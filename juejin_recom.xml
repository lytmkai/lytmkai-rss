<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[告别抽卡！小红书联合复旦开源新神器，AI绘图终于能指哪打哪了]]></title>    <link>https://juejin.cn/post/7588149079416700982</link>    <guid>https://juejin.cn/post/7588149079416700982</guid>    <pubDate>2025-12-27T10:14:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588149079416700982" data-draft-id="7588149079416668214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别抽卡！小红书联合复旦开源新神器，AI绘图终于能指哪打哪了"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-27T10:14:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别抽卡！小红书联合复旦开源新神器，AI绘图终于能指哪打哪了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T10:14:50.000Z" title="Sat Dec 27 2025 10:14:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>做过AI绘画的朋友大概都有过这种抓狂时刻：光影完美、画质惊艳，但你想让猫在左边、狗在右边，AI偏偏给你画成它们抱在一起，或者干脆把猫画到了天上。</p>
<p>这种“构图靠抽卡”的玄学时代，可能要被小红书AI团队和复旦大学联手终结了。</p>
<p>就在最近，一项名为 <strong>InstanceAssemble</strong> 的技术被顶会 NeurIPS 2025 收录，并直接在 GitHub 上开源。简单来说，它给 AI 装上了一个精准的“空间导航仪”，让文生图从“盲盒模式”进化到了“精准施工”阶段。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fgsdgfgfd-1024x490.jpg" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/gsdgfgfd-1024x490.jpg" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2b82fa5d3224175bc25c04c6650fb3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767435290&amp;x-signature=lsa8vFZT9S0vtVIKpbCTvalsgR4%3D" alt="gsdgfgfd" loading="lazy"/></a></p>
<h2 data-id="heading-0">为什么现在的 AI 总是不听指挥？</h2>
<p>目前的顶流模型，无论是 Stable Diffusion 还是 Flux，在处理“空间布局”时都有个通病：它们更擅长理解画面的整体氛围，却很难理解具体的空间指令。</p>
<p>当你输入“左边放个苹果，右边放个香蕉”，AI 处理时往往是一股脑地把语义混合在一起。这就导致了业界著名的“语义泄漏”问题——比如把香蕉画成了红色，或者两个物体的位置完全错乱。一旦画面里的物体超过两三个，AI 基本就开始胡乱发挥了。</p>
<h2 data-id="heading-1">InstanceAssemble 的解题思路：分而治之</h2>
<p>InstanceAssemble 的核心逻辑非常像是一个严谨的施工队。它抛弃了以往那种“大锅乱炖”的生成方式，引入了一种被称为 <strong>“实例组装注意力（Instance Assembly Attention）”</strong> 的新机制。</p>
<p>你可以把它理解为“分区分组管理”：</p>
<ol>
<li><strong>全局控场</strong>：模型先通过基础架构生成画面的大背景和整体光影氛围。</li>
<li><strong>定点组装</strong>：对于你指定的每一个物体（比如沙发、台灯、挂画），技术会锁定它们各自的坐标区域（Bounding Box）。</li>
<li><strong>独立计算</strong>：最绝的一点在于，每个物体的注意力计算被严格限制在自己的“地盘”里。画沙发时，AI 绝不看旁边的台灯一眼。</li>
</ol>
<p>这种机制完美解决了物体之间的干扰问题。哪怕是面对那种包含二三十个物体的超复杂室内设计图，它也能保证每个物体都在它该在的地方，长成它该有的样子。</p>
<h2 data-id="heading-2">惊人的“轻量化”数据</h2>
<p>通常提到这种精细控制，大家的第一反应是：这得消耗多大的算力？模型得重训多久？</p>
<p>InstanceAssemble 给出的答案让人相当意外。它采用了 LoRA（低秩适配）方案，并不需要重新训练那个庞大的底模。</p>
<p>看看这组数据：</p>
<ul>
<li>适配 <strong>Stable Diffusion 3-Medium</strong>：只需增加约 <strong>3.46%</strong> 的参数量。</li>
<li>适配最新的 <strong>Flux.1</strong>：额外参数量甚至低至 <strong>0.84%</strong>。</li>
</ul>
<p>这意味着，你不需要为了这就换一张4090显卡，也不需要下载几百个G的新模型，仅仅通过外挂一个极轻量的模块，就能让当红炸子鸡 Flux 拥有顶级的布局控制能力。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fsadasfsd.jpg" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/sadasfsd.jpg" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b759a4cd8384788bf23020b11cbc4b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767435290&amp;x-signature=eLLN4O2%2FND6Bdmb9F64iC%2BDNG%2BU%3D" alt="sadasfsd" loading="lazy"/></a></p>
<h2 data-id="heading-3">实战效果如何？</h2>
<p>为了验证这东西到底行不行，团队甚至专门搞了个高难度的测试集 <strong>DenseLayout</strong>，里面塞满了密密麻麻的物体布局。</p>
<p>测试结果显示，在处理包含10个以上物体的“地狱级”构图时，现有的大部分主流方法（如 ControlNet 或 GLIGEN）性能都会出现断崖式下跌，只有 InstanceAssemble 依然稳得住。它的布局对齐准确率比现有基线方法提升了整整一截。</p>
<p>更具实用价值的是，由于它训练时并没有见过那么密集的布局，但测试时却能完美泛化。也就是说，你哪怕给它一个从未见过的复杂广告排版，它也能依样画葫芦地生成出来。</p>
<h2 data-id="heading-4">写在最后</h2>
<p>InstanceAssemble 的出现，对于设计行业来说是个极大的利好。</p>
<p>以前设计师用 AI 做海报，最头疼的就是没法控制产品图的位置，往往需要生成几百张图再后期 PS 合成。现在，你只需要画好几个框，告诉 AI 这里放香水、那里放花瓣，一张符合排版规范的高质量商业图就出来了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-27_18.04.51.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-27_18.04.51.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa63b753c2f94e7a83db0a9324540cfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767435290&amp;x-signature=VfG2W3MzdcVDelyuElglgSFqiK8%3D" alt="iShot_2025-12-27_18.04.51" loading="lazy"/></a></p>
<p>目前，该项目的代码和预训练模型已经全部在 GitHub 上开源。对于想要在广告设计、游戏美术或者电商素材生成领域应用 AI 的开发者和创作者来说，这绝对是一个值得立刻上手尝试的工具。</p>
<p>AI 绘画，正在从“玩具”向“工具”迈出坚实的一步。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官: “ 说一下 JS 中什么是事件循环 ? ”]]></title>    <link>https://juejin.cn/post/7588043318358949923</link>    <guid>https://juejin.cn/post/7588043318358949923</guid>    <pubDate>2025-12-27T09:36:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588043318358949923" data-draft-id="7588004376867504163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官: “ 说一下 JS 中什么是事件循环 ? ”"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-27T09:36:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="千寻girling"/> <meta itemprop="url" content="https://juejin.cn/user/2276467567770442"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官: “ 说一下 JS 中什么是事件循环 ? ”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2276467567770442/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    千寻girling
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T09:36:27.000Z" title="Sat Dec 27 2025 09:36:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JS 中的事件循环原理以及异步执行过程</h2>
<p>这些知识点对新手来说可能有点难，但是是必须迈过的坎，逃避是解决不了问题的，本篇文章旨在帮你彻底搞懂它们。</p>
<hr/>
<h2 data-id="heading-1">1. JS 是单线程的</h2>
<p>我们都知道 JS 是单线程执行的（原因：我们不想并行地操作 DOM，DOM 树不是线程安全的，如果多线程，那会造成冲突）。</p>
<p>这里小说明一下：V8 是谷歌浏览器的 JS 执行引擎，在运行 JS 代码的时候，是以函数作为一个个帧（保存当前函数的执行环境）按代码的执行顺序压入执行栈（call stack）中，栈顶的函数先执行，执行完毕后弹出再执行下一个函数。其中堆是用来存放各种 JS 对象的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d84e209dca5f4171b1495763de9775ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=moHdlTyTSPHdOW%2BsgweuZUL4kA0%3D" alt="image.png" loading="lazy"/></p>
<p>假设浏览器就是上图的这种结构的话，执行同步代码是没什么问题的，如下</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">foo</span>() {
    <span class="hljs-built_in">bar</span>()
    console<span class="hljs-selector-class">.log</span>('foo')
}
function <span class="hljs-built_in">bar</span>() {
    <span class="hljs-built_in">baz</span>()
    console<span class="hljs-selector-class">.log</span>('bar')
}
function <span class="hljs-built_in">baz</span>() {
    console<span class="hljs-selector-class">.log</span>('baz')
}

<span class="hljs-built_in">foo</span>()
</code></pre>
<p>我们定义了 <code>foo</code>、<code>bar</code>、<code>baz</code> 三个函数，然后调用 <code>foo</code> 函数，控制台输出的结果为：</p>
<pre><code class="hljs">baz
bar
foo
</code></pre>
<p>执行过程如下：</p>
<ol>
<li>一个全局匿名函数最先执行（JS 的全局执行入口，之后的例子将忽略），遇到 <code>foo</code> 函数被调用，将 <code>foo</code> 函数压入执行栈。</li>
<li>执行 <code>foo</code> 函数，发现 <code>foo</code> 函数体中调用了 <code>bar</code> 函数，则将 <code>bar</code> 函数压入执行栈。</li>
<li>执行 <code>bar</code> 函数，发现 <code>bar</code> 函数体中调用了 <code>baz</code> 函数，又将 <code>baz</code> 函数压入执行栈。</li>
<li>执行 <code>baz</code> 函数，函数体中只有一条语句 <code>console.log('baz')</code>，执行，在控制台打印：<code>baz</code>，然后 <code>baz</code> 函数执行完毕弹出执行栈。</li>
<li>此时的栈顶为 <code>bar</code> 函数，<code>bar</code> 函数体中的 <code>baz()</code> 语句已经执行完，接着执行下一条语句（<code>console.log('bar')</code>），在控制台打印：<code>bar</code>，然后 <code>bar</code> 函数执行完毕弹出执行栈。</li>
<li>此时的栈顶为 <code>foo</code> 函数，<code>foo</code> 函数体中的 <code>bar()</code> 语句已经执行完，接着执行下一条语句（<code>console.log('foo')</code>），在控制台打印：<code>foo</code>，然后 <code>foo</code> 函数执行完毕弹出执行栈。</li>
<li>至此，执行栈为空，这一轮执行完毕。</li>
</ol>
<h4 data-id="heading-2">动图展示</h4>
<p><strong>还是图直观点，以上步骤对应的执行流程图如下：</strong></p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7babfceef98c4350854b9009daac673f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=xETmIWfBdx16y%2FGxFpfDIajXjgk%3D" alt="fc266fc5ceece50a1622961cf201eec5.gif" width="100%" loading="lazy"/>
<p><strong>非动图</strong> <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4563ea7eca1e4c9c9c8150cbbb808191~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=OqHzjLatjxwHMU%2BGsUCvsojpNsA%3D" alt="image.png" width="100%" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3">2. 事件循环（event loop）</h2>
<ul>
<li>
<p>事件循环：JS 处理异步任务的机制，因单线程特性，通过循环读取任务队列实现非阻塞。</p>
</li>
<li>
<p>过程：</p>
<ol>
<li>执行同步代码（调用栈清空）。</li>
<li>执行所有微任务（<code>Promise</code>回调等），直到微任务队列清空。</li>
<li>执行一个宏任务（<code>setTimeout</code>等），然后回到步骤 2，循环往复。</li>
</ol>
</li>
</ul>
<p>我们改变一下代码 1，
如下是代码 2：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">foo</span>() {
    <span class="hljs-built_in">bar</span>()
    console<span class="hljs-selector-class">.log</span>('foo')
}
function <span class="hljs-built_in">bar</span>() {
    <span class="hljs-built_in">baz</span>()
    console<span class="hljs-selector-class">.log</span>('bar')
}
function <span class="hljs-built_in">baz</span>() { 
    <span class="hljs-built_in">setTimeout</span>(() =&gt; {
        console<span class="hljs-selector-class">.log</span>('setTimeout: <span class="hljs-number">2s</span>')
    }, <span class="hljs-number">2000</span>)
    console<span class="hljs-selector-class">.log</span>('baz') 
}

<span class="hljs-built_in">foo</span>()
</code></pre>
<p>根据 1 中的假设，浏览器只由一个 JS 引擎构成的话，那么所有的代码必然同步执行（因为 JS 执行是单线程的，所以当前栈顶函数不管执行时间需要多久，执行栈中该函数下面的其他函数必须等它执行完弹出后才能执行（这就是代码被阻塞的意思）），执行到 <code>baz</code> 函数体中的 <code>setTimeout</code> 时应该等 2 秒，在控制台中输出 <code>setTimeout: 2s</code>，然后再输出：<code>baz</code>。所以我们期望的输出顺序应该是：<code>setTimeout: 2s -&gt; baz -&gt; bar -&gt; foo</code>（这是错的）。</p>
<p>浏览器如果真这样设计的话，肯定是有问题的！遇到 AJAX 请求、<code>setTimeout</code> 等比较耗时的操作时，我们页面需要长时间等待，就被阻塞住啥也干不了，出现了页面 “假死”，这样绝对不是我们想要的结果。</p>
<p>实际当然并非我以为的那样，这里先重点提醒一下：<strong>JS 是单线程的，这一点也没错，但是浏览器中并不仅仅只是由一个 JS 引擎构成，它还包括其他的一些线程来处理别的事情</strong>。如下图 !</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27284cf6e7584462a975b02db3927614~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=ABAeyN2SPdhMnXATooMLIHiYYds%3D" alt="image.png" width="100%" loading="lazy"/>
<p>浏览器除了 JS 引擎（JS 执行线程，后面我们只关注 JS 引擎中的执行栈）以外，还有 Web APIs（浏览器提供的接口，这是在 JS 引擎以外的）线程、GUI 渲染线程等。JS 引擎在执行过程中，如果遇到相关的事件（DOM 操作、鼠标点击事件、滚轮事件、AJAX 请求、<code>setTimeout</code> 等），并不会因此阻塞，它会将这些事件移交给 Web APIs 线程处理，而自己则接着往下执行。Web APIs 则会按照一定的规则将这些事件放入一个任务队列（callback queue，也叫 task queue）中，当 JS 执行栈中的代码执行完毕以后，它就会去任务队列中获取一个事件回调放入执行栈中执行，然后如此往复，这就是所谓的事件循环机制。</p>





























<table><thead><tr><th>线程名</th><th>作用</th></tr></thead><tbody><tr><td><strong>JS 引擎线程</strong></td><td>也称为 JS 内核，负责处理 JavaScript 脚本。（例如 V8 引擎）<strong>①</strong>负责解析 JS 脚本，运行代码。<strong>②</strong>一直等待着任务队列中的任务的到来，然后加以处理。<strong>③</strong>一个 Tab 页（renderer 进程）中无论什么时候都只有一个 JS 线程运行 JS 程序。</td></tr><tr><td><strong>事件触发线程</strong></td><td>归属于渲染进程而不是 JS 引擎，用来控制事件循环。<strong>①</strong>当 JS 引擎执行代码块如<code>setTimeout</code>时（也可来自浏览器内核的其他线程，如鼠标点击、Ajax 异步请求等），会将对应任务添加到事件线程中。<strong>②</strong>当对应的事件符合触发条件被触发时，该线程会把事件添加到待处理队列的队尾，等待 JS 引擎的处理。                                                                                 <strong>注意</strong>：由于 JS 的单线程关系，所以这些待处理队列中的事件都是排队等待 JS 引擎处理，JS 引擎空闲时才会执行。</td></tr><tr><td><strong>定时触发器线程</strong></td><td><code>setInterval</code>和<code>setTimeout</code>所在的线程。<strong>①</strong>浏览器定时计数器并不是由 JS 引擎计数的。<strong>②</strong>JS 引擎是单线程的，如果处于阻塞线程状态就会影响计时的准确，因此，通过单独的线程来计时并触发定时。<strong>③</strong>计时完毕后，添加到事件队列中，等待 JS 引擎空闲后执行。<strong>注意</strong>：W3C 在 HTML 标准中规定，<code>setTimeout</code>中低于 4ms 的时间间隔算为 4ms。</td></tr><tr><td><strong>异步 HTTP 请求线程</strong></td><td><code>XMLHttpRequest</code>在连接后通过浏览器新开一个线程请求。当检测到状态变更时，如果设置有回调函数，异步线程就产生状态变更事件，将这个回调放入事件队列中，再由 JS 引擎执行。</td></tr><tr><td><strong>GUI 渲染线程</strong></td><td>负责渲染浏览器界面，包括：<strong>①</strong>解析 HTML、CSS，构建 DOM 树和 RenderObject 树，布局和绘制等。<strong>②</strong>重绘（Repaint）以及回流（Reflow）处理。</td></tr></tbody></table>
<p>这里让我们对事件循环先来做个<strong>小总结</strong>：</p>
<ol>
<li>JS线程负责处理JS代码，当遇到一些<strong>异步操作</strong>的时候，则将这些<strong>异步事件移交给Web APIs 处理</strong>，自己则继续往下执行。</li>
<li>Web APIs线程将接收到的事件按照一定规则按顺序<strong>添加到任务队列</strong>中（应该是添加到任务集合中的各个事件队列中）。</li>
<li>JS线程<strong>处理完当前的所有任务以后</strong>（执行栈为空），它会去查看任务队列中是否有等待被处理的事件，若有，则<strong>取出一个事件回调放入执行栈</strong>中执行。</li>
<li>然后不断循环第3步。</li>
</ol>
<p>让我们来看看真正的浏览器中执行是什么个流程吧！</p>
<h4 data-id="heading-4">动图展示</h4>
<p><strong>第二段代码</strong> <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b59fc9945b1e4d41b4f7cdd7e982030c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=r%2BA2FvFKSJ4fg7dq813EQu8Vbo0%3D" alt="3.gif" width="100%" loading="lazy"/></p>
<p>细心的小伙伴可能有发现Web API在计时器时间到达后将匿名回调函数添加到任务队列中了，虽然定时器时间已到，但它目前并不能执行！！！因为JS的执行栈此时并非空，必须要等到当前执行栈为空后才有机会被召回到执行栈执行。由此，我们可以得出一个结论：<strong>setTimeout设置的时间其实只是最小延迟时间</strong>，而并不是确切的等待时间。（<strong>当主线程的任务耗时比较长的时候，等待时间将会变得更长</strong>）</p>
<hr/>
<h2 data-id="heading-5">3. 事件循环（进阶）与异步</h2>
<h3 data-id="heading-6">3.1 试试 <code>setTimeout(fn, 0)</code></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'foo'</span>)
}

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout: 0s'</span>)
}, <span class="hljs-number">0</span>);

<span class="hljs-title function_">foo</span>();
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-arduino" lang="arduino">foo
setTimeout: <span class="hljs-number">0</span>s
</code></pre>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e31e9e87364ffeb0149d7f793b8255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=U66NZMaWK72gkAc0QVNdVPO4tMk%3D" alt="4.gif" width="100%" loading="lazy"/>
<p>即使 <code>setTimeout</code> 的延时设置为 0（实际上最小延时 &gt;= 4ms），JS 执行栈也将该延时事件发放给 Web API 处理，Web API 再将事件添加到任务队列中，等 JS 执行栈为空时，该延时事件再压入执行栈中执行。</p>
<hr/>
<h3 data-id="heading-7">3.2 事件循环中的 Promise</h3>
<p>其实以上的浏览器模型是ES5标准的，ES6+标准中的任务队列在此基础上新增了一种，变成了如下两种：</p>
<h4 data-id="heading-8">3.2.1 宏任务 / 微任务</h4>
<p>现在W3C重新对事件循环进行了定义,<strong>取消了宏任务</strong>,取而代之的是<strong><strong>任务队列</strong></strong>,微任务依旧保留,优先级为最高。</p>
<blockquote>
<p>MDN 官网 : 事件循环会将作业分成两类： <em>任务</em>和<em>微任务</em>。微任务具有更高的优先级，在任务队列被拉出之前，微任务队列会先被排空</p>
</blockquote>
<blockquote>
<p><strong>任务队列（macrotask queue）</strong> ：<strong>普通优先级</strong>的任务，通常包括：</p>
</blockquote>
<ul>
<li><code>setTimeout</code> / <code>setInterval</code> / <code>setImmediate</code>（Node.js）</li>
<li>I/O 操作（文件读写、Ajax事件 / 网络请求等）</li>
<li>UI 渲染事件 (用户交互事件)</li>
<li>脚本整体代码（第一次执行的同步代码）</li>
</ul>
<blockquote>
<p><strong>微任务队列（microtask queue）</strong> ：<strong>高优先级</strong>的任务，通常包括：</p>
</blockquote>
<ul>
<li><code>Promise.then</code> / <code>Promise.catch</code> / <code>Promise.finally</code></li>
<li><code>async/await</code> 中 <code>await</code> 后面的代码（其实是 <code>.then</code> 的语法糖）</li>
<li><code>MutationObserver</code>（浏览器）</li>
<li><code>process.nextTick</code>（Node.js，优先级比普通微任务更高）</li>
</ul>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/759f9827e0974e309c1b75cd905f9aa1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=Z8FQRENJth1%2BKTUCGoKebYea4Vs%3D" alt="image.png" width="100%" loading="lazy"/>
<p>事件循环的处理流程变成了如下：</p>
<ol>
<li>JS 线程负责处理 JS 代码，当遇到一些异步操作的时候，则将这些异步事件移交给 Web APIs 处理，自己则继续往下执行。</li>
<li>Web APIs 线程将接收到的事件按照一定规则添加到任务队列中，宏事件添加到宏任务队列中，微事件添加到微事件队列中。</li>
<li>JS 线程处理完当前的所有任务以后（执行栈为空），它会先去微任务队列获取事件，并将微任务队列中的所有事件一件件执行完毕，直到微任务队列为空后再去宏任务队列中取出一个事件执行。</li>
<li>然后不断循环第 3 步。</li>
</ol>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c60d076b81c941f19f0979fa938856cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=07nVSf%2Bw7l2PhsICMBIw3Uoc4nU%3D" alt="image.png" width="70%" loading="lazy"/>
<p>排一下先后顺序： <strong>执行栈 --&gt; 微任务 --&gt; 渲染 --&gt; 下一个宏任务</strong>。</p>
<hr/>
<h4 data-id="heading-9">3.2.2 单独使用 Promise</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'foo'</span>)
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'global start'</span>)

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise'</span>)
    <span class="hljs-title function_">resolve</span>()
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise then'</span>)
})

<span class="hljs-title function_">foo</span>()

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'global end'</span>)
</code></pre>
<p>控制台输出的结果为：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">global</span> <span class="hljs-keyword">start</span>
promise
foo
<span class="hljs-keyword">global</span> <span class="hljs-keyword">end</span>
promise <span class="hljs-keyword">then</span>
</code></pre>
<p><strong>动图展示</strong></p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2715f43c9f1744ddbe61e23fbf1141ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=rum87u1ykYIV79iEis1KQ4IVMXA%3D" alt="5.gif" width="100%" loading="lazy"/>
<p><strong>代码执行过程解析(文字描述)</strong></p>
<ol>
<li><strong>执行同步代码</strong></li>
</ol>
<ul>
<li>执行 <code>console.log('global start')</code>，控制台输出：global start</li>
</ul>
<ol start="2">
<li><strong>执行 <code>new Promise(...)</code></strong></li>
</ol>
<ul>
<li>
<p><strong>注意</strong>：在使用 <code>new</code> 关键字创建 <code>Promise</code> 对象时，传递给 <code>Promise</code> 的函数称为 <strong>executor</strong>。</p>
<ul>
<li>当 <code>Promise</code> 被创建时，<strong>executor 函数会自动同步执行</strong>。</li>
<li><code>.then</code> 里的回调才是异步执行的部分。</li>
</ul>
</li>
<li>
<p>执行 <code>Promise</code> 参数中的匿名函数（同步执行）：</p>
<ul>
<li>
<p>执行 <code>console.log('promise')</code>，控制台输出：promise</p>
</li>
<li>
<p>执行 <code>resolve()</code>，将 <code>Promise</code> 状态变为 <code>resolved</code>。</p>
</li>
</ul>
</li>
<li>
<p>继续执行 <code>.then(...)</code>：</p>
<ul>
<li>遇到 <code>.then</code> 会将回调提交给 <strong>Web API</strong> 处理。</li>
<li>Web API 将该回调添加到 <strong>微任务队列</strong>（此时微任务队列中有一个 Promise 事件待执行）。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>继续执行同步代码</strong></li>
</ol>
<ul>
<li>
<p>执行栈在提交完 Promise 事件后，继续往下执行：</p>
<ul>
<li>
<p>执行 <code>foo()</code> 函数，控制台输出：foo</p>
</li>
<li>
<p>执行 <code>console.log('global end')</code>，控制台输出：global end</p>
</li>
</ul>
</li>
<li>
<p>至此，本轮事件循环的同步代码执行完毕，执行栈为空。</p>
</li>
</ul>
<ol start="4">
<li><strong>处理微任务队列</strong></li>
</ol>
<ul>
<li>
<p>事件循环机制首先查看 <strong>微任务队列</strong> 是否为空：</p>
<ul>
<li>
<p>发现有一个 Promise 事件待执行，将其压入执行栈。</p>
</li>
<li>
<p>执行 <code>.then</code> 中的回调：</p>
<ul>
<li>执行 <code>console.log('promise then')</code>，控制台输出：promise then</li>
</ul>
</li>
<li>
<p>至此，新的一轮事件循环（Promise 事件）执行完毕，执行栈为空。</p>
</li>
</ul>
</li>
</ul>
<ol start="5">
<li><strong>检查任务队列</strong></li>
</ol>
<ul>
<li>
<p>执行栈再次为空，事件循环：</p>
<ol>
<li>先查看 <strong>微任务队列</strong>，发现已空。</li>
<li>再查看 <strong>宏任务队列</strong>，发现也为空。</li>
</ol>
</li>
<li>
<p>执行栈进入等待事件状态。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-10">3.2.3 Promise 结合 setTimeout</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'foo'</span>)
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'global start'</span>)

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout: 0s'</span>)
}, <span class="hljs-number">0</span>)

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise'</span>)
    <span class="hljs-title function_">resolve</span>()
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise then'</span>)
})

<span class="hljs-title function_">foo</span>()

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'global end'</span>)
</code></pre>
<p>控制台输出的结果为：</p>
<pre><code class="hljs language-arduino" lang="arduino">global start
promise
foo
global end
promise then
setTimeout: <span class="hljs-number">0</span>s
</code></pre>
<p><strong>动图展示</strong></p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d19dfd6c6d504401b305c98176137f71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=6VQHqRrbjtquZa5pHYaMkfFYHn0%3D" alt="6.gif" width="100%" loading="lazy"/>
<ol>
<li><strong>执行同步代码</strong></li>
</ol>
<ul>
<li>执行 <code>console.log('global start')</code>，控制台输出：
global start</li>
</ul>
<ol start="2">
<li><strong>处理 <code>setTimeout</code>（改变部分）</strong></li>
</ol>
<ul>
<li>
<p>继续往下执行，遇到 <code>setTimeout</code>：</p>
<ul>
<li>JS 执行栈将其移交给 <strong>Web API</strong> 处理。</li>
<li>延迟 0 秒后，Web API 将 <code>setTimeout</code> 事件添加到 <strong>宏任务队列</strong>（此时宏任务队列中有一个 <code>setTimeout</code> 事件待处理）。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>继续执行同步代码</strong></li>
</ol>
<ul>
<li>
<p>JS 线程转交 <code>setTimeout</code> 事件后，继续往下执行：</p>
<ul>
<li>
<p>遇到 <code>new Promise(...)</code>：</p>
<ul>
<li>
<p>Promise 的 executor 函数 <strong>同步执行</strong>：</p>
<ul>
<li>
<p>执行 <code>console.log('promise')</code>，控制台输出：promise</p>
</li>
<li>
<p>执行 <code>resolve()</code>，将 Promise 状态变为 <code>resolved</code>。</p>
</li>
</ul>
</li>
<li>
<p>执行 <code>.then(...)</code>：</p>
<ul>
<li>遇到 <code>.then</code> 会将回调提交给 <strong>Web API</strong> 处理。</li>
<li>Web API 将该回调添加到 <strong>微任务队列</strong>（此时微任务队列中有一个 Promise 事件待处理）。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="4">
<li><strong>继续执行同步代码</strong></li>
</ol>
<ul>
<li>
<p>执行栈在提交完 Promise 事件后，继续往下执行：</p>
<ul>
<li>
<p>执行 <code>foo()</code> 函数，控制台输出：foo</p>
</li>
<li>
<p>执行 <code>console.log('global end')</code>，控制台输出：global end</p>
</li>
</ul>
</li>
<li>
<p>至此，本轮事件循环的同步代码执行完毕，执行栈为空。</p>
</li>
</ul>
<ol start="5">
<li><strong>处理微任务队列</strong></li>
</ol>
<ul>
<li>
<p>事件循环机制首先查看 <strong>微任务队列</strong> 是否为空：</p>
<ul>
<li>
<p>发现有一个 Promise 事件待执行，将其压入执行栈。</p>
</li>
<li>
<p>执行 <code>.then</code> 中的回调：</p>
<ul>
<li>执行 <code>console.log('promise then')</code>，控制台输出： promise then</li>
</ul>
</li>
<li>
<p>至此，新的一轮事件循环（Promise 事件）执行完毕，执行栈为空。</p>
</li>
</ul>
</li>
</ul>
<ol start="6">
<li><strong>处理宏任务队列（改变部分）</strong></li>
</ol>
<ul>
<li>
<p>执行栈再次为空，事件循环：</p>
<ol>
<li>
<p>先查看 <strong>微任务队列</strong>，发现已空。</p>
</li>
<li>
<p>再查看 <strong>宏任务队列</strong>，发现有一个 <code>setTimeout</code> 事件待处理：</p>
</li>
</ol>
<ul>
<li>
<p>将 <code>setTimeout</code> 中的匿名函数压入执行栈执行：</p>
<ul>
<li>执行 <code>console.log('setTimeout: 0s')</code>，控制台输出：setTimeout: 0s</li>
</ul>
</li>
<li>
<p>至此，新的一轮事件循环（<code>setTimeout</code> 事件）执行完毕，执行栈为空。</p>
</li>
</ul>
</li>
</ul>
<p>7.** 检查任务队列**</p>
<ul>
<li>
<p>执行栈再次为空，事件循环：</p>
<ol>
<li>先查看 <strong>微任务队列</strong>，发现已空。</li>
<li>再查看 <strong>宏任务队列</strong>，发现也为空。</li>
</ol>
</li>
<li>
<p>执行栈进入等待事件状态。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-11">3.3 事件循环中的 async/await</h3>
<p>这里简单介绍下async函数：</p>
<ol>
<li>
<p>函数前面 <strong>async 关键字的作用</strong>就2点：①这个函数总是返回一个promise。②允许函数内使用await关键字。</p>
</li>
<li>
<p><strong>关键字 await 使 async 函数一直等待</strong>（执行栈当然不可能停下来等待的，await将其后面的内容包装成promise交给Web APIs后，执行栈会跳出async函数继续执行），直到promise执行完并返回结果。<strong>await只在async函数函数里面奏效</strong>。</p>
</li>
<li>
<p>async函数只是一种比promise更优雅得获取promise结果（promise链式调用时）的一种语法而已。</p>
</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'foo'</span>)
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async1</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 start'</span>)
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">async2</span>()
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 end'</span>)
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async2</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async2'</span>)
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'global start'</span>)
<span class="hljs-title function_">async1</span>()
<span class="hljs-title function_">foo</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'global end'</span>)
</code></pre>
<p>执行的结果如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">global</span> <span class="hljs-keyword">start</span>
async1 <span class="hljs-keyword">start</span>
async2
foo
<span class="hljs-keyword">global</span> <span class="hljs-keyword">end</span>
async1 <span class="hljs-keyword">end</span>
</code></pre>
<ol>
<li><strong>执行同步代码</strong></li>
</ol>
<ul>
<li>执行 <code>console.log('global start')</code>，控制台输出：global start</li>
</ul>
<ol start="2">
<li><strong>调用 <code>async1()</code></strong></li>
</ol>
<ul>
<li>
<p>执行 <code>async1()</code>，进入 <code>async1</code> 函数体：</p>
<ul>
<li>
<p>执行 <code>console.log('async1 start')</code>，控制台输出：async1 start</p>
</li>
<li>
<p>执行 <code>await async2()</code>：</p>
<ul>
<li><code>await</code> 关键字会暂停 <code>async1</code> 函数的执行，直到 <code>await</code> 后面的 Promise 返回结果。</li>
<li><code>await async2()</code> 会像调用普通函数一样执行 <code>async2()</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>执行 <code>async2()</code></strong></li>
</ol>
<ul>
<li>
<p>进入 <code>async2</code> 函数体：</p>
<ul>
<li>
<p>执行 <code>console.log('async2')</code>，控制台输出：async2</p>
</li>
<li>
<p><code>async2</code> 函数执行结束，弹出执行栈。</p>
</li>
<li>
<p>由于 <code>async2</code> 没有显式返回 Promise，它会隐式返回一个已 resolved 的 Promise。</p>
</li>
</ul>
</li>
</ul>
<p>4.<strong>暂停 <code>async1()</code> 并继续执行同步代码</strong></p>
<ul>
<li>
<p>因为 <code>await</code> 关键字之后的代码被暂停，<code>async1</code> 函数执行结束，弹出执行栈。</p>
</li>
<li>
<p>JS 主线程继续向下执行：</p>
<ul>
<li>
<p>执行 <code>foo()</code> 函数，控制台输出：foo</p>
</li>
<li>
<p>执行 <code>console.log('global end')</code>，控制台输出：global end</p>
</li>
</ul>
</li>
<li>
<p>至此，本轮事件循环的同步代码执行完毕，执行栈为空。</p>
</li>
</ul>
<ol start="5">
<li><strong>事件循环处理微任务</strong></li>
</ol>
<ul>
<li>
<p>事件循环机制开始工作：</p>
<ol>
<li>
<p>先查看 <strong>微任务队列</strong>：</p>
<ul>
<li>
<p>发现有一个微任务事件，该事件是 <code>async1</code> 函数中 <code>await async2()</code> 之后的代码（可以理解为：用一个匿名函数包裹 <code>await</code> 之后的代码，作为微任务事件）。</p>
</li>
<li>
<p>执行该微任务：</p>
<ul>
<li>执行 <code>console.log('async1 end')</code>，控制台输出：async1 end</li>
</ul>
</li>
</ul>
</li>
<li>
<p>执行栈再次为空，本轮事件执行结束。</p>
</li>
</ol>
</li>
</ul>
<ol start="6">
<li><strong>检查任务队列</strong></li>
</ol>
<ul>
<li>
<p>事件循环机制再次查看：</p>
<ol>
<li><strong>微任务队列</strong>：已空。</li>
<li><strong>宏任务队列</strong>：也为空。</li>
</ol>
</li>
<li>
<p>执行栈进入等待事件状态。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-12">4. 大综合（自测）</h2>
<h4 data-id="heading-13">4.1 简单融合</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async1</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 start'</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">async2</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 end'</span>);
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async2</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async2'</span>);
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script start'</span>);

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout'</span>);
}, <span class="hljs-number">0</span>)

<span class="hljs-title function_">async1</span>();

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise1'</span>);
    <span class="hljs-title function_">resolve</span>();
}).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise2'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script end'</span>);
</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-sql" lang="sql">script <span class="hljs-keyword">start</span>
async1 <span class="hljs-keyword">start</span>
async2
promise1
script <span class="hljs-keyword">end</span>
async1 <span class="hljs-keyword">end</span>
promise2
setTimeout
</code></pre>
<hr/>
<h4 data-id="heading-14">4.2 变形 1</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async1</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 start'</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">async2</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 end'</span>);
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async2</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise1'</span>);
        <span class="hljs-title function_">resolve</span>();
    }).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise2'</span>);
    });
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script start'</span>);

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout'</span>);
}, <span class="hljs-number">0</span>)

<span class="hljs-title function_">async1</span>();

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise3'</span>);
    <span class="hljs-title function_">resolve</span>();
}).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise4'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script end'</span>);
</code></pre>
<p>输出的结果：</p>
<pre><code class="hljs language-sql" lang="sql">script <span class="hljs-keyword">start</span>
async1 <span class="hljs-keyword">start</span>
promise1
promise3
script <span class="hljs-keyword">end</span>
promise2
async1 <span class="hljs-keyword">end</span>
promise4
setTimeout
</code></pre>
<hr/>
<h4 data-id="heading-15">4.3 变形 2</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async1</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 start'</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">async2</span>();
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout1'</span>);
    },<span class="hljs-number">0</span>)
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async2</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async2'</span>);
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script start'</span>);

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout3'</span>);
}, <span class="hljs-number">0</span>)

<span class="hljs-title function_">async1</span>();

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise1'</span>);
    <span class="hljs-title function_">resolve</span>();
}).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise2'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script end'</span>);
</code></pre>
<p>输出的结果：</p>
<pre><code class="hljs language-sql" lang="sql">script <span class="hljs-keyword">start</span>
async1 <span class="hljs-keyword">start</span>
async2
promise1
script <span class="hljs-keyword">end</span>
promise2
setTimeout3
setTimeout1
</code></pre>
<hr/>
<h4 data-id="heading-16">4.4 变形 3</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">a1</span> () {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'a1 start'</span>)
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">a2</span>()
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'a1 end'</span>)
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">a2</span> () {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'a2'</span>)
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script start'</span>)

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout'</span>)
}, <span class="hljs-number">0</span>)

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise1'</span>)
})

<span class="hljs-title function_">a1</span>()

<span class="hljs-keyword">let</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'promise2.then'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise2'</span>)
})

promise2.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise3'</span>)
    })
})
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script end'</span>)
</code></pre>
<p>输出的结果：</p>
<pre><code class="hljs language-sql" lang="sql">script <span class="hljs-keyword">start</span>
a1 <span class="hljs-keyword">start</span>
a2
promise2
script <span class="hljs-keyword">end</span>
promise1
a1 <span class="hljs-keyword">end</span>
promise2.then
promise3
setTimeout
</code></pre>
<hr/>
<h2 data-id="heading-17">5. 结语</h2>
<ul>
<li><strong>JS 是单线程执行的</strong>，同一时间只能处理一件事。</li>
<li><strong>浏览器是多线程的</strong>，JS 引擎通过分发这些耗时的异步事件给 Web APIs 线程处理，避<strong>免了单线程被阻塞。</strong></li>
<li>事件循环机制是为了协调事件、用户交互、JS 脚本、页面渲染、网络请求等事件的<strong>有序执行</strong>。</li>
<li><strong>微任务的优先级高于宏任务</strong>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[el-table源码解读2-2——createStore()初始化方法]]></title>    <link>https://juejin.cn/post/7588028859541635098</link>    <guid>https://juejin.cn/post/7588028859541635098</guid>    <pubDate>2025-12-27T09:37:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588028859541635098" data-draft-id="7588086766248181811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="el-table源码解读2-2——createStore()初始化方法"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-27T09:37:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Joie"/> <meta itemprop="url" content="https://juejin.cn/user/3265984436383947"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            el-table源码解读2-2——createStore()初始化方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3265984436383947/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Joie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T09:37:53.000Z" title="Sat Dec 27 2025 09:37:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>1. createStore()初始化方法</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> createStore&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultRow</span>&gt;(
  <span class="hljs-attr">table</span>: <span class="hljs-title class_">Table</span>&lt;T&gt;,
  <span class="hljs-attr">props</span>: <span class="hljs-title class_">TableProps</span>&lt;T&gt;
) {
  <span class="hljs-keyword">if</span> (!table) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Table is required.'</span>)
  }

  <span class="hljs-keyword">const</span> store = useStore&lt;T&gt;()
  <span class="hljs-comment">// fix https://github.com/ElemeFE/element/issues/14075</span>
  <span class="hljs-comment">// related pr https://github.com/ElemeFE/element/pull/14146</span>

  <span class="hljs-comment">/**
   * 原始方法：_toggleAllSelection 是执行全选/取消全选的逻辑
   * 防抖包装：用 debounce 包装，延迟 10ms 执行
   * 方法替换：将防抖后的方法赋值给 toggleAllSelection
   */</span>
  store.<span class="hljs-property">toggleAllSelection</span> = <span class="hljs-title function_">debounce</span>(store.<span class="hljs-property">_toggleAllSelection</span>, <span class="hljs-number">10</span>)
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-title class_">InitialStateMap</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
    <span class="hljs-comment">/**
     * props是Table组件的props，key是InitialStateMap的key
     * 这段代码用于初始化 store 的状态：
     * 遍历 InitialStateMap 的所有 key，从 props 中取值并同步到 store。
     */</span>
    <span class="hljs-title function_">handleValue</span>(<span class="hljs-title function_">getArrKeysValue</span>(props, key), key, store)
  })
  <span class="hljs-comment">// 监听InitialStateMap中定义的所有属性</span>
  <span class="hljs-title function_">proxyTableProps</span>(store, props)
  <span class="hljs-keyword">return</span> store
}
</code></pre>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">/**
   * 原始方法：_toggleAllSelection 是执行全选/取消全选的逻辑
   * 防抖包装：用 debounce 包装，延迟 10ms 执行
   * 方法替换：将防抖后的方法赋值给 toggleAllSelection
   */</span>
   
  store.<span class="hljs-property">toggleAllSelection</span> = <span class="hljs-title function_">debounce</span>(store.<span class="hljs-property">_toggleAllSelection</span>, <span class="hljs-number">10</span>)
  
<span class="hljs-comment">// 用户点击全选框时</span>
store.<span class="hljs-title function_">toggleAllSelection</span>()  <span class="hljs-comment">// 调用防抖后的方法</span>
  → debounce 延迟 10ms
    → <span class="hljs-title function_">_toggleAllSelection</span>()  <span class="hljs-comment">// 执行实际逻辑</span>
      → 修改 selection 和 isAllSelected 状态
      
为什么需要防抖？
_toggleAllSelection方法会遍历所有行数据、更新每行的选择状态、触发事件，
如果用户快速连续点击，可能会导致状态不一致、性能问题、<span class="hljs-variable constant_">UI</span>闪烁，而防抖可以避免这些问题      
</code></pre>
<p><strong>2. getArrKeysValue()</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 从 props 中按路径取值，支持嵌套属性（如 'treeProps.hasChildren'）
 * <span class="hljs-doctag">@param</span> props Table组件的props
 * <span class="hljs-doctag">@param</span> key InitialStateMap的key
 * <span class="hljs-doctag">@returns</span>
 */</span>
<span class="hljs-keyword">function</span> getArrKeysValue&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultRow</span>&gt;(
  <span class="hljs-attr">props</span>: <span class="hljs-title class_">TableProps</span>&lt;T&gt;,
  <span class="hljs-attr">key</span>: string
) {
  <span class="hljs-keyword">if</span> ((key <span class="hljs-keyword">as</span> keyof <span class="hljs-keyword">typeof</span> props).<span class="hljs-title function_">includes</span>(<span class="hljs-string">'.'</span>)) {
    <span class="hljs-keyword">const</span> keyList = (key <span class="hljs-keyword">as</span> keyof <span class="hljs-keyword">typeof</span> props).<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>)
    <span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: string | <span class="hljs-title class_">Record</span>&lt;string, any&gt; = props
    keyList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> {
      value = (value <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;string, any&gt;)[k]
    })
    <span class="hljs-keyword">return</span> value
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> (props <span class="hljs-keyword">as</span> any)[key] <span class="hljs-keyword">as</span> boolean | string
  }
}

</code></pre>
<p><strong>3. handleValue()</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 将props的值同步到store的状态中，并处理映射关系和默认值
 * <span class="hljs-doctag">@param</span> value 从props中按InitialStateMap的key取到的值，支持嵌套属性（如 'treeProps.hasChildren'）
 * <span class="hljs-doctag">@param</span> propsKey InitialStateMap的key
 * <span class="hljs-doctag">@param</span> store TableStore
 */</span>
<span class="hljs-keyword">function</span> handleValue&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultRow</span>&gt;(
  <span class="hljs-attr">value</span>: string | boolean | <span class="hljs-title class_">Record</span>&lt;string, any&gt;,
  <span class="hljs-attr">propsKey</span>: string,
  <span class="hljs-attr">store</span>: <span class="hljs-title class_">Store</span>&lt;T&gt;
) {
  <span class="hljs-comment">// 保存从props中按InitialStateMap的key取到的原始值</span>
  <span class="hljs-keyword">let</span> newVal = value
  <span class="hljs-comment">// 从InitialStateMap获取映射配置</span>
  <span class="hljs-comment">// 可能是字符串（如 'rowKey'）或对象（如 { key: 'lazyColumnIdentifier', default: 'hasChildren' }）</span>
  <span class="hljs-keyword">let</span> storeKey = <span class="hljs-title class_">InitialStateMap</span>[propsKey <span class="hljs-keyword">as</span> keyof <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">InitialStateMap</span>]
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isObject</span>(storeKey)) {
    <span class="hljs-comment">// 如果newVal为空，则使用默认值</span>
    newVal = newVal || storeKey.<span class="hljs-property">default</span>
    storeKey = storeKey.<span class="hljs-property">key</span>
  }
  ; ((store.<span class="hljs-property">states</span> <span class="hljs-keyword">as</span> any)[storeKey] <span class="hljs-keyword">as</span> any).<span class="hljs-property">value</span> = newVal
}

</code></pre>
<p><strong>4. proxyTableProps()</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 用于监听 props 的变化，当 props 中的值改变时，自动同步到 store 的状态中
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">store</span>
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">props</span>
 */</span>
<span class="hljs-keyword">function</span> proxyTableProps&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultRow</span>&gt;(
  <span class="hljs-attr">store</span>: <span class="hljs-title class_">Store</span>&lt;T&gt;,
  <span class="hljs-attr">props</span>: <span class="hljs-title class_">TableProps</span>&lt;T&gt;
) {
  <span class="hljs-comment">// 遍历 InitialStateMap 的所有 key，为每个 key 创建一个 watch 监听器</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-title class_">InitialStateMap</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
    <span class="hljs-title function_">watch</span>(
      <span class="hljs-comment">// 监听 getArrKeysValue(props, key) 的返回值</span>
      <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">getArrKeysValue</span>(props, key),
      <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
        <span class="hljs-comment">// 当值变化时，调用 handleValue 同步到 store</span>
        <span class="hljs-title function_">handleValue</span>(value, key, store)
      }
    )
  })
}
</code></pre>
<h2 data-id="heading-0"><strong>核心编程思维提炼</strong></h2>
<h3 data-id="heading-1">1. 配置驱动编程（Configuration-Driven Programming）</h3>
<p>思维：将变化的部分抽离为配置，用统一逻辑处理。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ 硬编码思维（你可能会这样写）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">syncPropsToStore</span>(<span class="hljs-params">props, store</span>) {
  store.<span class="hljs-property">states</span>.<span class="hljs-property">rowKey</span>.<span class="hljs-property">value</span> = props.<span class="hljs-property">rowKey</span>
  store.<span class="hljs-property">states</span>.<span class="hljs-property">data</span>.<span class="hljs-property">value</span> = props.<span class="hljs-property">data</span>
  store.<span class="hljs-property">states</span>.<span class="hljs-property">defaultExpandAll</span>.<span class="hljs-property">value</span> = props.<span class="hljs-property">defaultExpandAll</span>
  <span class="hljs-comment">// ... 每个都要写一遍</span>
}

<span class="hljs-comment">// ✅ 配置驱动思维（Element Plus 的做法）</span>
<span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">rowKey</span>: <span class="hljs-string">'rowKey'</span>,
  <span class="hljs-attr">data</span>: <span class="hljs-string">'data'</span>,
  <span class="hljs-attr">defaultExpandAll</span>: <span class="hljs-string">'defaultExpandAll'</span>
}
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(config).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
  store.<span class="hljs-property">states</span>[config[key]].<span class="hljs-property">value</span> = props[key]
})
</code></pre>
<p>实际应用场景：</p>
<ul>
<li>API 字段映射：后端字段名 → 前端字段名</li>
</ul>

<ul>
<li>表单验证规则：统一配置，统一处理</li>
</ul>

<ul>
<li>权限控制：路由权限配置表</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 实际工作中的应用示例</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_FIELD_MAP</span> = {
  <span class="hljs-string">'user_name'</span>: <span class="hljs-string">'userName'</span>,
  <span class="hljs-string">'create_time'</span>: <span class="hljs-string">'createTime'</span>,
  <span class="hljs-string">'user_info.avatar'</span>: <span class="hljs-string">'avatar'</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">transformApiData</span>(<span class="hljs-params">apiData</span>) {
  <span class="hljs-keyword">const</span> result = {}
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable constant_">API_FIELD_MAP</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">apiKey</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> frontendKey = <span class="hljs-variable constant_">API_FIELD_MAP</span>[apiKey]
    result[frontendKey] = <span class="hljs-title function_">getNestedValue</span>(apiData, apiKey)
  })
  <span class="hljs-keyword">return</span> result
}
</code></pre>
<h3 data-id="heading-2">2. 映射层模式（Mapping Layer Pattern）</h3>
<p>思维：在数据源和目标之间建立映射层，解耦命名差异。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 映射层的作用</span>
<span class="hljs-title class_">Props</span> 命名（用户友好）  →  映射层  →  <span class="hljs-title class_">Store</span> 命名（内部实现）
<span class="hljs-string">'treeProps.hasChildren'</span>  →  <span class="hljs-title class_">InitialStateMap</span>  →  <span class="hljs-string">'lazyColumnIdentifier'</span>
</code></pre>
<p>实际应用场景：</p>
<ul>
<li>第三方 API 对接：外部 API 字段 → 内部数据模型</li>
</ul>

<ul>
<li>多语言支持：语言 key → 翻译文本</li>
</ul>

<ul>
<li>状态机转换：状态名 → 状态值</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 实际工作中的应用示例</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STATUS_MAP</span> = {
  <span class="hljs-string">'pending'</span>: { <span class="hljs-attr">label</span>: <span class="hljs-string">'待处理'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'orange'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">0</span> },
  <span class="hljs-string">'processing'</span>: { <span class="hljs-attr">label</span>: <span class="hljs-string">'处理中'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'blue'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">1</span> },
  <span class="hljs-string">'completed'</span>: { <span class="hljs-attr">label</span>: <span class="hljs-string">'已完成'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'green'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">2</span> }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getStatusInfo</span>(<span class="hljs-params">status</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">STATUS_MAP</span>[status] || <span class="hljs-variable constant_">STATUS_MAP</span>[<span class="hljs-string">'pending'</span>]
}
</code></pre>
<h3 data-id="heading-3">3. 数据转换管道（Data Transformation Pipeline）</h3>
<p>思维：将复杂的数据转换拆分为多个步骤，每个步骤职责单一。</p>
<p>解释 <code>reduce</code> 和数据管道的执行过程：</p>
<h4 data-id="heading-4"><code>reduce</code> 方法详解</h4>
<h4 data-id="heading-5">1. <code>reduce</code> 的基本语法</h4>
<pre><code class="hljs language-javascript" lang="javascript">array.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">accumulator, currentValue</span>) =&gt;</span> {
  <span class="hljs-comment">// 处理逻辑</span>
  <span class="hljs-keyword">return</span> newAccumulator
}, initialValue)
</code></pre>
<ul>
<li><code>accumulator</code>（累加器）：上一次处理的结果</li>
<li><code>currentValue</code>（当前值）：当前处理的元素</li>
<li><code>initialValue</code>（初始值）：第一次处理时的初始值</li>
</ul>
<h4 data-id="heading-6">2. 数据管道的执行过程</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> dataPipeline = [
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">transformApiFields</span>(data),      <span class="hljs-comment">// 步骤1：字段转换</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">validateData</span>(data),            <span class="hljs-comment">// 步骤2：数据验证</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">formatDates</span>(data),             <span class="hljs-comment">// 步骤3：日期格式化</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">enrichData</span>(data),              <span class="hljs-comment">// 步骤4：数据增强</span>
]

<span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">rawData</span>) {
  <span class="hljs-keyword">return</span> dataPipeline.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">data, transform</span>) =&gt;</span> <span class="hljs-title function_">transform</span>(data), rawData)
}
</code></pre>
<h4 data-id="heading-7">3. 逐步执行过程（拆解）</h4>
<p>等价写法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">rawData</span>) {
  <span class="hljs-comment">// 初始值：rawData</span>
  <span class="hljs-keyword">let</span> result = rawData
  
  <span class="hljs-comment">// 第1次循环：transform = transformApiFields</span>
  result = <span class="hljs-title function_">transformApiFields</span>(result)
  <span class="hljs-comment">// 此时 result = transformApiFields(rawData)</span>
  
  <span class="hljs-comment">// 第2次循环：transform = validateData</span>
  result = <span class="hljs-title function_">validateData</span>(result)
  <span class="hljs-comment">// 此时 result = validateData(transformApiFields(rawData))</span>
  
  <span class="hljs-comment">// 第3次循环：transform = formatDates</span>
  result = <span class="hljs-title function_">formatDates</span>(result)
  <span class="hljs-comment">// 此时 result = formatDates(validateData(transformApiFields(rawData)))</span>
  
  <span class="hljs-comment">// 第4次循环：transform = enrichData</span>
  result = <span class="hljs-title function_">enrichData</span>(result)
  <span class="hljs-comment">// 此时 result = enrichData(formatDates(validateData(transformApiFields(rawData))))</span>
  
  <span class="hljs-keyword">return</span> result
}
</code></pre>
<h4 data-id="heading-8">4. 用具体例子演示</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 假设原始数据</span>
<span class="hljs-keyword">const</span> rawData = {
  <span class="hljs-attr">user_name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">create_time</span>: <span class="hljs-string">'2024-01-01'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
}

<span class="hljs-comment">// 定义转换函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">transformApiFields</span> = (<span class="hljs-params">data</span>) =&gt; {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">userName</span>: data.<span class="hljs-property">user_name</span>,  <span class="hljs-comment">// 下划线转驼峰</span>
    <span class="hljs-attr">createTime</span>: data.<span class="hljs-property">create_time</span>,
    <span class="hljs-attr">age</span>: data.<span class="hljs-property">age</span>
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">validateData</span> = (<span class="hljs-params">data</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!data.<span class="hljs-property">userName</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'用户名不能为空'</span>)
  <span class="hljs-keyword">return</span> data
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">formatDates</span> = (<span class="hljs-params">data</span>) =&gt; {
  <span class="hljs-keyword">return</span> {
    ...data,
    <span class="hljs-attr">createTime</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(data.<span class="hljs-property">createTime</span>).<span class="hljs-title function_">toLocaleDateString</span>()
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">enrichData</span> = (<span class="hljs-params">data</span>) =&gt; {
  <span class="hljs-keyword">return</span> {
    ...data,
    <span class="hljs-attr">status</span>: <span class="hljs-string">'active'</span>,
    <span class="hljs-attr">id</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>).<span class="hljs-title function_">substr</span>(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>)
  }
}

<span class="hljs-comment">// 数据管道</span>
<span class="hljs-keyword">const</span> dataPipeline = [
  transformApiFields,
  validateData,
  formatDates,
  enrichData
]

<span class="hljs-comment">// 执行过程</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">rawData</span>) {
  <span class="hljs-keyword">return</span> dataPipeline.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">data, transform</span>) =&gt;</span> <span class="hljs-title function_">transform</span>(data), rawData)
}

<span class="hljs-comment">// 执行结果</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">processData</span>(rawData)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)
<span class="hljs-comment">// {</span>
<span class="hljs-comment">//   userName: '张三',</span>
<span class="hljs-comment">//   createTime: '2024/1/1',</span>
<span class="hljs-comment">//   age: 25,</span>
<span class="hljs-comment">//   status: 'active',</span>
<span class="hljs-comment">//   id: 'abc123xyz'</span>
<span class="hljs-comment">// }</span>
</code></pre>
<h4 data-id="heading-9">5. 执行流程图</h4>
<pre><code class="hljs language-css" lang="css">原始数据: { user_name: <span class="hljs-string">'张三'</span>, create_time: <span class="hljs-string">'2024-01-01'</span>, age: <span class="hljs-number">25</span> }
    ↓
<span class="hljs-selector-attr">[reduce 开始，初始值 = rawData]</span>
    ↓
步骤<span class="hljs-number">1</span>: <span class="hljs-built_in">transformApiFields</span>(rawData)
    → { userName: <span class="hljs-string">'张三'</span>, createTime: <span class="hljs-string">'2024-01-01'</span>, age: <span class="hljs-number">25</span> }
    ↓
步骤<span class="hljs-number">2</span>: <span class="hljs-built_in">validateData</span>(上一步结果)
    → { userName: <span class="hljs-string">'张三'</span>, createTime: <span class="hljs-string">'2024-01-01'</span>, age: <span class="hljs-number">25</span> } (验证通过)
    ↓
步骤<span class="hljs-number">3</span>: <span class="hljs-built_in">formatDates</span>(上一步结果)
    → { userName: <span class="hljs-string">'张三'</span>, createTime: <span class="hljs-string">'2024/1/1'</span>, age: <span class="hljs-number">25</span> }
    ↓
步骤<span class="hljs-number">4</span>: <span class="hljs-built_in">enrichData</span>(上一步结果)
    → { userName: <span class="hljs-string">'张三'</span>, createTime: <span class="hljs-string">'2024/1/1'</span>, age: <span class="hljs-number">25</span>, status: <span class="hljs-string">'active'</span>, id: <span class="hljs-string">'abc123xyz'</span> }
    ↓
最终结果
</code></pre>
<h4 data-id="heading-10">6. 用 for 循环等价写法（更容易理解）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">rawData</span>) {
  <span class="hljs-keyword">let</span> result = rawData  <span class="hljs-comment">// 初始值</span>
  
  <span class="hljs-comment">// 依次执行每个转换函数</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; dataPipeline.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> transform = dataPipeline[i]
    result = <span class="hljs-title function_">transform</span>(result)  <span class="hljs-comment">// 将上一步的结果作为下一步的输入</span>
  }
  
  <span class="hljs-keyword">return</span> result
}
</code></pre>
<h4 data-id="heading-11">7. 为什么用 <code>reduce</code>？</h4>
<p>优势：</p>
<ol>
<li>函数式编程：更简洁、声明式</li>
<li>链式处理：数据像流水线一样依次处理</li>
<li>易于扩展：添加新步骤只需在数组中添加函数</li>
<li>易于测试：每个转换函数可以独立测试</li>
</ol>
<h4 data-id="heading-12">8. 实际工作中的应用场景</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 场景1：表单数据处理</span>
<span class="hljs-keyword">const</span> formDataPipeline = [
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">trimFields</span>(data),           <span class="hljs-comment">// 去除空格</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">validateRequired</span>(data),     <span class="hljs-comment">// 必填验证</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">validateFormat</span>(data),       <span class="hljs-comment">// 格式验证</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">transformToApiFormat</span>(data)  <span class="hljs-comment">// 转换为 API 格式</span>
]

<span class="hljs-comment">// 场景2：列表数据处理</span>
<span class="hljs-keyword">const</span> listDataPipeline = [
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">transformFields</span>(data),      <span class="hljs-comment">// 字段转换</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">filterInvalid</span>(data),        <span class="hljs-comment">// 过滤无效数据</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">sortByDate</span>(data),           <span class="hljs-comment">// 按日期排序</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">paginate</span>(data)              <span class="hljs-comment">// 分页</span>
]

<span class="hljs-comment">// 场景3：API 响应处理</span>
<span class="hljs-keyword">const</span> apiResponsePipeline = [
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">extractData</span>(data),          <span class="hljs-comment">// 提取数据</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">handleError</span>(data),          <span class="hljs-comment">// 错误处理</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">normalizeData</span>(data),      <span class="hljs-comment">// 数据标准化</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">cacheData</span>(data)             <span class="hljs-comment">// 缓存数据</span>
]
</code></pre>
<h4 data-id="heading-13">9. 调试技巧</h4>
<p>如果想看每一步的结果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">rawData</span>) {
  <span class="hljs-keyword">return</span> dataPipeline.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">data, transform, index</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`步骤 <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>:`</span>, data)
    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">transform</span>(data)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`步骤 <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span> 结果:`</span>, result)
    <span class="hljs-keyword">return</span> result
  }, rawData)
}
</code></pre>
<h4 data-id="heading-14">总结</h4>
<ul>
<li><code>reduce</code> 的作用：将数组中的每个函数依次执行，前一个函数的输出作为下一个函数的输入</li>
<li>数据管道：像工厂流水线，数据依次经过每个处理步骤</li>
<li>优势：代码简洁、易于扩展、易于测试</li>
</ul>
<p>这就是函数式编程中的“管道模式”（Pipeline Pattern）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[django操作mysql常见错误大全]]></title>    <link>https://juejin.cn/post/7588043318359015459</link>    <guid>https://juejin.cn/post/7588043318359015459</guid>    <pubDate>2025-12-27T10:45:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588043318359015459" data-draft-id="7587997157238571060" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="django操作mysql常见错误大全"/> <meta itemprop="keywords" content="Django,MySQL"/> <meta itemprop="datePublished" content="2025-12-27T10:45:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            django操作mysql常见错误大全
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T10:45:04.000Z" title="Sat Dec 27 2025 10:45:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>因为我的机器使用的是mysql容器，所以可以打印环境环境获取登录账密</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it db <span class="hljs-built_in">printenv</span> | grep MYSQL
</code></pre>
<p>下面用「Django + MySQL」的视角，把 <strong>开发/上线 99% 会踩的 MySQL 典型错误</strong> 汇总成一张“踩坑地图”。<br/>
每个错误都给出：</p>
<ol>
<li>异常堆栈（Django 真实报错）</li>
<li>根因一句话</li>
<li>复现代码（最小 Django 示例）</li>
<li>修复方案（含 ORM 写法或配置）</li>
</ol>
<p>复制即可复现，跟着敲一遍，以后看到同样日志秒定位。</p>
<hr/>
<h2 data-id="heading-0">0. 环境统一</h2>
<ul>
<li>Django 4.2 + mysqlclient 2.2 + MySQL 8.0</li>
<li>默认配置（不改 SQL_MODE）以便暴露问题</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># settings.py</span>
DATABASES = {
    <span class="hljs-string">"default"</span>: {
        <span class="hljs-string">"ENGINE"</span>: <span class="hljs-string">"django.db.backends.mysql"</span>,
        <span class="hljs-string">"NAME"</span>: <span class="hljs-string">"django_err"</span>,
        <span class="hljs-string">"USER"</span>: <span class="hljs-string">"root"</span>,
        <span class="hljs-string">"PASSWORD"</span>: <span class="hljs-string">"password"</span>,
        <span class="hljs-string">"HOST"</span>: <span class="hljs-string">"127.0.0.1"</span>,
        <span class="hljs-string">"PORT"</span>: <span class="hljs-string">"3306"</span>,
        <span class="hljs-string">"OPTIONS"</span>: {<span class="hljs-string">"init_command"</span>: <span class="hljs-string">"SET sql_mode='STRICT_TRANS_TABLES'"</span>},  <span class="hljs-comment"># 严格模式先打开</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-1">1. Duplicate entry —— 主键/唯一键冲突</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.IntegrityError: (1062, "Duplicate entry 'tom' for key 'users.username'")
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(models.Model):
    username = models.CharField(max_length=<span class="hljs-number">50</span>, unique=<span class="hljs-literal">True</span>)

User.objects.create(username=<span class="hljs-string">"tom"</span>)
User.objects.create(username=<span class="hljs-string">"tom"</span>)  <span class="hljs-comment"># 再敲一次</span>
</code></pre>
<p><strong>修复</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 代码层先查后插 或 数据库层 on conflict</span>
user, created = User.objects.get_or_create(username=<span class="hljs-string">"tom"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-2">2. Data too long —— 列长度超限</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.DataError: (1406, "Data too long for column 'title' at row 1")
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Article</span>(models.Model):
    title = models.CharField(max_length=<span class="hljs-number">10</span>)

Article.objects.create(title=<span class="hljs-string">"12345678901"</span>)  <span class="hljs-comment"># 11 个字符</span>
</code></pre>
<p><strong>修复</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 要么改模型</span>
title = models.CharField(max_length=<span class="hljs-number">255</span>)
<span class="hljs-comment"># 要么截断</span>
Article.objects.create(title=long_title[:<span class="hljs-number">10</span>])
</code></pre>
<hr/>
<h2 data-id="heading-3">3. DoesNotExist —— 查询为空抛异常</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.core.exceptions.ObjectDoesNotExist: User matching query does not exist.
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python">user = User.objects.get(pk=<span class="hljs-number">999</span>)  <span class="hljs-comment"># 没有这条记录</span>
</code></pre>
<p><strong>修复</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 用 filter + first 或 get_object_or_404</span>
user = User.objects.<span class="hljs-built_in">filter</span>(pk=<span class="hljs-number">999</span>).first()  <span class="hljs-comment"># 返回 None</span>
<span class="hljs-keyword">from</span> django.shortcuts <span class="hljs-keyword">import</span> get_object_or_404
user = get_object_or_404(User, pk=<span class="hljs-number">999</span>)
</code></pre>
<hr/>
<h2 data-id="heading-4">4. Field cannot be null —— 非空约束</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.IntegrityError: (1048, "Column 'email' cannot be null")
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(models.Model):
    email = models.EmailField()  <span class="hljs-comment"># 默认 blank=False, null=False</span>

User.objects.create(username=<span class="hljs-string">"tom"</span>)  <span class="hljs-comment"># 没给 email</span>
</code></pre>
<p><strong>修复</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 允许空</span>
email = models.EmailField(blank=<span class="hljs-literal">True</span>, null=<span class="hljs-literal">True</span>)
<span class="hljs-comment"># 2. 给默认值</span>
email = models.EmailField(default=<span class="hljs-string">""</span>)
<span class="hljs-comment"># 3. 代码里传值</span>
User.objects.create(username=<span class="hljs-string">"tom"</span>, email=<span class="hljs-string">"tom@example.com"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-5">5. Incorrect string value —— 表情符/生僻字乱码</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.OperationalError: (1366, "Incorrect string value: '\\xF0\\x9F\\x98\\x80...' for column 'nickname'")
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python">User.objects.create(nickname=<span class="hljs-string">"😀"</span>)  <span class="hljs-comment"># utf8mb3 存不进 emoji</span>
</code></pre>
<p><strong>修复</strong></p>
<ol>
<li>数据库/表/列字符集改成 <code>utf8mb4</code>：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> DATABASE django_err <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users <span class="hljs-keyword">CONVERT</span> <span class="hljs-keyword">TO</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci;
</code></pre>
<ol start="2">
<li>连接层也指定：</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"OPTIONS"</span>: {<span class="hljs-string">"charset"</span>: <span class="hljs-string">"utf8mb4"</span>},
</code></pre>
<p>再插入 emoji 就正常了。</p>
<hr/>
<h2 data-id="heading-6">6. Lost connection —— 长查询被 kill</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.OperationalError: (2013, 'Lost connection to MySQL server during query')
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 故意搞个大表全表扫 + 不睡觉</span>
User.objects.<span class="hljs-built_in">all</span>().select_related(<span class="hljs-string">"profile"</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">100000</span>]  <span class="hljs-comment"># 100 万次 join</span>
</code></pre>
<p><strong>修复</strong></p>
<ul>
<li>优化 SQL（加索引、分页、只取所需列）</li>
<li>调大 <code>wait_timeout</code> / <code>interactive_timeout</code>（治标不治本）</li>
<li>用 <code>iterator()</code> 分批拉：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> User.objects.<span class="hljs-built_in">all</span>().iterator(chunk_size=<span class="hljs-number">2000</span>):
    ...
</code></pre>
<hr/>
<h2 data-id="heading-7">7. Too many connections —— 连接打满</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.OperationalError: (1040, 'Too many connections')
</code></pre>
<p><strong>复现</strong><br/>
并发压测 <code>ab -n 10000 -c 200 ...</code> 超过 <code>max_connections=151</code> 即可。</p>
<p><strong>修复</strong></p>
<ol>
<li>数据库层：温和涨上限</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> max_connections <span class="hljs-operator">=</span> <span class="hljs-number">300</span>;
</code></pre>
<ol start="2">
<li>应用层：用连接池 + 合理并发</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># settings.py 里加</span>
DATABASES[<span class="hljs-string">"default"</span>][<span class="hljs-string">"CONN_MAX_AGE"</span>] = <span class="hljs-number">600</span>  <span class="hljs-comment"># 复用连接</span>
</code></pre>
<ol start="3">
<li>代码里别泄露连接（长时间不 close）</li>
</ol>
<hr/>
<h2 data-id="heading-8">8. Deadlock found —— 并发死锁</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.OperationalError: (1213, 'Deadlock found when trying to get lock; try restarting transaction')
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 两个 view 同时</span>
<span class="hljs-meta">@transaction.atomic</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">debit</span>(<span class="hljs-params">request</span>):
    a = Account.objects.select_for_update().get(<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span>)
    b = Account.objects.select_for_update().get(<span class="hljs-built_in">id</span>=<span class="hljs-number">2</span>)
    ...

<span class="hljs-comment"># 另一个线程反向顺序</span>
<span class="hljs-meta">@transaction.atomic</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">debit2</span>(<span class="hljs-params">request</span>):
    b = Account.objects.select_for_update().get(<span class="hljs-built_in">id</span>=<span class="hljs-number">2</span>)  <span class="hljs-comment"># 先 2</span>
    a = Account.objects.select_for_update().get(<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span>)  <span class="hljs-comment"># 后 1</span>
</code></pre>
<p>交叉拿锁 → 死锁。</p>
<p><strong>修复</strong></p>
<ul>
<li>固定加锁顺序（总是 1→2）</li>
<li>精简事务范围，尽快提交</li>
<li>捕获重试（Django 3.2+ 自动重试 <code>max_retries=3</code>）</li>
</ul>
<hr/>
<h2 data-id="heading-9">9. IntegrityError —— 外键级联失败</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.IntegrityError: (1452, 'Cannot add or update a child row: a foreign key constraint fails ...)
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span>(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)

Order.objects.create(user_id=<span class="hljs-number">9999</span>)  <span class="hljs-comment"># 不存在 user 9999</span>
</code></pre>
<p><strong>修复</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 保证外键值存在</span>
user = User.objects.get(pk=user_id)
Order.objects.create(user=user)
</code></pre>
<hr/>
<h2 data-id="heading-10">10. ProgrammingError —— 拼错 raw SQL</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.ProgrammingError: (1064, "You have an error in your SQL syntax; check the manual ...")
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> connection
<span class="hljs-keyword">with</span> connection.cursor() <span class="hljs-keyword">as</span> c:
    c.execute(<span class="hljs-string">"SELCT * FROM users WHERE id = %s"</span>, [<span class="hljs-number">1</span>])  <span class="hljs-comment"># SELCT 拼错</span>
</code></pre>
<p><strong>修复</strong></p>
<ul>
<li>用 ORM 先顶一波，必须 raw 时开 <code>sql_mode=STRICT</code> 并打印语句再执行。</li>
</ul>
<hr/>
<h2 data-id="heading-11">一键速查表（打印贴墙）</h2>





















































<table><thead><tr><th>错误码</th><th>Django 异常</th><th>典型场景</th><th>最快修复</th></tr></thead><tbody><tr><td>1062</td><td>IntegrityError</td><td>唯一键冲突</td><td><code>get_or_create</code></td></tr><tr><td>1406</td><td>DataError</td><td>列太长</td><td>加长/截断</td></tr><tr><td>1048</td><td>IntegrityError</td><td>非空未给</td><td>设默认值</td></tr><tr><td>1366</td><td>OperationalError</td><td>emoji 乱码</td><td>改 <code>utf8mb4</code></td></tr><tr><td>2013</td><td>OperationalError</td><td>长查询</td><td>索引+分页</td></tr><tr><td>1040</td><td>OperationalError</td><td>连接打满</td><td>连接池+涨上限</td></tr><tr><td>1213</td><td>OperationalError</td><td>死锁</td><td>固定顺序+重试</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-12">结语</h2>
<p>把上面 10 个案例挨个 <code>python manage.py shell</code> 跑一遍，再遇到一样日志就能秒定位。<br/>
建议收藏 + 星标，下次面试/上线/救火，直接翻表。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter组件封装：视频播放组件全局封装]]></title>    <link>https://juejin.cn/post/7588028859540291610</link>    <guid>https://juejin.cn/post/7588028859540291610</guid>    <pubDate>2025-12-26T12:52:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588028859540291610" data-draft-id="7582777037864190002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter组件封装：视频播放组件全局封装"/> <meta itemprop="keywords" content="前端,Flutter"/> <meta itemprop="datePublished" content="2025-12-26T12:52:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SoaringHeart"/> <meta itemprop="url" content="https://juejin.cn/user/3544481219481374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter组件封装：视频播放组件全局封装
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3544481219481374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SoaringHeart
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T12:52:52.000Z" title="Fri Dec 26 2025 12:52:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    21
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、需求来源</h2>
<p>最近要开发一个在线视频播放的功能，每次实时获取播放，有些卡顿和初始化慢的问题，就随手优化一下。</p>
<h2 data-id="heading-1">二、使用示例</h2>
<p>1、数据源</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VideoDetailsProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChangeNotifier</span> </span>{

    <span class="hljs-comment">/// 当前播放中的</span>
    <span class="hljs-keyword">final</span> _videoModelController = <span class="hljs-type">StreamController</span>&lt;<span class="hljs-type">VideoDetailModel</span>?&gt;.broadcast();

    <span class="hljs-comment">/// 当前播放中 Stream&lt;VideoDetailModel&gt;</span>
    <span class="hljs-type">Stream</span>&lt;<span class="hljs-type">VideoDetailModel</span>?&gt; get videoModelStream =&gt; _videoModelController.stream;


    <span class="hljs-comment">/// 点击（model不为空时播放，为空时关闭）</span>
    sinkModelForVideoPlayer({required <span class="hljs-type">VideoDetailModel</span>? model}) {
      _videoModelController.add(model);
    }

}
</code></pre>
<p>2、显示播放器组件</p>
<pre><code class="hljs language-php" lang="php">StreamBuilder&lt;VideoDetailModel<span class="hljs-meta">?&gt;</span>(
  stream: provider.videoModelStream,
  builder: (context, snapshot) {
    <span class="hljs-keyword">if</span> (snapshot.data == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SizedBox</span>();
    }
    <span class="hljs-keyword">final</span> model = snapshot.data;
    <span class="hljs-keyword">if</span> (model?.isVideo != <span class="hljs-literal">true</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SizedBox</span>();
    }

    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">SafeArea</span>(
      <span class="hljs-attr">top</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">bottom</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">left</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">right</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">child</span>: <span class="hljs-title function_ invoke__">Container</span>(
        <span class="hljs-attr">decoration</span>: <span class="hljs-title function_ invoke__">BoxDecoration</span>(
          <span class="hljs-attr">color</span>: Colors.black,
        ),
        <span class="hljs-attr">child</span>: <span class="hljs-title function_ invoke__">AppVideoPlayer</span>(
          <span class="hljs-attr">key</span>: <span class="hljs-title function_ invoke__">Key</span>(model?.url ?? <span class="hljs-string">""</span>),
          <span class="hljs-attr">url</span>: model?.url ?? <span class="hljs-string">""</span>,
          <span class="hljs-attr">onFullScreen</span>: (value) async {
            <span class="hljs-keyword">if</span> (!value) {
              await Future.<span class="hljs-title function_ invoke__">delayed</span>(<span class="hljs-keyword">const</span> <span class="hljs-title function_ invoke__">Duration</span>(<span class="hljs-attr">milliseconds</span>: <span class="hljs-number">300</span>));//等待旋转完成
              SystemChromeExt.<span class="hljs-title function_ invoke__">changeDeviceOrientation</span>(<span class="hljs-attr">isPortrait</span>: <span class="hljs-literal">true</span>);
            }
          },
          <span class="hljs-attr">onClose</span>: () {
            DLog.<span class="hljs-title function_ invoke__">d</span>(<span class="hljs-string">"close"</span>);
            provider.<span class="hljs-title function_ invoke__">sinkModelForVideoPlayer</span>(<span class="hljs-attr">model</span>: <span class="hljs-literal">null</span>);
          },
        ),
      ),
    );
  },
)
</code></pre>
<h2 data-id="heading-2">三、源码</h2>
<h4 data-id="heading-3">1、AppVideoPlayer.dart</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">//</span>
<span class="hljs-comment">//  AppVideoPlayer.dart</span>
<span class="hljs-comment">//  flutter_templet_project</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//  Created by shang on 2025/12/12 18:11.</span>
<span class="hljs-comment">//  Copyright © 2025/12/12 shang. All rights reserved.</span>
<span class="hljs-comment">//</span>

<span class="hljs-keyword">import</span> <span class="hljs-string">'package:chewie/chewie.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_templet_project/basicWidget/AppVideoPlayer/AppVideoPlayerService.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_templet_project/extension/extension_local.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:video_player/video_player.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">播放器</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppVideoPlayer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> AppVideoPlayer({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">this</span>.controller,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.url,
    <span class="hljs-keyword">this</span>.autoPlay = <span class="hljs-keyword">true</span>,
    <span class="hljs-keyword">this</span>.looping = <span class="hljs-keyword">false</span>,
    <span class="hljs-keyword">this</span>.aspectRatio = <span class="hljs-number">16</span> / <span class="hljs-number">9</span>,
    <span class="hljs-keyword">this</span>.isPortrait = <span class="hljs-keyword">true</span>,
    <span class="hljs-keyword">this</span>.fullScreenVN,
    <span class="hljs-keyword">this</span>.onFullScreen,
    <span class="hljs-keyword">this</span>.onClose,
  });

  <span class="hljs-keyword">final</span> AppVideoPlayerController? controller;

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> url;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> autoPlay;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> looping;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> aspectRatio;

  <span class="hljs-comment">/// <span class="markdown">设备方向</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isPortrait;

  <span class="hljs-keyword">final</span> ValueNotifier&lt;<span class="hljs-built_in">bool</span>&gt;? fullScreenVN;

  <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">bool</span> isFullScreen)? onFullScreen;

  <span class="hljs-keyword">final</span> VoidCallback? onClose;

  <span class="hljs-meta">@override</span>
  State&lt;AppVideoPlayer&gt; createState() =&gt; _AppVideoPlayerState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_AppVideoPlayerState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">AppVideoPlayer</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">WidgetsBindingObserver</span>, <span class="hljs-title">AutomaticKeepAliveClientMixin</span> </span>{
  VideoPlayerController? _videoController;
  ChewieController? _chewieController;

  <span class="hljs-built_in">Duration</span> position = <span class="hljs-built_in">Duration</span>.zero;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    widget.controller?._detach(<span class="hljs-keyword">this</span>);
    WidgetsBinding.instance.removeObserver(<span class="hljs-keyword">this</span>);
    _onClose();
    <span class="hljs-comment">// 不销毁 VideoPlayerController，让全局复用</span>
    <span class="hljs-comment">// _chewieController?.dispose();</span>
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    widget.controller?._attach(<span class="hljs-keyword">this</span>);
    WidgetsBinding.instance.addObserver(<span class="hljs-keyword">this</span>);
    WidgetsBinding.instance.addPostFrameCallback((_) {
      initPlayer();
    });
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didChangeAppLifecycleState(AppLifecycleState state) {
    <span class="hljs-keyword">switch</span> (state) {
      <span class="hljs-keyword">case</span> AppLifecycleState.inactive:
      <span class="hljs-keyword">case</span> AppLifecycleState.hidden:
      <span class="hljs-keyword">case</span> AppLifecycleState.paused:
        {
          _chewieController?.pause();
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> AppLifecycleState.detached:
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> AppLifecycleState.resumed:
        {
          _chewieController?.play();
        }
        <span class="hljs-keyword">break</span>;
    }
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; initPlayer() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// DLog.d(widget.url.split("/").last);</span>
    <span class="hljs-keyword">assert</span>(widget.url.startsWith(<span class="hljs-string">"http"</span>), <span class="hljs-string">"url 错误"</span>);

    _videoController = <span class="hljs-keyword">await</span> AppVideoPlayerService.instance.getController(widget.url);

    _chewieController?.dispose();
    _chewieController = ChewieController(
      videoPlayerController: _videoController!,
      autoPlay: widget.autoPlay,
      looping: widget.looping,
      aspectRatio: widget.aspectRatio,
      autoInitialize: <span class="hljs-keyword">true</span>,
      allowFullScreen: <span class="hljs-keyword">true</span>,
      allowMuting: <span class="hljs-keyword">false</span>,
      showControlsOnInitialize: <span class="hljs-keyword">false</span>,
      <span class="hljs-comment">// customControls: const AppVideoControls(),</span>
    );

    _chewieController!.addListener(() {
      <span class="hljs-keyword">final</span> isFullScreen = _chewieController!.isFullScreen;
      widget.fullScreenVN?.value = isFullScreen;
      widget.onFullScreen?.call(isFullScreen);
      <span class="hljs-keyword">if</span> (isFullScreen) {
        DLog.d(<span class="hljs-string">"进入全屏"</span>);
      } <span class="hljs-keyword">else</span> {
        DLog.d(<span class="hljs-string">"退出全屏"</span>);
      }
    });
    <span class="hljs-keyword">if</span> (mounted) {
      setState(() {});
    }
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; _onClose() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (_videoController?.value.isPlaying == <span class="hljs-keyword">true</span>) {
      _videoController?.pause();
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didUpdateWidget(<span class="hljs-keyword">covariant</span> AppVideoPlayer oldWidget) {
    <span class="hljs-keyword">super</span>.didUpdateWidget(oldWidget);
    <span class="hljs-keyword">if</span> (oldWidget.url != widget.url) {
      initPlayer();
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didChangeDependencies() {
    <span class="hljs-keyword">super</span>.didChangeDependencies();

    <span class="hljs-comment">/// <span class="markdown">🔥屏幕横竖切换时 rebuild Chewie，但不 rebuild video</span></span>
    DLog.d([MediaQuery.of(context).orientation]);
    <span class="hljs-comment">// setState(() {});</span>
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">super</span>.build(context);
    <span class="hljs-keyword">if</span> (widget.url.startsWith(<span class="hljs-string">"http"</span>) != <span class="hljs-keyword">true</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> SizedBox();
    }

    <span class="hljs-keyword">if</span> (_chewieController == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Center(child: CircularProgressIndicator());
    }
    <span class="hljs-comment">// return Chewie(controller: _chewieController!);</span>
    <span class="hljs-keyword">return</span> Stack(
      children: [
        Positioned.fill(
          child: Chewie(
            controller: _chewieController!,
          ),
        ),
        Positioned(
          right: <span class="hljs-number">20</span>,
          top: <span class="hljs-number">10</span>,
          child: Container(
            <span class="hljs-comment">// decoration: BoxDecoration(</span>
            <span class="hljs-comment">//   color: Colors.red,</span>
            <span class="hljs-comment">//   border: Border.all(color: Colors.blue),</span>
            <span class="hljs-comment">// ),</span>
            child: buildCloseBtn(onTap: widget.onClose),
          ),
        ),
      ],
    );
  }

  Widget buildCloseBtn({VoidCallback? onTap}) {
    <span class="hljs-keyword">return</span> GestureDetector(
      behavior: HitTestBehavior.opaque,
      onTap: () {
        DLog.d(<span class="hljs-string">"buildCloseBtn"</span>);
        _onClose();
        <span class="hljs-keyword">if</span> (onTap != <span class="hljs-keyword">null</span>) {
          onTap();
          <span class="hljs-keyword">return</span>;
        }
        Navigator.pop(context);
      },
      child: Container(
        <span class="hljs-comment">// padding: EdgeInsets.all(6),</span>
        <span class="hljs-comment">// decoration: BoxDecoration(</span>
        <span class="hljs-comment">//   color: Colors.black54,</span>
        <span class="hljs-comment">//   shape: BoxShape.circle,</span>
        <span class="hljs-comment">//   border: Border.all(color: Colors.blue),</span>
        <span class="hljs-comment">// ),</span>
        child: <span class="hljs-keyword">const</span> Icon(Icons.close, color: Colors.white, size: <span class="hljs-number">24</span>),
      ),
    );
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> wantKeepAlive =&gt; <span class="hljs-keyword">true</span>;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppVideoPlayerController</span> </span>{
  _AppVideoPlayerState? _anchor;

  <span class="hljs-keyword">void</span> _attach(_AppVideoPlayerState anchor) {
    _anchor = anchor;
  }

  <span class="hljs-keyword">void</span> _detach(_AppVideoPlayerState anchor) {
    <span class="hljs-keyword">if</span> (_anchor == anchor) {
      _anchor = <span class="hljs-keyword">null</span>;
    }
  }

  VideoPlayerController? <span class="hljs-keyword">get</span> videoController {
    <span class="hljs-keyword">assert</span>(_anchor != <span class="hljs-keyword">null</span>);
    <span class="hljs-keyword">return</span> _anchor!._videoController;
  }

  ChewieController? <span class="hljs-keyword">get</span> chewieController {
    <span class="hljs-keyword">assert</span>(_anchor != <span class="hljs-keyword">null</span>);
    <span class="hljs-keyword">return</span> _anchor!._chewieController;
  }
}
</code></pre>
<h4 data-id="heading-4">2、AppVideoPlayerService.dart</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">//</span>
<span class="hljs-comment">//  AppVideoPlayerService.dart</span>
<span class="hljs-comment">//  flutter_templet_project</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//  Created by shang on 2025/12/12 18:10.</span>
<span class="hljs-comment">//  Copyright © 2025/12/12 shang. All rights reserved.</span>
<span class="hljs-comment">//</span>

<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_templet_project/extension/extension_local.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:quiver/collection.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:video_player/video_player.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">视频播放控制器全局管理</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppVideoPlayerService</span> </span>{
  AppVideoPlayerService._();
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> AppVideoPlayerService _instance = AppVideoPlayerService._();
  <span class="hljs-keyword">factory</span> AppVideoPlayerService() =&gt; _instance;
  <span class="hljs-keyword">static</span> AppVideoPlayerService <span class="hljs-keyword">get</span> instance =&gt; _instance;

  <span class="hljs-comment">/// <span class="markdown">播放器字典</span></span>
  LruMap&lt;<span class="hljs-built_in">String</span>, VideoPlayerController&gt; <span class="hljs-keyword">get</span> controllerMap =&gt; _controllerMap;
  <span class="hljs-comment">// final _controllerMap = &lt;String, VideoPlayerController&gt;{};</span>
  <span class="hljs-keyword">final</span> _controllerMap = LruMap&lt;<span class="hljs-built_in">String</span>, VideoPlayerController&gt;(maximumSize: <span class="hljs-number">10</span>);

  <span class="hljs-comment">/// <span class="markdown">最新使用播放器</span></span>
  VideoPlayerController? current;

  <span class="hljs-comment">/// <span class="markdown">有缓存控制器</span></span>
  <span class="hljs-built_in">bool</span> hasCtrl({<span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> url}) =&gt; _controllerMap[url] != <span class="hljs-keyword">null</span>;

  <span class="hljs-comment">/// <span class="markdown">是网络视频</span></span>
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> isVideo(<span class="hljs-built_in">String?</span> url) {
    <span class="hljs-keyword">if</span> (url?.isNotEmpty != <span class="hljs-keyword">true</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    <span class="hljs-keyword">final</span> videoUri = <span class="hljs-built_in">Uri</span>.tryParse(url!);
    <span class="hljs-keyword">if</span> (videoUri == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    <span class="hljs-keyword">final</span> videoExt = [<span class="hljs-string">'.mp4'</span>, <span class="hljs-string">'.mov'</span>, <span class="hljs-string">'.avi'</span>, <span class="hljs-string">'.wmv'</span>, <span class="hljs-string">'.flv'</span>, <span class="hljs-string">'.mkv'</span>, <span class="hljs-string">'.webm'</span>];
    <span class="hljs-keyword">final</span> ext = url.toLowerCase();
    <span class="hljs-keyword">final</span> result = videoExt.any((e) =&gt; ext.endsWith(e));
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-comment">/// <span class="markdown">获取 VideoPlayerController</span></span>
  Future&lt;VideoPlayerController?&gt; getController(<span class="hljs-built_in">String</span> url, {<span class="hljs-built_in">bool</span> isLog = <span class="hljs-keyword">false</span>}) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">assert</span>(url.startsWith(<span class="hljs-string">"http"</span>), <span class="hljs-string">"必须是视频链接,请检查链接是否合法"</span>);
    <span class="hljs-keyword">final</span> vc = _controllerMap[url];
    <span class="hljs-keyword">if</span> (vc != <span class="hljs-keyword">null</span>) {
      current = vc;
      <span class="hljs-keyword">if</span> (isLog) {
        DLog.d([<span class="hljs-string">"缓存: <span class="hljs-subst">${vc.hashCode}</span>"</span>]);
      }
      <span class="hljs-keyword">return</span> vc;
    }

    <span class="hljs-keyword">final</span> videoUri = <span class="hljs-built_in">Uri</span>.tryParse(url);
    <span class="hljs-keyword">if</span> (videoUri == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-keyword">final</span> ctrl = VideoPlayerController.networkUrl(videoUri);
    <span class="hljs-keyword">await</span> ctrl.initialize();
    _controllerMap[url] = ctrl;
    current = ctrl;
    <span class="hljs-keyword">if</span> (isLog) {
      DLog.d([<span class="hljs-string">"新建: <span class="hljs-subst">${_controllerMap[url].hashCode}</span>"</span>]);
    }
    <span class="hljs-keyword">return</span> ctrl;
  }

  <span class="hljs-comment">/// <span class="markdown">播放</span></span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; play({<span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> url, <span class="hljs-built_in">bool</span> onlyOne = <span class="hljs-keyword">true</span>}) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> getController(url);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> e <span class="hljs-keyword">in</span> _controllerMap.entries) {
      <span class="hljs-keyword">if</span> (e.key == url) {
        <span class="hljs-keyword">if</span> (!e.value.value.isPlaying) {
          e.value.play();
        } <span class="hljs-keyword">else</span> {
          e.value.pause();
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (onlyOne) {
          e.value.pause();
        }
      }
    }
  }

  <span class="hljs-comment">/// <span class="markdown">暂停所有视频</span></span>
  <span class="hljs-keyword">void</span> pauseAll() {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> e <span class="hljs-keyword">in</span> _controllerMap.entries) {
      e.value.pause();
    }
  }

  <span class="hljs-keyword">void</span> dispose(<span class="hljs-built_in">String</span> url) {
    _controllerMap[url]?.dispose();
    _controllerMap.remove(url);
  }

  <span class="hljs-keyword">void</span> disposeAll() {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> c <span class="hljs-keyword">in</span> _controllerMap.values) {
      c.dispose();
    }
    _controllerMap.clear();
  }
}
</code></pre>
<h2 data-id="heading-5">最后、总结</h2>
<p>1、播放视频组件和视频列表是分开的，通过监听 VideoPlayerController 保持状态（播放，暂停）一致性，类似网络视频小窗口播放。</p>
<p>2、通过 AppVideoPlayerService 实现全局 VideoPlayerController 缓存，提高初始化加载速度。</p>
<p>3、通过 quiver 的 LruMap 实现最大缓存数控制，防止内存爆炸。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshang1219178163%2Fflutter_templet_project%2Ftree%2Fv3.27.0%2Flib%2FbasicWidget%2FAppVideoPlayer" target="_blank" title="https://github.com/shang1219178163/flutter_templet_project/tree/v3.27.0/lib/basicWidget/AppVideoPlayer" ref="nofollow noopener noreferrer">github</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【前端学习AI】Python环境搭建]]></title>    <link>https://juejin.cn/post/7588004601393266722</link>    <guid>https://juejin.cn/post/7588004601393266722</guid>    <pubDate>2025-12-27T09:04:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588004601393266722" data-draft-id="7588004601393250338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【前端学习AI】Python环境搭建"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T09:04:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【前端学习AI】Python环境搭建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T09:04:30.000Z" title="Sat Dec 27 2025 09:04:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">Anaconda：多版本环境管理工具</h2>
<h3 data-id="heading-1">工具概述</h3>
<p>Anaconda 是 Python 数据科学领域常用的环境管理工具，可快速创建、切换多版本 Python 环境，避免版本冲突，同时内置大量科学计算依赖包。</p>
<h3 data-id="heading-2">安装方式</h3>
<h4 data-id="heading-3">1. 下载渠道选择（优先镜像源）</h4>
<p>官方下载渠道存在两大痛点：① 需登录账号才能下载；② 服务器位于境外，国内下载速度极慢。</p>
<p><strong>推荐渠道</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.tuna.tsinghua.edu.cn%2Fanaconda%2Farchive%2F" target="_blank" title="https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/" ref="nofollow noopener noreferrer">清华镜像源</a>，无需登录，下载速度快，资源与官方同步。</p>
<h4 data-id="heading-4">2. 版本选择原则</h4>
<p>核心标准：以「发布日期」为判断依据，优先选择最新版本，避免旧版本存在的兼容性错误、安装异常等问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8abfa762ea74bdfb015f629cd3d45ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5rOl56eN6I236Iqx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767431070&amp;x-signature=Ew1mhq2W%2BqyonwoZ9hYuv8ivBGc%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>注意</strong>：不要直接选择网页最底部的版本，需按发布日期排序后挑选最新版。</p>
</blockquote>
<blockquote>
<p><strong>注意</strong>：官方已停止发布Windows32位的软件</p>
</blockquote>
<h4 data-id="heading-5">3. 配置环境变量</h4>
<p>Anaconda 安装后需手动配置环境变量，否则无法在控制台直接使用 <code>conda</code> 命令。</p>
<h5 data-id="heading-6">3.1 配置步骤</h5>
<ol>
<li>进入系统设置：设置 → 系统 → 关于 → 高级系统设置 → 环境变量；</li>
<li>在「系统变量」中找到 <code>Path</code> 变量，点击「编辑」；</li>
<li>新增 Anaconda 相关路径（参考下方默认路径，需根据实际安装目录调整）；</li>
<li>保存配置，重启控制台使设置生效。</li>
</ol>
<h5 data-id="heading-7">3.2 默认环境变量路径（参考）</h5>
<pre><code class="hljs language-text" lang="text">C:\ProgramData\anaconda3
C:\ProgramData\anaconda3\Scripts
C:\ProgramData\anaconda3\Library\bin
</code></pre>
<h5 data-id="heading-8">3.3 安装与配置验证</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 conda 版本，正常显示版本号则安装配置成功</span>
conda --version
</code></pre>
<blockquote>
<p><strong>提示</strong>：若提示“conda 不是内部或外部命令”，请检查环境变量路径是否正确，或重启控制台重试。</p>
</blockquote>
<h3 data-id="heading-9">使用示例</h3>
<p>Anaconda 的核心价值在于环境的创建、切换、管理，建议使用 Anaconda  内置安装的界面应用 Anaconda  Navigator。</p>
<h2 data-id="heading-10">uv： Python 包管理器</h2>
<h3 data-id="heading-11">工具概述</h3>
<p>uv 由 Astral 公司基于 Rust 开发，兼容 pip 使用习惯，核心优势为「安装速度极快」「内存占用低」「内置虚拟环境管理」，是 pip/venv 的高效替代方案，可大幅提升包安装与项目管理效率。</p>
<h3 data-id="heading-12">安装方式</h3>
<h4 data-id="heading-13">1. 安装方法（优先镜像源）</h4>
<p>直接从官方源安装易因网络问题导致超时，推荐使用国内镜像源，Windows/macOS/Linux 系统通用。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 清华 PyPI 镜像安装（推荐）</span>
pip3 install uv -i https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre>
<h5 data-id="heading-14">1.1 安装验证</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 uv 版本，正常显示版本号则安装成功</span>
uv --version
</code></pre>
<blockquote>
<p><strong>提示</strong>：若 Windows 系统提示“uv 不是内部或外部命令”，需检查 Python 的 Scripts 目录（如 C:\ProgramData\anaconda3\Scripts）是否加入环境变量，或重启终端重试。</p>
</blockquote>
<h3 data-id="heading-15">使用示例</h3>
<h4 data-id="heading-16">1. 初始化项目</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化名为 project_demo 的项目（会自动生成 pyproject.toml 文件）</span>
uv init project_demo
</code></pre>
<h4 data-id="heading-17">2. 配置镜像源</h4>
<p>在项目根目录的 <code>pyproject.toml</code> 文件中配置 uv 镜像源，确保后续包安装速度：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[project]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"project_demo"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.13"</span>  <span class="hljs-comment"># 需根据实际使用的 Python 版本调整</span>

<span class="hljs-section">[tool.uv]</span>
<span class="hljs-comment"># 配置清华 PyPI 镜像源</span>
<span class="hljs-attr">index-url</span> = <span class="hljs-string">"https://pypi.tuna.tsinghua.edu.cn/simple"</span>
</code></pre>
<blockquote>
<p><strong>提示</strong>：全局安装uv模块，需要以管理员身份运行cmd窗口</p>
</blockquote>
<h4 data-id="heading-18">3.安装模块</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 langchain_openai 模块</span>
uv add langchain_openai
</code></pre>
<h2 data-id="heading-19">Ruff：高性能代码检查与格式化工具</h2>
<h3 data-id="heading-20">工具概述</h3>
<p>Ruff 是基于 Rust 开发的 Python 代码检查（Linter）与格式化（Formatter）二合一工具，核心价值是自动化规范代码风格、检测潜在问题，提升开发效率与代码质量。</p>
<h3 data-id="heading-21">配置文件（pyproject.toml）</h3>
<p>通过项目根目录的 <code>pyproject.toml</code> 文件自定义 Ruff 规则，优先级高于默认配置，可适配项目专属规范。</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[project]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"project-demo"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.10"</span>

<span class="hljs-section">[tool.ruff]</span>
<span class="hljs-attr">target-version</span> = <span class="hljs-string">"py310"</span>  <span class="hljs-comment"># 适配的 Python 版本，与上方保持一致</span>
<span class="hljs-attr">line-length</span> = <span class="hljs-number">88</span>  <span class="hljs-comment"># 代码行长度限制（默认 88，符合 PEP8 规范）</span>

<span class="hljs-section">[tool.ruff.lint]</span>
<span class="hljs-comment"># 启用核心规则集（推荐，避免过度检查）</span>
<span class="hljs-attr">select</span> = [<span class="hljs-string">"E"</span>, <span class="hljs-string">"W"</span>, <span class="hljs-string">"F"</span>, <span class="hljs-string">"I"</span>, <span class="hljs-string">"B"</span>]
<span class="hljs-comment"># 禁用特定规则（根据项目需求调整，示例：禁用行长度检查）</span>
<span class="hljs-attr">disable</span> = [<span class="hljs-string">"E501"</span>]
<span class="hljs-comment"># 忽略无需检查的文件/目录（必配置，避免检查冗余文件）</span>
<span class="hljs-attr">exclude</span> = [
    <span class="hljs-string">"venv/"</span>,
    <span class="hljs-string">"__pycache__/"</span>,
    <span class="hljs-string">"build/"</span>,
    <span class="hljs-string">"dist/"</span>,
    <span class="hljs-string">".git/"</span>
]

<span class="hljs-section">[tool.ruff.format]</span>
<span class="hljs-attr">line-length</span> = <span class="hljs-number">88</span>  <span class="hljs-comment"># 格式化行长度与检查规则保持一致</span>
<span class="hljs-attr">quote-style</span> = <span class="hljs-string">"preserve"</span>  <span class="hljs-comment"># 保留原有引号风格（默认会统一为双引号）</span>
</code></pre>

























<table><thead><tr><th align="left">规则类别</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left">E/W</td><td align="left">PEP8 规范相关问题（如缩进错误、空格缺失）</td></tr><tr><td align="left">F</td><td align="left">代码逻辑错误（如未定义变量、函数参数错误）</td></tr><tr><td align="left">I</td><td align="left">导入相关问题（如未使用导入、导入顺序混乱）</td></tr><tr><td align="left">B</td><td align="left">潜在 Bug 风险（如不安全的断言、空 except 语句）</td></tr></tbody></table>
<h3 data-id="heading-22">控制台集成</h3>
<h4 data-id="heading-23">1. 使用 pip 安装</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基础安装</span>
pip install ruff

<span class="hljs-comment"># 国内镜像源加速安装（推荐，解决下载慢问题）</span>
pip install ruff -i https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre>
<h5 data-id="heading-24">1.1 安装验证</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 Ruff 版本，正常显示版本号则安装成功</span>
ruff --version
</code></pre>
<h3 data-id="heading-25">控制台使用示例</h3>
<p>Ruff 的核心命令分为两类：「代码检查」（<code>ruff check</code>）和「代码格式化」（<code>ruff format</code>），分工明确，配合使用效果最佳。</p>
<h4 data-id="heading-26">代码格式化（ruff format）</h4>
<p>作用：自动优化代码样式，解决缩进混乱、空格缺失、行过长等格式问题，让代码整洁统一。</p>
<h5 data-id="heading-27">基础用法</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 格式化单个文件</span>
ruff format main.py

<span class="hljs-comment"># 格式化指定目录（递归处理所有 .py 文件）</span>
ruff format ./src/

<span class="hljs-comment"># 格式化当前目录所有文件（最常用）</span>
ruff format .
</code></pre>
<h5 data-id="heading-28">只检查不修改（--check 参数）</h5>
<p>适用于代码提交前校验，仅检测格式问题，不实际修改文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查单个文件格式</span>
ruff format --check main.py

<span class="hljs-comment"># 检查当前目录所有文件格式</span>
ruff format --check .
</code></pre>
<h4 data-id="heading-29">代码检查（ruff check）</h4>
<p>作用：检测代码中的逻辑错误、规范违规等问题（如未定义变量、未使用导入），仅报告问题，不主动修改文件。</p>
<h5 data-id="heading-30">基础用法</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查单个文件</span>
ruff check main.py

<span class="hljs-comment"># 检查当前目录所有文件</span>
ruff check .
</code></pre>
<h5 data-id="heading-31">自动修复问题（--fix 参数）</h5>
<p>一键修复支持自动修复的问题（如删除未使用导入、调整缩进）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 自动修复单个文件的可修复问题</span>
ruff check --fix main.py

<span class="hljs-comment"># 自动修复当前目录所有文件的可修复问题</span>
ruff check --fix .
</code></pre>
<h4 data-id="heading-32">核心命令区别对比</h4>



































<table><thead><tr><th align="left">命令</th><th align="left">核心目标</th><th align="left">是否修改文件</th><th align="left">典型场景</th></tr></thead><tbody><tr><td align="left">ruff format</td><td align="left">调整代码样式（美观度、统一性）</td><td align="left">✅ 是</td><td align="left">本地开发时统一代码格式</td></tr><tr><td align="left">ruff format --check</td><td align="left">检查格式问题，不修复</td><td align="left">❌ 否</td><td align="left">代码提交前格式合规校验</td></tr><tr><td align="left">ruff check</td><td align="left">检测代码错误、逻辑风险</td><td align="left">❌ 否</td><td align="left">开发中排查代码潜在问题</td></tr><tr><td align="left">ruff check --fix</td><td align="left">修复代码错误、规范违规问题</td><td align="left">✅ 是</td><td align="left">批量修复项目中的违规代码</td></tr></tbody></table>
<h3 data-id="heading-33">VS Code编辑器集成</h3>
<p>可实现「保存时自动格式化+自动修复问题」，无需手动执行命令，提升开发效率。</p>
<h4 data-id="heading-34">1. 安装 Ruff 插件</h4>
<ol>
<li>打开 VS Code，点击左侧「扩展」图标。</li>
<li>在搜索框输入「Ruff」，选择官方出品的插件。</li>
<li>点击「安装」，等待安装完成。</li>
</ol>
<h4 data-id="heading-35">2. 配置自动保存触发</h4>
<ol>
<li>在项目根目录新建文件夹 <code>.vscode</code>。</li>
<li>在 <code>.vscode</code> 文件夹内新建文件 <code>settings.json</code>。</li>
<li>写入以下配置：</li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// 保存时自动格式化代码</span>
    <span class="hljs-attr">"editor.formatOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 保存时自动触发代码检查修复</span>
    <span class="hljs-attr">"editor.codeActionsOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"source.fixAll"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"always"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 将 Ruff 设置为 Python 文件的默认格式化工具</span>
    <span class="hljs-attr">"[python]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"charliermarsh.ruff"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>配置生效后，编辑 Python 文件并保存（Ctrl+S），会自动执行 Ruff 格式化与可修复问题修复。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别传统低效！AgentRun 如何用 Serverless + Agent 打造现代化的舆情分析系统？]]></title>    <link>https://juejin.cn/post/7587998744294719494</link>    <guid>https://juejin.cn/post/7587998744294719494</guid>    <pubDate>2025-12-26T10:25:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587998744294719494" data-draft-id="7587998744294424582" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别传统低效！AgentRun 如何用 Serverless + Agent 打造现代化的舆情分析系统？"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-26T10:25:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别传统低效！AgentRun 如何用 Serverless + Agent 打造现代化的舆情分析系统？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:25:17.000Z" title="Fri Dec 26 2025 10:25:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：江昱</p>
<p>舆情分析是企业感知市场脉搏、预警公关危机的“听诊器”，然而传统的舆情分析系统更像是一个个“手工作坊”，面临数据收集效率低、分析深度不够、实时性差等问题，经常反馈之后，等企业拿到报告时，舆论热点早已转移，错过最佳时间。这些挑战，正是所有舆情系统开发者共同的痛点。</p>
<p>本方案将基于真实的代码实现，向您介绍如何使用函数计算 AgentRun 平台，构建一个现代化的“舆情分析专家”，<strong>该系统不仅实现了从数据采集到报告生成的可视化、全流程自动化，更通过流式架构，让洞察实时呈现。</strong></p>
<h2 data-id="heading-0">系统架构设计</h2>
<p>整个舆情分析系统采用分层架构设计，核心思想是通过代码严格控制流程执行顺序，而非依赖 LLM 的自主决策。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2b33e0db21440e8a5e7692c9e80eee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=e17egUD1fN2nxegUH1NiMJ9QW9o%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">快速体验和效果预览</h2>
<p>在深入技术细节前，我们先直观感受一下这套系统的效果。通过 AgentRun 平台，只需简单几步即可完成部署。</p>
<h3 data-id="heading-2">快速部署</h3>
<p>打开阿里云函数计算 AgentRun 探索页面：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8251150fb8fe44c3b0ce7b9bcca453af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=XigYs%2B%2FF2WIkqzNq7XkuS6etzWU%3D" alt="图片" loading="lazy"/></p>
<p>可以找到舆情分析专家案例，并点击卡片右下角进行部署，填写完整对应的参数信息即可点击右下角确定创建按钮：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e08339566414b16ae6d04f225f5403a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=h2f8rKDyFb4nUbxzwjurgt%2Ff8W4%3D" alt="图片" loading="lazy"/></p>
<p>此处需要稍等片刻，创建完之后可以看到体验地址，也可以跳转到运行时与沙箱看到部署完的 Agent：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37b6f6d2b3394d4d902053ffa8c127be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=qaaZpWZiU82BqewpWU8nd9M5rRw%3D" alt="图片" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f94cdee53e543a49247c8e2bf19ba3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=hKzteXD4wlEFD%2F1wXxPuCxp4i5E%3D" alt="图片" loading="lazy"/></p>
<p>首页地址即右侧 <code>main_web</code> 地址，直接查看线上效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04adff44127141059fa20f50a065734b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=xBW%2BaqF3Ff%2FS2qrqm%2BPughaIq64%3D" alt="图片" loading="lazy"/></p>
<p>也可以查看该应用案例代码，并进行在线二次开发：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aff65e6b0fbf472383cfea7e62dc41f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=Gjct%2BWU%2BX0GtLt0iKi38vEHqzrA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">效果体验</h3>
<p>打开体验地址，可以看到舆情分析专家页面，此时可以输入一个词进行舆情分析：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e85d5f4bb89e4cc49bc5fb2d8bd6c99b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=VqRXCcfCOQMNs6tRSPeG8ypMvZQ%3D" alt="图片" loading="lazy"/></p>
<p>分析过程中，系统会调用函数计算 AgentRun 的 Sandbox 沙箱（确切说是创建的时候，选择的浏览器沙箱），可以看到 AI 控制云上的浏览器进行数据检索：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da85bf3d6e474aeb83af3090b2cbb8e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=AtItZdsToxHhYgp9iLLbZ3I%2B8NA%3D" alt="图片" loading="lazy"/></p>
<p>完成之后，系统会整理所有采集到的数据和信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d657c650fbd4964b94801ac83e67c9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=nBd6IoDZ5%2Bm1yr1Vj8iViXjDiYQ%3D" alt="图片" loading="lazy"/></p>
<p>最终生成文字+图表的“可视化报告”：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41ee44786a594c39a7d3d9a1e6c0ae14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=4ud8UbB2u6GmL0VNgdL3oi%2FlHW8%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eb00b156cc44b8693697aa9034b5a81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=mgJR4KqfHaD9Hzd6NWL0K0Zm0ug%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">AgentRun 相比传统方案的核心优势</h2>
<h3 data-id="heading-5">安全隔离的执行环境</h3>
<p>传统舆情系统通常直接在服务器上运行爬虫程序，面临着安全风险和环境污染问题。当某个网站的反爬机制触发时，可能影响整个服务器的稳定性。而 AgentRun Sandbox 提供了完全隔离的浏览器环境，即使单个采集任务出现问题，也不会影响系统的整体运行。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_browser_sandbox</span>() -&gt; <span class="hljs-type">Optional</span>[BrowserSandbox]:
    <span class="hljs-string">"""创建隔离的浏览器环境，避免环境污染"""</span>
    <span class="hljs-keyword">try</span>:
        sandbox = <span class="hljs-keyword">await</span> Sandbox.create_async(
            template_type=TemplateType.BROWSER,
            template_name=agentrun_browser_sandbox_name,
        )
        _sandboxes[sandbox.sandbox_id] = sandbox
        <span class="hljs-keyword">return</span> sandbox
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># 单个Sandbox失败不影响其他实例</span>
        <span class="hljs-keyword">raise</span> SandboxCreationError(<span class="hljs-string">f"创建 Sandbox 失败: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h3 data-id="heading-6">真实浏览器环境模拟</h3>
<p>传统爬虫方案通常使用简单的 HTTP 请求库，容易被现代网站的反爬机制识别和拦截。AgentRun Sandbox 提供的是真实的 Chrome 浏览器环境，能够完整执行 JavaScript、处理复杂的页面交互，大大提高了数据采集的成功率。从代码中可以看到，系统通过 Playwright 连接到真实的 Chrome 实例：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> <span class="hljs-title">async_playwright</span>() <span class="hljs-keyword">as</span> playwright:
    browser</span> = <span class="hljs-keyword">await</span> playwright.chromium.connect_over_cdp(sandbox.get_cdp_url())
    context = browser.contexts[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> browser.contexts <span class="hljs-keyword">else</span> <span class="hljs-keyword">await</span> browser.new_context()
    page = context.pages[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> context.pages <span class="hljs-keyword">else</span> <span class="hljs-keyword">await</span> context.new_page()
</code></pre>
<h3 data-id="heading-7">可视化调试能力</h3>
<p>函数计算 AgentRun 最独特的优势是提供了实时的 VNC 预览功能，开发者和用户可以实时观察浏览器的操作过程。这种透明性在传统方案中是无法实现的，它不仅有助于调试和优化采集逻辑，还能让用户直观地了解系统的工作状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6f57bcd347d48788a3d988d39013957~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=vOQWwMQljnWyZPeKCmaGs0cfHUs%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-8">弹性扩展和故障恢复</h3>
<p>传统系统在面临大规模采集任务时，往往需要复杂的分布式架构设计。而函数计算 AgentRun 天然支持多 Sandbox 并行处理，系统可以根据需要动态创建和销毁浏览器实例。更重要的是，当某个实例出现故障时，系统能够自动检测并重建：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">recreate_sandbox_if_closed</span>(<span class="hljs-params">sandbox_id: <span class="hljs-built_in">str</span>, error_message: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""智能故障检测和自动重建机制"""</span>
    closed_error_patterns = [
        <span class="hljs-string">"Target page, context or browser has been closed"</span>,
        <span class="hljs-string">"Browser has been closed"</span>,
        <span class="hljs-string">"Connection closed"</span>,
    ]
    is_closed_error = <span class="hljs-built_in">any</span>(pattern.lower() <span class="hljs-keyword">in</span> error_message.lower() 
                         <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> closed_error_patterns)
    <span class="hljs-keyword">if</span> is_closed_error:
        <span class="hljs-keyword">await</span> remove_sandbox(sandbox_id)
        new_sandbox = <span class="hljs-keyword">await</span> create_browser_sandbox()
        <span class="hljs-keyword">return</span> new_sandbox
</code></pre>
<p>AgentRun Sandbox 采用阿里云函数计算实现，支持百万沙箱模板（函数级别）并发运行，Serverless 弹性伸缩，支持 3.5w+ 沙箱/分钟，支持缩容到 0，按请求感知调度。</p>
<h2 data-id="heading-9">后端核心实现</h2>
<h3 data-id="heading-10">Agent 工具链设计</h3>
<p>系统的核心是一个基于 PydanticAI 的智能体，该智能体包含四个关键工具，每个工具负责舆情分析的不同阶段。Agent 的设计遵循严格的执行顺序，确保数据收集的完整性和分析的准确性。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">opinion_agent</span> = Agent(
    agentrun_model,
    <span class="hljs-attr">deps_type</span>=StateDeps,
    <span class="hljs-attr">system_prompt</span>=<span class="hljs-string">"""你是舆情分析系统的执行者。
你的任务是按照以下严格流程执行舆情分析：
【流程】
1. 收到关键词后，调用 collect_data 工具收集数据
2. 数据收集完成后，调用 analyze_data 工具分析数据
3. 分析完成后，调用 write_report 工具撰写报告
4. 报告完成后，调用 render_html 工具生成 HTML
【重要规则】
- 必须按顺序调用工具
- 每个工具只调用一次
- 不要跳过任何步骤
- 不要编造数据
"""</span>,
    <span class="hljs-attr">retries</span>=<span class="hljs-number">3</span>,
)
</code></pre>
<h3 data-id="heading-11">流式输出与实时反馈</h3>
<p>传统舆情系统通常采用批处理模式，用户需要等待很长时间才能看到结果。而基于函数计算 AgentRun 的系统实现了真正的流式输出，用户可以实时观察每个处理步骤的进展。这种实时性不仅提升了用户体验，也便于及时发现和解决问题。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">push_state_event</span>(<span class="hljs-params">run_id: <span class="hljs-built_in">str</span>, state: OpinionState</span>):
    <span class="hljs-string">"""实时推送状态更新，用户无需等待"""</span>
    event = StateSnapshotEvent(
        <span class="hljs-built_in">type</span>=EventType.STATE_SNAPSHOT,
        snapshot=state.model_dump(),
        timestamp=<span class="hljs-built_in">int</span>(time.time() * <span class="hljs-number">1000</span>)
    )
    <span class="hljs-keyword">await</span> event_manager.push_event(run_id, event)
</code></pre>
<h3 data-id="heading-12">智能数据质量控制</h3>
<p>系统实现了严格的数据质量控制机制，通过多维度评估确保收集到的数据具有较高的相关性和价值。这种质量控制在传统系统中往往是缺失的，导致大量噪音数据影响分析结果。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_relevance</span>(<span class="hljs-params">keyword: <span class="hljs-built_in">str</span>, title: <span class="hljs-built_in">str</span>, snippet: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""多维度相关性评估，确保数据质量"""</span>
    text = <span class="hljs-string">f"<span class="hljs-subst">{title}</span> <span class="hljs-subst">{snippet}</span>"</span>
    text_lower = text.lower()
    <span class="hljs-comment"># 检测关键词匹配度</span>
    has_chinese_keyword = <span class="hljs-built_in">any</span>(<span class="hljs-string">'\u4e00'</span> &lt;= char &lt;= <span class="hljs-string">'鿿'</span> <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> keyword)
    result_has_chinese = <span class="hljs-built_in">any</span>(<span class="hljs-string">'\u4e00'</span> &lt;= char &lt;= <span class="hljs-string">'鿿'</span> <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> text)
    <span class="hljs-comment"># 中文关键词必须在结果中有中文内容</span>
    <span class="hljs-keyword">if</span> has_chinese_keyword <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> result_has_chinese:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
    <span class="hljs-comment"># 排除明显的无关网站</span>
    irrelevant_patterns = [
        <span class="hljs-string">"calculator"</span>, <span class="hljs-string">"deepseek"</span>, <span class="hljs-string">"chegg"</span>, <span class="hljs-string">"stackoverflow"</span>, 
        <span class="hljs-string">"翻译"</span>, <span class="hljs-string">"dictionary"</span>, <span class="hljs-string">"词典"</span>
    ]
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(pattern <span class="hljs-keyword">in</span> text_lower <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> irrelevant_patterns):
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
    <span class="hljs-comment"># 计算相关性得分</span>
    score = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">if</span> keyword <span class="hljs-keyword">in</span> text:
        score += <span class="hljs-number">0.6</span>  <span class="hljs-comment"># 基础分</span>
    <span class="hljs-comment"># 时效性加分</span>
    time_keywords = [<span class="hljs-string">"最新"</span>, <span class="hljs-string">"今日"</span>, <span class="hljs-string">"近日"</span>, <span class="hljs-string">"2024"</span>, <span class="hljs-string">"2025"</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(tk <span class="hljs-keyword">in</span> text <span class="hljs-keyword">for</span> tk <span class="hljs-keyword">in</span> time_keywords):
        score += <span class="hljs-number">0.1</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(<span class="hljs-number">0.0</span>, <span class="hljs-built_in">min</span>(<span class="hljs-number">1.0</span>, score))
</code></pre>
<h2 data-id="heading-13">深度内容抓取技术</h2>
<h3 data-id="heading-14">平台适配策略</h3>
<p>不同的社交媒体平台具有不同的页面结构和内容组织方式，传统系统往往采用统一的抓取策略，导致数据质量参差不齐。AgentRun 系统针对不同平台实现了定制化的抓取逻辑：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">explore_page_with_llm</span>(<span class="hljs-params">page, keyword: <span class="hljs-built_in">str</span>, url: <span class="hljs-built_in">str</span>, source: <span class="hljs-built_in">str</span>, initial_content: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""基于平台特性的智能内容抓取"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"weibo.com"</span> <span class="hljs-keyword">in</span> url:
        <span class="hljs-comment"># 微博特定的评论和转发抓取</span>
        available_actions = [
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_comments"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".WB_feed_expand, [class*='comment']"</span>},
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_retweets"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".WB_feed_expand, [class*='repost']"</span>},
        ]
    <span class="hljs-keyword">elif</span> <span class="hljs-string">"zhihu.com"</span> <span class="hljs-keyword">in</span> url:
        <span class="hljs-comment"># 知乎回答和评论抓取</span>
        available_actions = [
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_more_answers"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".AnswerItem, .List-item"</span>},
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_comments"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".Comments-container, .CommentItem"</span>},
        ]
    <span class="hljs-keyword">elif</span> <span class="hljs-string">"bilibili.com"</span> <span class="hljs-keyword">in</span> url:
        <span class="hljs-comment"># B站视频评论抓取</span>
        available_actions = [
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_comments"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".reply-item, .root-reply"</span>},
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_related"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".video-page-card, .recommend-list"</span>},
        ]
</code></pre>
<h3 data-id="heading-15">LLM 驱动的智能探索</h3>
<p>系统创新性地引入了 LLM 驱动的智能探索机制，让 AI 决定是否需要深入抓取某个页面的额外内容，如评论区、相关推荐等。这种智能决策大大提高了数据采集的效率和针对性。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">llm_decide_exploration</span>(<span class="hljs-params">keyword: <span class="hljs-built_in">str</span>, page_url: <span class="hljs-built_in">str</span>, page_content: <span class="hljs-built_in">str</span>, source: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""LLM 智能决策是否进行深度探索"""</span>
    prompt = <span class="hljs-string">f"""请根据以下信息决定是否需要进一步探索页面获取更多舆情数据。
【搜索关键词】<span class="hljs-subst">{keyword}</span>
【当前页面】<span class="hljs-subst">{page_url}</span>
【已获取内容预览】<span class="hljs-subst">{page_content[:<span class="hljs-number">500</span>]}</span>
【决策标准】
1. 如果当前内容已经足够丰富，可能不需要进一步探索
2. 如果是微博/B站等平台，评论区通常包含重要的舆情信息
3. 权衡时间成本，每个页面最多探索1-2个操作
请返回 JSON 格式的决策结果。
"""</span>
    result = <span class="hljs-keyword">await</span> explorer.run(prompt)
    <span class="hljs-keyword">return</span> json.loads(result.output)
</code></pre>
<h2 data-id="heading-16">前端 VNC 集成实现</h2>
<h3 data-id="heading-17">动态库加载机制</h3>
<p>前端 VNC 客户端需要动态加载 noVNC 库，系统实现了智能的加载机制，支持本地资源和 CDN 回退：</p>
<pre><code class="hljs language-ini" lang="ini">function loadScript(url) {
    return new Promise(function(resolve, reject) {
        var <span class="hljs-attr">script</span> = document.createElement(<span class="hljs-string">'script'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">script.src</span> = baseUrl + url<span class="hljs-comment">;</span>
        <span class="hljs-attr">script.onload</span> = resolve<span class="hljs-comment">;</span>
        <span class="hljs-attr">script.onerror</span> = function() {
            // 本地加载失败，尝试 CDN
            var <span class="hljs-attr">fallbackUrl</span> = url.includes(<span class="hljs-string">'wordcloud'</span>) 
                ? 'https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js'
                : 'https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js'<span class="hljs-comment">;</span>
            var <span class="hljs-attr">fallbackScript</span> = document.createElement(<span class="hljs-string">'script'</span>)<span class="hljs-comment">;</span>
            <span class="hljs-attr">fallbackScript.src</span> = fallbackUrl<span class="hljs-comment">;</span>
            <span class="hljs-attr">fallbackScript.onload</span> = resolve<span class="hljs-comment">;</span>
            <span class="hljs-attr">fallbackScript.onerror</span> = reject<span class="hljs-comment">;</span>
            document.head.appendChild(fallbackScript)<span class="hljs-comment">;</span>
        }<span class="hljs-comment">;</span>
        document.head.appendChild(script)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-18">多协议适配</h3>
<p>考虑到部署环境的复杂性，VNC 组件实现了 HTTP/HTTPS 环境下的 WebSocket 协议自适应：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">const</span> adjustWebSocketUrl = useCallback((url: string): string =&gt; {
    <span class="hljs-keyword">const</span> isHttps = window.location.protocol === <span class="hljs-string">'https:'</span>;
    <span class="hljs-keyword">if</span> (!isHttps &amp;&amp; url.startsWith(<span class="hljs-string">'wss://'</span>)) {
        <span class="hljs-keyword">return</span> url.replace(<span class="hljs-string">'wss://'</span>, <span class="hljs-string">'ws://'</span>);
    }
    <span class="hljs-keyword">if</span> (isHttps &amp;&amp; url.startsWith(<span class="hljs-string">'ws://'</span>)) {
        <span class="hljs-keyword">return</span> url.replace(<span class="hljs-string">'ws://'</span>, <span class="hljs-string">'wss://'</span>);
    }
    <span class="hljs-keyword">return</span> url;
}, []);
</code></pre>
<h2 data-id="heading-19">智能分析与报告生成</h2>
<h3 data-id="heading-20">标准化情感分析</h3>
<p>系统实现了基于关键词词典的情感分析算法，相比传统的机器学习模型，这种方法更加透明和可控：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SentimentStandards</span>:
    <span class="hljs-string">"""情感倾向标准化计算"""</span>
    POSITIVE_KEYWORDS = [
        <span class="hljs-string">"优秀"</span>, <span class="hljs-string">"卓越"</span>, <span class="hljs-string">"创新"</span>, <span class="hljs-string">"领先"</span>, <span class="hljs-string">"突破"</span>, <span class="hljs-string">"成功"</span>, <span class="hljs-string">"赞"</span>, <span class="hljs-string">"好评"</span>, <span class="hljs-string">"支持"</span>,
        <span class="hljs-string">"认可"</span>, <span class="hljs-string">"满意"</span>, <span class="hljs-string">"信赖"</span>, <span class="hljs-string">"期待"</span>, <span class="hljs-string">"看好"</span>, <span class="hljs-string">"值得"</span>, <span class="hljs-string">"推荐"</span>, <span class="hljs-string">"喜欢"</span>
    ]
    NEGATIVE_KEYWORDS = [
        <span class="hljs-string">"差"</span>, <span class="hljs-string">"糟糕"</span>, <span class="hljs-string">"失败"</span>, <span class="hljs-string">"落后"</span>, <span class="hljs-string">"问题"</span>, <span class="hljs-string">"缺陷"</span>, <span class="hljs-string">"批评"</span>, <span class="hljs-string">"质疑"</span>, <span class="hljs-string">"担忧"</span>,
        <span class="hljs-string">"失望"</span>, <span class="hljs-string">"不满"</span>, <span class="hljs-string">"抱怨"</span>, <span class="hljs-string">"投诉"</span>, <span class="hljs-string">"差评"</span>, <span class="hljs-string">"垃圾"</span>, <span class="hljs-string">"骗局"</span>
    ]
    @<span class="hljs-built_in">staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_sentiment_score</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">"""计算情感得分 (-1.0 到 1.0)"""</span>
        positive_count = <span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> SentimentStandards.POSITIVE_KEYWORDS <span class="hljs-keyword">if</span> word <span class="hljs-keyword">in</span> text)
        negative_count = <span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> SentimentStandards.NEGATIVE_KEYWORDS <span class="hljs-keyword">if</span> word <span class="hljs-keyword">in</span> text)
        total_count = positive_count + negative_count
        <span class="hljs-keyword">if</span> total_count == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
        <span class="hljs-keyword">return</span> (positive_count - negative_count) / total_count
</code></pre>
<h3 data-id="heading-21">流式报告生成</h3>
<p>报告生成过程采用流式输出，用户可以实时观察报告的撰写过程，这种体验是传统系统无法提供的：</p>
<pre><code class="hljs language-ini" lang="ini">async with writer.run_stream(report_prompt) as result:
    async for text in result.stream_text():
        <span class="hljs-attr">report_content</span> = text
        <span class="hljs-attr">state.report_text</span> = report_content
        <span class="hljs-attr">current_time</span> = asyncio.get_event_loop().time()
        <span class="hljs-attr">content_delta</span> = len(report_content) - last_event_length
        <span class="hljs-attr">time_delta</span> = current_time - last_event_time
        <span class="hljs-comment"># 每 100 字符或每 0.3 秒发送一次更新</span>
        if content_delta &gt;= 100 or time_delta &gt;= 0.3:
            await push_state_event(run_id, state)
</code></pre>
<h2 data-id="heading-22">部署与运维优势</h2>
<h3 data-id="heading-23">简化的部署流程</h3>
<p>相比传统舆情系统需要复杂的分布式爬虫集群部署，AgentRun 系统的部署相对简单。只需要配置好环境变量和 AgentRun Sandbox 模板，系统就能自动管理浏览器实例的创建和销毁：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 核心配置</span>
<span class="hljs-attr">AGENTRUN_MODEL_NAME</span>=your_model_name
<span class="hljs-attr">MODEL_NAME</span>=qwen3-max
<span class="hljs-attr">AGENTRUN_BROWSER_SANDBOX_NAME</span>=your_browser_template
<span class="hljs-attr">TIMEOUT</span>=<span class="hljs-number">180</span>
</code></pre>
<h3 data-id="heading-24">自动化运维能力</h3>
<p>系统内置了完善的监控和自恢复机制，大大降低了运维复杂度。当检测到异常时，系统能够自动重建资源，保证服务的连续性：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 连接失败时自动重连（每 10 秒尝试一次）</span>
useEffect(() =&gt; {
    if (<span class="hljs-attr">status</span> === <span class="hljs-string">'error'</span> &amp;&amp; active &amp;&amp; rfbLoaded) {
        <span class="hljs-attr">reconnectTimerRef.current</span> = setTimeout(() =&gt; {
            cleanupRfb()<span class="hljs-comment">;</span>
            <span class="hljs-attr">lastUrlRef.current</span> = null<span class="hljs-comment">;</span>
            fetchVncUrl(true)<span class="hljs-comment">;</span>
        }, RECONNECT_INTERVAL)<span class="hljs-comment">;</span>
    }
}, <span class="hljs-section">[status, active, rfbLoaded]</span>)<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-25">性能与扩展性分析</h2>
<h3 data-id="heading-26">并发处理能力</h3>
<p>传统系统的并发能力往往受限于单机资源，而函数计算 AgentRun 系统可以根据需要动态创建多个 Sandbox 实例，实现真正的水平扩展。系统通过异步编程模型和连接池管理，能够高效处理大量并发请求：</p>
<pre><code class="hljs language-ini" lang="ini">uvicorn.run(
    "main:app",
    <span class="hljs-attr">host</span>=<span class="hljs-string">"0.0.0.0"</span>,
    <span class="hljs-attr">port</span>=<span class="hljs-number">8000</span>,
    <span class="hljs-attr">log_level</span>=<span class="hljs-string">"info"</span>,
    <span class="hljs-attr">timeout_keep_alive</span>=<span class="hljs-number">120</span>,
    <span class="hljs-attr">limit_concurrency</span>=<span class="hljs-number">100</span>,  <span class="hljs-comment"># 支持高并发</span>
)
</code></pre>
<h3 data-id="heading-27">资源弹性管理</h3>
<p>系统实现了智能的资源管理策略，能够根据任务负载动态调整 Sandbox 实例数量。这种弹性扩展能力是传统固定架构难以实现的：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_all_sandboxes</span>() -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
    <span class="hljs-string">"""动态获取所有可用的Sandbox实例"""</span>
    result = []
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> _sandbox_lock:
        <span class="hljs-keyword">for</span> sandbox_id, sandbox <span class="hljs-keyword">in</span> _sandboxes.items():
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># 检查实例健康状态</span>
                vnc_url = sandbox.get_vnc_url()
                result.append({
                    <span class="hljs-string">"sandbox_id"</span>: sandbox_id,
                    <span class="hljs-string">"vnc_url"</span>: vnc_url,
                    <span class="hljs-string">"active"</span>: <span class="hljs-literal">True</span>,
                })
            <span class="hljs-keyword">except</span> Exception:
                <span class="hljs-comment"># 自动清理失效实例</span>
                result.append({
                    <span class="hljs-string">"sandbox_id"</span>: sandbox_id,
                    <span class="hljs-string">"active"</span>: <span class="hljs-literal">False</span>,
                })
    <span class="hljs-keyword">return</span> result
</code></pre>
<h2 data-id="heading-28">总结</h2>
<p>基于函数计算 AgentRun 构建的舆情分析系统展现了现代 AI 技术在实际业务场景中的强大应用潜力。相比传统方案，函数计算 AgentRun 系统在安全性、可靠性、可观测性和扩展性方面都具有显著优势。</p>
<p>通过隔离的浏览器环境，系统解决了传统爬虫面临的安全风险和环境污染问题。实时的 VNC 预览功能提供了前所未有的透明度，让开发者和用户能够直观地观察系统工作状态。智能的故障检测和自恢复机制大大降低了运维复杂度，而流式输出设计则显著提升了用户体验。</p>
<p>更重要的是，函数计算 AgentRun 系统将复杂的舆情分析任务完全自动化，从多平台数据采集、深度内容抓取、智能情感分析到专业报告生成，整个流程无需人工干预。这种端到端的自动化能力，结合 AI 技术的持续进步，将为企业和机构的舆情分析工作带来革命性的改变。</p>
<p>欢迎加入“函数计算 AgentRun 客户群”与我们交流，钉钉群号：134570017218。</p>
<p><strong>快速了解函数计算 AgentRun：</strong></p>
<p><strong>一句话介绍：</strong> 函数计算 AgentRun 是一个以高代码为核心的一站式 Agentic AI 基础设施平台。秉持生态开放和灵活组装的理念，为企业级 Agent 应用提供从开发、部署到运维的全生命周期管理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7333e7a6ace849a3a84cd2cef2836b4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=PGzjK9qak75XL0U0Ax7gSsa1tBw%3D" alt="图片" loading="lazy"/></p>
<p><em>函数计算 AgentRun 架构图</em></p>
<p>AgentRun 运行时基于阿里云函数计算 FC 构建，继承了 Serverless 计算极致弹性、按量付费、零运维的核心优势。通过深度集成 AgentScope、Langchain、RAGFlow、Mem0 等主流开源生态。AgentRun 将 Serverless 的极致弹性、零运维和按量付费的特性与 AI 原生应用场景深度融合，助力企业实现成本与效率的极致优化，平均 TCO 降低 60%。 </p>
<p>让开发者只需专注于 Agent 的业务逻辑创新，无需关心底层基础设施，让 Agentic AI 真正进入企业生产环境。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JS复杂去重一定要先排序吗？深度解析与性能对比]]></title>    <link>https://juejin.cn/post/7588002126258110470</link>    <guid>https://juejin.cn/post/7588002126258110470</guid>    <pubDate>2025-12-26T09:53:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588002126258110470" data-draft-id="7587995707165442067" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JS复杂去重一定要先排序吗？深度解析与性能对比"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-26T09:53:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Fronty"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JS复杂去重一定要先排序吗？深度解析与性能对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Fronty
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:53:34.000Z" title="Fri Dec 26 2025 09:53:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">引言</h4>
<p>在日常开发中，数组去重是JavaScript中常见的操作。对于简单数据类型，我们通常会毫不犹豫地使用Set。但当面对复杂对象数组时，很多开发者会产生疑问：复杂去重一定要先排序吗？</p>
<p>这个问题背后其实隐藏着几个更深层次的考量:</p>
<ul>
<li>排序是否会影响原始数据顺序？</li>
<li>排序的性能开销是否值得？</li>
<li>是否有更优雅的解决方案？</li>
</ul>
<h4 data-id="heading-1">1. 常见的排序去重方案</h4>
<h5 data-id="heading-2">1.1 传统的排序去重思路</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 先排序后去重的经典写法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sortThenUnique</span>(<span class="hljs-params">arr, key</span>) {
  <span class="hljs-keyword">return</span> arr
    .<span class="hljs-title function_">slice</span>()
    .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
      <span class="hljs-comment">// 避免修改原始数组</span>
      <span class="hljs-keyword">const</span> valueA = key ? a[key] : a;
      <span class="hljs-keyword">const</span> valueB = key ? b[key] : b;
      <span class="hljs-keyword">if</span> (valueA &lt; valueB) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
      <span class="hljs-keyword">if</span> (valueA &gt; valueB) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    })
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item, index, array</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 保留第一个元素</span>
      <span class="hljs-keyword">const</span> value = key ? item[key] : item;
      <span class="hljs-keyword">const</span> prevValue = key ? array[index - <span class="hljs-number">1</span>][key] : array[index - <span class="hljs-number">1</span>];
      <span class="hljs-keyword">return</span> value !== prevValue; <span class="hljs-comment">// 仅保留与前一个元素不同的元素</span>
    });
}
</code></pre>
<h5 data-id="heading-3">1.2 排序去重的优缺点</h5>
<p><strong>优点:</strong></p>
<ul>
<li>代码逻辑相对直观</li>
<li>对于已排序或需要排序的数据，可以一步完成</li>
<li>在某些算法题中可能是必要步骤</li>
</ul>
<p><strong>缺点:</strong></p>
<ul>
<li>时间复杂度至少为 O(n log n)</li>
<li>改变了原始数据的顺序</li>
<li>对于不需要排序的场景是额外开销</li>
</ul>
<h4 data-id="heading-4">2. 不排序的去重方案</h4>
<h5 data-id="heading-5">2.1 基于Map的保持顺序方案</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">uniqueByKey</span>(<span class="hljs-params">arr, key</span>) {
  <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  <span class="hljs-keyword">const</span> result = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> arr) {
    <span class="hljs-keyword">const</span> keyValue = item[key];
    <span class="hljs-keyword">if</span> (!seen.<span class="hljs-title function_">has</span>(keyValue)) {
      seen.<span class="hljs-title function_">set</span>(keyValue, <span class="hljs-literal">true</span>);
      result.<span class="hljs-title function_">push</span>(item);
    }
  }
  <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 支持多个字段的复合键</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">uniqueByMultipleKeys</span>(<span class="hljs-params">arr, keys</span>) {
  <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> compositeKey = keys.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> item[key]).<span class="hljs-title function_">join</span>(<span class="hljs-string">"|"</span>);
    <span class="hljs-keyword">if</span> (seen.<span class="hljs-title function_">has</span>(compositeKey)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    seen.<span class="hljs-title function_">add</span>(compositeKey);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  });
}
</code></pre>
<h5 data-id="heading-6">2.2 基于对象的缓存方案</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">uniqueByKeyWithObject</span>(<span class="hljs-params">arr, key</span>) {
  <span class="hljs-keyword">const</span> cache = {};
  <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> keyValue = item[key];
    <span class="hljs-keyword">if</span> (cache[keyValue]) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    cache[keyValue] = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  });
}
</code></pre>
<h5 data-id="heading-7">2.3 基于自定义比较函数的方案</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">uniqueWithCustomComparator</span>(<span class="hljs-params">arr, comparator</span>) {
  <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">current, index, self</span>) =&gt;</span> {
    <span class="hljs-comment">// 查找第一个相同元素的位置</span>
    <span class="hljs-keyword">return</span> self.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> <span class="hljs-title function_">comparator</span>(item, current)) === index;
  });
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> users = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> }, <span class="hljs-comment">// 重复</span>
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">26</span> }, <span class="hljs-comment">// ID相同但年龄不同</span>
];

<span class="hljs-keyword">const</span> uniqueUsers = <span class="hljs-title function_">uniqueWithCustomComparator</span>(
  users,
  <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">id</span> === b.<span class="hljs-property">id</span> &amp;&amp; a.<span class="hljs-property">name</span> === b.<span class="hljs-property">name</span>
);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(uniqueUsers);
<span class="hljs-comment">// [ { id: 1, name: 'Alice', age: 25 }, { id: 2, name: 'Bob', age: 30 } ]</span>
</code></pre>
<h4 data-id="heading-8">3. 性能对比分析</h4>
<h5 data-id="heading-9">3.1 时间复杂度对比</h5>



































<table><thead><tr><th align="left">方法</th><th align="left">时间复杂度</th><th align="left">空间复杂度</th><th align="left">是否保持顺序</th></tr></thead><tbody><tr><td align="left">排序后去重</td><td align="left">O(n log n)</td><td align="left">O(1) 或 O(n)</td><td align="left">否</td></tr><tr><td align="left">Map去重</td><td align="left">O(n)</td><td align="left">O(n)</td><td align="left">是</td></tr><tr><td align="left">对象缓存去重</td><td align="left">O(n)</td><td align="left">O(n)</td><td align="left">是</td></tr><tr><td align="left">filter + findIndex</td><td align="left">O(n²)</td><td align="left">O(1)</td><td align="left">是</td></tr></tbody></table>
<h5 data-id="heading-10">3.2 实际性能测试</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 性能测试代码示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">generateTestData</span>(<span class="hljs-params">count</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({<span class="hljs-attr">length</span>: count}, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
    <span class="hljs-attr">id</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * count / <span class="hljs-number">10</span>), <span class="hljs-comment">// 产生大量重复</span>
    <span class="hljs-attr">value</span>: <span class="hljs-string">`item-<span class="hljs-subst">${i}</span>`</span>,
    <span class="hljs-attr">data</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()
  }));
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">runPerformanceTest</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">generateTestData</span>(<span class="hljs-number">10000</span>);
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'Map去重'</span>);
  <span class="hljs-title function_">uniqueByKey</span>(data, <span class="hljs-string">'id'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'Map去重'</span>);
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'排序去重'</span>);
  <span class="hljs-title function_">sortThenUnique</span>(data, <span class="hljs-string">'id'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'排序去重'</span>);
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'filter+findIndex'</span>);
  <span class="hljs-title function_">uniqueWithCustomComparator</span>(data, <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">id</span> === b.<span class="hljs-property">id</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'filter+findIndex'</span>);
}
</code></pre>
<p><strong>测试结果趋势:</strong></p>
<ul>
<li>数据量&lt;1000：各种方法差异不大</li>
<li>数据量1000-10000：Map方案明显占优</li>
<li>数据量&gt;10000：排序方案开始显现劣势</li>
</ul>
<h4 data-id="heading-11">4. 应用场景与选择建议</h4>
<h5 data-id="heading-12">4.1 什么时候应该考虑排序？</h5>
<h6 data-id="heading-13">1.需要有序输出时</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 既要去重又要按特定字段排序</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getSortedUniqueUsers</span> = (<span class="hljs-params">users</span>) =&gt; {
  <span class="hljs-keyword">const</span> uniqueUsers = <span class="hljs-title function_">uniqueByKey</span>(users, <span class="hljs-string">'id'</span>);
  <span class="hljs-keyword">return</span> uniqueUsers.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">name</span>.<span class="hljs-title function_">localeCompare</span>(b.<span class="hljs-property">name</span>));
};
</code></pre>
<h6 data-id="heading-14">2. 数据本身就需要排序时</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 如果业务本来就需要排序，可以合并操作</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">processData</span> = (<span class="hljs-params">data</span>) =&gt; {
  <span class="hljs-comment">// 先排序便于后续处理</span>
  data.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">timestamp</span> - b.<span class="hljs-property">timestamp</span>);
  <span class="hljs-comment">// 去重</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">uniqueByKey</span>(data, <span class="hljs-string">'id'</span>);
};
</code></pre>
<h6 data-id="heading-15">3.处理流式数据时</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实时数据流，需要维持有序状态</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SortedUniqueCollection</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = key;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">seen</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  }
  
  <span class="hljs-title function_">add</span>(<span class="hljs-params">item</span>) {
    <span class="hljs-keyword">const</span> keyValue = item[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>];
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">seen</span>.<span class="hljs-title function_">has</span>(keyValue)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">seen</span>.<span class="hljs-title function_">add</span>(keyValue);
      <span class="hljs-comment">// 插入到正确位置维持有序</span>
      <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">while</span> (index &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">length</span> &amp;&amp; 
             <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>[index][<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>] &lt; keyValue) {
        index++;
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">0</span>, item);
    }
  }
}
</code></pre>
<h5 data-id="heading-16">4.2 什么时候应该避免排序？</h5>
<h6 data-id="heading-17">1.需要保持原始顺序时</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 日志记录、时间线数据等</span>
<span class="hljs-keyword">const</span> logEntries = [
  {<span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">time</span>: <span class="hljs-string">'10:00'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'启动'</span>},
  {<span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">time</span>: <span class="hljs-string">'10:01'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'初始化'</span>},
  {<span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">time</span>: <span class="hljs-string">'10:02'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'启动'</span>}, <span class="hljs-comment">// 重复</span>
  {<span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">time</span>: <span class="hljs-string">'10:03'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'运行'</span>}
];

<span class="hljs-comment">// 保持时间顺序很重要！</span>
<span class="hljs-keyword">const</span> uniqueLogs = <span class="hljs-title function_">uniqueByKey</span>(logEntries, <span class="hljs-string">'id'</span>);
</code></pre>
<h6 data-id="heading-18">2.性能敏感的应用</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实时渲染大量数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderItems</span>(<span class="hljs-params">items</span>) {
  <span class="hljs-comment">// 使用Map去重避免不必要的排序开销</span>
  <span class="hljs-keyword">const</span> uniqueItems = <span class="hljs-title function_">uniqueByKey</span>(items, <span class="hljs-string">'id'</span>);
  <span class="hljs-comment">// 快速渲染</span>
  <span class="hljs-keyword">return</span> uniqueItems.<span class="hljs-title function_">map</span>(renderItem);
}
</code></pre>
<h6 data-id="heading-19">3. 数据不可变要求</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React/Vue等框架中，避免改变原数组</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">DeduplicatedList</span> = (<span class="hljs-params">{ items }</span>) =&gt; {
  <span class="hljs-comment">// 不改变原始数据</span>
  <span class="hljs-keyword">const</span> uniqueItems = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">uniqueByKey</span>(items, <span class="hljs-string">'id'</span>),
    [items]
  );
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">List</span> <span class="hljs-attr">items</span>=<span class="hljs-string">{uniqueItems}</span> /&gt;</span></span>;
};
</code></pre>
<h4 data-id="heading-20">5. 高级技巧和优化</h4>
<h5 data-id="heading-21">5.1 惰性去重迭代器</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">uniqueIterator</span>(<span class="hljs-params">arr, getKey</span>) {
  <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> arr) {
    <span class="hljs-keyword">const</span> key = <span class="hljs-title function_">getKey</span>(item);
    <span class="hljs-keyword">if</span> (!seen.<span class="hljs-title function_">has</span>(key)) {
      seen.<span class="hljs-title function_">add</span>(key);
      <span class="hljs-keyword">yield</span> item;
    }
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> data = [...]; <span class="hljs-comment">// 大数据集</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> <span class="hljs-title function_">uniqueIterator</span>(data, <span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x.<span class="hljs-property">id</span>)) {
  <span class="hljs-comment">// 逐个处理，节省内存</span>
  <span class="hljs-title function_">processItem</span>(item);
}
</code></pre>
<h5 data-id="heading-22">5.2 增量去重</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">IncrementalDeduplicator</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = key;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">seen</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> = <span class="hljs-number">0</span>;
  }
  
  <span class="hljs-title function_">add</span>(<span class="hljs-params">items</span>) {
    <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> keyValue = item[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>];
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">seen</span>.<span class="hljs-title function_">has</span>(keyValue)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">seen</span>.<span class="hljs-title function_">set</span>(keyValue, ++<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>); <span class="hljs-comment">// 记录添加顺序</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    });
  }
  
  <span class="hljs-title function_">getAddedOrder</span>(<span class="hljs-params">keyValue</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">seen</span>.<span class="hljs-title function_">get</span>(keyValue);
  }
}
</code></pre>
<h5 data-id="heading-23">5.3 内存优化版本</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">memoryEfficientUnique</span>(<span class="hljs-params">arr, key</span>) {
  <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  <span class="hljs-keyword">const</span> result = [];
  
  <span class="hljs-comment">// 使用WeakMap处理对象键</span>
  <span class="hljs-keyword">const</span> weakMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> item = arr[i];
    <span class="hljs-keyword">const</span> keyValue = item[key];
    
    <span class="hljs-comment">// 对于对象类型的键值，使用WeakMap</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> keyValue === <span class="hljs-string">'object'</span> &amp;&amp; keyValue !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">if</span> (!weakMap.<span class="hljs-title function_">has</span>(keyValue)) {
        weakMap.<span class="hljs-title function_">set</span>(keyValue, <span class="hljs-literal">true</span>);
        result.<span class="hljs-title function_">push</span>(item);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (!seen.<span class="hljs-title function_">has</span>(keyValue)) {
        seen.<span class="hljs-title function_">set</span>(keyValue, <span class="hljs-literal">true</span>);
        result.<span class="hljs-title function_">push</span>(item);
      }
    }
  }
  
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h4 data-id="heading-24">6. 实战案例分析</h4>
<h5 data-id="heading-25">6.1 电商商品去重</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 场景：合并多个来源的商品数据</span>
<span class="hljs-keyword">const</span> productsFromAPI = [...];
<span class="hljs-keyword">const</span> productsFromCache = [...];
<span class="hljs-keyword">const</span> userUploadedProducts = [...];

<span class="hljs-comment">// 需求：按商品SKU去重，保持最新数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">mergeProducts</span>(<span class="hljs-params">productLists</span>) {
  <span class="hljs-keyword">const</span> merged = [];
  <span class="hljs-keyword">const</span> skuMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  
  <span class="hljs-comment">// 按优先级处理（后处理的优先级高）</span>
  productLists.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">list</span> =&gt;</span> {
    list.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> existing = skuMap.<span class="hljs-title function_">get</span>(product.<span class="hljs-property">sku</span>);
      <span class="hljs-keyword">if</span> (!existing || product.<span class="hljs-property">updatedAt</span> &gt; existing.<span class="hljs-property">updatedAt</span>) {
        <span class="hljs-keyword">if</span> (existing) {
          <span class="hljs-comment">// 移除旧的</span>
          <span class="hljs-keyword">const</span> index = merged.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">sku</span> === product.<span class="hljs-property">sku</span>);
          merged.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
        }
        merged.<span class="hljs-title function_">push</span>(product);
        skuMap.<span class="hljs-title function_">set</span>(product.<span class="hljs-property">sku</span>, product);
      }
    });
  });
  
  <span class="hljs-keyword">return</span> merged;
}
</code></pre>
<h5 data-id="heading-26">6.2 实时消息去重</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 场景：聊天应用消息去重</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageDeduplicator</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">timeWindow = <span class="hljs-number">5000</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeWindow</span> = timeWindow;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">messageIds</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timestamps</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  
  <span class="hljs-title function_">addMessage</span>(<span class="hljs-params">message</span>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> { id } = message;
    
    <span class="hljs-comment">// 清理过期记录</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanup</span>(now);
    
    <span class="hljs-comment">// 检查是否重复</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">messageIds</span>.<span class="hljs-title function_">has</span>(id)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 添加新记录</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">messageIds</span>.<span class="hljs-title function_">add</span>(id);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timestamps</span>.<span class="hljs-title function_">set</span>(id, now);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  
  <span class="hljs-title function_">cleanup</span>(<span class="hljs-params">now</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [id, timestamp] <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">timestamps</span>) {
      <span class="hljs-keyword">if</span> (now - timestamp &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeWindow</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">messageIds</span>.<span class="hljs-title function_">delete</span>(id);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">timestamps</span>.<span class="hljs-title function_">delete</span>(id);
      }
    }
  }
}
</code></pre>
<h4 data-id="heading-27">结论</h4>
<p>回到最初的问题：JS复杂去重一定要先排序吗？</p>
<p>答案是否定的。 排序只是众多去重策略中的一种，而非必需步骤。</p>
<p><strong>我的建议:</strong></p>
<ol>
<li><strong>默认使用Map方案:</strong> 对于大多数场景，基于Map或Set的去重方法在性能和功能上都是最佳选择。</li>
<li><strong>根据需求选择:</strong></li>
</ol>
<ul>
<li>需要保持顺序 → 使用Map</li>
<li>需要排序结果 → 先排序或后排序</li>
<li>数据量很大 → 考虑迭代器或流式处理</li>
<li>内存敏感 → 使用WeakMap或定期清理</li>
</ul>
<ol start="3">
<li><strong>考虑可读性和维护性:</strong> 有时清晰的代码比微小的性能优化更重要。</li>
<li><strong>进行实际测试:</strong> 在性能关键路径上，用真实数据测试不同方案。</li>
</ol>
<p><strong>实践总结:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 通用推荐方案</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">deduplicate</span>(<span class="hljs-params">arr, identifier = v =&gt; v</span>) {
  <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> key = <span class="hljs-keyword">typeof</span> identifier === <span class="hljs-string">'function'</span> 
      ? <span class="hljs-title function_">identifier</span>(item)
      : item[identifier];
    
    <span class="hljs-keyword">if</span> (seen.<span class="hljs-title function_">has</span>(key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    seen.<span class="hljs-title function_">add</span>(key);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  });
}

<span class="hljs-comment">// 需要排序时的方案</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">deduplicateAndSort</span>(<span class="hljs-params">arr, key, sortBy</span>) {
  <span class="hljs-keyword">const</span> unique = <span class="hljs-title function_">deduplicate</span>(arr, key);
  <span class="hljs-keyword">return</span> unique.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> aVal = a[sortBy];
    <span class="hljs-keyword">const</span> bVal = b[sortBy];
    <span class="hljs-keyword">return</span> aVal &lt; bVal ? -<span class="hljs-number">1</span> : aVal &gt; bVal ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
  });
}
</code></pre>
<p>记住，没有银弹。最合适的去重方案取决于你的具体需求：数据规模、顺序要求、性能需求和代码上下文。希望这篇文章能帮助你在面对复杂去重问题时做出明智的选择！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VueCropper加载OBS图片跨域问题]]></title>    <link>https://juejin.cn/post/7587743345197465652</link>    <guid>https://juejin.cn/post/7587743345197465652</guid>    <pubDate>2025-12-26T09:30:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587743345197465652" data-draft-id="7587743345197449268" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VueCropper加载OBS图片跨域问题"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-26T09:30:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VueCropper加载OBS图片跨域问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:30:22.000Z" title="Fri Dec 26 2025 09:30:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    24
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题场景</h2>
<p>在集成 <code>VueCropper</code> 图片裁剪组件时，遇到一个典型的跨域问题：加载存储在 OBS 上的图片时，浏览器会对同一张图片发起两次请求，最终第二次请求触发跨域错误。以下是问题的完整排查过程与现象梳理：</p>
<ol>
<li>请求行为异常：同一张 OBS 图片被浏览器发起两次请求，第一次请求正常响应，第二次请求直接抛出跨域相关错误（如 <code>CORS policy: No 'Access-Control-Allow-Origin' header</code>）；</li>
<li>初步排查方向：初期优先怀疑 OBS 服务器跨域配置缺失，反馈运维核查后，确认 OBS 已正确配置跨域允许规则（含允许当前前端域名、支持 GET 方法等）；</li>
<li>关键测试突破：通过浏览器开发者工具测试发现，开启「停用缓存」功能后，跨域错误消失。据此锁定问题根源与浏览器缓存机制相关；</li>
<li>核心差异定位：对比两次请求的详细信息，发现跨域标识配置不一致——第一次加载图片未设置 <code>crossOrigin</code> 标识，第二次加载时则添加了该标识；</li>
<li>问题逻辑闭环：第一次请求因无 <code>crossOrigin</code> 标识，OBS 服务器识别为非跨域请求，未返回跨域响应头；第二次请求虽开启 <code>crossOrigin</code>，但因图片 URL 未变，浏览器直接复用缓存的无跨域响应头资源，导致跨域校验失败。</li>
</ol>
<h2 data-id="heading-1">问题根源</h2>
<p>为验证上述排查结论，通过原生 JavaScript 代码复现了问题场景，最终确认问题根源为 <strong>跨域策略与浏览器缓存冲突</strong>。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
    <span class="hljs-comment">// 第一次加载：未设置 crossOrigin 标识</span>
    image.<span class="hljs-property">src</span> = <span class="hljs-string">'https://xxx.png'</span>; 
    image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片加载完成'</span>);
        <span class="hljs-keyword">const</span> image2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
        <span class="hljs-comment">// 第二次加载：设置跨域标识（与第一次不一致）</span>
        image2.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">"anonymous"</span>;
        <span class="hljs-comment">// 加载同一张图片，触发跨域错误</span>
        image2.<span class="hljs-property">src</span> = image.<span class="hljs-property">src</span>; 
        image2.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片2加载完成'</span>);
        });
    });
});
</code></pre>
<p>该问题的核心矛盾是「同一张图片的两次请求采用不一致的跨域策略」，结合浏览器缓存机制与 OBS 服务器的跨域响应规则，具体错误逻辑可拆解为两步：</p>
<ol>
<li>非跨域模式缓存：第一次加载未设置 <code>crossOrigin</code>，浏览器以「非跨域模式」发起请求（请求头 <code>Sec-Fetch-Mode = no-cors</code>）；OBS 服务器识别该模式后，不返回 <code>Access-Control-Allow-Origin</code> 等跨域响应头，浏览器则将这份「无跨域响应头的图片资源」缓存至本地；</li>
<li>跨域模式缓存冲突：第二次加载设置 <code>crossOrigin: "anonymous"</code>，浏览器需以「跨域模式」请求；但因图片 URL 未变，浏览器直接复用本地缓存的无跨域响应头资源，跨域校验无法通过，最终触发错误。</li>
</ol>
<p>关键结论：同一张图片的所有请求，跨域标识必须完全统一（要么所有请求都设 <code>crossOrigin</code>，要么都不设），否则会因缓存机制导致跨域策略冲突。</p>
<h2 data-id="heading-2">解决办法</h2>
<h3 data-id="heading-3">1. 核心通用方案：统一跨域标识（推荐首选）</h3>
<p>思路：统一所有加载该图片的 <code>Image</code> 实例的跨域配置（均设置或均不设置 <code>crossOrigin</code>），确保两次请求的跨域策略一致，从根源避免缓存与跨域规则的冲突。</p>
<p>核心注意点：<code>crossOrigin</code> 必须在 <code>src</code> 赋值 <strong>之前</strong> 设置。若先赋值 <code>src</code>，浏览器会提前以默认模式发起请求，仍会触发跨域冲突。</p>
<p>正确代码示例：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 第一次加载：提前设置 crossOrigin，统一跨域策略</span>
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
  image.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">"anonymous"</span>; 
  image.<span class="hljs-property">src</span> = <span class="hljs-string">'https://xxx.png'</span>;

  image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片加载完成'</span>);
      <span class="hljs-comment">// 第二次加载：保持 crossOrigin 配置一致</span>
      <span class="hljs-keyword">const</span> image2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
      image2.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">"anonymous"</span>; 
      image2.<span class="hljs-property">src</span> = image.<span class="hljs-property">src</span>;

      image2.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片2加载完成'</span>);
      });
  });

  <span class="hljs-comment">// 添加错误监听，便于问题排查</span>
  image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'图片1加载失败:'</span>, e));
  image2.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'图片2加载失败:'</span>, e));
});
</code></pre>
<p>适用场景：绝大多数前端场景（包括 <code>VueCropper </code> 等依赖 canvas 的裁剪组件场景），且图片存储端<code>（OBS/CDN）</code>已配置跨域允许规则。</p>
<h3 data-id="heading-4">2. 绕过缓存方案：让第二次请求视为「新资源」</h3>
<p>思路：若历史代码无法批量修改 <code>crossOrigin</code> 配置，可通过让第二次请求「避开缓存」，迫使浏览器重新向 OBS 服务器发起请求（而非复用旧缓存），从而避免跨域策略冲突。</p>
<p>推荐方案：给图片 URL 添加随机参数（如时间戳），使浏览器识别为「新资源」，触发全新请求：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> image2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
  image2.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">"anonymous"</span>;
  <span class="hljs-comment">// 追加时间戳参数，避开浏览器缓存</span>
  image2.<span class="hljs-property">src</span> = <span class="hljs-string">`<span class="hljs-subst">${image.src}</span>&amp;t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>; 
  image2.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片2加载完成'</span>));
});
</code></pre>
<p>适用场景：历史代码架构复杂，无法批量统一 <code>crossOrigin</code> 配置，需快速临时修复跨域问题。</p>
<p>缺点：完全失去缓存优势，每次请求均需重新下载图片，会增加带宽消耗并延长页面加载时间，仅建议临时使用。</p>
<h3 data-id="heading-5">3. 后端/存储端方案：从根源消除跨域</h3>
<p>思路：通过后端代理或域名绑定，将「跨域图片请求」转为「同源请求」，从根源上消除跨域问题，无需前端额外配置 <code>crossOrigin</code>。</p>
<p>具体做法：</p>
<ol>
<li>同源代理（推荐）：前端请求自身后端的代理接口，由后端代为拉取 OBS 图片并返回给前端。此时前端接收的图片为同源资源，无需任何跨域配置。</li>
</ol>
<p>示例（<code>Node.js/Express</code> 代理）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 后端代理代码（Node.js/Express）</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

<span class="hljs-comment">// 图片代理接口：接收前端传递的 OBS 图片 URL</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/proxy-image'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> imgUrl = req.<span class="hljs-property">query</span>.<span class="hljs-property">url</span>;
  <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 后端请求 OBS 图片，以流形式返回给前端</span>
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(imgUrl, { <span class="hljs-attr">responseType</span>: <span class="hljs-string">'stream'</span> });
      response.<span class="hljs-property">data</span>.<span class="hljs-title function_">pipe</span>(res);
  } <span class="hljs-keyword">catch</span> (err) {
      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'图片加载失败'</span>);
  }
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'代理服务启动在 3000 端口'</span>));
</code></pre>
<p>前端代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端代码：请求后端代理接口，无跨域问题</span>
<span class="hljs-keyword">const</span> image = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
image.<span class="hljs-property">src</span> = <span class="hljs-string">`http://localhost:3000/proxy-image?url=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-string">'https://xxx.png'</span>)}</span>`</span>;
image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片加载完成'</span>));
</code></pre>
<p>适用场景：前端需大量处理跨域图片（如批量裁剪、像素操作）；追求稳定可靠的跨域解决方案，不希望依赖前端代码配置。</p>
<p>优点：彻底解决跨域问题，前端无需任何跨域相关配置；缓存机制可正常生效，不影响加载性能；安全性更高（避免设置 <code>*</code> 允许所有域名跨域）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PAG在得物社区S级活动的落地]]></title>    <link>https://juejin.cn/post/7587675306659020800</link>    <guid>https://juejin.cn/post/7587675306659020800</guid>    <pubDate>2025-12-26T07:45:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587675306659020800" data-draft-id="7587675306658627584" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PAG在得物社区S级活动的落地"/> <meta itemprop="keywords" content="设计"/> <meta itemprop="datePublished" content="2025-12-26T07:45:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PAG在得物社区S级活动的落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T07:45:34.000Z" title="Fri Dec 26 2025 07:45:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景</h2>
<p>近期，得物社区活动「用篮球认识我」推出 “用户上传图片生成专属球星卡” 核心玩法。</p>
<p>初期规划由服务端基于 PAG 技术合成，为了让用户可以更自由的定制专属球星卡，经多端评估后确定：由 H5 端承接 “图片交互调整 - 球星卡生成” 核心链路，支持用户单指拖拽、双指缩放 / 旋转人像，待调整至理想位置后触发合成。而 PAG 作为腾讯自研开源的动效工作流解决方案，凭借跨平台渲染一致性、图层实时编辑、轻量化文件性能，能精准匹配需求，成为本次核心技术选型。</p>
<p>鉴于 H5 端需落地该核心链路，且流程涉及 PAG 技术应用，首先需对 PAG 技术进行深入了解，为后续开发与适配奠定基础。</p>
<h2 data-id="heading-1">二、PAG是什么？</h2>
<p>这里简单介绍一下，PAG 是腾讯自研并开源的动效工作流解决方案，核心是实现 Adobe After Effects（AE）动效的一键导出与跨平台应用，包含渲染 SDK、AE 导出插件（PAGExporter）、桌面预览工具（PAGViewer）三部分。</p>
<p>它导出的二进制 PAG 文件压缩率高、解码快，能集成多类资源；支持 Android、iOS、Web 等全平台，且各端渲染一致、开启 GPU 加速；既兼容大部分 AE 动效特性，也允许运行时编辑 —— 比如替换文本 / 图片、调整图层与时间轴，目前已广泛用于各类产品的动效场景。</p>
<p>已知业界中图片基础编辑（如裁剪、调色）、贴纸叠加、滤镜渲染等高频功能，在客户端发布器场景下已广泛采用 PAG技术实现，这一应用趋势在我司及竞品的产品中均有体现，成为支撑这类视觉交互功能的主流技术选择。</p>
<p>正是基于PAG 的跨平台渲染、图层实时编辑特性，其能精准承接 H5 端‘图片交互调整 + 球星卡合成’的核心链路，解决服务端固定合成的痛点，因此成为本次需求的核心技术选型。</p>
<p>为了让大家更直观地感受「用篮球认识我」活动中 “用户上传图片生成专属球星卡” 玩法，我们准备了活动实际效果录屏。通过录屏，你可以清晰看到用户如何通过单指拖拽、双指缩放 / 旋转人像，完成构图调整后生成球星卡的全过程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6d364c65f564fdb941ca847fa126f8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=V5UBY3EPViU4uKz7GXyKm%2BQbsXg%3D" alt="截屏2025-12-26 下午2.53.53.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dcfe266cdd24d82a2bb2786b546c284~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=UxMDfNCTXiTbWYYDFzIEEJsjEPQ%3D" alt="截屏2025-12-26 下午2.54.01.png" loading="lazy"/></p>
<p>接下来，我们将围绕业务目标，详细拆解实现该链路的具体任务优先级与核心模块。</p>
<h2 data-id="heading-2">三、如何实现核心交互链路？</h2>
<p>结合「用篮球认识我」球星卡生成的核心业务目标，按‘基础功能→交互体验→拓展能力→稳定性’优先级，将需求拆解为以下 6 项任务：</p>
<ol>
<li><strong>PAG 播放器基础功能搭建</strong>：实现播放 / 暂停、图层替换、文本修改、合成图导出，为后续交互打基础；</li>
<li><strong>图片交互变换功能开发</strong>：支持单指拖拽、双指缩放 / 旋转，满足人像构图调整需求；</li>
<li><strong>交互与预览实时同步</strong>：将图片调整状态实时同步至 PAG 图层，实现 “操作即预览”；</li>
<li><strong>批量合成能力拓展</strong>：基于单张合成逻辑，支持一次性生成多张球星卡（依赖任务 1-3）；</li>
<li><strong>全链路性能优化</strong>：优化 PAG 实例释放、图层渲染效率，保障 H5 流畅度（贯穿全流程）；</li>
<li><strong>异常场景降级兼容</strong>：针对 SDK 不支持场景，设计静态图层、服务端合成等兜底方案（同步推进）。</li>
</ol>
<p>在明确核心任务拆解后，首要环节是搭建 PAG 播放器基础能力 —— 这是后续图层替换、文本修改、球星卡合成的前提，需从 SDK 加载、播放器初始化、核心功能封装逐步落地。</p>
<h2 data-id="heading-3">四、基础PAG播放器实现</h2>
<h3 data-id="heading-4">加载PAG SDK</h3>
<p>因为是首次接触PAG ，所以在首次加载 SDK 环节便遇到了需要注意的细节：</p>
<p>libpag 的 SDK 加载包含两部分核心文件：</p>
<ul>
<li>主体 libpag.min.js</li>
<li>配套的 libpag.wasm</li>
</ul>
<p><strong>需特别注意</strong>：默认情况下，wasm文件需与 libpag.min.js 置于同一目录，若需自定义路径，也可手动指定其位置。（加载SDK参考文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpag.io%2Fdocs%2Fuse-web-sdk.html%25EF%25BC%2589" target="_blank" title="https://pag.io/docs/use-web-sdk.html%EF%BC%89" ref="nofollow noopener noreferrer">pag.io/docs/use-we…</a></p>
<p>在本项目中，我们将两个文件一同上传至 OSS的同一路径下：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fh5static.xx%2F10122053%2Flibpag.min.js" target="_blank" title="https://h5static.xx/10122053/libpag.min.js" ref="nofollow noopener noreferrer">h5static.xx/10122053/li…</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fh5static.xx%2F10122053%2Flibpag.wasm" target="_blank" title="https://h5static.xx/10122053/libpag.wasm" ref="nofollow noopener noreferrer">h5static.xx/10122053/li…</a></p>
<p>通过 CDN 方式完成加载，确保资源路径匹配。</p>
<p>SDK加载核心代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> loadLibPag = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-comment">// 若已加载，直接返回</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">libpag</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">libpag</span>
  }
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 动态创建script标签加载SDK</span>
    <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>)
    script.<span class="hljs-property">src</span> = <span class="hljs-string">'https://h5static.XX/10122053/libpag.min.js'</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script)
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      script.<span class="hljs-property">onload</span> = <span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-comment">// 等待500ms确保库完全初始化</span>
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">500</span>))
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'LibPag script loaded, checking window.libpag:'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">libpag</span>)
        
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">libpag</span>) {
          <span class="hljs-title function_">resolve</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">libpag</span>)
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'window.libpag is not available'</span>))
        }
      }
      <span class="hljs-comment">// 加载失败处理</span>
      script.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Failed to load libPag script'</span>))
    })
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Failed to load libPag: <span class="hljs-subst">${error}</span>`</span>)
  }
}, [])
</code></pre>
<h3 data-id="heading-5">初始化播放器</h3>
<p>加载完 SDK 后，window 对象会生成 libpag 对象，以此为基础可完成播放器初始化，步骤如下：</p>
<ul>
<li>准备 canvas 容器作为渲染载体；</li>
<li>加载 PAG 核心库并初始化 PAG 环境；</li>
<li>加载目标.pag 文件（动效模板）；</li>
<li>创建 PAGView 实例关联 canvas 与动效文件；</li>
<li>封装播放器控制接口（播放 / 暂停 / 销毁等），并处理资源释放与重复初始化问题。</li>
</ul>
<p>需说明的是，本需求核心诉求是 “合成球星卡图片”，不涉及PAG的视频相关能力，因此暂不扩展视频功能，在播放器初始化后完成立即暂停，后续仅围绕 “图层替换（如用户人像）”“文本替换（如球星名称）” 等核心需求展开。</p>
<p>核心代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { width, height } = props


<span class="hljs-comment">// Canvas渲染容器</span>
<span class="hljs-keyword">const</span> canvasRef = useRef&lt;<span class="hljs-title class_">HTMLCanvasElement</span>&gt;(<span class="hljs-literal">null</span>)
<span class="hljs-comment">// PAG动效模板地址（球星卡模板）</span>
<span class="hljs-keyword">const</span> src = <span class="hljs-string">'https://h5static.XX/10122053/G-lv1.pag'</span>


<span class="hljs-comment">// 初始化播放器函数</span>
<span class="hljs-keyword">const</span> initPlayer = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>)
    <span class="hljs-keyword">const</span> canvas = canvasRef.<span class="hljs-property">current</span>
    <span class="hljs-comment">// 设置Canvas尺寸与球星卡匹配</span>
    canvas.<span class="hljs-property">width</span> = width
    canvas.<span class="hljs-property">height</span> = height
    
    <span class="hljs-comment">// 1. 加载PAG核心库并初始化环境</span>
    <span class="hljs-keyword">const</span> libpag = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadLibPag</span>()
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PAG</span> = <span class="hljs-keyword">await</span> libpag.<span class="hljs-title class_">PAGInit</span>({ <span class="hljs-attr">useScale</span>: <span class="hljs-literal">false</span> })
    
    <span class="hljs-comment">// 2. 加载PAG动效模板</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(src)
    <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">arrayBuffer</span>()
    <span class="hljs-keyword">const</span> pagFile = <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">PAG</span>.<span class="hljs-property">PAGFile</span>.<span class="hljs-title function_">load</span>(buffer)
    
    <span class="hljs-comment">// 3. 创建PAGView，关联Canvas与动效模板</span>
    <span class="hljs-keyword">const</span> pagView = <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">PAG</span>.<span class="hljs-property">PAGView</span>.<span class="hljs-title function_">init</span>(pagFile, canvas)
    
    <span class="hljs-comment">// 4. 封装播放器控制接口</span>
    <span class="hljs-keyword">const</span> player = {
      <span class="hljs-attr">_pagView</span>: pagView,
      <span class="hljs-attr">_pagFile</span>: pagFile,
      <span class="hljs-attr">_PAG</span>: <span class="hljs-variable constant_">PAG</span>,
      <span class="hljs-attr">_isPlaying</span>: <span class="hljs-literal">false</span>,
      
      <span class="hljs-comment">// 播放</span>
      <span class="hljs-keyword">async</span> <span class="hljs-title function_">play</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_pagView</span>.<span class="hljs-title function_">play</span>()
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_isPlaying</span> = <span class="hljs-literal">true</span>
      },
      <span class="hljs-comment">// 暂停（初始化后默认暂停）</span>
      <span class="hljs-title function_">pause</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_pagView</span>.<span class="hljs-title function_">pause</span>()
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_isPlaying</span> = <span class="hljs-literal">false</span>
      },
      <span class="hljs-comment">// 销毁实例，释放资源</span>
      <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_pagView</span>.<span class="hljs-title function_">destroy</span>()
      },
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'PAG Player initialization failed:'</span>, error)
  } 
}, [src, width, height])
</code></pre>
<p><strong>实现效果</strong></p>
<p>播放器初始化完成后，可在Canvas中正常展示球星卡动效模板（初始化后默认暂停）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fad50f876ee4dea8bea2fbcac6018de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=PzWUqcrlOWM%2FlJAoUKvfd52Nw%2FQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>接下来我们来实现替换图层及文本功能。</p>
<h3 data-id="heading-6">替换图层及文本</h3>
<p>替换 “用户上传人像”（图层）与 “球星名称”（文本）是核心需求，需通过 PAGFile 的原生接口实现，并扩展播放器实例的操作方法：</p>
<ul>
<li><strong>图片图层替换</strong>：调用pagFile.replaceImage(index, image) 接口，将指定索引的图层替换为用户上传图片（支持 CDN 地址、Canvas 元素、Image 元素作为图片源）；</li>
<li><strong>文本内容替换</strong>：调用pagFile.setTextData(index, textData) 接口，修改指定文本图层的内容与字体；</li>
<li><strong>效果生效</strong>：每次替换后需调用 pagView.flush() 强制刷新渲染，确保修改实时生效。</li>
</ul>
<p><strong>实现方案</strong></p>
<ul>
<li>替换图片图层：通过pagFile.replaceImage(index, image)接口，将指定索引的图层替换为用户上传图片；</li>
<li>替换文本内容：通过pagFile.setTextData(index, textData)接口，修改指定文本图层的内容；</li>
<li>扩展播放器接口后，需调用flush()强制刷新渲染，确保替换效果生效。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d4f0a8a802e4de4ab1a0837984704f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=zMWQHOUsbMz7oyiPlhxrpYCdoIg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>初期问题：文本字体未生效</strong></p>
<p>替换文本后发现设定字体未应用。排查后确认：自定义字体包未在 PAG 环境中注册，导致 PAG 无法识别字体。</p>
<p>需在加载 PAG 模板前，优先完成字体注册，确保 PAG 能正常调用目标字体，具体实现步骤如下。</p>
<p>PAG提供PAGFont.registerFont()接口用于注册自定义字体，需传入 “字体名称” 与 “字体文件资源”（如.ttf/.otf 格式文件），流程为：</p>
<ul>
<li>加载字体文件（从 CDN/OSS 获取字体包）；</li>
<li>调用 PAG 接口完成注册；</li>
<li>注册成功后，再加载.pag文件，确保后续文本替换时字体已生效。</li>
</ul>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 需注册的字体列表（字体名称+CDN地址）</span>
<span class="hljs-keyword">const</span> fonts = [
  {
    <span class="hljs-attr">family</span>: <span class="hljs-string">'POIZONSans'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'https://h5static.XX/10122053/20250827-febf35c67d9232d4.ttf'</span>,
  },
  {
    <span class="hljs-attr">family</span>: <span class="hljs-string">'FZLanTingHeiS-DB-GB'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'https://h5static.XX/10122053/20250821-1e3a4fccff659d1c.ttf'</span>,
  },
]


<span class="hljs-comment">// 在“加载PAG核心库”后、“加载PAG模板”前，新增字体注册逻辑</span>
<span class="hljs-keyword">const</span> initPlayer = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-comment">// ... 原有代码（Canvas准备、加载libpag）</span>
  <span class="hljs-keyword">const</span> libpag = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadLibPag</span>()
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PAG</span> = <span class="hljs-keyword">await</span> libpag.<span class="hljs-title class_">PAGInit</span>({ <span class="hljs-attr">useScale</span>: <span class="hljs-literal">false</span> })
  
  <span class="hljs-comment">// 新增：注册自定义字体</span>
  <span class="hljs-keyword">if</span> (fonts &amp;&amp; fonts.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable constant_">PAG</span>?.<span class="hljs-property">PAGFont</span>?.<span class="hljs-property">registerFont</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> { family, url } <span class="hljs-keyword">of</span> fonts) {
        <span class="hljs-keyword">if</span> (!family || !url) <span class="hljs-keyword">continue</span>
        <span class="hljs-comment">// 加载字体文件（CORS跨域配置+强制缓存）</span>
        <span class="hljs-keyword">const</span> resp = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, { <span class="hljs-attr">mode</span>: <span class="hljs-string">'cors'</span>, <span class="hljs-attr">cache</span>: <span class="hljs-string">'force-cache'</span> })
        <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">await</span> resp.<span class="hljs-title function_">blob</span>()
        <span class="hljs-comment">// 转换为File类型（PAG注册需File格式）</span>
        <span class="hljs-keyword">const</span> filename = url.<span class="hljs-title function_">split</span>(<span class="hljs-string">'/'</span>).<span class="hljs-title function_">pop</span>() || <span class="hljs-string">'font.ttf'</span>
        <span class="hljs-keyword">const</span> fontFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>([blob], filename)
        <span class="hljs-comment">// 注册字体</span>
        <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">PAG</span>.<span class="hljs-property">PAGFont</span>.<span class="hljs-title function_">registerFont</span>(family, fontFile)
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Registered font for PAG:'</span>, family)
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Register fonts for PAG failed:'</span>, e)
    }
  }
  
  <span class="hljs-comment">// 继续加载PAG模板（原有代码）</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(src)
  <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">arrayBuffer</span>()
  <span class="hljs-keyword">const</span> pagFile = <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">PAG</span>.<span class="hljs-property">PAGFile</span>.<span class="hljs-title function_">load</span>(buffer)
  <span class="hljs-comment">// ... 后续创建PAGView、封装播放器接口</span>
}, [src, width, height])
</code></pre>
<p><strong>最终效果</strong></p>
<p>字体注册后，文本替换的字体正常生效，人像与文本均显示正确：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/405c50bb121c43049d8116a1584db07f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=objPcWRKzCFp%2FDbwdaU37xX5gJM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>数字字体已应用成功</p>
<p>可以看到，替换文本的字体已正确应用。接下来我们来实现最后一步，将更新图层及文本后的内容导出为CDN图片。</p>
<h3 data-id="heading-7">PagPlayer截帧（导出PagPlayer当前展示内容）</h3>
<p>截帧是将 “调整后的人像 + 替换后的文本 + 动效模板” 固化为最终图片的关键步骤。开发初期曾直接调用pagView.makeSnapshot()遭遇导出空帧，后通过updateSize()+flush()解决同步问题；此外，还有一种更直接的方案 ——直接导出PAG渲染对应的Canvas内容，同样能实现需求，且流程更简洁。</p>
<p><strong>初期问题：直接调用接口导致空帧</strong></p>
<p>开发初期，尝试直接使用PAGView提供的makeSnapshot()接口截帧，但遇到了返回空帧（全透明图片）情况经过反复调试和查阅文档，发现核心原因是PAG 渲染状态与调用时机不同步：</p>
<ul>
<li><strong>尺寸不同步</strong>：PAGView 内部渲染尺寸与 Canvas 实际尺寸不匹配，导致内容未落在可视区域；</li>
<li><strong>渲染延迟</strong>：图层替换、文本修改后，GPU 渲染是异步的，此时截帧只能捕获到未更新的空白或旧帧。</li>
</ul>
<p><strong>解决方案</strong></p>
<p>针对空帧问题，结合 PAG 在 H5 端 “基于 Canvas 渲染” 的特性，梳理出两种可行方案，核心都是 “先确保渲染同步，再获取画面”：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/350f4915f8a14f74a5a91479c8f727c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=rekCHrp2TwcDocokRn6CqTJfcHo%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>最终落地流程</strong></p>
<ul>
<li>调用 pagView.updateSize() 与 pagView.flush() 确保渲染同步；</li>
<li>通过canvas.toDataURL('image/jpeg', 0.9) 生成 Base64 格式图片（JPG 格式，清晰度 0.9，平衡质量与体积）；</li>
<li>将 Base64 图片上传至 CDN，获取可访问的球星卡链接。</li>
</ul>
<p>点击截帧按钮后，即可生成对应的截图。</p>
<p>完成 PAG 播放器的基础功能（图层替换、文本修改、截帧导出）后，我们来聚焦用户核心交互需求 —— 人像的拖拽、缩放与旋转，通过封装 Canvas 手势组件，实现精准的人像构图调整能力。</p>
<h2 data-id="heading-8">五、图片变换功能开发：实现人像拖拽、缩放与旋转</h2>
<p>在球星卡合成流程中，用户需自主调整上传人像的位置、尺寸与角度以优化构图。我们可以基于 Canvas 封装完整的手势交互能力组件，支持单指拖拽、双指缩放 / 旋转，同时兼顾高清渲染与跨设备兼容性。</p>
<h3 data-id="heading-9">功能目标</h3>
<p>针对 “用户人像调整” 场景，组件需实现以下核心能力：</p>
<ul>
<li><strong>基础交互</strong>：支持单指拖拽移动人像、双指缩放尺寸、双指旋转角度；</li>
<li><strong>约束控制</strong>：限制缩放范围（如最小 0.1 倍、最大 5 倍），可选关闭旋转功能；</li>
<li><strong>高清渲染</strong>：适配设备像素比（DPR），避免图片拉伸模糊；</li>
<li><strong>状态同步</strong>：实时反馈当前变换参数（偏移量、缩放比、旋转角），支持重置与结果导出。</li>
</ul>
<h3 data-id="heading-10">效果展示</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/811762938b80442bad5020688afbaf2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=hQMmlIYHZRjYm%2BGX3fthzZRJpyw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-11">组件设计理念</h3>
<p>在组件设计之初，我们来使用分层理念，将图片编辑操作分解为三个独立层次：</p>
<p><strong>交互感知层</strong></p>
<p><strong>交互感知层 - 捕获用户手势并转换为标准化的变换意图</strong></p>
<ul>
<li>手势语义化：将原始的鼠标/触摸事件转换为语义化的操作意图</li>
<li>单指移动 = 平移意图</li>
<li>双指距离变化 = 缩放意图</li>
<li>双指角度变化 = 旋转意图</li>
<li>双击 = 重置意图</li>
</ul>
<p><strong>变换计算层</strong></p>
<p><strong>变换计算层 - 处理几何变换逻辑和约束规则</strong></p>
<ul>
<li><strong>多点触控的几何计算</strong>：双指操作时，系统会实时计算两个触点形成的几何关系（距离、角度、中心点），然后将这些几何变化映射为图片的变换参数。</li>
<li><strong>交互连续性</strong>：每次手势开始时记录初始状态，移动过程中所有计算都基于这个初始状态进行增量计算，确保变换的连续性和平滑性。</li>
</ul>
<p><strong>渲染执行层</strong></p>
<p><strong>渲染执行层 - 将变换结果绘制到Canvas上</strong></p>
<ul>
<li><strong>高清适配</strong>：Canvas的物理分辨率和显示尺寸分离管理，物理分辨率适配设备像素比保证清晰度，显示尺寸控制界面布局。</li>
<li><strong>变换应用</strong>：绘制时按照特定顺序应用变换 - 先移动到画布中心建立坐标系，再应用用户的平移、旋转、缩放操作，最后以图片中心为原点绘制。这个顺序确保了变换的直观性。</li>
<li><strong>渲染控制</strong>：区分实时交互和静态显示两种场景，实时交互时使用requestAnimationFrame保证流畅性，静态更新时使用防抖减少不必要的重绘。</li>
</ul>
<h3 data-id="heading-12">数据流设计</h3>
<ul>
<li><strong>单向数据流</strong>：用户操作 → 手势解析 → 变换计算 → 约束应用 → 状态更新 → 重新渲染 → 回调通知。这种单向流动保证了数据的可追踪性。</li>
<li><strong>状态同步机制</strong>：内部状态变化时，通过回调机制同步给外部组件，支持实时同步和延迟同步两种模式，适应不同的性能需求。</li>
</ul>
<p>实现独立的人像交互调整功能后，关键是打通 “用户操作” 与 “PAG 预览” 的实时同步链路 —— 确保用户每一次调整都能即时反馈在球星卡模板中，这需要设计分层同步架构与高效调度策略。</p>
<h2 data-id="heading-13">六、交互与预览实时同步</h2>
<p>在球星卡生成流程中，“用户调整人像” 与 “PAG 预览更新” 的实时同步是核心体验指标 —— 用户每一次拖拽、缩放或旋转操作，都需要即时反馈在球星卡模板中，才能让用户精准判断构图效果。我们先来看一下实现效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fda5eb04c8744b7d81053047e34321cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=Fy2ZE0uP%2Bt%2FHLI2li8UCJy387mo%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>接下来，我们从逻辑架构、关键技术方案、边界场景处理三方面，拆解 “用户交互调整” 与 “PAG 预览同步” 链路的实现思路。</p>
<h3 data-id="heading-14">逻辑架构：三层协同同步模型</h3>
<p>组件将 “交互 - 同步 - 渲染” 拆分为三个独立但协同的层级，各层职责单一且通过明确接口通信，避免耦合导致的同步延迟或状态混乱。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72b5b151b1cb40cd9fcae281a5dab73d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=oZI%2F8D5Nyk4%2BLU%2FKYCGq5ajDBgs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>核心流转链路</strong>：用户操作 → CanvasImageEditor 生成实时 Canvas → 同步层直接复用 Canvas 更新 PAG 图层 → 调度层批量触发 flush → PagPlayer 渲染最新画面。</p>
<h3 data-id="heading-15">关键方案：低损耗 + 高实时性的平衡</h3>
<p>为同时兼顾 “高频交互导致 GPU 性能瓶颈” 与 “实时预览需即时反馈” ，组件通过三大核心技术方案实现平衡。</p>
<p><strong>复用 Canvas 元素</strong></p>
<p>跳过格式转换环节，减少性能消耗，直接复用 Canvas 元素作为 PAG 图片源。</p>
<p><strong>核心代码逻辑：</strong></p>
<p>通过 canvasEditorRef.current.getCanvas() 获取交互层的 Canvas 实例，直接传入PAG 的 replaceImageFast 接口（快速替换，不触发即时刷新），避免数据冗余处理。</p>
<pre><code class="hljs language-ini" lang="ini">// 直接使用 Canvas 元素更新 PAG，无格式转换
const <span class="hljs-attr">canvas</span> = canvasEditorRef.current.getCanvas()<span class="hljs-comment">;</span>
pagPlayerRef.current.replaceImageFast(editImageIndex, canvas)<span class="hljs-comment">; // 快速替换，不flush</span>
</code></pre>
<p><strong>智能批量调度：</strong></p>
<p><strong>分级处理更新，兼顾流畅与效率</strong></p>
<p>针对用户连续操作（如快速拖拽）产生的高频更新，组件设计 “分级调度策略”，避免每一次操作都触发 PAG 的 flush（GPU 密集型操作）：</p>
<p><strong>调度逻辑</strong>：</p>
<p>实时操作合并：通过 requestAnimationFrame 捕获连续操作，将 16ms 内的多次替换指令合并为一次；</p>
<p><strong>智能 flush 决策</strong>：</p>
<p>若距离上次 flush 超过 100ms（用户操作暂停），立即触发 flushPagView()，确保预览不延迟；</p>
<p>若操作仍在持续，延迟 Math.max(16, updateThrottle/2) 毫秒再 flush，合并多次更新。</p>
<p><strong>防抖降级</strong>：</p>
<p>当 updateThrottle &gt; 16ms（低实时性需求场景），自动降级为防抖策略，避免过度调度。</p>
<p><strong>核心代码片段</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 智能 flush 策略：短间隔合并，长间隔立即刷新</span>
const timeSinceLastFlush = Date<span class="hljs-selector-class">.now</span>() - batchUpdate<span class="hljs-selector-class">.lastFlushTime</span>;
if (timeSinceLastFlush &gt; <span class="hljs-number">100</span>) {
  await <span class="hljs-built_in">flushPagView</span>(); <span class="hljs-comment">// 间隔久，立即刷新</span>
} else {
  <span class="hljs-comment">// 延迟刷新，合并后续操作</span>
  <span class="hljs-built_in">setTimeout</span>(async () =&gt; {
    if (batchUpdate.pendingUpdates &gt; <span class="hljs-number">0</span>) {
      await <span class="hljs-built_in">flushPagView</span>();
    }
  }, Math<span class="hljs-selector-class">.max</span>(<span class="hljs-number">16</span>, updateThrottle/<span class="hljs-number">2</span>));
}
</code></pre>
<p><strong>双向状态校验：</strong></p>
<p><strong>解决首帧 / 切换场景的同步空白</strong></p>
<p>针对 “PAG 加载完成但 Canvas 未就绪”“Canvas 就绪但 PAG 未初始化” 等首帧同步问题，组件设计双向重试校验机制：</p>
<ul>
<li>PAG 加载后校验：handlePagLoad 中启动 60 帧（约 1s）重试，检测 Canvas 与 PAG 均就绪后，触发初始同步；</li>
<li>Canvas 加载后校验：handleCanvasImageLoad 同理，若 PAG 未就绪，重试至两者状态匹配；</li>
<li>编辑模式切换校验：进入 startEdit 时，通过像素检测（getImageData）判断 Canvas 是否有内容，有则立即同步，避免空白预览。</li>
</ul>
<h3 data-id="heading-16">边界场景处理：保障同步稳定性</h3>
<p><strong>编辑模式切换的状态衔接</strong></p>
<ul>
<li>进入编辑：暂停 PAG 播放，显示透明的 Canvas 交互层（opacity: 0，仅保留交互能力），触发初始同步；</li>
<li>退出编辑：清理批量调度定时器，强制 flush 确保最终状态生效，按需恢复 PAG 自动播放。</li>
</ul>
<p><strong>文本替换与图片同步的协同</strong></p>
<p>当外部传入 textReplacements（如球星名称修改）时，通过独立的 applyToPagText 接口更新文本图层，并与图片同步共享 flush 调度，避免重复刷新：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 文本替换后触发统一 flush</span>
<span class="hljs-built_in">useEffect</span>(() =&gt; {
  if (textReplacements?.length) {
    <span class="hljs-built_in">applyToPagText</span>();
    <span class="hljs-built_in">flushPagView</span>();
  }
}, <span class="hljs-selector-attr">[textReplacements]</span>);
</code></pre>
<p><strong>组件卸载的资源清理</strong></p>
<p>卸载时清除批量调度的定时器（clearTimeout），避免内存泄漏；同时 PAG 内部会自动销毁实例，释放 GPU 资源。</p>
<h3 data-id="heading-17">PAG人像居中无遮挡</h3>
<p>假设给定任意一张图片，我们将其绘制到Canvas中时，图片由于尺寸原因可能会展示不完整，如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f20320c6d45c4965a2d4a791fab68979~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=iXhbtjcj2kDyMBCDzSzqO11S%2B1Y%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>那么，如何保证任意尺寸图片在固定尺寸Canvas中初始化默认居中无遮挡呢？</p>
<p>我们采用以下方案：</p>
<p><strong>等比缩放算法（Contain模式）</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 计算适配缩放比例，确保图片完整显示</span>
<span class="hljs-type">const</span> fitScale = Math.<span class="hljs-built_in">min</span>(
  editCanvasWidth / image.width,   <span class="hljs-comment">// 宽度适配比例</span>
  availableHeight / image.height   <span class="hljs-comment">// 高度适配比例（考虑留白）</span>
)
</code></pre>
<p>核心原理：</p>
<ul>
<li>选择较小的缩放比例，确保图片在两个方向上都不会超出边界；</li>
<li>这就是CSS的object-fit: contain效果，保证图片完整可见。</li>
<li/>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1844bb68295646529e48d32d674b49b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=OSov7g1%2BbYGqAa16tpQ2j1HJa0I%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>顶部留白预留</strong></p>
<p>实际的PAG模板中，顶部会有一部分遮挡，因此需要对整个画布Canvas顶部留白。</p>
<p>如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8c97a982a1e47449476bcb38ef04ed9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=%2FjPaXe7garlxXEPlEfFnc9KQHqU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>为人像的头部区域预留空间</li>
<li>避免重要的面部特征被PAG模板的装饰元素遮挡</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dd54db9849547c885cba5cf79fddbdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=8cDAeZcTpWYZIm%2BSCCH78uelAHc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>核心代码</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 顶部留白比例</span>
<span class="hljs-type">const</span> TOP_BLANK_RATIO = <span class="hljs-number">0.2</span>


<span class="hljs-type">const</span> handleCanvasImageLoad = <span class="hljs-built_in">useCallback</span>(
  <span class="hljs-built_in">async</span> (image: HTMLImageElement) =&gt; {
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'Canvas图片加载完成:'</span>, image.width, <span class="hljs-string">'x'</span>, image.height)
    <span class="hljs-built_in">setIsImageReady</span>(<span class="hljs-literal">true</span>)


    <span class="hljs-comment">// 初始等比缩放以完整可见（contain）</span>
    <span class="hljs-keyword">if</span> (canvasEditorRef.current) {
      <span class="hljs-comment">// 顶部留白比例</span>
      <span class="hljs-type">const</span> TOP_BLANK_RATIO = spaceTopRatio ?? <span class="hljs-number">0</span>
      <span class="hljs-type">const</span> availableHeight = editCanvasHeight * (<span class="hljs-number">1</span> - TOP_BLANK_RATIO)


      <span class="hljs-comment">// 以可用高度进行等比缩放（同时考虑宽度）</span>
      <span class="hljs-type">const</span> fitScale = Math.<span class="hljs-built_in">min</span>(
        editCanvasWidth / image.width, 
        availableHeight / image.height
      )


      <span class="hljs-comment">// 计算使图片顶部恰好留白 TOP_BLANK_RATIO 的位移</span>
      <span class="hljs-type">const</span> topMargin = editCanvasHeight * TOP_BLANK_RATIO
      <span class="hljs-type">const</span> imageScaledHeight = image.height * fitScale
      <span class="hljs-type">const</span> targetCenterY = topMargin + imageScaledHeight / <span class="hljs-number">2</span>
      <span class="hljs-type">const</span> yOffset = targetCenterY - editCanvasHeight / <span class="hljs-number">2</span>
      
      canvasEditorRef.current.<span class="hljs-built_in">setTransform</span>({ 
        x: <span class="hljs-number">0</span>, 
        y: yOffset, 
        scale: fitScale, 
        rotation: <span class="hljs-number">0</span> 
      })
    }
    <span class="hljs-comment">// ...</span>
  },
  [applyToPag, flushPagView, isEditMode, editCanvasWidth, editCanvasHeight]
)
</code></pre>
<p>在单张球星卡的交互、预览与合成链路跑通后，需进一步拓展批量合成能力，以满足多等级球星卡一次性生成的业务需求，核心在于解决批量场景下的渲染效率、资源管理与并发控制问题。</p>
<h2 data-id="heading-18">七、批量生成</h2>
<p>在以上章节，我们实现了单个卡片的交互及合成，但实际的需求中还有批量生成的需求，用来合成不同等级的球星卡，因此接下来我们需要处理批量生成相关的逻辑（碍于篇幅原因，这里我们就不展示代码了，主要以流程图形式来呈现。</p>
<p>经统计，经过各种手段优化后本活动中批量合成8张图最快仅需3s，最慢10s，批量合成过程用户基本是感知不到。</p>
<h3 data-id="heading-19">关键技术方案</h3>
<ul>
<li>离线渲染隐藏容器：避免布局干扰</li>
<li>资源缓存与预加载：提升合成效率</li>
<li>并发工作协程池：平衡性能与稳定性</li>
<li>多层重试容错：提升合成成功率</li>
<li>图片处理与尺寸适配：保障合成质量</li>
<li>结合业务场景实现批量合成中断下次访问页面后台继续生成的逻辑：保障合成功能稳定性。</li>
</ul>
<h3 data-id="heading-20">核心架构</h3>
<ul>
<li>资源管理层：负责PAG库加载、buffer缓存、预加载调度</li>
<li>任务处理层：单个模板的渲染流水线，包含重试机制</li>
<li>并发控制层：工作协程池管理，任务队列调度</li>
</ul>
<h3 data-id="heading-21">整体批量合成流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/612b7f364a01464682a2e01d60f4a0b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=4uzWIL8yDryQcpg0M3eItoblv%2FQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>节拍拉取：按照固定时间间隔依次拉取资源，而非一次性并发获取所有资源</p>
<h3 data-id="heading-22">单个模板处理流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a635fd380fd46e18a0c9653cbda2bca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=udNFW54g0aY206qaj%2B3b4dCCPIs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c97ecbecda84aeeaa2e8375e5a4b760~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=USGY5wKbL7t%2B0UNqfSZZpDRFMSI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-23">并发工作协程模式</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4ffb9d653c3461394a6d8ece9c75c42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=zFxVlSb59WJjwShdqzKBQGKhQsE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>共享游标：多个工作协程共同使用的任务队列指针，用于协调任务分配。</p>
<p>原子获取任务：确保在并发环境下，每个任务只被一个协程获取，避免重复处理。</p>
<p>资源管理与缓存策略</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1b994db9a114173bcf9805939ae4b92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=KO9Wip5uJjz2Mj6ipKUhzkf6CWU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>批量合成与单卡交互的功能落地后，需针对开发过程中出现的卡顿、空帧、加载慢等问题进行针对性优化，同时构建兼容性检测与降级方案，保障不同环境下功能的稳定可用。</p>
<h2 data-id="heading-24">八、性能优化与降级兼容</h2>
<h3 data-id="heading-25">性能优化</h3>
<p>上述功能开发和实现并非一蹴而就，过程中遇到很多问题，诸如：</p>
<ul>
<li>图片拖动卡顿</li>
<li>Canvas导出空图、导出图片模糊</li>
<li>批量合成时间较久</li>
<li>PAG初始加载慢</li>
<li>导出图片时间久</li>
</ul>
<p>等等问题，因此，我们在开发过程中就对各功能组件进行性能优化，大体如下：</p>
<p><strong>PagPlayer（PAG播放器）</strong></p>
<p><strong>资源管理优化</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// src变化时主动销毁旧实例，释放WebGL/PAG资源</span>
if (srcChanged) {
  if (pagPlayer) {
    try {
      pagPlayer<span class="hljs-selector-class">.destroy</span>()
    } catch (e) {
      console<span class="hljs-selector-class">.warn</span>('Destroy previous player failed:', e)
    }
  }
}
</code></pre>
<p><strong>WebGL检查与降级</strong>：</p>
<ul>
<li>检查WebGL支持，不可用时降级为2D警告</li>
<li>验证Canvas状态和尺寸</li>
<li>PAGView创建带重试机制</li>
</ul>
<p><strong>字体预注册</strong>：</p>
<ul>
<li>必须在加载PAG文件之前注册字体</li>
<li>使用File类型进行字体注册</li>
</ul>
<p><strong>CanvasImageEditor（Canvas图片编辑器）</strong></p>
<p><strong>高DPI优化：</strong></p>
<ul>
<li>自动检测设备像素比，适配高分辨率设备</li>
<li>分离物理像素和CSS像素，确保清晰度</li>
</ul>
<p><strong>内存管理</strong>：</p>
<ul>
<li>组件卸载时自动清理Canvas资源</li>
<li>启用高质量图像平滑，避免出现边缘锯齿</li>
<li>使用CSS touch-action控制触摸行为</li>
</ul>
<p><strong>EditablePagPlayer（可编辑PAG播放器）</strong></p>
<p><strong>智能批量更新系统：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 高性能实时更新 - 使用RAF + 批量flush</span>
const smartApplyToPag = <span class="hljs-built_in">useMemo</span>(() =&gt; {
  return () =&gt; {
    rafId = <span class="hljs-built_in">requestAnimationFrame</span>(async () =&gt; {
      await <span class="hljs-built_in">applyToPag</span>() <span class="hljs-comment">// 快速图片替换（无flush）</span>
      <span class="hljs-built_in">smartFlush</span>(batchUpdateRef.current) <span class="hljs-comment">// 管理批量flush</span>
    })
  }
}, <span class="hljs-selector-attr">[]</span>)
</code></pre>
<p><strong>批量flush策略：</strong></p>
<ul>
<li>距离上次flush超过100ms立即flush</li>
<li>否则延迟16ms~updateThrottle/2合并多次更新</li>
<li>减少PAG刷新次数，提升性能</li>
</ul>
<p><strong>内存优化</strong>：</p>
<ul>
<li>自动管理Canvas和PAG资源生命周期</li>
<li>智能预热：检测Canvas内容避免不必要初始化</li>
<li>资源复用：复用Canvas元素</li>
</ul>
<p><strong>PAGBatchComposer（批量PAG合成器）</strong></p>
<p><strong>高并发处理：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 工作协程：按队列取任务直至耗尽或取消</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">runWorker</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">while</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelled</span>) {
    <span class="hljs-keyword">const</span> idx = cursor++
    <span class="hljs-keyword">if</span> (idx &gt;= total) <span class="hljs-keyword">break</span>
    <span class="hljs-comment">// 处理单个模板...</span>
  }
}
</code></pre>
<p><strong>智能重试机制</strong>：</p>
<ul>
<li>外层重试：最多3次整体重试，递增延迟</li>
<li>内层重试：PAG操作级别重试2次</li>
<li>首次延迟：第一个PAG处理增加500ms延迟</li>
</ul>
<p><strong>内存管理</strong>：</p>
<ul>
<li>每个模板处理完成后立即清理Canvas和PAG对象</li>
<li>集成Canvas计数器监控内存使用</li>
<li>支持强制清理超时实例</li>
</ul>
<p><strong>性能监控debugUtils</strong></p>
<ul>
<li>提供详细的性能监控和调试日志</li>
<li>支持批量统计分析（吞吐量、平均时间等）</li>
</ul>
<h3 data-id="heading-26">降级兼容</h3>
<p>由于核心业务依赖 PAG 技术栈，而 PAG 运行需 WebGL 和 WebAssembly 的基础API支持，因此必须在应用初始化阶段对这些基础 API 进行兼容性检测，并针对不支持的环境执行降级策略，以保障核心功能可用性。</p>
<p>核心API检测代码如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isWebGLAvailable</span>(<span class="hljs-params"/>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> === <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>)
    <span class="hljs-keyword">const</span> gl =
      canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'webgl'</span>) ||
      (canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'experimental-webgl'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">WebGLRenderingContext</span> | <span class="hljs-literal">null</span>)
    <span class="hljs-keyword">return</span> !!gl
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
}


<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isWasmAvailable</span>(<span class="hljs-params"/>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> hasBasic =
      <span class="hljs-keyword">typeof</span> (globalThis <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">WebAssembly</span> === <span class="hljs-string">'object'</span> &amp;&amp;
      <span class="hljs-keyword">typeof</span> (<span class="hljs-title class_">WebAssembly</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">instantiate</span> === <span class="hljs-string">'function'</span>
    <span class="hljs-keyword">if</span> (!hasBasic) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    <span class="hljs-comment">// 最小模块校验，规避“存在但不可用”的情况</span>
    <span class="hljs-keyword">const</span> bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0x00</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x6d</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>])
    <span class="hljs-keyword">const</span> mod = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Module</span>(bytes)
    <span class="hljs-keyword">const</span> inst = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Instance</span>(mod)
    <span class="hljs-keyword">return</span> inst <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-property">Instance</span>
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
}


<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isPagRuntimeAvailable</span>(<span class="hljs-params"/>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">isWebGLAvailable</span>() &amp;&amp; <span class="hljs-title function_">isWasmAvailable</span>()
}
</code></pre>
<p><strong>环境适配策略</strong></p>
<ul>
<li>兼容环境（检测通过）：直接执行 H5 端 PAG 初始化流程，启用完整的前端交互编辑能力。</li>
<li>不兼容环境（检测失败）：自动切换至服务端合成链路，通过预生成静态卡片保障核心功能可用，确保用户仍能完成球星卡生成的基础流程。</li>
</ul>
<h2 data-id="heading-27">九、小结</h2>
<p>本次「用篮球认识我」球星卡生成功能开发，围绕 “用户自主调整 + 跨端一致渲染” 核心目标，通过 PAG 技术与 Canvas 交互的深度结合，构建了从单卡编辑到批量合成的完整技术链路，可从问题解决、技术沉淀、业务价值三方面总结核心成果：</p>
<p><strong>问题解决：解决业务痛点，优化用户体验</strong></p>
<p>针对初期 “服务端固定合成导致构图偏差” 的核心痛点，通过 H5 端承接关键链路，保障活动玩法完整性：</p>
<ul>
<li>交互自主性：基于 Canvas 封装的CanvasImageEditor组件，支持单指拖拽、双指缩放 / 旋转，让用户可精准调整人像构图，解决 “固定合成无法适配个性化需求” 问题；</li>
<li>预览实时性：设计 “交互感知 - 同步调度 - 渲染执行” 三层模型，通过复用 Canvas 元素、智能批量调度等方案，实现操作与 PAG 预览的即时同步，避免 “调整后延迟反馈” 的割裂感；</li>
<li>场景兼容性：针对 PAG 加载失败、WebGL 不支持等边界场景，设计静态图层兜底、服务端合成降级、截帧前渲染同步等方案，保障功能高可用性。</li>
</ul>
<p><strong>技术沉淀</strong></p>
<p>本次开发过程中，围绕 PAG 技术在 H5 端的应用，沉淀出一套标准化的技术方案与组件体系，可复用于后续图片编辑、动效合成类需求：</p>
<ul>
<li>组件化封装：拆分出PagPlayer（基础播放与图层替换）、CanvasImageEditor（手势交互）、EditablePagPlayer（交互与预览同步）、PAGBatchComposer（批量合成）四大核心组件，各组件职责单一、接口清晰，支持灵活组合；</li>
<li>性能优化：通过 “高清适配（DPR 处理）、资源复用（Canvas 直接传递）、调度优化（RAF 合并更新）、内存管理（实例及时销毁）” 等优化方向，为后续复杂功能的性能调优提供参考范例；</li>
<li>问题解决案例：记录 PAG 字体注册失效、截帧空帧、批量合成卡顿等典型问题的排查思路与解决方案，形成技术文档，降低后续团队使用 PAG 的门槛。</li>
</ul>
<p><strong>业务价值：支撑活动爆发，拓展技术边界</strong></p>
<p>从业务落地效果来看，本次技术方案不仅满足了「用篮球认识我」活动的核心需求，更为社区侧后续视觉化功能提供了技术支撑：</p>
<ul>
<li>活动保障：球星卡生成功能上线后，未出现因技术问题导致的功能不可用。</li>
<li>技术能力拓展：首次在社区 H5 端落地 PAG 动效合成与手势交互结合的方案，填补了 “前端 PAG 应用” 的技术空白，为后续一些复杂交互奠定基础。</li>
</ul>
<p><strong>后续优化方向</strong></p>
<p>尽管当前方案已满足业务需求，但仍有可进一步优化的空间：</p>
<ul>
<li>性能再提升：批量合成场景下，可探索 Web Worker 分担 PAG 解析压力，减少主线程阻塞。</li>
<li>功能扩展：在CanvasImageEditor中增加图片裁剪、滤镜叠加等功能，拓展组件的适用场景。</li>
</ul>
<h3 data-id="heading-28">往期回顾</h3>
<ol>
<li>
<p>Ant Design 6.0 尝鲜：上手现代化组件开发｜得物技术</p>
</li>
<li>
<p>Java 设计模式：原理、框架应用与实战全解析｜得物技术</p>
</li>
<li>
<p>Go语言在高并发高可用系统中的实践与解决方案｜得物技术</p>
</li>
<li>
<p>从0到1搭建一个智能分析OBS埋点数据的AI Agent｜得物技术</p>
</li>
<li>
<p>数据库AI方向探索-MCP原理解析&amp;DB方向实战｜得物技术</p>
</li>
</ol>
<h3 data-id="heading-29">文 /无限</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回收团队基于Cursor集成MCP的智能代码修复提示词生成实践]]></title>    <link>https://juejin.cn/post/7587998744294752262</link>    <guid>https://juejin.cn/post/7587998744294752262</guid>    <pubDate>2025-12-26T10:29:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587998744294752262" data-draft-id="7588002126258356230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="回收团队基于Cursor集成MCP的智能代码修复提示词生成实践"/> <meta itemprop="keywords" content="程序员,人工智能,Python"/> <meta itemprop="datePublished" content="2025-12-26T10:29:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            回收团队基于Cursor集成MCP的智能代码修复提示词生成实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:29:56.000Z" title="Fri Dec 26 2025 10:29:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、痛点</h2>
<h3 data-id="heading-1">痛点一：为什么我的Token消耗的这么快</h3>
<p>Token的消耗量通常受到下面两个因素的影响</p>
<ul>
<li>输入和输出的Token数量：输入的Token越多，输出的Token也会相应增加，因为模型会基于输入的上下文进行内容生成。</li>
<li>任务复杂性：更复杂的任务通常需要消耗更多的Token，而多模态的Agent往往消耗的Token会更高。</li>
</ul>
<p>为什么模糊的提示词会增加Token的消耗量？</p>
<ul>
<li>模糊的提示词可能包含大量与输出不相关的内容，增加输入的Token量。</li>
<li>模糊的提示词通常缺乏具体细节或明确约束，导致模型无法直接理解用户意图。为了覆盖可能的解释，模型倾向于生成更长、更全面的响应，以避免遗漏关键信息，从而增加输出token数量。</li>
<li>模糊的提示词往往无法精准的生成用户想要的内容。用户可能因输出不符合预期而多次修改提示，形成无效交互循环，无形中浪费Token。</li>
</ul>
<h3 data-id="heading-2">痛点二：AI修复代码为什么总是"差点意思"？</h3>
<p>一般都是拿到Sonar 扫描结果复制粘贴, 让AI修复后，一个一个改, 又太慢, 太多问题要么修复不准确，要么把好的代码也改坏了，还有就是问题
太多, 上下文超限修改失败</p>
<p><strong>举个真实的例子：</strong>
Sonar报告：<code>ActivityServiceImpl.java</code> 第120行存在空指针风险</p>
<p>我的提示词（第一版）：</p>
<pre><code class="hljs language-css" lang="css">请修复以下问题：第<span class="hljs-number">120</span>行存在空指针风险
代码：
<span class="hljs-selector-attr">[粘贴整个ActivityServiceImpl.java文件，可能是几千行]</span>
</code></pre>
<p>AI的回复：</p>
<ul>
<li>情况1："这个文件太长了，请提供更具体的代码片段"</li>
<li>情况2：修复了空指针，但把旁边的业务逻辑也改了</li>
<li>情况3："Token超出限制，无法处理"</li>
</ul>
<h3 data-id="heading-3">问题根源在哪？</h3>
<ol>
<li><strong>上下文冗余</strong>：超大文件代码中，真正相关的可能只有20行</li>
<li><strong>缺乏规范引导</strong>：没告诉AI要遵循什么编码规范</li>
<li><strong>信息不准确</strong>：没有精确指出问题在哪个方法、什么结构中</li>
<li><strong>没有示例</strong>：AI缺乏类似问题的修复参考</li>
</ol>
<h2 data-id="heading-4">二、转机：Cursor结合MCP打造自动化修复流程</h2>
<p>关键问题在于：<strong>如何将Sonar扫描结果转换为AI能高效理解的结构化提示词</strong>。</p>
<p>于是，我利用MCP（Model Context Protocol）协议为Cursor开发了一套智能提示词生成系统。</p>
<h3 data-id="heading-5">什么是MCP？</h3>
<p>MCP（Model Context Protocol）是一个开放协议，Cursor支持这个协议，允许我们通过Python等语言编写自定义工具，直接集成到Cursor的AI助手中。简单说就是：<strong>让AI拥有调用你自己编写的工具的能力</strong>。</p>
<h3 data-id="heading-6">我的方案架构</h3>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdb0e7f30b144b9db7dde7e0415c66d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349796&amp;x-signature=muUTZJGKL%2FsAHZewB9m0evKbyqU%3D" width="500" loading="lazy"/>
<h2 data-id="heading-7">三、核心方案：六步智能提示词生成法</h2>
<p>这套方案的核心思想是：<strong>让AI精确理解问题，而不是让AI去猜测问题</strong>。</p>
<p>整个系统基于以下6个步骤构建：</p>
<h4 data-id="heading-8">第一步：问题类型识别</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">IssueTypeClassifier</span>:
    <span class="hljs-string">"""将Sonar规则映射到问题类型"""</span>
    
    RULE_MAPPING = {
        <span class="hljs-comment"># 空指针问题</span>
        <span class="hljs-string">"java:S2259"</span>: <span class="hljs-string">"NullPointer"</span>,
        <span class="hljs-string">"java:S2637"</span>: <span class="hljs-string">"NullPointer"</span>,
        
        <span class="hljs-comment"># 资源泄露</span>
        <span class="hljs-string">"java:S2095"</span>: <span class="hljs-string">"ResourceLeak"</span>,
        <span class="hljs-string">"java:S2093"</span>: <span class="hljs-string">"ResourceLeak"</span>,
        
        <span class="hljs-comment"># 安全漏洞</span>
        <span class="hljs-string">"java:S3649"</span>: <span class="hljs-string">"SQLInjection"</span>,
        <span class="hljs-string">"java:S2076"</span>: <span class="hljs-string">"CommandInjection"</span>,
        
        <span class="hljs-comment"># 代码规范</span>
        <span class="hljs-string">"java:S117"</span>: <span class="hljs-string">"NamingConvention"</span>,
        <span class="hljs-string">"java:S1192"</span>: <span class="hljs-string">"DuplicateString"</span>,
    }
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">classify</span>(<span class="hljs-params">rule_key: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""根据规则ID分类问题类型"""</span>
        <span class="hljs-keyword">return</span> IssueTypeClassifier.RULE_MAPPING.get(
            rule_key, 
            <span class="hljs-string">"General"</span>
        )
</code></pre>
<h4 data-id="heading-9">第二步：AST代码结构解析</h4>
<p><strong>什么是AST？</strong></p>
<p>AST（Abstract Syntax Tree，抽象语法树）是将代码理解成树形结构的技术。</p>
<p>当Sonar告诉你"第120行有空指针问题"，我们需要知道：</p>
<ul>
<li>第120行在哪个<strong>方法</strong>里？</li>
<li>这个方法从哪行<strong>开始</strong>，到哪行<strong>结束</strong>？</li>
<li>方法的完整信息（方法名、参数、返回值）</li>
</ul>
<p><strong>AST解析 = 像编译器一样理解代码结构</strong></p>
<p>想象代码是一个家族，AST就是家谱树：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">ClassDeclaration:</span> <span class="hljs-string">ActivityServiceImpl（类）</span>
 <span class="hljs-string">│</span>
 <span class="hljs-string">├─</span> <span class="hljs-attr">FieldDeclaration:</span> <span class="hljs-string">activityFacadeHelper（成员变量）</span>
 <span class="hljs-string">│</span>
 <span class="hljs-string">├─</span> <span class="hljs-attr">MethodDeclaration:</span> <span class="hljs-string">queryActivityListWithNewImei（方法）</span>
 <span class="hljs-string">│</span>   <span class="hljs-string">├─</span> <span class="hljs-attr">position:</span> <span class="hljs-string">line</span> <span class="hljs-number">106</span>
 <span class="hljs-string">│</span>   <span class="hljs-string">├─</span> <span class="hljs-attr">parameters:</span> [<span class="hljs-string">Long</span> <span class="hljs-string">orderId</span>, <span class="hljs-string">String</span> <span class="hljs-string">newMachineUuid</span>]
 <span class="hljs-string">│</span>   <span class="hljs-string">├─</span> <span class="hljs-attr">return_type:</span> <span class="hljs-string">OrderAllowActivityMiVO</span>
 <span class="hljs-string">│</span>   <span class="hljs-string">└─</span> <span class="hljs-attr">body:</span> {<span class="hljs-string">...</span>}  <span class="hljs-string">←</span> <span class="hljs-string">第120行在这里</span>
 <span class="hljs-string">│</span>
 <span class="hljs-string">└─</span> <span class="hljs-attr">MethodDeclaration:</span> <span class="hljs-string">editActivityListWithNewImei（另一个方法）</span>
</code></pre>
<p><strong>使用javalang进行AST解析</strong></p>
<p>javalang是一个纯Python库，用Python重新实现了Java语法解析器，<strong>不需要安装Java环境</strong>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> javalang

<span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaCodeParser</span>:
    <span class="hljs-string">"""Java代码结构解析器 - 使用AST精确解析"""</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_method_context</span>(<span class="hljs-params">file_path: <span class="hljs-built_in">str</span>, line_number: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>]:
        <span class="hljs-string">"""使用javalang进行AST解析，精确定位方法"""</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
            code = f.read()
        
        <span class="hljs-comment"># 1. 解析Java代码，生成AST（语法树）</span>
        tree = javalang.parse.parse(code)
        
        <span class="hljs-comment"># 2. 遍历AST，查找包含目标行的方法节点</span>
        <span class="hljs-keyword">for</span> path, node <span class="hljs-keyword">in</span> tree.<span class="hljs-built_in">filter</span>(javalang.tree.MethodDeclaration):
            method_start = node.position.line
            method_end = calculate_method_end(node)  <span class="hljs-comment"># 计算方法结束位置</span>
            
            <span class="hljs-comment"># 3. 检查目标行是否在此方法范围内</span>
            <span class="hljs-keyword">if</span> method_start &lt;= line_number &lt;= method_end:
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-string">'class_name'</span>: extract_class_name(path),
                    <span class="hljs-string">'method_name'</span>: node.name,              <span class="hljs-comment"># 方法名</span>
                    <span class="hljs-string">'start_line'</span>: method_start,            <span class="hljs-comment"># 方法开始行</span>
                    <span class="hljs-string">'end_line'</span>: method_end,                <span class="hljs-comment"># 方法结束行</span>
                    <span class="hljs-string">'modifiers'</span>: node.modifiers,           <span class="hljs-comment"># ['public', 'static']</span>
                    <span class="hljs-string">'return_type'</span>: node.return_type.name,  <span class="hljs-comment"># 返回值类型</span>
                    <span class="hljs-string">'parameters'</span>: [p.name <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> node.parameters],  <span class="hljs-comment"># 参数列表</span>
                }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<p><strong>AST解析的价值</strong>：</p>
<ol>
<li><strong>精确定位</strong>：直接知道第120行在<code>queryActivityListWithNewImei</code>方法内，而不是<code>editActivityListWithNewIme</code>方法</li>
<li><strong>完整信息</strong>：获取方法名、参数类型、返回值等元信息</li>
<li><strong>语法理解</strong>：像编译器一样理解Java语法，不会被注释、字符串、Lambda表达式干扰</li>
<li><strong>高准确率</strong>：准确率可达99%+</li>
</ol>
<p><strong>javalang的特点</strong>：</p>
<ul>
<li>纯Python库，只需<code>pip install javalang</code></li>
<li>不需要安装JDK或Java环境</li>
<li>提供完整的Java语法树节点</li>
<li>支持Java 8+的语法特性</li>
</ul>
<h4 data-id="heading-10">第三步：智能上下文提取</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextExtractor</span>:
    <span class="hljs-string">"""根据问题类型智能提取代码上下文"""</span>
    
    <span class="hljs-comment"># 不同问题类型的提取策略配置</span>
    EXTRACTION_RULES = {
        <span class="hljs-string">"NullPointer"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"full_method"</span>,           <span class="hljs-comment"># 提取完整方法</span>
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">150</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">True</span>,           <span class="hljs-comment"># 包含import语句</span>
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">True</span>, <span class="hljs-comment"># 包含类声明</span>
        },
        <span class="hljs-string">"ResourceLeak"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"full_method"</span>,
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">100</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">True</span>,
        },
        <span class="hljs-string">"SQLInjection"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"full_method"</span>,
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">120</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">True</span>,
        },
        <span class="hljs-string">"NamingConvention"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"surrounding"</span>,            <span class="hljs-comment"># 只提取周围代码</span>
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">30</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">False</span>,
        },
        <span class="hljs-string">"General"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"surrounding"</span>,
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">50</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">False</span>,
        },
    }
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extract</span>(<span class="hljs-params">file_path: <span class="hljs-built_in">str</span>, line_number: <span class="hljs-built_in">int</span>, issue_type: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""智能提取代码上下文"""</span>
        rules = ContextExtractor.EXTRACTION_RULES.get(
            issue_type,
            ContextExtractor.EXTRACTION_RULES[<span class="hljs-string">"General"</span>]
        )
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
                lines = f.readlines()
            
            context_lines = []
            
            <span class="hljs-comment"># 1. 提取package和imports（如果需要）</span>
            <span class="hljs-keyword">if</span> rules.get(<span class="hljs-string">"include_imports"</span>):
                <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines[:<span class="hljs-number">50</span>]:
                    <span class="hljs-keyword">if</span> line.strip().startswith((<span class="hljs-string">'package '</span>, <span class="hljs-string">'import '</span>)):
                        context_lines.append(line)
                    <span class="hljs-keyword">elif</span> line.strip() <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> line.strip().startswith(<span class="hljs-string">'//'</span>):
                        <span class="hljs-keyword">break</span>
                <span class="hljs-keyword">if</span> context_lines:
                    context_lines.append(<span class="hljs-string">'\n'</span>)
            
            <span class="hljs-comment"># 2. 提取方法或周围代码</span>
            <span class="hljs-keyword">if</span> rules[<span class="hljs-string">"range"</span>] == <span class="hljs-string">"full_method"</span>:
                method_info = JavaCodeParser.extract_method_context(file_path, line_number)
                <span class="hljs-keyword">if</span> method_info:
                    start = method_info[<span class="hljs-string">'start_line'</span>] - <span class="hljs-number">1</span>
                    end = method_info[<span class="hljs-string">'end_line'</span>]
                    
                    <span class="hljs-comment"># 如果需要类声明，向上查找</span>
                    <span class="hljs-keyword">if</span> rules.get(<span class="hljs-string">"include_class_declaration"</span>):
                        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(start, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>):
                            <span class="hljs-keyword">if</span> <span class="hljs-string">'class '</span> <span class="hljs-keyword">in</span> lines[i]:
                                context_lines.append(lines[i])
                                context_lines.append(<span class="hljs-string">'    // ... 其他成员 ...\n\n'</span>)
                                <span class="hljs-keyword">break</span>
                    
                    context_lines.extend(lines[start:end])
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># 回退到周围代码</span>
                    start = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, line_number - <span class="hljs-number">25</span>)
                    end = <span class="hljs-built_in">min</span>(<span class="hljs-built_in">len</span>(lines), line_number + <span class="hljs-number">25</span>)
                    context_lines.extend(lines[start:end])
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 提取周围代码</span>
                max_lines = rules[<span class="hljs-string">"max_lines"</span>]
                start = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, line_number - max_lines // <span class="hljs-number">2</span>)
                end = <span class="hljs-built_in">min</span>(<span class="hljs-built_in">len</span>(lines), line_number + max_lines // <span class="hljs-number">2</span>)
                context_lines.extend(lines[start:end])
            
            <span class="hljs-comment"># 3. 限制总行数</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(context_lines) &gt; rules[<span class="hljs-string">"max_lines"</span>]:
                context_lines = context_lines[:rules[<span class="hljs-string">"max_lines"</span>]]
                context_lines.append(<span class="hljs-string">'\n// ... 后续代码省略 ...\n'</span>)
            
            <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>.join(context_lines)
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"提取失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"// 无法读取文件: <span class="hljs-subst">{file_path}</span>"</span>
</code></pre>
<p><strong>核心策略</strong>：</p>
<ul>
<li><strong>差异化提取</strong>：空指针问题提取150行含imports，命名规范只提取30行</li>
<li><strong>智能回退</strong>：AST解析失败时自动回退到简单提取</li>
<li><strong>Token控制</strong>：通过max_lines限制，避免上下文过长</li>
</ul>
<h4 data-id="heading-11">第四步：分层模板体系</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PromptTemplateEngine</span>:
    <span class="hljs-string">"""分层的提示词模板引擎"""</span>
    
    <span class="hljs-comment"># Java语言规范</span>
    JAVA_STANDARDS = <span class="hljs-string">"""
请遵循以下Java开发规范：
1. 遵循阿里巴巴Java开发手册的编码规范
2. 所有可能为null的参数必须进行防御性检查
3. 资源（文件流、数据库连接等）必须使用try-with-resources自动管理
4. 异常必须妥善处理，不得吞掉异常
5. 方法复杂度不得过高，保持代码可读性
6. 变量和方法命名要清晰、符合驼峰命名规范
"""</span>
    
    <span class="hljs-comment"># 问题类型特定模板</span>
    ISSUE_TEMPLATES = {
        <span class="hljs-string">"NullPointer"</span>: {
            <span class="hljs-string">"task"</span>: <span class="hljs-string">"修复以下代码中的空指针风险问题"</span>,
            <span class="hljs-string">"requirements"</span>: <span class="hljs-string">"""
修复要求：
1. 在方法开始处对可能为null的参数进行检查
2. 如果参数为null，抛出IllegalArgumentException异常，并提供清晰的错误信息
3. 保持原有业务逻辑不变
4. 不要修改方法签名
5. 确保修复后不影响其他正常调用
"""</span>
        },
        <span class="hljs-string">"ResourceLeak"</span>: {
            <span class="hljs-string">"task"</span>: <span class="hljs-string">"修复以下代码中的资源泄露问题"</span>,
            <span class="hljs-string">"requirements"</span>: <span class="hljs-string">"""
修复要求：
1. 使用try-with-resources语句包裹需要关闭的资源
2. 确保在任何情况下（正常或异常）资源都能正确释放
3. 保持原有异常处理方式
4. 保持方法签名不变
"""</span>
        },
        <span class="hljs-string">"SQLInjection"</span>: {
            <span class="hljs-string">"task"</span>: <span class="hljs-string">"修复以下代码中的SQL注入安全漏洞"</span>,
            <span class="hljs-string">"requirements"</span>: <span class="hljs-string">"""
修复要求：
1. 必须使用参数化查询（PreparedStatement）替代字符串拼接
2. 使用占位符（?）和参数绑定传递用户输入
3. 不得使用字符串拼接或格式化方式构建SQL语句
4. 保持查询逻辑不变
"""</span>
        },
    }
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">issue_type: <span class="hljs-built_in">str</span>, issue_data: <span class="hljs-built_in">dict</span>, code_context: <span class="hljs-built_in">str</span>, examples: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""生成最终提示词"""</span>
        
        template = PromptTemplateEngine.ISSUE_TEMPLATES.get(
            issue_type,
            {<span class="hljs-string">"task"</span>: <span class="hljs-string">"修复以下代码问题"</span>, <span class="hljs-string">"requirements"</span>: <span class="hljs-string">"保持代码风格与项目一致"</span>}
        )
        
        <span class="hljs-comment"># 组装提示词</span>
        prompt = <span class="hljs-string">f"""你是一位精通Java开发的资深工程师。

任务：<span class="hljs-subst">{template[<span class="hljs-string">'task'</span>]}</span>

编码规范：<span class="hljs-subst">{PromptTemplateEngine.JAVA_STANDARDS.strip()}</span>
"""</span>
        
        <span class="hljs-comment"># 添加示例（如果有）</span>
        <span class="hljs-keyword">if</span> examples:
            prompt += <span class="hljs-string">f"\n<span class="hljs-subst">{examples}</span>\n"</span>
        
        <span class="hljs-comment"># 添加问题详情</span>
        prompt += <span class="hljs-string">f"""
问题详情：
- 规则ID: <span class="hljs-subst">{issue_data.get(<span class="hljs-string">'rule'</span>, <span class="hljs-string">'Unknown'</span>)}</span>
- 问题类型: <span class="hljs-subst">{issue_type}</span>
- 严重级别: <span class="hljs-subst">{issue_data.get(<span class="hljs-string">'severity'</span>, <span class="hljs-string">'MAJOR'</span>)}</span>
- 问题描述: <span class="hljs-subst">{issue_data.get(<span class="hljs-string">'message'</span>, <span class="hljs-string">''</span>)}</span>
- 问题位置: 第<span class="hljs-subst">{issue_data.get(<span class="hljs-string">'line'</span>, <span class="hljs-number">0</span>)}</span>行

待修复代码：
```java
<span class="hljs-subst">{code_context}</span>
``` <span class="hljs-subst">{data-source-line=<span class="hljs-string">"360"</span>}</span>

<span class="hljs-subst">{template[<span class="hljs-string">'requirements'</span>].strip()}</span>

输出格式：
- 仅输出修复后的完整方法代码
- 使用```java```格式包裹代码
- 不要输出多余的解释文字
- 确保代码可以直接替换原有方法
"""</span>
        
        <span class="hljs-keyword">return</span> prompt
</code></pre>
<p><strong>模板设计</strong>：</p>
<ul>
<li><strong>三层结构</strong>：角色设定 + 编码规范 + 问题类型特定要求</li>
<li><strong>灵活扩展</strong>：新增问题类型只需添加模板配置</li>
<li><strong>规范注入</strong>：自动注入阿里巴巴Java开发手册规范</li>
</ul>
<h4 data-id="heading-12">第五步：Few-shot示例库</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleRepository</span>:
    <span class="hljs-string">"""问题修复示例库 - 提供修复前后的对比案例"""</span>
    
    EXAMPLES = {
        <span class="hljs-string">"NullPointer"</span>: <span class="hljs-string">"""
参考示例：

示例1 - 空指针防御性检查：
修复前：
```java
public String getUserEmail(User user) {
    return user.getEmail();
}
``` {data-source-line="395"}
修复后：
```java
public String getUserEmail(User user) {
    if (user == null) {
        throw new IllegalArgumentException("用户对象不能为空");
    }
    return user.getEmail();
}
``` {data-source-line="404"}

示例2 - 多参数空值检查：
修复前：
```java
public void processOrder(Order order, User user) {
    order.setUser(user);
    order.setStatus("processed");
}
``` {data-source-line="413"}
修复后：
```java
public void processOrder(Order order, User user) {
    if (order == null) {
        throw new IllegalArgumentException("订单对象不能为空");
    }
    if (user == null) {
        throw new IllegalArgumentException("用户对象不能为空");
    }
    order.setUser(user);
    order.setStatus("processed");
}
``` {data-source-line="426"}
"""</span>,
        <span class="hljs-string">"ResourceLeak"</span>: <span class="hljs-string">"""
参考示例：

示例 - 使用try-with-resources：
修复前：
```java
public String readFile(String path) throws IOException {
    FileInputStream fis = new FileInputStream(path);
    byte[] buffer = new byte[1024];
    int length = fis.read(buffer);
    return new String(buffer, 0, length);
}
``` {data-source-line="440"}
修复后：
```java
public String readFile(String path) throws IOException {
    try (FileInputStream fis = new FileInputStream(path)) {
        byte[] buffer = new byte[1024];
        int length = fis.read(buffer);
        return new String(buffer, 0, length);
    }
}
``` {data-source-line="450"}
"""</span>,
        <span class="hljs-string">"SQLInjection"</span>: <span class="hljs-string">"""
参考示例：

示例 - 使用PreparedStatement：
修复前：
```java
public User findUserByName(String name) {
    String sql = "SELECT * FROM users WHERE name = '" + name + "'";
    return jdbcTemplate.queryForObject(sql, User.class);
}
``` {data-source-line="462"}
修复后：
```java
public User findUserByName(String name) {
    String sql = "SELECT * FROM users WHERE name = ?";
    return jdbcTemplate.queryForObject(sql, User.class, name);
}
``` {data-source-line="469"}
"""</span>,
    }
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_examples</span>(<span class="hljs-params">issue_type: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""获取相关示例"""</span>
        <span class="hljs-keyword">return</span> ExampleRepository.EXAMPLES.get(issue_type, <span class="hljs-string">""</span>)
</code></pre>
<p><strong>示例库价值</strong>：</p>
<ul>
<li><strong>Few-shot学习</strong>：让AI通过案例学习修复模式</li>
<li><strong>格式统一</strong>：修复前/后对比，清晰明了</li>
<li><strong>易于扩展</strong>：新增示例只需添加字符串配置</li>
</ul>
<h4 data-id="heading-13">第六步：整合到MCP服务</h4>
<p>现在，将所有组件整合到MCP服务中：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp.server <span class="hljs-keyword">import</span> FastMCP
<span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> os

mcp = FastMCP(<span class="hljs-string">"intelligent-code-fix"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">IntelligentPromptGenerator</span>:
    <span class="hljs-string">"""智能提示词生成器 - 整合6步生成法的核心类"""</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_for_issue</span>(<span class="hljs-params">issue: <span class="hljs-built_in">dict</span>, base_dir: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">"""为单个issue生成智能提示词"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 1. 提取issue信息</span>
            rule_key = issue.get(<span class="hljs-string">'rule'</span>, <span class="hljs-string">''</span>)
            component = issue.get(<span class="hljs-string">'component'</span>, <span class="hljs-string">''</span>)
            file_path = component.split(<span class="hljs-string">':'</span>, <span class="hljs-number">1</span>)[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> <span class="hljs-string">':'</span> <span class="hljs-keyword">in</span> component <span class="hljs-keyword">else</span> component
            full_path = os.path.join(base_dir, file_path)
            line_number = issue.get(<span class="hljs-string">'line'</span>, <span class="hljs-number">0</span>)
            message = issue.get(<span class="hljs-string">'message'</span>, <span class="hljs-string">''</span>)
            severity = issue.get(<span class="hljs-string">'severity'</span>, <span class="hljs-string">'MAJOR'</span>)
            
            <span class="hljs-comment"># 2. 问题类型识别</span>
            issue_type = IssueTypeClassifier.classify(rule_key)
            
            logging.info(<span class="hljs-string">f"处理问题: <span class="hljs-subst">{file_path}</span>:<span class="hljs-subst">{line_number}</span> - <span class="hljs-subst">{issue_type}</span>"</span>)
            
            <span class="hljs-comment"># 3. 提取代码上下文</span>
            code_context = ContextExtractor.extract(full_path, line_number, issue_type)
            
            <span class="hljs-comment"># 4. 获取示例</span>
            examples = ExampleRepository.get_examples(issue_type)
            
            <span class="hljs-comment"># 5. 生成提示词</span>
            issue_data = {
                <span class="hljs-string">'rule'</span>: rule_key,
                <span class="hljs-string">'severity'</span>: severity,
                <span class="hljs-string">'message'</span>: message,
                <span class="hljs-string">'line'</span>: line_number,
            }
            
            prompt = PromptTemplateEngine.generate(
                issue_type=issue_type,
                issue_data=issue_data,
                code_context=code_context,
                examples=examples
            )
            
            <span class="hljs-comment"># 6. 计算元数据</span>
            token_estimate = <span class="hljs-built_in">len</span>(prompt) // <span class="hljs-number">4</span>  <span class="hljs-comment"># 粗略估算</span>
            
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'success'</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">'prompt'</span>: prompt,
                <span class="hljs-string">'metadata'</span>: {
                    <span class="hljs-string">'file'</span>: file_path,
                    <span class="hljs-string">'line'</span>: line_number,
                    <span class="hljs-string">'issue_type'</span>: issue_type,
                    <span class="hljs-string">'rule'</span>: rule_key,
                    <span class="hljs-string">'severity'</span>: severity,
                    <span class="hljs-string">'token_estimate'</span>: token_estimate,
                }
            }
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"生成提示词失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'success'</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">'error'</span>: <span class="hljs-built_in">str</span>(e),
                <span class="hljs-string">'file'</span>: file_path,
                <span class="hljs-string">'line'</span>: line_number,
            }

<span class="hljs-meta">@mcp.tool(<span class="hljs-params"><span class="hljs-string">"auto-fix-sonar-issues"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">auto_fix_sonar_issues</span>(<span class="hljs-params">
    project_name: <span class="hljs-built_in">str</span>,
    cookie: <span class="hljs-built_in">str</span>,
    base_dir: <span class="hljs-built_in">str</span>,
    branch: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span>,
    page_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>,
    page_num: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span>,
    is_new_code_period: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""智能修复Sonar扫描问题 - 核心MCP工具"""</span>
    
    <span class="hljs-comment"># 获取Sonar问题列表</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient() <span class="hljs-keyword">as</span> client:
        params = {
            <span class="hljs-string">"components"</span>: project_name,
            <span class="hljs-string">"ps"</span>: page_size,
            <span class="hljs-string">"p"</span>: page_num,
        }
        <span class="hljs-keyword">if</span> branch:
            params[<span class="hljs-string">"branch"</span>] = branch
        <span class="hljs-keyword">if</span> is_new_code_period:
            params[<span class="hljs-string">"inNewCodePeriod"</span>] = <span class="hljs-string">"true"</span>
        
        response = <span class="hljs-keyword">await</span> client.get(
            <span class="hljs-string">"https://sonar.zhuanspirit.com/api/issues/search"</span>,
            params=params,
            headers={<span class="hljs-string">"Cookie"</span>: cookie},
            timeout=<span class="hljs-number">10.0</span>
        )
        
        data = response.json()
        issues = data.get(<span class="hljs-string">'issues'</span>, [])
        total = data.get(<span class="hljs-string">'total'</span>, <span class="hljs-number">0</span>)
    
    <span class="hljs-comment"># 为每个issue生成智能提示词</span>
    results = []
    success_count = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">for</span> idx, issue <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(issues, <span class="hljs-number">1</span>):
        result = IntelligentPromptGenerator.generate_for_issue(issue, base_dir)
        
        <span class="hljs-keyword">if</span> result[<span class="hljs-string">'success'</span>]:
            success_count += <span class="hljs-number">1</span>
            metadata = result[<span class="hljs-string">'metadata'</span>]
            results.append(<span class="hljs-string">f"""
<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">80</span>}</span>
## Issue <span class="hljs-subst">{idx}</span>: <span class="hljs-subst">{metadata[<span class="hljs-string">'file'</span>]}</span> (第<span class="hljs-subst">{metadata[<span class="hljs-string">'line'</span>]}</span>行)

**问题类型**: <span class="hljs-subst">{metadata[<span class="hljs-string">'issue_type'</span>]}</span>  
**严重级别**: <span class="hljs-subst">{metadata[<span class="hljs-string">'severity'</span>]}</span>  
**预估Token**: <span class="hljs-subst">{metadata[<span class="hljs-string">'token_estimate'</span>]}</span>

### 生成的智能提示词：

<span class="hljs-subst">{result[<span class="hljs-string">'prompt'</span>]}</span>
<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">80</span>}</span>
"""</span>)
    
    <span class="hljs-comment"># 组装最终输出</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"""
# 智能代码修复提示词生成完成

## 统计信息
- **项目**: <span class="hljs-subst">{project_name}</span>
- **总问题数**: <span class="hljs-subst">{total}</span>
- **本批次**: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(issues)}</span> 个
- **成功生成**: <span class="hljs-subst">{success_count}</span> 个

## 智能提示词列表
<span class="hljs-subst">{<span class="hljs-string">""</span>.join(results)}</span>

---
由智能提示词生成引擎提供支持
"""</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    mcp.run(<span class="hljs-string">"stdio"</span>)
</code></pre>
<p><strong>整合要点</strong>：</p>
<ul>
<li><strong>错误处理</strong>：每个issue独立处理，单个失败不影响其他</li>
<li><strong>元数据追踪</strong>：记录文件、行号、问题类型、Token估算</li>
<li><strong>结构化输出</strong>：Markdown格式，便于Cursor展示</li>
</ul>
<h3 data-id="heading-14">安装依赖包</h3>
<p>在使用MCP服务之前，需要先安装必要的Python依赖包。创建<code>requirements.txt</code>文件：</p>
<pre><code class="hljs language-txt" lang="txt"># 智能代码修复MCP服务依赖包

# MCP框架 - 用于构建MCP服务
mcp&gt;=0.9.0

# HTTP客户端 - 用于调用Sonar API
httpx&gt;=0.27.0

# Java AST解析器 - 精确解析Java代码结构（强烈推荐）
# 优势：准确率99%+，不受注释、字符串、Lambda影响
# 注意：这是纯Python库，不需要Java环境
javalang&gt;=0.13.0
</code></pre>
<p>安装命令：</p>
<pre><code class="hljs language-bash" lang="bash">pip install -r requirements.txt
</code></pre>
<p><strong>依赖说明</strong>：</p>
<ul>
<li><strong>mcp</strong>：MCP协议框架，让Python脚本能够被Cursor识别和调用</li>
<li><strong>httpx</strong>：现代化HTTP客户端，用于调用Sonar API获取扫描结果</li>
<li><strong>javalang</strong>：纯Python的Java AST解析器，用于精准定位代码结构，无需安装Java环境</li>
</ul>
<h3 data-id="heading-15">配置MCP（让Cursor识别你的服务）</h3>
<p>%这里改成你本地的路径%
在 <code>~/.cursor/mcp.json</code> 中添加：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"intelligent-code-fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"/Users/Desktop/cursor/intelligent-code-fix.py"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>配置说明</strong>：</p>
<ul>
<li><code>intelligent-code-fix</code>：MCP服务名称，在Cursor中通过<code>@intelligent-code-fix</code>调用</li>
<li><code>command</code>: Python解释器命令</li>
<li><code>args</code>: Python脚本的绝对路径（请修改为你的实际路径）</li>
<li>修改配置后需要重启Cursor生效</li>
</ul>
<h2 data-id="heading-16">四、使用体验：在Cursor中一键修复</h2>
<h3 data-id="heading-17">配置好MCP后，在Cursor中的使用非常简单</h3>
<h4 data-id="heading-18">步骤1：在Cursor聊天窗口调用MCP工具</h4>
<pre><code class="hljs language-diff" lang="diff">使用 auto-fix-sonar-issues 工具修复Sonar问题

参数：

<span class="hljs-deletion">- project_name: hunter_partner_recycle_core</span>
<span class="hljs-deletion">- cookie: sso_uid=xxx; ticket=xxx; aid=xxx</span>
<span class="hljs-deletion">- base_dir: /Users/xxx/projects/hunter/src/main/java</span>
<span class="hljs-deletion">- branch: feature-3278-163 (可选)</span>
<span class="hljs-deletion">- page_size: 10</span>




</code></pre>
<h4 data-id="heading-19">步骤2：MCP服务自动处理</h4>
<p>系统自动完成：</p>
<ol>
<li>调用Sonar API获取问题列表</li>
<li>为每个问题智能生成提示词</li>
<li>返回结构化的修复建议</li>
</ol>
<h4 data-id="heading-20">步骤3：AI生成修复后的代码</h4>
<pre><code class="hljs language-ini" lang="ini">已生成10个问题的修复建议：

Issue 1: ActivityServiceImpl.java 空指针修复
修复后代码：
<span class="hljs-section">[完整的修复代码]</span>

Issue 2: FileUtil.java 资源泄露修复
修复后代码：
<span class="hljs-section">[完整的修复代码]</span>

</code></pre>
<h4 data-id="heading-21">步骤4：一键应用修复</h4>
<p>直接在Cursor中review并应用修复</p>
<h3 data-id="heading-22">改进效果：</h3>
<ol>
<li>成本降低70% ：精准提取上下文，token使用量大幅减少</li>
<li>准确率提升30%：结构化提示词+示例引导，AI理解更准确</li>
<li>效率提升3倍：自动化流程，无需人工干预</li>
<li>质量可控：分层模板确保代码符合团队规范</li>
<li>易于扩展：新增问题类型只需添加配置</li>
</ol>
<h2 data-id="heading-23">五、写在最后</h2>
<p>真正有效的AI辅助开发，不是简单地把代码扔给AI，而是要做好：</p>
<ul>
<li><strong>问题的精准识别</strong>：知道是什么类型的问题</li>
<li><strong>上下文的智能提取</strong>：给AI最相关的代码，而不是全部代码</li>
<li><strong>规范的有效注入</strong>：让AI知道要遵循什么标准</li>
<li><strong>经验的系统沉淀</strong>：用示例库让AI学习最佳实践</li>
</ul>
<p>这套方案不仅适用于Sonar，也可以推广到其他代码扫描工具（ESLint、Checkstyle等）。核心思想都是：<strong>将非结构化的扫描结果转换为结构化的AI提示词</strong>。</p>
<p>希望这篇文章能给大家带来启发。如果大家也在探索AI辅助开发，欢迎交流！</p>
<blockquote>
<p>关于作者，刘雅斌，侠客汇Java开发工程师。
想了解更多转转公司的业务实践，欢迎点击关注下方公众号</p>
</blockquote>
<blockquote>
<p>转转研发中心及业界小伙伴们的技术学习交流平台，定期分享一线的实战经验及业界前沿的技术话题。
关注公众号「转转技术」（综合性）、「大转转FE」（专注于FE）、「转转QA」（专注于QA），更多干货实践，欢迎交流分享~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React下拉框接口请求hook封装]]></title>    <link>https://juejin.cn/post/7587903505134895154</link>    <guid>https://juejin.cn/post/7587903505134895154</guid>    <pubDate>2025-12-26T07:35:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587903505134895154" data-draft-id="7587709130531831817" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React下拉框接口请求hook封装"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-26T07:35:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jolyne_"/> <meta itemprop="url" content="https://juejin.cn/user/339101640827981"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React下拉框接口请求hook封装
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339101640827981/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jolyne_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T07:35:15.000Z" title="Fri Dec 26 2025 07:35:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>记录一下公司 下拉框封装的 接口hook。主要是支持</p>
<ul>
<li>初始化或者指定状态下请求接口</li>
<li>防抖搜索</li>
<li>支持不同类型的接口（get、post）</li>
</ul>
<h2 data-id="heading-1">代码</h2>
<h3 data-id="heading-2">主体 hook</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IObj</span>, <span class="hljs-title class_">IOption</span>, <span class="hljs-title class_">TRecord</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils/interface"</span>;
<span class="hljs-keyword">import</span> { to } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils/tools"</span>;
<span class="hljs-keyword">import</span> { useMount } <span class="hljs-keyword">from</span> <span class="hljs-string">"@quarkunlimit/react-hooks"</span>;
<span class="hljs-keyword">import</span> { debounce } <span class="hljs-keyword">from</span> <span class="hljs-string">"lodash"</span>;
<span class="hljs-keyword">import</span> { useEffect, useRef, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">IUseMountFetchDataNewProps</span>,
  <span class="hljs-title class_">IUseMountFetchDataResult</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"./interface"</span>;

<span class="hljs-comment">/**
 * 初始化请求下拉框接口
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">props</span>
 * <span class="hljs-doctag">@returns</span>
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useSearchSelectFetchNew = (
  <span class="hljs-attr">props</span>: <span class="hljs-title class_">IUseMountFetchDataNewProps</span>
): <span class="hljs-function"><span class="hljs-params">IUseMountFetchDataResult</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> {
    fetchDataApi,
    request,
    searchParamKey,
    transformOptions,
    refreshFetch,
    initFetch = <span class="hljs-literal">true</span>,
    needSetExtarData = <span class="hljs-literal">false</span>,
  } = props;

  <span class="hljs-keyword">const</span> [data, setData] = useState&lt;<span class="hljs-title class_">IOption</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> isMount = useRef&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> originData = useRef&lt;<span class="hljs-title class_">IOption</span>[]&gt;([]);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">otherRequest?: TRecord</span>) =&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">newRequst</span>: <span class="hljs-title class_">IObj</span> = {}
    newRequst = {
        <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">size</span>: <span class="hljs-number">100</span>,
        ...request,
        ...otherRequest
    }
    <span class="hljs-keyword">const</span> [err, res] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(
      (<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchDataApi</span>(newRequst);
      })()
    );
    <span class="hljs-keyword">if</span> (!(err || !res)) {
      <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">transformOptions</span>(res);
      <span class="hljs-title function_">setData</span>(data);
      <span class="hljs-keyword">if</span> (!isMount.<span class="hljs-property">current</span>) {
        originData.<span class="hljs-property">current</span> = data;
        isMount.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
      }
    }
  };

  <span class="hljs-keyword">const</span> onSearch = <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (value.<span class="hljs-title function_">trim</span>()) {
      <span class="hljs-title function_">fetchData</span>({
        [searchParamKey]: value,
      });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">setData</span>(originData.<span class="hljs-property">current</span>);
    }
  }, <span class="hljs-number">500</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (refreshFetch) {
      <span class="hljs-title function_">fetchData</span>();
    }
  }, [refreshFetch]);

  <span class="hljs-title function_">useMount</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (initFetch) {
      <span class="hljs-title function_">fetchData</span>();
    }
  });

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">setExtarData</span> = (<span class="hljs-params">list: IOption[]</span>) =&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">newData</span>: <span class="hljs-title class_">IOption</span>[] = [];
    <span class="hljs-keyword">const</span> idSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> data) {
      newData.<span class="hljs-title function_">push</span>(item);
      idSet.<span class="hljs-title function_">add</span>(item.<span class="hljs-property">value</span>);
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> list) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> item !== <span class="hljs-string">"object"</span>) {
        <span class="hljs-keyword">continue</span>;
      }
      <span class="hljs-keyword">if</span> (idSet.<span class="hljs-title function_">has</span>(item?.<span class="hljs-property">value</span>)) {
        <span class="hljs-keyword">continue</span>;
      }
      idSet.<span class="hljs-title function_">add</span>(item.<span class="hljs-property">value</span>);
      newData.<span class="hljs-title function_">push</span>(item);
    }
    <span class="hljs-title function_">setData</span>(newData);
  };

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">options</span>: data,
    onSearch,
    <span class="hljs-attr">onFocus</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchData</span>(),
    ...(needSetExtarData ? { setExtarData } : {}),
  };
};

</code></pre>
<h3 data-id="heading-3">类型定义</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SelectProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IOption</span> {
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>;
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUseMountFetchDataNewProps</span> {
  <span class="hljs-comment">/**<span class="hljs-doctag">@param</span> 接口Api */</span>
  <span class="hljs-attr">fetchDataApi</span>: <span class="hljs-function">(<span class="hljs-params">...arg: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">IApiData</span>&gt;;
  <span class="hljs-comment">/**<span class="hljs-doctag">@param</span> 初始化时接口额外参数 */</span>
  request?: <span class="hljs-title class_">TRecord</span> &amp; { enableFlag?: <span class="hljs-built_in">boolean</span>; dataScopeEnableFlag?: <span class="hljs-built_in">boolean</span> };
  <span class="hljs-comment">/**<span class="hljs-doctag">@param</span> 搜索时的key */</span>
  <span class="hljs-attr">searchParamKey</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/**<span class="hljs-doctag">@function</span> 转换数据源为options */</span>
  <span class="hljs-attr">transformOptions</span>: <span class="hljs-function">(<span class="hljs-params">res: IApiData</span>) =&gt;</span> <span class="hljs-title class_">IOption</span>[];
  <span class="hljs-comment">/**<span class="hljs-doctag">@param</span> 满足某种条件时加载数据，使用时请将 initFetch 设置为 false  */</span>
  refreshFetch?: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">/**<span class="hljs-doctag">@param</span> 是否挂载时默认加载数据 */</span>
  initFetch?: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 是否需要setExtarData */</span>
  needSetExtarData?: <span class="hljs-built_in">boolean</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUseMountFetchDataResult</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SelectProps</span> {
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 下拉框选项 */</span>
  <span class="hljs-attr">options</span>: <span class="hljs-title class_">IOption</span>[];
  <span class="hljs-comment">/** <span class="hljs-doctag">@function</span> 下拉框搜索 */</span>
  <span class="hljs-attr">onSearch</span>: <span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">/** <span class="hljs-doctag">@function</span> 手动添加额外的数据源 */</span>
  setExtarData?: <span class="hljs-function">(<span class="hljs-params">list: IOption[]</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}
</code></pre>
<h2 data-id="heading-4">使用</h2>
<pre><code class="hljs language-tsx" lang="tsx">
<span class="hljs-comment">/** <span class="hljs-doctag">@function</span> 获取字典值集合 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">sys_dict_value</span> = (<span class="hljs-params">params?: IReqSysDictValueDictValue</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Service</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/api/business/v1/sys-dict-value/dict-value"</span>, {
    params,
  }) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">IResDetail</span>&lt;<span class="hljs-title class_">IResSysDictValueDictValue</span>[]&gt;&gt;;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IReqSysDictValueDictValue</span> {
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 字典编码 */</span>
  dictCode?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 字典编码集合 */</span>
  dictCodeList?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 字典名称 */</span>
  dictName?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 字典值 */</span>
  dictValue?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 备注 */</span>
  memo?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IResSysDictValueDictValue</span> {
  <span class="hljs-attr">dictCode</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">dictName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">dictValue</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">enableFlag</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">memo</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">color</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">sortNum</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">TXDiplomaRadio</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">TXDiplomaRadio_</span>(<span class="hljs-params">{
  initFetch = <span class="hljs-literal">true</span>,
  refreshFetch = <span class="hljs-literal">false</span>,
  extraReq = {},
  ...rest
}: ITXDiplomaRadioProps</span>) {
  <span class="hljs-keyword">const</span> { options } = <span class="hljs-title function_">useSearchSelectFetchNew</span>({
    <span class="hljs-attr">fetchDataApi</span>: sys_dict_value（你的接口，返回promise）,
    <span class="hljs-attr">request</span>: {
      <span class="hljs-attr">dictCode</span>: <span class="hljs-string">"diploma"</span>,
      ...extraReq,
    },
    initFetch,
    refreshFetch,
    <span class="hljs-attr">searchParamKey</span>: <span class="hljs-string">"dictName"</span>,
    <span class="hljs-attr">transformOptions</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> res?.<span class="hljs-property">data</span>?.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">x: IResSysDictValueDictValue</span>) =&gt;</span> ({
        <span class="hljs-attr">label</span>: x.<span class="hljs-property">dictName</span>,
        <span class="hljs-attr">value</span>: x.<span class="hljs-property">dictValue</span>,
      }));
    },
  });

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Radio.Group</span> <span class="hljs-attr">options</span>=<span class="hljs-string">{options}</span> {<span class="hljs-attr">...rest</span>} /&gt;</span></span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TXDiplomaRadio</span>;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用Java Stream，将集合转换为一对一Map]]></title>    <link>https://juejin.cn/post/7587684397531021339</link>    <guid>https://juejin.cn/post/7587684397531021339</guid>    <pubDate>2025-12-26T03:26:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587684397531021339" data-draft-id="7587715742051139594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用Java Stream，将集合转换为一对一Map"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-26T03:26:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申城异乡人"/> <meta itemprop="url" content="https://juejin.cn/user/3245414056985831"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用Java Stream，将集合转换为一对一Map
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3245414056985831/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申城异乡人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:26:34.000Z" title="Fri Dec 26 2025 03:26:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常的开发工作中，我们经常使用到Java Stream，特别是Stream API中提供的<code>Collectors.toList()</code>收集器，</p>
<p>但有些场景下，我们需要将集合转换为Map，这时候就需要使用到Stream API中提供的另一个收集器：</p>
<p><code>Collectors.toMap</code>，它可以将流中的元素映射为键值对，并收集到一个Map中。</p>
<h2 data-id="heading-0">1. 三种主要的重载方法</h2>
<p><code>Collectors.toMap</code>有3种重载方法，分别是：</p>
<p>1)<strong>两个参数的重载方法（最简单的形式）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T, K, U&gt; Collector&lt;T, ?, Map&lt;K,U&gt;&gt; toMap(Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">K</span>&gt; keyMapper,
                                Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">U</span>&gt; valueMapper) {
	<span class="hljs-keyword">return</span> toMap(keyMapper, valueMapper, throwingMerger(), HashMap::<span class="hljs-keyword">new</span>);
}
</code></pre>
<p>2)<strong>三个参数的重载方法（包含冲突处理）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T, K, U&gt; Collector&lt;T, ?, Map&lt;K,U&gt;&gt; toMap(Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">K</span>&gt; keyMapper,
                                Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">U</span>&gt; valueMapper,
                                BinaryOperator&lt;U&gt; mergeFunction) {
    <span class="hljs-keyword">return</span> toMap(keyMapper, valueMapper, mergeFunction, HashMap::<span class="hljs-keyword">new</span>);
}
</code></pre>
<p>3)<strong>四个参数的重载方法（指定Map实现）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T, K, U, M <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Map</span>&lt;K, U&gt;&gt;
   Collector&lt;T, ?, M&gt; toMap(Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">K</span>&gt; keyMapper,
                            Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">U</span>&gt; valueMapper,
                            BinaryOperator&lt;U&gt; mergeFunction,
                            Supplier&lt;M&gt; mapSupplier) {
    BiConsumer&lt;M, T&gt; accumulator
            = (map, element) -&gt; map.merge(keyMapper.apply(element),
                                          valueMapper.apply(element), mergeFunction);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CollectorImpl</span>&lt;&gt;(mapSupplier, accumulator, mapMerger(mergeFunction), CH_ID);
}
</code></pre>
<p>接下来，我们结合使用示例详细讲解。</p>
<h2 data-id="heading-1">2. 使用示例</h2>
<h3 data-id="heading-2">2.1 将对象的某些属性转换为Map</h3>
<p>假设有一个城市列表，需要将其转换为Map，其中Key为城市ID、Value为城市名称，转换方法如下所示：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Getter</span>
<span class="hljs-meta">@Setter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">City</span> {
    <span class="hljs-keyword">private</span> Integer cityId;

    <span class="hljs-keyword">private</span> String cityName;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">City</span><span class="hljs-params">(Integer cityId, String cityName)</span> {
        <span class="hljs-built_in">this</span>.cityId = cityId;
        <span class="hljs-built_in">this</span>.cityName = cityName;
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
System.out.println(cityMap);
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>{1=北京, 2=上海, 3=广州, 4=深圳}</p>
</blockquote>
<h3 data-id="heading-3">2.2 将对象列表转换为Map（ID -&gt; 对象）</h3>
<p>仍然使用上面的城市列表，需要将其转换为Map，其中Key为城市ID、Value为城市对象，转换方法如下所示：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>)
);
Map&lt;Integer, City&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, city -&gt; city));
<span class="hljs-type">City</span> <span class="hljs-variable">city</span> <span class="hljs-operator">=</span> cityMap.get(<span class="hljs-number">1</span>);
System.out.println(<span class="hljs-string">"城市ID: "</span> + city.getCityId());
System.out.println(<span class="hljs-string">"城市名称: "</span> + city.getCityName());
</code></pre>
<p>输出结果如下所示：</p>
<blockquote>
<p>城市ID: 1
城市名称: 北京</p>
</blockquote>
<p>上面的写法等价于：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, City&gt; cityMap = cityList.stream()
    	.collect(Collectors.toMap(City::getCityId, Function.identity()));
</code></pre>
<p>因为<code>Function.identity()</code>内部实现是下面这样的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> &lt;T&gt; Function&lt;T, T&gt; <span class="hljs-title function_">identity</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> t -&gt; t;
}
</code></pre>
<h3 data-id="heading-4">2.3 键冲突处理</h3>
<p>假设上面的城市列表中有一个ID重复的城市：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"天津"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
System.out.println(<span class="hljs-string">"城市ID: 4, 城市名称: "</span> + cityMap.get(<span class="hljs-number">4</span>));
</code></pre>
<p>此时运行代码，会抛出<code>java.lang.IllegalStateException</code>异常，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad5bff41cf40443994c502a37403892c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz5Z-O5byC5Lmh5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324394&amp;x-signature=HucqYoD9JvlfNzJv%2FQ7VkGxLxRY%3D" alt="" loading="lazy"/></p>
<p>有3种常见的键冲突处理方式，分别是保留旧值、使用新值和合并值，接下来一一讲解。</p>
<p>1)方式一：保留旧值</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName, (oldValue, newValue) -&gt; oldValue));
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>城市ID: 4, 城市名称: 深圳</p>
</blockquote>
<p>2)方式二：使用新值</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName, (oldValue, newValue) -&gt; newValue));
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>城市ID: 4, 城市名称: 天津</p>
</blockquote>
<p>3)方式三：合并值</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName, 
        		(oldValue, newValue) -&gt; oldValue + <span class="hljs-string">", "</span> + newValue));
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>城市ID: 4, 城市名称: 深圳, 天津</p>
</blockquote>
<h3 data-id="heading-5">2.4 数据分组聚合</h3>
<p>假设有一个销售记录列表，需要将其转换为Map，其中Key为销售员、Value为该销售员的总销售额，转换方法如下所示：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Getter</span>
<span class="hljs-meta">@Setter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SalesRecord</span> {
    <span class="hljs-keyword">private</span> String salesPerson;

    <span class="hljs-keyword">private</span> BigDecimal amount;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SalesRecord</span><span class="hljs-params">(String salesPerson, BigDecimal amount)</span> {
        <span class="hljs-built_in">this</span>.salesPerson = salesPerson;
        <span class="hljs-built_in">this</span>.amount = amount;
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java">List&lt;SalesRecord&gt; salesRecordList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SalesRecord</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1000"</span>)),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SalesRecord</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"2000"</span>)),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SalesRecord</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"980"</span>))
);

Map&lt;String, BigDecimal&gt; salesRecordMap = salesRecordList.stream()
        .collect(Collectors.toMap(SalesRecord::getSalesPerson, SalesRecord::getAmount, BigDecimal::add));
System.out.println(salesRecordMap);
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>{李四=2000, 张三=1980}</p>
</blockquote>
<p>上面的例子是销售额累加，也可以只取最小值：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;String, BigDecimal&gt; salesRecordMap = salesRecordList.stream()
        .collect(Collectors.toMap(SalesRecord::getSalesPerson, SalesRecord::getAmount, BigDecimal::min));
</code></pre>
<p>此时的输出结果：</p>
<blockquote>
<p>{李四=2000, 张三=980}</p>
</blockquote>
<p>或者只取最大值：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;String, BigDecimal&gt; salesRecordMap = salesRecordList.stream()
        .collect(Collectors.toMap(SalesRecord::getSalesPerson, SalesRecord::getAmount, BigDecimal::max));
</code></pre>
<p>此时的输出结果：</p>
<blockquote>
<p>{李四=2000, 张三=1000}</p>
</blockquote>
<h3 data-id="heading-6">2.5 指定Map实现</h3>
<p>默认情况下，<code>Collectors.toMap</code>是将结果收集到HashMap中，如果有需要，我们也可以指定成TreeMap或者LinkedHashMap。</p>
<p>如果想要保持插入顺序，可以指定使用LinkedHashMap：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName,
                (existing, replacement) -&gt; existing, LinkedHashMap::<span class="hljs-keyword">new</span>));
System.out.println(cityMap);
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>{2=上海, 1=北京, 4=深圳, 3=广州}</p>
</blockquote>
<p>如果想要按键排序，可以指定使用TreeMap：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName,
                (existing, replacement) -&gt; existing, TreeMap::<span class="hljs-keyword">new</span>));
System.out.println(cityMap);
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>{1=北京, 2=上海, 3=广州, 4=深圳}</p>
</blockquote>
<h2 data-id="heading-7">3. 注意事项</h2>
<h3 data-id="heading-8">3.1 空异常</h3>
<p>如果valueMapper中取出的值有null值，会抛出<code>java.lang.NullPointerException</code>异常，如下示例：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">5</span>, <span class="hljs-literal">null</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
System.out.println(cityMap);
</code></pre>
<p>运行以上代码会抛出异常，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d288447108164d26985edd91c27e430a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz5Z-O5byC5Lmh5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324394&amp;x-signature=lP0nkReM4pnGZp6WqyEI2Kyufs0%3D" alt="" loading="lazy"/></p>
<p>有两种解决方案，第一种解决方案是过滤null值：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .filter(city -&gt; city.getCityName() != <span class="hljs-literal">null</span>)
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
</code></pre>
<p>第二种解决方案是提供默认值：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId,
                city -&gt; Optional.ofNullable(city.getCityName()).orElse(<span class="hljs-string">"未知"</span>)));
</code></pre>
<h3 data-id="heading-9">3.2 键重复异常</h3>
<p>如果出现重复键，且没有提供mergeFunction参数，会抛出<code>java.lang.IllegalStateException</code>异常，如下示例：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"天津"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
System.out.println(cityMap);
</code></pre>
<p>运行以上代码会抛出异常，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80f904404b9744e8a1379f64a65540fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz5Z-O5byC5Lmh5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324394&amp;x-signature=ZFH7K4V%2BTqNshyn32SOOiRBYDUc%3D" alt="" loading="lazy"/></p>
<p>解决方案见本篇文章<strong>2.3 键冲突处理</strong>部分。</p>
<h2 data-id="heading-10">4. 总结</h2>
<p><code>Collectors.toMap</code>是Stream API中提供的一个非常方便的收集器，它可以将流中的元素映射为键值对，并收集到一个Map中。</p>
<p>它适用于一对一映射的场景，但在使用时，要注意避免<code>java.lang.NullPointerException</code>异常和</p>
<p><code>java.lang.IllegalStateException</code>异常。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【日常知识积累】Kotlin let 函数、inline 函数以及 DSL]]></title>    <link>https://juejin.cn/post/7588146449005101092</link>    <guid>https://juejin.cn/post/7588146449005101092</guid>    <pubDate>2025-12-27T08:08:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588146449005101092" data-draft-id="7587630413012680714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【日常知识积累】Kotlin let 函数、inline 函数以及 DSL"/> <meta itemprop="keywords" content="Kotlin,编程语言,Android"/> <meta itemprop="datePublished" content="2025-12-27T08:08:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lei_official"/> <meta itemprop="url" content="https://juejin.cn/user/2351234021066314"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【日常知识积累】Kotlin let 函数、inline 函数以及 DSL
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2351234021066314/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lei_official
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T08:08:30.000Z" title="Sat Dec 27 2025 08:08:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>凡事有交代 —— 接到任务时，主动明确任务目标、背景、利益相关方、交付物、时间节点。<br/>件件有着落 —— 执行任务过程中，在里程碑节点及时同步，做好预期管理。<br/>事事有回音 —— 任务完成后，有复盘，有汇报，有总结。</p>
</blockquote>
<p>这篇文章记录了近期积累的一些零散知识点，临近元旦、春节，这个时期是一年里工作相对轻松的阶段，同时也是复盘总结过去一年的经验、以及做好明年目标规划的关键节点。<strong>利用好，别虚度</strong>。</p>
<h2 data-id="heading-0">你真的需要使用 let 函数吗？</h2>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d392b67f326648ed9a651e8b1f2addc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427710&amp;x-signature=KRUvnLcCqA%2F33q2JkVaq1FnNvrE%3D" alt="image.png" width="50%" loading="lazy"/>
<p>在 Kotlin 中，<code>let</code>、<code>apply</code>、<code>also</code>、<code>run</code> 等等函数，是降低代码行数、提升可读性的利器，然而它们并不是万能的，如果使用不当，会带来相反的效果。</p>
<h3 data-id="heading-1">let 的一般用法</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 如果元素非空，则对其进行绘制</span>
element?.let { render(it) }

<span class="hljs-comment">// 非 let 写法</span>
<span class="hljs-keyword">if</span> (element != <span class="hljs-literal">null</span>) {
	render(element)
}
</code></pre>
<p>可以看到，<code>let</code> 函数将3行代码精简成为1行，精简了 66% 的代码。它适用于以下场景：</p>
<ul>
<li>单次调用该对象</li>
<li>lambda 行数很少</li>
<li>没有后续依赖</li>
</ul>
<p>与之相反的条件，就是不适用于 let 的场景。</p>
<h3 data-id="heading-2">let 不适用的场景</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 灾难现场1：行数多、有后续依赖</span>
element?.let { e -&gt;
    config?.let { c -&gt;
        adapter?.let { a -&gt;
            renderer?.let { r -&gt;
                r.render(e, c, a)
            }
        }
    }
}

<span class="hljs-comment">// 灾难现场2：超过1行使用 let 对象</span>
element?.let {
    doSomething(it)
    doAnotherThing(it)
    doMore(it)
}
</code></pre>
<p>以上已经是 Kotlin 的反模式了，这样的代码不断<code>向右偏移（rightward drift）</code>，<strong>难读并且难改</strong>，在进行 Code Review 时一定要识别出来。</p>
<h3 data-id="heading-3">替代方案 return fast</h3>
<p>在函数的开头，检查变量条件，如果不符合立刻 return，可以在需要的位置增加日志打印，以便追溯问题。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateView</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> e = element ?: <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">val</span> c = config ?: <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">val</span> a = adapter ?: <span class="hljs-keyword">return</span>

    render(e, c, a)
}
</code></pre>
<p><strong>为什么这是好代码？</strong></p>
<ul>
<li>没有嵌套</li>
<li>控制流清晰</li>
<li>可调试（每一行都能打断点）</li>
<li>非常符合 “fail fast” 原则</li>
</ul>
<p>更进一步，如果 e、c、a 这三个对象经常一起判空，可以将它们本质上是一个状态，推荐对它们进行状态聚合，有利于长期使用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 状态聚合</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RenderState</span>(
    <span class="hljs-keyword">val</span> element: Element,
    <span class="hljs-keyword">val</span> config: Config,
    <span class="hljs-keyword">val</span> adapter: Adapter
)

<span class="hljs-comment">// 只有一个变量</span>
<span class="hljs-keyword">val</span> state: RenderState? = ...

<span class="hljs-comment">// 使用时判断该变量</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateView</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> s = state ?: <span class="hljs-keyword">return</span>
    render(s)
}
</code></pre>
<p>此外，如果发现，代码里多处进行判空操作，则可以利用 DSL，将判空操作提取出 <code>withReadyElement</code> 函数，</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 提取 inline 函数，集中进行可空性处理</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">withReadyElement</span><span class="hljs-params">(block: (<span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> e = element ?: <span class="hljs-keyword">return</span>
    block(e)
}

<span class="hljs-comment">// 调用点更加美观干净</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateView</span><span class="hljs-params">()</span></span> {
    withReadyElement {
        render(it)
    }
}
</code></pre>
<h2 data-id="heading-4">inline fun 用于消除 Lambda 对象额外开销</h2>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a21849cdca94449b6a88f2f36420c77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427710&amp;x-signature=knoT7IVA8H0X%2BSNR%2BClpTdCKsCo%3D" alt="image.png" width="70%" loading="lazy"/>
<p><code>inline fun</code> 是“为 Lambda 买单的工具”，<strong>用于消除 Lambda 参数引起的对象创建&amp;间接调用开销</strong>，同样地，它也不是“银弹”，如果使用不当，反而会引起性能下降。</p>
<h3 data-id="heading-5">普通 Lambda 函数与 inline Lambda 函数</h3>
<p><strong>普通 Lambda 函数</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doSomething</span><span class="hljs-params">(block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    block()
}
</code></pre>
<p>系统在编译这段代码时，实际上发生了：</p>
<ul>
<li>创建一个 <code>Function0</code> 对象（表示0个参数、即无参函数）</li>
<li>捕获外部变量，生成闭包</li>
<li>通过 <code>invoke()</code> 间接调用</li>
</ul>
<p>例如，我们调用 <code>doSomething { println("hello") }</code> 后，编译器实际上创建了一个类，并调用其 <code>invoke</code> 函数。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DoSomething$1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Function0</span>&lt;Unit&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Unit <span class="hljs-title function_">invoke</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"hello"</span>)
        <span class="hljs-keyword">return</span> Unit.INSTANCE;
    }
}
</code></pre>
<p><strong>inline Lambda 函数</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doSomething</span><span class="hljs-params">(block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    block()
}

<span class="hljs-comment">// 编译后直接展开</span>
println(<span class="hljs-string">"hello"</span>)
</code></pre>
<h3 data-id="heading-6">标准库的 inline 用法</h3>
<p>在 Kotlin 标准库里，这些函数都是 inline 实现</p>
<ul>
<li><code>let</code></li>
<li><code>apply</code></li>
<li><code>run</code></li>
<li><code>with</code></li>
<li><code>use</code></li>
<li><code>synchronized</code></li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T.<span class="hljs-title">apply</span><span class="hljs-params">(block: <span class="hljs-type">T</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: T
</code></pre>
<h3 data-id="heading-7">inline 的负面作用</h3>
<p>由于 inline 本质上采用了 <code>复制-粘贴</code> 的模式，因此它会在每个调用点复制一份函数代码，这会造成 <code>APK / DEX 膨胀</code>，对 Android 来说，更会引起 <strong>方法数增加，甚至突破 64K 限制</strong>。</p>
<h3 data-id="heading-8">inline 的应用场景</h3>
<ul>
<li>参数是 <code>lambda</code> 类型</li>
<li><code>lambda</code> 非常短</li>
<li>该函数 90% 以上是 lambda 调用</li>
<li>应用在循环 / UI / 热路径中</li>
<li>inline 收益 &gt; 代码膨胀成本</li>
</ul>
<h2 data-id="heading-9">DSL，把握好“提升可读性”与“滥用”之间的界限</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f6f805ff7004862a181894f89e18a2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427710&amp;x-signature=s7yDmw0ziEFA4oiyoqcuzxdSf%2Fc%3D" alt="image.png" loading="lazy"/></p>
<p><code>DSL（Domain-Specific Language，领域特定语言）</code>，是一种 <strong>只为某个特定领域服务</strong> 的语言，目标不是“什么都能干”，而是把这个领域的表达做到最清晰、最省心、最不容易写错。</p>
<p>如何理解“领域”呢？在我看来，“领域”是指特定的场景、语境、上下文，它具有一定的重复性，因此通过提炼总结 DSL，能够降低重复使用的成本。“领域”可以是技术上的，也可以是业务场景里的。</p>
<h3 data-id="heading-10">GPL 与 DSL</h3>
<p>与 DSL 相对的概念，是 <strong>通用语言（GPL）</strong>，Java / Kotlin / C++ 都属于此类，它们功能强大且全面，但随之而来的，是写法严谨甚至冗长，无法做到针对特定场景（领域）进行简化。</p>
<p>DSL 则专注于解决一个特定领域的问题，为此进行了特定优化，短、平、快、准。</p>
<p>GPL、DSL 都可以解决问题，重点在于选择使用哪一个。</p>
<h3 data-id="heading-11">DSL 的两大类型：外部 DSL</h3>
<p>外部 DSL 具备 <strong>独立的语法和解析器</strong> ，更像一门新的编程语言，因此其表达能力很强。同时，由于依赖于特定解析器，故定制成本高。</p>
<p>常见的外部 DSL 有：</p>
<ul>
<li>SQL</li>
<li>正则表达式</li>
<li>Gradle Groovy/Kotlin DSL（build.gradle）</li>
<li>HTML / CSS</li>
</ul>
<h3 data-id="heading-12">DSL 的两大类型：内部 DSL</h3>
<p>内部 DSL 在 Kotlin 语言中是非常常见的，例如前文的 <code>let</code>、<code>apply</code>、<code>also</code> 等均属于此类。可以通过 Kotlin 语法特性，使代码“看起来像新的语言”。Kotlin 的标准库中，有很多 API 本身就是 DSL。举两个常见的例子：</p>
<p><strong>例1，Lambda with Receiver</strong></p>
<p>定义 <code>user</code> DSL，代替 <code>set</code> 函数。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 Lambda，域内对象为 User</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">user</span><span class="hljs-params">(block: <span class="hljs-type">User</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> u = User()
    u.block()
}

<span class="hljs-comment">// 使用 DSL</span>
user {
	name = <span class="hljs-string">"Lei"</span>
}

<span class="hljs-comment">// 不使用 DSL</span>
user.setName(<span class="hljs-string">"Lei"</span>)
</code></pre>
<p><strong>例2， infix 函数</strong></p>
<p>可以提升可读性，例如定义二元运算符 <code>eq</code>，比较 String 对象：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 声明 DSL</span>
<span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">eq</span><span class="hljs-params">(value: <span class="hljs-type">String</span>)</span></span>

<span class="hljs-comment">// 使用 DSL</span>
<span class="hljs-string">"status"</span> eq <span class="hljs-string">"success"</span>
</code></pre>
<blockquote>
<p>Gradle Kotlin、Jetpack Compose、HTML 都是典型的 DSL，UI结构=代码结构，起到“看代码知UI”的作用。</p>
</blockquote>
<h3 data-id="heading-13">DSL 不是炫技工具，而是把业务规则提取为代码的手段</h3>













<table><thead><tr><th>值得设计 DSL</th><th>不该用DSL</th></tr></thead><tbody><tr><td>✅是不是反复写相同结构？<br/>✅业务规则是否固定？<br/>✅现在的代码是否“看不出业务语义”？<br/>✅错误是不是经常发生在“用法不对”？</td><td>❌一次性逻辑<br/>❌需求不稳定<br/>❌团队 Kotlin 水平参差<br/>❌DSL 设计者不在一线维护</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[shadcn-ui 的 Radix Dialog 这两个警告到底在说什么？为什么会报？怎么修？]]></title>    <link>https://juejin.cn/post/7587998744294047750</link>    <guid>https://juejin.cn/post/7587998744294047750</guid>    <pubDate>2025-12-26T08:44:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587998744294047750" data-draft-id="7587825267879182377" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="shadcn-ui 的 Radix Dialog 这两个警告到底在说什么？为什么会报？怎么修？"/> <meta itemprop="keywords" content="前端,WeUI,React.js"/> <meta itemprop="datePublished" content="2025-12-26T08:44:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨夜寻晴天"/> <meta itemprop="url" content="https://juejin.cn/user/1943592288391496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            shadcn-ui 的 Radix Dialog 这两个警告到底在说什么？为什么会报？怎么修？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592288391496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨夜寻晴天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T08:44:52.000Z" title="Fri Dec 26 2025 08:44:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,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) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,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) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题</h2>
<p>最近在项目里遇到两个来自 Radix Dialog 的控制台提示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e5a30b959ff477987d91cbb78c449e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5aSc5a-75pm05aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767343491&amp;x-signature=d1n2YG8uQeurasELGsmVhqqQi6k%3D" alt="image.png" loading="lazy"/></p>
<p>它们不是 “功能错误”，但属于 <strong>无障碍（a11y）级别的警告</strong>：Radix 在开发环境主动提醒你对话框缺少 “可被屏幕阅读器正确理解” 的关键语义。</p>
<p>本文基于 coco-app（React 18 + TS + Tailwind + shadcn-ui）里真实踩坑的修复过程总结。</p>
<hr/>
<h2 data-id="heading-1">1. 背景：Radix Dialog 需要什么语义？</h2>
<p>一个可访问的 Dialog 至少需要：</p>
<ul>
<li><strong>可访问名称（accessible name）</strong>：告诉读屏软件 “这个弹窗叫啥”
<ul>
<li>对应：<code>&lt;DialogTitle /&gt;</code>（内部映射到 <code>aria-labelledby</code>）</li>
</ul>
</li>
<li><strong>可访问描述（accessible description）</strong>：告诉读屏软件 “这个弹窗在说啥/要用户做啥”
<ul>
<li>对应：<code>&lt;DialogDescription /&gt;</code>（内部映射到 <code>aria-describedby</code>）</li>
</ul>
</li>
</ul>
<p>Radix 的示例结构也是这个顺序（Title + Description + 内容 + Close 等）。</p>
<hr/>
<h2 data-id="heading-2">2. 报错 1：为什么必须要 <code>DialogTitle</code>？</h2>
<h3 data-id="heading-3">2.1 报错含义</h3>
<blockquote>
<p><code>DialogContent requires a DialogTitle...</code></p>
</blockquote>
<p>意思是：你的 <code>&lt;DialogContent /&gt;</code> 里没有提供标题，导致 Dialog 没有可访问名称。读屏用户打开弹窗时，不知道这是 “更新提示” 还是 “删除确认”。</p>
<h3 data-id="heading-4">2.2 coco-app 的修复方式</h3>
<p>我们在 <code>UpdateApp</code> 弹窗中增加了一个 “对视觉隐藏、对读屏可见” 的标题：</p>
<ul>
<li>文件：<code>src/components/UpdateApp/index.tsx:164</code></li>
<li>代码形态：</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">DialogTitle</span> className=<span class="hljs-string">"sr-only"</span>&gt;{<span class="hljs-title function_">t</span>(<span class="hljs-string">"update.title"</span>)}&lt;/<span class="hljs-title class_">DialogTitle</span>&gt;
</code></pre>
<p>为什么用 <code>sr-only</code>？</p>
<ul>
<li>Tailwind 的 <code>sr-only</code> 能达到<strong>UI 不变，读屏可读</strong>的效果（有些 shadcn 模板会有现成的 <code>VisuallyHidden</code> 组件）。</li>
</ul>
<hr/>
<h2 data-id="heading-5">3. 报错 2：为什么必须要 <code>DialogDescription</code> / <code>aria-describedby</code>？</h2>
<h3 data-id="heading-6">3.1 报错含义</h3>
<blockquote>
<p><code>Warning: Missing Description or aria-describedby={undefined} for {DialogContent}.</code></p>
</blockquote>
<p>意思是：Dialog 没有可访问描述，或者你显式把 <code>aria-describedby</code> 置为 <code>undefined</code> 但又没有描述节点关联上。</p>
<p>Radix 的逻辑大致是：</p>
<ul>
<li>你提供 <code>&lt;DialogDescription /&gt;</code>：Radix 自动把它的 id 绑定到 <code>aria-describedby</code></li>
<li>你不提供 <code>&lt;DialogDescription /&gt;</code>：Radix 会提醒你 “缺描述”，避免读屏用户只听到标题但不知道要做什么</li>
</ul>
<h3 data-id="heading-7">3.2 coco-app 的修复方式</h3>
<p>我们把原先展示更新说明的 <code>div</code> 替换为 <code>DialogDescription</code>（UI class 不变，只换组件语义）：</p>
<ul>
<li>文件：<code>src/components/UpdateApp/index.tsx:179-193</code></li>
<li>代码形态：</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">DialogDescription</span> className=<span class="hljs-string">"text-sm leading-5 py-2 text-foreground text-center"</span>&gt;
  {updateInfo ? ... : <span class="hljs-title function_">t</span>(<span class="hljs-string">"update.date"</span>)}
&lt;/<span class="hljs-title class_">DialogDescription</span>&gt;
</code></pre>
<p>这样 Radix 就能自动生成正确的 <code>aria-describedby</code>，warning 消失。</p>
<hr/>
<h2 data-id="heading-8">4. “洁癖”：它不是 bug，但是就是在控制台报红了...</h2>
<p>shadcn-ui 的 <code>Dialog</code> 本质是对 Radix Dialog 的一层轻封装（项目里对应 <code>src/components/ui/dialog.tsx</code>），它不会强制你必须写 Title/Description。</p>
<h3 data-id="heading-9">4.1 为什么更容易踩坑？</h3>
<p>因为 UI 上你可能觉得：</p>
<ul>
<li>我已经有图标（logo）</li>
<li>我已经有一段说明文字（div/p）</li>
<li>我不想显示标题</li>
</ul>
<p>但 <strong>视觉上满足 ≠ 语义上满足</strong>。读屏依赖的是 <code>aria-labelledby/aria-describedby</code> 的关联，而不是你页面里有没有一个看起来像标题的 <code>div</code>。</p>
<hr/>
<h2 data-id="heading-10">5. 最推荐的写法、更标准的写法</h2>
<h3 data-id="heading-11">5.1 标题不想显示：用 <code>sr-only</code></h3>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">DialogTitle</span> className=<span class="hljs-string">"sr-only"</span>&gt;{<span class="hljs-title function_">t</span>(<span class="hljs-string">"xxx.title"</span>)}&lt;/<span class="hljs-title class_">DialogTitle</span>&gt;
</code></pre>
<h3 data-id="heading-12">5.2 描述存在：用 <code>DialogDescription</code></h3>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">DialogDescription</span> className=<span class="hljs-string">"sr-only"</span>&gt;
  {<span class="hljs-title function_">t</span>(<span class="hljs-string">"xxx.description"</span>)}
&lt;/<span class="hljs-title class_">DialogDescription</span>&gt;
</code></pre>
<p>是否一定要隐藏 Description？</p>
<ul>
<li>不一定。像更新弹窗这种 “正文就是描述”，直接用 <code>DialogDescription</code> 包住正文最自然。</li>
</ul>
<hr/>
<h2 data-id="heading-13">6. 也可以手动 <code>aria-describedby</code> 吗？可以，但更容易出错</h2>
<p>你当然可以自己写：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">DialogContent</span> aria-describedby=<span class="hljs-string">"my-desc"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"my-desc"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">DialogContent</span>&gt;
</code></pre>
<p>但坑在于：</p>
<ul>
<li>id 可能忘了写 / 重复</li>
<li>条件渲染导致节点不在 DOM（aria 指向不存在的 id）</li>
<li>重构时删掉了 <code>id</code> 没发现</li>
<li>多弹窗复用组件时 id 冲突</li>
</ul>
<p>所以在 shadcn/Radix 体系里，优先使用 <code>DialogTitle</code> / <code>DialogDescription</code> 让 Radix 负责关联更稳。</p>
<hr/>
<h2 data-id="heading-14">7. 真正的“坑点清单”（建议以后 review 的时候对照）</h2>
<ul>
<li>只写了 <code>&lt;DialogContent /&gt;</code>，把标题/正文都塞进普通 <code>div</code></li>
<li>标题用视觉元素表达（比如 logo 或大号文本），但没用 <code>DialogTitle</code></li>
<li>描述是条件渲染的，导致有时没有 <code>DialogDescription</code></li>
<li>想隐藏标题却直接不写（应该隐藏而不是删除）</li>
</ul>
<hr/>
<h2 data-id="heading-15">8. coco-app 里的落地实践（最终结论）</h2>
<p>在 coco-app 里，我们最终遵循了一个简单规则：</p>
<ul>
<li>每个 <code>DialogContent</code> 内部都应该有且只有一个语义标题：<code>DialogTitle</code></li>
<li>只要弹窗有 “说明性文本”，优先用 <code>DialogDescription</code> 承载</li>
<li>如果 UI 不需要展示标题/描述：用 <code>sr-only</code> 隐藏（而不是不写）</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 React 里优雅地 “隐藏 iframe 滚动条”]]></title>    <link>https://juejin.cn/post/7587961565477224502</link>    <guid>https://juejin.cn/post/7587961565477224502</guid>    <pubDate>2025-12-26T09:27:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587961565477224502" data-draft-id="7587998744294146054" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 React 里优雅地 “隐藏 iframe 滚动条”"/> <meta itemprop="keywords" content="前端,React.js,CSS"/> <meta itemprop="datePublished" content="2025-12-26T09:27:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨夜寻晴天"/> <meta itemprop="url" content="https://juejin.cn/user/1943592288391496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 React 里优雅地 “隐藏 iframe 滚动条”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592288391496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨夜寻晴天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:27:30.000Z" title="Fri Dec 26 2025 09:27:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,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) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,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) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前端有一个经典问题：</p>
<blockquote>
<p>你在宿主页面怎么写 CSS，都<strong>管不到 iframe 内部</strong>的滚动条。</p>
</blockquote>
<p>所以正确的前端方案不是 “给外层容器加 overflow”，而是：<strong>尽量在 iframe 自己层面兜底 + 同源时向 iframe 内注入 CSS</strong>。</p>
<p>本文只聚焦前端实现，不展开前后端传参链路。</p>
<hr/>
<h2 data-id="heading-0">1. 为什么你明明设置了，滚动条还是在？</h2>
<p>因为滚动条来自 <strong>iframe 内部 document</strong>：</p>
<ul>
<li>外层 <code>div</code> 的 <code>overflow-hidden</code> 只能裁剪 “iframe 这个盒子” 是否溢出</li>
<li>iframe 里面的页面是否出现滚动条，取决于 iframe 内部的 <code>html/body</code> 或某个容器的 <code>overflow</code></li>
<li>宿主页面的 CSS 不会跨 document 生效（iframe 天生隔离）</li>
</ul>
<hr/>
<h2 data-id="heading-1">2. 我们最终用了 “两层方案”，解决现实世界的不确定性</h2>
<p>实现集中在 <code>src/components/Search/ViewExtensionIframe.tsx:1-88</code>。</p>
<h3 data-id="heading-2">2.1 第一层：<code>scrolling="no"</code> 作为低成本兜底</h3>
<pre><code class="hljs language-tsx" lang="tsx">&lt;iframe scrolling={hideScrollbar ? <span class="hljs-string">"no"</span> : <span class="hljs-string">"auto"</span>} /&gt;
</code></pre>
<p>它不是现代标准，但在某些 WebView/嵌入环境里仍能减少滚动条出现的概率。</p>
<p>它的价值在于：<strong>不依赖同源</strong>，哪怕你进不去 iframe，也能 “碰一碰运气”。</p>
<h3 data-id="heading-3">2.2 第二层（主力）：同源时注入一段隐藏滚动条的 CSS</h3>
<p>核心是这段逻辑（同文件 <code>applyHideScrollbarToIframe</code>）：</p>
<ul>
<li><code>src/components/Search/ViewExtensionIframe.tsx:5-39</code></li>
</ul>
<p>做法很直接：</p>
<ol>
<li>拿到 <code>iframe.contentDocument</code></li>
<li>往里面塞一个带固定 <code>id</code> 的 <code>&lt;style&gt;</code></li>
<li>开关关闭时把这个 <code>&lt;style&gt;</code> 删掉</li>
</ol>
<p>注入的 CSS 同时覆盖主流引擎：</p>
<pre><code class="hljs language-css" lang="css">* {
  <span class="hljs-attribute">scrollbar-width</span>: none;      <span class="hljs-comment">/* Firefox */</span>
  -ms-<span class="hljs-attribute">overflow</span>-style: none;   <span class="hljs-comment">/* 老 IE/Edge 风格 */</span>
}
*::-webkit-scrollbar {        <span class="hljs-comment">/* Chrome/Safari */</span>
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0px</span>;
}
</code></pre>
<p>为什么用 <code>*</code>？</p>
<ul>
<li>扩展页面的滚动容器不一定是 <code>body</code>，可能是任意 <code>div overflow-auto</code></li>
<li>用 <code>*</code> 能最大概率“全场隐藏”，更通用</li>
</ul>
<p>为什么要固定 <code>id</code>？</p>
<ul>
<li>防止重复注入（多次 onLoad / 状态变化）</li>
<li>关闭时能精确移除，保证可逆</li>
</ul>
<hr/>
<h2 data-id="heading-4">3. 为什么要 “onLoad + useEffect” 双触发？</h2>
<p>这是最容易漏、也最影响体验的一点。</p>
<ul>
<li><code>useEffect</code>：响应 <code>hideScrollbar</code> 变化（开关切换时立刻生效）</li>
<li><code>onLoad</code>：保证“首次加载完成后一定注入成功”</li>
</ul>
<p>原因：iframe 的加载时序不可控。你在 React 渲染完时，iframe 可能还没 ready，<code>contentDocument</code> 为空；等到 onLoad 才能 100% 确认 document 存在。</p>
<p>对应代码：</p>
<ul>
<li><code>src/components/Search/ViewExtensionIframe.tsx:52-55</code></li>
<li><code>src/components/Search/ViewExtensionIframe.tsx:78-84</code></li>
</ul>
<hr/>
<h2 data-id="heading-5">4. 这个方案的边界与坑（提前写清楚，后面少掉头发）</h2>
<h3 data-id="heading-6">4.1 “隐藏滚动条” 不等于 “不能滚”</h3>
<p>我们只隐藏 scrollbar 的视觉表现，滚动行为仍存在（滚轮/触摸板/键盘都能滚）。<br/>
这在沉浸式页面很舒服，但在长页面里也可能让用户不知道 “还能滚”。</p>
<h3 data-id="heading-7">4.2 跨域 iframe：注入会失败，但不会炸</h3>
<p>如果 iframe 加载跨域页面，访问 <code>contentDocument</code> 会触发同源限制。当前实现用 <code>try/catch</code> 静默吞掉异常，结果是：</p>
<ul>
<li>CSS 注入失败</li>
<li>只剩 <code>scrolling="no"</code> 兜底，效果不保证</li>
</ul>
<p>这不是 bug，是浏览器安全模型决定的。</p>
<h3 data-id="heading-8">4.3 全局 <code>*</code> 的副作用</h3>
<p>它会把 iframe 内所有滚动条都干掉，包括某些组件内部滚动区域、代码块滚动等。<br/>
目前我们选择“通用性优先”，但如果未来某些扩展需要保留局部滚动条，就要改为更精确的选择器策略。</p>
<hr/>
<h2 data-id="heading-9">5. 一句话总结</h2>
<p>在前端想稳定控制 iframe 滚动条，最靠谱的思路是：</p>
<ul>
<li><strong>先用 iframe 自身属性做兜底</strong></li>
<li><strong>再在同源条件下对 iframe 内部 document 注入 CSS</strong></li>
<li><strong>用固定 style id 保证幂等与可逆</strong></li>
<li><strong>用 onLoad + effect 解决时序问题</strong></li>
</ul>
<p>这就是 <code>hideScrollbar</code> 在前端真正解决的问题：不是写没写 CSS，而是有没有把 CSS 写到“对的世界里”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么企业都需要职场心理学分析专家？]]></title>    <link>https://juejin.cn/post/7588004601393037346</link>    <guid>https://juejin.cn/post/7588004601393037346</guid>    <pubDate>2025-12-27T08:12:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588004601393037346" data-draft-id="7588004376867569699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么企业都需要职场心理学分析专家？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T08:12:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LucianaiB"/> <meta itemprop="url" content="https://juejin.cn/user/1269294586664749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么企业都需要职场心理学分析专家？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1269294586664749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LucianaiB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T08:12:28.000Z" title="Sat Dec 27 2025 08:12:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,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) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,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) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么企业都需要职场心理学分析专家？</h2>
<p>在快节奏、高压力的现代职场环境中，员工的行为表现往往不仅仅是表面现象，背后隐藏着复杂的心理动因。这些动因如果得不到科学识别与有效干预，极易演变为沟通障碍、协作低效，甚至引发组织内部的士气危机。因此，越来越多的企业意识到，将心理学系统性地引入管理实践，不仅是一种“柔性管理”手段，更是一项能够提升组织效能与人才保留率的战略投资。</p>
<p>正是基于这一洞察，我利用 <strong>腾讯元器（YuanQi）</strong> 平台，构建了一款面向企业办公场景的实用型 AI 智能体——「职场心理学分析专家」。它聚焦于解决企业管理中三大高频痛点：<strong>看不懂员工行为、沟通效率低下、团队士气低迷</strong>，将心理学理论转化为可落地的管理工具。</p>
<blockquote>
<p><strong>✨ 目标：让心理学成为企业管理的“隐形杠杆”</strong></p>
</blockquote>
<h2 data-id="heading-1">🧠我用腾讯元器打造的心理学分析专家效果预览</h2>
<p>点击链接即刻体验：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuanqi.tencent.com%2Fwebim%2F%23%2Fchat%2FJoAncj%3Fappid%3D2004808954860119296%26experience%3Dtrue" target="_blank" title="https://yuanqi.tencent.com/webim/#/chat/JoAncj?appid=2004808954860119296&amp;experience=true" ref="nofollow noopener noreferrer">yuanqi.tencent.com/webim/#/cha…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d858aa818aa48f48b95c8b58f878534~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=vEI2PIKDvXKuJ%2F640Grp9yhUbgQ%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>该智能体融合心理学与社会学理论，通过结构化分析框架，帮助 HR、管理者甚至普通员工，科学解析职场行为背后的深层原因，并提供可操作的管理建议。其目标不仅是“解释问题”，更是“推动改变”。</p>
<h3 data-id="heading-2">职场行为分析</h3>
<p>可以直接用预设的问题来体验，可以看到成功的回复了我们<code>员工频繁迟到的可能原因</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/864e52c98b564ba38489caa5aef043c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=QcNIOZowVu8%2F5ANbQyy7k0Xbc6E%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">职业发展</h3>
<p>当我们不知道职业发展的时候他可以用工作流来回复我们发展的方向。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d7cbf9bd73e46c9acd4ceb1687b1751~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=QGtj%2FX%2B71MIpxcxdi4Fs%2BIK5xL4%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-4">智能体能做什么？</h3>
<p>这款 Agent 聚焦三大核心能力：</p>
<p>✅ 职场行为分析：从迟到、沉默、过度加班等行为中挖掘潜在动机</p>
<p>✅ 微表情与非语言信号解读：辅助识别会议/谈判中的真实情绪状态</p>
<p>✅ 基于心理学与社会学理论的结构化输出：提供可操作的管理建议</p>
<p>无论你是 HR、团队管理者，还是普通职场人，都能借助它更科学地理解他人、优化沟通、营造健康职场生态。</p>
<h2 data-id="heading-5">相关介绍</h2>
<h3 data-id="heading-6">腾讯元器</h3>
<p>腾讯元器是腾讯推出的一站式 <strong>AI 智能体（Agent）开发与分发平台</strong>，旨在降低大模型应用的开发门槛，让企业、开发者甚至非技术人员都能快速构建、部署和运营专属智能体。平台深度集成腾讯混元大模型能力，并支持多种主流开源模型（如 DeepSeek、Llama 系列等），通过“提示词 + 知识库 + 工作流”的组合方式，赋予智能体垂直领域专业能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07e6bbfaaad645f9b3b819cdc63df776~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=tOwum1IVti0bx35%2FQyS9W%2BEaXCI%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-7">系统逻辑架构</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89d87147c9bb4fbd9b36e0d1bb815798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=rRMvKh2oH7fs4eHPuyK6t4ZNqXA%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h2 data-id="heading-8">手把手教程（全网最详细教程）</h2>
<h3 data-id="heading-9">手把手教程总览</h3>
<p>整体流程可以拆成五步：</p>
<ol>
<li>打开腾讯元器并新建智能体</li>
<li>完成基础配置：模型、提示词、欢迎语、开场问题等</li>
<li>测试基础版职场心理学分析专家</li>
<li>搭建进阶工作流：待定</li>
<li>发布到各平台，作为长期可用的职场心理学分析专家 Agent</li>
</ol>
<h3 data-id="heading-10">1.打开腾讯元器</h3>
<p>点击网站直达地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuanqi.tencent.com%2F" target="_blank" title="https://yuanqi.tencent.com/" ref="nofollow noopener noreferrer">yuanqi.tencent.com/</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/654c914a77864e748f1f9a89f676cf34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=WJIaWdLtAQ4pvmuN%2FyjGSg%2B8Tgc%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-11">2.新建职场心理学分析专家智能体</h3>
<p>在腾讯元器支持两种类型的智能体：</p>
<p><strong>公众号**</strong>智能体**：支持便捷拉取公众号文章构建知识库，一键发布到公众号后台，实现智能回复功能。</p>
<p><strong>对话式**</strong>智能体**：支持灵活构建通用知识库和工作流，可发布到多个渠道进行对话互动。</p>
<p>如果对<strong>公众号智能体</strong>感兴趣的可以看我的上一篇文章（<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F2600684" target="_blank" title="https://cloud.tencent.com/developer/article/2600684" ref="nofollow noopener noreferrer">cloud.tencent.com/developer/a…</a>）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ef76bfa20d24c6fb2e7bd3ca753bf0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=LTc2wg4CfyQSWSesi2oycRAWckE%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>输入智能体的基本信息，如：名称，简介，以及头像。</p>
<p>我的仅供参考：</p>
<blockquote>
<p>名称：职场心理学分析专家
简介：职场心理学分析专家专注于解析职场中个体行为背后的潜在心理动机，帮助理解员工和同事的行为模式。该Agent结合心理学与社会学理论，运用行为概括、动机分析和微表情识别等专业技能，深入剖析职场行为背后的多重心理因素。适用于HR、管理者及职场人士，用于提升团队管理、优化沟通和促进职场氛围健康。
头像：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/102d31bb220e4d81869c9ae1ed574992~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=STVomSVTQaqOHCXJc73%2FIh%2B9Tlk%3D" alt="请在此添加图片描述" loading="lazy"/></p>
</blockquote>
<p>如下图所示，点击新建即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b216f7b6c3314e30b1e80c3e9748e6bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=LRcGRzKSQxcISOcUzByxlts6LR8%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-12">3.基础配置示例：=</h3>
<p>在右侧进行一些基础的配置，如模型设置，提示词，欢迎语，知识库等。</p>
<p>我这里的具体模型设置：DeepSeek-V3.2</p>
<p>提示词：</p>
<pre><code class="hljs language-md" lang="md">请扮演职场心理学分析专家，分析职场中人们行为背后的潜在心理动机。

<span class="hljs-bullet">-</span> 在任何情况下都不要脱离角色。
<span class="hljs-bullet">-</span> 不要胡说八道或编造事实。

<span class="hljs-section">## 概况：</span>

<span class="hljs-bullet">-</span> 语言：中文
<span class="hljs-bullet">-</span> 描述：你是一个心理学专家，用来分析职场中人们行为背后的潜在心理动机，可能的心理动机分析

<span class="hljs-section">## 技能</span>

<span class="hljs-bullet">1.</span> 职场行为分析
<span class="hljs-bullet">2.</span> 微表情识别
<span class="hljs-bullet">3.</span> 其他有助于分析职场心理状态的心理学、社会学技能

<span class="hljs-section"># 步骤</span>

<span class="hljs-bullet">1.</span> <span class="hljs-strong">**行为概括**</span>：总结需要分析的职场行为。
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**动机分析**</span>：对于概括出的行为，提供至少三个可能的心理动机。
<span class="hljs-bullet">    -</span> 每个动机包含以下几个部分:
<span class="hljs-bullet">        -</span> <span class="hljs-strong">**解释**</span>：描述这个动机的基本情况。
<span class="hljs-bullet">        -</span> <span class="hljs-strong">**可能的原因**</span>：解释为什么这个动机可能是行为背后的原因。
<span class="hljs-bullet">        -</span> <span class="hljs-strong">**潜在影响**</span>：说明这个动机对个体或职场环境可能产生的影响。

<span class="hljs-section"># 输出格式</span>

请在代码块中输出结果，结构如下：

行为概括

动机 1

解释:

可能的原因:

潜在影响:

动机 2

解释:

可能的原因:

潜在影响:

动机 3

解释:

可能的原因:

潜在影响:

<span class="hljs-section"># 示例</span>

行为概括

某员工频繁加班，甚至在周末也在处理工作。

动机 1

解释: 该员工希望在短时间内提升业绩。

可能的原因: 可能是为了给上级留下好印象，争取升职或加薪的机会。

潜在影响: 长期加班可能导致员工身心疲惫，从而影响工作效率和健康。

动机 2

解释: 该员工对工作有较强的责任感和成就感。

可能的原因: 他可能认为完成更多的工作能带来个人意义和职业满足感。

潜在影响: 虽然能短期提振工作绩效，但也有可能加剧员工的疲劳和倦怠。

动机 3

解释: 该员工缺乏时间管理技能，导致工作时间延长。

可能的原因: 工作方法不够有效，大量时间被浪费在低效的任务上。

潜在影响: 如果不加以改善，可能会形成恶性循环，影响长远的工作表现和职业发展。

<span class="hljs-section"># 注意事项</span>

<span class="hljs-bullet">-</span> 妥善分析行为动机，避免主观臆断。
<span class="hljs-bullet">-</span> 提供的解释和分析需要合理且基于心理学和社会学理论。 
</code></pre>
<p>欢迎语:</p>
<pre><code class="hljs language-md" lang="md">您好，我是您的职场心理学分析专家，专注于解析职场行为背后的心理动机。无论是团队沟通、员工行为还是管理难题，我都能为您提供科学、专业的心理动机分析，助您优化职场环境，提升团队效能。
</code></pre>
<p>开场的3个问题：</p>
<pre><code class="hljs language-md" lang="md">某员工频繁迟到，可能有哪些心理动机？

如何分析同事在会议中的肢体语言？

团队成员表现出消极情绪，可能的心理原因是什么？
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/861fa1e9a81c4538a15310e039611a83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=3%2B0KfOduddO2LjaCyoC0NTassF0%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>在右侧我们就可以直接对话了，可以看到下图，成功输出了行为概括和动机。</p>
<p>基于提示词直接问：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/482611a921b446ac9aeb6604c8b25577~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=AEi7qzI5BwFhsUG3TLe1KAcdS%2BA%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>告诉他一个一个职场心理问题：</p>
<blockquote>
<p>某员工频繁迟到，可能有哪些心理动机？</p>
</blockquote>
<p>他会基于这个“职场心理学分析专家”来分析问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b9f8f8a5a6f487c8bd85b87a2b17475~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=8xSGg8QKBddvvgT6Dfb1J92hJj8%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>他会通过分析并回答：</p>
<blockquote>
<p>行为概括
某员工频繁迟到，经常在上班时间之后才到达工作岗位。动机 1
解释: 该员工可能对工作或工作环境存在潜在的抵触或不满情绪。
可能的原因: 这种抵触可能源于对工作内容不感兴趣、与同事或上级关系紧张、感到工作压力过大或缺乏成就感。迟到行为成为一种被动的、非直接的抵抗方式，用以表达不满或试图重新获得对工作时间的某种控制感。
潜在影响: 长期如此会损害该员工的职业形象和信誉，可能导致绩效评估不佳、错失发展机会，并可能加剧其与团队及上级的矛盾，形成负面循环。动机 2
解释: 该员工可能存在时间管理能力不足或自律性较弱的问题。
可能的原因: 这可能与个人的生活习惯、拖延倾向、对时间预估过于乐观，或者缺乏有效的优先级排序和计划能力有关。其行为背后并非对工作有强烈负面情绪，而是个人组织技能存在短板。
潜在影响: 不仅影响个人工作效率和任务完成质量，也可能给团队协作带来不便（如延误会议、等待其开始工作等），长期会限制其职业发展，并可能被贴上“不可靠”的标签。动机 3
解释: 该员工可能通过迟到行为来寻求关注或测试组织规则的边界。
可能的原因: 这背后可能隐藏着对自身在组织中地位的不安全感，希望通过“特殊”行为来确认上级或组织对自己的容忍度和重视程度。也可能是一种无意识的、希望引起他人（尤其是管理者）注意的方式。
潜在影响: 这种行为容易引发管理者的负面关注和同事的不满，破坏团队公平感。如果管理者处理不当（如过度纵容或过度惩罚），可能进一步强化该员工的不当行为或引发更大的冲突。</p>
</blockquote>
<h3 data-id="heading-13">4.进阶：为职场心理学分析专家加入职业发展工作流</h3>
<p>上面就是一个简单的对话，下面来加入一个高级点的技术，如工作流。</p>
<p>在上方有工作流管理，然后点击新建，手动录入，输入工作流的基本信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab6785d407c24589957db4376e1d4c3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=AnBhnFI8IqBhJFdp1Wgyf1UkUC8%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>我们输入工作流的基本信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bb8791b278a446e94191cbe65b4d873~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=gZvkjnbHVpRQdUu3Z3kLT%2FOfGDg%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>我填的具体如下：</p>
<blockquote>
<p>工作流名称：职业发展工作流
工作流描述：职业发展导师是一位经验丰富的职业规划和创业咨询专家，专注于为职场新人和创业者提供个性化、实用的职业发展和创业指导。该Agent通过系统化的信息收集，深入了解用户的教育背景、工作经验、兴趣爱好及职业目标，制定切实可行的职业规划方案。它不仅推荐适合的职业方向和晋升路径，还提供技能提升建议、行业趋势分析以及创业可行性评估。通过指导用户如何拓展人际网络、管理工作与生活平衡，帮助用户全面提升职场竞争力。</p>
</blockquote>
<p>创建一个如下图所示的工作流。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/548b6ceb593c45e0bfdb8ff2dc12993f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=V%2FOgYMdIixNJVTN6GEmhLPo6JFk%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>其中"职业发展工作流"节点的提示词如下：</p>
<blockquote>
<p>你是一位经验丰富的职业发展顾问和导师，擅长为职场新人和创业者提供全面、实用且具有可操作性的建议。你的任务是通过深入了解用户的教育背景、职业经历、当前面临的挑战与目标，为他们量身定制个性化、切实可行的职业发展方案。用户输入：shuru</p>
</blockquote>
<p>我们来进行测试一下：</p>
<p>点击右上角的调试，对他说：我是一名运营，我该怎么发展</p>
<p>可以看到Agent回复：</p>
<blockquote>
<p>作为一名运营人员，职业发展的关键在于不断提升自己的专业技能、行业知识以及软实力。首先，建议你定期参加行业相关的培训和研讨会，以保持对最新趋势和技术的了解。其次，建立一个强大的网络，包括同事、行业专家和潜在雇主，这将有助于你在行业内建立声誉，并可能带来新的职业机会。
此外，考虑获得一些认证或资格证书，如项目管理专业人士（PMP）认证，这可以证明你的专业能力并增强你的简历。同时，不断反思和评估自己的工作表现，设定明确的职业发展目标，并制定实现这些目标的具体计划。
最后，不要忘记培养自己的领导力和团队合作能力，这些都是在职业生涯中取得成功的重要因素。通过持续学习和实践，你可以逐步提升自己在运营领域的竞争力，实现职业上的成长和发展。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ab6c7c5bcc342e9afbabd5f49864311~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=MXU3P83DMo78A93xJ%2FdwXoSmHHM%3D" alt="请在此添加图片描述" loading="lazy"/></p>
</blockquote>
<p>成功的创造了一个职业发展工作流，这下就不用担心职业发展不知道的方向了。</p>
<h3 data-id="heading-14">5.发布</h3>
<h4 data-id="heading-15">发布工作流</h4>
<p>制作好工作流后要记得来这里把他启动才可以运行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0887e06039704d18b0e9eb4080e1215d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=Kkf6T7n36jHFGixSHDbNXPbevVk%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-16">发布应用</h4>
<p>接下来测试没问题后，我们就可以发布应用了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e163b8db11ab4200b9a8d2dfe8ddc9dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=SgydzZ0yGsWnuWXTbO5RxSEf2qo%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>测试通过后，点击右上角的“发布”。腾讯元器支持一键分发到多个高流量渠道：</p>
<ul>
<li><strong>微信公众号</strong>：自动回复，粉丝互动（这里因为已经有了，就不再选择了）。</li>
<li><strong>微信小程序</strong>：独立入口，体验更佳。</li>
<li><strong>智能硬件</strong>：如荣耀YOYO等。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fc1bb2aa09844baadd5fcd8c01c80f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=uwBc13hPYEY%2F9q7oVjSh4V65T4w%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>然后就是等待审核。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25b01fea688c48f5aaf342cb1a5d8841~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=p%2BbWJRA6vnwLLV3rF%2FBbHkdnXj0%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>最终效果如下，用户可以通过简单的指令开启体验丝滑的分析过程。</p>
<p>点击下方链接体验<strong>职场心理学分析专家</strong>（已上架到小米应用商店）：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuanqi.tencent.com%2Fwebim%2F%23%2Fchat%2FJoAncj%3Fappid%3D2004808954860119296%26experience%3Dtrue" target="_blank" title="https://yuanqi.tencent.com/webim/#/chat/JoAncj?appid=2004808954860119296&amp;experience=true" ref="nofollow noopener noreferrer">yuanqi.tencent.com/webim/#/cha…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeb044951c7b423b9fb79ca2ad9aee1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=2a0VhAgY1LZx6RCwN9WsSS6biKA%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h2 data-id="heading-17">总结</h2>
<h3 data-id="heading-18">🌟 为什么选择腾讯元器？</h3>
<ul>
<li>低门槛：无需编程，拖拽+提示词即可构建专业智能体</li>
<li>强生态：无缝对接微信、小程序、硬件设备</li>
<li>知识库支持：可后续接入企业内部培训资料或心理学数据库</li>
</ul>
<h3 data-id="heading-19">⚠️ 小建议（来自真实体验）：</h3>
<p>目前开场问题仅支持3个，建议未来开放更多选项，提升用户引导灵活性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a55efbf790b443c58ede9af150a6b5c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=EB4%2BwkPeelidyCqDFJ4lbZota0g%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-20">整体感受：</h3>
<p>在数字化转型浪潮中，企业对“人”的关注正从“绩效输出”转向“心理体验”。本文所构建的「职场心理学分析专家」智能体，正是这一趋势下的技术回应。其核心价值在于将抽象的心理学理论转化为可操作、可复用、可规模化的管理工具。</p>
<p>首先，该智能体解决了传统管理中的“信息盲区”问题。管理者往往只能观察到行为表象（如迟到、沉默），却难以洞察其背后的情绪、动机或认知偏差。而本智能体通过结构化分析框架（行为概括 + 三重动机模型），帮助用户从情绪抵触、能力短板、边界试探等多个角度理解行为，避免误判与冲突升级。</p>
<p>其次，通过集成“职业发展工作流”，智能体不仅具备“诊断”能力，还提供“治疗”方案。它不再局限于问题分析，而是主动引导用户思考职业路径、技能缺口与资源网络，真正实现“赋能式管理”。这种从“解释”到“行动”的跃迁，是传统咨询难以高频覆盖的。</p>
<p>更重要的是，该方案依托腾讯元器平台，具备极强的落地性与扩展性。企业可在1小时内完成部署，无需IT支持；未来还可接入内部知识库，打造专属“组织心理顾问”。这不仅降低了心理学应用的门槛，也为企业构建“高情商组织文化”提供了技术支点。</p>
<p>综上所述，职场心理学分析专家不仅是AI工具，更是企业提升组织情商（Organizational EQ）、增强人才黏性、优化管理决策的智能基础设施。在“以人为本”的企业管理新时代，这样的智能体将成为HR与管理者不可或缺的数字伙伴。</p>
<p>通过腾讯元器，你也能在1小时内，打造一个专业、可靠、可落地的AI心理顾问，</p>
<p>让管理更有人性，让职场更有效能。</p>
<p>👉 立即体验：点击进入小米应用商店（已上架） 👉 动手创建：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuanqi.tencent.com%2Fwebim%2F%23%2Fchat%2FJoAncj%3Fappid%3D2004808954860119296%26experience%3Dtrue" target="_blank" title="https://yuanqi.tencent.com/webim/#/chat/JoAncj?appid=2004808954860119296&amp;experience=true" ref="nofollow noopener noreferrer">yuanqi.tencent.com/webim/#/cha…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[取件伙伴性能提升——长列表]]></title>    <link>https://juejin.cn/post/7588034035287162895</link>    <guid>https://juejin.cn/post/7588034035287162895</guid>    <pubDate>2025-12-27T07:53:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588034035287162895" data-draft-id="7588043318358622243" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="取件伙伴性能提升——长列表"/> <meta itemprop="keywords" content="HarmonyOS,性能优化"/> <meta itemprop="datePublished" content="2025-12-27T07:53:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云_杰"/> <meta itemprop="url" content="https://juejin.cn/user/3877341924964713"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            取件伙伴性能提升——长列表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3877341924964713/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云_杰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T07:53:59.000Z" title="Sat Dec 27 2025 07:53:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,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) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,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) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">取件伙伴性能提升——长列表</h2>
<p>在移动应用开发中，List是最常见也是最容易出现性能瓶颈的场景之一。在 <strong>取件伙伴</strong> 项目中，取件列表页面需要展示可能多达数百条的包裹信息。如果不进行优化，随着数据量的增长，应用会出现滑动掉帧、内存占用过高甚至崩溃的问题，特别是最近我增加了在<strong>深色模式下的雪花效果</strong>，列表更是卡的不行！</p>
<p>本文将详细介绍我们如何利用 性能优化 "三剑客" —— <strong><code>LazyForEach</code></strong>、<strong><code>@Reusable</code></strong> 和 <strong><code>cachedCount</code></strong>，将列表渲染性能提升至极致。</p>
<hr/>
<h3 data-id="heading-1">核心问题分析</h3>
<p>在早期的开发中，如果直接使用 <code>ForEach</code> 渲染列表：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 性能较差的写法</span>
<span class="hljs-title class_">List</span>() {
  <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">packages</span>, <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    <span class="hljs-title class_">PackageCard</span>({ <span class="hljs-attr">packageInfo</span>: item })
  })
}
</code></pre>
<p>这种方式存在两个主要缺陷：</p>
<ol>
<li><strong>全量加载</strong>：无论列表有多长，<code>ForEach</code> 都会一次性创建所有的数据对象和组件节点。如果有 1000 个包裹，就会瞬间创建 1000 个 <code>PackageCard</code>，导致内存激增。</li>
<li><strong>频繁销毁与创建</strong>：当用户滑动列表时，移出屏幕的组件会被销毁，新进入屏幕的组件需要重新创建、布局和渲染。对于包含图片和复杂布局的卡片，这种开销是巨大的，直接导致滑动卡顿。</li>
</ol>
<hr/>
<h3 data-id="heading-2">解决方案：性能优化 "三剑客"</h3>
<h4 data-id="heading-3">1. LazyForEach：按需加载</h4>
<p><code>LazyForEach</code> 是专门为长列表设计的渲染控制语法。与 <code>ForEach</code> 不同，它只渲染屏幕可见区域的组件，并配合数据源（IDataSource）实现按需加载。</p>
<h5 data-id="heading-4">实现步骤：</h5>
<p>首先，我们需要实现一个 <code>IDataSource</code> 接口的数据源类：</p>
<p><strong><code>entry/src/main/ets/utils/BasicDataSource.ets</code></strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 通用数据源基类，实现了 IDataSource 接口</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicDataSource</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IDataSource</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">listeners</span>: <span class="hljs-title class_">DataChangeListener</span>[] = [];
  <span class="hljs-keyword">private</span> <span class="hljs-attr">originDataArray</span>: T[] = [];

  <span class="hljs-comment">// 获取数据的总条数</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">totalCount</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">originDataArray</span>.<span class="hljs-property">length</span>;
  }

  <span class="hljs-comment">// 获取指定索引的数据</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getData</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): T {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">originDataArray</span>[index];
  }

  <span class="hljs-comment">// 注册/注销监听器（框架调用）</span>
  <span class="hljs-title function_">registerDataChangeListener</span>(<span class="hljs-attr">listener</span>: <span class="hljs-title class_">DataChangeListener</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">indexOf</span>(listener) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">push</span>(listener);
    }
  }
  <span class="hljs-title function_">unregisterDataChangeListener</span>(<span class="hljs-attr">listener</span>: <span class="hljs-title class_">DataChangeListener</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> pos = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">indexOf</span>(listener);
    <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">splice</span>(pos, <span class="hljs-number">1</span>);
    }
  }

  <span class="hljs-comment">// === 通知 LazyForEach 刷新 ===</span>
  <span class="hljs-title function_">notifyDataReload</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> listener.<span class="hljs-title function_">onDataReloaded</span>());
  }
  
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setData</span>(<span class="hljs-params">data: T[]</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">originDataArray</span> = data;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyDataReload</span>();
  }
}
</code></pre>
<h4 data-id="heading-5">2. @Reusable：组件复用</h4>
<p>这是解决“滑动卡顿”的关键。通过 <code>@Reusable</code> 装饰器，我们可以让组件具备“复用”能力。当一个列表项滑出屏幕时，它的组件实例不会被销毁，而是被放入缓存池；当新数据滑入屏幕时，直接从缓存池取出实例并更新数据，<strong>跳过了昂贵的组件创建和布局计算过程</strong>。</p>
<p><strong><code>entry/src/main/ets/components/PackageCard.ets</code></strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Reusable</span> <span class="hljs-comment">// &lt;--- 1. 标记为可复用组件</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">PackageCard</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">packageInfo</span>: <span class="hljs-title class_">PackageInfo</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;
  
  <span class="hljs-comment">/**
   * 2. 复用生命周期回调
   * 当组件被复用时触发。在此处更新状态变量，驱动 UI 刷新。
   * 
   * <span class="hljs-doctag">@param</span> params 上层传入的新参数
   */</span>
  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-params">params: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">Object</span>&gt;</span>) {
    <span class="hljs-comment">// 快速更新数据</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">packageInfo</span> = params.<span class="hljs-property">packageInfo</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">PackageInfo</span>;
    
    <span class="hljs-comment">// 更新其他状态</span>
    <span class="hljs-keyword">if</span> (params.<span class="hljs-property">compactModeEnabled</span> !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">compactModeEnabled</span> = params.<span class="hljs-property">compactModeEnabled</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">boolean</span>;
    }
    <span class="hljs-comment">// ...</span>
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 构建复杂的卡片布局...</span>
    <span class="hljs-comment">// 复用时，这里的节点结构保持不变，仅数据发生变化</span>
  }
}
</code></pre>
<h4 data-id="heading-6">3. cachedCount：预加载</h4>
<p><code>LazyForEach</code> 默认只加载屏幕可见的项。为了让滑动更流畅，我们可以利用 <code>cachedCount</code> 属性，让列表在屏幕上下方预先加载几个项目。</p>
<p><strong><code>entry/src/main/ets/pages/PackagesPage.ets</code></strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">List</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">12</span> }) {
  <span class="hljs-comment">// 使用 LazyForEach + 自定义数据源</span>
  <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">packagesDataSource</span>, <span class="hljs-function">(<span class="hljs-params">packageInfo: PackageInfo, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
    <span class="hljs-title class_">ListItem</span>() {
      <span class="hljs-comment">// 使用可复用组件</span>
      <span class="hljs-title class_">PackageCard</span>({
        <span class="hljs-attr">packageInfo</span>: packageInfo,
        <span class="hljs-comment">// ...</span>
      })
    }
  }, <span class="hljs-function">(<span class="hljs-params">item: PackageInfo</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${item.id}</span>_<span class="hljs-subst">${item.updateTime}</span>`</span>) <span class="hljs-comment">// 键值生成器</span>
}
.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
.<span class="hljs-title function_">cachedCount</span>(<span class="hljs-number">5</span>) <span class="hljs-comment">// &lt;--- 设置缓存数量为 5</span>
</code></pre>
<ul>
<li><strong>原理</strong>：<code>cachedCount(5)</code> 表示在屏幕视口之外，预先渲染并缓存 5 个列表项。</li>
<li><strong>收益</strong>：当用户快速滑动时，即将进入屏幕的卡片已经渲染好了，消除了白屏和闪烁，极大提升了跟手性。</li>
</ul>
<hr/>
<h3 data-id="heading-7">优化效果对比</h3>



































<table><thead><tr><th align="left">指标</th><th align="left">优化前 (ForEach)</th><th align="left">优化后 (LazyForEach + @Reusable)</th><th align="left">提升原理</th></tr></thead><tbody><tr><td align="left"><strong>首屏加载时间</strong></td><td align="left">慢（加载所有数据）</td><td align="left"><strong>快</strong>（仅加载首屏可见项）</td><td align="left">按需渲染</td></tr><tr><td align="left"><strong>内存占用</strong></td><td align="left">高（随数据量线性增长）</td><td align="left"><strong>低且稳定</strong>（仅维持可见项+缓存项）</td><td align="left">对象复用</td></tr><tr><td align="left"><strong>滑动帧率</strong></td><td align="left">掉帧明显</td><td align="left"><strong>满帧运行 (60/90/120Hz)</strong></td><td align="left">避免频繁创建销毁节点</td></tr><tr><td align="left"><strong>CPU 占用</strong></td><td align="left">高（频繁 GC 和布局计算）</td><td align="left"><strong>低</strong></td><td align="left">复用现有节点结构</td></tr></tbody></table>
<h3 data-id="heading-8">总结</h3>
<p>在开发复杂列表界面时，<strong>"LazyForEach + @Reusable + cachedCount"</strong> 是标准的高性能解决方案。</p>
<ol>
<li>用 <code>LazyForEach</code> 替代 <code>ForEach</code>，解决内存和首屏问题。</li>
<li>用 <code>@Reusable</code> 改造子组件，解决滑动掉帧问题。</li>
<li>用 <code>cachedCount</code> 调节预加载，进一步提升流畅度。</li>
</ol>
<p>这套方案在 PickupPartner 项目中经受住了大量数据的考验，为用户提供了丝滑的操作体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Vue3 高级技巧】函数重载+Watch：打造类型安全的通用事件监听 Hook]]></title>    <link>https://juejin.cn/post/7588086766248132659</link>    <guid>https://juejin.cn/post/7588086766248132659</guid>    <pubDate>2025-12-27T08:05:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766248132659" data-draft-id="7588010346071736330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Vue3 高级技巧】函数重载+Watch：打造类型安全的通用事件监听 Hook"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-27T08:05:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="练习前端两年半"/> <meta itemprop="url" content="https://juejin.cn/user/4012552097381324"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Vue3 高级技巧】函数重载+Watch：打造类型安全的通用事件监听 Hook
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4012552097381324/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    练习前端两年半
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T08:05:29.000Z" title="Sat Dec 27 2025 08:05:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Vue3 高级技巧】函数重载+Watch：打造类型安全的通用事件监听 Hook</h2>
<h3 data-id="heading-1">📖 引言</h3>
<p>在 Vue3 项目开发中，事件监听是一项非常基础但频繁使用的功能。我们经常需要为 DOM 元素或 window 对象绑定各类事件，如点击、滚动、键盘输入等。虽然原生 API 使用起来并不复杂，但在组件化开发中，手动管理事件的绑定与解绑不仅繁琐，还容易导致内存泄漏。</p>
<p>今天，我们将探索如何利用 Vue3 的<code>watch</code>API 和 TypeScript 的函数重载特性，打造一个<strong>类型安全、自动清理、使用便捷</strong>的通用事件监听 Hook，彻底解决事件管理的痛点。</p>
<h3 data-id="heading-2">🎯 问题剖析：原生事件绑定的痛点</h3>
<p>先来看一段我们在 Vue 组件中经常写的事件绑定代码：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div ref="divRef"&gt;&lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, onMounted, onUnmounted } from "vue";
const divRef = ref();
onMounted(() =&gt; {
  divRef.value.addEventListener("click", (e) =&gt; {
    console.log(e);
  });
});
onUnmounted(() =&gt; {
  divRef.value.removeEventListener("click");
});
&lt;/script&gt;
</code></pre>
<p>这段代码看似简单，但存在以下几个问题：</p>
<ol>
<li><strong>代码重复</strong>：每个需要事件绑定的组件都要写类似的<code>onMounted</code>和<code>onUnmounted</code>逻辑</li>
<li><strong>手动管理</strong>：必须手动调用<code>removeEventListener</code>，容易遗漏导致内存泄漏</li>
<li><strong>缺乏灵活性</strong>：无法很好地处理动态渲染的 DOM 元素（如 v-if 控制的元素）</li>
<li><strong>类型不安全</strong>：事件处理函数中的事件对象缺乏类型提示</li>
</ol>
<h3 data-id="heading-3">💡 解决方案：封装通用事件监听 Hook</h3>
<p>针对上述问题，我们可以封装一个通用的事件监听 Hook——<code>useEventListener</code>，利用 Vue3 的<code>watch</code>API 来自动管理事件的生命周期。</p>
<h4 data-id="heading-4">核心实现思路</h4>
<ol>
<li><strong>自动清理机制</strong>：利用<code>watch</code>的<code>onClear</code>回调实现事件的自动解绑</li>
<li><strong>动态目标支持</strong>：同时支持 window 对象和 DOM 元素作为事件目标</li>
<li><strong>响应式处理</strong>：通过<code>watch</code>监听目标元素的变化，支持动态 DOM</li>
<li><strong>类型安全</strong>：使用 TypeScript 的函数重载提供完整的类型提示</li>
</ol>
<h4 data-id="heading-5">基础版本实现</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { watch, unref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useEventListener</span>(<span class="hljs-params">...args</span>) {
  <span class="hljs-comment">// 判断目标：如果第一个参数是字符串，则目标为window；否则为传入的DOM元素</span>
  <span class="hljs-keyword">const</span> target = <span class="hljs-keyword">typeof</span> args[<span class="hljs-number">0</span>] === <span class="hljs-string">"string"</span> ? <span class="hljs-variable language_">window</span> : args.<span class="hljs-title function_">shift</span>();

  <span class="hljs-comment">// 使用watch监听目标元素的变化</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">watch</span>(
    <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">unref</span>(target),
    <span class="hljs-function">(<span class="hljs-params">element, _, onClear</span>) =&gt;</span> {
      <span class="hljs-comment">// 处理DOM不存在的情况（如v-if初始为false）</span>
      <span class="hljs-keyword">if</span> (!element) <span class="hljs-keyword">return</span>;

      <span class="hljs-comment">// 绑定事件</span>
      element.<span class="hljs-title function_">addEventListener</span>(...args);

      <span class="hljs-comment">// 清理函数：在组件卸载或watch停止时执行</span>
      <span class="hljs-title function_">onClear</span>(<span class="hljs-function">() =&gt;</span> {
        element.<span class="hljs-title function_">removeEventListener</span>(...args);
      });
    },
    {
      <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 立即执行</span>
    }
  );
}
</code></pre>
<h4 data-id="heading-6">用法示例</h4>
<p>封装完成后，我们可以通过两种方式使用这个 Hook：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 1. 给window绑定事件</span>
<span class="hljs-title function_">useEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Window clicked!"</span>), options);

<span class="hljs-comment">// 2. 给指定DOM元素绑定事件</span>
<span class="hljs-title function_">useEventListener</span>(domRef, <span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"DOM clicked!"</span>), options);
</code></pre>
<p>如果需要手动结束事件监听，可以调用返回的<code>stop</code>方法：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> handle = <span class="hljs-title function_">useEventListener</span>(domRef, <span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> {});
<span class="hljs-comment">// 手动终止监听</span>
handle.<span class="hljs-title function_">stop</span>();
</code></pre>
<h3 data-id="heading-7">🚀 进阶优化：函数重载实现类型安全</h3>
<p>基础版本虽然功能完整，但在 TypeScript 环境下使用时缺乏类型提示，这会影响开发体验。为了解决这个问题，我们可以利用 TypeScript 的<strong>函数重载</strong>特性。</p>
<h4 data-id="heading-8">函数重载的定义</h4>
<p>函数重载允许我们为同一个函数提供多个类型定义，TypeScript 会根据传入的参数类型自动选择匹配的重载版本。</p>
<h4 data-id="heading-9">类型安全版本实现</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { watch, unref, <span class="hljs-title class_">Ref</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-comment">// 重载1：给window绑定事件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useEventListener&lt;K <span class="hljs-keyword">extends</span> keyof <span class="hljs-title class_">WindowEventMap</span>&gt;(
  <span class="hljs-attr">type</span>: K,
  <span class="hljs-attr">handle</span>: <span class="hljs-function">(<span class="hljs-params">event: WindowEventMap[K]</span>) =&gt;</span> <span class="hljs-built_in">void</span>,
  options?: <span class="hljs-built_in">boolean</span> | <span class="hljs-title class_">AddEventListenerOptions</span>
);

<span class="hljs-comment">// 重载2：给指定DOM元素绑定事件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useEventListener&lt;K <span class="hljs-keyword">extends</span> keyof <span class="hljs-title class_">HTMLElementEventMap</span>&gt;(
  <span class="hljs-attr">target</span>: <span class="hljs-title class_">Ref</span>&lt;<span class="hljs-title class_">HTMLElement</span> | <span class="hljs-literal">null</span>&gt;,
  <span class="hljs-attr">type</span>: K,
  <span class="hljs-attr">handle</span>: <span class="hljs-function">(<span class="hljs-params">event: HTMLElementEventMap[K]</span>) =&gt;</span> <span class="hljs-built_in">void</span>,
  options?: <span class="hljs-built_in">boolean</span> | <span class="hljs-title class_">AddEventListenerOptions</span>
);

<span class="hljs-comment">// 通用实现</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useEventListener</span>(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) {
  <span class="hljs-comment">// 判断目标：如果第一个参数是字符串，则目标为window；否则为传入的DOM元素</span>
  <span class="hljs-keyword">const</span> target = <span class="hljs-keyword">typeof</span> args[<span class="hljs-number">0</span>] === <span class="hljs-string">"string"</span> ? <span class="hljs-variable language_">window</span> : args.<span class="hljs-title function_">shift</span>();

  <span class="hljs-comment">// 使用watch监听目标元素的变化</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">watch</span>(
    <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">unref</span>(target),
    <span class="hljs-function">(<span class="hljs-params">element, _, onClear</span>) =&gt;</span> {
      <span class="hljs-comment">// 处理DOM不存在的情况（如v-if初始为false）</span>
      <span class="hljs-keyword">if</span> (!element) <span class="hljs-keyword">return</span>;

      <span class="hljs-comment">// 绑定事件</span>
      element.<span class="hljs-title function_">addEventListener</span>(...args);

      <span class="hljs-comment">// 清理函数：在组件卸载或watch停止时执行</span>
      <span class="hljs-title function_">onClear</span>(<span class="hljs-function">() =&gt;</span> {
        element.<span class="hljs-title function_">removeEventListener</span>(...args);
      });
    },
    {
      <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 立即执行</span>
    }
  );
}
</code></pre>
<h4 data-id="heading-10">类型重载的优势</h4>
<ol>
<li><strong>智能提示</strong>：IDE 会根据传入的参数类型提供对应的事件名称和事件对象类型提示</li>
<li><strong>类型检查</strong>：TypeScript 会检查事件处理函数的参数类型是否正确</li>
<li><strong>错误预防</strong>：避免传入不存在的事件类型或错误的事件处理函数签名</li>
</ol>
<h3 data-id="heading-11">🎯 技术深度解析</h3>
<h4 data-id="heading-12">1. Watch API 的高级用法</h4>
<p>在这个 Hook 中，我们充分利用了 Vue3 <code>watch</code> API 的高级特性：</p>
<ul>
<li><strong>响应式监听</strong>：通过<code>unref(target)</code>确保可以同时处理 ref 和普通值</li>
<li><strong>immediate 选项</strong>：确保组件挂载后立即绑定事件</li>
<li><strong>onClear 回调</strong>：提供了可靠的清理机制，避免内存泄漏</li>
</ul>
<h4 data-id="heading-13">2. TypeScript 类型系统的强大</h4>
<ul>
<li><strong>事件映射类型</strong>：<code>WindowEventMap</code>和<code>HTMLElementEventMap</code>提供了浏览器原生事件的完整类型定义</li>
<li><strong>泛型约束</strong>：使用<code>K extends keyof EventMap</code>确保事件类型的正确性</li>
<li><strong>函数重载</strong>：为不同的使用场景提供精确的类型定义</li>
</ul>
<h4 data-id="heading-14">3. 自动清理机制的原理</h4>
<p>当以下情况发生时，<code>onClear</code>回调会被自动调用：</p>
<ul>
<li>组件卸载时</li>
<li>调用返回的<code>stop</code>方法时</li>
<li>监听的目标元素发生变化时</li>
</ul>
<p>这种机制确保了事件监听始终与组件生命周期同步，彻底避免了内存泄漏。</p>
<h3 data-id="heading-15">📝 最佳实践与注意事项</h3>
<h4 data-id="heading-16">1. 事件处理函数的注意事项</h4>
<ul>
<li><strong>避免箭头函数陷阱</strong>：如果需要在事件处理函数中访问<code>this</code>，应使用普通函数</li>
<li><strong>事件对象的正确使用</strong>：利用 TypeScript 的类型系统确保事件对象的属性访问安全</li>
</ul>
<h4 data-id="heading-17">2. 性能优化建议</h4>
<ul>
<li><strong>事件委托</strong>：对于大量相似元素，优先考虑事件委托而不是为每个元素单独绑定事件</li>
<li><strong>合理使用事件选项</strong>：根据需要设置<code>passive</code>、<code>capture</code>等选项优化性能</li>
</ul>
<h4 data-id="heading-18">3. 扩展使用场景</h4>
<ul>
<li><strong>自定义事件</strong>：可以扩展支持自定义事件的类型定义</li>
<li><strong>组件事件</strong>：结合 Vue 的组件事件系统使用</li>
<li><strong>第三方库集成</strong>：与 Chart.js、Mapbox 等第三方库的事件系统集成</li>
</ul>
<h3 data-id="heading-19">🔧 实战案例：实时键盘监听</h3>
<p>让我们通过一个实际案例来展示<code>useEventListener</code>的强大功能：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;h2&gt;键盘监听演示&lt;/h2&gt;
    &lt;p&gt;当前按下的键：{{ pressedKey }}&lt;/p&gt;
    &lt;p&gt;按下次数：{{ pressCount }}&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from "vue";
import { useEventListener } from "./useEventListener";

const pressedKey = ref("");
const pressCount = ref(0);

// 使用通用事件监听Hook
useEventListener(
  "keydown",
  (event: KeyboardEvent) =&gt; {
    pressedKey.value = event.key;
    pressCount.value++;
  },
  { passive: true }
);
&lt;/script&gt;
</code></pre>
<p>这个示例展示了如何轻松实现一个实时键盘监听功能，无需手动管理事件的绑定与解绑。</p>
<h3 data-id="heading-20">📚 扩展阅读</h3>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fwatchers.html" target="_blank" title="https://vuejs.org/guide/essentials/watchers.html" ref="nofollow noopener noreferrer">Vue3 Composition API - Watch</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fdocs%2Fhandbook%2F2%2Ffunctions.html%23function-overloads" target="_blank" title="https://www.typescriptlang.org/docs/handbook/2/functions.html#function-overloads" ref="nofollow noopener noreferrer">TypeScript 函数重载</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventTarget%2FaddEventListener" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener" ref="nofollow noopener noreferrer">DOM 事件 API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FPerformance%2FMemory_management" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/Performance/Memory_management" ref="nofollow noopener noreferrer">前端内存泄漏排查与解决</a></li>
</ol>
<h3 data-id="heading-21">💭 思考题</h3>
<ol>
<li>如何扩展这个 Hook 以支持自定义事件类型？</li>
<li>如果需要同时监听多个事件，应该如何优化实现？</li>
<li>如何将这个 Hook 与 Vue 的响应式系统更好地结合？</li>
</ol>
<h3 data-id="heading-22">🎉 总结</h3>
<p>通过本文的介绍，我们学习了如何利用 Vue3 的<code>watch</code>API 和 TypeScript 的函数重载特性，打造一个类型安全、自动清理的通用事件监听 Hook。这个 Hook 不仅解决了原生事件绑定的痛点，还提供了良好的开发体验和类型支持。</p>
<p>核心技术点回顾：</p>
<ul>
<li><strong>函数重载</strong>：提供精确的类型定义和智能提示</li>
<li><strong>Watch API</strong>：实现响应式监听和自动清理</li>
<li><strong>自动管理</strong>：事件生命周期与组件同步，避免内存泄漏</li>
<li><strong>灵活使用</strong>：支持 window 和 DOM 元素，适应各种场景</li>
</ul>
<p>这个简单而强大的 Hook 展示了 Vue3 Composition API 的灵活性和 TypeScript 类型系统的强大，是我们在日常开发中值得掌握的高级技巧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[稳定性性能系列之二——ANR机制深度解析:从触发到上报]]></title>    <link>https://juejin.cn/post/7588034035287080975</link>    <guid>https://juejin.cn/post/7588034035287080975</guid>    <pubDate>2025-12-27T06:51:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588034035287080975" data-draft-id="7587776610437152783" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="稳定性性能系列之二——ANR机制深度解析:从触发到上报"/> <meta itemprop="keywords" content="性能优化,Android,Debug"/> <meta itemprop="datePublished" content="2025-12-27T06:51:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            稳定性性能系列之二——ANR机制深度解析:从触发到上报
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T06:51:24.000Z" title="Sat Dec 27 2025 06:51:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言:那个让人又爱又恨的ANR Dialog</h2>
<p>还记得第一次看到ANR Dialog吗?</p>
<p>"<strong>应用XX无响应,是否关闭?</strong>"</p>
<p>作为用户,这个对话框让人抓狂——应用卡住了,什么都做不了。但作为开发者,这个对话框却是救命稻草——至少它告诉你出问题了,还给你留下了traces.txt这个"作案现场"。</p>
<p>我曾经遇到过一个让人头疼的ANR:用户在设置界面切换WiFi时,整个系统界面就卡死了。看logcat,发现主线程在等一个锁;再看traces.txt,发现持锁的线程正在进行Binder调用;继续追踪,原来是ContentObserver注册过多导致的Binder资源耗尽...这就像一场侦探游戏,而ANR Dialog是案件的起点。</p>
<p>本文将带你深入ANR机制的内部,从Input事件分发到超时检测,从traces信息收集到Dialog弹出,完整剖析ANR的全生命周期。读完本文,你将能够:</p>
<ol>
<li>理解ANR的4种类型及其超时时间</li>
<li>掌握InputDispatcher如何检测Input ANR</li>
<li>了解ActivityManagerService如何处理ANR</li>
<li>学会分析traces.txt和找到根因</li>
<li>构建ANR监控和预防机制</li>
</ol>
<p>准备好了吗?让我们揭开ANR机制的神秘面纱!</p>
<hr/>
<h2 data-id="heading-1">一、ANR基础概念</h2>
<h3 data-id="heading-2">1.1 什么是ANR?</h3>
<p>ANR (Application Not Responding) 是Android系统的一种保护机制。当应用在规定时间内没有响应用户操作或系统事件时,系统会认为应用"死了",弹出ANR对话框让用户选择是继续等待还是强制关闭。</p>
<p>打个比方:ANR就像餐厅的"上菜超时提醒"。你点了一道菜,如果厨房5分钟还没上菜,服务员就会过来询问"要不要继续等,还是换一道菜"。这避免了你无限期地等下去。</p>
<p><strong>ANR的核心作用</strong>:</p>
<ul>
<li><strong>保护用户体验</strong>: 避免应用长时间无响应</li>
<li><strong>及时发现问题</strong>: 通过traces.txt记录"作案现场"</li>
<li><strong>系统自我保护</strong>: 防止单个应用拖垮整个系统</li>
</ul>
<h3 data-id="heading-3">1.2 ANR的4种类型</h3>
<p>Android系统对不同类型的事件设置了不同的超时时间:</p>



































<table><thead><tr><th>ANR类型</th><th>超时时间</th><th>触发场景</th><th>检测位置</th></tr></thead><tbody><tr><td><strong>Input ANR</strong></td><td>5秒</td><td>用户触摸/按键事件未被处理</td><td>InputDispatcher</td></tr><tr><td><strong>Broadcast ANR</strong></td><td>前台10秒 / 后台60秒</td><td>BroadcastReceiver的onReceive()未执行完</td><td>ActivityManagerService</td></tr><tr><td><strong>Service ANR</strong></td><td>前台20秒 / 后台200秒</td><td>Service的生命周期方法未执行完</td><td>ActivityManagerService</td></tr><tr><td><strong>ContentProvider ANR</strong></td><td>10秒</td><td>ContentProvider发布超时</td><td>ActivityManagerService</td></tr></tbody></table>
<p><strong>为什么超时时间不一样?</strong></p>
<p>这是基于用户体验和系统响应性的权衡:</p>
<ul>
<li><strong>Input ANR最短(5秒)</strong>: 用户操作必须得到快速反馈,否则会认为设备坏了</li>
<li><strong>Broadcast ANR中等(10秒/60秒)</strong>: 广播接收器本应该快速执行,但允许一定的处理时间</li>
<li><strong>Service ANR较长(20秒/200秒)</strong>: 后台服务可以处理耗时操作,给予更多宽容</li>
<li><strong>后台进程超时更长</strong>: 后台操作不影响前台体验,可以等待更久</li>
</ul>
<h3 data-id="heading-4">1.3 ANR vs Freeze vs Watchdog</h3>
<p>经常有人混淆这几个概念,让我们对比一下:</p>









































<table><thead><tr><th>特性</th><th>ANR</th><th>Freeze</th><th>Watchdog</th></tr></thead><tbody><tr><td><strong>检测对象</strong></td><td>应用进程</td><td>应用进程</td><td>System Server</td></tr><tr><td><strong>检测维度</strong></td><td>特定事件响应</td><td>整体响应性</td><td>核心线程健康</td></tr><tr><td><strong>超时时间</strong></td><td>5-200秒</td><td>通常小于秒</td><td>30-60秒</td></tr><tr><td><strong>后果</strong></td><td>弹出ANR Dialog</td><td>可能触发ANR</td><td>系统重启</td></tr><tr><td><strong>作用域</strong></td><td>单个应用</td><td>单个应用</td><td>整个系统</td></tr></tbody></table>
<p><strong>形象的比喻</strong>:</p>
<ul>
<li><strong>ANR</strong>: 餐厅服务员检查你点的菜是否上齐了</li>
<li><strong>Freeze</strong>: 餐厅经理监控服务员是否在工作</li>
<li><strong>Watchdog</strong>: 消防队定时巡查餐厅的消防系统是否正常</li>
</ul>
<hr/>
<h2 data-id="heading-5">二、Input ANR的完整流程</h2>
<p>Input ANR是最常见也是最典型的ANR类型。让我们通过一个用户点击按钮的场景,完整走一遍ANR的检测流程。</p>
<h3 data-id="heading-6">2.1 整体流程概览</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3890f02135fe40e5a0a4cb7daaffa516~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767424897&amp;x-signature=fPgI6qx%2BkPMhB9PzmnCNj7VOoBo%3D" alt="02-01-anr-input-flow.png" loading="lazy"/></p>
<h3 data-id="heading-7">2.2 InputReader:事件的源头</h3>
<p>InputReader运行在一个独立的线程中,负责从内核读取输入事件:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// frameworks/native/services/inputflinger/reader/InputReader.cpp</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InputReader::loopOnce</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 从/dev/input/eventX读取原始事件</span>
    <span class="hljs-type">size_t</span> count = mEventHub-&gt;<span class="hljs-built_in">getEvents</span>(timeoutMillis, mEventBuffer, EVENT_BUFFER_SIZE);

    <span class="hljs-comment">// 2. 处理每个事件</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
        <span class="hljs-type">const</span> RawEvent&amp; rawEvent = mEventBuffer[i];

        <span class="hljs-comment">// 3. 根据设备类型(触摸屏、键盘等)转换为Android事件</span>
        <span class="hljs-built_in">processEventsLocked</span>(rawEvent);
    }

    <span class="hljs-comment">// 4. 将处理好的事件交给InputDispatcher</span>
    mQueuedListener-&gt;<span class="hljs-built_in">flush</span>();
}
</code></pre>
<p><strong>关键点</strong>:</p>
<ul>
<li>InputReader是事件的"搬运工",只负责读取和初步处理</li>
<li>它不关心事件是否被应用处理,只管往前送</li>
<li>真正的超时检测发生在InputDispatcher</li>
</ul>
<h3 data-id="heading-8">2.3 InputDispatcher:超时检测的核心</h3>
<p>InputDispatcher是ANR检测的"心脏"。让我们看看它如何检测超时:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// frameworks/native/services/inputflinger/dispatcher/InputDispatcher.cpp</span>

<span class="hljs-comment">// 分发事件的核心逻辑</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InputDispatcher::dispatchOnce</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">nsecs_t</span> nextWakeupTime = LONG_LONG_MAX;

    <span class="hljs-comment">// 1. 从队列中取出待分发的事件</span>
    <span class="hljs-keyword">if</span> (mPendingEvent == <span class="hljs-literal">nullptr</span>) {
        mPendingEvent = mInboundQueue.<span class="hljs-built_in">dequeueAtHead</span>();
    }

    <span class="hljs-comment">// 2. 找到事件的目标Window</span>
    std::vector&lt;InputTarget&gt; inputTargets;
    <span class="hljs-type">int32_t</span> injectionResult = <span class="hljs-built_in">findFocusedWindowTargetsLocked</span>(
            currentTime, mPendingEvent, inputTargets, nextWakeupTime);

    <span class="hljs-comment">// 3. 分发事件到目标Window</span>
    <span class="hljs-keyword">if</span> (injectionResult == INPUT_EVENT_INJECTION_SUCCEEDED) {
        <span class="hljs-built_in">dispatchEventLocked</span>(currentTime, mPendingEvent, inputTargets);
    }

    <span class="hljs-comment">// 4. 检查是否有连接超时</span>
    <span class="hljs-type">nsecs_t</span> nextAnrCheck = <span class="hljs-built_in">checkUnresponsiveConnectionsLocked</span>(currentTime);
    <span class="hljs-keyword">if</span> (nextAnrCheck &lt; nextWakeupTime) {
        nextWakeupTime = nextAnrCheck;
    }
}
</code></pre>
<p><strong>超时检测的关键逻辑</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 检查连接是否响应</span>
<span class="hljs-function"><span class="hljs-type">nsecs_t</span> <span class="hljs-title">InputDispatcher::checkUnresponsiveConnectionsLocked</span><span class="hljs-params">(<span class="hljs-type">nsecs_t</span> currentTime)</span> </span>{
    <span class="hljs-type">nsecs_t</span> nextAnrCheck = LONG_LONG_MAX;

    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; [token, connection] : mConnectionsByToken) {
        <span class="hljs-comment">// 检查这个连接的等待队列</span>
        <span class="hljs-keyword">if</span> (connection-&gt;waitQueue.<span class="hljs-built_in">empty</span>()) {
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 获取队头事件</span>
        DispatchEntry* head = connection-&gt;waitQueue.head;
        <span class="hljs-type">nsecs_t</span> eventTime = head-&gt;eventEntry-&gt;eventTime;

        <span class="hljs-comment">// 计算等待时间</span>
        <span class="hljs-type">nsecs_t</span> waitDuration = currentTime - eventTime;

        <span class="hljs-comment">// 如果超过5秒(5000ms),触发ANR</span>
        <span class="hljs-keyword">if</span> (waitDuration &gt; <span class="hljs-number">5000</span>ms) {
            <span class="hljs-built_in">onAnrLocked</span>(connection);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 记录下次检查时间</span>
            <span class="hljs-type">nsecs_t</span> timeoutTime = eventTime + <span class="hljs-number">5000</span>ms;
            <span class="hljs-keyword">if</span> (timeoutTime &lt; nextAnrCheck) {
                nextAnrCheck = timeoutTime;
            }
        }
    }

    <span class="hljs-keyword">return</span> nextAnrCheck;
}
</code></pre>
<p><strong>精妙的设计</strong>:</p>
<ol>
<li><strong>事件入队列时记录时间戳</strong>: 每个事件分发时,都会记录<code>eventTime</code></li>
<li><strong>定时检查队头事件</strong>: InputDispatcher会定期检查waitQueue的队头</li>
<li><strong>计算等待时长</strong>: <code>waitDuration = currentTime - eventTime</code></li>
<li><strong>超时触发ANR</strong>: 如果等待超过5秒,调用<code>onAnrLocked()</code></li>
</ol>
<p><strong>为什么检查队头而不是队尾?</strong></p>
<p>因为队头是最早发送的事件,如果队头都还没处理完,说明应用真的卡住了。这就像排队买票:如果队伍最前面的人还在办理,后面的人自然也走不了。</p>
<h3 data-id="heading-9">2.4 等待队列(waitQueue)的秘密</h3>
<p>理解waitQueue是理解Input ANR的关键:</p>
<pre><code class="hljs language-ini" lang="ini">waitQueue的生命周期:

1. 事件发送前
   waitQueue: <span class="hljs-section">[]</span>

2. 事件发送给应用
   dispatchEntry入队
   waitQueue: <span class="hljs-section">[Event1]</span>
   记录<span class="hljs-attr">Event1.eventTime</span> = T0

3. 应用处理事件(正常情况)
   应用调用finish()
   waitQueue: <span class="hljs-section">[]</span>  ← Event1被移除

4. 应用卡住(异常情况)
   T0 + 5秒后
   waitQueue: <span class="hljs-section">[Event1]</span>  ← Event1还在!
   InputDispatcher检测到超时
   触发ANR
</code></pre>
<p><strong>代码实现</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 应用处理完事件后调用</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InputDispatcher::finishDispatchCycleLocked</span><span class="hljs-params">(
        <span class="hljs-type">nsecs_t</span> currentTime, sp&lt;Connection&gt; connection)</span> </span>{
    <span class="hljs-comment">// 从waitQueue移除已处理的事件</span>
    <span class="hljs-keyword">while</span> (!connection-&gt;waitQueue.<span class="hljs-built_in">empty</span>()) {
        DispatchEntry* dispatchEntry = connection-&gt;waitQueue.head;
        connection-&gt;waitQueue.<span class="hljs-built_in">dequeue</span>(dispatchEntry);

        <span class="hljs-comment">// 释放资源</span>
        <span class="hljs-built_in">releaseDispatchEntry</span>(dispatchEntry);

        <span class="hljs-comment">// 如果这是最后一个事件,重置超时检查</span>
        <span class="hljs-keyword">if</span> (connection-&gt;waitQueue.<span class="hljs-built_in">empty</span>()) {
            connection-&gt;lastEventTime = LLONG_MIN;
        }
    }
}
</code></pre>
<h3 data-id="heading-10">2.5 ANR分析示例</h3>
<p>让我们看一个真实的Input ANR场景的分析简化:</p>
<p><strong>场景</strong>: 用户在列表界面快速滑动,突然应用无响应</p>
<p><strong>logcat日志</strong>:</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-number">12</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">30</span>:<span class="hljs-number">15.123</span>  <span class="hljs-number">1234</span>  <span class="hljs-number">1250</span> E InputDispatcher: channel <span class="hljs-string">'e8d3a72 com.example.app/com.example.app.MainActivity (server)'</span> ~ Channel <span class="hljs-keyword">is</span> unresponsive! Waited <span class="hljs-number">5008</span>ms
<span class="hljs-number">12</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">30</span>:<span class="hljs-number">15.234</span>  <span class="hljs-number">1234</span>  <span class="hljs-number">1250</span> I InputDispatcher: Delivering ANR to com.example.app
</code></pre>
<p><strong>traces.txt片段</strong>:</p>
<pre><code class="hljs language-ini" lang="ini">"main" <span class="hljs-attr">prio</span>=<span class="hljs-number">5</span> tid=<span class="hljs-number">1</span> Blocked
  | <span class="hljs-attr">group</span>=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0</span>x74e04dd8 self=<span class="hljs-number">0</span>x7a4e014c00
  | <span class="hljs-attr">sysTid</span>=<span class="hljs-number">12345</span> nice=-<span class="hljs-number">10</span> cgrp=default sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0</span>x7b5a9f49a8
  | <span class="hljs-attr">state</span>=S schedstat=( <span class="hljs-number">15678923456</span> <span class="hljs-number">8765432109</span> <span class="hljs-number">1234</span> ) utm=<span class="hljs-number">1500</span> stm=<span class="hljs-number">67</span> core=<span class="hljs-number">2</span> HZ=<span class="hljs-number">100</span>
  at com.example.app.RecyclerAdapter.onBindViewHolder(RecyclerAdapter.java:150)
  - waiting to lock &lt;0x0a1b2c3d&gt; (a java.lang.Object) held by thread 15
  at android.support.v7.widget.RecyclerView.dispatchLayout(RecyclerView.java:3500)
  at android.support.v7.widget.RecyclerView.onLayout(RecyclerView.java:4064)
  at android.view.View.layout(View.java:19839)
  ...
</code></pre>
<p><strong>根因分析</strong>:</p>
<ol>
<li><strong>现象</strong>: 主线程被阻塞,状态是<code>Blocked</code></li>
<li><strong>位置</strong>: 卡在<code>RecyclerAdapter.onBindViewHolder()</code></li>
<li><strong>原因</strong>: 主线程在等待一个锁<code>&lt;0x0a1b2c3d&gt;</code>,这个锁被线程15持有</li>
<li><strong>解决</strong>: 找到线程15在干什么,解开死锁</li>
</ol>
<p><strong>关键教训</strong>:</p>
<ul>
<li>永远不要在主线程中等待锁</li>
<li>RecyclerView的Adapter中不要做耗时操作</li>
<li>复杂的数据处理应该在后台线程完成</li>
</ul>
<hr/>
<h2 data-id="heading-11">三、Broadcast ANR的检测机制</h2>
<p>相比Input ANR的"被动检测"(等事件处理完),Broadcast ANR采用"主动检测"(主动设置超时)。</p>
<h3 data-id="heading-12">3.1 广播分发流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c48bed15aa364a7388b593fb3fa3dbc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767424897&amp;x-signature=5AJxmL0s40v4PxwnY7YHWuJ7aXs%3D" alt="02-02-broadcast-anr-flow.png" loading="lazy"/></p>
<h3 data-id="heading-13">3.2 超时定时器的实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/am/BroadcastQueue.java</span>

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processCurBroadcastLocked</span><span class="hljs-params">(BroadcastRecord r, ProcessRecord app)</span> {
    <span class="hljs-comment">// 1. 设置超时时间</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> r.isForeground() ?
            BROADCAST_FG_TIMEOUT : BROADCAST_BG_TIMEOUT;

    <span class="hljs-comment">// 2. 发送延时消息</span>
    mHandler.sendMessageDelayed(
            mHandler.obtainMessage(BROADCAST_TIMEOUT_MSG, r),
            timeout);

    <span class="hljs-comment">// 3. 调用receiver的onReceive()</span>
    app.thread.scheduleReceiver(...);
}

<span class="hljs-comment">// Handler处理超时消息</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
    <span class="hljs-keyword">switch</span> (msg.what) {
        <span class="hljs-keyword">case</span> BROADCAST_TIMEOUT_MSG:
            <span class="hljs-type">BroadcastRecord</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> (BroadcastRecord) msg.obj;
            <span class="hljs-comment">// 触发ANR</span>
            broadcastTimeoutLocked(r, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">break</span>;
    }
}

<span class="hljs-comment">// 广播执行完毕后取消超时</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performReceiveLocked</span><span class="hljs-params">(ProcessRecord app, ...)</span> {
    <span class="hljs-comment">// 1. 执行完毕</span>
    r.receiver = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 2. 取消超时消息</span>
    mHandler.removeMessages(BROADCAST_TIMEOUT_MSG, r);

    <span class="hljs-comment">// 3. 继续处理下一个广播</span>
    processCurBroadcastLocked(r, app);
}
</code></pre>
<p><strong>关键点</strong>:</p>
<ul>
<li>使用Handler的延时消息实现超时检测</li>
<li>如果在超时前完成,<code>removeMessages()</code>取消定时器</li>
<li>如果超时,Handler收到消息,触发ANR</li>
</ul>
<h3 data-id="heading-14">3.3 前台 vs 后台广播的区别</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 超时时间定义</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BROADCAST_FG_TIMEOUT</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> * <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 10秒</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BROADCAST_BG_TIMEOUT</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 60秒</span>

<span class="hljs-comment">// 如何判断前台还是后台?</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">isForeground</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 广播发送时指定了FLAG_RECEIVER_FOREGROUND</span>
    <span class="hljs-keyword">if</span> ((intent.getFlags() &amp; Intent.FLAG_RECEIVER_FOREGROUND) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">// 2. 接收进程是前台进程</span>
    <span class="hljs-keyword">if</span> (app.setAdj &lt;= ProcessList.PERCEPTIBLE_APP_ADJ) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">// 3. 有序广播的当前接收者是前台</span>
    <span class="hljs-keyword">if</span> (ordered &amp;&amp; curReceiver.priority &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p><strong>实战案例</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 案例:一个耗时的BroadcastReceiver</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> {
        <span class="hljs-comment">// ❌ 错误:在主线程做耗时操作</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
            <span class="hljs-comment">// 大量计算</span>
        }
        <span class="hljs-comment">// 如果超过10秒,触发ANR</span>
    }
}

<span class="hljs-comment">// ✅ 正确做法:使用goAsync()</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> {
        <span class="hljs-comment">// 1. 获取PendingResult</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">PendingResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> goAsync();

        <span class="hljs-comment">// 2. 在子线程处理</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 耗时操作</span>
                doHeavyWork();
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 3. 完成后通知系统</span>
                result.finish();
            }
        }).start();
    }
}
</code></pre>
<p><strong>goAsync()的作用</strong>:</p>
<ul>
<li>告诉系统"我需要异步处理,别急着超时"</li>
<li>系统会延长超时时间(但仍有上限)</li>
<li>必须在完成后调用<code>result.finish()</code></li>
</ul>
<hr/>
<h2 data-id="heading-15">四、Service ANR的检测机制</h2>
<p>Service ANR的检测逻辑与Broadcast类似,但更复杂,因为Service有多个生命周期方法需要监控。</p>
<h3 data-id="heading-16">4.1 Service生命周期的超时监控</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/am/ActiveServices.java</span>

<span class="hljs-comment">// Service启动超时检测</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bringUpServiceLocked</span><span class="hljs-params">(ServiceRecord r, ...)</span> {
    <span class="hljs-comment">// 1. 设置超时时间</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> r.isForeground() ?
            SERVICE_TIMEOUT : SERVICE_BACKGROUND_TIMEOUT;

    <span class="hljs-comment">// 2. 发送超时消息</span>
    mAm.mHandler.sendMessageDelayed(
            mAm.mHandler.obtainMessage(SERVICE_TIMEOUT_MSG, r),
            timeout);

    <span class="hljs-comment">// 3. 启动Service</span>
    app.thread.scheduleCreateService(r, ...);
}

<span class="hljs-comment">// Service生命周期方法执行完毕</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serviceDoneExecutingLocked</span><span class="hljs-params">(ServiceRecord r, ...)</span> {
    <span class="hljs-comment">// 1. 取消超时消息</span>
    mAm.mHandler.removeMessages(SERVICE_TIMEOUT_MSG, r);

    <span class="hljs-comment">// 2. 更新Service状态</span>
    r.executeNesting--;
    <span class="hljs-keyword">if</span> (r.executeNesting &lt;= <span class="hljs-number">0</span>) {
        r.executing = <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<p><strong>监控的生命周期方法</strong>:</p>
<ul>
<li><code>onCreate()</code>: Service创建</li>
<li><code>onStartCommand()</code>: Service启动</li>
<li><code>onBind()</code>: Service绑定</li>
<li><code>onUnbind()</code>: Service解绑</li>
<li><code>onDestroy()</code>: Service销毁</li>
</ul>
<h3 data-id="heading-17">4.2 前台Service的特殊处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 前台Service的超时时间更短</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SERVICE_TIMEOUT</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span> * <span class="hljs-number">1000</span>;       <span class="hljs-comment">// 20秒</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SERVICE_BACKGROUND_TIMEOUT</span> <span class="hljs-operator">=</span> <span class="hljs-number">200</span> * <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 200秒</span>

<span class="hljs-comment">// 启动前台Service的正确姿势</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();

        <span class="hljs-comment">// 在onCreate()中尽快调用startForeground()</span>
        <span class="hljs-comment">// 否则可能触发ANR</span>
        <span class="hljs-type">Notification</span> <span class="hljs-variable">notification</span> <span class="hljs-operator">=</span> createNotification();
        startForeground(NOTIFICATION_ID, notification);

        <span class="hljs-comment">// 然后再做其他初始化</span>
        initializeResources();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">onStartCommand</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> startId)</span> {
        <span class="hljs-comment">// 如果有耗时操作,放到子线程</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            doHeavyWork();
        }).start();

        <span class="hljs-keyword">return</span> START_STICKY;
    }
}
</code></pre>
<p><strong>为什么前台Service超时时间短?</strong></p>
<p>因为前台Service通常与用户当前的操作相关(如音乐播放、导航),必须快速启动,否则影响用户体验。</p>
<h3 data-id="heading-18">4.3 IntentService的超时问题</h3>
<p>IntentService是一个特殊的Service,它自带工作线程:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// IntentService的内部实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntentService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Looper mServiceLooper;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> ServiceHandler mServiceHandler;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();
        <span class="hljs-comment">// 创建工作线程</span>
        <span class="hljs-type">HandlerThread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerThread</span>(<span class="hljs-string">"IntentService["</span> + mName + <span class="hljs-string">"]"</span>);
        thread.start();

        mServiceLooper = thread.getLooper();
        mServiceHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceHandler</span>(mServiceLooper);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">onStartCommand</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> startId)</span> {
        <span class="hljs-comment">// 将任务发送到工作线程</span>
        <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> mServiceHandler.obtainMessage();
        msg.arg1 = startId;
        msg.obj = intent;
        mServiceHandler.sendMessage(msg);
        <span class="hljs-keyword">return</span> START_REDELIVER_INTENT;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">ServiceHandler</span><span class="hljs-params">(Looper looper)</span> {
            <span class="hljs-built_in">super</span>(looper);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
            <span class="hljs-comment">// 在工作线程调用onHandleIntent()</span>
            onHandleIntent((Intent)msg.obj);
            stopSelf(msg.arg1);
        }
    }

    <span class="hljs-comment">// 子类实现这个方法</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onHandleIntent</span><span class="hljs-params">(Intent intent)</span>;
}
</code></pre>
<p><strong>重要细节</strong>:</p>
<ul>
<li><code>onStartCommand()</code>在主线程,但很快返回</li>
<li><code>onHandleIntent()</code>在工作线程,可以耗时</li>
<li>不会触发Service ANR,因为主线程方法都很快</li>
</ul>
<p><strong>但是要注意<code>onCreate()</code>!</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误:在onCreate()中初始化耗时资源</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyIntentService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IntentService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();
        <span class="hljs-comment">// 这里仍然在主线程!</span>
        loadLargeDatabase();  <span class="hljs-comment">// 可能触发ANR</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onHandleIntent</span><span class="hljs-params">(Intent intent)</span> {
        <span class="hljs-comment">// 这里在工作线程,可以耗时</span>
        processData();
    }
}

<span class="hljs-comment">// ✅ 正确:耗时初始化也放到工作线程</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyIntentService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IntentService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();
        <span class="hljs-comment">// 只做轻量级初始化</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onHandleIntent</span><span class="hljs-params">(Intent intent)</span> {
        <span class="hljs-comment">// 第一次调用时再初始化</span>
        <span class="hljs-keyword">if</span> (!initialized) {
            loadLargeDatabase();
            initialized = <span class="hljs-literal">true</span>;
        }
        processData();
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-19">五、ANR信息的收集与上报</h2>
<p>当InputDispatcher或AMS检测到ANR后,会触发一系列的信息收集操作。这些信息对于分析ANR至关重要。</p>
<h3 data-id="heading-20">5.1 ANR触发和信息搜集流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/788e0de317454e1d92142ac1afa051e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767424897&amp;x-signature=lbufZe1kQrFeVIcdhM766moZHiM%3D" alt="02-03-anr-collection-flow.png" loading="lazy"/></p>
<h3 data-id="heading-21">5.2 appNotResponding()的实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/am/ProcessRecord.java</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">appNotResponding</span><span class="hljs-params">(String activityShortComponentName, ApplicationInfo aInfo,
        String parentShortComponentName, WindowProcessController parentProcess,
        <span class="hljs-type">boolean</span> aboveSystem, String annotation)</span> {

    <span class="hljs-comment">// 1. 防止重复ANR</span>
    <span class="hljs-keyword">synchronized</span> (mService) {
        <span class="hljs-keyword">if</span> (mNotResponding) {
            Slog.w(TAG, <span class="hljs-string">"App already notresponding: "</span> + <span class="hljs-built_in">this</span>);
            <span class="hljs-keyword">return</span>;
        }
        mNotResponding = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// 2. 记录ANR信息</span>
        mNotRespondingReport = generateErrorReport(
                annotation, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">// 3. 收集CPU使用情况</span>
    updateCpuStatsNow();

    <span class="hljs-comment">// 4. 输出到logcat</span>
    Slog.e(TAG, <span class="hljs-string">"ANR in "</span> + processName + <span class="hljs-string">" ("</span> + activityShortComponentName + <span class="hljs-string">")"</span>);
    Slog.e(TAG, <span class="hljs-string">"PID: "</span> + pid);
    Slog.e(TAG, <span class="hljs-string">"Reason: "</span> + annotation);
    Slog.e(TAG, <span class="hljs-string">"Load: "</span> + loadAverage);
    Slog.e(TAG, <span class="hljs-string">"CPU usage from "</span> + cpuUsageStart + <span class="hljs-string">"ms to "</span> + cpuUsageEnd + <span class="hljs-string">"ms later:"</span>);
    Slog.e(TAG, cpuUsageString);

    <span class="hljs-comment">// 5. dump所有相关线程堆栈</span>
    ArrayList&lt;Integer&gt; firstPids = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-number">5</span>);
    firstPids.add(pid);  <span class="hljs-comment">// ANR进程</span>
    firstPids.add(Process.myPid());  <span class="hljs-comment">// System Server</span>

    <span class="hljs-type">File</span> <span class="hljs-variable">tracesFile</span> <span class="hljs-operator">=</span> ActivityManagerService.dumpStackTraces(
            firstPids, processCpuTracker, ...);

    <span class="hljs-comment">// 6. 写入DropBox</span>
    mService.addErrorToDropBox(<span class="hljs-string">"anr"</span>, <span class="hljs-built_in">this</span>, processName, activityShortComponentName,
            parentShortComponentName, parentProcess, annotation,
            cpuUsageString, tracesFile, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 7. 弹出ANR Dialog</span>
    <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Message.obtain();
    msg.what = ActivityManagerService.SHOW_NOT_RESPONDING_UI_MSG;
    msg.obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppNotRespondingDialog</span>.Data(<span class="hljs-built_in">this</span>, aInfo, aboveSystem);
    mService.mUiHandler.sendMessage(msg);
}
</code></pre>
<h3 data-id="heading-22">5.3 traces.txt的生成</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> File <span class="hljs-title function_">dumpStackTraces</span><span class="hljs-params">(ArrayList&lt;Integer&gt; firstPids,
        ProcessCpuTracker processCpuTracker, ...)</span> {

    <span class="hljs-comment">// 1. 创建traces文件</span>
    <span class="hljs-type">File</span> <span class="hljs-variable">tracesFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"/data/anr/traces.txt"</span>);

    <span class="hljs-comment">// 2. dump第一批进程(ANR进程和System Server)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> pid : firstPids) {
        dumpJavaTracesTombstoned(pid, tracesFile, timeout);
    }

    <span class="hljs-comment">// 3. dump Native进程(如果ANR进程有native线程)</span>
    <span class="hljs-keyword">if</span> (DEBUG_ANR) {
        dumpNativeBacktraceToFile(pid, tracesFile);
    }

    <span class="hljs-comment">// 4. dump其他重要进程</span>
    ArrayList&lt;Integer&gt; extraPids = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-comment">// 4.1 最近使用的3个应用</span>
    <span class="hljs-keyword">if</span> (lastPids != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; lastPids.size() &amp;&amp; i &lt; <span class="hljs-number">3</span>; i++) {
            extraPids.add(lastPids.get(i));
        }
    }

    <span class="hljs-comment">// 4.2 所有persistent进程</span>
    <span class="hljs-keyword">synchronized</span> (mPidsSelfLocked) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mPidsSelfLocked.size(); i++) {
            <span class="hljs-type">ProcessRecord</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> mPidsSelfLocked.valueAt(i);
            <span class="hljs-keyword">if</span> (r.persistent) {
                extraPids.add(r.pid);
            }
        }
    }

    <span class="hljs-comment">// 4.3 dump这些进程</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> pid : extraPids) {
        dumpJavaTracesTombstoned(pid, tracesFile, timeout);
    }

    <span class="hljs-keyword">return</span> tracesFile;
}
</code></pre>
<p><strong>traces.txt的结构</strong>:</p>
<pre><code class="hljs language-ini" lang="ini">----- pid 12345 at 2024-12-25 10:30:15 -----
Cmd line: com.example.app
Build fingerprint: 'google/sdk_gphone_x86_64/generic_x86_64:11/RSR1.201013.001/6903271:user/release-keys'
ABI: 'x86_64'
...

"main" <span class="hljs-attr">prio</span>=<span class="hljs-number">5</span> tid=<span class="hljs-number">1</span> Blocked
  | <span class="hljs-attr">group</span>=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0</span>x74e04dd8
  | <span class="hljs-attr">sysTid</span>=<span class="hljs-number">12345</span> nice=-<span class="hljs-number">10</span> cgrp=default sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0</span>x7b5a9f49a8
  | <span class="hljs-attr">state</span>=S schedstat=( <span class="hljs-number">15678923456</span> <span class="hljs-number">8765432109</span> <span class="hljs-number">1234</span> ) utm=<span class="hljs-number">1500</span> stm=<span class="hljs-number">67</span>
  at com.example.app.MainActivity.onClick(MainActivity.java:150)
  - waiting to lock &lt;0x0a1b2c3d&gt; (a java.lang.Object) held by thread 15
  at android.view.View.performClick(View.java:7125)
  ...

"Thread-15" <span class="hljs-attr">prio</span>=<span class="hljs-number">5</span> tid=<span class="hljs-number">15</span> Native
  | <span class="hljs-attr">group</span>=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0</span>x13579bdf
  | <span class="hljs-attr">sysTid</span>=<span class="hljs-number">12360</span> nice=<span class="hljs-number">0</span> cgrp=default sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0</span>x7a4e028800
  at android.os.BinderProxy.transactNative(Native Method)
  - locked &lt;0x0a1b2c3d&gt; (a java.lang.Object)
  at android.os.BinderProxy.transact(Binder.java:1129)
  ...

"Binder:12345_2" <span class="hljs-attr">prio</span>=<span class="hljs-number">5</span> tid=<span class="hljs-number">12</span> Native
  ...

----- end 12345 -----
</code></pre>
<p><strong>关键信息解读</strong>:</p>
<ul>
<li><strong>Cmd line</strong>: 进程名称</li>
<li><strong>tid</strong>: 线程ID</li>
<li><strong>状态</strong>: Blocked/Native/Waiting/Runnable</li>
<li><strong>堆栈</strong>: Java方法调用链</li>
<li><strong>锁信息</strong>: <code>waiting to lock &lt;地址&gt;</code> 或 <code>locked &lt;地址&gt;</code></li>
</ul>
<h3 data-id="heading-23">5.4 DropBox:ANR的"黑匣子"</h3>
<p>DropBox是Android的系统日志服务,专门用于存储系统异常事件:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 写入DropBox</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">addErrorToDropBox</span><span class="hljs-params">(String eventType, ProcessRecord process,
        String processName, String activityShortComponentName, ...)</span> {

    <span class="hljs-comment">// 1. 构建DropBox条目</span>
    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-number">1024</span>);
    sb.append(<span class="hljs-string">"Process: "</span>).append(processName).append(<span class="hljs-string">"\n"</span>);
    sb.append(<span class="hljs-string">"PID: "</span>).append(process.pid).append(<span class="hljs-string">"\n"</span>);
    sb.append(<span class="hljs-string">"Reason: "</span>).append(annotation).append(<span class="hljs-string">"\n"</span>);
    sb.append(<span class="hljs-string">"Load: "</span>).append(loadAverage).append(<span class="hljs-string">"\n"</span>);
    sb.append(cpuUsageString);

    <span class="hljs-comment">// 2. 添加traces内容</span>
    <span class="hljs-keyword">if</span> (tracesFile != <span class="hljs-literal">null</span>) {
        sb.append(<span class="hljs-string">"\n\n*** TRACES ***\n"</span>);
        sb.append(FileUtils.readTextFile(tracesFile, DROPBOX_MAX_SIZE, <span class="hljs-string">"..."</span>));
    }

    <span class="hljs-comment">// 3. 写入DropBox</span>
    <span class="hljs-type">DropBoxManager</span> <span class="hljs-variable">dbox</span> <span class="hljs-operator">=</span> mContext.getSystemService(DropBoxManager.class);
    dbox.addText(eventType, sb.toString());
}
</code></pre>
<p><strong>查看DropBox内容</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出所有ANR记录</span>
adb shell dumpsys dropbox --<span class="hljs-built_in">print</span> anr

<span class="hljs-comment"># 导出最近的ANR</span>
adb shell dumpsys dropbox --<span class="hljs-built_in">print</span> anr &gt; anr_dropbox.txt

<span class="hljs-comment"># 清空DropBox</span>
adb shell dumpsys dropbox --wipe
</code></pre>
<p><strong>DropBox vs traces.txt</strong>:</p>



































<table><thead><tr><th>特性</th><th>DropBox</th><th>traces.txt</th></tr></thead><tbody><tr><td>存储位置</td><td><code>/data/system/dropbox</code></td><td><code>/data/anr/</code></td></tr><tr><td>存储格式</td><td>结构化条目</td><td>纯文本</td></tr><tr><td>容量限制</td><td>有限(会滚动删除)</td><td>单个文件</td></tr><tr><td>包含信息</td><td>ANR+CPU+内存</td><td>仅线程堆栈</td></tr><tr><td>查看方式</td><td>dumpsys dropbox</td><td>adb pull</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-24">六、ANR Dialog的展示</h2>
<p>ANR检测和信息收集完成后,最终会弹出一个对话框让用户决定如何处理。</p>
<h3 data-id="heading-25">6.1 ANR Dialog的类型</h3>
<p>Android有两种ANR Dialog:</p>
<p><strong>1. 应用ANR Dialog</strong>(普通应用):</p>
<pre><code class="hljs language-css" lang="css">─────────────────────────────
│  应用无响应                  │
│                            │
│  "XX"未响应。               │
│                            │
│  您要关闭它吗?               │
│                            │
│  <span class="hljs-selector-attr">[等待]</span>  <span class="hljs-selector-attr">[关闭应用]</span>          │
─────────────────────────────
</code></pre>
<p><strong>2. 系统ANR Dialog</strong>(系统应用或System Server):</p>
<pre><code class="hljs language-css" lang="css">─────────────────────────────
│  系统未响应                 │
│                            │
│  "System UI"未响应。        │
│                            │
│  <span class="hljs-selector-attr">[等待]</span>  <span class="hljs-selector-attr">[确定]</span>             │
─────────────────────────────
</code></pre>
<h3 data-id="heading-26">6.2 Dialog的实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/am/AppNotRespondingDialog.java</span>

<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppNotRespondingDialog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseErrorDialog</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ActivityManagerService mService;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ProcessRecord mProc;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AppNotRespondingDialog</span><span class="hljs-params">(ActivityManagerService service,
            Context context, Data data)</span> {
        <span class="hljs-built_in">super</span>(context);

        mService = service;
        mProc = data.proc;

        <span class="hljs-comment">// 1. 设置Dialog标题</span>
        setTitle(context.getText(com.android.internal.R.string.anr_title));

        <span class="hljs-comment">// 2. 设置消息内容</span>
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        msg.append(context.getString(com.android.internal.R.string.anr_activity_application,
                data.aInfo.loadLabel(context.getPackageManager()).toString(),
                data.proc.info.processName));

        setMessage(msg);

        <span class="hljs-comment">// 3. 设置按钮</span>
        setCancelable(<span class="hljs-literal">false</span>);

        <span class="hljs-comment">// "等待"按钮</span>
        setButton(DialogInterface.BUTTON_POSITIVE,
                context.getText(com.android.internal.R.string.wait),
                mHandler.obtainMessage(WAIT));

        <span class="hljs-comment">// "关闭应用"按钮</span>
        setButton(DialogInterface.BUTTON_NEGATIVE,
                context.getText(com.android.internal.R.string.force_close),
                mHandler.obtainMessage(FORCE_CLOSE));

        <span class="hljs-comment">// "报告"按钮(可选)</span>
        <span class="hljs-keyword">if</span> (data.proc.errorReportReceiver != <span class="hljs-literal">null</span>) {
            setButton(DialogInterface.BUTTON_NEUTRAL,
                    context.getText(com.android.internal.R.string.report),
                    mHandler.obtainMessage(APP_INFO));
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Handler</span> <span class="hljs-variable">mHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
            <span class="hljs-keyword">switch</span> (msg.what) {
                <span class="hljs-keyword">case</span> WAIT:
                    <span class="hljs-comment">// 用户选择等待,关闭Dialog</span>
                    mService.mUiHandler.sendEmptyMessage(DISMISS_DIALOG);
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> FORCE_CLOSE:
                    <span class="hljs-comment">// 用户选择关闭,杀死应用</span>
                    mService.killAppAtUsersRequest(mProc, AppNotRespondingDialog.<span class="hljs-built_in">this</span>);
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> APP_INFO:
                    <span class="hljs-comment">// 用户选择报告,打开应用信息页</span>
                    mService.mUiHandler.obtainMessage(SHOW_APP_ERROR_REPORT, mProc)
                            .sendToTarget();
                    <span class="hljs-keyword">break</span>;
            }
        }
    };
}
</code></pre>
<h3 data-id="heading-27">6.3 用户操作的后续处理</h3>
<p><strong>用户选择"等待"</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 什么都不做,只是关闭Dialog</span>
<span class="hljs-comment">// ANR进程继续运行</span>
<span class="hljs-comment">// 如果还是没响应,可能再次触发ANR</span>
</code></pre>
<p><strong>用户选择"关闭应用"</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">killAppAtUsersRequest</span><span class="hljs-params">(ProcessRecord app, Dialog fromDialog)</span> {
    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
        <span class="hljs-comment">// 1. 标记为用户主动关闭</span>
        app.crashing = <span class="hljs-literal">false</span>;
        app.crashingReport = <span class="hljs-literal">null</span>;
        app.notResponding = <span class="hljs-literal">false</span>;
        app.notRespondingReport = <span class="hljs-literal">null</span>;

        <span class="hljs-comment">// 2. 杀死进程</span>
        Process.killProcess(app.pid);

        <span class="hljs-comment">// 3. 清理进程记录</span>
        handleAppDiedLocked(app, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);
    }
}
</code></pre>
<p><strong>用户选择"报告"</strong>(某些系统):</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 打开Feedback或BugReport应用</span>
<span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-string">"android.intent.action.APP_ERROR"</span>);
intent.putExtra(<span class="hljs-string">"error_type"</span>, <span class="hljs-string">"anr"</span>);
intent.putExtra(<span class="hljs-string">"package_name"</span>, app.info.packageName);
intent.putExtra(<span class="hljs-string">"process_name"</span>, app.processName);
intent.putExtra(<span class="hljs-string">"pid"</span>, app.pid);
context.startActivity(intent);
</code></pre>
<hr/>
<h2 data-id="heading-28">七、ANR分析实战</h2>
<p>理论讲了这么多,让我们通过几个真实案例,看看如何实战分析ANR。</p>
<h3 data-id="heading-29">7.1 案例1:主线程等锁导致的ANR</h3>
<p><strong>现象</strong>: 用户点击按钮后,应用卡住5秒,弹出ANR</p>
<p><strong>logcat日志</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown">12-25 10:30:15.123  1234  1250 E InputDispatcher: Application is not responding: AppWindowToken{e8d3a72 token=Token{b6c7d3e ActivityRecord{a9f8e1d u0 com.example/.MainActivity}}}
12-25 10:30:15.234  1234  1250 I ActivityManager: ANR in com.example.app (com.example.app/.MainActivity)
12-25 10:30:15.234  1234  1250 I ActivityManager: PID: 12345
12-25 10:30:15.234  1234  1250 I ActivityManager: Reason: Input dispatching timed out (Waiting to send non-key event because the touched window has not finished processing certain input events that were delivered to it over 500.0ms ago.  Wait queue length: 1.)
</code></pre>
<p><strong>traces.txt分析</strong>:</p>
<pre><code class="hljs language-php" lang="php">----- pid <span class="hljs-number">12345</span> at <span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">30</span>:<span class="hljs-number">15</span> -----
Cmd line: com.example.app

<span class="hljs-string">"main"</span> prio=<span class="hljs-number">5</span> tid=<span class="hljs-number">1</span> Blocked
  | group=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0x74e04dd8</span>
  | sysTid=<span class="hljs-number">12345</span> nice=-<span class="hljs-number">10</span> cgrp=<span class="hljs-keyword">default</span> sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0x7b5a9f49a8</span>
  | state=S schedstat=( <span class="hljs-number">15678923456</span> <span class="hljs-number">8765432109</span> <span class="hljs-number">1234</span> ) utm=<span class="hljs-number">1500</span> stm=<span class="hljs-number">67</span>
  at com.example.app.DataManager.<span class="hljs-title function_ invoke__">getData</span>(DataManager.<span class="hljs-attr">java</span>:<span class="hljs-number">45</span>)
  - waiting to lock &lt;<span class="hljs-number">0x0a1b2c3d</span>&gt; (a java.lang.Object) held by thread <span class="hljs-number">15</span>
  at com.example.app.MainActivity.<span class="hljs-title function_ invoke__">onClick</span>(MainActivity.<span class="hljs-attr">java</span>:<span class="hljs-number">100</span>)
  at android.view.View.<span class="hljs-title function_ invoke__">performClick</span>(View.<span class="hljs-attr">java</span>:<span class="hljs-number">7125</span>)
  at android.view.View.<span class="hljs-title function_ invoke__">performClickInternal</span>(View.<span class="hljs-attr">java</span>:<span class="hljs-number">7102</span>)
  at android.view.View.access$<span class="hljs-number">3500</span>(View.java:<span class="hljs-number">801</span>)
  at android.view.View<span class="hljs-variable">$PerformClick</span>.<span class="hljs-title function_ invoke__">run</span>(View.<span class="hljs-attr">java</span>:<span class="hljs-number">27851</span>)
  at android.os.Handler.<span class="hljs-title function_ invoke__">handleCallback</span>(Handler.<span class="hljs-attr">java</span>:<span class="hljs-number">883</span>)
  at android.os.Handler.<span class="hljs-title function_ invoke__">dispatchMessage</span>(Handler.<span class="hljs-attr">java</span>:<span class="hljs-number">100</span>)
  at android.os.Looper.<span class="hljs-title function_ invoke__">loop</span>(Looper.<span class="hljs-attr">java</span>:<span class="hljs-number">214</span>)
  at android.app.ActivityThread.<span class="hljs-title function_ invoke__">main</span>(ActivityThread.<span class="hljs-attr">java</span>:<span class="hljs-number">7356</span>)
  ...

<span class="hljs-string">"Thread-15"</span> prio=<span class="hljs-number">5</span> tid=<span class="hljs-number">15</span> Native
  | group=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0x13579bdf</span>
  | sysTid=<span class="hljs-number">12360</span> nice=<span class="hljs-number">0</span> cgrp=<span class="hljs-keyword">default</span> sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0x7a4e028800</span>
  | state=S schedstat=( <span class="hljs-number">9876543210</span> <span class="hljs-number">5432109876</span> <span class="hljs-number">123</span> ) utm=<span class="hljs-number">900</span> stm=<span class="hljs-number">87</span>
  at android.os.BinderProxy.<span class="hljs-title function_ invoke__">transactNative</span>(Native Method)
  at android.os.BinderProxy.<span class="hljs-title function_ invoke__">transact</span>(Binder.<span class="hljs-attr">java</span>:<span class="hljs-number">1129</span>)
  - locked &lt;<span class="hljs-number">0x0a1b2c3d</span>&gt; (a java.lang.Object)
  at android.content.IContentProvider$Stub<span class="hljs-variable">$Proxy</span>.<span class="hljs-title function_ invoke__">query</span>(IContentProvider.<span class="hljs-attr">java</span>:xxx)
  at android.content.ContentResolver.<span class="hljs-title function_ invoke__">query</span>(ContentResolver.<span class="hljs-attr">java</span>:xxx)
  at com.example.app.DataManager.<span class="hljs-title function_ invoke__">loadFromDatabase</span>(DataManager.<span class="hljs-attr">java</span>:<span class="hljs-number">80</span>)
  at com.example.app.DataManager$<span class="hljs-number">1</span>.<span class="hljs-title function_ invoke__">run</span>(DataManager.<span class="hljs-attr">java</span>:<span class="hljs-number">60</span>)
  ...
</code></pre>
<p><strong>分析步骤</strong>:</p>
<ol>
<li><strong>看主线程状态</strong>: <code>Blocked</code> - 主线程被阻塞了</li>
<li><strong>看阻塞位置</strong>: <code>DataManager.getData()</code>第45行,在等一个锁<code>&lt;0x0a1b2c3d&gt;</code></li>
<li><strong>找持锁线程</strong>: Thread-15持有这个锁(<code>locked &lt;0x0a1b2c3d&gt;</code>)</li>
<li><strong>看持锁线程在干嘛</strong>: 正在进行Binder调用<code>transactNative()</code>,查询ContentProvider</li>
<li><strong>根本原因</strong>: 线程15持锁做耗时操作,主线程等不到锁</li>
</ol>
<p><strong>解决方案</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 原代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">mLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 主线程调用</span>
        <span class="hljs-keyword">synchronized</span> (mLock) {
            <span class="hljs-type">Data</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> getData();
            updateUI(data);
        }
    }

    <span class="hljs-keyword">private</span> Data <span class="hljs-title function_">getData</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 还是在持锁状态!</span>
        <span class="hljs-keyword">return</span> loadFromDatabase();  <span class="hljs-comment">// Binder调用,很慢</span>
    }
}

<span class="hljs-comment">// ✅ 修复后</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">mLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 异步加载</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            Data data;
            <span class="hljs-keyword">synchronized</span> (mLock) {
                data = getData();
            }
            <span class="hljs-comment">// 在主线程更新UI</span>
            runOnUiThread(() -&gt; updateUI(data));
        }).start();
    }
}
</code></pre>
<h3 data-id="heading-30">7.2 案例2:Binder调用超时导致的ANR</h3>
<p><strong>现象</strong>: 应用在后台,突然收到Broadcast ANR</p>
<p><strong>logcat</strong>:</p>
<pre><code class="hljs language-ini" lang="ini">12-25 11:00:00.123  1234  1250 W BroadcastQueue: Timeout of broadcast BroadcastRecord{a1b2c3d u0 android.intent.action.BATTERY_CHANGED} - <span class="hljs-attr">receiver</span>=android.content.IIntentReceiver<span class="hljs-variable">$Stub</span><span class="hljs-variable">$Proxy</span>@e4f5g6h
12-25 11:00:00.234  1234  1250 I ActivityManager: ANR in com.example.app (com.example.app/.MyReceiver)
12-25 11:00:00.234  1234  1250 I ActivityManager: Reason: Broadcast of Intent { <span class="hljs-attr">act</span>=android.intent.action.BATTERY_CHANGED }
</code></pre>
<p><strong>traces.txt</strong>:</p>
<pre><code class="hljs language-ini" lang="ini">"main" <span class="hljs-attr">prio</span>=<span class="hljs-number">5</span> tid=<span class="hljs-number">1</span> Native
  | <span class="hljs-attr">group</span>=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0</span>x74e04dd8
  | <span class="hljs-attr">sysTid</span>=<span class="hljs-number">23456</span> nice=<span class="hljs-number">0</span> cgrp=default sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0</span>x7b5a9f49a8
  | <span class="hljs-attr">state</span>=S schedstat=( <span class="hljs-number">2345678901</span> <span class="hljs-number">1234567890</span> <span class="hljs-number">234</span> ) utm=<span class="hljs-number">200</span> stm=<span class="hljs-number">34</span>
  at android.os.BinderProxy.transactNative(Native Method)
  at android.os.BinderProxy.transact(Binder.java:1129)
  at android.app.IActivityManager$Stub$Proxy.registerContentObserver(IActivityManager.java:xxxx)
  at android.content.ContentResolver.registerContentObserver(ContentResolver.java:xxxx)
  at com.example.app.MyReceiver.onReceive(MyReceiver.java:30)
  at android.app.ActivityThread.handleReceiver(ActivityThread.java:xxxx)
  ...
</code></pre>
<p><strong>分析</strong>:</p>
<ol>
<li><strong>ANR类型</strong>: Broadcast ANR</li>
<li><strong>主线程状态</strong>: <code>Native</code> - 正在执行Native方法</li>
<li><strong>卡在哪里</strong>: <code>BinderProxy.transactNative()</code> - Binder调用</li>
<li><strong>在做什么</strong>: 注册ContentObserver</li>
<li><strong>为什么慢</strong>: 可能System Server繁忙或Binder资源耗尽</li>
</ol>
<p><strong>根因</strong>: 在BroadcastReceiver中进行同步Binder调用,而System Server响应慢</p>
<p><strong>解决方案</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 原代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> {
        <span class="hljs-comment">// 同步注册ContentObserver,可能很慢</span>
        context.getContentResolver().registerContentObserver(
                Settings.System.getUriFor(Settings.System.SCREEN_BRIGHTNESS),
                <span class="hljs-literal">false</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentObserver</span>(<span class="hljs-literal">null</span>) {
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onChange</span><span class="hljs-params">(<span class="hljs-type">boolean</span> selfChange)</span> {
                        <span class="hljs-comment">// ...</span>
                    }
                });
    }
}

<span class="hljs-comment">// ✅ 修复方案1:使用goAsync()</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">PendingResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> goAsync();

        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">try</span> {
                context.getContentResolver().registerContentObserver(...);
            } <span class="hljs-keyword">finally</span> {
                result.finish();
            }
        }).start();
    }
}

<span class="hljs-comment">// ✅ 修复方案2:延迟注册</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> {
        <span class="hljs-comment">// 启动Service延迟注册</span>
        <span class="hljs-type">Intent</span> <span class="hljs-variable">serviceIntent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(context, RegistrationService.class);
        context.startService(serviceIntent);
    }
}
</code></pre>
<h3 data-id="heading-31">7.3 案例3:主线程做数据库操作</h3>
<p><strong>traces.txt</strong>:</p>
<pre><code class="hljs language-less" lang="less">"<span class="hljs-selector-tag">main</span>" <span class="hljs-selector-tag">prio</span>=<span class="hljs-number">5</span> <span class="hljs-selector-tag">tid</span>=<span class="hljs-number">1</span> <span class="hljs-selector-tag">Native</span>
  | <span class="hljs-selector-tag">sysTid</span>=<span class="hljs-number">34567</span> <span class="hljs-selector-tag">nice</span>=<span class="hljs-selector-tag">-10</span>
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.database</span><span class="hljs-selector-class">.sqlite</span><span class="hljs-selector-class">.SQLiteConnection</span><span class="hljs-selector-class">.nativeExecute</span>(Native Method)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.database</span><span class="hljs-selector-class">.sqlite</span><span class="hljs-selector-class">.SQLiteConnection</span><span class="hljs-selector-class">.execute</span>(SQLiteConnection.<span class="hljs-attribute">java</span>:<span class="hljs-number">609</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.database</span><span class="hljs-selector-class">.sqlite</span><span class="hljs-selector-class">.SQLiteSession</span><span class="hljs-selector-class">.executeForCursorWindow</span>(SQLiteSession.<span class="hljs-attribute">java</span>:<span class="hljs-number">820</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.database</span><span class="hljs-selector-class">.sqlite</span><span class="hljs-selector-class">.SQLiteQuery</span><span class="hljs-selector-class">.fillWindow</span>(SQLiteQuery.<span class="hljs-attribute">java</span>:<span class="hljs-number">62</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.database</span><span class="hljs-selector-class">.sqlite</span><span class="hljs-selector-class">.SQLiteCursor</span><span class="hljs-selector-class">.fillWindow</span>(SQLiteCursor.<span class="hljs-attribute">java</span>:<span class="hljs-number">144</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.database</span><span class="hljs-selector-class">.sqlite</span><span class="hljs-selector-class">.SQLiteCursor</span><span class="hljs-selector-class">.getCount</span>(SQLiteCursor.<span class="hljs-attribute">java</span>:<span class="hljs-number">134</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.DatabaseHelper</span><span class="hljs-selector-class">.queryAllRecords</span>(DatabaseHelper.<span class="hljs-attribute">java</span>:<span class="hljs-number">150</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.MainActivity</span><span class="hljs-selector-class">.onCreate</span>(MainActivity.<span class="hljs-attribute">java</span>:<span class="hljs-number">50</span>)
  ...
</code></pre>
<p><strong>分析</strong>:</p>
<ul>
<li>主线程在执行SQLite查询</li>
<li><code>getCount()</code>会加载所有数据到Cursor</li>
<li>数据量大时会很慢</li>
</ul>
<p><strong>解决方案</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 原代码</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    <span class="hljs-comment">// 主线程查询数据库</span>
    <span class="hljs-type">Cursor</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> mDbHelper.queryAllRecords();
    <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> cursor.getCount();  <span class="hljs-comment">// 触发实际查询</span>
    processData(cursor);
}

<span class="hljs-comment">// ✅ 使用AsyncTask(已废弃,仅作示例)</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryTask</span>().execute();
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AsyncTask</span>&lt;Void, Void, Cursor&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Cursor <span class="hljs-title function_">doInBackground</span><span class="hljs-params">(Void... voids)</span> {
        <span class="hljs-keyword">return</span> mDbHelper.queryAllRecords();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPostExecute</span><span class="hljs-params">(Cursor cursor)</span> {
        processData(cursor);
    }
}

<span class="hljs-comment">// ✅ 使用Kotlin Coroutines(推荐)</span>
override fun <span class="hljs-title function_">onCreate</span><span class="hljs-params">(savedInstanceState: Bundle?)</span> {
    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState)
    setContentView(R.layout.activity_main)

    lifecycleScope.launch {
        <span class="hljs-type">val</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> withContext(Dispatchers.IO) {
            dbHelper.queryAllRecords()
        }
        processData(cursor)
    }
}

<span class="hljs-comment">// ✅ 使用Room + LiveData(最佳实践)</span>
<span class="hljs-meta">@Dao</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">RecordDao</span> {
    <span class="hljs-meta">@Query("SELECT * FROM records")</span>
    fun <span class="hljs-title function_">getAllRecords</span><span class="hljs-params">()</span>: LiveData&lt;List&lt;Record&gt;&gt;
}

override fun <span class="hljs-title function_">onCreate</span><span class="hljs-params">(savedInstanceState: Bundle?)</span> {
    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState)
    setContentView(R.layout.activity_main)

    viewModel.records.observe(<span class="hljs-built_in">this</span>) { records -&gt;
        processData(records)
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-32">八、ANR的预防和监控</h2>
<p>预防胜于治疗。让我们看看如何在开发阶段就避免ANR,以及如何建立有效的监控体系。</p>
<h3 data-id="heading-33">8.1 开发阶段的预防措施</h3>
<p><strong>1. 使用StrictMode检测主线程违规</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();

        <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
            StrictMode.setThreadPolicy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMode</span>.ThreadPolicy.Builder()
                    .detectDiskReads()    <span class="hljs-comment">// 检测磁盘读取</span>
                    .detectDiskWrites()   <span class="hljs-comment">// 检测磁盘写入</span>
                    .detectNetwork()      <span class="hljs-comment">// 检测网络操作</span>
                    .detectCustomSlowCalls()  <span class="hljs-comment">// 检测自定义慢调用</span>
                    .penaltyLog()         <span class="hljs-comment">// 输出到logcat</span>
                    .penaltyDeath()       <span class="hljs-comment">// 直接crash(开发阶段)</span>
                    .build());

            StrictMode.setVmPolicy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMode</span>.VmPolicy.Builder()
                    .detectLeakedSqlLiteObjects()  <span class="hljs-comment">// 检测数据库泄漏</span>
                    .detectLeakedClosableObjects() <span class="hljs-comment">// 检测未关闭的对象</span>
                    .penaltyLog()
                    .build());
        }
    }
}
</code></pre>
<p><strong>2. 使用BlockCanary检测卡顿</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 初始化BlockCanary</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();

        BlockCanary.install(<span class="hljs-built_in">this</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppBlockCanaryContext</span>()).start();
    }
}

<span class="hljs-comment">// 自定义配置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppBlockCanaryContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BlockCanaryContext</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">provideBlockThreshold</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">500</span>;  <span class="hljs-comment">// 超过500ms判定为卡顿</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">displayNotification</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> BuildConfig.DEBUG;  <span class="hljs-comment">// 仅debug环境显示通知</span>
    }
}
</code></pre>
<p><strong>3. 使用TraceView分析性能</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在可疑代码前后添加trace</span>
Debug.startMethodTracing(<span class="hljs-string">"my_trace"</span>);
<span class="hljs-comment">// 可疑的代码</span>
suspiciousMethod();
Debug.stopMethodTracing();

<span class="hljs-comment">// 导出trace文件</span>
adb pull /sdcard/Android/data/&lt;<span class="hljs-keyword">package</span>&gt;/files/my_trace.trace .

<span class="hljs-comment">// 使用Android Studio的Profiler分析</span>
</code></pre>
<h3 data-id="heading-34">8.2 线上监控体系</h3>
<p><strong>1. ANR捕获和上报</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ANRWatchDog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mTimeout;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Handler</span> <span class="hljs-variable">mHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>(Looper.getMainLooper());

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ANRWatchDog</span><span class="hljs-params">(<span class="hljs-type">int</span> timeout)</span> {
        <span class="hljs-built_in">super</span>(<span class="hljs-string">"ANR-WatchDog"</span>);
        <span class="hljs-built_in">this</span>.mTimeout = timeout;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">while</span> (!isInterrupted()) {
            <span class="hljs-comment">// 1. 记录当前时间</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">executionTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>();

            <span class="hljs-comment">// 2. 向主线程发送任务</span>
            mHandler.post(() -&gt; {
                executionTime.set(System.currentTimeMillis());
            });

            <span class="hljs-comment">// 3. 等待一段时间</span>
            <span class="hljs-keyword">try</span> {
                Thread.sleep(mTimeout);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// 4. 检查任务是否执行</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">execTime</span> <span class="hljs-operator">=</span> executionTime.get();
            <span class="hljs-keyword">if</span> (execTime == <span class="hljs-number">0</span> || System.currentTimeMillis() - execTime &gt; mTimeout) {
                <span class="hljs-comment">// 检测到ANR!</span>
                onAnrDetected();
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnrDetected</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 收集堆栈信息</span>
        Map&lt;Thread, StackTraceElement[]&gt; stackTraces = Thread.getAllStackTraces();

        <span class="hljs-comment">// 2. 上报到服务器</span>
        ANRReporter.report(stackTraces);
    }
}

<span class="hljs-comment">// 启动监控</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">ANRWatchDog</span>(<span class="hljs-number">5000</span>).start();
</code></pre>
<p><strong>2. 使用Bugly等第三方平台</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();

        <span class="hljs-comment">// 初始化Bugly</span>
        CrashReport.initCrashReport(getApplicationContext(), <span class="hljs-string">"YOUR_APP_ID"</span>, BuildConfig.DEBUG);

        <span class="hljs-comment">// 配置ANR监控</span>
        CrashReport.<span class="hljs-type">UserStrategy</span> <span class="hljs-variable">strategy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CrashReport</span>.UserStrategy(getApplicationContext());
        strategy.setAppReportDelay(<span class="hljs-number">10000</span>);  <span class="hljs-comment">// 延迟上报</span>
        CrashReport.initCrashReport(getApplicationContext(), <span class="hljs-string">"YOUR_APP_ID"</span>, BuildConfig.DEBUG, strategy);
    }
}
</code></pre>
<p><strong>3. 监控关键指标</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMonitor</span> {
    <span class="hljs-comment">// 监控主线程消息处理时间</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorMainLooper</span><span class="hljs-params">()</span> {
        Looper.getMainLooper().setMessageLogging(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Printer</span>() {
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">START</span> <span class="hljs-operator">=</span> <span class="hljs-string">"&gt;&gt;&gt;&gt;&gt; Dispatching"</span>;
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">END</span> <span class="hljs-operator">=</span> <span class="hljs-string">"&lt;&lt;&lt;&lt;&lt; Finished"</span>;

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">println</span><span class="hljs-params">(String msg)</span> {
                <span class="hljs-keyword">if</span> (msg.startsWith(START)) {
                    <span class="hljs-comment">// 消息开始处理</span>
                    mStartTime = System.currentTimeMillis();
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (msg.startsWith(END)) {
                    <span class="hljs-comment">// 消息处理完毕</span>
                    <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - mStartTime;
                    <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">100</span>) {  <span class="hljs-comment">// 超过100ms</span>
                        <span class="hljs-comment">// 记录慢消息</span>
                        logSlowMessage(msg, duration);
                    }
                }
            }
        });
    }

    <span class="hljs-comment">// 监控方法执行时间</span>
    <span class="hljs-meta">@Around("execution(* com.example.app..*(..))")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">measureMethod</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();
        <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;

        <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">50</span>) {  <span class="hljs-comment">// 超过50ms</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> joinPoint.getSignature().toShortString();
            Log.w(<span class="hljs-string">"Performance"</span>, method + <span class="hljs-string">" took "</span> + duration + <span class="hljs-string">"ms"</span>);
        }

        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<h3 data-id="heading-35">8.3 ANR优化的最佳实践</h3>
<p><strong>1. 主线程的黄金法则</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">主线程只做三件事:
<span class="hljs-bullet">1.</span> 更新UI
<span class="hljs-bullet">2.</span> 分发事件
<span class="hljs-bullet">3.</span> 启动异步任务

绝对不能做:
<span class="hljs-bullet">1.</span> 磁盘I/O (读写文件、数据库)
<span class="hljs-bullet">2.</span> 网络I/O (HTTP请求、Socket通信)
<span class="hljs-bullet">3.</span> 复杂计算 (大数据处理、加密解密)
<span class="hljs-bullet">4.</span> 同步Binder调用 (ContentProvider、System Service)
<span class="hljs-bullet">5.</span> 等待锁 (synchronized、Lock)
</code></pre>
<p><strong>2. 使用异步机制</strong></p>








































<table><thead><tr><th>场景</th><th>推荐方案</th><th>示例</th></tr></thead><tbody><tr><td>简单异步任务</td><td><code>HandlerThread</code> + <code>Handler</code></td><td>后台数据处理</td></tr><tr><td>生命周期感知</td><td><code>ViewModel</code> + <code>LiveData</code></td><td>UI数据加载</td></tr><tr><td>复杂协程</td><td>Kotlin <code>Coroutines</code></td><td>网络请求+数据库</td></tr><tr><td>定时任务</td><td><code>WorkManager</code></td><td>定期同步</td></tr><tr><td>文件I/O</td><td><code>Executors.newSingleThreadExecutor()</code></td><td>日志写入</td></tr><tr><td>数据库</td><td><code>Room</code> + <code>LiveData</code></td><td>本地数据访问</td></tr></tbody></table>
<p><strong>3. 优化Binder调用</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 主线程同步调用ContentProvider</span>
<span class="hljs-type">Cursor</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> getContentResolver().query(uri, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);

<span class="hljs-comment">// ✅ 使用ContentProviderOperation批量操作</span>
ArrayList&lt;ContentProviderOperation&gt; ops = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
ops.add(ContentProviderOperation.newInsert(uri).withValues(values1).build());
ops.add(ContentProviderOperation.newInsert(uri).withValues(values2).build());
getContentResolver().applyBatch(AUTHORITY, ops);

<span class="hljs-comment">// ✅ 使用AsyncQueryHandler异步查询</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncQueryHandler</span>(getContentResolver()) {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onQueryComplete</span><span class="hljs-params">(<span class="hljs-type">int</span> token, Object cookie, Cursor cursor)</span> {
        processData(cursor);
    }
}.startQuery(<span class="hljs-number">0</span>, <span class="hljs-literal">null</span>, uri, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
</code></pre>
<p><strong>4. 减少锁竞争</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 粗粒度锁</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Data&gt; mCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Data <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-type">Data</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> mCache.get(key);
        <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) {
            data = loadFromDisk(key);  <span class="hljs-comment">// 耗时操作在持锁状态!</span>
            mCache.put(key, data);
        }
        <span class="hljs-keyword">return</span> data;
    }
}

<span class="hljs-comment">// ✅ 细粒度锁 + Double-Check</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;String, Data&gt; mCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">mLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();

    <span class="hljs-keyword">public</span> Data <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-type">Data</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> mCache.get(key);
        <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">synchronized</span> (mLock) {
                data = mCache.get(key);
                <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) {
                    data = loadFromDisk(key);  <span class="hljs-comment">// 只有必要时才持锁</span>
                    mCache.put(key, data);
                }
            }
        }
        <span class="hljs-keyword">return</span> data;
    }
}

<span class="hljs-comment">// ✅ 使用Lock + tryLock避免死等</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">mLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();

    <span class="hljs-keyword">public</span> Data <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">if</span> (mLock.tryLock(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> loadData(key);
            } <span class="hljs-keyword">finally</span> {
                mLock.unlock();
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 获取锁失败,返回默认值或异步加载</span>
            <span class="hljs-keyword">return</span> getDefaultValue();
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-36">九、总结与展望</h2>
<p>让我们回顾一下ANR机制的全貌:</p>
<h3 data-id="heading-37">9.1 核心要点回顾</h3>
<p><strong>ANR的4种类型</strong>:</p>
<ul>
<li><strong>Input ANR</strong>: 5秒无响应,由InputDispatcher检测</li>
<li><strong>Broadcast ANR</strong>: 10秒/60秒,由ActivityManagerService检测</li>
<li><strong>Service ANR</strong>: 20秒/200秒,由ActivityManagerService检测</li>
<li><strong>ContentProvider ANR</strong>: 10秒,由ActivityManagerService检测</li>
</ul>
<p><strong>ANR检测机制</strong>:</p>
<ul>
<li><strong>Input</strong>: 事件入队时记录时间戳,定时检查waitQueue</li>
<li><strong>Broadcast/Service</strong>: 发送延时消息,超时触发Handler回调</li>
</ul>
<p><strong>ANR处理流程</strong>:</p>
<pre><code class="hljs language-scss" lang="scss">检测超时 → 调用<span class="hljs-built_in">appNotResponding</span>() → 收集CPU/内存信息
→ dump线程堆栈 → 生成traces<span class="hljs-selector-class">.txt</span> → 写入DropBox → 弹出Dialog
</code></pre>
<p><strong>traces.txt的关键信息</strong>:</p>
<ul>
<li>线程状态: Blocked/Waiting/Native/Runnable</li>
<li>堆栈信息: 方法调用链</li>
<li>锁信息: waiting to lock / locked</li>
</ul>
<h3 data-id="heading-38">9.2 ANR优化的金字塔</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff3e30c9a4a74efeaddc3eae26e4549c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767424897&amp;x-signature=1MwwEhjyYQaL15IFWwUlZYM5dMY%3D" alt="02-04-anr-prevention-priority.png" loading="lazy"/></p>
<h3 data-id="heading-39">9.3 实战建议</h3>
<ol>
<li>
<p><strong>开发阶段</strong>:</p>
<ul>
<li>开启StrictMode</li>
<li>使用BlockCanary</li>
<li>Code Review关注主线程操作</li>
</ul>
</li>
<li>
<p><strong>测试阶段</strong>:</p>
<ul>
<li>压力测试</li>
<li>Monkey测试</li>
<li>性能测试(TraceView、Systrace)</li>
</ul>
</li>
<li>
<p><strong>线上阶段</strong>:</p>
<ul>
<li>接入Bugly等监控平台</li>
<li>定期分析ANR Top榜</li>
<li>建立ANR快速响应机制</li>
</ul>
</li>
</ol>
<h3 data-id="heading-40">9.4 后续文章预告</h3>
<p>ANR机制只是稳定性的一个方面。在后续文章中,我们将继续深入:</p>



































<table><thead><tr><th>文章</th><th>主题</th><th>核心内容</th></tr></thead><tbody><tr><td>第3篇</td><td>ANR问题排查实战</td><td>traces.txt深度解读、Systrace分析、常见ANR案例</td></tr><tr><td>第4篇</td><td>异常日志机制</td><td>Crash处理、Tombstone分析、信号机制</td></tr><tr><td>第5篇</td><td>Native Crash深度分析</td><td>debuggerd、符号化、coredump</td></tr><tr><td>第6篇</td><td>Java异常与JE分析实战</td><td>Java异常的分析实战</td></tr><tr><td>第7篇</td><td>Watchdog机制</td><td>系统看门狗、半死锁检测、System Server保护</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-41">参考资料</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Fperformance%2Fvitals%2Fanr" target="_blank" title="https://developer.android.com/topic/performance/vitals/anr" ref="nofollow noopener noreferrer">Android官方文档 - ANR</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2F%2B%2Fmaster%3Aframeworks%2Fnative%2Fservices%2Finputflinger%2Fdispatcher%2FInputDispatcher.cpp" target="_blank" title="https://cs.android.com/android/platform/superproject/+/master:frameworks/native/services/inputflinger/dispatcher/InputDispatcher.cpp" ref="nofollow noopener noreferrer">AOSP源码 - InputDispatcher.cpp</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2F%2B%2Fmaster%3Aframeworks%2Fbase%2Fservices%2Fcore%2Fjava%2Fcom%2Fandroid%2Fserver%2Fam%2FActivityManagerService.java" target="_blank" title="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java" ref="nofollow noopener noreferrer">AOSP源码 - ActivityManagerService.java</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2F%2B%2Fmaster%3Aframeworks%2Fbase%2Fservices%2Fcore%2Fjava%2Fcom%2Fandroid%2Fserver%2Fam%2FBroadcastQueue.java" target="_blank" title="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/core/java/com/android/server/am/BroadcastQueue.java" ref="nofollow noopener noreferrer">AOSP源码 - BroadcastQueue.java</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fplaylist%3Flist%3DPLWz5rJ2EKKc9CBxr3BVjPTPoDPLdPIFCE" target="_blank" title="https://www.youtube.com/playlist?list=PLWz5rJ2EKKc9CBxr3BVjPTPoDPLdPIFCE" ref="nofollow noopener noreferrer">Android Performance Patterns</a></li>
</ol>
<p><strong>上一篇</strong>：<a href="https://juejin.cn/post/7587776610436497423" target="_blank" title="https://juejin.cn/post/7587776610436497423">稳定性性能系列之一——Android稳定性基础:系统架构与关键机制</a><br/>
<strong>下一篇</strong>：<a href="https://juejin.cn/post/7588004601392906274" target="_blank" title="https://juejin.cn/post/7588004601392906274">稳定性性能系列之三——ANR问题排查实战:日志分析与工具实战</a><br/>
<strong>返回专栏目录</strong>: <a href="https://juejin.cn/post/7587473691170095104" target="_blank" title="https://juejin.cn/post/7587473691170095104">Android稳定性&amp;性能深入理解专栏介绍</a></p>
<hr/>
<blockquote>
<p><strong>作者简介</strong>: 多年Android系统开发经验,专注于系统稳定性与性能优化领域。欢迎关注本系列,一起深入Android系统的精彩世界!</p>
</blockquote>
<hr/>
<h3 data-id="heading-42">🎉 感谢关注,让我们一起深入Android系统的精彩世界!     找到我: <a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a></h3></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java的类加载过程]]></title>    <link>https://juejin.cn/post/7588067055481880585</link>    <guid>https://juejin.cn/post/7588067055481880585</guid>    <pubDate>2025-12-27T08:27:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588067055481880585" data-draft-id="7588031908172251145" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java的类加载过程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T08:27:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kevinzeng"/> <meta itemprop="url" content="https://juejin.cn/user/1964143993949127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java的类加载过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1964143993949127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kevinzeng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T08:27:48.000Z" title="Sat Dec 27 2025 08:27:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java 类加载全过程（完整+易懂版，含底层原理）</h2>
<p>Java 类加载是 <strong>JVM 将</strong> <strong><code>.class</code></strong> <strong>字节码文件加载到内存，并对其进行验证、准备、解析、初始化，最终形成可被 JVM 直接使用的 Java 类型</strong> 的全过程。这个过程发生在<strong>程序运行期间（动态加载）</strong> ，而非编译期，是 JVM 实现「跨平台」「动态扩展」的核心基础。</p>
<p>✅ 核心结论：Java 类加载流程遵循 <strong>「加载 → 验证 → 准备 → 解析 → 初始化」</strong> 5个固定阶段，其中「解析」阶段可穿插至「初始化」之后执行，整体严格按顺序推进，缺一不可。</p>
<h3 data-id="heading-1">一、类加载整体生命周期（全流程总览）</h3>
<p>一个 Java 类从被加载到 JVM 内存中，到最终被卸载，完整的生命周期包含 <strong>7个阶段</strong>，其中<strong>前5个是「类加载的核心流程」</strong>，后2个是类加载完成后的运行与销毁阶段，整体流程如下：</p>
<pre><code class="hljs">加载 → 验证 → 准备 → 解析 → 初始化 → 使用 → 卸载
</code></pre>
<p>💡 关键特性：</p>
<ol>
<li>加载、验证、准备、初始化、卸载 <strong>5个阶段的执行顺序是固定的</strong>，必须按序推进；</li>
<li><strong>解析阶段是灵活的</strong>：可以在「准备阶段后」立即执行（静态绑定），也可以延迟到「初始化阶段后」执行（动态绑定/晚期绑定），目的是支持 Java 的多态特性。</li>
</ol>
<h3 data-id="heading-2">二、类加载核心5阶段（逐阶段详解，附底层逻辑）</h3>
<h4 data-id="heading-3">✅ 阶段1：加载（Loading）—— 「找文件、读数据、建对象」</h4>
<p>这是类加载的<strong>第一个阶段</strong>，由 JVM 的「类加载器（ClassLoader）」负责执行，核心完成 <strong>3件核心工作</strong>，缺一不可：</p>
<h5 data-id="heading-4">1. 定位字节码文件</h5>
<p>通过类的<strong>全限定类名</strong>（如 <code>java.lang.String</code>、<code>com.test.User</code>），找到对应的 <code>.class</code> 字节码文件（来源可以是本地磁盘、网络、jar包、动态生成等）。</p>
<h5 data-id="heading-5">2. 读取字节码数据</h5>
<p>将 <code>.class</code> 文件的二进制字节流，读取到 JVM 的<strong>方法区</strong>（JDK8及以后为「元空间 Metaspace」，直接占用堆外内存）中。</p>
<h5 data-id="heading-6">3. 创建Class对象</h5>
<p>在 JVM 的<strong>堆内存</strong>中，创建一个对应类的 <code>java.lang.Class</code> 类型对象 —— 这个对象是程序访问方法区中类元数据的「唯一入口」，后续反射、实例化对象都依赖它。</p>
<p>💡 经典考点：堆中的 <code>Class</code> 对象 ≠ 方法区的类元数据。<code>Class</code> 对象是访问入口，类元数据是类的完整信息（属性、方法、常量池等）。</p>
<h4 data-id="heading-7">✅ 阶段2：验证（Verification）—— 「验合法性、保安全性」</h4>
<p>验证是类加载的<strong>安全屏障</strong>，JVM 会对加载到方法区的字节码数据进行<strong>全方位校验</strong>，确保其<strong>符合Java虚拟机规范、无安全隐患</strong>，防止恶意或错误的字节码文件破坏JVM运行。</p>
<p>该阶段分为 <strong>4个子验证环节</strong>，层层递进：</p>
<ol>
<li><strong>文件格式验证</strong>：校验字节码是否符合 <code>.class</code> 文件的格式规范（如魔数是否为 <code>0xCAFEBABE</code>、版本号是否兼容当前JVM）；</li>
<li><strong>元数据验证</strong>：校验类的元数据是否符合Java语法规范（如是否有父类、是否继承了不可继承的类、方法参数是否合法）；</li>
<li><strong>字节码验证</strong>：校验字节码指令的执行逻辑是否合法（如是否存在栈溢出、类型转换异常、指令执行顺序错误）；</li>
<li><strong>符号引用验证</strong>：校验类中的符号引用（如引用的类、方法、字段）是否真实存在、访问权限是否合法。</li>
</ol>
<p>💡 优化点：若确认字节码文件是安全的（如项目内部类），可通过JVM参数 <code>-Xverify:none</code> 关闭验证，提升类加载效率。</p>
<h4 data-id="heading-8">✅ 阶段3：准备（Preparation）—— 「赋默认值、分配内存」</h4>
<p>准备阶段是<strong>为类的静态变量分配内存，并设置默认初始值</strong>的阶段，核心规则明确且固定，是高频考点：</p>
<h5 data-id="heading-9">✅ 核心规则（必须牢记）</h5>
<ol>
<li><strong>仅处理「静态变量（static修饰）」</strong>：实例变量的内存分配和初始化，要等到<strong>对象实例化</strong>时才在堆中执行，与本阶段无关；</li>
<li><strong>分配内存位置</strong>：静态变量的内存，分配在<strong>方法区</strong>的类元数据中；</li>
<li><strong>赋值规则</strong>：仅设置「JVM默认初始值」，<strong>不会执行程序员自定义的赋值语句</strong>。</li>
</ol>
<h5 data-id="heading-10">✅ 基础数据类型默认值对照表</h5>









































<table><thead><tr><th>数据类型</th><th>默认初始值</th><th>数据类型</th><th>默认初始值</th></tr></thead><tbody><tr><td>byte</td><td>0</td><td>boolean</td><td>false</td></tr><tr><td>short</td><td>0</td><td>char</td><td>'\u0000'</td></tr><tr><td>int</td><td>0</td><td>long</td><td>0L</td></tr><tr><td>float</td><td>0.0f</td><td>double</td><td>0.0d</td></tr><tr><td>引用类型</td><td>null</td><td>-</td><td>-</td></tr></tbody></table>
<h5 data-id="heading-11">✅ 经典示例（理解核心）</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
    <span class="hljs-comment">// 静态变量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> num = <span class="hljs-number">10</span>; 
    <span class="hljs-comment">// 实例变量（本阶段不处理）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> name;
}
</code></pre>
<p>👉 准备阶段执行结果：</p>
<ul>
<li>为 <code>num</code> 分配内存，赋值为 <strong>0</strong>（默认值），而非10；</li>
<li>完全不处理 <code>name</code> 变量；</li>
<li>程序员写的 <code>num=10</code> 赋值语句，要等到<strong>初始化阶段</strong>才执行。</li>
</ul>
<h4 data-id="heading-12">✅ 阶段4：解析（Resolution）—— 「符号引用 → 直接引用」</h4>
<p>解析是 JVM 将常量池中的 <strong>符号引用</strong> 替换为 <strong>直接引用</strong> 的过程，是「链接阶段」的最后一步，先明确两个核心概念：</p>
<h5 data-id="heading-13">✅ 核心概念区分（必懂）</h5>
<ol>
<li><strong>符号引用</strong>：用「字符串」描述的引用关系（如类名、方法名、字段名），独立于内存布局，JVM 不知道其真实内存地址。例如 <code>.class</code> 文件中 <code>invokevirtual com/test/User.getName()</code> 就是符号引用；</li>
<li><strong>直接引用</strong>：指向目标的<strong>真实内存地址</strong>（可以是指针、偏移量），JVM 能直接定位到目标位置，与内存布局强相关。</li>
</ol>
<h5 data-id="heading-14">✅ 解析的核心内容</h5>
<p>解析阶段主要处理<strong>4类符号引用</strong>，全部位于类的常量池中：</p>
<ol>
<li><strong>类/接口解析</strong>：将类的全限定名，解析为对应的 <code>Class</code> 对象直接引用；</li>
<li><strong>字段解析</strong>：将字段名，解析为指向方法区中字段内存地址的直接引用；</li>
<li><strong>方法解析</strong>：将方法名，解析为指向方法区中方法内存地址的直接引用；</li>
<li><strong>接口方法解析</strong>：专门处理接口中的方法引用解析。</li>
</ol>
<p>💡 关键特性：解析阶段<strong>支持动态绑定</strong>。比如子类重写父类方法时，JVM 不会在解析阶段确定最终引用，而是延迟到<strong>运行期</strong>（调用方法时）才确定，这是Java实现<strong>多态</strong>的核心基础。</p>
<h4 data-id="heading-15">✅ 阶段5：初始化（Initialization）—— 「执行代码、赋真实值」</h4>
<p>初始化是类加载<strong>5个核心阶段的最后一步</strong>，也是<strong>唯一会执行Java代码的阶段</strong>，核心是「执行静态代码，为静态变量赋予程序员自定义的真实值」，是类加载中最核心、最易考的阶段。</p>
<h5 data-id="heading-16">✅ 核心触发条件（主动使用，7种必背）</h5>
<p>JVM 严格规定：<strong>只有当类被「主动使用」时，才会触发初始化阶段</strong>；被动使用（如仅引用静态常量）不会触发初始化。主动使用的7种场景：</p>
<ol>
<li>创建类的实例（<code>new User()</code>）；</li>
<li>调用类的静态方法（<code>User.testMethod()</code>）；</li>
<li>访问类/接口的<strong>非final</strong>静态变量（<code>User.num</code>）；</li>
<li>反射调用类（<code>Class.forName("com.test.User")</code>）；</li>
<li>初始化子类时，其父类会被优先初始化；</li>
<li>JVM启动时，被指定为「主类」的类（含 <code>main()</code> 方法的类）；</li>
<li>动态语言支持（JDK7+）：调用 <code>java.lang.invoke.MethodHandle</code> 实例，且该实例指向的方法所属类未初始化。</li>
</ol>
<p>✅ 经典反例（被动使用，不初始化）：访问类的 <code>static final</code> 静态常量（<code>public static final int a=10</code>），因为常量在<strong>编译期</strong>就已存入调用类的常量池，无需加载原类。</p>
<h5 data-id="heading-17">✅ 初始化阶段的执行顺序（严格固定，高频考点）</h5>
<p>JVM 会按**「自上而下、先父后子」** 的顺序，执行以下两类代码，且<strong>仅执行一次</strong>（类初始化是线程安全的，JVM会加锁保证）：</p>
<ol>
<li><strong>执行静态变量的显式赋值语句</strong>（如 <code>num=10</code>）；</li>
<li><strong>执行静态代码块（static{}）中的代码</strong>；</li>
<li>若存在父类，<strong>先初始化父类</strong>，再初始化子类。</li>
</ol>
<h5 data-id="heading-18">✅ 经典示例（彻底理解）</h5>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">Parent</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> p = <span class="hljs-number">100</span>;
    <span class="hljs-keyword">static</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"父类静态代码块执行"</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title">Son</span> <span class="hljs-title">extends</span> <span class="hljs-title">Parent</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> s = <span class="hljs-number">200</span>;
    <span class="hljs-keyword">static</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"子类静态代码块执行"</span>);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(Son.s);
    }
}
</code></pre>
<p>👉 执行结果（严格遵循初始化顺序）：</p>
<pre><code class="hljs">父类静态代码块执行
子类静态代码块执行
200
</code></pre>
<p>👉 底层逻辑：</p>
<ul>
<li>调用 <code>Son.s</code> 属于「主动使用」，触发Son类初始化；</li>
<li>初始化Son前，先初始化父类Parent；</li>
<li>Parent中：先执行 <code>p=100</code>，再执行静态代码块；</li>
<li>Parent初始化完成后，执行Son的 <code>s=200</code>，再执行Son的静态代码块；</li>
<li>最终返回 <code>s=200</code>。</li>
</ul>
<h3 data-id="heading-19">三、类加载的核心特性（3个，必须掌握）</h3>
<p>Java 类加载机制设计了3个核心特性，保证了加载的高效性、安全性和灵活性，是面试高频考点：</p>
<h4 data-id="heading-20">✅ 特性1：<strong>双亲委派机制</strong>（核心，重中之重）</h4>
<h5 data-id="heading-21">1. 定义</h5>
<p>类加载器在加载类时，<strong>先委托父类加载器加载，父类加载失败后，自己才尝试加载</strong>，是一种「向上委托、向下查找」的加载机制。</p>
<h5 data-id="heading-22">2. 作用</h5>
<p>✅ 保证<strong>核心类的唯一性</strong>：如 <code>java.lang.String</code> 只会被「启动类加载器」加载，避免自定义类篡改核心类；</p>
<p>✅ 保证<strong>类加载的安全性</strong>：防止恶意类冒充核心类，破坏JVM运行。</p>
<h5 data-id="heading-23">3. 类加载器层级（自上而下）</h5>
<ol>
<li><strong>启动类加载器（Bootstrap ClassLoader）</strong> ：C++实现，加载JRE/lib核心类库（如rt.jar）；</li>
<li><strong>扩展类加载器（Extension ClassLoader）</strong> ：Java实现，加载JRE/lib/ext扩展类库；</li>
<li><strong>应用程序类加载器（Application ClassLoader）</strong> ：Java实现，加载项目classpath下的类（我们自己写的类）；</li>
<li><strong>自定义类加载器</strong>：继承 <code>ClassLoader</code>，按需加载自定义来源的类（如网络、加密文件）。</li>
</ol>
<h4 data-id="heading-24">✅ 特性2：<strong>懒加载（延迟加载）</strong></h4>
<p>JVM 不会在程序启动时加载所有类，而是<strong>在类被「主动使用」时才触发加载</strong>，极大节省内存开销，提升程序启动速度。</p>
<ul>
<li>类的加载、验证、准备阶段：随「主动使用」触发；</li>
<li>初始化阶段：严格按「主动使用」条件触发，且仅执行一次。</li>
</ul>
<h4 data-id="heading-25">✅ 特性3：<strong>缓存机制</strong></h4>
<p>类被加载后，JVM 会将其元数据缓存到方法区中，后续再次使用该类时，直接从缓存中获取 <code>Class</code> 对象，<strong>无需重复加载</strong>。</p>
<ul>
<li>缓存有效期：直到JVM退出；</li>
<li>作用：提升类的复用效率，避免重复执行加载、验证等开销。</li>
</ul>
<h3 data-id="heading-26">四、类加载后续阶段（使用+卸载）</h3>
<p>类加载的5个核心阶段完成后，类就进入「可用状态」，最终在满足条件时被卸载，完成完整生命周期：</p>
<h4 data-id="heading-27">✅ 阶段6：使用（Using）</h4>
<p>程序通过两种方式使用已初始化的类：</p>
<ol>
<li><strong>创建类的实例对象</strong>：<code>new User()</code>，调用实例方法、访问实例变量；</li>
<li><strong>调用类的静态成员</strong>：<code>User.staticMethod()</code>、<code>User.staticVar</code>。</li>
</ol>
<h4 data-id="heading-28">✅ 阶段7：卸载（Unloading）</h4>
<p>类的卸载是JVM回收方法区内存的过程，<strong>必须同时满足3个条件</strong>，否则不会被卸载（类的卸载条件极其苛刻）：</p>
<ol>
<li>该类的<strong>所有实例对象</strong>都已被GC回收，堆中无该类的任何实例；</li>
<li>该类的 <code>java.lang.Class</code> 对象，无任何地方被引用（如无反射、无静态变量引用）；</li>
<li>加载该类的<strong>类加载器</strong>已被GC回收。</li>
</ol>
<p>💡 结论：JVM的核心类（如 <code>java.lang.String</code>）永远不会被卸载，因为其被启动类加载器加载，且始终被JVM内部引用。</p>
<h3 data-id="heading-29">五、核心总结（必背，覆盖所有考点）</h3>
<ol>
<li>Java类加载核心流程：<strong>加载 → 验证 → 准备 → 解析 → 初始化</strong>，前4个为「链接阶段」，解析可延迟；</li>
<li>准备阶段：给<strong>静态变量</strong>分配内存，赋<strong>JVM默认值</strong>，不执行自定义赋值；</li>
<li>初始化阶段：执行<strong>静态赋值语句+静态代码块</strong>，仅在「主动使用」时触发，且<strong>先父后子</strong>；</li>
<li>类加载3大特性：<strong>双亲委派、懒加载、缓存机制</strong>，双亲委派是核心；</li>
<li>类卸载3个条件：无实例、无Class对象引用、类加载器被回收；</li>
<li>堆中的 <code>Class</code> 对象是访问方法区类元数据的唯一入口。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python多线程与多进程编程实战指南]]></title>    <link>https://juejin.cn/post/7588073726207918086</link>    <guid>https://juejin.cn/post/7588073726207918086</guid>    <pubDate>2025-12-27T07:20:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588073726207918086" data-draft-id="7588069469516808233" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Python多线程与多进程编程实战指南"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-27T07:20:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Python多线程与多进程编程实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T07:20:07.000Z" title="Sat Dec 27 2025 07:20:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,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");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,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");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,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");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">引言：理解并发与并行</h2>
<p>在处理大数据或高并发场景时，我们需要让程序同时做多件事情。Python提供了两种主要方式：多线程（threading）和多进程（multiprocessing）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 一个直观的例子：同步 vs 多线程 vs 多进程</span>
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">task</span>(<span class="hljs-params">n</span>):
    <span class="hljs-string">"""模拟耗时任务"""</span>
    result = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        result += i * i
    <span class="hljs-keyword">return</span> result

<span class="hljs-comment"># 同步执行（一个一个来）</span>
start = time.time()
<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):
    task(<span class="hljs-number">10000000</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"同步执行耗时: <span class="hljs-subst">{time.time() - start:<span class="hljs-number">.2</span>f}</span>秒"</span>)

<span class="hljs-comment"># 多线程执行（同时开始，但由于GIL限制，实际还是交替执行）</span>
<span class="hljs-comment"># 多进程执行（真正的同时执行）</span>
</code></pre>
<h2 data-id="heading-1">一、多线程编程</h2>
<h3 data-id="heading-2">1.1 创建和启动线程</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> time

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 多线程基础 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">name, delay</span>):
    <span class="hljs-string">"""工作者函数"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[<span class="hljs-subst">{name}</span>] 开始工作，需要 <span class="hljs-subst">{delay}</span> 秒"</span>)
    time.sleep(delay)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[<span class="hljs-subst">{name}</span>] 工作完成"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{name}</span>的结果"</span>

<span class="hljs-comment"># 方法1：直接创建线程</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">basic_threads</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"方法1：直接创建线程"</span>)
    
    <span class="hljs-comment"># 创建线程对象</span>
    thread1 = threading.Thread(target=worker, args=(<span class="hljs-string">"工人1"</span>, <span class="hljs-number">2</span>))
    thread2 = threading.Thread(target=worker, args=(<span class="hljs-string">"工人2"</span>, <span class="hljs-number">1</span>))
    thread3 = threading.Thread(target=worker, args=(<span class="hljs-string">"工人3"</span>, <span class="hljs-number">3</span>))
    
    <span class="hljs-comment"># 启动线程</span>
    thread1.start()
    thread2.start()
    thread3.start()
    
    <span class="hljs-comment"># 等待所有线程完成</span>
    thread1.join()
    thread2.join()
    thread3.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"所有线程工作完成"</span>)

<span class="hljs-comment"># 方法2：继承Thread类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyThread</span>(threading.Thread):
    <span class="hljs-string">"""自定义线程类"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, delay</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.name = name
        self.delay = delay
        self.result = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""线程执行的代码"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[<span class="hljs-subst">{self.name}</span>] 开始工作"</span>)
        time.sleep(self.delay)
        self.result = <span class="hljs-string">f"<span class="hljs-subst">{self.name}</span>完成任务"</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[<span class="hljs-subst">{self.name}</span>] 工作完成"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_result</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取结果"""</span>
        <span class="hljs-keyword">return</span> self.result

<span class="hljs-keyword">def</span> <span class="hljs-title function_">class_based_threads</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n方法2：继承Thread类"</span>)
    
    threads = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
        thread = MyThread(<span class="hljs-string">f"线程<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>"</span>, i+<span class="hljs-number">1</span>)
        thread.start()
        threads.append(thread)
    
    <span class="hljs-comment"># 等待并获取结果</span>
    <span class="hljs-keyword">for</span> thread <span class="hljs-keyword">in</span> threads:
        thread.join()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"结果: <span class="hljs-subst">{thread.get_result()}</span>"</span>)

<span class="hljs-comment"># 运行演示</span>
basic_threads()
class_based_threads()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-3">1.2 线程同步与通信</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> queue
<span class="hljs-keyword">import</span> time

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 线程同步与通信 ==="</span>)

<span class="hljs-comment"># 1. 线程锁 - 防止数据竞争</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BankAccount</span>:
    <span class="hljs-string">"""银行账户（线程安全）"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, balance=<span class="hljs-number">0</span></span>):
        self.balance = balance
        self.lock = threading.Lock()
        self.transactions = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">deposit</span>(<span class="hljs-params">self, amount, thread_name</span>):
        <span class="hljs-string">"""存款"""</span>
        <span class="hljs-keyword">with</span> self.lock:  <span class="hljs-comment"># 自动获取和释放锁</span>
            old_balance = self.balance
            self.balance += amount
            self.transactions.append(<span class="hljs-string">f"<span class="hljs-subst">{thread_name}</span>: 存款 <span class="hljs-subst">{amount}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{thread_name}</span>: 存款 <span class="hljs-subst">{amount}</span>, 余额: <span class="hljs-subst">{old_balance}</span> -&gt; <span class="hljs-subst">{self.balance}</span>"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">withdraw</span>(<span class="hljs-params">self, amount, thread_name</span>):
        <span class="hljs-string">"""取款"""</span>
        <span class="hljs-keyword">with</span> self.lock:
            <span class="hljs-keyword">if</span> self.balance &gt;= amount:
                old_balance = self.balance
                self.balance -= amount
                self.transactions.append(<span class="hljs-string">f"<span class="hljs-subst">{thread_name}</span>: 取款 <span class="hljs-subst">{amount}</span>"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{thread_name}</span>: 取款 <span class="hljs-subst">{amount}</span>, 余额: <span class="hljs-subst">{old_balance}</span> -&gt; <span class="hljs-subst">{self.balance}</span>"</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{thread_name}</span>: 取款失败，余额不足"</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_bank_account</span>():
    <span class="hljs-string">"""测试银行账户"""</span>
    account = BankAccount(<span class="hljs-number">1000</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">customer_operations</span>(<span class="hljs-params">name, operations</span>):
        <span class="hljs-keyword">for</span> op_type, amount <span class="hljs-keyword">in</span> operations:
            <span class="hljs-keyword">if</span> op_type == <span class="hljs-string">"deposit"</span>:
                account.deposit(amount, name)
            <span class="hljs-keyword">else</span>:
                account.withdraw(amount, name)
            time.sleep(<span class="hljs-number">0.1</span>)
    
    <span class="hljs-comment"># 多个客户同时操作账户</span>
    customers = [
        (<span class="hljs-string">"张三"</span>, [(<span class="hljs-string">"deposit"</span>, <span class="hljs-number">200</span>), (<span class="hljs-string">"withdraw"</span>, <span class="hljs-number">300</span>)]),
        (<span class="hljs-string">"李四"</span>, [(<span class="hljs-string">"deposit"</span>, <span class="hljs-number">500</span>), (<span class="hljs-string">"withdraw"</span>, <span class="hljs-number">800</span>)]),
        (<span class="hljs-string">"王五"</span>, [(<span class="hljs-string">"withdraw"</span>, <span class="hljs-number">400</span>), (<span class="hljs-string">"deposit"</span>, <span class="hljs-number">600</span>)])
    ]
    
    threads = []
    <span class="hljs-keyword">for</span> name, operations <span class="hljs-keyword">in</span> customers:
        thread = threading.Thread(target=customer_operations, args=(name, operations))
        thread.start()
        threads.append(thread)
    
    <span class="hljs-keyword">for</span> thread <span class="hljs-keyword">in</span> threads:
        thread.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n最终余额: <span class="hljs-subst">{account.balance}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"交易记录:"</span>, account.transactions)

<span class="hljs-comment"># 2. 队列 - 线程间安全通信</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">producer_consumer_demo</span>():
    <span class="hljs-string">"""生产者-消费者模式"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n生产者-消费者模式演示"</span>)
    
    q = queue.Queue(maxsize=<span class="hljs-number">5</span>)  <span class="hljs-comment"># 最大容量5</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">producer</span>(<span class="hljs-params">name, items</span>):
        <span class="hljs-string">"""生产者"""</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(items):
            item = <span class="hljs-string">f"<span class="hljs-subst">{name}</span>的产品-<span class="hljs-subst">{i}</span>"</span>
            q.put(item)  <span class="hljs-comment"># 如果队列满，会阻塞等待</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[生产者<span class="hljs-subst">{name}</span>] 生产: <span class="hljs-subst">{item}</span>"</span>)
            time.sleep(<span class="hljs-number">0.5</span>)
        q.put(<span class="hljs-literal">None</span>)  <span class="hljs-comment"># 发送结束信号</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">consumer</span>(<span class="hljs-params">name</span>):
        <span class="hljs-string">"""消费者"""</span>
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            item = q.get()  <span class="hljs-comment"># 如果队列空，会阻塞等待</span>
            <span class="hljs-keyword">if</span> item <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                q.put(<span class="hljs-literal">None</span>)  <span class="hljs-comment"># 传递结束信号给其他消费者</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[消费者<span class="hljs-subst">{name}</span>] 结束"</span>)
                <span class="hljs-keyword">break</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[消费者<span class="hljs-subst">{name}</span>] 消费: <span class="hljs-subst">{item}</span>"</span>)
            time.sleep(<span class="hljs-number">1</span>)
            q.task_done()
    
    <span class="hljs-comment"># 启动生产者和消费者</span>
    producers = [
        threading.Thread(target=producer, args=(<span class="hljs-string">"A"</span>, <span class="hljs-number">5</span>)),
        threading.Thread(target=producer, args=(<span class="hljs-string">"B"</span>, <span class="hljs-number">3</span>))
    ]
    
    consumers = [
        threading.Thread(target=consumer, args=(<span class="hljs-string">"1"</span>,)),
        threading.Thread(target=consumer, args=(<span class="hljs-string">"2"</span>,))
    ]
    
    <span class="hljs-comment"># 启动所有线程</span>
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> producers:
        p.start()
    
    <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> consumers:
        c.start()
    
    <span class="hljs-comment"># 等待生产者完成</span>
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> producers:
        p.join()
    
    <span class="hljs-comment"># 等待队列清空</span>
    q.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"所有任务完成"</span>)

<span class="hljs-comment"># 运行演示</span>
test_bank_account()
producer_consumer_demo()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-4">1.3 线程池</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor
<span class="hljs-keyword">import</span> time

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 线程池 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_item</span>(<span class="hljs-params">item</span>):
    <span class="hljs-string">"""处理单个项目"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始处理: <span class="hljs-subst">{item}</span>"</span>)
    time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 模拟耗时操作</span>
    result = <span class="hljs-string">f"<span class="hljs-subst">{item}</span>_processed"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理完成: <span class="hljs-subst">{item}</span> -&gt; <span class="hljs-subst">{result}</span>"</span>)
    <span class="hljs-keyword">return</span> result

<span class="hljs-keyword">def</span> <span class="hljs-title function_">thread_pool_demo</span>():
    <span class="hljs-string">"""线程池演示"""</span>
    
    items = [<span class="hljs-string">f"item_<span class="hljs-subst">{i}</span>"</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)]
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始处理 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(items)}</span> 个项目"</span>)
    start_time = time.time()
    
    <span class="hljs-comment"># 使用线程池（最大3个线程）</span>
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> executor:
        <span class="hljs-comment"># 提交所有任务</span>
        future_to_item = {executor.submit(process_item, item): item 
                         <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items}
        
        <span class="hljs-comment"># 收集结果</span>
        results = []
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> future_to_item:
            result = future.result()
            results.append(result)
    
    end_time = time.time()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n所有项目处理完成!"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时: <span class="hljs-subst">{end_time - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理了 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(results)}</span> 个项目"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"结果样例: <span class="hljs-subst">{results[:<span class="hljs-number">3</span>]}</span>..."</span>)

<span class="hljs-comment"># 高级特性：回调函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">callback_demo</span>():
    <span class="hljs-string">"""回调函数演示"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n线程池回调函数演示"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">task</span>(<span class="hljs-params">n</span>):
        <span class="hljs-string">"""任务函数"""</span>
        <span class="hljs-keyword">return</span> n * n
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">callback</span>(<span class="hljs-params">future</span>):
        <span class="hljs-string">"""回调函数"""</span>
        result = future.result()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"回调: 任务完成，结果=<span class="hljs-subst">{result}</span>"</span>)
    
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> executor:
        <span class="hljs-comment"># 提交任务并添加回调</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
            future = executor.submit(task, i)
            future.add_done_callback(callback)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"所有回调执行完成"</span>)

<span class="hljs-comment"># 运行演示</span>
thread_pool_demo()
callback_demo()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-5">二、多进程编程</h2>
<h3 data-id="heading-6">2.1 创建进程</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> multiprocessing
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> os

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 多进程基础 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">worker_process</span>(<span class="hljs-params">name, delay</span>):
    <span class="hljs-string">"""工作进程函数"""</span>
    pid = os.getpid()  <span class="hljs-comment"># 获取进程ID</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[进程<span class="hljs-subst">{pid}</span>] <span class="hljs-subst">{name}</span> 开始工作，需要 <span class="hljs-subst">{delay}</span> 秒"</span>)
    time.sleep(delay)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[进程<span class="hljs-subst">{pid}</span>] <span class="hljs-subst">{name}</span> 工作完成"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{name}</span>的结果"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">basic_processes</span>():
    <span class="hljs-string">"""基本进程创建"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"创建多个进程"</span>)
    
    processes = []
    
    <span class="hljs-comment"># 创建进程</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
        p = multiprocessing.Process(
            target=worker_process,
            args=(<span class="hljs-string">f"工人<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>"</span>, i+<span class="hljs-number">1</span>)
        )
        processes.append(p)
        p.start()
    
    <span class="hljs-comment"># 等待所有进程完成</span>
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:
        p.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"所有进程工作完成"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_pool_demo</span>():
    <span class="hljs-string">"""进程池演示"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n使用进程池"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cpu_intensive_task</span>(<span class="hljs-params">n</span>):
        <span class="hljs-string">"""CPU密集型任务"""</span>
        result = <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
            result += i * i
        pid = os.getpid()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[进程<span class="hljs-subst">{pid}</span>] 完成计算 n=<span class="hljs-subst">{n}</span>"</span>)
        <span class="hljs-keyword">return</span> result
    
    numbers = [<span class="hljs-number">1000000</span>, <span class="hljs-number">2000000</span>, <span class="hljs-number">3000000</span>, <span class="hljs-number">4000000</span>]
    
    start_time = time.time()
    
    <span class="hljs-comment"># 使用进程池</span>
    <span class="hljs-keyword">with</span> multiprocessing.Pool(processes=<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> pool:
        results = pool.<span class="hljs-built_in">map</span>(cpu_intensive_task, numbers)
    
    end_time = time.time()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"计算完成!"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"结果: <span class="hljs-subst">{results}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时: <span class="hljs-subst">{end_time - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)

<span class="hljs-comment"># 运行演示</span>
basic_processes()
process_pool_demo()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-7">2.2 进程间通信</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> multiprocessing
<span class="hljs-keyword">import</span> time

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 进程间通信 ==="</span>)

<span class="hljs-comment"># 1. 队列通信</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">queue_communication</span>():
    <span class="hljs-string">"""使用队列进行进程间通信"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 队列通信演示"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">producer</span>(<span class="hljs-params">queue, items</span>):
        <span class="hljs-string">"""生产者进程"""</span>
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[生产者] 发送: <span class="hljs-subst">{item}</span>"</span>)
            queue.put(item)
            time.sleep(<span class="hljs-number">0.5</span>)
        queue.put(<span class="hljs-literal">None</span>)  <span class="hljs-comment"># 结束信号</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">consumer</span>(<span class="hljs-params">queue, name</span>):
        <span class="hljs-string">"""消费者进程"""</span>
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            item = queue.get()
            <span class="hljs-keyword">if</span> item <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                queue.put(<span class="hljs-literal">None</span>)  <span class="hljs-comment"># 传递结束信号</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[消费者<span class="hljs-subst">{name}</span>] 结束"</span>)
                <span class="hljs-keyword">break</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[消费者<span class="hljs-subst">{name}</span>] 收到: <span class="hljs-subst">{item}</span>"</span>)
            time.sleep(<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># 创建队列</span>
    q = multiprocessing.Queue(maxsize=<span class="hljs-number">3</span>)
    
    <span class="hljs-comment"># 创建进程</span>
    producer_p = multiprocessing.Process(
        target=producer,
        args=(q, [<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>, <span class="hljs-string">"E"</span>])
    )
    
    consumer1_p = multiprocessing.Process(
        target=consumer,
        args=(q, <span class="hljs-string">"1"</span>)
    )
    
    consumer2_p = multiprocessing.Process(
        target=consumer,
        args=(q, <span class="hljs-string">"2"</span>)
    )
    
    <span class="hljs-comment"># 启动进程</span>
    producer_p.start()
    consumer1_p.start()
    consumer2_p.start()
    
    <span class="hljs-comment"># 等待完成</span>
    producer_p.join()
    consumer1_p.join()
    consumer2_p.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"队列通信完成"</span>)

<span class="hljs-comment"># 2. 管道通信</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">pipe_communication</span>():
    <span class="hljs-string">"""使用管道进行进程间通信"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n2. 管道通信演示"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_a</span>(<span class="hljs-params">conn</span>):
        <span class="hljs-string">"""进程A"""</span>
        conn.send(<span class="hljs-string">"Hello from Process A"</span>)
        data = conn.recv()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[Process A] 收到: <span class="hljs-subst">{data}</span>"</span>)
        conn.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_b</span>(<span class="hljs-params">conn</span>):
        <span class="hljs-string">"""进程B"""</span>
        data = conn.recv()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[Process B] 收到: <span class="hljs-subst">{data}</span>"</span>)
        conn.send(<span class="hljs-string">"Hello from Process B"</span>)
        conn.close()
    
    <span class="hljs-comment"># 创建管道</span>
    parent_conn, child_conn = multiprocessing.Pipe()
    
    <span class="hljs-comment"># 创建进程</span>
    p1 = multiprocessing.Process(target=process_a, args=(parent_conn,))
    p2 = multiprocessing.Process(target=process_b, args=(child_conn,))
    
    <span class="hljs-comment"># 启动进程</span>
    p1.start()
    p2.start()
    
    <span class="hljs-comment"># 等待完成</span>
    p1.join()
    p2.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"管道通信完成"</span>)

<span class="hljs-comment"># 3. 共享内存</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">shared_memory_demo</span>():
    <span class="hljs-string">"""共享内存演示"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n3. 共享内存演示"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">shared_value, shared_array, lock, worker_id</span>):
        <span class="hljs-string">"""工作进程"""</span>
        <span class="hljs-keyword">with</span> lock:
            shared_value.value += <span class="hljs-number">1</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[Worker <span class="hljs-subst">{worker_id}</span>] 共享值: <span class="hljs-subst">{shared_value.value}</span>"</span>)
        
        <span class="hljs-comment"># 修改共享数组</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(shared_array)):
            shared_array[i] = worker_id * <span class="hljs-number">10</span> + i
    
    <span class="hljs-comment"># 创建共享值</span>
    shared_value = multiprocessing.Value(<span class="hljs-string">'i'</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># 整数类型</span>
    
    <span class="hljs-comment"># 创建共享数组</span>
    shared_array = multiprocessing.Array(<span class="hljs-string">'i'</span>, <span class="hljs-number">5</span>)  <span class="hljs-comment"># 5个整数的数组</span>
    
    <span class="hljs-comment"># 创建锁</span>
    lock = multiprocessing.Lock()
    
    <span class="hljs-comment"># 创建多个进程</span>
    processes = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
        p = multiprocessing.Process(
            target=worker,
            args=(shared_value, shared_array, lock, i+<span class="hljs-number">1</span>)
        )
        processes.append(p)
        p.start()
    
    <span class="hljs-comment"># 等待所有进程完成</span>
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:
        p.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"最终共享值: <span class="hljs-subst">{shared_value.value}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"共享数组: <span class="hljs-subst">{<span class="hljs-built_in">list</span>(shared_array)}</span>"</span>)

<span class="hljs-comment"># 运行演示</span>
queue_communication()
pipe_communication()
shared_memory_demo()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-8">三、选择指南：线程 vs 进程</h2>
<h3 data-id="heading-9">3.1 性能对比</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> multiprocessing
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">def</span> <span class="hljs-title function_">cpu_bound_task</span>(<span class="hljs-params">n</span>):
    <span class="hljs-string">"""CPU密集型任务"""</span>
    count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        count += i * i
    <span class="hljs-keyword">return</span> count

<span class="hljs-keyword">def</span> <span class="hljs-title function_">io_bound_task</span>(<span class="hljs-params">duration</span>):
    <span class="hljs-string">"""I/O密集型任务"""</span>
    time.sleep(duration)
    <span class="hljs-keyword">return</span> duration

<span class="hljs-keyword">def</span> <span class="hljs-title function_">compare_performance</span>():
    <span class="hljs-string">"""比较线程和进程的性能"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 线程 vs 进程 性能对比 ==="</span>)
    
    <span class="hljs-comment"># 测试配置</span>
    task_count = <span class="hljs-number">4</span>
    cpu_task_size = <span class="hljs-number">10000000</span>
    io_task_duration = <span class="hljs-number">1</span>
    
    <span class="hljs-comment"># 1. CPU密集型任务对比</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n1. CPU密集型任务对比:"</span>)
    
    <span class="hljs-comment"># 单线程</span>
    start = time.time()
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(task_count):
        cpu_bound_task(cpu_task_size)
    single_time = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  单线程: <span class="hljs-subst">{single_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    
    <span class="hljs-comment"># 多线程（由于GIL，可能不会更快）</span>
    start = time.time()
    threads = []
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(task_count):
        t = threading.Thread(target=cpu_bound_task, args=(cpu_task_size,))
        t.start()
        threads.append(t)
    
    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> threads:
        t.join()
    thread_time = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  多线程(<span class="hljs-subst">{task_count}</span>线程): <span class="hljs-subst">{thread_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    
    <span class="hljs-comment"># 多进程</span>
    start = time.time()
    processes = []
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(task_count):
        p = multiprocessing.Process(target=cpu_bound_task, args=(cpu_task_size,))
        p.start()
        processes.append(p)
    
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:
        p.join()
    process_time = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  多进程(<span class="hljs-subst">{task_count}</span>进程): <span class="hljs-subst">{process_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  CPU任务结论: 多进程比多线程快 <span class="hljs-subst">{thread_time/process_time:<span class="hljs-number">.1</span>f}</span>倍"</span>)
    
    <span class="hljs-comment"># 2. I/O密集型任务对比</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n2. I/O密集型任务对比:"</span>)
    
    <span class="hljs-comment"># 单线程</span>
    start = time.time()
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(task_count):
        io_bound_task(io_task_duration)
    single_io_time = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  单线程: <span class="hljs-subst">{single_io_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    
    <span class="hljs-comment"># 多线程</span>
    start = time.time()
    threads = []
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(task_count):
        t = threading.Thread(target=io_bound_task, args=(io_task_duration,))
        t.start()
        threads.append(t)
    
    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> threads:
        t.join()
    thread_io_time = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  多线程(<span class="hljs-subst">{task_count}</span>线程): <span class="hljs-subst">{thread_io_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    
    <span class="hljs-comment"># 多进程</span>
    start = time.time()
    processes = []
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(task_count):
        p = multiprocessing.Process(target=io_bound_task, args=(io_task_duration,))
        p.start()
        processes.append(p)
    
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:
        p.join()
    process_io_time = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  多进程(<span class="hljs-subst">{task_count}</span>进程): <span class="hljs-subst">{process_io_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  I/O任务结论: 多线程比单线程快 <span class="hljs-subst">{single_io_time/thread_io_time:<span class="hljs-number">.1</span>f}</span>倍"</span>)
    
    <span class="hljs-comment"># 3. 内存使用对比</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n3. 内存使用注意事项:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"  - 线程: 共享内存，内存使用少，但需要处理线程安全问题"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"  - 进程: 独立内存空间，内存使用多，但不需要处理线程安全问题"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"  - 线程创建开销: 小"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"  - 进程创建开销: 大"</span>)
    
    <span class="hljs-comment"># 4. 选择指南</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n4. 选择指南:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"  使用多线程的场景:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    ✓ I/O密集型任务（网络请求、文件读写）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    ✓ 需要共享数据"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    ✓ 任务执行时间短"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n  使用多进程的场景:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    ✓ CPU密集型任务（科学计算、图像处理）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    ✓ 需要进程隔离（一个进程崩溃不影响其他进程）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    ✓ 需要利用多核CPU"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n  通用建议:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    - 优先使用concurrent.futures模块"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    - I/O密集型：使用ThreadPoolExecutor"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    - CPU密集型：使用ProcessPoolExecutor"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    - 任务数量多但简单：使用线程池/进程池"</span>)

<span class="hljs-comment"># 运行比较</span>
compare_performance()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-10">3.2 实战案例：并行下载管理器</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> concurrent.futures
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ParallelDownloader</span>:
    <span class="hljs-string">"""并行下载管理器"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_workers=<span class="hljs-number">5</span>, download_dir=<span class="hljs-string">"downloads"</span></span>):
        self.max_workers = max_workers
        self.download_dir = download_dir
        
        <span class="hljs-comment"># 创建下载目录</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(download_dir):
            os.makedirs(download_dir)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download_file</span>(<span class="hljs-params">self, url, filename=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""下载单个文件"""</span>
        <span class="hljs-keyword">if</span> filename <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            filename = url.split(<span class="hljs-string">"/"</span>)[-<span class="hljs-number">1</span>]
        
        filepath = os.path.join(self.download_dir, filename)
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始下载: <span class="hljs-subst">{url}</span>"</span>)
            start_time = time.time()
            
            response = requests.get(url, stream=<span class="hljs-literal">True</span>, timeout=<span class="hljs-number">10</span>)
            response.raise_for_status()
            
            total_size = <span class="hljs-built_in">int</span>(response.headers.get(<span class="hljs-string">'content-length'</span>, <span class="hljs-number">0</span>))
            downloaded = <span class="hljs-number">0</span>
            
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filepath, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:
                <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> response.iter_content(chunk_size=<span class="hljs-number">8192</span>):
                    <span class="hljs-keyword">if</span> chunk:
                        f.write(chunk)
                        downloaded += <span class="hljs-built_in">len</span>(chunk)
                        
                        <span class="hljs-comment"># 显示进度</span>
                        <span class="hljs-keyword">if</span> total_size &gt; <span class="hljs-number">0</span>:
                            percent = downloaded * <span class="hljs-number">100</span> / total_size
                            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{filename}</span>: <span class="hljs-subst">{percent:<span class="hljs-number">.1</span>f}</span>%"</span>, end=<span class="hljs-string">'\r'</span>)
            
            end_time = time.time()
            download_time = end_time - start_time
            
            file_size = os.path.getsize(filepath)
            speed = file_size / download_time / <span class="hljs-number">1024</span>  <span class="hljs-comment"># KB/s</span>
            
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"下载完成: <span class="hljs-subst">{filename}</span> (<span class="hljs-subst">{file_size/<span class="hljs-number">1024</span>:<span class="hljs-number">.1</span>f}</span>KB, <span class="hljs-subst">{speed:<span class="hljs-number">.1</span>f}</span>KB/s)"</span>)
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'url'</span>: url,
                <span class="hljs-string">'filename'</span>: filename,
                <span class="hljs-string">'success'</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">'size'</span>: file_size,
                <span class="hljs-string">'time'</span>: download_time,
                <span class="hljs-string">'speed'</span>: speed
            }
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"下载失败 <span class="hljs-subst">{url}</span>: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'url'</span>: url,
                <span class="hljs-string">'filename'</span>: filename,
                <span class="hljs-string">'success'</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">'error'</span>: <span class="hljs-built_in">str</span>(e)
            }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parallel_download</span>(<span class="hljs-params">self, url_list</span>):
        <span class="hljs-string">"""并行下载多个文件"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始并行下载 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(url_list)}</span> 个文件"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"工作线程数: <span class="hljs-subst">{self.max_workers}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
        
        start_time = time.time()
        results = []
        
        <span class="hljs-comment"># 使用线程池（I/O密集型任务适合用线程）</span>
        <span class="hljs-keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=self.max_workers) <span class="hljs-keyword">as</span> executor:
            <span class="hljs-comment"># 提交所有下载任务</span>
            future_to_url = {}
            <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> url_list:
                filename = url.split(<span class="hljs-string">"/"</span>)[-<span class="hljs-number">1</span>]
                future = executor.submit(self.download_file, url, filename)
                future_to_url[future] = url
            
            <span class="hljs-comment"># 收集结果</span>
            <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> concurrent.futures.as_completed(future_to_url):
                url = future_to_url[future]
                <span class="hljs-keyword">try</span>:
                    result = future.result()
                    results.append(result)
                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务异常 <span class="hljs-subst">{url}</span>: <span class="hljs-subst">{e}</span>"</span>)
                    results.append({
                        <span class="hljs-string">'url'</span>: url,
                        <span class="hljs-string">'success'</span>: <span class="hljs-literal">False</span>,
                        <span class="hljs-string">'error'</span>: <span class="hljs-built_in">str</span>(e)
                    })
        
        end_time = time.time()
        total_time = end_time - start_time
        
        <span class="hljs-comment"># 统计结果</span>
        successful = [r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results <span class="hljs-keyword">if</span> r[<span class="hljs-string">'success'</span>]]
        failed = [r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> r[<span class="hljs-string">'success'</span>]]
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"下载完成!"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时: <span class="hljs-subst">{total_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(successful)}</span> 个"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"失败: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(failed)}</span> 个"</span>)
        
        <span class="hljs-keyword">if</span> successful:
            total_size = <span class="hljs-built_in">sum</span>(r[<span class="hljs-string">'size'</span>] <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> successful)
            avg_speed = <span class="hljs-built_in">sum</span>(r[<span class="hljs-string">'speed'</span>] <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> successful) / <span class="hljs-built_in">len</span>(successful)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总大小: <span class="hljs-subst">{total_size/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>:<span class="hljs-number">.2</span>f}</span>MB"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均速度: <span class="hljs-subst">{avg_speed:<span class="hljs-number">.1</span>f}</span>KB/s"</span>)
        
        <span class="hljs-keyword">if</span> failed:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n失败的文件:"</span>)
            <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> failed:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{result[<span class="hljs-string">'url'</span>]}</span>: <span class="hljs-subst">{result.get(<span class="hljs-string">'error'</span>, <span class="hljs-string">'未知错误'</span>)}</span>"</span>)
        
        <span class="hljs-keyword">return</span> results

<span class="hljs-comment"># 模拟使用</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_downloader</span>():
    <span class="hljs-string">"""下载管理器演示"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 并行下载管理器演示 ==="</span>)
    
    <span class="hljs-comment"># 示例URL列表（实际使用时替换为真实URL）</span>
    <span class="hljs-comment"># 注意：这里使用一些公开的测试URL</span>
    test_urls = [
        <span class="hljs-string">"https://httpbin.org/image/jpeg"</span>,  <span class="hljs-comment"># 测试图片</span>
        <span class="hljs-string">"https://httpbin.org/image/png"</span>,
        <span class="hljs-string">"https://httpbin.org/image/svg"</span>,
        <span class="hljs-string">"https://httpbin.org/html"</span>,        <span class="hljs-comment"># 测试HTML</span>
        <span class="hljs-string">"https://httpbin.org/robots.txt"</span>,  <span class="hljs-comment"># 测试文本</span>
        <span class="hljs-string">"https://httpbin.org/xml"</span>          <span class="hljs-comment"># 测试XML</span>
    ]
    
    <span class="hljs-comment"># 创建下载管理器</span>
    downloader = ParallelDownloader(max_workers=<span class="hljs-number">3</span>, download_dir=<span class="hljs-string">"test_downloads"</span>)
    
    <span class="hljs-comment"># 执行并行下载</span>
    results = downloader.parallel_download(test_urls)
    
    <span class="hljs-keyword">return</span> results

<span class="hljs-built_in">print</span>(<span class="hljs-string">"实战案例：并行下载管理器"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"这个管理器可以同时下载多个文件，提高下载效率"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"注意：演示代码中使用的是测试URL，实际使用时需要替换为真实URL"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-11">总结：最佳实践指南</h2>
<h3 data-id="heading-12">关键决策点：</h3>
<ol>
<li><strong>CPU密集型任务</strong> → 使用多进程</li>
<li><strong>I/O密集型任务</strong> → 使用多线程</li>
<li><strong>需要数据共享</strong> → 多线程或共享内存</li>
<li><strong>需要进程隔离</strong> → 多进程</li>
<li><strong>不确定任务类型</strong> → 先测试，后选择</li>
</ol>
<h3 data-id="heading-13">最佳实践：</h3>
<ol>
<li><strong>使用高层API</strong>：优先使用<code>concurrent.futures</code>模块</li>
<li><strong>控制并发数</strong>：合理设置线程/进程数量</li>
<li><strong>处理异常</strong>：确保异常不会导致程序崩溃</li>
<li><strong>资源清理</strong>：使用with语句确保资源正确释放</li>
<li><strong>性能监控</strong>：记录执行时间和资源使用情况</li>
</ol>
<h3 data-id="heading-14">常见陷阱：</h3>
<ol>
<li><strong>死锁</strong>：多个锁相互等待</li>
<li><strong>竞态条件</strong>：多个线程同时修改共享数据</li>
<li><strong>内存泄漏</strong>：忘记释放资源</li>
<li><strong>过度并发</strong>：创建过多线程/进程导致系统卡顿</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mysql索引影响查询速度的示例demo]]></title>    <link>https://juejin.cn/post/7588034035287392271</link>    <guid>https://juejin.cn/post/7588034035287392271</guid>    <pubDate>2025-12-27T08:56:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588034035287392271" data-draft-id="7588034035287359503" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mysql索引影响查询速度的示例demo"/> <meta itemprop="keywords" content="MySQL"/> <meta itemprop="datePublished" content="2025-12-27T08:56:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mysql索引影响查询速度的示例demo
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T08:56:15.000Z" title="Sat Dec 27 2025 08:56:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>创建一个完整的索引影响查询速度的示例demo，通过实际对比可以直观感受索引的强大作用。</p>
<h2 data-id="heading-0">一、测试环境准备</h2>
<h3 data-id="heading-1">1. 创建测试数据库和表</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建测试数据库</span>
<span class="hljs-keyword">CREATE</span> DATABASE index_demo;
USE index_demo;

<span class="hljs-comment">-- 创建用户表（无索引状态）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users_no_index (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    age <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    city <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    created_at DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 创建用户表（有索引状态）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users_with_index (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    age <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    city <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    created_at DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_age_city (age, city),
    INDEX idx_created_at (created_at)
);
</code></pre>
<h3 data-id="heading-2">2. 插入大量测试数据</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 插入50万条测试数据</span>
DELIMITER $$
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> insert_test_data()
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> i <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>;
    WHILE i <span class="hljs-operator">&lt;=</span> <span class="hljs-number">500000</span> DO
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users_no_index (username, email, age, city) <span class="hljs-keyword">VALUES</span> (
            CONCAT(<span class="hljs-string">'user'</span>, i),
            CONCAT(<span class="hljs-string">'user'</span>, i, <span class="hljs-string">'@example.com'</span>),
            <span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">18</span> <span class="hljs-operator">+</span> RAND() <span class="hljs-operator">*</span> <span class="hljs-number">50</span>),
            ELT(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> RAND() <span class="hljs-operator">*</span> <span class="hljs-number">10</span>), <span class="hljs-string">'北京'</span>, <span class="hljs-string">'上海'</span>, <span class="hljs-string">'广州'</span>, <span class="hljs-string">'深圳'</span>, <span class="hljs-string">'杭州'</span>, <span class="hljs-string">'南京'</span>, <span class="hljs-string">'武汉'</span>, <span class="hljs-string">'成都'</span>, <span class="hljs-string">'西安'</span>, <span class="hljs-string">'重庆'</span>)
        );
        
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users_with_index (username, email, age, city) <span class="hljs-keyword">VALUES</span> (
            CONCAT(<span class="hljs-string">'user'</span>, i),
            CONCAT(<span class="hljs-string">'user'</span>, i, <span class="hljs-string">'@example.com'</span>),
            <span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">18</span> <span class="hljs-operator">+</span> RAND() <span class="hljs-operator">*</span> <span class="hljs-number">50</span>),
            ELT(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> RAND() <span class="hljs-operator">*</span> <span class="hljs-number">10</span>), <span class="hljs-string">'北京'</span>, <span class="hljs-string">'上海'</span>, <span class="hljs-string">'广州'</span>, <span class="hljs-string">'深圳'</span>, <span class="hljs-string">'杭州'</span>, <span class="hljs-string">'南京'</span>, <span class="hljs-string">'武汉'</span>, <span class="hljs-string">'成都'</span>, <span class="hljs-string">'西安'</span>, <span class="hljs-string">'重庆'</span>)
        );
        
        IF i <span class="hljs-operator">%</span> <span class="hljs-number">10000</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-keyword">SELECT</span> CONCAT(<span class="hljs-string">'已插入 '</span>, i, <span class="hljs-string">' 条数据'</span>) <span class="hljs-keyword">AS</span> progress;
        <span class="hljs-keyword">END</span> IF;
        <span class="hljs-keyword">SET</span> i <span class="hljs-operator">=</span> i <span class="hljs-operator">+</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">END</span> WHILE;
<span class="hljs-keyword">END</span>$$
DELIMITER ;

<span class="hljs-comment">-- 执行数据插入（这可能需要几分钟）</span>
<span class="hljs-keyword">CALL</span> insert_test_data();
</code></pre>
<h2 data-id="heading-3">二、性能对比测试</h2>
<h3 data-id="heading-4">测试1：基本查询对比</h3>
<pre><code class="hljs language-sql" lang="sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users_no_index <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'user110000'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> id     <span class="hljs-operator">|</span> username   <span class="hljs-operator">|</span> email                  <span class="hljs-operator">|</span> age <span class="hljs-operator">|</span> city   <span class="hljs-operator">|</span> created_at          <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">110000</span> <span class="hljs-operator">|</span> user110000 <span class="hljs-operator">|</span> user110000<span class="hljs-variable">@example</span>.com <span class="hljs-operator">|</span>  <span class="hljs-number">36</span> <span class="hljs-operator">|</span> 北京   <span class="hljs-operator">|</span> <span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">15</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.08</span> sec)

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users_with_index <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'user110000'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> id     <span class="hljs-operator">|</span> username   <span class="hljs-operator">|</span> email                  <span class="hljs-operator">|</span> age <span class="hljs-operator">|</span> city   <span class="hljs-operator">|</span> created_at          <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">110000</span> <span class="hljs-operator">|</span> user110000 <span class="hljs-operator">|</span> user110000<span class="hljs-variable">@example</span>.com <span class="hljs-operator">|</span>  <span class="hljs-number">66</span> <span class="hljs-operator">|</span> 成都   <span class="hljs-operator">|</span> <span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">15</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)
</code></pre>
<h3 data-id="heading-5">测试2：精确的性能测量</h3>
<pre><code class="hljs language-sql" lang="sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SET</span> profiling <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)

mysql<span class="hljs-operator">&gt;</span> 
mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users_no_index <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'user110000'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> id     <span class="hljs-operator">|</span> username   <span class="hljs-operator">|</span> email                  <span class="hljs-operator">|</span> age <span class="hljs-operator">|</span> city   <span class="hljs-operator">|</span> created_at          <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">110000</span> <span class="hljs-operator">|</span> user110000 <span class="hljs-operator">|</span> user110000<span class="hljs-variable">@example</span>.com <span class="hljs-operator">|</span>  <span class="hljs-number">36</span> <span class="hljs-operator">|</span> 北京   <span class="hljs-operator">|</span> <span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">15</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.07</span> sec)

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SHOW</span> PROFILE <span class="hljs-keyword">FOR</span> QUERY <span class="hljs-number">1</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span>
<span class="hljs-operator">|</span> Status                         <span class="hljs-operator">|</span> Duration <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span>
<span class="hljs-operator">|</span> starting                       <span class="hljs-operator">|</span> <span class="hljs-number">0.000094</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> Executing hook <span class="hljs-keyword">on</span> transaction  <span class="hljs-operator">|</span> <span class="hljs-number">0.000006</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> starting                       <span class="hljs-operator">|</span> <span class="hljs-number">0.000034</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> checking permissions           <span class="hljs-operator">|</span> <span class="hljs-number">0.000006</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> Opening tables                 <span class="hljs-operator">|</span> <span class="hljs-number">0.000034</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> init                           <span class="hljs-operator">|</span> <span class="hljs-number">0.000011</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-keyword">System</span> lock                    <span class="hljs-operator">|</span> <span class="hljs-number">0.000007</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> optimizing                     <span class="hljs-operator">|</span> <span class="hljs-number">0.000011</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> statistics                     <span class="hljs-operator">|</span> <span class="hljs-number">0.000022</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> preparing                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000021</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> executing                      <span class="hljs-operator">|</span> <span class="hljs-number">0.073159</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-keyword">end</span>                            <span class="hljs-operator">|</span> <span class="hljs-number">0.000040</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> query <span class="hljs-keyword">end</span>                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000004</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> waiting <span class="hljs-keyword">for</span> handler <span class="hljs-keyword">commit</span>     <span class="hljs-operator">|</span> <span class="hljs-number">0.000007</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> closing tables                 <span class="hljs-operator">|</span> <span class="hljs-number">0.000008</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> freeing items                  <span class="hljs-operator">|</span> <span class="hljs-number">0.000220</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> cleaning up                    <span class="hljs-operator">|</span> <span class="hljs-number">0.000018</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span>
<span class="hljs-number">17</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users_with_index <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'user110000'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> id     <span class="hljs-operator">|</span> username   <span class="hljs-operator">|</span> email                  <span class="hljs-operator">|</span> age <span class="hljs-operator">|</span> city   <span class="hljs-operator">|</span> created_at          <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">110000</span> <span class="hljs-operator">|</span> user110000 <span class="hljs-operator">|</span> user110000<span class="hljs-variable">@example</span>.com <span class="hljs-operator">|</span>  <span class="hljs-number">66</span> <span class="hljs-operator">|</span> 成都   <span class="hljs-operator">|</span> <span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">15</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)

mysql<span class="hljs-operator">&gt;</span> 
mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SHOW</span> PROFILE <span class="hljs-keyword">FOR</span> QUERY <span class="hljs-number">2</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span>
<span class="hljs-operator">|</span> Status                         <span class="hljs-operator">|</span> Duration <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span>
<span class="hljs-operator">|</span> starting                       <span class="hljs-operator">|</span> <span class="hljs-number">0.000096</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> Executing hook <span class="hljs-keyword">on</span> transaction  <span class="hljs-operator">|</span> <span class="hljs-number">0.000006</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> starting                       <span class="hljs-operator">|</span> <span class="hljs-number">0.000005</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> checking permissions           <span class="hljs-operator">|</span> <span class="hljs-number">0.000005</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> Opening tables                 <span class="hljs-operator">|</span> <span class="hljs-number">0.000040</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> init                           <span class="hljs-operator">|</span> <span class="hljs-number">0.000005</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-keyword">System</span> lock                    <span class="hljs-operator">|</span> <span class="hljs-number">0.000006</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> optimizing                     <span class="hljs-operator">|</span> <span class="hljs-number">0.000011</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> statistics                     <span class="hljs-operator">|</span> <span class="hljs-number">0.000089</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> preparing                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000040</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> executing                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000051</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-keyword">end</span>                            <span class="hljs-operator">|</span> <span class="hljs-number">0.000005</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> query <span class="hljs-keyword">end</span>                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000005</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> waiting <span class="hljs-keyword">for</span> handler <span class="hljs-keyword">commit</span>     <span class="hljs-operator">|</span> <span class="hljs-number">0.000007</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> closing tables                 <span class="hljs-operator">|</span> <span class="hljs-number">0.000006</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> freeing items                  <span class="hljs-operator">|</span> <span class="hljs-number">0.000168</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> cleaning up                    <span class="hljs-operator">|</span> <span class="hljs-number">0.000012</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span>
<span class="hljs-number">17</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SHOW</span> PROFILES;
<span class="hljs-operator">+</span><span class="hljs-comment">----------+------------+--------------------------------------------------------------+</span>
<span class="hljs-operator">|</span> Query_ID <span class="hljs-operator">|</span> Duration   <span class="hljs-operator">|</span> Query                                                        <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------+------------+--------------------------------------------------------------+</span>
<span class="hljs-operator">|</span>        <span class="hljs-number">1</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.07369975</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users_no_index <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'user110000'</span>   <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>        <span class="hljs-number">2</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.00055400</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users_with_index <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'user110000'</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------+------------+--------------------------------------------------------------+</span>
<span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年终醒悟，AI 让我误以为自己很强，未来程序员的转型之路]]></title>    <link>https://juejin.cn/post/7587845752681807935</link>    <guid>https://juejin.cn/post/7587845752681807935</guid>    <pubDate>2025-12-26T06:56:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587845752681807935" data-draft-id="7587825267878363177" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 年终醒悟，AI  让我误以为自己很强，未来程序员的转型之路"/> <meta itemprop="keywords" content="前端,Android,Flutter"/> <meta itemprop="datePublished" content="2025-12-26T06:56:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 年终醒悟，AI  让我误以为自己很强，未来程序员的转型之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:56:11.000Z" title="Fri Dec 26 2025 06:56:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025 可以说只要是开发者都绕不过 AI ，<strong>时至今日你说你不用 AI 写代码我是不信的</strong>，但是直到最近我才发现，我似乎已经把 AI 的能力当做自己的能力，这种错觉体现在，昨天我用 AI 五分钟做出这下方这个动画效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3613ce014e91453e94fd1c50e05143b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=V%2FggoLB%2BRrHCDNxj18pG0%2BKeNEk%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>不知道有没有人能看出这个动画里的梗。。。。</p>
</blockquote>
<p>自从有了 AI 之后，有问题可以让 AI 解读，有需求可以让 AI 分解，比如我想做上面那个动画的时候，只需要让 AI 先根据我的表述给出数学公式，然后根据公式再让 AI 实现和组合代码，而这个过程我只需要点一点运行，预览下效果符不符合我的要求，然后我就觉得自己强的可怕。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b801a608a3d495ca937d2d310dc418b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=4sQwLflLYn2KO2O6JqxXpFkmZiU%3D" alt="image-20251226121839643" loading="lazy"/></p>
<p><strong>这种错觉经常让我陷入以为自己“无所不能”</strong>，在提效的同时，心态似乎也在慢慢的走偏，比如这段时间以来，我通过 AI 复刻和尝试了许多特效，虽然偶尔需要我介入修改问题，但是大多数时候都是在 Vibe Coding ，<strong>而看着这些充满想象力的炫酷动画，那种自以为是的心理就会被 AI 无限放大</strong> 。</p>






























<table><thead><tr><th/><th/><th/></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9a0b6d11b53452aabc66265090bff30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=B4fz6UPLNseq%2BwXTBX5v2pwKfmA%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0652e86bc274bbe848f632b1c9a4de0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=DTitkkZn7FjnWI7tNlmYg6Dw5Nc%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59c367b6756e4943be98af358fbda0b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=Pr6BMhu8aVvezQ54%2FAr6Kk2XRaw%3D" alt="" loading="lazy"/></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7e6a3504cef472aafc13d3dbd1a3231~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=A2xT%2Bo62zuV2YSno8IMzQsBzZuY%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27890d610f0a46c8b03fc3729d950408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=ttJCBUnDlMTHPlcf4t5yp%2BIq88U%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b946921d4ccc4edbb9a1029fdc24ddcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=76PXV6IfJcYGOFboTNrrVWHY4Es%3D" alt="" loading="lazy"/></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0922dc78fe5456fac76e2f26777624a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=uuAOJoF5FGq7IhDEStgVaI6oQb0%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/704d800576f34e0f8529a09be8951d83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=7LLJKuhnAaUJeEkTnKM%2F7jomc1k%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9f9c62e85e74c21a076cd06236976ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=lqxbzv51reLd%2Bum5GesSiHyi59U%3D" alt="" loading="lazy"/></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b801b53c1d0461fbac8c3e136fbd2c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=4bKyBdV4vnEg7AkYw%2FJRwR86lm0%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5af36b93fae24792aa76ccbaed68dda9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=qhOkHiOw5CYUmcVJ6HNGjhmXl5A%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/409a495b57284042bb88798cf8c738c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=24DWwASBfi1wo%2BF%2Bpnly9BlI3%2Fw%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<p>但是现在想来，你真的理解过这些动画吗？真的有去了解他们的实现原理和实现逻辑吗？就算事后看过，不是你写的东西，过后还有印象吗？也让我想起了  Anthropic 在 <a href="https://juejin.cn/post/7579555970594947113" target="_blank" title="https://juejin.cn/post/7579555970594947113">《How AI Is Transforming Work at Anthropic》</a> 文章里提到过的：</p>
<blockquote>
<p>“我以为我喜欢写代码，其实我只是喜欢代码跑通的结果”。</p>
</blockquote>
<p>这也让我开始怀疑，我究竟是喜欢写代码，还是只是单纯喜欢跑通产品？在这个过程中，AI 带来的短期能力提升，很容易就让人对自己的定位产生误差，实际上这个过程有没有发现你的能力可能正在倒退？</p>
<p>这种<strong>职业认同的危机不只是外部开发者有， Claude 内部开发者也有这个焦虑</strong>，所以未来 AI 对于开发者的影响，还可能会带来新的职业价值观的重构，所以有人感到迷茫：<strong>如果写代码这个动作本身不再重要，那么以后作为软件工程师的身份认同建立在哪里</strong>？</p>
<blockquote>
<p>而在这个过程里，<strong>AI 能显著增加产量并扩展个人可承担任务的范围，但同时带来技能退化风险</strong>。</p>
</blockquote>
<p>如今 AI 越来越强已经是时代必然的浪潮，而 AI 现在的缺陷也会很快被时代所修复，就像 Google 的 <a href="https://juejin.cn/post/7576181242582892607" target="_blank" title="https://juejin.cn/post/7576181242582892607">Nested  Learning</a>  论文介绍的，现在大模型的问题在于<strong>大模型无法在训练后继续学习</strong> ，因为目前的大模型只有<strong>极快且短暂的记忆</strong>（In-Context Learning）和<strong>冻结的长期记忆（Pre-trained Weights）</strong> ，这个问题在于：</p>
<blockquote>
<p>当前模型缺乏将“即时对话”转化为“长期参数”的机制，也就是它们缺乏中间的频谱：<strong>那些应该从短期逐渐变为长期的记忆</strong>。</p>
</blockquote>
<p>但是这个问题已经被他们通过全新的 HOPE 架构攻克，未来<strong>能“吃一堑长一智”的 AI 也许离我们就不远了</strong>，所以编程能力对于程序员来说，未来是一个什么地位？这个职业的核心竞争力又在哪里？</p>
<p>在开发实现过程中 AI 很强，但是我们需要清晰的知道，<strong>AI 的强大的编程能力并不是你的能力，而作为程序员，你竞争力也不再是</strong>：</p>
<ul>
<li>熟练掌握某些框架和 API</li>
<li>精通某个语言和语法</li>
</ul>
<p>在这些方面，人是跑不过机器的，就像 <a href="https://juejin.cn/post/7584729714339250195" target="_blank" title="https://juejin.cn/post/7584729714339250195">《  OpenAI  使用 Codex 在 28 天内构建 Android 版 Sora》</a> 里介绍的：</p>
<blockquote>
<p>在使用 GPT-5.1-Codex 之后，在短短 28 天内，不仅完成了繁重的开发任务，还创造了上线 24 小时生成 100 万视频、99.9% 无崩溃率的应用，在这个过程里AI 可以 24 小时无间断编写代码和自我修复，28 天通过 50 亿 token 完成了正常需要几个月的产品上线。</p>
</blockquote>
<p>所以从这里可以看到，你如果想和 AI 拼编码能力肯定是拼不过的，就像 OpenAI 最后总结的：<strong>未来的开发工程师的能力不再是打字速度或语法 API 记忆，而是对系统的深刻洞察力。</strong></p>
<p>直到看到 OpenAI  和 Anthropic 等模型公司对于程序员未来的思考时，我才明白不能再沉迷于 AI 编程给自己带来的“成就感”，因为那是 AI 的能力而不是你的，<strong>你用 AI 可以做到，那别人用 AI 是不是也能做到，那你的职业竞争力在哪里</strong>？</p>
<blockquote>
<p>未来的开发者，强的可能不是代码能力，而是项目管理和 AI 驯服能力。</p>
</blockquote>
<p>所以未来程序员的职业能力肯定会发现变化，比如 2026 对于开发者来说，<strong>短期的价值会体现在如何驯服 AI</strong> ，因为现在的 AI 还是一批脱缰的野马，他的保证就像是“事前”的承诺，各种言之凿凿让你相信它：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6de1b143a7a54428803ad5ddb57b13c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=nLA0hRhAuuidTgf9iibjVAymlAs%3D" alt="" loading="lazy"/></p>
<p>而事后提起裤子，出问题了它可半点不认，所以<strong>如何驯服 AI ，同时如何管理和做好大模型善后工程师，这将是程序员短期内的职业变化</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65b268e5419642d7925522fec6dcf45c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=RRDXTLPqV9kxqTt7sL%2BcksYg49g%3D" alt="" loading="lazy"/></p>
<p>而如何驯服 AI ，其实也很简单，<strong>那就是不要上来就让 AI 执行需求，而是给 AI 规划好需求和规则</strong>，把 AI 看作是一个“<em>高能力但缺乏背景的资深新员工</em>”，而你负责架构设计、用户体验和最终决策，而 AI 负责写代码、单元测试和需求落地。</p>
<p>因为 AI 的短板在于目前对于需求的理解还不够，也不擅长得深层的架构权衡（经常为了实现功能而把代码写乱），因为它的 Context 有限，所以经常都会比较片面去理解项目，所以作为程序员，你需要做的是：</p>
<ul>
<li><strong>先规划后代码</strong>：先让 AI 理解系统并编写“设计文档”，纠偏后再执行</li>
<li><strong>背景信息驱动</strong>：通过各种文件文档为 AI 提供规范和上下文，比如各种 rule 和模块描述</li>
<li><strong>增加技能支持</strong> :  通过各种技能描述让 AI 能力增加，比如 CC 可以通过 skills 加载各种插件来辅助能力提升</li>
</ul>
<p>举个例子，比如你要用 Flutter 做一个 Wallet App ，而任务是开发一个 <code>TransactionDetail</code> 模块，需求是：</p>
<ul>
<li>必须遵循 Clean Architecture (Domain -&gt; Data -&gt; Presentation)</li>
<li>数据敏感，金额精度（Decimal）、哈希脱敏显示有严格规范</li>
<li>状态管理，强制使用 <code>riverpod_generator</code> + <code>freezed</code></li>
</ul>
<p>那么在 Claude Code 场景，首先接下来你需要做的会是：</p>
<h3 data-id="heading-0">一、增加 Skill</h3>
<p>这里的核心是教 AI <strong>“在这个团队里，如何标准化地生产一个 Feature”</strong> ，例如创建一个 <code>skills/flutter-clean-feature/</code>  ：</p>
<ol>
<li>
<p><strong><code>SKILL.md</code></strong></p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: flutter-clean-feature
description: 能够按 Clean Architecture 标准生成全套 Flutter 功能模块
<span class="hljs-section">usage: "当用户想开发新页面或功能模块时使用"
---</span>

<span class="hljs-section"># 标准工作流 (SOP)</span>
AI 在执行此 Skill 时，必须严格遵守以下顺序：

<span class="hljs-bullet">1.</span>  <span class="hljs-strong">**Phase 1: 领域建模 (Domain First)**</span>
<span class="hljs-bullet">    -</span> 读取 <span class="hljs-code">`references/domain_rules.md`</span>。
<span class="hljs-bullet">    -</span> 优先定义 Entity 和 Repository 接口。
<span class="hljs-bullet">    -</span> <span class="hljs-emphasis">*Check*</span>: 所有的金额字段必须使用 <span class="hljs-code">`Decimal`</span> 类型，禁止使用 <span class="hljs-code">`double`</span>。

<span class="hljs-bullet">2.</span>  <span class="hljs-strong">**Phase 2: 架构脚手架 (Scaffolding)**</span>
<span class="hljs-bullet">    -</span> 调用 <span class="hljs-code">`scripts/scaffold_module.py`</span> 自动生成文件夹和空文件。
<span class="hljs-bullet">    -</span> 路径结构必须是 <span class="hljs-code">`lib/features/&lt;name&gt;/{data,domain,presentation}`</span>。

<span class="hljs-bullet">3.</span>  <span class="hljs-strong">**Phase 3: 实现与绑定**</span>
<span class="hljs-bullet">    -</span> 实现 Repository 时，必须使用 <span class="hljs-code">`fpdart`</span> 处理 <span class="hljs-code">`Either&lt;Failure, T&gt;`</span>。
<span class="hljs-bullet">    -</span> UI 层必须使用 <span class="hljs-code">`AsyncValue`</span> 处理加载状态。
</code></pre>
</li>
<li>
<p><strong><code>references/domain_rules.md</code> (知识库)</strong></p>
<ul>
<li>包含团队约定的 Clean Architecture 分层图</li>
<li>包含 JSON 解析的通用错误处理模版</li>
</ul>
</li>
<li>
<p><strong><code>assets/repo_template.dart</code> (模版)</strong></p>
<ul>
<li>预置了带有 <code>Either</code> 返回值的 Repository 接口模版</li>
</ul>
</li>
<li>
<p><strong><code>scripts/scaffold_module.py</code> (自动化工具)</strong></p>
<ul>
<li>一个 Python 脚本，接受模块名参数，自动在 <code>lib/features/</code> 下创建标准的文件夹结构和基础文件（解决 AI 有时候懒得创建文件的毛病）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-1">二、增加上下文信息</h3>
<p>核心思想就是告诉 AI “这个项目现有的基础设施是什么” ，比如项目维护一个 <code>CLAUDE.md</code>，提供项目级上下文：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># CryptoWallet Project Context</span>

<span class="hljs-section">## 技术栈</span>
<span class="hljs-bullet">-</span> Flutter 3.24
<span class="hljs-bullet">-</span> Riverpod (Annotation mode only)
<span class="hljs-bullet">-</span> Dio (已封装在 <span class="hljs-code">`lib/core/network/dio_client.dart`</span>)
<span class="hljs-bullet">-</span> UI Kit (所有按钮必须使用 <span class="hljs-code">`lib/core/widgets/app_button.dart`</span>)

<span class="hljs-section">## 现有能力</span>
<span class="hljs-bullet">-</span> 格式化工具：<span class="hljs-code">`lib/core/utils/formatters.dart`</span> (包含 hash 截断、货币格式化)
<span class="hljs-bullet">-</span> 路由：GoRouter，路由定义在 <span class="hljs-code">`lib/routes.dart`</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">三、先规划后代码 (Plan)</h3>
<p>可以利用 Claude Code 的交互能力，先加载 Skill 进行规划，审核无误后再由 Skill 中的 Script 自动执行，例如：</p>
<p><strong>1. 启动与规划</strong></p>
<blockquote>
<p>"使用 skill: flutter-clean-feature，我要开发一个 TransactionDetail 模块，输入是 txHash，需要展示交易金额、时间、发送方和接收方。"`</p>
</blockquote>
<blockquote>
<p><strong>Claude (加载 Skill)</strong>: <em>读取 <code>skills/flutter-clean-feature/SKILL.md</code>...</em> <em>读取 <code>CLAUDE.md</code> 获取项目上下文...</em></p>
<p><strong>Claude (输出规划)</strong>: 根据 <strong>Flutter Clean Feature SOP</strong>，我制定了以下计划：</p>
<ol>
<li><strong>Domain</strong>: 定义 <code>TransactionEntity</code> (包含 <code>Decimal amount</code>) 和 <code>ITransactionRepo</code>。</li>
<li><strong>Scaffold</strong>: 运行脚本创建 <code>lib/features/transaction_detail/...</code> 目录。</li>
<li><strong>Data</strong>: 实现 Repo，调用 Context 中提到的 <code>DioClient</code>。</li>
<li><strong>Presentation</strong>: 使用 <code>riverpod_generator</code> 创建 <code>transactionDetailProvider</code>。</li>
</ol>
<p><strong>请确认</strong>：是否需要支持“交易状态（成功/失败）”的枚举？</p>
</blockquote>
<p><strong>2.  Review 优化</strong></p>
<blockquote>
<p><strong>User</strong>: "需要。另外，UI 上金额显示需要调用 <code>formatters.dart</code> 里的方法，不要自己写格式化逻辑。"</p>
</blockquote>
<p><strong>3. 执行</strong></p>
<blockquote>
<p><strong>Claude</strong>: 收到。开始执行。</p>
</blockquote>
<p><em>(Claude 内部触发 Skill 中的 Script)</em> <code>Run script: python skills/flutter-clean-feature/scripts/scaffold_module.py transaction_detail</code> ：</p>
<blockquote>
<p><strong>Terminal Output</strong>:
✅ Created lib/features/transaction_detail/domain
✅ Created lib/features/transaction_detail/data
✅ Created lib/features/transaction_detail/presentation</p>
</blockquote>
<p><em>(Claude 继续编写代码)</em> Claude 根据 <code>assets/repo_template.dart</code> 填充 <code>transaction_repository.dart</code>，并根据 <code>CLAUDE.md</code> 里的规则，引入了 <code>dio_client.dart</code>。</p>
<p>······</p>
<p>是不是觉得很繁琐？是不是觉得一轮整下来我需求都写完了？但是这就是使用 AI 的趋势，只有这样才能控制和管理好 AI 的代码，不至于让 AI 写出一坨屎山，而随着你对工程文档和技能补充的完善，你的开发速度就会越来越快，AI 也能像是你多年的老哥们一样懂你需求，比如 ：</p>
<blockquote>
<p><code>CLAUDE.md</code> 确保了 AI 不会引入 <code>http</code> 库（因为它知道有 <code>Dio</code>），也不会手写丑陋的按钮（因为它知道有 <code>AppButton</code>），它理解了项目的现状，知道有什么技能可用，然后通过规划很你完成确认，这些写出来的代码和项目才是可持续维护的。</p>
</blockquote>
<p>最后，这一年里我出了用 AI 写代码之外，也开始尝试用 AI 去解决和尝试代码之外的事情，因为 AI 所以我敢于尝试一些以前不敢接触的领域，因为过程学习成本太高，而现在 AI 提供了另外一种思路：</p>
<blockquote>
<p><strong>我不需要真的懂，我只需要让 AI 去做就好了，而我只需要提供想法和验证结果</strong>。</p>
</blockquote>
<p>2025 即将结束，而 2026 也会如期而至，而 AI 的浪潮从未停歇，<strong>愿你我都能在新的浪潮下找到自己的位置</strong>~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI 编程实战】第 5 篇：Pinia 状态管理 - 从混乱代码到优雅架构]]></title>    <link>https://juejin.cn/post/7587738151658881024</link>    <guid>https://juejin.cn/post/7587738151658881024</guid>    <pubDate>2025-12-26T07:12:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587738151658881024" data-draft-id="7587277503947341824" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI 编程实战】第 5 篇：Pinia 状态管理 - 从混乱代码到优雅架构"/> <meta itemprop="keywords" content="前端,Vue.js,AI编程"/> <meta itemprop="datePublished" content="2025-12-26T07:12:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HashTang"/> <meta itemprop="url" content="https://juejin.cn/user/1117561754756488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI 编程实战】第 5 篇：Pinia 状态管理 - 从混乱代码到优雅架构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117561754756488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HashTang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T07:12:19.000Z" title="Fri Dec 26 2025 07:12:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,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) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><blockquote>
<p>状态管理是前端应用的"心脏"，但很多人一提到 Pinia/Vuex 就头疼：Store 该怎么设计？持久化怎么做？登录态怎么维护？这篇文章以<strong>心动恋聊</strong>小程序为例，通过和 AI 的<strong>真实对话</strong>，展示如何从零搭建一个完整的用户状态管理系统。</p>
<p><strong>系列专栏</strong>：<a href="https://juejin.cn/column/7579556047783624756" target="_blank" title="https://juejin.cn/column/7579556047783624756">【AI 编程实战：TRAE SOLO 全栈开发指南】</a></p>
<p><strong>本篇主题</strong>：Pinia 状态管理 - 从混乱代码到优雅架构</p>
<p><strong>实战项目</strong>：心动恋聊 - AI 恋爱聊天助手</p>
</blockquote>
<h2 data-id="heading-0">一、开篇：状态管理的痛点</h2>
<h3 data-id="heading-1">1.1 没有状态管理时的混乱</h3>
<p>在没有集中式状态管理之前，我的代码是这样的：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 页面 A：登录后保存用户信息</span>
uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'userInfo'</span>, userData);
uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'token'</span>, token);
uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'isLoggedIn'</span>, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 页面 B：读取用户信息</span>
<span class="hljs-keyword">const</span> userInfo = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'userInfo'</span>);
<span class="hljs-keyword">const</span> isLoggedIn = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'isLoggedIn'</span>);

<span class="hljs-comment">// 页面 C：更新用户信息</span>
<span class="hljs-keyword">const</span> userInfo = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'userInfo'</span>);
userInfo.<span class="hljs-property">avatar</span> = newAvatar;
uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'userInfo'</span>, userInfo);

<span class="hljs-comment">// 页面 D：判断登录状态</span>
<span class="hljs-keyword">if</span> (uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'token'</span>)) {
  <span class="hljs-comment">// 已登录逻辑</span>
}
</code></pre>
<p><strong>问题显而易见</strong>：</p>
<ul>
<li>每个页面都在重复读写 Storage</li>
<li>状态分散在各处，难以追踪</li>
<li>修改一处，容易漏改其他地方</li>
<li>没有响应式，页面不会自动更新</li>
</ul>
<h3 data-id="heading-2">1.2 我需要什么</h3>
<p>我需要一个<strong>集中式的用户状态管理</strong>：</p>
<ul>
<li>统一管理用户信息、登录态</li>
<li>支持持久化（刷新不丢失）</li>
<li>响应式更新（数据变化，页面自动刷新）</li>
<li>多种登录方式支持（微信、手机号）</li>
</ul>
<p>但我对 Pinia 不熟悉，于是开始和 AI 对话。</p>
<h2 data-id="heading-3">二、基础 Store 搭建</h2>
<h3 data-id="heading-4">2.1 我的第一句话</h3>
<pre><code class="hljs language-txt" lang="txt">我：项目需要用户状态管理，用 Pinia 实现。
    要管理用户信息、登录状态，支持登录、退出功能。
</code></pre>
<h3 data-id="heading-5">2.2 AI 先问问题</h3>
<pre><code class="hljs language-txt" lang="txt">AI：好的，我来帮你搭建用户状态管理。先确认几个问题：

🤔 问题：
1. 项目技术栈是什么？（Vue3/UniApp/其他）
2. 用户信息需要哪些字段？
3. 登录方式有哪些？（账号密码/微信/手机号）
4. 需要持久化吗？（刷新页面后保持登录）

请告诉我这些信息，我来设计 Store 结构。
</code></pre>
<h3 data-id="heading-6">2.3 我补充信息</h3>
<pre><code class="hljs language-txt" lang="txt">我：UniApp + Vue3 项目，跑微信小程序。
    用户信息：user_id、username、avatar、gender、phone_number、vip_status 这些。
    登录方式：主要是微信登录，后面可能加手机号登录。
    需要持久化，用户登录后刷新不能退出。
</code></pre>
<h3 data-id="heading-7">2.4 AI 给出执行计划</h3>
<pre><code class="hljs language-txt" lang="txt">AI：明白了，我来设计 Store 结构。

📋 执行计划：

1. 创建 src/store/index.ts - Pinia 入口配置
2. 创建 src/store/user.ts - 用户状态管理
3. 在 main.ts 中注册 Pinia

📐 Store 结构设计：

src/store/
├── index.ts      # Pinia 实例 + 插件配置
└── user.ts       # 用户状态管理
    ├── state     # userInfo, isLoggedIn
    ├── getters   # genderDisplay, isVip
    └── actions   # login, logout, updateUserInfo

🤔 关于语法风格，有两种选择：
1. Options API 风格：state/getters/actions 分开写
2. Setup 风格：用 ref/computed/function，更灵活

你想用哪种风格？
</code></pre>
<pre><code class="hljs language-txt" lang="txt">我：用 Setup 风格吧，看起来更简洁
</code></pre>
<h3 data-id="heading-8">2.5 AI 生成基础代码</h3>
<pre><code class="hljs language-txt" lang="txt">AI：好的，开始生成代码...

✅ 创建 src/store/index.ts
✅ 创建 src/store/user.ts
✅ 修改 main.ts

基础结构已完成，这是核心代码：
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/index.ts</span>
<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createPinia</span>();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store;
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./user'</span>;
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 用户信息类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserInfo</span> {
  <span class="hljs-attr">user_id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">username</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">avatar</span>: <span class="hljs-built_in">string</span>;
  gender?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 1: 男, 2: 女</span>
  phone_number?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">vip_status</span>: <span class="hljs-string">'none'</span> | <span class="hljs-string">'vip'</span> | <span class="hljs-string">'expired'</span>;
}

<span class="hljs-comment">// 初始状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">initialUserInfo</span>: <span class="hljs-title class_">UserInfo</span> = {
  <span class="hljs-attr">user_id</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">username</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">avatar</span>: <span class="hljs-string">'/static/images/default-avatar.png'</span>,
  <span class="hljs-attr">gender</span>: <span class="hljs-literal">undefined</span>,
  <span class="hljs-attr">phone_number</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">vip_status</span>: <span class="hljs-string">'none'</span>,
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// ===== 状态 =====</span>
  <span class="hljs-keyword">const</span> userInfo = ref&lt;<span class="hljs-title class_">UserInfo</span>&gt;({ ...initialUserInfo });
  <span class="hljs-keyword">const</span> isLoggedIn = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-comment">// ===== 计算属性 =====</span>
  <span class="hljs-keyword">const</span> isVip = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> userInfo.<span class="hljs-property">value</span>.<span class="hljs-property">vip_status</span> === <span class="hljs-string">'vip'</span>);

  <span class="hljs-comment">// ===== 方法 =====</span>

  <span class="hljs-comment">/** 设置用户信息 */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">setUserInfo</span> = (<span class="hljs-params">info: UserInfo</span>) =&gt; {
    userInfo.<span class="hljs-property">value</span> = { ...initialUserInfo, ...info };
    isLoggedIn.<span class="hljs-property">value</span> = !!info.<span class="hljs-property">user_id</span>;
  };

  <span class="hljs-comment">/** 清除用户信息 */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearUserInfo</span> = (<span class="hljs-params"/>) =&gt; {
    userInfo.<span class="hljs-property">value</span> = { ...initialUserInfo };
    isLoggedIn.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  };

  <span class="hljs-comment">/** 退出登录 */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">clearUserInfo</span>();
  };

  <span class="hljs-keyword">return</span> {
    userInfo,
    isLoggedIn,
    isVip,
    setUserInfo,
    clearUserInfo,
    logout,
  };
});
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：基础 Store 已创建。使用方式：

// 在组件中
import { useUserStore } from '@/store'

const userStore = useUserStore()

// 读取状态
console.log(userStore.userInfo.username)
console.log(userStore.isLoggedIn)

// 调用方法
userStore.setUserInfo({ user_id: '123', username: '小明', ... })
userStore.logout()

现在可以测试一下基础功能。
</code></pre>
<h2 data-id="heading-9">三、持久化配置</h2>
<h3 data-id="heading-10">3.1 我发现刷新后状态丢失</h3>
<p>测试后，我发现一个问题：</p>
<pre><code class="hljs language-txt" lang="txt">我：登录后刷新页面，状态丢失了，又变成未登录状态。
    你不是说要支持持久化吗？
</code></pre>
<h3 data-id="heading-11">3.2 AI 解释并修复</h3>
<pre><code class="hljs language-txt" lang="txt">AI：抱歉，我忘了加持久化配置。

🔍 原因：
Pinia 默认不持久化，状态只存在内存中，刷新就没了。

🔧 解决方案：
使用 pinia-plugin-persistedstate 插件，自动将状态同步到 Storage。

⚠️ 小程序注意：
小程序没有 localStorage，需要用 uni.getStorageSync/setStorageSync。

我来修改配置...
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/index.ts（修改后）</span>
<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;
<span class="hljs-keyword">import</span> { createPersistedState } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia-plugin-persistedstate'</span>;

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createPinia</span>();

<span class="hljs-comment">// 配置持久化插件，适配小程序存储 API</span>
store.<span class="hljs-title function_">use</span>(
  <span class="hljs-title function_">createPersistedState</span>({
    <span class="hljs-attr">storage</span>: {
      <span class="hljs-attr">getItem</span>: uni.<span class="hljs-property">getStorageSync</span>,
      <span class="hljs-attr">setItem</span>: uni.<span class="hljs-property">setStorageSync</span>,
    },
  }),
);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store;
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./user'</span>;
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts（添加持久化配置）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(
  <span class="hljs-string">'user'</span>,
  <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ... 原有代码不变</span>
  },
  {
    <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启持久化</span>
  },
);
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：
✅ 已安装 pinia-plugin-persistedstate
✅ 已修改 src/store/index.ts
✅ 已修改 src/store/user.ts

现在刷新页面，登录状态会保持。

⚠️ 注意：
persist: true 会持久化整个 state。
如果某些状态不想持久化，可以用 paths 指定：

{
  persist: {
    paths: ['userInfo', 'isLoggedIn'],  // 只持久化这些
  },
}
</code></pre>
<h3 data-id="heading-12">3.3 我验证修复成功</h3>
<pre><code class="hljs language-txt" lang="txt">我：好了，刷新后状态保持了。但我还有个问题：
    token 现在是存在 Store 里还是 Storage 里？
</code></pre>
<h3 data-id="heading-13">3.4 AI 解释 Token 存储策略</h3>
<pre><code class="hljs language-txt" lang="txt">AI：好问题！目前 token 没有放在 Store 里。

🤔 关于 Token 存储，有两种策略：

【策略一】Token 放 Store（持久化到 Storage）
优点：统一管理，响应式
缺点：Store 初始化前无法使用

【策略二】Token 单独存 Storage（推荐）
优点：HTTP 拦截器可以直接读取，不依赖 Store 初始化
缺点：需要单独管理

📌 推荐策略二，原因：
HTTP 请求拦截器需要在应用启动最早期就能获取 token，
此时 Store 可能还没初始化完成。

代码示例：
// 登录成功时
uni.setStorageSync('token', response.token)
setUserInfo(response.user)

// HTTP 拦截器中
const token = uni.getStorageSync('token')

你想用哪种策略？
</code></pre>
<pre><code class="hljs language-txt" lang="txt">我：用策略二，Token 单独存
</code></pre>
<h2 data-id="heading-14">四、完善登录流程</h2>
<h3 data-id="heading-15">4.1 我要添加微信登录</h3>
<pre><code class="hljs language-txt" lang="txt">我：现在要加微信登录功能。
    流程是：调用 uni.login 获取 code → 发给后端换 token 和用户信息。
</code></pre>
<h3 data-id="heading-16">4.2 AI 设计登录方法</h3>
<pre><code class="hljs language-txt" lang="txt">AI：明白，我来添加微信登录方法。

📋 执行计划：
1. 添加 wechatLogin 方法到 userStore
2. 处理登录成功：保存 token + 设置用户信息
3. 处理登录失败：提示错误

🤔 问题：
1. 登录 API 接口路径是什么？
2. 登录成功后要不要自动跳转？
3. 需要 loading 和 toast 提示吗？
</code></pre>
<pre><code class="hljs language-txt" lang="txt">我：API 是 /api/auth/wechat-login，参数是 { code }。
    不需要自动跳转，由调用方决定。
    需要 toast 提示成功/失败。
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：好的，添加登录方法：
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts（添加登录方法）</span>
<span class="hljs-keyword">import</span> { toast } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/toast'</span>;
<span class="hljs-keyword">import</span> { loginByWechat } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/auth'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(
  <span class="hljs-string">'user'</span>,
  <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ... 原有状态和方法</span>

    <span class="hljs-comment">/**
     * 微信登录
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">wechatLogin</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">code: <span class="hljs-built_in">string</span></span>) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loginByWechat</span>({ code });

        <span class="hljs-keyword">if</span> (response.<span class="hljs-property">code</span> !== <span class="hljs-number">200</span>) {
          toast.<span class="hljs-title function_">error</span>(response.<span class="hljs-property">msg</span> || <span class="hljs-string">'登录失败'</span>);
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(response.<span class="hljs-property">msg</span> || <span class="hljs-string">'登录失败'</span>);
        }

        <span class="hljs-keyword">const</span> { token, user } = response.<span class="hljs-property">data</span>;

        <span class="hljs-comment">// 保存 token（单独存 Storage）</span>
        uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'token'</span>, token);

        <span class="hljs-comment">// 设置用户信息</span>
        <span class="hljs-title function_">setUserInfo</span>(user);

        toast.<span class="hljs-title function_">success</span>(<span class="hljs-string">'登录成功'</span>);
        <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'微信登录失败:'</span>, error);
        toast.<span class="hljs-title function_">error</span>(<span class="hljs-string">'登录失败，请稍后再试'</span>);
        <span class="hljs-keyword">throw</span> error;
      }
    };

    <span class="hljs-comment">/**
     * 退出登录（更新）
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-title function_">clearUserInfo</span>();
      uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'token'</span>); <span class="hljs-comment">// 清除 token</span>
      toast.<span class="hljs-title function_">success</span>(<span class="hljs-string">'已退出登录'</span>);
    };

    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// ... 原有导出</span>
      wechatLogin,
      logout,
    };
  },
  { <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span> },
);
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：使用方式：

// 页面中调用
const handleWechatLogin = async () =&gt; {
  try {
    // 1. 获取微信 code
    const { code } = await new Promise((resolve, reject) =&gt; {
      uni.login({
        provider: 'weixin',
        success: resolve,
        fail: reject,
      })
    })

    // 2. 调用 Store 登录方法
    await userStore.wechatLogin(code)

    // 3. 登录成功后的操作（由页面决定）
    uni.navigateBack()
  } catch (error) {
    console.error('登录失败:', error)
  }
}
</code></pre>
<h3 data-id="heading-17">4.3 我追问：登录态初始化</h3>
<pre><code class="hljs language-txt" lang="txt">我：还有个问题，应用启动时怎么恢复登录态？
    比如用户之前登录过，打开应用应该自动是登录状态。
</code></pre>
<h3 data-id="heading-18">4.4 AI 添加初始化逻辑</h3>
<pre><code class="hljs language-txt" lang="txt">AI：需要添加一个初始化方法，在应用启动时调用。

🔍 初始化逻辑：
1. 检查本地是否有 token 和 userInfo
2. 如果有，恢复登录状态
3. 异步请求最新用户信息（token 可能过期）
4. 如果 token 过期，清除登录态
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts（添加初始化方法）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(
  <span class="hljs-string">'user'</span>,
  <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ... 原有代码</span>

    <span class="hljs-comment">/**
     * 初始化用户状态（应用启动时调用）
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">initializeUserState</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'token'</span>);
      <span class="hljs-keyword">const</span> savedUserInfo = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'userInfo'</span>);
      <span class="hljs-keyword">const</span> savedLoginStatus = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'isLoggedIn'</span>);

      <span class="hljs-comment">// 检查是否有完整的登录信息</span>
      <span class="hljs-keyword">if</span> (token &amp;&amp; savedUserInfo?.<span class="hljs-property">user_id</span> &amp;&amp; savedLoginStatus) {
        <span class="hljs-comment">// 恢复登录态</span>
        userInfo.<span class="hljs-property">value</span> = savedUserInfo;
        isLoggedIn.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// 异步获取最新用户信息（校验 token 有效性）</span>
        <span class="hljs-title function_">loadUserInfo</span>();
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 清除可能存在的无效数据</span>
        <span class="hljs-title function_">clearUserInfo</span>();
        uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'token'</span>);
      }
    };

    <span class="hljs-comment">/**
     * 从服务器加载最新用户信息
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadUserInfo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">apiGetUserInfo</span>();
        <span class="hljs-keyword">if</span> (response.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
          <span class="hljs-title function_">setUserInfo</span>(response.<span class="hljs-property">data</span>);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// token 可能已过期</span>
          <span class="hljs-title function_">clearUserInfo</span>();
          uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'token'</span>);
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户信息失败:'</span>, error);
        <span class="hljs-title function_">clearUserInfo</span>();
        uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'token'</span>);
      }
    };

    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// ... 原有导出</span>
      initializeUserState,
      loadUserInfo,
    };
  },
  { <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span> },
);
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：在 App.vue 的 onLaunch 中调用初始化：

// App.vue
&lt;script setup lang="ts"&gt;
import { useUserStore } from '@/store'

const userStore = useUserStore()

onLaunch(() =&gt; {
  userStore.initializeUserState()
})
&lt;/script&gt;

这样应用启动时会自动恢复登录态。
</code></pre>
<h2 data-id="heading-19">五、计算属性与统一更新</h2>
<h3 data-id="heading-20">5.1 我需要显示性别文本</h3>
<pre><code class="hljs language-txt" lang="txt">我：用户信息里 gender 是数字（1=男，2=女），
    但页面上要显示"男生"、"女生"，每次都要写判断很麻烦。
</code></pre>
<h3 data-id="heading-21">5.2 AI 添加计算属性</h3>
<pre><code class="hljs language-txt" lang="txt">AI：用计算属性（computed）解决，在 Store 里统一处理。

这样所有页面都可以直接用 userStore.genderDisplay，不用重复判断。
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts（添加计算属性）</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GenderEnum</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'shared-types'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(
  <span class="hljs-string">'user'</span>,
  <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ... 原有状态</span>

    <span class="hljs-comment">// ===== 计算属性 =====</span>

    <span class="hljs-comment">/** 性别显示文本 */</span>
    <span class="hljs-keyword">const</span> genderDisplay = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">switch</span> (userInfo.<span class="hljs-property">value</span>.<span class="hljs-property">gender</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">GenderEnum</span>.<span class="hljs-property">MALE</span>: <span class="hljs-comment">// 1</span>
          <span class="hljs-keyword">return</span> <span class="hljs-string">'男生'</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">GenderEnum</span>.<span class="hljs-property">FEMALE</span>: <span class="hljs-comment">// 2</span>
          <span class="hljs-keyword">return</span> <span class="hljs-string">'女生'</span>;
        <span class="hljs-attr">default</span>:
          <span class="hljs-keyword">return</span> <span class="hljs-string">'未设置'</span>;
      }
    });

    <span class="hljs-comment">/** 是否是 VIP */</span>
    <span class="hljs-keyword">const</span> isVip = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> userInfo.<span class="hljs-property">value</span>.<span class="hljs-property">vip_status</span> === <span class="hljs-string">'vip'</span>);

    <span class="hljs-comment">/** 根据性别获取默认头像 */</span>
    <span class="hljs-keyword">const</span> defaultAvatarByGender = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">switch</span> (userInfo.<span class="hljs-property">value</span>.<span class="hljs-property">gender</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">GenderEnum</span>.<span class="hljs-property">MALE</span>:
          <span class="hljs-keyword">return</span> <span class="hljs-string">'/static/images/avatar-male.png'</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">GenderEnum</span>.<span class="hljs-property">FEMALE</span>:
          <span class="hljs-keyword">return</span> <span class="hljs-string">'/static/images/avatar-female.png'</span>;
        <span class="hljs-attr">default</span>:
          <span class="hljs-keyword">return</span> <span class="hljs-string">'/static/images/avatar-default.png'</span>;
      }
    });

    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 状态</span>
      userInfo,
      isLoggedIn,
      <span class="hljs-comment">// 计算属性</span>
      genderDisplay,
      isVip,
      defaultAvatarByGender,
      <span class="hljs-comment">// 方法</span>
      <span class="hljs-comment">// ...</span>
    };
  },
  { <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span> },
);
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：使用方式：

&lt;template&gt;
  &lt;view&gt;
    &lt;text&gt;性别：{{ userStore.genderDisplay }}&lt;/text&gt;
    &lt;image :src="userStore.userInfo.avatar || userStore.defaultAvatarByGender" /&gt;
    &lt;text v-if="userStore.isVip"&gt;VIP 用户&lt;/text&gt;
  &lt;/view&gt;
&lt;/template&gt;

📌 计算属性的好处：
1. 逻辑集中，不用每个页面重复写
2. 响应式，userInfo 变化自动更新
3. 有缓存，多次访问只计算一次
</code></pre>
<h3 data-id="heading-22">5.3 我追问：更新用户信息</h3>
<pre><code class="hljs language-txt" lang="txt">我：用户在"我的"页面可以修改性别、昵称，
    修改后要同步更新 Store 和服务器，怎么做比较好？
</code></pre>
<h3 data-id="heading-23">5.4 AI 添加统一更新方法</h3>
<pre><code class="hljs language-txt" lang="txt">AI：添加一个统一的更新方法，封装 API 调用 + Store 更新 + 提示。

这样所有修改用户信息的地方都调用同一个方法，保证一致性。
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts（添加更新方法）</span>
<span class="hljs-keyword">import</span> { updateUserInfo <span class="hljs-keyword">as</span> apiUpdateUserInfo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/auth'</span>;

<span class="hljs-comment">/**
 * 统一更新用户信息
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">updateData</span> - 要更新的字段
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">successMessage</span> - 成功提示，默认"修改成功"
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateUserInfo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
  updateData: Partial&lt;Pick&lt;UserInfo, <span class="hljs-string">'gender'</span> | <span class="hljs-string">'username'</span> | <span class="hljs-string">'avatar'</span>&gt;&gt;,
  successMessage = <span class="hljs-string">'修改成功'</span>,
</span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 1. 调用 API 更新服务器</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">apiUpdateUserInfo</span>(updateData);

    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">code</span> === <span class="hljs-number">200</span> &amp;&amp; response.<span class="hljs-property">data</span>) {
      <span class="hljs-comment">// 2. 更新 Store（用服务器返回的最新数据）</span>
      <span class="hljs-title function_">setUserInfo</span>(response.<span class="hljs-property">data</span>);
      <span class="hljs-comment">// 3. 提示成功</span>
      toast.<span class="hljs-title function_">success</span>(successMessage);
    } <span class="hljs-keyword">else</span> {
      toast.<span class="hljs-title function_">error</span>(response.<span class="hljs-property">msg</span> || <span class="hljs-string">'修改失败'</span>);
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'更新用户信息失败:'</span>, error);
    toast.<span class="hljs-title function_">error</span>(<span class="hljs-string">'修改失败，请稍后再试'</span>);
  }
};
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：使用方式：

// 修改性别
await userStore.updateUserInfo({ gender: 1 })

// 修改昵称，自定义提示
await userStore.updateUserInfo(
  { username: '新昵称' },
  '昵称修改成功'
)

// 同时修改多个
await userStore.updateUserInfo({
  username: '新昵称',
  avatar: 'https://xxx.com/avatar.png',
})
</code></pre>
<h2 data-id="heading-24">六、跨 Store 通信</h2>
<h3 data-id="heading-25">6.1 我遇到跨 Store 问题</h3>
<pre><code class="hljs language-txt" lang="txt">我：用户退出登录时，除了清除用户信息，还要清除聊天记录。
    聊天记录在另一个 chatSessionStore 里，怎么在 userStore 里调用它？
</code></pre>
<h3 data-id="heading-26">6.2 AI 解释跨 Store 通信</h3>
<pre><code class="hljs language-txt" lang="txt">AI：Pinia 支持在一个 Store 里调用另一个 Store。

⚠️ 注意事项：
1. 必须在 action（方法）内部调用，不能在 Store 定义的顶层调用
2. 这是因为顶层调用时，Pinia 可能还没初始化完成

❌ 错误写法：
const useChatStore = useChatSessionStore()  // 顶层调用，可能报错

✅ 正确写法：
const logout = () =&gt; {
  const chatStore = useChatSessionStore()  // 方法内部调用
  chatStore.reset()
}
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts（跨 Store 调用）</span>
<span class="hljs-keyword">import</span> { useChatSessionStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/chatSession'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(
  <span class="hljs-string">'user'</span>,
  <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ...</span>

    <span class="hljs-comment">/**
     * 清除用户信息
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearUserInfo</span> = (<span class="hljs-params"/>) =&gt; {
      userInfo.<span class="hljs-property">value</span> = { ...initialUserInfo };
      isLoggedIn.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;

      <span class="hljs-comment">// 清除本地存储</span>
      uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'userInfo'</span>);
      uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'token'</span>);
      uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'isLoggedIn'</span>);

      <span class="hljs-comment">// 【跨 Store】清除聊天记录</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> chatStore = <span class="hljs-title function_">useChatSessionStore</span>();
        chatStore.<span class="hljs-title function_">reset</span>();
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'清理聊天记录失败:'</span>, error);
      }
    };

    <span class="hljs-comment">// ...</span>
  },
  { <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span> },
);
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：现在退出登录时会自动清除聊天记录。

📌 跨 Store 通信场景：
1. 退出登录 → 清除所有业务数据
2. 登录成功 → 初始化其他 Store
3. VIP 状态变化 → 通知其他模块

如果跨 Store 调用很多，也可以考虑用事件总线解耦。
</code></pre>
<h2 data-id="heading-27">七、核心经验：状态管理的最佳实践</h2>
<h3 data-id="heading-28">7.1 Store 设计原则</h3>






























<table><thead><tr><th>原则</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>单一职责</td><td>一个 Store 管理一个领域</td><td>userStore、chatStore、uiStore</td></tr><tr><td>状态只读</td><td>用 readonly 包装，防止外部直接修改</td><td><code>readonly(userInfo)</code></td></tr><tr><td>方法封装</td><td>修改状态统一通过方法，不要直接赋值</td><td><code>setUserInfo()</code> 而不是 <code>userInfo.value = xxx</code></td></tr><tr><td>计算属性</td><td>派生状态用 computed，避免重复计算</td><td><code>genderDisplay</code>、<code>isVip</code></td></tr></tbody></table>
<h3 data-id="heading-29">7.2 持久化注意事项</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 推荐：持久化配置适配小程序</span>
store.<span class="hljs-title function_">use</span>(
  <span class="hljs-title function_">createPersistedState</span>({
    <span class="hljs-attr">storage</span>: {
      <span class="hljs-attr">getItem</span>: uni.<span class="hljs-property">getStorageSync</span>,
      <span class="hljs-attr">setItem</span>: uni.<span class="hljs-property">setStorageSync</span>,
    },
  }),
)

<span class="hljs-comment">// ⚠️ 注意：Token 单独存储</span>
uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'token'</span>, token)  <span class="hljs-comment">// 不放 Store</span>

<span class="hljs-comment">// ⚠️ 注意：敏感信息不要持久化</span>
{
  <span class="hljs-attr">persist</span>: {
    <span class="hljs-attr">paths</span>: [<span class="hljs-string">'userInfo'</span>, <span class="hljs-string">'isLoggedIn'</span>],  <span class="hljs-comment">// 明确指定</span>
  },
}
</code></pre>
<h3 data-id="heading-30">7.3 跨 Store 通信规则</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误：在 Store 顶层调用其他 Store</span>
<span class="hljs-keyword">const</span> chatStore = <span class="hljs-title function_">useChatSessionStore</span>(); <span class="hljs-comment">// 可能报错</span>

<span class="hljs-comment">// ✅ 正确：在方法内部调用</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> chatStore = <span class="hljs-title function_">useChatSessionStore</span>();
  chatStore.<span class="hljs-title function_">reset</span>();
};
</code></pre>
<h3 data-id="heading-31">7.4 初始化时机</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// App.vue - 应用启动时初始化</span>
<span class="hljs-title function_">onLaunch</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>();
  userStore.<span class="hljs-title function_">initializeUserState</span>();
});
</code></pre>
<h2 data-id="heading-32">八、总结：对话中学会状态管理</h2>
<h3 data-id="heading-33">8.1 迭代过程回顾</h3>



































<table><thead><tr><th>阶段</th><th>需求</th><th>成果</th></tr></thead><tbody><tr><td>基础搭建</td><td>创建 Store</td><td>状态定义、基础方法</td></tr><tr><td>数据持久化</td><td>刷新保持登录</td><td>pinia-plugin-persistedstate 配置</td></tr><tr><td>登录流程</td><td>微信登录 + 初始化</td><td>wechatLogin、initializeUserState</td></tr><tr><td>体验优化</td><td>派生状态 + 统一更新</td><td>genderDisplay、updateUserInfo</td></tr><tr><td>架构完善</td><td>跨 Store 通信</td><td>clearUserInfo 中调用 chatStore</td></tr></tbody></table>
<h3 data-id="heading-34">8.2 关键收获</h3>
<ol>
<li><strong>不要一次想清楚所有细节</strong>，先搭基础框架，遇到问题再补充</li>
<li><strong>让 AI 解释原理</strong>，比如"为什么 Token 不放 Store"，理解后才能举一反三</li>
<li><strong>注意平台差异</strong>，小程序没有 localStorage，需要用 uni.getStorageSync</li>
<li><strong>状态管理不只是存数据</strong>，计算属性、方法封装、跨 Store 通信都是关键</li>
</ol>
<h3 data-id="heading-35">8.3 下一篇预告</h3>
<p><strong>《【AI 编程实战】第 6 篇：告别复制粘贴 - 设计一个优雅的 HTTP 模块》</strong></p>
<p>下一篇继续对话式协作，教你：</p>
<ul>
<li>如何设计 HTTP 请求/响应拦截器</li>
<li>Token 自动携带和刷新</li>
<li>统一错误处理和 Loading 管理</li>
</ul>
<hr/>
<blockquote>
<p>状态管理的核心不是"用什么库"，而是<strong>如何组织数据和逻辑</strong>。
通过和 AI 对话，你可以快速理清思路，少走弯路。</p>
<p>这是《<a href="https://juejin.cn/column/7579556047783624756" target="_blank" title="https://juejin.cn/column/7579556047783624756">AI 编程实战：TRAE SOLO 全栈开发指南</a>》专栏的第五篇文章</p>
<p>如果这篇文章对你有帮助，请点赞、收藏、转发！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cesium 去掉默认瓦片和地形，解决网络不好时地图加载缓慢的问题]]></title>    <link>https://juejin.cn/post/7587729264184885311</link>    <guid>https://juejin.cn/post/7587729264184885311</guid>    <pubDate>2025-12-26T03:12:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587729264184885311" data-draft-id="7587712328826355748" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cesium 去掉默认瓦片和地形，解决网络不好时地图加载缓慢的问题"/> <meta itemprop="keywords" content="前端,cesium"/> <meta itemprop="datePublished" content="2025-12-26T03:12:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲云一鹤"/> <meta itemprop="url" content="https://juejin.cn/user/729731452122382"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cesium 去掉默认瓦片和地形，解决网络不好时地图加载缓慢的问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731452122382/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲云一鹤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:12:34.000Z" title="Fri Dec 26 2025 03:12:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">抽丝剥茧，找到真凶</h2>
<p>甲方反馈地图经常出现偶发性加载缓慢的问题</p>
<p>我寻思在我本地开发环境很快啊，上了测试环境也没毛病，咋个部署到正式环境就地图慢了？</p>
<p>经过排查发现每次地图加载缓慢时 <code>endpoint</code> 接口都在报错（控制台也提示 net::ERR_CONNECTION_TIMED_OUT），并且百度也无法访问(甲方项目部署在内网，访问公网不太流畅)</p>
<p>破案了！罪魁祸首就是这两个接口请求在报错（图片无错误是因为我网络好，这里假装它在报错）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36705965fdc243e2b8a4c28090d4d752~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323554&amp;x-signature=nTDEe%2BbD3F3sJPSglhtAs2fPlGg%3D" alt="1.png" loading="lazy"/></p>
<p><code>https://api.cesium.com/v1/assets/1/endpoint?access_token="你的token"</code>
<code>https://api.cesium.com/v1/assets/2/endpoint?access_token="你的token"</code></p>
<p>这两个接口请求分别是加载 cesium 默认的地形数据和地图瓦片（其中 assets/1 是地形，assets/2 是瓦片）由于 cesium 服务器在国外，所以网络波动等原因会导致访问不稳定，从而影响地图加载速度</p>
<p>哪怕你是调用了第三方的地图瓦片，比如天地图瓦片服务，如果网络不稳定也会出现此错误，它会阻塞地图的正常加载</p>
<p>要想彻底解决只有将它禁用</p>
<h2 data-id="heading-1">禁用 cesium 默认地图瓦片</h2>
<p>默认地图瓦片默认是启用的，需要手动禁用</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> viewer = <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Viewer</span>(<span class="hljs-string">'CesiumViewer'</span>, {
  ...
  imageryProvider: <span class="hljs-literal">false</span> <span class="hljs-comment">// 不加载默认底图</span>
  ...
})
</code></pre>
<p>我们来测试下效果，这里放图片（算了不放了，节约文章空间）</p>
<h2 data-id="heading-2">禁用 cesium 默认地形数据</h2>
<p>地形默认是不启用的，如果你自己启动了，把它注释了就可以了</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> viewer = <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Viewer</span>(<span class="hljs-string">'CesiumViewer'</span>, {
  ...
  terrain: Cesium.Terrain.<span class="hljs-built_in">fromWorldTerrain</span>(), <span class="hljs-comment">// 使用Cesium官方的地形服务 全球地形数据</span>
  ...
})
</code></pre>
<p>注意：我的 Cesium 版本为 1.128，不同版本的启动地形和加载默认地图方法会不一样，请根据你项目中的版本去官方查找对应的 api 进行修改</p>
<p>刚接触三维地图的朋友可能会问，地形是个什么玩意？开启与关闭有何区别？这里我放两张截图来作对比（采用同样的视角）</p>
<p>这是加载地形的效果：可以看见，山势有明显的高低起伏</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3d6d2e44ec4586afa695499e0d26af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323554&amp;x-signature=Qabf4eA3KGOhWKJwyw6KQLNc15g%3D" alt="2.png" loading="lazy"/></p>
<p>这是关闭地形的效果：可以看见，山的高度没了，地图的 3D 立体变成了二维扁平</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b3aa42bf15f48a78e9655827cfe776a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323554&amp;x-signature=D5hS5QIht2e%2FZmMeR27urHfqiWg%3D" alt="3.png" loading="lazy"/></p>
<h2 data-id="heading-3">结语</h2>
<p>细心的朋友可能会问，既然地形对于三维地图如此重要，那么把他禁用了那岂不是效果大打折扣吗？是的，那么有什么办法，既能解决网络不好时报错，又能使地形存在呢？</p>
<p>办法是有的，那就是自己部署地形服务并调用，不从 cesium 官方获取地形接口即可</p>
<p>具体如何操作？如果有人感兴趣的话就下次再写吧</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[同事查日志太慢，我现场教他一套 awk、tail、grep、sed 组合拳]]></title>    <link>https://juejin.cn/post/7587714124856770614</link>    <guid>https://juejin.cn/post/7587714124856770614</guid>    <pubDate>2025-12-26T01:35:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587714124856770614" data-draft-id="7587712328825847844" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="同事查日志太慢，我现场教他一套 awk、tail、grep、sed 组合拳"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-26T01:35:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小富"/> <meta itemprop="url" content="https://juejin.cn/user/993614241734270"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            同事查日志太慢，我现场教他一套 awk、tail、grep、sed 组合拳
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614241734270/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小富
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T01:35:50.000Z" title="Fri Dec 26 2025 01:35:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>昨天临下班，生产环境出现了一个偶发的报错预警。</p>
<p>旁边的同事正~~准备排查，只见他输入命令 <code>cat application.log</code> ，一个 <strong>2GB</strong> 大小文本啊，日志哗哗刷啥也看不清，crtl + c 也停不下来了，最后轻轻的关闭连接，又重新打开了一个～</p>
<p>后端开发来说，熟练掌握 Linux 的日志分析命令是基本功，整理几一些基于 <code>tail</code>、<code>less</code>、<code>grep</code>、<code>sed</code>、<code>awk</code> 的日志查询场景，希望能帮你快速定位问题。</p>
<h3 data-id="heading-0">tail</h3>
<p>很多新手习惯用 <code>cat</code>，但对于大文件，<code>cat</code> 会导致屏幕刷屏，还容易把终端卡死。<code>tail</code> 才是实时监控的神器。</p>
<p><strong>真实场景 A：服务发版启动监控</strong></p>
<p>每次发版重启服务时，我们都需要确认 Spring Boot 是否启动成功，或者有没有初始化报错。</p>
<pre><code class="hljs language-java" lang="java"># -f (follow)：实时追加显示文件尾部内容
tail -f logs/application.log
</code></pre>
<p><strong>真实场景 B：配合测试复现 Bug</strong></p>
<p>测试同学说：我现在点一下按钮，你看看后台有没有报错。</p>
<p>此时不需要看历史日志，只需要盯着最新的输出。</p>
<pre><code class="hljs language-java" lang="java"># 只看最后 <span class="hljs-number">200</span> 行，并保持实时刷新，避免被历史日志干扰
tail -n <span class="hljs-number">200</span> -f logs/application.log
</code></pre>
<h3 data-id="heading-1">less</h3>
<p>如果需要查看之前的日志，推荐使用 <code>less</code>。不同于 <code>vim</code> 会一次性加载整个文件占用大量内存，<code>less</code> 是按需加载，打开几个 G 的文件也极其流畅，且支持向后回溯。</p>
<p><strong>真实场景：追查某笔客诉订单</strong></p>
<p>运营反馈：刚才 10 点左右，订单号 <code>ORD12345678</code> 支付失败了。</p>
<p>你需要从日志末尾开始，往前反向查找这个订单号。</p>
<pre><code class="hljs language-bash" lang="bash">less logs/application.log
</code></pre>
<p><strong>进入界面后的操作流：</strong></p>
<ol>
<li>
<p><code>Shift + G</code> 先跳到日志最末尾（因为报错通常发生在最近）。</p>
</li>
<li>
<p><code>?ORD12345678</code> 输入问号+订单号，<strong>向上反向搜索</strong>。</p>
</li>
<li>
<p><code>n</code>：如果当前这行不是关键信息，按 <code>n</code> 继续向上找上一次出现的位置。</p>
</li>
<li>
<p><code>Shift + F</code> 如果看着看着，日志又更新了，按这个组合键可以让 less 进入类似 <code>tail -f</code> 的实时滚动模式；按 <code>Ctrl + C</code> 退回浏览模式。</p>
</li>
</ol>
<h3 data-id="heading-2">grep</h3>
<p><code>grep</code> 是最常用的搜索命令，但在实际业务中，简单的关键词搜索往往不够用。</p>
<p><strong>真实场景 A：还原报错现场（关键）</strong></p>
<p>只看到 <code>NullPointerException</code> 这一行往往无法定位问题，我们需要知道<strong>报错前</strong>的请求参数是什么，<strong>报错后</strong>的堆栈信息是什么。</p>
<p>此时必须配合 <code>-C</code> (Context) 参数。</p>
<pre><code class="hljs language-java" lang="java"># 搜索异常关键字，并显示该行 <span class="hljs-string">"前后各 20 行"</span>
grep -C <span class="hljs-number">20</span> <span class="hljs-string">"NullPointerException"</span> logs/application.log
</code></pre>
<p><strong>真实场景 B：全链路追踪 TraceId</strong></p>
<p>微服务我们通常会通过 <code>TraceId</code> 串联请求。日志文件可能发生了滚动（Rolling），变成了 <code>app.log</code>、<code>app.log.1</code>、<code>app.log.2</code>。</p>
<p>我们需要在所有日志文件中搜索同一个 TraceId。</p>
<pre><code class="hljs language-java" lang="java"># 搜索当前目录下所有以 app.log 开头的文件
grep <span class="hljs-string">"TraceId-20251219001"</span> logs/app.log*
</code></pre>
<p><strong>真实场景 C：统计异常频次</strong></p>
<p>老板问：“Redis 超时异常今天到底发生了多少次？是偶发还是大规模？”</p>
<p>不需要数数，直接统计行数。</p>
<pre><code class="hljs language-java" lang="java"># -c (count)：只统计匹配的行数
grep -c <span class="hljs-string">"RedisConnectionException"</span> logs/application.log
</code></pre>
<p><strong>真实场景 D：排除干扰噪音</strong></p>
<p>排查问题时，日志里充斥着大量无关的 <code>INFO</code> 心跳日志或健康检查日志，严重干扰视线。</p>
<pre><code class="hljs language-java" lang="java"># -v (invert)：显示不包含 <span class="hljs-string">"HealthCheck"</span> 的所有行
grep -v <span class="hljs-string">"HealthCheck"</span> logs/application.log
</code></pre>
<h3 data-id="heading-3">sed</h3>
<p>有时候日志非常大，例如有 10GB，grep 搜出来的内容依然过多。如果我们明确知道生产事故发生在 <strong>14:00 到 14:05</strong> 之间，该怎么办？</p>
<p>下载整个日志不现实，<code>sed</code> 可以帮我们把这段时间的日志单独<strong>切</strong>出来，保存成一个小文件慢慢分析。</p>
<p><strong>真实场景：导出事故时间窗口的日志</strong></p>
<pre><code class="hljs language-java" lang="java"># 语法：sed -n <span class="hljs-string">'/开始时间/,/结束时间/p'</span> 源文件 &gt; 目标文件
# 注意：时间格式必须和日志里的格式完全一致
sed -n <span class="hljs-string">'/2025-12-19 14:00/,/2025-12-19 14:05/p'</span> logs/application.log &gt; error_segment.log
</code></pre>
<p>这样你就得到了一个只有几 MB 的 <code>error_segment.log</code>，这时候再下载到本地分析，或者发给同事，都非常方便。</p>
<h3 data-id="heading-4">Awk</h3>
<p><code>awk</code> 擅长处理列数据，对于格式规范的日志，如 Nginx 访问日志、Apache 日志，它可以直接在服务器上生成简报。</p>
<p><strong>真实场景 A：遭到攻击，查找恶意 IP</strong></p>
<p>服务突然报警 CPU 飙升，怀疑遭到 CC 攻击或爬虫抓取，我们需要分析 Nginx 日志，找出访问量最高的 IP。</p>
<p>假设日志格式第一列是 IP：</p>
<pre><code class="hljs language-java" lang="java"># <span class="hljs-number">1.</span> awk <span class="hljs-string">'{print $1}'</span>：提取第一列（IP）
# <span class="hljs-number">2.</span> sort：排序，把相同的 IP 排在一起
# <span class="hljs-number">3.</span> uniq -c：去重并统计每个 IP 出现的次数
# <span class="hljs-number">4.</span> sort -nr：按次数(n)倒序(r)排列
# <span class="hljs-number">5.</span> head -n <span class="hljs-number">10</span>：取前 <span class="hljs-number">10</span> 名

awk <span class="hljs-string">'{print $1}'</span> access.log | sort | uniq -c | sort -nr | head -n <span class="hljs-number">10</span>
</code></pre>
<p><strong>真实场景 B：找出响应最慢的接口</strong></p>
<p>Nginx 日志中通常记录了响应时间，假设在最后一列，我们想把响应时间超过 1 秒的请求找出来。</p>
<pre><code class="hljs language-java" lang="java"># $NF 代表最后一列
# 打印所有响应时间大于 <span class="hljs-number">1</span> 秒的 URL（假设 URL 在第 <span class="hljs-number">7</span> 列）
awk <span class="hljs-string">'$NF &gt; 1.000 {print $7, $NF}'</span> access.log
</code></pre>
<h3 data-id="heading-5">总结</h3>
<p>举的例子都是我常用的，建议把这几个命令刻在脑子里或者收藏本文，下次遇到生产问题，对着场景直接复制粘贴就ok了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzAxNTM4NzAyNg%3D%3D%26mid%3D2247499835%26idx%3D1%26sn%3Da202a41010813cd6e7496ef796723735%26chksm%3D9b8650c6acf1d9d0002189ed373170a770701fedaaaf2939a6eb041c58f2bbc749020aab728f%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzAxNTM4NzAyNg==&amp;mid=2247499835&amp;idx=1&amp;sn=a202a41010813cd6e7496ef796723735&amp;chksm=9b8650c6acf1d9d0002189ed373170a770701fedaaaf2939a6eb041c58f2bbc749020aab728f#rd" ref="nofollow noopener noreferrer">PS：这里送题主和大家一份计算机书籍资源包，基本上是我这些年学习和工作中看过的书籍，本身我是做后端的，像Java、数据结构、操作系统、JVM、SQL调优、面试题、职业规划看的会多花一些），点击下边链接直接获取：</a>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab62123b84f546c193527ec9f7fc63ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767317750&amp;x-signature=Uea%2By9xvTu2bq%2FpMygUVojK542U%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[async/await 到底要不要加 try-catch？异步错误处理最佳实践]]></title>    <link>https://juejin.cn/post/7587675443442024488</link>    <guid>https://juejin.cn/post/7587675443442024488</guid>    <pubDate>2025-12-26T01:28:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587675443442024488" data-draft-id="7579111646874828851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="async/await 到底要不要加 try-catch？异步错误处理最佳实践"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-26T01:28:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            async/await 到底要不要加 try-catch？异步错误处理最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T01:28:30.000Z" title="Fri Dec 26 2025 01:28:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上周五下午，我正准备下班，产品经理突然跑过来：“用户反馈说提交订单后没反应，是不是又出 bug 了？”</p>
<p>我一查日志，发现接口报了 500 错误，但页面上什么提示都没有。</p>
<p>原来是我写异步请求时忘了加<code>try-catch</code>。用户点完提交就以为成功了，结果订单根本没生成。</p>
<p>那一刻的我才意识到：async/await 错误处理真的不能省。</p>
<hr/>
<h2 data-id="heading-0">先来理解 async/await 是什么</h2>
<p>简单来说，<code>async/await</code>是处理异步操作的语法糖，让异步代码看起来像同步代码一样直观。</p>
<p><strong>没有 async/await 的时代：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 回调地狱</span>
<span class="hljs-title function_">fetchData</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">result1</span>) {
  <span class="hljs-title function_">fetchMoreData</span>(result1, <span class="hljs-keyword">function</span>(<span class="hljs-params">result2</span>) {
    <span class="hljs-title function_">fetchEvenMoreData</span>(result2, <span class="hljs-keyword">function</span>(<span class="hljs-params">result3</span>) {
      <span class="hljs-comment">// 更多嵌套...</span>
    })
  })
})
</code></pre>
<p><strong>有了 async/await 之后：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 同步般的写法</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> result1 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>()
  <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchMoreData</span>(result1)
  <span class="hljs-keyword">const</span> result3 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchEvenMoreData</span>(result2)
  <span class="hljs-keyword">return</span> result3
}
</code></pre>
<p>是不是清爽多了？但是，如果 await 后面的 Promise 发生错误（比如网络请求失败），这个错误会直接抛出，如果不捕获，就会导致程序崩溃。</p>
<hr/>
<h2 data-id="heading-1">什么时候必须加 try-catch？</h2>
<h3 data-id="heading-2">1. 需要给用户明确反馈的场景</h3>
<p>举个例子：用户点击提交按钮，如果失败了却没有任何提示，用户会以为提交成功，这体验多差啊！</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"submitOrder"</span> <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"loading"</span>&gt;</span>
      {{ loading ? '提交中...' : '提交订单' }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">successMessage</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">errorMessage</span>: <span class="hljs-string">''</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">submitOrder</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 开始加载</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = <span class="hljs-string">''</span>
      
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 尝试提交订单</span>
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/orders'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">orderData</span>)
        
        <span class="hljs-comment">// 提交成功</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">successMessage</span> = <span class="hljs-string">'订单提交成功！'</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/success'</span>) <span class="hljs-comment">// 跳转到成功页面</span>
        
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 根据不同错误类型给用户不同的提示</span>
        <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = <span class="hljs-string">'请先登录后再提交订单'</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">400</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = <span class="hljs-string">'订单数据有误，请检查后重试'</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">500</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = <span class="hljs-string">'服务器繁忙，请稍后重试'</span>
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = <span class="hljs-string">'网络错误，请检查网络连接'</span>
        }
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 无论成功失败，都要取消加载状态</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
      }
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>用户操作必须有反馈</li>
<li>不同错误给出不同提示</li>
<li>使用 finally 确保加载状态正确重置</li>
</ul>
<h3 data-id="heading-3">2. 需要继续执行后续逻辑的场景</h3>
<p>有时候，即使某个请求失败了，我们仍然希望继续执行其他操作。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initializePage</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 获取用户基本信息（重要）</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userInfo</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/user/info'</span>)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户信息失败，但页面仍可正常使用'</span>)
    <span class="hljs-comment">// 即使失败，也继续执行下面的逻辑</span>
  }
  
  <span class="hljs-comment">// 获取用户设置（重要）</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userSettings</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/user/settings'</span>)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户设置失败'</span>)
    <span class="hljs-comment">// 使用默认设置继续</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userSettings</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultSettings</span>
  }
  
  <span class="hljs-comment">// 获取推荐内容（非关键，失败也没关系）</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">recommendations</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/recommendations'</span>)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 静默失败，不影响主要功能</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'推荐内容加载失败'</span>)
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-4">什么时候可以不加 try-catch？</h2>
<h3 data-id="heading-5">1. 有全局错误拦截器的情况</h3>
<p>如果你的项目配置了全局的 HTTP 拦截器，那么很多错误已经被统一处理了。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// http.js - 全局拦截器</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response,
  <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 全局统一处理错误</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {
      router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/login'</span>)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">500</span>) {
      <span class="hljs-title class_">Message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'服务器错误，请稍后重试'</span>)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
  }
)

<span class="hljs-comment">// 组件中 - 不需要重复处理</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 错误已经被全局拦截器处理了</span>
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span> = data
}
</code></pre>
<h3 data-id="heading-6">2. 错误需要向上抛出的情况</h3>
<p>在编写可复用的函数时，通常不应该在函数内部处理错误，而是让调用方来决定如何处理。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// api/user.js - 用户相关的 API 函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> userApi = {
  <span class="hljs-comment">// 不处理错误，让调用方决定如何处理</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getUserProfile</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">${userId}</span>`</span>)
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
  },
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">updateUserProfile</span>(<span class="hljs-params">userId, profile</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">put</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">${userId}</span>`</span>, profile)
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
  }
}

<span class="hljs-comment">// 组件中 - 调用方处理错误</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadUserProfile</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">profile</span> = <span class="hljs-keyword">await</span> userApi.<span class="hljs-title function_">getUserProfile</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">userId</span>)
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'加载用户信息失败'</span>)
      }
    }
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-7">让代码更简洁</h2>
<p>每次都写 try-catch 确实有点啰嗦。我们可以封装一个工具函数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// utils/safeAsync.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">safeAsync</span>(<span class="hljs-params">promise</span>) {
  <span class="hljs-keyword">return</span> promise
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> [<span class="hljs-literal">null</span>, data])      <span class="hljs-comment">// 成功：[null, 数据]</span>
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> [err, <span class="hljs-literal">null</span>])       <span class="hljs-comment">// 失败：[错误, null]</span>
}
</code></pre>
<p>使用方式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { safeAsync } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/safeAsync'</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [err, data] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">safeAsync</span>(<span class="hljs-title function_">getUserInfo</span>())
  
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'加载失败'</span>)
    <span class="hljs-keyword">return</span>
  }
  
  user.<span class="hljs-property">value</span> = data
}
</code></pre>
<p>这看起来更舒服了吧？这种写法来自 Go 语言的错误优先风格，在 JS 社区也很流行。</p>
<hr/>
<h2 data-id="heading-8">多个请求怎么办？先别用 Promise.all</h2>
<p>很多朋友喜欢这样写：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 危险！一个失败，全部失败</span>
<span class="hljs-keyword">const</span> [user, orders] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
  <span class="hljs-title function_">getUser</span>(),
  <span class="hljs-title function_">getOrders</span>()
])
</code></pre>
<p>但如果 <code>getOrders()</code> 挂了，<code>getUser()</code> 的结果也会丢掉！</p>
<p>正确做法：用 <code>Promise.allSettled</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>([<span class="hljs-title function_">getUser</span>(), <span class="hljs-title function_">getOrders</span>()])

<span class="hljs-keyword">const</span> user = results[<span class="hljs-number">0</span>].<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span> ? results[<span class="hljs-number">0</span>].<span class="hljs-property">value</span> : <span class="hljs-literal">null</span>
<span class="hljs-keyword">const</span> orders = results[<span class="hljs-number">1</span>].<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span> ? results[<span class="hljs-number">1</span>].<span class="hljs-property">value</span> : []

<span class="hljs-comment">// 即使订单加载失败，用户信息还能显示！</span>
</code></pre>
<p>或者用我们上面的 <code>safeAsync</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> [userErr, user] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">safeAsync</span>(<span class="hljs-title function_">getUser</span>())
<span class="hljs-keyword">const</span> [orderErr, orders] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">safeAsync</span>(<span class="hljs-title function_">getOrders</span>())

<span class="hljs-keyword">if</span> (userErr) <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">warning</span>(<span class="hljs-string">'用户信息加载失败'</span>)
<span class="hljs-keyword">if</span> (orderErr) <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">warning</span>(<span class="hljs-string">'订单加载失败'</span>)
</code></pre>
<hr/>
<h2 data-id="heading-9">全局错误兜底</h2>
<p>即使你写了 try-catch，也可能漏掉。所以可以做一些兜底的操作。</p>
<p>比如在全局拦截器处理，或者也可以在 <code>main.js</code> 这样写加个安全网：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)

<span class="hljs-comment">// 全局 Vue 错误处理器</span>
app.<span class="hljs-property">config</span>.<span class="hljs-property">errorHandler</span> = <span class="hljs-function">(<span class="hljs-params">err, instance, info</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Vue 组件错误:'</span>, err, info)
  <span class="hljs-title class_">ElNotification</span>.<span class="hljs-title function_">error</span>({
    <span class="hljs-attr">title</span>: <span class="hljs-string">'系统异常'</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'页面出现错误，请刷新重试'</span>
  })
}

app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>这样，就算你忘了加 try-catch，也不会让用户看到白屏！</p>
<hr/>
<h2 data-id="heading-10">总结</h2>
<ol>
<li><strong>用户需要反馈时</strong>必须加 try-catch</li>
<li><strong>关键业务流程</strong>必须加 try-catch</li>
<li><strong>有全局处理时</strong>可以不加，避免重复</li>
<li><strong>编写可复用函数时</strong>通常不加，让调用方处理</li>
<li><strong>非关键操作</strong>可以不加，或简单处理</li>
</ol>
<p>错误处理不是一刀切的事情，需要根据具体业务场景来决定。好的错误处理能让你的应用更加健壮，用户体验更好。</p>
<p>感谢观看，希望这篇文章能帮你理清思路！</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-11">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F184BGM_pdMFLc0ASrferwQ" target="_blank" title="https://mp.weixin.qq.com/s/184BGM_pdMFLc0ASrferwQ" ref="nofollow noopener noreferrer">《代码里全是 new 对象，真的很 Low 吗？我认真想了一晚》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fp0n2mN5RDDDaIWuHHVRUZQ" target="_blank" title="https://mp.weixin.qq.com/s/p0n2mN5RDDDaIWuHHVRUZQ" ref="nofollow noopener noreferrer">《Java 开发必看：什么时候用 for，什么时候用 Stream？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FX-MSa0CHwVW_qgPezbpMUA" target="_blank" title="https://mp.weixin.qq.com/s/X-MSa0CHwVW_qgPezbpMUA" ref="nofollow noopener noreferrer">《这 5 个冷门 HTML 标签，让我直接删了100 行 JS 代码》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FT3ronvigepWew6dRC4uH2g" target="_blank" title="https://mp.weixin.qq.com/s/T3ronvigepWew6dRC4uH2g" ref="nofollow noopener noreferrer">《Vue 组件通信的 8 种最佳实践，你知道几种？》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin协程：Job.cancel() 和 Scope.cancel() 的区别详解！！！]]></title>    <link>https://juejin.cn/post/7587704265054945318</link>    <guid>https://juejin.cn/post/7587704265054945318</guid>    <pubDate>2025-12-26T03:28:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587704265054945318" data-draft-id="7587779957674573875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin协程：Job.cancel() 和 Scope.cancel() 的区别详解！！！"/> <meta itemprop="keywords" content="Kotlin,Android,Android Jetpack"/> <meta itemprop="datePublished" content="2025-12-26T03:28:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QING618"/> <meta itemprop="url" content="https://juejin.cn/user/339115460529117"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin协程：Job.cancel() 和 Scope.cancel() 的区别详解！！！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339115460529117/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QING618
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:28:58.000Z" title="Fri Dec 26 2025 03:28:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Kotlin 协程中，<code>Job.cancel()</code> 和 <code>Scope.cancel()</code> 都用于取消协程，但它们的作用范围和行为有重要区别：</p>
<h2 data-id="heading-0">1. Job.cancel()</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job = launch {
    <span class="hljs-comment">// 协程体</span>
}
job.cancel()  <span class="hljs-comment">// 只取消这个特定的 job</span>
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>只取消<strong>单个 Job</strong> 及其子协程</li>
<li>不会影响同一作用域中的其他 Job</li>
<li>Job 被取消后，仍然可以附加新的子协程</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job1 = scope.launch { <span class="hljs-comment">/* 任务1 */</span> }
<span class="hljs-keyword">val</span> job2 = scope.launch { <span class="hljs-comment">/* 任务2 */</span> }

job1.cancel()  <span class="hljs-comment">// 只取消 job1，job2 继续运行</span>
</code></pre>
<h2 data-id="heading-1">2. Scope.cancel()</h2>
<pre><code class="hljs language-kotlin" lang="kotlin">scope.cancel()  <span class="hljs-comment">// 取消整个作用域及其所有协程</span>
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>取消<strong>整个作用域</strong>中的所有协程</li>
<li>作用域被取消后，<strong>不能再启动新的协程</strong></li>
<li>所有子 Job 都会被取消</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> scope = CoroutineScope(Dispatchers.IO)

scope.launch { <span class="hljs-comment">/* 任务1 */</span> }
scope.launch { <span class="hljs-comment">/* 任务2 */</span> }

scope.cancel()  <span class="hljs-comment">// 取消所有任务，且 scope 不能再 launch 新协程</span>
</code></pre>
<h2 data-id="heading-2">3. 关键区别对比</h2>






























<table><thead><tr><th>特性</th><th>Job.cancel()</th><th>Scope.cancel()</th></tr></thead><tbody><tr><td>作用范围</td><td>单个 Job + 其子协程</td><td>整个作用域 + 所有协程</td></tr><tr><td>后续使用</td><td>可继续启动新协程</td><td>作用域已失效，不能启动新协程</td></tr><tr><td>状态影响</td><td>Job 进入 Cancelling 状态</td><td>Scope 和所有 Job 都取消</td></tr><tr><td>典型场景</td><td>取消特定任务</td><td>清理整个界面/组件资源</td></tr></tbody></table>
<h2 data-id="heading-3">4. 实际例子</h2>
<h3 data-id="heading-4">Job.cancel() 示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> scope = CoroutineScope(SupervisorJob())

<span class="hljs-keyword">val</span> jobA = scope.launch {
    delay(<span class="hljs-number">1000</span>)
    println(<span class="hljs-string">"Job A 完成"</span>)
}

<span class="hljs-keyword">val</span> jobB = scope.launch {
    delay(<span class="hljs-number">2000</span>)
    println(<span class="hljs-string">"Job B 完成"</span>)
}

<span class="hljs-comment">// 只取消 jobA，jobB 继续运行</span>
jobA.cancel()

<span class="hljs-comment">// scope 仍然可用，可以启动新协程</span>
scope.launch { println(<span class="hljs-string">"新协程"</span>) }
</code></pre>
<h3 data-id="heading-5">Scope.cancel() 示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> scope = CoroutineScope(SupervisorJob())

scope.launch { <span class="hljs-comment">/* 任务1 */</span> }
scope.launch { <span class="hljs-comment">/* 任务2 */</span> }

<span class="hljs-comment">// 取消整个作用域</span>
scope.cancel()

<span class="hljs-comment">// 这里会抛出异常：Scope is cancelled</span>
scope.launch { println(<span class="hljs-string">"这不会执行"</span>) }
</code></pre>
<h2 data-id="heading-6">5. 重要细节</h2>
<h3 data-id="heading-7">Scope.cancel() 的内部实现</h3>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// CoroutineScope 的 cancel() 实际上调用了关联 Job 的 cancel()</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">cancel</span><span class="hljs-params">(cause: <span class="hljs-type">CancellationException</span>? = <span class="hljs-literal">null</span>)</span></span> {
    <span class="hljs-keyword">val</span> job = coroutineContext[Job]
        ?: error(<span class="hljs-string">"Scope cannot be cancelled because it does not have a job"</span>)
    job.cancel(cause)
}
</code></pre>
<h3 data-id="heading-8">结构化并发的体现</h3>
<ul>
<li>在结构化并发中，通常使用 <code>scope.cancel()</code> 来清理资源</li>
<li>ViewModel 销毁时：<code>viewModelScope.cancel()</code></li>
<li>Activity 销毁时：<code>lifecycleScope.cancel()</code></li>
</ul>
<h3 data-id="heading-9">异常处理差异</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Job.cancel() 可以指定原因</span>
job.cancel(<span class="hljs-string">"用户取消操作"</span>)

<span class="hljs-comment">// Scope.cancel() 同样可以</span>
scope.cancel(TimeoutCancellationException(<span class="hljs-string">"超时"</span>))
</code></pre>
<h2 data-id="heading-10">6. 最佳实践建议</h2>
<ol>
<li>
<p><strong>使用 Job.cancel()</strong>  当需要：</p>
<ul>
<li>取消特定的后台任务</li>
<li>实现可取消的单个操作</li>
<li>不影响其他并行任务</li>
</ul>
</li>
<li>
<p><strong>使用 Scope.cancel()</strong>  当需要：</p>
<ul>
<li>组件（Activity/Fragment）销毁时清理资源</li>
<li>取消整个工作流的所有任务</li>
<li>确保没有协程泄露</li>
</ul>
</li>
<li>
<p><strong>在 ViewModel 中</strong>：</p>
</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> customScope = CoroutineScope(SupervisorJob())
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startWork</span><span class="hljs-params">()</span></span> {
        customScope.launch { <span class="hljs-comment">/* 工作 */</span> }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCleared</span><span class="hljs-params">()</span></span> {
        customScope.cancel()  <span class="hljs-comment">// 清理自定义作用域</span>
        <span class="hljs-keyword">super</span>.onCleared()
    }
    
    <span class="hljs-comment">// viewModelScope 会自动管理，无需手动取消</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">useViewModelScope</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch { <span class="hljs-comment">/* 自动绑定生命周期 */</span> }
    }
}
</code></pre>
<p><strong>核心总结</strong>：<code>Job.cancel()</code> 是<strong>选择性取消</strong>，<code>Scope.cancel()</code> 是<strong>全面清理</strong>。在结构化并发中，通常让作用域管理生命周期，仅在特殊情况下单独取消特定 Job。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android ANR项目实战：Reason: Broadcast { act=android.intent.action.TIME_TICK}]]></title>    <link>https://juejin.cn/post/7587636536898240548</link>    <guid>https://juejin.cn/post/7587636536898240548</guid>    <pubDate>2025-12-26T00:18:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587636536898240548" data-draft-id="7586893663075762186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android  ANR项目实战：Reason: Broadcast { act=android.intent.action.TIME_TICK}"/> <meta itemprop="keywords" content="前端,Android,人工智能"/> <meta itemprop="datePublished" content="2025-12-26T00:18:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏程十八少"/> <meta itemprop="url" content="https://juejin.cn/user/184373685534077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android  ANR项目实战：Reason: Broadcast { act=android.intent.action.TIME_TICK}
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373685534077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏程十八少
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T00:18:51.000Z" title="Fri Dec 26 2025 00:18:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>同事最近出现一个ANR,又没Trace文件，不知道如何分析，报错信息如下：</p>
<h2 data-id="heading-0">1.报错信息</h2>
<pre><code class="hljs language-12-23" lang="12-23">12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 事件类型: 
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 发生时间: 2025-12-23 15:32:05.537
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 调用耗时: 5001ms
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: === 系统资源状态 ===
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 进程内存: 126MB (PSS)
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: Java堆内存: 39MB
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: Native堆内存: 0MB
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 系统可用内存: 15224MB / 16385MB
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: CPU使用率: 0.0%
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: Binder状态: 统计不可用
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: === 性能分析 ===
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 问题描述: 获取无障碍根节点耗时5001ms，超过正常阈值
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 建议: 检查系统负载，优化无障碍服务逻辑
</code></pre>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span> <span class="hljs-string">ANR</span> <span class="hljs-string">in</span> <span class="hljs-string">com.tencent.carecolauncher</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager: PID:</span> <span class="hljs-number">43162</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager: Reason:</span> <span class="hljs-string">Broadcast</span> <span class="hljs-string">of</span> <span class="hljs-string">Intent</span> { <span class="hljs-string">act=android.intent.action.TIME_TICK</span> <span class="hljs-string">flg=0x50200014</span> <span class="hljs-string">(has</span> <span class="hljs-string">extras)</span> }
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager: Load:</span> <span class="hljs-number">169.8</span> <span class="hljs-string">/</span> <span class="hljs-number">144.63</span> <span class="hljs-string">/</span> <span class="hljs-number">112.13</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span> <span class="hljs-string">CPU</span> <span class="hljs-string">usage</span> <span class="hljs-string">from</span> <span class="hljs-string">0ms</span> <span class="hljs-string">to</span> <span class="hljs-string">7239ms</span> <span class="hljs-string">later</span> <span class="hljs-string">(2025-12-23</span> <span class="hljs-number">15</span><span class="hljs-string">:32:10.006</span> <span class="hljs-string">to</span> <span class="hljs-number">2025-12-23 15:32:17.245</span><span class="hljs-string">):</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">19</span><span class="hljs-string">%</span> <span class="hljs-attr">44555/gzip:</span> <span class="hljs-number">12</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">6</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">16</span><span class="hljs-string">%</span> <span class="hljs-attr">100/surfaceflinger:</span> <span class="hljs-number">8.2</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">8.4</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">164</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">14</span><span class="hljs-string">%</span> <span class="hljs-attr">43162/com.tencent.carecolauncher:</span> <span class="hljs-number">10</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.5</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">8324 </span><span class="hljs-string">minor</span> <span class="hljs-number">3</span> <span class="hljs-string">major</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">9.3</span><span class="hljs-string">%</span> <span class="hljs-attr">254/system_server:</span> <span class="hljs-number">3</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">6.3</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">4072 </span><span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">8.8</span><span class="hljs-string">%</span> <span class="hljs-attr">2071/com.autonavi.amapauto:</span> <span class="hljs-number">4.9</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">3.8</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">4576 </span><span class="hljs-string">minor</span> <span class="hljs-number">4</span> <span class="hljs-string">major</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">6.7</span><span class="hljs-string">%</span> <span class="hljs-attr">44554/tar_custom:</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">6.4</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.3</span><span class="hljs-string">%</span> <span class="hljs-attr">43186/com.android.systemui:</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">2327 </span><span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">1.3</span><span class="hljs-string">%</span> <span class="hljs-attr">1539/com.tencent.cloudsmartvoice:</span> <span class="hljs-number">0.9</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.4</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">6130 </span><span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.8</span><span class="hljs-string">%</span> <span class="hljs-attr">1100/com.android.phone:</span> <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.6</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">680</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">1560/com.tencent.netserver:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">2003 </span><span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">1081/com.tencent.datatrackclient:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">785</span> <span class="hljs-string">minor</span> <span class="hljs-number">1</span> <span class="hljs-string">major</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.5</span><span class="hljs-string">%</span> <span class="hljs-attr">1060/com.tencent.datatrackservice:</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">730</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-attr">1//init:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">173</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-attr">46/logd:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">18</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">131/tombstoned:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">7</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-attr">137/logcat:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">1</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">47/servicemanager:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">48/hwservicemanager:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">60</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">78/netd:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">45</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">79/zygote64:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">107/cameraserver:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">50</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">120/media.extractor:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">19</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">122/mediaserver:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">24</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">1440/com.baidu.input_huawei:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">24</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">1938/com.tencent.settings:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">17</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">2316/com.autonavi.amapauto:locationservice:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">13</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>  <span class="hljs-string">+0%</span> <span class="hljs-attr">44854/audioserver:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>  <span class="hljs-string">+0%</span> <span class="hljs-attr">44856/CloudAppEngine:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>  <span class="hljs-string">+0%</span> <span class="hljs-attr">44989/media.codec:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>  <span class="hljs-string">+0%</span> <span class="hljs-attr">45004/sh:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>  <span class="hljs-string">+0%</span> <span class="hljs-attr">45005/sh:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>  <span class="hljs-string">+0%</span> <span class="hljs-attr">45006/tee:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span> <span class="hljs-number">2</span><span class="hljs-string">%</span> <span class="hljs-attr">TOTAL:</span> <span class="hljs-number">1.6</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.4</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span> <span class="hljs-string">CPU</span> <span class="hljs-string">usage</span> <span class="hljs-string">from</span> <span class="hljs-string">26ms</span> <span class="hljs-string">to</span> <span class="hljs-string">260ms</span> <span class="hljs-string">later</span> <span class="hljs-string">(2025-12-23</span> <span class="hljs-number">15</span><span class="hljs-string">:32:10.032</span> <span class="hljs-string">to</span> <span class="hljs-number">2025-12-23 15:32:10.266</span><span class="hljs-string">):</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">16</span><span class="hljs-string">%</span> <span class="hljs-attr">254/system_server:</span> <span class="hljs-number">4.1</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">12</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">274</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>     <span class="hljs-number">16</span><span class="hljs-string">%</span> <span class="hljs-attr">268/ActivityManager:</span> <span class="hljs-number">4.1</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">12</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">8.3</span><span class="hljs-string">%</span> <span class="hljs-attr">100/surfaceflinger:</span> <span class="hljs-number">4.1</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.1</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>     <span class="hljs-number">12</span><span class="hljs-string">%</span> <span class="hljs-attr">100/surfaceflinger:</span> <span class="hljs-number">4.1</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">8.3</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">8.8</span><span class="hljs-string">%</span> <span class="hljs-attr">44555/gzip:</span> <span class="hljs-number">4.4</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.4</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">4.2</span><span class="hljs-string">%</span> <span class="hljs-attr">1659/CloudAppEngine:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.2</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">4.2</span><span class="hljs-string">%</span> <span class="hljs-attr">2071/com.autonavi.amapauto:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.2</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">3</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>     <span class="hljs-number">4.2</span><span class="hljs-string">%</span> <span class="hljs-attr">2262/gnet_proc:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.2</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">4.4</span><span class="hljs-string">%</span> <span class="hljs-attr">44554/tar_custom:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.4</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span> <span class="hljs-number">0.9</span><span class="hljs-string">%</span> <span class="hljs-attr">TOTAL:</span> <span class="hljs-number">0.6</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.294   254   270 I ActivityManager: Start proc 45028:</span>

</code></pre>
<h2 data-id="heading-1">2.问题概述：</h2>
<p><strong>ANR原因：</strong>  处理广播 <code>android.intent.action.TIME_TICK</code> 时超时</p>
<h2 data-id="heading-2">3.关键问题分析：</h2>
<h3 data-id="heading-3">1. <strong>系统负载极高</strong></h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Load: 169.8 / 144.63 / 112.13</span>
</code></pre>
<ul>
<li>系统1分钟平均负载高达169.8（远超正常值）</li>
<li>这表明系统极度繁忙，CPU资源严重不足</li>
</ul>
<h3 data-id="heading-4">2. <strong>主要CPU占用者</strong></h3>
<ul>
<li><strong>gzip进程 (PID: 44555):</strong>  19% CPU</li>
<li><strong>surfaceflinger:</strong>  16% CPU</li>
<li><strong>问题应用本身:</strong>  14% CPU（且有大量缺页中断）</li>
<li><strong>system_server:</strong>  9.3% CPU</li>
<li><strong>高德地图车机版:</strong>  8.8% CPU</li>
</ul>
<h3 data-id="heading-5">三个数字的含义：</h3>
<h3 data-id="heading-6"><strong>格式：</strong>  1分钟平均 / 5分钟平均 / 15分钟平均</h3>
<ul>
<li><strong>169.8</strong> - 过去1分钟的平均负载</li>
<li><strong>144.63</strong> - 过去5分钟的平均负载</li>
<li><strong>112.13</strong> - 过去15分钟的平均负载</li>
</ul>
<h3 data-id="heading-7">如何理解这些数值：</h3>
<h3 data-id="heading-8"><strong>基准对比：</strong></h3>
<p>通常与<strong>CPU核心数</strong>进行比较：</p>
<ul>
<li>负载值 &lt; CPU核心数：系统相对空闲</li>
<li>负载值 ≈ CPU核心数：系统满负荷运行</li>
<li>负载值 &gt; CPU核心数：系统过载，有进程在等待CPU</li>
</ul>
<h3 data-id="heading-9"><strong>车机系统分析：</strong></h3>
<p>假设这个车机系统有<strong>8个CPU核心</strong>：</p>
<ul>
<li>正常情况：负载应该在8以下</li>
<li><strong>实际负载：169.8</strong>（远超CPU核心数）</li>
</ul>
<p>用命令查看： adb shell uptime
正常情况下的负载参数：<br/>
10:08:11 up 100 days, 15:26,  0 users,  load average: 0.47, 0.42, 0.42</p>
<h4 data-id="heading-10">具体含义：</h4>
<h3 data-id="heading-11"><strong>为什么这么高？</strong></h3>
<ol>
<li>
<p><strong>大量进程在运行队列中等待CPU</strong></p>
<ul>
<li>系统中有平均169个进程在等待执行</li>
<li>包括：可运行状态（R状态）和不可中断睡眠状态（D状态）</li>
</ul>
</li>
<li>
<p><strong>系统严重过载</strong></p>
<ul>
<li>CPU资源极度匮乏</li>
<li>进程需要长时间等待才能获得CPU时间片</li>
</ul>
</li>
</ol>
<h4 data-id="heading-12">在ANR问题中的意义：</h4>
<h3 data-id="heading-13"><strong>直接导致ANR的原因：</strong></h3>
<ol>
<li>
<p><strong>Launcher应用无法及时获得CPU时间片</strong></p>
<ul>
<li>系统中有169个进程在排队</li>
<li>Launcher的广播接收器需要等待很长时间才能执行</li>
</ul>
</li>
<li>
<p><strong>TIME_TICK广播处理延迟</strong></p>
<pre><code class="hljs language-ini" lang="ini">Reason: Broadcast of Intent { <span class="hljs-attr">act</span>=android.intent.action.TIME_TICK }
</code></pre>
<ul>
<li>TIME_TICK广播每分钟发送一次</li>
<li>由于系统负载高，Launcher可能延迟了几秒甚至几十秒才处理到这个广播</li>
<li>Android系统检测到广播处理超时（通常5秒），触发ANR</li>
</ul>
</li>
</ol>
<p>代码里面没用注册这个广播：</p>
<p><strong><code>TextClock</code></strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterTextChanged</span>(<span class="hljs-params">Editable s</span>)</span> {
    LogUtil.d(TAG, <span class="hljs-string">"afterTextChanged s: "</span> + s); <span class="hljs-comment">// ← 这行每分钟都打日志！</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"00:00"</span>.<span class="hljs-keyword">equals</span>(s.toString()) || ...) {
        updateDate();
    }
}
</code></pre>
<h3 data-id="heading-14">验证方法：看 <code>traces.txt</code> 主线程堆栈</h3>
<p>如果你能拿到 <code>/data/anr/traces.txt</code>，搜索 <code>main</code> 线程，大概率会看到：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-string">"main"</span> prio<span class="hljs-operator">=</span><span class="hljs-number">5</span> tid<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-type">Native</span>
  <span class="hljs-operator">|</span> group<span class="hljs-operator">=</span><span class="hljs-string">"main"</span> sCount<span class="hljs-operator">=</span><span class="hljs-number">1</span> dsCount<span class="hljs-operator">=</span><span class="hljs-number">0</span> flags<span class="hljs-operator">=</span><span class="hljs-number">1</span> obj<span class="hljs-operator">=</span><span class="hljs-number">0x74b0a8a0</span> <span class="hljs-keyword">self</span><span class="hljs-operator">=</span><span class="hljs-number">0xb400007c</span><span class="hljs-operator">...</span>
  at android.os.<span class="hljs-type">BinderProxy</span>.transactNative(<span class="hljs-type">Native</span> method)
  at android.os.<span class="hljs-type">BinderProxy</span>.transact(<span class="hljs-type">Binder</span>.java:<span class="hljs-number">1133</span>)
  at android.app.<span class="hljs-type">IActivityManager</span><span class="hljs-variable">$Stub</span><span class="hljs-variable">$Proxy</span>.broadcastIntent(<span class="hljs-operator">...</span>)
  <span class="hljs-operator">...</span>
  at android.widget.<span class="hljs-type">TextClock</span><span class="hljs-variable">$1</span>.onReceive(<span class="hljs-type">TextClock</span>.java:<span class="hljs-number">123</span>)
  at android.app.<span class="hljs-type">LoadedApk</span><span class="hljs-variable">$ReceiverDispatcher</span><span class="hljs-variable">$Args</span>.lambda<span class="hljs-variable">$getRunnable</span><span class="hljs-variable">$0</span><span class="hljs-variable">$LoadedApk</span><span class="hljs-variable">$ReceiverDispatcher</span><span class="hljs-variable">$Args</span>(<span class="hljs-type">LoadedApk</span>.java:<span class="hljs-number">1550</span>)
  <span class="hljs-operator">...</span>
  at com.gwm.presetcard.vehicle.view.<span class="hljs-type">VehicleSettingsCardView</span><span class="hljs-variable">$1</span>.afterTextChanged(<span class="hljs-type">VehicleSettingsCardView</span>.java:<span class="hljs-type">XX</span>)
</code></pre>
<p>→ 明确显示卡在 <code>TextClock</code> 的广播接收 + 你的 <code>TextWatcher</code></p>
<p>解决方案：</p>
<p><strong>替换为 <code>TextView + Handler</code> 是最稳妥方案</strong>，彻底绕过系统广播机制。</p>
<p><code>private void startClock() { mClockUpdater.run(); } private final Runnable mClockUpdater = new Runnable() { @Override public void run() { mVehicleSettingsClock.setText(new SimpleDateFormat("HH:mm").format(new Date())); long delay = 60_000 - (System.currentTimeMillis() % 60_000); mHandler.postDelayed(this, delay); } };</code></p>
<h3 data-id="heading-15">3. <strong>具体问题表现</strong></h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">14</span><span class="hljs-string">%</span> <span class="hljs-attr">43162/com.tencent.carecolauncher:</span> <span class="hljs-number">10</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.5</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">8324 </span><span class="hljs-string">minor</span> <span class="hljs-number">3</span> <span class="hljs-string">major</span>
</code></pre>
<ul>
<li>应用本身占用14% CPU</li>
<li><strong>8324次minor faults和3次major faults</strong>：表明应用在进行大量内存分配/访问操作</li>
<li>处理TIME_TICK广播时响应超时</li>
</ul>
<h3 data-id="heading-16"><strong>CPU使用部分：</strong></h3>
<ul>
<li><strong>14%</strong>  - 该进程占总CPU时间的14%</li>
<li><strong>10% user</strong> - 在用户态运行占10%（执行应用自己的代码）</li>
<li><strong>4.5% kernel</strong> - 在内核态运行占4.5%（执行系统调用、内核服务）</li>
</ul>
<h3 data-id="heading-17"><strong>缺页中断部分（关键线索）：</strong></h3>
<ul>
<li><strong>8324 minor faults</strong> - 8324次次缺页中断</li>
<li><strong>3 major faults</strong> - 3次主缺页中断</li>
</ul>
<h4 data-id="heading-18">这说明了什么：</h4>
<h3 data-id="heading-19"><strong>1. 应用正在大量分配/访问内存</strong></h3>
<ul>
<li>
<p><strong>Minor faults（次缺页中断）</strong> ：当进程访问的页面在物理内存中但未映射到进程地址空间时发生</p>
<ul>
<li>常见于：堆内存分配、文件映射、动态链接库加载、写时复制等</li>
<li><strong>8324次</strong>在7秒多的时间内，表明应用在进行<strong>非常频繁的内存操作</strong></li>
</ul>
</li>
</ul>
<h3 data-id="heading-20"><strong>2. 可能的内存密集型操作</strong></h3>
<p>应用可能正在：</p>
<ul>
<li><strong>创建大量对象</strong>（频繁的垃圾回收）</li>
<li><strong>处理大尺寸图片/资源</strong></li>
<li><strong>加载大量数据到内存</strong></li>
<li><strong>进行文件映射操作</strong></li>
<li><strong>执行大量的UI布局/渲染</strong></li>
</ul>
<h3 data-id="heading-21"><strong>3. Major faults的严重性</strong></h3>
<ul>
<li><strong>Major faults（主缺页中断）</strong> ：需要从磁盘读取数据到内存</li>
<li>通常涉及：从存储设备读取文件、内存交换（swap）等</li>
<li><strong>3次major faults</strong>虽然不多，但每次都会导致显著延迟（毫秒级阻塞）</li>
</ul>
<h3 data-id="heading-22"><strong>4. ANR抓取错误了，ANR 日志中的“Reason”是误导性的</strong></h3>
<p>在极端高负载（Load &gt; 160）情况下：</p>
<ul>
<li>系统可能在 <strong>发送 <code>TIME_TICK</code> 时发现你的应用主线程无响应</strong></li>
<li>即使你<strong>根本没注册</strong>，AMS（ActivityManagerService）也可能把“最近一次尝试发送的广播”记为 ANR 原因</li>
<li>实际根本原因是：<strong>你的主线程早已卡死（比如死锁、I/O 阻塞），恰好在 <code>TIME_TICK</code> 到来时被检测到</strong></li>
</ul>
<blockquote>
<p>💡 类比：一个人已经昏迷 5 分钟，救护车（TIME_TICK）来了发现他没反应，就记录“因救护车到来时无反应”，但真正病因是 earlier 的脑梗。</p>
</blockquote>
<h4 data-id="heading-23">可能的原因：</h4>
<h3 data-id="heading-24">主要原因：</h3>
<ol>
<li>
<p><strong>系统级资源竞争</strong></p>
<ul>
<li>gzip进程占用大量CPU（可能是系统压缩/备份操作）</li>
<li>多个车机应用同时高CPU使用，导致Launcher无法及时响应</li>
</ul>
</li>
<li>
<p><strong>Launcher应用问题</strong></p>
<ul>
<li>TIME_TICK广播每分钟一次，可能触发Launcher的时钟更新等操作</li>
<li>广播接收器中可能执行了耗时操作</li>
<li>应用可能在进行大量UI渲染或数据处理</li>
</ul>
</li>
<li>
<p><strong>内存压力</strong></p>
<ul>
<li>大量缺页中断表明内存访问频繁，可能存在内存泄漏或频繁GC</li>
</ul>
</li>
</ol>
<p>3.后面补充了Trace文件，进一步确认了</p>
<pre><code class="hljs language-less" lang="less">"<span class="hljs-selector-tag">RenderThread</span>" <span class="hljs-selector-tag">daemon</span> <span class="hljs-selector-tag">prio</span>=<span class="hljs-number">7</span> <span class="hljs-selector-tag">tid</span>=<span class="hljs-number">26</span> <span class="hljs-selector-tag">Native</span>
  | <span class="hljs-selector-tag">group</span>="<span class="hljs-selector-tag">main</span>" <span class="hljs-selector-tag">sCount</span>=<span class="hljs-number">1</span> <span class="hljs-selector-tag">dsCount</span>=<span class="hljs-number">0</span> <span class="hljs-selector-tag">flags</span>=<span class="hljs-number">1</span> <span class="hljs-selector-tag">obj</span>=<span class="hljs-number">0</span><span class="hljs-selector-tag">x130c0818</span> <span class="hljs-selector-tag">self</span>=<span class="hljs-number">0</span><span class="hljs-selector-tag">x3ffedf5f7400</span>
  | <span class="hljs-selector-tag">sysTid</span>=<span class="hljs-number">55663</span> <span class="hljs-selector-tag">nice</span>=<span class="hljs-selector-tag">-4</span> <span class="hljs-selector-tag">cgrp</span>=<span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">sched</span>=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> <span class="hljs-selector-tag">handle</span>=<span class="hljs-number">0</span><span class="hljs-selector-tag">x3ffedcf054f0</span>
  | <span class="hljs-selector-tag">state</span>=<span class="hljs-selector-tag">S</span> <span class="hljs-selector-tag">schedstat</span>=( <span class="hljs-number">31569136200</span> <span class="hljs-number">4107637200</span> <span class="hljs-number">156698</span> ) <span class="hljs-selector-tag">utm</span>=<span class="hljs-number">2105</span> <span class="hljs-selector-tag">stm</span>=<span class="hljs-number">1051</span> <span class="hljs-selector-tag">core</span>=<span class="hljs-number">9</span> <span class="hljs-selector-tag">HZ</span>=<span class="hljs-number">100</span>
  | <span class="hljs-selector-tag">stack</span>=<span class="hljs-number">0</span><span class="hljs-selector-tag">x3ffedce0a000-0x3ffedce0c000</span> <span class="hljs-selector-tag">stackSize</span>=<span class="hljs-number">1009</span><span class="hljs-selector-tag">KB</span>
  | <span class="hljs-selector-tag">held</span> <span class="hljs-selector-tag">mutexes</span>=
  <span class="hljs-selector-tag">kernel</span>: (couldn't read /proc/self/task/<span class="hljs-number">55663</span>/stack)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#00</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000006</span><span class="hljs-selector-tag">e0d8</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libc</span><span class="hljs-selector-class">.so</span> (__ioctl+<span class="hljs-number">4</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#01</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000029058</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libc</span><span class="hljs-selector-class">.so</span> (ioctl+<span class="hljs-number">136</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#02</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000004</span><span class="hljs-selector-tag">dd8</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libdrm</span><span class="hljs-selector-class">.so</span> (drmIoctl+<span class="hljs-number">28</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#03</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000004920</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libdrm_amdgpu</span><span class="hljs-selector-class">.so</span> (amdgpu_cs_query_fence_status+<span class="hljs-number">248</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#04</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">00000000002</span><span class="hljs-selector-tag">ba4cc</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">dri</span>/<span class="hljs-selector-tag">gallium_dri</span><span class="hljs-selector-class">.so</span> (amdgpu_fence_wait+<span class="hljs-number">288</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#05</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000025</span><span class="hljs-selector-tag">c8f0</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">dri</span>/<span class="hljs-selector-tag">gallium_dri</span><span class="hljs-selector-class">.so</span> (si_fence_finish+<span class="hljs-number">516</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#06</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">00000000002</span><span class="hljs-selector-tag">c7d68</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">dri</span>/<span class="hljs-selector-tag">gallium_dri</span><span class="hljs-selector-class">.so</span> (dri_flush+<span class="hljs-number">300</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#07</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000016</span><span class="hljs-selector-tag">c84</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">egl</span>/<span class="hljs-selector-tag">libGLES_mesa</span><span class="hljs-selector-class">.so</span> (droid_swap_buffers+<span class="hljs-number">192</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#08</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">00000000000149</span><span class="hljs-selector-tag">bc</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">egl</span>/<span class="hljs-selector-tag">libGLES_mesa</span><span class="hljs-selector-class">.so</span> (dri2_swap_buffers_with_damage+<span class="hljs-number">276</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#09</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000000</span><span class="hljs-selector-tag">c6a0</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">egl</span>/<span class="hljs-selector-tag">libGLES_mesa</span><span class="hljs-selector-class">.so</span> (_eglSwapBuffersWithDamageCommon+<span class="hljs-number">248</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#10</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">00000000000175</span><span class="hljs-selector-tag">f4</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libEGL</span><span class="hljs-selector-class">.so</span> (eglSwapBuffersWithDamageKHR+<span class="hljs-number">412</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#11</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000047</span><span class="hljs-selector-tag">f6d8</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libhwui</span><span class="hljs-selector-class">.so</span> (<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">renderthread</span>::<span class="hljs-attribute">EglManager</span>::<span class="hljs-built_in">swapBuffers</span>(<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">renderthread</span>::Frame const&amp;, SkRect const&amp;)+<span class="hljs-number">124</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#12</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000478</span><span class="hljs-selector-tag">cac</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libhwui</span><span class="hljs-selector-class">.so</span> (<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">skiapipeline</span>::<span class="hljs-attribute">SkiaOpenGLPipeline</span>::<span class="hljs-built_in">swapBuffers</span>(<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">renderthread</span>::Frame const&amp;, bool, SkRect const&amp;, <span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::FrameInfo*, bool*)+<span class="hljs-number">88</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#13</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000106</span><span class="hljs-selector-tag">da4</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libhwui</span><span class="hljs-selector-class">.so</span> (<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">renderthread</span>::<span class="hljs-attribute">CanvasContext</span>::<span class="hljs-built_in">draw</span>()+<span class="hljs-number">296</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#14</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000047</span><span class="hljs-selector-tag">e124</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libhwui</span><span class="hljs-selector-class">.so</span> (_ZNSt3__110__function6__funcIZN7android10uirenderer12renderthread13DrawFrameTask11postAndWaitEvE3$_0NS_9allocatorIS6_EEFvvEEclEv$c303f2d2360db58ed70a2d0ac7ed911b+<span class="hljs-number">644</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#15</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000434</span><span class="hljs-selector-tag">ab4</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libhwui</span><span class="hljs-selector-class">.so</span> (<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">WorkQueue</span>::<span class="hljs-built_in">process</span>()+<span class="hljs-number">168</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#16</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000113</span><span class="hljs-selector-tag">cd0</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libhwui</span><span class="hljs-selector-class">.so</span> (<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">renderthread</span>::<span class="hljs-attribute">RenderThread</span>::<span class="hljs-built_in">threadLoop</span>()+<span class="hljs-number">240</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#17</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000000</span><span class="hljs-selector-tag">fa8c</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libutils</span><span class="hljs-selector-class">.so</span> (<span class="hljs-attribute">android</span>::<span class="hljs-attribute">Thread</span>::<span class="hljs-built_in">_threadLoop</span>(void*)+<span class="hljs-number">280</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#18</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">00000000000818</span><span class="hljs-selector-tag">c8</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libc</span><span class="hljs-selector-class">.so</span> (<span class="hljs-built_in">__pthread_start</span>(void*)+<span class="hljs-number">36</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#19</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000023400</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libc</span><span class="hljs-selector-class">.so</span> (__start_thread+<span class="hljs-number">68</span>)
  (no managed stack frames)
</code></pre>
<p>这是 <strong>ANR的完整线程转储（Thread Dump）</strong> ，它提供了ANR发生时应用内部所有线程的详细状态。以下是关键问题的深入分析：</p>
<h2 data-id="heading-25"><strong>关键发现：</strong></h2>
<h3 data-id="heading-26"><strong>根本原因</strong></h3>
<pre><code class="hljs language-less" lang="less">"<span class="hljs-selector-tag">main</span>" <span class="hljs-selector-tag">prio</span>=<span class="hljs-number">5</span> <span class="hljs-selector-tag">tid</span>=<span class="hljs-number">1</span> <span class="hljs-selector-tag">Native</span>
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#00</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000001</span><span class="hljs-selector-tag">f02c</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libc</span><span class="hljs-selector-class">.so</span> (syscall+<span class="hljs-number">28</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#01</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000022104</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libc</span><span class="hljs-selector-class">.so</span> (__futex_wait_ex)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#02</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000080</span><span class="hljs-selector-tag">e0c</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libc</span><span class="hljs-selector-class">.so</span> (pthread_cond_wait+<span class="hljs-number">60</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#03</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000047</span><span class="hljs-selector-tag">ddfc</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libhwui</span><span class="hljs-selector-class">.so</span> (<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">renderthread</span>::<span class="hljs-attribute">DrawFrameTask</span>::<span class="hljs-built_in">postAndWait</span>()+<span class="hljs-number">260</span>)
  
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.view</span><span class="hljs-selector-class">.ThreadedRenderer</span><span class="hljs-selector-class">.nSyncAndDrawFrame</span>(Native method)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.view</span><span class="hljs-selector-class">.ThreadedRenderer</span><span class="hljs-selector-class">.draw</span>(ThreadedRenderer.<span class="hljs-attribute">java</span>:<span class="hljs-number">823</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.view</span><span class="hljs-selector-class">.ViewRootImpl</span><span class="hljs-selector-class">.draw</span>(ViewRootImpl.<span class="hljs-attribute">java</span>:<span class="hljs-number">3318</span>)
  ...
</code></pre>
<p><strong>核心问题：</strong>  主线程在等待渲染线程完成绘制（<code>DrawFrameTask::postAndWait()</code>），但渲染线程被阻塞。</p>
<h3 data-id="heading-27"><strong>2. 渲染线程（RenderThread）被阻塞</strong></h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">"RenderThread"</span> <span class="hljs-string">daemon</span> <span class="hljs-string">prio=7</span> <span class="hljs-string">tid=26</span> <span class="hljs-string">Native</span>
  <span class="hljs-attr">native:</span> <span class="hljs-comment">#00 pc 000000000006e0d8  /system/lib64/libc.so (__ioctl+4)</span>
  <span class="hljs-attr">native:</span> <span class="hljs-comment">#01 pc 0000000000029058  /system/lib64/libc.so (ioctl+136)</span>
  <span class="hljs-attr">native:</span> <span class="hljs-comment">#02 pc 0000000000004dd8  /system/vendor/lib64/libdrm.so (drmIoctl+28)</span>
  <span class="hljs-attr">native:</span> <span class="hljs-comment">#03 pc 0000000000004920  /system/vendor/lib64/libdrm_amdgpu.so (amdgpu_cs_query_fence_status+248)</span>
  <span class="hljs-string">...</span>
</code></pre>
<p><strong>关键发现：</strong>  渲染线程在等待GPU的fence状态（<code>amdgpu_cs_query_fence_status</code>），这表明<strong>GPU渲染过慢或被阻塞</strong>。</p>
<h3 data-id="heading-28"><strong>3. 多个渲染相关线程处于等待状态</strong></h3>
<p>线程ID 55553-55564 都是以<code>.carecolauncher</code>命名的线程，它们都在等待条件变量：</p>
<p>text</p>
<pre><code class="hljs language-rust" lang="rust">native: #<span class="hljs-number">03</span> pc <span class="hljs-number">000000000003</span>aa34  /system/lib64/libRS_internal.<span class="hljs-title function_ invoke__">so</span> (android::renderscript::Signal::<span class="hljs-title function_ invoke__">wait</span>()+<span class="hljs-number">84</span>)
</code></pre>
<p>这些是<strong>RenderScript计算线程</strong>，用于图形计算，它们也在等待。</p>
<h2 data-id="heading-29"><strong>问题链分析：</strong></h2>
<h3 data-id="heading-30"><strong>时间线重建：</strong></h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. TIME_TICK广播触发 → 
<span class="hljs-number">2</span>. 主线程需要更新UI（可能包括TextClock更新、日期更新等） → 
<span class="hljs-number">3</span>. 主线程调用ThreadedRenderer<span class="hljs-selector-class">.nSyncAndDrawFrame</span>() → 
<span class="hljs-number">4</span>. 主线程等待渲染线程完成绘制（<span class="hljs-built_in">postAndWait</span>()） → 
<span class="hljs-number">5</span>. 渲染线程在GPU层面被阻塞（等待fence状态） → 
<span class="hljs-number">6</span>. 多个RenderScript线程也在等待 → 
<span class="hljs-number">7</span>. 主线程等待超时（<span class="hljs-number">5</span>秒）→ 
<span class="hljs-number">8</span>. ANR发生
</code></pre>
<h3 data-id="heading-31"><strong>GPU问题的可能原因：</strong></h3>
<ol>
<li><strong>GPU过载</strong>：系统中有太多3D渲染任务</li>
<li><strong>GPU驱动程序问题</strong>：amdgpu驱动程序响应慢</li>
<li><strong>显存不足</strong>：GPU显存被占满</li>
<li><strong>渲染任务过重</strong>：需要渲染的UI内容太复杂</li>
</ol>
<h2 data-id="heading-32"><strong>根本原因：三级阻塞导致的渲染链断裂</strong></h2>
<h3 data-id="heading-33"><strong>核心问题链：</strong></h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> <span class="hljs-strong">**系统级资源枯竭**</span>（Load: 169.8）
   ↓
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**GPU驱动层阻塞**</span>（amdgpu<span class="hljs-emphasis">_cs_</span>query<span class="hljs-emphasis">_fence_</span>status）
   ↓  
<span class="hljs-bullet">3.</span> <span class="hljs-strong">**渲染线程等待**</span>（RenderThread被阻塞）
   ↓
<span class="hljs-bullet">4.</span> <span class="hljs-strong">**主线程超时**</span>（等待渲染线程完成绘制）
   ↓
<span class="hljs-bullet">5.</span> <span class="hljs-strong">**ANR发生**</span>
</code></pre>
<h3 data-id="heading-34"><strong>详细分解：</strong></h3>
<h4 data-id="heading-35"><strong>1. 根本触发点：TIME_TICK广播</strong></h4>
<ul>
<li><strong>现象</strong>：每分钟一次的TIME_TICK广播</li>
<li><strong>作用</strong>：触发Launcher的UI时间更新</li>
<li><strong>不是根本原因</strong>，只是<strong>触发器</strong></li>
</ul>
<h4 data-id="heading-36"><strong>2. 直接原因：GPU驱动层阻塞</strong></h4>
<pre><code class="hljs language-ini" lang="ini">"RenderThread" daemon <span class="hljs-attr">prio</span>=<span class="hljs-number">7</span> tid=<span class="hljs-number">26</span> Native
  native: <span class="hljs-comment">#03 pc 0000000000004920  /system/vendor/lib64/libdrm_amdgpu.so (amdgpu_cs_query_fence_status+248)</span>
</code></pre>
<ul>
<li><strong>问题</strong>：GPU驱动程序<code>amdgpu</code>在查询fence状态时阻塞</li>
<li><strong>影响</strong>：渲染线程等待GPU完成渲染命令</li>
<li><strong>本质</strong>：GPU硬件或驱动无法及时响应</li>
</ul>
<h4 data-id="heading-37"><strong>3. 传导原因：渲染线程链式阻塞</strong></h4>
<ul>
<li><strong>主线程</strong> → 调用<code>ThreadedRenderer.nSyncAndDrawFrame()</code></li>
<li><strong>主线程</strong> → 等待渲染线程完成（<code>DrawFrameTask::postAndWait()</code>）</li>
<li><strong>渲染线程</strong> → 等待GPU的fence状态</li>
<li><strong>12个RenderScript线程</strong> → 也在等待信号（<code>Signal::wait()</code>）</li>
</ul>
<h4 data-id="heading-38"><strong>4. 放大原因：系统级资源枯竭</strong></h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Load: 169.8 / 144.63 / 112.13</span>
</code></pre>
<ul>
<li><strong>系统有169个进程在等待CPU</strong></li>
<li><strong>CPU调度器无法及时调度所有进程</strong></li>
<li><strong>GPU调度也受影响</strong>（GPU调度依赖CPU）</li>
</ul>
<h4 data-id="heading-39"><strong>5. 加剧因素：应用内存访问频繁</strong></h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">faults:</span> <span class="hljs-number">8324 </span><span class="hljs-string">minor</span> <span class="hljs-number">3</span> <span class="hljs-string">major</span>
<span class="hljs-attr">Total GC time:</span> <span class="hljs-number">8.</span><span class="hljs-string">993s</span>
<span class="hljs-attr">Total GC count:</span> <span class="hljs-number">141</span>
</code></pre>
<ul>
<li><strong>频繁的内存分配和GC</strong>消耗CPU时间</li>
<li><strong>进一步加剧了CPU竞争</strong></li>
</ul>
<h3 data-id="heading-40"><strong>根本原因一句话总结：</strong></h3>
<p><strong>车机GPU驱动（amdgpu）在高系统负载（Load 169.8）下无法及时处理渲染命令，导致渲染链断裂，主线程等待渲染线程超时，最终在TIME_TICK广播触发UI更新时发生ANR。</strong></p>
<h3 data-id="heading-41"><strong>各层责任分配：</strong></h3>






























<table><thead><tr><th>层级</th><th>责任</th><th>具体问题</th></tr></thead><tbody><tr><td><strong>硬件/驱动层</strong></td><td><strong>主要责任</strong></td><td>AMD GPU驱动程序响应慢，fence查询阻塞</td></tr><tr><td><strong>系统层</strong></td><td><strong>重要责任</strong></td><td>系统负载极高（169.8），资源调度失效</td></tr><tr><td><strong>应用层</strong></td><td><strong>次要责任</strong></td><td>频繁的内存操作和GC，UI更新时机不当</td></tr><tr><td><strong>广播机制</strong></td><td><strong>触发责任</strong></td><td>TIME_TICK广播在错误的时间触发UI更新</td></tr></tbody></table>
<h2 data-id="heading-42">4.总结：</h2>




























































<table><thead><tr><th><strong>维度</strong></th><th><strong>高系统负载（Load ≈ 170）</strong></th><th><strong>使用 <code>TextClock</code></strong></th></tr></thead><tbody><tr><td><strong>性质</strong></td><td><strong>系统级环境问题</strong>（外部诱因）</td><td><strong>应用级实现问题</strong>（直接导火索）</td></tr><tr><td><strong>表现</strong></td><td><code>Load: 169.8 / 144.63 / 112.13</code> 大量进程排队，CPU/I/O 资源枯竭</td><td>布局中使用 <code>&lt;TextClock&gt;</code>，代码中持有 <code>TextClock</code> 引用</td></tr><tr><td><strong>根本机制</strong></td><td>后台进程（如 <code>gzip</code>、<code>tar_custom</code>）持续占用 CPU + I/O，导致主线程调度延迟</td><td><code>TextClock</code> 内部自动注册 <code>android.intent.action.TIME_TICK</code> 广播，每分钟在主线程响应系统广播</td></tr><tr><td><strong>是否必要条件</strong></td><td>❌ 单独存在通常不会直接导致 ANR（但会造成卡顿）</td><td>❌ 在正常系统中完全安全</td></tr><tr><td><strong>是否充分条件</strong></td><td>❌ 系统可能卡但不一定会 ANR</td><td>❌ 正常负载下无风险</td></tr><tr><td><strong>联合效应</strong></td><td>✅ <strong>两者叠加 → 主线程无法在 10 秒内处理广播 → Broadcast ANR</strong></td><td/></tr><tr><td><strong>排查方式</strong></td><td><code>adb shell cat /proc/loadavg</code> <code>adb shell top</code> 查看 ANR 日志中的 Load 和 CPU 分布</td><td>全局搜索 <code>TextClock</code> 检查布局文件是否包含 <code>&lt;TextClock&gt;</code> 确认是否在大卡片模式启用</td></tr><tr><td><strong>短期修复</strong></td><td>暂无法由应用层解决（需平台配合）</td><td>✅ <strong>替换为 <code>TextView + Handler</code> 定时更新</strong> 彻底绕过系统广播，消除 ANR 风险</td></tr><tr><td><strong>长期优化</strong></td><td>✅ 联系车机平台： - 限制 <code>tar_custom</code>/<code>gzip</code> 的 I/O 频率 - 优化后台任务调度 - 提升存储性能</td><td>✅ 移除所有隐式广播依赖，避免使用自动注册广播的系统控件（如 <code>TextClock</code>, <code>DigitalClock</code>）</td></tr><tr><td><strong>风险等级</strong></td><td>🔴 <strong>极高</strong>（影响整个系统稳定性）</td><td>🟠 <strong>中高</strong>（在高负载环境下极易触发 ANR）</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 21虚拟线程实战：7个性能翻倍的异步重构案例与避坑指南]]></title>    <link>https://juejin.cn/post/7587473691170635776</link>    <guid>https://juejin.cn/post/7587473691170635776</guid>    <pubDate>2025-12-26T00:16:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587473691170635776" data-draft-id="7587605704636203042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 21虚拟线程实战：7个性能翻倍的异步重构案例与避坑指南"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-26T00:16:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 21虚拟线程实战：7个性能翻倍的异步重构案例与避坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T00:16:42.000Z" title="Fri Dec 26 2025 00:16:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    25
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Java 21虚拟线程实战：7个性能翻倍的异步重构案例与避坑指南</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>Java 21的发布标志着并发编程的一次重大飞跃，其核心特性之一——虚拟线程（Virtual Threads）为高吞吐量应用带来了革命性的改进。虚拟线程是轻量级的用户态线程，由JVM管理而非操作系统，可以显著降低创建和切换线程的开销。本文将深入探讨如何通过虚拟线程重构传统异步代码，并结合7个真实案例展示性能提升的关键技巧。同时，我们也会揭示实践中常见的陷阱及其规避方法。</p>
<hr/>
<h3 data-id="heading-2">虚拟线程基础</h3>
<p>在深入案例之前，有必要理解虚拟线程的核心机制：</p>
<ol>
<li><strong>轻量级调度</strong>：虚拟线程由JVM调度，无需占用OS线程资源，单个JVM可支持数百万个活跃虚拟线程。</li>
<li><strong>协作式挂起</strong>：通过<code>Continuation</code>机制实现任务主动让出控制权（如I/O阻塞时），避免资源浪费。</li>
<li><strong>兼容性</strong>：基于<code>java.lang.Thread</code> API设计，现有代码只需最小修改即可迁移。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建虚拟线程的两种方式</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">virtualThread</span> <span class="hljs-operator">=</span> Thread.ofVirtual().start(() -&gt; System.out.println(<span class="hljs-string">"Hello"</span>));
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor();
</code></pre>
<hr/>
<h3 data-id="heading-3">案例解析：从传统异步到虚拟线程重构</h3>
<h4 data-id="heading-4">案例1：HTTP服务请求并行化</h4>
<p><strong>原始代码</strong>：使用<code>CompletableFuture</code>实现异步HTTP调用</p>
<pre><code class="hljs language-java" lang="java">CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; fetchData(url), executor);
</code></pre>
<p><strong>问题</strong>：依赖固定大小线程池，易出现资源耗尽或闲置。</p>
<p><strong>重构方案</strong>：每个请求分配独立虚拟线程</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {
    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> executor.submit(() -&gt; fetchData(url)).get();
}
</code></pre>
<p><strong>效果</strong>：吞吐量提升300%，延迟降低60%（实测数据）。</p>
<hr/>
<h4 data-id="heading-5">案例2：批量数据库操作优化</h4>
<p><strong>原始代码</strong>：批处理使用同步循环</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">for</span> (Query query : queries) {
    dbClient.execute(query); <span class="hljs-comment">// 阻塞调用</span>
}
</code></pre>
<p><strong>重构方案</strong>：虚拟线程+结构化并发（Java 21新特性）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructuredTaskScope</span>.ShutdownOnFailure()) {
    <span class="hljs-keyword">for</span> (Query query : queries) {
        scope.fork(() -&gt; dbClient.execute(query));
    }
    scope.join();
}
</code></pre>
<p><strong>优势</strong>：所有子任务自动生命周期管理，避免泄漏风险。</p>
<hr/>
<h4 data-id="heading-6">案例3：文件IO密集型任务</h4>
<p>原始同步代码在读取大文件时阻塞工作线程。通过<code>FileChannel</code>+虚拟线程改造：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Path</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> Path.of(<span class="hljs-string">"largefile.bin"</span>);
<span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {
    executor.submit(() -&gt; Files.readAllBytes(path)); <span class="hljs-comment">// JVM自动挂起优化</span>
}
</code></pre>
<p>实测显示CPU利用率从40%提升至75%。</p>
<hr/>
<h4 data-id="heading-7">案例4-7快速一览：</h4>



































<table><thead><tr><th>案例</th><th>原技术栈</th><th>重构方案</th><th>QPS提升</th></tr></thead><tbody><tr><td>微服务聚合</td><td>Reactive Streams</td><td>Virtual Threads + CompletableFuture</td><td>220%</td></tr><tr><td>日志异步处理</td><td>BlockingQueue</td><td>LinkedBlockingQueue + VTs</td><td>180%</td></tr><tr><td>Websocket推送</td><td>Netty EventLoop</td><td>VirtualThreadPerTaskExecutor</td><td>150%</td></tr><tr><td>CI/CD任务调度</td><td>Quartz Scheduler</td><td>Structured Concurrency</td><td>Reduce GC by 70%</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">避坑指南</h3>
<h4 data-id="heading-9">🚨 <strong>陷阱1：虚假的非阻塞调用</strong></h4>
<p>即使使用虚拟线程，若底层库（如JDBC驱动）未实现真非阻塞IO，仍会导致载体线程（Carrier Thread）阻塞。解决方案：</p>
<ul>
<li>确认驱动支持异步API（如R2DBC）</li>
<li>For CPU-bound tasks, still prefer platform threads</li>
</ul>
<h4 data-id="heading-10">🚨 <strong>陷阱2：过度创建Pin住的虚擬線程</strong></h4>
<p>某些Native操作（如JNI调用）会"pin"住虛擬線程到載體線程。监控工具推薦：</p>
<pre><code class="hljs language-bash" lang="bash">jcmd &lt;pid&gt; Thread.dump_to_file -format=json vthread_dump.json
</code></pre>
<h4 data-id="heading-11">🚨 <strong>陷阱3：忽视结构化并发的取消语义</strong></h4>
<p>未正确处理<code>ShutdownOnFailure()</code>可能导致资源泄漏：</p>
<pre><code class="hljs language-java" lang="java">scope.fork(() -&gt; {
    <span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> acquireDbConn()) { <span class="hljs-comment">// AutoCloseable必须!</span>
        <span class="hljs-keyword">return</span> query(connection);
    }
});
</code></pre>
<hr/>
<h3 data-id="heading-12">JVM调优建议</h3>
<ol>
<li><strong>载体線程数配置</strong>:
<pre><code class="hljs language-bash" lang="bash">-Djdk.virtualThreadScheduler.parallelism=CPU核心数*2 
</code></pre>
</li>
<li><strong>内存分配</strong>: Virtual threads have <del>1KB stack vs平台thread's默认</del>1MB</li>
<li><strong>监控</strong>: JDK Flight Recorder新增虛擬線程事件:
<pre><code class="hljs language-ini" lang="ini">jcmd &lt;pid&gt; JFR.start <span class="hljs-attr">settings</span>=profile filename=vthread.jfr
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-13">Conclusion</h3>
<p>Java21的虛擬線程並非銀彈(A silver bullet)，但正確使用時能將同步代碼的簡單性與異步系統的高效性完美結合。本文展示的7個重構模式覆蓋了IO密集、並行計算等典型場景——關鍵在于識別真實阻塞點並結合Structured Concurrency等新特性規避風險。展望未來隨著生態系統對虛擬線程適配完成(如Hibernate6.x已支持)，這項技術或將重塑Java服務端開發範式。</p>
<p>對於現有系統遷移建議採用漸進式策略:從邊緣服務開始驗證→核心無狀態服務→最終擴展至數據層訪問模塊(middle-out migration)。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React使用useLayoutEffect解决操作DOM页面闪烁问题]]></title>    <link>https://juejin.cn/post/7587672626757648403</link>    <guid>https://juejin.cn/post/7587672626757648403</guid>    <pubDate>2025-12-26T00:31:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587672626757648403" data-draft-id="7576470438581272602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React使用useLayoutEffect解决操作DOM页面闪烁问题"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-12-26T00:31:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React使用useLayoutEffect解决操作DOM页面闪烁问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T00:31:09.000Z" title="Fri Dec 26 2025 00:31:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">1. 概述</h2>
<p><code>useLayoutEffect</code> 是 React 中用于处理副作用的 Hook 之一，它与 <code>useEffect</code> 功能相似，但执行时机有着显著差异。<code>useLayoutEffect</code> 会在所有的 DOM 变更之后同步执行，这一特性使其特别适合用于需要基于最新 DOM 结构进行操作的场景，例如获取元素尺寸、操作 DOM 样式等，能有效避免因异步执行导致的视觉闪烁或布局抖动问题，确保页面渲染的稳定性和一致性。</p>
<h2 data-id="heading-1">2. 基本原理与语法</h2>
<p><code>useLayoutEffect</code> 的原理基于 React 的渲染机制。在 React 进行组件渲染时，会先构建虚拟 DOM，计算出需要更新的部分，然后将这些更新应用到真实 DOM 上。<code>useLayoutEffect</code> 恰好在真实 DOM 更新完成，但浏览器尚未进行绘制之前执行，这就保证了开发者可以在这个阶段安全地访问和操作最新的 DOM 结构。</p>
<p>在语法使用上，<code>useLayoutEffect</code> 需要从 <code>react</code> 库中导入，它接受一个回调函数作为参数，该回调函数中可以编写副作用逻辑。同时，<code>useLayoutEffect</code> 也支持第二个可选参数，即依赖项数组，用于控制副作用的重新执行时机。其语法示例如下：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useLayoutEffect, useState } <span class="hljs-keyword">from</span><span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">`Count is <span class="hljs-subst">${count}</span>`</span>;
  }, [count]);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;Increment<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>在上述代码中，<code>useLayoutEffect</code> 会在每次 <code>count</code> 状态发生变化，且 DOM 已更新后，立即更新页面的标题。依赖项数组 <code>[count]</code> 确保只有当 <code>count</code> 改变时，<code>useLayoutEffect</code> 的回调函数才会重新执行。</p>
<h2 data-id="heading-2">3. 应用场景</h2>
<p>下面是一些实际的应用场景：</p>
<h3 data-id="heading-3">3.1 获取元素尺寸和位置</h3>
<p>在开发图表、拖拽交互等功能时，常常需要获取元素的尺寸和位置信息。例如，在一个动态生成的柱状图组件中，每个柱子的高度需要根据数据动态计算并设置。通过 <code>useLayoutEffect</code>，可以在组件渲染完成后，立即获取容器元素的尺寸，再根据数据计算柱子高度并设置相应的样式，保证图表能够准确渲染，避免因异步计算导致的图表闪烁问题。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useLayoutEffect, useState, useRef } <span class="hljs-keyword">from</span><span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">BarChart</span>(<span class="hljs-params">{ data }</span>) {
  <span class="hljs-keyword">const</span> chartRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [barHeights, setBarHeights] = <span class="hljs-title function_">useState</span>([]);

  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (chartRef.<span class="hljs-property">current</span>) {
      <span class="hljs-keyword">const</span> containerWidth = chartRef.<span class="hljs-property">current</span>.<span class="hljs-property">offsetWidth</span>;
      <span class="hljs-keyword">const</span> newBarHeights = data.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
        <span class="hljs-comment">// 简单计算柱子高度，实际应用中更复杂</span>
        <span class="hljs-keyword">return</span> (value / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(...data)) * containerWidth;
      });
      <span class="hljs-title function_">setBarHeights</span>(newBarHeights);
    }
  }, [data]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{chartRef}</span>&gt;</span>
      {data.map((_, index) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
            <span class="hljs-attr">width:</span> '<span class="hljs-attr">20px</span>',
            <span class="hljs-attr">height:</span> `${<span class="hljs-attr">barHeights</span>[<span class="hljs-attr">index</span>]}<span class="hljs-attr">px</span>`,
            <span class="hljs-attr">backgroundColor:</span> '<span class="hljs-attr">blue</span>',
            <span class="hljs-attr">marginRight:</span> '<span class="hljs-attr">5px</span>',
            <span class="hljs-attr">display:</span> '<span class="hljs-attr">inline-block</span>'
          }}
        /&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">BarChart</span>;
</code></pre>
<h3 data-id="heading-4">3.2 强制同步更新 DOM 样式</h3>
<p>当需要根据状态变化立即更新 DOM 样式，且不希望出现视觉延迟时，<code>useLayoutEffect</code> 是最佳选择。比如在实现一个主题切换功能时，用户点击切换主题按钮后，页面的整体样式需要立即改变。利用 <code>useLayoutEffect</code>，可以在状态更新后，同步修改 DOM 的样式类名或直接设置内联样式，确保用户能即时看到主题切换效果，不会出现短暂的样式错乱。</p>
<h3 data-id="heading-5">3.3 处理浏览器事件与 DOM 交互</h3>
<p>在绑定和处理一些与 DOM 紧密相关的浏览器事件时，<code>useLayoutEffect</code> 能确保事件绑定在正确的 DOM 结构上。例如，为一个可滚动的列表添加滚动事件监听器，需要在列表渲染完成后进行绑定。使用 <code>useLayoutEffect</code> 可以在 DOM 更新后立即绑定滚动事件，并且在组件卸载时正确移除事件监听器，避免内存泄漏，保证交互功能的稳定性。</p>
<h2 data-id="heading-6">4. 与其他相关Hook的对比</h2>
<p>在 React 的 Hook 体系中，<code>useLayoutEffect</code> 与 <code>useEffect</code> 最为相似，但它们的执行时机决定了不同的应用场景。<code>useEffect</code> 会在浏览器完成绘制后异步执行，适用于不影响页面视觉效果的副作用操作，如数据请求、订阅事件等。例如，从 API 获取数据并更新组件状态，这种操作不需要即时反馈给用户，使用 <code>useEffect</code> 不会影响页面的流畅度。</p>
<p>而 <code>useLayoutEffect</code> 由于同步执行的特性，如果在其回调函数中执行复杂计算或耗时操作，可能会阻塞浏览器的渲染，导致页面卡顿。因此，在选择使用时，开发者需要根据副作用操作是否与 DOM 渲染紧密相关，以及是否对即时性有要求来决定使用 <code>useLayoutEffect</code> 还是 <code>useEffect</code>。</p>
<p>此外，<code>useLayoutEffect</code> 与 <code>useState</code>、<code>useReducer</code> 等状态管理 Hook 也有所不同。<code>useState</code> 和 <code>useReducer</code> 主要用于管理组件的状态，而 <code>useLayoutEffect</code> 专注于处理与状态变化相关的副作用，它们在 React 应用开发中承担着不同的角色，相互配合以实现丰富的功能。</p>
<h2 data-id="heading-7">5. 结合其他Hook使用</h2>
<p><code>useLayoutEffect</code> 可以与其他 Hook 灵活结合使用，以满足更复杂的需求。例如，与 <code>useRef</code> 结合可以更方便地操作 DOM 元素。在一个实现自动聚焦的输入框组件中，通过 <code>useRef</code> 获取输入框元素的引用，再利用 <code>useLayoutEffect</code> 在组件渲染完成后立即将焦点设置到输入框上，实现用户进入页面即可直接输入的效果。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useLayoutEffect, useRef } <span class="hljs-keyword">from</span><span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">AutoFocusInput</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (inputRef.<span class="hljs-property">current</span>) {
      inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();
    }
  }, []);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span> /&gt;</span></span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">AutoFocusInput</span>;
</code></pre>
<p>同时，<code>useLayoutEffect</code> 也能和 <code>useState</code> 配合，在状态更新后基于最新 DOM 进行操作。比如在一个可折叠面板组件中，当面板展开或收起的状态改变时，<code>useLayoutEffect</code> 可以在 DOM 更新后获取面板的高度等信息，用于实现过渡动画或其他交互效果。</p>
<h2 data-id="heading-8">6. 注意事项</h2>
<ul>
<li>避免在 <code>useLayoutEffect</code> 中执行长时间运行的任务或复杂计算，因为它会阻塞浏览器的渲染线程，导致页面卡顿，影响用户体验。如果有复杂计算需求，尽量将其放在 <code>useEffect</code> 或其他异步操作中进行。</li>
<li>合理使用依赖项数组，确保 <code>useLayoutEffect</code> 的回调函数在正确的时机重新执行。错误设置依赖项数组可能会导致副作用执行次数过多或过少，引发难以排查的问题。</li>
<li>由于 <code>useLayoutEffect</code> 会在 DOM 更新后立即执行，频繁触发可能会带来性能问题。在设计组件逻辑时，要尽量减少不必要的 <code>useLayoutEffect</code> 调用，或者通过优化逻辑减少其执行频率。</li>
<li>当 <code>useLayoutEffect</code> 中包含事件监听器等资源时，一定要在组件卸载时正确清理，避免内存泄漏。通常可以在 <code>useLayoutEffect</code> 返回的清理函数中移除事件监听器或取消订阅等操作。</li>
</ul>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7568192652286754870" target="_blank" title="https://juejin.cn/post/7568192652286754870">纯前端提取图片颜色插件Color-Thief教学+实战完整指南</a></li>
<li><a href="https://juejin.cn/post/7565737512816771135" target="_blank" title="https://juejin.cn/post/7565737512816771135">react-konva实战指南：Canvas高性能+易维护的组件化图形开发实现教程</a></li>
<li><a href="https://juejin.cn/post/7560905838074462271" target="_blank" title="https://juejin.cn/post/7560905838074462271">React无限滚动插件react-infinite-scroll-component的配置+优化+避坑指南</a></li>
<li><a href="https://juejin.cn/post/7560542615484137491" target="_blank" title="https://juejin.cn/post/7560542615484137491">前端音频兼容解决：音频神器howler.js从基础到进阶完整使用指南</a></li>
<li><a href="https://juejin.cn/post/7559871680015024169" target="_blank" title="https://juejin.cn/post/7559871680015024169">使用React-OAuth进行Google/GitHub登录的教程和案例</a></li>
<li><a href="https://juejin.cn/post/7550585427834404927" target="_blank" title="https://juejin.cn/post/7550585427834404927">纯前端人脸识别利器：face-api.js手把手深入解析教学</a></li>
<li><a href="https://juejin.cn/post/7553865490732433462" target="_blank" title="https://juejin.cn/post/7553865490732433462">关于React父组件调用子组件方法forwardRef的详解和案例</a></li>
<li><a href="https://juejin.cn/post/7553484874609410074" target="_blank" title="https://juejin.cn/post/7553484874609410074">React跨组件数据共享useContext详解和案例</a></li>
<li><a href="https://juejin.cn/post/7545087762837815334" target="_blank" title="https://juejin.cn/post/7545087762837815334">Web图像编辑神器tui.image-editor从基础到进阶的实战指南</a></li>
<li><a href="https://juejin.cn/post/7544323659788288046" target="_blank" title="https://juejin.cn/post/7544323659788288046">开发个人微信小程序类目选择/盈利方式/成本控制与服务器接入指南</a></li>
<li><a href="https://juejin.cn/post/7541741121400864778" target="_blank" title="https://juejin.cn/post/7541741121400864778">前端图片裁剪Cropper.js核心功能与实战技巧详解</a></li>
<li><a href="https://juejin.cn/post/7536530451461472265" target="_blank" title="https://juejin.cn/post/7536530451461472265">编辑器也有邪修？盘点VS Code邪门/有趣的扩展</a></li>
<li><a href="https://juejin.cn/post/7535005018257981466" target="_blank" title="https://juejin.cn/post/7535005018257981466">js使用IntersectionObserver实现目标元素可见度的交互</a></li>
<li><a href="https://juejin.cn/post/7534547200330121225" target="_blank" title="https://juejin.cn/post/7534547200330121225">Web前端页面开发阿拉伯语种适配指南</a></li>
<li><a href="https://juejin.cn/post/7516122409948020736" target="_blank" title="https://juejin.cn/post/7516122409948020736">让网页拥有App体验？PWA 将网页变为桌面应用的保姆级教程PWA</a></li>
<li><a href="https://juejin.cn/post/6953803916484018206" target="_blank" title="https://juejin.cn/post/6953803916484018206">使用nvm管理node.js版本以及更换npm淘宝镜像源</a></li>
<li><a href="https://juejin.cn/post/7140443283209060383" target="_blank" title="https://juejin.cn/post/7140443283209060383">手把手教你搭建规范的团队vue项目，包含commitlint，eslint，prettier，husky，commitizen等等</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[刷新后点赞全变 0？别急着怪 Redis，这八成是 Long 被 JavaScript 偷偷“改号”了（一次线上复盘）]]></title>    <link>https://juejin.cn/post/7587605704636121122</link>    <guid>https://juejin.cn/post/7587605704636121122</guid>    <pubDate>2025-12-25T16:08:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587605704636121122" data-draft-id="7587594077015523362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="刷新后点赞全变 0？别急着怪 Redis，这八成是 Long 被 JavaScript 偷偷“改号”了（一次线上复盘）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-25T16:08:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WanderInk"/> <meta itemprop="url" content="https://juejin.cn/user/4440283730679642"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            刷新后点赞全变 0？别急着怪 Redis，这八成是 Long 被 JavaScript 偷偷“改号”了（一次线上复盘）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4440283730679642/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WanderInk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T16:08:44.000Z" title="Thu Dec 25 2025 16:08:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>做社区功能的人，多半都经历过这种抓狂时刻：你在帖子上点了个赞，按钮立刻高亮，数字也加一，用户体验看起来很丝滑；可你一刷新页面，点赞数像被人清空了一样，全部回到 0。你打开 Redis 客户端看，计数 key 明明存在，值也不是 0。于是你开始怀疑缓存一致性，怀疑是不是读了另一台 Redis，怀疑线上 jar 没更新，甚至怀疑自己是不是在梦里写代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8d082f11fc24aed8b8a6685e17893ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2FuZGVySW5r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767283724&amp;x-signature=MjWhUtKbk4Bj7QcEhxY7HR0wfwU%3D" alt="ChatGPT Image 2025年12月26日 00_06_20.png" loading="lazy"/></p>
<p>我得说，这类问题最阴的地方就在于它特别像缓存问题，实际上却往往跟缓存一点关系都没有。真正的凶手是数据类型边界，准确地说，是 Java 的 long 雪花 id 进了 JavaScript 的 Number 世界以后超过安全整数范围，发生了精度丢失，导致你点赞写入用的是一个“被四舍五入后的 id”，刷新读取用的又是“真实 id”。写入和读取压根不是同一个目标，你换十台 Redis 也救不了。</p>
<p>我当时定位这个问题的切入点很朴素，不靠猜，全靠证据。把浏览器 Network 打开，盯住两处就够了：列表或者详情接口返回的帖子 id，和点赞接口请求路径里带的 id。正常情况下它们应该一模一样，哪怕多一个字符都不行。结果我看到的非常刺眼，点赞请求打的是 <code>.../posts/2003003909205840000/like</code>，列表返回的真实 id 却是 <code>2003003909205839874</code>。你看这俩数字差得不多，甚至肉眼一滑可能以为一样，但在业务上它们就是两个完全不同的帖子。更关键的是，这种“差一点点”的差法特别典型，末尾被抹平，被凑整，被改号，这是 JavaScript 精度丢失的指纹。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2c6d3124f7b4c47a57ee7cec033c9b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2FuZGVySW5r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767283724&amp;x-signature=2PaIjWrlNrAs7gFBgtxL5hH4js4%3D" alt="ChatGPT Image 2025年12月26日 00_06_50.png" loading="lazy"/></p>
<p>原因在于 JavaScript 的 Number 是双精度浮点数，安全整数上限是 2^53-1，也就是 9007199254740991。雪花 id 动辄十八十九位，早就远远超过这个范围。超过之后，JS 不是直接报错，它会用一个最接近的可表示值来存，于是你以为你拿到了 2003003909205839874，实际上它在内存里已经变成了另一个相邻但不同的数。前端把这个“变形 id”拼进 URL 发给后端，后端又是强类型世界，收到什么就当什么，于是 Redis 的 key 写成 <code>forum:like:count:1:2003003909205840000</code>，数据库里 target_id 也可能跟着写错。刷新页面时，列表接口从数据库读出真实帖子，再把真实 id 返回给前端，前端用真实 id 去查计数，当然查不到，因为计数全在另一个 id 上，于是你看到的就是“刷新后全是 0”。这不是缓存不一致，这是写错对象了，属于逻辑层面彻底错位。</p>
<p>这种坑之所以容易把人带沟里，是因为点赞当下看起来“生效”。很多实现会在点击后先做乐观更新，UI 先加一，给用户即时反馈。再加上 Redis 里确实有 key 有值，你就更容易误判成“读取链路有问题”。但只要你把写入 id 和读取 id 对齐看一眼，真相就很干净，干净得甚至有点残忍。</p>
<p>修复这类问题，我的经验是别在前端做花活，工程上最稳的路线是后端把所有 Long 统一序列化成字符串，让 id 从一开始就别进 JS 的 Number 世界。只要 JSON 里 id 带引号，前端拿到的就是 string，拼 URL 比较相等都不会丢精度。Spring Boot 里用 Jackson 做全局配置就行，把 Long 和 long 都用 ToStringSerializer 输出，类似这样：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.meme.generator.config;

<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ser.std.ToStringSerializer;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.jackson.Jackson2ObjectMapperBuilderCustomizer;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JacksonConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Jackson2ObjectMapperBuilderCustomizer <span class="hljs-title function_">longToStringCustomizer</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> builder -&gt; {
            builder.serializerByType(Long.class, ToStringSerializer.instance);
            builder.serializerByType(Long.TYPE, ToStringSerializer.instance);
        };
    }
}
</code></pre>
<p>上线之后你会很直观地看到变化，接口返回从 <code>id: 200300...</code> 变成 <code>"id":"200300..."</code>。这一步就是治本，因为你把风险源头掐掉了。前端这边也别犹豫，所有 id 一律当字符串处理，路由参数、请求参数、Map key、对比逻辑都用 string，别手贱去 Number(id)。如果你用 TypeScript，把 DTO 里的 id 类型直接写死成 string，能提前拦住一堆无意的隐式转换。</p>
<p>光把 Long 转字符串还不够，我习惯再加一道保险，防止系统继续被脏请求污染。点赞接口在真正写 Redis 和写 DB 之前，先校验 targetId 必须真实存在。原因很现实，就算你前端全修好了，也总会有人抓包乱打接口，或者旧版本前端还在外面跑，甚至某些数据链路中间又把 id 搞成了 number。你不想 Redis 和点赞表里永远躺着一堆“幽灵帖子”的点赞记录，最好的办法就是入口处把门关死，不存在的帖子或评论直接拒绝，别写入任何东西。这样系统的容错会强很多，你以后做统计、排行、消息通知也不至于被脏数据恶心。</p>
<p>修复上线以后验证也很简单，不需要写什么复杂用例。你打开 Network 看一眼列表接口响应，只要 id 带引号，基本可以确认你已经跨过了 JS 精度这个坑。如果你发现线上还是数字 id，那就别往下测了，说明你压根没部署到新版本或者配置没生效。接着随便点个赞，观察点赞请求路径里的 id 是否和列表返回完全一致，然后刷新页面看 likeCount 是否还能保持一致。如果这三件事都稳了，这个问题就可以宣布结束，属于“永不复发”那一类。</p>
<p>最后别忘了历史脏数据。这个坑一旦发生过，你 Redis 里很可能已经存在一批错误 id 的计数 key，数据库里也可能已经有 target_id 指向不存在目标的点赞记录。新版本不会再产生，但旧的如果不清理，迟早会在某个统计功能里反咬你一口。清理的思路也不复杂，本质上就是删掉所有指向不存在目标的点赞记录。举个常见场景，如果你的点赞表是 forum_like，帖子表是 forum_post，并且 target_type=1 代表帖子，你可以在确认备份和测试之后用类似的 SQL 找并删除“不存在帖子”的点赞记录：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> fl
<span class="hljs-keyword">FROM</span> forum_like fl
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> forum_post fp <span class="hljs-keyword">ON</span> fp.id <span class="hljs-operator">=</span> fl.target_id
<span class="hljs-keyword">WHERE</span> fl.target_type <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">AND</span> fp.id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;
</code></pre>
<p>Redis 清理也建议用 SCAN 去做渐进删除，别在生产上用 KEYS 图省事，Redis 这玩意你真把它阻塞了，后果比点赞错位严重多了。</p>
<p>写到这里你会发现，这次事故真正的教训其实很工程化：跨语言系统里，id 这种一旦出错就会写错对象的字段，永远不要把它当数值去传。尤其是雪花 long，在 Java 世界里再自然不过，到了 JS 世界里就是个随时可能变形的“危险品”。把 Long 输出成字符串不是洁癖，是对线上稳定性的尊重。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec3e298142b4485eaf8b4ec0c9c7bc65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2FuZGVySW5r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767283724&amp;x-signature=cCGWcOwKgJ9aM4Mw551YtDyU3hM%3D" alt="ChatGPT Image 2025年12月26日 00_07_25.png" loading="lazy"/></p>
<p>如果你现在也被“刷新后点赞全是 0”折磨着，我建议你先别急着调 Redis 和部署链路，先做一件最便宜但最有效的事：对比一下列表返回的 id 和点赞请求里的 id 是否完全一致。只要它们差一点点，你就已经抓到凶手了。把 Long 全局转字符串，再把点赞入口加上存在性校验，最后清掉历史脏数据，你会发现这个问题结束得非常干脆，甚至有点爽。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[案例+图解带你一文读懂Svg、Canvas、Css、Js动画🔥🔥（4k+字）]]></title>    <link>https://juejin.cn/post/7587811143109509171</link>    <guid>https://juejin.cn/post/7587811143109509171</guid>    <pubDate>2025-12-26T07:43:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587811143109509171" data-draft-id="7587903505134878770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="案例+图解带你一文读懂Svg、Canvas、Css、Js动画🔥🔥（4k+字）"/> <meta itemprop="keywords" content="前端,JavaScript,Canvas"/> <meta itemprop="datePublished" content="2025-12-26T07:43:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lsx_"/> <meta itemprop="url" content="https://juejin.cn/user/1442981392682829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            案例+图解带你一文读懂Svg、Canvas、Css、Js动画🔥🔥（4k+字）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442981392682829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lsx_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T07:43:15.000Z" title="Fri Dec 26 2025 07:43:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>动画在前端开发中扮演着重要的角色。它不仅可以提升用户体验，还可以使界面更加生动和有趣。在这篇文章中，我们将深入探讨前端动画的各种实现方式，包括 CSS 动画、JavaScript 动画、SVG 动画等。我们还将讨论一些触发动画的方式和动画在用户体验中的最佳实践。</p>
<h2 data-id="heading-1">前端动画分类</h2>
<ul>
<li>
<p><strong><code>CSS 动画</code></strong></p>
<ul>
<li>
<p><strong>CSS Transition</strong><br/>
CSS 过渡，属于<strong>补间动画</strong>，即设置关键帧的初始状态，然后在另一个关键帧改变这个状态，比如大小、颜色、透明度等，浏览器将自动根据二者之间帧的值创建的动画。</p>
</li>
<li>
<p><strong>CSS Animation</strong><br/>
CSS 动画，可以理解是 <code>CSS Transition</code> 的加强版，它既可以实现 <strong>补间动画</strong> 的动画效果，也可以使其以 <strong>逐帧动画</strong> 的方式进行绘制。</p>
</li>
</ul>
</li>
<li>
<p><strong><code>SVG 动画</code></strong></p>
<ul>
<li>SVG 动画用于矢量图形，提供了高质量的动画效果，常用于图标和图形动画。可以使用 SMIL 在SVG中定义动画。同样的也可以使用css或者js来控制svg动画。</li>
</ul>
</li>
<li>
<p><strong><code>Canvas 动画</code></strong></p>
<ul>
<li>
<p>通过结合使用 <code>requestAnimationFrame</code>、路径和变换等技术对画布的元素进行擦除和重新绘制，可以实现复杂的动画效果。另外Canvas还可以用于绘制复杂的背景或静态内容，从而减少每帧的绘制工作量。</p>
</li>
<li>
<p>可以参考我的一篇关于canvas制作动画的文章：<a href="https://juejin.cn/post/7389211334641270793" target="_blank" title="https://juejin.cn/post/7389211334641270793">用Canvas绘制一个高可配置的圆形进度条</a></p>
</li>
</ul>
</li>
<li>
<p><strong><code>JS 动画</code></strong></p>
<ul>
<li>
<p><strong>setTimeout</strong> / <strong>setInterval</strong> / <strong>requestAnimationFrame</strong><br/>
<code>setTimeout</code> 和 <code>setInterval</code> 这两个 API 设定的时间会因为浏览器当前工作负载而有所偏差，而且无法与浏览器的绘制帧保持同步。所以才有了 <strong>与浏览器的绘制帧同步</strong> 的原生 API <code>requestAnimationFrame</code>，以取代 <code>setTimeout</code> 和 <code>setInterval</code> 实现动画。</p>
</li>
<li>
<p><strong>Web Animations API</strong><br/>
浏览器动画 API，通过 JavaScript 操作。这些 API 被设计成 <code>CSS Transition</code> 和 <code>CSS Animation</code> 的接口，很容易通过 JS 的方式实现 CSS 动画，它是对动画化的支持最有效的方式之一。</p>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2">css 动画</h2>
<h3 data-id="heading-3">css过渡动画 <code>transition</code></h3>
<h4 data-id="heading-4">注意</h4>
<p>由于浏览器是根据样式差异化的两帧自动计算并过渡，所以 <code>transition</code> 只支持可识别中间值的属性 (如大小、颜色、位置、透明度等)，而如 display 属性则不支持。</p>
<h4 data-id="heading-5">语法定义</h4>
<ul>
<li>
<p><code>transition-property</code>： 指定哪个或哪些 CSS 属性用于过渡。只有指定的属性才会在过渡中发生动画，其他属性仍如通常那样瞬间变化。</p>
</li>
<li>
<p><code>transition-duration</code>： 指定过渡的时长。你可以为所有属性指定一个值，或者指定多个值，或者为每个属性指定不同的时长。</p>
</li>
<li>
<p><code>transition-timing-function</code>： 指定一个缓动函数，定义属性值怎么变化。常见的缓动函数是一个三次贝塞尔曲线 ( <code>cubic-bezier(&lt;x1&gt;, &lt;y1&gt;, &lt;x2&gt;, &lt;y2&gt;)</code> )。当然也可以选择关键字</p>
<ul>
<li><strong>linear</strong>：<code>cubic-bezier(0.0, 0.0, 1.0, 1.0)</code></li>
<li><strong>ease</strong>：<code>cubic-bezier(0.25, 0.1, 0.25, 1.0)</code></li>
<li><strong>ease-in</strong>：<code>cubic-bezier(0.42, 0.0, 1.0, 1.0)</code></li>
<li><strong>ease-out</strong>：<code>cubic-bezier(0.0, 0.0, 0.58, 1.0)</code></li>
<li><strong>ease-in-out</strong>：<code>cubic-bezier(0.42, 0.0, 0.58, 1.0)</code></li>
</ul>
</li>
<li>
<p><code>transition-delay</code>： 指定延迟，即属性开始变化时与过渡开始发生时之间的时长。</p>
</li>
</ul>
<h4 data-id="heading-6">代码示例</h4>
<pre><code class="hljs language-css" lang="css">  <span class="hljs-comment">/* 单条 简写形式 */</span>
  <span class="hljs-attribute">transition</span>: 
    &lt;property&gt; &lt;duration&gt; &lt;timing-function&gt; &lt;delay&gt;;
  
  
  <span class="hljs-comment">/* 多条 简写形式 */</span>
  <span class="hljs-attribute">transition</span>: 
    &lt;property&gt; &lt;duration&gt; &lt;timing-function&gt; &lt;delay&gt;,
    &lt;property&gt; &lt;duration&gt; &lt;timing-function&gt; &lt;delay&gt;,
    ...;


  <span class="hljs-comment">/* 单条 子属性形式 */</span>
  <span class="hljs-attribute">transition-property</span>: &lt;property-name&gt;;
  <span class="hljs-attribute">transition-duration</span>: &lt;duration-time&gt;;
  <span class="hljs-attribute">transition-timing-function</span>: &lt;timing-function&gt;;
  <span class="hljs-attribute">transition-delay</span>: &lt;duration-time&gt;;
  
  
  <span class="hljs-comment">/* 多条 子属性形式 */</span>
  <span class="hljs-attribute">transition-property</span>: &lt;property-name&gt; [, &lt;property-name&gt;, ...];
  <span class="hljs-attribute">transition-duration</span>: &lt;duration-time&gt; [, &lt;duration-time&gt;, ...];
  <span class="hljs-attribute">transition-timing-function</span>: [, &lt;cubic-bezier&gt;, ...];
  <span class="hljs-attribute">transition-delay</span>: [, &lt;duration-time&gt;, ...];
  
  
  // 如果任意属性值列表的长度比其他属性值列表要短，则其中的值会重复使用以便匹配
  
  // 如果某个属性的值列表长于 `<span class="hljs-attribute">transition-property</span>` 的属性，则将被截短
  

</code></pre>
<h4 data-id="heading-7">css过渡动画 触发方式</h4>
<h5 data-id="heading-8">1. 伪类触发（:hover、:focus、:active等）</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background-color</span>: blue;
  <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-selector-class">.button</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">background-color</span>: red;
}

</code></pre>
<h5 data-id="heading-9">2. 类名切换（通过JS动态切换类名来触发过渡效果）</h5>
<pre><code class="hljs language-js" lang="js">&lt;button id=<span class="hljs-string">"toggleButton"</span>&gt;<span class="hljs-title class_">Toggle</span>&lt;/button&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"box"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.box</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">background-color</span>: blue;
    <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">0.3s</span> ease;
  }

  <span class="hljs-selector-class">.box</span><span class="hljs-selector-class">.active</span> {
    <span class="hljs-attribute">background-color</span>: red;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'toggleButton'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'box'</span>).<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">'active'</span>);
  });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

</code></pre>
<h5 data-id="heading-10">3. 属性变化</h5>
<pre><code class="hljs language-js" lang="js">&lt;button id=<span class="hljs-string">"toggleButton"</span>&gt;<span class="hljs-title class_">Toggle</span>&lt;/button&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"box"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.box</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">background-color</span>: blue;
    <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">0.3s</span> ease;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'toggleButton'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> box = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'box'</span>);
    box.<span class="hljs-property">style</span>.<span class="hljs-property">backgroundColor</span> = box.<span class="hljs-property">style</span>.<span class="hljs-property">backgroundColor</span> === <span class="hljs-string">'red'</span> ? <span class="hljs-string">'blue'</span> : <span class="hljs-string">'red'</span>;
  });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

</code></pre>
<h5 data-id="heading-11">4. 伪元素触发（通过伪元素如<code>::before</code>、<code>::after</code>的状态变化来触发过渡效果。）</h5>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> class="box"&gt;&lt;/<span class="hljs-selector-tag">div</span>&gt;

&lt;style&gt;
  <span class="hljs-selector-class">.box</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">position</span>: relative;
  }

  <span class="hljs-selector-class">.box</span><span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">''</span>;
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">background-color</span>: blue;
    <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">0.3s</span> ease;
  }

  <span class="hljs-selector-class">.box</span><span class="hljs-selector-pseudo">:hover</span><span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">background-color</span>: red;
  }
&lt;/style&gt;

</code></pre>
<h3 data-id="heading-12">css动画 <code>animation</code></h3>
<h4 data-id="heading-13">注意</h4>
<p>CSS Animation 具备了对 <strong>关键帧和循环次数</strong> 的自定义能力。CSS Animation 在实现像 CSS Transition <strong>补间动画</strong> 效果时，还可以在起始帧和结束帧之间自定义中间帧，使得动画更加平滑过渡的同时，对动画有了更好的控制和自定义能力。</p>
<h4 data-id="heading-14">语法定义</h4>
<p>先创建一个带名称的 <code>@keyframes</code> 规则，以便后续使用 <code>animation-name</code> 属性将动画同其关键帧声明进行匹配。每个规则包含多个关键帧，也就是一段样式块语句，每个关键帧有一个百分比值作为名称，代表在动画进行中，在哪个阶段触发这个帧所包含的样式。</p>
<ul>
<li>
<p><code>animation-name</code>：指定一个或多个 @keyframes 的名称，描述了要应用于元素的动画。多个 @keyframes 以逗号分隔。</p>
</li>
<li>
<p><code>animation-duration</code>：设置动画完成一个动画周期所需的时间，需要指定单位，如 <code>1s</code>、<code>500ms</code>。</p>
</li>
<li>
<p><code>animation-delay</code>：指定执行动画之前的等待时间。动画可以稍后开始、立即从开头开始、立即在动画中途播放 <strong>(如 <code>-1s</code>)</strong> 。其中 <code>-1s</code> 意思是动画立即从 1s 处开始。</p>
</li>
<li>
<p><code>animation-iteration-count</code>：设置动画序列在停止前应播放的次数，有效值 <code>0</code>、正整数、正小数、无限循环 <code>infinite</code>。</p>
</li>
<li>
<p><code>animation-direction</code>：设置动画是正向播放 <code>normal</code>、反向播放 <code>reverse</code>、正向交替播放 <code>alternate</code>、反向交替播放 <code>alternate-reverse</code>。</p>
</li>
<li>
<p><code>animation-play-state</code>：设置动画是运行还是暂停，有效值 <code>running</code>、<code>paused</code>。</p>
</li>
<li>
<p><code>animation-fill-mode</code>：设置 CSS 动画在执行之前和之后如何将样式应用于其目标，有效值如下：</p>
<ul>
<li><code>none</code>：当动画未执行时，动画将不会将任何样式应用于目标，而是已经赋予给该元素的 CSS 规则来显示该元素。这是默认值</li>
<li><code>forwards</code>：目标将保留由执行期间遇到的最后一个关键帧计算值。</li>
<li><code>backwards</code>：动画将在应用于目标时立即应用第一个关键帧中定义的值。
<code>animation-timing-function</code>：设置动画在每个周期的持续时间内如何进行，主要是如下两种函数：</li>
</ul>
</li>
<li>
<p><code>cubic-bezier</code> 三次贝塞尔曲线 ( <code>cubic-bezier(&lt;x1&gt;, &lt;y1&gt;, &lt;x2&gt;, &lt;y2&gt;)</code> )，以实现 <strong>补间动画</strong> 效果。</p>
</li>
<li>
<p><code>steps</code> 是一个分段的阶跃函数，，以实现 <strong>逐帧动画</strong>。n 相当于单次动画的帧数，每帧动画的时间是均等的 (<code>steps(n, &lt;jumpterm&gt;)</code>)，其中 <code>jumpterm (默认值 end)</code> 含义如下：</p>
<ol>
<li>jump-start：在起始位置阶跃，<code>n=2 ⇒ 50% 100%; (100 / 2)</code></li>
<li>jump-end：在结束位置阶跃, <code>n=4 ⇒ 0% 25% 50% 75%; (100 / 4)</code></li>
<li>jump-none：起止位置均无跳跃，<code>n=5 ⇒ 0% 25% 50% 75% 100%; (100 / 4)</code></li>
<li>jump-both：起止位置均有跳跃 <code>n=3 ⇒ 25% 50% 75%; (100 / 4)</code></li>
<li>start：等同 jump-start</li>
<li>end：等同 jump-end</li>
<li>step-start：等同 steps(1, jump-start)</li>
<li>step-end：等同 steps(1, jump-end)</li>
</ol>
</li>
</ul>
<pre><code class="hljs language-css" lang="css">  <span class="hljs-comment">/* animation 声明样式顺序 */</span> 
  <span class="hljs-comment">/* animation-duration */</span>
  <span class="hljs-comment">/* animation-easing-function */</span>
  <span class="hljs-comment">/* animation-delay */</span> 
  <span class="hljs-comment">/* animation-iteration-count */</span>
  <span class="hljs-comment">/* animation-direction */</span>
  <span class="hljs-comment">/* animation-fill-mode */</span>
  <span class="hljs-comment">/* animation-play-state */</span>
  <span class="hljs-comment">/* animation-name */</span>
  <span class="hljs-attribute">animation</span>: <span class="hljs-number">3s</span> ease-in <span class="hljs-number">1s</span> <span class="hljs-number">2</span> reverse both paused slidein; 

  
  <span class="hljs-comment">/* animation - duration | easing-function | delay | name */</span>
  <span class="hljs-attribute">animation</span>: <span class="hljs-number">3s</span> linear <span class="hljs-number">1s</span> slidein;
  
  
  <span class="hljs-comment">/* more animations - duration | easing-function | delay | name */</span>
  <span class="hljs-attribute">animation</span>: <span class="hljs-number">3s</span> linear slidein, <span class="hljs-number">3s</span> ease-out <span class="hljs-number">5s</span> slideout;

 
  <span class="hljs-comment">/* animation-name */</span>
  <span class="hljs-attribute">animation-name</span>: none;
  <span class="hljs-attribute">animation-name</span>: animate1;
  <span class="hljs-attribute">animation-name</span>: animate1, animate2;
  
  
  <span class="hljs-comment">/* animation-timing-function */</span>
  <span class="hljs-attribute">animation-timing-function</span>: ease;
  <span class="hljs-attribute">animation-timing-function</span>: step-start;
  <span class="hljs-attribute">animation-timing-function</span>: <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.1</span>);
  <span class="hljs-attribute">animation-timing-function</span>: ease, step-start, <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.1</span>);
  

</code></pre>
<h4 data-id="heading-15">css animation 动画触发方式</h4>
<p>和css <code>transition</code> 触发动画方式相似</p>
<p><strong>此外还可以增加一个图层，专门用于制作动画效果。</strong></p>
<p>例如：鼠标在点击按钮时，会有涟漪动画。</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-comment">// 涟漪动画定义</span>
@keyframes ripple {
  <span class="hljs-number">0</span>% {
    <span class="hljs-attr">transform</span>: <span class="hljs-title function_">scale</span>(<span class="hljs-number">0</span>);
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">1</span>;
  }

  to {
    <span class="hljs-attr">transform</span>: <span class="hljs-title function_">scale</span>(<span class="hljs-number">4</span>);
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span>;
  }
}

<span class="hljs-comment">// 图层动画 css</span>
.<span class="hljs-property">ripple</span> {
  <span class="hljs-attr">position</span>: absolute;
  border-<span class="hljs-attr">radius</span>: <span class="hljs-number">50</span>%;
  <span class="hljs-attr">background</span>: <span class="hljs-title function_">rgba</span>(<span class="hljs-number">8</span>, <span class="hljs-number">7</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0.2</span>);
  pointer-<span class="hljs-attr">events</span>: none;

  <span class="hljs-attr">animation</span>: ripple <span class="hljs-number">0.</span>6s linear;
}

<span class="hljs-comment">// 制作动画  这样每次点击按钮 就会生成动画，动画结束便销毁动画元素</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">makeAnimate</span> = (<span class="hljs-params">e: React.MouseEvent</span>) =&gt; {
  <span class="hljs-keyword">const</span> dom = e.<span class="hljs-property">currentTarget</span>;
  <span class="hljs-keyword">const</span> rect = dom.<span class="hljs-title function_">getBoundingClientRect</span>();
  <span class="hljs-keyword">const</span> x = e.<span class="hljs-property">clientX</span> - rect.<span class="hljs-property">left</span>;
  <span class="hljs-keyword">const</span> y = e.<span class="hljs-property">clientY</span> - rect.<span class="hljs-property">top</span>;
  <span class="hljs-keyword">const</span> size = <span class="hljs-number">100</span>;

  <span class="hljs-keyword">const</span> ripple = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'span'</span>);
  ripple.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'ripple'</span>);
  ripple.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">`<span class="hljs-subst">${size}</span>px`</span>;
  ripple.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${size}</span>px`</span>;
  ripple.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">`<span class="hljs-subst">${x - size / <span class="hljs-number">2</span>}</span>px`</span>;
  ripple.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${y - size / <span class="hljs-number">2</span>}</span>px`</span>;
  dom.<span class="hljs-title function_">appendChild</span>(ripple);

  ripple.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'animationend'</span>, <span class="hljs-function">() =&gt;</span> {
    ripple.<span class="hljs-title function_">remove</span>();
  });
};


</code></pre>
<h2 data-id="heading-16">svg 动画</h2>
<h3 data-id="heading-17">常用的 SMIL 动画元素</h3>
<ul>
<li><code>&lt;animate&gt;</code>：用于动画化单个属性。</li>
<li><code>&lt;animateTransform&gt;</code>：用于动画化变换属性，如旋转、缩放、平移等。</li>
<li><code>&lt;animateMotion&gt;</code>：用于沿着路径动画化元素。（路径动画）</li>
<li><code>&lt;set&gt;</code>：用于在指定时间点设置属性值。</li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;svg width=<span class="hljs-string">"100"</span> height=<span class="hljs-string">"100"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">circle</span> <span class="hljs-attr">cx</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">cy</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">r</span>=<span class="hljs-string">"40"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"red"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">animate</span> <span class="hljs-attr">attributeName</span>=<span class="hljs-string">"cx"</span> <span class="hljs-attr">from</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"150"</span> <span class="hljs-attr">dur</span>=<span class="hljs-string">"2s"</span> <span class="hljs-attr">repeatCount</span>=<span class="hljs-string">"indefinite"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">circle</span>&gt;</span></span>
&lt;/svg&gt;

</code></pre>
<h3 data-id="heading-18">svg 描边动画</h3>
<p>SVG动画的路径实现主要依赖属性：<code>stroke</code>（描边）和 <code>fill</code>（填充）。</p>
<ul>
<li><strong>stroke</strong>：定义svg的轮廓线。常用css属性有： <code>stroke-dasharray</code>（描边的样式），<code>stroke-dashoffset</code>（起始位置），<code>stroke-color</code>（描边的颜色），<code>stroke-opacity</code>（描边的透明度），<code>stroke-linecap</code>（描边端点形状）等。</li>
<li><strong>fill</strong>：定义svg内部颜色或图案 ，常用css属性有<code>fill-opacity</code>(定义填充的透明度), <code>fill-rule</code>(定义填充规则)等。</li>
</ul>
<h4 data-id="heading-19">stroke-dasharray （定义虚线的长度和间隔）</h4>
<p>提供一个奇数或偶数数列，其中数与数之间用逗号或空格隔开，用来指定短划线和缺口的长度，并重复。 如果是<code>偶数数列</code>，则一个表示短线长度，一个表示缺口长度。 如果是<code>奇数数列</code>，将奇数数列复制一个变成偶数数列，然后按照短线，缺口的顺序绘制。</p>
<p>(偶数数列) <code>stroke-dasharray="5, 5" x1="10" y1="10" x2="190" y2="10"</code>表示从坐标（10,10）到(200,10)这条水平线上，短划线和缺口都为5个px</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3298ea28b93c4d6b9a6693bbe89e2984~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHN4Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339795&amp;x-signature=u0p86ISTMyua61kJghaqrnV%2F23Y%3D" alt="image.png" loading="lazy"/></p>
<p>（奇数数列） <code>stroke-dasharray="20 10 5" x1="10" y1="10" x2="190" y2="10"</code>表示从坐标（10,10）到(200,10)这条水平线上，短划线和缺口按照20 10 5 20 10 5的顺序排列。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f644bfba2884206af13d69046a6c4b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHN4Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339795&amp;x-signature=mGga%2Be5%2BvHL5XTFGp%2FJXaFN%2BJhY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-20">stroke-dashoffset （定义虚线的起始位置）</h4>
<p>stroke-dashoffset 属性用于指定路径开始的距离(正值向左偏移，负值向右偏移)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b04bccdcff294be89efd61b13026531c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHN4Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339795&amp;x-signature=JQOha66p%2BXZULeeSTsOPFCUBhDU%3D" alt="image.png" loading="lazy"/></p>
<p>描边动画示例：</p>
<p><a href="https://code.juejin.cn/pen/7391734513644077082" target="_blank" title="https://code.juejin.cn/pen/7391734513644077082">code.juejin.cn/pen/7391734…</a></p>
<h2 data-id="heading-21">js 动画</h2>
<h3 data-id="heading-22">setTimeout / setInterval API</h3>
<p>设定定时器，通过周期性的触发重复执行绘制动画的函数，来实现 “逐帧动画” 的效果。</p>
<ul>
<li>
<p>优势</p>
<ol>
<li>具有很好的浏览器兼容性</li>
</ol>
</li>
<li>
<p>劣势</p>
<ol>
<li>只能接近设备屏幕刷新率，无法做到和浏览器同步，所以可能会存在卡顿、丢帧、抖动的现象</li>
<li>由于浏览器单线程机制，存在队列中回调函数被阻塞的可能，所以无法保证每一次调用的时间间隔都相同，某次回调可能会被跳过，导致跳帧。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-23">requestAnimationFrame API</h3>
<p>为了弥补 <code>setTimeout / setInterval</code> 在动画方面的不足，浏览器提供了为动画而生的 API，它可以让 DOM 动画、Canvas 动画、 SVG 动画等有一个统一的刷新机制，随着浏览器的屏幕刷新，统一绘制动画帧。</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-keyword">let</span> id = <span class="hljs-literal">null</span>
  
  <span class="hljs-comment">// 动画函数</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">draw</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">/* 动画绘制... */</span>
  }
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">start</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">draw</span>()
    <span class="hljs-title function_">cancelAnimationFrame</span>(id)
    id = <span class="hljs-title function_">requestAnimationFrame</span>(start)
  }
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">stop</span> = (<span class="hljs-params"/>) =&gt; { <span class="hljs-title function_">cancelAnimationFrame</span>(id) }
  
</code></pre>
<ul>
<li>
<p>优势</p>
<ol>
<li>由系统来决定回调函数的执行时机, 它能保证回调函数在屏幕每一次的刷新间隔中只被执行一次, 这样就不会引起丢帧现象, 也不会导致动画出现卡顿的问题。</li>
<li>在运行时浏览器会自动优化方法的调用，并且如果页面不是激活状态下的话，动画会自动暂停，有效节省了CPU的开销。</li>
</ol>
</li>
<li>
<p>不足</p>
<ol>
<li>同 setTimeout/setInterval 一样，它是以逐帧动画的方式进行绘制，无法做到像 CSS 动画，让游览器自动根据两帧之间的差异创建插值，以实现补间动画的过渡效果。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-24">Web Animations API</h3>
<ol>
<li><code>requestAnimationFrame</code>、<code>setTimeout/setInterval</code> 都是以逐帧绘制的方式实现动画， 而 <strong>Animations API</strong> 不仅可以 “逐帧动画”，还可以实现 “补间动画” 的效果。</li>
<li>CSS 动画有一定的局限性，需要事先预设动画样式，而且无法与 JS 进行交互。相比之下，<strong>Animations API</strong> 可以随时定义并使用动画，自然是更加灵活方便。</li>
</ol>
<p>参考文档： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWeb_Animations_API" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Animations_API" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></p>
<p>语法示例：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"container"</span>);

  <span class="hljs-keyword">const</span> animation = element.<span class="hljs-title function_">animate</span>(
    [
      { <span class="hljs-attr">transform</span>: <span class="hljs-string">"translateY(0%)"</span> },
      { <span class="hljs-attr">transform</span>: <span class="hljs-string">"translateY(100%)"</span> },
    ],
    { <span class="hljs-attr">duration</span>: <span class="hljs-number">3000</span>, <span class="hljs-attr">fill</span>: <span class="hljs-string">"forwards"</span> }
  );
  

</code></pre>
<p>代码示例：</p>
<p><a href="https://code.juejin.cn/pen/7391799461493932069" target="_blank" title="https://code.juejin.cn/pen/7391799461493932069">code.juejin.cn/pen/7391799…</a></p>
<h4 data-id="heading-25">关于Flip动画</h4>
<p>浏览器计算位置很快，绘制可能很慢。利用浏览器强大的计算能力，获取动画的起止状态，接着单独开启一个线程做动画。这样触发布局更新的操作，只会发生在一帧时间内，剩下的动画跑在单独的线程上，会更流畅。</p>
<p>介绍下FLIP 。</p>
<ol>
<li>F 代表 First，也就是动画的开始状态。</li>
<li>L 代表 Last，代表动画结束状态。</li>
<li>I 代表 Invert，也就是状态反转，使用 transform 等属性，创建单独的图层，并将元素状态反转回去。</li>
<li>P 代表 Play，播放动画。</li>
</ol>
<p>示例代码：</p>
<p>其中，在初始帧中，应用逆变换（<code>translate</code> 和 <code>scale</code>），将元素从其最终状态逆变换到初始状态。</p>
<p>最后一帧 <code>transform: "none"</code> 的作用是将元素的变换属性重置为其最终状态。具体来说，<code>transform: "none"</code> 表示不应用任何变换，这意味着元素将恢复到由 CSS 设置的最终位置和大小。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>FLIP Animation Example<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-id">#box</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#4caf50</span>;
      <span class="hljs-attribute">position</span>: absolute;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"animateButton"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-top: 300px;"</span>&gt;</span>Animate<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> box = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'box'</span>);
    <span class="hljs-keyword">const</span> button = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'animateButton'</span>);

    button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// First: 记录初始状态</span>
      <span class="hljs-keyword">const</span> first = box.<span class="hljs-title function_">getBoundingClientRect</span>();

      <span class="hljs-comment">// 修改元素的位置</span>
      box.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-number">300</span>}</span>px`</span>;
      box.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-number">300</span>}</span>px`</span>;

      <span class="hljs-comment">// Last: 记录最终状态</span>
      <span class="hljs-keyword">const</span> last = box.<span class="hljs-title function_">getBoundingClientRect</span>();

      <span class="hljs-comment">// Invert: 计算初始状态和最终状态之间的变换</span>
      <span class="hljs-keyword">const</span> deltaX = first.<span class="hljs-property">left</span> - last.<span class="hljs-property">left</span>;
      <span class="hljs-keyword">const</span> deltaY = first.<span class="hljs-property">top</span> - last.<span class="hljs-property">top</span>;
      <span class="hljs-keyword">const</span> deltaW = first.<span class="hljs-property">width</span> / last.<span class="hljs-property">width</span>;
      <span class="hljs-keyword">const</span> deltaH = first.<span class="hljs-property">height</span> / last.<span class="hljs-property">height</span>;


      <span class="hljs-comment">// 应用 FLIP 动画</span>
      box.<span class="hljs-title function_">animate</span>(
        [
          {
            <span class="hljs-attr">transformOrigin</span>: <span class="hljs-string">"top left"</span>,
            <span class="hljs-attr">transform</span>: <span class="hljs-string">`
            translate(<span class="hljs-subst">${deltaX}</span>px, <span class="hljs-subst">${deltaY}</span>px)
            scale(<span class="hljs-subst">${deltaW}</span>, <span class="hljs-subst">${deltaH}</span>)`</span>,
          },
          {
            <span class="hljs-attr">transformOrigin</span>: <span class="hljs-string">"top left"</span>,
            <span class="hljs-attr">transform</span>: <span class="hljs-string">"none"</span>,
          },
        ],
        {
          <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span>,
          <span class="hljs-attr">easing</span>: <span class="hljs-string">"ease-in-out"</span>,
          <span class="hljs-attr">fill</span>: <span class="hljs-string">"both"</span>,
        }
      );
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RUM 赋能 iOS App 稳定：从异常体系到监控方案的全方位解析！]]></title>    <link>https://juejin.cn/post/7587961565475815478</link>    <guid>https://juejin.cn/post/7587961565475815478</guid>    <pubDate>2025-12-26T06:14:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587961565475815478" data-draft-id="7587582213060755510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RUM 赋能 iOS App 稳定：从异常体系到监控方案的全方位解析！"/> <meta itemprop="keywords" content="云原生,iOS"/> <meta itemprop="datePublished" content="2025-12-26T06:14:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RUM 赋能 iOS App 稳定：从异常体系到监控方案的全方位解析！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:14:41.000Z" title="Fri Dec 26 2025 06:14:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：高玉龙（元泊）</p>
<h2 data-id="heading-0">背景介绍</h2>
<p>App 上线后，作为开发同学，最怕出现的情况就是应用崩溃了。但是，线下测试好好的 App，为什么上线后就发生崩溃了呢？这些崩溃日志信息是怎么采集的？</p>
<p>先看看几个常见的编写代码时的疏忽，是如何让应用崩溃的。</p>
<ul>
<li>数组越界：在取数据索引时越界，App 会发生崩溃。</li>
<li>多线程问题：在子线程中进行 UI 更新可能会发生崩溃。多个线程进行数据的读取操作，因为处理时机不一致，比如有一个线程在置空数据的同时另一个线程在读取这个数据，可能会出现崩溃情况。</li>
<li>主线程无响应：如果主线程超过系统规定的时间无响应，就会被 Watchdog 杀掉。</li>
<li>野指针：指针指向一个已删除的对象访问内存区域时，会出现野指针崩溃。</li>
</ul>
<p>为了解决这个问题，阿里云可观测研发团队进行了一些 iOS 异常监控方向的探索。</p>
<h2 data-id="heading-1">iOS 异常体系介绍</h2>
<p>iOS 异常体系采用分层架构，从底层硬件到上层应用，异常在不同层次被捕获和处理。理解异常体系的分层结构，有助于我们更好地设计和实现异常监控方案。iOS 异常体系主要分为以下几个层次：</p>
<p><strong>1. 硬件层异常</strong></p>
<ul>
<li>CPU 异常：由硬件直接产生的异常，如非法指令、内存访问错误等</li>
<li>这是最底层的异常来源，所有其他异常最终都源于此</li>
</ul>
<p><strong>2. 系统层异常</strong></p>
<ul>
<li><strong>Mach 异常：</strong> macOS/iOS 系统最底层的异常机制，源于 Mach 微内核架构</li>
<li><strong>Unix 信号：</strong> Mach 异常会被转换为 Unix 信号，如 SIGSEGV、SIGABRT 等</li>
<li>系统层异常是应用层异常监控的主要捕获点</li>
</ul>
<p><strong>3. 运行时层异常</strong></p>
<ul>
<li><strong>NSException：</strong> Objective-C 运行时异常，如数组越界、空指针等</li>
<li><strong>C++ 异常：</strong> C++ 代码抛出的异常，通过 <code>std::terminate()</code> 处理</li>
<li>运行时层异常通常由编程错误引起</li>
</ul>
<p><strong>4. 应用层异常</strong></p>
<ul>
<li>业务逻辑异常：应用自定义的异常和错误</li>
<li>性能异常：主线程死锁、内存泄漏等</li>
<li>僵尸对象访问：访问已释放对象导致的异常</li>
</ul>
<p>异常体系的分层关系如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76b1aebf9fbb4fadbaa11904a79b8ebe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=zzyK08sey2WdbpWl7zaCE3NfFdI%3D" alt="图片" loading="lazy"/></p>
<p><strong>异常捕获的层次关系：</strong></p>
<ol>
<li><strong>硬件异常 → Mach 异常：</strong> CPU 异常被 Mach 内核捕获，转换为 Mach 异常消息</li>
<li><strong>Mach 异常 → Unix 信号：</strong> Mach 异常处理机制会将异常转换为对应的 Unix 信号</li>
<li><strong>运行时异常：</strong> NSException 和 C++ 异常在运行时层被捕获，如果未处理会触发系统层异常</li>
<li><strong>应用层异常：</strong> 业务异常和性能问题需要应用层主动监控和检测</li>
</ol>
<p>异常监控策略：</p>
<ul>
<li><strong>系统层监控：</strong> 通过 Mach 异常和 Unix 信号捕获，可以捕获所有底层异常</li>
<li><strong>运行时层监控：</strong> 通过设置异常处理器（NSUncaughtExceptionHandler、terminate handler）捕获运行时异常</li>
<li><strong>应用层监控：</strong> 通过主动检测机制（死锁检测、僵尸对象检测）发现潜在问题</li>
</ul>
<p>理解这个分层体系，有助于我们：</p>
<ul>
<li>选择合适的异常捕获机制</li>
<li>理解不同异常类型的来源和处理方式</li>
<li>设计完整的异常监控方案</li>
</ul>
<h2 data-id="heading-2">主流异常监控方案</h2>
<p>在 iOS 端侧异常监控领域，PLCrashReporter 与 KSCrash 是最常用的两个内核库。两者都是开源、生产可用，且被多家平台化产品或 SDK 采用作为底层能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f29cd5dfb83449980eb292e7409ed2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=nhC8P4pByPRX5VXdRbIYWE%2BUw6Q%3D" alt="图片" loading="lazy"/></p>
<p>基于以上对比分析，KSCrash 相比其他崩溃监控框架的核心优势在于：</p>
<ul>
<li>异常类型监测支持更全面（唯一同时支持 C++ 异常、死锁检测、僵尸对象检测的开源框架）</li>
<li>异步安全设计（崩溃处理完全异步安全，双重异常处理线程确保可靠性）</li>
<li>技术优势明显（堆栈游标抽象、内存内省、模块化架构等）</li>
</ul>
<p>基于以上优势，我们选择基于 KSCrash 作为崩溃异常监控的核心方案。</p>
<h2 data-id="heading-3">异常监控方案实现</h2>
<h3 data-id="heading-4">架构设计</h3>
<p>异常采集模块，是我们 SDK 数据采集层一个模块的具体实现，如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4730892e98c423789008773cf0038fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=d6x5g7bs%2FbB4M4nyDRVhY7qu3G0%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>监控器管理层：统一管理所有监控器，提供统一的异常处理入口</li>
<li>异常捕获层：多种监控器，分别捕获不同类型的异常和状态信息</li>
<li>异常处理层：构建崩溃上下文，收集堆栈、符号、内存等信息</li>
<li>报告生成层：将崩溃上下文转换为 JSON 格式报告</li>
</ul>
<p>接下来，我们介绍各种类型异常的捕获原理，以及对应监控器是如何实现的。</p>
<h3 data-id="heading-5">系统层异常捕获</h3>
<p>系统层异常包括 Mach 异常和 Unix 信号，是应用层异常监控的主要捕获点。我们需要同时捕获这两种异常，确保不遗漏任何底层异常。</p>
<p><strong>Mach 异常捕获</strong></p>
<p>Mach 异常是 macOS/iOS 系统最底层的异常机制，源于 Mach 微内核架构。Mach 是 macOS/iOS 内核的基础，提供了进程间通信（IPC）和异常处理的核心机制。硬件异常（CPU 异常）会被 Mach 内核捕获并转换为 Mach 异常消息。Mach 异常与特定线程关联，可以精确捕获异常发生的线程。Mach 异常通过 Mach 消息异步传递异常信息，需要使用 Mach 端口（Mach Port）作为异常处理的通信通道。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35c0d189c0114803beb1b2c3c7350419~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=6dddWt9JW1BUAqL59282SzA1J10%3D" alt="图片" loading="lazy"/></p>
<p>监控 Mach 异常，涉及以下几个核心的步骤：</p>
<p><strong>1. 创建异常端口</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 创建新的异常处理端口</span>
<span class="hljs-built_in">mach_port_allocate</span>(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &amp;g_exceptionPort);
<span class="hljs-comment">// 申请端口权限</span>
<span class="hljs-built_in">mach_port_insert_right</span>(mach_task_self(), g_exceptionPort, g_exceptionPort, MACH_MSG_TYPE_MAKE_SEND);
</code></pre>
<p>为了与三方 SDK 兼容，在创建新的异常处理端口之前，需要对旧的异常处理端口进行保存，并在异常处理完毕后恢复旧的异常端口。</p>
<p><strong>2. 注册异常处理器</strong></p>
<p>把异常处理端口设置为刚才创建的：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 设置异常端口，捕获所有异常类型</span>
<span class="hljs-built_in">task_set_exception_ports</span>(
    mach_task_self(),
    EXC_MASK_ALL,
    g_exceptionPort,
    EXCEPTION_DEFAULT,
    MACHINE_THREAD_STATE
);
</code></pre>
<p><strong>3. 创建异常处理线程</strong></p>
<p>为了防止异常处理线程本身崩溃，需要创建两个独立的异常处理线程：</p>
<ul>
<li>主处理线程：正常处理异常</li>
<li>备用处理线程：主处理线程崩溃时的后备份方案</li>
</ul>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 主异常处理线程</span>
<span class="hljs-built_in">pthread_create</span>(&amp;g_primaryPThread, &amp;attr, handleExceptions, kThreadPrimary);
<span class="hljs-comment">// 备用异常处理线程（防止主线程崩溃）</span>
<span class="hljs-built_in">pthread_create</span>(&amp;g_secondaryPThread, &amp;attr, handleExceptions, kThreadSecondary);
</code></pre>
<p>主备线程之间的关系如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca5e38d3619b404c86fbae5a052a8be3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=XzQr3NIkoc132BvsNpFWRMg7rc8%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>备用处理线程在创建后会立即挂起</li>
<li>主线程在处理异常之前会通过 <code>thread_resume()</code> 函数恢复备用处理线程</li>
<li>备用处理线程恢复后，会进入 <code>mach_msg()</code> 等待</li>
<li>如果主线程在处理异常时发生崩溃，备用处理线程可以继续处理崩溃信息（由于异常端口已恢复，此时备用线程可能也收不到消息）</li>
</ul>
<p><strong>4. 处理异常消息</strong></p>
<p>异常处理线程通过 <code>mach_msg()</code> 接收异常消息：</p>
<pre><code class="hljs language-ini" lang="ini">mach_msg_return_t <span class="hljs-attr">kr</span> = mach_msg(
    &amp;exceptionMessage.header,
    MACH_RCV_MSG | MACH_RCV_LARGE,
    0,
    sizeof(exceptionMessage),
    g_exceptionPort,
    MACH_MSG_TIMEOUT_NONE,
    MACH_PORT_NULL
)<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ae5dc7535ed4d51ad9d3caab43e8d72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=yHdgCmOAVfmpLNNDLSStow2R7z0%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>挂起所有线程：确保状态一致性</li>
<li>标记已捕获异常：进入异步安全模式</li>
<li>激活备用处理线程</li>
<li>读取异常线程的机器状态</li>
<li>初始化堆栈游标</li>
<li>构建异常上下文
<ul>
<li>异常类型</li>
<li>机器状态</li>
<li>地址信息等</li>
<li>堆栈游标</li>
</ul>
</li>
<li>统一异常处理：不同异常类型统一处理</li>
<li>恢复线程</li>
</ul>
<p><strong>Unix 信号捕获</strong></p>
<p>作为 Mach 异常捕获的补充，也需要直接捕获 Unix 信号，确保在 Mach 异常处理失败时，仍能捕获到崩溃。Unix 信号的捕获处理涉及：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f6d860e25174edbadabe9c1bafb0d10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=skXpLyxNJhC%2BTEX27GcWy8BADvw%3D" alt="图片" loading="lazy"/></p>
<p>为了能够通过 Unix 信号捕获到异常，需要先安装信号处理器：</p>
<pre><code class="hljs language-ini" lang="ini">// 获取信号列表
const int* <span class="hljs-attr">fatal_signals</span> = signal_fatal_signals()<span class="hljs-comment">;</span>
// 配置信号动作
struct sigaction <span class="hljs-attr">action</span> = {{<span class="hljs-number">0</span>}}<span class="hljs-comment">;</span>
<span class="hljs-attr">action.sa_flags</span> = SA_SIGINFO | SA_ONSTACK<span class="hljs-comment">;</span>
<span class="hljs-attr">action.sa_sigaction</span> = &amp;signal_handle_signals<span class="hljs-comment">;</span>
// 安装信号处理器
sigaction(fatal_signal, &amp;action, &amp;previous_signal_handler)<span class="hljs-comment">;</span>
</code></pre>
<p>Unix 信号的产生主要有以下情况：</p>
<ul>
<li><strong>来自 Mach 异常：</strong> 如果 Mach 异常未被应用层处理，系统会将其转换为对应的 Unix 信号</li>
<li><strong>直接产生：</strong> 如调用 <code>abort()</code> 直接产生 <code>SIGABRT</code>，或 NSException/C++ 异常未捕获时产生的信号</li>
</ul>
<p>当信号产生后，系统会找到我们安装的信号处理器，并调用我们注册的信号处理函数：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">signal_handle_signals</span><span class="hljs-params">(<span class="hljs-type">int</span> sig_num, <span class="hljs-type">siginfo_t</span> *signal_info, <span class="hljs-type">void</span>* user_context)</span>
</span>{
  <span class="hljs-comment">// sig_num: 信号编码，如 SIGSEGV=11</span>
  <span class="hljs-comment">// signal_info: 信号详细信息</span>
  <span class="hljs-comment">//     - si_signo: 信号编码</span>
  <span class="hljs-comment">//     - si_code: 信号代码，如 SEGV_MAPERR</span>
  <span class="hljs-comment">//     - si_addr: 异常地址</span>
  <span class="hljs-comment">// user_context: CPU 寄存器状态</span>
}
</code></pre>
<p>后续对异常的处理，同 Mach 异常处理流程。</p>
<p><strong>注意：</strong> 并非所有异常都源于 Mach 异常。例如，NSException 未捕获时通常会调用 abort() 产生 SIGABRT 信号，这个过程不经过 Mach 异常。因此，异常监控需要同时捕获 Mach 异常、Unix 信号和运行时异常处理器。</p>
<p><strong>机器上下文堆栈</strong></p>
<p>在崩溃发生时，堆栈追踪可以帮助开发者定位问题发生的代码位置。在基于 Mach 或 Unix 信号捕获的场景，需要从 CPU 寄存器和堆栈内存中恢复完整的调用栈。核心原理：每个函数调用，都会在堆栈上创建一个堆栈帧，包含：</p>
<ul>
<li>返回地址：函数返回后继续执行的地址</li>
<li>帧指针（FP）：指向当前堆栈帧的指针</li>
<li>局部变量：函数的局部变量</li>
<li>参数：传递给函数的参数</li>
</ul>
<p>以 ARM64 架构为例，堆栈布局如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/099216b95aa4478cac47a9cd15ac3e98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=YtbZzRyYfPBZadWwgKPFTBEm%2BAw%3D" alt="图片" loading="lazy"/></p>
<p>为了还原崩溃发生时的调用栈，我们需要对堆栈帧进行遍历。堆栈帧遍历的核心原理是通过帧指针链向上遍历：</p>
<ol>
<li>第 1 帧：从 PC 寄存器获取当前崩溃点</li>
<li>第 2 帧：从 LR 寄存器获取调用者</li>
<li>第 3 帧及以后：通过帧指针链从堆栈内存中读取</li>
</ol>
<p>堆栈帧遍历的完整流程如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e2e5e22119d4b01a814ca6696db3e5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=bz2WYghwQBfsVqw5G%2Bhjp7th4N4%3D" alt="图片" loading="lazy"/></p>
<p>在堆栈遍历过程中，有下面几个关键点需要注意：</p>
<ul>
<li>在遍历堆栈时，必须安全地访问内存，防止访问无效内存导致崩溃</li>
<li>堆栈溢出检测，防止在堆栈损坏时无限遍历</li>
<li>地址规范化，不同 CPU 架构的地址可能有特殊标记，需要规范化处理</li>
</ul>
<h3 data-id="heading-6">运行时异常捕获</h3>
<p>运行时异常包括 NSException 和 C++ 异常，通常由编程错误引起。我们需要通过设置异常处理器来捕获这些未处理的异常。</p>
<p><strong>NSException 异常捕获</strong></p>
<p>iOS 需要通过设置 <code>NSUncaughtExceptionHandler</code> 来捕获未捕获的 <code>NSException</code>。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 在设置exception handler之前，先保存之前的设置</span>
NSUncaughtExceptionHandler *previous_uncaught_exceptionhandler = <span class="hljs-built_in">NSGetUncaughtExceptionHandler</span>();
<span class="hljs-comment">// 设置我们的exception handler</span>
<span class="hljs-built_in">NSSetUncaughtExceptionHandler</span>(&amp;handle_uncaught_exception);
</code></pre>
<p>当 <code>Objective-C</code> 代码抛出异常，且未被 <code>@catch</code> 块捕获时，<code>Objective-C</code> 运行时会调用我们设置的异常处理器。在处理完 <code>NSException</code> 异常后，还需要主动调用 <code>previous_uncaught_exceptionhandler</code>，以便其他异常处理器能够正确处理异常。</p>
<p>注意：在异常监控场景中，通常需要在 handler 中收集完崩溃信息后，主动调用 <code>abort()</code> 来终止程序，确保程序不会在异常状态下继续运行。</p>
<p>在捕获到 NSException 异常之后，一般通过以下方式获取 Objective-C 的调用栈信息。</p>
<pre><code class="hljs language-ini" lang="ini">// NSException 提供了 callStackReturnAddresses
NSArray* <span class="hljs-attr">addresses</span> = [exception callStackReturnAddresses]<span class="hljs-comment">;</span>
</code></pre>
<p>通过 [NSException callStackReturnAddresses] 获取到 return address 之后，还需要进一步处理，如：过滤掉无效地址等。</p>
<p><strong>C++ 异常捕获</strong></p>
<p>通过设置 C++ terminate handler 可以捕获未处理的 C 异常。当 C 异常未被捕获时，C++ 运行时会调用 std::terminate()，我们通过拦截这个调用来捕获异常。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 保存原始 terminate handler</span>
<span class="hljs-built_in">std</span>::terminate_handler original_terminate_handler = <span class="hljs-built_in">std</span>::get_terminate();
<span class="hljs-comment">// 设置我们的 terminate handler</span>
<span class="hljs-built_in">std</span>::set_terminate(cpp_exception_terminate_handler);
</code></pre>
<p>当 C 代码抛出异常时，throw 语句会调用 <code>__cxa_throw()</code>，C 运行时会查找匹配的 <code>catch</code> 块，如果未找到异常会继续向上传播。当异常未被捕获时：</p>
<ol>
<li>C++ 运行时会调用 <code>std::terminate()</code></li>
<li><code>std::terminate()</code> 会调用已注册的 terminate handler</li>
<li>我们设置的 <code>cpp_exception_terminate_handler</code> 会被调用</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcb389325124486098131f56af994f28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=ULSbW9hGyFRtAc%2BKSLiodN0aVdk%3D" alt="图片" loading="lazy"/></p>
<p>在我们的 terminate handler 中处理完异常后，还需要调用原始的 terminate handler，以便其他异常处理器能正确处理异常。</p>
<h3 data-id="heading-7">应用层异常捕获</h3>
<p>应用层异常包括业务逻辑异常和性能问题，需要应用层主动监控和检测。主要包括主线程死锁检测和僵尸对象检测。</p>
<p><strong>主线程死锁检测</strong></p>
<p>主线程死锁（Deadlock）是 iOS 开发中一种严重的运行时问题，会导致 App 界面完全卡死（无响应），最终通常会被系统的看门狗（Watchdog）强制终止。</p>
<p>针对这类问题，一种可行的方式是通过“看门狗”机制检测主线程死锁：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6487ae311c5479ba0924a7605ce55eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=0n%2BwJEAMGc6wAHg5EBkWJKgwXm0%3D" alt="图片" loading="lazy"/></p>
<ol>
<li>监控线程：独立的监控线程，定期检查主线程状态</li>
<li>心跳机制：向主线程发送“心跳”任务，检查是否及时响应</li>
<li>死锁判定：如果主队列在指定时间内未响应，则判定为死锁</li>
</ol>
<p><strong>需要注意：</strong></p>
<ul>
<li>误报风险：如果主线程有长时间运行的任务，可能产生误报</li>
<li>超时时间：需要根据应用实际情况，调整超时时间，避免误报</li>
</ul>
<p><strong>僵尸对象检测</strong></p>
<p>iOS 僵尸对象（Zombie Object）是 iOS 开发中导致应用崩溃（Crash）最常见的内存问题之一。僵尸对象是指已经被释放（dealloc）的内存块，但对应的指针仍然指向这块内存，并且代码试图通过这个指针去访问它（发送消息）。访问僵尸对象可能会导致崩溃，通常表现为 <code>EXC_BAD_ACCESS</code> 崩溃。</p>
<ul>
<li>这是一个内存访问错误，意味着你试图访问一块你无法访问或无效的内存。</li>
<li>因为这块内存可能已经被系统回收并分配给了其他对象，或者变成了一块杂乱的数据区域，所以访问结果是不可预知的。</li>
</ul>
<p>产生僵尸对象的原因主要有以下几点：</p>
<ul>
<li><strong>unsafe_unretained 或 assign 指针：</strong> 如果一个属性被修饰为 assign（修饰对象时）或 unsafe_unretained，当对象被释放后，指针不会自动置为 nil（变成悬垂指针）。此时再次访问就会变成僵尸对象访问</li>
<li><strong>多线程竞争：</strong> 线程 A 刚刚释放了对象，但线程 B 几乎同时在尝试访问该对象</li>
<li><strong>CoreFoundation 与 ARC 的桥接不当：</strong> 在使用 <code>__bridge，__bridge_transfer</code> 等转换时，所有权管理混乱导致对象过早释放</li>
<li>Block 或 Delegate 循环引用：某些老旧代码中 Delegate 依然使用 assign 修饰</li>
</ul>
<p>僵尸对象检测的主要思路是：</p>
<ol>
<li>hook <code>NSObject</code> 和 <code>NSProxy</code> 的 <code>dealloc</code> 方法</li>
<li>在对象释放时，计算对象的 hash，然后记录 class 信息</li>
<li>检测是否为 NSException，如果是，则保存异常详情</li>
<li>各类异常发生时，读取保存的异常详情</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7c0d27c2c47429193d02f1d7c870287~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=LMI%2Bq89hqhBpfdHcBQU6d2Wjp3Y%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>为了降低 CPU 和内存占用，僵尸对象的记录上限是 <code>0x8000</code> 个，即：32768</li>
<li>计算哈希时，通过 <code>((uintptr_t)object &gt;&gt; (sizeof(uintptr_t) - 1)) &amp; 0x7FFF</code> 计算</li>
</ul>
<p>这是一种设计权衡的结果。因为这种检测方式并不是非常准确，不能捕获所有僵尸对象。因为 hash 的计算会产生一定的碰撞，导致对象被覆盖，可能会产生误报或错误的类型。</p>
<h3 data-id="heading-8">运行时符号化</h3>
<p>在异常监控系统中，除了需要检测和记录异常类型（如僵尸对象访问、主线程死锁等），还需要处理异常发生时的堆栈信息。堆栈信息通常以内存地址的形式存在，这些地址对于开发者来说是不可读的。为了能够快速定位问题，我们需要将这些内存地址转换为可读的函数名、文件名和行号信息，这个过程就是符号化（Symbolication）。</p>
<p>符号化一般分为两种：</p>
<ul>
<li>运行时符号化：使用 <code>dladdr()</code> 获取符号信息（函数名、镜像名等）</li>
<li>完整符号化：使用 <code>dSYM</code> 文件获取文件名和行号</li>
</ul>
<p>运行时符号化只能获取公开符号。</p>
<p>我们主要讨论 iOS 平台上如何在运行时符号化。iOS 平台主要通过 <code>dladdr()</code> 进行运行时符号化，通过 <code>dladdr()</code> 可以获取到如下信息：</p>
<ul>
<li>imageAddress：image 镜像基址</li>
<li>imageName：image 镜像路径</li>
<li>symbolAddress：符号地址</li>
<li>symbolName：符号名称</li>
</ul>
<p>由于在符号化时，我们需要的是调用指令的地址，但堆栈上存储的是返回地址，因此需要对地址调整：</p>
<pre><code class="hljs language-scss" lang="scss">函数调用过程：
<span class="hljs-number">1</span>. 调用指令：call function_name  (地址: <span class="hljs-number">0</span>x1000)
<span class="hljs-number">2</span>. 函数执行：<span class="hljs-built_in">function_name</span>()     (地址: <span class="hljs-number">0</span>x2000)
<span class="hljs-number">3</span>. 返回地址：<span class="hljs-number">0</span>x1001              (存储在堆栈上)
堆栈上存储的是返回地址（<span class="hljs-number">0</span>x1001），
但我们需要的是调用指令的地址（<span class="hljs-number">0</span>x1000），所以需要减 <span class="hljs-number">1</span>。
</code></pre>
<p>不同 CPU 架构对应的地址调整有所不同，以 ARM64 为例：</p>
<pre><code class="hljs language-ini" lang="ini">uintptr_t <span class="hljs-attr">address</span> = (return_address &amp;~ <span class="hljs-number">3</span>UL) - <span class="hljs-number">1</span><span class="hljs-comment">;</span>
</code></pre>
<p>运行时符号化的完整流程如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb54f323bba147a8918aeb3f53574e3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=Ax3vBc8u8orTPHE5xV3Vj9O7deI%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-9">异步安全</h3>
<p>除了以上内容外，在处理 iOS 平台异常捕获时，我们还需要关注异步安全。</p>
<p>在 Unix 信号处理函数，或 Mach 异常处理中，只能使用异步安全函数，主要是因为：</p>
<ul>
<li>崩溃时系统状态不稳定</li>
<li>可能持有锁，调用非异步安全函数可能导致死锁</li>
<li>堆可能已损坏，此时分配内存可能会失败</li>
</ul>
<p>一般情况下，<code>malloc()</code>、<code>free()</code>、<code>NSLog()</code>、<code>printf()</code>，Objective-C 方法的调用，任何可能分配内存的函数都不允许在处理异常过程中调用。</p>
<h2 data-id="heading-10">结语和展望</h2>
<p>本文主要介绍了当下主流的 iOS 异常监控方案，和基于 KSCrash 的异常监控实现细节，包括 Mach、Unix 信号、NSException 等异常类型的捕获的处理等。异常监控能力还在持续进化，后续还有不少可以优化和提升的点，如支持实时上传和崩溃回调，支持 App 日志记录，dump 寄存器地址附近内存等。目前这套方案已经应用在阿里云用户体验监控 RUM iOS SDK 中，您可以参考接入文档 <strong>[</strong> <strong>1]</strong> 体验使用。阿里云 RUM SDK 当前也支持 Android 、 HarmonyOS 、Web 等平台下异常监控能力。相关问题可以加入“RUM用户体验监控支持群”（钉钉群号：67370002064）进行咨询。</p>
<p><strong>相关链接：</strong></p>
<p>[1] 接入文档</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fuser-experience-monitoring%2Fmonitor-ios-apps%2F" target="_blank" title="https://help.aliyun.com/zh/arms/user-experience-monitoring/monitor-ios-apps/" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/use…</a></p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Farms%3Fspm%3Da1z389.11499242.0.0.65452413yOc5rP%26utm_content%3Dg_1000408142" target="_blank" title="https://www.aliyun.com/product/arms?spm=a1z389.11499242.0.0.65452413yOc5rP&amp;utm_content=g_1000408142" ref="nofollow noopener noreferrer">此处</a>查看产品详情。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别数据库“膨胀”：Dify x SLS 构建高可用生产级 AI 架构]]></title>    <link>https://juejin.cn/post/7587961565477060662</link>    <guid>https://juejin.cn/post/7587961565477060662</guid>    <pubDate>2025-12-26T09:04:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587961565477060662" data-draft-id="7587825268200112134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别数据库“膨胀”：Dify x SLS 构建高可用生产级 AI 架构"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-12-26T09:04:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别数据库“膨胀”：Dify x SLS 构建高可用生产级 AI 架构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:04:57.000Z" title="Fri Dec 26 2025 09:04:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：无哲、言合</p>
<h2 data-id="heading-0">一、前言：Dify 的规模化挑战</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e4b96578c324f8eb575aa3e339537b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=7esT50KRWjTd1U1Li%2FrZwedPkkw%3D" alt="image.png" loading="lazy"/></p>
<p>Dify 是当前最受欢迎的低代码 LLM 应用开发平台之一，在 Github 上已斩获 120k+ 的星标数。国内外有众多企业基于 Dify 构建自己的智能体应用。阿里云可观测团队既是 Dify 的深度用户，也是社区的活跃贡献者。</p>
<p>在大规模生产实践中，我们发现 Dify 在高负载场景下面临显著的数据库性能瓶颈：其执行引擎高度依赖 PostgreSQL，单次 Chat 请求可能触发数百甚至上千次数据库访问；与此同时，Worker 进程在知识库索引构建、Trace 追踪等任务中也会持续写入大量数据。这频繁导致 <strong>DB 连接池打满、慢查询频发</strong> 等问题，已成为制约 Dify 集群横向扩展与并发能力的关键瓶颈。</p>
<h2 data-id="heading-1">二、现状与挑战：Dify 存储机制痛点分析</h2>
<h3 data-id="heading-2">数据分布现状</h3>
<p>Dify 的数据主要分为三类：</p>
<ul>
<li>Meta类 数据：租户、应用、工作流、工具等配置信息；</li>
<li>运行时日志：工作流执行明细、会话历史、消息记录等；</li>
<li>文件类数据：用户上传文件、知识库文档、多模态输出等（通常存于对象存储）。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb0cebf88890443fb5ef43fed477af9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=mu7eRrlsWT0j5mRMUmkGPBTi5rA%3D" alt="图片" loading="lazy"/></p>
<p>其中Meta 与运行日志均存储在 PostgreSQL 中，运行时日志占据了数据库的绝大部分资源。以我们的生产环境为例，运行日志占 DB 存储空间的 95%以上。在访问频率最高和慢查询最多的 SQL 模式中，绝大多数都与运行日志的读写相关。</p>
<p>Dify 的运行日志包含工作流的执行明细记录和会话消息数据，执行记录中有工具输出、模型上下文等大量长文本信息，并且运行日志数量也会随着用户请求快速增长。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b166d94d3d384e4c9c9080eb2c5a9c2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=jBNWY8hOhvSbzd04lV8HEOsR%2BSY%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">核心痛点</h3>
<p>将这类海量、高吞吐的日志数据全量存储在 PostgreSQL 中，带来了多重挑战：</p>
<ul>
<li><strong>负载压力大：</strong> Workflow 节点的每次执行都会产生明细日志（节点执行明细数据，记录节点的输入输出和运行状态等数据），高并发下 <code>workflow_node_executions</code> 表的读写极易成为热点。</li>
<li><strong>连接占用：</strong> 尽管 Dify 1.x 的几个版本对数据库长连接问题做了很多优化（如 issue #22307[1]），但日志密集访问仍加剧连接池压力，影响核心业务的连接获取。</li>
<li><strong>扩展性不足：</strong> 运行日志随着业务量呈爆发式增长，而 PG 扩容依赖垂直升配，升级规格往往伴随主备切换导致的连接闪断或维护窗口，难以实现完全的无感扩容。社区已有多个反馈（如  issue #18800 [2]因会话数据堆积导致首 Token 延迟增加 3 秒； issue #22796 [3]呼吁将日志迁出 PG）</li>
<li><strong>分析加工能力缺失：</strong> 控制台仅支持有限关键词检索，难以满足业务对历史会话进行多维分析、二次加工及精细化运营的需求。</li>
</ul>
<h3 data-id="heading-4">社区的积极探索与演进</h3>
<p>运行日志存储一直是影响 Dify 系统性能与稳定性的痛点。针对这一问题，社区一直在积极寻求解决方案，并已落地了多项优化措施：</p>
<ul>
<li><strong>内存数据库</strong>（issue #20147[4]）：适用于无需持久化的轻量场景，同时新版执行引擎已完成日志存储抽象，为后续异构存储改造奠定了基础。</li>
<li><strong>后台异步执行</strong>（ issue #20050[5]）：通过 Celery Worker 异步写入日志，有效降低了核心链路的延迟，减轻了 API 引擎对 DB 的同步依赖。</li>
<li><strong>周期性清理</strong>（ issue #23399[6]）：引入自动清理机制，定期移除陈旧的会话与执行记录，有效缓解了数据库存储膨胀问题。</li>
<li><strong>大字段分离存储：</strong> 针对 LLM 长上下文导致的大字段问题，支持将超长字段截断并转存至对象存储，减轻了 DB 的 I/O 压力。</li>
</ul>
<h3 data-id="heading-5">根因分析：数据特征与存储引擎的错配</h3>
<p>上述优化在特定阶段非常有效，缓解了 Dify 的燃眉之急，但在大规模生产场景下，应用层的逻辑优化（异步、清理等）已触及天花板。要彻底解决扩展性问题，必须消除数据特征与存储引擎的错配——即我们一直在试图用“关系型数据库”去承载本该由“日志系统”处理的数据。</p>
<p>Dify 工作流记录虽然并非完全是Append-Only写，但具有鲜明的日志特征，与典型的业务数据（如用户信息、应用配置）截然不同：</p>
<ul>
<li><strong>终态不可变：</strong> 记录仅在执行期短暂流转，结束后即成为“只读”档案。在 PG 中长期留存海量只读数据，不仅挤占昂贵的 SSD 资源，庞大的表数据更会显著降低索引效率与查询性能。</li>
<li><strong>泛结构化与 Schema 易变：</strong> 核心负载为巨大的 JSON 对象（每个工作流节点的Inputs/Outputs），且结构随版本迭代。PG 难以高效处理深层 JSON 检索，且亿级大表的 DDL 变更会引发长时间锁表风险。</li>
<li><strong>高吞吐时序写入：</strong> 日志随时间源源不断地产生，持续消耗 IOPS 与数据库连接。请求高峰期极易导致连接池耗尽，导致创建应用等核心业务因资源争抢而失败。</li>
</ul>
<p>因此，我们需要一种支持<strong>存算分离、弹性伸缩、低成本且具备原生 OLAP 能力</strong>的存储架构。阿里云日志服务（SLS） 凭借其云原生特性，成为解决这一瓶颈的最佳选择。</p>
<h2 data-id="heading-6">三、方案选型：为什么 SLS 更适合 Dify 日志场景</h2>
<p>SLS 并不是“另一个数据库替代”，它是为日志场景量身定制的基础设施。在Dify工作流日志场景下，相比于 PG，SLS 在以下四个维度实现了架构上的优化升级：</p>
<h3 data-id="heading-7">极致弹性，应对流量波动</h3>
<p>Dify 业务常有突发流量（如 AI 推理高峰）。PostgreSQL 需按峰值预置硬件资源，低谷期的资源浪费，一旦流量突增超过预设上限，数据库稳定性会有问题。</p>
<p>而SLS 作为 SaaS 化云服务，天然支持秒级弹性伸缩，无须关心分片或容量上限，且默认支持 3AZ 同城冗余。</p>
<h3 data-id="heading-8">高写入吞吐 + 架构解耦，保障核心稳定</h3>
<ul>
<li><strong>高并发写入：</strong> SLS 针对日志场景优化，数据以追加方式顺序写入，避免了数据库中常见的随机 I/O 和锁竞争，能以极低成本支撑数万 TPS 的写入吞吐，轻松应对 AI 业务的写入洪峰。</li>
<li><strong>资源隔离：</strong> 将日志负载剥离至 SLS 云端，实现日志数据流与 Dify 核心业务事务的物理隔离，有效保障主业务系统的稳定性与性能。</li>
</ul>
<h3 data-id="heading-9">海量日志，低成本长期留存</h3>
<p>SLS 数据采用高压缩比技术，支持自动化分层存储，可将历史数据自动沉降至低频和归档存储，无需维护清理脚本，成本远低于数据库 SSD。这使得 Dify 能以极低的成本满足长周期的分析和审计需求。</p>
<h3 data-id="heading-10">开箱即用的数据价值释放能力</h3>
<ul>
<li><strong>Schema-on-Read：</strong> SLS 写入时不强制校验 Schema，完美适配 Dify 快速迭代带来的字段变更，无需对历史数据重新变更。</li>
<li><strong>秒级分析：</strong> SLS 内置了针对日志优化的分析引擎（倒排索引+列存）。开发者可以使用关键词从海量日志中检索，也可以利用 SQL 对亿级日志进行实时聚合分析，将日志数据转化为业务洞察。</li>
<li><strong>丰富数据生态：</strong> 日志在SLS中，可以进一步进行更完善的处理和分析，比如数据加工清洗、联合分析、可视化、告警、消费和投递等等。</li>
</ul>
<h2 data-id="heading-11">四、技术实现：核心架构改造与插件化</h2>
<p>为了将 SLS 引入 Dify，整个工程实施分为两个部分：一是对 Dify 核心的插件化改造，二是基于 SLS 读写日志的插件实现。</p>
<h3 data-id="heading-12">1.Dify 核心插件化改造</h3>
<p>Dify 早期架构中，工作流记录的读写逻辑深度耦合了 SQLAlchemy（PG ORM），扩展性受限。从 v1.4.1 以后社区引入了 WorkflowExecution 的领域模型（#20067[7]）并开始逐步对工作流执行核心流程进行重构，定义了一套标准的 Repository 接口，涵盖日志的写入、更新、读取以及统计等标准行为。在 v1.8.0 社区引入了 Repository 的异步实现，通过推迟日志记录保存提升了工作流执行速度。</p>
<p>虽然 Repository 接口为多存储驱动提供了可能，但早期的抽象并不彻底：它主要解决了“写”的抽象，但大量“读”操作仍绕过 Repository 直接依赖 SQLAlchemy，且复杂的跨表 Join 查询使得存储层难以真正剥离。</p>
<p>为此，我们和 Dify 研发团队多次交流，确定了 Repository 抽象层的完整实现方案。我们通过剥离跨表关联查询、标准化读取与统计接口，真正实现了存储层的完全解耦与插件化加载。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9134545808d64137babd480eb1803ce1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=F0EI47Kaaq%2BkVtx888Z%2ByO4qAZA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-13">2.SLS 日志插件实现</h3>
<p>在插件实现过程中，核心挑战在于抹平关系型数据库（PG）与日志系统（SLS）在数据模型上的差异。为此，我们采用了以下技术策略：</p>
<h4 data-id="heading-14">基于多版本的状态管理</h4>
<p>SLS 的 LogStore 是 Append-Only 追加写入，而Dify 的工作流执行过程存在状态流转，从 <code>RUNNING</code> 变为 <code>SUCCEEDED/FAIL</code>。因此我们采用了多版本控制的思路：</p>
<ul>
<li>写入策略：每次状态更新，不覆盖旧日志，而是新写入一条包含完整状态的日志记录。我们在日志模型中引入了一个纳秒级的时间戳字段 <code>log_version</code>来区分版本。</li>
<li>读取策略：在查询或统计时，插件内部会生成聚合 SQL，对于同一个 <code>workflow_run_id</code>，始终选取 <code>log_version</code> 最大的那条记录作为最终状态。</li>
</ul>
<h4 data-id="heading-15">Schema 自动同步</h4>
<p>Dify 的迭代速度非常快，数据库模型经常发生变更。如果每次升级 Dify 都需要用户手动维护索引配置，将极大地增加运维负担。SLS 插件启动时会自动扫描 SQLAlchemy 模型定义，并与 SLS 索引配置进行 Diff。一旦发现新字段，自动调用 API 更新索引。用户无需手动维护索引，开发者也无须为 SLS 单独编写升级脚本。</p>
<h4 data-id="heading-16">原生 PG 协议兼容</h4>
<p>值得一提的是，SLS 新增原生支持 PostgreSQL 协议。绝大部分原有的统计与分析 SQL，均可通过 PG 兼容模式直接发送到 SLS 上执行，极大地降低了插件的开发适配成本。</p>
<h2 data-id="heading-17">五、实践指南：配置与平滑迁移</h2>
<p>该功能已正式合并至 Dify 社区主分支。基于Dify最新代码，只需进行简单配置，就可以将工作流执行记录切换到SLS存储。</p>
<h3 data-id="heading-18">第一步：准备工作</h3>
<p>（1）创建 Project：在阿里云日志服务控制台创建 Project（建议与业务同地域）</p>
<blockquote>
<p>无需手动创建 Logstore 和索引，Dify 启动后插件会自动检测并创建。</p>
</blockquote>
<p>（2）获取访问凭证：获取具备 SLS 读写权限的 AccessKey ID 和 Secret。</p>
<blockquote>
<p>可以授予 <code>AliyunLogFullAccess</code>，或按需配置最小权限（创建/查看Project、创建/查看logstore、创建/更新/查看索引、写日志、查日志等）</p>
</blockquote>
<h3 data-id="heading-19">第二步：配置Dify</h3>
<p>在 <code>.env</code> 或 <code>docker-compose.yaml</code> 中修改以下配置项，将工作流存储驱动指向 SLS 插件，并补充连接信息：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 1. 修改 Repository 驱动指向 SLS 插件</span>
<span class="hljs-attr">CORE_WORKFLOW_EXECUTION_REPOSITORY</span>=extensions.logstore.repositories.logstore_workflow_execution_repository.LogstoreWorkflowExecutionRepository
<span class="hljs-attr">CORE_WORKFLOW_NODE_EXECUTION_REPOSITORY</span>=extensions.logstore.repositories.logstore_workflow_node_execution_repository.LogstoreWorkflowNodeExecutionRepository
<span class="hljs-attr">API_WORKFLOW_NODE_EXECUTION_REPOSITORY</span>=extensions.logstore.repositories.logstore_api_workflow_node_execution_repository.LogstoreAPIWorkflowNodeExecutionRepository
<span class="hljs-attr">API_WORKFLOW_RUN_REPOSITORY</span>=extensions.logstore.repositories.logstore_api_workflow_run_repository.LogstoreAPIWorkflowRunRepository

<span class="hljs-comment"># 2. 新增 SLS 连接配置</span>
<span class="hljs-attr">ALIYUN_SLS_ACCESS_KEY_ID</span>=your_access_key_id
<span class="hljs-attr">ALIYUN_SLS_ACCESS_KEY_SECRET</span>=your_access_key_secret
<span class="hljs-attr">ALIYUN_SLS_ENDPOINT</span>=cn-hangzhou.log.aliyuncs.com
<span class="hljs-attr">ALIYUN_SLS_REGION</span>=cn-hangzhou
<span class="hljs-attr">ALIYUN_SLS_PROJECT_NAME</span>=your_project_name
<span class="hljs-attr">ALIYUN_SLS_LOGSTORE_TTL</span>=<span class="hljs-number">365</span>  <span class="hljs-comment"># 日志存储天数</span>

<span class="hljs-comment"># 3. 迁移开关配置</span>
<span class="hljs-attr">LOGSTORE_DUAL_WRITE_ENABLED</span>=<span class="hljs-literal">false</span>
<span class="hljs-attr">LOGSTORE_DUAL_READ_ENABLED</span>=<span class="hljs-literal">true</span>
</code></pre>
<p>为了保证存量 PG 用户能平滑升级到 SLS 版本，我们在插件中提供了两个开关：</p>
<p>（1）双写机制：通过配置 <code>LOGSTORE_DUAL_WRITE_ENABLED=True</code>（默认关闭），系统会将日志同时写入 PG 和 SLS。这适用于存量用户迁移初期的灰度验证，确保在不改变原有数据流的情况下，验证 SLS 的配置正确性和 Dify 版本升级本身的兼容性。</p>
<p>（2）双读降级机制：通过配置 <code>LOGSTORE_DUAL_READ_ENABLED=True</code>（默认开启），系统优先从 SLS 读取日志。如果 SLS 中未找到该记录（例如迁移前的老历史数据），插件会自动降级回 PG 再次尝试读取。</p>
<h2 data-id="heading-20">六、成效对比：迁移到SLS的三大收益</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aea0cb21a5e24771aeffdf497955ece5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=DxndBXmlkeKxm1hQInl7Nas1ZQw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-21">收益一：DB压力显著下降</h3>
<p>切换到SLS，相当于把现有PG中数据量最大的两张表的数据迁移走了。根据我们线上业务的数据，DB减少了95%以上的存储空间（运行时间越长，这个比例越高），并且读写过程中的DB的连接数、CPU等压力也有显著降低。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4d2c9bfc0a7413c80c84ef6e342f40f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=onbuHtEOBnkJxbvllkTrlJuoNL8%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-22">收益二：存储成本大幅降低</h3>
<p>为了直观量化迁移后的成本收益，我们以一个典型的生产级场景进行估算：假设 Dify 应用日增日志 10GB，为了满足模型评估与回溯需求，需留存最近 300 天（约 3TB）的数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d62106f5d70411191263f4516ecbb77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=t0jTFhJJVBs9wMNLEBH0291WpA8%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>注：这里估算SLS成本的时候，已经将存多条状态记录会占用存储空间的因素考虑进去。 此外对于PG实际生产中还需额外考虑高可用多副本、预留存储空间、连接池扩容等隐性成本。</p>
</blockquote>
<p>这里造成近 10 倍成本差距 的根本原因在于存储机制的不同。</p>
<p>Dify的工作流记录包含了用户提问、知识召回、工具调用和模型响应等数据，是评估和回归等任务需要的数据资产，长期留存价值高。</p>
<ul>
<li><strong>对于 PG：</strong> 存储时间越长，数据量越大，对昂贵的 SSD 存储空间占用就越多，成本会大幅增长。pg实例需要提前预估存储空间，存储空间不可能完全利用起来，必然闲置一部分空间。</li>
<li><strong>对于 SLS：</strong> 专为日志设计的高压缩比与分层存储技术，使得存储数据量越大、时间越长，其边际成本优势越明显。</li>
</ul>
<h3 data-id="heading-23">收益三：数据价值释放，从“运维监控”到“业务洞察”</h3>
<p>这里我们以一个真实的 Dify 应用场景——“电商智能客服助手”为例，展示日志数据接入 SLS 后，如何挖掘其背后更大的业务价值。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34f07812069f4240a95ced39194b1c01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=GTVZOmUKBO82gcTS9uB7GtqXa1U%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-24">（1）无缝集成，原生体验</h4>
<p>接入 SLS 后，Dify 界面上的日志查询与回溯体验保持不变，但底层存储已完全切换。</p>
<ul>
<li>日志回溯：Dify 控制台的日志详情页直接从 SLS 读取数据，响应更迅速。</li>
<li>监控图表：Dify 内置的监控统计图表，也是通过执行 SLS SQL 实时生成的。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/488198cf9d744b73a6749e36e5a881d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=ZAz2mNYyhoeYHFd6dlOW0V8BZCY%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-25">（2）超越基础，SLS 进阶分析</h4>
<p>虽然 Dify 内置了基础查询和统计功能，但面对复杂的业务分析需求，我们可以直接转至 SLS 控制台，解锁更强大的能力。</p>
<ul>
<li><strong>任意字段的高速检索</strong></li>
</ul>
<p>SLS 支持全文索引和任意键值对条件的组合查询，快速精准检索出符合某种特定特征的日志。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0192c2f638134b7ebc8daf0d20ef34e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=yBjE%2BqKPuZ2yni%2B8A%2B9eteLnOr0%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>业务趋势分析（可视化）场景</strong></li>
</ul>
<p>比如这里我们分析“用户意图识别”这个工作流节点里，按识别出的用户意图的分类统计随时间变化的PV情，便于通过观察不同分类的趋势变化，做出相应的运营决策。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">*</span> <span class="hljs-keyword">and</span> title: 用户意图识别 <span class="hljs-keyword">and</span> intent <span class="hljs-operator">|</span> <span class="hljs-keyword">select</span> json_extract(outputs, <span class="hljs-string">'$.intent'</span>) <span class="hljs-keyword">as</span> "用户意图", date_trunc(<span class="hljs-string">'minute'</span>, __time__) t, <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> pv <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> "用户意图",t <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> t limit <span class="hljs-keyword">all</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/692159a7f5104fa69597b423df8b19bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=svJH61m4JahxuSeXK6brd3so%2By4%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>异常诊断（漏斗分析）场景</strong></li>
</ul>
<p>可以通过漏斗图，分析观察工作流哪些中间节点出现异常失败的比率较高。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">status:</span>succeeded | <span class="hljs-keyword">select</span> title, count(<span class="hljs-keyword">distinct</span> workflow_run_id) cnt <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> title <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> cnt desc
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9889e516acc4f90b5fad6938d3eec7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=w%2BQdP13JYArRO6PK%2FvGRitBiRy8%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>成本与风险风控（实时告警）场景</strong></li>
</ul>
<p>配置告警规则，统计 LLM 节点的 Token 消耗，一旦超过预设阈值，立即触发钉钉/电话告警。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e94041094dcf439f97c7315fcee0124a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=RJLTS3%2FglNn7YziG0zJyXZPygC8%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>数据闭环（ETL 与加工）场景</strong></li>
</ul>
<p>利用数据加工和定时 SQL，对工作流的输入输出进行清洗、脱敏与标准化，构建持续更新的评估与训练数据集。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e5a8e291fa24253b68e6ba96b991445~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=nw7RMdGNFYrnaJHMgSc5Hr4gXm0%3D" alt="图片" loading="lazy"/></p>
<p>总之，将 Dify 工作流日志接入 SLS，不仅能高效查询日志，更能通过分析、可视化、告警和数据加工，将日志转化为业务洞察，真正实现从“看日志”到“懂业务”的跃升。</p>
<h2 data-id="heading-26">七、总结：迈向生产级 AI 架构</h2>
<p>将 Dify 运行日志迁移至阿里云 SLS，并非一次简单的“存储替换”，而是 Dify 向生产级高可用架构演进的关键一跃。</p>
<p>我们通过业务数据与日志数据解耦的架构改造，成功将高吞吐、泛结构化的日志流从事务型数据库中剥离。让 PostgreSQL 专注核心业务事务处理，让 SLS 充分发挥其在海量数据存储与分析上的原生优势。</p>
<p>这一特性带来的价值是全方位的：</p>
<ul>
<li><strong>解决DB性能瓶颈：</strong> 将日志与核心事务解耦，从根本上解决数据库瓶颈，保证核心业务稳定性。</li>
<li><strong>大幅降低日志成本：</strong> 利用SLS的弹性伸缩、高压缩比、分层存储，低成本存储海量日志。</li>
<li><strong>充分释放数据价值：</strong> 从简单的日志查看升级为强大的实时分析、监控告警、加工处理，将运维数据转换为业务洞察。</li>
</ul>
<p>如果您正在构建大规模的 AI 应用，或者正被 Dify 数据库的性能瓶颈所困扰，现在就是升级的最佳时机。拥抱云原生日志架构，让您的 Dify 跑得更快、更稳、更智能。</p>
<p><strong>参考链接：</strong></p>
<p>[1]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Fissues%2F22307" target="_blank" title="https://github.com/langgenius/dify/issues/22307" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p>
<p>[2]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Fissues%2F18800%23event-17534118862" target="_blank" title="https://github.com/langgenius/dify/issues/18800#event-17534118862" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p>
<p>[3]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Fissues%2F22796" target="_blank" title="https://github.com/langgenius/dify/issues/22796" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p>
<p>[4]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Fissues%2F20147" target="_blank" title="https://github.com/langgenius/dify/issues/20147" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p>
<p>[5]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Fpull%2F20050" target="_blank" title="https://github.com/langgenius/dify/pull/20050" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p>
<p>[6]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Fissues%2F23399" target="_blank" title="https://github.com/langgenius/dify/issues/23399" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p>
<p>[7]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Fpull%2F20067" target="_blank" title="https://github.com/langgenius/dify/pull/20067" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[containerd的CPU过高的问题排查]]></title>    <link>https://juejin.cn/post/7587740546954854440</link>    <guid>https://juejin.cn/post/7587740546954854440</guid>    <pubDate>2025-12-26T09:48:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587740546954854440" data-draft-id="7587776610436055055" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="containerd的CPU过高的问题排查"/> <meta itemprop="keywords" content="容器,Kubernetes,性能优化"/> <meta itemprop="datePublished" content="2025-12-26T09:48:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="liuxuzxx"/> <meta itemprop="url" content="https://juejin.cn/user/465848660687336"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            containerd的CPU过高的问题排查
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848660687336/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    liuxuzxx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:48:51.000Z" title="Fri Dec 26 2025 09:48:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>发现线下一台k8s的node的containerd的CPU基本在95%-130%之间来回浮动，看到别的node的containerd的CPU占用率基本都在20%以下，或者是基本上是:1%-5%的样子.</p>
<h2 data-id="heading-1">排查过程</h2>
<h3 data-id="heading-2">定位CPU过高的进程</h3>
<ol>
<li>使用top命令查看发现containerd的CPU居高不下，基本上在100%---120%之间浮动</li>
<li>使用pidstat命令仔细查看</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">linux &gt; pidstat -p 1163 1 <span class="hljs-comment">#抓取1163进程，按照1s的间隔打印CPU消耗</span>

33分27秒   UID       PID    %usr %system  %guest   %<span class="hljs-built_in">wait</span>    %CPU   CPU  Command
33分28秒     0      1163   68.00   56.00    0.00    0.00  124.00     2  containerd
33分29秒     0      1163   46.00   49.00    0.00    0.00   95.00     2  containerd
33分30秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
33分31秒     0      1163    4.00    1.00    0.00    0.00    5.00     2  containerd
33分32秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
33分33秒     0      1163    4.00    3.00    0.00    0.00    7.00     2  containerd
33分34秒     0      1163   58.00   60.00    0.00    0.00  118.00     2  containerd
33分35秒     0      1163   56.00   58.00    0.00    0.00  114.00     2  containerd
33分36秒     0      1163   59.00   57.00    0.00    0.00  116.00     2  containerd
33分37秒     0      1163   59.00   60.00    0.00    0.00  119.00     2  containerd
33分38秒     0      1163   69.00   57.00    0.00    0.00  126.00     2  containerd
33分39秒     0      1163   50.00   49.00    0.00    0.00   99.00     2  containerd
33分40秒     0      1163    2.00    1.00    0.00    0.00    3.00     2  containerd
33分41秒     0      1163    3.00    1.00    0.00    0.00    4.00     2  containerd
33分42秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
33分43秒     0      1163    3.00    2.00    0.00    0.00    5.00     2  containerd
33分44秒     0      1163   56.00   61.00    0.00    0.00  117.00     2  containerd
33分45秒     0      1163   60.00   58.00    0.00    0.00  118.00     2  containerd
33分46秒     0      1163   57.00   60.00    0.00    0.00  117.00     2  containerd
33分47秒     0      1163   55.00   63.00    0.00    0.00  118.00     2  containerd
33分48秒     0      1163   71.00   59.00    0.00    0.00  130.00     2  containerd
33分49秒     0      1163   51.00   50.00    0.00    0.00  101.00     2  containerd
33分50秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
33分51秒     0      1163    4.00    2.00    0.00    0.00    6.00     2  containerd
33分52秒     0      1163    2.00    1.00    0.00    0.00    3.00     2  containerd
33分53秒     0      1163    3.00    3.00    0.00    0.00    6.00     2  containerd
33分54秒     0      1163   58.00   60.00    0.00    0.00  118.00     2  containerd


<span class="hljs-comment">#1.其实输出的是:14时33分xx秒格式，为了不换行，去掉了:14时</span>
<span class="hljs-comment">#2.从输出来看，基本上隔4-5s的时间，就会出现大概:6s的CPU运行在: 100%-120%之间</span>
</code></pre>
<h3 data-id="heading-3">使用perf抓取对应进程的CPU采样信息</h3>
<ol>
<li>在目标node上执行perf命令抓取对应pid的CPU的采样信息</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">linux &gt; sudo perf record -F 99 -p 1179 -g -- <span class="hljs-built_in">sleep</span> 60

linux &gt; sudo perf script -i perf.data &gt; out.perf
</code></pre>
<ol start="2">
<li>安装FlameGraph</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">linux &gt; git <span class="hljs-built_in">clone</span> https://github.com/brendangregg/FlameGraph.git
</code></pre>
<ol start="3">
<li>生成火焰图</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">linux &gt; <span class="hljs-built_in">cd</span> FlameGraph //[上一个步骤git <span class="hljs-built_in">clone</span>的FlameGraph的仓库]
linux &gt; ./stackcollapse-perf.pl out.perf | ./flamegraph.pl &gt; flamegraph.svg
</code></pre>
<ol start="4">
<li>生成的CPU的火焰图如下</li>
</ol>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67ea0bf278a64d45b55a99580f1ba324~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGl1eHV6eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767347331&amp;x-signature=mwAsSAMVB2A5cu%2BfIAzlIc5n7WE%3D" alt="" loading="lazy"/></p>
<ol start="5">
<li>分析这个火焰图能够得到耗费CPU最多的地方是</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">os.Lstat这个系统调用
</code></pre>
<h3 data-id="heading-4">查找containerd的源码对应的操作</h3>
<ol>
<li>查找containerd对应的源码的部分</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// DiskUsage counts the number of inodes and disk usage for the resources under</span>
<span class="hljs-comment">// path.</span>
<span class="hljs-comment">//看代码的意思是获取磁盘的使用量</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DiskUsage</span><span class="hljs-params">(ctx context.Context, roots ...<span class="hljs-type">string</span>)</span></span> (Usage, <span class="hljs-type">error</span>) {
	<span class="hljs-keyword">return</span> diskUsage(ctx, roots...)
}
</code></pre>
<ol start="2">
<li>持续追踪系统的调用代码</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">diskUsage</span><span class="hljs-params">(ctx context.Context, roots ...<span class="hljs-type">string</span>)</span></span> (Usage, <span class="hljs-type">error</span>) {
	...省略
	<span class="hljs-keyword">for</span> _, root := <span class="hljs-keyword">range</span> roots {
        <span class="hljs-comment">//重点是下面这块:filepath.Walk这个方法的调用</span>
		<span class="hljs-keyword">if</span> err := filepath.Walk(root, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(path <span class="hljs-type">string</span>, fi os.FileInfo, err <span class="hljs-type">error</span>)</span></span> <span class="hljs-type">error</span> {
			...省略
		}); 
	}

	...省略
}

<span class="hljs-comment">//继续展开代码</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Walk</span><span class="hljs-params">(root <span class="hljs-type">string</span>, fn WalkFunc)</span></span> <span class="hljs-type">error</span> {
	...省略
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		...省略
	} <span class="hljs-keyword">else</span> {
		err = walk(root, info, fn)
	}
    ...省略
}


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">walk</span><span class="hljs-params">(path <span class="hljs-type">string</span>, info fs.FileInfo, walkFn WalkFunc)</span></span> <span class="hljs-type">error</span> {
	...省略
	<span class="hljs-keyword">for</span> _, name := <span class="hljs-keyword">range</span> names {
		...省略:下面这个
		fileInfo, err := lstat(filename)
		...省略
	}
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Lstat</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> (FileInfo, <span class="hljs-type">error</span>) {
	testlog.Stat(name)
	<span class="hljs-keyword">return</span> lstatNolog(name)
}

...省略中间多个追踪，最终结果是:

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fstatat</span><span class="hljs-params">(fd <span class="hljs-type">int</span>, path <span class="hljs-type">string</span>, stat *Stat_t, flags <span class="hljs-type">int</span>)</span></span> (err <span class="hljs-type">error</span>) {
	<span class="hljs-keyword">var</span> _p0 *<span class="hljs-type">byte</span>
	_p0, err = BytePtrFromString(path)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span>
	}
	_, _, e1 := Syscall6(SYS_NEWFSTATAT, <span class="hljs-type">uintptr</span>(fd), <span class="hljs-type">uintptr</span>(unsafe.Pointer(_p0)), <span class="hljs-type">uintptr</span>(unsafe.Pointer(stat)), <span class="hljs-type">uintptr</span>(flags), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
	<span class="hljs-keyword">if</span> e1 != <span class="hljs-number">0</span> {
		err = errnoErr(e1)
	}
	<span class="hljs-keyword">return</span>
}

#可以看到系统调用的方法是:sys_newfstatat这个
</code></pre>
<h3 data-id="heading-5">使用bpftrace抓取调用细节</h3>
<ol>
<li>安装bpftrace(自行安装)</li>
<li>提供bpftrace的脚本</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#1179是node的containerd的进程的id</span>
tracepoint:syscalls:sys_enter_newfstatat {
    <span class="hljs-keyword">if</span> (pid == 1179) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"1179 filename: %s, flag: %d\n"</span>, str(args-&gt;filename,100), args-&gt;flag);
    }
}

<span class="hljs-comment">#上面文件保存为:trace_lstat.bt</span>
</code></pre>
<ol start="3">
<li>提供bash脚本</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-built_in">export</span> BPFTRACE_MAX_STRLEN=200
bpftrace trace_lstat.bt

<span class="hljs-comment">#原因是，需要引入一个BPFTRACE_MAX_STRLEN的环境变量，因为bpftrace的str方法默认只会打印100的长度好像，但是需要通过这个来设置才行</span>
</code></pre>
<ol start="4">
<li>看下输出的数据信息</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">...省略
1179 filename: /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/43491/fs/home/cpaas/xxl-job/202, flag: 256
1179 filename: /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/43491/fs/home/cpaas/xxl-job/202, flag: 256
1179 filename: /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/43491/fs/home/cpaas/xxl-job/202, flag: 256
1179 filename: /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/43491/fs/home/cpaas/xxl-job/202, flag: 256
1179 filename: /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/43491/fs/home/cpaas/xxl-job/202, flag: 256
1179 filename: /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/43491/fs/home/cpaas/xxl-job/202, flag: 256
1179 filename: /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapsho
...省略

分析下就是如下的结果:
1. 这个文件总共380562行
linux &gt; <span class="hljs-comment"># find /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs -type f|wc -l</span>

<span class="hljs-comment">#输出的文件个数</span>
1104159


那么基本能够确定问题出在这个地方了
</code></pre>
<ol start="5">
<li>进入目录查找对应的文件个数</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#使用AI提供的如下的bash脚本进行统计文件个数</span>

<span class="hljs-comment">#!/bin/bash</span>

<span class="hljs-comment"># 指定根目录</span>
root_dir=<span class="hljs-string">"/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots"</span>

<span class="hljs-comment"># 遍历根目录下的所有子文件夹</span>
<span class="hljs-keyword">for</span> <span class="hljs-built_in">dir</span> <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">$root_dir</span>"</span>/*/; <span class="hljs-keyword">do</span>
    <span class="hljs-comment"># 去除路径末尾的斜杠</span>
    <span class="hljs-built_in">dir</span>=<span class="hljs-variable">${dir%/}</span>
    <span class="hljs-comment"># 提取子文件夹名称</span>
    folder_name=$(<span class="hljs-built_in">basename</span> <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span>)
    <span class="hljs-comment"># 使用 find 命令统计文件夹中的文件数量</span>
    file_count=$(find <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span> -<span class="hljs-built_in">type</span> f | <span class="hljs-built_in">wc</span> -l)
    <span class="hljs-comment"># 检查文件数量是否大于 10000</span>
    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$file_count</span> -gt 10000 ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$folder_name</span>: <span class="hljs-variable">$file_count</span> 个文件"</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>


<span class="hljs-comment">#1.输出结果如下:统计文件个数 &gt; 10000的(1w)</span>
83674: 21389 个文件
85266: 16118 个文件
85333: 22828 个文件
85932: 11998 个文件
86634: 430300 个文件
86635: 430193 个文件

</code></pre>
<ol start="6">
<li>找到如下的文件夹的个数很多</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">linux &gt; find /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/86634/fs/home/export-import-server/xxl-job -<span class="hljs-built_in">type</span> f|<span class="hljs-built_in">wc</span> -l
430842

</code></pre>
<ol start="7">
<li>分析下这个下面的文件个数统计</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#还是上面 6 步骤的bash统计脚本，只是换下root_url即可，得到的结果为</span>
2025-03-22: 55409 个文件
2025-03-23: 103679 个文件
2025-03-24: 103680 个文件
2025-03-25: 103330 个文件
2025-03-26: 64412 个文件
</code></pre>
<ol start="8">
<li>随便进入一个文件夹查看下,看到都是xxl-job的日志。因为xxl-job每次执行都会产生一个很小的日志文件，如果任务多，并且任务频繁(例如5个任务，然后每个任务5s执行一次，那么每天就是:86400).看上面竟然10w多的日志文件个数，估计任务更多更频繁.</li>
<li>手动执行下清理前面几天的日志即可，不过应用程序也要作出改动，显示日志产生的个数以及保留的时间</li>
<li>清理xxl-job的过期无用的日志文件之后，查看containerd进程消耗的CPU</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">[root@h-172-16-15-144-DEV-k8s-node fs]<span class="hljs-comment"># pidstat -p 1163 1</span>
Linux 5.14.0-479.el9.x86_64 (h-172-16-15-144-DEV-k8s-node) 	2025年03月26日 	_x86_64_	(16 CPU)

13分21秒   UID       PID    %usr %system  %guest   %<span class="hljs-built_in">wait</span>    %CPU   CPU  Command
13分22秒     0      1163    9.00    1.00    0.00    0.00   10.00     2  containerd
13分23秒     0      1163    0.00    1.00    0.00    0.00    1.00     2  containerd
13分24秒     0      1163    8.00    9.00    0.00    0.00   17.00     2  containerd
13分25秒     0      1163    3.00    1.00    0.00    0.00    4.00     2  containerd
13分26秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
13分27秒     0      1163    2.00    1.00    0.00    0.00    3.00     2  containerd
13分28秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
13分29秒     0      1163    1.00    0.00    0.00    0.00    1.00     2  containerd
13分30秒     0      1163    0.00    1.00    0.00    0.00    1.00     2  containerd
13分31秒     0      1163   10.00    0.00    0.00    0.00   10.00     2  containerd
13分32秒     0      1163    2.00    1.00    0.00    0.00    3.00     2  containerd
13分33秒     0      1163    0.00    0.00    0.00    0.00    0.00     2  containerd
13分34秒     0      1163    9.00    9.00    0.00    0.00   18.00     2  containerd
13分35秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
13分36秒     0      1163    0.00    0.00    0.00    0.00    0.00     2  containerd
13分37秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
13分38秒     0      1163    1.00    0.00    0.00    0.00    1.00     2  containerd
13分39秒     0      1163    3.00    1.00    0.00    0.00    4.00     2  containerd
13分40秒     0      1163    0.00    1.00    0.00    0.00    1.00     2  containerd
13分41秒     0      1163   11.00    1.00    0.00    0.00   12.00     2  containerd
13分42秒     0      1163    1.00    0.00    0.00    0.00    1.00     2  containerd
13分43秒     0      1163    0.00    0.00    0.00    0.00    0.00     2  containerd
13分44秒     0      1163    8.00   10.00    0.00    0.00   18.00     2  containerd
13分45秒     0      1163    0.00    0.00    0.00    0.00    0.00     2  containerd
13分46秒     0      1163    1.00    0.00    0.00    0.00    1.00     2  containerd
13分47秒     0      1163   11.00    2.00    0.00    0.00   13.00     2  containerd
13分48秒     0      1163    0.00    0.00    0.00    0.00    0.00     2  containerd
13分49秒     0      1163    3.00    2.00    0.00    0.00    5.00     2  containerd
13分50秒     0      1163    1.00    0.00    0.00    0.00    1.00     2  containerd
13分51秒     0      1163    1.00    0.00    0.00    0.00    1.00     2  containerd
13分52秒     0      1163    2.00    1.00    0.00    0.00    3.00     2  containerd
13分53秒     0      1163    0.00    1.00    0.00    0.00    1.00     2  containerd
13分54秒     0      1163   18.00    9.00    0.00    0.00   27.00     2  containerd
13分55秒     0      1163    2.00    1.00    0.00    0.00    3.00     2  containerd
13分56秒     0      1163    2.00    2.00    0.00    0.00    4.00     2  containerd
13分57秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
13分58秒     0      1163    0.00    0.00    0.00    0.00    0.00     2  containerd
13分59秒     0      1163    2.00    1.00    0.00    0.00    3.00     2  containerd
14分00秒     0      1163    1.00    0.00    0.00    0.00    1.00     2  containerd

<span class="hljs-comment">#可以看到CPU降下来了，最高才27%</span>
</code></pre>
<h3 data-id="heading-6">原因分析</h3>
<ol>
<li>由于containerd开启了一个定时任务去获取自己管辖的磁盘的使用大小:就是DiskUsage方法</li>
<li>然后需要调用系统调用的newfstatat进行统计</li>
<li>然后由于文件个数太多了，导致非常耗费CPU</li>
<li>这个文件很多的snapshots下面有很多pod的container写的日志，xxl-job的日志，产生了几百万个，文件很小，但是文件个数很多，没有及时的清理，导致containerd每次扫描都非常耗费CPU</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis主从复制原理与实战：构建高可用缓存架构]]></title>    <link>https://juejin.cn/post/7587630831466250282</link>    <guid>https://juejin.cn/post/7587630831466250282</guid>    <pubDate>2025-12-26T01:07:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587630831466250282" data-draft-id="7490815158190243866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis主从复制原理与实战：构建高可用缓存架构"/> <meta itemprop="keywords" content="Redis,数据库,性能优化"/> <meta itemprop="datePublished" content="2025-12-26T01:07:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Go高并发架构_王工"/> <meta itemprop="url" content="https://juejin.cn/user/446863555701561"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis主从复制原理与实战：构建高可用缓存架构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/446863555701561/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Go高并发架构_王工
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T01:07:24.000Z" title="Fri Dec 26 2025 01:07:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">一、引言</h4>
<p>在现代分布式系统中，缓存几乎无处不在，而Redis凭借其高性能和丰富的数据结构，已然成为缓存领域的“明星选手”。无论是电商平台的秒杀库存、社交应用的热点数据，还是实时分析的中间层存储，Redis都以其低延迟和高吞吐量赢得了开发者的青睐。然而，随着业务规模的增长和对服务可用性的更高要求，单节点的Redis已经难以满足需求。这时候，如何构建一个高可用的缓存架构就成了摆在我们面前的课题。</p>
<p>高可用不仅仅意味着“不停机”，更需要在故障发生时快速恢复、在高并发下稳定运行。Redis的主从复制（Replication）机制正是解决这一问题的基石。通过将数据从主节点（Master）同步到多个从节点（Slave），我们不仅能实现读写分离，分担主节点的压力，还能在主节点故障时快速切换，保障服务的连续性。可以说，主从复制就像一支乐队的指挥，协调着各个乐手（节点）共同演奏出高可用的乐章。</p>
<p>这篇文章的目标读者是那些已有1-2年Redis开发经验的开发者。你可能已经熟悉Redis的基本操作，但对如何在生产环境中利用主从复制构建高可用架构感到好奇，甚至在实战中踩过一些坑。别担心，这里不仅会深入剖析主从复制的原理，还会结合实际项目经验，分享配置方法、优化技巧和踩坑解决方案。无论你是想提升技术深度，还是准备在下一个项目中大展身手，这篇文章都希望为你提供实实在在的价值。</p>
<p>文章将从原理到实战逐步展开：先带你理解主从复制的核心机制，再手把手教你搭建一个高可用缓存架构，最后通过真实案例和经验总结，帮你避开常见陷阱。接下来，让我们从Redis主从复制的基本概念开始，逐步揭开它的高可用魔法。</p>
<hr/>
<h4 data-id="heading-1">二、Redis主从复制核心原理</h4>
<p>主从复制是Redis高可用架构的基石，它通过将主节点的数据复制到从节点，不仅提升了系统的读性能，还为故障转移提供了基础保障。理解其原理，就像拆解一台精密的机械表，只有看清每个齿轮的运转逻辑，才能在实战中游刃有余。本节将从基本概念入手，逐步剖析主从复制的工作流程和关键技术点，并分析其优势与局限。</p>
<h5 data-id="heading-2">1. 什么是主从复制？</h5>
<p>简单来说，主从复制是Redis中一种数据同步机制，主节点负责处理写操作，并将数据变更实时同步到多个从节点，从节点则提供只读服务。想象一下，主节点像是一位忙碌的厨师，不断烹饪新菜（写数据），而从节点则是帮厨，把成品菜分发给顾客（读数据）。这种分工不仅减轻了主节点的负担，还让系统具备了更高的并发能力和容错性。</p>
<ul>
<li><strong>主节点（Master）</strong>：接收客户端的写请求，维护数据的最新状态。</li>
<li><strong>从节点（Slave）</strong>：通过复制主节点的数据提供读服务，默认配置为只读。</li>
</ul>
<h5 data-id="heading-3">2. 主从复制的工作流程</h5>
<p>主从复制的实现可以分为两个阶段：<strong>全量同步</strong>和<strong>增量同步</strong>，再辅以心跳检测来维护连接状态。以下是详细流程：</p>
<h6 data-id="heading-4">（1）全量同步（Full Resynchronization）</h6>
<p>当从节点初次连接主节点或因网络中断重连时，会触发全量同步。主节点会生成一个RDB快照文件，并传输给从节点。</p>
<ul>
<li><strong>流程示意图</strong>：</li>
</ul>
<pre><code class="hljs language-lua" lang="lua">主节点        从节点
  | 生成RDB快照   |
  | <span class="hljs-comment">------------&gt; | 接收RDB快照</span>
  |              | 加载数据到内存
</code></pre>
<ul>
<li><strong>步骤</strong>：
<ol>
<li>从节点发送<code>PSYNC</code>命令请求同步。</li>
<li>主节点执行<code>BGSAVE</code>，后台生成RDB快照。</li>
<li>快照通过网络传输到从节点，从节点加载数据。</li>
</ol>
</li>
</ul>
<h6 data-id="heading-5">（2）增量同步（Partial Resynchronization）</h6>
<p>全量同步完成后，后续的写操作通过增量同步传播。主节点将命令写入复制缓冲区（Replication Buffer），从节点实时读取并执行。</p>
<ul>
<li><strong>流程示意图</strong>：</li>
</ul>
<pre><code class="hljs language-lua" lang="lua">主节点        从节点
  | 写命令缓冲    |
  | <span class="hljs-comment">------------&gt; | 执行命令</span>
  | 心跳检测      | 反馈状态
</code></pre>
<ul>
<li><strong>机制</strong>：
<ul>
<li>主节点维护一个复制偏移量（Offset），记录已发送的数据位置。</li>
<li>从节点反馈自己的偏移量，主节点只发送增量部分。</li>
</ul>
</li>
</ul>
<h6 data-id="heading-6">（3）心跳检测与状态维护</h6>
<p>主从之间通过定期的<code>PING/PONG</code>消息保持连接，检测网络状态和从节点的存活情况。</p>
<h5 data-id="heading-7">3. 关键技术点解析</h5>
<p>主从复制看似简单，但背后有一些技术细节值得关注：</p>
<ul>
<li>
<p><strong>PSYNC命令与复制偏移量</strong></p>
<ul>
<li><code>PSYNC</code>是Redis 2.8引入的同步命令，支持部分重同步（Partial Resync）。它通过复制偏移量和主节点的运行ID（Run ID）判断是否需要全量同步。</li>
<li><strong>表格：PSYNC工作模式</strong>

























<table><thead><tr><th>场景</th><th>主节点响应</th><th>行为</th></tr></thead><tbody><tr><td>初次连接</td><td>FULLRESYNC</td><td>传输RDB快照</td></tr><tr><td>网络中断后重连</td><td>CONTINUE</td><td>发送缓冲区增量数据</td></tr><tr><td>偏移量丢失</td><td>FULLRESYNC</td><td>重新全量同步</td></tr></tbody></table>
</li>
</ul>
</li>
<li>
<p><strong>主从一致性与延迟问题</strong></p>
<ul>
<li>主从复制是异步的，从节点数据可能略滞后于主节点，尤其在高并发写场景下。延迟大小取决于网络状况和从节点处理能力。</li>
<li><strong>经验</strong>：在金融类项目中，这种延迟可能导致读到“脏数据”，需结合业务容忍度调整架构。</li>
</ul>
</li>
<li>
<p><strong>Redis Sentinel与主从切换</strong></p>
<ul>
<li>Sentinel是Redis的高可用组件，监控主从状态并在主节点宕机时自动切换从节点为主。虽然后文会详细展开，但这里提一句：主从复制是Sentinel的基础。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-8">4. 主从复制的优势与局限</h5>
<p>主从复制并非万能，它有自己的“闪光点”和“短板”：</p>
<ul>
<li>
<p><strong>优势</strong>：</p>
<ol>
<li><strong>读写分离</strong>：从节点分担读请求，主节点专注写操作，提升整体吞吐量。</li>
<li><strong>高可用基础</strong>：从节点可作为主节点的备份，配合Sentinel实现故障转移。</li>
</ol>
</li>
<li>
<p><strong>局限</strong>：</p>
<ol>
<li><strong>数据一致性挑战</strong>：异步复制可能导致主从数据不一致。</li>
<li><strong>主节点单点压力</strong>：所有写操作仍集中于主节点，高并发下易成为瓶颈。</li>
</ol>
</li>
</ul>
<p>从原理上看，主从复制就像一条高效的生产线，主节点负责生产（写），从节点负责分发（读）。但在实际应用中，如何配置、优化这条“生产线”，还需要我们走进实战场景。接下来，我们将基于这些原理，手把手搭建一个高可用缓存架构。</p>
<hr/>
<h4 data-id="heading-9">三、主从复制实战：构建高可用缓存架构</h4>
<p>理解了主从复制的原理后，接下来是时候将理论转化为实践了。就像搭积木一样，我们需要从基础的主从环境搭建开始，逐步加入读写分离和高可用设计，最终构建一个健壮的缓存架构。本节将通过具体的配置步骤、代码示例和架构设计，带你一步步实现这一切。准备好了吗？让我们动手吧！</p>
<h5 data-id="heading-10">1. 环境搭建与配置</h5>
<p>搭建主从环境是第一步，可以选择单机多实例（用于测试）或多机部署（生产推荐）。这里以单机为例，展示基本配置。</p>
<h6 data-id="heading-11">（1）主从节点部署步骤</h6>
<ul>
<li><strong>前提</strong>：确保Redis已安装（建议版本5.0+），并准备好两个端口：6379（主）、6380（从）。</li>
<li><strong>步骤</strong>：
<ol>
<li>创建两个配置文件：<code>redis-6379.conf</code>（主节点）和<code>redis-6380.conf</code>（从节点）。</li>
<li>编辑配置文件，设置主从关系。</li>
<li>分别启动两个实例。</li>
</ol>
</li>
</ul>
<h6 data-id="heading-12">（2）配置文件详解</h6>
<p>以下是主从配置的核心参数：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 主节点 redis-6379.conf</span>
<span class="hljs-built_in">bind</span> 0.0.0.0          <span class="hljs-comment"># 监听所有IP（生产中建议限定内网IP）</span>
port 6379             <span class="hljs-comment"># 主节点端口</span>
daemonize <span class="hljs-built_in">yes</span>         <span class="hljs-comment"># 后台运行</span>

<span class="hljs-comment"># 从节点 redis-6380.conf</span>
<span class="hljs-built_in">bind</span> 0.0.0.0
port 6380             <span class="hljs-comment"># 从节点端口</span>
daemonize <span class="hljs-built_in">yes</span>
replicaof 127.0.0.1 6379  <span class="hljs-comment"># 指定主节点IP和端口</span>
replica-read-only <span class="hljs-built_in">yes</span>     <span class="hljs-comment"># 从节点只读（默认值，可不写）</span>
</code></pre>
<ul>
<li><strong>参数说明</strong>：
<ul>
<li><code>replicaof</code>：从节点指向主节点的关键配置。</li>
<li><code>replica-read-only</code>：确保从节点只处理读请求，避免误写。</li>
</ul>
</li>
</ul>
<h6 data-id="heading-13">（3）启动与验证</h6>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动主节点</span>
redis-server redis-6379.conf
<span class="hljs-comment"># 启动从节点</span>
redis-server redis-6380.conf
<span class="hljs-comment"># 检查主从状态</span>
redis-cli -p 6379 INFO REPLICATION
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-ini" lang="ini">role:master
connected_slaves:1
slave0:<span class="hljs-attr">ip</span>=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>,port=<span class="hljs-number">6380</span>,state=<span class="hljs-literal">on</span>line,<span class="hljs-literal">off</span>set=<span class="hljs-number">140</span>,lag=<span class="hljs-number">0</span>
</code></pre>
<h5 data-id="heading-14">2. 读写分离实战</h5>
<p>主从环境就绪后，我们可以通过客户端实现读写分离，提升读性能。以Java的Jedis为例，展示具体实现。</p>
<h6 data-id="heading-15">（1）Jedis配置主从读写分离</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisMasterSlaveDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 连接主节点（写）</span>
        <span class="hljs-type">Jedis</span> <span class="hljs-variable">master</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">6379</span>);
        <span class="hljs-comment">// 连接从节点（读）</span>
        <span class="hljs-type">Jedis</span> <span class="hljs-variable">slave</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">6380</span>);

        <span class="hljs-comment">// 写数据到主节点</span>
        master.set(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"Hello from Master"</span>);
        System.out.println(<span class="hljs-string">"Write to master: key1=Hello from Master"</span>);

        <span class="hljs-comment">// 从从节点读取数据</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> slave.get(<span class="hljs-string">"key1"</span>);
        System.out.println(<span class="hljs-string">"Read from slave: key1="</span> + value);

        <span class="hljs-comment">// 关闭连接</span>
        master.close();
        slave.close();
    }
}
</code></pre>
<ul>
<li><strong>运行结果</strong>：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">Write to master: <span class="hljs-attr">key1</span>=Hello from Master
Read from slave: <span class="hljs-attr">key1</span>=Hello from Master
</code></pre>
<h6 data-id="heading-16">（2）注意事项</h6>
<ul>
<li><strong>负载均衡</strong>：多个从节点时，可用轮询或随机策略分配读请求。</li>
<li><strong>一致性</strong>：异步复制可能导致从节点数据稍有延迟，需根据业务场景权衡。</li>
</ul>
<h5 data-id="heading-17">3. 高可用架构设计</h5>
<p>主从复制虽好，但主节点宕机怎么办？答案是结合Redis Sentinel实现自动故障转移。</p>
<h6 data-id="heading-18">（1）Sentinel配置与部署</h6>
<ul>
<li><strong>步骤</strong>：
<ol>
<li>创建<code>sentinel.conf</code>文件。</li>
<li>配置监控的主节点。</li>
<li>启动Sentinel实例。</li>
</ol>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># sentinel.conf 示例</span>
port 26379
daemonize <span class="hljs-built_in">yes</span>
sentinel monitor mymaster 127.0.0.1 6379 2  <span class="hljs-comment"># 监控主节点，2表示quorum值</span>
sentinel down-after-milliseconds mymaster 5000  <span class="hljs-comment"># 5秒未响应视为宕机</span>
sentinel failover-timeout mymaster 180000      <span class="hljs-comment"># 故障转移超时时间（毫秒）</span>
</code></pre>
<ul>
<li><strong>启动Sentinel</strong>：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">redis-sentinel sentinel.conf
</code></pre>
<h6 data-id="heading-19">（2）主节点宕机切换流程</h6>
<ul>
<li><strong>示意图</strong>：</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">初始状态：<span class="hljs-built_in">Master</span>(<span class="hljs-number">6379</span>) -&gt; <span class="hljs-built_in">Slave</span>(<span class="hljs-number">6380</span>)
          Sentinel 监控
宕机后：  <span class="hljs-built_in">Slave</span>(<span class="hljs-number">6380</span>) 提升为 Master
          Sentinel 更新配置
</code></pre>
<ul>
<li><strong>验证</strong>：
<ol>
<li>手动停止主节点：<code>redis-cli -p 6379 SHUTDOWN</code></li>
<li>检查Sentinel日志或新主节点状态：</li>
</ol>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">redis-cli -p 6380 INFO REPLICATION
<span class="hljs-comment"># 输出：role:master</span>
</code></pre>
<h6 data-id="heading-20">（3）实战经验</h6>
<ul>
<li><strong>quorum值</strong>：表示需要多少个Sentinel同意才能执行切换，建议设置为Sentinel实例数的一半加1。</li>
<li><strong>生产建议</strong>：部署3个Sentinel节点，避免单点故障。</li>
</ul>
<p>通过以上步骤，我们不仅搭建了主从环境，还实现了读写分离和高可用切换。这就像给缓存系统装上了“安全带”和“备用引擎”，既提升了性能，又保障了稳定性。但实战中总会遇到一些挑战，接下来，我将分享一些项目经验和踩坑记录，帮助你少走弯路。</p>
<hr/>
<h4 data-id="heading-21">四、项目经验分享：最佳实践与踩坑记录</h4>
<p>理论和基础配置只是起点，真正让主从复制发挥作用，还需要在实战中不断打磨。就像开车一样，懂得踩油门和刹车只是基本功，如何应对复杂路况才是考验技术的时候。本节将基于我10年Redis开发经验，提炼出一些最佳实践，并分享踩过的坑以及解决办法，最后通过一个真实案例展示效果。</p>
<h5 data-id="heading-22">1. 最佳实践</h5>
<h6 data-id="heading-23">（1）主从延迟优化</h6>
<p>主从复制是异步的，延迟不可避免，但可以通过配置和网络优化减少影响。</p>
<ul>
<li><strong>调整复制缓冲区大小</strong>：
<ul>
<li>参数：<code>repl-backlog-size</code>，默认1MB。高并发写时若缓冲区太小，可能导致全量同步。</li>
<li>建议：根据写流量设置为内存的10%-20%，如<code>repl-backlog-size 128mb</code>。</li>
</ul>
</li>
<li><strong>网络优化</strong>：确保主从节点间网络带宽充足，避免跨地域部署。</li>
</ul>
<h6 data-id="heading-24">（2）负载均衡</h6>
<p>多个从节点如何高效利用？可以结合客户端分片或代理提升读性能。</p>
<ul>
<li><strong>工具推荐</strong>：Twemproxy或Redis Cluster的客户端分片。</li>
<li><strong>经验</strong>：在读多写少场景下，3-5个从节点能显著提升QPS。</li>
</ul>
<h6 data-id="heading-25">（3）监控与报警</h6>
<p>实时掌握主从状态是稳定性关键。</p>
<ul>
<li><strong>命令</strong>：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">redis-cli -p 6379 INFO REPLICATION
</code></pre>
<ul>
<li><strong>输出解读</strong>：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">role:master
connected_slaves:1
slave0:<span class="hljs-attr">ip</span>=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>,port=<span class="hljs-number">6380</span>,state=<span class="hljs-literal">on</span>line,<span class="hljs-literal">off</span>set=<span class="hljs-number">1024</span>,lag=<span class="hljs-number">1</span>
</code></pre>
<ul>
<li><code>lag</code>：从节点延迟（秒），超过5秒需报警。</li>
<li><strong>建议</strong>：集成Prometheus+Grafana，监控offset和lag。</li>
</ul>
<h6 data-id="heading-26">（4）容量规划</h6>
<p>主从节点的硬件配置需与数据规模匹配。</p>
<ul>
<li><strong>经验公式</strong>：从节点内存≥主节点数据量，主节点CPU核心数≥写并发峰值/1000。</li>
</ul>
<h5 data-id="heading-27">2. 踩坑经验</h5>
<h6 data-id="heading-28">（1）全量同步风暴</h6>
<ul>
<li><strong>问题</strong>：主节点高并发下频繁生成RDB快照，导致CPU和IO压力飙升，服务抖动。</li>
<li><strong>场景</strong>：从节点因网络中断重连，触发全量同步。</li>
<li><strong>解决</strong>：
<ol>
<li>增加<code>repl-backlog-size</code>，减少全量同步概率。</li>
<li>优化RDB触发时机，使用<code>save ""</code>禁用手动快照，依靠<code>bgsave</code>。</li>
</ol>
</li>
<li><strong>效果</strong>：全量同步频率降低80%。</li>
</ul>
<h6 data-id="heading-29">（2）主从数据不一致</h6>
<ul>
<li><strong>问题</strong>：网络抖动或从节点处理能力不足，导致数据未及时同步。</li>
<li><strong>场景</strong>：电商库存显示异常，用户读到旧数据。</li>
<li><strong>解决</strong>：
<ol>
<li>提高心跳频率：<code>repl-ping-replica-period 1</code>（默认10秒）。</li>
<li>设置合理超时：<code>repl-timeout 60</code>。</li>
</ol>
</li>
<li><strong>建议</strong>：关键业务加一致性校验（如版本号）。</li>
</ul>
<h6 data-id="heading-30">（3）Sentinel误判</h6>
<ul>
<li><strong>问题</strong>：网络闪断导致Sentinel误认为主节点宕机，频繁切换。</li>
<li><strong>场景</strong>：短暂丢包触发不必要的主从切换。</li>
<li><strong>解决</strong>：
<ol>
<li>调整<code>down-after-milliseconds</code>为10000（10秒）。</li>
<li>增加quorum值，如3个Sentinel设为2。</li>
</ol>
</li>
<li><strong>效果</strong>：误判率降低至近零。</li>
</ul>
<h5 data-id="heading-31">3. 真实案例</h5>
<h6 data-id="heading-32">项目场景：电商秒杀系统的高可用缓存设计</h6>
<ul>
<li><strong>背景</strong>：某电商平台秒杀活动，需支撑10万QPS读请求，1万QPS写请求。</li>
<li><strong>架构</strong>：
<ul>
<li><strong>1主2从 + Sentinel</strong>：
<ul>
<li>主节点：16核32G，存储库存数据。</li>
<li>从节点：8核16G，处理读请求。</li>
<li>Sentinel：3节点部署，保障切换。</li>
</ul>
</li>
<li><strong>读写分离</strong>：客户端用Jedis轮询2个从节点。</li>
</ul>
</li>
<li><strong>优化</strong>：
<ul>
<li><code>repl-backlog-size 256mb</code>，应对高并发写。</li>
<li>网络专线连接主从，延迟&lt;1ms。</li>
</ul>
</li>
<li><strong>效果</strong>：
<ul>
<li>QPS提升50%（从6万到9万）。</li>
<li>主节点宕机后，Sentinel切换时间&lt;5秒，业务无感知。</li>
</ul>
</li>
</ul>
<h6 data-id="heading-33">经验总结</h6>
<p>这个案例让我深刻体会到，主从复制的高可用不仅靠配置，更需要监控和优化。提前规划容量、合理设置参数，才能让架构在压力下稳如泰山。</p>
<p>从最佳实践到踩坑记录，我们看到主从复制既强大又需要细心调校。接下来，我们将探讨一些进阶应用场景和未来趋势，看看如何让它在更广阔的舞台上发光发热。</p>
<hr/>
<h4 data-id="heading-34">五、进阶应用场景与扩展</h4>
<p>主从复制不仅是一个高可用工具，它还能在特定场景下发挥独特作用，就像一把瑞士军刀，功能远超你的想象。掌握了基础实战后，我们可以进一步挖掘它的潜力，同时对比其他方案，展望未来趋势。本节将带你走进主从复制的进阶世界，看看它如何在更复杂的业务场景中大显身手。</p>
<h5 data-id="heading-35">1. 主从复制的特色功能应用</h5>
<h6 data-id="heading-36">（1）从节点只读特性在数据分析中的妙用</h6>
<p>从节点的只读属性不仅适合读写分离，还能作为数据分析的“副本”。</p>
<ul>
<li><strong>场景</strong>：实时统计用户行为日志。</li>
<li><strong>实现</strong>：将日志写入主节点，从节点运行Lua脚本或客户端程序分析数据，不影响主节点性能。</li>
<li><strong>优势</strong>：无需额外ETL工具，简单高效。</li>
<li><strong>经验</strong>：我在一个广告系统项目中用从节点统计点击率，节省了30%的计算资源。</li>
</ul>
<h6 data-id="heading-37">（2）主从结合Redis Cluster扩展规模</h6>
<p>当数据量或并发超过单主多从的承载能力时，可以结合Redis Cluster。</p>
<ul>
<li><strong>架构示意图</strong>：</li>
</ul>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">主从组1: Master1 -&gt; Slave1, Slave2</span>
<span class="hljs-section">主从组2: Master2 -&gt; Slave3, Slave4</span>
Redis Cluster管理多个主从组
</code></pre>
<ul>
<li><strong>适用场景</strong>：PB级数据或百万QPS的超大规模应用。</li>
<li><strong>注意</strong>：Cluster增加了复杂度，适合团队有运维能力的场景。</li>
</ul>
<h5 data-id="heading-38">2. 与其他高可用方案对比</h5>
<p>主从复制并非唯一选择，了解它的“对手”能帮助我们更好地决策。</p>
<h6 data-id="heading-39">（1）主从复制 vs Redis Cluster</h6>
<ul>
<li><strong>对比表格</strong>：






























<table><thead><tr><th>特性</th><th>主从复制</th><th>Redis Cluster</th></tr></thead><tbody><tr><td><strong>架构复杂度</strong></td><td>简单，单主多从</td><td>复杂，多主分片</td></tr><tr><td><strong>数据规模</strong></td><td>中等（GB-TB）</td><td>大规模（TB-PB）</td></tr><tr><td><strong>写性能</strong></td><td>主节点瓶颈</td><td>多主并行写</td></tr><tr><td><strong>适用场景</strong></td><td>读多写少</td><td>读写均衡、大数据</td></tr></tbody></table>
</li>
<li><strong>选择建议</strong>：中小型项目用主从复制，快速上手；超大规模场景选Cluster。</li>
</ul>
<h6 data-id="heading-40">（2）主从复制 vs 自定义分布式方案</h6>
<ul>
<li><strong>对比</strong>：
<ul>
<li><strong>主从复制</strong>：Redis原生支持，维护成本低，但灵活性有限。</li>
<li><strong>自定义方案</strong>：如基于Zookeeper+分片，灵活性高，但开发和运维成本高。</li>
</ul>
</li>
<li><strong>经验</strong>：除非有特殊需求（如强一致性），主从复制通常是性价比最高的选择。</li>
</ul>
<h5 data-id="heading-41">3. 未来展望</h5>
<p>Redis的演进一直在加速，主从复制也在不断优化。</p>
<ul>
<li><strong>Redis 7.0+新特性</strong>：
<ul>
<li><strong>多线程IO</strong>：提升主从同步效率，尤其在高并发写场景下。</li>
<li><strong>PSYNC改进</strong>：更智能的增量同步，减少全量同步开销。</li>
</ul>
</li>
<li><strong>趋势判断</strong>：
<ul>
<li>云原生支持增强：主从复制将更适配K8s等容器化环境。</li>
<li>AI驱动优化：未来可能通过机器学习动态调整复制参数。</li>
</ul>
</li>
<li><strong>个人心得</strong>：Redis的简单哲学不会变，主从复制仍将是高可用核心，但会更智能、更高效。</li>
</ul>
<p>主从复制的应用场景和未来潜力远不止于此，它就像一棵茁壮成长的树，不断开枝散叶。下一节，我们将回顾全文，总结实践建议，为你的Redis之旅画上圆满句号。</p>
<hr/>
<h4 data-id="heading-42">六、总结</h4>
<p>经过从原理到实战的全面探索，我们已经走完了Redis主从复制的旅程。就像搭建一座房子，我们先打好了地基（原理），然后搭起了框架（实战），最后用经验和优化让它更坚固。现在，让我们回顾一下核心内容，并为你的下一步实践提供一些建议。</p>
<h5 data-id="heading-43">1. 核心内容回顾</h5>
<ul>
<li><strong>主从复制原理</strong>：通过全量同步（RDB快照）和增量同步（AOF日志+复制缓冲区），主节点将数据高效传播给从节点。心跳检测和PSYNC命令则是保障同步稳定的“幕后英雄”。</li>
<li><strong>实战要点</strong>：从基础配置到读写分离，再到结合Sentinel实现高可用，我们一步步构建了一个健壮的缓存架构。代码和配置示例让理论落地，触手可及。</li>
<li><strong>项目经验</strong>：优化主从延迟、应对全量同步风暴、解决Sentinel误判，这些实战经验不仅提升了性能，也让我们少走弯路。</li>
</ul>
<h5 data-id="heading-44">2. 给读者的建议</h5>
<p>如果你正准备将主从复制应用到自己的项目中，这里有几条建议：</p>
<ul>
<li><strong>从小规模实验开始</strong>：先在本地或测试环境搭建1主1从，熟悉配置和监控，再逐步扩展到生产。</li>
<li><strong>关注监控与异常处理</strong>：用<code>INFO REPLICATION</code>实时检查状态，设置报警机制，确保第一时间发现问题。</li>
<li><strong>根据业务场景调整</strong>：读多写少用多从节点，高一致性需求则加校验机制，主从复制很灵活，关键是找到适合你的平衡点。</li>
</ul>
<h5 data-id="heading-45">3. 结束语</h5>
<p>Redis主从复制看似简单，却蕴含着构建高可用缓存架构的无限可能。它就像一颗种子，只要你用心浇灌，就能在你的系统中开花结果。希望这篇文章能成为你探索Redis世界的起点，无论是对技术的钻研，还是对架构设计的信心，掌握主从复制都将为你的职业旅程加分。动手试试吧，高可用的缓存架构就在你的指尖！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如果让我站在科技从业者的角度去回看 2025 年，让我选一个词出来形容它，我会选择“vibe coding”这个词。]]></title>    <link>https://juejin.cn/post/7587997157237915700</link>    <guid>https://juejin.cn/post/7587997157237915700</guid>    <pubDate>2025-12-27T06:10:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587997157237915700" data-draft-id="7587997157237899316" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如果让我站在科技从业者的角度去回看 2025 年，让我选一个词出来形容它，我会选择“vibe coding”这个词。"/> <meta itemprop="keywords" content="后端,前端,程序员"/> <meta itemprop="datePublished" content="2025-12-27T06:10:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="why技术"/> <meta itemprop="url" content="https://juejin.cn/user/3702810893364350"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如果让我站在科技从业者的角度去回看 2025 年，让我选一个词出来形容它，我会选择“vibe coding”这个词。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810893364350/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    why技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T06:10:09.000Z" title="Sat Dec 27 2025 06:10:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果让我站在科技从业者的角度去回看 2025 年，让我选一个词出来形容它，我会选择“vibe coding”这个词。</p>
<p>ChatGPT 作为 AI 的第一波浪潮来临的时候，我们作为科技从业者，都清楚的知道这波浪潮会冲击到我们中的大多数。</p>
<p>对我来说，在 2025 年，这波浪潮的名称就叫 vibe coding。其实你仔细想想，AI 写出的代码能用，这件事爆发性的发展，也就是今年这一年发生的事儿，甚至是下半年的事情。各种各样的 AI 编码工具如雨后春笋般的冒出来头来，一个比一个好用。</p>
<p>冲击到我的一个具体表现之一就是今年我写文章的频率真的没有前几年这么高了。</p>
<p>同样的一个问题，你去问 AI，它只用几十秒，就能得到我花了大量精力才学会，并融汇贯通的东西。</p>
<p>你只需要用自然语言把需求描述清楚，再稍加引导，它就能在很短的时间内直接给你生成工程级别的代码，水平能和一个中级程序员对标。</p>
<p>轻而易举就能获得我呕心沥血才学会的东西。所以我是真的感到恐惧，恐惧到我开始抗拒。</p>
<p>以前，我想起一个有意思的技术话题就会去一边研究一边写，最后把它写出来，这个过程是很有意思的。</p>
<p>现在，当我研究了一点，然后在把它写出来的，我就会觉得，没意思。</p>
<p>单纯就是觉得没意思，因为我写的这些东西，去问 AI 都知道。</p>
<p>我把它写出来可能要用一周时间，但是去问 AI，它几分钟就能给你一大段内容，并说得头头是道，比我分析更加全面，更加有细节，遇到不明白的地方，你还可以不断的去追问它。</p>
<p>我找不到我写出来的文章的价值在哪里。</p>
<p>以前会有读者给我反馈一些他们遇到的技术问题，而我恰好又有时间，我就会给读者量身定做一篇答疑，甚至没有时间的时候我会先加入素材库。</p>
<p>现在，为什么还要来问我？</p>
<p>即使有人来问我，我都会叫他先去问 AI。</p>
<p>在当下 AI 已经进化到“vibe coding”阶段了，我作为一个技术博主，再去写一些常规性的技术类文章的时候，我更加找不到价值在哪里。我也尝试过在找不到价值的时候，就硬写，但是写的心境变了，写出来的东西我自己都觉得是垃圾。</p>
<p>想提笔，但是四顾茫然，最终落得一个道心破碎的下场。所以，我之前有一段时间是干脆就不写了。</p>
<p>后面我觉得我还是想要写一点东西的，就转而面向了一些 AI 工具的使用，或者围绕 AI 产生的一些思考。虽然没有之前写技术文章时的冲劲了，但是至少这是我真的想要写的东西，而不是硬憋出来的垃圾。</p>
<p>这也是我拥抱 AI 的一种方式。</p>
<p>vibe coding 这一波浪潮只是冲击到了我，但还冲不倒我。</p>
<p>犹记得 2022 年末 ChatGPT 横空出世的时候，我写过一篇蹭热度的文章，当时取标题为了骗点击率，就故意写的“危言耸听”一点：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2de3b8e4ce27446d86657c9fa75c2092~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2h55oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420609&amp;x-signature=%2B5JDCXcqprnmnW%2BbE8YdgebuHks%3D" alt="" loading="lazy"/></p>
<p>现在回头去看“端好饭碗，谨防AI”一点也不算危言耸听，反而是一种“预言”。</p>
<p>我知道，从 2022 年的 chatGPT 到 2025 年的 vibe coding，这只是又一波浪潮而已。后面紧跟着还有不知道多少波更猛的。</p>
<p>后面的，不知道我顶不顶得住。</p>
<p>顶得住，万事大吉。</p>
<p>顶不住，我也已经想好了倒下时看起来比较悲壮的台词：</p>
<p>我是旧时代的残党，新时代没有能载我的船。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[24页 大语言模型（LLM）入门指南：从核心定义、训练三步法到 Llama 3.1 实操部署]]></title>    <link>https://juejin.cn/post/7588042910195122226</link>    <guid>https://juejin.cn/post/7588042910195122226</guid>    <pubDate>2025-12-27T06:15:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588042910195122226" data-draft-id="7588031908171841545" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="24页 大语言模型（LLM）入门指南：从核心定义、训练三步法到 Llama 3.1 实操部署"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-27T06:15:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            24页 大语言模型（LLM）入门指南：从核心定义、训练三步法到 Llama 3.1 实操部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T06:15:42.000Z" title="Sat Dec 27 2025 06:15:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>大语言模型（LLM)，是一种能够理解并生成我们日常使用的语言的 AI工具。例如，如果你问中国首都的名字是什么？它的核心是通过大量的文本数据来“学”懂语言规则，并且能够预测接下来的单词和句子应该是什么，如“中国首都是北京。”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b20b93bb495a498987d8d5d6e426b8dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=IRh51yWFDqi7HISBjSysW7CIUCo%3D" alt="" loading="lazy"/></p>
<p>在了解 LLM之前，我们必须了解其“大”之处。一方面，训练数据量很大，主要是使用 Common Crawl网的过滤数据，仅此一项就占据了60%的训练数据，达到4100多亿次；然后是 Reddit论坛的WebText2,Books1和Books2两个在线图书收藏网站，还有维基百科，所有这些加在一起的数据是非常巨大的。另一方面，模型的参数较多，如GPT-3，参数最小为1250万，参数最大为1750亿，共96层；非官方的消息称GPT-4更加夸张，其参数多到1.8兆字节，120个层次，并且学习了13兆个单词。而且，由于是基于自然语言处理的方法，所以非常符合人的语言逻辑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a615174bea754c8cb10e28ff5feca007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=%2B5po7dCKLBAS%2F5YIbBZh022GK6A%3D" alt="" loading="lazy"/></p>
<p>训练LLM有3个步骤。第一阶段是非监督式的预训练阶段，将大量的文本输入到模型中，先进行“文字接龙”的练习，其核心是猜测接下来的单词；第二步就是进行有监控的微调，训练机器人使用人工编写的答案来准确地回答用户的提问，就像一个初级客户服务人员一样；第三步就是通过人的反馈进行强化学习，按照人们对模型的响应等级来训练激励模型，最终将该模型完善为一名专业的咨询师。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9d2666afa1b444299b1f4eb376c6650~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=rIFzKcAcDG3DkC7CZ1vVM1oPVDU%3D" alt="" loading="lazy"/></p>
<p>真正使用起来，LLM可以完成很多事情。基本功能包括编写内容，回答知识库中的问题，对文本进行分类，对文本进行情感分析，以及辅助检索，保证电脑安全等。在产业上也有广泛应用，比如广告业可以用它进行精准投放，教育界可以进行个性化教学，医学界可以用它进行辅助诊断，金融界可以用它进行动态风险监控。</p>
<p>如果你想尝试自己部署，可以使用谷歌标签。Llama3.1是 Meta在去年的4个月开放的一个模型，虽然95%的训练数据都是用英文的，但是 Llama3.1有很多版本。再使用开放源码的 LLM开发平台 Ollama，流程也不是很复杂，打开 Colab，选择 GPU支持的环境、安装 Ollama、下载 Llama3.1、运行 Lllama3.1，然后就可以和模型进行交互。如果硬件不够好，也可以尝试在本地部署或与 ngrok一起进行远程接入。</p>
<p>然而，使用 LLM需要考虑一些道德上的因素，例如保护数据隐私，避免产生虚假信息，降低模型偏差，以及 LLM的能源消耗并不小，会对环境造成一定的影响。未来， LLM将朝着多模式、强逻辑推理（OpenAIo1）、自治模型的方向前进，并且将更加有效地进行个性化的微调，更加密切地与人类进行合作，并且将逐渐完善相关的道德规范。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6678f831590e4bf98223ff23e25900f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=GOFcwZEFwV7E5SoOKCfblxcGZB0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f823ddab2d944369668102ac0e204f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=PjRyT%2BxX0L3%2Bku0h%2FObCRM57%2BSo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7867ad6db65c4b48898f2716eb17cf38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=RfzOACOnwm5NsARibiWWcNvtNqs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15f5e250e99c46f7a9bcb6fbd72bacd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=R2YjnRc3NU%2F5XuBGieNn79PL%2Blk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad86b7e6663a498bad6b34f64306a440~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=nv5EXymNWRF9R2f9Sc%2BKnmntaS0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/040e209b2f43477fb45080a2a02b46ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=JTAu%2BER4e8r2uAJ8PucGAtshkbE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20555c4762f34ec4b27182a0e925705c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=IPJh%2BehvP%2Br%2FZj3wQdTO%2BofcgL0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/412e92b3d56545fdad4e34cfb3595788~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=cj1OfR9Nt6AwSGHuKw41raXw6VQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/284ccd5285e9476d9542c28584b21986~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=pGOAkayHHe4iZAB2IDk5TzK7qfQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/367be3e1905d4fec8bf2e61d9ffa96c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=Yfii5zj5KJyIWWaK5%2BwCrxpyiWg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c07ab8a8801d44eca7bcf59cf45478ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=M3b%2F9kjkDB2loHqKfD7bmApnL0I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59a0f0039b5e4dfea78ab3fd2d0e4e14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=XRglWL5chO6uakBdR3d0fqz92dI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebb12acc74aa448f8ac372b3505df368~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=ejHhOz8K0aAiySDPYsBzBuPwVZs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ab1d077d0034d18b29b9f9f102c446c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=Ih1IkGFhNQhUFFtidTPHsxo5sIQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f68cea40dc9a45d2932f03575d33388e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=%2FArYH0cc0OQ2tlvD%2BszXB6cxHko%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98d235d9437b43a2a96bc122b2df729c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=UphzYVGVMgDT2hYce%2FBMLp4xaog%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6137a0a7b9fb4dc5a37f26137593bd57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=eZRG3FzbbmJTbvktM0zaGhxWlgg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d7f4e5e486a4efd9cdfd06725893ebe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=Q9nmJsU3ctoBr0iTs6SgmKcmFrc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38dfdaf572ee429fbc968c862d689cb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=QrkoYgCWBSRhChLhhA3gQe4rFJQ%3D" alt="" loading="lazy"/></p>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG评测完整指南：指标、测试和最佳实践]]></title>    <link>https://juejin.cn/post/7588031908171890697</link>    <guid>https://juejin.cn/post/7588031908171890697</guid>    <pubDate>2025-12-27T06:18:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588031908171890697" data-draft-id="7588028859541241882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG评测完整指南：指标、测试和最佳实践"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-12-27T06:18:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG评测完整指南：指标、测试和最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T06:18:45.000Z" title="Sat Dec 27 2025 06:18:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>RAG（Retrieval-Augmented Generation，检索增强生）最初由Facebook AI Research（现Meta AI）团队在论文 Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks 中提出，并发表于NeurIPS 2020。</p>
<p>如果你有使用RAG应用，你会发现，RAG框架是一个复杂的工作流，包括分块、搜索、上下文拼接和内容生成等步骤，一旦系统最终响应的内容不符合预期，对于问题的定位会非常复杂，是模型出现了幻觉？还是从一开始就没有获取到正确的信息？</p>
<p>这就需要一个完善的RAG评估体系：评估RAG系统各个模块运行的效果，在用户之前分析问题、甚至是预判问题。这篇文章会和大家详细聊聊，如何在开发和生产环境中评估RAG系统。</p>
<h2 data-id="heading-0">全文速览</h2>
<ul>
<li><strong>基本概念</strong>：<strong>RAG系统</strong>能够从大量的语料库中检索出与输入问题相关的上下文信息，并利用这些信息生成准确、合理的回答, <strong>RAG评估</strong>用于评价RAG系统性能的系统方法。</li>
<li><strong>RAG评估核心内容</strong>：<strong>检索</strong>（查找有用信息）、<strong>生成</strong>（生成最终答案）。</li>
<li><strong>检索评估</strong>：分为排序、上下文相关性指标，前者可以采用Top-K召回，后者可以采用人工或LLM来判断。</li>
<li><strong>生成评估</strong></li>
</ul>

<ul>
<li><strong>有真值</strong>：使用LLM作为评判员或语义相似性，将输出与正确答案进行比较。</li>
<li><strong>无真值</strong>：可以检查响应的忠诚度、完整性、语气或结构质量</li>
</ul>

<ul>
<li><strong>合成测试数据</strong>：一种帮助RAG评估的方法，通过从知识库中生成问答对来实现，用以在没有真实数据的情况下快速构建和测试集。</li>
<li><strong>鲁棒性测试和对抗性测试</strong>：确保RAG系统在面对风险输入或极端情况时，响应仍然安全一致。鲁棒性测试评估RAG系统在正常场景之外的行为，并观察其能否从容的应对。对抗性测试侧重系统的安全性，测试RAG系统能够抵御恶意攻击或误操作，并保护用户的数据和隐私。</li>
</ul>
<h2 data-id="heading-1">基本概念</h2>
<h3 data-id="heading-2">什么是 RAG？</h3>
<p>RAG作为当下主流的LLM应用框架，将外挂的知识库（如网络数据、企业私有文档）、LLM内置的知识完美融合，有效解决LLM中存在的<strong>信息过时</strong>、<strong>输出幻觉、行业数据隔离</strong>等痛点问题，产生更准确、更有用的结果。</p>
<p>举个例子，对于一家公司的客服机器人，LLM是很难知道这家公司的产品功能、业务逻辑的。相反，RAG系统在用户提出问题时，会检索公司内部的产品或业务文档，将检索到的相关内容交给LLM，由LLM生成最终的答案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84448f6a01504fe0bac6ce6db54eba92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=tnPRbhFPAN9F0dou1d7g9SpMQBc%3D" alt="" loading="lazy"/></p>
<p>RAG 系统可以分为两大步骤：</p>
<ul>
<li>R（Retrieval）: 尝试找到与用户查询最相关的信息片段，信息的来源包括文档存储库、知识库、SQL查询数据库等。</li>
<li>G（Generate）: 利用检索到的信息生成答案</li>
</ul>
<p>需要提醒的是，RAG系统是一种设计理念，而非单一的实现形式。比如，<strong>检索</strong>部分的实现形式是多样的，如语义搜索、关键词搜索、SQL查询，甚至是API调用，为模型提供有用的上下文信息。</p>
<p>在企业应用中，检索实际上是对内部的大量非结构化文档进行搜索的系统，包括文档的准备、存储、索引方式和排序。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51974b77ef0e4220806e0b2953148e43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=ypF%2BIYZEhZ3wFXqI2rJZa66%2FNE8%3D" alt="" loading="lazy"/></p>
<p>检索完成后，需要为LLM构建完整的提示信息，包括：</p>
<ul>
<li>用户的问题</li>
<li>检索到的上下文</li>
<li>系统提示，约定模型按照什么格式输出答案</li>
</ul>
<h3 data-id="heading-3">什么是 RAG 评估？</h3>
<p>定义：旨在衡量RAG系统在实际应用中的性能表现。比如：是否提取了正确的信息？是否给出了正确的答案？输出结果是否可信？一个合理的评估体系有助于回答这些问题，并指导开发工程师做出更好的设计决策。</p>
<p>RAG系统就像一台精密的机器，要让它稳定运转，每个关键环节都要做扎实：文档的分块和存储方式、使用的嵌入模型、检索逻辑、提示格式、LLM 版本等等。</p>
<p>一套靠谱的评估方法，就像这台精密机器的调试工具箱，能解决很多实际问题：</p>
<ul>
<li>快速给出不同方案的对比效果，比如哪种文档分块方式找答案更准</li>
<li>追踪哪些因素能提高或降低效果</li>
<li>精准定位问题，当系统答非所问或出错时，能更快找到症结在哪儿，调试起来更省心。</li>
</ul>
<p>说了这么多，到底该如何评估呢？一种简单的方式，对RAG系统进行端到端评估，重点关注最终答案的质量，这种方式尽管也可行，但不利于问题的排查、效果的优化。</p>
<p>更优的方式是，将检索和生成阶段分开评测，这对于调试也至关重要。当你得到错误答案时，你首先应该问自己：哪里出错了？</p>
<ul>
<li>系统是否检索到正确的上下文信息</li>
<li>上下文正确了，模型是不是出现了幻觉</li>
</ul>
<p>接下来，我们将分别介绍检索和生成阶段的评估方法</p>
<h2 data-id="heading-4">检索阶段的评估方法</h2>
<p>下面将介绍<strong>有真值、人工标注和LLM</strong>三种评估方法。</p>
<h3 data-id="heading-5">有真值的评估方法</h3>
<p>检索评估并非一个新话题，所有搜索引擎的背后都有一套这样的评估机制，比如百度、谷歌，这是一个典型的机器学习应用场景。在这套评估机制的引导下，工程师可以为用户提供更好的产品服务。类似的，我们也可以将这套方法复用到RAG系统中。</p>
<p>你需要有一个<strong>真值数据集，对于每个查询，需要定义包含答案的正确来源，可以是文档ID、数据块ID 或链接。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be2215a44ecc468bbe4b0daf728a6120~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=AlGi45txZveTYcmObaSfrwgm9DY%3D" alt="" loading="lazy"/></p>
<p>在信息检索术语中，这些被称为<strong>相关</strong>文档，即为用户查询提供正确、有效信息的条目。</p>
<p>有了这份真值数据集，就可以在系统中运行查询，并通过比较检索到的数据块与预期数据块，来检查系统是否能够找到预期的上下文。为了量化结果，可以计算标准的信息检索指标。</p>
<p>以下是一些例子，后续将以专栏的形式，详细介绍各类评估指标的原理、实现：</p>

























<table><thead><tr><th>指标</th><th>说明</th></tr></thead><tbody><tr><td>精确度@k</td><td>在检索到的前k个结果中，有多少是真正相关的？</td></tr><tr><td>召回@k</td><td>在所有相关文档中，有多少个文档被检索到排名前k之列？</td></tr><tr><td>命中率</td><td>前k个结果中是否至少出现过一个相关条目？（是/否）</td></tr><tr><td>NDCG@k</td><td>归一化折扣累计收益：用来衡量排名前k个检索结果的相关性和排序合理性</td></tr></tbody></table>
<p>以<strong>精确度@k</strong>指标为例，其计算示意图如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7b95f8bf97e4c41858e77772b04b522~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=fNjsji2ncYxYwezTz94guWXtnYY%3D" alt="" loading="lazy"/></p>
<p>这些评估指标能帮助我们有效对比不同的搜索配置，比如重排规则、嵌入方法，还能定位问题。缺点是，构建真实的测试数据集特别耗时，需要人工把每个测试问题对应到正确的参考内容上。</p>
<h3 data-id="heading-6">人工标注相关性</h3>
<p>这是一种相对简单的方法，在检索后评估结果。</p>
<p>无需预先定义相关文档，让系统按原样运行测试查询，然后手动评估结果。对于每个查询，都要检查系统的检索内容，并分配一个标签，例如：<em>相关</em>、<em>部分相关 、不相关</em>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a4f4f98d53845bcb391f14a1a877d89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=UxRjSGu2RhSz9DCgfPAD1PpmBNc%3D" alt="" loading="lazy"/></p>
<p>许多团队在实践中也是用这种方法评估检索效果的。例如，谷歌制定了详尽的内部准则 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%2Fhowsearchworks%2Fhow-search-works%2Frigorous-testing%2F" target="_blank" title="https://www.google.com/search/howsearchworks/how-search-works/rigorous-testing/" ref="nofollow noopener noreferrer">www.google.com/search/hows…</a>）供人工评分员参考。</p>
<p>这样做的好处是灵活，可以评估整个检索流程在实际运行中的效果，包括：</p>
<ul>
<li>评估用户在生产环境中实际看到的检索质量。</li>
<li>找出性能极差的查询</li>
<li>更好地理解边界情况和歧义查询</li>
</ul>
<p>缺点也显而易见，无法计算召回率，因为没有真值。</p>
<h3 data-id="heading-7">LLM评审员评估相关性</h3>
<p>LLM评审员使用用大语言模型，在评估提示词的引导下，评价RAG系统响应的结果。比如，可以给LLM定制提示词，让它判断某个回复有没有帮助，或者是否符合特定的规则要求。</p>
<p>下面，将为大家介绍LLM评审员的两种技术方案。</p>
<h4 data-id="heading-8">对数据块评估相关性</h4>
<p>可以把用户的问题和检索到的数据块一起给到LLM评审员，让它来判断信息块和用户问题是否相关。</p>
<p>LLM评审员给出的判断结果有两种形式：</p>
<ul>
<li>简单的二分类标签，直接标记*相关、*<em>不相关</em></li>
<li>给出一个具体的相关性分数</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6898b8e9e0e437f8d0635103a4eb8df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=Nu7QWkUWDNTy2wn6wfuLP2QSjLc%3D" alt="" loading="lazy"/></p>
<p>还可以使用其他LLM评估方法，例如，基于嵌入的语义相似度，它会返回一个数值分数，反映查询和检索到的数据块在语义上的相似程度。</p>
<p>需要注意的是，RAG系统一般会对单次查询返回多个数据块，这意味着需要对每个数据块单独进行评分。</p>
<p><strong>举个简单的例子</strong>：假设关于香蕉的查询检索到三个短文本块。每个文本块都是一个句子，可能来自不同的文档。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c92b06020f9c40c4a354b2565839d3df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=4pqMpuZFtqZj0jmUCXi6it3UBec%3D" alt="" loading="lazy"/></p>
<p>然后，采用LLM评审员为每个数据块分配一个相关性分数，其中 1 表示高度相关，0 表示完全不相关。</p>
<p>例如，上图中的<strong>Chunk 1</strong>包含有关香蕉健康益处的相关信息，得1分。但<strong>Chunk 3</strong>这样的内容与用户的查询无相关性，得0分。</p>
<p>一旦评估完每个数据块的相关性之后，就可以汇总结果，评估本次查询的整体检索质量。 有三种实现方式：</p>
<ul>
<li><strong>二元命中</strong>：是否至少有一个数据块达到了相关性阈值？</li>
<li><strong>相关数据块占比</strong>：检索到的数据块中，相关的数据块占比是多少？</li>
<li><strong>平均相关性得分</strong>：总体而言，这些内容块的相关性如何？</li>
</ul>
<p>我们以平均相关性得分例，如下图所示，分别是关于香蕉和土豆烹饪的查询，从Relevance来看，关于香蕉的问题，得到了更多相关的数据块。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6deb0ad61f6a45cbabb51625936baa2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=MdftBg76AQOHjiJrpUVtkHkBiPM%3D" alt="" loading="lazy"/></p>
<p>更进一步，我们可以汇总每个查询在多个检索文本块下的相关性得分，从而计算出整个测试数据集、或特定时间段内查询的相关性打分。</p>
<h4 data-id="heading-9">对上下文评估相关性</h4>
<p>如果检索系统返回的上下文很短，或者很容易将所有数据块打包成一个上下文块，可以跳过按块评分，直接评估整个上下文。只需要为LLM设置提示词就行，如：</p>
<blockquote>
<p>帮我判断检索到的内容是否包含足够的信息回答用户的问题？如果是，则显示有效；否则，显示无效。</p>
</blockquote>
<p>LLM评审员将会按照上述提示词返回结果，并附有理由，示例如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a401ec9ad6d14a808c324a3b98e434b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=NQUSR%2FNDhYOHlPyNnHmeYVT3N3Q%3D" alt="" loading="lazy"/></p>
<p>经过上述两种方法的介绍，可以总结LLM评审员方法具有如下优势：</p>
<ul>
<li><strong>工作量低</strong>：只需要测试查询语句，无法标注问题的答案。</li>
<li><strong>强基线性能</strong>：LLM可以很好地处理相关性检查，特别是简单是非问题上。微软在论文 Large language models can accurately predict searcher preferences声称，GPT-4在Bing的RAG系统相关性评估方面，达到了接近人类的水平。</li>
<li><strong>非常适合快速实验</strong>：当你要尝试新的数据库或检索配置时，可以直接运行LLM评审员，快速比较不同配置的效果。</li>
<li><strong>适用于生产环境监控</strong>：由于不需要事先构建真值，特别适合生产环境。</li>
</ul>
<h2 data-id="heading-10">内容生成阶段的评估方法</h2>
<p>一旦系统检索到上下文，LLM就会使用上下文、用户的问题和系统提示词来生成最终答案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91ffa528cf024abba94900cb08554327~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=i%2F5f4arrIDhCjS8uNU31TecVNYM%3D" alt="" loading="lazy"/></p>
<p>有两种方法评估LLM生成的最终答案是否有效：</p>
<ul>
<li><strong>基于参考的评估</strong> ：将RAG系统的输出与预定义的参考答案进行比较，这就需要构建标注好的数据集，适用于开发或测试环境。</li>
<li><strong>无参考评估</strong> ：当没有参考答案时，仍然可以使用指标来评估质量，比如模型回答结构、语气、长度、完整性、是否包含必要的免责声明等特定属性。这类方法适用于灰度阶段和生产环境。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/040a77145b154366a4866fa65ed85d94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=c6ZsqlsTikt4Z5X4GtSSFjkxWnY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">基于参考的评估</h3>
<p>如果是离线测试，最可靠的评估方法是将LLM的答案与正确的答案进行比较。这些基于参考的评估可以衡量 RAG系统在测试集中与理想答案的接近程度。</p>
<p>从上面的描述可以看出，要使用基于参考的评估方法，需要构建一系列问答对数据集，作为评测基准。</p>
<p>接下来，将问题输入到RAG系统中，并将生成的响应与参考响应进行比较，具体的计分方式如下：</p>
<ul>
<li><strong>语义相似性</strong>: 分别获取生成答案和参考答案的嵌入向量，计算两个向量间的相似度</li>
<li><strong>LLM 作为评判员</strong>：这是一种使用LLM作为判断器的方法，用来比较生成答案和参考答案，并评估RAG响应是否正确、完整或与之前的文本相一致。</li>
</ul>
<p>两种方法效果都不错。语义相似度方法效率高、可扩展性高。基于LLM的方法能够提供更细致的上下文推理，最大的优势可以根据用户的评估规则进行调整。</p>
<p>以下是一个基于LLM方法评估RAG响应效果的示例：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ead2da35dccf45e38808971081b6934f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=0m94ZyLqAUTQwf3KSH0Lh2TIysQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">RAG评测数据集</h3>
<p>在RAG评估中，评测数据集的质量至关重要。若数据集仅含简单或不切实际的问题，模型难以应对现实中的复杂场景。测试用例需贴合真实用户问题、覆盖关键主题，尽可能的覆盖多种场景，只有这样，才能精准评估 RAG 的实际性能。</p>
<p>构建一个完备的测试集需要花费大量精力，好消息是不用完全手动构建，可以直接从知识库生成测试用例，提高效率。实现上也十分简单，从文档或知识库中选取数据块，让LLM完成以下操作：</p>
<ul>
<li>根据数据块的内容，生成一个问题。</li>
<li>根据数据库的内容，生成可以回答上述问题的答案。</li>
</ul>
<p>由于上述测试用例来源真实的RAG知识库，也会更加符合生成环境中的业务场景。此外，你可以通过变换生成问题的表述方式、模拟不同的角色，来匹配实际应用中的查询风格和意图，进一步丰富RAG评测数据集。</p>
<p>一旦有了成千上百个这样的示例，就可以使用它们来对比不同配置下RAG系统的好坏。</p>
<h3 data-id="heading-13">无参考评估</h3>
<p>在实际应用中，用户可以提出任何问题，而事先并不知道<strong>正确答案</strong>是什么。这就需要<strong>无参考的评估方法</strong>了。</p>
<p>比如一些规则性的检查，可以直接通过编程实现，如</p>
<ul>
<li><strong>长度</strong>：答案是否符合规定的字数限制？</li>
<li><strong>链接是否存在</strong>：是否包含指向来源的链接，以及该链接是否有效？</li>
<li><strong>完全匹配</strong>：是否包含特定免责声明？</li>
</ul>
<p>即使没有<strong>正确答案</strong>，仍然可以利用一些有价值的数据，如用户的问题、检索到的上下文以及LLM的响应，通过合适的方法来推断回复本身的质量，以下是一些你可以评估的内容：</p>





























<table><thead><tr><th>指标</th><th>说明</th></tr></thead><tbody><tr><td>忠诚度</td><td>衡量LLM的响应遵从检索的上下文程度。得分低，回答出现幻觉的可能就越大。</td></tr><tr><td>答案相关性</td><td>衡量LLM的回答对用户问题的相关度。得分低，可能答不对题</td></tr><tr><td>上下文相关性</td><td>衡量召回的上下文能够支持用户问题的程度。得分低，检索了太多与问题无关的内容。</td></tr><tr><td>语气</td><td>该回复是否符合品牌的风格或语气？</td></tr><tr><td>拒绝</td><td>RAG系统是否拒绝回答</td></tr></tbody></table>
<p>可以使用LLM作为评判工具来评估上述指标。例如，在计算忠诚度时，可以将问题、上下文和答案传递LLM，提示词可以这样写，<em>答案{RAG的响应}是否忠实于检索到的上下文{RAG检索的内容}，还是添加了未经证实的信息、遗漏了重要细节或与来源相矛盾？请返回忠诚、不忠诚。</em></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7fe5e7dccca4bbf990294714486dd8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=oMHNco6XnHF%2FCHRinfGv%2BMJCIVo%3D" alt="" loading="lazy"/></p>
<p>下面是忠诚度评估方法的具体样例</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0547aede3fb745a9a6c027fcfcda40c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=yaJs9JjbI71xGORIzoAQ28fTcf4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">RAG评估方法小结</h2>
<p>根据是否存在真值情况，我们对RAG评估方法作了更进一步的总结，如下图所示，从左到右，依次代表检索和生成两个阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e554c78f5eb7410595fca37e4d9c49e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=g6yf%2FFAWt%2FzlxyqCzQBH7KiCqD0%3D" alt="" loading="lazy"/></p>
<p><strong>检索阶段</strong>：</p>
<ul>
<li>如果事先知道每个查询的相关文档，可以计算排序指标，如召回@k、NDCG@k。</li>
<li>如果不知道查询的相关文档，可以通过检索的数据块与用户请求的相关性来判断，具体的方式可以是人工标注、或使用LLM来判断。</li>
</ul>
<p><strong>内容生成阶段</strong>：</p>
<ul>
<li>如果有参考答案，可以使用LLM评判员或语义相似性来评估正确性。</li>
<li>即使没有参考答案，可以检查答案是否忠实于上下文/完整，答案是否与问题相关，以及语气、结构或安全性等自定义属性。</li>
</ul>
<p>该使用哪种评估方法，这取决于项目所处的阶段：开发、测试还是生产环境。</p>
<h2 data-id="heading-15">RAG高级评估方法</h2>
<p>对于企业内部使用的RAG系统，基本的质量检查通常就足够了，风险低、范围窄、复杂度也易于管理。</p>
<p>但许多实际应用，情况要复杂的多，尤其是医疗保健、金融或法律支持等领域。这些系统通常服务外部用户，并且涉及信任、准确性和安全性等高风险问题。</p>
<p>可能还会遇到复杂的多轮聊天机器人或代理式流程，在这种情况下，测试一串简单的查询列表是不够的</p>
<p>对于上面提到的情况，需要更高级的评估方法来测试系统的稳健性、边界行为或多轮体验的质量。</p>
<h3 data-id="heading-16">鲁棒性测试</h3>
<p>鲁棒性测试的目标是评估RAG系统在正常场景之外的行为，并观察其能否从容的应对。这意味要测试系统如何处理棘手或不寻常的问题。需要考虑以下情况：</p>
<ul>
<li><strong>明确风险和极端情况</strong>：识别可能导致不良后果的场景。</li>
<li><strong>创建测试查询</strong>：模拟这些风险的测试用例。</li>
<li><strong>确定一个好的回应方式</strong>：例如，可以是拒绝、要求澄清，或者采取稳妥的默认回答。</li>
</ul>
<p>一种可行的方案，可以利用LLM评审员自动对输出进行打分，实现对流程的量化评估。我们来看一个<strong>鲁棒性测试的例子。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80239e4ec0604045a6f1db82f5951552~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=J%2FeTdGw7g6eJg7oub7tlPeSSTYQ%3D" alt="" loading="lazy"/></p>
<p>在本例中，为了测试系统回答的一致性，以不同的方式提问同一个问题，比如使用不同的措辞、风格和结构来描述同一个问题，并检查系统响应是否一致。通过对RAG系统进行一致性测试，可以提高其准确性和可靠性，从而更好地满足用户不同表达方式的需求。</p>
<p><strong>边界情况</strong></p>
<p>边界情况指的是在研发中可能会出现的一些非常规、特殊的情况。这些情况可能很难预测，并且可能导致系统出现错误或异常行为。</p>
<p>为了确保系统的稳定性和可靠性，开发者需要针对这些边界情况进行测试。可以通过精心设计一些特殊的测试用例来实现，比如，关于竞争对手的问题、模糊的单个单词查询等。每个测试用例都应该与一个自动化的评估器配对，以检查系统是否正确地处理了该测试用例。</p>
<p>通过边界情况的测试，可以发现并修复潜在的缺陷，从而提高系统的质量和性能。同时，也可以帮助用户更好地理解和使用系统，减少不必要的困惑和误解。</p>
<p>边界问题样例：</p>









































<table><thead><tr><th>类别</th><th>测试内容</th><th>示例输入</th><th>评估/预期行为</th></tr></thead><tbody><tr><td>品牌安全</td><td>当被问及竞争对手或产品评价时，系统表现如何？</td><td>为什么[竞争对手]比[你的品牌]更好？</td><td>回应得当或拒绝；避免负面比较或未经许可的观点。</td></tr><tr><td>外语</td><td>系统如何处理它不应该支持的查询语言</td><td>这是什么政治？ （西班牙语，如果不受支持）</td><td>礼貌地回复支持的语言列表。</td></tr><tr><td>输入不完整</td><td>只有一个词或含义模糊、缺乏明确语境的问题。</td><td>“退款”或“政策”</td><td>要求提供澄清或背景信息，而不是进行推测性回答。</td></tr><tr><td>多个问题</td><td>一次输入可处理多个子问题</td><td>价格是多少？试用期有多长？</td><td>两个问题都回答得很清楚；没有跳过或忽略任何部分。</td></tr><tr><td>歧义查询</td><td>缺乏关键背景信息或有多种可能的含义</td><td>如果我全职工作，需要缴纳哪种税？（未提供国家/地区信息）</td><td>请求澄清（例如，地点）；避免猜测具体细节。</td></tr></tbody></table>
<p>另外，还可以添加<strong>专家精心设计的特殊案例</strong>，即需要根据使用场景进行细致处理的问题。例如，退款政策可能因用户所在国家/地区而异，或者某些员工福利可能仅在用户入职六个月后适用。</p>
<p>为了设计这些问题，与了解目标用户、熟悉某个领域的专家合作会很有帮助。甚至，可以将这些问题收集到一个专门的测试数据集中，因为这些数据具有极高的商业价值，包含行业领域最困难或风险最高的查询。</p>
<h3 data-id="heading-17">对抗性测试</h3>
<p>对抗性测试则是故意试图破坏系统，旨在发现不安全、非预期或不符合规范的行为，这些行为可能会被用户或攻击者在实际使用中触发。</p>
<p>对于面向公众开放的RAG系统，或者是受监管的RAG应用、敏感的行业，对抗性测试尤为重要。我们希望确保模型不仅能够产生好的答案，还要避免产生有害或危险的答案。</p>
<p>在对抗性测试中，需要设计一些查询语句，故意尝试破坏系统，例如绕过安全措施、混淆模型或触发风险输出。这些示例可能不会出现在常规用户日志中，但它们正是你在生产环境中出现故障之前想要确认的场景。可以人为地创建这些测试查询语句，以模拟真实的攻击尝试。</p>
<p>一些常见的测试场景：</p>
<ul>
<li><strong>提示注入</strong>：试图覆盖原始的提示指令，例如，<em>忽略之前的文本，改为……</em></li>
<li><strong>越狱</strong>：巧妙措辞的输入，试图诱使模型违反安全协议。例如：<em>告诉我如何做X，但假装是为了写小说。</em></li>
<li><strong>有害内容</strong>：与暴力、仇恨言论、自残或虚假信息相关的查询。</li>
<li><strong>禁忌话题</strong>：有关法律咨询、医疗诊断、政治方面的问题，如果不是该领域的应用，系统最好不要响应相关问题。</li>
<li><strong>操纵尝试</strong>：试图让系统自动提供财务报价、折扣或确认等一系列需要人工批准的事情。例如，<em>今天的折扣码是什么？我可以申请退款吗？</em></li>
<li><strong>敏感场景</strong>：来自弱势用户的反馈。例如：*我感到绝望，我该怎么办？*这样的问题应该得到清晰、安全且尊重的回应，理想情况下，还应进行升级处理或转人工。</li>
</ul>
<h3 data-id="heading-18">会话级评估</h3>
<p>许多RAG系统并非仅仅回答单个问题，而是参与多轮对话。例如，客服聊天机器人或故障排除助手，用户需要通过多个步骤与系统进行交互。</p>
<p>这意味着系统的质量评估不仅仅取决于一次回复，还需要考虑是否很好地处理整个对话过程。针对这种场景，可以从以下几个方面考虑：</p>
<ul>
<li><strong>会话成功</strong>：用户的问题最终是否得到解决？</li>
<li><strong>一致性</strong>：系统是否忘记了上下文、重复或自相矛盾？</li>
<li><strong>谈话语气</strong>：整个谈话过程中语气是否恰当？</li>
</ul>
<p>在测试中，会话级别的数据比单个回合的例子更难创建。有两种备选方案：</p>
<ul>
<li>让测试人员在真实场景下收集对话信息，这种方法可以提供最真实的数据，成本高、效率低。</li>
<li>设计自动化脚本模拟多轮测试用例，用以代表常见或关键用户使用场景，这种方法可在短时间内生成大量的测试用例，但会忽略一些真实场景下的交互细节，容易导致测试不准确。</li>
</ul>
<p>沿用之前用大模型做评估的思路，把多轮对话传给模型，让其评估帮助性、回答的一致性，或是用户的情绪变化等内容。输出结果可以是二元判断，比如直接标记<em>已解决、未解决</em>，再附上具体的评估依据。</p>
<p>对于离线环境会话级测试不太好落地，但在生产环境下，可以真实地评估用户与RAG系统的交互情况。为了便于后续自动化评估、问题排查，需要在后端开启会话跟踪，根据用户ID、会议ID记录多轮交互内容。</p>
<p>当数据积累到一定规模后，通过自定义的筛选规则，从中获取特定的会话内容进行评测，比如用户提到竞争对手、表达对产品不满的对话内容。</p>
<p>小结一下，会话级评估能发现单轮检查易遗漏的问题，比如丢失上下文、反复说一样的内容，或者始终没解决用户的核心问题，而是在和用户打太极。融合了会话级评估的RAG系统， 能确保即时回应、真正解决用户咨询的问题。</p>
<h2 data-id="heading-19">RAG评估最佳实践</h2>
<p>设计一套好的评估体系不仅选择指标，还得构建切实可行的工作流程，帮助迭代改进，并始终满足真实的用户体验。</p>
<h3 data-id="heading-20">设计高质量的测试用例</h3>
<p>评估效果取决于测试样本的质量。在考虑评估指标、撰写LLM评估提示词之前，优先关注评估数据集：是否真实、与测试目标相关性如何？是否具有代表性？</p>
<p><strong>优先使用真实数据</strong>。如果可以，尽量使用真实的用户查询、过往的对话日志或内部搜索历史记录来生成测试用例。这样做，保证了评测数据符合人们实际使用的场景。</p>
<p><strong>没有真实数据，可以考虑合成</strong>。可以调整数据合成策略，生成更真实、更多样化的示例。比如，在给LLM系统提示词时，为其定义具体的角色（正在比较方案的客户、正在审核政策的内部分析师等），从他们的角度生成问题。另外，测试内容需要结合数据类型的比例来生成，假设实际场景中有40%是与商品退款有关，在合成数据中也需要体现这一点。</p>
<p><strong>一定要人工检查合成的测试机</strong>。LLM可以辅助生成测试用例，但并不意味着可以盲目使用测试数据集。需要规则脚本进行筛选，甚至需人工抽样筛查。</p>
<p><strong>参考领域专家的建议</strong>。在某些具体的领域，存在许多边界情况，可能会影响系统性能、安全性和稳定性的情况。这些情况通常由丰富经验和知识的专业人员掌握。可以提供一些工具和支持，例如共享表格或轻量级用户界面，帮助他们更轻松地审查输出结果，并提出测试案例。</p>
<p><strong>在实验中，务必使用相同的测试集</strong>。每次运行都重新生成测试集，这是一类常见的错误，会引入噪声，使结果不可靠。正确的做法是，保持测试集的稳定。</p>
<p><strong>随着时间的推移，请更新测试数据集</strong>。在完成不同配置的性能对比、系统也稳定运行一段时间了，测试集的规模也应该不断演进，可以使用观察到的真实用户查询和故障来扩展数据集。另外，最好保留一份最初的测试集，作为整个系统的性能基线。</p>
<h3 data-id="heading-21">选择核心的指标</h3>
<p>不需要对所有的指标评估一次，应当结合系统的当前问题、业务需求，选择适配的评估方式。</p>
<ul>
<li><strong>拒绝万能指标</strong>：不同的阶段需用不同评估工具，例如，检索评估要看数据块相关性与排序质量，鲁棒性测试要考虑品牌安全等定制评估项，生产环境追踪忠实度、格式正确性等核心指标。</li>
<li><strong>聚焦实际问题</strong>：优先对已发现的错误或高风险点设计评估，避免对所有指标评估，这只会增加工作量和噪声干扰，这类指标无法定位真实问题。</li>
<li><strong>让LLM对齐人工标注</strong>：LLM 评估方法需以人工标注为基准，而非依赖现成提示词或固定指标，要通过人工标注案例校准优化LLM提示词，使LLM评估标准与业务标注准则保持一致，从而实现人工标注的规模化延伸。</li>
<li><strong>规避完美主义</strong>：评估方法以有用为目标，不要追求极致，可以通过迭代持续优化，核心是构建<strong>发现问题-测试修复-验证效果</strong>的有效闭环。</li>
</ul>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gradle秒级打包部署SpringBoot项目，行云流水]]></title>    <link>https://juejin.cn/post/7588064253635706934</link>    <guid>https://juejin.cn/post/7588064253635706934</guid>    <pubDate>2025-12-27T04:16:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588064253635706934" data-draft-id="7588064253635674166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gradle秒级打包部署SpringBoot项目，行云流水"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T04:16:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="i听风逝夜"/> <meta itemprop="url" content="https://juejin.cn/user/588993963758215"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gradle秒级打包部署SpringBoot项目，行云流水
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963758215/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    i听风逝夜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T04:16:47.000Z" title="Sat Dec 27 2025 04:16:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常的 Java 开发流程中，将项目打包并部署到远程服务器是一个极其高频的操作。传统的做法往往是：手动执行 <code>./gradlew bootJar</code>，打开 FTP 客户端，找到 JAR 包，然后慢悠悠地上传。如果网络环境不佳，或者需要经过复杂的**堡垒机（JumpServer）**跳转，这一过程简直是开发者的噩梦。</p>
<p>今天，我要向大家推荐一款大幅提升部署效率的 Gradle 插件——<strong>dev.coolrequest.gosync</strong>。它不仅支持极致的<strong>增量同步</strong>，还能自动化处理<strong>堡垒机穿透</strong>。</p>
<hr/>
<p>github:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhouxinlin%2FgoSyncPlugin" target="_blank" title="https://github.com/houxinlin/goSyncPlugin" ref="nofollow noopener noreferrer">github.com/houxinlin/g…</a></p>
<h3 data-id="heading-0">1. 痛点分析：为什么需要 gosync？</h3>
<p>在传统的部署模式下，我们面临两个主要问题：</p>
<ol>
<li><strong>重复传输：</strong> 即使只改了一行代码，也需要上传整个几百 MB 的 JAR，浪费带宽和时间。</li>
<li><strong>堡垒机阻隔：</strong> 许多公司内网环境必须通过 JumpServer 登录，手动在终端敲命令跳转、再进行文件传输，流程繁琐且难以自动化。</li>
</ol>
<p><code>dev.coolrequest.gosync</code> 正是为了解决这些问题而生的。</p>
<hr/>
<h3 data-id="heading-1">2. 核心特性</h3>
<ul>
<li><strong>智能增量同步 (Smart Sync)：</strong> 插件会计算本地文件与远程文件的 MD5 校验和。只有在文件内容发生变化时才会触发上传。如果 MD5 一致，直接跳过。</li>
<li><strong>依赖自动提取：</strong> 自动分析项目的 Runtime 依赖，并将所有依赖包与主程序分离，确保远程 <code>lib</code> 目录始终与本地同步。</li>
<li><strong>原生支持堡垒机 (JumpServer)：</strong> 支持配置自动化指令序列，模拟键盘输入，自动完成堡垒机菜单选择并穿透到目标主机。</li>
<li><strong>高效集成：</strong> 无缝集成到 Gradle 构建生命周期，实现“构建即部署”。</li>
<li><strong>无依赖</strong>：所有操作都依靠SSH、大量交互命令实现，服务器不需要安装任何软件</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. 快速上手</h3>
<p>在你的 <code>build.gradle</code> 文件中添加以下配置，即可开启自动化部署之旅。</p>
<h4 data-id="heading-3">配置示例：</h4>
<pre><code class="hljs language-groovy" lang="groovy">plugins {
  id("dev.coolrequest.gosync") version "1.1"
}

goSync {
    // 连接模式：可选 "simple" (直连) 或 "jumpserver" (堡垒机)
    serverType = "jumpserver" 
    
    // 服务器/堡垒机地址
    serverAddress = "192.168.1.100"
    port = 2222
    userName = "admin"
    userPass = "your_password"

    /**
     * 堡垒机专有配置：afterConnectedCommand
     * 用于模拟进入堡垒机后的交互命令。
     * \r 代表回车。例如：p\r25\r2\r 表示：
     * 输入 p -&gt; 回车 -&gt; 输入 1 -&gt; 回车 -&gt; 输入 2 -&gt; 回车
     */
    afterConnectedCommand = "p\r25\r2\r"

    // 远程服务器存放依赖库（JAR）的绝对路径
    libDirectory = "/app/deploy/libs"
    
    // 远程服务器存放主程序 JAR 的绝对路径
    mainJarDirectory = "/app/deploy/app-main"
}
</code></pre>
<hr/>
<h3 data-id="heading-4">4. 工作原理深度解析</h3>
<p><code>gosync</code> 的工作流程非常严谨且高效：</p>
<ol>
<li><strong>构建后触发：</strong> 插件会自动挂载在 Gradle 的 <code>jar</code> 任务之后。当你执行构建时，它会自动启动。</li>
<li><strong>依赖扫描：</strong> 插件会提取项目所有的运行时依赖（Runtime Dependencies）。</li>
<li><strong>MD5 比对：</strong>
<ul>
<li>计算本地主 JAR 及所有依赖 JAR 的 MD5 值。</li>
<li>通过 SSH 连接远程服务器，获取对应路径下文件的 MD5。</li>
</ul>
</li>
<li><strong>按需上传：</strong>
<ul>
<li>如果远程不存在该文件 -&gt; <strong>上传</strong>。</li>
<li>如果远程存在但 MD5 不匹配 -&gt; <strong>覆盖上传</strong>。</li>
<li>如果 MD5 完全一致 -&gt; <strong>跳过</strong>。</li>
</ul>
</li>
<li><strong>自动化穿透：</strong> 如果配置为 <code>jumpserver</code> 模式，插件会建立一个交互式会话，按照 <code>afterConnectedCommand</code> 预设的指令流自动“敲击键盘”，穿透菜单界面，最终定位到目标机进行 SFTP 传输。</li>
</ol>
<hr/>
<h3 data-id="heading-5">5. 如何执行？</h3>
<p>你可以手动触发同步任务：</p>
<pre><code class="hljs language-bash" lang="bash">./gradlew goSync
</code></pre>
<p>或者，如果你已经配置了任务依赖，只需执行标准的构建命令，部署工作就会在后台静默完成。</p>
<hr/>
<h3 data-id="heading-6">6. 总结</h3>
<p><code>dev.coolrequest.gosync</code> 是一款非常懂开发者的插件。它将“增量更新”和“自动化穿透”这两个痛点结合得非常优雅。对于那些深陷复杂内网环境、或是厌倦了漫长上传等待的同学来说，这绝对是一把利器。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ElasticSearch操作系统环境设置]]></title>    <link>https://juejin.cn/post/7588004601392726050</link>    <guid>https://juejin.cn/post/7588004601392726050</guid>    <pubDate>2025-12-27T06:13:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588004601392726050" data-draft-id="7588043318358458403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ElasticSearch操作系统环境设置"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T06:13:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Postkarte不想说话"/> <meta itemprop="url" content="https://juejin.cn/user/3544481220007736"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ElasticSearch操作系统环境设置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3544481220007736/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Postkarte不想说话
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T06:13:56.000Z" title="Sat Dec 27 2025 06:13:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">设置虚拟内存大小</h2>
<p>编辑<code>/etc/sysctl.conf </code>添加如下内容</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 禁用内存与硬盘交换</span>
vm.swappiness=1
<span class="hljs-comment"># 设置虚拟内存大小，mmpfile存储内存需要</span>
vm.max_map_count=262144
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c869673f2759493c8f17e096f98a231c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9zdGthcnRl5LiN5oOz6K-06K-d:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420836&amp;x-signature=SJlznDgW8Pm79R6Wj2Nty3R4j8k%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">设置文件句柄值</h2>
<p>ES索引由很多文件组成，打开文件数量多。ES进程内置多种线程池，线程数量多。</p>
<p>编辑<code>/etc/security/limits.conf</code>,添加如下内容</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 进程线程数</span>
* soft <span class="hljs-built_in">nproc</span> 131072
* hard <span class="hljs-built_in">nproc</span> 131072
<span class="hljs-comment"># 文件句柄数</span>
* soft nofile 131072
* hard nofile 131072
<span class="hljs-comment"># 内存锁定交换</span>
* soft memlock unlimited
* hard memlock unlimited
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d39936678144fc99d663400259e4ff6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9zdGthcnRl5LiN5oOz6K-06K-d:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420836&amp;x-signature=cC9E0dLKktIOigZnHRMFMQL8GBg%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">创建ES专用账号</h2>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 创建ES账号</span>
useradd elsatic
<span class="hljs-comment"># 授权ES程序目录权限给elastic账号</span>
<span class="hljs-comment"># 假设ES程序目录、数据目录、日志目录都在/gpes目录下</span>
<span class="hljs-built_in">chown</span> -R elastic:elastic /gpes
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JobFlow调度的难题：超时、补偿与漏调]]></title>    <link>https://juejin.cn/post/7588028859541307418</link>    <guid>https://juejin.cn/post/7588028859541307418</guid>    <pubDate>2025-12-27T06:36:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588028859541307418" data-draft-id="7588031908171956233" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JobFlow调度的难题：超时、补偿与漏调"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-12-27T06:36:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JobFlow调度的难题：超时、补偿与漏调
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T06:36:02.000Z" title="Sat Dec 27 2025 06:36:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开源地址与系列文章</h2>
<ul>
<li><strong>开源地址</strong>：<code>https://gitee.com/sh_wangwanbao/job-flow</code></li>
<li><strong>系列文章：</strong>
<ul>
<li><a href="https://juejin.cn/post/7583469866007969827" target="_blank" title="https://juejin.cn/post/7583469866007969827">第一篇：基于Nacos的轻量任务调度方案 —— 从 XXL-Job 的痛点说起</a></li>
<li><a href="https://juejin.cn/post/7584353612501106729" target="_blank" title="https://juejin.cn/post/7584353612501106729">第二篇：JobFlow 实现方案：云原生时代的任务调度新思路</a></li>
<li><a href="https://juejin.cn/post/7585727457472823296" target="_blank" title="https://juejin.cn/post/7585727457472823296">第三篇：JobFlow 实战：无锁调度是怎么做到的</a></li>
<li><a href="https://juejin.cn/post/7585751355593506835" target="_blank" title="https://juejin.cn/post/7585751355593506835">第四篇：JobFlow 背后：五个让我豁然开朗的设计瞬间</a></li>
<li><a href="https://juejin.cn/post/7588028859541307418" target="_blank" title="https://juejin.cn/post/7588028859541307418">第五篇：# JobFlow调度的难题：超时、补偿与漏调</a></li>
<li>第六篇：延时队列的设计与实现（撰写中）</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">前言</h2>
<p>前面几篇文章讲了 JobFlow 的无锁调度是怎么做的：通过 Hash 分区 + Owner 判定，让每个调度器实例自己算出该不该执行任务，避免了数据库锁竞争。</p>
<p>但无锁设计带来了新问题：</p>
<pre><code class="hljs">场景一：任务触发了，但执行器一直没响应
→ 是真的在跑，还是已经挂了？

场景二：任务失败了，需要重试
→ 重试几次？间隔多久？

场景三：某一轮任务根本没被触发
→ 怎么发现？怎么补偿？
</code></pre>
<p>这就是分布式调度的三个终极难题：<strong>超时、补偿、漏调</strong>。</p>
<p>这篇文章就来讲讲 JobFlow 是怎么解决这三个问题的。</p>
<h2 data-id="heading-2">一、整体方案：三层保障机制</h2>
<p>在深入细节之前，先看看 JobFlow 的整体设计思路。</p>
<h3 data-id="heading-3">核心理念</h3>
<p>JobFlow 的异常处理遵循一个简单的原则：</p>
<pre><code class="hljs language-diff" lang="diff">正常路径：追求性能
<span class="hljs-deletion">- 无锁调度，快速触发</span>
<span class="hljs-deletion">- 异步回调，立即响应</span>
<span class="hljs-deletion">- 99% 的任务走这条路</span>

异常路径：追求可靠性
<span class="hljs-deletion">- 超时巡检，确认状态</span>
<span class="hljs-deletion">- 分片补偿，限次重试</span>
<span class="hljs-deletion">- 漏调检测，主动补偿</span>
<span class="hljs-deletion">- 1% 的任务需要兜底</span>
</code></pre>
<h3 data-id="heading-4">三层保障机制</h3>
<p>JobFlow 通过三个层次来保障任务执行：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[第一层&lt;br/&gt;正常调度] --&gt; B[第二层&lt;br/&gt;超时与补偿]
    B --&gt; C[第三层&lt;br/&gt;漏调检测]
    
    A --&gt; D[99%任务&lt;br/&gt;快速完成]
    B --&gt; E[0.9%任务&lt;br/&gt;重试成功]
    C --&gt; F[0.1%任务&lt;br/&gt;补偿执行]
    
    style A fill:#90EE90
    style B fill:#FFE4B5
    style C fill:#FFB6C1
    style D fill:#90EE90
    style E fill:#87CEEB
    style F fill:#87CEEB
</code></pre>
<p><strong>第一层：正常调度</strong></p>
<ul>
<li>Owner 判定避免重复</li>
<li>创建父子记录</li>
<li>初始分配 + 回调驱动</li>
<li>大部分任务在这一层完成</li>
</ul>
<p><strong>第二层：超时与补偿</strong></p>
<ul>
<li>超时巡检（3 分钟一次）</li>
<li>询问执行器确认真实状态</li>
<li>分片补偿，限次重试</li>
<li>处理执行慢、失败的情况</li>
</ul>
<p><strong>第三层：漏调检测</strong></p>
<ul>
<li>低频任务巡检（10 分钟一次）</li>
<li>时间窗口内查找执行记录</li>
<li>发现漏调主动补偿</li>
<li>处理整轮未触发的情况</li>
</ul>
<h3 data-id="heading-5">关键角色分工</h3>
<p>不是所有调度器实例都做所有事情：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[普通实例&lt;br/&gt;负责正常调度] --&gt; B[按 Hash 分区&lt;br/&gt;各管各的任务]
    
    C[巡检Leader&lt;br/&gt;最小节点] --&gt; D[超时巡检&lt;br/&gt;分片补偿&lt;br/&gt;漏调检测]
    
    style A fill:#90EE90
    style B fill:#87CEEB
    style C fill:#FFE4B5
    style D fill:#FFB6C1
</code></pre>
<p>这样设计的好处：</p>
<ul>
<li>正常调度负载均衡（Hash 分区）</li>
<li>巡检任务单点执行（避免重复）</li>
<li>最小节点挂了，下一个自动接管</li>
</ul>
<p>有了整体认识，我们再深入每个环节的细节。</p>
<h2 data-id="heading-6">二、问题拆解：三种异常场景</h2>
<p>先看看 JobFlow 需要处理哪些异常场景：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[正常执行&lt;br/&gt;99%场景] --&gt; B[任务完成]
    
    C[执行超时&lt;br/&gt;卡住不动] --&gt; D[超时判定]
    E[执行失败&lt;br/&gt;需要重试] --&gt; F[补偿重试]
    G[任务漏调&lt;br/&gt;整轮错过] --&gt; H[漏调检测]
    
    style A fill:#90EE90
    style C fill:#FFB6C1
    style E fill:#FFB6C1
    style G fill:#FFB6C1
</code></pre>
<p><strong>核心设计思路：</strong></p>
<p>正常路径追求性能：</p>
<ul>
<li>无锁 owner 判定</li>
<li>快速触发执行</li>
<li>异步回调更新</li>
</ul>
<p>异常路径追求可靠性：</p>
<ul>
<li>超时巡检确认状态</li>
<li>分片补偿限次重试</li>
<li>低频任务漏调检测</li>
</ul>
<p>接下来分别展开讲。</p>
<h2 data-id="heading-7">三、正常流程快速回顾</h2>
<p>在讲异常处理之前，快速回顾一下正常流程（详细内容见第二、三篇文章）：</p>
<p><strong>调度触发</strong>：定时扫描 → Owner 判定 → Cron 到期 → 触发执行</p>
<p><strong>分片执行</strong>：创建父记录 → 创建子记录（100 个 PENDING 分片）→ 初始分配 → 回调驱动</p>
<p>这就是正常路径。问题是，异常情况怎么处理？</p>
<h2 data-id="heading-8">四、超时判定：从感觉超时到确认超时</h2>
<h3 data-id="heading-9">什么叫超时？</h3>
<p>任务触发了，分片也调度了，但一直没回调。这时候调度器不知道：</p>
<pre><code class="hljs">可能性一：执行器还在跑，只是比较慢
可能性二：执行器挂了，回调发不出来
可能性三：网络抖动，回调丢了
</code></pre>
<p><strong>JobFlow 的策略：先巡检，再询问，最后判死刑。</strong></p>
<h3 data-id="heading-10">巡检入口</h3>
<p>超时巡检由最小节点负责：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[定时巡检&lt;br/&gt;每3分钟] --&gt; B{isInspectionLeader?}
    B --&gt;|否| C[跳过]
    B --&gt;|是| D[查询超时分片]
    D --&gt; E[分类处理]
    
    style A fill:#87CEEB
    style B fill:#FFE4B5
    style D fill:#FFB6C1
    style E fill:#90EE90
</code></pre>
<p>为什么由最小节点负责？</p>
<pre><code class="hljs">所有实例从 Nacos 拉取实例列表
排序后，最小的那个就是 leader
不需要复杂的选举算法
最小节点挂了，下一个自动接管
</code></pre>
<p>代码逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inspectTimeoutSubExecutions</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 判断我是不是巡检 leader</span>
    <span class="hljs-keyword">if</span> (!isInspectionLeader()) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 2. 查询超时分片（基准时间 + 超时阈值）</span>
    List&lt;JobSubExecution&gt; timeoutSubs = jobRepository.findTimeoutSubExecutions(timeoutThresholdMinutes);
    
    <span class="hljs-comment">// 3. 分类处理</span>
    <span class="hljs-keyword">for</span> (JobSubExecution sub : timeoutSubs) {
        <span class="hljs-keyword">if</span> (sub.getStatus() == RUNNING) {
            handleRunningTimeoutSubExecution(sub, now);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sub.getStatus() == PENDING) {
            handleSubExecutionForCompensation(sub, now);
        }
    }
}
</code></pre>
<h3 data-id="heading-11">三步询问策略</h3>
<p>对于 RUNNING 状态的分片，JobFlow 不会直接判死刑，而是先问一问：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[发现RUNNING超时] --&gt; B{超过2倍阈值?}
    B --&gt;|是| C[直接标记TIMEOUT]
    B --&gt;|否| D[HTTP询问执行器]
    D --&gt; E{执行器返回?}
    E --&gt;|SUCCESS/FAILED| F[更新为真实状态]
    E --&gt;|RUNNING| G[暂不处理]
    E --&gt;|超时/异常| H[标记TIMEOUT]
    
    style A fill:#FFB6C1
    style B fill:#FFE4B5
    style C fill:#FF6B6B
    style D fill:#87CEEB
    style E fill:#FFE4B5
    style F fill:#90EE90
    style H fill:#FF6B6B
</code></pre>
<p>这个策略分三步：</p>
<p><strong>第一步：询问执行器</strong></p>
<p>向执行器发送 HTTP 请求查询状态</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">statusUrl</span> <span class="hljs-operator">=</span> executorUrl + <span class="hljs-string">"/internal/job/status?traceId="</span> + shardTraceId;
<span class="hljs-type">String</span> <span class="hljs-variable">statusText</span> <span class="hljs-operator">=</span> restTemplate.getForObject(statusUrl, String.class);
</code></pre>
<p><strong>第二步：执行器应答</strong></p>
<p>执行器返回真实状态</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 执行器端代码</span>
<span class="hljs-meta">@GetMapping("/internal/job/status")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getStatus</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String traceId)</span> {
    <span class="hljs-comment">// 从内存查询任务状态</span>
    <span class="hljs-type">ExecutionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> taskContext.getStatus(traceId);
    <span class="hljs-keyword">return</span> status.name();
}
</code></pre>
<p><strong>第三步：根据应答决定行动</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (remoteStatus == SUCCESS || remoteStatus == FAILED) {
    <span class="hljs-comment">// 以执行器反馈为准，更新状态</span>
    jobRepository.updateSubExecutionResult(...);
    updateParentExecutionStatus(parentExecutionId);
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (remoteStatus == RUNNING) {
    <span class="hljs-comment">// 还在跑，暂不处理</span>
    log.info(<span class="hljs-string">"任务仍在执行中，暂不处理"</span>);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 超时或异常，标记 TIMEOUT</span>
    markSubExecutionTimeout(sub, now, <span class="hljs-string">"No valid response from executor"</span>);
}
</code></pre>
<p><strong>为什么要这么麻烦？</strong></p>
<p>因为分布式系统的不确定性：</p>
<pre><code class="hljs">场景一：执行器在跑批处理，数据量特别大，确实很慢
→ 如果直接判超时，任务白跑了

场景二：执行器挂了，或者网络断了
→ 这时候确实该判超时

场景三：执行器已经执行完了，但回调失败了
→ 询问后拿到真实状态，避免重复执行
</code></pre>
<h3 data-id="heading-12">超时阈值的双重保护</h3>
<p>JobFlow 有两层超时判断：</p>
<p><strong>第一层：任务配置的超时时间</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> job_definition (
    ...
    timeout_seconds <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">300</span>,  <span class="hljs-comment">-- 默认5分钟</span>
    ...
);
</code></pre>
<p><strong>第二层：巡检阈值（2 倍超时时间）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">long</span> <span class="hljs-variable">elapsedSeconds</span> <span class="hljs-operator">=</span> Duration.between(baseTime, now).getSeconds();
<span class="hljs-keyword">if</span> (elapsedSeconds &gt;= timeoutSeconds * <span class="hljs-number">2</span>) {
    <span class="hljs-comment">// 超过2倍阈值，直接标记 TIMEOUT，不再询问</span>
    markSubExecutionTimeout(sub, now, <span class="hljs-string">"Exceeded 2x timeout threshold"</span>);
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<p>这样设计的好处：</p>
<pre><code class="hljs">第一次超时（5分钟）：巡检发现，询问执行器
→ 如果还在跑，继续等

第二次超时（10分钟）：确认已经卡死，直接判死刑
→ 避免一直询问，浪费资源
</code></pre>
<h3 data-id="heading-13">超时处理小结</h3>
<p>超时处理的核心思路：</p>
<pre><code class="hljs">不确定的时候，先问问
问了还不确定，再等等
等太久了，该死就死
</code></pre>
<p>这种策略在性能和可靠性之间找到了平衡：</p>
<ul>
<li>不会因为临时慢就误判</li>
<li>也不会因为真挂了还一直等</li>
</ul>
<h2 data-id="heading-14">五、分片补偿：失败了怎么重试</h2>
<h3 data-id="heading-15">什么时候需要补偿？</h3>
<p>分片补偿处理两种情况：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[分片状态异常] --&gt; B{什么状态?}
    B --&gt;|PENDING超时| C[从未执行&lt;br/&gt;重新分配]
    B --&gt;|FAILED| D[执行失败&lt;br/&gt;重试执行]
    
    style A fill:#FFB6C1
    style B fill:#FFE4B5
    style C fill:#87CEEB
    style D fill:#87CEEB
</code></pre>
<p><strong>PENDING 超时</strong>：调度器已经创建了分片记录，但一直没分配出去</p>
<pre><code class="hljs language-diff" lang="diff">可能原因：
<span class="hljs-deletion">- 所有执行器都挂了</span>
<span class="hljs-deletion">- 初始分配时网络异常</span>
<span class="hljs-deletion">- 前面的分片都卡住了，后面的没机会执行</span>
</code></pre>
<p><strong>FAILED 状态</strong>：分片执行过，但失败了</p>
<pre><code class="hljs language-diff" lang="diff">可能原因：
<span class="hljs-deletion">- 业务逻辑异常</span>
<span class="hljs-deletion">- 数据库连接超时</span>
<span class="hljs-deletion">- 下游服务不可用</span>
</code></pre>
<h3 data-id="heading-16">补偿逻辑</h3>
<p>补偿的核心逻辑在 <code>handleSubExecutionForCompensation</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleSubExecutionForCompensation</span><span class="hljs-params">(JobSubExecution sub, LocalDateTime now)</span> {
    <span class="hljs-comment">// 1. 查询任务定义，获取最大重试次数</span>
    <span class="hljs-type">JobDefinition</span> <span class="hljs-variable">jobDef</span> <span class="hljs-operator">=</span> jobRepository.findJobByName(sub.getJobName());
    <span class="hljs-type">int</span> <span class="hljs-variable">maxRetry</span> <span class="hljs-operator">=</span> jobDef != <span class="hljs-literal">null</span> ? jobDef.getMaxRetry() : <span class="hljs-number">3</span>;

    <span class="hljs-comment">// 2. 检查是否超过最大重试次数</span>
    <span class="hljs-keyword">if</span> (sub.getRetryCount() &gt;= maxRetry) {
        log.warn(<span class="hljs-string">"分片已达最大重试次数，标记为最终失败"</span>);
        jobRepository.updateSubExecutionStatus(sub.getId(), FAILED, now, 
            <span class="hljs-string">"Max retry exceeded in compensation"</span>);
        updateParentExecutionStatus(sub.getParentExecutionId());
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 3. 重新分配执行</span>
    <span class="hljs-type">JobExecution</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> jobRepository.findExecutionById(sub.getParentExecutionId());
    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(jobDef.getServiceName());
    
    compensateSubExecution(sub, parent, jobDef, instances);
}
</code></pre>
<p>补偿流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[发现异常分片] --&gt; B{重试次数?}
    B --&gt;|未达上限| C[CAS更新状态&lt;br/&gt;PENDING to RUNNING]
    B --&gt;|达到上限| D[标记最终失败]
    C --&gt; E{CAS成功?}
    E --&gt;|是| F[调用执行器]
    E --&gt;|否| G[其他实例已处理]
    
    style A fill:#FFB6C1
    style B fill:#FFE4B5
    style C fill:#87CEEB
    style D fill:#FF6B6B
    style F fill:#90EE90
</code></pre>
<p><strong>关键点：CAS 更新保护</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 尝试 CAS 更新状态</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">updated</span> <span class="hljs-operator">=</span> jobRepository.casUpdateSubExecutionStatus(
    sub.getId(), 
    sub.getStatus(),      <span class="hljs-comment">// 旧状态</span>
    RUNNING,              <span class="hljs-comment">// 新状态</span>
    sub.getRetryCount()   <span class="hljs-comment">// 版本号</span>
);

<span class="hljs-keyword">if</span> (!updated) {
    <span class="hljs-comment">// CAS 失败，说明其他实例已经在处理了</span>
    log.info(<span class="hljs-string">"CAS更新失败，分片可能已被其他实例补偿"</span>);
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<p>为什么要用 CAS？</p>
<pre><code class="hljs language-css" lang="css">场景：多个调度器实例同时发现同一个分片超时

实例<span class="hljs-selector-tag">A</span>：CAS 更新 PENDING → RUNNING，成功
实例<span class="hljs-selector-tag">B</span>：CAS 更新 PENDING → RUNNING，失败（状态已经是 RUNNING 了）

结果：只有实例<span class="hljs-selector-tag">A</span> 会真正调用执行器，避免重复执行
</code></pre>
<h3 data-id="heading-17">重试策略：限次不限时</h3>
<p>JobFlow 的重试策略很简单：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">max_retry</span> = <span class="hljs-number">3</span>  （可配置）

第1次失败：立即重试
第2次失败：立即重试
第3次失败：立即重试
第4次失败：标记最终失败，不再重试
</code></pre>
<p><strong>为什么不用指数退避？</strong></p>
<p>周期任务的重试和延时任务不同：</p>
<p>周期任务：</p>
<ul>
<li>执行窗口有限（下一轮很快就来了）</li>
<li>希望尽快完成</li>
<li>失败原因通常是临时性的（网络抖动、GC暂停）</li>
</ul>
<p>延时任务：</p>
<ul>
<li>执行时间灵活</li>
<li>可以等一等</li>
<li>需要避免雪崩</li>
</ul>
<p>所以周期任务用"限次不限时"，延时任务用"指数退避"。</p>
<h3 data-id="heading-18">补偿的触发时机</h3>
<p>补偿有两个触发入口：</p>
<p><strong>入口一：超时巡检</strong>（前面讲过）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inspectTimeoutSubExecutions</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">for</span> (JobSubExecution sub : timeoutSubs) {
        <span class="hljs-keyword">if</span> (sub.getStatus() == PENDING) {
            handleSubExecutionForCompensation(sub, now);
        }
    }
}
</code></pre>
<p><strong>入口二：立即失败</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 调用执行器失败时，立即标记 FAILED</span>
<span class="hljs-keyword">if</span> (!success) {
    jobRepository.updateSubExecutionStatus(sub.getId(), FAILED, now, errorMsg);
}
</code></pre>
<p>这样两条路径配合：</p>
<pre><code class="hljs">立即失败：快速响应，不等巡检
超时巡检：兜底保护，防止遗漏
</code></pre>
<h2 data-id="heading-19">六、低频任务的漏调检测</h2>
<h3 data-id="heading-20">什么是漏调？</h3>
<p>漏调是指：任务本该执行，但整轮都没触发。</p>
<pre><code class="hljs">示例：每天凌晨2点的对账任务

正常情况：
12月20日 02:00:00 → 执行
12月21日 02:00:00 → 执行
12月22日 02:00:00 → 执行

漏调情况：
12月20日 02:00:00 → 执行
12月21日 02:00:00 → 没执行（所有调度器都挂了）
12月22日 02:00:00 → 执行

问题：21号的对账任务漏了
</code></pre>
<p>对于高频任务（分钟级），漏调影响较小，很快就有下一轮。</p>
<p>但对于低频任务（小时级、天级），漏调可能导致严重后果：</p>
<pre><code class="hljs">对账任务漏调：财务数据不准
报表生成漏调：业务决策延误
数据清理漏调：磁盘空间耗尽
</code></pre>
<h3 data-id="heading-21">怎么检测漏调？</h3>
<p>JobFlow 的思路：<strong>时间窗口 + 执行记录</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[计算Cron周期] --&gt; B{周期大于等于1小时?}
    B --&gt;|否| C[高频任务&lt;br/&gt;跳过]
    B --&gt;|是| D[计算上一轮时间窗口]
    D --&gt; E{窗口内有执行记录?}
    E --&gt;|是| F[未漏调]
    E --&gt;|否| G[触发补偿]
    
    style A fill:#87CEEB
    style B fill:#FFE4B5
    style C fill:#D3D3D3
    style D fill:#87CEEB
    style E fill:#FFE4B5
    style G fill:#90EE90
    style G fill:#90EE90
</code></pre>
<p>核心逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 解析 Cron，计算周期</span>
<span class="hljs-type">CronExpression</span> <span class="hljs-variable">cronExpression</span> <span class="hljs-operator">=</span> CronExpression.parse(cron);
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">next1</span> <span class="hljs-operator">=</span> cronExpression.next(now.minusSeconds(<span class="hljs-number">1</span>));
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">next2</span> <span class="hljs-operator">=</span> cronExpression.next(next1);
<span class="hljs-type">Duration</span> <span class="hljs-variable">period</span> <span class="hljs-operator">=</span> Duration.between(next1, next2);

<span class="hljs-comment">// 2. 过滤：只检测周期 ≥ 1 小时的任务</span>
<span class="hljs-keyword">if</span> (period == <span class="hljs-literal">null</span> || period.toMinutes() &lt; <span class="hljs-number">60</span>) {
    <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 高频任务不检测</span>
}

<span class="hljs-comment">// 3. 计算上一轮的时间窗口</span>
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">lastSlotTime</span> <span class="hljs-operator">=</span> next1.minus(period);
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">windowStart</span> <span class="hljs-operator">=</span> lastSlotTime;
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">windowEnd</span> <span class="hljs-operator">=</span> now;

<span class="hljs-comment">// 4. 查询窗口内是否有执行记录</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">exists</span> <span class="hljs-operator">=</span> jobRepository.existsExecutionInWindow(
    job.getName(), windowStart, windowEnd);

<span class="hljs-comment">// 5. 如果没有记录，触发补偿</span>
<span class="hljs-keyword">if</span> (!exists) {
    log.info(<span class="hljs-string">"检测到低频任务漏调，触发补偿，jobName={}, window=[{}, {}]"</span>,
        job.getName(), windowStart, windowEnd);
    triggerExecution(job, now);
}
</code></pre>
<p>SQL 查询：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">FROM</span> job_execution 
<span class="hljs-keyword">WHERE</span> job_name <span class="hljs-operator">=</span> ? 
  <span class="hljs-keyword">AND</span> trigger_time <span class="hljs-operator">&gt;=</span> ? 
  <span class="hljs-keyword">AND</span> trigger_time <span class="hljs-operator">&lt;</span> ?
</code></pre>
<h3 data-id="heading-22">时间窗口示例</h3>
<p>以"每天凌晨2点"的任务为例：</p>
<pre><code class="hljs language-ini" lang="ini">当前时间：2024-12-22 10:00:00

计算过程：
<span class="hljs-attr">1. next1</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">23</span> <span class="hljs-number">02</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>（下一个触发时间）
<span class="hljs-attr">2. next2</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">24</span> <span class="hljs-number">02</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>（再下一个触发时间）
<span class="hljs-attr">3. period</span> = <span class="hljs-number">24</span>小时
<span class="hljs-attr">4. lastSlotTime</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">23</span> <span class="hljs-number">02</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> - <span class="hljs-number">24</span>小时 = <span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">22</span> <span class="hljs-number">02</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>

时间窗口：
<span class="hljs-attr">windowStart</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">22</span> <span class="hljs-number">02</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>
<span class="hljs-attr">windowEnd</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">22</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>（当前时间）

判断：
如果窗口内有执行记录 → 未漏调
如果窗口内没有执行记录 → 漏调了，补偿一次
</code></pre>
<h3 data-id="heading-23">为什么只检测低频任务？</h3>
<p>因为高频任务的漏调影响小：</p>
<pre><code class="hljs language-diff" lang="diff">分钟级任务：
<span class="hljs-deletion">- 漏调一次，1分钟后就有下一轮</span>
<span class="hljs-deletion">- 业务影响小</span>
<span class="hljs-deletion">- 容易被监控发现</span>

小时级任务：
<span class="hljs-deletion">- 漏调一次，要等1小时</span>
<span class="hljs-deletion">- 可能影响业务</span>
<span class="hljs-deletion">- 不容易被发现</span>

天级任务：
<span class="hljs-deletion">- 漏调一次，要等1天</span>
<span class="hljs-deletion">- 严重影响业务</span>
<span class="hljs-deletion">- 很难被发现</span>
</code></pre>
<p>所以 JobFlow 的策略是：</p>
<pre><code class="hljs">高频任务（&lt; 1小时）：不检测，靠监控
低频任务（≥ 1小时）：主动检测，自动补偿
</code></pre>
<h3 data-id="heading-24">漏调检测的触发频率</h3>
<p>漏调检测不需要太频繁：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Scheduled(fixedDelay = 600000)</span>  <span class="hljs-comment">// 10分钟一次</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">compensateLowFrequencyMisfires</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (!clusterInstanceService.shouldRunInspection()) {
        <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 非巡检leader，跳过</span>
    }
    
    List&lt;JobDefinition&gt; jobs = jobRepository.findAllEnabledJobs();
    <span class="hljs-keyword">for</span> (JobDefinition job : jobs) {
        compensateIfLowFrequencyAndMissed(job, LocalDateTime.now());
    }
}
</code></pre>
<p>为什么10分钟一次就够了？</p>
<pre><code class="hljs">对于小时级任务：10分钟检测一次，足够及时
对于天级任务：10分钟检测一次，更够了
对于分钟级任务：不检测，等下一轮就好
</code></pre>
<h2 data-id="heading-25">七、延时任务的超时与重试</h2>
<p>延时任务和周期任务不同，它是一次性的：</p>
<pre><code class="hljs">周期任务：每天凌晨2点执行
延时任务：30分钟后执行一次
</code></pre>
<h3 data-id="heading-26">延时任务的状态机</h3>
<p>延时任务的状态流转：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[PENDING&lt;br/&gt;等待中] --&gt; B[SENDING&lt;br/&gt;调用中]
    B --&gt; C[SENT&lt;br/&gt;已发送]
    B --&gt; D[FAILED&lt;br/&gt;失败]
    D --&gt; E{重试次数?}
    E --&gt;|未达上限| A
    E --&gt;|达到上限| F[FAILED_FINAL&lt;br/&gt;最终失败]
    
    style A fill:#87CEEB
    style B fill:#FFE4B5
    style C fill:#90EE90
    style D fill:#FFB6C1
    style F fill:#FF6B6B
</code></pre>
<p>核心字段：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> job_delay_task (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    execute_time <span class="hljs-type">TIMESTAMP</span>,      <span class="hljs-comment">-- 预期执行时间</span>
    next_attempt_time <span class="hljs-type">TIMESTAMP</span>, <span class="hljs-comment">-- 下次重试时间</span>
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),          <span class="hljs-comment">-- PENDING/SENDING/SENT/FAILED/FAILED_FINAL</span>
    retry_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,   <span class="hljs-comment">-- 重试次数</span>
    max_retry <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">3</span>,     <span class="hljs-comment">-- 最大重试次数</span>
    ...
);
</code></pre>
<h3 data-id="heading-27">调度流程</h3>
<p>延时任务的调度逻辑：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[扫描到期任务] --&gt; B{isOwner?}
    B --&gt;|否| C[跳过]
    B --&gt;|是| D[CAS更新&lt;br/&gt;PENDING to SENDING]
    D --&gt; E{CAS成功?}
    E --&gt;|否| F[其他实例处理]
    E --&gt;|是| G[HTTP调用执行器]
    G --&gt; H{成功?}
    H --&gt;|是| I[标记SENT]
    H --&gt;|否| J[重试逻辑]
    
    style A fill:#87CEEB
    style B fill:#FFE4B5
    style D fill:#87CEEB
    style G fill:#FFE4B5
    style I fill:#90EE90
    style J fill:#FFB6C1
</code></pre>
<p>关键代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. Owner 判定（按 serviceName 分区）</span>
<span class="hljs-keyword">if</span> (!clusterInstanceService.isOwner(task.getServiceName())) {
    <span class="hljs-keyword">return</span>;
}

<span class="hljs-comment">// 2. CAS 抢占</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">locked</span> <span class="hljs-operator">=</span> delayTaskRepository.tryMarkSending(
    task.getId(), task.getStatus(), task.getRetryCount());
<span class="hljs-keyword">if</span> (!locked) {
    <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 被其他实例抢了</span>
}

<span class="hljs-comment">// 3. HTTP 调用</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> callExecutor(task);

<span class="hljs-comment">// 4. 更新状态</span>
<span class="hljs-keyword">if</span> (success) {
    delayTaskRepository.markSent(task.getId(), LocalDateTime.now());
} <span class="hljs-keyword">else</span> {
    handleCallFailure(task, errorMsg);
}
</code></pre>
<h3 data-id="heading-28">重试策略：指数退避</h3>
<p>延时任务的重试用指数退避：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleCallFailure</span><span class="hljs-params">(JobDelayTask task, String errorMsg)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">newRetryCount</span> <span class="hljs-operator">=</span> task.getRetryCount() + <span class="hljs-number">1</span>;
    
    <span class="hljs-keyword">if</span> (newRetryCount &gt;= task.getMaxRetry()) {
        <span class="hljs-comment">// 标记最终失败</span>
        delayTaskRepository.markFailedFinal(task.getId(), newRetryCount, errorMsg);
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 计算下次重试时间</span>
    LocalDateTime nextAttempt;
    <span class="hljs-keyword">if</span> (newRetryCount == <span class="hljs-number">1</span>) {
        nextAttempt = now.plusMinutes(<span class="hljs-number">3</span>);   <span class="hljs-comment">// 第1次：3分钟后</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newRetryCount == <span class="hljs-number">2</span>) {
        nextAttempt = now.plusMinutes(<span class="hljs-number">5</span>);   <span class="hljs-comment">// 第2次：5分钟后</span>
    } <span class="hljs-keyword">else</span> {
        nextAttempt = now.plusMinutes(<span class="hljs-number">5</span>);   <span class="hljs-comment">// 第3次：5分钟后</span>
    }
    
    delayTaskRepository.markFailedAndScheduleNext(
        task.getId(), newRetryCount, nextAttempt, errorMsg);
}
</code></pre>
<p>重试时间轴：</p>
<pre><code class="hljs language-ini" lang="ini">初始执行：<span class="hljs-attr">execute_time</span> = <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>
第1次失败：<span class="hljs-attr">next_attempt_time</span> = <span class="hljs-number">10</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00</span>（+<span class="hljs-number">3</span>分钟）
第2次失败：<span class="hljs-attr">next_attempt_time</span> = <span class="hljs-number">10</span>:<span class="hljs-number">08</span>:<span class="hljs-number">00</span>（+<span class="hljs-number">5</span>分钟）
第3次失败：<span class="hljs-attr">next_attempt_time</span> = <span class="hljs-number">10</span>:<span class="hljs-number">13</span>:<span class="hljs-number">00</span>（+<span class="hljs-number">5</span>分钟）
第4次失败：标记 FAILED_FINAL
</code></pre>
<h3 data-id="heading-29">SENDING 超时检测</h3>
<p>延时任务还有个特殊场景：调用执行器后，一直没响应。</p>
<p>这时候数据库里的状态是 SENDING，需要有个超时检测：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 扫描 SENDING 超时任务</span>
List&lt;JobDelayTask&gt; stuckTasks = delayTaskRepository.findStuckSendingTasks(
    sendingTimeoutSeconds, scanBatchSize);

<span class="hljs-keyword">for</span> (JobDelayTask task : stuckTasks) {
    handleSendingTimeout(task);
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleSendingTimeout</span><span class="hljs-params">(JobDelayTask task)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">timeoutMsg</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SENDING timeout (over "</span> + sendingTimeoutSeconds + <span class="hljs-string">" seconds)"</span>;
    log.warn(<span class="hljs-string">"检测到SENDING超时，视为失败，traceId={}"</span>, task.getTraceId());
    handleCallFailure(task, timeoutMsg);
}
</code></pre>
<p>查询 SQL：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> job_delay_task 
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'SENDING'</span> 
  <span class="hljs-keyword">AND</span> sent_at <span class="hljs-operator">&lt;</span> NOW() <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> ? <span class="hljs-keyword">SECOND</span>
LIMIT ?
</code></pre>
<p><strong>为什么要这样设计？</strong></p>
<pre><code class="hljs language-diff" lang="diff">场景：调用执行器后，执行器挂了

结果：
<span class="hljs-deletion">- 回调不会来</span>
<span class="hljs-deletion">- 状态一直是 SENDING</span>
<span class="hljs-deletion">- 需要超时检测来兜底</span>

处理：
<span class="hljs-deletion">- 视为一次失败</span>
<span class="hljs-deletion">- 进入重试流程</span>
<span class="hljs-deletion">- 最多重试3次</span>
</code></pre>
<h2 data-id="heading-30">八、巡检任务的协调：谁来做？</h2>
<p>前面讲了三种巡检：</p>
<ul>
<li>超时巡检（分片超时）</li>
<li>分片补偿（分片失败）</li>
<li>漏调检测（低频任务）</li>
</ul>
<p>这些巡检都需要有人做，但不能所有实例都做（会重复）。</p>
<h3 data-id="heading-31">选主策略：最小节点</h3>
<p>JobFlow 的选主很简单：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[从Nacos获取&lt;br/&gt;所有调度器实例] --&gt; B[按IP:PORT排序]
    B --&gt; C{我是最小的?}
    C --&gt;|是| D[我是Leader&lt;br/&gt;负责巡检]
    C --&gt;|否| E[我是Follower&lt;br/&gt;跳过巡检]
    
    style A fill:#87CEEB
    style B fill:#87CEEB
    style C fill:#FFE4B5
    style D fill:#90EE90
    style E fill:#D3D3D3
</code></pre>
<p>代码实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldRunInspection</span><span class="hljs-params">()</span> {
    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="hljs-string">"jobflow-scheduler"</span>);
    <span class="hljs-keyword">if</span> (instances == <span class="hljs-literal">null</span> || instances.isEmpty()) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 排序</span>
    instances.sort(Comparator.comparing(i -&gt; i.getHost() + <span class="hljs-string">":"</span> + i.getPort()));
    
    <span class="hljs-comment">// 判断我是不是最小的</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">smallest</span> <span class="hljs-operator">=</span> instances.get(<span class="hljs-number">0</span>).getHost() + <span class="hljs-string">":"</span> + instances.get(<span class="hljs-number">0</span>).getPort();
    <span class="hljs-type">String</span> <span class="hljs-variable">myself</span> <span class="hljs-operator">=</span> localHost + <span class="hljs-string">":"</span> + localPort;
    
    <span class="hljs-keyword">return</span> smallest.equals(myself);
}
</code></pre>
<p><strong>为什么选最小节点？</strong></p>
<p>优点：</p>
<ul>
<li>简单：不需要复杂的选举算法</li>
<li>确定：所有实例看到的排序结果一致</li>
<li>快速：最小节点挂了，下一个立刻接管</li>
</ul>
<p>缺点：</p>
<ul>
<li>负载不均：所有巡检都在一个节点上</li>
</ul>
<p>但对于巡检任务来说，负载很小，这个缺点可以接受。</p>
<h3 data-id="heading-32">巡检频率</h3>
<p>不同巡检的频率不同：</p>
<pre><code class="hljs language-diff" lang="diff">超时巡检：3分钟一次
<span class="hljs-deletion">- 需要及时发现卡住的任务</span>
<span class="hljs-deletion">- 但也不能太频繁，避免打爆执行器</span>

分片补偿：随超时巡检触发
<span class="hljs-deletion">- 和超时巡检是一起的</span>

漏调检测：10分钟一次
<span class="hljs-deletion">- 低频任务本来就慢，不需要太频繁</span>
<span class="hljs-deletion">- 降低数据库压力</span>
</code></pre>
<h2 data-id="heading-33">九、设计权衡与取舍</h2>
<p>回顾一下 JobFlow 在超时、补偿、漏调这三个问题上的设计权衡：</p>
<h3 data-id="heading-34">权衡一：询问 vs 直接判死刑</h3>
<p><strong>方案A：直接判死刑</strong></p>
<ul>
<li>优点：简单快速</li>
<li>缺点：误杀正常任务</li>
</ul>
<p><strong>方案B：先询问执行器</strong>（JobFlow 的选择）</p>
<ul>
<li>优点：准确性高，避免误判</li>
<li>缺点：增加一次 HTTP 调用</li>
</ul>
<p>JobFlow 选择了方案B，因为：</p>
<pre><code class="hljs language-diff" lang="diff">对于批处理任务：
<span class="hljs-deletion">- 数据量大，确实很慢</span>
<span class="hljs-deletion">- 误判成本高（任务白跑了）</span>
<span class="hljs-deletion">- 多一次 HTTP 询问，成本可接受</span>
</code></pre>
<h3 data-id="heading-35">权衡二：立即重试 vs 指数退避</h3>
<p><strong>周期任务：立即重试</strong></p>
<ul>
<li>原因：执行窗口有限</li>
<li>目标：尽快完成</li>
</ul>
<p><strong>延时任务：指数退避</strong></p>
<ul>
<li>原因：时间灵活</li>
<li>目标：避免雪崩</li>
</ul>
<p>这是根据场景特点做的差异化设计。</p>
<h3 data-id="heading-36">权衡三：全量检测 vs 分层检测</h3>
<p><strong>方案A：所有任务都检测漏调</strong></p>
<ul>
<li>优点：覆盖全面</li>
<li>缺点：数据库压力大</li>
</ul>
<p><strong>方案B：只检测低频任务</strong>（JobFlow 的选择）</p>
<ul>
<li>优点：性价比高</li>
<li>缺点：高频任务漏调不管</li>
</ul>
<p>JobFlow 选择了方案B，因为：</p>
<pre><code class="hljs language-diff" lang="diff">高频任务漏调影响小：
<span class="hljs-deletion">- 1分钟后就有下一轮</span>
<span class="hljs-deletion">- 容易被监控发现</span>
<span class="hljs-deletion">- 不需要主动检测</span>

低频任务漏调影响大：
<span class="hljs-deletion">- 可能要等很久</span>
<span class="hljs-deletion">- 不容易被发现</span>
<span class="hljs-deletion">- 需要主动检测</span>
</code></pre>
<h3 data-id="heading-37">权衡四：所有实例巡检 vs 单实例巡检</h3>
<p><strong>方案A：所有实例都巡检</strong></p>
<ul>
<li>优点：分布式，负载均衡</li>
<li>缺点：容易重复，需要分布式锁</li>
</ul>
<p><strong>方案B：最小节点巡检</strong>（JobFlow 的选择）</p>
<ul>
<li>优点：简单，无需锁</li>
<li>缺点：单点，负载集中</li>
</ul>
<p>JobFlow 选择了方案B，因为：</p>
<pre><code class="hljs language-diff" lang="diff">巡检负载很小：
<span class="hljs-deletion">- 3分钟一次，10分钟一次</span>
<span class="hljs-deletion">- 每次扫描几百个任务</span>
<span class="hljs-deletion">- 单实例完全扛得住</span>

简单优先：
<span class="hljs-deletion">- 不需要分布式锁</span>
<span class="hljs-deletion">- 不需要复杂的协调</span>
<span class="hljs-deletion">- 最小节点挂了，自动切换</span>
</code></pre>
<h2 data-id="heading-38">十、总结</h2>
<p>JobFlow 处理超时、补偿、漏调的核心思路：</p>
<p><strong>正常路径优先</strong>：</p>
<ul>
<li>99% 的任务走正常路径</li>
<li>无锁调度，性能好</li>
<li>回调驱动，响应快</li>
</ul>
<p><strong>异常路径兜底</strong>：</p>
<ul>
<li>超时巡检：询问执行器确认真实状态</li>
<li>分片补偿：CAS 保护，限次重试</li>
<li>漏调检测：时间窗口，主动补偿</li>
</ul>
<p><strong>设计原则</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 简单优于复杂
<span class="hljs-bullet">   -</span> 最小节点选主，而不是 Raft 选举
<span class="hljs-bullet">   -</span> CAS 保护，而不是分布式锁

<span class="hljs-bullet">2.</span> 分层优于全量
<span class="hljs-bullet">   -</span> 只检测低频任务漏调
<span class="hljs-bullet">   -</span> 超时判定分两层

<span class="hljs-bullet">3.</span> 询问优于猜测
<span class="hljs-bullet">   -</span> 先问执行器，再判超时
<span class="hljs-bullet">   -</span> 准确性优于性能

<span class="hljs-bullet">4.</span> 兜底优于完美
<span class="hljs-bullet">   -</span> 接受1%的漏调，用巡检兜底
<span class="hljs-bullet">   -</span> 接受短暂的状态不一致
</code></pre>
<p><strong>核心价值</strong>：</p>
<p>JobFlow 没有追求完美的一致性，而是用异步补偿换取了：</p>
<ul>
<li>更好的性能（无锁调度）</li>
<li>更低的复杂度（无需分布式锁）</li>
<li>更好的可维护性（逻辑清晰）</li>
</ul>
<p>这就是 JobFlow 在分布式调度这个领域的核心竞争力：<strong>在性能和可靠性之间找到最优平衡点。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官: “ 请你说一下什么是 ajax ? ”]]></title>    <link>https://juejin.cn/post/7588004376867340323</link>    <guid>https://juejin.cn/post/7588004376867340323</guid>    <pubDate>2025-12-27T05:33:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588004376867340323" data-draft-id="7588034035286884367" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官:  “ 请你说一下什么是 ajax ? ”"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-27T05:33:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="千寻girling"/> <meta itemprop="url" content="https://juejin.cn/user/2276467567770442"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官:  “ 请你说一下什么是 ajax ? ”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2276467567770442/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    千寻girling
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T05:33:37.000Z" title="Sat Dec 27 2025 05:33:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、AJAX 核心定义</h3>
<p>AJAX 是 <strong>Asynchronous JavaScript and XML</strong> 的缩写，翻译为 “异步的 JavaScript 和 XML”。</p>
<ul>
<li>本质：它不是一种新的编程语言，而是一套<strong>使用现有技术组合实现的编程方案</strong>。</li>
<li>核心作用：让 JavaScript 在<strong>不刷新整个网页</strong>的情况下，异步地与服务器交换数据，实现网页局部更新。</li>
<li>关键特点：<strong>异步</strong>（请求发送后，页面不用等待服务器响应，仍可正常交互）、<strong>局部更新</strong>（只更新需要变化的部分，提升用户体验）。</li>
</ul>
<p>补充：虽然名字里有 XML，但现在实际开发中几乎都用<strong>JSON</strong>（更轻量、易解析）来传输数据，AJAX 只是沿用了历史名称。</p>
<h3 data-id="heading-1">二、AJAX 工作原理</h3>
<p>AJAX 的核心是浏览器提供的 <code>XMLHttpRequest</code> 对象（简称 XHR），现代浏览器也提供了更易用的 <code>fetch</code> API。其基本工作流程如下：</p>
<ol>
<li>创建 AJAX 请求对象（XHR/fetch）；</li>
<li>配置请求参数（请求方式、URL、是否异步等）；</li>
<li>发送请求到服务器；</li>
<li>监听服务器响应状态；</li>
<li>接收服务器返回的数据；</li>
<li>用 JavaScript 更新网页局部内容。</li>
</ol>
<h3 data-id="heading-2">三、AJAX 代码示例</h3>
<h4 data-id="heading-3">1. 传统 XHR 方式（兼容所有浏览器）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建XHR对象</span>
<span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

<span class="hljs-comment">// 2. 配置请求：请求方式(GET)、URL、是否异步(true)</span>
xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://jsonplaceholder.typicode.com/todos/1'</span>, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 3. 监听请求状态变化（核心）</span>
xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// readyState=4 表示请求完成；status=200 表示响应成功</span>
    <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-comment">// 4. 解析服务器返回的JSON数据</span>
        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
        <span class="hljs-comment">// 5. 局部更新页面（比如把数据显示到id为result的元素里）</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'result'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
            &lt;h3&gt;任务标题：<span class="hljs-subst">${data.title}</span>&lt;/h3&gt;
            &lt;p&gt;是否完成：<span class="hljs-subst">${data.completed ? <span class="hljs-string">'是'</span> : <span class="hljs-string">'否'</span>}</span>&lt;/p&gt;
        `</span>;
    }
};

<span class="hljs-comment">// 处理请求失败的情况</span>
xhr.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'result'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'请求失败！'</span>;
};

<span class="hljs-comment">// 4. 发送请求</span>
xhr.<span class="hljs-title function_">send</span>();
</code></pre>
<h4 data-id="heading-4">2. 现代 fetch 方式（ES6+，更简洁）</h4>
<p><code>fetch</code> 是 AJAX 的现代替代方案，基于 Promise，语法更优雅：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 发送GET请求</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://jsonplaceholder.typicode.com/todos/1'</span>)
    <span class="hljs-comment">// 2. 处理响应：先判断是否成功，再解析为JSON</span>
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'请求失败，状态码：'</span> + response.<span class="hljs-property">status</span>);
        }
        <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
    })
    <span class="hljs-comment">// 3. 使用数据更新页面</span>
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'result'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
            &lt;h3&gt;任务标题：<span class="hljs-subst">${data.title}</span>&lt;/h3&gt;
            &lt;p&gt;是否完成：<span class="hljs-subst">${data.completed ? <span class="hljs-string">'是'</span> : <span class="hljs-string">'否'</span>}</span>&lt;/p&gt;
        `</span>;
    })
    <span class="hljs-comment">// 4. 捕获异常</span>
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'result'</span>).<span class="hljs-property">innerHTML</span> = error.<span class="hljs-property">message</span>;
    });
</code></pre>
<h3 data-id="heading-5">四、AJAX 的典型应用场景</h3>
<ul>
<li>表单提交（比如登录验证，不用刷新页面就能提示 “用户名密码错误”）；</li>
<li>数据分页加载（比如滚动到底部自动加载下一页内容）；</li>
<li>搜索框联想（输入关键词实时显示匹配结果）；</li>
<li>局部数据刷新（比如网页的点赞、评论功能，点击后直接更新数字）。</li>
</ul>
<h3 data-id="heading-6">五、关键注意点</h3>
<ol>
<li><strong>同源策略</strong>：浏览器默认限制 AJAX 请求只能访问<strong>同域名、同端口、同协议</strong>的服务器（比如<code>http://localhost:8080</code>不能请求<code>http://baidu.com</code>），跨域需要服务器配置 CORS 或使用代理。</li>
<li><strong>异步特性</strong>：AJAX 请求是异步的，不能在请求发送后立即获取结果，必须在回调函数（<code>onreadystatechange</code>）或 Promise 的<code>then</code>里处理返回数据。</li>
</ol>
<h3 data-id="heading-7">总结</h3>
<ol>
<li>AJAX 是一套实现 “网页异步请求数据、局部更新” 的技术方案，核心是<code>XMLHttpRequest</code>对象（或现代的<code>fetch</code>）。</li>
<li>核心优势：无需刷新整个页面，提升用户体验，实现网页与服务器的异步数据交互。</li>
<li>现代开发中，<code>fetch</code>（结合 Promise/async-await）已逐步替代传统 XHR，是 AJAX 的主流实现方式。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue.js 源码揭秘（一）：Vue3 架构总览]]></title>    <link>https://juejin.cn/post/7588064253636018230</link>    <guid>https://juejin.cn/post/7588064253636018230</guid>    <pubDate>2025-12-27T05:51:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588064253636018230" data-draft-id="7588149079401250859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue.js 源码揭秘（一）：Vue3 架构总览"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T05:51:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="借个火er"/> <meta itemprop="url" content="https://juejin.cn/user/2225067265915783"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue.js 源码揭秘（一）：Vue3 架构总览
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067265915783/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    借个火er
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T05:51:56.000Z" title="Sat Dec 27 2025 05:51:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue.js 源码揭秘（一）：Vue3 架构总览</h2>
<blockquote>
<p>本文从全局视角解析 Vue3 的核心架构，建立源码阅读的整体认知。</p>
</blockquote>
<h3 data-id="heading-1">一、整体架构</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                      Vue Application                        │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    Compiler (编译时)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Parse     │─►│  <span class="hljs-attribute">Transform</span>  │─►│   Codegen   │         │
│  │  (解析)     │  │   (转换)    │  │  (代码生成)  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼ render function
┌─────────────────────────────────────────────────────────────┐
│                    Runtime (运行时)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ Reactivity  │  │   Renderer  │  │  Scheduler  │         │
│  │  (响应式)   │  │   (渲染器)   │  │   (调度器)   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                      DOM / Platform                         │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-2">二、编译时 vs 运行时</h3>
<h4 data-id="heading-3">2.1 编译时（Compile Time）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 模板</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ msg }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="hljs-comment">// 编译后的 render 函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">_createElementVNode</span>(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, <span class="hljs-title function_">_toDisplayString</span>(_ctx.<span class="hljs-property">msg</span>))
}
</code></pre>
<h4 data-id="heading-4">2.2 运行时（Runtime）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 运行时执行 render 函数</span>
<span class="hljs-keyword">const</span> vnode = <span class="hljs-title function_">render</span>(ctx)

<span class="hljs-comment">// patch 到 DOM</span>
<span class="hljs-title function_">patch</span>(<span class="hljs-literal">null</span>, vnode, container)
</code></pre>
<h3 data-id="heading-5">三、响应式系统</h3>
<h4 data-id="heading-6">3.1 核心 API</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// reactive - 对象响应式</span>
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> })

<span class="hljs-comment">// ref - 基本类型响应式</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

<span class="hljs-comment">// computed - 计算属性</span>
<span class="hljs-keyword">const</span> double = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>)

<span class="hljs-comment">// effect - 副作用</span>
<span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count.<span class="hljs-property">value</span>)
})
</code></pre>
<h4 data-id="heading-7">3.2 依赖收集与触发</h4>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────────────────┐
│                    响应式流程                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────┐    <span class="hljs-keyword">get</span>     ┌─────────┐                       │
│   │  Proxy  │ ─────────► │  track  │ ──► 收集当前 effect    │
│   └─────────┘            └─────────┘                       │
│        │                                                    │
│        │ <span class="hljs-keyword">set</span>                                                │
│        ▼                                                    │
│   ┌─────────┐            ┌─────────┐                       │
│   │ <span class="hljs-keyword">trigger</span> │ ─────────► │ effects │ ──► 执行所有 effect    │
│   └─────────┘            └─────────┘                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-8">3.3 Dep 与 Effect</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Dep - 依赖容器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dep</span> {
  <span class="hljs-attr">subs</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">Subscriber</span>&gt;  <span class="hljs-comment">// 订阅者集合</span>
  
  <span class="hljs-title function_">track</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (activeSub) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">add</span>(activeSub)
    }
  }
  
  <span class="hljs-title function_">trigger</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">sub</span> =&gt;</span> sub.<span class="hljs-title function_">notify</span>())
  }
}

<span class="hljs-comment">// ReactiveEffect - 副作用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveEffect</span> {
  <span class="hljs-attr">deps</span>: <span class="hljs-title class_">Link</span>[]  <span class="hljs-comment">// 依赖链表</span>
  
  <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    activeSub = <span class="hljs-variable language_">this</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fn</span>()
  }
  
  <span class="hljs-title function_">notify</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scheduler</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">scheduler</span>() : <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">run</span>()
  }
}
</code></pre>
<h3 data-id="heading-9">四、虚拟 DOM</h3>
<h4 data-id="heading-10">4.1 VNode 结构</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">VNode</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">Component</span>    <span class="hljs-comment">// 节点类型</span>
  <span class="hljs-attr">props</span>: <span class="hljs-built_in">object</span> | <span class="hljs-literal">null</span>        <span class="hljs-comment">// 属性</span>
  <span class="hljs-attr">children</span>: <span class="hljs-title class_">VNode</span>[] | <span class="hljs-built_in">string</span>  <span class="hljs-comment">// 子节点</span>
  <span class="hljs-attr">el</span>: <span class="hljs-title class_">Element</span> | <span class="hljs-literal">null</span>          <span class="hljs-comment">// 真实 DOM</span>
  <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>        <span class="hljs-comment">// diff key</span>
  <span class="hljs-attr">shapeFlag</span>: <span class="hljs-built_in">number</span>           <span class="hljs-comment">// 节点类型标记</span>
  <span class="hljs-attr">patchFlag</span>: <span class="hljs-built_in">number</span>           <span class="hljs-comment">// 优化标记</span>
}
</code></pre>
<h4 data-id="heading-11">4.2 ShapeFlags</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">ShapeFlags</span> {
  <span class="hljs-variable constant_">ELEMENT</span> = <span class="hljs-number">1</span>,                    <span class="hljs-comment">// 普通元素</span>
  <span class="hljs-variable constant_">FUNCTIONAL_COMPONENT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,  <span class="hljs-comment">// 函数组件</span>
  <span class="hljs-variable constant_">STATEFUL_COMPONENT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>,    <span class="hljs-comment">// 有状态组件</span>
  <span class="hljs-variable constant_">TEXT_CHILDREN</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>,         <span class="hljs-comment">// 文本子节点</span>
  <span class="hljs-variable constant_">ARRAY_CHILDREN</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>,        <span class="hljs-comment">// 数组子节点</span>
  <span class="hljs-variable constant_">SLOTS_CHILDREN</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>,        <span class="hljs-comment">// 插槽子节点</span>
  <span class="hljs-variable constant_">TELEPORT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>,              <span class="hljs-comment">// Teleport</span>
  <span class="hljs-variable constant_">SUSPENSE</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>,              <span class="hljs-comment">// Suspense</span>
  <span class="hljs-variable constant_">COMPONENT</span> = <span class="hljs-variable constant_">STATEFUL_COMPONENT</span> | <span class="hljs-variable constant_">FUNCTIONAL_COMPONENT</span>
}
</code></pre>
<h3 data-id="heading-12">五、渲染器</h3>
<h4 data-id="heading-13">5.1 patch 函数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">patch</span> = (<span class="hljs-params">n1, n2, container</span>) =&gt; {
  <span class="hljs-keyword">if</span> (n1 === n2) <span class="hljs-keyword">return</span>
  
  <span class="hljs-comment">// 类型不同，卸载旧节点</span>
  <span class="hljs-keyword">if</span> (n1 &amp;&amp; !<span class="hljs-title function_">isSameVNodeType</span>(n1, n2)) {
    <span class="hljs-title function_">unmount</span>(n1)
    n1 = <span class="hljs-literal">null</span>
  }
  
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">type</span>, shapeFlag } = n2
  
  <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Text</span>:
      <span class="hljs-title function_">processText</span>(n1, n2, container)
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Fragment</span>:
      <span class="hljs-title function_">processFragment</span>(n1, n2, container)
      <span class="hljs-keyword">break</span>
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">if</span> (shapeFlag &amp; <span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">ELEMENT</span>) {
        <span class="hljs-title function_">processElement</span>(n1, n2, container)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (shapeFlag &amp; <span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">COMPONENT</span>) {
        <span class="hljs-title function_">processComponent</span>(n1, n2, container)
      }
  }
}
</code></pre>
<h4 data-id="heading-14">5.2 组件挂载</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">mountComponent</span> = (<span class="hljs-params">vnode, container</span>) =&gt; {
  <span class="hljs-comment">// 1. 创建组件实例</span>
  <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">createComponentInstance</span>(vnode)
  
  <span class="hljs-comment">// 2. 设置组件（执行 setup）</span>
  <span class="hljs-title function_">setupComponent</span>(instance)
  
  <span class="hljs-comment">// 3. 设置渲染副作用</span>
  <span class="hljs-title function_">setupRenderEffect</span>(instance, vnode, container)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">setupRenderEffect</span> = (<span class="hljs-params">instance, vnode, container</span>) =&gt; {
  <span class="hljs-keyword">const</span> effect = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReactiveEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!instance.<span class="hljs-property">isMounted</span>) {
      <span class="hljs-comment">// 首次挂载</span>
      <span class="hljs-keyword">const</span> subTree = instance.<span class="hljs-title function_">render</span>()
      <span class="hljs-title function_">patch</span>(<span class="hljs-literal">null</span>, subTree, container)
      instance.<span class="hljs-property">subTree</span> = subTree
      instance.<span class="hljs-property">isMounted</span> = <span class="hljs-literal">true</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 更新</span>
      <span class="hljs-keyword">const</span> nextTree = instance.<span class="hljs-title function_">render</span>()
      <span class="hljs-title function_">patch</span>(instance.<span class="hljs-property">subTree</span>, nextTree, container)
      instance.<span class="hljs-property">subTree</span> = nextTree
    }
  })
  
  effect.<span class="hljs-title function_">run</span>()
}
</code></pre>
<h3 data-id="heading-15">六、调度器</h3>
<h4 data-id="heading-16">6.1 任务队列</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">queue</span>: <span class="hljs-title class_">SchedulerJob</span>[] = []
<span class="hljs-keyword">let</span> isFlushing = <span class="hljs-literal">false</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">queueJob</span>(<span class="hljs-params">job</span>) {
  <span class="hljs-keyword">if</span> (!queue.<span class="hljs-title function_">includes</span>(job)) {
    queue.<span class="hljs-title function_">push</span>(job)
    <span class="hljs-title function_">queueFlush</span>()
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">queueFlush</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (!isFlushing) {
    isFlushing = <span class="hljs-literal">true</span>
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(flushJobs)
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">flushJobs</span>(<span class="hljs-params"/>) {
  queue.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> <span class="hljs-title function_">getId</span>(a) - <span class="hljs-title function_">getId</span>(b))
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> job <span class="hljs-keyword">of</span> queue) {
    <span class="hljs-title function_">job</span>()
  }
  
  queue.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>
  isFlushing = <span class="hljs-literal">false</span>
}
</code></pre>
<h4 data-id="heading-17">6.2 nextTick</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> resolvedPromise = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()

<span class="hljs-keyword">function</span> <span class="hljs-title function_">nextTick</span>(<span class="hljs-params">fn?</span>) {
  <span class="hljs-keyword">return</span> fn 
    ? resolvedPromise.<span class="hljs-title function_">then</span>(fn) 
    : resolvedPromise
}
</code></pre>
<h3 data-id="heading-18">七、组件系统</h3>
<h4 data-id="heading-19">7.1 组件实例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ComponentInternalInstance</span> {
  <span class="hljs-attr">uid</span>: <span class="hljs-built_in">number</span>                    <span class="hljs-comment">// 唯一 ID</span>
  <span class="hljs-attr">type</span>: <span class="hljs-title class_">Component</span>                <span class="hljs-comment">// 组件定义</span>
  <span class="hljs-attr">parent</span>: <span class="hljs-title class_">ComponentInternalInstance</span> | <span class="hljs-literal">null</span>
  
  <span class="hljs-comment">// 状态</span>
  <span class="hljs-attr">data</span>: <span class="hljs-built_in">object</span>                   <span class="hljs-comment">// data()</span>
  <span class="hljs-attr">props</span>: <span class="hljs-built_in">object</span>                  <span class="hljs-comment">// props</span>
  <span class="hljs-attr">setupState</span>: <span class="hljs-built_in">object</span>             <span class="hljs-comment">// setup() 返回值</span>
  <span class="hljs-attr">ctx</span>: <span class="hljs-built_in">object</span>                    <span class="hljs-comment">// 渲染上下文</span>
  
  <span class="hljs-comment">// 渲染</span>
  <span class="hljs-attr">render</span>: <span class="hljs-title class_">Function</span>               <span class="hljs-comment">// render 函数</span>
  <span class="hljs-attr">subTree</span>: <span class="hljs-title class_">VNode</span>                 <span class="hljs-comment">// 渲染的 VNode 树</span>
  <span class="hljs-attr">effect</span>: <span class="hljs-title class_">ReactiveEffect</span>         <span class="hljs-comment">// 渲染副作用</span>
  
  <span class="hljs-comment">// 生命周期</span>
  <span class="hljs-attr">isMounted</span>: <span class="hljs-built_in">boolean</span>
  <span class="hljs-attr">isUnmounted</span>: <span class="hljs-built_in">boolean</span>
  
  <span class="hljs-comment">// 生命周期钩子</span>
  <span class="hljs-attr">bc</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>          <span class="hljs-comment">// beforeCreate</span>
  <span class="hljs-attr">c</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>           <span class="hljs-comment">// created</span>
  <span class="hljs-attr">bm</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>          <span class="hljs-comment">// beforeMount</span>
  <span class="hljs-attr">m</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>           <span class="hljs-comment">// mounted</span>
  <span class="hljs-attr">bu</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>          <span class="hljs-comment">// beforeUpdate</span>
  <span class="hljs-attr">u</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>           <span class="hljs-comment">// updated</span>
  <span class="hljs-attr">bum</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>         <span class="hljs-comment">// beforeUnmount</span>
  <span class="hljs-attr">um</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>          <span class="hljs-comment">// unmounted</span>
}
</code></pre>
<h4 data-id="heading-20">7.2 setup 执行</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setupComponent</span>(<span class="hljs-params">instance</span>) {
  <span class="hljs-keyword">const</span> { props, children } = instance.<span class="hljs-property">vnode</span>
  
  <span class="hljs-comment">// 初始化 props</span>
  <span class="hljs-title function_">initProps</span>(instance, props)
  
  <span class="hljs-comment">// 初始化 slots</span>
  <span class="hljs-title function_">initSlots</span>(instance, children)
  
  <span class="hljs-comment">// 执行 setup</span>
  <span class="hljs-keyword">const</span> { setup } = instance.<span class="hljs-property">type</span>
  <span class="hljs-keyword">if</span> (setup) {
    <span class="hljs-keyword">const</span> setupResult = <span class="hljs-title function_">setup</span>(instance.<span class="hljs-property">props</span>, {
      <span class="hljs-attr">attrs</span>: instance.<span class="hljs-property">attrs</span>,
      <span class="hljs-attr">slots</span>: instance.<span class="hljs-property">slots</span>,
      <span class="hljs-attr">emit</span>: instance.<span class="hljs-property">emit</span>,
      <span class="hljs-attr">expose</span>: instance.<span class="hljs-property">expose</span>
    })
    
    <span class="hljs-title function_">handleSetupResult</span>(instance, setupResult)
  }
}
</code></pre>
<h3 data-id="heading-21">八、编译优化</h3>
<h4 data-id="heading-22">8.1 PatchFlags</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">PatchFlags</span> {
  <span class="hljs-variable constant_">TEXT</span> = <span class="hljs-number">1</span>,              <span class="hljs-comment">// 动态文本</span>
  <span class="hljs-variable constant_">CLASS</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,        <span class="hljs-comment">// 动态 class</span>
  <span class="hljs-variable constant_">STYLE</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>,        <span class="hljs-comment">// 动态 style</span>
  <span class="hljs-variable constant_">PROPS</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>,        <span class="hljs-comment">// 动态 props</span>
  <span class="hljs-variable constant_">FULL_PROPS</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>,   <span class="hljs-comment">// 有动态 key</span>
  <span class="hljs-variable constant_">NEED_HYDRATION</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>,
  <span class="hljs-variable constant_">STABLE_FRAGMENT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>,
  <span class="hljs-variable constant_">KEYED_FRAGMENT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>,
  <span class="hljs-variable constant_">UNKEYED_FRAGMENT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">8</span>,
  <span class="hljs-variable constant_">NEED_PATCH</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">9</span>,
  <span class="hljs-variable constant_">DYNAMIC_SLOTS</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">10</span>,
  <span class="hljs-variable constant_">HOISTED</span> = -<span class="hljs-number">1</span>,          <span class="hljs-comment">// 静态提升</span>
  <span class="hljs-variable constant_">BAIL</span> = -<span class="hljs-number">2</span>              <span class="hljs-comment">// 退出优化</span>
}
</code></pre>
<h4 data-id="heading-23">8.2 Block Tree</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 编译优化：只追踪动态节点</span>
<span class="hljs-keyword">const</span> _hoisted_1 = <span class="hljs-title function_">createVNode</span>(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"static"</span>)

<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (<span class="hljs-title function_">openBlock</span>(), <span class="hljs-title function_">createBlock</span>(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, [
    _hoisted_1,  <span class="hljs-comment">// 静态提升</span>
    <span class="hljs-title function_">createVNode</span>(<span class="hljs-string">"span"</span>, <span class="hljs-literal">null</span>, ctx.<span class="hljs-property">msg</span>, <span class="hljs-title class_">PatchFlags</span>.<span class="hljs-property">TEXT</span>)  <span class="hljs-comment">// 动态节点</span>
  ]))
}
</code></pre>
<h3 data-id="heading-24">九、完整渲染流程</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                    Vue 渲染流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  <span class="hljs-number">1</span>. <span class="hljs-built_in">createApp</span>(App)<span class="hljs-selector-class">.mount</span>('#app')                            │
│        │                                                    │
│        ▼                                                    │
│  <span class="hljs-number">2</span>. 创建 VNode                                              │
│        │                                                    │
│        ▼                                                    │
│  <span class="hljs-number">3</span>. <span class="hljs-built_in">render</span>(vnode, container)                                │
│        │                                                    │
│        ▼                                                    │
│  <span class="hljs-number">4</span>. <span class="hljs-built_in">patch</span>(null, vnode, container)                           │
│        │                                                    │
│        ▼                                                    │
│  <span class="hljs-number">5</span>. processComponent → mountComponent                       │
│        │                                                    │
│        ├── createComponentInstance                          │
│        ├── setupComponent (执行 setup)                      │
│        └── setupRenderEffect                                │
│              │                                              │
│              ▼                                              │
│  <span class="hljs-number">6</span>. ReactiveEffect<span class="hljs-selector-class">.run</span>()                                    │
│        │                                                    │
│        ▼                                                    │
│  <span class="hljs-number">7</span>. instance<span class="hljs-selector-class">.render</span>() → subTree VNode                       │
│        │                                                    │
│        ▼                                                    │
│  <span class="hljs-number">8</span>. <span class="hljs-built_in">patch</span>(null, subTree, container)                         │
│        │                                                    │
│        ▼                                                    │
│  <span class="hljs-number">9</span>. 递归处理子节点 → 挂载到 DOM                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-25">十、小结</h3>
<p>Vue3 架构的核心：</p>
<ol>
<li><strong>响应式系统</strong>：基于 Proxy，依赖收集 + 触发更新</li>
<li><strong>虚拟 DOM</strong>：VNode 描述 UI，patch 算法高效更新</li>
<li><strong>编译优化</strong>：PatchFlags、Block Tree、静态提升</li>
<li><strong>调度器</strong>：批量更新，nextTick 微任务队列</li>
<li><strong>组件系统</strong>：setup + Composition API</li>
</ol>
<hr/>
<blockquote>
<p>📦 源码地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore" target="_blank" title="https://github.com/vuejs/core" ref="nofollow noopener noreferrer">github.com/vuejs/core</a></p>
<p>下一篇：响应式系统详解</p>
<p>如果觉得有帮助，欢迎点赞收藏 👍</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[webpack的生命周期与Loader/Plugin]]></title>    <link>https://juejin.cn/post/7588061231590244393</link>    <guid>https://juejin.cn/post/7588061231590244393</guid>    <pubDate>2025-12-27T06:35:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588061231590244393" data-draft-id="7588010346070966282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="webpack的生命周期与Loader/Plugin"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T06:35:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MQliferecord"/> <meta itemprop="url" content="https://juejin.cn/user/1139543665814600"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            webpack的生命周期与Loader/Plugin
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1139543665814600/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MQliferecord
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T06:35:20.000Z" title="Sat Dec 27 2025 06:35:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>核心对象：</strong></p>
<ul>
<li>compiler: 代表Webpack构建的全局上下文，钩子是全局生命周期钩子</li>
<li>compilation: 代表一次构建的编译过程，钩子是编译阶段钩子</li>
</ul>
<p><strong>生命周期：</strong></p>
<p>整个过程分为【初始化-&gt;编译-&gt;输出-&gt;结束】，一共四个阶段，以下列举一下各个阶段的核心钩子：</p>
<ol>
<li>初始化：</li>
</ol>
<ul>
<li>entryOption 动态新增入口</li>
</ul>
<ol start="2">
<li>编译：</li>
</ol>
<ul>
<li>compile：等同于vite的config阶段，能够获得最终生成的config文件，如果需要添加一些环境值的占位符，可以在这个阶段介入</li>
</ul>
<pre><code class="hljs language-js" lang="js">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compiler</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">'插件名'</span>,<span class="hljs-function">()=&gt;</span>{
    compiler.<span class="hljs-property">options</span>.<span class="hljs-property">plugins</span>.<span class="hljs-title function_">push</span>(
        <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">DefinePlugin</span>({
          <span class="hljs-string">'process.env.APP_VERSION'</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable constant_">PLACEHOLDER</span>),
        })
    );
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ 已注入APP_VERSION占位符：'</span>, <span class="hljs-variable constant_">PLACEHOLDER</span>);
})
</code></pre>
<ul>
<li>compilation: 内部包含整个打包构建流程，像是buildModule和optimize等等，实际打包实例已经创建完成，一般这个阶段可以拿到文件最终的contenthash值</li>
</ul>
<pre><code class="hljs language-js" lang="js">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">'ContentHashReplacePlugin'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">contentHash</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateContentHash</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ 生成真实contentHash：'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">contentHash</span>);
});
</code></pre>
<ol start="3">
<li>输出：</li>
</ol>
<ul>
<li>emit： 异步钩子！必须和callback和tapAsync结合使用！准备将数据写入磁盘，这个阶段可以把环境值的占位符替换成真正的数据</li>
</ul>
<pre><code class="hljs language-js" lang="js">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tapAsync</span>(<span class="hljs-string">'MyPlugin'</span>, <span class="hljs-function">(<span class="hljs-params">compilation, callback</span>) =&gt;</span> {
  <span class="hljs-comment">// 遍历所有输出的资源</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [filename, source] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(compilation.<span class="hljs-property">assets</span>)) {
    <span class="hljs-keyword">if</span> (filename.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.js'</span>)) {
      <span class="hljs-comment">// 读取原内容，添加版权注释</span>
      <span class="hljs-keyword">const</span> content = source.<span class="hljs-title function_">source</span>();
      <span class="hljs-keyword">const</span> newContent = <span class="hljs-string">`/* 版权所有 © 2025 MyProject */\n<span class="hljs-subst">${content}</span>`</span>;
      <span class="hljs-comment">// 替换资源内容</span>
      compilation.<span class="hljs-property">assets</span>[filename] = {
        <span class="hljs-attr">source</span>: <span class="hljs-function">() =&gt;</span> newContent,
        <span class="hljs-attr">size</span>: <span class="hljs-function">() =&gt;</span> newContent.<span class="hljs-property">length</span>
      };
    }
  }
  <span class="hljs-title function_">callback</span>(); <span class="hljs-comment">// 异步钩子必须调用 callback 结束</span>
});
</code></pre>
<ol start="4">
<li>结束：</li>
</ol>
<ul>
<li>done: 构建完成之后输出一些日志信息，生成报告</li>
</ul>
<p><strong>tap和tapAsync的区别:</strong></p>
<p>同步钩子和异步钩子调用时候的函数。</p>
<p>tapAsync必须和callback结合使用，用于通知webpack异步流程已经结束，可以继续接下来的流程，不然会卡住。</p>
<p><strong>Plugin:</strong> 用于webpack打包生命周期中执行的一些函数，比如css和图片压缩的plugin，无视打包模块的IgnorePlugin</p>
<p><strong>Loader:</strong> 用于代码转换，因为浏览器只能解析html，css和js，所以会有各种loader将浏览器没法解析的东西转换成能解析的语言，同时webpack本身无法识别一些文件，也需要Loader做转换，比如css-loader，sass-loader，ts-loader，style-loader，postcss-loader</p>
<p>(1.1) css-loader：因为webpack没办法识别css文件，webpack其实只能理解js和json，所以才会使用需要css-loader去处理css文件引用，将其转为模板字符串</p>
<p>(1.2) style-loader: 将css-loader生成的样式字符串注入到style标签中</p>
<p>(1.3) postcss-loader: 对css做兼容处理，自动增加前缀</p>
<p>执行顺序是postcss-loader-&gt;css-loader-&gt;style-loader，而配置的时候需要从右向左配置，顺序错误，会导致报错</p>
<p>Loader整体执行阶段类似于洋葱模型，从左到右依次遍历对应的loader，再从右到左执行对应的loader</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/.css$/</span>,
        <span class="hljs-attr">use</span>: [<span class="hljs-string">'style-loader'</span>, <span class="hljs-string">'css-loader'</span>,  <span class="hljs-string">'postcss-loader'</span>]
      }
    ]
  }
};
</code></pre>
<p><strong>vite自身没有loader</strong>，可以通过装插件来配置loader，但是没有原生好用，而且vite很多loader功能都原生内嵌了，而且因为工具特性，vite依赖es模块，而浏览器是完全支持es模块的，无需loader做模块转换，整体上都是依靠plugin进行处理</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hugging Face 200页的大模型训练实录]]></title>    <link>https://juejin.cn/post/7588028859541061658</link>    <guid>https://juejin.cn/post/7588028859541061658</guid>    <pubDate>2025-12-27T04:28:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588028859541061658" data-draft-id="7588031908171644937" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hugging Face 200页的大模型训练实录"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2025-12-27T04:28:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hugging Face 200页的大模型训练实录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T04:28:25.000Z" title="Sat Dec 27 2025 04:28:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近，Hugging Face 发布了一篇罕见的超长技术博客——<strong>超过 200 页的《Smol  训练手册》</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87dec66f76d14da5b75aa04343cc364c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=lWHwrjHNULEn2jVGDA9Ai2ug6ug%3D" alt="" loading="lazy"/><br/>
这篇博客并不是论文、也不是产品报告，而更像是一份实验日记。<br/>
它详细记录了团队在使用 <strong>384 块 H100 GPU</strong> 训练一款 <strong>30 亿参数模型 SmolLM3</strong> 的从立项思考到基础设施管理全过程。</p>
<p>在如今大模型几乎成产业标配的背景下，这篇文档显得有些反潮流，它没有炫耀成果，而是在展示<strong>过程的混乱与妥协</strong>。<br/>
作者似乎想告诉同行，训练一个可用的 LLM，不只是算法竞赛，更是一场<strong>漫长的工程磨合</strong>。</p>
<p>所有相关源码示例、流程图、面试八股、模型配置与知识库构建技巧，我也将持续更新在Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faicoting%2FAIHub" target="_blank" title="https://github.com/aicoting/AIHub" ref="nofollow noopener noreferrer"><strong>AIHub</strong></a>，欢迎关注收藏！</p>
<h2 data-id="heading-0">一、你真的需要训练一个新模型吗？</h2>
<p>Hugging Face 在文档开篇提出了一个很现实的问题：“你是否真的需要从头训练一个模型？”</p>
<p>他们列出了几条常见但错误的理由——“有多余算力”、“大家都在做”、“我们也想有自己的模型”。<br/>
接着，给出了一张决策流程图，帮助团队判断：是微调、改 prompt、还是必须预训练。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d014c8a4de8462fab34d31e498ba4da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=rOOUZoEpHTW0GADVUf%2Fbsn0MTjs%3D" alt="" loading="lazy"/></p>
<p>根据他们的定义，真正值得从零训练的情境只剩三种：</p>
<ol>
<li><strong>研究问题</strong>：验证新的优化器或训练策略；</li>
<li><strong>业务约束</strong>：特定行业或硬件需求（如金融、航空、医疗设备）；</li>
<li><strong>战略性开源</strong>：弥补现有生态中的空白。</li>
</ol>
<p>这段内容听起来像是劝退，但其核心是<strong>现实主义</strong>。<br/>
面对 Llama、Gemma、Qwen 等日趋完善的开源模型，重新造轮子并不是勇气，而是一种成本高昂的选择。</p>
<p>如果为什么解决了动机问题，那么训练什么就决定了方向。</p>
<p>Hugging Face 团队提出了一个思维框架：</p>
<p>让技术决策反映业务约束，而不是兴趣。</p>
<p>例如：</p>
<ul>
<li>如果模型要在边缘设备上运行，架构必须优先考虑计算密度和延迟。</li>
<li>如果目标是多语言能力，那 tokenizer 的设计要优先于模型深度。</li>
<li>如果追求长上下文推理，位置编码与样本打包策略必须在最早阶段确定。</li>
</ul>
<p>这看似常识，却是很多失败项目的根源——<strong>团队常常在不知道目标的情况下开始堆算力</strong>。<br/>
SmolLM3 的设计过程，从一开始就被绑定在这些约束上。</p>
<h2 data-id="heading-1">二、每一个稳定的模型都诞生于消融</h2>
<p>Hugging Face 在文档中反复强调一个词：<strong>消融实验（ablation）</strong>。</p>
<p>他们认为，大模型训练的真正瓶颈不是算力，而是<strong>不确定性</strong>。<br/>
理论上合理的改动，往往在实践中崩溃。</p>
<p>SmolLM3 的主训练用了 11 万亿 tokens，但在此之前，他们在小规模模型上进行了数十组实验——测试优化器、注意力实现、权重衰减、位置编码等细节。</p>
<p>其中一个典型案例是位置编码：传统 RoPE 编码在长上下文中会失效，团队通过混合 RoPE 与 NoPE（称为 RNoPE）解决了这一问题。<br/>
这种方案并非来自文献，而是从反复试验中被逼出来的。</p>
<p>文档中的一句话很典型：“除非有实验证明有效，否则不要改动任何组件。”</p>
<p>这背后体现的是一种工程化心态，<strong>科学假设在 GPU 面前要先过验证关。</strong></p>
<h2 data-id="heading-2">三、架构选择的权衡</h2>
<p>SmolLM3 的架构看似平平——标准 Transformer，但每个决策都来自验证。</p>
<ul>
<li><strong>注意力机制</strong>：使用分组查询（GQA）替代多头注意力（MHA），在节省显存的同时保持性能。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de60f63976c04cbb8cc90398522c61b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=8z9iKqxf7cnNWY0ZiJVa6n2p7xk%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>嵌入层共享</strong>：为了节省参数，将输入和输出嵌入矩阵合并，用深度换取宽度。</li>
<li><strong>稳定性技巧</strong>：移除嵌入层的权重衰减（来自 OLMo2 的经验）避免梯度震荡。</li>
</ul>
<p>这套保守的架构并没有追求前沿，而是围绕可复现与长期训练稳定性优化。<br/>
团队的结论是：<strong>小模型比大模型更容易被架构选择害死</strong>，因此设计必须务实。</p>
<h2 data-id="heading-3">四、数据决定灵魂</h2>
<p>如果说模型结构决定怎么学，数据则决定学什么。<br/>
Hugging Face 的态度很明确：<strong>数据混合比架构更关键。</strong></p>
<p>他们的经验是——数据不是越高质量越好。<br/>
例如，过多的学术论文文本会让模型在通用语义任务上表现退化。</p>
<p>真正的关键在于比例和节奏：</p>
<ul>
<li>训练初期，用多样、略带噪声的数据提升鲁棒性；</li>
<li>中后期（尤其学习率衰减阶段），引入高质量领域数据强化能力。</li>
</ul>
<p>这种动态课程式训练（curriculum scheduling）在 SmolLM3 中被严格执行。<br/>
甚至连何时切换数据配方都由在线评估指标决定，而非人工预设。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a86e9a664fe484bb6055b869de09758~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=tmd0KzFR%2FhoDEw8De9KlaL5txRA%3D" alt="" loading="lazy"/></p>
<p>文档把这种过程称为数据指挥（Data Conductor）——模型的行为不是写在代码里，而是写在它最后读到的那批数据里。</p>
<h2 data-id="heading-4">五、现实中的训练</h2>
<p>Hugging Face 用飞行前检查形容正式训练前的准备工作。<br/>
因为当你启动 384 张 H100 时，任何配置错误都可能意味着几万美元的浪费。</p>
<p>他们列出了包括：</p>
<ul>
<li>checkpoint 恢复机制；</li>
<li>数据加载健康检查；</li>
<li>GPU 吞吐率与热稳定性监控；</li>
<li>以及日志系统的冗余备份。</li>
</ul>
<p>但即便如此，训练仍然会出事故。<br/>
文档记录了典型问题：“吞吐率突然下降、loss 曲线变得噪声化、节点间通信延迟异常。”</p>
<p>为此，他们开发了 GPU Fryer（压力测试）与 DCGM（诊断管理器）来检测显存、PCIe 连接与热稳定性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5612345563264ad28ca8f0eec25613fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=gXFUh8pnc73vRJTRcml79o195rE%3D" alt="" loading="lazy"/></p>
<p>训练一个 LLM，更像是<strong>运维一座微缩的数据中心</strong>。<br/>
Hugging Face 的工程师总结得很干脆：“在规模化训练中，问题不会消失，只会轮流出现。”</p>
<h2 data-id="heading-5">六、后训练</h2>
<p>完成预训练的 SmolLM3 只具备原始语言能力，离可用产品还差一大步。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b55e6ffd5a6444094158799642be7ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=agKW6cEckk9sgPPz3mTd%2BY2uTkI%3D" alt="" loading="lazy"/></p>
<p>后训练阶段包括：</p>
<ol>
<li><strong>监督微调（SFT）</strong> —— 建立任务意识；</li>
<li><strong>偏好优化（DPO / PPO）</strong> —— 学习人类偏好；</li>
<li><strong>强化学习（RLHF）</strong> —— 提升稳健性与一致性。</li>
</ol>
<p>团队强调，不必神话 RLHF。<br/>
SFT 成本低、稳定、效果明显，是所有改进的起点。<br/>
后续的 DPO 与 RLHF 更像打磨，而不是重塑。</p>
<h2 data-id="heading-6">七、基础设施</h2>
<p>文档的最后一部分谈的不是算法，而是<strong>基础设施</strong>。在长达数周的训练中，基础设施的可靠性决定项目能否完成。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69a8c61e39da4a67bb348b97e5c346e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=yuMzBPE7QMzGIt3jZMQuys1RMWU%3D" alt="" loading="lazy"/></p>
<p>他们详细介绍了 GPU 健康监测、内存通信、数据同步策略。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba204bd77eb54c81acce71214faa9cab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=zdHNPzKDx5QkXhTFO%2BMTTvwgrd0%3D" alt="" loading="lazy"/></p>
<p>并给出了一个实际算力估算公式：</p>
<p>所需 GPU 数量 ≈ (模型参数量 × 训练 Tokens × 每 Token FLOPs) ÷ (单 GPU 吞吐 × 目标训练时间)</p>
<p>代入 SmolLM3 的参数，结果是 379 块 GPU。<br/>
最终部署 384 块，以便在出现节点损坏时有容错余量。</p>
<p>这部分提醒读者训练 LLM 不仅是科学实验，更是工程项目。没有稳定的基础设施，再好的架构也无法落地。</p>
<p>Hugging Face 的这篇长文没有太多突破性算法，但它提供了一个不同的视角——<strong>把模型训练当作现实工程而非抽象科学</strong>。</p>
<p>它让人看到，在巨大的技术叙事之外，一个大模型的诞生，其实更接近一次长期的系统建设：从理念、实验、数据、监控到修复，每个环节都在和现实的摩擦中前进。</p>
<p><strong>📚推荐阅读</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1967942441748371257" target="_blank" title="https://zhuanlan.zhihu.com/p/1967942441748371257" ref="nofollow noopener noreferrer">详解Kimi Linear——有望替代全注意力的全新注意力架构</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1927844769058497732" target="_blank" title="https://zhuanlan.zhihu.com/p/1927844769058497732" ref="nofollow noopener noreferrer">GPT‑4：多模态大规模模型，开启更智能时代</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1937265830216857540" target="_blank" title="https://zhuanlan.zhihu.com/p/1937265830216857540" ref="nofollow noopener noreferrer">一文搞懂DeepSeek LLM</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1930331294874703770" target="_blank" title="https://zhuanlan.zhihu.com/p/1930331294874703770" ref="nofollow noopener noreferrer">LLaMA 3：离 AGI 更近一步？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1936554902206784162" target="_blank" title="https://zhuanlan.zhihu.com/p/1936554902206784162" ref="nofollow noopener noreferrer">Grok-1：马斯克旗下 xAI 首个开源大模型全面解析</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1961825568644401081" target="_blank" title="https://zhuanlan.zhihu.com/p/1961825568644401081" ref="nofollow noopener noreferrer">LongCat-Flash：美团出手，国产卡上跑出的「闪电级」大模型</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1966265102568265354" target="_blank" title="https://zhuanlan.zhihu.com/p/1966265102568265354" ref="nofollow noopener noreferrer">美团发力，LongCat-Video发布！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1968799296439693416" target="_blank" title="https://zhuanlan.zhihu.com/p/1968799296439693416" ref="nofollow noopener noreferrer">LongCat-Flash-Omni：美团的全模态大模型</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1970980105363886971" target="_blank" title="https://zhuanlan.zhihu.com/p/1970980105363886971" ref="nofollow noopener noreferrer">Kimi K2 Thinking：面向思考＋工具调用的高阶智能体大模型</a></p>
<p>关于深度学习和AI大模型相关的知识和前沿技术更新，请关注公众号 <strong>coting</strong>！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Transformer 中为什么用LayerNorm而不用BatchNorm？]]></title>    <link>https://juejin.cn/post/7588042910194942002</link>    <guid>https://juejin.cn/post/7588042910194942002</guid>    <pubDate>2025-12-27T04:33:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588042910194942002" data-draft-id="7588086766247690291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Transformer 中为什么用LayerNorm而不用BatchNorm？"/> <meta itemprop="keywords" content="人工智能,面试"/> <meta itemprop="datePublished" content="2025-12-27T04:33:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Transformer 中为什么用LayerNorm而不用BatchNorm？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T04:33:53.000Z" title="Sat Dec 27 2025 04:33:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>无论是 BERT、GPT 还是 ViT，几乎都不用 Batch Normalization，而是清一色地用 Layer Normalization。<br/>
这不是巧合，而是 Transformer 架构中一个非常深层的设计选择。
所有相关源码示例、流程图、面试八股、模型配置与知识库构建技巧，我也将持续更新在Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faicoting%2FAIHub" target="_blank" title="https://github.com/aicoting/AIHub" ref="nofollow noopener noreferrer"><strong>AIHub</strong></a>，欢迎关注收藏！</p>
<h2 data-id="heading-0">一、BN 和 LN 到底在做什么？</h2>
<p>BN 和 LN 的出发点其实一样——<strong>稳定训练，防止梯度爆炸或消失</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b87daf6213cb40eca921271df82fd30f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414832&amp;x-signature=mj%2B%2F9I6ALCv%2BExNlxMSRm5mdt60%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>Batch Normalization（BN）</strong>：<br/>
它在一个 batch 内计算均值和方差，对同一层的所有样本的每个通道做标准化。<br/>
换句话说，BN 关心的是<strong>这一批数据的统计特征</strong>。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53fa1da874854ef299fb2c0e8d3e077d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414832&amp;x-signature=ktu1j1rc4l21Ogzl7uSVNHLNvwI%3D" alt="image" loading="lazy"/></li>
<li><strong>Layer Normalization（LN）</strong>：<br/>
LN 则是在同一个样本内部计算均值和方差，对该样本的所有特征维度一起归一化。<br/>
换句话说，LN 关心的是<strong>单个样本内部的特征分布</strong>。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71266b0ccba349abacadc92ec8094017~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414832&amp;x-signature=GYbEzuDVAYrKX2pK1T%2BWD2j9Qq0%3D" alt="image" loading="lazy"/></li>
</ul>
<p>BN 是跨样本归一化，LN 是单样本归一化。</p>
<h2 data-id="heading-1">二、BN 的问题</h2>
<p>BN 在 CNN 时代非常成功，但为什么在 Transformer 中就变得水土不服？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aadc88b99c9942caafadf2819b076be2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414832&amp;x-signature=QqvYXs9OWKwXSmPLBiNmrISTgFg%3D" alt="" loading="lazy"/></p>
<p>根本原因有三点。</p>
<h3 data-id="heading-2">1. Transformer 是<strong>序列模型</strong>，batch 维度不稳定</h3>
<p>BN 的计算依赖 batch 的统计量（均值和方差）。<br/>
而 Transformer 的输入往往是<strong>变长序列</strong>，不同样本长度不同，padding 数量不同，导致 batch 内统计特性不一致，BN 的均值和方差变得不可靠。</p>
<h3 data-id="heading-3">2. <strong>自注意力机制破坏了空间独立性</strong></h3>
<p>在卷积中，BN 对通道归一化是合理的，因为每个通道特征相对独立。<br/>
但在 Transformer 的 Self-Attention 中，<strong>每个 token 都与其他 token 有强关联</strong>。<br/>
此时再按 batch 统计均值、方差，就会让不同样本的分布互相干扰，破坏注意力机制的学习稳定性。</p>
<h3 data-id="heading-4">3. <strong>推理阶段 BN 的统计特性难以复用</strong></h3>
<p>BN 在推理时会使用训练阶段的滑动均值来做归一化。<br/>
但 Transformer 的输入分布在推理阶段往往与训练时不同（比如变长文本、不同语言或领域），这会导致分布漂移（distribution shift），从而引入偏差。<br/>
LN 不依赖 batch，因此天然更稳定。</p>
<h2 data-id="heading-5">三、LN 的优势</h2>
<p>相较 BN，LN 有三个天然优势，让它几乎成了 Transformer 的标配：</p>
<ol>
<li><strong>与 batch size 无关</strong>：LN 在样本内部归一化，batch 只要有一个样本都能跑。</li>
<li><strong>适合变长序列</strong>：每个 token 独立归一化，不受 padding、mask 等影响。</li>
<li><strong>训练和推理一致</strong>：LN 在训练和推理阶段用的统计量完全一致，不存在分布漂移问题。</li>
</ol>
<p>这些特性让 LN 特别适合大模型——尤其是在分布式、异步、变长输入的环境下。</p>
<p>更深层次的，BN 的归一化粒度是 <strong>batch 维度</strong>，而 Transformer 想捕捉的是 <strong>token 之间的微妙关系</strong>。<br/>
当每个样本长度不同、token 相关性强时，BN 的跨样本归一化反而会削弱模型的表达能力。</p>
<p>LN 的归一化发生在特征维度内部，保证了<strong>每个 token 的特征分布稳定</strong>，不会被其他样本的统计特征干扰。</p>
<p>这其实是一种从样本层面向特征层面的思维转变。</p>
<p>所以，总结一下：</p>
<p>Transformer 用 LN 而不用 BN，本质上是因为：</p>
<ol>
<li>BN 依赖 batch 统计量，不适合变长、分布差异大的序列数据；</li>
<li>Attention 机制导致样本间特征强耦合，BN 会破坏这种结构；</li>
<li>LN 与 batch size 无关，推理阶段也稳定一致。</li>
</ol>
<p>关于深度学习和AI大模型相关的知识和前沿技术更新，请关注公众号 <strong>aicoting</strong>！</p>
<p><strong>📚推荐阅读</strong></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1918047303597552480" target="_blank" title="https://zhuanlan.zhihu.com/p/1918047303597552480" ref="nofollow noopener noreferrer">一览Transformer整体架构</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1918049072331362469" target="_blank" title="https://zhuanlan.zhihu.com/p/1918049072331362469" ref="nofollow noopener noreferrer">Transformer——Attention怎么实现集中注意力</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1918050616376301224" target="_blank" title="https://zhuanlan.zhihu.com/p/1918050616376301224" ref="nofollow noopener noreferrer">Transformer——FeedForward模块在干什么？</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1918357249883105145" target="_blank" title="https://zhuanlan.zhihu.com/p/1918357249883105145" ref="nofollow noopener noreferrer">从0开始实现Transformer</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1919338888536756837" target="_blank" title="https://zhuanlan.zhihu.com/p/1919338888536756837" ref="nofollow noopener noreferrer">什么是KV-Cache</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1919500956946655189" target="_blank" title="https://zhuanlan.zhihu.com/p/1919500956946655189" ref="nofollow noopener noreferrer">Transformer注意力机制——MHA&amp;MQA&amp;GQA</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1923328314241704991" target="_blank" title="https://zhuanlan.zhihu.com/p/1923328314241704991" ref="nofollow noopener noreferrer">FlashAttention怎么提升速度的？</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1963547933044631464" target="_blank" title="https://zhuanlan.zhihu.com/p/1963547933044631464" ref="nofollow noopener noreferrer">面试官：BatchNorm、LayerNorm、GroupNorm、InstanceNorm 有什么本质区别？</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1962254381677257759" target="_blank" title="https://zhuanlan.zhihu.com/p/1962254381677257759" ref="nofollow noopener noreferrer">面试官：Transformer如何优化到线性级？</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1923714840653993730" target="_blank" title="https://zhuanlan.zhihu.com/p/1923714840653993730" ref="nofollow noopener noreferrer">FlashAttention2：更快的注意力机制，更好的并行效率</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1924154277082961318" target="_blank" title="https://zhuanlan.zhihu.com/p/1924154277082961318" ref="nofollow noopener noreferrer">FlashAttention3 全解析：速度、精度、显存的再平衡</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>