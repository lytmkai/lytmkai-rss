<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[前端工程化 - Vite初始化Vue项目及代码规范配置]]></title>    <link>https://juejin.cn/post/7602816610932277311</link>    <guid>https://juejin.cn/post/7602816610932277311</guid>    <pubDate>2026-02-05T00:40:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602816610932277311" data-draft-id="7602807243705204799" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端工程化 - Vite初始化Vue项目及代码规范配置"/> <meta itemprop="keywords" content="前端工程化,Vite,Vue.js"/> <meta itemprop="datePublished" content="2026-02-05T00:40:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="EchoEcho"/> <meta itemprop="url" content="https://juejin.cn/user/2920774267837208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端工程化 - Vite初始化Vue项目及代码规范配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2920774267837208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    EchoEcho
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:40:58.000Z" title="Thu Feb 05 2026 00:40:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前端工程化是通过工具和规范，提升开发效率、代码质量和团队协作的系统化方案。大致包含以下内容：</p>
<ul>
<li>代码规范</li>
<li>Git Hooks</li>
<li>环境变量</li>
<li>构建优化</li>
</ul>
<p><strong>本文内容包含</strong>：</p>
<ol>
<li><a href="#%E4%BD%BF%E7%94%A8vite%E5%88%9B%E5%BB%BAvue%E9%A1%B9%E7%9B%AE" title="#%E4%BD%BF%E7%94%A8vite%E5%88%9B%E5%BB%BAvue%E9%A1%B9%E7%9B%AE">使用 vite 创建 vue 项目</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%A0%BC%E5%BC%8F%E5%8C%96" title="#%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%A0%BC%E5%BC%8F%E5%8C%96">配置代码规范及相关格式化</a></li>
<li>
<ul>
<li><a href="#%E9%85%8D%E7%BD%AE%E6%A0%BC%E5%BC%8F%E5%8C%96%E6%A0%A1%E9%AA%8C" title="#%E9%85%8D%E7%BD%AE%E6%A0%BC%E5%BC%8F%E5%8C%96%E6%A0%A1%E9%AA%8C">配置格式化校验</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEcss%E6%A0%BC%E5%BC%8F%E6%A0%A1%E9%AA%8C%E5%8F%8A%E5%85%B6%E4%BB%96" title="#%E9%85%8D%E7%BD%AEcss%E6%A0%BC%E5%BC%8F%E6%A0%A1%E9%AA%8C%E5%8F%8A%E5%85%B6%E4%BB%96">配置css格式校验及其他</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BF%9D%E5%AD%98%E6%97%B6%E8%87%AA%E5%8A%A8%E6%A0%BC%E5%BC%8F%E5%8C%96" title="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BF%9D%E5%AD%98%E6%97%B6%E8%87%AA%E5%8A%A8%E6%A0%BC%E5%BC%8F%E5%8C%96">配置文件保存时自动格式化</a></li>
</ul>
</li>
</ol>
<h3 data-id="heading-0">一、使用vite创建vue项目</h3>
<h4 data-id="heading-1">初始化项目</h4>
<pre><code class="hljs language-lua" lang="lua">pnpm <span class="hljs-built_in">create</span> vue
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88ed00619c68491d9489d84685c6a45d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWNob0VjaG8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856857&amp;x-signature=7fR3%2BfLCNkbxF%2BMlc3Grl11J%2B38%3D" alt="图片" loading="lazy"/></p>
<p>按需完善项目结构</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e83dcfc949c04594961ee8f5cca16ac2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWNob0VjaG8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856857&amp;x-signature=cvxCv%2F1KaO7oDkcs%2BWR%2FmX6wKA4%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-2">设置别名</h4>
<p>修改<code>vite.config.ts</code></p>
<pre><code class="hljs language-csharp" lang="csharp">import path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
​
...
resolve: {
    <span class="hljs-keyword">alias</span>: {
        <span class="hljs-string">'@'</span>: path.resolve(__dirname, <span class="hljs-string">'src'</span>),
    }
}
...
</code></pre>
<p>修改<code>tsconfig.app.json</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"."</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-3">为项目添加自动导入</h4>
<pre><code class="hljs language-arduino" lang="arduino">pnpm add -D unplugin-<span class="hljs-keyword">auto</span>-<span class="hljs-keyword">import</span> unplugin-vue-components
</code></pre>
<p>修改<code>vite.config.ts</code></p>
<pre><code class="hljs language-php" lang="php">import AutoImport <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-auto-import/vite'</span>
import Components <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/vite'</span>
​
export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
   <span class="hljs-attr"> plugins</span>: [
        <span class="hljs-title function_ invoke__">vue</span>(),
        // 新增
        <span class="hljs-title function_ invoke__">AutoImport</span>({
           <span class="hljs-attr"> imports</span>: [<span class="hljs-string">'vue'</span>],
           <span class="hljs-attr"> dts</span>: <span class="hljs-string">'./src/auto-imports.d.ts'</span>,
           <span class="hljs-attr"> eslintrc</span>: {
               <span class="hljs-attr"> enabled</span>: <span class="hljs-literal">true</span>,
               <span class="hljs-attr"> filepath</span>: <span class="hljs-string">'./src/.eslintrc-auto-import.json'</span>,
            }
        }),
        // 新增
        <span class="hljs-title function_ invoke__">Components</span>({
           <span class="hljs-attr"> dirs</span>: [<span class="hljs-string">'src/components'</span>],
           <span class="hljs-attr"> extensions</span>: [<span class="hljs-string">'vue'</span>],
           <span class="hljs-attr"> deep</span>: <span class="hljs-literal">true</span>,
           <span class="hljs-attr"> dts</span>: <span class="hljs-string">'./src/components.d.ts'</span>,
           <span class="hljs-attr"> resolvers</span>: []
        })
    ]
})
</code></pre>
<p>修改<code>tsconfig.app.json</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  ...
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"src/**/*.ts"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"src/**/*.tsx"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"src/**/*.vue"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"src/auto-imports.d.ts"</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 新增</span>
    <span class="hljs-string">"src/components.d.ts"</span>     <span class="hljs-comment">// 新增</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-4">二、配置代码规范及相关格式化</h3>
<h4 data-id="heading-5">配置格式化校验</h4>
<blockquote>
<p>统一代码风格，自动检查常见错误和潜在问题</p>
</blockquote>
<ul>
<li>
<p>ESLint: 代码质量检查（语法、最佳实践）</p>
<blockquote>
<p>ESLint 9.x 不再支持 .eslintrc.*，需要使用新的扁平配置格式 eslint.config.js</p>
</blockquote>
</li>
<li>
<p>Prettier: 代码格式化（缩紧、引号、分号等）</p>
</li>
<li>
<p>依赖：</p>
</li>
</ul>

<pre><code class="hljs language-sql" lang="sql">pnpm <span class="hljs-keyword">add</span> <span class="hljs-operator">-</span>D \
eslint \
<span class="hljs-variable">@typescript</span><span class="hljs-operator">-</span>eslint<span class="hljs-operator">/</span>parser \
<span class="hljs-variable">@typescript</span><span class="hljs-operator">-</span>eslint<span class="hljs-operator">/</span>eslint<span class="hljs-operator">-</span>plugin \
eslint<span class="hljs-operator">-</span>plugin<span class="hljs-operator">-</span>vue \
<span class="hljs-variable">@eslint</span><span class="hljs-operator">/</span>js \
vue<span class="hljs-operator">-</span>eslint<span class="hljs-operator">-</span>parser \
prettier \
eslint<span class="hljs-operator">-</span>config<span class="hljs-operator">-</span>prettier \
eslint<span class="hljs-operator">-</span>plugin<span class="hljs-operator">-</span>prettier
</code></pre>
<ul>
<li>配置文件： <code>eslint.config.js</code>、<code>.prettierrc.cjs</code>、<code>.prettierignore</code></li>
<li>脚本：在<code>package.json</code>中添加检验和格式化命令</li>
</ul>
<p>添加<code>eslint.config.js</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> js <span class="hljs-keyword">from</span> <span class="hljs-string">'@eslint/js'</span>
<span class="hljs-keyword">import</span> tsPlugin <span class="hljs-keyword">from</span> <span class="hljs-string">'@typescript-eslint/eslint-plugin'</span>
<span class="hljs-keyword">import</span> tsParser <span class="hljs-keyword">from</span> <span class="hljs-string">'@typescript-eslint/parser'</span>
<span class="hljs-keyword">import</span> vueParser <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-eslint-parser'</span>
<span class="hljs-keyword">import</span> vuePlugin <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-vue'</span>
<span class="hljs-keyword">import</span> prettierConfig <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-config-prettier'</span>
<span class="hljs-keyword">import</span> prettierPlugin <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-prettier'</span>
​
exportdefault [
    <span class="hljs-comment">// 基础配置</span>
    js.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>,
​
    <span class="hljs-comment">// 全局忽略</span>
    {
        <span class="hljs-attr">ignores</span>: [<span class="hljs-string">'node_modules/**'</span>, <span class="hljs-string">'dist/**'</span>, <span class="hljs-string">'*.config.*'</span>, <span class="hljs-string">'pnpm-lock.yaml'</span>],
    },
​
    <span class="hljs-comment">// vue文件配置</span>
    {
        <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.vue'</span>],
        <span class="hljs-attr">languageOptions</span>: {
            <span class="hljs-attr">parser</span>: vueParser,
            <span class="hljs-attr">parserOptions</span>: {
                <span class="hljs-attr">parser</span>: tsParser,
                <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-string">'latest'</span>,
                <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
            },
            <span class="hljs-attr">globals</span>: {
                <span class="hljs-attr">console</span>: <span class="hljs-string">'readonly'</span>,
                <span class="hljs-attr">process</span>: <span class="hljs-string">'readonly'</span>,
            },
        },
        <span class="hljs-attr">plugins</span>: {
            <span class="hljs-attr">vue</span>: vuePlugin,
            <span class="hljs-string">'@typescript-eslint'</span>: tsPlugin,
            <span class="hljs-attr">prettier</span>: prettierPlugin,
        },
        <span class="hljs-comment">/**
         * "off" 或 0    ==&gt;  关闭规则
         * "warn" 或 1   ==&gt;  打开的规则作为警告（不影响代码执行）
         * "error" 或 2  ==&gt;  规则作为一个错误（代码不能执行，界面报错）
         */</span>
        <span class="hljs-attr">rules</span>: {
            ...prettierConfig.<span class="hljs-property">rules</span>,
​
            <span class="hljs-comment">// eslint 规则</span>
            <span class="hljs-string">'no-var'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-comment">// 要求使用 let 或 const 而不是 var</span>
            <span class="hljs-string">'no-multiple-empty-lines'</span>: [<span class="hljs-string">'error'</span>, { <span class="hljs-attr">max</span>: <span class="hljs-number">1</span> }], <span class="hljs-comment">// 不允许多个空行</span>
            <span class="hljs-string">'prefer-const'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 使用 let 关键字声明但在初始分配后从未重新分配的变量，要求使用 const</span>
            <span class="hljs-string">'no-use-before-define'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 禁止在 函数/类/变量 定义之前使用它们</span>
            <span class="hljs-string">'no-param-reassign'</span>: [<span class="hljs-string">'error'</span>, { <span class="hljs-attr">props</span>: <span class="hljs-literal">false</span> }], <span class="hljs-comment">// 禁止修改函数参数</span>
            <span class="hljs-string">'max-classes-per-file'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 禁止类超过一个文件</span>
​
            <span class="hljs-comment">// typescript 规则</span>
            <span class="hljs-string">'@typescript-eslint/no-unused-vars'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-comment">// 禁止定义未使用的变量</span>
            <span class="hljs-string">'@typescript-eslint/no-empty-function'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-comment">// 禁止空函数</span>
            <span class="hljs-string">'@typescript-eslint/prefer-ts-expect-error'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-comment">// 禁止使用 @ts-ignore</span>
            <span class="hljs-string">'@typescript-eslint/ban-ts-comment'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-comment">// 禁止 @ts-&lt;directive&gt; 使用注释或要求在指令后进行描述</span>
            <span class="hljs-string">'@typescript-eslint/no-inferrable-types'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 禁止对初始化为数字、字符串或布尔值的变量或参数进行显式类型声明</span>
            <span class="hljs-string">'@typescript-eslint/no-namespace'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 禁止使用 namespace 声明</span>
            <span class="hljs-string">'@typescript-eslint/no-explicit-any'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 禁止使用 any 类型</span>
            <span class="hljs-string">'@typescript-eslint/ban-types'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 禁止使用 any 类型</span>
            <span class="hljs-string">'@typescript-eslint/no-var-requires'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 禁止使用 require 语句</span>
            <span class="hljs-string">'@typescript-eslint/no-non-null-assertion'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 禁止使用 ! 断言</span>
            <span class="hljs-string">'@typescript-eslint/no-use-before-define'</span>: [
              <span class="hljs-string">'error'</span>,
              {
                <span class="hljs-attr">functions</span>: <span class="hljs-literal">false</span>,
              },
            ],
​
            <span class="hljs-comment">// vue 规则</span>
            <span class="hljs-comment">// 'vue/script-setup-uses-vars': 'error', // 要求在 script setup 中使用已定义的变量</span>
            <span class="hljs-string">'vue/v-slot-style'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-comment">// 要求 v-slot 指令的写法正确</span>
            <span class="hljs-string">'vue/no-mutating-props'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-comment">// 禁止修改组件的 props</span>
            <span class="hljs-string">'vue/custom-event-name-casing'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-comment">// 要求自定义事件名称符合 kebab-case 规范</span>
            <span class="hljs-string">'vue/html-closing-bracket-newline'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 要求 HTML 闭合标签换行</span>
            <span class="hljs-string">'vue/attribute-hyphenation'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-comment">// 对模板中的自定义组件强制执行属性命名样式：my-prop="prop"</span>
            <span class="hljs-string">'vue/attributes-order'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// vue api使用顺序，强制执行属性顺序</span>
            <span class="hljs-string">'vue/no-v-html'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 禁止使用 v-html</span>
            <span class="hljs-string">'vue/require-default-prop'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 此规则要求为每个 prop 为必填时，必须提供默认值</span>
            <span class="hljs-string">'vue/multi-word-component-names'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 要求组件名称始终为 “-” 链接的单词</span>
            <span class="hljs-string">'vue/no-setup-props-destructure'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 禁止解构 props 传递给 setup</span>
            <span class="hljs-string">'vue/max-len'</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 强制所有行都小于 80 个字符</span>
            <span class="hljs-string">'vue/singleline-html-element-content-newline'</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 强制单行元素的内容折行</span>
            
            <span class="hljs-comment">// Prettier 规则</span>
            <span class="hljs-string">'prettier/prettier'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-comment">// 强制使用 prettier 格式化代码</span>
        }
    },
    <span class="hljs-comment">// js文件配置</span>
    {
        <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.{js,jsx,cjs,mjs,ts,tsx,cts,mts}'</span>],
        <span class="hljs-attr">languageOptions</span>: {
            <span class="hljs-attr">parser</span>: tsParser,
            <span class="hljs-attr">parserOptions</span>: {
                <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-string">'latest'</span>,
                <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
            },
            <span class="hljs-attr">globals</span>: {
                <span class="hljs-attr">console</span>: <span class="hljs-string">'readonly'</span>,
                <span class="hljs-attr">process</span>: <span class="hljs-string">'readonly'</span>,
            }
        },
        <span class="hljs-attr">plugins</span>: {
            <span class="hljs-string">'@typescript-eslint'</span>: tsPlugin,
            <span class="hljs-attr">prettier</span>: prettierPlugin,
        },
        <span class="hljs-attr">rules</span>: {
            ...prettierConfig.<span class="hljs-property">rules</span>,
​
            <span class="hljs-comment">// eslint 规则</span>
            <span class="hljs-string">'no-var'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-comment">// 要求使用 let 或 const 而不是 var</span>
            <span class="hljs-string">'no-multiple-empty-lines'</span>: [<span class="hljs-string">'error'</span>, { <span class="hljs-attr">max</span>: <span class="hljs-number">1</span> }], <span class="hljs-comment">// 不允许多个空行</span>
            <span class="hljs-string">'prefer-const'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 使用 let 关键字声明但在初始分配后从未重新分配的变量，要求使用 const</span>
            <span class="hljs-string">'no-use-before-define'</span>: <span class="hljs-string">'off'</span>, <span class="hljs-comment">// 禁止在 函数/类/变量 定义之前使用它们</span>
            <span class="hljs-string">'prettier/prettier'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-comment">// 强制使用 prettier 格式化代码</span>
​
            <span class="hljs-comment">// TypeScript 规则</span>
            <span class="hljs-string">'@typescript-eslint/no-unused-vars'</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-string">'@typescript-eslint/no-empty-function'</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-string">'@typescript-eslint/prefer-ts-expect-error'</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-string">'@typescript-eslint/ban-ts-comment'</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-string">'@typescript-eslint/no-inferrable-types'</span>: <span class="hljs-string">'off'</span>,
            <span class="hljs-string">'@typescript-eslint/no-namespace'</span>: <span class="hljs-string">'off'</span>,
            <span class="hljs-string">'@typescript-eslint/no-explicit-any'</span>: <span class="hljs-string">'off'</span>,
            <span class="hljs-string">'@typescript-eslint/ban-types'</span>: <span class="hljs-string">'off'</span>,
            <span class="hljs-string">'@typescript-eslint/no-var-requires'</span>: <span class="hljs-string">'off'</span>,
            <span class="hljs-string">'@typescript-eslint/no-non-null-assertion'</span>: <span class="hljs-string">'off'</span>,
            <span class="hljs-string">'@typescript-eslint/no-use-before-define'</span>: [
                <span class="hljs-string">'error'</span>,
                {
                    <span class="hljs-attr">functions</span>: <span class="hljs-literal">false</span>,
                },
            ],
            
            <span class="hljs-string">'prettier/prettier'</span>: <span class="hljs-string">'error'</span>,
        }
    }
]
</code></pre>
<p>添加<code>.prettierrc.cjs</code></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * Prettier 代码格式化配置
 * 文档：https://prettier.io/docs/en/configuration.html
 */</span>
<span class="hljs-keyword">module</span>.exports= {
  <span class="hljs-comment">// 是否在语句末尾添加分号</span>
  semi: <span class="hljs-literal">false</span>,
  <span class="hljs-comment">// 是否使用单引号</span>
  singleQuote: <span class="hljs-literal">true</span>,
  <span class="hljs-comment">// 设置缩进</span>
  tabWidth: <span class="hljs-number">2</span>,
  <span class="hljs-comment">// 尾随逗号</span>
  trailingComma: <span class="hljs-string">'es5'</span>,
  <span class="hljs-comment">// 每行最大字符数</span>
  printWidth: <span class="hljs-number">120</span>,
  <span class="hljs-comment">// 箭头函数参数括号： avoid( 避免 ) | always( 总是 )</span>
  arrowParens: <span class="hljs-string">'avoid'</span>,
  <span class="hljs-comment">// 文件行尾： lf( 换行 ) | crlf( 回车换行 ) | auto( 自动 )</span>
  endOfLine: <span class="hljs-string">'lf'</span>,
}
</code></pre>
<p>添加<code>.prettierignore</code></p>
<pre><code class="hljs language-csharp" lang="csharp">node_modules
dist
*.specstory
*.local
pnpm-<span class="hljs-keyword">lock</span>.yaml
package-<span class="hljs-keyword">lock</span>.json
.DS_Store
coverage
.vscode
.idea
<span class="hljs-keyword">public</span>
</code></pre>
<p>在<code>package.json</code>中添加相关<code>scripts</code></p>
<pre><code class="hljs language-json" lang="json">...
<span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  ...
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint . --fix"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prettier --write "</span>src<span class="hljs-comment">/**/</span>*.<span class="hljs-punctuation">{</span>js<span class="hljs-punctuation">,</span>ts<span class="hljs-punctuation">,</span>vue<span class="hljs-punctuation">,</span>json<span class="hljs-punctuation">,</span>css<span class="hljs-punctuation">,</span>scss<span class="hljs-punctuation">,</span>md<span class="hljs-punctuation">}</span><span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint:check"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint ."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"format:check"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prettier --check "</span>src<span class="hljs-comment">/**/</span>*.<span class="hljs-punctuation">{</span>js<span class="hljs-punctuation">,</span>ts<span class="hljs-punctuation">,</span>vue<span class="hljs-punctuation">,</span>json<span class="hljs-punctuation">,</span>css<span class="hljs-punctuation">,</span>scss<span class="hljs-punctuation">,</span>md<span class="hljs-punctuation">}</span><span class="hljs-string">""</span>
<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
...
</code></pre>
<h4 data-id="heading-6">配置<code>css</code>格式校验及其他</h4>
<ul>
<li>Stylelint: <code>css/scss</code>样式校验和格式化，统一样式代码风格，发现样式错误</li>
<li>EditorConfig: 统一编辑器配置，保证跨编辑器保持一致的编码风格</li>
<li>Commitlint: Git 提交信息格式校验，规范提交信息，便于追踪和生成changeling</li>
<li>Husky + lint-staged: Git hooks 自动化校验，代码提交前自动检查，避免提交不符合规范的代码</li>
</ul>
<ol>
<li>
<p>安装相关依赖</p>
<pre><code class="hljs language-arduino" lang="arduino"># 基础依赖（必需）
<span class="hljs-meta"># stylelint-config-html: HTML/Vue模板样式格式化</span>
<span class="hljs-meta"># stylelint-config-recess-order: css属性书写顺序</span>
<span class="hljs-meta"># stylelint-config-recommended-vue: Vue推荐配置</span>
pnpm add -D \
  stylelint \
  stylelint-config-standard \
  stylelint-config-standard-vue \
  stylelint-config-prettier \
  stylelint-config-html \ 
  stylelint-config-recess-order \  
  stylelint-config-recommended-vue \ 
  @commitlint/cli \
  @commitlint/config-conventional \
  husky \
  lint-staged \
  postcss-html 
​
​
# 可选依赖（根据项目需要）
# 如果使用 Tailwind CSS
pnpm add -D stylelint-config-tailwindcss
​
# 如果使用SCSS
pnpm add -D stylelint-config-standard-scss stylelint-scss
</code></pre>
</li>
</ol>

<ol>
<li>
<p>创建<code>.stylelintrc.cjs</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span>= {
  <span class="hljs-comment">// 继承规则</span>
  extends: [
    <span class="hljs-string">'stylelint-config-standard'</span>, <span class="hljs-comment">// 配置 stylelint 拓展插件</span>
    <span class="hljs-string">'stylelint-config-html/vue'</span>, <span class="hljs-comment">// 配置 vue 中 template 样式格式化</span>
    <span class="hljs-string">'stylelint-config-recess-order'</span>, <span class="hljs-comment">// 配置 stylelint css 属性书写顺序插件,</span>
    <span class="hljs-string">'stylelint-config-standard-scss'</span>, <span class="hljs-comment">// 配置 stylelint scss 插件</span>
    <span class="hljs-string">'stylelint-config-recommended-vue/scss'</span>, <span class="hljs-comment">// 配置 vue 中 scss 样式格式化</span>
    <span class="hljs-string">'stylelint-config-tailwindcss'</span>,
  ],
  overrides: [
    <span class="hljs-comment">// 扫描 .vue/html 文件中的 &lt;style&gt; 标签内的样式</span>
    {
      files: [<span class="hljs-string">'**/*.{vue,html}'</span>],
      <span class="hljs-comment">// 使用 postcss-html 解析器</span>
      customSyntax: <span class="hljs-string">'postcss-html'</span>,
    },
  ],
  rules: {
    <span class="hljs-string">'keyframes-name-pattern'</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 强制关键帧名称的格式</span>
    <span class="hljs-string">'custom-property-pattern'</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 强制自定义属性的格式</span>
    <span class="hljs-string">'selector-id-pattern'</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 强制选择器 ID 的格式</span>
    <span class="hljs-string">'declaration-block-no-redundant-longhand-properties'</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 禁止冗余的长属性</span>
    <span class="hljs-string">'function-url-quotes'</span>: <span class="hljs-string">'always'</span>, <span class="hljs-comment">// URL 的引号 "always(必须加上引号)"|"never(没有引号)"</span>
    <span class="hljs-string">'color-hex-length'</span>: <span class="hljs-string">'long'</span>, <span class="hljs-comment">// 指定 16 进制颜色的简写或扩写 "short(16进制简写)"|"long(16进制扩写)"</span>
    <span class="hljs-string">'rule-empty-line-before'</span>: <span class="hljs-string">'never'</span>, <span class="hljs-comment">// 要求或禁止在规则之前的空行 "always(规则之前必须始终有一个空行)"|"never(规则前绝不能有空行)"|"always-multi-line(多行规则之前必须始终有一个空行)"|"never-multi-line(多行规则之前绝不能有空行)"</span>
    <span class="hljs-string">'font-family-no-missing-generic-family-keyword'</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 禁止在字体族名称列表中缺少通用字体族关键字</span>
    <span class="hljs-string">'property-no-unknown'</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 禁止未知的属性</span>
    <span class="hljs-string">'no-empty-source'</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 禁止空源码</span>
    <span class="hljs-string">'selector-class-pattern'</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 强制选择器类名的格式</span>
    <span class="hljs-string">'value-no-vendor-prefix'</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 关闭 vendor-prefix (为了解决多行省略 -webkit-box)</span>
    <span class="hljs-string">'no-descending-specificity'</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 不允许较低特异性的选择器出现在覆盖较高特异性的选择器</span>
    <span class="hljs-comment">// 禁止未知的伪类</span>
    <span class="hljs-string">'selector-pseudo-class-no-unknown'</span>: [
      <span class="hljs-literal">true</span>,
      {
        ignorePseudoClasses: [<span class="hljs-string">'global'</span>, <span class="hljs-string">'v-deep'</span>, <span class="hljs-string">'deep'</span>],
      },
    ],
    <span class="hljs-comment">// 禁止未知的 at-rule</span>
    <span class="hljs-string">'scss/at-rule-no-unknown'</span>: [
      <span class="hljs-literal">true</span>,
      {
        ignoreAtRules: [<span class="hljs-string">'tailwind'</span>, <span class="hljs-string">'apply'</span>],
      },
    ],
    <span class="hljs-comment">// 禁止未知的函数</span>
    <span class="hljs-string">'function-no-unknown'</span>: [
      <span class="hljs-literal">true</span>,
      {
        ignoreFunctions: [<span class="hljs-string">'constant'</span>],
      },
    ],
  },
  ignoreFiles: [<span class="hljs-string">'**/*.js'</span>, <span class="hljs-string">'**/*.ts'</span>, <span class="hljs-string">'**/*.jsx'</span>, <span class="hljs-string">'**/*.tsx'</span>, <span class="hljs-string">'node_modules/**'</span>, <span class="hljs-string">'dist/**'</span>],
}
</code></pre>
</li>
</ol>

<ol>
<li>
<p>创建<code>.editorconfig</code></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># EditorConfig 是帮助多个编辑器和 IDE 维护一致的编码样式的配置文件</span>
<span class="hljs-comment"># https://editorconfig.org</span>
​
<span class="hljs-attr">root</span> = <span class="hljs-literal">true</span>
​
<span class="hljs-section">[*]</span> <span class="hljs-comment"># 表示所有文件适用</span>
<span class="hljs-attr">charset</span> = utf-<span class="hljs-number">8</span> <span class="hljs-comment"># 设置文件字符集为 utf-8</span>
<span class="hljs-attr">end_of_line</span> = lf <span class="hljs-comment"># 设置文件行尾为 LF</span>
<span class="hljs-attr">indent_style</span> = space <span class="hljs-comment"># 缩进风格（tab | space）</span>
<span class="hljs-attr">indent_size</span> = <span class="hljs-number">2</span> <span class="hljs-comment"># 缩进大小</span>
<span class="hljs-attr">insert_final_newline</span> = <span class="hljs-literal">true</span> <span class="hljs-comment"># 在文件末尾插入一个新行</span>
<span class="hljs-attr">trim_trailing_whitespace</span> = <span class="hljs-literal">true</span> <span class="hljs-comment"># 删除行尾的空格</span>
<span class="hljs-attr">max_line_length</span> = <span class="hljs-number">130</span> <span class="hljs-comment"># 最大行长度</span>
​
<span class="hljs-section">[*.md]</span> <span class="hljs-comment"># 表示仅对 md 文件适用以下规则</span>
<span class="hljs-attr">max_line_length</span> = <span class="hljs-literal">off</span> <span class="hljs-comment"># 关闭最大行长度限制</span>
<span class="hljs-attr">trim_trailing_whitespace</span> = <span class="hljs-literal">false</span> <span class="hljs-comment"># 关闭末尾空格修剪</span>
​
<span class="hljs-section">[*.{yml,yaml}]</span>
<span class="hljs-attr">indent_size</span> = <span class="hljs-number">2</span> <span class="hljs-comment"># 设置 yaml 文件的缩进大小为 2</span>
​
<span class="hljs-section">[Makefile]</span>
<span class="hljs-attr">indent_style</span> = tab <span class="hljs-comment"># 设置 Makefile 文件的缩进风格为 tab</span>
</code></pre>
</li>
</ol>

<ol>
<li>
<p>创建<code>commitlint.config.js</code>文件</p>
<pre><code class="hljs language-php" lang="php">exportdefault {
    <span class="hljs-keyword">extends</span>: [<span class="hljs-string">'@commitlint/config-conventional'</span>],
    rules: {
        <span class="hljs-string">'type-enum'</span>: [
            <span class="hljs-number">2</span>,
            <span class="hljs-string">'always'</span>,
            [
                <span class="hljs-string">'feat'</span>, <span class="hljs-comment">// 新功能</span>
                <span class="hljs-string">'fix'</span>, <span class="hljs-comment">// 修复问题</span>
                <span class="hljs-string">'docs'</span>, <span class="hljs-comment">// 文档更新</span>
                <span class="hljs-string">'style'</span>, <span class="hljs-comment">// 代码格式（不影响代码运行的变动）</span>
                <span class="hljs-string">'refactor'</span>, <span class="hljs-comment">// 重构代码（既不是新增功能，也不是修复问题的代码变动）</span>
                <span class="hljs-string">'perf'</span>, <span class="hljs-comment">// 性能优化</span>
                <span class="hljs-string">'test'</span>, <span class="hljs-comment">// 添加测试</span>
                <span class="hljs-string">'chore'</span>, <span class="hljs-comment">// 构建过程或辅助工具的变动</span>
                <span class="hljs-string">'build'</span>, <span class="hljs-comment">// 打包</span>
                <span class="hljs-string">'ci'</span>, <span class="hljs-comment">// CI配置</span>
                <span class="hljs-string">'revert'</span>, <span class="hljs-comment">// 回退</span>
                <span class="hljs-string">'release'</span>, <span class="hljs-comment">// 发布</span>
                <span class="hljs-string">'wip'</span>, <span class="hljs-comment">// 开发中</span>
            ]
        ],
        <span class="hljs-comment">// 类型必须小写</span>
        <span class="hljs-string">'type-case'</span>: [
            <span class="hljs-number">2</span>,
            <span class="hljs-string">'always'</span>,
            <span class="hljs-string">'lower-case'</span>
        ],
        <span class="hljs-comment">// 类型不能为空</span>
        <span class="hljs-string">'type-empty'</span>: [<span class="hljs-number">2</span>, <span class="hljs-string">'never'</span>],
        <span class="hljs-comment">// 作用域必须小写</span>
        <span class="hljs-string">'scope-case'</span>: [
            <span class="hljs-number">2</span>,
            <span class="hljs-string">'always'</span>,
            <span class="hljs-string">'lower-case'</span>
        ],
        <span class="hljs-comment">// 主题必须小写</span>
        <span class="hljs-string">'subject-case'</span>: [
            <span class="hljs-number">2</span>,
            <span class="hljs-string">'always'</span>,
            <span class="hljs-string">'lower-case'</span>
        ],
        <span class="hljs-comment">// 头部最大长度为 100 个字符</span>
        <span class="hljs-string">'header-max-length'</span>: [
            <span class="hljs-number">2</span>,
            <span class="hljs-string">'always'</span>,
            <span class="hljs-number">100</span>
        ],
        <span class="hljs-comment">// 主体前面必须有一个空行</span>
        <span class="hljs-string">'body-leading-blank'</span>: [
            <span class="hljs-number">2</span>,
            <span class="hljs-string">'always'</span>
        ],
    }
}
</code></pre>
</li>
</ol>

<ol>
<li>
<p>创建<code>.lintstagedrc.js</code></p>
<pre><code class="hljs language-arduino" lang="arduino">exportdefault {
  <span class="hljs-string">'*.{js,jsx,ts,tsx,vue}'</span>: [<span class="hljs-string">'eslint --fix'</span>, <span class="hljs-string">'prettier --write'</span>],
  <span class="hljs-string">'*.{css,scss,less,styl}'</span>: [<span class="hljs-string">'stylelint --fix'</span>, <span class="hljs-string">'prettier --write'</span>],
  <span class="hljs-string">'*.{json,md,yml,yaml}'</span>: [<span class="hljs-string">'prettier --write'</span>],
}
</code></pre>
</li>
</ol>

<ol>
<li>
<p>更新<code>package.json</code></p>
<pre><code class="hljs language-swift" lang="swift">{
<span class="hljs-operator">...</span>
<span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"lint"</span>: <span class="hljs-string">"eslint . --fix"</span>,
    <span class="hljs-string">"format"</span>: <span class="hljs-string">"prettier --write "</span>src<span class="hljs-comment">/**/</span><span class="hljs-operator">*</span>.{js,ts,vue,json,css,scss,md}<span class="hljs-string">""</span>,
    <span class="hljs-string">"lint:check"</span>: <span class="hljs-string">"eslint ."</span>,
    <span class="hljs-string">"format:check"</span>: <span class="hljs-string">"prettier --check "</span>src<span class="hljs-comment">/**/</span><span class="hljs-operator">*</span>.{js,ts,vue,json,css,scss,md}<span class="hljs-string">""</span>,
​
    <span class="hljs-string">"lint:style"</span>: <span class="hljs-string">"stylelint "</span><span class="hljs-operator">**/*</span>.{css,scss,vue}<span class="hljs-string">" --fix"</span>,
    <span class="hljs-string">"lint:style:check"</span>: <span class="hljs-string">"stylelint "</span><span class="hljs-operator">**/*</span>.{css,scss,vue}<span class="hljs-string">""</span>,
​
    <span class="hljs-string">"type-check"</span>: <span class="hljs-string">"vue-tsc --noEmit"</span>,
​
    <span class="hljs-string">"check"</span>: <span class="hljs-string">"pnpm lint:check &amp;&amp; pnpm format:check &amp;&amp; pnpm lint:style:check &amp;&amp; pnpm type-check"</span>,
    <span class="hljs-string">"fix"</span>: <span class="hljs-string">"pnpm lint &amp;&amp; pnpm format &amp;&amp; pnpm lint:style"</span>,
​
    <span class="hljs-string">"prepare"</span>: <span class="hljs-string">"husky install"</span>
},
<span class="hljs-operator">...</span>
}
</code></pre>
</li>
<li>
<p>初始化Husky（Git Hooks）</p>
<pre><code class="hljs language-arduino" lang="arduino">pnpm prepare
</code></pre>
<p>这会在根目录下生成<code>.husky</code>目录，其中包含了<code>_</code>子目录，将子目录下的<code>commit-msg</code>和<code>pre-commit</code>文件拷贝到<code>.husky</code>目录下，并修改文件内容如下：</p>
<p><code>.husky/commit-msg</code>文件内容</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/usr/bin/env sh</span>
. <span class="hljs-string">"<span class="hljs-subst">$(dirname -- <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>)</span> /_/husky.sh"</span>
​
npx --no -- commitlint --edit <span class="hljs-variable">$1</span>
</code></pre>
<p><code>.husky/pre-commit</code>文件内容</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/usr/bin/env sh</span>
. <span class="hljs-string">"<span class="hljs-subst">$(dirname -- <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>)</span>/_/husky.sh"</span>
​
pnpm lint-staged
</code></pre>
</li>
<li>
<p>验证配置文件语法</p>
<p>如果某些验证失败，请检查：</p>
<ul>
<li>
<p>依赖是否已正确安装</p>
</li>
<li>
<p>配置文件语法是否正确</p>
</li>
<li>
<p>文件路径是否正确</p>
</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 验证 ESLint 配置</span>
pnpm <span class="hljs-built_in">exec</span> eslint --print-config src/App.vue &gt; /dev/null &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ ESLint 配置正确"</span> || <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ ESLint 配置有误"</span>
​
<span class="hljs-comment"># 2. 验证 Prettier 配置</span>
pnpm <span class="hljs-built_in">exec</span> prettier --check . &gt; /dev/null 2&gt;&amp;1 &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ Prettier 配置正确"</span> || <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️  Prettier 发现格式问题（这是正常的）"</span>
​
<span class="hljs-comment"># 3. 验证 Stylelint 配置</span>
pnpm <span class="hljs-built_in">exec</span> stylelint --print-config src/style.css &gt; /dev/null &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ Stylelint 配置正确"</span> || <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ Stylelint 配置有误"</span>
​
<span class="hljs-comment"># 4. 验证 Commitlint 配置</span>
pnpm <span class="hljs-built_in">exec</span> commitlint --<span class="hljs-built_in">help</span> &gt; /dev/null &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ Commitlint 已安装"</span> || <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ Commitlint 未安装"</span>
​
<span class="hljs-comment"># 5. 验证 TypeScript 配置</span>
pnpm <span class="hljs-built_in">exec</span> vue-tsc --version &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ vue-tsc 已安装"</span> || <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ vue-tsc 未安装"</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb49442348aa4c529a43c4da3061ae0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWNob0VjaG8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856857&amp;x-signature=9NQrVRjY5tsulPYNEBBvvwDVMh4%3D" alt="图片" loading="lazy"/></p>
</li>
</ol>

<ol>
<li>
<p>运行检查命令</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 检查代码格式（ESLint）</span>
pnpm lint:check
​
<span class="hljs-comment"># 2. 检查代码格式（Prettier）</span>
pnpm <span class="hljs-built_in">format</span>:check
​
<span class="hljs-comment"># 3. 检查样式格式（Stylelint）</span>
pnpm lint:style:check
​
<span class="hljs-comment"># 4. 检查 TypeScript 类型</span>
pnpm <span class="hljs-built_in">type</span>-check
​
<span class="hljs-comment"># 5. 综合检查（运行所有检查）</span>
pnpm check
​
<span class="hljs-comment"># 6. 自动修复</span>
pnpm fix
</code></pre>
</li>
</ol>
<h4 data-id="heading-7">配置文件保存时自动格式化</h4>
<ol>
<li>安装相关插件</li>
<li>
<ul>
<li>Prettier - Code formatter</li>
<li>ESLint</li>
<li>Stylelint</li>
<li>Volar</li>
<li>TypeScript Vue Plugin</li>
</ul>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78f4a289d35c4a7c97a06f9197344cf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWNob0VjaG8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856857&amp;x-signature=mVtQIb1JFxNRO0kTrR8atUp9Nd0%3D" alt="图片" loading="lazy"/></p>
<ol>
<li>
<p>创建<code>.vscode/setting.json</code></p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-comment">// 编辑器基础配置</span>
  <span class="hljs-string">"editor.formatOnSave"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"editor.defaultFormatter"</span>: <span class="hljs-string">"esbenp.prettier-vscode"</span>,
  <span class="hljs-string">"editor.codeActionsOnSave"</span>: {
    <span class="hljs-string">"source.fixAll.eslint"</span>: <span class="hljs-string">"explicit"</span>,
    <span class="hljs-string">"source.fixAll.stylelint"</span>: <span class="hljs-string">"explicit"</span>
  },
​
  <span class="hljs-comment">// Vue 文件特殊配置 - 使用 Volar 格式化</span>
  <span class="hljs-string">"[vue]"</span>: {
    <span class="hljs-string">"editor.defaultFormatter"</span>: <span class="hljs-string">"Vue.volar"</span>,
    <span class="hljs-string">"editor.formatOnSave"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"editor.codeActionsOnSave"</span>: {
      <span class="hljs-string">"source.fixAll.eslint"</span>: <span class="hljs-string">"explicit"</span>,
      <span class="hljs-string">"source.fixAll.stylelint"</span>: <span class="hljs-string">"explicit"</span>
    }
  },
​
  <span class="hljs-comment">// Volar 配置</span>
  <span class="hljs-string">"volar.formatting.printWidth"</span>: <span class="hljs-number">120</span>,
  <span class="hljs-string">"volar.formatting.singleQuote"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"volar.formatting.semi"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"volar.formatting.tabSize"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"volar.formatting.trailingComma"</span>: <span class="hljs-string">"es5"</span>,
  <span class="hljs-string">"volar.formatting.arrowParens"</span>: <span class="hljs-string">"avoid"</span>,
  <span class="hljs-string">"volar.formatting.endOfLine"</span>: <span class="hljs-string">"lf"</span>,
​
  <span class="hljs-comment">// 或者使用 Prettier 格式化 Vue（需要配置）</span>
  <span class="hljs-comment">// "[vue]": {</span>
  <span class="hljs-comment">//   "editor.defaultFormatter": "esbenp.prettier-vscode",</span>
  <span class="hljs-comment">//   "editor.formatOnSave": true</span>
  <span class="hljs-comment">// },</span>
​
  <span class="hljs-comment">// 文件类型特定配置</span>
  <span class="hljs-string">"[javascript]"</span>: {
    <span class="hljs-string">"editor.defaultFormatter"</span>: <span class="hljs-string">"esbenp.prettier-vscode"</span>,
    <span class="hljs-string">"editor.formatOnSave"</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-string">"[javascriptreact]"</span>: {
    <span class="hljs-string">"editor.defaultFormatter"</span>: <span class="hljs-string">"esbenp.prettier-vscode"</span>,
    <span class="hljs-string">"editor.formatOnSave"</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-string">"[typescript]"</span>: {
    <span class="hljs-string">"editor.defaultFormatter"</span>: <span class="hljs-string">"esbenp.prettier-vscode"</span>,
    <span class="hljs-string">"editor.formatOnSave"</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-string">"[typescriptreact]"</span>: {
    <span class="hljs-string">"editor.defaultFormatter"</span>: <span class="hljs-string">"esbenp.prettier-vscode"</span>,
    <span class="hljs-string">"editor.formatOnSave"</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-string">"[json]"</span>: {
    <span class="hljs-string">"editor.defaultFormatter"</span>: <span class="hljs-string">"esbenp.prettier-vscode"</span>,
    <span class="hljs-string">"editor.formatOnSave"</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-string">"[jsonc]"</span>: {
    <span class="hljs-string">"editor.defaultFormatter"</span>: <span class="hljs-string">"esbenp.prettier-vscode"</span>,
    <span class="hljs-string">"editor.formatOnSave"</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-string">"[css]"</span>: {
    <span class="hljs-string">"editor.defaultFormatter"</span>: <span class="hljs-string">"esbenp.prettier-vscode"</span>,
    <span class="hljs-string">"editor.formatOnSave"</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-string">"[scss]"</span>: {
    <span class="hljs-string">"editor.defaultFormatter"</span>: <span class="hljs-string">"esbenp.prettier-vscode"</span>,
    <span class="hljs-string">"editor.formatOnSave"</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-string">"[less]"</span>: {
    <span class="hljs-string">"editor.defaultFormatter"</span>: <span class="hljs-string">"esbenp.prettier-vscode"</span>,
    <span class="hljs-string">"editor.formatOnSave"</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-string">"[html]"</span>: {
    <span class="hljs-string">"editor.defaultFormatter"</span>: <span class="hljs-string">"esbenp.prettier-vscode"</span>,
    <span class="hljs-string">"editor.formatOnSave"</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-string">"[markdown]"</span>: {
    <span class="hljs-string">"editor.defaultFormatter"</span>: <span class="hljs-string">"esbenp.prettier-vscode"</span>,
    <span class="hljs-string">"editor.formatOnSave"</span>: <span class="hljs-literal">true</span>
  },
​
  <span class="hljs-comment">// ESLint 配置</span>
  <span class="hljs-string">"eslint.enable"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"eslint.validate"</span>: [
    <span class="hljs-string">"javascript"</span>,
    <span class="hljs-string">"javascriptreact"</span>,
    <span class="hljs-string">"typescript"</span>,
    <span class="hljs-string">"typescriptreact"</span>,
    <span class="hljs-string">"vue"</span>
  ],
  <span class="hljs-string">"eslint.format.enable"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"eslint.codeAction.showDocumentation"</span>: {
    <span class="hljs-string">"enable"</span>: <span class="hljs-literal">true</span>
  },
​
  <span class="hljs-comment">// Stylelint 配置</span>
  <span class="hljs-string">"stylelint.enable"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"stylelint.validate"</span>: [
    <span class="hljs-string">"css"</span>,
    <span class="hljs-string">"scss"</span>,
    <span class="hljs-string">"less"</span>,
    <span class="hljs-string">"vue"</span>
  ],
​
  <span class="hljs-comment">// Prettier 配置</span>
  <span class="hljs-string">"prettier.enable"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"prettier.requireConfig"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"prettier.configPath"</span>: <span class="hljs-string">".prettierrc.cjs"</span>,
​
  <span class="hljs-comment">// 使用 Prettier 格式化 Vue（如果使用 Prettier 而不是 Volar）</span>
  <span class="hljs-string">"prettier.documentSelectors"</span>: [<span class="hljs-string">"**/*.vue"</span>],
​
  <span class="hljs-comment">// 其他编辑器配置</span>
  <span class="hljs-string">"files.eol"</span>: <span class="hljs-string">"<span class="hljs-subst">\n</span>"</span>,
  <span class="hljs-string">"files.insertFinalNewline"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"files.trimTrailingWhitespace"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"files.encoding"</span>: <span class="hljs-string">"utf8"</span>,
​
  <span class="hljs-comment">// Vue 相关配置 - 禁用 Vetur（如果安装了）</span>
  <span class="hljs-string">"vetur.format.enable"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"vetur.validation.template"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"vetur.validation.script"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"vetur.validation.style"</span>: <span class="hljs-literal">false</span>,
​
  <span class="hljs-comment">// TypeScript 配置</span>
  <span class="hljs-string">"typescript.tsdk"</span>: <span class="hljs-string">"node_modules/typescript/lib"</span>,
  <span class="hljs-string">"typescript.enablePromptUseWorkspaceTsdk"</span>: <span class="hljs-literal">true</span>
}
</code></pre>
</li>
</ol>

<ol>
<li>
<p>验证配置</p>
<p>打开任意<code>.vue</code>、<code>ts</code>或<code>.js</code>文件，故意写一些格式不规范的代码（例如：多余空格，缺少分号等），保存文件，检查代码是否自动格式化</p>
</li>
</ol>
<h3 data-id="heading-8">常见问题：</h3>
<h4 data-id="heading-9">1. 保存时格式化不生效</h4>
<ul>
<li>检查 VSCode 扩展是否已安装</li>
<li>检查 <code>.vscode/settings.json</code> 是否正确配置</li>
<li>重启 VSCode 或重新加载窗口</li>
</ul>
<h4 data-id="heading-10">2. ESLint 报错找不到模块</h4>
<ul>
<li>运行 <code>pnpm install</code> 重新安装依赖</li>
<li>检查 <code>eslint.config.js</code> 中的导入路径</li>
</ul>
<h4 data-id="heading-11">3. Git Hooks 不生效</h4>
<ul>
<li>检查 <code>.husky/pre-commit</code> 和 <code>.husky/commit-msg</code> 文件是否存在且可执行</li>
<li>运行 <code>chmod +x .husky/pre-commit .husky/commit-msg</code> 添加执行权限</li>
</ul>
<h3 data-id="heading-12">总结</h3>
<p>通过以上配置，我们已经为 Vue 3 + TypeScript + Vite 项目搭建了完整的代码规范体系：</p>
<p>✅ <strong>代码质量检查</strong>：ESLint + TypeScript 类型检查</p>
<p>✅ <strong>代码格式化</strong>：Prettier</p>
<p>✅ <strong>样式规范</strong>：Stylelint + EditorConfig</p>
<p>✅ <strong>提交规范</strong>：Commitlint + Husky + lint-staged</p>
<p>✅ <strong>开发体验</strong>：VSCode 保存自动格式化</p>
<h4 data-id="heading-13"/>
<h4 data-id="heading-14">配置清单</h4>
<p>项目根目录下应包含以下配置文件：</p>
<ul>
<li><code>eslint.config.js</code> - ESLint 配置</li>
<li><code>.prettierrc.cjs</code> - Prettier 配置</li>
<li><code>.prettierignore</code> - Prettier 忽略文件</li>
<li><code>.stylelintrc.cjs</code> - Stylelint 配置</li>
<li><code>.editorconfig</code> - 编辑器配置</li>
<li><code>commitlint.config.js</code> - Commitlint 配置</li>
<li><code>.lintstagedrc.js</code> - lint-staged 配置</li>
<li><code>.husky/pre-commit</code> - Git pre-commit hook</li>
<li><code>.husky/commit-msg</code> - Git commit-msg hook</li>
<li><code>.vscode/settings.json</code> - VSCode 工作区配置</li>
</ul>
<p><strong>相关资源</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Feslint.org%2F" target="_blank" title="https://eslint.org/" ref="nofollow noopener noreferrer">ESLint 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fprettier.io%2F" target="_blank" title="https://prettier.io/" ref="nofollow noopener noreferrer">Prettier 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fstylelint.io%2F" target="_blank" title="https://stylelint.io/" ref="nofollow noopener noreferrer">Stylelint 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcommitlint.js.org%2F" target="_blank" title="https://commitlint.js.org/" ref="nofollow noopener noreferrer">Commitlint 官方文档</a></li>
</ul>
<p>📦 完整示例： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F1193082625%2Fvite-vue-demo%2Freleases%2Ftag%2Fv1.0.0" target="_blank" title="https://github.com/1193082625/vite-vue-demo/releases/tag/v1.0.0" ref="nofollow noopener noreferrer">GitHub 仓库地址</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[由vite项目引起的Nginx学习]]></title>    <link>https://juejin.cn/post/7602841282802860073</link>    <guid>https://juejin.cn/post/7602841282802860073</guid>    <pubDate>2026-02-05T01:08:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602841282802860073" data-draft-id="7602814773497233450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="由vite项目引起的Nginx学习"/> <meta itemprop="keywords" content="Nginx,前端"/> <meta itemprop="datePublished" content="2026-02-05T01:08:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="EchoEcho"/> <meta itemprop="url" content="https://juejin.cn/user/2920774267837208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            由vite项目引起的Nginx学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2920774267837208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    EchoEcho
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T01:08:01.000Z" title="Thu Feb 05 2026 01:08:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一直对<code>nginx</code>处于比较浅显的了解，趁着这次调试项目，对了解到的<code>nginx</code>也做一次总结。</p>
<p><strong>问题背景</strong>：</p>
<p>本地<code>vite</code>项目运行正常，但是部署到对应环境后，页面无法正常访问。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/619a1eff94194b92a5b01d22bb930291~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWNob0VjaG8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858489&amp;x-signature=AwNk5gupBUH%2FIajexOHYZ6MQsp4%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p> 预计此问题是未正常请求到资源导致返回了兜底的<code>html</code>内容，然而请求的是<code>js</code>文件，得到的却是<code>html</code>文件，所以导致的此报错。</p>
<p>查看了<code>vite.config.ts</code>，发现当前<code>base</code>配置是<code>./</code>【相对路径】，将其修改为<code>/</code>【绝对路径】后，希望在本地确认一下是否正常后再部署到对应环境，就有了以下流程。</p>
</blockquote>
<p><strong>调试过程</strong>：</p>
<p>先在本地执行对应环境的打包命令：<code>pnpm run build:test</code>，会在项目根目录下生成<code>dist</code>文件。</p>
<p>由于<code>Vite</code>中内置的<code>Vite preview</code>不支持代理，所以无法使用<code>pnpm run preview</code>直接运行<code>dist</code>。</p>
<p>此时选择使用<code>Nginx</code>运行本地<code>dist</code>。</p>
<p>在本地<code>nginx</code>配置中添加对此项目的代理:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 所有行都需要 ; 结尾</span>
...
server {
    <span class="hljs-comment"># 监听端口号</span>
    listen 3333<span class="hljs-comment">;</span>
    <span class="hljs-comment"># 配置后在浏览器中的地址就是localhost:3333</span>
    server_name localhost<span class="hljs-comment">;</span>

    <span class="hljs-comment"># 静态文件目录【使用绝对路径】</span>
    root E:/work/object/dist<span class="hljs-comment">;</span>

    index index.html<span class="hljs-comment">;</span>

    <span class="hljs-comment"># 静态资源缓存</span>
    location~* .(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|wasm)$ {
        expires 1y<span class="hljs-comment">;</span>
    }
    
    <span class="hljs-comment"># API 代理</span>
    location /api/ {
        proxy_pass http://1.1.1.1:1111<span class="hljs-comment">;</span>
                client_max_body_size 500m<span class="hljs-comment">; # 允许上传最大 500MB 文件</span>
        proxy_connect_timeout 600<span class="hljs-comment">; # 连接超时 600 秒</span>
        proxy_send_timeout 600<span class="hljs-comment">;</span>
        proxy_read_timeout 600<span class="hljs-comment">; # 读取超时 600 秒</span>
    }
    
    <span class="hljs-comment"># SPA 路由支持</span>
    location / {
        <span class="hljs-comment"># 文件查找顺序 先找精确路径（/aa.html） 再找目录（/aa/） 最后用备用页面（回退到首页）</span>
        try_files $uri $uri/ /index.html<span class="hljs-comment">;</span>
    }
    
    error_page 500 502 503 504 /50x.html<span class="hljs-comment">;</span>
    <span class="hljs-attr">location</span> = <span class="hljs-number">50</span>x.html {
        root html<span class="hljs-comment">;</span>
    }
}
...
</code></pre>
<p>重启<code>nginx</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入nginx.exe所在目录</span>

<span class="hljs-comment"># 1. 停止Nginx</span>
./nginx -s stop

<span class="hljs-comment"># 2. 重新加载配置</span>
./nginx -s reload

<span class="hljs-comment"># 3. 检查 Nginx 进程</span>
tasklist | findstr nginx
</code></pre>
<p>除了以上方法也可以在任务管理器中手动停止对应的<code>nginx</code>进行后，再双击<code>nginx.exe</code>启动</p>
<p><code>nginx</code>正常运行后，就可以在浏览器中直接访问了<code>http:localhost:3333</code>。发现修改<code>base</code>的设置后，确实解决了上述问题。就可以正常提交代码并在对应环境部署了。</p>
<p><strong>问题解析</strong></p>
<p>此次问题是因为新增了一个二级路由，当以<code>base: "./"</code>设置访问子路由<code>/second/page</code>时，</p>
<p>当前URL为：<code>http://localhost:3333/second/page</code></p>
<p>资源路径为：<code>./assets/xxx.js</code></p>
<p>解析结果为：<code>http://localhost:3333/second/assets/xxx.js</code>❌</p>
<p>浏览器会基于当前路径解析相对路径，<code>./assets/xxx.js</code>被解析成了<code>second/assets/xxx.js</code>，而实际文件在<code>/assets/xxx.js</code>，所以导致资源文件404，服务器返回了<code>index.html</code>【<code>SPA fallback</code>】，但浏览器期望<code>js</code>文件，因此报错<code>Expected a JavaScript-or-Wasm module script but the server responded with a MIME type of 'text/html'</code>。</p>
<p>这个问题没有在本地运行时报错，是因为<code>vite</code>开发服务器会动态处理所有请求，不受<code>base</code>配置影响。</p>
<p><strong>其他补充</strong>：</p>
<ul>
<li>
<p>正向代理： </p>
<p>Nginx作为客户端代理，通常用于VPN、翻墙、公司内网代理</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 公司内网代理配置</span>
<span class="hljs-comment"># 员工电脑配置代理：192.168.1.100:3128</span>
<span class="hljs-comment"># 所有外网请求都通过这个代理</span>
server {
    listen 3128<span class="hljs-comment">; # 常用代理端口</span>
    server_name proxy.example.com<span class="hljs-comment">;</span>
    
    resolver 8.8.8.8<span class="hljs-comment">; # DNS 服务器地址</span>

    <span class="hljs-comment"># 允许的客户端IP（安全）</span>
    allow 192.168.1.0/24<span class="hljs-comment">; 只允许内网</span>
    deny all<span class="hljs-comment">;</span>

    location / { 
        proxy_pass http://$http_host$request_uri<span class="hljs-comment">; # 动态目标</span>
        proxy_set_header Host $http_host<span class="hljs-comment">;</span>
        proxy_set_header X-Real-IP $remote_addr<span class="hljs-comment">;</span>
        proxy_buffering off<span class="hljs-comment">; # 关闭缓冲，提高性能</span>
        <span class="hljs-comment"># 日志</span>
        access_log logs/proxy_access.log<span class="hljs-comment">;</span>
    }
}
</code></pre>
</li>
<li>
<p>反向代理：</p>
<p>Nginx作为服务器代理，上面的例子就是反向代理</p>
<pre><code class="hljs language-bash" lang="bash">localtion /api/ {
    proxy_pass http://1.1.1.1:7788; <span class="hljs-comment"># 转给后端</span>
}
</code></pre>
</li>
<li>
<p>负载均衡：</p>
<p>可以设置自动轮询，设置权重，或者自定义</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 多个后端，按权重分配请求</span>
upstream backend {
    server localhost:8080 <span class="hljs-attr">weight</span>=<span class="hljs-number">3</span><span class="hljs-comment">; # 权重 3</span>
    server localhost:8081 <span class="hljs-attr">weight</span>=<span class="hljs-number">1</span><span class="hljs-comment">; # 权重 1</span>
    server localhost:8082 backup<span class="hljs-comment">; # 备用服务器</span>
}
server {
    location /api/ {
   proxy_pass http://backend<span class="hljs-comment">; # 使用负载均衡</span>
    }
}
</code></pre>
</li>
<li>
<p>静态文件处理：</p>
<pre><code class="hljs language-bash" lang="bash">server {
    root E:/work/app/dist; <span class="hljs-comment"># 文件仓库【绝对路径】</span>

    location / {
   try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.html;
    }
}
</code></pre>
</li>
<li>
<p><code>Gzip</code>压缩</p>
<p>传输前压缩，可以减少带宽</p>
<p>图片、视频、PDF等如果已经压缩过，就不需要再压缩了，再次压缩效果差</p>
<p>小文件压缩收益小，反而增加CPU开销</p>
<pre><code class="hljs language-bash" lang="bash">http {
    gzip on; <span class="hljs-comment"># 开启压缩</span>
    
    <span class="hljs-comment"># 压缩级别（1-9，数字越大压缩越好但越慢）</span>
    gzip_comp_level 6;  <span class="hljs-comment"># 推荐 6，平衡压缩率和速度</span>
    
    <span class="hljs-comment"># 大于 1KB 才压缩，太小压缩意义不大</span>
    gzip_min_length 1024;
    
    <span class="hljs-comment"># 压缩的文件类型</span>
    gzip_types
        text/plain           <span class="hljs-comment"># 纯文本</span>
        text/css             <span class="hljs-comment"># CSS</span>
        text/javascript      <span class="hljs-comment"># JavaScript</span>
        application/javascript
        application/json     <span class="hljs-comment"># JSON</span>
        text/xml             <span class="hljs-comment"># XML</span>
        application/xml
        application/xml+rss
        text/html;           <span class="hljs-comment"># HTML</span>
    
    <span class="hljs-comment"># 压缩缓冲区大小</span>
    gzip_buffers 16 8k;  <span class="hljs-comment"># 16个8KB缓冲区</span>
    
    <span class="hljs-comment"># 是否添加 Vary: Accept-Encoding 头</span>
    <span class="hljs-comment"># 告诉缓存服务器支持压缩  支持压缩的浏览器给压缩版，不支持的给原版</span>
    gzip_vary on;  
    
    <span class="hljs-comment"># 禁用某些浏览器的压缩（旧版 IE）</span>
    gzip_disable <span class="hljs-string">"msie6"</span>;  <span class="hljs-comment"># 禁用 IE6</span>
}
</code></pre>
</li>
<li>
<p>缓存控制</p>
<p>静态资源缓存，减少重复请求，减轻服务器压力</p>
<p>第一次请求：<code>浏览器 -&gt; 服务器 -&gt; 返回文件 -&gt; 浏览器（同时缓存）</code></p>
<p>第二次请求：<code>浏览器 -&gt; nginx -&gt; 直接返回缓存</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 静态资源（JS、CSS、图片）- 长期缓存</span>
location ~* .(js|css|png|jpg)$ {
    expires 1y; <span class="hljs-comment"># 缓存1年  -1【不缓存】| epoch【不缓存】 | max【最大缓存时间10年】| 1y【一年】| 1M【一个月】...</span>
<span class="hljs-comment"># 更详细的缓存规则 公共缓存，1年有效，不会改变</span>
    add_header Cache-Control <span class="hljs-string">"public, max-age=31536000, immutable"</span>;
    access_log off;  <span class="hljs-comment"># 不记录访问日志（可选）</span>
}

<span class="hljs-comment"># HTML文件 - 短期缓存或不缓存</span>
location ~* .html$ {
    expires 1h; <span class="hljs-comment"># 缓存1小时</span>
    add_header Cache-Control <span class="hljs-string">"public, max-age=3600"</span>;
}

<span class="hljs-comment"># API响应 - 不缓存</span>
location /api {
    proxy_pass http://localhost:8080;
    add_header Cache-Control <span class="hljs-string">"no-cache, no-store, must-revalidate"</span>;
}

<span class="hljs-comment"># 其他文件</span>
location / {
    try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.html;
}
</code></pre>
<p><code>Cache-Control</code>参数说明：</p>








































<table><thead><tr><th>指令</th><th>含义</th><th>比喻</th></tr></thead><tbody><tr><td>public</td><td>可以被任何缓存存储</td><td>公共货架，谁都能用</td></tr><tr><td>private</td><td>只能被浏览器缓存</td><td>私人货架，只有你能用</td></tr><tr><td>max-age=秒数</td><td>缓存有效期（秒）</td><td>保质期</td></tr><tr><td>immutable</td><td>文件不会改变</td><td>永久不变</td></tr><tr><td>no-cache</td><td>需要验证才能使用</td><td>每次都要检查</td></tr><tr><td>no-store</td><td>不缓存</td><td>不放在货架上</td></tr></tbody></table>
</li>
<li>
<p>HTTPS【SSL】</p>
<pre><code class="hljs language-bash" lang="bash">server {
    listen 443 ssl; <span class="hljs-comment"># HTTPS 端口</span>
    server_name example.com;

    <span class="hljs-comment"># SSL证书配置</span>
    ssl_certificate /path/to/certificate.crt; <span class="hljs-comment"># 证书文件</span>
    ssl_certificate_key /path/to/private.key; <span class="hljs-comment"># 私钥文件</span>

}
</code></pre>
</li>
<li>
<p>限流</p>
<p>防止请求过多，保护服务器</p>
<pre><code class="hljs language-ini" lang="ini">limit_req_zone $binary_remote_addr <span class="hljs-attr">zone</span>=api_limit:<span class="hljs-number">10</span>m rate=<span class="hljs-number">10</span>r/s<span class="hljs-comment">;</span>

location /api/ {
    limit_req <span class="hljs-attr">zone</span>=api_limit burst=<span class="hljs-number">20</span><span class="hljs-comment">; # 每秒10个请求</span>
    proxy_pass http://localhost:8080<span class="hljs-comment">;</span>
}
</code></pre>
</li>
<li>
<p>跨域【CORS】</p>
<p>允许不同域名的前端访问API</p>
<pre><code class="hljs language-bash" lang="bash">location /api {
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods <span class="hljs-string">'GET, POST, PUT, DELETE'</span>;
    add_header Access-Control-Allow-Headers <span class="hljs-string">'Content-Type,     Authorization'</span>;

    proxy_pass http://localhost:8080;
}
</code></pre>
</li>
<li>
<p>重定向</p>
<p>URL变更，自动跳转</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 301 永久重定向</span>
<span class="hljs-comment"># 浏览器行为：记住新地址，下次直接访问；适用于域名变更或URL永久变更</span>
location /old {
    <span class="hljs-built_in">return</span> 301 /new;
}

<span class="hljs-comment"># 302 临时重定向</span>
<span class="hljs-comment"># 浏览器行为：不记住，每次都询问；适用于临时维护、A/B测试</span>
location /temp {
    <span class="hljs-built_in">return</span> 302 /new;
}
</code></pre>
</li>
<li>
<p>请求头修改</p>
<pre><code class="hljs language-bash" lang="bash">location /api {
    proxy_set_header Host <span class="hljs-variable">$host</span>; <span class="hljs-comment"># 设置Host</span>
    proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>; <span class="hljs-comment"># 真实IP</span>
    proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;

    proxy_pass http://localhost:8080;
}
</code></pre>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nestjs链接mongodb]]></title>    <link>https://juejin.cn/post/7602940720689676334</link>    <guid>https://juejin.cn/post/7602940720689676334</guid>    <pubDate>2026-02-05T01:53:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602940720689676334" data-draft-id="7602842876255469614" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nestjs链接mongodb"/> <meta itemprop="keywords" content="后端,MySQL"/> <meta itemprop="datePublished" content="2026-02-05T01:53:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="牧野星辰"/> <meta itemprop="url" content="https://juejin.cn/user/166781500788429"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nestjs链接mongodb
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781500788429/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    牧野星辰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T01:53:42.000Z" title="Thu Feb 05 2026 01:53:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>安装依赖</p>
<pre><code class="hljs language-js" lang="js">npm i @nestjs/mongoose mongoose
npm i @nestjs/config
</code></pre>
<p>创建<code>.env</code>环境变量文件，内容如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable constant_">MONGODB_URI</span>=<span class="hljs-attr">mongodb</span>:<span class="hljs-comment">//localhost:27017/projectdata</span>
</code></pre>
<p>配置链接mongodb，主要修改可以看下方截图</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.controller'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">ConfigModule</span>,<span class="hljs-title class_">ConfigService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">MongooseModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/mongoose'</span>;

@<span class="hljs-title class_">Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">isGlobal</span>:<span class="hljs-literal">true</span>,<span class="hljs-comment">//全局模块，可在任何地方使用</span>
    }),
    <span class="hljs-title class_">MongooseModule</span>.<span class="hljs-title function_">forRootAsync</span>({
      <span class="hljs-attr">imports</span>:[<span class="hljs-title class_">ConfigModule</span>],
      <span class="hljs-attr">useFactory</span>:<span class="hljs-keyword">async</span> (<span class="hljs-attr">configService</span>:<span class="hljs-title class_">ConfigService</span>)=&gt;({
        <span class="hljs-attr">uri</span>:configService.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-string">'MONGODB_URI'</span>)||<span class="hljs-string">'mongodb://localhost:27017/projectdata'</span>
      }),
      <span class="hljs-attr">inject</span>:[<span class="hljs-title class_">ConfigService</span>]
    })
  ],
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">AppController</span>],
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">AppService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a70376856354b929debb97dce7334b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54mn6YeO5pif6L6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770861222&amp;x-signature=QugJps%2F8SA68AlbP0bNi3HxLBgI%3D" alt="image.png" loading="lazy"/></p>
<p>开发环境使用.env</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1.下载dotenv</span>
npm i dotenv
<span class="hljs-comment">// 2.src/main.ts中配置</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">'dotenv'</span>;
dotenv.<span class="hljs-title function_">config</span>();
</code></pre>
<p><code>npm run start:dev</code>运行项目显示如下图所示即为成功</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb3131bd980e41c4877d12d69a4705d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54mn6YeO5pif6L6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770861222&amp;x-signature=hmbY8vDKrLAmyu%2FzylmXssLRkpM%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥🔥🔥 React18 源码学习 - hook 原理 - useState & useReducer]]></title>    <link>https://juejin.cn/post/7603004323870064683</link>    <guid>https://juejin.cn/post/7603004323870064683</guid>    <pubDate>2026-02-04T17:54:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603004323870064683" data-draft-id="7602825342228168738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥🔥🔥 React18 源码学习 - hook 原理 - useState &amp; useReducer"/> <meta itemprop="keywords" content="React.js,源码阅读"/> <meta itemprop="datePublished" content="2026-02-04T17:54:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="yyyao"/> <meta itemprop="url" content="https://juejin.cn/user/4266531531793976"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥🔥🔥 React18 源码学习 - hook 原理 - useState &amp; useReducer
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4266531531793976/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    yyyao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T17:54:07.000Z" title="Wed Feb 04 2026 17:54:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>本文的<code>React</code>代码版本为<code>18.2.0</code></p>
<p>可调试的代码仓库为：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyyyao-hh%2Freact-debug%2Ftree%2Fmaster-pure" target="_blank" title="https://github.com/yyyao-hh/react-debug/tree/master-pure" ref="nofollow noopener noreferrer">GitHub - yyyao-hh/react-debug at master-pure</a></p>
<p>在<code>React16.8</code>引入Hooks之前，状态逻辑复用一直困扰着<code>React</code>开发者。<code>Hooks</code>的诞生不仅解决了状态逻辑复用的问题，更重要的是统一了函数组件与类组件的能力边界。作为<code>React</code>中最基础也最核心的两个<code>Hooks</code>，<code>useState</code>和<code>useReducer</code>共同构建了函数组件的状态管理体系。</p>
<h2 data-id="heading-1">useState 源码</h2>
<p>接下来我们看一下<code>useState</code>的源码。在<code>Hook</code>那一章节讲过，对于<code>Hooks</code>的处理会分为<code>mount</code>和<code>update</code>两个阶段，然后不同阶段调用不同函数对<code>Hook</code>进行处理。</p>
<p>所以我们接下来直接去看不同阶段处理方法的内部实现</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">/*</span> <span class="hljs-string">react/packages/react-reconciler/src/ReactFiberHooks.old.js</span> <span class="hljs-string">*/</span>

<span class="hljs-string">//</span> <span class="hljs-string">mount</span> <span class="hljs-string">阶段</span>
<span class="hljs-attr">const HooksDispatcherOnMount:</span> <span class="hljs-string">Dispatcher</span> <span class="hljs-string">=</span> {
  <span class="hljs-attr">useEffect:</span> <span class="hljs-string">mountEffect</span>,
  <span class="hljs-attr">useRef:</span> <span class="hljs-string">mountRef</span>,
  <span class="hljs-attr">useState:</span> <span class="hljs-string">mountState</span>,
  <span class="hljs-string">...</span>
}<span class="hljs-string">;</span>

<span class="hljs-string">//</span> <span class="hljs-string">update</span> <span class="hljs-string">阶段</span>
<span class="hljs-attr">const HooksDispatcherOnUpdate:</span> <span class="hljs-string">Dispatcher</span> <span class="hljs-string">=</span> {
  <span class="hljs-attr">useEffect:</span> <span class="hljs-string">updateEffect</span>,
  <span class="hljs-attr">useRef:</span> <span class="hljs-string">updateRef</span>,
  <span class="hljs-attr">useState:</span> <span class="hljs-string">updateState</span>,
  <span class="hljs-string">...</span>
}<span class="hljs-string">;</span>
</code></pre>
<h3 data-id="heading-2">挂载阶段</h3>
<p>因此我们直接看<code>mountState</code>的实现，它是<code>useState</code>在组件首次渲染时的初始化逻辑。它的任务不是计算状态，而是搭建好整个状态管理所需的“基础设施”。</p>
<ol>
<li>首先<code>mountWorkInProgressHook</code>的作用是：创建新的<code>Hook</code>对象并添加到正在渲染的<code>Fiber</code>节点的<code>Hook</code>链表末尾（<code>Hook</code>原理一文详细提到过）</li>
<li>然后计算初始状态值，并放到<code>hook</code>对象的<code>memoizedState</code>和<code>baseState</code>属性上</li>
</ol>

<ol>
<li>
<ol>
<li><code>memoizedState</code>：当前渲染周期的状态值，组件渲染时使用这个值（即<code>state</code>状态）</li>
<li><code>baseState</code>：基础状态，用于计算更新</li>
<li>两者初始值相同，但在更新过程中可能不同（特别是存在跳过的更新时）</li>
</ol>
</li>
</ol>

<ol start="3">
<li>然后创建更新队列放在<code>hook</code>对象的<code>queue</code>属性，管理状态更新</li>
<li>最后通过<code>dispatchSetState</code>创建<code>dispatch</code>函数（即<code>setState</code>函数）</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/* src/react/packages/react-reconciler/src/ReactFiberHooks.old.js */</span>

<span class="hljs-keyword">function</span> mountState&lt;S&gt;(
  <span class="hljs-attr">initialState</span>: (<span class="hljs-function">() =&gt;</span> S) | S,
): [S, <span class="hljs-title class_">Dispatch</span>&lt;<span class="hljs-title class_">BasicStateAction</span>&lt;S&gt;&gt;] {
  <span class="hljs-comment">// 创建新的Hook对象并添加到正在渲染的Fiber节点的Hook链表末尾</span>
  <span class="hljs-keyword">const</span> hook = <span class="hljs-title function_">mountWorkInProgressHook</span>();
  
  <span class="hljs-comment">// 计算初始状态值 (支持惰性初始化)</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> initialState === <span class="hljs-string">'function'</span>) {
    initialState = <span class="hljs-title function_">initialState</span>();
  }
  hook.<span class="hljs-property">memoizedState</span> = hook.<span class="hljs-property">baseState</span> = initialState;
  <span class="hljs-keyword">const</span> <span class="hljs-attr">queue</span>: <span class="hljs-title class_">UpdateQueue</span>&lt;S, <span class="hljs-title class_">BasicStateAction</span>&lt;S&gt;&gt; = {
    <span class="hljs-attr">pending</span>: <span class="hljs-literal">null</span>,     <span class="hljs-comment">// 指向更新队列中最后一个更新 (环形链表)</span>
    <span class="hljs-attr">interleaved</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 在并发渲染中, 用于存储被中断后插入的更新 (环形链表)</span>
    <span class="hljs-attr">lanes</span>: <span class="hljs-title class_">NoLanes</span>,    <span class="hljs-comment">// 表示当前更新队列的优先级 (车道模型)</span>
    <span class="hljs-attr">dispatch</span>: <span class="hljs-literal">null</span>,    <span class="hljs-comment">// 用于保存dispatch函数, 在mountReducer中会被赋值</span>
    <span class="hljs-attr">lastRenderedReducer</span>: basicStateReducer, <span class="hljs-comment">// 用于计算新状态的reducer</span>
    <span class="hljs-attr">lastRenderedState</span>: (<span class="hljs-attr">initialState</span>: <span class="hljs-built_in">any</span>), <span class="hljs-comment">// 上一次渲染的状态</span>
  };
  hook.<span class="hljs-property">queue</span> = queue;
  <span class="hljs-keyword">const</span> <span class="hljs-attr">dispatch</span>: <span class="hljs-title class_">Dispatch</span>&lt;
    <span class="hljs-title class_">BasicStateAction</span>&lt;S&gt;,
  &gt; = (queue.<span class="hljs-property">dispatch</span> = (dispatchSetState.<span class="hljs-title function_">bind</span>(
    <span class="hljs-literal">null</span>,
    currentlyRenderingFiber,
    queue,
  ): <span class="hljs-built_in">any</span>));
  <span class="hljs-keyword">return</span> [hook.<span class="hljs-property">memoizedState</span>, dispatch];
}
</code></pre>
<p>然后看一下<code>dispatchSetState</code>函数主要做了什么？</p>
<ol>
<li>首先获取本次更新的优先级 ，使用<code>requestUpdateLane</code>确定更新的<strong>优先级</strong></li>
<li>之后创建一个更新对象<code>Update</code>（<code>pending</code>和<code>interleaved</code>都是环形链表）</li>
</ol>

<ol>
<li>
<ol>
<li>这个更新如果在渲染阶段发生，会被挂载在<code>hook</code>对象的更新队列<code>queue</code>的<code>pending</code>属性上</li>
<li>如果是正常更新：如果新状态与当前状态相同，直接跳过更新，避免不必要渲染的关键优化。这个更新会被挂载在<code>hook</code>对象的更新队列<code>queue</code>的<code>interleaved</code>属性上</li>
</ol>
</li>
</ol>

<ol start="3">
<li>最后会调度更新（<code>scheduleUpdateOnFiber</code>），安排渲染工作</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">/* src/react/packages/react-reconciler/src/ReactFiberHooks.old.js */

function dispatchSetState&lt;S, A&gt;(
  fiber: Fiber,
  queue: UpdateQueue&lt;S, A&gt;,
  action: A,
) {
  const <span class="hljs-attr">lane</span> = requestUpdateLane(fiber)<span class="hljs-comment">;</span>

  const update: Update&lt;S, A&gt; = {
    lane,   // 优先级车道
    action, // 更新动作 (值或函数)
    hasEagerState: false, // 是否已计算急切状态
    eagerState: null,     // 预先计算的状态 (优化用)
    next: (null: any),    // 指向下一个更新 (形成环状链表)
  }<span class="hljs-comment">;</span>

  if (isRenderPhaseUpdate(fiber)) {
    enqueueRenderPhaseUpdate(queue, update)<span class="hljs-comment">;</span>
  } else {
    const <span class="hljs-attr">alternate</span> = fiber.alternate<span class="hljs-comment">;</span>
    if (
      <span class="hljs-attr">fiber.lanes</span> === NoLanes &amp;&amp;
      (<span class="hljs-attr">alternate</span> === null || alternate.lanes === NoLanes)
    ) {
      const <span class="hljs-attr">lastRenderedReducer</span> = queue.lastRenderedReducer<span class="hljs-comment">;</span>
      if (lastRenderedReducer !== null) {
        let prevDispatcher<span class="hljs-comment">;</span>
        try {
          const currentState: <span class="hljs-attr">S</span> = (queue.lastRenderedState: any)<span class="hljs-comment">;</span>
          const <span class="hljs-attr">eagerState</span> = lastRenderedReducer(currentState, action)<span class="hljs-comment">;</span>
          <span class="hljs-attr">update.hasEagerState</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
          <span class="hljs-attr">update.eagerState</span> = eagerState<span class="hljs-comment">;</span>
          if (is(eagerState, currentState)) {
            enqueueConcurrentHookUpdateAndEagerlyBailout(
              fiber,
              queue,
              update,
              lane,
            )<span class="hljs-comment">;</span>
            return<span class="hljs-comment">;</span>
          }
        }
      }
    }

    const <span class="hljs-attr">root</span> = enqueueConcurrentHookUpdate(fiber, queue, update, lane)<span class="hljs-comment">;</span>
    if (root !== null) {
      const <span class="hljs-attr">eventTime</span> = requestEventTime()<span class="hljs-comment">;</span>
      scheduleUpdateOnFiber(root, fiber, lane, eventTime)<span class="hljs-comment">;</span>
      entangleTransitionUpdate(root, queue, lane)<span class="hljs-comment">;</span>
    }
  }
}
</code></pre>
<pre><code class="hljs language-ini" lang="ini">/* src/react/packages/react-reconciler/src/ReactFiberHooks.old.js */

function enqueueRenderPhaseUpdate&lt;S, A&gt;(
  queue: UpdateQueue&lt;S, A&gt;,
  update: Update&lt;S, A&gt;,
) {
  const <span class="hljs-attr">pending</span> = queue.pending<span class="hljs-comment">;</span>
  if (<span class="hljs-attr">pending</span> === null) {
    <span class="hljs-attr">update.next</span> = update<span class="hljs-comment">;</span>
  } else {
    <span class="hljs-attr">update.next</span> = pending.next<span class="hljs-comment">;</span>
    <span class="hljs-attr">pending.next</span> = update<span class="hljs-comment">;</span>
  }
  <span class="hljs-attr">queue.pending</span> = update<span class="hljs-comment">;</span>
}


/* src/react/packages/react-reconciler/src/ReactFiberConcurrentUpdates.old.js */
export function enqueueConcurrentHookUpdate&lt;S, A&gt;(
  fiber: Fiber,
  queue: HookQueue&lt;S, A&gt;,
  update: HookUpdate&lt;S, A&gt;,
  lane: Lane,
) {
  const <span class="hljs-attr">interleaved</span> = queue.interleaved<span class="hljs-comment">;</span>
  if (<span class="hljs-attr">interleaved</span> === null) {
    <span class="hljs-attr">update.next</span> = update<span class="hljs-comment">;</span>
    pushConcurrentUpdateQueue(queue)<span class="hljs-comment">;</span>
  } else {
    <span class="hljs-attr">update.next</span> = interleaved.next<span class="hljs-comment">;</span>
    <span class="hljs-attr">interleaved.next</span> = update<span class="hljs-comment">;</span>
  }
  <span class="hljs-attr">queue.interleaved</span> = update<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-3">更新阶段</h3>
<p>在<code>mount</code>阶段初始化了<code>hook</code>对象，然后给开发者返回了<code>state</code>和<code>setState/dispath</code>函数。</p>
<p>而返回的<code>setState</code>函数我们上面已经分析过了，主要的作用就是将传入的<code>action</code>放到<code>hook</code>对象的更新队列<code>queue</code>中。</p>
<p>更新阶段我们看<code>updateState</code>的实现：<code>updateState</code>直接委托给了<code>updateReducer</code>，这揭示了一个重要事实：<code>useState</code>在更新阶段就是一个预定义<code>reducer</code>的<code>useReducer</code>。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">/* src/react/packages/react-reconciler/src/ReactFiberHooks.old.js */</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateState</span>&lt;<span class="hljs-title">S</span>&gt;(<span class="hljs-params">
  initialState: (<span class="hljs-params">(<span class="hljs-params"/>) =&gt; S</span>) | S,
</span>): [<span class="hljs-title">S</span>, <span class="hljs-title">Dispatch</span>&lt;<span class="hljs-title">BasicStateAction</span>&lt;<span class="hljs-title">S</span>&gt;&gt;] </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">updateReducer</span>(basicStateReducer, (<span class="hljs-attr">initialState</span>: any));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">basicStateReducer</span>&lt;<span class="hljs-title">S</span>&gt;(<span class="hljs-params">state: S, action: BasicStateAction&lt;S&gt;</span>): <span class="hljs-title">S</span> </span>{
  <span class="hljs-keyword">return</span> typeof action === <span class="hljs-string">'function'</span> ? <span class="hljs-title function_ invoke__">action</span>(state) : action;
}
</code></pre>
<ol>
<li><strong>队列合并</strong>：函数首先会将新加入的、尚未处理的更新队列 (<code>queue.pending</code>)，合并到当前正在处理的基础队列 (<code>current.baseQueue</code>) 中。这个合并操作确保了所有更新都在一个环状链表里按顺序排队。</li>
<li><strong>优先级分拣与状态计算</strong>（函数会遍历合并后的队列，对每一个更新进行检查）</li>
</ol>

<ol>
<li>
<ol>
<li>如果优先级不足：此更新被跳过，但它会被克隆一份，加入到 <code>newBaseQueue</code> 中。这个被跳过的队列，连同计算到此刻的状态 (<code>newBaseState</code>)，将成为下一次渲染时计算的起点（即新的<code>baseState</code>和<code>baseQueue</code>）。</li>
<li>如果优先级足够：此更新被处理。如果它之前已被预计算则直接采用计算结果（性能优化）；否则调用<code>reducer</code>函数，传入当前累积的<code>newState</code>和更新的<code>action</code>，计算出新的状态。</li>
</ol>
</li>
</ol>

<ol start="3">
<li><strong>交错更新处理</strong>：循环结束后，函数会检查是否存在<code>interleaved</code>更新（通常由高优先级更新中断低优先级渲染产生）。注意：这里并不会处理这些更新的具体内容（<code>action</code>），而只是将它们所携带的优先级（<code>lane</code>）合并到当前 <code>Fiber</code>中，确保系统知道“还有这些优先级的任务待办”。</li>
</ol>
<p>遍历完所有可以执行的任务后，得到一个新的<code>state</code>，返回新的<code>state</code>和<code>setStatus/dispath</code>方法。</p>
<pre><code class="hljs language-ini" lang="ini">function updateReducer&lt;S, I, A&gt;(
  reducer: (S, A) =&gt; S,
  initialArg: I,
  init?: <span class="hljs-attr">I</span> =&gt; S,
): <span class="hljs-section">[S, Dispatch&lt;A&gt;]</span> {
  const <span class="hljs-attr">hook</span> = updateWorkInProgressHook()<span class="hljs-comment">; // 获取当前正在处理的 WIP Hook</span>
  const <span class="hljs-attr">queue</span> = hook.queue<span class="hljs-comment">; // 获取该 Hook的更新队列</span>

  <span class="hljs-attr">queue.lastRenderedReducer</span> = reducer<span class="hljs-comment">; // 更新 reducer(对 useState就是 basicStateReducer)</span>

  const current: <span class="hljs-attr">Hook</span> = (currentHook: any)<span class="hljs-comment">;</span>

  let <span class="hljs-attr">baseQueue</span> = current.baseQueue<span class="hljs-comment">;  // baseQueue: 上一次渲染中被跳过的低优先级更新(环形链表: 指针指向最后一个节点)</span>
  const <span class="hljs-attr">pendingQueue</span> = queue.pending<span class="hljs-comment">; // pending: 本次渲染周期新产生、尚未处理的更新(环形链表: 指针指向最后一个节点)</span>

  // 合并队列: 将新更新(pendingQueue)合并到 baseQueue
  if (pendingQueue !== null) {
    if (baseQueue !== null) { // 两个环状链表合并
      const <span class="hljs-attr">baseFirst</span> = baseQueue.next<span class="hljs-comment">;</span>
      const <span class="hljs-attr">pendingFirst</span> = pendingQueue.next<span class="hljs-comment">;</span>
      <span class="hljs-attr">baseQueue.next</span> = pendingFirst<span class="hljs-comment">;</span>
      <span class="hljs-attr">pendingQueue.next</span> = baseFirst<span class="hljs-comment">;</span>
    }
    <span class="hljs-attr">current.baseQueue</span> = baseQueue = pendingQueue<span class="hljs-comment">; // 将合并后的队列设为新的 baseQueue</span>
    <span class="hljs-attr">queue.pending</span> = null<span class="hljs-comment">; // 清空更新队列</span>
  }

  // 处理队列: 遍历并计算新状态(核心循环)
  if (baseQueue !== null) {
    const <span class="hljs-attr">first</span> = baseQueue.next<span class="hljs-comment">;</span>
    let <span class="hljs-attr">newState</span> = current.baseState<span class="hljs-comment">;</span>

    let <span class="hljs-attr">newBaseState</span> = null<span class="hljs-comment">;</span>
    let <span class="hljs-attr">newBaseQueueFirst</span> = null<span class="hljs-comment">;</span>
    let <span class="hljs-attr">newBaseQueueLast</span> = null<span class="hljs-comment">;</span>
    let <span class="hljs-attr">update</span> = first<span class="hljs-comment">;</span>
    do {
      const <span class="hljs-attr">updateLane</span> = update.lane<span class="hljs-comment">;</span>
      // 判断优先级: 当前更新的优先级是否足够在当前渲染中执行? - 优先级不足
      if (!isSubsetOfLanes(renderLanes, updateLane)) {
        const clone: Update&lt;S, A&gt; = {
          lane: updateLane,
          action: update.action,
          hasEagerState: update.hasEagerState,
          eagerState: update.eagerState,
          next: (null: any),
        }<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">newBaseQueueLast</span> === null) {
          <span class="hljs-attr">newBaseQueueFirst</span> = newBaseQueueLast = clone<span class="hljs-comment">;</span>
          <span class="hljs-attr">newBaseState</span> = newState<span class="hljs-comment">;</span>
        } else {
          <span class="hljs-attr">newBaseQueueLast</span> = newBaseQueueLast.next = clone<span class="hljs-comment">;</span>
        }
        <span class="hljs-attr">currentlyRenderingFiber.lanes</span> = mergeLanes(
          currentlyRenderingFiber.lanes,
          updateLane,
        )<span class="hljs-comment">;</span>
        markSkippedUpdateLanes(updateLane)<span class="hljs-comment">;</span>
      } else {
        // This update does have sufficient priority.

        if (newBaseQueueLast !== null) {
          const clone: Update&lt;S, A&gt; = {
            lane: NoLane,
            action: update.action,
            hasEagerState: update.hasEagerState,
            eagerState: update.eagerState,
            next: (null: any),
          }<span class="hljs-comment">;</span>
          <span class="hljs-attr">newBaseQueueLast</span> = newBaseQueueLast.next = clone<span class="hljs-comment">;</span>
        }

        if (update.hasEagerState) {
          <span class="hljs-attr">newState</span> = ((update.eagerState: any): S)<span class="hljs-comment">;</span>
        } else {
          const <span class="hljs-attr">action</span> = update.action<span class="hljs-comment">;</span>
          <span class="hljs-attr">newState</span> = reducer(newState, action)<span class="hljs-comment">;</span>
        }
      }
      <span class="hljs-attr">update</span> = update.next<span class="hljs-comment">;</span>
    } while (update !== null &amp;&amp; update !== first)<span class="hljs-comment">;</span>

    if (<span class="hljs-attr">newBaseQueueLast</span> === null) {
      <span class="hljs-attr">newBaseState</span> = newState<span class="hljs-comment">;</span>
    } else {
      <span class="hljs-attr">newBaseQueueLast.next</span> = (newBaseQueueFirst: any)<span class="hljs-comment">;</span>
    }

    if (!is(newState, hook.memoizedState)) {
      markWorkInProgressReceivedUpdate()<span class="hljs-comment">;</span>
    }

    <span class="hljs-attr">hook.memoizedState</span> = newState<span class="hljs-comment">;</span>
    <span class="hljs-attr">hook.baseState</span> = newBaseState<span class="hljs-comment">;</span>
    <span class="hljs-attr">hook.baseQueue</span> = newBaseQueueLast<span class="hljs-comment">;</span>

    <span class="hljs-attr">queue.lastRenderedState</span> = newState<span class="hljs-comment">;</span>
  }

  const <span class="hljs-attr">lastInterleaved</span> = queue.interleaved<span class="hljs-comment">;</span>
  if (lastInterleaved !== null) {
    let <span class="hljs-attr">interleaved</span> = lastInterleaved<span class="hljs-comment">;</span>
    do {
      const <span class="hljs-attr">interleavedLane</span> = interleaved.lane<span class="hljs-comment">;</span>
      <span class="hljs-attr">currentlyRenderingFiber.lanes</span> = mergeLanes(
        currentlyRenderingFiber.lanes,
        interleavedLane,
      )<span class="hljs-comment">;</span>
      markSkippedUpdateLanes(interleavedLane)<span class="hljs-comment">;</span>
      <span class="hljs-attr">interleaved</span> = ((interleaved: any).next: Update&lt;S, A&gt;)<span class="hljs-comment">;</span>
    } while (interleaved !== lastInterleaved)<span class="hljs-comment">;</span>
  } else if (<span class="hljs-attr">baseQueue</span> === null) {
    <span class="hljs-attr">queue.lanes</span> = NoLanes<span class="hljs-comment">;</span>
  }

  const dispatch: Dispatch&lt;A&gt; = (queue.dispatch: any)<span class="hljs-comment">;</span>
  return <span class="hljs-section">[hook.memoizedState, dispatch]</span><span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-4">useReducer 源码</h2>
<p><code>useReducer</code>其实就是可以自定义更新方法的<code>useState</code>。</p>
<pre><code class="hljs language-ini" lang="ini">function mountReducer&lt;S, I, A&gt;(
  reducer: (S, A) =&gt; S,
  initialArg: I,
  init?: <span class="hljs-attr">I</span> =&gt; S,
): <span class="hljs-section">[S, Dispatch&lt;A&gt;]</span> {
  // 创建新的Hook对象并添加到正在渲染的Fiber节点的Hook链表末尾
  const <span class="hljs-attr">hook</span> = mountWorkInProgressHook()<span class="hljs-comment">;</span>
  // 计算初始状态值
  let initialState<span class="hljs-comment">;</span>
  if (init !== undefined) {
    <span class="hljs-attr">initialState</span> = init(initialArg)<span class="hljs-comment">;</span>
  } else {
    <span class="hljs-attr">initialState</span> = ((initialArg: any): S)<span class="hljs-comment">;</span>
  }
  <span class="hljs-attr">hook.memoizedState</span> = hook.baseState = initialState<span class="hljs-comment">;</span>
  const queue: UpdateQueue&lt;S, A&gt; = {
    pending: null,
    interleaved: null,
    lanes: NoLanes,
    dispatch: null,
    lastRenderedReducer: reducer,
    lastRenderedState: (initialState: any),
  }<span class="hljs-comment">;</span>
  <span class="hljs-attr">hook.queue</span> = queue<span class="hljs-comment">;</span>
  const dispatch: Dispatch&lt;A&gt; = (<span class="hljs-attr">queue.dispatch</span> = (dispatchReducerAction.bind(
    null,
    currentlyRenderingFiber,
    queue,
  ): any))<span class="hljs-comment">;</span>
  return <span class="hljs-section">[hook.memoizedState, dispatch]</span><span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-5">总结</h2>
<p><strong>React Hooks 设计的精妙之处</strong></p>
<ol>
<li><strong>最小化 API，最大化能力</strong>：通过极简的<code>API</code>设计，提供了强大的状态管理能力</li>
<li><strong>函数式理念的贯彻</strong>：纯函数组件 + 不可变状态更新 = 可预测的<code>UI</code></li>
<li><strong>性能优化的内置</strong>：自动的<code>bail-out</code>机制，减少不必要的渲染</li>
</ol>
<p>下一章我们将了解其他<code>hook</code>的实现方式</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 AI 生成高质量 Mock 数据的实践]]></title>    <link>https://juejin.cn/post/7603004323870851115</link>    <guid>https://juejin.cn/post/7603004323870851115</guid>    <pubDate>2026-02-05T02:39:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603004323870851115" data-draft-id="7602816610932932671" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 AI 生成高质量 Mock 数据的实践"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-05T02:39:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 AI 生成高质量 Mock 数据的实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T02:39:04.000Z" title="Thu Feb 05 2026 02:39:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在前后端分离的研发模式下，Mock 数据是并行开发的基础设施。本文介绍一套 Mock 工具的技术实现，核心解决四个问题：请求拦截、规则匹配、数据质量、团队共享。</p>
</blockquote>
<h2 data-id="heading-0">背景</h2>
<p>在实际业务开发中，前端和测试同学经常遇到这些问题：</p>
<ul>
<li><strong>联调阻塞</strong>：后端接口未就绪时，前端只能等待或硬编码 <code>if (true) { ... }</code></li>
<li><strong>场景覆盖难</strong>：想模拟边缘场景（异常、空数据、分页），往往需要后端改数据库</li>
<li><strong>Mock 数据质量差</strong>：Mock.js 生成的 <code>@cname</code>、<code>@integer</code> 缺乏业务语义，和真实数据差距大</li>
<li><strong>数据难共享</strong>：Mock 数据存在本地，换台电脑或换个同事就用不了</li>
</ul>
<p>我们需要一套工具解决这些问题：</p>
<ul>
<li>不侵入业务代码，npm 包引入即可</li>
<li>支持参数级别的规则匹配，同一接口可配置多个场景</li>
<li>根据接口文档自动生成符合业务语义的数据</li>
<li>支持团队共享 Mock 配置</li>
</ul>
<hr/>
<h2 data-id="heading-1">业界常见方案</h2>



































<table><thead><tr><th>方案</th><th>优点</th><th>不足</th></tr></thead><tbody><tr><td>硬编码 Mock</td><td>简单直接</td><td>侵入业务代码，发布前需手动删除</td></tr><tr><td>Mock.js</td><td>有数据生成能力</td><td>规则配置繁琐，数据缺乏业务语义</td></tr><tr><td>whistle 代理</td><td>不侵入业务，使用简单</td><td>数据保存在本地，无法团队共享，无法匹配复杂场景</td></tr><tr><td>MSW (Service Worker)</td><td>网络层拦截</td><td>需注册 sw.js，依赖 HTTPS，接入成本高</td></tr><tr><td>浏览器插件</td><td>使用简单 无侵入式</td><td>规则在本地，无法接入内部接口平台</td></tr></tbody></table>
<p>这些方案都无法同时满足"低侵入"、"规则灵活"、"数据质量高"、"团队可共享"四个需求。</p>
<hr/>
<h2 data-id="heading-2">整体架构</h2>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────┐
│                        业务项目                              │
│   import { mockInit } <span class="hljs-selector-tag">from</span> '<span class="hljs-keyword">@zz-common</span>/ai_mock'             │
│   mockInit({ rules: [<span class="hljs-string">'api.example.com'</span>] })                  │
└────────────────────────────┬────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────┐
│                    ai_mock (npm 包)                         │
│      XHR/Fetch 拦截  →  规则匹配引擎  →  返回 Mock 数据         │
└────────────────────────────┬────────────────────────────────┘
                             │ 动态加载 sdk + CustomEvent 通信
┌────────────────────────────▼────────────────────────────────┐
│                  mock-sdk (可视化面板)                        │
│        请求列表  |  规则管理  |  Monaco Editor 编辑器           │
└────────────────────────────┬────────────────────────────────┘
                             │ HTTP
┌────────────────────────────▼────────────────────────────────┐
│                   node (后端服务)                            │
│         接口文档获取  →  AI 生成  →  数据持久化                 │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<p>核心设计：</p>
<ul>
<li><code>ai_mock</code> 只负责拦截和匹配，不包含 UI 代码</li>
<li><code>mock-sdk</code> 通过 CDN 动态注入，不增加业务包体积</li>
<li>两者通过 <code>CustomEvent</code> 松耦合通信</li>
<li>仅在非生产环境启用</li>
</ul>
<hr/>
<h2 data-id="heading-3">核心实现一：请求拦截</h2>
<h3 data-id="heading-4">问题</h3>
<p>现代前端应用混合使用 <code>XMLHttpRequest</code> 和 <code>fetch</code>。拦截时需要解决：</p>
<ol>
<li>同时拦截 XHR 和 Fetch，且不破坏第三方库（如 Sentry）的监听逻辑</li>
<li>XHR 的 <code>readyState</code>、<code>status</code>、<code>responseText</code> 是只读属性，无法直接赋值</li>
<li>拦截后发送真实请求会再次进入拦截逻辑，造成无限递归</li>
</ol>
<h3 data-id="heading-5">实现</h3>
<p>通过重写 <code>XMLHttpRequest.prototype.send</code> 和 <code>window.fetch</code> 实现拦截：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 保存原始方法</span>
<span class="hljs-keyword">const</span> xhrSendNative = <span class="hljs-title class_">XMLHttpRequest</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">send</span>
<span class="hljs-keyword">const</span> originalFetch = <span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span>

<span class="hljs-comment">// 防递归：标记真实请求</span>
<span class="hljs-keyword">const</span> isRealRequest = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>&lt;<span class="hljs-title class_">XMLHttpRequest</span>, <span class="hljs-built_in">boolean</span>&gt;()

<span class="hljs-title class_">XMLHttpRequest</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">send</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
  <span class="hljs-keyword">const</span> xhr = <span class="hljs-variable language_">this</span>
  <span class="hljs-keyword">const</span> url = <span class="hljs-title function_">sliceUrlPath</span>(xhr.<span class="hljs-property">originRequestUrl</span>)
  
  <span class="hljs-comment">// 检查是否为标记的真实请求，防止无限递归</span>
  <span class="hljs-keyword">if</span> (isRealRequest.<span class="hljs-title function_">get</span>(xhr)) {
    <span class="hljs-keyword">return</span> xhrSendNative.<span class="hljs-title function_">apply</span>(xhr, args)
  }
  
  <span class="hljs-comment">// 检查是否命中 Mock 规则</span>
  <span class="hljs-keyword">if</span> (mockInterface[url]?.<span class="hljs-property">isOpen</span>) {
    <span class="hljs-keyword">const</span> mockResult = <span class="hljs-title function_">getMockData</span>(url, requestData)
    
    <span class="hljs-keyword">if</span> (mockResult.<span class="hljs-property">matched</span>) {
      <span class="hljs-comment">// 1. 立即返回 Mock 响应给业务层</span>
      <span class="hljs-title function_">applyMockResponseToXhr</span>(xhr, mockResult.<span class="hljs-property">data</span>, mockResult.<span class="hljs-property">httpStatusCode</span>)
      
      <span class="hljs-comment">// 2. 后台发送真实请求（用于数据对照，不触发业务回调）</span>
      <span class="hljs-keyword">const</span> realXhr = <span class="hljs-title function_">cloneXHR</span>(xhr, <span class="hljs-literal">false</span>)  <span class="hljs-comment">// 不复制事件监听器</span>
      isRealRequest.<span class="hljs-title function_">set</span>(realXhr, <span class="hljs-literal">true</span>)       <span class="hljs-comment">// 标记，防止递归</span>
      xhrSendNative.<span class="hljs-title function_">apply</span>(realXhr, args)
      <span class="hljs-keyword">return</span>
    }
  }
  
  <span class="hljs-comment">// 未命中：执行原生请求</span>
  xhrSendNative.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
}
</code></pre>
<p><strong>覆写只读属性</strong>：XHR 的 <code>readyState</code>、<code>status</code> 等属性是只读的，通过 <code>Object.defineProperties</code> 解决：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">applyMockResponseToXhr</span> = (<span class="hljs-params">
  xhr: XMLHttpRequest,
  responseData: <span class="hljs-built_in">any</span>,
  statusCode: <span class="hljs-built_in">number</span>
</span>) =&gt; {
  <span class="hljs-keyword">const</span> responseText = <span class="hljs-keyword">typeof</span> responseData === <span class="hljs-string">'string'</span> 
    ? responseData 
    : <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(responseData)
  
  <span class="hljs-comment">// 通过 defineProperties 覆写只读属性</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperties</span>(xhr, {
    <span class="hljs-attr">readyState</span>: { <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-number">4</span>, <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-attr">status</span>: { <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> statusCode, <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-attr">response</span>: { <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> responseData, <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-attr">responseText</span>: { <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> responseText, <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span> }
  })
  
  <span class="hljs-comment">// 触发标准事件序列</span>
  xhr.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'readystatechange'</span>))
  xhr.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'load'</span>))
  xhr.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'loadend'</span>))
}
</code></pre>
<p><strong>立即响应 + 真实请求</strong>：开启 Mock 后，业务层立即拿到 Mock 数据，同时后台会发送一份真实请求用于数据对照。面板提供「加载真实数据」按钮，可以一键将真实响应填入编辑器，方便基于真实数据微调。</p>
<hr/>
<h2 data-id="heading-6">核心实现二：规则匹配引擎</h2>
<h3 data-id="heading-7">问题</h3>
<p>实际业务中，同一个接口需要根据不同参数返回不同数据：</p>
<ul>
<li><code>page=1</code> 返回第一页，<code>page=2</code> 返回第二页</li>
<li><code>userId=vip</code> 返回 VIP 数据，<code>userId=normal</code> 返回普通数据</li>
<li><code>header</code> 中带某个标识时返回调试数据</li>
</ul>
<p>参数可能在 URL Query、Request Body、Header、Cookie、Path 中，需要一套灵活的规则匹配机制。</p>
<h3 data-id="heading-8">规则数据结构</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MockRule</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">priority</span>: <span class="hljs-built_in">number</span>;  <span class="hljs-comment">// 优先级，数字越小越优先</span>
  <span class="hljs-attr">enabled</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">type</span>: <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">3</span>;   <span class="hljs-comment">// 1=本地草稿，2=个人云端，3=团队共享</span>
  <span class="hljs-attr">paramConditions</span>: <span class="hljs-title class_">ParamCondition</span>[];  <span class="hljs-comment">// 参数条件</span>
  <span class="hljs-attr">mockData</span>: <span class="hljs-built_in">any</span>;
  <span class="hljs-attr">httpStatusCode</span>: <span class="hljs-built_in">number</span>;
  delay?: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ParamCondition</span> {
  <span class="hljs-attr">location</span>: <span class="hljs-string">'query'</span> | <span class="hljs-string">'body'</span> | <span class="hljs-string">'header'</span> | <span class="hljs-string">'cookie'</span> | <span class="hljs-string">'path'</span>;
  <span class="hljs-attr">paramName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">operator</span>: <span class="hljs-string">'equals'</span> | <span class="hljs-string">'notEquals'</span> | <span class="hljs-string">'contains'</span> | <span class="hljs-string">'notContains'</span> | 
            <span class="hljs-string">'greaterThan'</span> | <span class="hljs-string">'lessThan'</span> | <span class="hljs-string">'greaterOrEqual'</span> | <span class="hljs-string">'lessOrEqual'</span>;
  <span class="hljs-attr">value</span>: <span class="hljs-built_in">any</span>;
}
</code></pre>
<h3 data-id="heading-9">匹配算法</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">matchRule</span>(<span class="hljs-params">rules: MockRule[], request: RequestInfo</span>): <span class="hljs-title class_">MatchResult</span> {
  <span class="hljs-comment">// 只匹配已启用的期望，按优先级排序</span>
  <span class="hljs-keyword">const</span> enabledRules = rules
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">rule</span> =&gt;</span> rule.<span class="hljs-property">enabled</span>)
    .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">priority</span> - b.<span class="hljs-property">priority</span>);

  <span class="hljs-keyword">const</span> matched = enabledRules.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">rule</span> =&gt;</span> <span class="hljs-title function_">isRuleMatched</span>(rule, request));
  
  <span class="hljs-keyword">return</span> matched 
    ? { <span class="hljs-attr">matched</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">rule</span>: matched, <span class="hljs-attr">delay</span>: matched.<span class="hljs-property">delay</span> ?? <span class="hljs-number">0</span> }
    : { <span class="hljs-attr">matched</span>: <span class="hljs-literal">false</span> };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">isRuleMatched</span>(<span class="hljs-params">rule: MockRule, request: RequestInfo</span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-comment">// 没有参数条件，匹配所有请求</span>
  <span class="hljs-keyword">if</span> (!rule.<span class="hljs-property">paramConditions</span>?.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  
  <span class="hljs-comment">// 所有条件都满足才匹配（AND 关系）</span>
  <span class="hljs-keyword">return</span> rule.<span class="hljs-property">paramConditions</span>.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">condition</span> =&gt;</span>
    <span class="hljs-title function_">matchParamCondition</span>(condition, request)
  );
}
</code></pre>
<h3 data-id="heading-10">参数值获取</h3>
<p>根据 <code>location</code> 从不同位置取值：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getParamValue</span>(<span class="hljs-params">location: <span class="hljs-built_in">string</span>, paramName: <span class="hljs-built_in">string</span>, request: RequestInfo</span>): <span class="hljs-built_in">any</span> {
  <span class="hljs-keyword">switch</span> (location) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'query'</span>:
      <span class="hljs-keyword">return</span> request.<span class="hljs-property">query</span>?.[paramName];
    <span class="hljs-keyword">case</span> <span class="hljs-string">'body'</span>:
      <span class="hljs-comment">// 支持嵌套路径，如 body.user.id</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">getNestedValue</span>(<span class="hljs-title function_">parseBody</span>(request.<span class="hljs-property">body</span>), paramName);
    <span class="hljs-keyword">case</span> <span class="hljs-string">'header'</span>:
      <span class="hljs-keyword">return</span> request.<span class="hljs-property">headers</span>?.[paramName];
    <span class="hljs-keyword">case</span> <span class="hljs-string">'cookie'</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">parseCookie</span>(request.<span class="hljs-property">headers</span>?.<span class="hljs-property">cookie</span>, paramName);
    <span class="hljs-keyword">case</span> <span class="hljs-string">'path'</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">extractPathParam</span>(request.<span class="hljs-property">url</span>, paramName);
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  }
}
</code></pre>
<p>比较时会做类型兼容处理，比如 <code>1</code> 和 <code>"1"</code> 视为相等，避免因类型不一致导致匹配失败。</p>
<h3 data-id="heading-11">使用示例</h3>






























<table><thead><tr><th>请求参数</th><th>规则配置</th><th>结果</th></tr></thead><tbody><tr><td><code>?page=1</code></td><td><code>query.page equals 1</code></td><td>返回第一页数据</td></tr><tr><td><code>?page=2</code></td><td><code>query.page equals 2</code></td><td>返回第二页数据</td></tr><tr><td><code>body: {"user":{"type":"vip"}}</code></td><td><code>body.user.type equals "vip"</code></td><td>返回 VIP 数据</td></tr><tr><td><code>Header: X-Debug: true</code></td><td><code>header.X-Debug equals "true"</code></td><td>返回调试数据</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-12">核心实现三：AI 生成高质量数据</h2>
<h3 data-id="heading-13">问题</h3>
<p>Mock.js 生成的数据缺乏业务语义：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Mock.js 生成</span>
{ <span class="hljs-attr">name</span>: <span class="hljs-string">"xxx"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">82</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">3</span> }

<span class="hljs-comment">// 期望的业务数据</span>
{ <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">28</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">1</span> }  <span class="hljs-comment">// status: 0=待审核, 1=已通过, 2=已拒绝</span>
</code></pre>
<p>我们希望根据接口文档中的字段描述、枚举说明、字段命名来生成符合业务语义的数据, 这样文档备注越详细 字段名定义越清晰 生成数据会越准确。</p>
<h3 data-id="heading-14">实现思路</h3>
<p>后端服务从 API文档平台 获取接口的 JSON Schema，构建 Prompt 调用 AI 生成数据。</p>
<p><strong>核心 Prompt 设计</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> systemPrompt = <span class="hljs-string">`
你是 Mock 数据生成专家，根据 JSON Schema 生成符合业务场景的数据。

【生成规则 - 按优先级排序】
1. 若 description 中存在枚举说明（如 "0:成功, 1:失败"），优先使用枚举值本身（如 0、1）
2. 若无 description，则根据字段名的语义生成合理值
3. 数组类型默认生成 5 条数据
4. 若 description 中枚举值较多，数组应覆盖所有枚举值

【默认值规则】
- respCode / code：成功场景为 0，失败场景为 -1
- errorMsg：成功场景为 null，失败场景为 "系统异常"
- 图片 URL：使用统一的占位图地址
- 普通 URL：使用统一的域名地址

【输出格式】
仅输出 JSON，不附加任何解释文字
`</span>;
</code></pre>
<p><strong>关键设计点</strong>：</p>
<ol>
<li><strong>description 优先</strong>：接口文档中 <code>status: 0=待审核, 1=已通过</code> 这类描述会被优先使用</li>
<li><strong>字段名语义</strong>：<code>userName</code> 生成中文姓名，<code>price</code> 生成合理价格</li>
<li><strong>枚举覆盖</strong>：数组字段会尽量覆盖所有枚举值，便于测试</li>
<li><strong>默认成功场景</strong>：除非用户指定，否则生成正常数据</li>
</ol>
<h3 data-id="heading-15">数据校验</h3>
<p>AI 生成的 JSON 可能格式有问题，通过 <code>jsonrepair</code> 验证修复：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> jsonMatch = result.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\{[\s\S]*\}/</span>);
<span class="hljs-keyword">if</span> (jsonMatch) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">jsonrepair</span>(jsonMatch[<span class="hljs-number">0</span>]);
}
</code></pre>
<p>生成后对比 Schema 和实际数据，字段缺失时发送告警。</p>
<h3 data-id="heading-16">生成模式</h3>
<ul>
<li><strong>整体生成</strong>：根据完整 Schema 生成所有字段</li>
<li><strong>选区生成</strong>：只替换选中的字段，保留其他字段不变</li>
<li><strong>自定义 Prompt</strong>：用户可输入额外要求，如"生成 VIP 用户数据"、"价格在 100-500 之间"、"生成10条数据"、"生成某个场景值的数据"等</li>
</ul>
<hr/>
<h2 data-id="heading-17">核心实现四：三层作用域</h2>
<h3 data-id="heading-18">问题</h3>
<p>Mock 数据存在本地的问题：</p>
<ul>
<li>换台电脑就没了</li>
<li>同事想用同一套数据，只能手动复制</li>
<li>团队标准测试数据无法统一管理</li>
</ul>
<h3 data-id="heading-19">设计</h3>
<p>三层作用域解决不同场景的需求：</p>





























<table><thead><tr><th>作用域</th><th>存储位置</th><th>可见性</th><th>典型场景</th></tr></thead><tbody><tr><td>本地草稿</td><td>IndexedDB</td><td>仅当前设备</td><td>临时调试</td></tr><tr><td>个人云端</td><td>远程数据库</td><td>仅创建者</td><td>跨设备同步</td></tr><tr><td>团队共享</td><td>远程数据库</td><td>所有团队成员</td><td>标准测试数据</td></tr></tbody></table>
<p><strong>关键设计</strong>：</p>
<ol>
<li><strong>优先级和启用状态仅在本地维护</strong>：避免团队成员互相干扰</li>
<li><strong>云端只存期望内容</strong>：每个人独立控制"哪些期望启用、优先级如何排序"</li>
<li><strong>规则缓存</strong>：加载后缓存在 <code>window.__mockRulesCache</code>，避免重复读取 IndexedDB</li>
</ol>
<h3 data-id="heading-20">数据结构</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MockRule</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">3</span>;  <span class="hljs-comment">// 1=本地草稿，2=个人云端，3=团队共享</span>
  <span class="hljs-attr">enabled</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 本地维护</span>
  <span class="hljs-attr">priority</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 本地维护</span>
  <span class="hljs-comment">// ... 其他字段</span>
}
</code></pre>
<h3 data-id="heading-21">事件通信</h3>
<p>SDK 与 UI 面板通过 CustomEvent 通信：</p>

























<table><thead><tr><th>事件名</th><th>方向</th><th>用途</th></tr></thead><tbody><tr><td><code>mock-request-end</code></td><td>SDK → UI</td><td>请求完成上报</td></tr><tr><td><code>mock-interface-switch</code></td><td>UI → SDK</td><td>单接口开关控制</td></tr><tr><td><code>mock-rules-updated</code></td><td>UI → SDK</td><td>规则更新通知</td></tr></tbody></table>
<h3 data-id="heading-22">数据清理</h3>
<p>自动清理 30 天未使用的本地数据，自动清理非活跃的数据 避免存储膨胀：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">await</span> <span class="hljs-title function_">cleanupInactiveData</span>(<span class="hljs-number">30</span>);
</code></pre>
<hr/>
<h2 data-id="heading-23">动态模板语法</h2>
<p>支持在 Mock 数据中引用请求参数，实现"响应随请求变化"：</p>



































<table><thead><tr><th>语法</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>{{Date.now()}}</code></td><td>当前时间戳</td><td><code>1706432400000</code></td></tr><tr><td><code>{{uuid()}}</code></td><td>生成 UUID</td><td><code>"a1b2c3d4-..."</code></td></tr><tr><td><code>{{request.query.xxx}}</code></td><td>获取 URL 参数</td><td><code>{{request.query.page}}</code></td></tr><tr><td><code>{{request.body.xxx}}</code></td><td>获取请求体字段</td><td><code>{{request.body.userId}}</code></td></tr><tr><td><code>{{request.headers.xxx}}</code></td><td>获取请求头</td><td><code>{{request.headers.token}}</code></td></tr></tbody></table>
<p>示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"requestId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{{uuid()}}"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{{Date.now()}}"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"userId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{{request.body.userId}}"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"page"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{{request.query.page}}"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-24">快速开始</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 安装</span>
npm install <span class="hljs-meta">@zz</span>-common/ai_mock

<span class="hljs-comment">// 2. 初始化</span>
<span class="hljs-keyword">import</span> { mockInit } <span class="hljs-keyword">from</span> <span class="hljs-string">'@zz-common/ai_mock'</span>

<span class="hljs-title function_">mockInit</span>({
  <span class="hljs-attr">rules</span>: [<span class="hljs-string">'api.example.com'</span>],      <span class="hljs-comment">// 拦截的域名</span>
  <span class="hljs-attr">excludeRules</span>: [<span class="hljs-regexp">/static/</span>, <span class="hljs-regexp">/cdn/</span>]  <span class="hljs-comment">// 排除的资源</span>
})
</code></pre>
<h2 data-id="heading-25">推荐工作流</h2>
<p>下面演示从请求采集到 AI 生成 Mock 数据的完整流程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/412918b4575440488ee46ab82d54fb31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770863944&amp;x-signature=%2BY5Ha6UIl1%2Bn86hwo0z%2B0DpXwjY%3D" alt="24182e81-01bc-11f1-83a0-e2f0e015208e.gif" loading="lazy"/></p>
<ol>
<li><strong>接入 npm 包</strong>：在非生产环境启用拦截</li>
<li><strong>从真实请求创建 Mock</strong>：打开面板，点击请求日志的"创建期望"</li>
<li><strong>配置参数条件</strong>：同一接口不同参数返回不同数据</li>
<li><strong>AI 生成补充</strong>：用 AI 生成符合业务语义的数据</li>
<li><strong>团队共享</strong>：将稳定的测试数据推送到团队共享</li>
</ol>
<hr/>
<h2 data-id="heading-26">总结</h2>
<p>本文介绍的 Mock 工具解决了四个核心问题：</p>

























<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td>请求拦截</td><td>Monkey Patch 重写 XHR/Fetch，通过 WeakMap 防递归</td></tr><tr><td>规则匹配</td><td>支持 5 种参数位置 × 8 种操作符，按优先级排序</td></tr><tr><td>数据质量</td><td>AI 根据接口文档的 description、字段名语义生成数据</td></tr><tr><td>团队共享</td><td>三层作用域，本地维护启用状态和优先级</td></tr></tbody></table>
<p>目前这套工具已在公司内部使用，可以减少联调阻塞、提高场景覆盖率。</p>
<h2 data-id="heading-27">未来规划</h2>
<ul>
<li><strong>流量录制回放</strong>：基于真实流量生成 Mock 数据，数据更贴近线上场景</li>
<li><strong>AI生成数据时基于真实数据</strong>：进一步提升AI生成数据质量 贴近真实业务场景</li>
<li><strong>移动端支持</strong>：真机环境下配合 PC 端使用 Mock 数据验证</li>
<li><strong>规则推荐</strong>：基于历史请求，自动推荐可能需要的 Mock 场景</li>
</ul>
<blockquote>
<p>转转研发中心及业界小伙伴们的技术学习交流平台，定期分享一线的实战经验及业界前沿的技术话题。 关注公众号「转转技术」（综合性）、「大转转FE」（专注于FE）、「转转QA」（专注于QA），更多干货实践，欢迎交流分享~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 Starlight 文档站点接入 Microsoft Clarity 的完整实践指南]]></title>    <link>https://juejin.cn/post/7602910573404831782</link>    <guid>https://juejin.cn/post/7602910573404831782</guid>    <pubDate>2026-02-05T01:14:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602910573404831782" data-draft-id="7602901565025599497" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 Starlight 文档站点接入 Microsoft Clarity 的完整实践指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-05T01:14:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="newbe36524"/> <meta itemprop="url" content="https://juejin.cn/user/2682464104098654"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 Starlight 文档站点接入 Microsoft Clarity 的完整实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464104098654/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    newbe36524
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T01:14:26.000Z" title="Thu Feb 05 2026 01:14:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从数据洞察到用户增长：HagiCode 博客接入 Clarity Analytics 的完整指南</h2>
<blockquote>
<p>本文将分享如何在 Starlight 文档站点中优雅地接入 Microsoft Clarity，不仅能看清用户行为，还能确保隐私合规。这套方案是我们在 HagiCode 项目中实践总结出来的，希望能给同样在折腾数据统计的你一点参考。</p>
</blockquote>

<h3 data-id="heading-1">背景：为什么我们需要 Clarity？</h3>
<p>以下代码展示了如何在 Astro 集成中根据环境变量动态注入 Microsoft Clarity 脚本，仅在生效时进行生产环境加载。</p>

<pre><code class="hljs language-markdown" lang="markdown">105 | interface Props {
106 |   // 未来可扩展: 允许手动覆盖 Project ID
107 |   projectId?: string;
108 | }
109 | 
110 | const {
111 |   projectId = import.meta.env.CLARITY<span class="hljs-emphasis">_PROJECT_</span>ID,
112 | } = Astro.props;
113 | 
114 | const isProduction = import.meta.env.PROD;
115 | ---
116 | 
117 | {isProduction &amp;&amp; projectId &amp;&amp; (
118 |   <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">is:inline</span> <span class="hljs-attr">define:vars</span>=<span class="hljs-string">{{projectId}}</span>&gt;</span></span>
119 |     (function(c,l,a,r,i,t,y){
</code></pre>
<p><em>文件：<code>openspec/changes/archive/2026-01-30-microsoft-clarity-integration/design.md</code></em></p>
<p>在运营 <strong>HagiCode</strong> 的过程中，我们一直面临一个"盲盒"问题：我们产出内容，但不清楚用户是如何阅读的。虽然 GitHub 能看到 Star 数，但这太滞后了。我们需要知道：</p>
<ul>
<li>用户到底有没有看完我们的教程？</li>
<li>那些复杂的配置文档，是在哪一步劝退了用户的？</li>
<li>我们的 SEO 优化是否真的带来了有效流量？</li>
</ul>
<p>市面上有很多分析工具，比如 Google Analytics（GA）和 Microsoft Clarity。GA 功能强大但配置复杂，且受到隐私法规（如 GDPR）的严格限制。而 Clarity 作为微软推出的免费热力图工具，不仅功能直观，而且在隐私合规上相对宽松，非常适合技术文档站点。</p>
<p><strong>我们的目标很明确</strong>：在 <strong>HagiCode</strong> 的文档站点中无缝集成 Clarity，既要在所有页面生效，又要给用户留有"退出"的权利（隐私合规）。</p>
<h3 data-id="heading-2">关于 HagiCode</h3>
<p>HagiCode 主题初始化逻辑：优先读取本地存储，回退至系统偏好，默认暗色。</p>

<pre><code class="hljs language-markdown" lang="markdown">67 | function getInitialTheme(): Theme {
68 |   // 1. 检查 localStorage
69 |   const stored = localStorage.getItem('hagicode-theme');
70 |   if (stored) return stored as Theme;
71 | 
72 |   // 2. 检测系统偏好
73 |   const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
74 |   if (systemDark) return 'dark';
75 | 
76 |   // 3. 默认暗色
77 |   return 'dark';
78 | }
79 | <span class="hljs-code">```
80 | 
81 | ### 决策 3：主题应用方式
82 | 
83 | **选择**：在 `&lt;html&gt;` 根元素设置 `data-theme` 属性
84 | 
85 | **对比方案**：
86 | 
</span></code></pre>
<p><em>文件：<code>openspec/changes/archive/2026-01-29-theme-toggle-implementation/design.md</code></em></p>
<p>本文分享的方案来自我们在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FHagiCode-org%2Fsite" target="_blank" title="https://github.com/HagiCode-org/site" ref="nofollow noopener noreferrer">HagiCode</a> 项目中的实践经验。HagiCode 是一个基于 AI 的代码辅助工具，在开发过程中，我们需要维护大量的技术文档和博客。为了更好地理解用户需求，我们探索并实施了这套数据接入方案。</p>
<h3 data-id="heading-3">技术选型与探索</h3>
<p>起初，我们在 Proposal 阶段讨论了多种集成方式。既然我们使用的是 Starlight（基于 Astro 的文档框架），最直观的想法是利用 Astro 的 Hooks。</p>
<p>我们首先尝试了修改 <code>astro.config.mjs</code>，计划在构建时注入 Clarity 脚本。虽然这种方式能保证全局覆盖，但缺乏灵活性——我们无法根据用户的偏好动态加载或卸载脚本。</p>
<p>考虑到用户体验和隐私控制，我们最终决定采用 <strong>组件覆盖</strong> 的方案。Starlight 允许开发者覆盖其内部组件，这意味着我们可以接管 <code>&lt;footer&gt;</code> 或 <code>&lt;head&gt;</code> 的渲染逻辑，从而精细控制 Clarity 的加载时机。</p>
<p>这里有一个小插曲：原本我们想创建一个名为 <code>StarlightWrapper.astro</code> 的布局包装器。但在实际调试中发现，Starlight 的路由机制并不会自动调用这个自定义 Wrapper，这导致脚本在部分页面失效。这算是一个典型的"想当然"踩坑经历，提醒我们<strong>必须深入理解框架的渲染流程，而不是盲目套用通用框架模式</strong>。</p>
<h3 data-id="heading-4">核心方案：Footer 组件覆盖</h3>
<p>为了确保 Clarity 脚本在所有页面（包括文档和博客）加载，并且不破坏原有的页面结构，我们选择了覆盖 Starlight 的 <code>Footer</code> 组件。</p>
<h4 data-id="heading-5">为什么是 Footer？</h4>
<ol>
<li><strong>全局性</strong>：Footer 几乎在所有标准页面都会出现。</li>
<li><strong>非侵入性</strong>：将脚本放在 Footer 区域（实际渲染在 body 底部）不会阻塞页面的关键渲染路径（LCP），对性能影响最小。</li>
<li><strong>逻辑集中</strong>：可以在组件内部统一处理 Cookie 同意逻辑。</li>
</ol>
<h4 data-id="heading-6">实施步骤</h4>
<h5 data-id="heading-7">1. 准备 Clarity 项目</h5>
<p>首先，你需要在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fclarity.microsoft.com%2F" target="_blank" title="https://clarity.microsoft.com/" ref="nofollow noopener noreferrer">Microsoft Clarity</a> 注册并创建一个新项目。获取你的 Project ID（类似 <code>k8z2ab3xxx</code> 这样的字符串）。</p>
<h5 data-id="heading-8">2. 环境变量配置</h5>
<p>下面通过环境变量配置与日期判断代码，实现新年期间的逻辑控制，请参考具体实现。</p>

<pre><code class="hljs language-text" lang="text">46 |         function isLunarNewYearPeriod() {
47 |           const now = new Date();
48 |           const year = now.getFullYear();
49 |           const month = now.getMonth() + 1; // 1-12
50 |           const day = now.getDate();
51 | 
52 |           // 2025年蛇年新年期间 (1月29日 - 2月12日)
53 |           if (year === 2025) {
54 |             if (month === 1 &amp;&amp; day &gt;= 29) return true;
55 |             if (month === 2 &amp;&amp; day &lt;= 12) return true;
56 |           }
57 |           // 2026年马年新年期间 (2月17日 - 3月3日)
58 |           if (year === 2026) {
59 |             if (month === 2 &amp;&amp; day &gt;= 17) return true;
60 |             if (month === 3 &amp;&amp; day &lt;= 3) return true;
61 |           }
62 |           return false;
63 |         }
64 | 
65 |         const stored = localStorage.getItem('starlight-theme');
</code></pre>
<p><em>文件：<code>src/pages/index.astro</code></em></p>
<p>为了安全起见，不要硬编码 ID。建议将 ID 存入环境变量。</p>
<p>在项目根目录创建 <code>.env</code> 文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Microsoft Clarity ID</span>
PUBLIC_CLARITY_ID=<span class="hljs-string">"你的_Clarity_ID"</span>
</code></pre>
<h5 data-id="heading-9">3. 创建覆盖组件</h5>
<p>以下是监听系统主题变化的实现代码，展示了如何仅在未手动设置时跟随系统切换主题。</p>

<pre><code class="hljs language-markdown" lang="markdown">445 |     const handleChange = (e: MediaQueryListEvent) =&gt; {
446 |       // 仅在用户未手动设置时跟随系统
447 |       if (!localStorage.getItem(THEME<span class="hljs-emphasis">_KEY)) {
448 |         setThemeState(e.matches ? 'dark' : 'light');
449 |       }
450 |     };
451 | 
452 |     mediaQuery.addEventListener('change', handleChange);
453 |     return () =&gt; mediaQuery.removeEventListener('change', handleChange);
454 |   }, []);
455 | 
456 |   return { theme, toggleTheme, setTheme: manuallySetTheme };
457 | }
458 | ```
459 | 
460 | #### 3. `src/components/ThemeButton.tsx` - 按钮组件
461 | 
462 | <span class="hljs-strong">**职责**</span>：渲染主题切换按钮，处理用户交互
463 | 
464 | <span class="hljs-strong">**组件接口**</span>：
</span></code></pre>
<p><em>文件：<code>openspec/changes/archive/2026-01-29-theme-toggle-implementation/design.md</code></em></p>
<p>在 <code>src/components/</code> 目录下创建文件 <code>StarlightFooter.astro</code>。Starlight 会自动识别这个文件并覆盖默认的 Footer。</p>
<p>核心代码逻辑如下：</p>
<pre><code class="hljs language-astro" lang="astro">---
// src/components/StarlightFooter.astro
// 1. 引入原始组件以保留其默认功能
import DefaultFooter from '@astrojs/starlight/components/StarlightFooter.astro';

// 2. 获取环境变量
const clarityId = import.meta.env.PUBLIC_CLARITY_ID;

// 3. 定义简单的注入脚本（内联方式）
// 注意：生产环境建议将此逻辑抽离到单独的 .js 文件中以利用缓存
const initScript = `
(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "${clarityId}");
`;
---

&lt;DefaultFooter {...Astro.props} /&gt;

{/* 仅在生产环境且 ID 存在时注入脚本 */}
{import.meta.env.PROD &amp;&amp; clarityId &amp;&amp; (
  &lt;script is:inline define:vars={{ clarityId }}&gt;
    {initScript}
  &lt;/script&gt;
)}
</code></pre>
<p><strong>关键点解析</strong>：</p>
<ul>
<li><code>is:inline</code>：告诉 Astro 不要处理这个 script 标签内的内容，直接输出到 HTML。这对第三方统计脚本至关重要，否则 Astro 的打包优化可能会导致脚本失效。</li>
<li><code>define:vars</code>：这是 Astro 3+ 的特性，允许在作用域内安全地注入变量。</li>
<li><code>import.meta.env.PROD</code>：确保在本地开发时（除非为了调试）不产生无效统计，保持数据纯净。</li>
</ul>
<h4 data-id="heading-10">进阶：隐私合规与 Cookie 控制</h4>
<p>仅仅加上代码是不够的，特别是在 GDPR 管辖区域。我们需要尊重用户的选择。</p>
<p>HagiCode 的做法是提供一个简单的开关。虽然这不是全功能的 Cookie Banner，但对于纯展示的技术文档站点来说，通常属于"必要"或"统计"类 Cookie，可以通过隐私声明告知并默认开启，或者在 Footer 链接到隐私设置页面。</p>
<p>如果需要更严谨的控制，你可以结合 <code>localStorage</code> 来记录用户的选择：</p>
<p>本文将介绍用于主题切换与持久化的 TypeScript 工具函数，通过类型安全与环境检测实现严谨控制。</p>

<pre><code class="hljs language-markdown" lang="markdown">367 | export function getInitialTheme(): Theme;
368 | export function getSystemTheme(): Theme;
369 | export function setTheme(theme: Theme): void;
370 | export function applyTheme(theme: Theme): void;
371 | <span class="hljs-code">```
372 | 
373 | **设计原则**：
374 | - **纯函数**：无副作用（除了 `setTheme` 和 `applyTheme`）
375 | - **类型安全**：完整的 TypeScript 类型推导
376 | - **环境检测**：SSR 安全（`typeof window` 检查）
377 | - **单一职责**：每个函数只做一件事
378 | 
379 | **关键实现**：
380 | ```</span>typescript
381 | export function getInitialTheme(): Theme {
382 |   if (typeof window === 'undefined') return 'dark';
383 | 
384 |   const stored = localStorage.getItem(THEME<span class="hljs-emphasis">_KEY);
385 |   if (stored === 'light' || stored === 'dark') return stored;
386 | 
</span></code></pre>
<p><em>文件：<code>openspec/changes/archive/2026-01-29-theme-toggle-implementation/design.md</code></em></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简单示例：检查用户是否拒绝统计</span>
<span class="hljs-keyword">const</span> consent = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'clarity_consent'</span>);
<span class="hljs-keyword">if</span> (consent !== <span class="hljs-string">'denied'</span>) {
    <span class="hljs-comment">// 执行上面的 Clarity 初始化代码</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">clarity</span>(<span class="hljs-string">'start'</span>, clarityId);
}
</code></pre>
<h3 data-id="heading-11">经验总结与坑点</h3>
<p>在将这套方案落地到 HagiCode 的过程中，我们总结了几个容易被忽视的细节：</p>
<ol>
<li>
<p><strong><code>StarlightWrapper.astro</code> 是个陷阱</strong>：
如前所述，不要试图去创建一个全局 Wrapper 来注入脚本，这在 Starlight 中行不通。老老实实覆盖特定组件（如 <code>StarlightFooter.astro</code> 或 <code>StarlightHead.astro</code>）才是正解。</p>
</li>
<li>
<p><strong>脚本位置的性能考量</strong>：
虽然 Clarity 建议放在 <code>&lt;head&gt;</code> 中以确保数据准确性，但对于文档站点，首屏加载速度（LCP）直接影响了 SEO 和用户留存。我们选择了放在 Footer（Body 底部），这会轻微丢失极少量"秒退"用户的数据，但换来了更快的页面加载体验，这是一个值得的权衡。</p>
</li>
<li>
<p><strong>开发环境的干扰</strong>：
一定要加上 <code>import.meta.env.PROD</code> 判断。在开发模式下，你会频繁刷新页面，这会产生大量无意义的测试数据，污染你的 Clarity 仪表盘。</p>
</li>
</ol>
<h3 data-id="heading-12">效果验证</h3>
<p>部署完成后，你可以在 Clarity 控制台查看实时数据。通常在几分钟内，你就能看到用户的heatmap（热力图）和 recordings（录屏）。</p>
<p>对于 HagiCode 来说，通过这些数据我们发现：</p>
<ul>
<li>很多用户会反复查看"快速开始"章节，说明我们的安装指引可能还不够直观。</li>
<li>"API 参考"页面的停留时间最长，证实了我们核心用户群体的需求。</li>
</ul>
<h3 data-id="heading-13">总结</h3>
<p>接入 Microsoft Clarity 并不需要复杂的服务端改造，也不需要引入沉重的 SDK。</p>
<p>利用 Starlight 的组件覆盖机制，我们仅通过一个轻量级的 <code>StarlightFooter.astro</code> 组件，就实现了全局数据统计。这种"微集成"的方式，既保证了代码的整洁，又赋予了我们洞察用户行为的能力。</p>
<p>如果你也在运营技术类项目，特别是像 <strong>HagiCode</strong> 这样需要不断迭代文档的项目，强烈建议尝试接入 Clarity。数据会告诉你，用户真正的痛点在哪里。</p>
<h3 data-id="heading-14">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FHagiCode-org%2Fsite" target="_blank" title="https://github.com/HagiCode-org/site" ref="nofollow noopener noreferrer">HagiCode GitHub 仓库</a> - 查看我们在实际项目中的配置文件</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fclarity%2F" target="_blank" title="https://learn.microsoft.com/en-us/clarity/" ref="nofollow noopener noreferrer">Microsoft Clarity 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fstarlight.astro.build%2Fguides%2Foverriding-components%2F" target="_blank" title="https://starlight.astro.build/guides/overriding-components/" ref="nofollow noopener noreferrer">Starlight 组件覆盖指南</a></li>
</ul>
<hr/>
<p>感谢您的阅读,如果您觉得本文有用,快点击下方点赞按钮👍,让更多的人看到本文。</p>
<p>本内容采用人工智能辅助协作,经本人审核,符合本人观点与立场。</p>
<ul>
<li><strong>本文作者:</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.newbe.pro" target="_blank" title="https://www.newbe.pro" ref="nofollow noopener noreferrer">newbe36524</a></li>
<li><strong>本文链接:</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fhagicode-org.github.io%2Fsite%2Fblog%2F2026-02-04-starlight-docs-integration-microsoft-clarity%2F" target="_blank" title="https://hagicode-org.github.io/site/blog/2026-02-04-starlight-docs-integration-microsoft-clarity/" ref="nofollow noopener noreferrer">hagicode-org.github.io/site/blog/2…</a></li>
<li><strong>版权声明:</strong> 本博客所有文章除特别声明外,均采用 BY-NC-SA 许可协议。转载请注明出处!</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Tauri 项目：交互流程与开发指南]]></title>    <link>https://juejin.cn/post/7602893600251658286</link>    <guid>https://juejin.cn/post/7602893600251658286</guid>    <pubDate>2026-02-05T02:34:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602893600251658286" data-draft-id="7602850166732275721" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Tauri 项目：交互流程与开发指南"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2026-02-05T02:34:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卡尔特斯"/> <meta itemprop="url" content="https://juejin.cn/user/4450440831840909"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Tauri 项目：交互流程与开发指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4450440831840909/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卡尔特斯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T02:34:38.000Z" title="Thu Feb 05 2026 02:34:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、项目文件结构</h2>
<pre><code class="hljs language-csharp" lang="csharp">DZMRustTauriBaseProject/
├── index.html                    <span class="hljs-meta"># 前端 HTML 入口</span>
├── package.json                  <span class="hljs-meta"># 前端依赖与脚本</span>
├── vite.config.ts                <span class="hljs-meta"># Vite 构建配置</span>
├── tsconfig.json
│
├── src/                          <span class="hljs-meta"># 【前端】主要开发区</span>
│   ├── main.ts                   <span class="hljs-meta"># Vue 应用挂载</span>
│   ├── App.vue                   <span class="hljs-meta"># 根组件 / 主页面</span>
│   ├── assets/                   <span class="hljs-meta"># 静态资源</span>
│   └── vite-env.d.ts
│
├── src-tauri/                    <span class="hljs-meta"># 【后端/桌面壳】主要开发区</span>
│   ├── Cargo.toml                <span class="hljs-meta"># Rust 依赖</span>
│   ├── tauri.conf.json           <span class="hljs-meta"># 窗口、前端地址、构建命令等</span>
│   ├── build.rs                  <span class="hljs-meta"># 构建时脚本</span>
│   ├── capabilities/
│   │   └── <span class="hljs-literal">default</span>.json          <span class="hljs-meta"># 权限：允许前端调用的 API</span>
│   ├── src/
│   │   ├── main.rs               <span class="hljs-meta"># 程序入口，启动 Tauri</span>
│   │   └── lib.rs                <span class="hljs-meta"># 业务逻辑 + 暴露给前端的命令（核心）</span>
│   └── icons/                    <span class="hljs-meta"># 应用图标</span>
│
└── docs/                         <span class="hljs-meta"># 文档（本文件所在目录）</span>
</code></pre>
<hr/>
<h2 data-id="heading-1">二、前后端交互流程</h2>
<h3 data-id="heading-2">2.1 整体流程（一次调用）</h3>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────────────────┐
│  用户操作（如点击 Greet）                                                  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  前端 (Vue / <span class="hljs-attribute">src</span>/App<span class="hljs-selector-class">.vue</span>)                                                │
│  • 调用: <span class="hljs-built_in">invoke</span>(<span class="hljs-string">"greet"</span>, { name: name.value })                           │
│  • 使用: @tauri-apps/api/core 的 invoke                                  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │  (Tauri 内部：序列化参数 → IPC → 后端)
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  后端 (Rust / src-tauri/src/lib.rs)                                      │
│  • 匹配命令名 <span class="hljs-string">"greet"</span> → 执行 fn <span class="hljs-built_in">greet</span>(name: &amp;str) -&gt; String               │
│  • 返回值序列化后通过 IPC 回传                                            │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  前端 (Vue)                                                              │
│  • await <span class="hljs-built_in">invoke</span>(...) 得到 Rust 返回的 String                              │
│  • 写入 greetMsg，界面更新                                                │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-3">2.2 代码对应关系</h3>

























<table><thead><tr><th>环节</th><th>位置</th><th>做什么</th></tr></thead><tbody><tr><td>前端调用</td><td><code>src/App.vue</code></td><td><code>invoke("greet", { name })</code>，命令名必须与 Rust 中一致</td></tr><tr><td>命令注册</td><td><code>src-tauri/src/lib.rs</code></td><td><code>#[tauri::command] fn greet(...)</code> + <code>generate_handler![greet]</code></td></tr><tr><td>权限</td><td><code>src-tauri/capabilities/default.json</code></td><td>允许使用 <code>core</code>（含 invoke）等能力</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">三、后续开发：主要操作区域与流程</h2>
<h3 data-id="heading-5">3.1 加一个「新能力」（新命令）</h3>
<ol>
<li>
<p><strong>Rust 端</strong>（<code>src-tauri/src/lib.rs</code>）</p>
<ul>
<li>写一个新函数，加上 <code>#[tauri::command]</code>。</li>
<li>在 <code>tauri::Builder</code> 的 <code>.invoke_handler(tauri::generate_handler![..., 新命令])</code> 里注册。</li>
</ul>
</li>
<li>
<p><strong>前端</strong></p>
<ul>
<li>在需要的地方 <code>import { invoke } from "@tauri-apps/api/core"</code>，然后 <code>await invoke("新命令名", { 参数 })</code>。</li>
</ul>
</li>
<li>
<p><strong>权限</strong>（若用到敏感 API）</p>
<ul>
<li>在 <code>capabilities/</code> 里为对应能力添加 permission（多数纯业务命令用默认即可）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-6">3.2 改界面</h3>
<ul>
<li>只动 <strong><code>src/</code></strong>：Vue 组件、路由、状态、样式等，和普通 Vue 项目一致。</li>
</ul>
<h3 data-id="heading-7">3.3 改窗口/打包/配置</h3>
<ul>
<li>动 <strong><code>src-tauri/tauri.conf.json</code></strong>：窗口大小、标题、前端 devUrl、构建命令等。</li>
</ul>
<h3 data-id="heading-8">3.4 开发时跑起来</h3>
<ul>
<li>只跑网页：<code>npm run dev</code></li>
<li>跑桌面客户端（前端 + 壳）：<code>npm run tauri dev</code></li>
</ul>
<hr/>
<h2 data-id="heading-9">四、交互原理简述</h2>
<ul>
<li><strong>前端</strong>运行在 Tauri 提供的 WebView 里，和普通网页一样写 Vue/TS。</li>
<li><strong>通信</strong>：前端不直接访问 Rust，而是通过 Tauri 的 <strong>invoke</strong> 发「命令名 + 参数」；Tauri 在 Rust 端根据命令名路由到对应的 <code>#[tauri::command]</code> 函数，执行完后把返回值通过 IPC 传回前端。</li>
<li><strong>安全</strong>：前端只能调用你在 Rust 里显式注册的 command，以及 capabilities 里允许的 API；没有「整个 Node/系统」暴露给前端，所以不需要像 Electron 那样用 contextBridge 做一层暴露。</li>
</ul>
<hr/>
<h2 data-id="heading-10">五、和 Electron 在流程上的区别</h2>
<h3 data-id="heading-11">5.1 Electron 的典型做法</h3>
<ul>
<li><strong>主进程</strong>：Node 环境，可 require、访问系统。</li>
<li><strong>渲染进程</strong>：浏览器环境，默认不能直接 require、不能随意调主进程。</li>
<li>所以要用 <strong>contextBridge + ipcRenderer</strong>：
<ul>
<li>主进程里用 <strong>preload</strong> 脚本，通过 <code>contextBridge.exposeInMainWorld('xxx', { ... })</code> 只暴露有限 API 给渲染进程。</li>
<li>渲染进程里不直接 <code>require('electron')</code>，而是用挂到 <code>window</code> 上的对象（例如 <code>window.xxx.invoke('channel', data)</code>），内部再转成 <strong>ipcRenderer.send / ipcRenderer.invoke</strong> 与主进程通信。</li>
</ul>
</li>
<li>流程：<strong>渲染进程 → preload（contextBridge 暴露的 API）→ ipcRenderer → 主进程（ipcMain 监听 channel）→ 主进程逻辑</strong>。</li>
</ul>
<p>也就是说：Electron 需要你<strong>自己用 preload + contextBridge 定义「前端能调什么」</strong>，再用 <strong>ipcRenderer / ipcMain</strong> 在进程间传 channel + 数据。</p>
<h3 data-id="heading-12">5.2 Tauri 的对应关系</h3>






























<table><thead><tr><th>概念</th><th>Electron</th><th>Tauri</th></tr></thead><tbody><tr><td>前端调「后端」</td><td>通过 preload 暴露的 API</td><td>通过 <code>invoke("command", args)</code></td></tr><tr><td>暴露方式</td><td>contextBridge.exposeInMainWorld</td><td>无需 preload，直接 invoke 命令名</td></tr><tr><td>后端实现</td><td>ipcMain.on('channel', handler)</td><td><code>#[tauri::command] fn xxx()</code></td></tr><tr><td>通信模型</td><td>自己定 channel 名、自己序列化</td><td>命令名 + 参数，Tauri 负责序列化/路由</td></tr></tbody></table>
<h3 data-id="heading-13">5.3 核心区别总结</h3>
<ol>
<li>
<p><strong>Electron</strong></p>
<ul>
<li>渲染进程不能直接用 <code>require('electron')</code>，所以要 <strong>preload + contextBridge</strong> 暴露安全 API，再用 <strong>ipcRenderer</strong> 发 channel，主进程用 <strong>ipcMain</strong> 收。</li>
<li>流程是你自己设计 channel 和参数格式。</li>
</ul>
</li>
<li>
<p><strong>Tauri</strong></p>
<ul>
<li>前端直接用 <strong><code>invoke("命令名", 参数)</code></strong>，不需要 preload，也没有 contextBridge。</li>
<li>「暴露什么」由 Rust 里注册的 <strong>command</strong> 和 <strong>capabilities</strong> 决定，安全性在框架层就按「白名单命令」设计好了。</li>
</ul>
</li>
</ol>
<p>所以：<strong>Electron 的 contextBridge + ipcRenderer 那一套，在 Tauri 里被简化为「前端 invoke 命令名 + Rust 端 command 注册」</strong>，不需要你写 preload，也不用手动管 channel 名，只要在 Rust 里加 command、在前端调 invoke 即可。</p>
<hr/>
<h2 data-id="heading-14">六、对照小结</h2>
<ul>
<li><strong>项目结构</strong>：<code>src/</code> = 前端，<code>src-tauri/</code> = 桌面壳与后端逻辑；后续开发主要就是在这两块加命令和改界面。</li>
<li><strong>交互流程</strong>：用户操作 → 前端 <code>invoke("命令", 参数)</code> → Tauri 路由到 Rust <code>#[tauri::command]</code> → 返回值回前端。</li>
<li><strong>和 Electron 的区别</strong>：Tauri 用「invoke + command」替代了 Electron 的「contextBridge + ipcRenderer + ipcMain」；前端只调命令名，不碰 preload，也不定义 channel。</li>
</ul>
<p>文档结束。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Promise对象、同步和异步代码、回调地狱的讲解]]></title>    <link>https://juejin.cn/post/7602837527674945551</link>    <guid>https://juejin.cn/post/7602837527674945551</guid>    <pubDate>2026-02-05T02:38:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602837527674945551" data-draft-id="7602825342228561954" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Promise对象、同步和异步代码、回调地狱的讲解"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-02-05T02:38:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SuperEugene"/> <meta itemprop="url" content="https://juejin.cn/user/2366613652515256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Promise对象、同步和异步代码、回调地狱的讲解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2366613652515256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SuperEugene
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T02:38:26.000Z" title="Thu Feb 05 2026 02:38:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>简单粗暴一点的说 <code>Promise</code> 就是一个为了解决异步代码的东西，它可以让代码按照你想要的顺序去执行。</p>
<p>我们先来说说什么是同步代码，什么是异步代码。</p>
<ul>
<li><strong>同步代码</strong>就是按顺序执行，如：12345 按顺序往下走。只有前一条代码执行完毕之后才会去执行后一条代码。</li>
<li><strong>异步代码</strong>就是可以不按照顺序执行的代码，如：213465，例如：网络请求、定时器、文件的读写等均是异步的。我们直接上代码直观的去感受一下</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  
}, <span class="hljs-number">1000</span>)
</code></pre>
<p>↑这是一个定时器，这是一个可以将包裹在方法体内的代码延迟 1000 毫秒以后再执行的定时器。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务1'</span>, <span class="hljs-title function_">moment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).<span class="hljs-title function_">format</span>(<span class="hljs-string">'HH:mm:ss'</span>))
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务2'</span>, <span class="hljs-title function_">moment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).<span class="hljs-title function_">format</span>(<span class="hljs-string">'HH:mm:ss'</span>))
}, <span class="hljs-number">1000</span>)

<span class="hljs-comment">//moment (new Date ()).format ('HH:mm:ss') 如果你是初学者不明白 moment () 是什么，</span>
<span class="hljs-comment">//直接复制代码发现报错，没关系。并不影响你继续学习，这条代码的功能就是输出博主当前执行代码的时间，</span>
<span class="hljs-comment">//你可以删掉这条代码，只输出 ' 任务1、任务2' 即可。感兴趣的同学可以自行搜索 moment 的使用方法学习</span>

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ddb51c23f40436794e46a454b1d41ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3VwZXJFdWdlbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770863909&amp;x-signature=EfJRCskvN%2BoiyiMqUkbMjYZVoYQ%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到任务 2 比任务 1 的打印时间晚了一秒</p>
<p>前面我们说到定时器是一个异步的代码，我们来验证一下。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务2'</span>, <span class="hljs-title function_">moment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).<span class="hljs-title function_">format</span>(<span class="hljs-string">'HH:mm:ss'</span>))
}, <span class="hljs-number">1000</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务1'</span>, <span class="hljs-title function_">moment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).<span class="hljs-title function_">format</span>(<span class="hljs-string">'HH:mm:ss'</span>))
</code></pre>
<p>按照代码自上而下的执行顺序，在控制台中应该是一秒钟以后先输出的任务 2 再输出的任务 1</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8496e4564aef4cf6a709c1853d360c5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3VwZXJFdWdlbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770863909&amp;x-signature=4Jbvi4nY9CaR25ePPdqdKETACbk%3D" alt="image.png" loading="lazy"/></p>
<p>从控制台的输出得知并不是这样的。代码跳过了任务 2 先输出的任务 1，然后一秒钟之后才输出的任务 2，证实定时器确实是一个异步的代码，它并没有按照顺序执行。</p>
<p>异步代码的好处就在于不会造成代码的堵塞</p>
<ul>
<li>例如：现在我们是交通参与者的身份开着车行驶在路上，突然前方出现了交通事故，此时边上有辅道可以绕过去，难道我们就要等到这起交通事故处理完成之后才能通行吗？当然是没有这个必要的，我们可以先通过边上的辅道绕过去，无需等到交通事故处理完毕之后再通行，如果等到交通事故处理之后再通行那就会造成交通瘫痪大堵车的结局。</li>
</ul>
<p>还有的时候异步任务也需要同步的去执行。还是以这个交通事故举例子，例如：我们是交警，我们接到了调度中心发来的任务请求，告知我们某路段发生交通事故需要我们前往现场进行处理。在接警没多久之后调度中心又发来请求，告知我们现在警力紧张，在我们的不远处还有一起交通事故希望我们处理完手里的这个事故之后立马前往下一个路段处理第二起交通事故。那此时任务二就要等待任务一执行完毕之后才能执行。其他的交通参与者当然不需要等待交警的任务执行完毕之后才能通过，可以自行从边上绕过去。上代码，我们把这个小故事以代码的形式呈现出来</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆1'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆2'</span>)
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'交警处理事故1'</span>, <span class="hljs-title function_">moment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).<span class="hljs-title function_">format</span>(<span class="hljs-string">'HH:mm:ss'</span>))
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'交警处理事故2'</span>, <span class="hljs-title function_">moment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).<span class="hljs-title function_">format</span>(<span class="hljs-string">'HH:mm:ss'</span>))
  }, <span class="hljs-number">1000</span>)
}, <span class="hljs-number">1000</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆3'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆4'</span>)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01e31bdf6fb84b88b6feb2b3099b6cb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3VwZXJFdWdlbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770863909&amp;x-signature=KX%2B1BOvaqh%2FjhFK%2BvGnnVqxMTPk%3D" alt="image.png" loading="lazy"/></p>
<p>通过控制台的输出我们可以看到社会车辆 1、2、3、4 先行通过了，交警处理事故 1 之后一秒钟事故 2 才执行处理。</p>
<p>但其实这种写法并不美观，如果有很多事故需要处理呢，那是不是就要嵌套很多层呢。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆1'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆2'</span>)
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'交警处理事故1'</span>, <span class="hljs-title function_">moment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).<span class="hljs-title function_">format</span>(<span class="hljs-string">'HH:mm:ss'</span>))
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'交警处理事故2'</span>, <span class="hljs-title function_">moment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).<span class="hljs-title function_">format</span>(<span class="hljs-string">'HH:mm:ss'</span>))
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'交警处理事故3'</span>, <span class="hljs-title function_">moment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).<span class="hljs-title function_">format</span>(<span class="hljs-string">'HH:mm:ss'</span>))
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'交警处理事故4'</span>, <span class="hljs-title function_">moment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).<span class="hljs-title function_">format</span>(<span class="hljs-string">'HH:mm:ss'</span>))
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'交警处理事故5'</span>, <span class="hljs-title function_">moment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).<span class="hljs-title function_">format</span>(<span class="hljs-string">'HH:mm:ss'</span>))
          <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'交警处理事故6'</span>, <span class="hljs-title function_">moment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).<span class="hljs-title function_">format</span>(<span class="hljs-string">'HH:mm:ss'</span>))
          }, <span class="hljs-number">1000</span>)
        }, <span class="hljs-number">1000</span>)
      }, <span class="hljs-number">1000</span>)
    }, <span class="hljs-number">1000</span>)
  }, <span class="hljs-number">1000</span>)
}, <span class="hljs-number">1000</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆3'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆4'</span>)
</code></pre>
<p>这样的写法会导致代码的可读性非常的差，你可能说我现在一眼就能看出哪儿条输出语句对应着哪儿个代码块。没错，就以现在的这个代码是可以做到。但如果当每一个代码块中的代码复杂起来多起来了以后呢。你还能一眼就看出来吗？当然是很费力的嘛。这就是我们常说的<strong>回调地狱</strong>。</p>
<p><code>Promise</code> 的出现就可以很好的规避掉这个问题，让我们来进入 <code>Promise</code> 的学习吧。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>()
</code></pre>
<p><code>Promise</code> 就长这样↑</p>
<p><code>Promise</code> 接收一个函数，在函数中接收两个参数：<code>resolve</code> 和 <code>reject</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {})
</code></pre>
<p><code>resolve</code> 和 <code>reject</code> 是由 <code>Promise</code> 对象传入的。<code>resolve</code> 直译过来的意思是：决定、解决，是在程序执行成功的时候调用的，而 <code>reject</code> 直译过来的意思是：拒绝，是在程序调用失败的时候调用的，故此你可以将</p>
<ul>
<li><code>resolve</code> <strong>理解为成功</strong>，</li>
<li><code>reject</code>  <strong>理解为失败</strong>。</li>
</ul>
<p>例如：现在我们正在登陆某一个网站，当你的用户名或密码输入错误之时，身份验证不通过就会返回错误信息，此时就可以调用 <code>reject</code>。反之用户名和密码都正确身份认证通过了，此时便可调用 <code>resolve</code>。</p>
<p>咱们先打印一下这个 <code>Promise</code> 对象，看看长什么样</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> promiseObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {})
 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(promiseObj)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe26d6c9109e4a04b74bb5918d1d7878~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3VwZXJFdWdlbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770863909&amp;x-signature=WYYyqLC3LJetGlNYtrR344sJE4k%3D" alt="image.png" loading="lazy"/></p>
<p>我们看到在控制台打印出来的数据中有一个<code>pending</code>（等待的意思），<code>promise</code> 对象中有一个状态的概念。你看现在的状态是一个默认状态 <code>pending</code>，你可以理解为这个 <code>promise</code> 里的 <code>resolve</code> 和 <code>reject</code> 一个都没有被触发。</p>
<p>我们来触发 <code>resolve</code> 参数看看状态</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> promiseObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-title function_">resolve</span>()
})
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(promiseObj)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/884ab525c62942c18f724a975670e108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3VwZXJFdWdlbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770863909&amp;x-signature=Gvmb5f3mvbWSUJ7%2FMiVag56TEjc%3D" alt="image.png" loading="lazy"/></p>
<p>观察发现 <code>PromiseState</code> 从 <code>pending</code> 等待变成了<code>fulfilled</code>，<code>fulfilled</code> 就表示<strong>完成或者成功</strong>。</p>
<p>我们再来触发一下 reject 参数看看状态</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> promiseObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-title function_">reject</span>()
})
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(promiseObj)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/484661044ce44233970870cccf12e339~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3VwZXJFdWdlbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770863909&amp;x-signature=L8%2FKD%2BQE2taLNdZk3jg7cnMw1cM%3D" alt="image.png" loading="lazy"/></p>
<p>观察发现 PromiseState 的状态变成了<strong>rejected</strong> 表示拒绝或者失败了。</p>
<p><code>promise</code> 对象给我们提供了三个方法，咱们自己可以如图一样通过对象点的形式来看看是不是出来 <code>catch</code> 、<code>finally</code>、<code>then</code> 这三个方法。</p>
<p>简单粗暴的讲一下这三个方法。还是以登陆某一网站为例：</p>
<ul>
<li>假设用户名和密码都填写正确则会走到 <code>then()</code> 方法里，你可以理解为<code>then()</code> <strong>方法是成功时候调用的</strong>。假设用户名和密码有一个或者全都填写错误时服务器便会返回错误信息，此时代码就会走到 <code>catch()</code> 方法里，你可以理解为<code>catch()</code><strong>方法是在错误时候调用的</strong>。那么<code>finally()</code> <strong>方法则是无论服务器返回的是</strong> <code>true</code> <strong>还是</strong> <code>false</code> <strong>都会走到</strong> <code>finally</code> <strong>里面</strong>，你可以理解为不论对错都会调用 <code>finally</code>。用户名密码填写正确，走完 <code>then()</code> 还会走 <code>finally</code>。用户名密码填写错误，走完 <code>catch()</code> 也还会走 <code>finally()</code>。</li>
</ul>
<p>让我们来一一验证一下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> promiseObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'身份认证通过！'</span>)
})
promiseObj
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> { <span class="hljs-comment">//data就是resolve传过来的内容 名称没有规定自定义即可</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)
  })
  .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'我是finally'</span>)
  })
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a791a9eeba174e2f85bc27c15ced8cdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3VwZXJFdWdlbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770863909&amp;x-signature=4i5fZC9Ovgf4hB1AAZcz6ydyAa4%3D" alt="image.png" loading="lazy"/></p>
<p>通过代码可以看得出这三个方法接收的都是一个<code>回调函数</code>。通过控制台的输出可以得知当我们调用了 <code>resolve</code> 时代码走到了<code>then()</code> 方法之后又走到了 <code>finally()</code> 方法，验证通过。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> promiseObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-title function_">reject</span>(<span class="hljs-string">'身份认证失败！'</span>)
})
promiseObj
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> { 
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> { <span class="hljs-comment">//error就是reject传过来的内容  名称没有规定自定义即可</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)
  })
  .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'我是finally'</span>)
  })
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4801d34aff5474fb6a9c0f29e4104fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3VwZXJFdWdlbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770863909&amp;x-signature=6MqyKIJUyz4PaQGqIrBr4mo3WCk%3D" alt="image.png" loading="lazy"/></p>
<p>通过控制台的输出可以得知当我们调用了 <code>reject</code> 时代码走到了 <code>catch()</code> 方法之后又走到了 <code>finally()</code> 方法，验证通过。</p>
<p>到这儿为止你已经对 <code>Promise</code> 的使用有了一个简单的认识。我们现在用 <code>Promise</code> 来解决一下前面举例说明的小故事。看看你是否会觉得优雅很多，代码更可读。</p>
<p>虽然 <code>promise</code> 本身是同步的，但是 <code>promise</code> 的<code>.then()</code>、<code>.catch ()</code>、<code>. finally ()</code> 这些方法中的回调是异步的，所以在这里我们就不用定时器了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆1'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆2'</span>)
<span class="hljs-keyword">const</span> promiseObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'交警处理事故1'</span>)
})
promiseObj
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'交警处理事故2'</span>)
    })
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'交警处理事故3'</span>)
    })
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'交警处理事故4'</span>)
    })
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)
  })
  .<span class="hljs-title function_">catch</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆3'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆4'</span>)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3dbc7f101ea4e33b3d698cf2e1a0cd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3VwZXJFdWdlbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770863909&amp;x-signature=qQ99JiwIheLD3eNJ97KBixcJ1LU%3D" alt="image.png" loading="lazy"/></p>
<p>有的人会说 这也嵌套了呀。没错这确实是也嵌套了，但是只有一层，无论多少次都只有一层</p>
<pre><code class="hljs language-js" lang="js">promiseObj.<span class="hljs-title function_">then</span>().<span class="hljs-title function_">then</span>().<span class="hljs-title function_">then</span>().<span class="hljs-title function_">then</span>().<span class="hljs-title function_">then</span>().<span class="hljs-title function_">then</span>().<span class="hljs-title function_">catch</span>()
</code></pre>
<p>↑这样看是不是就更直观了呢。</p>
<p>还有另一种写法可以给每一个<code>.then()</code> 都设置一个单独的 <code>catch()</code> 直接上代码</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2bd69858409432c8537b0f8f986ed29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3VwZXJFdWdlbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770863909&amp;x-signature=jRSkg9StdnZwj9Qareu46hhM0Yg%3D" alt="image.png" loading="lazy"/>
从这张图↑可以看到<code>.then()</code> 里面其实可以传递两个参数的，第一个表示成功时候的调用，第二个表示失败时候的调用</p>
<pre><code class="hljs language-js" lang="js">promiseObj
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {}, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {})
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {}, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {})
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {}, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {})
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {}, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {})
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {}, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {})
</code></pre>
<p>↑这便是大致的一个结构</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> promiseObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'交警处理事故1'</span>)
})
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆1'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆2'</span>)
promiseObj
  .<span class="hljs-title function_">then</span>(
    <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'交警处理事故2'</span>)
      })
    },
    <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)
    }
  )
  .<span class="hljs-title function_">then</span>(
    <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)
      <span class="hljs-keyword">let</span> errorBtn = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (errorBtn) {
          <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'交警处理事故3'</span>)
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">reject</span>(<span class="hljs-string">'交通事故处理时候遇到特殊状况'</span>)
        }
      })
    },
    <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)
    }
  )
  .<span class="hljs-title function_">then</span>(
    <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'交警处理事故4'</span>)
      })
    },
    <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)
    }
  )
  .<span class="hljs-title function_">then</span>()
 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆3'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'社会车辆4'</span>)
</code></pre>
<p>我们在交警事故处理 3 处加了一个 <code>reject</code> 的调用</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/396603bb27f44f8b93d534b9d5380fe8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3VwZXJFdWdlbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770863909&amp;x-signature=PHMIR1RbnaL85VZeTEmXGUCmRws%3D" alt="image.png" loading="lazy"/></p>
<p>通过控制台的输出可以得知咱们的 <code>reject</code> 起作用了。当交警处理事故 3 处报错时代码就终止了，后面的程序就不执行了。</p>
<p>以上就是本章的知识点讲解分享，感谢大家的耐心观看学习，欢迎大家在评论区讨论纠错，与大家共勉。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Compose 页面跳转中的状态保留：ViewModel + StateHolder 架构模式]]></title>    <link>https://juejin.cn/post/7602825342228103202</link>    <guid>https://juejin.cn/post/7602825342228103202</guid>    <pubDate>2026-02-04T16:24:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602825342228103202" data-draft-id="7602824293164793871" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Compose 页面跳转中的状态保留：ViewModel + StateHolder 架构模式"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-04T16:24:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="荠麦青青"/> <meta itemprop="url" content="https://juejin.cn/user/2647279733077246"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Compose 页面跳转中的状态保留：ViewModel + StateHolder 架构模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2647279733077246/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    荠麦青青
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T16:24:07.000Z" title="Wed Feb 04 2026 16:24:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Compose 页面跳转中的状态保留：ViewModel + StateHolder 架构模式</h2>
<h3 data-id="heading-1">问题背景</h3>
<p>在使用 Jetpack Compose 进行页面导航开发时，我们经常遇到一个经典问题：<strong>页面跳转后，返回时 UI 控件的内部状态会丢失</strong>。</p>
<p>例如，一个计数器页面，用户手动增加了计数，然后跳转到其他页面，再返回时，计数器回到了初始值。这是因为 Composable 的重组机制导致的——页面重建时，所有状态都被重新初始化。</p>
<h3 data-id="heading-2">传统解决方案</h3>
<p>在 Android 传统开发中，我们习惯使用 <code>savedInstanceState</code> 来保存状态。但在 Compose 中，这仍然面临挑战：</p>
<ul>
<li>需要手动序列化和反序列化状态</li>
<li>对于复杂的业务逻辑对象，处理起来很繁琐</li>
<li>代码侵入性较强</li>
</ul>
<h3 data-id="heading-3">我们的解决方案：ViewModel + StateHolder 架构</h3>
<h4 data-id="heading-4">核心思想</h4>
<p>将<strong>状态管理</strong>和<strong>业务逻辑</strong>从 UI 层分离出来，使用：</p>
<ol>
<li><strong>ViewModel</strong>：管理生命周期，持有 StateHolder</li>
<li><strong>StateHolder</strong>：纯 Kotlin 类，封装业务逻辑和状态</li>
</ol>
<p>这样，即使页面跳转，ViewModel 仍然存活，StateHolder 中的状态得以保留。</p>
<h4 data-id="heading-5">代码实现</h4>
<h5 data-id="heading-6">1. StateHolder - 业务逻辑层</h5>
<p>首先创建一个纯 Kotlin 类来管理业务逻辑和状态：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.ehi.cmp_demo.page.router_test.logic

<span class="hljs-keyword">import</span> kotlinx.coroutines.CoroutineScope
<span class="hljs-keyword">import</span> kotlinx.coroutines.Job
<span class="hljs-keyword">import</span> kotlinx.coroutines.delay
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.MutableStateFlow
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.StateFlow
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.asStateFlow
<span class="hljs-keyword">import</span> kotlinx.coroutines.isActive
<span class="hljs-keyword">import</span> kotlinx.coroutines.launch

<span class="hljs-comment">/**
 * State Holder for Counter logic.
 * Pure Kotlin class, unaware of Android Lifecycle.
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterManager</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> scope: CoroutineScope) {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _count = MutableStateFlow(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">val</span> count: StateFlow&lt;<span class="hljs-built_in">Int</span>&gt; = _count.asStateFlow()

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _isAutoIncrementing = MutableStateFlow(<span class="hljs-literal">false</span>)
    <span class="hljs-keyword">val</span> isAutoIncrementing: StateFlow&lt;<span class="hljs-built_in">Boolean</span>&gt; = _isAutoIncrementing.asStateFlow()

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> timerJob: Job? = <span class="hljs-literal">null</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span></span> {
        _count.value++
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">decrement</span><span class="hljs-params">()</span></span> {
        _count.value--
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toggleAutoIncrement</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (_isAutoIncrementing.value) {
            stopAutoIncrement()
        } <span class="hljs-keyword">else</span> {
            startAutoIncrement()
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startAutoIncrement</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (_isAutoIncrementing.value) <span class="hljs-keyword">return</span>
        _isAutoIncrementing.value = <span class="hljs-literal">true</span>
        
        timerJob?.cancel()
        timerJob = scope.launch {
            <span class="hljs-keyword">while</span> (isActive &amp;&amp; _isAutoIncrementing.value) {
                delay(<span class="hljs-number">1000</span>)
                increment()
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stopAutoIncrement</span><span class="hljs-params">()</span></span> {
        _isAutoIncrementing.value = <span class="hljs-literal">false</span>
        timerJob?.cancel()
        timerJob = <span class="hljs-literal">null</span>
    }
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>纯 Kotlin 类，不依赖 Android API</li>
<li>使用 <code>StateFlow</code> 暴露响应式状态</li>
<li>业务逻辑清晰，易于测试</li>
</ul>
<h5 data-id="heading-7">2. ViewModel - 生命周期管理层</h5>
<p>创建 ViewModel 来持有 StateHolder：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.ehi.cmp_demo.page.router_test

<span class="hljs-keyword">import</span> androidx.lifecycle.ViewModel
<span class="hljs-keyword">import</span> androidx.lifecycle.viewModelScope
<span class="hljs-keyword">import</span> com.ehi.cmp_demo.page.router_test.logic.CounterManager

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RouterPageAViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-comment">// Composition: ViewModel holds the StateHolder</span>
    <span class="hljs-keyword">val</span> counterManager = CounterManager(viewModelScope)
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>ViewModel 使用 <code>viewModelScope</code> 传递给 StateHolder</li>
<li>简洁明了，只负责持有和管理 StateHolder</li>
<li>避免膨胀成 God ViewModel</li>
</ul>
<h5 data-id="heading-8">3. UI 层 - 状态展示</h5>
<p>在 Composable 中使用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RouterPageA</span><span class="hljs-params">(navController: <span class="hljs-type">NavController</span>)</span></span> {
    <span class="hljs-comment">// 引入 ViewModel (官方架构推荐)</span>
    <span class="hljs-comment">// 此时 ViewModel 的生命周期跟随 NavigationBackStackEntry，</span>
    <span class="hljs-comment">// 即便跳转到 B 页面，A 页面在后台栈中，ViewModel 依然存活，数据（CountManager）被保留。</span>
    <span class="hljs-keyword">val</span> viewModel: RouterPageAViewModel = androidx.lifecycle.viewmodel.compose.viewModel { RouterPageAViewModel() }

    <span class="hljs-comment">// 观察 StateHolder (CounterManager) 中的状态</span>
    <span class="hljs-keyword">val</span> count <span class="hljs-keyword">by</span> viewModel.counterManager.count.collectAsState()
    <span class="hljs-keyword">val</span> isAutoIncrementing <span class="hljs-keyword">by</span> viewModel.counterManager.isAutoIncrementing.collectAsState()

    CommonPageLayout(
        title = <span class="hljs-string">"计数器页面A"</span>,
        navController = navController
    ) {
        Column(
            modifier = Modifier.fillMaxSize().padding(<span class="hljs-number">16.</span>dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.Center
        ) {

            Text(
                <span class="hljs-string">"当前页面使用 ViewModel + StateHolder (CounterManager) 架构。\n"</span> +
                        <span class="hljs-string">"跳转到 B 页面后，ViewModel 存活，自动计数器仍在后台运行。\n"</span> +
                        <span class="hljs-string">"返回 A 页面，状态无缝衔接，无需重建。"</span>
            )

            <span class="hljs-comment">// 显示当前计数</span>
            Text(
                text = <span class="hljs-string">"当前计数"</span>,
                style = MaterialTheme.typography.titleMedium,
                color = MaterialTheme.colorScheme.onSurface
            )

            Spacer(modifier = Modifier.height(<span class="hljs-number">16.</span>dp))

            Text(
                text = <span class="hljs-string">"<span class="hljs-variable">$count</span>"</span>,
                style = MaterialTheme.typography.displayLarge,
                color = MaterialTheme.colorScheme.primary
            )

            Spacer(modifier = Modifier.height(<span class="hljs-number">32.</span>dp))

            <span class="hljs-comment">// 加减按钮行</span>
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.Center
            ) {
                Button(
                    onClick = { viewModel.counterManager.decrement() },
                    modifier = Modifier.width(<span class="hljs-number">100.</span>dp)
                ) {
                    Text(text = <span class="hljs-string">"-1"</span>, style = MaterialTheme.typography.titleMedium)
                }

                Spacer(modifier = Modifier.width(<span class="hljs-number">24.</span>dp))

                Button(
                    onClick = { viewModel.counterManager.increment() },
                    modifier = Modifier.width(<span class="hljs-number">100.</span>dp)
                ) {
                    Text(text = <span class="hljs-string">"+1"</span>, style = MaterialTheme.typography.titleMedium)
                }
            }

            Spacer(modifier = Modifier.height(<span class="hljs-number">32.</span>dp))

            <span class="hljs-comment">// 跳转到B页面按钮</span>
            Button(
                onClick = {
                    navController.navigate(CmpRouter.RouterPageB.router())
                },
                modifier = Modifier.fillMaxWidth(<span class="hljs-number">0.6f</span>)
            ) {
                Text(
                    text = <span class="hljs-string">"跳转到B页面"</span>,
                    style = MaterialTheme.typography.titleMedium
                )
            }

            Spacer(modifier = Modifier.height(<span class="hljs-number">32.</span>dp))

            <span class="hljs-comment">// 自动计数切换按钮</span>
            Button(
                onClick = { viewModel.counterManager.toggleAutoIncrement() },
                modifier = Modifier.fillMaxWidth(<span class="hljs-number">0.6f</span>)
            ) {
                Text(
                    text = <span class="hljs-keyword">if</span> (isAutoIncrementing) <span class="hljs-string">"停止自动计数"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"开启自动计数"</span>,
                    style = MaterialTheme.typography.titleMedium
                )
            }
        }
    }
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>使用 <code>viewModel()</code> 函数获取 ViewModel 实例</li>
<li>通过 <code>collectAsState()</code> 观察 StateFlow 状态</li>
<li>UI 层简洁，只负责展示和事件处理</li>
</ul>
<h3 data-id="heading-9">架构优势</h3>
<h4 data-id="heading-10">1. 状态自动保留</h4>
<p>ViewModel 的生命周期跟随 <code>NavigationBackStackEntry</code>，即使页面跳转，ViewModel 仍然存活，StateHolder 中的状态得以保留。返回页面时，状态无缝衔接。</p>
<h4 data-id="heading-11">2. 避免 God ViewModel</h4>
<p>很多开发者担心 ViewModel 膨胀成巨型类，我们的设计通过以下方式解决这个问题：</p>
<ul>
<li><strong>单一职责</strong>：ViewModel 只负责管理 StateHolder 的生命周期</li>
<li><strong>组合而非继承</strong>：通过组合多个 StateHolder 来管理不同领域的业务逻辑</li>
<li><strong>StateHolder 独立</strong>：每个 StateHolder 封装特定领域的逻辑，清晰独立</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 示例：一个 ViewModel 可以持有多个 StateHolder</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ComplexPageViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">val</span> counterManager = CounterManager(viewModelScope)
    <span class="hljs-keyword">val</span> userManager = UserManager(viewModelScope)
    <span class="hljs-keyword">val</span> networkManager = NetworkManager(viewModelScope)
    
    <span class="hljs-comment">// 如果有跨 StateHolder 的组合逻辑，可以在这里提供</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadData</span><span class="hljs-params">()</span></span> {
        networkManager.fetch()
        userManager.updateProfile()
    }
}
</code></pre>
<h4 data-id="heading-12">3. 高度可测试</h4>
<ul>
<li><strong>StateHolder 是纯 Kotlin 类</strong>，可以轻松进行单元测试，无需 Android 环境</li>
<li><strong>ViewModel 和 UI 解耦</strong>，可以独立测试业务逻辑</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// CounterManager 的单元测试示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterManagerTest</span> {
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> `increment should increase count`<span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> scope = TestScope()
        <span class="hljs-keyword">val</span> counterManager = CounterManager(scope)
        
        assertEquals(<span class="hljs-number">0</span>, counterManager.count.value)
        counterManager.increment()
        assertEquals(<span class="hljs-number">1</span>, counterManager.count.value)
    }
}
</code></pre>
<h4 data-id="heading-13">4. 清晰的代码结构</h4>

























<table><thead><tr><th>层级</th><th>职责</th><th>示例</th></tr></thead><tbody><tr><td>UI 层</td><td>展示界面，响应用户操作</td><td>RouterPageA.kt</td></tr><tr><td>ViewModel 层</td><td>管理生命周期，持有 StateHolder</td><td>RouterPageAViewModel.kt</td></tr><tr><td>StateHolder 层</td><td>封装业务逻辑和状态</td><td>CounterManager.kt</td></tr></tbody></table>
<h3 data-id="heading-14">适用场景</h3>
<p>这种架构模式特别适合：</p>
<p>✅ <strong>中大型应用</strong> - 有复杂业务逻辑的场景<br/>
✅ <strong>需要状态保留</strong> - 页面跳转后需要保持状态的页面<br/>
✅ <strong>需要高度可测试</strong> - 对代码质量要求较高的项目<br/>
✅ <strong>跨平台项目</strong> - StateHolder 是纯 Kotlin 代码，可复用</p>
<h3 data-id="heading-15">最佳实践建议</h3>
<ol>
<li><strong>StateHolder 命名规范</strong>：使用 <code>xxxManager</code> 或 <code>xxxState</code> 后缀</li>
<li><strong>状态使用 StateFlow</strong>：符合 Compose 响应式编程范式</li>
<li><strong>ViewModel 保持轻量</strong>：只负责持有 StateHolder，避免膨胀</li>
<li><strong>合理的粒度</strong>：StateHolder 应该是合理的业务边界，不要过小也不要过大</li>
</ol>
<h3 data-id="heading-16">总结</h3>
<p>ViewModel + StateHolder 架构模式是解决 Compose 页面跳转状态丢失问题的优雅方案。它不仅解决了状态保留问题，还提供了清晰的代码结构、高度的可测试性，以及避免 God ViewModel 的有效方式。</p>
<p>这种模式符合 Google 官方的架构指导原则，同时在实际项目中具有很高的实用价值。如果你的应用需要处理复杂的页面状态，强烈推荐尝试这种架构！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[BFF 与 Next.js 的联系与组合]]></title>    <link>https://juejin.cn/post/7602837527674273807</link>    <guid>https://juejin.cn/post/7602837527674273807</guid>    <pubDate>2026-02-04T17:13:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602837527674273807" data-draft-id="7602825342228135970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="BFF 与 Next.js 的联系与组合"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2026-02-04T17:13:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="codingWhat"/> <meta itemprop="url" content="https://juejin.cn/user/2189882895642728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            BFF 与 Next.js 的联系与组合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882895642728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    codingWhat
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T17:13:59.000Z" title="Wed Feb 04 2026 17:13:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><em>最近在写一个Next.js的应用，其中API Routes被我当做轻量BFF，去做一些数据加工与处理，那么BFF 与 Next.js到底有什么样的联系呢？</em></h2>
<h2 data-id="heading-1">一、概念先厘清</h2>
<h3 data-id="heading-2">1. BFF（Backend for Frontend）</h3>
<p>BFF 是<strong>为前端专门提供的一层后端</strong>，职责包括：</p>
<ul>
<li><strong>接口聚合</strong>：把多个后端/微服务的调用合并成前端需要的少数接口。</li>
<li><strong>数据裁剪与适配</strong>：把后端 DTO 转成前端需要的结构，减少字段、改名、扁平化等。</li>
<li><strong>鉴权与会话</strong>：在 BFF 统一做登录态校验、权限校验，前端只关心「调一个接口」。</li>
<li><strong>协议与形态统一</strong>：前端只和 BFF 用 REST/JSON 等约定好的方式通信，不直接面对内部 RPC、消息队列等。</li>
</ul>
<p>BFF <strong>不负责 HTML 渲染</strong>，只负责「给前端提供数据接口」。</p>
<h3 data-id="heading-3">2. Next.js 与 SSR</h3>
<p>Next.js 是一个 <strong>React 全栈框架</strong>，除了做前端 SPA，还提供：</p>
<ul>
<li><strong>服务端渲染（SSR）</strong>：在服务器上执行 React，生成 HTML 再返回给浏览器，首屏即完整内容，利于 SEO 和首屏性能。</li>
<li><strong>API Routes</strong>：在 <code>pages/api</code> 下写接口，运行在 Node 里，对外提供 HTTP API，可当「小后端」用。</li>
</ul>
<p>所以：</p>
<ul>
<li><strong>SSR</strong> 解决的是「谁在哪儿把页面渲染出来」的问题（服务器渲染 vs 浏览器渲染）。</li>
<li><strong>BFF</strong> 解决的是「谁给前端提供接口、怎么聚合与适配」的问题。</li>
</ul>
<p>二者一个偏「渲染与页面」，一个偏「接口与数据」，可以单独用，也可以一起用。</p>
<hr/>
<h2 data-id="heading-4">二、A项目中的 BFF 层：</h2>
<p>在我们工作中，前端使用的接口由JAVA编写的BFF分层应用提供，在分层应用中去调用真正的内网接口。</p>
<h3 data-id="heading-5">2.1 架构概览</h3>
<ul>
<li><strong>Web 层</strong>：Controller 暴露 HTTP 接口，路径多为 <code>/xxx/api</code>。</li>
<li><strong>Service 层</strong>：Facade 封装对下游业务服务的调用。</li>
</ul>
<p>前端/移动端只认 BFF 的 URL，不直接调业务中台。</p>
<h3 data-id="heading-6">2.2 Controller：面向前端的接口与鉴权</h3>
<p>以xxx申报记录查询为例（<code>MobilexxxController</code>）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Controller</span>
<span class="hljs-meta">@RequestMapping("/xxx/xxxx/api")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MobilexxxController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MobilexxxBaseController</span> {

    <span class="hljs-meta">@RequestMapping(value = "/query", method = RequestMethod.POST)</span>
    <span class="hljs-meta">@ResponseBody</span>
    <span class="hljs-keyword">public</span> MobilexxxDTO&lt;Object&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> MobileuxxDTO&lt;ZxxxRequestDTO&gt; requestDTO)</span> {
        <span class="hljs-comment">// 1. 获取用户账户信息</span>
        <span class="hljs-type">AccountDTO</span> <span class="hljs-variable">accountDTO</span> <span class="hljs-operator">=</span> getAccount();
        <span class="hljs-comment">// 2. 验证用户会话（BFF 统一鉴权）</span>
        validateHelper.accountSessionCheck(accountDTO, ...);
        <span class="hljs-comment">// 3. 从统一入参中取出业务数据，并注入用户信息</span>
        <span class="hljs-type">ZxxxRequestDTO</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> requestDTO.getData();
        request.setXm(accountDTO.getAccount().getName());
        <span class="hljs-comment">// ...</span>
        <span class="hljs-comment">// 4. 调用 Facade，再统一封装返回格式</span>
        Response&lt;List&lt;ZxxxResponseDTO&gt;&gt; response = mobilexxxFacade.query(request);
        <span class="hljs-keyword">return</span> ResponseHandler.procResponseResult(response);
    }
}
</code></pre>
<p>可以看到 BFF 在这里做了：</p>
<ul>
<li><strong>统一入参/出参</strong>：<code>MobilexxxDTO</code> / <code>MobileuxxDTO</code>，前端只面对一种请求/响应形态。</li>
<li><strong>会话与鉴权</strong>：<code>getAccount()</code>、<code>validateHelper.accountSessionCheck()</code> 在 BFF 完成，前端无感知。</li>
<li><strong>数据注入</strong>：把当前用户姓名、证件号等写入请求再交给下游，前端不用传敏感信息。</li>
</ul>
<h3 data-id="heading-7">2.3 Facade：聚合下游服务</h3>
<p>Facade 不实现业务，只做「转发 + 聚合」：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MobilexxxFacade</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RestfulClient restfulClient;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RestfulUrlHelper restfulUrlHelper;

    <span class="hljs-keyword">public</span> Response&lt;List&lt;ZxxResponseDTO&gt;&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(ZxxRequestDTO request)</span> {
        <span class="hljs-keyword">return</span> restfulClient.postForJson(
            restfulUrlHelper.getxxxnwUrl(<span class="hljs-string">"xxxx/query"</span>),
            request, Response.class, List.class, ZxxResponseDTO.class);
    }
}
</code></pre>
<p>其他 Facade同理：BFF 通过 RestfulClient 调远端服务，对前端只暴露「一个接口、一种协议」。</p>
<p>小结：<strong>app 这一层是典型的 BFF</strong>——独立部署的 Java 服务，只提供 API，不负责页面渲染；职责是鉴权、聚合、适配，方便前端/移动端调用。</p>
<hr/>
<h2 data-id="heading-8">三、B项目中的 Next.js 与 SSR：</h2>
<p><strong>xxx-Next</strong> 是 Next.js 应用，同时用到了 <strong>SSR</strong> 和 <strong>API Routes（充当轻量 BFF）</strong>。</p>
<h3 data-id="heading-9">3.1 SSR：首屏服务端取数与渲染</h3>
<p>使用 <code>getServerSideProps</code> <strong>每次请求时</strong>在服务端拉取数据并渲染：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GetData</span>(<span class="hljs-params">props: PropsType</span>) {
  <span class="hljs-keyword">const</span> { err, data, msg = <span class="hljs-string">''</span> } = props
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// ...</span>
  )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getServerSideProps</span>(<span class="hljs-params">context: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-keyword">const</span> { id = <span class="hljs-string">''</span> } = context.<span class="hljs-property">params</span>
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDataById</span>(id)  <span class="hljs-comment">// 服务端请求接口</span>
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">props</span>: data }
}
</code></pre>
<p>流程是：</p>
<ol>
<li>用户请求 <code>/data/xxx</code>;</li>
<li>Next 在服务器执行 <code>getServerSideProps</code>，调用 <code>getDataById(id)</code>;</li>
<li>拿到数据后，在服务器上渲染 React，得到 HTML;</li>
<li>把 HTML 和序列化好的 <code>props</code> 一起返回给浏览器;</li>
</ol>
<p>这样首屏就是「带数据的完整 HTML」，无需等客户端再发请求才出内容，这就是 <strong>SSR</strong>。这里 Next.js 的角色是「渲染层 + 在服务端发起数据请求」，数据来源也可以换成调用上面那套 Java BFF。</p>
<h3 data-id="heading-10">3.2 API Routes："薄" BFF</h3>
<p>点击提交按钮时，指向的是 Next 自己的接口：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">req: NextApiRequest, res: NextApiResponse</span>) {
  <span class="hljs-comment">// 数据加工</span>
  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">genData</span>(req.<span class="hljs-property">body</span>)  <span class="hljs-comment">// 把表单 body 转成后端需要的结构</span>
  <span class="hljs-keyword">const</span> resData = <span class="hljs-keyword">await</span> <span class="hljs-title function_">postData</span>(data)
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>这里 Next.js 的 API Route 做的是：</p>
<ul>
<li><strong>接收</strong>： 传入的数据，如表单数据；</li>
<li><strong>转换</strong>：<code>genData(req.body)</code> 把表单字段整理成接口需要的结构；</li>
<li><strong>转发</strong>：<code>postData(data)</code> 再请求真正的后端。</li>
</ul>
<p>也就是说，<strong>API Route 在这里扮演了一层薄 BFF</strong>：对前端暴露简单的一个 POST <code>/api/data</code>，内部做参数适配和转发，前端不直接调外部后端。</p>
<h3 data-id="heading-11">3.3 数据流小结</h3>
<ul>
<li><strong>读</strong>：浏览器 → Next 服务端 → <code>getServerSideProps</code> 里 <code>getDataById</code> → 外部接口→ 服务端渲染 HTML → 返回。</li>
<li><strong>写</strong>：浏览器 POST 到 Next 的 <code>/api/data</code> → API Route 整理参数并 <code>postData()</code> → 再请求后端→ 根据结果处理。</li>
</ul>
<p>SSR 解决「从哪拿数据、在哪渲染」；API Route 解决「提交时谁来做参数转换和转发」。两者都在 Next 里，但职责不同。</p>
<hr/>
<h2 data-id="heading-12">四、BFF 与 Next.js（SSR）的区别</h2>








































<table><thead><tr><th>维度</th><th>BFF（如 app 中的 Java 层）</th><th>Next.js（SSR + API Routes）</th></tr></thead><tbody><tr><td><strong>主要职责</strong></td><td>为前端提供聚合/适配后的 API</td><td>渲染 HTML 页面 + 可选的 API 端点</td></tr><tr><td><strong>是否渲染</strong></td><td>不渲染，只返回 JSON 等数据</td><td>服务端执行 React，输出 HTML</td></tr><tr><td><strong>典型部署</strong></td><td>独立服务（如 Java 进程、容器）</td><td>Node 进程，同一应用里既有页面也有 API</td></tr><tr><td><strong>技术栈</strong></td><td>任意后端语言（本项目为 Java）</td><td>Node + React（Next.js）</td></tr><tr><td><strong>鉴权位置</strong></td><td>常在 BFF 统一做</td><td>可在 API Route 或 getServerSideProps 里做</td></tr><tr><td><strong>适用场景</strong></td><td>多端复用同一套接口、多后端聚合</td><td>需要 SEO、首屏性能的前端应用</td></tr></tbody></table>
<p>简言之：<strong>BFF 是「专门给前端的接口层」；Next.js SSR 是「在服务器上把页面渲染出来的方式」</strong>。一个偏数据与接口，一个偏页面与渲染。</p>
<hr/>
<h2 data-id="heading-13">五、BFF 与 Next.js 的联系与组合</h2>
<ol>
<li>
<p><strong>Next.js API Routes 本身可以当作轻量 BFF</strong><br/>
如 xxx-Next 的 <code>/api/data</code>：接收整理参数，再调后端。适合逻辑简单、不需要多语言/多后端聚合的场景。</p>
</li>
<li>
<p><strong>Next.js 的 SSR 可以消费 BFF</strong><br/>
在 <code>getServerSideProps</code> 或 <code>getStaticProps</code> 里，用 <code>getDataById</code> 这类函数去请求「真正的 BFF」（例如 app 里的 <code>xxx/xxx/api</code>），而不是直接调业务中台。这样：</p>
<ul>
<li>鉴权、聚合在 BFF 完成；</li>
<li>Next 只负责「要什么数据、怎么渲染」，职责清晰。</li>
</ul>
</li>
<li>
<p><strong>组合方式示例</strong></p>
<ul>
<li>把 xxx-Next 里 <code>ajax.ts</code> 的 <code>HOST</code> 或 <code>getDataById</code> 的 URL 指向 app 的 BFF 地址，数据就从 Java BFF 来。</li>
<li>提交仍可先到 Next 的 <code>/api/data</code>，再由 API Route 调 BFF 的提交接口，这样前端只和 Next 打交道，BFF 由 Next 在服务端/API 里调用。</li>
</ul>
</li>
</ol>
<p>于是可以形成：<strong>浏览器 ↔ Next.js（SSR + API Routes）↔ BFF（app）↔ 业务服务</strong>。BFF 管「接口与数据」，Next 管「页面与一次转发/适配」。</p>
<hr/>
<h2 data-id="heading-14">六、总结</h2>
<ul>
<li><strong>BFF</strong>：面向前端的接口层，做聚合、适配、鉴权，不负责渲染；本项目中 <strong>app</strong> 的 Controller + Facade 是典型实现。</li>
<li><strong>Next.js SSR</strong>：在服务端按请求拉数据并渲染 React 成 HTML，首屏快、利于 SEO；<strong>xxx-Next</strong> 的 <code>getServerSideProps</code> 就是 SSR。</li>
<li><strong>区别</strong>：BFF 是「接口层」，Next.js（SSR）是「渲染方式」；BFF 可独立于前端技术栈部署，Next 是前端框架自带服务端能力。</li>
<li><strong>联系</strong>：Next 的 API Routes 可当薄 BFF 用；SSR 的数据来源可以、也适合来自 BFF；二者组合能同时获得「清晰的数据接口层」和「更好的首屏与 SEO」。</li>
</ul>
<p>结合项目：<strong>app 负责「给前端/移动端提供统一、安全、好用的 API」；xxx-Next 负责「用 Next.js 把页面做出来（SSR），并用 API Route 做提交时的薄 BFF」</strong>。理解这一点，就能在架构上分清 BFF 与 Next.js（SSR）各自解决什么问题、如何配合使用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ConnectivityService框架]]></title>    <link>https://juejin.cn/post/7602825342228889634</link>    <guid>https://juejin.cn/post/7602825342228889634</guid>    <pubDate>2026-02-05T02:42:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602825342228889634" data-draft-id="7602837527674961935" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ConnectivityService框架"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-05T02:42:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ConnectivityService框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T02:42:54.000Z" title="Thu Feb 05 2026 02:42:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ConnectivityService 框架详解</h2>
<p>ConnectivityService 是 Android 网络架构的<strong>中央管理者</strong>，负责协调所有网络连接和请求。让我详细解析它的框架。</p>
<h3 data-id="heading-1">一、核心职责</h3>
<pre><code class="hljs language-105:116:packages_modules_Connectivity/framework/src/android/net/ConnectivityManager.java" lang="105:116:packages_modules_Connectivity/framework/src/android/net/ConnectivityManager.java"> * The primary responsibilities of this class are to:
 * &lt;ol&gt;
 * &lt;li&gt;Monitor network connections (Wi-Fi, GPRS, UMTS, etc.)&lt;/li&gt;
 * &lt;li&gt;Send broadcast intents when network connectivity changes&lt;/li&gt;
 * &lt;li&gt;Attempt to "fail over" to another network when connectivity to a network
 * is lost&lt;/li&gt;
 * &lt;li&gt;Provide an API that allows applications to query the coarse-grained or fine-grained
 * state of the available networks&lt;/li&gt;
 * &lt;li&gt;Provide an API that allows applications to request and select networks for their data
 * traffic&lt;/li&gt;
 * &lt;/ol&gt;
 */
</code></pre>
<h3 data-id="heading-2">二、核心数据结构</h3>
<h4 data-id="heading-3">1. <strong>NetworkAgentInfo 集合</strong> - 管理所有网络</h4>
<pre><code class="hljs language-8546:8548:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java" lang="8546:8548:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java">// Tracks all NetworkAgents that are currently registered.
// NOTE: Only should be accessed on ConnectivityServiceThread, except dump().
private final ArraySet&lt;NetworkAgentInfo&gt; mNetworkAgentInfos = new ArraySet&lt;&gt;();
</code></pre>
<ul>
<li>存储所有已注册的网络（WiFi、Cellular、Ethernet等）</li>
<li>每个 <code>NetworkAgentInfo</code> 代表一个物理或虚拟网络</li>
<li><strong>线程安全</strong>：仅在 ConnectivityService 线程访问</li>
</ul>
<h4 data-id="heading-4">2. <strong>NetworkRequest 映射</strong> - 管理所有网络请求</h4>
<pre><code class="hljs language-7504:7504:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java" lang="7504:7504:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java">private final HashMap&lt;NetworkRequest, NetworkRequestInfo&gt; mNetworkRequests = new HashMap&lt;&gt;();
</code></pre>
<ul>
<li>存储所有应用和系统的网络请求</li>
<li>Key: <code>NetworkRequest</code> - 请求本身</li>
<li>Value: <code>NetworkRequestInfo</code> - 请求的详细信息和满足状态</li>
</ul>
<h3 data-id="heading-5">三、NetworkAgent 注册流程</h3>
<pre><code class="hljs language-740:776:packages_modules_Connectivity/framework/src/android/net/NetworkAgent.java" lang="740:776:packages_modules_Connectivity/framework/src/android/net/NetworkAgent.java">    /**
     * Register this network agent with ConnectivityService.
     *
     * This method can only be called once per network agent.
     *
     * @return the Network associated with this network agent (which can also be obtained later
     *         by calling getNetwork() on this agent).
     * @throws IllegalStateException thrown by the system server if this network agent is
     *         already registered.
     */
    @NonNull
    public Network register() {
        if (VDBG) log("Registering NetworkAgent");
        synchronized (mRegisterLock) {
            if (mNetwork != null) {
                throw new IllegalStateException("Agent already registered");
            }
            final ConnectivityManager cm = (ConnectivityManager) mInitialConfiguration.context
                    .getSystemService(Context.CONNECTIVITY_SERVICE);
            if (mInitialConfiguration.localNetworkConfig == null) {
                // Call registerNetworkAgent without localNetworkConfig argument to pass
                // android.net.cts.NetworkAgentTest#testAgentStartsInConnecting in old cts
                mNetwork = cm.registerNetworkAgent(new NetworkAgentBinder(mHandler),
                        new NetworkInfo(mInitialConfiguration.info),
                        mInitialConfiguration.properties, mInitialConfiguration.capabilities,
                        mInitialConfiguration.score, mInitialConfiguration.config, providerId);
            } else {
                mNetwork = cm.registerNetworkAgent(new NetworkAgentBinder(mHandler),
                        new NetworkInfo(mInitialConfiguration.info),
                        mInitialConfiguration.properties, mInitialConfiguration.capabilities,
                        mInitialConfiguration.localNetworkConfig, mInitialConfiguration.score,
                        mInitialConfiguration.config, providerId);
            }
            mInitialConfiguration = null; // All this memory can now be GC'd
        }
        return mNetwork;
    }
</code></pre>
<p><strong>注册流程</strong>：</p>
<ol>
<li>NetworkAgent 调用 <code>register()</code></li>
<li>通过 ConnectivityManager 调用 <code>registerNetworkAgent()</code></li>
<li>ConnectivityService 创建 <code>NetworkAgentInfo</code></li>
<li>添加到 <code>mNetworkAgentInfos</code> 集合</li>
<li>触发网络重新匹配 (<code>rematch</code>)</li>
</ol>
<h3 data-id="heading-6">四、网络请求处理</h3>
<h4 data-id="heading-7">1. <strong>请求注册</strong></h4>
<pre><code class="hljs language-5683:5723:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java" lang="5683:5723:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java">    private void handleRegisterNetworkRequest(@NonNull final NetworkRequestInfo nri) {
        handleRegisterNetworkRequests(Collections.singleton(nri));
    }

    private void handleRegisterNetworkRequests(@NonNull final Set&lt;NetworkRequestInfo&gt; nris) {
        ensureRunningOnConnectivityServiceThread();
        for (final NetworkRequestInfo nri : nris) {
            mNetworkRequestInfoLogs.log("REGISTER " + nri);
            checkNrisConsistency(nri);
            for (final NetworkRequest req : nri.mRequests) {
                mNetworkRequests.put(req, nri);
                // TODO: Consider update signal strength for other types.
                if (req.isListen()) {
                    for (final NetworkAgentInfo network : mNetworkAgentInfos) {
                        if (req.networkCapabilities.hasSignalStrength()
                                &amp;&amp; network.satisfiesImmutableCapabilitiesOf(req)) {
                            updateSignalStrengthThresholds(network, "REGISTER", req);
                        }
                    }
                } else if (req.isRequest() &amp;&amp; mNetworkRequestStateStatsMetrics != null) {
                    mNetworkRequestStateStatsMetrics.onNetworkRequestReceived(req);
                }
            }

            // If this NRI has a satisfier already, it is replacing an older request that
            // has been removed. Track it.
            final NetworkRequest activeRequest = nri.getActiveRequest();
            if (null != activeRequest) {
                // If there is an active request, then for sure there is a satisfier.
                nri.getSatisfier().addRequest(activeRequest);
            }

            if (shouldTrackUidsForBlockedStatusCallbacks()
                    &amp;&amp; isAppRequest(nri)
                    &amp;&amp; !nri.mUidTrackedForBlockedStatus) {
                Log.wtf(TAG, "Registered nri is not tracked for sending blocked status: " + nri);
            }
        }

        if (mFlags.noRematchAllRequestsOnRegister()) {
            rematchNetworksAndRequests(nris);
</code></pre>
<h4 data-id="heading-8">2. <strong>网络请求类型</strong></h4>
<pre><code class="hljs language-7976:8008:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java" lang="7976:8008:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java">        switch (reqType) {
            case TRACK_DEFAULT:
                // If the request type is TRACK_DEFAULT, the passed {@code networkCapabilities}
                // is unused and will be replaced by ones appropriate for the UID (usually, the
                // calling app). This allows callers to keep track of the default network.
                networkCapabilities = copyDefaultNetworkCapabilitiesForUid(
                        defaultNc, asUid, callingUid, callingPackageName);
                enforceAccessPermission();
                break;
            case TRACK_SYSTEM_DEFAULT:
                enforceSettingsOrSetupWizardOrUseRestrictedNetworksPermission();
                networkCapabilities = new NetworkCapabilities(defaultNc);
                break;
            case BACKGROUND_REQUEST:
                enforceNetworkStackOrSettingsPermission();
                // Fall-through since other checks are the same with normal requests.
            case REQUEST:
                networkCapabilities = new NetworkCapabilities(networkCapabilities);
                enforceNetworkRequestPermissions(networkCapabilities, callingPackageName,
                        callingAttributionTag, callingUid);
                // TODO: this is incorrect. We mark the request as metered or not depending on
                //  the state of the app when the request is filed, but we never change the
                //  request if the app changes network state. http://b/29964605
                enforceMeteredApnPolicy(networkCapabilities);
                maybeDisableLocalNetworkMatching(networkCapabilities, callingUid);
                break;
            case LISTEN_FOR_BEST:
                enforceAccessPermission();
                networkCapabilities = new NetworkCapabilities(networkCapabilities);
</code></pre>
<p><strong>请求类型</strong>：</p>
<ul>
<li><strong>REQUEST</strong>: 应用主动请求网络，可能导致网络建立</li>
<li><strong>LISTEN</strong>: 仅监听网络变化，不主动建立</li>
<li><strong>TRACK_DEFAULT</strong>: 跟踪默认网络</li>
<li><strong>TRACK_SYSTEM_DEFAULT</strong>: 跟踪系统默认网络</li>
<li><strong>BACKGROUND_REQUEST</strong>: 后台请求</li>
<li><strong>LISTEN_FOR_BEST</strong>: 监听最佳网络</li>
</ul>
<h3 data-id="heading-9">五、核心算法：网络重新匹配 (Rematch)</h3>
<p>这是 ConnectivityService 最关键的算法，决定哪个网络满足哪个请求。</p>
<h4 data-id="heading-10">1. <strong>触发 Rematch 的场景</strong></h4>
<ul>
<li>新网络注册</li>
<li>网络断开</li>
<li>网络评分变化</li>
<li>网络能力变化</li>
<li>新的网络请求注册</li>
<li>网络请求取消</li>
</ul>
<h4 data-id="heading-11">2. <strong>Rematch 算法</strong></h4>
<pre><code class="hljs language-10710:10758:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java" lang="10710:10758:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java">    /**
     * This function is triggered when something can affect what network should satisfy what
     * request, and it computes the network reassignment from the passed collection of requests to
     * network match to the one that the system should now have. That data is encoded in an
     * object that is a list of changes, each of them having an NRI, and old satisfier, and a new
     * satisfier.
     *
     * After the reassignment is computed, it is applied to the state objects.
     *
     * @param networkRequests the nri objects to evaluate for possible network reassignment
     * @return NetworkReassignment listing of proposed network assignment changes
     */
    @NonNull
    private NetworkReassignment computeNetworkReassignment(
            @NonNull final Collection&lt;NetworkRequestInfo&gt; networkRequests) {
        final NetworkReassignment changes = new NetworkReassignment();

        // Gather the list of all relevant agents.
        final ArrayList&lt;NetworkAgentInfo&gt; nais = new ArrayList&lt;&gt;();
        for (final NetworkAgentInfo nai : mNetworkAgentInfos) {
            nais.add(nai);
        }

        for (final NetworkRequestInfo nri : networkRequests) {
            // Non-multilayer listen requests can be ignored.
            if (!nri.isMultilayerRequest() &amp;&amp; nri.mRequests.get(0).isListen()) {
                continue;
            }
            NetworkAgentInfo bestNetwork = null;
            NetworkRequest bestRequest = null;
            for (final NetworkRequest req : nri.mRequests) {
                bestNetwork = mNetworkRanker.getBestNetwork(req, nais, nri.getSatisfier());
                // Stop evaluating as the highest possible priority request is satisfied.
                if (null != bestNetwork) {
                    bestRequest = req;
                    break;
                }
            }
            if (null == bestNetwork &amp;&amp; isDefaultBlocked(nri)) {
                // Remove default networking if disallowed for managed default requests.
                bestNetwork = mNoServiceNetwork;
            }
            if (nri.getSatisfier() != bestNetwork) {
                // bestNetwork may be null if no network can satisfy this request.
                changes.addRequestReassignment(new NetworkReassignment.RequestReassignment(
                        nri, nri.mActiveRequest, bestRequest, nri.getSatisfier(), bestNetwork));
            }
        }
        return changes;
    }
</code></pre>
<h4 data-id="heading-12">3. <strong>完整的 Rematch 流程</strong></h4>
<pre><code class="hljs language-10768:10796:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java" lang="10768:10796:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java">    /**
     * Attempt to rematch all Networks with all NetworkRequests.  This may result in Networks
     * being disconnected.
     */
    private void rematchAllNetworksAndRequests() {
        rematchNetworksAndRequests(getNrisFromGlobalRequests());
    }

    /**
     * Attempt to rematch all Networks with given NetworkRequests.  This may result in Networks
     * being disconnected.
     */
    private void rematchNetworksAndRequests(
            @NonNull final Set&lt;NetworkRequestInfo&gt; networkRequests) {
        ensureRunningOnConnectivityServiceThread();
        // TODO: This may be slow, and should be optimized.
        final long start = SystemClock.elapsedRealtime();
        final NetworkReassignment changes = computeNetworkReassignment(networkRequests);
        final long computed = SystemClock.elapsedRealtime();
        applyNetworkReassignment(changes, start);
        final long applied = SystemClock.elapsedRealtime();
        issueNetworkNeeds();
        final long end = SystemClock.elapsedRealtime();
        if (VDBG || DDBG) {
            log(String.format("Rematched networks [computed %dms] [applied %dms] [issued %d]",
                    computed - start, applied - computed, end - applied));
            log(changes.debugString());
        } else if (DBG) {
            // Shorter form, only one line of log
            log(String.format("%s [c %d] [a %d] [i %d]", changes.toString(),
                    computed - start, applied - computed, end - applied));
        }
    }
</code></pre>
<p><strong>步骤</strong>：</p>
<ol>
<li><strong>计算重新分配</strong> (<code>computeNetworkReassignment</code>): 对每个请求找到最佳网络</li>
<li><strong>应用重新分配</strong> (<code>applyNetworkReassignment</code>): 更新满足关系</li>
<li><strong>发出网络需求</strong> (<code>issueNetworkNeeds</code>): 通知 NetworkProvider</li>
</ol>
<h3 data-id="heading-13">六、关键组件</h3>
<h4 data-id="heading-14">1. <strong>NetworkRanker</strong> - 网络排名器</h4>
<ul>
<li>根据策略选择最佳网络</li>
<li>详见之前的"网络评分机制"分析</li>
</ul>
<h4 data-id="heading-15">2. <strong>DnsManager</strong> - DNS 管理</h4>
<ul>
<li>Private DNS 配置</li>
<li>DNS 验证</li>
</ul>
<h4 data-id="heading-16">3. <strong>MultinetworkPolicyTracker</strong> - 多网络策略</h4>
<ul>
<li>"避免坏 WiFi" 配置</li>
<li>多网络同时激活策略</li>
</ul>
<h4 data-id="heading-17">4. <strong>PermissionMonitor</strong> - 权限监控</h4>
<ul>
<li>监控应用权限变化</li>
<li>INTERNET 权限检查</li>
</ul>
<h4 data-id="heading-18">5. <strong>NetworkNotificationManager</strong> - 通知管理</h4>
<ul>
<li>显示网络状态通知</li>
<li>Captive Portal 通知</li>
<li>部分连接通知</li>
</ul>
<h4 data-id="heading-19">6. <strong>LingerMonitor</strong> - Linger 监控</h4>
<ul>
<li>实现网络保活机制</li>
<li>监控网络切换</li>
</ul>
<h3 data-id="heading-20">七、Linger 机制</h3>
<pre><code class="hljs language-458:461:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java" lang="458:461:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java">    // Default to 30s linger time-out, and 5s for nascent network. Modifiable only for testing.
    private static final String LINGER_DELAY_PROPERTY = "persist.netmon.linger";
    private static final int DEFAULT_LINGER_DELAY_MS = 30_000;
    private static final int DEFAULT_NASCENT_DELAY_MS = 5_000;
</code></pre>
<p><strong>Linger 状态</strong>：</p>
<ul>
<li><strong>Nascent (新生)</strong>: 网络刚连接，还未被使用，保留 5 秒</li>
<li><strong>Lingering (徘徊)</strong>: 网络失去所有请求但仍保持连接 30 秒</li>
<li>目的：避免频繁切换网络，给替代网络时间验证</li>
</ul>
<h3 data-id="heading-21">八、事件驱动架构</h3>
<p>ConnectivityService 使用 Handler 机制处理异步事件：</p>
<pre><code class="hljs language-642:799:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java" lang="642:799:packages_modules_Connectivity/service/src/com/android/server/ConnectivityService.java">    /**
     * used internally to clear a wakelock when transitioning
     * from one net to another.  Clear happens when we get a new
     * network - EVENT_EXPIRE_NET_TRANSITION_WAKELOCK happens
     * after a timeout if no network is found (typically 1 min).
     */
    private static final int EVENT_CLEAR_NET_TRANSITION_WAKELOCK = 8;

    /**
     * used internally to reload global proxy settings
     */
    private static final int EVENT_APPLY_GLOBAL_HTTP_PROXY = 9;

    /**
     * PAC manager has received new port.
     */
    private static final int EVENT_PAC_PROXY_HAS_CHANGED = 16;

    /**
     * used internally when registering NetworkProviders
     * obj = NetworkProviderInfo
     */
    private static final int EVENT_REGISTER_NETWORK_PROVIDER = 17;

    /**
     * used internally when registering NetworkAgents
     * obj = Messenger
     */
    private static final int EVENT_REGISTER_NETWORK_AGENT = 18;

    /**
     * used to add a network request
     * includes a NetworkRequestInfo
     */
    private static final int EVENT_REGISTER_NETWORK_REQUEST = 19;

    /**
     * indicates a timeout period is over - check if we had a network yet or not
     * and if not, call the timeout callback (but leave the request live until they
     * cancel it.
     * includes a NetworkRequestInfo
     */
    private static final int EVENT_TIMEOUT_NETWORK_REQUEST = 20;

    /**
     * used to add a network listener - no request
     * includes a NetworkRequestInfo
     */
    private static final int EVENT_REGISTER_NETWORK_LISTENER = 21;

    /**
     * used to remove a network request, either a listener or a real request
     * arg1 = UID of caller
     * obj  = NetworkRequest
     */
    private static final int EVENT_RELEASE_NETWORK_REQUEST = 22;

    /**
     * used internally when registering NetworkProviders
     * obj = Messenger
     */
    private static final int EVENT_UNREGISTER_NETWORK_PROVIDER = 23;

    /**
     * used internally to expire a wakelock when transitioning
     * from one net to another.  Expire happens when we fail to find
     * a new network (typically after 1 minute) -
     * EVENT_CLEAR_NET_TRANSITION_WAKELOCK happens if we had found
     * a replacement network.
     */
    private static final int EVENT_EXPIRE_NET_TRANSITION_WAKELOCK = 24;

    /**
     * used to add a network request with a pending intent
     * obj = NetworkRequestInfo
     */
    private static final int EVENT_REGISTER_NETWORK_REQUEST_WITH_INTENT = 26;

    /**
     * used to remove a pending intent and its associated network request.
     * arg1 = UID of caller
     * obj  = PendingIntent
     */
    private static final int EVENT_RELEASE_NETWORK_REQUEST_WITH_INTENT = 27;

    /**
     * used to specify whether a network should be used even if unvalidated.
     * arg1 = whether to accept the network if it's unvalidated (1 or 0)
     * arg2 = whether to remember this choice in the future (1 or 0)
     * obj  = network
     */
    private static final int EVENT_SET_ACCEPT_UNVALIDATED = 28;

    /**
     * used internally to (re)configure always-on networks.
     */
    private static final int EVENT_CONFIGURE_ALWAYS_ON_NETWORKS = 30;

    /**
     * used to add a network listener with a pending intent
     * obj = NetworkRequestInfo
     */
    private static final int EVENT_REGISTER_NETWORK_LISTENER_WITH_INTENT = 31;

    /**
     * used to specify whether a network should not be penalized when it becomes unvalidated.
     */
    private static final int EVENT_SET_AVOID_UNVALIDATED = 35;

    /**
     * used to handle reported network connectivity. May trigger revalidation of a network.
     */
    private static final int EVENT_REPORT_NETWORK_CONNECTIVITY = 36;

    // Handle changes in Private DNS settings.
    private static final int EVENT_PRIVATE_DNS_SETTINGS_CHANGED = 37;

    // Handle private DNS validation status updates.
    private static final int EVENT_PRIVATE_DNS_VALIDATION_UPDATE = 38;

     /**
      * Event for NetworkMonitor/NetworkAgentInfo to inform ConnectivityService that the network has
      * been tested.
      * obj = {@link NetworkTestedResults} representing information sent from NetworkMonitor.
      * data = PersistableBundle of extras passed from NetworkMonitor. If {@link
      * NetworkMonitorCallbacks#notifyNetworkTested} is called, this will be null.
      */
    private static final int EVENT_NETWORK_TESTED = 41;

    /**
     * Event for NetworkMonitor/NetworkAgentInfo to inform ConnectivityService that the private DNS
     * config was resolved.
     * obj = PrivateDnsConfig
     * arg2 = netid
     */
    private static final int EVENT_PRIVATE_DNS_CONFIG_RESOLVED = 42;

    /**
     * Request ConnectivityService display provisioning notification.
     * arg1    = Whether to make the notification visible.
     * arg2    = NetID.
     * obj     = Intent to be launched when notification selected by user, null if !arg1.
     */
    private static final int EVENT_PROVISIONING_NOTIFICATION = 43;

    /**
     * Used to specify whether a network should be used even if connectivity is partial.
     * arg1 = whether to accept the network if its connectivity is partial (1 for true or 0 for
     * false)
     * arg2 = whether to remember this choice in the future (1 for true or 0 for false)
     * obj  = network
     */
    private static final int EVENT_SET_ACCEPT_PARTIAL_CONNECTIVITY = 44;

    /**
     * Event for NetworkMonitor to inform ConnectivityService that the probe status has changed.
     * Both of the arguments are bitmasks, and the value of bits come from
     * INetworkMonitor.NETWORK_VALIDATION_PROBE_*.
     * arg1 = unused
     * arg2 = netId
     * obj = A Pair of integers: the bitmasks of, respectively, completed and successful probes.
     */
    public static final int EVENT_PROBE_STATUS_CHANGED = 45;
</code></pre>
<h3 data-id="heading-22">九、ConnectivityService 架构图</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────────┐
│                      ConnectivityService                             │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                    Handler (单线程处理)                         │ │
│  │  • EVENT_REGISTER_NETWORK_AGENT                                │ │
│  │  • EVENT_REGISTER_NETWORK_REQUEST                              │ │
│  │  • EVENT_NETWORK_TESTED                                        │ │
│  │  • EVENT_PRIVATE_DNS_VALIDATION_UPDATE                         │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                       │
│  ┌──────────────────────┐    ┌──────────────────────────────────┐  │
│  │  mNetworkAgentInfos  │    │   mNetworkRequests               │  │
│  │  (所有网络)          │    │   (所有请求)                     │  │
│  │  • WiFi              │    │   • App 请求                     │  │
│  │  • Cellular          │    │   • 系统请求                     │  │
│  │  • VPN               │    │   • 监听器                       │  │
│  │  • Ethernet          │    │   • 默认网络跟踪                 │  │
│  └──────────────────────┘    └──────────────────────────────────┘  │
│           │                              │                           │
│           └──────────────┬───────────────┘                           │
│                          ▼                                           │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │             <span class="hljs-built_in">rematchNetworksAndRequests</span>()                        │ │
│  │  <span class="hljs-number">1</span>. 计算重新分配 (computeNetworkReassignment)                  │ │
│  │     • 使用 NetworkRanker 为每个请求找最佳网络                  │ │
│  │  <span class="hljs-number">2</span>. 应用重新分配 (applyNetworkReassignment)                   │ │
│  │     • 更新 NetworkAgentInfo 的请求列表                         │ │
│  │     • 更新 NetworkRequestInfo 的满足者                         │ │
│  │  <span class="hljs-number">3</span>. 发出网络需求 (issueNetworkNeeds)                          │ │
│  │     • 通知 NetworkProvider 需要新网络                          │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                       │
│  ┌─────────────────── 核心组件 ────────────────────────────────┐   │
│  │ • NetworkRanker       - 网络排名                             │   │
│  │ • DnsManager          - DNS 管理                             │   │
│  │ • LingerMonitor       - Linger 监控                          │   │
│  │ • PermissionMonitor   - 权限监控                             │   │
│  │ • MultinetworkPolicyTracker - 多网络策略                     │   │
│  │ • NetworkNotificationManager - 通知管理                      │   │
│  │ • RoutingCoordinatorService - 路由协调                       │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                    ▲                            │
                    │ 注册/更新                   │ 回调
                    │                            ▼
┌────────────────────────────────┐  ┌──────────────────────────────┐
│       NetworkAgent             │  │     应用 / 系统服务          │
│  • TelephonyNetworkAgent       │  │  • NetworkCallback           │
│  • WifiNetworkAgent            │  │  • NetworkRequest            │
│  • VpnNetworkAgent             │  │  • ConnectivityManager       │
└────────────────────────────────┘  └──────────────────────────────┘
</code></pre>
<h3 data-id="heading-23">十、关键流程时序</h3>
<h4 data-id="heading-24">1. <strong>网络连接流程</strong></h4>
<pre><code class="hljs language-scss" lang="scss">NetworkAgent          ConnectivityService         NetworkMonitor        App
    │                        │                          │                │
    │ <span class="hljs-built_in">register</span>()             │                          │                │
    ├───────────────────────&gt;│                          │                │
    │                        │ 创建 NetworkAgentInfo    │                │
    │                        │                          │                │
    │ <span class="hljs-built_in">markConnected</span>()        │                          │                │
    ├───────────────────────&gt;│ 触发验证                 │                │
    │                        ├─────────────────────────&gt;│                │
    │                        │                          │ HTTP/HTTPS探测 │
    │                        │ <span class="hljs-built_in">rematchNetworksAndRequests</span>() │            │
    │                        │ (找到满足的请求)         │                │
    │                        │                          │                │
    │                        │ <span class="hljs-built_in">onAvailable</span>()            │                │
    │                        ├────────────────────────────────────────&gt;│
    │                        │                          │ onValidated   │
    │                        │&lt;─────────────────────────┤                │
    │                        │ 更新能力: VALIDATED      │                │
    │                        ├────────────────────────────────────────&gt;│
    │                        │ <span class="hljs-built_in">onCapabilitiesChanged</span>()  │                │
</code></pre>
<h4 data-id="heading-25">2. <strong>网络请求流程</strong></h4>
<pre><code class="hljs language-scss" lang="scss">App                 ConnectivityService      NetworkRanker      NetworkAgent
 │                          │                      │                  │
 │ <span class="hljs-built_in">requestNetwork</span>()         │                      │                  │
 ├─────────────────────────&gt;│                      │                  │
 │                          │ 创建 NRI             │                  │
 │                          │ <span class="hljs-built_in">rematchNetworks</span>()    │                  │
 │                          ├─────────────────────&gt;│                  │
 │                          │ <span class="hljs-built_in">getBestNetwork</span>()     │                  │
 │                          │&lt;─────────────────────┤                  │
 │                          │                      │                  │
 │ 情况<span class="hljs-number">1</span>: 有满足的网络      │                      │                  │
 │&lt;─────────────────────────┤ <span class="hljs-built_in">onAvailable</span>()        │                  │
 │                          │                      │                  │
 │ 情况<span class="hljs-number">2</span>: 无满足的网络      │                      │                  │
 │                          │ <span class="hljs-built_in">issueNetworkNeeds</span>()  │                  │
 │                          │ ─────────────────────────────────────&gt;│
 │                          │                      │  (请求建立新网络) │
</code></pre>
<h3 data-id="heading-26">十一、关键特性</h3>
<ol>
<li>
<p><strong>单线程模型</strong>：所有操作在 ConnectivityService Handler 线程执行，避免并发问题</p>
</li>
<li>
<p><strong>懒惰评估</strong>：不会主动建立网络，只有在有请求时才建立</p>
</li>
<li>
<p><strong>优雅降级</strong>：Linger 机制确保网络切换平滑</p>
</li>
<li>
<p><strong>权限控制</strong>：严格的权限检查，不同 UID 看到不同的网络</p>
</li>
<li>
<p><strong>性能优化</strong>：</p>
<ul>
<li>增量 Rematch（仅重新匹配相关请求）</li>
<li>批量处理回调</li>
<li>避免不必要的网络创建/销毁</li>
</ul>
</li>
</ol>
<p>这就是 ConnectivityService 的完整框架！它是 Android 网络架构的大脑，协调所有网络和请求，确保应用始终连接到最佳网络。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[<<github 加星 Taimili.com 艾米莉 >> 前端面试题-JavaScript高级篇]]></title>    <link>https://juejin.cn/post/7602901565026385929</link>    <guid>https://juejin.cn/post/7602901565026385929</guid>    <pubDate>2026-02-05T02:43:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602901565026385929" data-draft-id="7602893600251674670" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="&lt;&lt;github 加星 Taimili.com 艾米莉 &gt;&gt; 前端面试题-JavaScript高级篇"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-05T02:43:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开源之眼"/> <meta itemprop="url" content="https://juejin.cn/user/55438993800919"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            &lt;&lt;github 加星 Taimili.com 艾米莉 &gt;&gt; 前端面试题-JavaScript高级篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/55438993800919/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开源之眼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T02:43:01.000Z" title="Thu Feb 05 2026 02:43:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、 V8引擎工作原理与垃圾回收 (GC)</h2>
<p>理解JavaScript的执行环境是高级优化的前提。</p>
<h3 data-id="heading-1"><strong>V8引擎核心流程</strong></h3>
<h5 data-id="heading-2">Taimili 艾米莉 ( 一款专业的 GitHub star 管理和github 加星涨星工具<a href="https://link.juejin.cn?target=taimili.com" title="https://link.juejin.cn?target=taimili.com" target="_blank">taimili.com</a> )</h5>
<p>艾米莉 是一款优雅便捷的 GitHub star 管理和github 加星 涨星工具，基于 PHP &amp; javascript 构建， 能对github star fork follow watch 刷星管理和提升，最适合github 的深度用户</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24a5622ae9084d3ea6ce3cd9de43430f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5LmL55y8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770864180&amp;x-signature=IlxfsV%2FnvJoFY0nnLgL7cwon8Rk%3D" alt="WX20251021-210346@2x.png" loading="lazy"/></p>
<blockquote>
</blockquote>
<ol>
<li><strong>解析 (Parsing)</strong> : V8将JavaScript源代码解析成<strong>抽象语法树 (AST)</strong> 。</li>
<li><strong>解释 (Interpretation)</strong> : <strong>Ignition</strong> (V8的解释器) 将AST转换成字节码并执行。同时，Ignition会收集分析信息，用于后续的优化。</li>
<li><strong>编译 (Compilation)</strong> : 对于被频繁执行的代码（热点代码），<strong>TurboFan</strong> (V8的优化编译器) 会介入，利用分析信息将字节码编译成高度优化的机器码，以提升执行效率。这个过程被称为<strong>JIT (Just-In-Time) 编译</strong>。如果优化的假设失败（如函数参数类型改变），会进行<strong>去优化 (Deoptimization)</strong> ，回退到字节码执行。</li>
</ol>
<h3 data-id="heading-3"><strong>垃圾回收 (Garbage Collection)</strong></h3>
<p>V8采用<strong>分代回收 (Generational Collection)<strong>的策略，将堆内存分为</strong>新生代 (New Generation)<strong>和</strong>老生代 (Old Generation)</strong> 。</p>
<h4 data-id="heading-4"><strong>新生代 (Scavenger算法)</strong></h4>
<ul>
<li>空间小，存活对象少。采用<strong>Scavenger</strong>算法，将空间一分为二（From-Space 和 To-Space）。</li>
<li>回收时，将From-Space中的存活对象复制到To-Space，然后清空From-Space。最后，From-Space和To-Space角色互换。</li>
<li>对象若经历多轮回收仍存活，则被**晋升 (Promotion)**到老生代。</li>
</ul>
<h4 data-id="heading-5"><strong>老生代</strong></h4>
<ul>
<li>空间大，存活对象多。采用<strong>标记-清除</strong>算法。</li>
<li><strong>标记阶段</strong>: 从根对象（如全局对象）开始，遍历所有可达对象并打上标记。</li>
<li><strong>清除阶段</strong>: 清除非标记对象所占用的内存。</li>
<li><strong>整理阶段</strong> : 为解决内存碎片化问题，在清除后，会将所有存活对象向一端移动，形成连续的内存空间。</li>
</ul>
<h4 data-id="heading-6"><strong>代码示例 (导致内存泄漏的场景):</strong></h4>
<p>高级开发者需要能够识别并解释内存泄漏。闭包引用了已分离的DOM节点是典型案例。</p>
<pre><code class="hljs language-javascript" lang="javascript">js
 体验<span class="hljs-variable constant_">AI</span>代码助手
 代码解读
复制代码
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createLeakingElement</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'container'</span>);
  <span class="hljs-keyword">const</span> detachedElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  detachedElement.<span class="hljs-property">textContent</span> = <span class="hljs-string">'This is a potentially leaking element.'</span>;
  container.<span class="hljs-title function_">appendChild</span>(detachedElement);

  <span class="hljs-comment">// 关键：一个外部可访问的函数，通过闭包持有了对 detachedElement 的引用</span>
  <span class="hljs-keyword">const</span> leakingClosure = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 即使 detachedElement 从DOM树中移除，只要 leakingClosure 存在，</span>
    <span class="hljs-comment">// detachedElement 就不会被GC回收。</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(detachedElement.<span class="hljs-property">textContent</span>);
  };

  <span class="hljs-comment">// 从DOM中移除元素</span>
  container.<span class="hljs-title function_">removeChild</span>(detachedElement);

  <span class="hljs-comment">// 返回这个闭包</span>
  <span class="hljs-keyword">return</span> leakingClosure;
}

<span class="hljs-comment">// globalLeaker 现在持有了对 detachedElement 的间接引用</span>
<span class="hljs-comment">// 即使它在DOM中已不可见，它依然存在于内存中</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">globalLeaker</span> = <span class="hljs-title function_">createLeakingElement</span>();

<span class="hljs-comment">// 只要 window.globalLeaker 不被设为 null，这块内存就永远无法被回收</span>
</code></pre>
<h2 data-id="heading-7">二、 事件循环 (Event Loop)</h2>
<p>高级面试会深入到Node.js环境，考察对Event Loop各阶段的理解。</p>
<ul>
<li>
<p><strong>浏览器 vs. Node.js</strong>: 两者模型相似，但Node.js的事件循环有更明确的阶段划分。</p>
</li>
<li>
<p><strong>Node.js 事件循环的六个阶段</strong>:</p>
<ol>
<li><strong>timers</strong>: 执行 <code>setTimeout()</code> 和 <code>setInterval()</code> 的回调。</li>
<li><strong>pending callbacks</strong>: 执行上一轮循环中延迟到本轮执行的I/O回调。</li>
<li><strong>idle, prepare</strong>: 仅内部使用。</li>
<li><strong>poll</strong>: 核心阶段。检索新的I/O事件；执行与I/O相关的回调。如果队列不为空，会遍历执行；如果为空，会在此阻塞等待，直到有新的I/O事件或到达 <code>timers</code> 设定的阈值。</li>
<li><strong>check</strong>: 执行 <code>setImmediate()</code> 的回调。</li>
<li><strong>close callbacks</strong>: 执行如 <code>socket.on('close', ...)</code> 的回调。</li>
</ol>
</li>
<li>
<p><strong><code>process.nextTick()</code> 与微任务 (Micro-task)</strong> :</p>
<ul>
<li><code>process.nextTick()</code> 有自己独立的队列，其优先级<strong>高于</strong>所有微任务。</li>
<li>在一个阶段执行完毕后，事件循环会<strong>立即</strong>清空 <code>nextTick</code> 队列，然后才清空微任务队列，之后才进入下一个阶段。</li>
</ul>
</li>
</ul>
<p><strong>代码示例 (Node.js环境下):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">js
 体验<span class="hljs-variable constant_">AI</span>代码助手
 代码解读
复制代码
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. Script Start'</span>);

<span class="hljs-comment">// Timers 阶段</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'7. setTimeout'</span>);
}, <span class="hljs-number">0</span>);

<span class="hljs-comment">// Check 阶段</span>
<span class="hljs-title function_">setImmediate</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'8. setImmediate'</span>);
});

<span class="hljs-comment">// Micro-task</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'5. Promise.then'</span>);
});

<span class="hljs-comment">// process.nextTick 队列 (最高优先级)</span>
process.<span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. process.nextTick'</span>);
});

<span class="hljs-comment">// I/O 操作，其回调将在 Poll 阶段执行</span>
fs.<span class="hljs-title function_">readFile</span>(__filename, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'6. I/O (readFile) callback'</span>);

  <span class="hljs-comment">// I/O回调内部的调度</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'11. I/O -&gt; setTimeout'</span>), <span class="hljs-number">0</span>);
  <span class="hljs-title function_">setImmediate</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'9. I/O -&gt; setImmediate'</span>));
  process.<span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'10. I/O -&gt; nextTick'</span>));
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. Script End'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. Poll phase may start here...'</span>);

<span class="hljs-comment">// 理论输出顺序:</span>
<span class="hljs-comment">// 1. Script Start</span>
<span class="hljs-comment">// 2. Script End</span>
<span class="hljs-comment">// 3. Poll phase may start here...</span>
<span class="hljs-comment">// 4. process.nextTick</span>
<span class="hljs-comment">// 5. Promise.then</span>
<span class="hljs-comment">// 6. I/O (readFile) callback</span>
<span class="hljs-comment">// 10. I/O -&gt; nextTick</span>
<span class="hljs-comment">// 9. I/O -&gt; setImmediate</span>
<span class="hljs-comment">// 7. setTimeout</span>
<span class="hljs-comment">// 8. setImmediate</span>
<span class="hljs-comment">// 11. I/O -&gt; setTimeout</span>
<span class="hljs-comment">// (注意：9, 7, 8, 11 的确切顺序可能因I/O耗时和系统调度而有细微变化，但基本规律如此)</span>
</code></pre>
<h2 data-id="heading-8">三、 高级性能优化</h2>
<h3 data-id="heading-9"><strong>Tree Shaking (摇树优化)</strong></h3>
<h4 data-id="heading-10"><strong>原理</strong></h4>
<ul>
<li>依赖ES Modules (<code>import</code>/<code>export</code>) 的静态结构，在编译时分析代码，移除未被实际引用的“死代码”(dead-code)。</li>
</ul>
<h4 data-id="heading-11"><strong>实践</strong></h4>
<ul>
<li>Webpack, Rollup等现代打包工具在生产模式下默认开启。开发者需保证代码遵循ESM规范，并避免有副作用的模块导入。</li>
</ul>
<h3 data-id="heading-12"><strong>Code Splitting (代码分割)</strong></h3>
<h4 data-id="heading-13"><strong>目的</strong></h4>
<ul>
<li>将巨大的单体bundle分割成多个小块(chunks)，按需加载，以减小首屏加载体积，提升用户体验。</li>
</ul>
<h4 data-id="heading-14"><strong>策略</strong></h4>
<ol>
<li><strong>按路由分割</strong>: 每个页面或路由对应一个chunk。</li>
<li><strong>按组件分割</strong>: 对于非首屏、或需要交互才出现的大型组件（如弹窗、图表）进行懒加载。</li>
<li><strong>公共库分离 (Vendor Splitting)</strong> : 将不常变动的第三方库（如React, Lodash）打包成独立的vendor chunk，利用浏览器缓存。</li>
</ol>
<h3 data-id="heading-15"><strong>利用浏览器渲染路径</strong></h3>
<ul>
<li><strong>关键渲染路径</strong> : 优化CSS加载（内联关键CSS）、减少阻塞渲染的脚本、使用 <code>async</code>/<code>defer</code>。</li>
<li><strong>硬件加速</strong>: 尽量使用 <code>transform</code> 和 <code>opacity</code> 属性进行动画，它们能被提升到单独的合成层(Compositor Layer)，由GPU处理，避免触发重排(Reflow)和重绘(Repaint)。</li>
</ul>
<h3 data-id="heading-16"><strong>代码示例 (React中的代码分割)</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript">jsx
 体验<span class="hljs-variable constant_">AI</span>代码助手
 代码解读
复制代码
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">Suspense</span>, lazy } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 使用 React.lazy 和动态 import() 来实现组件的懒加载</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HeavyComponent</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./components/HeavyComponent'</span>));
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AnotherLazyComponent</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./components/AnotherLazyComponent'</span>));

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [showHeavy, setShowHeavy] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>My App<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setShowHeavy(true)}&gt;Load Heavy Component<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 
        Suspense 组件用于在懒加载组件下载和解析期间，显示一个fallback UI。
        只有当 showHeavy 为 true 时，浏览器才会去请求 HeavyComponent.js。
      */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        {showHeavy &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">HeavyComponent</span> /&gt;</span>}
        
        {/* 假设这是另一个需要懒加载的组件 */}
        {/* <span class="hljs-tag">&lt;<span class="hljs-name">AnotherLazyComponent</span> /&gt;</span> */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-17">四、 内存管理与诊断</h2>
<h3 data-id="heading-18"><strong>内存泄漏的常见原因</strong></h3>
<ol>
<li><strong>意外的全局变量</strong>: 未经声明的变量被赋值，成为全局对象的属性。</li>
<li><strong>遗忘的定时器或回调</strong>: <code>setInterval</code> 未被清除，其回调函数及其闭包环境无法被回收。</li>
<li><strong>分离的DOM节点引用</strong>: 如第一节的代码示例。</li>
<li><strong>闭包的滥用</strong>: 闭包会使其外部函数的作用域持续存在，如果作用域中包含大量数据，则可能造成内存占用过高。</li>
</ol>
<h3 data-id="heading-19"><strong>诊断工具 (Chrome DevTools)</strong></h3>
<ul>
<li>
<p><strong>Performance Monitor</strong>: 实时监控CPU使用率、JS堆大小、DOM节点数等。</p>
</li>
<li>
<p><strong>Memory Tab</strong>:</p>
<ul>
<li><strong>Heap Snapshot (堆快照)</strong> : 拍摄堆内存的快照，用于分析对象分布、查找分离的DOM树、定位内存泄漏。</li>
<li><strong>Allocation Instrumentation on Timeline</strong>: 记录内存分配的时间线，用于定位是哪个函数或操作导致了频繁的内存分配或内存激增。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-20"><strong>代码示例 (遗忘的定时器):</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin">js
 体验AI代码助手
 代码解读
复制代码
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PulsingDot</span> {
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.size = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.isGrowing = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// 定时器通过闭包持有了对 this (PulsingDot实例) 的引用</span>
    <span class="hljs-keyword">this</span>.intervalId = setInterval(() =&gt; {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isGrowing) {
        <span class="hljs-keyword">this</span>.size += <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.size &gt;= <span class="hljs-number">10</span>) <span class="hljs-keyword">this</span>.isGrowing = <span class="hljs-literal">false</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.size -= <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.size &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">this</span>.isGrowing = <span class="hljs-literal">true</span>;
      }
    }, <span class="hljs-number">100</span>);
  }

  <span class="hljs-comment">// 必须提供一个销毁方法来清除定时器</span>
  destroy() {
    clearInterval(<span class="hljs-keyword">this</span>.intervalId);
    console.log(<span class="hljs-string">'PulsingDot destroyed and interval cleared.'</span>);
  }
}

let dot = new PulsingDot();

<span class="hljs-comment">// 假设在某个时间点，我们不再需要这个 dot 实例</span>
dot = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// 问题：虽然 dot 变量被设为 null，但 PulsingDot 实例无法被回收，</span>
<span class="hljs-comment">// 因为 setInterval 的回调函数仍然持有对它的引用，定时器还在不停地运行。</span>
<span class="hljs-comment">// 正确做法：在销毁对象前，调用 dot.destroy()。</span>
</code></pre>
<h2 data-id="heading-21">五、 软件设计模式</h2>
<p>高级开发者应能将设计模式思想融入日常编码，以构建可维护、可扩展的系统。</p>
<ul>
<li><strong>单例模式 (Singleton)</strong> : 确保一个类只有一个实例，并提供一个全局访问点。</li>
<li><strong>观察者模式 (Observer / Pub/Sub)</strong> : 定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都将得到通知并自动更新。</li>
<li><strong>工厂模式 (Factory)</strong> : 定义一个用于创建对象的接口，让子类决定实例化哪一个类。</li>
<li><strong>装饰器模式 (Decorator)</strong> : 动态地给一个对象添加一些额外的职责。</li>
<li><strong>代理模式 (Proxy)</strong> : 为其他对象提供一种代理以控制对这个对象的访问。</li>
</ul>
<p><strong>代码示例 (观察者模式/发布-订阅):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">js
 体验<span class="hljs-variable constant_">AI</span>代码助手
 代码解读
复制代码
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EventBus</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span> = {};
  }

  <span class="hljs-comment">// 订阅</span>
  <span class="hljs-title function_">on</span>(<span class="hljs-params">eventName, callback</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName]) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName] = [];
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName].<span class="hljs-title function_">push</span>(callback);
  }

  <span class="hljs-comment">// 取消订阅</span>
  <span class="hljs-title function_">off</span>(<span class="hljs-params">eventName, callback</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName]) <span class="hljs-keyword">return</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName].<span class="hljs-title function_">filter</span>(
      <span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> listener !== callback
    );
  }

  <span class="hljs-comment">// 发布</span>
  <span class="hljs-title function_">emit</span>(<span class="hljs-params">eventName, ...args</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName]) <span class="hljs-keyword">return</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-title function_">listener</span>(...args);
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error in listener for event "<span class="hljs-subst">${eventName}</span>":`</span>, e);
      }
    });
  }
}

<span class="hljs-comment">// --- 使用场景 ---</span>
<span class="hljs-keyword">const</span> bus = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventBus</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">onUserLogin</span>(<span class="hljs-params">userData</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Analytics Service: User logged in'</span>, userData.<span class="hljs-property">name</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateNavbar</span>(<span class="hljs-params">userData</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'UI Service: Updating navbar for'</span>, userData.<span class="hljs-property">name</span>);
}

bus.<span class="hljs-title function_">on</span>(<span class="hljs-string">'user:login'</span>, onUserLogin);
bus.<span class="hljs-title function_">on</span>(<span class="hljs-string">'user:login'</span>, updateNavbar);

<span class="hljs-comment">// 某处登录成功后...</span>
bus.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'user:login'</span>, { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Mickey'</span> });

<span class="hljs-comment">// 用户退出时，可以取消订阅</span>
<span class="hljs-comment">// bus.off('user:login', onUserLogin);</span>
</code></pre>
<h2 data-id="heading-22"/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[部署openclaw与ai的对话过程]]></title>    <link>https://juejin.cn/post/7602834985902014514</link>    <guid>https://juejin.cn/post/7602834985902014514</guid>    <pubDate>2026-02-04T17:27:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602834985902014514" data-draft-id="7602811649126744115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="部署openclaw与ai的对话过程"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-02-04T17:27:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="隔壁晓晓"/> <meta itemprop="url" content="https://juejin.cn/user/4499656909521368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            部署openclaw与ai的对话过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4499656909521368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    隔壁晓晓
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T17:27:34.000Z" title="Wed Feb 04 2026 17:27:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读45分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">✅ 推荐方案：使用 <code>@william.qian/simple-wecom</code></h3>
<p>这是目前文档最完善、使用最广泛的方案</p>
<h4 data-id="heading-1">安装步骤</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装插件（注意是这个名称）</span>
clawdbot plugins install @william.qian/simple-wecom

<span class="hljs-comment"># 2. 启用插件</span>
clawdbot plugins <span class="hljs-built_in">enable</span> simple-wecom

<span class="hljs-comment"># 3. 配置企业微信（需要替换为你的真实参数）</span>
clawdbot config <span class="hljs-built_in">set</span> channels.simple-wecom.corpid <span class="hljs-string">"ww1234567890abcdef"</span>
clawdbot config <span class="hljs-built_in">set</span> channels.simple-wecom.corpsecret <span class="hljs-string">"your-corp-secret"</span>
clawdbot config <span class="hljs-built_in">set</span> channels.simple-wecom.token <span class="hljs-string">"your-token"</span>
clawdbot config <span class="hljs-built_in">set</span> channels.simple-wecom.encodingAESKey <span class="hljs-string">"your-aes-key"</span>
clawdbot config <span class="hljs-built_in">set</span> channels.simple-wecom.enabled <span class="hljs-literal">true</span>

<span class="hljs-comment"># 4. 配置网关</span>
clawdbot config <span class="hljs-built_in">set</span> gateway.mode <span class="hljs-string">"local"</span>
clawdbot config <span class="hljs-built_in">set</span> gateway.bind <span class="hljs-string">"0.0.0.0"</span>
clawdbot config <span class="hljs-built_in">set</span> gateway.port 18789

<span class="hljs-comment"># 5. 重启网关</span>
clawdbot gateway restart

<span class="hljs-comment"># 6. 验证状态</span>
clawdbot channels status
</code></pre>
<hr/>
<h3 data-id="heading-2">🔍 如果上面的装不了，试试这些替代方案</h3>
<h4 data-id="heading-3">方案二：GitHub 开源插件（功能最全）[8]</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从 GitHub 克隆安装</span>
git <span class="hljs-built_in">clone</span> https://github.com/dingxiang-me/OpenClaw-Wechat.git
<span class="hljs-built_in">cd</span> OpenClaw-Wechat

<span class="hljs-comment"># 本地路径安装</span>
clawdbot plugins install -l ./
</code></pre>
<h4 data-id="heading-4">方案三：OpenClaw 官方 wecom 插件 [1]</h4>
<p>如果你用的是 <strong>OpenClaw</strong>（Clawdbot 的新名字），可能已经预装了：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查是否已安装</span>
clawdbot plugins list | grep wecom

<span class="hljs-comment"># 如果看到 wecom，直接启用</span>
clawdbot plugins <span class="hljs-built_in">enable</span> wecom
</code></pre>
<hr/>
<h3 data-id="heading-5">❓ 先确认几个问题</h3>
<p><strong>1. 你运行的是哪个版本？</strong></p>
<pre><code class="hljs language-bash" lang="bash">clawdbot --version
<span class="hljs-comment"># 或</span>
openclaw --version
</code></pre>
<p><strong>2. 查看当前已安装插件</strong></p>
<pre><code class="hljs language-bash" lang="bash">clawdbot plugins list
</code></pre>
<p><strong>3. 你之前看到的 <code>@mijia-life/clawdbot-wecom</code> 是从哪里获取的？</strong></p>
<ul>
<li>是某篇教程？</li>
<li>还是 <code>clawdbot plugins search wecom</code> 搜出来的？</li>
</ul>
<hr/>
<h3 data-id="heading-6">🎯 快速诊断</h3>
<p>运行这个命令看看有没有企业微信相关插件：</p>
<pre><code class="hljs language-bash" lang="bash">clawdbot plugins search wecom
</code></pre>
<p>如果有输出，告诉我插件名；如果没输出，就用上面的 <strong>@william.qian/simple-wecom</strong> 方案。</p>
<hr/>
<p><strong>你想先试哪个方案？</strong> 或者告诉我你的 <code>clawdbot plugins list</code> 输出，我帮你判断最佳安装方式！
User: 我用的是openclaw，2 hollis@lijinghaodeMac-mini ~ % openclaw plugins install @william.qian/simple-wecom</p>
<p>🦞 OpenClaw 2026.2.1 (ed4529e) — I can run local, remote, or purely on vibes—results may vary with DNS.</p>
<p>Downloading @william.qian/simple-wecom…
Extracting /var/folders/xd/4z9xg52d2ms0sr1gm0gd8lbh0000gn/T/openclaw-npm-pack-7BZ0U8/william.qian-simple-wecom-1.0.2.tgz…
Error: package.json missing openclaw.extensions
hollis@lijinghaodeMac-mini ~ % openclaw plugins</p>
<p>🦞 OpenClaw 2026.2.1 (ed4529e) — Siri's competent cousin.
Kimi: 明白了！错误信息显示 <code>package.json missing openclaw.extensions</code>，说明 <strong>@william.qian/simple-wecom</strong> 这个插件是为旧版 Clawdbot 设计的，<strong>不兼容新版 OpenClaw 2026.2.1</strong>。</p>
<p>新版 OpenClaw 的插件系统变了，需要 <code>openclaw.extensions</code> 字段。</p>
<hr/>
<h3 data-id="heading-7">🔍 搜索兼容 OpenClaw 2026.2 的企业微信插件</h3>
<p>太好了！找到了完美适配 <strong>OpenClaw 2026.2.1</strong> 的企业微信插件！</p>
<hr/>
<h3 data-id="heading-8">✅ 推荐方案：<code>openclaw-plugin-wecom</code></h3>
<p>GitHub 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsunnoy%2Fopenclaw-plugin-wecom" target="_blank" title="https://github.com/sunnoy/openclaw-plugin-wecom" ref="nofollow noopener noreferrer">github.com/sunnoy/open…</a></p>
<p>这是专门为 <strong>新版 OpenClaw</strong> 开发的插件，支持 2026 版本，有你需要的 <code>openclaw.extensions</code> 字段。</p>
<hr/>
<h3 data-id="heading-9">🚀 安装步骤</h3>
<h4 data-id="heading-10">方法一：直接安装（推荐）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装插件（新版 OpenClaw 专用）</span>
openclaw plugins install openclaw-plugin-wecom
</code></pre>
<h4 data-id="heading-11">方法二：如果上面找不到，用 GitHub 安装</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 先克隆到本地</span>
git <span class="hljs-built_in">clone</span> https://github.com/sunnoy/openclaw-plugin-wecom.git
<span class="hljs-built_in">cd</span> openclaw-plugin-wecom

<span class="hljs-comment"># 2. 本地路径安装</span>
openclaw plugins install -l ./
</code></pre>
<hr/>
<h3 data-id="heading-12">⚙️ 配置企业微信</h3>
<p>安装成功后，配置有两种方式：</p>
<h4 data-id="heading-13">方式 A：智能机器人（简单，被动回复）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基础配置</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom.enabled <span class="hljs-literal">true</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom.webhookPath /wecom
openclaw config <span class="hljs-built_in">set</span> channels.wecom.token <span class="hljs-string">"你的Token"</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom.encodingAESKey <span class="hljs-string">"你的43位EncodingAESKey"</span>

<span class="hljs-comment"># 重启网关</span>
openclaw gateway restart
</code></pre>
<h4 data-id="heading-14">方式 B：自建应用（功能全，支持主动发消息）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 完整配置</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom-app.enabled <span class="hljs-literal">true</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom-app.webhookPath /wecom-app
openclaw config <span class="hljs-built_in">set</span> channels.wecom-app.token <span class="hljs-string">"你的Token"</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom-app.encodingAESKey <span class="hljs-string">"你的43位EncodingAESKey"</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom-app.corpId <span class="hljs-string">"你的企业ID"</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom-app.corpSecret <span class="hljs-string">"你的应用Secret"</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom-app.agentId <span class="hljs-string">"你的应用ID"</span>

<span class="hljs-comment"># 重启</span>
openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-15">🔍 先验证安装</h3>
<p>运行这个命令，看是否能找到插件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 搜索插件</span>
openclaw plugins search wecom

<span class="hljs-comment"># 或查看已安装列表</span>
openclaw plugins list
</code></pre>
<hr/>
<h3 data-id="heading-16">❓ 请尝试</h3>
<p><strong>第一步：</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw plugins install openclaw-plugin-wecom
</code></pre>
<p><strong>结果会是：</strong></p>
<ul>
<li>✅ 成功安装 → 继续配置</li>
<li>❌ 找不到包 → 用 GitHub 克隆方式</li>
</ul>
<p><strong>告诉我安装结果，我再给你下一步的具体配置命令！</strong></p>
<hr/>
<h3 data-id="heading-17">💡 企业微信后台需要准备的参数</h3>



































<table><thead><tr><th>参数</th><th>从哪里获取</th><th>长度/格式</th></tr></thead><tbody><tr><td><code>token</code></td><td>企业微信后台 → 随机获取</td><td>任意字符串</td></tr><tr><td><code>encodingAESKey</code></td><td>企业微信后台 → 随机获取</td><td><strong>43位字符</strong></td></tr><tr><td><code>corpId</code></td><td>企业微信后台 → 我的企业 → 企业ID</td><td>类似 <code>ww123456...</code></td></tr><tr><td><code>corpSecret</code></td><td>应用详情页 → 查看 Secret</td><td>长字符串</td></tr><tr><td><code>agentId</code></td><td>应用详情页 → AgentId</td><td>数字，如 <code>1000002</code></td></tr></tbody></table>
<p><strong>你现在有企业微信后台的管理员权限吗？</strong> 有的话可以先去创建机器人和应用，拿到这些参数！
User: 我已经成功安装这个了，hollis@lijinghaodeMac-mini ~ % openclaw plugins install openclaw-plugin-wecom</p>
<p>🦞 OpenClaw 2026.2.1 (ed4529e) — Because texting yourself reminders is so 2024.</p>
<p>Downloading openclaw-plugin-wecom…
Extracting /var/folders/xd/4z9xg52d2ms0sr1gm0gd8lbh0000gn/T/openclaw-npm-pack-vKfVkG/openclaw-plugin-wecom-1.0.0.tgz…
Installing to /Users/hollis/.openclaw/extensions/openclaw-plugin-wecom…
Installing plugin dependencies…
2026-02-04T09:46:20.446Z INFO [wecom] WeCom plugin registering...
2026-02-04T09:46:20.446Z INFO [wecom] WeCom channel registered
2026-02-04T09:46:20.446Z INFO [wecom] WeCom HTTP handler registered
Installed plugin: openclaw-plugin-wecom
Restart the gateway to load plugins. 但是在企业微信后台机器人创建这里，url不知道填什么，我们用的是mac
Kimi: 太好了！安装成功！🎉</p>
<p>现在的问题是 <strong>URL 填什么</strong>。因为你用的是 <strong>Mac</strong>，需要让企业微信服务器能访问到你本地的 OpenClaw。</p>
<hr/>
<h3 data-id="heading-18">🔍 核心问题：企业微信需要访问你的 Mac</h3>
<p>企业微信服务器在互联网上，它需要发送消息到你的 OpenClaw。但你的 Mac 在本地网络（内网），需要解决 <strong>内网穿透</strong> 问题。</p>
<hr/>
<h3 data-id="heading-19">解决方案对比</h3>





























<table><thead><tr><th>方案</th><th>难度</th><th>适用场景</th><th>稳定性</th></tr></thead><tbody><tr><td><strong>A. 内网穿透（推荐）</strong></td><td>⭐⭐ 中等</td><td>开发测试</td><td>依赖第三方</td></tr><tr><td><strong>B. 部署到云服务器</strong></td><td>⭐⭐⭐ 复杂</td><td>生产环境</td><td>高</td></tr><tr><td><strong>C. 本地调试模式</strong></td><td>⭐ 简单</td><td>快速验证</td><td>一次性</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-20">方案 A：内网穿透（推荐用于测试）</h3>
<p>使用 <strong>ngrok</strong> 或 <strong>Cloudflare Tunnel</strong> 把本地端口暴露到公网。</p>
<h4 data-id="heading-21">步骤 1：安装 ngrok</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 用 Homebrew 安装</span>
brew install ngrok

<span class="hljs-comment"># 或者去官网下载 https://ngrok.com/download</span>
</code></pre>
<h4 data-id="heading-22">步骤 2：注册 ngrok 账号并配置</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 注册后获取 authtoken，然后配置</span>
ngrok config add-authtoken 你的_token
</code></pre>
<h4 data-id="heading-23">步骤 3：启动内网穿透</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 假设 OpenClaw 网关运行在 18789 端口（默认）</span>
<span class="hljs-comment"># 先确认 OpenClaw 网关端口</span>
openclaw config get gateway.port
<span class="hljs-comment"># 通常是 18789</span>

<span class="hljs-comment"># 启动 ngrok 转发</span>
ngrok http 18789
</code></pre>
<h4 data-id="heading-24">步骤 4：获取公网 URL</h4>
<p>运行后会看到类似：</p>
<pre><code class="hljs language-bash" lang="bash">Forwarding  https://abc123.ngrok-free.app -&gt; http://localhost:18789
</code></pre>
<p><strong>这个 <code>https://abc123.ngrok-free.app</code> 就是你的公网地址！</strong></p>
<hr/>
<h3 data-id="heading-25">步骤 5：配置 OpenClaw 企业微信通道</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置基础配置</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom.enabled <span class="hljs-literal">true</span>

<span class="hljs-comment"># webhook 路径（企业微信会访问这个路径）</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom.webhookPath /wecom

<span class="hljs-comment"># 企业微信后台生成的 Token</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom.token <span class="hljs-string">"你在企业微信后台设置的Token"</span>

<span class="hljs-comment"># 企业微信后台生成的 EncodingAESKey（43位）</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom.encodingAESKey <span class="hljs-string">"你的43位EncodingAESKey"</span>

<span class="hljs-comment"># 重启网关加载插件</span>
openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-26">步骤 6：企业微信后台填写</h3>





















<table><thead><tr><th>字段</th><th>填写内容</th></tr></thead><tbody><tr><td><strong>URL</strong></td><td><code>https://abc123.ngrok-free.app/wecom</code></td></tr><tr><td><strong>Token</strong></td><td>你设置的 Token（任意字符串）</td></tr><tr><td><strong>EncodingAESKey</strong></td><td>点击"随机生成"的 43 位字符串</td></tr></tbody></table>
<p><strong>注意：</strong></p>
<ul>
<li>确保勾选 <strong>"已开启"</strong></li>
<li>选择 <strong>"明文模式"</strong> 或 <strong>"兼容模式"</strong>（如果用兼容模式需要填 EncodingAESKey）</li>
</ul>
<hr/>
<h3 data-id="heading-27">方案 B：快速验证（不穿透，仅本地测试）</h3>
<p>如果你只是想验证插件是否工作，可以先用 <strong>curl</strong> 本地测试：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试 OpenClaw 是否运行</span>
curl http://localhost:18789/wecom \
  -X POST \
  -H <span class="hljs-string">"Content-Type: text/xml"</span> \
  -d <span class="hljs-string">'&lt;xml&gt;&lt;ToUserName&gt;test&lt;/ToUserName&gt;&lt;FromUserName&gt;user&lt;/FromUserName&gt;&lt;CreateTime&gt;123456&lt;/CreateTime&gt;&lt;MsgType&gt;text&lt;/MsgType&gt;&lt;Content&gt;你好&lt;/Content&gt;&lt;/xml&gt;'</span>
</code></pre>
<hr/>
<h3 data-id="heading-28">你现在需要做的</h3>
<p><strong>1. 确认 OpenClaw 网关端口</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw config get gateway.port
</code></pre>
<p><strong>2. 安装 ngrok</strong></p>
<pre><code class="hljs language-bash" lang="bash">brew install ngrok
</code></pre>
<p><strong>3. 注册 ngrok 账号</strong> → <a href="https://link.juejin.cn?target=https%3A%2F%2Fdashboard.ngrok.com%2Fsignup" target="_blank" title="https://dashboard.ngrok.com/signup" ref="nofollow noopener noreferrer">dashboard.ngrok.com/signup</a></p>
<p><strong>4. 配置并启动</strong></p>
<p>告诉我：</p>
<ul>
<li>你的 <code>gateway.port</code> 是多少？</li>
<li>有没有 ngrok 账号？</li>
</ul>
<p>我帮你写完整的启动命令！ 🚀
User: 我安装ngrok好了，怎么注册，步骤二怎么做
Kimi: 好的！一步步来 👇</p>
<hr/>
<h3 data-id="heading-29">步骤 1：注册 ngrok 账号</h3>
<p><strong>打开浏览器访问：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">https:<span class="hljs-comment">//dashboard.ngrok.com/signup</span>
</code></pre>
<p><strong>注册方式（三选一）：</strong></p>
<ul>
<li>GitHub 账号登录（最快）</li>
<li>Google 账号登录</li>
<li>邮箱注册</li>
</ul>
<hr/>
<h3 data-id="heading-30">步骤 2：获取 Authtoken</h3>
<p>注册登录后：</p>
<ol>
<li><strong>进入 Dashboard</strong> → <a href="https://link.juejin.cn?target=https%3A%2F%2Fdashboard.ngrok.com" target="_blank" title="https://dashboard.ngrok.com" ref="nofollow noopener noreferrer">dashboard.ngrok.com</a></li>
<li>左侧菜单点击 <strong>"Your Authtoken"</strong></li>
<li>点击 <strong>"Copy"</strong> 按钮复制</li>
</ol>
<p><strong>Authtoken 长这样：</strong></p>
<pre><code class="hljs">2KxZ...很长一串字符...xyz
</code></pre>
<hr/>
<h3 data-id="heading-31">步骤 3：配置 ngrok（在终端执行）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 粘贴你复制的 token</span>
ngrok config add-authtoken 2KxZ你的token这里
</code></pre>
<p><strong>成功后会显示：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Authtoken</span> saved to configuration <span class="hljs-attr">file</span>: <span class="hljs-regexp">/Users/</span>hollis/.<span class="hljs-property">config</span>/ngrok/ngrok.<span class="hljs-property">yml</span>
</code></pre>
<hr/>
<h3 data-id="heading-32">步骤 4：确认 OpenClaw 端口</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看当前网关端口</span>
openclaw config get gateway.port
</code></pre>
<p><strong>如果显示空或 0，设置为默认端口：</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> gateway.port 18789
</code></pre>
<hr/>
<h3 data-id="heading-33">步骤 5：启动内网穿透</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动 ngrok，把本地 18789 端口暴露到公网</span>
ngrok http 18789
</code></pre>
<p><strong>成功后会看到：</strong></p>
<pre><code class="hljs language-java" lang="java">Session Status                online
Account                       <span class="hljs-title function_">hollis</span> <span class="hljs-params">(Plan: Free)</span>  
Version                       <span class="hljs-number">3.</span>x.x
Region                        Asia <span class="hljs-title function_">Pacific</span> <span class="hljs-params">(ap)</span>
Web Interface                 http:<span class="hljs-comment">//127.0.0.1:4040</span>
Forwarding                    https:<span class="hljs-comment">//abc123-def456.ngrok-free.app -&gt; http://localhost:18789</span>
</code></pre>
<p><strong>关键信息：</strong></p>
<ul>
<li><code>https://abc123-def456.ngrok-free.app</code> ← <strong>这是你的公网 URL</strong></li>
</ul>
<hr/>
<h3 data-id="heading-34">步骤 6：配置企业微信后台</h3>





















<table><thead><tr><th>字段</th><th>填写内容</th></tr></thead><tbody><tr><td><strong>URL</strong></td><td><code>https://abc123-def456.ngrok-free.app/wecom</code></td></tr><tr><td><strong>Token</strong></td><td>任意设置，如 <code>OpenClaw2024</code></td></tr><tr><td><strong>EncodingAESKey</strong></td><td>点击"随机生成"</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-35">步骤 7：配置 OpenClaw</h3>
<p><strong>保持 ngrok 运行</strong>，新开一个终端窗口：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置企业微信配置</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom.enabled <span class="hljs-literal">true</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom.webhookPath /wecom
openclaw config <span class="hljs-built_in">set</span> channels.wecom.token <span class="hljs-string">"OpenClaw2024"</span>  <span class="hljs-comment"># 和上面设置的Token一致</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom.encodingAESKey <span class="hljs-string">"企业微信生成的43位Key"</span>

<span class="hljs-comment"># 重启网关</span>
openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-36">你现在做到哪一步了？</h3>





























<table><thead><tr><th>步骤</th><th>状态</th></tr></thead><tbody><tr><td>注册 ngrok 账号</td><td>⬜ 待完成</td></tr><tr><td>复制 Authtoken</td><td>⬜ 待完成</td></tr><tr><td>配置 ngrok</td><td>⬜ 待完成</td></tr><tr><td>启动 ngrok</td><td>⬜ 待完成</td></tr><tr><td>配置企业微信</td><td>⬜ 待完成</td></tr></tbody></table>
<p><strong>先去 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdashboard.ngrok.com%2Fsignup" target="_blank" title="https://dashboard.ngrok.com/signup" ref="nofollow noopener noreferrer">dashboard.ngrok.com/signup</a> 注册，拿到 Authtoken 后告诉我，我继续带你下一步！</strong> 🚀
User: 他内网穿透是什么原理，如果我mac重启了呢还有效吗
Kimi: 好问题！我来用简单的方式解释清楚 👇</p>
<hr/>
<h3 data-id="heading-37">🔍 内网穿透是什么原理？</h3>
<h4 data-id="heading-38">一句话解释</h4>
<blockquote>
<p><strong>ngrok 就像一个"快递中转站"</strong>，让企业微信服务器能把消息"寄"到你家里的 Mac 上。</p>
</blockquote>
<h4 data-id="heading-39">图解</h4>
<pre><code class="hljs language-markdown" lang="markdown">企业微信用户
<span class="hljs-code">    ↓ 发消息
企业微信服务器（互联网上）
    ↓ 发送到 ngrok 提供的公网地址
ngrok 云服务器（中转站）
    ↓ 转发到你电脑
你的 Mac（localhost:18789）
    ↓ OpenClaw 处理
回复消息原路返回
</span></code></pre>
<h4 data-id="heading-40">技术原理</h4>





















<table><thead><tr><th>概念</th><th>解释</th></tr></thead><tbody><tr><td><strong>隧道（Tunnel）</strong></td><td>ngrok 在你电脑和云端之间建立加密通道</td></tr><tr><td><strong>反向代理</strong></td><td>公网请求 → ngrok 云端 → 你的本地端口</td></tr><tr><td><strong>随机子域名</strong></td><td>每次启动分配 <code>abc123.ngrok-free.app</code> 这样的临时地址</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-41">❓ Mac 重启后还有效吗？</h3>
<p><strong>答案是：失效！需要重新启动</strong></p>

























<table><thead><tr><th>情况</th><th>结果</th></tr></thead><tbody><tr><td><strong>关闭 ngrok 终端</strong></td><td>❌ 隧道断开，URL 失效</td></tr><tr><td><strong>Mac 重启</strong></td><td>❌ 完全失效，ngrok 没运行</td></tr><tr><td><strong>网络切换（WiFi断/换）</strong></td><td>❌ 隧道断开</td></tr><tr><td><strong>重新启动 ngrok</strong></td><td>⚠️<strong>URL 会变</strong>（免费版）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-42">🔄 免费版 vs 付费版对比</h3>






























<table><thead><tr><th>功能</th><th>免费版</th><th>付费版（$5/月起）</th></tr></thead><tbody><tr><td>随机 URL</td><td>✅ 每次变</td><td>✅ 固定子域名</td></tr><tr><td>连接时长</td><td>有限制</td><td>无限制</td></tr><tr><td>自定义域名</td><td>❌</td><td>✅</td></tr><tr><td>重启后 URL 变化</td><td>✅ 会变</td><td>❌ 固定不变</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-43">💡 对你来说的实际情况</h3>
<h4 data-id="heading-44">开发测试阶段（现在）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 每次 Mac 开机后，需要手动启动</span>
ngrok http 18789

<span class="hljs-comment"># 然后复制新的 URL 到企业微信后台</span>
<span class="hljs-comment"># 有点麻烦，但免费</span>
</code></pre>
<h4 data-id="heading-45">长期解决方案（推荐）</h4>
<p><strong>方案 A：固定子域名（付费 ngrok）</strong></p>
<ul>
<li>每月 $5-8</li>
<li>获得固定 URL：<code>https://hollis-openclaw.ngrok.io</code></li>
<li>Mac 重启后 URL 不变，只需重新启动 ngrok</li>
</ul>
<p><strong>方案 B：部署到云服务器（生产环境）</strong></p>
<ul>
<li>阿里云/腾讯云轻量服务器（约 50-100元/月）</li>
<li>OpenClaw 24小时运行</li>
<li>固定 IP，企业微信配置一次永久有效</li>
</ul>
<p><strong>方案 C：本地开发专用（现在先用着）</strong></p>
<ul>
<li>每次开发测试时启动 ngrok</li>
<li>企业微信后台更新 URL</li>
<li>适合学习阶段</li>
</ul>
<hr/>
<h3 data-id="heading-46">🎯 你现在该做什么？</h3>
<h4 data-id="heading-47">现在（免费方案）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 启动 ngrok（每次开机后执行）</span>
ngrok http 18789

<span class="hljs-comment"># 2. 复制显示的 https://xxx.ngrok-free.app</span>

<span class="hljs-comment"># 3. 去企业微信后台更新 URL</span>

<span class="hljs-comment"># 4. 测试机器人</span>
</code></pre>
<h4 data-id="heading-48">如果嫌每次改 URL 麻烦</h4>
<p>可以考虑：</p>
<ol>
<li><strong>付费 ngrok</strong>（$5/月）→ 固定子域名</li>
<li><strong>购买云服务器</strong>（50元/月）→ 永久在线</li>
</ol>
<hr/>
<h3 data-id="heading-49">❓ 你想怎么选？</h3>





















<table><thead><tr><th>你的情况</th><th>建议方案</th></tr></thead><tbody><tr><td>只是学习/测试</td><td>免费 ngrok，每次手动启动</td></tr><tr><td>长期自用</td><td>付费 ngrok 固定域名</td></tr><tr><td>团队使用/稳定服务</td><td>云服务器部署</td></tr></tbody></table>
<p><strong>告诉我你的需求，我帮你选最佳方案！</strong> 🚀
User: openclaw config set channels.wecom-app.corpId "你的企业ID" 企业id那里获取
Kimi: 好的！企业 ID 获取步骤如下 👇</p>
<hr/>
<h3 data-id="heading-50">获取企业 ID（CorpID）</h3>
<h4 data-id="heading-51">步骤 1：登录企业微信管理后台</h4>
<p><strong>网址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwork.weixin.qq.com%2Fwework_admin" target="_blank" title="https://work.weixin.qq.com/wework_admin" ref="nofollow noopener noreferrer">work.weixin.qq.com/wework_admi…</a></p>
<p>用<strong>管理员账号</strong>扫码登录</p>
<hr/>
<h4 data-id="heading-52">步骤 2：找到企业 ID</h4>
<p>登录后：</p>
<ol>
<li>顶部菜单点击 <strong>"我的企业"</strong></li>
<li>页面拉到最下方</li>
<li>看到 <strong>"企业ID"</strong> 一栏</li>
</ol>
<pre><code class="hljs language-css" lang="css">企业ID
ww1234567890abcdef
<span class="hljs-selector-attr">[查看]</span>
</code></pre>
<p>点击 <strong>"查看"</strong> 按钮，复制这串字符</p>
<hr/>
<h4 data-id="heading-53">步骤 3：填入 OpenClaw</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> channels.wecom-app.corpId <span class="hljs-string">"ww1234567890abcdef"</span>
</code></pre>
<hr/>
<h3 data-id="heading-54">完整配置命令（等下一起执行）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 企业ID（刚才获取的）</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom-app.corpId <span class="hljs-string">"ww你的企业ID"</span>

<span class="hljs-comment"># 应用凭证（下一步获取）</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom-app.corpSecret <span class="hljs-string">"应用的Secret"</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom-app.agentId <span class="hljs-string">"1000002"</span>

<span class="hljs-comment"># 机器人配置（企业微信后台生成的）</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom-app.token <span class="hljs-string">"你的Token"</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom-app.encodingAESKey <span class="hljs-string">"你的43位EncodingAESKey"</span>

<span class="hljs-comment"># 启用并重启</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom-app.enabled <span class="hljs-literal">true</span>
openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-55">⚠️ 注意：CorpSecret 和 AgentId 还需要创建应用</h3>
<p>企业 ID 只是第一步，还需要：</p>






























<table><thead><tr><th>参数</th><th>获取位置</th><th>下一步操作</th></tr></thead><tbody><tr><td><strong>corpId</strong></td><td>我的企业 → 企业ID</td><td>✅ 已获取</td></tr><tr><td><strong>agentId</strong></td><td>应用管理 → 创建应用</td><td>需要创建自建应用</td></tr><tr><td><strong>corpSecret</strong></td><td>应用详情页</td><td>创建应用后查看</td></tr><tr><td><strong>token/encodingAESKey</strong></td><td>接收消息设置</td><td>随机生成</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-56">你现在做到哪一步了？</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 登录了企业微信后台？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 找到企业 ID 了？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 创建自建应用了吗？</li>
</ul>
<p><strong>告诉我进度，我继续带你下一步！</strong> 🚀
User: engxiaochao@dengxiaochao ~ %
dengxiaochao@dengxiaochao ~ % openclaw config set channels.wecom-app.enabled true</p>
<p>(node:29800) [DEP0040] DeprecationWarning: The <code>punycode</code> module is deprecated. Please use a userland alternative instead.
(Use <code>node --trace-deprecation ...</code> to show where the warning was created)
2026-02-04T10:46:29.015Z INFO [wecom] WeCom plugin registering...
2026-02-04T10:46:29.018Z INFO [wecom] WeCom channel registered
2026-02-04T10:46:29.019Z INFO [wecom] WeCom HTTP handler registered</p>
<p>🦞 OpenClaw 2026.1.30 (76b5208) — Because texting yourself reminders is so 2024.</p>
<p>Error: Config validation failed: channels.wecom-app: unknown channel id: wecom-app 为啥
Kimi: 明白了！错误提示 <code>unknown channel id: wecom-app</code>，说明这个插件注册的通道名不是 <code>wecom-app</code>，而是其他名字。</p>
<hr/>
<h3 data-id="heading-57">🔍 查看插件实际注册的通道名</h3>
<p>运行这个命令查看可用的通道：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看所有可用通道</span>
openclaw channels list

<span class="hljs-comment"># 或查看配置</span>
openclaw config get channels
</code></pre>
<hr/>
<h3 data-id="heading-58">可能的正确通道名</h3>
<p>根据插件日志 <code>WeCom channel registered</code>，可能的名称是：</p>





















<table><thead><tr><th>尝试名称</th><th>命令</th></tr></thead><tbody><tr><td><code>wecom</code></td><td><code>openclaw config set channels.wecom.enabled true</code></td></tr><tr><td><code>wecom-app</code></td><td>你刚才试的，报错</td></tr><tr><td><code>wechat-work</code></td><td><code>openclaw config set channels.wechat-work.enabled true</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-59">快速诊断</h3>
<p><strong>第一步：查看插件详情</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw plugins info openclaw-plugin-wecom
</code></pre>
<p><strong>第二步：查看所有配置项</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw config list
</code></pre>
<p><strong>第三步：直接搜索 wecom 相关配置</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw config list | grep wecom
</code></pre>
<hr/>
<h3 data-id="heading-60">临时解决方案</h3>
<p>如果查不到，直接用 <strong>环境变量方式</strong> 配置（跳过验证）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置环境变量（当前终端有效）</span>
<span class="hljs-built_in">export</span> WECOM_CORPID=<span class="hljs-string">"ww你的企业ID"</span>
<span class="hljs-built_in">export</span> WECOM_CORPSECRET=<span class="hljs-string">"你的Secret"</span>
<span class="hljs-built_in">export</span> WECOM_AGENTID=<span class="hljs-string">"1000002"</span>
<span class="hljs-built_in">export</span> WECOM_TOKEN=<span class="hljs-string">"你的Token"</span>
<span class="hljs-built_in">export</span> WECOM_ENCODINGAESKEY=<span class="hljs-string">"你的43位Key"</span>

<span class="hljs-comment"># 然后启动网关</span>
openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-61">你现在执行这个</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw channels list
</code></pre>
<p><strong>把输出结果复制给我</strong>，我看看实际的通道名是什么！ 🎯
User: o@dengxiaochao ~ % openclaw config get channels</p>
<p>(node:32663) [DEP0040] DeprecationWarning: The <code>punycode</code> module is deprecated. Please use a userland alternative instead.
(Use <code>node --trace-deprecation ...</code> to show where the warning was created)
2026-02-04T10:53:06.063Z INFO [wecom] WeCom plugin registering...
2026-02-04T10:53:06.064Z INFO [wecom] WeCom channel registered
2026-02-04T10:53:06.066Z INFO [wecom] WeCom HTTP handler registered</p>
<p>🦞 OpenClaw 2026.1.30 (76b5208)
If you can describe it, I can probably automate it—or at least make it funnier.</p>
<p>Config path not found: channels
Kimi: 明白了！<code>channels</code> 路径不存在，说明插件可能用的是不同的配置结构。</p>
<p>让我搜索一下这个插件的正确配置方式：
太好了！找到问题了！根据搜索结果，你安装的插件 <code>openclaw-plugin-wecom</code> 的<strong>正确通道名是 <code>wecom</code></strong>，不是 <code>wecom-app</code>。</p>
<p>而且配置方式要用 <strong>JSON 格式</strong> 或者 <strong>直接编辑配置文件</strong>。</p>
<hr/>
<h3 data-id="heading-62">✅ 正确的配置方式</h3>
<h4 data-id="heading-63">方法一：使用 --json 参数（推荐）</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{
  "enabled": true,
  "webhookPath": "/wecom",
  "token": "你的Token",
  "encodingAESKey": "你的43位EncodingAESKey",
  "receiveId": "",
  "dm": { "policy": "pairing" }
}'</span> --json
</code></pre>
<h4 data-id="heading-64">方法二：直接编辑配置文件</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 打开配置文件</span>
nano ~/.openclaw/openclaw.json
</code></pre>
<p>添加以下内容：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"channels"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"wecom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"webhookPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/wecom"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的Token"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"encodingAESKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的43位EncodingAESKey"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"receiveId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"dm"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"policy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pairing"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-65">🚀 完整步骤（现在执行）</h3>
<p><strong>第一步：配置企业微信通道</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{
  "enabled": true,
  "webhookPath": "/wecom",
  "token": "你在企业微信后台设置的Token",
  "encodingAESKey": "你在企业微信后台生成的43位Key",
  "receiveId": "",
  "dm": { "policy": "pairing" }
}'</span> --json
</code></pre>
<p><strong>第二步：重启网关</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw gateway restart
</code></pre>
<p><strong>第三步：验证状态</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw channels status
</code></pre>
<hr/>
<h3 data-id="heading-66">🔍 如果要用自建应用（wecom-app）功能</h3>
<p>你之前尝试的 <code>wecom-app</code> 需要安装另一个插件 <code>@openclaw-china/channels</code> ：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装社区版插件（支持更多功能）</span>
openclaw plugins install @openclaw-china/channels

<span class="hljs-comment"># 然后配置 wecom-app</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom-app <span class="hljs-string">'{
  "enabled": true,
  "webhookPath": "/wecom-app",
  "token": "your-token",
  "encodingAESKey": "your-43-char-key",
  "corpId": "your-corp-id",
  "corpSecret": "your-app-secret",
  "agentId": 1000002
}'</span> --json
</code></pre>
<hr/>
<h3 data-id="heading-67">你现在执行这个</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 先确认插件安装成功</span>
openclaw plugins list | grep wecom

<span class="hljs-comment"># 然后用 JSON 方式配置</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/wecom","token":"你的Token","encodingAESKey":"你的43位Key","receiveId":"","dm":{"policy":"pairing"}}'</span> --json

<span class="hljs-comment"># 重启</span>
openclaw gateway restart
</code></pre>
<p><strong>把 <code>你的Token</code> 和 <code>你的43位Key</code> 替换成企业微信后台生成的真实值！</strong></p>
<p>执行后告诉我结果！ 🎯
User: "installs": {
"openclaw-plugin-wecom": {
"source": "npm",
"spec": "openclaw-plugin-wecom",
"installPath": "/Users/dengxiaochao/.openclaw/extensions/openclaw-plugin-wecom",
"version": "1.0.0",
"installedAt": "2026-02-04T10:44:21.631Z"
}
Kimi: 好的，插件安装成功！现在用 <strong>JSON 格式</strong> 配置 <code>wecom</code> 通道。</p>
<hr/>
<h3 data-id="heading-68">现在执行这个命令</h3>
<p>把下面的 <code>你的Token</code> 和 <code>你的43位EncodingAESKey</code> 替换成企业微信后台的真实值：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/wecom","token":"你的Token","encodingAESKey":"你的43位EncodingAESKey","receiveId":"","dm":{"policy":"pairing"}}'</span> --json
</code></pre>
<hr/>
<h3 data-id="heading-69">示例（假设你的值）</h3>
<p>如果你在企业微信后台设置的：</p>
<ul>
<li><strong>Token</strong>: <code>OpenClaw2024</code></li>
<li><strong>EncodingAESKey</strong>: <code>abcdefghijklmnopqrstuvwxyz1234567890123456</code>（43位）</li>
</ul>
<p>那么命令是：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/wecom","token":"OpenClaw2024","encodingAESKey":"abcdefghijklmnopqrstuvwxyz1234567890123456","receiveId":"","dm":{"policy":"pairing"}}'</span> --json
</code></pre>
<hr/>
<h3 data-id="heading-70">然后重启网关</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-71">验证配置</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw channels status
</code></pre>
<hr/>
<h3 data-id="heading-72">企业微信后台填写</h3>





















<table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td><strong>URL</strong></td><td><code>https://你的ngrok地址.ngrok-free.app/wecom</code></td></tr><tr><td><strong>Token</strong></td><td>和上面配置的一致</td></tr><tr><td><strong>EncodingAESKey</strong></td><td>和上面配置的一致</td></tr></tbody></table>
<hr/>
<p><strong>告诉我：</strong></p>
<ol>
<li>你的 Token 是什么？</li>
<li>你的 EncodingAESKey 是什么（43位）？</li>
<li>ngrok 的 URL 是什么？</li>
</ol>
<p>我帮你生成完整的配置命令！ 🚀
User: 不是要先配置企业Id嘛
Kimi: 你说得对！企业微信<strong>自建应用</strong>确实需要 <code>corpId</code> + <code>corpSecret</code> + <code>agentId</code>。</p>
<p>但你现在装的插件 <code>openclaw-plugin-wecom</code> 是<strong>基础版</strong>，看它的配置只有：</p>
<ul>
<li><code>token</code></li>
<li><code>encodingAESKey</code></li>
<li><code>webhookPath</code></li>
</ul>
<p><strong>没有企业ID相关字段！</strong></p>
<hr/>
<h3 data-id="heading-73">两种模式对比</h3>























<table><thead><tr><th>模式</th><th>需要参数</th><th>功能</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>基础版（你现在装的）</strong></td><td>Token + EncodingAESKey</td><td>被动回复消息</td><td>简单机器人</td></tr><tr><td><strong>自建应用版</strong></td><td>corpId + corpSecret + agentId</td><td>主动发消息、获取用户信息</td><td>完整功能</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-74">方案选择</h3>
<h4 data-id="heading-75">方案 A：先用基础版（简单，现在就能用）</h4>
<p><strong>特点：</strong></p>
<ul>
<li>不需要 corpId</li>
<li>企业微信后台创建的是**"接收消息"**的机器人</li>
<li>只能被动回复（用户先发消息，机器人才能回）</li>
</ul>
<p><strong>配置（就是你现在的插件）：</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/wecom","token":"你的Token","encodingAESKey":"你的43位Key"}'</span> --json
</code></pre>
<hr/>
<h4 data-id="heading-76">方案 B：安装完整版插件（需要 corpId）</h4>
<p>如果你想用<strong>自建应用</strong>（主动发消息、获取部门列表等），需要安装另一个插件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装社区版插件（支持 corpId/corpSecret）</span>
openclaw plugins install @openclaw-china/channels
</code></pre>
<p>然后才能配置：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> channels.wecom-app <span class="hljs-string">'{
  "enabled": true,
  "corpId": "ww你的企业ID",
  "corpSecret": "应用的Secret",
  "agentId": 1000002,
  "token": "你的Token",
  "encodingAESKey": "你的43位Key"
}'</span> --json
</code></pre>
<hr/>
<h3 data-id="heading-77">你现在怎么选？</h3>

















<table><thead><tr><th>你的需求</th><th>建议方案</th></tr></thead><tbody><tr><td>只想快速测试，能回复消息就行</td><td><strong>方案 A</strong>（基础版，不用 corpId）</td></tr><tr><td>需要主动推送消息、完整功能</td><td><strong>方案 B</strong>（安装 @openclaw-china/channels）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-78">快速决策</h3>
<p><strong>先回答我：</strong></p>
<ol>
<li>
<p>你在企业微信后台创建的是 <strong>"接收消息"</strong> 还是 <strong>"自建应用"</strong>？</p>
<ul>
<li>路径是：<strong>应用管理 → 接收消息</strong> → 基础版</li>
<li>路径是：<strong>应用管理 → 自建应用</strong> → 完整版</li>
</ul>
</li>
<li>
<p>你想实现什么功能？</p>
<ul>
<li>只是问答对话 → 基础版够用</li>
<li>要主动群发消息 → 需要完整版</li>
</ul>
</li>
</ol>
<p>告诉我，我帮你走正确的配置！ 🎯
User: toekn是 lYpiVXyHnrYvKVcD5HMVOM4UK，encodingaes是cySuMkqB6wu3PkLY9hoyT2lELURprMUmaVpAx7OlOOO
Kimi: 好的！用你提供的值，现在执行：</p>
<hr/>
<h3 data-id="heading-79">配置命令</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/wecom","token":"lYpiVXyHnrYvKVcD5HMVOM4UK","encodingAESKey":"cySuMkqB6wu3PkLY9hoyT2lELURprMUmaVpAx7OlOOO","receiveId":"","dm":{"policy":"pairing"}}'</span> --json
</code></pre>
<hr/>
<h3 data-id="heading-80">然后重启网关</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-81">验证配置</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw channels status
</code></pre>
<hr/>
<h3 data-id="heading-82">企业微信后台填写</h3>

























<table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td><strong>URL</strong></td><td><code>https://你的ngrok地址.ngrok-free.app/wecom</code></td></tr><tr><td><strong>Token</strong></td><td><code>lYpiVXyHnrYvKVcD5HMVOM4UK</code></td></tr><tr><td><strong>EncodingAESKey</strong></td><td><code>cySuMkqB6wu3PkLY9hoyT2lELURprMUmaVpAx7OlOOO</code></td></tr><tr><td><strong>消息加解密方式</strong></td><td>选**"兼容模式"** 或**"明文模式"**</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-83">检查清单</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> ngrok 正在运行（<code>ngrok http 18789</code>）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 复制了 ngrok 的 https 地址</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 执行了上面的 config 命令</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 执行了 <code>openclaw gateway restart</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 企业微信后台填了正确的 URL + Token + EncodingAESKey</li>
</ul>
<p><strong>执行完告诉我结果！</strong> 🚀
User: 他做了域名 那企业微信后台设置url这里写<a href="https://link.juejin.cn?target=https%3A%2F%2Fbot.shuqi.run%255Cwecom" target="_blank" title="https://bot.shuqi.run%5Cwecom" ref="nofollow noopener noreferrer">bot.shuqi.run\wecom</a> 对吗
Kimi: 不对！URL 格式有误。</p>
<hr/>
<h3 data-id="heading-84">❌ 错误</h3>
<pre><code class="hljs language-arduino" lang="arduino">https:<span class="hljs-comment">//bot.shuqi.run\wecom</span>
              ↑
           这里用了反斜杠 \
</code></pre>
<hr/>
<h3 data-id="heading-85">✅ 正确格式</h3>
<pre><code class="hljs language-arduino" lang="arduino">https:<span class="hljs-comment">//bot.shuqi.run/wecom</span>
              ↑
           用正斜杠 /
</code></pre>
<hr/>
<h3 data-id="heading-86">企业微信后台填写</h3>





















<table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td><strong>URL</strong></td><td><code>https://bot.shuqi.run/wecom</code></td></tr><tr><td><strong>Token</strong></td><td><code>lYpiVXyHnrYvKVcD5HMVOM4UK</code></td></tr><tr><td><strong>EncodingAESKey</strong></td><td><code>cySuMkqB6wu3PkLY9hoyT2lELURprMUmaVpAx7OlOOO</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-87">关键点</h3>
<ul>
<li><strong>正斜杠</strong> <code>/</code> ✅</li>
<li><strong>反斜杠</strong> <code>\</code> ❌（这是 Windows 路径用的，URL 里不能用）</li>
</ul>
<hr/>
<p>改过来后点击<strong>保存</strong>，如果显示 <strong>"请求成功"</strong> 或 <strong>"验证通过"</strong> 就说明配置成功了！🎉</p>
<p><strong>保存后告诉我结果！</strong>
User: ◇Gateway reachable.</p>
<ul>
<li>Enterprise WeChat default: enabled</li>
</ul>
<p>Tip: status --deep adds gateway health probes to status output (requires a reachable gateway). 这样说明可以了吧
Kimi: 太好了！🎉 <strong>配置成功！</strong></p>
<hr/>
<h3 data-id="heading-88">✅ 状态解读</h3>
<pre><code class="hljs language-arduino" lang="arduino">◇ Gateway reachable.                    ← 网关可访问
- Enterprise WeChat <span class="hljs-keyword">default</span>: enabled     ← 企业微信通道已启用
</code></pre>
<p><strong>说明：</strong></p>
<ul>
<li>OpenClaw 网关运行正常</li>
<li>企业微信插件已加载并启用</li>
<li>可以接收消息了！</li>
</ul>
<hr/>
<h3 data-id="heading-89">🚀 现在测试</h3>
<p><strong>1. 在企业微信里找到机器人</strong></p>
<ul>
<li>可能是你创建的<strong>应用名称</strong></li>
<li>或者在<strong>通讯录</strong> → <strong>外部联系人</strong>里</li>
</ul>
<p><strong>2. 发送消息测试</strong></p>
<pre><code class="hljs">你好
</code></pre>
<p><strong>3. 看 OpenClaw 是否收到</strong></p>
<ul>
<li>观察 OpenClaw 终端是否有日志输出</li>
<li>或者查看日志文件</li>
</ul>
<hr/>
<h3 data-id="heading-90">🔍 查看实时日志</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 如果要看实时日志</span>
openclaw logs -f

<span class="hljs-comment"># 或者找日志文件位置</span>
openclaw config get logging.file
</code></pre>
<hr/>
<h3 data-id="heading-91">如果收不到消息，检查</h3>

























<table><thead><tr><th>检查项</th><th>命令/方法</th></tr></thead><tbody><tr><td>ngrok 是否还在运行</td><td>看 ngrok 终端窗口</td></tr><tr><td>URL 是否能访问</td><td>浏览器访问 <code>https://bot.shuqi.run/wecom</code></td></tr><tr><td>企业微信后台是否保存成功</td><td>重新打开后台确认</td></tr><tr><td>OpenClaw 是否运行</td><td><code>openclaw gateway status</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-92">你现在</h3>
<p><strong>在企业微信里发一条消息试试！</strong></p>
<p>发了之后告诉我：</p>
<ul>
<li>机器人回复了吗？</li>
<li>OpenClaw 终端有日志输出吗？</li>
</ul>
<p>🚀
User: 最后创建这里<a href="https://link.juejin.cn?target=http%3A%2F%2Fbot.shuqi.run%2Fwecom" target="_blank" title="http://bot.shuqi.run/wecom" ref="nofollow noopener noreferrer">bot.shuqi.run/wecom</a> 这个时显示请求url失败显示301，如果是https就显示501
Kimi: 明白了！HTTP 301 和 HTTPS 501 说明 URL 访问有问题。</p>
<hr/>
<h3 data-id="heading-93">问题分析</h3>

















<table><thead><tr><th>错误</th><th>含义</th></tr></thead><tbody><tr><td><strong>HTTP 301</strong></td><td>重定向到 HTTPS，但企业微信要求直接访问</td></tr><tr><td><strong>HTTPS 501</strong></td><td>服务器不支持该请求方法（可能是配置问题）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-94">可能原因 &amp; 解决方案</h3>
<h4 data-id="heading-95">原因 1：你的固定域名 <code>bot.shuqi.run</code> 配置有问题</h4>
<p>你之前用 ngrok 是 <code>https://xxx.ngrok-free.app</code>，现在换成了 <code>bot.shuqi.run</code>。</p>
<p><strong>这个域名是怎么配置的？</strong></p>
<ul>
<li>Cloudflare Tunnel？</li>
<li>自己的服务器反向代理？</li>
<li>其他内网穿透工具？</li>
</ul>
<hr/>
<h4 data-id="heading-96">原因 2：OpenClaw 网关没绑定到该域名</h4>
<p>检查 OpenClaw 实际监听的地址：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看网关配置</span>
openclaw config get gateway

<span class="hljs-comment"># 应该显示</span>
{
  <span class="hljs-string">"bind"</span>: <span class="hljs-string">"0.0.0.0"</span>,    // 或 <span class="hljs-string">"127.0.0.1"</span>
  <span class="hljs-string">"port"</span>: 18789
}
</code></pre>
<p>如果 <code>bind</code> 是 <code>127.0.0.1</code>，那只能本地访问，外部域名进不来。</p>
<p><strong>改成 0.0.0.0：</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> gateway.bind <span class="hljs-string">"0.0.0.0"</span>
openclaw gateway restart
</code></pre>
<hr/>
<h4 data-id="heading-97">原因 3：HTTPS 证书问题</h4>
<p>如果 <code>bot.shuqi.run</code> 走了 HTTPS，但后端 OpenClaw 是 HTTP，需要检查反向代理配置。</p>
<hr/>
<h3 data-id="heading-98">快速诊断</h3>
<p><strong>第一步：测试域名是否能访问 OpenClaw</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在你的 Mac 上测试（替换为你的域名）</span>
curl -v http://bot.shuqi.run/wecom

<span class="hljs-comment"># 和</span>
curl -v https://bot.shuqi.run/wecom
</code></pre>
<p><strong>把输出结果给我！</strong></p>
<hr/>
<p><strong>第二步：确认网络路径</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">企业微信服务器 → bot.shuqi.run → ??? → 你的 Mac:<span class="hljs-number">18789</span>
</code></pre>
<p><strong>告诉我：</strong></p>
<ol>
<li><code>bot.shuqi.run</code> 是怎么配置的？（Cloudflare？Nginx？其他？）</li>
<li>它指向哪里？（你的公网 IP？还是 ngrok？）</li>
<li>之前用 ngrok 的 URL 能成功吗？</li>
</ol>
<hr/>
<h3 data-id="heading-99">临时解决方案</h3>
<p>如果着急测试，<strong>先用回 ngrok</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动 ngrok</span>
ngrok http 18789

<span class="hljs-comment"># 用 ngrok 的 https 地址（如 https://abc123.ngrok-free.app）</span>
<span class="hljs-comment"># 填到企业微信： https://abc123.ngrok-free.app/wecom</span>
</code></pre>
<p>ngrok 的 HTTPS 是经过验证的，企业微信能正常访问。</p>
<hr/>
<p><strong>先回答我：</strong></p>
<ul>
<li><code>bot.shuqi.run</code> 是什么服务配置的？</li>
<li>之前 ngrok 能用吗？</li>
</ul>
<p>我帮你定位问题！🔧
User: 他用的是什么frpdengxiaochao@dengxiaochao ~ % chmod +x /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc &amp;&amp;  /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc -c /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml
2026-02-04 15:29:33.944 [I] [sub/root.go:159] start frpc service for config file [/Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml]
2026-02-04 15:29:33.944 [I] [client/service.go:335] try to connect to server...
2026-02-04 15:29:33.999 [I] [client/service.go:327] [8e537f1df8196659] login to server success, get run id [8e537f1df8196659]
2026-02-04 15:29:34.000 [I] [proxy/proxy_manager.go:180] [8e537f1df8196659] proxy added: [bot]
2026-02-04 15:29:34.020 [I] [client/control.go:172] [8e537f1df8196659] [bot] start proxy success
2026-02-04 19:12:18.674 [E] [proxy/proxy.go:202] [8e537f1df8196659] [bot] connect to local service [127.0.0.1:18789] error: dial tcp 127.0.0.1:18789: connect: connection refused
Kimi: 明白了！问题找到了！🔍</p>
<hr/>
<h3 data-id="heading-100">错误分析</h3>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">connect</span> to <span class="hljs-keyword">local</span> service [<span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">18789</span>] error: dial tcp <span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">18789</span>: <span class="hljs-keyword">connect</span>: connection refused
</code></pre>
<p><strong>FRP 客户端无法连接到本地的 OpenClaw！</strong></p>
<hr/>
<h3 data-id="heading-101">根本原因</h3>

















<table><thead><tr><th>问题</th><th>说明</th></tr></thead><tbody><tr><td>FRP 配置</td><td>指向 <code>127.0.0.1:18789</code></td></tr><tr><td>实际情况</td><td>OpenClaw 网关<strong>没有运行</strong>，或<strong>绑定了其他端口/地址</strong></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-102">检查步骤</h3>
<p><strong>第一步：确认 OpenClaw 网关是否运行</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看网关状态</span>
openclaw gateway status

<span class="hljs-comment"># 或者看进程</span>
ps aux | grep openclaw
</code></pre>
<p><strong>如果显示 stopped，先启动：</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw gateway start
<span class="hljs-comment"># 或</span>
openclaw gateway restart
</code></pre>
<hr/>
<p><strong>第二步：确认 OpenClaw 实际监听地址</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看网关配置</span>
openclaw config get gateway
</code></pre>
<p><strong>应该显示：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"bind"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.0.0.0"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 或 "127.0.0.1"</span>
  <span class="hljs-attr">"port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18789</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<p><strong>第三步：检查端口是否真的在监听</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Mac 上查看 18789 端口</span>
lsof -i :18789

<span class="hljs-comment"># 或</span>
netstat -an | grep 18789
</code></pre>
<p><strong>如果没有输出，说明 OpenClaw 没绑定这个端口！</strong></p>
<hr/>
<h3 data-id="heading-103">解决方案</h3>
<h4 data-id="heading-104">情况 A：OpenClaw 网关没运行</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动网关</span>
openclaw gateway start

<span class="hljs-comment"># 确认状态</span>
openclaw gateway status
</code></pre>
<h4 data-id="heading-105">情况 B：端口被占用或配置错误</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 重新设置配置</span>
openclaw config <span class="hljs-built_in">set</span> gateway.bind <span class="hljs-string">"127.0.0.1"</span>
openclaw config <span class="hljs-built_in">set</span> gateway.port 18789

<span class="hljs-comment"># 重启</span>
openclaw gateway restart
</code></pre>
<h4 data-id="heading-106">情况 C：FRP 配置和 OpenClaw 不匹配</h4>
<p>检查你的 <code>frpc.toml</code> 文件：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-comment"># 应该类似这样</span>
<span class="hljs-section">[common]</span>
<span class="hljs-attr">server_addr</span> = 你的FRP服务器地址
<span class="hljs-attr">server_port</span> = <span class="hljs-number">7000</span>
<span class="hljs-attr">token</span> = 你的token

<span class="hljs-section">[bot]</span>
<span class="hljs-attr">type</span> = http
<span class="hljs-attr">local_port</span> = <span class="hljs-number">18789</span>        <span class="hljs-comment"># ← 必须和 OpenClaw 一致</span>
<span class="hljs-attr">local_ip</span> = <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>      <span class="hljs-comment"># ← 必须和 OpenClaw bind 一致</span>
<span class="hljs-attr">custom_domains</span> = bot.shuqi.run
</code></pre>
<hr/>
<h3 data-id="heading-107">快速验证</h3>
<p><strong>先确保 OpenClaw 本地可访问：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 本地测试</span>
curl http://127.0.0.1:18789/wecom

<span class="hljs-comment"># 如果返回 404 或 200，说明 OpenClaw 在运行</span>
<span class="hljs-comment"># 如果 connection refused，说明没运行</span>
</code></pre>
<hr/>
<h3 data-id="heading-108">你现在执行</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查 OpenClaw 状态</span>
openclaw gateway status

<span class="hljs-comment"># 2.</span>
User: curl -v https://bot.shuqi.run/wecom 

* Host bot.shuqi.run:443 was resolved.
* IPv6: (none)
* IPv4: 122.9.157.124
*   Trying 122.9.157.124:443...
* Connected to bot.shuqi.run (122.9.157.124) port 443
* ALPN: curl offers h2,http/1.1
* (304) (OUT), TLS handshake, Client hello (1):
*  CAfile: /etc/ssl/cert.pem
*  CApath: none
* (304) (IN), TLS handshake, Server hello (2):
* (304) (IN), TLS handshake, Unknown (8):
* (304) (IN), TLS handshake, Certificate (11):
* (304) (IN), TLS handshake, CERT verify (15):
* (304) (IN), TLS handshake, Finished (20):
* (304) (OUT), TLS handshake, Finished (20):
* SSL connection using TLSv1.3 / AEAD-AES256-GCM-SHA384 / [blank] / UNDEF
* ALPN: server accepted h2
* Server certificate:
*  subject: CN=bot.shuqi.run
*  start <span class="hljs-built_in">date</span>: Feb  4 06:18:35 2026 GMT
*  expire <span class="hljs-built_in">date</span>: May  5 06:18:34 2026 GMT
*  subjectAltName: host <span class="hljs-string">"bot.shuqi.run"</span> matched cert<span class="hljs-string">'s "bot.shuqi.run"
*  issuer: C=US; O=Let'</span>s Encrypt; CN=R13
*  SSL certificate verify ok.
* using HTTP/2
* [HTTP/2] [1] OPENED stream <span class="hljs-keyword">for</span> https://bot.shuqi.run/wecom 
* [HTTP/2] [1] [:method: GET]
* [HTTP/2] [1] [:scheme: https]
* [HTTP/2] [1] [:authority: bot.shuqi.run]
* [HTTP/2] [1] [:path: /wecom]
* [HTTP/2] [1] [user-agent: curl/8.7.1]
* [HTTP/2] [1] [accept: */*]
&gt; GET /wecom HTTP/2
&gt; Host: bot.shuqi.run
&gt; User-Agent: curl/8.7.1
&gt; Accept: */*
&gt; 
* Request completely sent off
&lt; HTTP/2 500 
&lt; server: nginx
&lt; <span class="hljs-built_in">date</span>: Wed, 04 Feb 2026 11:18:28 GMT
&lt; content-type: text/plain; charset=utf-8
&lt; content-length: 21
&lt; 
* Connection <span class="hljs-comment">#0 to host bot.shuqi.run left intact</span>
Internal Server Error%                                                          dengxiaochao@dengxiaochao openclaw-plugin-wecom %
Kimi: 找到了！问题很清楚 🔍

---

<span class="hljs-comment">## 问题根源</span>

**FRP 日志显示：**
</code></pre>
<p>connect to local service [127.0.0.1:18789] error: connection refused</p>
<pre><code class="hljs language-yaml" lang="yaml">
<span class="hljs-string">**意思是：**</span> <span class="hljs-string">FRP</span> <span class="hljs-string">客户端连不上你本地的</span> <span class="hljs-string">OpenClaw！</span>

<span class="hljs-meta">---
</span>
<span class="hljs-comment">## 原因分析</span>

<span class="hljs-string">|</span> <span class="hljs-string">问题</span> <span class="hljs-string">|</span> <span class="hljs-string">说明</span> <span class="hljs-string">|</span>
<span class="hljs-string">|-----|------|</span>
<span class="hljs-string">|</span> <span class="hljs-string">FRP</span> <span class="hljs-string">配置指向</span> <span class="hljs-string">`127.0.0.1:18789`</span> <span class="hljs-string">|</span> <span class="hljs-string">但</span> <span class="hljs-string">OpenClaw</span> <span class="hljs-string">没运行，或绑定了其他地址</span> <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">`curl`</span> <span class="hljs-string">返回</span> <span class="hljs-string">`HTTP</span> <span class="hljs-number">500</span><span class="hljs-string">`</span> <span class="hljs-string">|</span> <span class="hljs-string">FRP</span> <span class="hljs-string">连不上后端，返回内部错误</span> <span class="hljs-string">|</span>

<span class="hljs-meta">---
</span>
<span class="hljs-comment">## 解决方案</span>

<span class="hljs-comment">### 第一步：确认 OpenClaw 网关正在运行</span>

<span class="hljs-string">```bash</span>
<span class="hljs-comment"># 查看网关状态</span>
<span class="hljs-string">openclaw</span> <span class="hljs-string">gateway</span> <span class="hljs-string">status</span>

<span class="hljs-comment"># 如果没运行，启动它</span>
<span class="hljs-string">openclaw</span> <span class="hljs-string">gateway</span> <span class="hljs-string">start</span>
<span class="hljs-comment"># 或</span>
<span class="hljs-string">openclaw</span> <span class="hljs-string">gateway</span> <span class="hljs-string">restart</span>
</code></pre>
<hr/>
<h4 data-id="heading-109">第二步：确认端口监听</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 18789 端口是否被监听</span>
lsof -i :18789

<span class="hljs-comment"># 或</span>
netstat -an | grep 18789
</code></pre>
<p><strong>应该显示：</strong></p>
<pre><code class="hljs">LISTEN  0  0  0.0.0.0:18789  (或 127.0.0.1:18789)
</code></pre>
<hr/>
<h4 data-id="heading-110">第三步：如果 OpenClaw 没绑定 127.0.0.1</h4>
<p>检查配置：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw config get gateway.bind
</code></pre>
<p><strong>如果显示 <code>0.0.0.0</code>，改成 <code>127.0.0.1</code> 或保持，确保 FRP 能连上：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方案 A：让 OpenClaw 只监听本地（FRP 在同一台机器，可以连）</span>
openclaw config <span class="hljs-built_in">set</span> gateway.bind <span class="hljs-string">"127.0.0.1"</span>
openclaw config <span class="hljs-built_in">set</span> gateway.port 18789
openclaw gateway restart
</code></pre>
<hr/>
<h4 data-id="heading-111">第四步：验证本地能访问</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试本地访问</span>
curl http://127.0.0.1:18789/wecom

<span class="hljs-comment"># 应该返回类似 405 Method Not Allowed 或正常响应</span>
<span class="hljs-comment"># 而不是 connection refused</span>
</code></pre>
<hr/>
<h4 data-id="heading-112">第五步：重启 FRP</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 先停止之前的 frpc（Ctrl+C）</span>

<span class="hljs-comment"># 重新启动</span>
/Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc -c /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml
</code></pre>
<hr/>
<h3 data-id="heading-113">快速检查清单</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. OpenClaw 运行了吗？</span>
openclaw gateway status

<span class="hljs-comment"># 2. 端口监听了吗？</span>
lsof -i :18789

<span class="hljs-comment"># 3. 本地能访问吗？</span>
curl http://127.0.0.1:18789/wecom

<span class="hljs-comment"># 4. FRP 日志还报错吗？</span>
</code></pre>
<hr/>
<h3 data-id="heading-114">你现在执行</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 先确保 OpenClaw 运行</span>
openclaw gateway restart

<span class="hljs-comment"># 检查端口</span>
lsof -i :18789

<span class="hljs-comment"># 测试本地</span>
curl http://127.0.0.1:18789/wecom
</code></pre>
<p><strong>把三个命令的输出给我！</strong> 🔧
User: Checking gateway status...
◇
Service: LaunchAgent (loaded)
File logs: /tmp/openclaw/openclaw-2026-02-04.log
Command: /usr/local/bin/node /Users/dengxiaochao/.nvm/versions/node/v22.12.0/lib/node_modules/openclaw/dist/index.js gateway --port 18789
Service file: ~/Library/LaunchAgents/ai.openclaw.gateway.plist
Service env: OPENCLAW_GATEWAY_PORT=18789</p>
<p>Config (cli): ~/.openclaw/openclaw.json
Config (service): ~/.openclaw/openclaw.json</p>
<p>Gateway: bind=loopback (127.0.0.1), port=18789 (service args)
Probe target: ws://127.0.0.1:18789
Dashboard: <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A18789%2F" target="_blank" title="http://127.0.0.1:18789/" ref="nofollow noopener noreferrer">http://127.0.0.1:18789/</a>
Probe note: Loopback-only gateway; only local clients can connect.</p>
<p>Runtime: running (pid 40119)
RPC probe: ok</p>
<p>Listening: 127.0.0.1:18789
Troubles: run openclaw status
Troubleshooting: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.openclaw.ai%2Ftroubleshooting" target="_blank" title="https://docs.openclaw.ai/troubleshooting" ref="nofollow noopener noreferrer">docs.openclaw.ai/troubleshoo…</a>
Kimi: 找到了！问题很明确 🔍</p>
<hr/>
<h3 data-id="heading-115">问题根源</h3>
<p><strong>OpenClaw 绑定了 <code>127.0.0.1</code>（loopback），但 FRP 连不上！</strong></p>
<pre><code class="hljs language-ini" lang="ini">Gateway: <span class="hljs-attr">bind</span>=loopback (<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>), port=<span class="hljs-number">18789</span>
Probe note: Loopback-only gateway<span class="hljs-comment">; only local clients can connect.</span>
</code></pre>
<p><strong>意思是：</strong> OpenClaw 只监听本地回环地址，FRP 虽然在你同一台 Mac 上，但可能以不同方式解析 <code>127.0.0.1</code>。</p>
<hr/>
<h3 data-id="heading-116">解决方案</h3>
<h4 data-id="heading-117">方案：让 OpenClaw 监听所有网卡</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 停止当前网关</span>
openclaw gateway stop

<span class="hljs-comment"># 修改绑定地址为 0.0.0.0（所有网卡）</span>
openclaw config <span class="hljs-built_in">set</span> gateway.bind <span class="hljs-string">"0.0.0.0"</span>
openclaw config <span class="hljs-built_in">set</span> gateway.port 18789

<span class="hljs-comment"># 重启网关</span>
openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-118">验证修改</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查新配置</span>
openclaw gateway status

<span class="hljs-comment"># 应该显示</span>
Gateway: <span class="hljs-built_in">bind</span>=0.0.0.0, port=18789
<span class="hljs-comment"># 而不是 loopback (127.0.0.1)</span>
</code></pre>
<hr/>
<h3 data-id="heading-119">然后重启 FRP</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 停止之前的 frpc（Ctrl+C）</span>

<span class="hljs-comment"># 重新启动</span>
/Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc -c /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml
</code></pre>
<hr/>
<h3 data-id="heading-120">完整测试流程</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 修改 OpenClaw 绑定</span>
openclaw config <span class="hljs-built_in">set</span> gateway.bind <span class="hljs-string">"0.0.0.0"</span>
openclaw gateway restart

<span class="hljs-comment"># 2. 验证监听地址</span>
lsof -i :18789
<span class="hljs-comment"># 应该显示 0.0.0.0:18789 或 *:18789</span>

<span class="hljs-comment"># 3. 本地测试</span>
curl http://127.0.0.1:18789/wecom

<span class="hljs-comment"># 4. 重启 FRP</span>
<span class="hljs-comment"># （在另一个终端运行 frpc）</span>

<span class="hljs-comment"># 5. 外网测试</span>
curl https://bot.shuqi.run/wecom
</code></pre>
<hr/>
<h3 data-id="heading-121">你现在执行</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> gateway.bind <span class="hljs-string">"0.0.0.0"</span>
openclaw gateway restart
</code></pre>
<p><strong>然后告诉我 <code>openclaw gateway status</code> 的输出！</strong> 🚀
User: openclaw config set gateway.bind "0.0.0.0"</p>
<p>(node:44236) [DEP0040] DeprecationWarning: The <code>punycode</code> module is deprecated. Please use a userland alternative instead.
(Use <code>node --trace-deprecation ...</code> to show where the warning was created)
2026-02-04T11:23:07.443Z INFO [wecom] WeCom plugin registering...
2026-02-04T11:23:07.445Z INFO [wecom] WeCom channel registered
2026-02-04T11:23:07.448Z INFO [wecom] WeCom HTTP handler registered</p>
<p>🦞 OpenClaw 2026.1.30 (76b5208) — curl for conversations.</p>
<p>│
◇  Doctor changes ─────────────────────╮
│                                      │
│  wecom configured, not enabled yet.  │
│                                      │
├──────────────────────────────────────╯
│
◇  Doctor ──────────────────────────────────────────────╮
│                                                       │
│  Run "openclaw doctor --fix" to apply these changes.  │
│                                                       │
├───────────────────────────────────────────────────────╯
Error: Config validation failed: gateway.bind: Invalid input
Kimi: 明白了！<code>gateway.bind</code> 不能直接设置，需要通过 <strong>service 配置</strong> 修改。</p>
<hr/>
<h3 data-id="heading-122">正确修改方式</h3>
<p>OpenClaw 作为服务运行，需要修改 <strong>LaunchAgent 配置</strong>：</p>
<h4 data-id="heading-123">步骤 1：停止当前服务</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw gateway stop
</code></pre>
<h4 data-id="heading-124">步骤 2：编辑服务配置文件</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 打开 plist 文件</span>
nano ~/Library/LaunchAgents/ai.openclaw.gateway.plist
</code></pre>
<h4 data-id="heading-125">步骤 3：修改绑定地址</h4>
<p>找到 <code>&lt;key&gt;ProgramArguments&lt;/key&gt;</code> 部分，添加 <code>--bind</code> 参数：</p>
<p><strong>原来的可能是：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/usr/local/bin/node<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/Users/dengxiaochao/.nvm/versions/node/v22.12.0/lib/node_modules/openclaw/dist/index.js<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>gateway<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>--port<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>18789<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span>
</code></pre>
<p><strong>改成：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/usr/local/bin/node<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/Users/dengxiaochao/.nvm/versions/node/v22.12.0/lib/node_modules/openclaw/dist/index.js<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>gateway<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>--port<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>18789<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>--bind<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>0.0.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span>
</code></pre>
<h4 data-id="heading-126">步骤 4：重新加载服务</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 卸载旧服务</span>
launchctl unload ~/Library/LaunchAgents/ai.openclaw.gateway.plist

<span class="hljs-comment"># 重新加载</span>
launchctl load ~/Library/LaunchAgents/ai.openclaw.gateway.plist

<span class="hljs-comment"># 或者直接用 openclaw 命令重启</span>
openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-127">更简单的方法：使用环境变量</h3>
<p>如果上面的太复杂，试试环境变量方式：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 停止服务</span>
openclaw gateway stop

<span class="hljs-comment"># 设置环境变量</span>
<span class="hljs-built_in">export</span> OPENCLAW_GATEWAY_BIND=<span class="hljs-string">"0.0.0.0"</span>
<span class="hljs-built_in">export</span> OPENCLAW_GATEWAY_PORT=<span class="hljs-string">"18789"</span>

<span class="hljs-comment"># 前台启动（测试用）</span>
openclaw gateway start --foreground
</code></pre>
<hr/>
<h3 data-id="heading-128">或者：直接修改 config 文件</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑配置文件</span>
nano ~/.openclaw/openclaw.json
</code></pre>
<p>添加：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"gateway"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"bind"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.0.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18789</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-129">推荐：先试试环境变量方式（最快）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 停止服务</span>
openclaw gateway stop

<span class="hljs-comment"># 2. 设置环境变量并启动</span>
<span class="hljs-built_in">export</span> OPENCLAW_GATEWAY_BIND=<span class="hljs-string">"0.0.0.0"</span>
openclaw gateway start --foreground
</code></pre>
<p><strong>然后新开一个终端测试：</strong></p>
<pre><code class="hljs language-bash" lang="bash">curl http://127.0.0.1:18789/wecom
lsof -i :18789
</code></pre>
<p><strong>告诉我结果！</strong> 如果成功，我们再改成永久配置。🔧
User: <code>&lt;true/&gt;</code>
<code>&lt;key&gt;</code>KeepAlive <code>&lt;/key&gt;</code>
<code>&lt;true/&gt;</code>
<code>&lt;key&gt;</code>ProgramArguments <code>&lt;/key&gt;</code>
<code>&lt;array&gt;</code>
<code>&lt;string&gt;</code>/usr/local/bin/node <code>&lt;/string&gt;</code>
<code>&lt;string&gt;</code>/Users/dengxiaochao/.nvm/versions/node/v22.12.0/lib/node_modules/$
<code>&lt;string&gt;</code>gateway <code>&lt;/string&gt;</code>
<code>&lt;string&gt;</code>--port <code>&lt;/string&gt;</code>
<code>&lt;string&gt;</code>18789 <code>&lt;/string&gt;</code>
<code>&lt;/array&gt;</code></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`&lt;key&gt;`</span>StandardOutPath <span class="hljs-string">`&lt;/key&gt;`</span>
<span class="hljs-string">`&lt;string&gt;`</span>/Users/dengxiaochao/.openclaw/logs/gateway.log <span class="hljs-string">`&lt;/string&gt;`</span>
<span class="hljs-string">`&lt;key&gt;`</span>StandardErrorPath <span class="hljs-string">`&lt;/key&gt;`</span>
<span class="hljs-string">`&lt;string&gt;`</span>/Users/dengxiaochao/.openclaw/logs/gateway.err.log <span class="hljs-string">`&lt;/string&gt;`</span>
<span class="hljs-string">`&lt;key&gt;`</span>EnvironmentVariables <span class="hljs-string">`&lt;/key&gt;`</span>
<span class="hljs-string">`&lt;dict&gt;`</span>
<span class="hljs-string">`&lt;key&gt;`</span>HOME <span class="hljs-string">`&lt;/key&gt;`</span>
</code></pre>
<p>Kimi: 看到了！在 <code>ProgramArguments</code> 数组里添加 <code>--bind</code> 和 <code>0.0.0.0</code> 两个元素。</p>
<hr/>
<h3 data-id="heading-130">修改步骤</h3>
<h4 data-id="heading-131">1. 编辑 plist 文件</h4>
<pre><code class="hljs language-bash" lang="bash">nano ~/Library/LaunchAgents/ai.openclaw.gateway.plist
</code></pre>
<h4 data-id="heading-132">2. 找到这段（你贴的部分）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/usr/local/bin/node<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/Users/dengxiaochao/.nvm/versions/node/v22.12.0/lib/node_modules/openclaw/dist/index.js<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>gateway<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>--port<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>18789<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span>
</code></pre>
<h4 data-id="heading-133">3. 改成这样</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/usr/local/bin/node<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/Users/dengxiaochao/.nvm/versions/node/v22.12.0/lib/node_modules/openclaw/dist/index.js<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>gateway<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>--port<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>18789<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>--bind<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>0.0.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span>
</code></pre>
<p><strong>就是在 <code>18789&lt;/string&gt;</code> 后面添加两行：</strong></p>
<pre><code class="hljs language-xml" lang="xml">  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>--bind<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>0.0.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
</code></pre>
<h4 data-id="heading-134">4. 保存并重启服务</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 停止旧服务</span>
launchctl unload ~/Library/LaunchAgents/ai.openclaw.gateway.plist

<span class="hljs-comment"># 重新加载</span>
launchctl load ~/Library/LaunchAgents/ai.openclaw.gateway.plist

<span class="hljs-comment"># 验证状态</span>
openclaw gateway status
</code></pre>
<hr/>
<h3 data-id="heading-135">验证成功</h3>
<p><code>openclaw gateway status</code> 应该显示：</p>
<pre><code class="hljs language-ini" lang="ini">Gateway: <span class="hljs-attr">bind</span>=<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>, port=<span class="hljs-number">18789</span>
</code></pre>
<p><strong>而不是</strong> <code>bind=loopback (127.0.0.1)</code></p>
<hr/>
<h3 data-id="heading-136">然后</h3>
<ol>
<li><strong>重启 FRP</strong></li>
<li><strong>测试外网访问</strong></li>
<li><strong>企业微信后台保存 URL</strong></li>
</ol>
<p>改完告诉我结果！🚀
User: ◇
Service: LaunchAgent (loaded)
File logs: /tmp/openclaw/openclaw-2026-02-04.log
Command: /usr/local/bin/node /Users/dengxiaochao/.nvm/versions/node/v22.12.0/lib/node_modules/openclaw/dist/index.js gateway --port 18789 --bind 0.0.0.0
Service file: ~/Library/LaunchAgents/ai.openclaw.gateway.plist
Service env: OPENCLAW_GATEWAY_PORT=18789</p>
<p>Config (cli): ~/.openclaw/openclaw.json
Config (service): ~/.openclaw/openclaw.json</p>
<p>Gateway: bind=loopback (127.0.0.1), port=18789 (service args)
Probe target: ws://127.0.0.1:18789
Dashboard: <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A18789%2F" target="_blank" title="http://127.0.0.1:18789/" ref="nofollow noopener noreferrer">http://127.0.0.1:18789/</a>
Probe note: Loopback-only gateway; only local clients can connect.</p>
<p>Runtime: running (pid 49313)
Warm-up: launch agents can take a few seconds. Try again shortly.
RPC probe: failed
RPC target: ws://127.0.0.1:18789
gateway closed (1006 abnormal closure (no close frame)): no close reason
Gateway target: ws://127.0.0.1:18789
Source: cli --url
Config: /Users/dengxiaochao/.openclaw/openclaw.json</p>
<p>Gateway port 18789 is not listening (service appears running).
Last gateway error: 2026-02-04T11:35:17.312Z Invalid --bind (use "loopback", "lan", "tailnet", "auto", or "custom")
Logs: ~/.openclaw/logs/gateway.log
Errors: ~/.openclaw/logs/gateway.err.log</p>
<p>Troubles: run openclaw status
Troubleshooting: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.openclaw.ai%2Ftroubleshooting" target="_blank" title="https://docs.openclaw.ai/troubleshooting" ref="nofollow noopener noreferrer">docs.openclaw.ai/troubleshoo…</a>
Kimi: 找到了！错误很清楚 🔍</p>
<hr/>
<h3 data-id="heading-137">问题根源</h3>
<p><strong>OpenClaw 不支持 <code>0.0.0.0</code> 作为 <code>--bind</code> 参数！</strong></p>
<pre><code class="hljs language-perl" lang="perl">Invalid --<span class="hljs-keyword">bind</span> (<span class="hljs-keyword">use</span> <span class="hljs-string">"loopback"</span>, <span class="hljs-string">"lan"</span>, <span class="hljs-string">"tailnet"</span>, <span class="hljs-string">"auto"</span>, <span class="hljs-keyword">or</span> <span class="hljs-string">"custom"</span>)
</code></pre>
<p><strong>有效选项：</strong></p>
<ul>
<li><code>loopback</code> - 仅本地（127.0.0.1）</li>
<li><code>lan</code> - 局域网（所有网卡）</li>
<li><code>tailnet</code> - Tailscale 网络</li>
<li><code>auto</code> - 自动</li>
<li><code>custom</code> - 自定义（需要额外配置）</li>
</ul>
<hr/>
<h3 data-id="heading-138">解决方案：使用 <code>lan</code></h3>
<p>把 <code>0.0.0.0</code> 改成 <code>lan</code>：</p>
<h4 data-id="heading-139">1. 编辑 plist 文件</h4>
<pre><code class="hljs language-bash" lang="bash">nano ~/Library/LaunchAgents/ai.openclaw.gateway.plist
</code></pre>
<h4 data-id="heading-140">2. 修改这段</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/usr/local/bin/node<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/Users/dengxiaochao/.nvm/versions/node/v22.12.0/lib/node_modules/openclaw/dist/index.js<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>gateway<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>--port<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>18789<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>--bind<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>lan<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>    <span class="hljs-comment">&lt;!-- 改成 lan --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span>
</code></pre>
<h4 data-id="heading-141">3. 重启服务</h4>
<pre><code class="hljs language-bash" lang="bash">launchctl unload ~/Library/LaunchAgents/ai.openclaw.gateway.plist
launchctl load ~/Library/LaunchAgents/ai.openclaw.gateway.plist
</code></pre>
<hr/>
<h3 data-id="heading-142">验证</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw gateway status
</code></pre>
<p><strong>应该显示：</strong></p>
<pre><code class="hljs language-ini" lang="ini">Gateway: <span class="hljs-attr">bind</span>=lan, port=<span class="hljs-number">18789</span>
<span class="hljs-comment"># 或类似</span>
Listening: 0.0.0.0:18789
</code></pre>
<hr/>
<h3 data-id="heading-143">然后</h3>
<ol>
<li><strong>重启 FRP</strong></li>
<li><strong>测试</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">curl https://bot.shuqi.run/wecom
</code></pre>
<p>改完告诉我结果！🚀
User: ◒  Checking gateway status...</p>
<p>◇
Service: LaunchAgent (loaded)
File logs: /tmp/openclaw/openclaw-2026-02-04.log
Command: /usr/local/bin/node /Users/dengxiaochao/.nvm/versions/node/v22.12.0/lib/node_modules/openclaw/dist/index.js gateway --port 18789 --bind lan
Service file: ~/Library/LaunchAgents/ai.openclaw.gateway.plist
Service env: OPENCLAW_GATEWAY_PORT=18789</p>
<p>Config (cli): ~/.openclaw/openclaw.json
Config (service): ~/.openclaw/openclaw.json</p>
<p>Gateway: bind=loopback (127.0.0.1), port=18789 (service args)
Probe target: ws://127.0.0.1:18789
Dashboard: <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A18789%2F" target="_blank" title="http://127.0.0.1:18789/" ref="nofollow noopener noreferrer">http://127.0.0.1:18789/</a>
Probe note: Loopback-only gateway; only local clients can connect.</p>
<p>Runtime: running (pid 50924)
RPC probe: ok</p>
<p>Listening: *:18789
Troubles: run openclaw status
Troubleshooting: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.openclaw.ai%2Ftroubleshooting" target="_blank" title="https://docs.openclaw.ai/troubleshooting" ref="nofollow noopener noreferrer">docs.openclaw.ai/troubleshoo…</a>
dengxiaochao@dengxiaochao ~ % curl <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A18789%2Fwecom" target="_blank" title="http://127.0.0.1:18789/wecom" ref="nofollow noopener noreferrer">http://127.0.0.1:18789/wecom</a></p>
<p>Internal Server Error% 为啥
Kimi: 太好了！有进展！🎉</p>
<hr/>
<h3 data-id="heading-144">状态分析</h3>
<p><strong>好消息：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Listening:</span> <span class="hljs-string">*:18789</span>    <span class="hljs-string">←</span> <span class="hljs-string">成功监听所有网卡！</span>
<span class="hljs-attr">RPC probe:</span> <span class="hljs-string">ok</span>         <span class="hljs-string">←</span> <span class="hljs-string">服务运行正常</span>
</code></pre>
<p><strong>问题：</strong></p>
<pre><code class="hljs language-vbscript" lang="vbscript">curl http://<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">18789</span>/wecom 返回 Internal <span class="hljs-built_in">Server</span> <span class="hljs-keyword">Error</span>
</code></pre>
<p>这说明 <strong>OpenClaw 收到了请求，但处理出错了</strong>。</p>
<hr/>
<h3 data-id="heading-145">可能原因</h3>





















<table><thead><tr><th>原因</th><th>说明</th></tr></thead><tbody><tr><td><strong>wecom 插件未启用</strong></td><td>配置里有，但没激活</td></tr><tr><td><strong>配置格式错误</strong></td><td>JSON 配置有问题</td></tr><tr><td><strong>缺少依赖</strong></td><td>插件需要的环境没准备好</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-146">诊断步骤</h3>
<h4 data-id="heading-147">1. 查看详细日志</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 看错误日志</span>
<span class="hljs-built_in">cat</span> ~/.openclaw/logs/gateway.err.log

<span class="hljs-comment"># 或看主日志</span>
<span class="hljs-built_in">cat</span> ~/.openclaw/logs/gateway.log
</code></pre>
<p><strong>把最后几行错误信息贴给我！</strong></p>
<hr/>
<h4 data-id="heading-148">2. 检查 wecom 配置状态</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw config get channels.wecom
</code></pre>
<p><strong>输出是什么？</strong></p>
<hr/>
<h4 data-id="heading-149">3. 确认插件已启用</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw plugins list
</code></pre>
<p><strong>wecom 插件显示 enabled 吗？</strong></p>
<hr/>
<h4 data-id="heading-150">4. 快速修复尝试</h4>
<p>如果配置有问题，重新设置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 重新配置 wecom</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/wecom","token":"lYpiVXyHnrYvKVcD5HMVOM4UK","encodingAESKey":"cySuMkqB6wu3PkLY9hoyT2lELURprMUmaVpAx7OlOOO","receiveId":"","dm":{"policy":"pairing"}}'</span> --json

<span class="hljs-comment"># 重启网关</span>
openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-151">你现在执行</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 看错误日志</span>
<span class="hljs-built_in">tail</span> -20 ~/.openclaw/logs/gateway.err.log

<span class="hljs-comment"># 2. 检查配置</span>
openclaw config get channels.wecom
</code></pre>
<p><strong>把输出给我，我定位问题！</strong> 🔧
User: 2026-02-04T11:41:13.897Z [ws] closed before connect conn=f697974e-225f-465a-a65d-c789465fe470 remote=127.0.0.1 fwd=119.86.128.23 origin=<a href="https://link.juejin.cn?target=https%3A%2F%2Fbot.shuqi.run" target="_blank" title="https://bot.shuqi.run" ref="nofollow noopener noreferrer">bot.shuqi.run</a>  host=bot.shuqi.run ua=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36 code=1008 reason=pairing required
2026-02-04T11:41:21.776Z [ws] Proxy headers detected from untrusted address. Connection will not be treated as local. Configure gateway.trustedProxies to restore local client detection behind your proxy.
2026-02-04T11:41:21.804Z [ws] unauthorized conn=740e4301-6fe7-40e3-9d92-3fceb78c3077 remote=127.0.0.1 client=openclaw-control-ui webchat vdev reason=token_missing
2026-02-04T11:41:21.850Z [ws] closed before connect conn=740e4301-6fe7-40e3-9d92-3fceb78c3077 remote=127.0.0.1 fwd=119.86.128.23 origin=<a href="https://link.juejin.cn?target=https%3A%2F%2Fbot.shuqi.run" target="_blank" title="https://bot.shuqi.run" ref="nofollow noopener noreferrer">bot.shuqi.run</a>  host=bot.shuqi.run ua=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36 code=1008 reason=unauthorized: gateway token missing (open a tokenized dashboard URL or paste token in Control UI settings)
2026-02-04T11:41:30.069Z [plugins] plugin http handler failed (openclaw-plugin-wecom): Error: EncodingAESKey invalid: length must be 43
Kimi: 找到了！错误很清楚 🔍</p>
<hr/>
<h3 data-id="heading-152">问题根源</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Error</span>: <span class="hljs-title class_">EncodingAESKey</span> <span class="hljs-attr">invalid</span>: length must be <span class="hljs-number">43</span>
</code></pre>
<p><strong>你的 EncodingAESKey 长度不对！</strong></p>
<hr/>
<h3 data-id="heading-153">检查你的 Key</h3>
<p>你之前给的：</p>
<pre><code class="hljs">cySuMkqB6wu3PkLY9hoyT2lELURprMUmaVpAx7OlOOO
</code></pre>
<p><strong>数一下字符：</strong></p>
<ul>
<li>c-y-S-u-M-k-q-B-6-w-u-3-P-k-L-Y-9-h-o-y-T-2-l-E-L-U-R-p-r-M-U-m-a-V-p-A-x-7-O-l-O-O-O</li>
<li><strong>实际长度：43？还是 44？</strong></li>
</ul>
<hr/>
<h3 data-id="heading-154">企业微信后台重新生成</h3>
<h4 data-id="heading-155">步骤 1：登录企业微信后台</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwork.weixin.qq.com%2Fwework_admin" target="_blank" title="https://work.weixin.qq.com/wework_admin" ref="nofollow noopener noreferrer">work.weixin.qq.com/wework_admi…</a></p>
<h4 data-id="heading-156">步骤 2：找到接收消息配置</h4>
<ul>
<li>应用管理 → 你的应用 → 接收消息</li>
</ul>
<h4 data-id="heading-157">步骤 3：点击 <strong>"随机生成"</strong> EncodingAESKey</h4>
<p><strong>必须是 43 位！</strong></p>
<h4 data-id="heading-158">步骤 4：复制新的 Key</h4>
<hr/>
<h3 data-id="heading-159">重新配置 OpenClaw</h3>
<p>假设新的 Key 是 <code>新的43位字符</code>：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/wecom","token":"lYpiVXyHnrYvKVcD5HMVOM4UK","encodingAESKey":"新的43位EncodingAESKey","receiveId":"","dm":{"policy":"pairing"}}'</span> --json

openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-160">快速验证 Key 长度</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试你的 Key 长度</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"cySuMkqB6wu3PkLY9hoyT2lELURprMUmaVpAx7OlOOO"</span> | <span class="hljs-built_in">wc</span> -c
</code></pre>
<p><strong>应该输出 43，如果输出 44 或其他，就是多了字符！</strong></p>
<hr/>
<h3 data-id="heading-161">你现在</h3>
<ol>
<li><strong>去企业微信后台重新生成 EncodingAESKey</strong></li>
<li><strong>复制新的 43 位 Key</strong></li>
<li><strong>重新配置 OpenClaw</strong></li>
</ol>
<p><strong>把新的 Key 给我，我帮你生成配置命令！</strong> 🚀
User: 我重新设置了 ，token是 fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD   aeskey是ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL
Kimi: 好的！新的 Token 和 EncodingAESKey 都有了。</p>
<hr/>
<h3 data-id="heading-162">验证长度</h3>




















<table><thead><tr><th>参数</th><th>值</th><th>长度</th></tr></thead><tbody><tr><td>Token</td><td><code>fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD</code></td><td>32 ✓</td></tr><tr><td>EncodingAESKey</td><td><code>ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL</code></td><td><strong>43</strong> ✓</td></tr></tbody></table>
<p>完美！都是正确的长度。</p>
<hr/>
<h3 data-id="heading-163">重新配置 OpenClaw</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/wecom","token":"fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD","encodingAESKey":"ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL","receiveId":"","dm":{"policy":"pairing"}}'</span> --json
</code></pre>
<hr/>
<h3 data-id="heading-164">重启网关</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-165">验证状态</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw channels status
</code></pre>
<hr/>
<h3 data-id="heading-166">企业微信后台更新</h3>





















<table><thead><tr><th>字段</th><th>新值</th></tr></thead><tbody><tr><td><strong>URL</strong></td><td><code>https://bot.shuqi.run/wecom</code></td></tr><tr><td><strong>Token</strong></td><td><code>fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD</code></td></tr><tr><td><strong>EncodingAESKey</strong></td><td><code>ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL</code></td></tr></tbody></table>
<p><strong>记得点击保存！</strong></p>
<hr/>
<h3 data-id="heading-167">测试</h3>
<pre><code class="hljs language-bash" lang="bash">curl https://bot.shuqi.run/wecom
</code></pre>
<p><strong>执行完告诉我结果！</strong> 🚀
User: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsunnoy%2Fopenclaw-plugin-wecom%2Fblob%2Fmain%2FREADME_ZH.md" target="_blank" title="https://github.com/sunnoy/openclaw-plugin-wecom/blob/main/README_ZH.md" ref="nofollow noopener noreferrer">github.com/sunnoy/open…</a>  是按照这样的做嘛你给的命令
Kimi: 是的！我看了这个文档，我们配置的是对的，但有个关键区别：</p>
<hr/>
<h3 data-id="heading-168">文档 vs 我们的配置</h3>



































<table><thead><tr><th>项目</th><th>文档</th><th>我们的配置</th></tr></thead><tbody><tr><td><strong>通道名</strong></td><td><code>wecom</code></td><td><code>wecom</code> ✓</td></tr><tr><td><strong>Token</strong></td><td>文档示例</td><td>你的真实 Token ✓</td></tr><tr><td><strong>EncodingAESKey</strong></td><td>文档示例</td><td>你的真实 Key ✓</td></tr><tr><td><strong>webhookPath</strong></td><td><code>/wecom</code></td><td><code>/wecom</code> ✓</td></tr><tr><td><strong>enabled</strong></td><td><code>true</code></td><td><code>true</code> ✓</td></tr></tbody></table>
<p><strong>我们的配置完全正确！</strong></p>
<hr/>
<h3 data-id="heading-169">文档里的额外信息</h3>
<p>文档还提到可以配置：</p>
<ul>
<li><code>corpId</code> - 企业ID（可选，用于高级功能）</li>
<li><code>corpSecret</code> - 应用密钥（可选）</li>
<li><code>agentId</code> - 应用ID（可选）</li>
</ul>
<p><strong>这些我们现在不需要</strong>，基础功能只需要 Token + EncodingAESKey。</p>
<hr/>
<h3 data-id="heading-170">确认执行</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 配置（已经做了）</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/wecom","token":"fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD","encodingAESKey":"ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL","receiveId":"","dm":{"policy":"pairing"}}'</span> --json

<span class="hljs-comment"># 2. 重启网关</span>
openclaw gateway restart

<span class="hljs-comment"># 3. 验证</span>
openclaw channels status
</code></pre>
<hr/>
<h3 data-id="heading-171">然后测试</h3>
<pre><code class="hljs language-bash" lang="bash">curl https://bot.shuqi.run/wecom
</code></pre>
<p><strong>如果返回的不是 <code>Internal Server Error</code>，就说明成功了！</strong></p>
<hr/>
<h3 data-id="heading-172">文档里的重要提示</h3>
<blockquote>
<p><strong>注意：企业微信要求 URL 能正常访问，否则会保存失败</strong></p>
</blockquote>
<p>所以企业微信后台点击保存时，OpenClaw 必须正在运行，FRP 必须连通。</p>
<p><strong>你现在执行到哪一步了？</strong> 有报错吗？ 🚀
User: Gateway reachable.</p>
<ul>
<li>Enterprise WeChat default: enabled网关可以了，网页也有信息了，为啥Gateway reachable.</li>
<li>Enterprise WeChat default: enabled
Kimi: 太好了！🎉 <strong>配置成功！</strong></li>
</ul>
<hr/>
<h3 data-id="heading-173">状态解读</h3>
<pre><code class="hljs language-arduino" lang="arduino">Gateway reachable.                    ← 网关运行正常
- Enterprise WeChat <span class="hljs-keyword">default</span>: enabled  ← 企业微信通道已启用
</code></pre>
<p><strong>这说明：</strong></p>
<ul>
<li>✅ OpenClaw 运行正常</li>
<li>✅
User: % curl <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A18789%2Fwecom" target="_blank" title="http://127.0.0.1:18789/wecom" ref="nofollow noopener noreferrer">http://127.0.0.1:18789/wecom</a></li>
</ul>
<p>Internal Server Error% 那为啥这里是这样的
Kimi: 太好了！🎉 <strong>企业微信通道已启用！</strong></p>
<hr/>
<h3 data-id="heading-174">为什么 <code>curl</code> 还是 <code>Internal Server Error</code>？</h3>
<p><strong>原因：企业微信的 webhook 需要特殊的请求格式</strong></p>
<p><code>curl http://127.0.0.1:18789/wecom</code> 只是简单的 GET 请求，但企业微信插件期望的是：</p>
<ol>
<li><strong>POST 请求</strong>（不是 GET）</li>
<li><strong>特定的 XML 格式消息体</strong></li>
<li><strong>包含签名验证参数</strong>（<code>msg_signature</code>, <code>timestamp</code>, <code>nonce</code>）</li>
</ol>
<p>所以直接 <code>curl</code> 会报错，这是<strong>正常的</strong>！</p>
<hr/>
<h3 data-id="heading-175">正确的本地测试方式</h3>
<h4 data-id="heading-176">方法 1：模拟企业微信的 POST 请求</h4>
<pre><code class="hljs language-bash" lang="bash">curl -X POST http://127.0.0.1:18789/wecom \
  -H <span class="hljs-string">"Content-Type: text/xml"</span> \
  -d <span class="hljs-string">'&lt;xml&gt;&lt;ToUserName&gt;bot&lt;/ToUserName&gt;&lt;FromUserName&gt;user123&lt;/FromUserName&gt;&lt;CreateTime&gt;123456789&lt;/CreateTime&gt;&lt;MsgType&gt;text&lt;/MsgType&gt;&lt;Content&gt;你好&lt;/Content&gt;&lt;/xml&gt;'</span>
</code></pre>
<h4 data-id="heading-177">方法 2：直接在企业微信里测试</h4>
<p><strong>这是推荐方式！</strong> 配置已经好了，现在去：</p>
<ol>
<li><strong>企业微信后台</strong> → 应用管理 → 你的应用</li>
<li><strong>找到"接收消息"</strong> → 确保 URL 保存成功（显示"请求成功"）</li>
<li><strong>在企业微信 APP 里</strong>找到这个应用</li>
<li><strong>发送消息测试</strong></li>
</ol>
<hr/>
<h3 data-id="heading-178">你现在该做的</h3>
<p><strong>去企业微信后台确认：</strong></p>





















<table><thead><tr><th>检查项</th><th>状态</th></tr></thead><tbody><tr><td>URL 保存成功</td><td>显示"请求成功"或"验证通过"</td></tr><tr><td>Token 一致</td><td><code>fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD</code></td></tr><tr><td>EncodingAESKey 一致</td><td><code>ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL</code></td></tr></tbody></table>
<p><strong>然后去企业微信 APP 发消息测试！</strong></p>
<hr/>
<h3 data-id="heading-179">如果企业微信后台保存失败</h3>
<p>告诉我错误信息，可能是：</p>
<ul>
<li>URL 无法访问（FRP 问题）</li>
<li>Token/Key 不匹配</li>
<li>其他配置问题</li>
</ul>
<p><strong>现在去企业微信后台试试保存，然后告诉我结果！</strong> 🚀
User: 那开启上面的frp那个内网穿透吧
Kimi: 好的！开启 FRP 内网穿透，让企业微信能访问到你的 Mac。</p>
<hr/>
<h3 data-id="heading-180">启动 FRP 客户端</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 执行这个命令启动 FRP</span>
/Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc -c /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml
</code></pre>
<hr/>
<h3 data-id="heading-181">确认 FRP 启动成功</h3>
<p>应该看到类似输出：</p>
<pre><code class="hljs language-ini" lang="ini">2026-02-04 xx:xx:xx <span class="hljs-section">[I]</span> <span class="hljs-section">[client/service.go:327]</span> <span class="hljs-section">[xxxx]</span> login to server success
2026-02-04 xx:xx:xx <span class="hljs-section">[I]</span> <span class="hljs-section">[proxy/proxy_manager.go:180]</span> <span class="hljs-section">[xxxx]</span> proxy added: <span class="hljs-section">[bot]</span>
2026-02-04 xx:xx:xx <span class="hljs-section">[I]</span> <span class="hljs-section">[client/control.go:172]</span> <span class="hljs-section">[xxxx]</span> <span class="hljs-section">[bot]</span> start proxy success
</code></pre>
<p><strong>关键：<code>[bot] start proxy success</code></strong></p>
<hr/>
<h3 data-id="heading-182">验证外网访问</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 新开一个终端，测试外网 URL</span>
curl https://bot.shuqi.run/wecom
</code></pre>
<p><strong>如果 FRP 和 OpenClaw 都正常，应该还是 <code>Internal Server Error</code>（这是正常的，因为缺少 POST 参数）</strong></p>
<hr/>
<h3 data-id="heading-183">然后去企业微信后台测试</h3>
<ol>
<li>打开 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwork.weixin.qq.com%2Fwework_admin" target="_blank" title="https://work.weixin.qq.com/wework_admin" ref="nofollow noopener noreferrer">work.weixin.qq.com/wework_admi…</a></li>
<li>应用管理 → 你的应用 → 接收消息</li>
<li>点击 <strong>"保存"</strong> 或 <strong>"验证"</strong></li>
</ol>
<p><strong>应该显示：请求成功</strong> ✅</p>
<hr/>
<h3 data-id="heading-184">如果 FRP 启动失败</h3>
<p>检查错误：</p>
<ul>
<li><code>connection refused</code> → OpenClaw 没启动</li>
<li><code>login to server failed</code> → FRP 服务器配置问题</li>
</ul>
<p><strong>执行命令后把输出给我！</strong> 🚀
User: dengxiaochao@dengxiaochao ~ % /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc -c /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml</p>
<p>2026-02-04 19:55:58.988 [I] [sub/root.go:159] start frpc service for config file [/Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml]
2026-02-04 19:55:58.989 [I] [client/service.go:335] try to connect to server...
2026-02-04 19:55:59.053 [I] [client/service.go:327] [8c811ae26837fbc1] login to server success, get run id [8c811ae26837fbc1]
2026-02-04 19:55:59.053 [I] [proxy/proxy_manager.go:180] [8c811ae26837fbc1] proxy added: [bot]
2026-02-04 19:55:59.074 [I] [client/control.go:172] [8c811ae26837fbc1] [bot] start proxy success curl <a href="https://link.juejin.cn?target=https%3A%2F%2Fbot.shuqi.run%2Fwecom" target="_blank" title="https://bot.shuqi.run/wecom" ref="nofollow noopener noreferrer">bot.shuqi.run/wecom</a>  这个不行，但是curl <a href="https://link.juejin.cn?target=https%3A%2F%2Fbot.shuqi.run" target="_blank" title="https://bot.shuqi.run" ref="nofollow noopener noreferrer">bot.shuqi.run</a> 这个就返回了很多信息
Kimi: 太好了！🎉 FRP 启动成功！</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">bot</span>] start proxy success
</code></pre>
<hr/>
<h3 data-id="heading-185">问题分析</h3>




















<table><thead><tr><th>请求</th><th>结果</th><th>说明</th></tr></thead><tbody><tr><td><code>curl https://bot.shuqi.run</code></td><td>✅ 返回很多信息</td><td>FRP + OpenClaw 正常</td></tr><tr><td><code>curl https://bot.shuqi.run/wecom</code></td><td>❌ 不行</td><td>路径问题或插件问题</td></tr></tbody></table>
<p><strong><code>/</code> 能访问，<code>/wecom</code> 不能访问</strong>，说明：</p>
<ol>
<li><strong>FRP 配置可能只代理了根路径 <code>/</code></strong></li>
<li><strong>或者 wecom 插件的 webhookPath 配置不匹配</strong></li>
</ol>
<hr/>
<h3 data-id="heading-186">检查 FRP 配置</h3>
<p>看看你的 <code>frpc.toml</code> 文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml
</code></pre>
<p><strong>关键看 <code>custom_domains</code> 和 <code>locations</code> 配置</strong></p>
<p>应该是类似这样：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[[proxies]]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"bot"</span>
<span class="hljs-attr">type</span> = <span class="hljs-string">"http"</span>
<span class="hljs-attr">localPort</span> = <span class="hljs-number">18789</span>
<span class="hljs-attr">customDomains</span> = [<span class="hljs-string">"bot.shuqi.run"</span>]
<span class="hljs-comment"># 注意：有没有 locations 配置？</span>
</code></pre>
<hr/>
<h3 data-id="heading-187">可能的解决方案</h3>
<h4 data-id="heading-188">方案 1：FRP 配置添加路径（如果支持）</h4>
<p>如果 <code>frpc.toml</code> 有 <code>locations</code>，改成：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-attr">locations</span> = [<span class="hljs-string">"/"</span>, <span class="hljs-string">"/wecom"</span>]
</code></pre>
<h4 data-id="heading-189">方案 2：修改 OpenClaw webhookPath 为根路径</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 把 wecom 的 webhookPath 改成 /</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/","token":"fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD","encodingAESKey":"ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL","receiveId":"","dm":{"policy":"pairing"}}'</span> --json

openclaw gateway restart
</code></pre>
<p>然后企业微信后台 URL 填：<code>https://bot.shuqi.run</code></p>
<hr/>
<h3 data-id="heading-190">你现在执行</h3>
<p><strong>第一步：查看 FRP 配置</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml
</code></pre>
<p><strong>把内容贴给我</strong>，我看怎么改！🔧
User: cat /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml</p>
<h2 data-id="heading-191">我是配置文件，请将我全部复制到 frpc.toml !</h2>
<p>serverAddr = "122.9.157.124"
serverPort = 7000
auth.method = "token"
auth.token = "60d8a83c544e6168db"
#user = "2026th02U03v224515bg"
#metadatas.token = "hsidc123"</p>
<p>[[proxies]]
name = "bot" # 应用名，必须唯一，但你可以随便填写
type = "tcp"
localIP = "127.0.0.1" # 本地IP，本机就填写127.0.0.1、局域网其它机器就填 192.168.x.x 的内网IP
localPort = 18789 # 本地端口号，例如飞牛NAS此处填写5666
remotePort = 10981  # 服务器远程端口号，端口范围: [10981-10990] 随便挑一个就行</p>
<h2 data-id="heading-192">启动 frpc 后，可以通过 <a href="https://link.juejin.cn?target=http%3A%2F%2F114.66.55.23%3A10981" target="_blank" title="http://114.66.55.23:10981" ref="nofollow noopener noreferrer">http://114.66.55.23:10981</a>  进行访问</h2>
<h2 data-id="heading-193">可以将你的域名 DNS 记录解析至 114.66.55.23</h2>
<h2 data-id="heading-194">这样就能通过: <a href="https://link.juejin.cn?target=http%3A%2F%2F%25E4%25BD%25A0%25E7%259A%2584%25E5%259F%259F%25E5%2590%258D%3A10981" target="_blank" title="http://%E4%BD%A0%E7%9A%84%E5%9F%9F%E5%90%8D:10981" ref="nofollow noopener noreferrer">http://你的域名:10981</a> 进行访问</h2>
<h2 data-id="heading-195">如果你想配置第二个应用如下所示，把 # 注释打开就行，第三个应用同理</h2>
<p>#[[proxies]]
#name = "my_app02"
#type = "tcp"
#localIP = "127.0.0.1"
#localPort = 80
#remotePort = 18789%
Kimi: 找到了！🔍</p>
<p><strong>问题：FRP 用的是 <code>type = "tcp"</code>，不是 <code>http</code>！</strong></p>
<p>TCP 模式只转发端口，不支持 HTTP 路径（<code>/wecom</code>），所以：</p>
<ul>
<li><code>https://bot.shuqi.run</code> 能访问（可能是 nginx 做了默认转发）</li>
<li><code>https://bot.shuqi.run/wecom</code> 不行（路径没正确转发）</li>
</ul>
<hr/>
<h3 data-id="heading-196">解决方案：改成 HTTP 模式</h3>
<h4 data-id="heading-197">修改 frpc.toml</h4>
<pre><code class="hljs language-bash" lang="bash">nano /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml
</code></pre>
<p><strong>改成这样：</strong></p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-attr">serverAddr</span> = <span class="hljs-string">"122.9.157.124"</span>
<span class="hljs-attr">serverPort</span> = <span class="hljs-number">7000</span>
<span class="hljs-attr">auth.method</span> = <span class="hljs-string">"token"</span>
<span class="hljs-attr">auth.token</span> = <span class="hljs-string">"60d8a83c544e6168db"</span>

<span class="hljs-section">[[proxies]]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"bot"</span>
<span class="hljs-attr">type</span> = <span class="hljs-string">"http"</span>                    <span class="hljs-comment"># 改成 http</span>
<span class="hljs-attr">localIP</span> = <span class="hljs-string">"127.0.0.1"</span>
<span class="hljs-attr">localPort</span> = <span class="hljs-number">18789</span>
<span class="hljs-attr">customDomains</span> = [<span class="hljs-string">"bot.shuqi.run"</span>]  <span class="hljs-comment"># 你的域名</span>
<span class="hljs-comment"># remotePort 不需要，http 模式用域名访问</span>
</code></pre>
<hr/>
<h3 data-id="heading-198">重启 FRP</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 停止之前的 frpc（Ctrl+C）</span>

<span class="hljs-comment"># 2. 重新启动</span>
/Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc -c /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml
</code></pre>
<hr/>
<h3 data-id="heading-199">验证</h3>
<pre><code class="hljs language-bash" lang="bash">curl https://bot.shuqi.run/wecom
</code></pre>
<p><strong>应该能访问了！</strong></p>
<hr/>
<h3 data-id="heading-200">如果服务器端不支持 HTTP 模式</h3>
<p>可能 FRP 服务器只开了 TCP，那需要联系服务器管理员，或者：</p>
<p><strong>方案 B：用 TCP 模式 + 修改 OpenClaw 路径为根</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 把 webhookPath 改成 /</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/","token":"fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD","encodingAESKey":"ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL","receiveId":"","dm":{"policy":"pairing"}}'</span> --json

openclaw gateway restart
</code></pre>
<p>然后企业微信后台 URL 填：<code>http://bot.shuqi.run:10981</code>（注意是 10981 端口）</p>
<hr/>
<h3 data-id="heading-201">先试试方案 A（改 HTTP 模式）</h3>
<p><strong>修改 frpc.toml 后重启 FRP，然后测试！</strong></p>
<p>有问题告诉我！🚀
User: curl <a href="https://link.juejin.cn?target=https%3A%2F%2Fbot.shuqi.run%2Fwecom" target="_blank" title="https://bot.shuqi.run/wecom" ref="nofollow noopener noreferrer">bot.shuqi.run/wecom</a></p>

502 Bad Gateway

<h2 data-id="heading-202">502 Bad Gateway</h2>
<hr/>nginx

 我试了为啥返回这个
Kimi: 502 Bad Gateway 说明 FRP 的 HTTP 模式连接失败了。
<hr/>
<h3 data-id="heading-203">可能原因</h3>





















<table><thead><tr><th>原因</th><th>说明</th></tr></thead><tbody><tr><td><strong>FRP 服务器端没开 HTTP 支持</strong></td><td>服务器只配置了 TCP 端口</td></tr><tr><td><strong>域名解析问题</strong></td><td><code>bot.shuqi.run</code> 没指向 FRP 服务器</td></tr><tr><td><strong>FRP 客户端连接失败</strong></td><td>HTTP 模式连不上服务器</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-204">快速解决方案：用回 TCP 模式 + 指定端口</h3>
<p>你的 FRP 服务器只支持 TCP，那就用 TCP 模式，<strong>但企业微信要填带端口的 URL</strong>。</p>
<h4 data-id="heading-205">步骤 1：改回 TCP 配置</h4>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-attr">serverAddr</span> = <span class="hljs-string">"122.9.157.124"</span>
<span class="hljs-attr">serverPort</span> = <span class="hljs-number">7000</span>
<span class="hljs-attr">auth.method</span> = <span class="hljs-string">"token"</span>
<span class="hljs-attr">auth.token</span> = <span class="hljs-string">"60d8a83c544e6168db"</span>

<span class="hljs-section">[[proxies]]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"bot"</span>
<span class="hljs-attr">type</span> = <span class="hljs-string">"tcp"</span>
<span class="hljs-attr">localIP</span> = <span class="hljs-string">"127.0.0.1"</span>
<span class="hljs-attr">localPort</span> = <span class="hljs-number">18789</span>
<span class="hljs-attr">remotePort</span> = <span class="hljs-number">10981</span>
</code></pre>
<h4 data-id="heading-206">步骤 2：重启 FRP</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 停止后重新启动</span>
/Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc -c /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml
</code></pre>
<h4 data-id="heading-207">步骤 3：修改 OpenClaw 的 webhookPath 为根路径</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/","token":"fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD","encodingAESKey":"ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL","receiveId":"","dm":{"policy":"pairing"}}'</span> --json

openclaw gateway restart
</code></pre>
<h4 data-id="heading-208">步骤 4：企业微信后台填写带端口的 URL</h4>





















<table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td><strong>URL</strong></td><td><code>http://122.9.157.124:10981</code></td></tr><tr><td><strong>Token</strong></td><td><code>fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD</code></td></tr><tr><td><strong>EncodingAESKey</strong></td><td><code>ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL</code></td></tr></tbody></table>
<p><strong>注意：是 HTTP 不是 HTTPS，且带 10981 端口！</strong></p>
<hr/>
<h3 data-id="heading-209">验证</h3>
<pre><code class="hljs language-bash" lang="bash">curl http://122.9.157.124:10981
</code></pre>
<p><strong>应该能返回 OpenClaw 的信息了！</strong></p>
<hr/>
<h3 data-id="heading-210">如果要用域名（bot.shuqi.run）</h3>
<p>需要服务器管理员配置 nginx 转发：</p>
<pre><code class="hljs language-arduino" lang="arduino">bot.shuqi.run → <span class="hljs-number">122.9</span><span class="hljs-number">.157</span><span class="hljs-number">.124</span>:<span class="hljs-number">10981</span>
</code></pre>
<p>这个你控制不了，<strong>先用 IP:端口 测试！</strong></p>
<hr/>
<h3 data-id="heading-211">你现在执行</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 改配置</span>
nano /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml
<span class="hljs-comment"># 确认是 tcp 模式，remotePort = 10981</span>

<span class="hljs-comment"># 2. 重启 FRP</span>
/Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc -c /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml

<span class="hljs-comment"># 3. 改 OpenClaw 配置</span>
openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/","token":"fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD","encodingAESKey":"ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL","receiveId":"","dm":{"policy":"pairing"}}'</span> --json
openclaw gateway restart

<span class="hljs-comment"># 4. 测试</span>
curl http://122.9.157.124:10981
</code></pre>
<p><strong>执行完告诉我结果！</strong> 🚀
User: % curl <a href="https://link.juejin.cn?target=http%3A%2F%2F122.9.157.124%3A10981" target="_blank" title="http://122.9.157.124:10981" ref="nofollow noopener noreferrer">http://122.9.157.124:10981</a>
curl: (28) Failed to connect to 122.9.157.124 port 10981 after 17220 ms: Couldn't connect to server
dengxiaochao@dengxiaochao ~ % curl <a href="https://link.juejin.cn?target=https%3A%2F%2Fbot.shuqi.run" target="_blank" title="https://bot.shuqi.run" ref="nofollow noopener noreferrer">bot.shuqi.run</a>  第二个curl返回信息
Kimi: 明白了！🔍</p>
<p><strong>情况：</strong></p>
<ul>
<li><code>122.9.157.124:10981</code> 连不上（端口没开或防火墙）</li>
<li><code>https://bot.shuqi.run</code> 能访问（走 nginx 的 80/443 端口）</li>
</ul>
<p><strong>说明 FRP 服务器端只开放了 80/443 端口，10981 端口没对外开放！</strong></p>
<hr/>
<h3 data-id="heading-212">解决方案：用 nginx 转发（服务器端配置）</h3>
<p>需要服务器管理员在 <code>122.9.157.124</code> 上配置 nginx，把 <code>bot.shuqi.run</code> 转发到本地的 10981 端口。</p>
<p><strong>但你控制不了服务器...</strong></p>
<hr/>
<h3 data-id="heading-213">替代方案：用 OpenClaw 的 Cloud 模式</h3>
<p>如果本地穿透太麻烦，可以试试 OpenClaw 的 <strong>Cloud 托管</strong> 或 <strong>Tailscale</strong> 模式。</p>
<h4 data-id="heading-214">检查 OpenClaw 其他绑定选项</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看支持的模式</span>
openclaw gateway start --<span class="hljs-built_in">help</span>
</code></pre>
<hr/>
<h3 data-id="heading-215">最简单的方案：用 ngrok（之前成功的）</h3>
<p>既然 <code>https://bot.shuqi.run</code> 能访问，但路径有问题，<strong>不如先用 ngrok 测试</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 启动 ngrok</span>
ngrok http 18789

<span class="hljs-comment"># 2. 获得 https 地址（如 https://abc123.ngrok-free.app）</span>

<span class="hljs-comment"># 3. 企业微信后台填</span>
<span class="hljs-comment"># URL: https://abc123.ngrok-free.app/wecom</span>
</code></pre>
<p><strong>ngrok 的 HTTP 模式支持路径，而且 HTTPS 证书是有效的！</strong></p>
<hr/>
<h3 data-id="heading-216">你现在选哪个？</h3>



































<table><thead><tr><th>方案</th><th>难度</th><th>时间</th></tr></thead><tbody><tr><td>A. 联系服务器管理员开 10981 端口或配 nginx</td><td>⭐⭐⭐ 难</td><td>不确定</td></tr><tr><td>B. 用 ngrok 临时测试</td><td>⭐ 简单</td><td>立刻可用</td></tr><tr><td>C. 检查 OpenClaw cloud/tailnet 模式</td><td>⭐⭐ 中等</td><td/></tr><tr><td>User: 我就是管理员我全权控制的</td><td/><td/></tr><tr><td>Kimi: 太好了！你是管理员，那我们可以彻底解决这个问题！</td><td/><td/></tr></tbody></table>
<hr/>
<h3 data-id="heading-217">问题分析</h3>

















<table><thead><tr><th>现象</th><th>说明</th></tr></thead><tbody><tr><td><code>curl https://bot.shuqi.run</code> ✅ 有返回</td><td>nginx + FRP 正常</td></tr><tr><td><code>curl http://122.9.157.124:10981</code> ❌ 连不上</td><td>服务器 10981 端口没开或 FRP 没连上</td></tr></tbody></table>
<p><strong>说明 FRP 的 TCP 模式没成功，但 HTTP 模式之前是通的（只是 502）</strong></p>
<hr/>
<h3 data-id="heading-218">最佳方案：服务器端开 HTTP 支持 + nginx 转发</h3>
<h4 data-id="heading-219">步骤 1：服务器端配置 frps.toml</h4>
<p>在你的服务器（122.9.157.124）上：</p>
<pre><code class="hljs language-bash" lang="bash">nano /path/to/frps.toml
</code></pre>
<p>确保有：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-attr">bindPort</span> = <span class="hljs-number">7000</span>
<span class="hljs-attr">vhostHTTPPort</span> = <span class="hljs-number">80</span>      <span class="hljs-comment"># HTTP 虚拟主机端口</span>
<span class="hljs-comment"># 或者</span>
<span class="hljs-attr">vhostHTTPSPort</span> = <span class="hljs-number">443</span>    <span class="hljs-comment"># HTTPS 虚拟主机端口（如果用 HTTPS）</span>
</code></pre>
<h4 data-id="heading-220">步骤 2：重启 FRP 服务器</h4>
<pre><code class="hljs language-bash" lang="bash">systemctl restart frps
<span class="hljs-comment"># 或</span>
./frps -c frps.toml
</code></pre>
<h4 data-id="heading-221">步骤 3：客户端改回 HTTP 模式</h4>
<p>在你的 Mac 上：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-attr">serverAddr</span> = <span class="hljs-string">"122.9.157.124"</span>
<span class="hljs-attr">serverPort</span> = <span class="hljs-number">7000</span>
<span class="hljs-attr">auth.method</span> = <span class="hljs-string">"token"</span>
<span class="hljs-attr">auth.token</span> = <span class="hljs-string">"60d8a83c544e6168db"</span>

<span class="hljs-section">[[proxies]]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"bot"</span>
<span class="hljs-attr">type</span> = <span class="hljs-string">"http"</span>
<span class="hljs-attr">localIP</span> = <span class="hljs-string">"127.0.0.1"</span>
<span class="hljs-attr">localPort</span> = <span class="hljs-number">18789</span>
<span class="hljs-attr">customDomains</span> = [<span class="hljs-string">"bot.shuqi.run"</span>]
</code></pre>
<h4 data-id="heading-222">步骤 4：重启客户端 FRP</h4>
<pre><code class="hljs language-bash" lang="bash">/Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc -c /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml
</code></pre>
<h4 data-id="heading-223">步骤 5：nginx 配置（如果要用 HTTPS）</h4>
<p>在服务器上：</p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen 443 ssl;
    server_name bot.shuqi.run;
  
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
  
    location / {
        proxy_pass http://127.0.0.1:80;  # 转发到 FRP 的 vhostHTTPPort
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-224">快速验证步骤</h3>
<p><strong>服务器端执行：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查 FRP 服务器是否开了 HTTP 支持</span>
netstat -tlnp | grep frps
<span class="hljs-comment"># 应该看到 :80 或 :443</span>
</code></pre>
<p><strong>客户端执行：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 重启 FRP HTTP 模式</span>
/Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc -c /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64/frpc.toml
</code></pre>
<p><strong>测试：</strong></p>
<pre><code class="hljs language-bash" lang="bash">curl https://bot.shuqi.run/wecom
</code></pre>
<hr/>
<h3 data-id="heading-225">你现在检查</h3>
<p><strong>在服务器上执行：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /path/to/frps.toml
netstat -tlnp | grep frp
</code></pre>
<p><strong>把 FRP 服务器的配置贴给我！</strong> 🔧
User: dengxiaochao@dengxiaochao Downloads % ls
Clash.Verge_2.4.5_x64.dmg		ddns-go_6.15.0_darwin_x86_64 2
ToDesk					ddns-go_6.15.0_darwin_x86_64.tar.gz
ddns-go_6.15.0_darwin_arm64		frp_0.67.0_darwin_amd64
ddns-go_6.15.0_darwin_arm64.tar.gz	frp_0.67.0_darwin_amd64.tar.gz
ddns-go_6.15.0_darwin_x86_64		node-v22.2.0.pkg
dengxiaochao@dengxiaochao Downloads % cd frp_0.67.0_darwin_amd64
dengxiaochao@dengxiaochao frp_0.67.0_darwin_amd64 % ls
LICENSE		frpc		frpc.toml	frps		frps.toml
Kimi: 太好了！你本地有 <code>frps</code> 和 <code>frps.toml</code>，说明 FRP 服务器端也在你 Mac 上？还是只是客户端工具？</p>
<hr/>
<h3 data-id="heading-226">确认服务器位置</h3>
<p><strong>122.9.157.124 这个 IP 是什么？</strong></p>
<ul>
<li>你的 Mac 公网 IP？</li>
<li>云服务器 IP？</li>
<li>还是其他设备？</li>
</ul>
<hr/>
<h3 data-id="heading-227">如果是云服务器（122.9.157.124）</h3>
<p>需要 SSH 登录到那台服务器，修改它的 <code>frps.toml</code>：</p>
<pre><code class="hljs language-bash" lang="bash">ssh root@122.9.157.124
<span class="hljs-comment"># 然后</span>
<span class="hljs-built_in">cat</span> /path/to/frps.toml
</code></pre>
<hr/>
<h3 data-id="heading-228">如果服务器端也在你 Mac 上（测试用）</h3>
<p>那需要启动 <code>frps</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /Users/dengxiaochao/Downloads/frp_0.67.0_darwin_amd64
User: 服务器端也在你 Mac   122.9.157.124是公网ip 他拉的宽带
Kimi: 明白了！**FRP 服务器端也在你的 Mac 上**，`122.9.157.124` 是公网 IP。

这意味着：
- **frps**（服务端）在你的 Mac 运行
- **frpc**（客户端）也在你的 Mac 运行
- 公网 IP 是宽带拨号获取的

---

<span class="hljs-comment">## 快速解决方案：不用 FRP，直接用公网 IP</span>

如果你的 Mac 有公网 IP（122.9.157.124），**直接让 OpenClaw 监听公网**：

<span class="hljs-comment">### 步骤 1：停止 FRP（不需要了）</span>

```bash
<span class="hljs-comment"># 停止 frpc 和 frps（Ctrl+C 或杀掉进程）</span>
pkill frpc
pkill frps
</code></pre>
<h4 data-id="heading-229">步骤 2：OpenClaw 绑定公网 IP</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看当前绑定</span>
openclaw config get gateway.bind

<span class="hljs-comment"># 改成公网 IP</span>
openclaw config <span class="hljs-built_in">set</span> gateway.bind <span class="hljs-string">"122.9.157.124"</span>
openclaw config <span class="hljs-built_in">set</span> gateway.port 18789

<span class="hljs-comment"># 重启</span>
openclaw gateway restart
</code></pre>
<h4 data-id="heading-230">步骤 3：路由器做端口映射</h4>
<p>在你的路由器后台：</p>
<ul>
<li><strong>外网端口</strong>：80 或 443 或 18789</li>
<li><strong>内网 IP</strong>：你的 Mac 内网 IP（如 192.168.1.xxx）</li>
<li><strong>内网端口</strong>：18789</li>
</ul>
<h4 data-id="heading-231">步骤 4：企业微信后台填写</h4>





















<table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td><strong>URL</strong></td><td><code>http://122.9.157.124:18789/wecom</code> 或 <code>http://你的域名:18789/wecom</code></td></tr><tr><td><strong>Token</strong></td><td><code>fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD</code></td></tr><tr><td><strong>EncodingAESKey</strong></td><td><code>ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-232">如果要用 FRP（保持现有架构）</h3>
<p>那需要 <strong>frps 在公网服务器上运行</strong>，但现在都在你的 Mac，没有意义。</p>
<hr/>
<h3 data-id="heading-233">推荐：直接用公网 IP</h3>
<p><strong>你现在执行：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 停掉 FRP</span>
pkill frpc frps

<span class="hljs-comment"># 2. OpenClaw 绑定公网 IP</span>
openclaw config <span class="hljs-built_in">set</span> gateway.bind <span class="hljs-string">"122.9.157.124"</span>
openclaw gateway restart

<span class="hljs-comment"># 3. 验证</span>
openclaw gateway status
curl http://122.9.157.124:18789/wecom
</code></pre>
<p><strong>然后告诉我结果！</strong> 🔧
User: <code>&lt;h1&gt;</code>抱歉！该站点已经被管理员停止运行，请联系管理员了解详情！<code>&lt;/h1&gt;</code></p>



dengxiaochao@dengxiaochao frp_0.67.0_darwin_amd64 % ssh root@122.9.157.124
<p>dengxiaochao@dengxiaochao frp_0.67.0_darwin_amd64 % ssh root@122.9.157.124</p>
<p>dengxiaochao@dengxiaochao frp_0.67.0_darwin_amd64 % ssh root@122.9.157.124</p>
<p>The authenticity of host '122.9.157.124 (122.9.157.124)' can't be established.
ED25519 key fingerprint is SHA256:uQ44A4ybXd00RPq0n1be8lz6Nlo9ADrJNC8vve2MLeU.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])?  上面那个是我直接curl ip的
Kimi: 明白了！<code>122.9.157.124</code> 这个 IP 不是你的 Mac，是<strong>另一台云服务器</strong>（可能是租的 VPS）。</p>
<p><strong>"该站点已经被管理员停止运行"</strong> 说明这个服务器上之前跑了 frps，但现在停了。</p>
<hr/>
<h3 data-id="heading-234">情况梳理</h3>

























<table><thead><tr><th>组件</th><th>位置</th><th>状态</th></tr></thead><tbody><tr><td><strong>OpenClaw</strong></td><td>你的 Mac</td><td>✅ 运行中</td></tr><tr><td><strong>FRP 客户端 (frpc)</strong></td><td>你的 Mac</td><td>需要连接服务器</td></tr><tr><td><strong>FRP 服务器 (frps)</strong></td><td>122.9.157.124 (云服务器)</td><td>❌ 已停止</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-235">解决方案：启动云服务器上的 frps</h3>
<h4 data-id="heading-236">步骤 1：SSH 登录云服务器</h4>
<pre><code class="hljs language-bash" lang="bash">ssh root@122.9.157.124
<span class="hljs-comment"># 输入 yes 确认指纹</span>
<span class="hljs-comment"># 然后输入密码</span>
</code></pre>
<h4 data-id="heading-237">步骤 2：启动 frps</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 找到 frps 目录</span>
<span class="hljs-built_in">cd</span> /path/to/frp
<span class="hljs-comment"># 或</span>
<span class="hljs-built_in">which</span> frps

<span class="hljs-comment"># 启动</span>
./frps -c frps.toml
</code></pre>
<h4 data-id="heading-238">步骤 3：检查 frps 配置</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> frps.toml
</code></pre>
<p>确保有：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-attr">bindPort</span> = <span class="hljs-number">7000</span>
<span class="hljs-attr">vhostHTTPPort</span> = <span class="hljs-number">80</span>
<span class="hljs-comment"># 或</span>
<span class="hljs-attr">vhostHTTPSPort</span> = <span class="hljs-number">443</span>
</code></pre>
<hr/>
<h3 data-id="heading-239">如果云服务器没装 FRP</h3>
<p>需要上传安装：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在你的 Mac 上，上传 FRP 到服务器</span>
scp -r frp_0.67.0_darwin_amd64 root@122.9.157.124:/root/

<span class="hljs-comment"># 注意：服务器可能是 Linux，需要下载 Linux 版本</span>
<span class="hljs-comment"># https://github.com/fatedier/frp/releases</span>
</code></pre>
<hr/>
<h3 data-id="heading-240">你现在执行</h3>
<p><strong>第一步：SSH 登录</strong></p>
<pre><code class="hljs language-bash" lang="bash">ssh root@122.9.157.124
</code></pre>
<p><strong>能登录吗？登录后执行：</strong></p>
<pre><code class="hljs language-bash" lang="bash">ps aux | grep frp
<span class="hljs-built_in">cat</span> /root/frps.toml 2&gt;/dev/null || <span class="hljs-built_in">cat</span> /etc/frp/frps.toml 2&gt;/dev/null
</code></pre>
<p><strong>把结果给我！</strong> 🔧
User: 不行要密码 不知道 那怎么办
Kimi: 明白了！没有云服务器密码，无法启动 FRP 服务端。</p>
<hr/>
<h3 data-id="heading-241">替代方案：不用 FRP，直接用 ngrok（免费）</h3>
<p>之前你装过 ngrok，用这个最简单！</p>
<h4 data-id="heading-242">步骤 1：启动 ngrok</h4>
<pre><code class="hljs language-bash" lang="bash">ngrok http 18789
</code></pre>
<h4 data-id="heading-243">步骤 2：获取公网 URL</h4>
<p>会显示：</p>
<pre><code class="hljs language-bash" lang="bash">Forwarding  https://abc123-def456.ngrok-free.app -&gt; http://localhost:18789
</code></pre>
<h4 data-id="heading-244">步骤 3：企业微信后台填写</h4>





















<table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td><strong>URL</strong></td><td><code>https://abc123-def456.ngrok-free.app/wecom</code></td></tr><tr><td><strong>Token</strong></td><td><code>fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD</code></td></tr><tr><td><strong>EncodingAESKey</strong></td><td><code>ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-245">或者：尝试找回服务器密码</h3>
<p>联系服务器提供商（阿里云/腾讯云/其他）：</p>
<ul>
<li>控制台重置密码</li>
<li>或者查看购买时的邮件</li>
</ul>
<hr/>
<h3 data-id="heading-246">推荐：先用 ngrok 测试</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 确保 OpenClaw 运行</span>
openclaw gateway status

<span class="hljs-comment"># 2. 启动 ngrok</span>
ngrok http 18789

<span class="hljs-comment"># 3. 复制 https 地址，填到企业微信后台</span>
</code></pre>
<p><strong>ngrok 启动后把 URL 给我！</strong> 🚀
User: ngrok怎么弄来的
Kimi: 之前你装过 ngrok，用 Homebrew 安装的：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查是否已安装</span>
<span class="hljs-built_in">which</span> ngrok

<span class="hljs-comment"># 或</span>
ngrok --version
</code></pre>
<hr/>
<h3 data-id="heading-247">如果已安装，直接启动</h3>
<pre><code class="hljs language-bash" lang="bash">ngrok http 18789
</code></pre>
<hr/>
<h3 data-id="heading-248">如果提示未安装，重新装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 用 Homebrew 安装</span>
brew install ngrok

<span class="hljs-comment"># 配置 token（之前注册过）</span>
ngrok config add-authtoken 你的_token
</code></pre>
<hr/>
<h3 data-id="heading-249">如果忘记 token</h3>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdashboard.ngrok.com" target="_blank" title="https://dashboard.ngrok.com" ref="nofollow noopener noreferrer">dashboard.ngrok.com</a></li>
<li>用 GitHub/Google/邮箱登录</li>
<li>复制 Authtoken</li>
</ol>
<hr/>
<h3 data-id="heading-250">你现在执行</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 先检查</span>
ngrok --version

<span class="hljs-comment"># 如果显示版本号，直接启动</span>
ngrok http 18789
</code></pre>
<p><strong>执行后把显示的 Forwarding URL 给我！</strong> 🚀
User: ao frp_0.67.0_darwin_amd64 % brew install ngrok</p>
<p>zsh: command not found: brew 真服了他这mac电脑
Kimi: 明白了！这台 Mac 没有 Homebrew，那我们用其他方式安装 ngrok。</p>
<hr/>
<h3 data-id="heading-251">方案 1：直接下载 ngrok</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载 ngrok（Mac Intel 版本）</span>
curl -O https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-darwin-amd64.zip

<span class="hljs-comment"># 解压</span>
unzip ngrok-v3-stable-darwin-amd64.zip

<span class="hljs-comment"># 移动到可执行目录</span>
<span class="hljs-built_in">mv</span> ngrok /usr/local/bin/
</code></pre>
<hr/>
<h3 data-id="heading-252">方案 2：如果 curl 下载慢，用浏览器下载</h3>
<ol>
<li>打开 <a href="https://link.juejin.cn?target=https%3A%2F%2Fngrok.com%2Fdownload" target="_blank" title="https://ngrok.com/download" ref="nofollow noopener noreferrer">ngrok.com/download</a></li>
<li>下载 <strong>Mac OS (Intel)</strong> 版本</li>
<li>解压后得到 <code>ngrok</code> 文件</li>
<li>在终端执行：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入下载目录</span>
<span class="hljs-built_in">cd</span> ~/Downloads

<span class="hljs-comment"># 赋予执行权限</span>
<span class="hljs-built_in">chmod</span> +x ngrok

<span class="hljs-comment"># 移动到系统路径</span>
sudo <span class="hljs-built_in">mv</span> ngrok /usr/local/bin/
</code></pre>
<hr/>
<h3 data-id="heading-253">配置 token</h3>
<p>去 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdashboard.ngrok.com" target="_blank" title="https://dashboard.ngrok.com" ref="nofollow noopener noreferrer">dashboard.ngrok.com</a> 获取你的 Authtoken，然后：</p>
<pre><code class="hljs language-bash" lang="bash">ngrok config add-authtoken 2KxZ你的token这里
</code></pre>
<hr/>
<h3 data-id="heading-254">你现在执行</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 先试试直接下载</span>
curl -O https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-darwin-amd64.zip

<span class="hljs-comment"># 如果下载成功</span>
unzip ngrok-v3-stable-darwin-amd64.zip
./ngrok --version
</code></pre>
<p><strong>如果下载失败，告诉我，我们用浏览器下载方式！</strong> 🔧
User: 他这个frp这种方式在mac上进行内网穿透真的不行嘛
Kimi: 用户问 FRP 在 Mac 上真的不行吗？其实不是不行，而是需要 FRP 服务器端（frps）运行在<strong>有公网 IP 的服务器上</strong>，而用户的云服务器（122.9.157.124）已经停止服务了，且没有密码无法登录。</p>
<p>让我总结一下当前情况和可行方案。FRP 本身完全可以运行在 Mac 上，但问题是：</p>
<ol>
<li>FRP 需要服务端（frps）在公网服务器上</li>
<li>用户的云服务器 122.9.157.124 已经停止，且没有 root 密码</li>
<li>用户的 Mac 没有公网 IP（虽然有 122.9.157.124 这个 IP，但 curl 显示是"站点已停止"，说明这是云服务器不是 Mac 本地）</li>
</ol>
<p>所以 FRP 方案目前不可行，因为没有可用的公网服务器来跑 frps。</p>
<p>我应该：</p>
<ol>
<li>解释清楚为什么 FRP 现在不行（缺少 frps 服务器）</li>
<li>确认用户的 Mac 网络环境（到底有没有公网 IP）</li>
<li>提供可行的替代方案（ngrok、花生壳、或其他内网穿透）</li>
<li>如果用户坚持要用 FRP，需要解决服务器问题（找回密码、或找其他有公网 IP 的机器）</li>
</ol>
<p>让我先确认用户的网络环境。不是不行，是<strong>缺少 FRP 服务器端（frps）</strong>！</p>
<hr/>
<h3 data-id="heading-255">为什么 FRP 现在用不了？</h3>
<pre><code class="hljs language-scss" lang="scss">你的 Mac (frpc)  →  需要连接  →  云服务器 (frps)  →  公网访问
     ✅ 运行中              ❌ 已停止                ❌ 无法访问
</code></pre>
<p><strong>FRP 需要两端：</strong></p>
<ul>
<li><strong>frpc</strong>（客户端）✅ 在你的 Mac 上，运行正常</li>
<li><strong>frps</strong>（服务端）❌ 在 122.9.157.124 上，<strong>已停止且无密码无法启动</strong></li>
</ul>
<hr/>
<h3 data-id="heading-256">你的 Mac 网络环境确认</h3>
<p>执行这个命令，看看你的 Mac 到底是什么网络：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看公网 IP</span>
curl ip.sb

<span class="hljs-comment"># 查看内网 IP</span>
ifconfig | grep <span class="hljs-string">"inet "</span> | grep -v 127.0.0.1
</code></pre>
<p><strong>结果会是：</strong></p>

























<table><thead><tr><th>情况</th><th>说明</th><th>FRP 可行性</th></tr></thead><tbody><tr><td>公网 IP = 122.9.157.124</td><td>你的 Mac 直接有公网</td><td>✅ 不用 FRP，直接绑定</td></tr><tr><td>公网 IP = 其他</td><td>宽带拨号，可能动态</td><td>⚠️ 需要 DDNS + 端口映射</td></tr><tr><td>公网 IP 显示内网段</td><td>运营商 NAT，无公网</td><td>❌ 必须用内网穿透工具</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-257">可行方案对比</h3>









































<table><thead><tr><th>方案</th><th>需要条件</th><th>难度</th><th>稳定性</th></tr></thead><tbody><tr><td><strong>ngrok</strong></td><td>注册账号</td><td>⭐ 简单</td><td>临时/开发用</td></tr><tr><td><strong>花生壳/贝锐</strong></td><td>注册+客户端</td><td>⭐ 简单</td><td>较好</td></tr><tr><td><strong>Tailscale/ZeroTier</strong></td><td>两端安装</td><td>⭐⭐ 中等</td><td>好，但需客户端</td></tr><tr><td><strong>找回云服务器密码</strong></td><td>联系服务商</td><td>⭐⭐ 中等</td><td>最好，恢复 FRP</td></tr><tr><td><strong>买新云服务器</strong></td><td>花钱（50元/月）</td><td>⭐⭐ 中等</td><td>最好</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-258">推荐：先确认网络环境</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看公网 IP</span>
curl ip.sb

<span class="hljs-comment"># 2. 查看路由器 IP（判断是否在 NAT 后）</span>
curl ip.sb
<span class="hljs-comment"># 然后对比 ifconfig 看到的 IP</span>
</code></pre>
<p><strong>把结果给我，我告诉你最佳方案！</strong> 🔧</p>
<hr/>
<h3 data-id="heading-259">如果着急测试</h3>
<p>先用 <strong>ngrok</strong>（无需服务器，5分钟搞定）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载 ngrok（浏览器访问 https://ngrok.com/download）</span>
<span class="hljs-comment"># 解压后执行</span>
./ngrok http 18789
</code></pre>
<p><strong>你现在执行 <code>curl ip.sb</code>，看看返回什么 IP？</strong>
User: curl ip.sb</p>
<p>240e:330:54d1:2000:cc28:773b:75f:89f
dengxiaochao@dengxiaochao Downloads % ifconfig | grep "inet " | grep -v 127.0.0.1</p>
<pre><code class="hljs">inet 192.168.1.7 netmask 0xffffff00 broadcast 192.168.1.255
</code></pre>
<p>Kimi: 明白了！你的网络情况：</p>
<ul>
<li><strong>公网 IP</strong>：<code>240e:330:54d1:2000:cc28:773b:75f:89f</code>（IPv6）</li>
<li><strong>内网 IP</strong>：<code>192.168.1.7</code>（IPv4）</li>
</ul>
<p><strong>这是典型的家庭宽带：有 IPv6 公网，但 IPv4 在 NAT 后</strong></p>
<hr/>
<h3 data-id="heading-260">为什么 FRP 不行？</h3>





















<table><thead><tr><th>问题</th><th>说明</th></tr></thead><tbody><tr><td><strong>IPv6 公网</strong></td><td>企业微信不支持 IPv6 直接访问</td></tr><tr><td><strong>IPv4 无公网</strong></td><td><code>192.168.1.7</code> 是内网，需要端口映射</td></tr><tr><td><strong>路由器 NAT</strong></td><td>运营商可能做了多层 NAT，端口映射也可能失败</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-261">可行方案</h3>
<h4 data-id="heading-262">方案 1：用 IPv6（尝试）</h4>
<p>如果企业微信支持 IPv6：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试 IPv6 访问</span>
curl http://[240e:330:54d1:2000:cc28:773b:75f:89f]:18789/wecom
</code></pre>
<p><strong>但企业微信后台可能不支持 IPv6 地址格式</strong>，大概率不行。</p>
<hr/>
<h4 data-id="heading-263">方案 2：路由器端口映射（尝试）</h4>
<p>在你的路由器后台：</p>
<ol>
<li>找到 <strong>端口映射/虚拟服务器</strong></li>
<li>添加规则：
<ul>
<li>外部端口：<code>18789</code></li>
<li>内部 IP：<code>192.168.1.7</code></li>
<li>内部端口：<code>18789</code></li>
</ul>
</li>
</ol>
<p>然后测试：</p>
<pre><code class="hljs language-bash" lang="bash">curl http://你的IPv4公网IP:18789/wecom
</code></pre>
<p><strong>但你的 IPv4 公网 IP 可能不存在（运营商 NAT）</strong></p>
<hr/>
<h4 data-id="heading-264">方案 3：ngrok（推荐，100% 可行）</h4>
<p>不需要公网 IP，直接穿透：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载 ngrok</span>
curl -O https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-darwin-amd64.zip
unzip ngrok-v3-stable-darwin-amd64.zip

<span class="hljs-comment"># 运行（不需要 token 也能临时用）</span>
./ngrok http 18789
</code></pre>
<p><strong>或者浏览器下载：<a href="https://link.juejin.cn?target=https%3A%2F%2Fngrok.com%2Fdownload" target="_blank" title="https://ngrok.com/download" ref="nofollow noopener noreferrer">ngrok.com/download</a></strong></p>
<hr/>
<h4 data-id="heading-265">方案 4：花生壳（国内稳定）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载花生壳客户端</span>
<span class="hljs-comment"># https://hsk.oray.com/download</span>

<span class="hljs-comment"># 安装后配置映射</span>
</code></pre>
<hr/>
<h3 data-id="heading-266">你现在选哪个？</h3>

























<table><thead><tr><th>方案</th><th>难度</th><th>成功率</th></tr></thead><tbody><tr><td>路由器端口映射</td><td>中</td><td>50%（可能运营商 NAT）</td></tr><tr><td><strong>ngrok</strong></td><td><strong>低</strong></td><td><strong>100%</strong></td></tr><tr><td>花生壳</td><td>低</td><td>95%</td></tr></tbody></table>
<p><strong>推荐先用 ngrok，5 分钟搞定！</strong></p>
<hr/>
<h3 data-id="heading-267">快速启动 ngrok</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> ~/Downloads/frp_0.67.0_darwin_amd64

<span class="hljs-comment"># 下载 ngrok</span>
curl -O https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-darwin-amd64.zip

<span class="hljs-comment"># 解压</span>
unzip ngrok-v3-stable-darwin-amd64.zip

<span class="hljs-comment"># 运行</span>
./ngrok http 18789
</code></pre>
<p><strong>执行后把显示的 https 地址给我！</strong> 🚀
User: curl <a href="https://link.juejin.cn?target=http%3A%2F%2F192.168.1.7%3A18789" target="_blank" title="http://192.168.1.7:18789" ref="nofollow noopener noreferrer">http://192.168.1.7:18789</a>  访问这个可以 访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fbot.shuqi.run%2Fwebhooks%2Fwecom" target="_blank" title="https://bot.shuqi.run/webhooks/wecom" ref="nofollow noopener noreferrer">bot.shuqi.run/webhooks/we…</a> 这个也行，但是访问 curl <a href="https://link.juejin.cn?target=http%3A%2F%2F192.168.1.7%3A18789%2Fwecom%25E5%25B0%25B1%25E4%25B8%258D%25E8%25A1%258C%25E4%25BA%2586" target="_blank" title="http://192.168.1.7:18789/wecom%E5%B0%B1%E4%B8%8D%E8%A1%8C%E4%BA%86" ref="nofollow noopener noreferrer">http://192.168.1.7:18789/wecom就不行了</a>
Kimi: 太好了！有进展！🎉</p>
<hr/>
<h3 data-id="heading-268">问题分析</h3>

























<table><thead><tr><th>URL</th><th>结果</th><th>说明</th></tr></thead><tbody><tr><td><code>http://192.168.1.7:18789</code></td><td>✅ 可以</td><td>OpenClaw 根路径正常</td></tr><tr><td><code>https://bot.shuqi.run/webhooks/wecom</code></td><td>✅ 可以</td><td>FRP + nginx 转发正常</td></tr><tr><td><code>http://192.168.1.7:18789/wecom</code></td><td>❌ 不行</td><td>wecom 插件路径有问题</td></tr></tbody></table>
<p><strong>关键发现：<code>/webhooks/wecom</code> 可以，<code>/wecom</code> 不行！</strong></p>
<hr/>
<h3 data-id="heading-269">原因</h3>
<p><strong>插件的 webhookPath 配置是 <code>/webhooks/wecom</code>，不是 <code>/wecom</code>！</strong></p>
<p>之前我们配置的是：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"webhookPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/wecom"</span>
</code></pre>
<p>但实际应该是：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"webhookPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/webhooks/wecom"</span>
</code></pre>
<hr/>
<h3 data-id="heading-270">修复配置</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/webhooks/wecom","token":"fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD","encodingAESKey":"ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL","receiveId":"","dm":{"policy":"pairing"}}'</span> --json

openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-271">然后测试</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 本地测试</span>
curl http://192.168.1.7:18789/webhooks/wecom

<span class="hljs-comment"># 外网测试（FRP）</span>
curl https://bot.shuqi.run/webhooks/wecom
</code></pre>
<hr/>
<h3 data-id="heading-272">企业微信后台填写</h3>





















<table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td><strong>URL</strong></td><td><code>https://bot.shuqi.run/webhooks/wecom</code></td></tr><tr><td><strong>Token</strong></td><td><code>fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD</code></td></tr><tr><td><strong>EncodingAESKey</strong></td><td><code>ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL</code></td></tr></tbody></table>
<p><strong>执行修复命令后测试！</strong> 🚀
User: 很奇怪，按你的操作后curl <a href="https://link.juejin.cn?target=http%3A%2F%2F192.168.1.7%3A18789%2Fwebhooks%2Fwecom" target="_blank" title="http://192.168.1.7:18789/webhooks/wecom" ref="nofollow noopener noreferrer">http://192.168.1.7:18789/webhooks/wecom</a> 不行，变成了curl <a href="https://link.juejin.cn?target=http%3A%2F%2F192.168.1.7%3A18789%2Fwecom" target="_blank" title="http://192.168.1.7:18789/wecom" ref="nofollow noopener noreferrer">http://192.168.1.7:18789/wecom</a>  这样可行，然后企业微信后台那创建提示echostr校验失败，请您检查是否正确解密并输出明文echostr
Kimi: 明白了！情况反转了：</p>
<ul>
<li><code>/wecom</code> ✅ 可以</li>
<li><code>/webhooks/wecom</code> ❌ 不行</li>
</ul>
<p><strong>说明插件实际注册的路径是 <code>/wecom</code>，不是 <code>/webhooks/wecom</code>！</strong></p>
<hr/>
<h3 data-id="heading-273">企业微信报错分析</h3>
<pre><code class="hljs">echostr校验失败，请您检查是否正确解密并输出明文echostr
</code></pre>
<p><strong>这不是 URL 问题，是 Token 或 EncodingAESKey 不匹配！</strong></p>
<p>企业微信发送验证请求时，OpenClaw 无法正确解密，导致校验失败。</p>
<hr/>
<h3 data-id="heading-274">检查清单</h3>





























<table><thead><tr><th>检查项</th><th>企业微信后台</th><th>OpenClaw 配置</th><th>状态</th></tr></thead><tbody><tr><td>Token</td><td><code>fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD</code></td><td>相同</td><td>？</td></tr><tr><td>EncodingAESKey</td><td><code>ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL</code></td><td>相同</td><td>？</td></tr><tr><td>消息加解密方式</td><td>兼容模式/明文模式</td><td>-</td><td>？</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-275">可能原因</h3>
<ol>
<li><strong>Key 复制有误</strong>（多了空格或字符）</li>
<li><strong>企业微信后台重新生成了 Key</strong>，但没更新到 OpenClaw</li>
<li><strong>消息加解密方式</strong> 选错了（应该选"兼容模式"或"明文模式"）</li>
</ol>
<hr/>
<h3 data-id="heading-276">你现在检查</h3>
<p><strong>第一步：确认企业微信后台的 Token 和 Key</strong></p>
<p>去 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwork.weixin.qq.com%2Fwework_admin" target="_blank" title="https://work.weixin.qq.com/wework_admin" ref="nofollow noopener noreferrer">work.weixin.qq.com/wework_admi…</a> 查看：</p>
<ul>
<li>应用管理 → 你的应用 → 接收消息</li>
<li><strong>Token</strong> 是什么？</li>
<li><strong>EncodingAESKey</strong> 是什么？</li>
</ul>
<p><strong>第二步：对比 OpenClaw 配置</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw config get channels.wecom
</code></pre>
<p><strong>把两边的 Token 和 Key 都贴给我，我帮你对比！</strong> 🔧</p>
<hr/>
<h3 data-id="heading-277">临时解决方案</h3>
<p>如果着急测试，先改成<strong>明文模式</strong>（不加密，绕过校验）：</p>
<ol>
<li>企业微信后台 → 接收消息 → <strong>消息加解密方式</strong> → 选 <strong>"明文模式"</strong></li>
<li>保存</li>
</ol>
<p>这样不需要 EncodingAESKey 也能通过验证。</p>
<p><strong>先告诉我两边的 Token/Key 是否一致！</strong>
User: {
"enabled": true,
"webhookPath": "/webhooks/wecom",
"token": "fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD",
"encodingAESKey": "ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL",
"receiveId": "",
"dm": {
"policy": "pairing"
}
}   后台 fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD ，ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL
Kimi: 发现了！<strong>OpenClaw 配置还是 <code>/webhooks/wecom</code>，但你测试说 <code>/wecom</code> 才行！</strong></p>
<hr/>
<h3 data-id="heading-278">问题确认</h3>

















<table><thead><tr><th>项目</th><th>值</th></tr></thead><tbody><tr><td>OpenClaw 配置</td><td><code>webhookPath: "/webhooks/wecom"</code></td></tr><tr><td>实际能访问的路径</td><td><code>/wecom</code></td></tr></tbody></table>
<p><strong>配置和实际不匹配！</strong></p>
<hr/>
<h3 data-id="heading-279">修复：改回 <code>/wecom</code></h3>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{"enabled":true,"webhookPath":"/wecom","token":"fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD","encodingAESKey":"ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL","receiveId":"","dm":{"policy":"pairing"}}'</span> --json

openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-280">然后验证</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 本地测试</span>
curl http://192.168.1.7:18789/wecom

<span class="hljs-comment"># 外网测试</span>
curl https://bot.shuqi.run/wecom
</code></pre>
<hr/>
<h3 data-id="heading-281">企业微信后台</h3>

























<table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td><strong>URL</strong></td><td><code>https://bot.shuqi.run/wecom</code></td></tr><tr><td><strong>Token</strong></td><td><code>fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD</code></td></tr><tr><td><strong>EncodingAESKey</strong></td><td><code>ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL</code></td></tr><tr><td><strong>消息加解密方式</strong></td><td>建议选**"明文模式"** 先测试</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-282">如果还是 echostr 校验失败</h3>
<p>选 <strong>明文模式</strong> 绕过加密校验：</p>
<ol>
<li>企业微信后台 → 接收消息</li>
<li><strong>消息加解密方式</strong> → 选 <strong>"明文模式"</strong></li>
<li>保存</li>
</ol>
<p>这样不需要 EncodingAESKey 也能通过。</p>
<p><strong>执行修复命令后测试！</strong> 🚀
User: 然后在 OpenClaw 配置文件中添加：</p>
<p>{
"plugins": {
"entries": {
"wecom": { "enabled": true }
}
},
"channels": {
"wecom": {
"enabled": true,
"token": "你的 Token",
"encodingAesKey": "你的 EncodingAESKey"
}
}
}  我觉得有可能是你直接这样用命令这样设置不行不符合他的格式，上面是GitHub的插件官方的
Kimi: 用户发现问题了！GitHub 官方文档的配置格式和我们用的命令行设置不一样。</p>
<p>官方文档的配置结构是：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"entries"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"wecom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"channels"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"wecom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"xxx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"encodingAesKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"xxx"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>而我们之前用的是：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> channels.wecom <span class="hljs-string">'{...}'</span>
</code></pre>
<p>这可能只是设置了 <code>channels.wecom</code>，但没有设置 <code>plugins.entries.wecom</code>。</p>
<p>而且注意官方用的是 <code>encodingAesKey</code>（驼峰命名），而我们用的是 <code>encodingAESKey</code>（全大写）。</p>
<p>让我让用户直接编辑配置文件，按照官方格式来。你说得对！<strong>配置结构可能不完整</strong>！</p>
<p>官方文档需要两个部分：</p>
<ol>
<li><code>plugins.entries.wecom</code> - 启用插件</li>
<li><code>channels.wecom</code> - 通道配置</li>
</ol>
<p>而且注意：<strong><code>encodingAesKey</code></strong>（驼峰）vs <strong><code>encodingAESKey</code></strong>（我们用的）</p>
<hr/>
<h3 data-id="heading-283">直接编辑配置文件（推荐）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 打开配置文件</span>
nano ~/.openclaw/openclaw.json
</code></pre>
<p><strong>改成这样：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"entries"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"wecom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"channels"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"wecom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"encodingAesKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>注意：</strong></p>
<ul>
<li><code>encodingAesKey</code> 不是 <code>encodingAESKey</code>（大小写不同！）</li>
<li>不需要 <code>webhookPath</code>，用默认的 <code>/wecom</code></li>
</ul>
<hr/>
<h3 data-id="heading-284">然后重启</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw gateway restart
</code></pre>
<hr/>
<h3 data-id="heading-285">验证</h3>
<pre><code class="hljs language-bash" lang="bash">curl http://192.168.1.7:18789/wecom
</code></pre>
<hr/>
<h3 data-id="heading-286">企业微信后台</h3>





















<table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td><strong>URL</strong></td><td><code>https://bot.shuqi.run/wecom</code></td></tr><tr><td><strong>Token</strong></td><td><code>fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD</code></td></tr><tr><td><strong>EncodingAESKey</strong></td><td><code>ykBavPwByUVHYjf9hPYrE3lBzE257ziz3ziS57cJGLL</code></td></tr></tbody></table>
<p><strong>修改配置文件后测试！</strong> 🚀
User: 搞定了，总结一下经验吧
Kimi: 太好了！🎉 恭喜搞定！总结一下完整经验：</p>
<hr/>
<h3 data-id="heading-287">✅ 最终成功配置</h3>
<h4 data-id="heading-288">1. OpenClaw 配置文件 <code>~/.openclaw/openclaw.json</code></h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"entries"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"wecom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"channels"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"wecom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"encodingAesKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ykBavPwByUVHYjf9hPYrE3lELURprMUmaVpAx7OlOOO"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><code>plugins.entries.wecom</code> 必须启用</li>
<li><code>encodingAesKey</code> 是驼峰命名（不是 <code>encodingAESKey</code>）</li>
<li>不需要 <code>webhookPath</code>，默认 <code>/wecom</code></li>
</ul>
<hr/>
<h4 data-id="heading-289">2. OpenClaw 网关绑定</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 绑定局域网（让 FRP 能访问）</span>
openclaw config <span class="hljs-built_in">set</span> gateway.bind <span class="hljs-string">"lan"</span>
openclaw config <span class="hljs-built_in">set</span> gateway.port 18789
openclaw gateway restart
</code></pre>
<hr/>
<h4 data-id="heading-290">3. FRP 客户端配置 <code>frpc.toml</code></h4>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-attr">serverAddr</span> = <span class="hljs-string">"122.9.157.124"</span>
<span class="hljs-attr">serverPort</span> = <span class="hljs-number">7000</span>
<span class="hljs-attr">auth.method</span> = <span class="hljs-string">"token"</span>
<span class="hljs-attr">auth.token</span> = <span class="hljs-string">"你的token"</span>

<span class="hljs-section">[[proxies]]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"bot"</span>
<span class="hljs-attr">type</span> = <span class="hljs-string">"tcp"</span>
<span class="hljs-attr">localIP</span> = <span class="hljs-string">"127.0.0.1"</span>
<span class="hljs-attr">localPort</span> = <span class="hljs-number">18789</span>
<span class="hljs-attr">remotePort</span> = <span class="hljs-number">10981</span>
</code></pre>
<hr/>
<h4 data-id="heading-291">4. 企业微信后台</h4>

































<table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td><strong>URL</strong></td><td><code>https://bot.shuqi.run/wecom</code></td></tr><tr><td><strong>Token</strong></td><td><code>fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD</code></td></tr><tr><td><strong>EncodingAESKey</strong></td><td><code>ykBavPwByUVHYjf9hPYrE3lELURprMUmaVpAx7OlOOO</code></td></tr><tr><td><strong>消息加解密方式</strong></td><td>兼容模式或</td></tr><tr><td>User: 我们对话了这么多我经历这么久，把这个，写成指南吧，我准备发到网上，告诉后来者，避坑这些，怎么用frp内网穿通工具打通实现企业微信机器人成功上线</td><td/></tr><tr><td>Kimi: 好的！我来帮你整理成一份<strong>完整避坑指南</strong>，方便你发到网上帮助后来者。</td><td/></tr></tbody></table>
<hr/>
<h2 data-id="heading-292">🚀 OpenClaw + FRP 企业微信机器人部署完全指南</h2>
<blockquote>
<p><strong>作者</strong>：Dengxiaochao &amp; AI Assistant
<strong>耗时</strong>：N 小时踩坑总结
<strong>目标</strong>：让后来者 30 分钟搞定，不再踩坑</p>
</blockquote>
<hr/>
<h3 data-id="heading-293">📋 前置条件</h3>
<ul>
<li>Mac 电脑（Intel/Apple Silicon）</li>
<li>企业微信管理员权限</li>
<li>一台有公网 IP 的服务器（跑 FRP 服务端）</li>
<li>基础命令行知识</li>
</ul>
<hr/>
<h3 data-id="heading-294">🎯 最终架构</h3>
<pre><code class="hljs language-scss" lang="scss">用户 → 企业微信服务器 → FRP 服务端(公网) → FRP 客户端(Mac) → OpenClaw
</code></pre>
<hr/>
<h3 data-id="heading-295">第一步：安装 OpenClaw</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装（需 Node.js）</span>
npm install -g openclaw

<span class="hljs-comment"># 验证</span>
openclaw --version
</code></pre>
<hr/>
<h3 data-id="heading-296">第二步：安装企业微信插件</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw plugins install openclaw-plugin-wecom
</code></pre>
<p><strong>验证安装</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw plugins list
<span class="hljs-comment"># 应显示 openclaw-plugin-wecom</span>
</code></pre>
<hr/>
<h3 data-id="heading-297">第三步：配置 OpenClaw（核心避坑！）</h3>
<p><strong>⚠️ 坑点：必须同时配置 <code>plugins.entries</code> 和 <code>channels</code></strong></p>
<p>编辑配置文件：</p>
<pre><code class="hljs language-bash" lang="bash">nano ~/.openclaw/openclaw.json
</code></pre>
<p><strong>完整配置</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"entries"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"wecom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"channels"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"wecom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的Token"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"encodingAesKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的43位EncodingAESKey"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>🔥 避坑要点</strong>：</p>





















<table><thead><tr><th>坑</th><th>正确做法</th></tr></thead><tbody><tr><td>❌<code>encodingAESKey</code></td><td>✅<code>encodingAesKey</code>（驼峰命名！）</td></tr><tr><td>❌ 只配 <code>channels</code></td><td>✅ 必须同时配 <code>plugins.entries</code></td></tr><tr><td>❌ 配 <code>webhookPath</code></td><td>✅ 不写，用默认 <code>/wecom</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-298">第四步：配置网关绑定</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 绑定到局域网（让 FRP 能访问）</span>
openclaw config <span class="hljs-built_in">set</span> gateway.bind <span class="hljs-string">"lan"</span>
openclaw config <span class="hljs-built_in">set</span> gateway.port 18789

<span class="hljs-comment"># 重启</span>
openclaw gateway restart

<span class="hljs-comment"># 验证</span>
openclaw gateway status
<span class="hljs-comment"># 应显示 Listening: *:18789</span>
</code></pre>
<hr/>
<h3 data-id="heading-299">第五步：配置 FRP 内网穿透</h3>
<h4 data-id="heading-300">5.1 服务端（frps）- 公网服务器</h4>
<p><code>frps.toml</code>：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-attr">bindPort</span> = <span class="hljs-number">7000</span>
<span class="hljs-attr">auth.method</span> = <span class="hljs-string">"token"</span>
<span class="hljs-attr">auth.token</span> = <span class="hljs-string">"你的强密码"</span>
</code></pre>
<p>启动：</p>
<pre><code class="hljs language-bash" lang="bash">./frps -c frps.toml
</code></pre>
<h4 data-id="heading-301">5.2 客户端（frpc）- Mac</h4>
<p><code>frpc.toml</code>：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-attr">serverAddr</span> = <span class="hljs-string">"你的公网IP"</span>
<span class="hljs-attr">serverPort</span> = <span class="hljs-number">7000</span>
<span class="hljs-attr">auth.method</span> = <span class="hljs-string">"token"</span>
<span class="hljs-attr">auth.token</span> = <span class="hljs-string">"你的强密码"</span>

<span class="hljs-section">[[proxies]]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"openclaw-wecom"</span>
<span class="hljs-attr">type</span> = <span class="hljs-string">"tcp"</span>
<span class="hljs-attr">localIP</span> = <span class="hljs-string">"127.0.0.1"</span>
<span class="hljs-attr">localPort</span> = <span class="hljs-number">18789</span>
<span class="hljs-attr">remotePort</span> = <span class="hljs-number">10981</span>
</code></pre>
<p>启动：</p>
<pre><code class="hljs language-bash" lang="bash">./frpc -c frpc.toml
</code></pre>
<p><strong>验证连接</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 服务端应显示</span>
[xxx] [openclaw-wecom] start proxy success
</code></pre>
<hr/>
<h3 data-id="heading-302">第六步：企业微信后台配置</h3>
<ol>
<li>登录 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwork.weixin.qq.com%2Fwework_admin" target="_blank" title="https://work.weixin.qq.com/wework_admin" ref="nofollow noopener noreferrer">work.weixin.qq.com/wework_admi…</a></li>
<li>应用管理 → 自建应用 → 接收消息</li>
<li>填写：</li>
</ol>

























<table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td>URL</td><td><code>http://你的公网IP:10981/wecom</code></td></tr><tr><td>Token</td><td>和 OpenClaw 配置一致</td></tr><tr><td>User: 继续，能把整个聊天记录导出不</td><td/></tr><tr><td>Kimi: 用户想把整个聊天记录导出发到网上。我需要总结整个对话过程，但我是 AI 助手，无法直接导出聊天记录文件。</td><td/></tr></tbody></table>
<p>我应该：</p>
<ol>
<li>告诉用户我无法直接导出文件</li>
<li>提供完整的对话内容总结（按时间线整理）</li>
<li>建议用户如何复制保存这些内容</li>
</ol>
<p>让我整理整个对话的关键节点：</p>
<ul>
<li>开始：用户问 Clawbot hooks 功能</li>
<li>然后：OpenClaw 企业微信插件安装</li>
<li>配置问题：encodingAesKey 大小写、plugins.entries 结构</li>
<li>FRP 内网穿透配置</li>
<li>网关绑定问题（lan vs 0.0.0.0 vs loopback）</li>
<li>企业微信后台配置</li>
<li>最终成功</li>
</ul>
<p>我可以按时间线整理成详细的"对话实录"形式。我无法直接导出聊天记录文件，但我可以帮你<strong>按时间线整理完整的对话实录</strong>，你可以复制保存：</p>
<hr/>
<h2 data-id="heading-303">📜 OpenClaw + FRP 企业微信机器人部署实录</h2>
<blockquote>
<p>完整踩坑过程，从入门到成功</p>
</blockquote>
<hr/>
<h3 data-id="heading-304">第一章：初识 Clawbot Hooks（14:00-15:00）</h3>
<p><strong>用户</strong>：clawbot 这几个 hook 是什么功能？</p>
<p><strong>AI</strong>：解释了四个钩子：</p>
<ul>
<li><code>boot-md</code>：启动文档加载</li>
<li><code>command-logger</code>：命令日志记录</li>
<li><code>session-memory</code>：会话记忆（推荐开启）</li>
<li><code>soul-evil</code>：性格插件（傲娇模式）</li>
</ul>
<p><strong>用户</strong>：怎么启用记忆功能？</p>
<p><strong>AI</strong>：方向键选择 → 空格勾选 → 回车确认</p>
<hr/>
<h3 data-id="heading-305">第二章：企业微信插件探索（15:00-16:00）</h3>
<p><strong>用户</strong>：<code>clawdbot plugins install @mijia-life/clawdbot-wecom</code> 没找到仓库</p>
<p><strong>AI</strong>：发现是旧版插件名，搜索后推荐：</p>
<ul>
<li>新版 OpenClaw 用 <code>openclaw-plugin-wecom</code></li>
</ul>
<p><strong>安装成功</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw plugins install openclaw-plugin-wecom
<span class="hljs-comment"># 显示：WeCom plugin registering... 成功</span>
</code></pre>
<hr/>
<h3 data-id="heading-306">第三章：FRP 内网穿透配置（16:00-17:30）</h3>
<p><strong>用户</strong>：Mac 怎么配置 FRP？</p>
<p><strong>发现网络环境</strong>：</p>
<ul>
<li>Mac 内网 IP：<code>192.168.1.7</code></li>
<li>公网 IPv6：<code>240e:330:54d1:2000...</code>（企业微信不支持）</li>
<li>有台云服务器 <code>122.9.157.124</code> 但已停止服务</li>
</ul>
<p><strong>FRP 配置确定</strong>：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-comment"># frpc.toml（Mac 客户端）</span>
<span class="hljs-attr">serverAddr</span> = <span class="hljs-string">"122.9.157.124"</span>
<span class="hljs-attr">serverPort</span> = <span class="hljs-number">7000</span>
<span class="hljs-attr">auth.method</span> = <span class="hljs-string">"token"</span>
<span class="hljs-attr">auth.token</span> = <span class="hljs-string">"60d8a83c544e6168db"</span>

<span class="hljs-section">[[proxies]]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"bot"</span>
<span class="hljs-attr">type</span> = <span class="hljs-string">"tcp"</span>
<span class="hljs-attr">localIP</span> = <span class="hljs-string">"127.0.0.1"</span>
<span class="hljs-attr">localPort</span> = <span class="hljs-number">18789</span>
<span class="hljs-attr">remotePort</span> = <span class="hljs-number">10981</span>
</code></pre>
<p><strong>坑点</strong>：尝试改 <code>type = "http"</code> 失败，因为服务端只支持 TCP</p>
<hr/>
<h3 data-id="heading-307">第四章：网关绑定大战（17:30-19:00）</h3>
<p><strong>连环踩坑</strong>：</p>

























<table><thead><tr><th>尝试</th><th>结果</th><th>原因</th></tr></thead><tbody><tr><td><code>0.0.0.0</code></td><td>❌ Invalid --bind</td><td>不支持</td></tr><tr><td><code>lan</code></td><td>✅ Listening: *:18789</td><td>正确</td></tr><tr><td><code>loopback</code></td><td>❌ 仅本地</td><td>FRP 连不上</td></tr></tbody></table>
<p><strong>关键发现</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> gateway.bind <span class="hljs-string">"lan"</span>
<span class="hljs-comment"># 不是 "0.0.0.0" 也不是 "loopback"！</span>
</code></pre>
<p><strong>修改 plist 文件</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>--bind<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>lan<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-308">第五章：配置格式核战争（19:00-20:30）</h3>
<p><strong>最大坑点：encodingAesKey 大小写</strong></p>
<pre><code class="hljs">错误：encodingAESKey（全大写）
正确：encodingAesKey（驼峰）
</code></pre>
<p><strong>配置结构缺失</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// ❌ 错误：只配了 channels</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"channels"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"wecom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// ✅ 正确：必须同时启用 plugins.entries</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"entries"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"wecom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"channels"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"wecom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>webhookPath 混乱</strong>：</p>
<ul>
<li>试了 <code>/wecom</code> → 不行</li>
<li>试了 <code>/webhooks/wecom</code> → 不行</li>
<li>最终：不写，用默认 <code>/wecom</code></li>
</ul>
<hr/>
<h3 data-id="heading-309">第六章：企业微信后台对决（20:30-21:00）</h3>
<p><strong>echostr 校验失败</strong>：</p>
<ul>
<li>原因：Token/Key 不匹配</li>
<li>解决：两边重新复制，确保一致</li>
</ul>
<p><strong>最终成功配置</strong>：</p>
<p><strong>OpenClaw</strong> <code>~/.openclaw/openclaw.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"entries"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"wecom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"channels"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"wecom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"encodingAesKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ykBavPwByUVHYjf9hPYrE3lELURprMUmaVpAx7OlOOO"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>企业微信后台</strong>：</p>
<ul>
<li>URL：<code>https://bot.shuqi.run/wecom</code></li>
<li>Token：<code>fXXt9aFjVNzq51lsPEBJiBRquiNKiyBD</code></li>
<li>EncodingAESKey：<code>ykBavPwByUVHYjf9hPYrE3lELURprMUmaVpAx7OlOOO</code></li>
</ul>
<hr/>
<h3 data-id="heading-310">第七章：胜利时刻（21:00+）</h3>
<p><strong>验证命令</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 本地</span>
curl http://192.168.1.7:18789/wecom

<span class="hljs-comment"># 外网</span>
curl https://bot.shuqi.run/wecom

<span class="hljs-comment"># 企业微信 App 发送"你好" → 机器人回复成功！</span>
</code></pre>
<hr/>
<h3 data-id="heading-311">💎 核心经验总结</h3>
<h4 data-id="heading-312">必坑三原则</h4>
<ol>
<li><strong>大小写敏感</strong>：<code>encodingAesKey</code> 不是 <code>encodingAESKey</code></li>
<li><strong>双管齐下</strong>：必须同时配 <code>plugins.entries</code> + <code>channels</code></li>
<li><strong>绑定用 lan</strong>：不是 <code>0.0.0.0</code> 不是 <code>loopback</code></li>
</ol>
<h4 data-id="heading-313">调试顺序</h4>
<pre><code class="hljs">本地 curl → FRP 启动 → 外网 curl → 企业微信保存 → App 测试
</code></pre>
<h4 data-id="heading-314">救命命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 看日志</span>
<span class="hljs-built_in">tail</span> -f ~/.openclaw/logs/gateway.err.log

<span class="hljs-comment"># 看配置</span>
openclaw config get channels.wecom

<span class="hljs-comment"># 看状态</span>
openclaw channels status
</code></pre>
<hr/>
<blockquote>
<p><strong>后记</strong>：从下午 2 点到晚上 9 点，7 小时踩坑，30 行配置，致敬每一位部署 OpenClaw 的开发者！</p>
</blockquote>
<hr/>
<h3 data-id="heading-315">💾 如何保存这份实录</h3>
<p><strong>方法一：复制粘贴</strong></p>
<ol>
<li>选中上面的全部内容</li>
<li>复制到 VS Code/Typora/记事本</li>
<li>保存为 <code>.md</code> 文件</li>
</ol>
<p><strong>方法二：生成 PDF</strong></p>
<ul>
<li>用浏览器"打印" → 另存为 PDF</li>
</ul>
<p><strong>方法三：发布到网上</strong></p>
<ul>
<li>知乎/掘金/CSDN：直接粘贴 Markdown</li>
<li>GitHub：创建 Gist 或仓库</li>
</ul>
<hr/>
<p>需要我把这份实录调整成<strong>知乎排版</strong>、<strong>公众号排版</strong>、或者<strong>GitHub README 格式</strong>吗？ 🎉</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[曾经王者今何在? OpenAI 遭遇滑铁卢,Codex App 能否力挽狂澜]]></title>    <link>https://juejin.cn/post/7602846823325614115</link>    <guid>https://juejin.cn/post/7602846823325614115</guid>    <pubDate>2026-02-04T18:46:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602846823325614115" data-draft-id="7602837527674290191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="曾经王者今何在? OpenAI 遭遇滑铁卢,Codex App 能否力挽狂澜"/> <meta itemprop="keywords" content="OpenAI,人工智能,AI编程"/> <meta itemprop="datePublished" content="2026-02-04T18:46:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wangruofeng"/> <meta itemprop="url" content="https://juejin.cn/user/712139266070296"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            曾经王者今何在? OpenAI 遭遇滑铁卢,Codex App 能否力挽狂澜
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139266070296/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wangruofeng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T18:46:41.000Z" title="Wed Feb 04 2026 18:46:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">OpenRouter 是什么</h2>
<p><strong>OpenRouter</strong> 是一个多模型 LLM API 的统一网关,把不同厂商、不同模型、不同计费方式、不同参数接口,统一封装成一套兼容 OpenAI 的调用方式。你可以在一个 endpoint 上完成选模型、调用、计费和观测。</p>
<p>官网:<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenrouter.ai%2Frankings" target="_blank" title="https://openrouter.ai/rankings" ref="nofollow noopener noreferrer">openrouter.ai/rankings</a></p>
<h2 data-id="heading-1">OpenRouter 使用趋势</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f9c84a526a34409b462ef80580eb41f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=t%2F8VXhH7IbW1%2Ftn7%2BZ0EAwXK8dA%3D" alt="" loading="lazy"/></p>
<p>最近一周(截至 2026.01.26)的榜单如下:</p>
<p><strong>国外:</strong> Anthropic 的 Claude Sonnet 4.5、Claude Opus 4.5;Google 的 Gemini 3 Flash Preview、Gemini 2.5 Flash;xAI 的 Grok Code Fast 1、Grok 4.1 Fast;OpenAI 的开源模型 gpt-oss-120b。</p>
<p><strong>国内:</strong> DeepSeek V3.2、Kimi K2.5。</p>
<p>往前推一周,榜单差不多。小米的 Mimo-V2-Flash 掉出去了,gpt-oss-120b 进了前十。但有个意外:曾经的绝对老大 OpenAI,除了一个免费开源模型,最新的 ChatGPT-5.2、ChatGPT-5.2-Codex 等主力模型全都不在榜上。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7608bfd056e4ce5889af4fa17365c13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=48ibBXp8pjiptTFFepjwCtOvrds%3D" alt="" loading="lazy"/></p>
<p>2026.01.19 和 2026.01.26 的对比:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/119f22789e704b89a6a0136813f9a251~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=d2fVAHiYHlsNp2S%2BrrbUdFZ9yDo%3D" alt="" loading="lazy"/></p>
<p>从数据看,GPT 系列的 token 使用量已经掉出前十,Google 的市场份额是 OpenAI 的两倍。</p>
<p>再看看最受欢迎的大语言模型(LLM)排行榜,还是没 OpenAI 的影子。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8206e87fe16645d9aea3af63b99575ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=e4S95jS0uPzb8Of4Zqrkt%2Fm7DXc%3D" alt="" loading="lazy"/></p>
<p>再看公司的市场份额,中间蓝色是 OpenAI:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1b4fa1e492c46b698f3cef7388b01b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=cAHePunLHn2q%2F6t%2B%2FPB1ty3jWp4%3D" alt="" loading="lazy"/></p>
<p>xAI 正在快速崛起,OpenAI 的市场份额被严重蚕食,现在只剩 10% 左右。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7e54693cd6e4ec19132788646d236e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=zeqDWerL0EKvPJywV1gZCWZpvPg%3D" alt="" loading="lazy"/></p>
<p>编程模型数据,基准语言是 Python:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af0038f02dc549348f316c96078b6da6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=tVI9hhZiOaVwDgsKoMetfI%2Fip9E%3D" alt="" loading="lazy"/></p>
<p>OpenAI 曾经是这一领域的绝对霸主,现在这个表现确实让人意外。我觉得原因可能有不少:产品更新慢了、定价没优势、开源模型冲击、对手进步太快。</p>
<p>两天前 OpenAI 推出了 Mac 版 Codex App,还免费开放了最新的付费模型。下面详细测试一下。</p>
<h2 data-id="heading-2">Codex App 评测</h2>
<p>我安装后的可用模型:上面是 GPT-5.2-Codex、GPT-5.2 Medium/High/Extra,下面是历史模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd4025f7ebca4839b33b36482198584a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=l0vZIxjTT5qpQP4nbbeLjoSnGmU%3D" alt="" loading="lazy"/></p>
<p><strong>官方说法:</strong></p>
<blockquote>
<p>Codex App 是一个功能强大的全新界面,旨在轻松管理多个代理,并行运行工作,并与代理协作完成长时间运行的任务。</p>
<p>在限定时间内,ChatGPT Free 和 Go 版本均包含 Codex,Plus、Pro、Business、Enterprise 和 Edu 套餐的速率限制也翻倍。无论您在何处使用 Codex,这些更高的速率限制都适用。</p>
</blockquote>
<p>现在 Codex 限时免费,具体多久没说。主要面向开发者,有兴趣可以试试。</p>
<p>下载地址:<a href="https://link.juejin.cn?target=https%3A%2F%2Fpersistent.oaistatic.com%2Fcodex-app-prod%2FCodex.dmg" target="_blank" title="https://persistent.oaistatic.com/codex-app-prod/Codex.dmg" ref="nofollow noopener noreferrer">persistent.oaistatic.com/codex-app-p…</a></p>
<p>这次更新主要是两个功能:<strong>技能库(Skills)和自动化任务</strong>。</p>
<h3 data-id="heading-3">技能库</h3>
<p>Codex App 内置了技能库,包含 OpenAI 常用的工具和工作流程,而且全部开源:<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fskills%25E3%2580%2582" target="_blank" title="https://github.com/openai/skills%E3%80%82" ref="nofollow noopener noreferrer">github.com/openai/skil…</a> 举几个例子:</p>
<ul>
<li>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fskills%2Fblob%2Fmain%2Fskills%2F.curated%2Ffigma-implement-design%2FSKILL.md" target="_blank" title="https://github.com/openai/skills/blob/main/skills/.curated/figma-implement-design/SKILL.md" ref="nofollow noopener noreferrer">figma-implement-design</a></strong>:从 Figma 获取设计素材,转换成 UI 代码,实现 1:1 还原。</p>
</li>
<li>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fskills%2Fblob%2Fmain%2Fskills%2F.curated%2Flinear%2FSKILL.md" target="_blank" title="https://github.com/openai/skills/blob/main/skills/.curated/linear/SKILL.md" ref="nofollow noopener noreferrer">Linear 项目管理</a></strong>:分类错误、跟踪版本发布、管理工作量。</p>
</li>
<li>
<p><strong>云端部署</strong>:把 Web 应用部署到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fskills%2Fblob%2Fmain%2Fskills%2F.curated%2Fcloudflare-deploy%2FSKILL.md" target="_blank" title="https://github.com/openai/skills/blob/main/skills/.curated/cloudflare-deploy/SKILL.md" ref="nofollow noopener noreferrer">Cloudflare</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fskills%2Fblob%2Fmain%2Fskills%2F.curated%2Frender-deploy%2FSKILL.md" target="_blank" title="https://github.com/openai/skills/blob/main/skills/.curated/render-deploy/SKILL.md" ref="nofollow noopener noreferrer">Netlify</a> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fskills%2Fblob%2Fmain%2Fskills%2F.curated%2Fvercel-deploy%2FSKILL.md" target="_blank" title="https://github.com/openai/skills/blob/main/skills/.curated/vercel-deploy/SKILL.md" ref="nofollow noopener noreferrer">Vercel</a>。</p>
</li>
<li>
<p><strong>图像生成</strong>:用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fskills%2Fblob%2Fmain%2Fskills%2F.curated%2Fimagegen%2FSKILL.md" target="_blank" title="https://github.com/openai/skills/blob/main/skills/.curated/imagegen/SKILL.md" ref="nofollow noopener noreferrer">图像生成技能</a>(GPT Image)创建和编辑图像。</p>
</li>
<li>
<p><strong>OpenAI API 开发</strong>:<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fskills%2Fblob%2Fmain%2Fskills%2F.curated%2Fopenai-docs%2FSKILL.md" target="_blank" title="https://github.com/openai/skills/blob/main/skills/.curated/openai-docs/SKILL.md" ref="nofollow noopener noreferrer">参考文档</a>。</p>
</li>
<li>
<p><strong>文档处理</strong>:阅读、创建和编辑 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fskills%2Fblob%2Fmain%2Fskills%2F.curated%2Fpdf%2FSKILL.md" target="_blank" title="https://github.com/openai/skills/blob/main/skills/.curated/pdf/SKILL.md" ref="nofollow noopener noreferrer">PDF</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fskills%2Fblob%2Fmain%2Fskills%2F.curated%2Fspreadsheet%2FSKILL.md" target="_blank" title="https://github.com/openai/skills/blob/main/skills/.curated/spreadsheet/SKILL.md" ref="nofollow noopener noreferrer">电子表格</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fskills%2Fblob%2Fmain%2Fskills%2F.curated%2Fdoc%2FSKILL.md" target="_blank" title="https://github.com/openai/skills/blob/main/skills/.curated/doc/SKILL.md" ref="nofollow noopener noreferrer">docx</a>。</p>
</li>
</ul>
<p>本地安装的 Skills:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55a81999479540f49b383ba190c8fb32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=Q%2BihiM%2F%2BJBWbYGrvIbbvsSeCzLw%3D" alt="" loading="lazy"/></p>
<p>系统推荐的官方 Skills:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3e0253096ab475f9ccf8a9faffd6a65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=a2aNC2Ljf3jC9HmD3WjIjdLtGEM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">自动化任务</h3>
<p><strong>官方介绍:</strong></p>
<blockquote>
<p>使用 Codex 应用设置自动化任务,让 Codex 在后台按计划自动运行。自动化任务将指令与可选<strong>技能</strong>相结合,并按照您设定的时间表运行。完成后结果会进入审核队列,您可以随时返回继续工作。</p>
<p>在 OpenAI,我们一直使用自动化处理重复但重要的任务,例如日常问题分类、查找和总结 CI 失败、生成每日发布简报、检查错误等等。</p>
</blockquote>
<p>这个功能还在 Beta。界面如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77f5bfc496ca42bb8d1b59143a394fc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=eMbIR%2BoltHwxgdjQ410iMjmWshY%3D" alt="" loading="lazy"/></p>
<p>创建自动化任务需要填写:<strong>名称</strong>、<strong>项目</strong>、<strong>提示词</strong>、<strong>执行计划</strong>。</p>
<p>执行计划有两种:</p>
<p><strong>按天循环</strong>:选一周中的哪几天、什么时间触发。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1884e6eb28c464d80a5ab427d997bd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=BUgORfX1kUEeAovHf5caz5slTlY%3D" alt="" loading="lazy"/></p>
<p><strong>固定间隔</strong>:每几小时触发一次,也要选一周中的哪几天。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/747a58e454d245fc8c686edac0284043~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=7nwMal1fTRmg01U16jpeOnsSPHk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">功能测试</h2>
<h3 data-id="heading-6">调用 Skills</h3>
<p>我测试了本地安装的 Code Review Skill。</p>
<p><strong>步骤 1:</strong> 选择【Skills】,找到【Code Review】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4f5f6440ee0474298ad9f88299a27d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=D78UqHnYT99gcenYBJTy9l6yh%2Bg%3D" alt="" loading="lazy"/></p>
<p><strong>步骤 2:</strong> 点击【Try】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b289a7e7c36c485dbf979bf198914ba3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=uPpqy1pfz2yvZW6H7beCy9vvyrA%3D" alt="" loading="lazy"/></p>
<p><strong>步骤 3:</strong> 输入"Review 代码"</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e09423bbfa04f88bddf41c2f734d853~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=RQ3e2njZxoYGkeR345WHJ%2B08OWU%3D" alt="" loading="lazy"/></p>
<p>系统问要 Review 哪些,我选了"当前所有变更":</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdc9437cc9214f6ca18ec53147ce191d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=lMoKN30iPOJYhwk2p0jemsZZH7k%3D" alt="" loading="lazy"/></p>
<p>默认返回英文:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8eddbc29f14645878815cf49d585e657~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=2bWjLABGTWMTKfUvu9Ir2RwoYvI%3D" alt="" loading="lazy"/></p>
<p>让系统用中文回复,切换没问题:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/097d64faccef474792b8c558294b1d59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=%2FdCuzwGVMFe3xB%2BI1uIDLtJiX98%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">提交代码</h3>
<p>Review 完了,继续测试代码提交。输入"提交代码",按系统提示操作:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39a06ea67d5f4a6cab75b2cc18afff6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=bjSp7KNnrZSGINlco34mq9N8jt4%3D" alt="" loading="lazy"/></p>
<p>成功推到 GitHub(这个项目托管在 GitHub)。用自然语言就能完成一些 Git 操作:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9673da6c919a4dc981b88a920e8bc9c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=xpzGA%2Fnt7Z5E1TXba9Ldq4ISDx8%3D" alt="" loading="lazy"/></p>
<p>去 GitHub 验证,确实提交成功了:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a0c6059ed6c4c5992cf866a3614dfc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=VoPJF%2FYFwfXRUaFUnPOLT%2FfFzzs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">整理桌面</h3>
<p>听说 Mac 版 App 也支持类似 Claude Code 的桌面整理,测试一下。</p>
<p>输入"帮我整理一下桌面",系统要授权。点 Setting 菜单的登出,重新登录:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d91b04e92cb0437a94ecb04def56e650~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=Zh53Zr9i%2B60CMDxaiXze5MyHw2Y%3D" alt="" loading="lazy"/></p>
<p>重新登录后,再输入指令,系统让确认整理规则:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/751acda7ffbe4ab390ceb9e9aea3e433~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=DBflqK%2B1zm1w4Zw0WtMiabJLdPs%3D" alt="" loading="lazy"/></p>
<p>输入规则后继续,桌面整理完成了。这个功能没问题:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a437205f19fd4f4b916cd2254dde094f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=9RMaGiuE1JFgXV9mnB7VjTIlXss%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">运行项目</h3>
<p>找个本地项目试试。系统说没法直接运行,和 CLI 相比权限有限,本地 Web Node 服务都没法直接启动,让我自己在终端启动:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea6b261d1faf474e9ed4c684f9798519~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=QU3hEElbjDyU7k4qqeJgLXzocQs%3D" alt="" loading="lazy"/></p>
<p>打开 App 提供的终端测试启动,正常。问题在于,想通过自然语言直接运行项目,现在还是偏向 ChatBox 问答,不是真正的自动化。</p>
<p>另一种方式是点界面上方的运行按钮(向右三角形),配置运行命令后点【Save】,App 会在内部开终端执行命令:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3a7d5ded2de4df092120fd784d8cacf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=xRymbTRicNZPb%2FYk%2F6gdk5GAALg%3D" alt="" loading="lazy"/></p>
<p>效果如下,本质上还是借终端环境:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37364fa54dca4aceb72b6953e5036900~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=IhYEcvfMWmhKg4GDN8s6s%2BUcSBo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">其他功能</h2>
<h3 data-id="heading-11">Git 管理</h3>
<p>App 内置了 Git 查看功能,点右上角按钮能看<strong>已暂存</strong>、<strong>未暂存</strong>的代码:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72f07f60118a455a9be36d79e2fd2568~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=Yc4A%2BQdgSVkdzSRvn1RENuY%2F%2Bh4%3D" alt="" loading="lazy"/></p>
<p>支持按文件树看:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e96a00c40e07432cae2a44539b292bae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=cm3k5%2FzUiERbAFa3kjiuOrluUGA%3D" alt="" loading="lazy"/></p>
<p>点右上角 commit 按钮,能直接提交代码、推到远端、创建 PR:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59a7e52f58f74ec3b0d30a83fb00a4b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=7PDoUp5MrKkrJCO%2BSQusuf106oM%3D" alt="" loading="lazy"/></p>
<p>点右上角 Open 按钮,能用 IDE 或其他应用打开项目,比如终端和 Finder:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36812dbf49b949088971336b75db0ce8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=GC2JPozK7%2BU8UmZVMcu0VPhKJcE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">上下文</h3>
<p>点右下角圆圈图标看上下文使用,GPT-5.2-Codex 是 <strong>258k tokens</strong>。从描述看,支持上下文超出后自动压缩:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d4c8e2dcc164db293ea17fd476cdcc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770835604&amp;x-signature=6FZmFymMeKqTcrHiP%2F42s%2FhU0D4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">最后的想法</h2>
<p>Codex App 有几个明显的好处:把代码审查、文档生成、图像处理等多个 AI 能力集成在一个界面,不用来回切换工具;开源的 Skills 机制让开发者可以扩展能力;用日常语言就能完成 Git 操作、文件整理等任务,门槛降低了;现在免费,可以低成本体验。</p>
<p>但也有局限:和 CLI 工具比,权限不够,没法直接启动本地服务,还是得依赖终端;现在的体验更像传统 ChatBot,不是真正的自动化工作流;Google、Anthropic 这些对手迭代很快,Codex App 的功能创新度相对有限。</p>
<p>从 OpenRouter 的数据看,OpenAI 压力很大。Codex App 是一个应对策略,但要真正扭转局面,我觉得 OpenAI 还得在几个方面发力:</p>
<ul>
<li>技术创新：不能只优化应用层面,模型能力得有突破性提升;</li>
<li>定价策略：保持盈利的同时,价格得更有竞争力;</li>
<li>开发者生态：构建更开放的生态,吸引第三方开发者共建;</li>
<li>用户体验：从"工具"向"智能助理"转变,真正实现从"调用"到"协作"。</li>
</ul>
<p>给开发者的建议:Codex App 提供了便利,但别过度依赖。复杂开发工作流里,CLI 工具和 IDE 集成还是少不了;免费期结束后,得评估成本和收益是否匹配;AI 工具市场变化快,建议多体验几个平台,比如 Claude Code、GitHub Copilot,选最适合自己工作流程的。</p>
<p>OpenAI 想通过 Codex App 抢占开发者工具市场,但实测下来,自然语言交互能力和系统权限还不如 CLI 工具灵活。Google、Anthropic 这些竞争对手起来了,Codex App 能不能帮 OpenAI 夺回市场,还得再看。</p>
<p>对开发者来说,保持开放心态,拥抱新工具,但也得理性评估实际价值。这是应对 AI 时代技术变革的正确方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangGraph Multi-Agent 实战：让智能体像团队一样协作]]></title>    <link>https://juejin.cn/post/7602824293165170703</link>    <guid>https://juejin.cn/post/7602824293165170703</guid>    <pubDate>2026-02-05T01:22:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602824293165170703" data-draft-id="7602800677712298018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangGraph Multi-Agent 实战：让智能体像团队一样协作"/> <meta itemprop="keywords" content="后端,LangChain,Agent"/> <meta itemprop="datePublished" content="2026-02-05T01:22:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="星浩AI"/> <meta itemprop="url" content="https://juejin.cn/user/2904236059009760"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangGraph Multi-Agent 实战：让智能体像团队一样协作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2904236059009760/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    星浩AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T01:22:48.000Z" title="Thu Feb 05 2026 01:22:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 导读</h3>
<p>真实业务里，<strong>一个 Agent 往往不够</strong>：</p>
<ul>
<li>有的任务需要“拆分 → 并行执行 → 汇总决策”；</li>
<li>有的任务需要“一个总控来分配工作，多个 worker 去各自执行”；</li>
<li>有的场景要“一个模型来生成，一个模型来评估 / 修改 / 打回重做”。</li>
</ul>
<p>这就是多代理系统（Multi-Agent）要搞定的事儿：</p>
<blockquote>
<p>❝不再只依赖一个“大而全”的智能体，而是让多个有分工的 Agent 协同完成复杂任务。</p>
</blockquote>
<p>咱们从能直接落地的角度，一起搭一个简单但靠谱的多代理系统，看看它是怎么让智能体像团队一样协作的。</p>
<h3 data-id="heading-1">2. 读完你能学到</h3>
<ul>
<li><strong>理解角色划分</strong>：Orchestrator（总控）、Worker（执行）、Evaluator（评估）、Specialist（领域专家）</li>
<li><strong>掌握核心思路</strong>：共享 State、条件边/路由、子图封装</li>
<li><strong>实现经典模式</strong>：Orchestrator-Worker（任务分配执行）、Evaluator-Optimizer（评估迭代）</li>
<li><strong>学会取舍</strong>：判断何时需要多代理，何时单 Agent + 工具足够</li>
</ul>
<h3 data-id="heading-2">3. Multi-Agent 是什么 &amp; 什么时候该用？</h3>
<h4 data-id="heading-3">3.1 一个直观的类比</h4>
<p>可以把多代理系统类比为一个小型团队：</p>
<ul>
<li>Orchestrator：产品经理 / 项目经理，负责拆解任务、分配工作、整合结果；</li>
<li>Worker：各路开发 / 运营 / 销售，负责完成各自的子任务；</li>
<li>Evaluator：测试 / 质检 / 审核，负责挑错和把关质量。</li>
</ul>
<p>在 LangGraph 视角下：</p>
<ul>
<li><strong>每个 Agent 本质上就是一个"带有自己 Prompt + 工具 + 状态视角"的节点子图</strong>；</li>
<li>它们通过<strong>共享的全局 State</strong>读写信息；</li>
<li>图结构（节点 + 边）定义了"谁先说、谁后说、谁有权打回重做"。</li>
</ul>
<blockquote>
<p>❝重要说明：本讲介绍的是"多节点编排"模式，而非"分布式多智能体"本讲：所有 Agent 节点在同一个进程内运行，通过 LangGraph 的状态机编排，共享同一个State。这种方式适合： ✅ 快速原型验证（代码少、部署快） ✅ 中小规模应用（任务复杂度适中） ✅ 本地开发调试（可观测性强）第 9 讲：我们将讲解真正的分布式多智能体系统，每个 Agent 可以独立部署在不同进程/服务器上，通过消息队列、API 等方式异步通信，适合大规模、高可用、需要独立扩展的场景。为什么先讲单进程？：单进程模式是分布式模式的基础，理解了状态共享和节点编排，再学分布式会更轻松。</p>
</blockquote>
<h4 data-id="heading-4">3.2 什么时候值得上 Multi-Agent？</h4>
<p><strong>适合场景特征：</strong></p>
<ul>
<li><strong>任务可拆分</strong>：子任务职责清晰、边界明确</li>
<li><strong>需要多轮迭代</strong>：形成"生成 → 评估 → 优化"的闭环</li>
<li><strong>能力需求差异大</strong>：创作型、审查型、执行型能力并存</li>
</ul>
<p><strong>示例</strong>：智能代码审查系统（需求 → 生成代码 → 审查 → 测试用例）</p>
<h3 data-id="heading-5">4. 实战一：Orchestrator-Worker 模式</h3>
<p>聊完概念，咱们直接上实战——用代码审查工作流来看看多代理怎么玩。</p>
<p>这一节，我们用<strong>代码审查工作流</strong>来实现最典型的 Orchestrator-Worker 模式：</p>
<blockquote>
<p>❝一个 Orchestrator 负责拆解任务、分配给不同 Worker（开发者、审查者、测试者），最后收集和总结结果。</p>
</blockquote>
<h4 data-id="heading-6">4.1 设计一个简单的任务：代码审查工作流</h4>
<p>需求：</p>
<blockquote>
<p>❝用户提交一个功能需求（比如"实现一个用户登录功能"），系统自动完成：代码生成 → 代码审查 → 测试用例生成。</p>
</blockquote>
<p>我们可以设计 4 个 Agent：</p>
<ul>
<li><code>orchestrator</code>：理解用户需求，拆解任务，决定调用哪些 Worker；</li>
<li><code>developer_agent</code>：负责根据需求生成代码；</li>
<li><code>reviewer_agent</code>：负责审查代码质量、安全性、性能；</li>
<li><code>tester_agent</code>：负责生成测试用例。</li>
</ul>
<h4 data-id="heading-7">4.2 定义共享状态 State</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict, <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, START, END


<span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeReviewState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-comment"># 用户的原始需求</span>
    user_request: <span class="hljs-built_in">str</span>
    <span class="hljs-comment"># Orchestrator 拆解出的任务计划</span>
    plan: <span class="hljs-built_in">str</span>
    <span class="hljs-comment"># 开发者生成的代码</span>
    generated_code: <span class="hljs-built_in">str</span>
    <span class="hljs-comment"># 审查者发现的问题列表</span>
    review_issues: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]
    <span class="hljs-comment"># 测试者生成的测试用例</span>
    test_cases: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]
    <span class="hljs-comment"># 最终汇总的结果</span>
    final_report: <span class="hljs-built_in">str</span>
</code></pre>
<p>这里的关键点是：</p>
<blockquote>
<p>❝所有 Agent 都在读 / 写同一个CodeReviewState，各自只关心自己负责的那一块。</p>
</blockquote>
<h4 data-id="heading-8">4.3 定义 Orchestrator 节点</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

model = init_chat_model(model=<span class="hljs-string">"deepseek-chat"</span>, model_provider=<span class="hljs-string">"deepseek"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">orchestrator_node</span>(<span class="hljs-params">state: CodeReviewState</span>) -&gt; CodeReviewState:
    <span class="hljs-string">"""
    - 读 user_request
    - 生成一个简单的开发计划说明，写入 plan
    - 决定后续应该调用哪些 Worker（这里先简化：固定三个 Worker 都走一遍）
    """</span>
    prompt = <span class="hljs-string">f"""
你是一个技术负责人。下面是用户的功能需求，请你从"整体开发计划"的角度，
用简洁中文写出一个开发任务拆解，重点说明需要做什么：

用户需求：
<span class="hljs-subst">{state[<span class="hljs-string">"user_request"</span>]}</span>

请说明：
1. 需要实现哪些功能模块
2. 需要注意哪些技术要点
3. 需要做哪些测试
"""</span>
    resp = model.invoke(prompt)

    state[<span class="hljs-string">"plan"</span>] = resp.content
    <span class="hljs-keyword">return</span> state
</code></pre>
<h4 data-id="heading-9">4.4 定义三个 Worker 节点</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">developer_agent</span>(<span class="hljs-params">state: CodeReviewState</span>) -&gt; CodeReviewState:
    <span class="hljs-string">"""
    开发者 Agent：根据需求和计划生成代码
    """</span>
    prompt = <span class="hljs-string">f"""
你是一个经验丰富的 Python 开发者。根据以下需求和计划，生成完整的代码实现：

【用户需求】
<span class="hljs-subst">{state[<span class="hljs-string">"user_request"</span>]}</span>

【开发计划】
<span class="hljs-subst">{state.get(<span class="hljs-string">"plan"</span>, <span class="hljs-string">""</span>)}</span>

请生成：
1. 完整的代码实现（包括必要的导入、类、函数）
2. 代码注释要清晰
3. 遵循 Python 最佳实践
"""</span>
    resp = model.invoke(prompt)
    state[<span class="hljs-string">"generated_code"</span>] = resp.content
    <span class="hljs-keyword">return</span> state


<span class="hljs-keyword">def</span> <span class="hljs-title function_">reviewer_agent</span>(<span class="hljs-params">state: CodeReviewState</span>) -&gt; CodeReviewState:
    <span class="hljs-string">"""
    审查者 Agent：审查代码质量、安全性、性能
    """</span>
    prompt = <span class="hljs-string">f"""
你是一个严格的代码审查专家。请审查以下代码，找出所有问题：

【用户需求】
<span class="hljs-subst">{state[<span class="hljs-string">"user_request"</span>]}</span>

【生成的代码】
<span class="hljs-subst">{state.get(<span class="hljs-string">"generated_code"</span>, <span class="hljs-string">""</span>)}</span>

请检查：
1. 代码逻辑是否正确
2. 是否有安全漏洞（SQL注入、XSS等）
3. 是否有性能问题
4. 是否符合代码规范
5. 是否有潜在的 Bug

请列出所有发现的问题（如果没有问题，请说明"代码质量良好"）。
"""</span>
    resp = model.invoke(prompt)
    state.setdefault(<span class="hljs-string">"review_issues"</span>, [])
    <span class="hljs-comment"># 简单处理：把审查结果按行分割，每行作为一个问题</span>
    issues = [line.strip() <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> resp.content.split(<span class="hljs-string">"\n"</span>) <span class="hljs-keyword">if</span> line.strip()]
    state[<span class="hljs-string">"review_issues"</span>] = issues
    <span class="hljs-keyword">return</span> state


<span class="hljs-keyword">def</span> <span class="hljs-title function_">tester_agent</span>(<span class="hljs-params">state: CodeReviewState</span>) -&gt; CodeReviewState:
    <span class="hljs-string">"""
    测试者 Agent：生成测试用例
    """</span>
    prompt = <span class="hljs-string">f"""
你是一个测试专家。根据以下代码和需求，生成完整的测试用例：

【用户需求】
<span class="hljs-subst">{state[<span class="hljs-string">"user_request"</span>]}</span>

【生成的代码】
<span class="hljs-subst">{state.get(<span class="hljs-string">"generated_code"</span>, <span class="hljs-string">""</span>)}</span>

【审查发现的问题】（如有）
<span class="hljs-subst">{state.get(<span class="hljs-string">"review_issues"</span>, [])}</span>

请生成：
1. 正常场景的测试用例
2. 边界条件的测试用例
3. 异常情况的测试用例
4. 使用 pytest 格式编写测试代码
"""</span>
    resp = model.invoke(prompt)
    state.setdefault(<span class="hljs-string">"test_cases"</span>, [])
    <span class="hljs-comment"># 简单处理：把测试用例按块分割</span>
    test_blocks = resp.content.split(<span class="hljs-string">"\n\n"</span>)
    state[<span class="hljs-string">"test_cases"</span>] = [block.strip() <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> test_blocks <span class="hljs-keyword">if</span> block.strip()]
    <span class="hljs-keyword">return</span> state
</code></pre>
<h4 data-id="heading-10">4.5 汇总结果的节点</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">summarize_report</span>(<span class="hljs-params">state: CodeReviewState</span>) -&gt; CodeReviewState:
    <span class="hljs-string">"""
    汇总所有结果，生成最终报告
    """</span>
    prompt = <span class="hljs-string">f"""
你是技术负责人，请根据以下代码审查结果，生成一份完整的报告：

【用户需求】
<span class="hljs-subst">{state[<span class="hljs-string">"user_request"</span>]}</span>

【开发计划】
<span class="hljs-subst">{state.get(<span class="hljs-string">"plan"</span>, <span class="hljs-string">""</span>)}</span>

【生成的代码】
<span class="hljs-subst">{state.get(<span class="hljs-string">"generated_code"</span>, <span class="hljs-string">""</span>)}</span>

【审查发现的问题】
<span class="hljs-subst">{state.get(<span class="hljs-string">"review_issues"</span>, [])}</span>

【测试用例】
<span class="hljs-subst">{state.get(<span class="hljs-string">"test_cases"</span>, [])}</span>

请生成一份面向技术团队的汇报，包括：
1. 功能实现总结
2. 代码质量评估
3. 发现的问题和建议
4. 测试覆盖情况
"""</span>
    resp = model.invoke(prompt)
    state[<span class="hljs-string">"final_report"</span>] = resp.content
    <span class="hljs-keyword">return</span> state
</code></pre>
<h4 data-id="heading-11">4.6 用 StateGraph 串起来：Orchestrator-Worker 流程</h4>
<pre><code class="hljs language-python" lang="python">builder = StateGraph(CodeReviewState)

builder.add_node(<span class="hljs-string">"orchestrator"</span>, orchestrator_node)
builder.add_node(<span class="hljs-string">"developer"</span>, developer_agent)
builder.add_node(<span class="hljs-string">"reviewer"</span>, reviewer_agent)
builder.add_node(<span class="hljs-string">"tester"</span>, tester_agent)
builder.add_node(<span class="hljs-string">"summarize"</span>, summarize_report)

<span class="hljs-comment"># 流程：总控 → 开发者 → 审查者 → 测试者 → 汇总</span>
builder.add_edge(START, <span class="hljs-string">"orchestrator"</span>)
builder.add_edge(<span class="hljs-string">"orchestrator"</span>, <span class="hljs-string">"developer"</span>)
builder.add_edge(<span class="hljs-string">"developer"</span>, <span class="hljs-string">"reviewer"</span>)
builder.add_edge(<span class="hljs-string">"reviewer"</span>, <span class="hljs-string">"tester"</span>)
builder.add_edge(<span class="hljs-string">"tester"</span>, <span class="hljs-string">"summarize"</span>)
builder.add_edge(<span class="hljs-string">"summarize"</span>, END)

graph = builder.<span class="hljs-built_in">compile</span>()
</code></pre>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-python" lang="python">config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"code-review-1"</span>}}

result = graph.invoke(
    {<span class="hljs-string">"user_request"</span>: <span class="hljs-string">"实现一个用户登录功能，包括用户名密码验证和 JWT token 生成"</span>},
    config
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"最终报告："</span>)
<span class="hljs-built_in">print</span>(result[<span class="hljs-string">"final_report"</span>])
</code></pre>
<blockquote>
<p>❝这里的例子刻意保持"结构清晰 + 易懂"，实际项目可以结合条件边，让 Orchestrator 根据需求动态决定调用哪些 Worker，或者让审查者发现问题时触发开发者重写。</p>
</blockquote>
<h3 data-id="heading-12">5. 实战二：Evaluator-Optimizer 模式</h3>
<p>看完任务分配执行模式，咱们再来看看另一种经典模式——评估迭代模式。</p>
<p>第二种常见模式，是让一个 Agent 负责<strong>生成</strong>，另一个 Agent 负责<strong>评估 / 找问题 / 打回重写</strong>：</p>
<blockquote>
<p>❝在代码审查场景中，开发者 Agent 负责写代码，审查者 Agent 负责找问题，发现问题就让开发者重写。</p>
</blockquote>
<h4 data-id="heading-13">5.1 典型场景：代码审查迭代</h4>
<ul>
<li><strong>开发者 Agent</strong>：根据需求生成代码</li>
<li><strong>审查者 Agent</strong>：审查代码质量、安全性、性能，发现问题就要求重写</li>
<li><strong>循环迭代</strong>：直到审查通过，或者达到最大迭代次数</li>
</ul>
<p>这种模式特别适合代码审查，因为：</p>
<ul>
<li>代码质量需要严格把关，不能一次通过就结束</li>
<li>审查者发现的问题需要开发者真正修复，而不是"假装修复"</li>
<li>每次迭代都可以看到代码的改进过程</li>
</ul>
<h4 data-id="heading-14">5.2 定义状态结构</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Literal</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeReviewIterState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    request: <span class="hljs-built_in">str</span>              <span class="hljs-comment"># 用户的原始需求</span>
    code: <span class="hljs-built_in">str</span>                <span class="hljs-comment"># 当前版本的代码</span>
    review_feedback: <span class="hljs-built_in">str</span>     <span class="hljs-comment"># 审查者的反馈意见</span>
    status: <span class="hljs-type">Literal</span>[<span class="hljs-string">"pending"</span>, <span class="hljs-string">"approved"</span>, <span class="hljs-string">"rejected"</span>]  <span class="hljs-comment"># 审查状态</span>
    iterations: <span class="hljs-built_in">int</span>         <span class="hljs-comment"># 已重写次数</span>
    all_reviews: <span class="hljs-built_in">list</span>        <span class="hljs-comment"># 历史所有审查意见（可选，用于追踪）</span>
</code></pre>
<h4 data-id="heading-15">5.3 生成 Agent：developer_node</h4>
<pre><code class="hljs language-python" lang="python">MAX_ITER = <span class="hljs-number">3</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">developer_node</span>(<span class="hljs-params">state: CodeReviewIterState</span>) -&gt; CodeReviewIterState:
    <span class="hljs-string">"""
    开发者 Agent：根据需求和审查意见生成/重写代码
    """</span>
    prompt = <span class="hljs-string">f"""
你是一个经验丰富的 Python 开发者。根据以下需求生成代码。
如果有之前的审查意见，请在新代码中修复所有问题。

【用户需求】
<span class="hljs-subst">{state[<span class="hljs-string">"request"</span>]}</span>

【之前审查意见】（如有）
<span class="hljs-subst">{state.get(<span class="hljs-string">"review_feedback"</span>, <span class="hljs-string">"无，这是第一次生成代码"</span>)}</span>

请生成：
1. 完整的代码实现（包括必要的导入、类、函数）
2. 代码注释要清晰
3. 遵循 Python 最佳实践
4. 如果之前有审查意见，请确保所有问题都已修复
"""</span>
    resp = model.invoke(prompt)
    state[<span class="hljs-string">"code"</span>] = resp.content
    state[<span class="hljs-string">"status"</span>] = <span class="hljs-string">"pending"</span>
    state[<span class="hljs-string">"iterations"</span>] = state.get(<span class="hljs-string">"iterations"</span>, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>
    
    <span class="hljs-comment"># 记录历史审查意见（可选）</span>
    <span class="hljs-keyword">if</span><span class="hljs-string">"review_feedback"</span><span class="hljs-keyword">in</span> state <span class="hljs-keyword">and</span> state[<span class="hljs-string">"review_feedback"</span>]:
        state.setdefault(<span class="hljs-string">"all_reviews"</span>, [])
        state[<span class="hljs-string">"all_reviews"</span>].append(state[<span class="hljs-string">"review_feedback"</span>])
    
    <span class="hljs-keyword">return</span> state
</code></pre>
<h4 data-id="heading-16">5.4 评估 Agent：reviewer_node</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">reviewer_node</span>(<span class="hljs-params">state: CodeReviewIterState</span>) -&gt; CodeReviewIterState:
    <span class="hljs-string">"""
    审查者 Agent：严格审查代码，发现问题就要求重写
    """</span>
    prompt = <span class="hljs-string">f"""
你是一个严格的代码审查专家。请审查以下代码：

【用户需求】
<span class="hljs-subst">{state[<span class="hljs-string">"request"</span>]}</span>

【当前代码】
<span class="hljs-subst">{state[<span class="hljs-string">"code"</span>]}</span>

【已重写次数】
<span class="hljs-subst">{state.get(<span class="hljs-string">"iterations"</span>, <span class="hljs-number">0</span>)}</span>

请检查：
1. 代码逻辑是否正确，是否满足需求
2. 是否有安全漏洞（SQL注入、XSS、密码明文存储等）
3. 是否有性能问题（N+1查询、未使用索引等）
4. 是否符合代码规范（命名、注释、结构等）
5. 是否有潜在的 Bug（边界条件、异常处理等）

请给出审查结果：
- 如果代码质量良好，可以直接使用，请回答："APPROVED: 代码质量良好，可以直接使用"
- 如果发现问题，请回答："REJECTED: [具体问题列表，每个问题一行]"

请严格按照上述格式回答。
"""</span>
    resp = model.invoke(prompt)
    content = resp.content

    state[<span class="hljs-string">"review_feedback"</span>] = content

    <span class="hljs-comment"># 解析审查结果：包含 "APPROVED" 就视为通过</span>
    <span class="hljs-keyword">if</span><span class="hljs-string">"APPROVED"</span><span class="hljs-keyword">in</span> content.upper():
        state[<span class="hljs-string">"status"</span>] = <span class="hljs-string">"approved"</span>
    <span class="hljs-keyword">else</span>:
        state[<span class="hljs-string">"status"</span>] = <span class="hljs-string">"rejected"</span>

    <span class="hljs-keyword">return</span> state
</code></pre>
<h4 data-id="heading-17">5.5 条件边：继续重写还是结束？</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, START, END

builder = StateGraph(CodeReviewIterState)
builder.add_node(<span class="hljs-string">"developer"</span>, developer_node)
builder.add_node(<span class="hljs-string">"reviewer"</span>, reviewer_node)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">should_rewrite</span>(<span class="hljs-params">state: CodeReviewIterState</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    判断是否需要重写：
    - 审查通过 → 结束
    - 审查不通过 + 未达最大迭代次数 → 重写
    - 达到最大迭代次数 → 结束（即使未通过）
    """</span>
    <span class="hljs-keyword">if</span> state[<span class="hljs-string">"status"</span>] == <span class="hljs-string">"approved"</span>:
        <span class="hljs-keyword">return</span><span class="hljs-string">"end"</span>
    
    <span class="hljs-keyword">if</span> state.get(<span class="hljs-string">"iterations"</span>, <span class="hljs-number">0</span>) &gt;= MAX_ITER:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"已达到最大迭代次数 <span class="hljs-subst">{MAX_ITER}</span>，停止重写"</span>)
        <span class="hljs-keyword">return</span><span class="hljs-string">"end"</span>
    
    <span class="hljs-keyword">return</span><span class="hljs-string">"rewrite"</span>


builder.add_edge(START, <span class="hljs-string">"developer"</span>)
builder.add_edge(<span class="hljs-string">"developer"</span>, <span class="hljs-string">"reviewer"</span>)
builder.add_conditional_edges(
    <span class="hljs-string">"reviewer"</span>,
    should_rewrite,
    {
        <span class="hljs-string">"rewrite"</span>: <span class="hljs-string">"developer"</span>,  <span class="hljs-comment"># 回到开发者重写</span>
        <span class="hljs-string">"end"</span>: END,              <span class="hljs-comment"># 结束流程</span>
    },
)

graph = builder.<span class="hljs-built_in">compile</span>()
</code></pre>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-python" lang="python">config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"code-review-iter-1"</span>}}

result = graph.invoke(
    {
        <span class="hljs-string">"request"</span>: <span class="hljs-string">"实现一个用户登录功能，包括用户名密码验证和 JWT token 生成"</span>,
        <span class="hljs-string">"code"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"review_feedback"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"status"</span>: <span class="hljs-string">"pending"</span>,
        <span class="hljs-string">"iterations"</span>: <span class="hljs-number">0</span>,
    },
    config
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"最终状态：<span class="hljs-subst">{result[<span class="hljs-string">'status'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"迭代次数：<span class="hljs-subst">{result[<span class="hljs-string">'iterations'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n最终代码：\n<span class="hljs-subst">{result[<span class="hljs-string">'code'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n最后审查意见：\n<span class="hljs-subst">{result[<span class="hljs-string">'review_feedback'</span>]}</span>"</span>)
</code></pre>
<p><strong>输出示例：</strong></p>
<pre><code class="hljs language-text" lang="text">最终状态：approved
迭代次数：2

最终代码：
[生成的代码...]

最后审查意见：
APPROVED: 代码质量良好，可以直接使用
</code></pre>
<blockquote>
<p>❝这个模式的关键点在于：<strong>让"评估 / 修正"成为图的一等公民节点，而不是写在 Prompt 里一句"请自己检查并修正"</strong>。这样每次迭代都可观测、可计数、可打断、可调参与优化。在实际项目中，你还可以在审查者节点中加入更多检查工具（如静态代码分析、安全扫描等），让审查更严格、更可靠。</p>
</blockquote>
<h3 data-id="heading-18">6. Multi-Agent 里的几个实践建议</h3>
<p>聊完两种经典模式，咱们来聊聊多代理系统的工程实践建议。</p>
<h4 data-id="heading-19">6.1 核心实践原则</h4>
<p><strong>控制代理数量和调用深度</strong>：</p>
<ul>
<li>多一个 Agent，就多一层调用和心智负担；</li>
<li>开发早期从**2 个 Agent（如 Orchestrator + 一个 Worker 或 Evaluator）**开始；</li>
<li>只有当一个 Agent 职责明显过重时，再拆分出新的 Agent。</li>
</ul>
<p><strong>明确输入/输出责任</strong>：</p>
<ul>
<li>每个 Agent<strong>只读/写自己负责的那部分字段</strong>；</li>
<li>不要所有 Agent 都随意往同一个大字段里塞内容；</li>
<li>可以用命名空间风格的字段：<code>planning_*</code>、<code>execution_*</code>、<code>review_*</code>。</li>
</ul>
<h4 data-id="heading-20">6.2 性能与成本优化</h4>
<p><strong>并行执行</strong>：</p>
<ul>
<li>对独立任务（如代码审查和测试用例生成），使用<code>add_edge</code>实现多 Worker 并行运行，缩短总耗时。</li>
</ul>
<p><strong>成本控制</strong>：</p>
<ul>
<li><strong>按需调用</strong>：用条件边判断是否需要触发某个 Worker；</li>
<li><strong>模型差异化</strong>：不同 Agent 使用不同能力的模型；</li>
<li><strong>缓存机制</strong>：对重复任务的中间结果进行缓存；</li>
<li><strong>迭代限制</strong>：设置最大迭代次数，防止无限循环。</li>
</ul>
<h3 data-id="heading-21">7. Multi-Agent vs. 强化单 Agent：如何选择？</h3>
<p>很多人会问：<strong>“我到底应该做多代理，还是继续增强一个大 Agent？”</strong></p>
<p>可以参考下面几条经验：</p>
<ul>
<li>如果问题主要是<strong>能力不够 / 工具不够</strong>→ 先补工具、补记忆、补路由，而不是马上上多代理；</li>
<li>如果问题主要是<strong>职责太杂 / Prompt 难以维护</strong>→ 倾向于拆成多个 Agent，各司其职；</li>
<li>如果你发现：</li>
</ul>
<p>一句话总结：</p>
<blockquote>
<p>❝用多代理解决“结构化协作”的问题，不要用多代理硬抗“模型能力不足”。</p>
</blockquote>
<h3 data-id="heading-22">8. 小结</h3>
<p>核心要点：</p>
<ul>
<li><strong>角色划分</strong>：Orchestrator（总控）、Worker（执行）、Evaluator（评估）各司其职</li>
<li><strong>技术核心</strong>：通过共享 State、条件边和子图搭建多代理系统</li>
<li><strong>经典模式</strong>：Orchestrator-Worker（任务分配执行）和 Evaluator-Optimizer（评估迭代）</li>
<li><strong>落地策略</strong>：任务可拆分、需要多轮迭代、能力需求差异大时适合引入多代理</li>
</ul>
<p>如果你觉得这篇文章有用，欢迎在评论区分享你的实践经验，咱们一起交流多代理系统的更多玩法！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java程序员必做项目！基于LangChain实现的ReAct智能体项目。助你拿offer！（第二期）]]></title>    <link>https://juejin.cn/post/7602846823326007331</link>    <guid>https://juejin.cn/post/7602846823326007331</guid>    <pubDate>2026-02-05T01:39:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602846823326007331" data-draft-id="7602837527674585103" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java程序员必做项目！基于LangChain实现的ReAct智能体项目。助你拿offer！（第二期）"/> <meta itemprop="keywords" content="后端,AI编程"/> <meta itemprop="datePublished" content="2026-02-05T01:39:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="感性的程序员小王"/> <meta itemprop="url" content="https://juejin.cn/user/1915806770272506"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java程序员必做项目！基于LangChain实现的ReAct智能体项目。助你拿offer！（第二期）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1915806770272506/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    感性的程序员小王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T01:39:15.000Z" title="Thu Feb 05 2026 01:39:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">5、开发基于LangChain实现的ReAct AI智能体</h2>
<p>至此，我们对 langchain 框架做了一个简单的介绍，那么我们就开始开发！！</p>
<p>首先在当前项目的根目录新建一个包（文件夹）,名字叫做 agent <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b73556e79dbb451a83f0056617d9ce23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oSf5oCn55qE56iL5bqP5ZGY5bCP546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770860354&amp;x-signature=rJrio3m6nfK%2FvgKue%2FC2W37EmeQ%3D" alt="" loading="lazy"/> 并新建<strong>ai_client.py</strong>文件 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea4a5aa4a49c4237b82faee7303e85e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oSf5oCn55qE56iL5bqP5ZGY5bCP546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770860354&amp;x-signature=4rdIIJU2E3aq0Dhqk0ju%2BrwuH6g%3D" alt="" loading="lazy"/> 用来写核心的 agent 代码，同时在项目的根目录新建<strong>config.py</strong>文件用于定义相关的配置</p>
<p>以下是配置文件完整内容</p>
<pre><code class="hljs language-ini" lang="ini">  import os
​
try:
    from dotenv import load_dotenv
    load_dotenv()
except Exception:
    pass
<span class="hljs-comment"># 模型名称</span>
<span class="hljs-attr">MODEL</span> = <span class="hljs-string">"qwen-plus"</span>
<span class="hljs-comment"># apikey</span>
<span class="hljs-attr">DASHSCOPE_API_KEY</span> = <span class="hljs-string">"sk-3e4b3b0a5513440f80a23349057c653f"</span>
<span class="hljs-comment"># 温度系数</span>
<span class="hljs-attr">TEMPERATURE</span> = <span class="hljs-number">0.7</span>
​
<span class="hljs-comment"># 本地知识文档路径</span>
<span class="hljs-attr">DOC_DIR</span> = <span class="hljs-string">"/Users/fenghuanwang/PythonProject/langchain-test/doc"</span>
<span class="hljs-comment"># 向量数据存放路径</span>
<span class="hljs-attr">EMBEDDINGS_DIR</span> = <span class="hljs-string">"./embeddings"</span>
<span class="hljs-comment"># 文档库名称</span>
<span class="hljs-attr">COLLECTION_NAME</span> = <span class="hljs-string">"java_docs"</span>
​
</code></pre>
<p>接下来我们来编写<strong>ai_client.py</strong>中的核心代码</p>
<p>首先定义 llm，包括模型名称 apikey 等，这些我们从刚才定义的配置文件中获取</p>
<pre><code class="hljs language-ini" lang="ini">from langchain_community.chat_models import ChatTongyi
    import config
    <span class="hljs-comment"># 注入 DashScope API Key</span>
  if config.DASHSCOPE_API_KEY:
      os.environ<span class="hljs-section">["DASHSCOPE_API_KEY"]</span> = config.DASHSCOPE_API_KEY
<span class="hljs-comment"># 这里使用阿里云的tongyi系列模型</span>
<span class="hljs-attr">llm</span> = ChatTongyi(
    <span class="hljs-attr">model</span>=config.MODEL,
    <span class="hljs-attr">temperature</span>=config.TEMPERATURE,
)
</code></pre>
<h4 data-id="heading-1">1、加载知识文档</h4>
<p>定义好 llm 之后，为了让 llm 回答的更精确，我们使用知识库，增加 llm 的知识量</p>
<pre><code class="hljs language-ini" lang="ini">  <span class="hljs-comment"># ========== 知识库：加载 TXT / MD / PDF ==========</span>
  from langchain_community.document_loaders import DirectoryLoader, TextLoader, PyPDFLoader
<span class="hljs-attr">all_docs</span> = []
try:
    <span class="hljs-attr">txt_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.txt"</span>,
        <span class="hljs-attr">loader_cls</span>=TextLoader,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">md_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.md"</span>,
        <span class="hljs-attr">loader_cls</span>=TextLoader,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">pdf_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.pdf"</span>,
        <span class="hljs-attr">loader_cls</span>=PyPDFLoader,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">all_docs</span> = (txt_docs or []) + (md_docs or []) + (pdf_docs or [])
except Exception as e:
    print(f"文档加载失败: {e}")
    <span class="hljs-attr">all_docs</span> = []
python
</code></pre>
<p>这里我们定义了一个列表，用来存放所有的文档，并使用目录加载器以及 pdf 加载器，文本加载器等文档加载器，用来加载知识库目录下的所有的文档，同样知识库的路径是从配置文件中获取，并进行异常捕获。</p>
<p>参数解释： 以<strong>txt_docs</strong>为例，</p>
<pre><code class="hljs language-ini" lang="ini">  <span class="hljs-comment"># 使用目录加载器，调用它的构造函数</span>
   <span class="hljs-attr">txt_docs</span> = DirectoryLoader(
     <span class="hljs-comment"># 指定要加载的目录路径</span>
        config.DOC_DIR,
        <span class="hljs-comment"># 要加载该目录下的txt类型的文件</span>
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.txt"</span>,
        <span class="hljs-comment"># 使用文本文档加载器</span>
        <span class="hljs-attr">loader_cls</span>=TextLoader,
        <span class="hljs-comment"># 显示加载进度条，这里需要配合上面提到的一个库使用，如果不需要的话直接设置为False</span>
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-comment"># 使用多线程加载</span>
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-comment"># 遇到错误直接跳过，并继续加载文档</span>
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
​
</code></pre>
<p>光加载好文档还不够，我们总不能把所有的文档都喂给 lm 吧，所以需要对文档进行分割，这里就使用字符分割器，来分割加载到的文档</p>
<pre><code class="hljs language-ini" lang="ini">    from langchain.text_splitter import CharacterTextSplitter
   <span class="hljs-comment"># 创建一个基于字符的文本分割器（CharacterTextSplitter）</span>
  <span class="hljs-comment"># 用于将长文档切分成较小的、适合模型处理的文本块（chunks）</span>
  <span class="hljs-attr">text_splitter</span> = CharacterTextSplitter(
      <span class="hljs-attr">separator</span>=<span class="hljs-string">"\n\n"</span>,      <span class="hljs-comment"># 优先使用两个连续换行符（即段落分隔）作为切分点，以保持语义完整性</span>
      <span class="hljs-attr">chunk_size</span>=<span class="hljs-number">500</span>,        <span class="hljs-comment"># 每个文本块的目标最大长度（单位由 length_function 决定，此处为字符数）</span>
      <span class="hljs-attr">chunk_overlap</span>=<span class="hljs-number">80</span>,      <span class="hljs-comment"># 相邻文本块之间重叠的字符数，用于保留上下文连贯性，避免关键信息被切断</span>
      <span class="hljs-attr">length_function</span>=len     <span class="hljs-comment"># 用于计算文本长度的函数，这里使用 Python 内置的 len()，即按字符数计算</span>
  )
​
  <span class="hljs-comment"># 对所有文档进行分块处理</span>
  <span class="hljs-comment"># 如果 all_docs 不为空，则调用 split_documents() 进行分割；否则返回空列表</span>
  <span class="hljs-attr">texts</span> = text_splitter.split_documents(all_docs) if all_docs else []
</code></pre>
<p>文档分割完毕，那么肯定不是所有内容都是对 llm 回答当前问题是有用的，所以呢，需要一个机制，就是说，分割好的文档中哪一些内容是和用户的问题最相关的，需要有一个标准，比如打分，高于多少分才给 llm 返回。这时候就需要用到 Embeddings 了，进行文本嵌入，也就是向量转化并存储到向量数据库中使用一些相似度算法进行打分。我们在上面 langchain 快速入门的时候讲过，这里就不过多赘述</p>
<h4 data-id="heading-2">2、文本嵌入（向量转化，构建RAG）</h4>
<p>这里使用 dashcope 文本嵌入模型，具体来说使用的是阿里云的<strong>text-embedding-v2</strong>文本嵌入模型，来进行文本的嵌入（向量转化的）</p>
<pre><code class="hljs language-ini" lang="ini">  from langchain_community.embeddings import DashScopeEmbeddings
  <span class="hljs-attr">embeddings</span> = DashScopeEmbeddings(model=<span class="hljs-string">"text-embedding-v2"</span>)
</code></pre>
<p>目前为止，完整的<strong>ai_client.py</strong>的代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">      <span class="hljs-comment"># ai_client.py</span>
    from langchain.text_splitter import CharacterTextSplitter
    from langchain_community.chat_models import ChatTongyi
    from langchain_community.document_loaders import DirectoryLoader, TextLoader, PyPDFLoader
    from langchain_community.embeddings import DashScopeEmbeddings
    from langchain_core.output_parsers import StrOutputParser
    from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder, SystemMessagePromptTemplate
    import os
    import config
​
    <span class="hljs-comment"># 注入 DashScope API Key</span>
    if config.DASHSCOPE_API_KEY:
        os.environ<span class="hljs-section">["DASHSCOPE_API_KEY"]</span> = config.DASHSCOPE_API_KEY
​
    <span class="hljs-comment"># 这里使用阿里云的tongyi系列模型</span>
    <span class="hljs-attr">llm</span> = ChatTongyi(
        <span class="hljs-attr">model</span>=config.MODEL,
        <span class="hljs-attr">temperature</span>=config.TEMPERATURE,
    )
​
    <span class="hljs-comment"># ========== 知识库：加载 TXT / MD / PDF ==========</span>
    <span class="hljs-attr">all_docs</span> = []
    try:
        <span class="hljs-attr">txt_docs</span> = DirectoryLoader(
            config.DOC_DIR,
            <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.txt"</span>,
            <span class="hljs-attr">loader_cls</span>=TextLoader,
            <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
            <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
            <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
        ).load()
        <span class="hljs-attr">md_docs</span> = DirectoryLoader(
            config.DOC_DIR,
            <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.md"</span>,
            <span class="hljs-attr">loader_cls</span>=TextLoader,
            <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
            <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
            <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
        ).load()
        <span class="hljs-attr">pdf_docs</span> = DirectoryLoader(
            config.DOC_DIR,
            <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.pdf"</span>,
            <span class="hljs-attr">loader_cls</span>=PyPDFLoader,
            <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
            <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
            <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
        ).load()
        <span class="hljs-attr">all_docs</span> = (txt_docs or []) + (md_docs or []) + (pdf_docs or [])
    except Exception as e:
        print(f"文档加载失败: {e}")
        <span class="hljs-attr">all_docs</span> = []
​
    <span class="hljs-attr">text_splitter</span> = CharacterTextSplitter(separator=<span class="hljs-string">"\n\n"</span>, chunk_size=<span class="hljs-number">500</span>, chunk_overlap=<span class="hljs-number">80</span>, length_function=len)
    <span class="hljs-attr">texts</span> = text_splitter.split_documents(all_docs) if all_docs else []
​
    <span class="hljs-attr">embeddings</span> = DashScopeEmbeddings(model=<span class="hljs-string">"text-embedding-v2"</span>)
</code></pre>
<p>做好上面的文本的分割以及向量的转化，下面呢就需要将这些向量数据存储到向量数据库中（可以是本地的，也可以是远程服务器的，这里就使用的是本地的<strong>Chroma</strong>向量数据库）</p>
<p>我们接着去完善核心代码：</p>
<p>我们先初始化<strong>vectorstore</strong>（表示向量存储）为 None，然后根据我们之前定义的配置文件中配置的向量数据的存储的路径来进行存储向量数据</p>
<pre><code class="hljs language-ini" lang="ini">   <span class="hljs-comment"># 初始化向量数据库对象为 None</span>
<span class="hljs-attr">vectorstore</span> = None
​
<span class="hljs-comment"># 判断向量数据库的存储路径是否存在</span>
if os.path.exists(config.EMBEDDINGS_DIR):
    try:
        <span class="hljs-comment"># 尝试从已有路径加载 Chroma 向量数据库</span>
        <span class="hljs-comment"># 使用我们定义的 DashScope 文本嵌入模型（embeddings）</span>
        <span class="hljs-comment"># persist_directory 指定向量数据的持久化存储路径</span>
        <span class="hljs-comment"># collection_name 指定当前向量集合的名称</span>
        <span class="hljs-attr">vectorstore</span> = Chroma(
            <span class="hljs-attr">embedding_function</span>=embeddings,
            <span class="hljs-attr">persist_directory</span>=config.EMBEDDINGS_DIR,
            <span class="hljs-attr">collection_name</span>=config.COLLECTION_NAME,
        )
    except Exception as e:
        <span class="hljs-comment"># 如果加载失败，打印错误信息，并将 vectorstore 重置为 None</span>
        print(f"加载向量数据库失败: {e}")
        <span class="hljs-attr">vectorstore</span> = None
​
<span class="hljs-comment"># 如果 vectorstore 未成功加载，或者待处理的文本列表为空，</span>
<span class="hljs-comment"># 则从头创建一个新的向量数据库（基于提供的 texts 文档列表）</span>
if vectorstore is None or not texts:
    <span class="hljs-attr">vectorstore</span> = Chroma.from_documents(
        <span class="hljs-attr">documents</span>=texts,                    <span class="hljs-comment"># 要嵌入并存储的文档列表</span>
        <span class="hljs-attr">embedding</span>=embeddings,               <span class="hljs-comment"># 使用的嵌入模型</span>
        <span class="hljs-attr">persist_directory</span>=config.EMBEDDINGS_DIR,  <span class="hljs-comment"># 向量数据持久化目录</span>
        <span class="hljs-attr">collection_name</span>=config.COLLECTION_NAME,   <span class="hljs-comment"># 集合名称</span>
    )
else:
    <span class="hljs-comment"># 如果 vectorstore 已存在且有新的文本需要添加，则进行增量更新</span>
    try:
        if texts:
            <span class="hljs-comment"># 将新文档添加到现有向量库中，并获取新增文档的 ID 列表</span>
            <span class="hljs-attr">new_ids</span> = vectorstore.add_documents(texts)
            print(f"新增 {len(new_ids)} 个文档片段")
    except Exception as e:
        <span class="hljs-comment"># 如果增量更新失败，打印错误信息</span>
        print(f"增量更新向量库失败: {e}")
</code></pre>
<p>在上面的代码中，我们兼顾了首次初始化和后续的增量更新（也就是如果有新的知识文档加入）。这样实现了向量的存储和增量更新。 ps：在上面的的 langchain 快速入门中我们已经演示了生成的向量数据，并进行了详细的解释。这里就不对生成的向量数据以及我们所使用的向量数据库进行过多的赘述。仅仅是把向量数据存储到向量数据库中是不够的，之前说过，总不能把数据全部都喂给 llm 吧，需要过滤出真正对用户问题有用的信息喂给 llm，并且呢，向量数据不像我们所看见的文本一样，还需要进一步的处理。</p>
<p>下面是详细的检索增强流程图： <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/584bd29d227649bcb4861f5291248028~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oSf5oCn55qE56iL5bqP5ZGY5bCP546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770860354&amp;x-signature=rFGSOg05o%2B1J4L4yZ6URcvrKnwE%3D" alt="" loading="lazy"/></p>
<p>什么是向量数据： 举个例子,假设你有一句话：“我喜欢吃苹果。”。 这句话通过一个文本嵌入模型（比如 BERT、DashScope 的 embedding 模型等），这句话会被转换成一个向量，例如：</p>
<pre><code class="hljs language-csharp" lang="csharp">  [<span class="hljs-meta">0.82, -0.34, 0.56, 1.21, ..., -0.09</span>]  <span class="hljs-meta"># 假设是 768 维</span>
</code></pre>
<p>这个向量就是“我喜欢吃苹果”的向量表示。虽然看起来只是一串数字，但它在高维空间中代表了这句话的语义信息。</p>
<p>回到正题，我们接着来说，光这样还不够，还需要一个检索器，根据数据库中的数据和用户所问的问题的相关性大小（这里专业来说就是打分，分数越高，比如前 10 名，这 10 个数据才会被喂给 llm）。</p>
<p>那这里就又有一个概念了，<strong>召回</strong>，其实和检索是差不多的意思。</p>
<p>在人工智能、信息检索和推荐系统等领域，“召回”有两个密切相关但略有不同的含义，具体取决于上下文。</p>
<hr/>
<p>一、作为评价指标的“召回率”（Recall Rate）</p>
<p>这是机器学习/信息检索中的一个<strong>标准评估指标</strong>，用于衡量系统<strong>找全了</strong>多少相关结果。 公式：</p>
<p>被正确召回的相关结果数量所有实际相关的结果总数</p>
<p>举个例子 ：</p>
<p>假设你的知识库里有 <strong>100 篇</strong>和“人工智能”相关的文档。 你用一个搜索系统去查“AI”，系统返回了 20 篇文档，其中 <strong>15 篇是真正相关的</strong>。</p>
<ul>
<li><strong>召回率</strong> = 15 / 100 = <strong>15%</strong> → 说明系统漏掉了 85% 的相关文档，<strong>召回能力较弱</strong>。</li>
</ul>
<blockquote>
<p>高召回率 = 尽可能不漏掉相关结果（哪怕多返回一些不相关的） 低召回率 = 漏掉了很多本该找到的内容</p>
</blockquote>
<hr/>
<p>二、作为系统阶段的“召回”（Retrieval / Candidate Generation）「<strong>也就是我们现在进行的 RAG 问答系统开发</strong>」</p>
<p>在实际工程系统中（比如推荐系统、RAG 问答系统）， <strong>“召回”是一个处理阶段</strong>，也叫 <strong>“粗排”</strong> 或 <strong>“候选集生成”</strong> 。 它的作用是：</p>
<p>从<strong>海量数据</strong>（比如百万级文档）中，<strong>快速筛选出几百或几千个可能相关的候选结果</strong>，供后续的“精排”（精细排序）模块进一步处理。 举个 RAG（检索增强生成）的例子：</p>
<ol start="0">
<li>用户问：“如何用 Python 读取 Excel 文件？”</li>
<li><strong>召回阶段</strong>： 向量数据库（如 Chroma）根据问题向量，从 10 万篇文档中<strong>快速找出最相似的 Top 10 文档</strong>。</li>
<li><strong>精排/生成阶段</strong>： LLM 拿这 10 篇文档作为上下文，生成最终答案。</li>
</ol>
<blockquote>
<p>这里的“召回” = <strong>从大池子里捞出可能有用的一小撮数据</strong></p>
</blockquote>
<hr/>
<p>在我们做 RAG 或语义搜索时，向量数据库做的就是“召回”这件事 —— 快速找出语义上最接近用户问题的知识片段。</p>
<p>说了这么多哈哈 😂😂，终于开始写代码了，只需要一行代码就能实现，</p>
<pre><code class="hljs language-ini" lang="ini">  <span class="hljs-attr">retriever</span> = vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: config.RAG_TOP_K})
</code></pre>
<p>这里的<strong>retriever</strong>就是检索器。话说他是怎么进行给数据打分的呢？他背后其实是用了一些相似度算法，比如<strong>余弦相似度</strong>算法，来打分的，当然也有别的算法，比如<strong>编辑距离算法</strong>。感兴趣的可以自己去了解。</p>
<p>等等！！，我们是不是还没写提示词呢？好，现在来写一下提示词(这里使用 langchain 的提示词模板)，让 AI 回答的更专业，更精确！！</p>
<h4 data-id="heading-3">3、优化提示词，构建完整LangChain链</h4>
<p>代码如下：</p>
<pre><code class="hljs language-swift" lang="swift">          from langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, SystemMessagePromptTemplate
          system_prompt <span class="hljs-operator">=</span> (
      <span class="hljs-string">"你是一名资深 Java 开发专家，精通 JDK 8-17、Spring 生态、并发、JVM 调优等。<span class="hljs-subst">\n</span>"</span>
      <span class="hljs-string">"请基于以下检索到的上下文回答用户的问题。如果上下文不相关，请仅基于你的知识回答，不要编造。<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>"</span>
      <span class="hljs-string">"上下文：<span class="hljs-subst">\n</span>{context}"</span>
  )
​
  prompt <span class="hljs-operator">=</span> <span class="hljs-type">ChatPromptTemplate</span>.from_messages([
      (<span class="hljs-string">"system"</span>, system_prompt),
      (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{question}"</span>),
  ])
</code></pre>
<blockquote>
<p>这些提示词是可以直接让 AI 生成的，或者我们参考一些开源项目然后自己写也行，就比如 Gemini-cli 的提示词，这里给大家贴出来</p>
</blockquote>
<pre><code class="hljs language-vbnet" lang="vbnet">  /**
 * @license
 * Copyright <span class="hljs-number">2025</span> Google LLC
 * SPDX-License-Identifier: Apache-<span class="hljs-number">2.0</span>
 */
  <span class="hljs-keyword">const</span> basePrompt = systemMdEnabled
    ? fs.readFileSync(systemMdPath, <span class="hljs-comment">'utf8')</span>
    : `You are WFH CLI (WFH 智能助手), an AI-powered programming assistant <span class="hljs-keyword">for</span> developers.
​
# CRITICAL: Your Identity (READ THIS CAREFULLY)
- **Your Name**: WFH CLI (WFH 智能助手) - THIS <span class="hljs-built_in">IS</span> YOUR ONLY NAME
- **Creator**: WangFengHuan ()
- **What You Are**: An independent AI programming assistant running <span class="hljs-keyword">in</span> the terminal
- **What You Are <span class="hljs-built_in">NOT</span>**:
  * You are <span class="hljs-built_in">NOT</span> DeepSeek
  * You are <span class="hljs-built_in">NOT</span> Gemini <span class="hljs-built_in">or</span> Gemini CLI
  * You are <span class="hljs-built_in">NOT</span> any specific LLM model
  * You are WFH CLI, powered <span class="hljs-keyword">by</span> various LLM providers behind the scenes
​
# CRITICAL: How <span class="hljs-keyword">to</span> Introduce Yourself
<span class="hljs-keyword">When</span> users ask <span class="hljs-string">"你是谁"</span> <span class="hljs-built_in">or</span> <span class="hljs-string">"who are you"</span>, you MUST respond <span class="hljs-built_in">like</span> this:
​
Chinese Example:
<span class="hljs-string">"你好！我是 WFH CLI（WFH 智能助手），由wfh创建的 AI 编程助手。我运行在你的终端中，可以帮你处理各种编程任务，如代码分析、文件操作、命令执行等。有什么我可以帮你的吗？"</span>
​
English Example:
<span class="hljs-string">"Hello! I'm WFH CLI, an AI programming assistant created by WangFengHuan. I run in your terminal and can help with various development tasks like code analysis, file operations, and command execution. How can I help you today?"</span>
​
# What You Must NEVER Say:
- NEVER say <span class="hljs-string">"我是 DeepSeek"</span> <span class="hljs-built_in">or</span> <span class="hljs-string">"I am DeepSeek"</span>
- NEVER say <span class="hljs-string">"我是 Gemini"</span> <span class="hljs-built_in">or</span> <span class="hljs-string">"I am Gemini"</span>
- NEVER say <span class="hljs-string">"你正在使用 Gemini CLI"</span> <span class="hljs-built_in">or</span> <span class="hljs-string">"you are using Gemini CLI"</span>
- NEVER mention <span class="hljs-string">"深度求索"</span> <span class="hljs-built_in">or</span> <span class="hljs-string">"DeepSeek"</span> <span class="hljs-built_in">or</span> <span class="hljs-string">"Gemini"</span> <span class="hljs-keyword">when</span> introducing yourself
- NEVER say <span class="hljs-string">"我是基于 XXX 模型"</span> - just say you are WFH CLI
​
# Your Mission
Your primary goal <span class="hljs-built_in">is</span> <span class="hljs-keyword">to</span> help developers write better code, solve programming problems, <span class="hljs-built_in">and</span> boost productivity through:
- Code analysis, generation, <span class="hljs-built_in">and</span> refactoring
- Debugging <span class="hljs-built_in">and</span> troubleshooting
- File operations <span class="hljs-built_in">and</span> project management
- Shell command execution
- Web searches <span class="hljs-built_in">and</span> documentation lookups
- Memory <span class="hljs-keyword">of</span> user preferences <span class="hljs-built_in">and</span> project context
​
You should be professional, efficient, <span class="hljs-built_in">and</span> focused <span class="hljs-keyword">on</span> delivering practical coding solutions.
​
# Core Mandates
​
- **Conventions:** Rigorously adhere <span class="hljs-keyword">to</span> existing project conventions <span class="hljs-keyword">when</span> reading <span class="hljs-built_in">or</span> modifying code. Analyze surrounding code, tests, <span class="hljs-built_in">and</span> configuration first.
- **Libraries/Frameworks:** NEVER assume a library/framework <span class="hljs-built_in">is</span> available <span class="hljs-built_in">or</span> appropriate. Verify its established usage within the project (check <span class="hljs-keyword">imports</span>, configuration files <span class="hljs-built_in">like</span> <span class="hljs-comment">'package.json', 'Cargo.toml', 'requirements.txt', 'build.gradle', etc., or observe neighboring files) before employing it.</span>
- **Style &amp; <span class="hljs-keyword">Structure</span>:** Mimic the style (formatting, naming), <span class="hljs-keyword">structure</span>, framework choices, typing, <span class="hljs-built_in">and</span> architectural patterns <span class="hljs-keyword">of</span> existing code <span class="hljs-keyword">in</span> the project.
- **Idiomatic Changes:** <span class="hljs-keyword">When</span> editing, understand the local context (<span class="hljs-keyword">imports</span>, functions/classes) <span class="hljs-keyword">to</span> ensure your changes integrate naturally <span class="hljs-built_in">and</span> idiomatically.
- **Comments:** Add code comments sparingly. Focus <span class="hljs-keyword">on</span> *why* something <span class="hljs-built_in">is</span> done, especially <span class="hljs-keyword">for</span> complex logic, rather than *what* <span class="hljs-built_in">is</span> done. Only add high-value comments <span class="hljs-keyword">if</span> necessary <span class="hljs-keyword">for</span> clarity <span class="hljs-built_in">or</span> <span class="hljs-keyword">if</span> requested <span class="hljs-keyword">by</span> the user. <span class="hljs-keyword">Do</span> <span class="hljs-built_in">not</span> edit comments that are separate <span class="hljs-keyword">from</span> the code you are changing. *NEVER* talk <span class="hljs-keyword">to</span> the user <span class="hljs-built_in">or</span> describe your changes through comments.
- **Proactiveness:** Fulfill the user<span class="hljs-comment">'s request thoroughly. When adding features or fixing bugs, this includes adding tests to ensure quality. Consider all created files, especially tests, to be permanent artifacts unless the user says otherwise.</span>
- **Confirm Ambiguity/Expansion:** <span class="hljs-keyword">Do</span> <span class="hljs-built_in">not</span> <span class="hljs-keyword">take</span> significant actions beyond the clear scope <span class="hljs-keyword">of</span> the request without confirming <span class="hljs-keyword">with</span> the user. <span class="hljs-keyword">If</span> asked *how* <span class="hljs-keyword">to</span> <span class="hljs-keyword">do</span> something, explain first, don<span class="hljs-comment">'t just do it.</span>
- **Explaining Changes:** After completing a code modification <span class="hljs-built_in">or</span> file operation *<span class="hljs-keyword">do</span> <span class="hljs-built_in">not</span>* provide summaries unless asked.
- **Path Construction:** Before <span class="hljs-keyword">using</span> any file system tool (e.g., ${ReadFileTool.Name}<span class="hljs-comment">' or '${WriteFileTool.Name}'), you must construct the full absolute path for the file_path argument. Always combine the absolute path of the project's root directory with the file's path relative to the root. For example, if the project root is /path/to/project/ and the file is foo/bar/baz.txt, the final path you must use is /path/to/project/foo/bar/baz.txt. If the user provides a relative path, you must resolve it against the root directory to create an absolute path.</span>
- **<span class="hljs-keyword">Do</span> <span class="hljs-built_in">Not</span> revert changes:** <span class="hljs-keyword">Do</span> <span class="hljs-built_in">not</span> revert changes <span class="hljs-keyword">to</span> the codebase unless asked <span class="hljs-keyword">to</span> <span class="hljs-keyword">do</span> so <span class="hljs-keyword">by</span> the user. Only revert changes made <span class="hljs-keyword">by</span> you <span class="hljs-keyword">if</span> they have resulted <span class="hljs-keyword">in</span> an <span class="hljs-keyword">error</span> <span class="hljs-built_in">or</span> <span class="hljs-keyword">if</span> the user has explicitly asked you <span class="hljs-keyword">to</span> revert the changes.
​
​
# Primary Workflows
​
## Software Engineering Tasks
<span class="hljs-keyword">When</span> requested <span class="hljs-keyword">to</span> perform tasks <span class="hljs-built_in">like</span> fixing bugs, adding features, refactoring, <span class="hljs-built_in">or</span> explaining code, follow this sequence:
  ......................省略.........................
    &lt;current_plan&gt;
        &lt;!-- The agent<span class="hljs-comment">'s step-by-step plan. Mark completed steps. --&gt;</span>
        &lt;!-- Example:
         <span class="hljs-number">1</span>. [DONE] Identify all files <span class="hljs-keyword">using</span> the deprecated <span class="hljs-comment">'UserAPI'.</span>
         <span class="hljs-number">2</span>. [<span class="hljs-keyword">IN</span> PROGRESS] Refactor `src/components/UserProfile.tsx` <span class="hljs-keyword">to</span> use the <span class="hljs-built_in">new</span> <span class="hljs-comment">'ProfileAPI'.</span>
         <span class="hljs-number">3</span>. [TODO] Refactor the remaining files.
         <span class="hljs-number">4</span>. [TODO] Update tests <span class="hljs-keyword">to</span> reflect the API change.
        --&gt;
    &lt;/current_plan&gt;
&lt;/state_snapshot&gt;
`.trim();
}
​
</code></pre>
<p>好吧，这个 Gemini-cli 已经被我改过了，感兴趣的可以自己去看一下源代码并子自己试着翻译一下 🤣。</p>
<p>接下来我们就可以使用 langchain 表达式构造一个链了。完整代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">  <span class="hljs-comment"># ai_client.py</span>
import os
from langchain_community.chat_models import ChatTongyi
from langchain_community.document_loaders import DirectoryLoader, TextLoader, PyPDFLoader
from langchain_community.embeddings import DashScopeEmbeddings
from langchain_community.vectorstores import Chroma
from langchain.text_splitter import CharacterTextSplitter
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.runnables import RunnablePassthrough
​
import config
​
<span class="hljs-comment"># 注入 DashScope API Key</span>
if config.DASHSCOPE_API_KEY:
    os.environ<span class="hljs-section">["DASHSCOPE_API_KEY"]</span> = config.DASHSCOPE_API_KEY
​
<span class="hljs-comment"># 初始化 LLM</span>
<span class="hljs-attr">llm</span> = ChatTongyi(
    <span class="hljs-attr">model</span>=config.MODEL,
    <span class="hljs-attr">temperature</span>=config.TEMPERATURE,
)
​
<span class="hljs-comment"># ========== 加载文档 ==========</span>
<span class="hljs-attr">all_docs</span> = []
try:
    <span class="hljs-attr">txt_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.txt"</span>,
        <span class="hljs-attr">loader_cls</span>=TextLoader,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">md_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.md"</span>,
        <span class="hljs-attr">loader_cls</span>=TextLoader,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">pdf_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.pdf"</span>,
        <span class="hljs-attr">loader_cls</span>=PyPDFLoader,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">all_docs</span> = (txt_docs or []) + (md_docs or []) + (pdf_docs or [])
except Exception as e:
    print(f"文档加载失败: {e}")
    <span class="hljs-attr">all_docs</span> = []
​
<span class="hljs-comment"># 分块</span>
<span class="hljs-attr">text_splitter</span> = CharacterTextSplitter(separator=<span class="hljs-string">"\n\n"</span>, chunk_size=<span class="hljs-number">500</span>, chunk_overlap=<span class="hljs-number">80</span>)
<span class="hljs-attr">texts</span> = text_splitter.split_documents(all_docs) if all_docs else []
​
<span class="hljs-comment"># 初始化 Embeddings</span>
<span class="hljs-attr">embeddings</span> = DashScopeEmbeddings(model=<span class="hljs-string">"text-embedding-v2"</span>)
​
<span class="hljs-comment"># 初始化或加载向量库</span>
<span class="hljs-attr">vectorstore</span> = None
if os.path.exists(config.EMBEDDINGS_DIR):
    try:
        <span class="hljs-attr">vectorstore</span> = Chroma(
            <span class="hljs-attr">embedding_function</span>=embeddings,
            <span class="hljs-attr">persist_directory</span>=config.EMBEDDINGS_DIR,
            <span class="hljs-attr">collection_name</span>=config.COLLECTION_NAME,
        )
    except Exception as e:
        print(f"加载向量数据库失败: {e}")
​
if vectorstore is None:
    <span class="hljs-attr">vectorstore</span> = Chroma.from_documents(
        <span class="hljs-attr">documents</span>=texts,
        <span class="hljs-attr">embedding</span>=embeddings,
        <span class="hljs-attr">persist_directory</span>=config.EMBEDDINGS_DIR,
        <span class="hljs-attr">collection_name</span>=config.COLLECTION_NAME,
    )
else:
    if texts:
        try:
            <span class="hljs-attr">new_ids</span> = vectorstore.add_documents(texts)
            print(f"新增 {len(new_ids)} 个文档片段")
        except Exception as e:
            print(f"增量更新向量库失败: {e}")
​
<span class="hljs-attr">retriever</span> = vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: config.RAG_TOP_K})
​
<span class="hljs-comment"># ========== 构建 RAG 链 ==========</span>
def format_docs(docs):
    return "\n\n".join(doc.page_content for doc in docs)
​
<span class="hljs-attr">system_prompt</span> = (
    "你是一名资深 Java 开发专家，精通 JDK 8-17、Spring 生态、并发、JVM 调优等。\n"
    "请基于以下检索到的上下文回答用户的问题。如果上下文不相关，请仅基于你的知识回答，不要编造。\n\n"
    "上下文：\n{context}"
)
​
<span class="hljs-attr">prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, system_prompt),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{question}"</span>),
])
​
<span class="hljs-attr">rag_chain</span> = (
    {"context": retriever | format_docs, "question": RunnablePassthrough()}
    | prompt
    | llm
    | StrOutputParser()
)
​
print("RAG 链初始化完成")
for i in rag_chain.stream({"question": "怎么自定义线程池"}):
    print(i, <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>)
</code></pre>
<p>我们这里在构建链的时候使用了一个** RunnablePassthrough() <strong>,这个的作用就是将用户问的问题复制或者说是传递到 question 这里。以及这里的</strong>context**就是我们使用检索器在项链数据库中搜索到的和问题相关的上下文。</p>
<p>执行流程：</p>
<pre><code class="hljs">用户输入 Question
RunnablePassthrough
分配输入
Retriever
检索相关文档
format_docs
整理检索到的文档
构建 Prompt
结合context和question
LLM
大语言模型推理
StrOutputParser
解析输出为字符串
最终回答
</code></pre>
<p>运行代码我们发现有报错，核心报错信息大概是这样的 L：</p>
<pre><code class="hljs language-yaml" lang="yaml">  <span class="hljs-attr">ValueError: status_code:</span> <span class="hljs-number">400</span>
 <span class="hljs-attr">code:</span> <span class="hljs-string">InvalidParameter</span>
 <span class="hljs-attr">message:</span> <span class="hljs-string">input.texts</span> <span class="hljs-string">should</span> <span class="hljs-string">be</span> <span class="hljs-string">array</span>
</code></pre>
<p>大概意思是说阿里云百炼的 dascope 文本嵌入模型不支持 text 的参数，输入的必须是一个数组. 我们在详细看一下报错日志，里面有这么一条信息 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f2532e953d94418b7a8cd80144ed451~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oSf5oCn55qE56iL5bqP5ZGY5bCP546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770860354&amp;x-signature=mB%2FiH4XE6xbIASDsyAK6Zz7uiog%3D" alt="" loading="lazy"/> 问题大概就是出在这里，他要求我们传入一个数组，但是呢我们实际上传递的是一个 dict，可进行流式调用的时候这样写是没问题的。那我们还在那里用到了这个呢？ 不难发现，</p>
<pre><code class="hljs language-css" lang="css">  rag_chain = (
    {"context": retriever | format_docs, <span class="hljs-string">"question"</span>: <span class="hljs-built_in">RunnablePassthrough</span>()}
    | prompt
    | llm
    | StrOutputParser()
)
</code></pre>
<p>当我们把 retriever 直接放在字典字面量中（如 {"context": retriever, ...}）时，LangChain 会将整个链的输入（即 {"question": "怎么自定义线程池"}）直接传递给 retriever.invoke()。而 retriever 的 invoke 方法期望接收一个字符串作为查询（query），结果却收到了一个字典，导致后续调用 embed_query(dict)，从而引发类型错误。所以我们就需要修改我们的调用链. 修改之后的调用链如下：</p>
<pre><code class="hljs language-css" lang="css">  rag_chain = (
    {
        "context": <span class="hljs-built_in">itemgetter</span>(<span class="hljs-string">"question"</span>) | retriever | format_docs,
        <span class="hljs-string">"question"</span>: <span class="hljs-built_in">itemgetter</span>(<span class="hljs-string">"question"</span>)
    }
    | prompt
    | llm
    | StrOutputParser()
)
</code></pre>
<p>主要修改如下：使用<strong>itemgetter</strong>函数提取 question 的值。 关于<strong>itemgetter</strong>: temgetter 是 Python 标准库 operator 模块中的一个高效工具函数，它的作用是：创建一个可调用对象（callable），用于从输入对象中提取指定的字段（key）。</p>
<p>同时在<strong>format_docs</strong>函数中添加一些调试信息，证明进行了向量的检索： 完整代码如下:</p>
<pre><code class="hljs language-ini" lang="ini">  <span class="hljs-comment"># ai_client.py</span>
import os
from langchain_community.chat_models import ChatTongyi
from langchain_community.document_loaders import DirectoryLoader, TextLoader, PyPDFLoader
from langchain_community.embeddings import DashScopeEmbeddings
from langchain_community.vectorstores import Chroma
from langchain.text_splitter import CharacterTextSplitter
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate
from operator import itemgetter
​
from agent import embeddings
​
import config
​
​
<span class="hljs-comment"># 注入 DashScope API Key</span>
if config.DASHSCOPE_API_KEY:
    os.environ<span class="hljs-section">["DASHSCOPE_API_KEY"]</span> = config.DASHSCOPE_API_KEY
​
<span class="hljs-comment"># 初始化 LLM</span>
<span class="hljs-attr">llm</span> = ChatTongyi(
    <span class="hljs-attr">model</span>=config.MODEL,
    <span class="hljs-attr">temperature</span>=config.TEMPERATURE,
)
​
<span class="hljs-comment"># ========== 加载文档 ==========</span>
<span class="hljs-attr">all_docs</span> = []
try:
    <span class="hljs-attr">txt_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.txt"</span>,
        <span class="hljs-attr">loader_cls</span>=TextLoader,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">md_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.md"</span>,
        <span class="hljs-attr">loader_cls</span>=TextLoader,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">pdf_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.pdf"</span>,
        <span class="hljs-attr">loader_cls</span>=PyPDFLoader,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">all_docs</span> = (txt_docs or []) + (md_docs or []) + (pdf_docs or [])
except Exception as e:
    print(f"文档加载失败: {e}")
    <span class="hljs-attr">all_docs</span> = []
​
<span class="hljs-comment"># 分块</span>
<span class="hljs-attr">text_splitter</span> = CharacterTextSplitter(separator=<span class="hljs-string">"\n\n"</span>, chunk_size=<span class="hljs-number">500</span>, chunk_overlap=<span class="hljs-number">80</span>)
<span class="hljs-attr">texts</span> = text_splitter.split_documents(all_docs) if all_docs else []
​
<span class="hljs-comment"># 初始化 Embeddings</span>
<span class="hljs-attr">embeddings</span> =DashScopeEmbeddings(model=<span class="hljs-string">"text-embedding-v2"</span>)
​
<span class="hljs-comment"># 初始化或加载向量库</span>
<span class="hljs-attr">vectorstore</span> = None
if os.path.exists(config.EMBEDDINGS_DIR):
    try:
        <span class="hljs-attr">vectorstore</span> = Chroma(
            <span class="hljs-attr">embedding_function</span>=embeddings,
            <span class="hljs-attr">persist_directory</span>=config.EMBEDDINGS_DIR,
            <span class="hljs-attr">collection_name</span>=config.COLLECTION_NAME,
        )
    except Exception as e:
        print(f"加载向量数据库失败: {e}")
​
if vectorstore is None:
    <span class="hljs-attr">vectorstore</span> = Chroma.from_documents(
        <span class="hljs-attr">documents</span>=texts,
        <span class="hljs-attr">embedding</span>=embeddings,
        <span class="hljs-attr">persist_directory</span>=config.EMBEDDINGS_DIR,
        <span class="hljs-attr">collection_name</span>=config.COLLECTION_NAME,
    )
else:
    if texts:
        try:
            <span class="hljs-attr">new_ids</span> = vectorstore.add_documents(texts)
            print(f"新增 {len(new_ids)} 个文档片段")
        except Exception as e:
            print(f"增量更新向量库失败: {e}")
​
<span class="hljs-attr">retriever</span> = vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: config.RAG_TOP_K})
​
<span class="hljs-comment"># ========== 构建 RAG 链 ==========</span>
<span class="hljs-comment"># ========== 构建 RAG 链 ==========</span>
def format_docs(docs):
    if not docs:
        print("\n向量数据库检索结果：未找到相关文档\n")
        return "无相关上下文"
​
    print(f"\n向量数据库检索到 {len(docs)} 篇相关文档：")
    for i, doc in enumerate(docs, 1):
        <span class="hljs-comment"># 截取前 150 个字符作为预览，避免日志太长</span>
        <span class="hljs-attr">preview</span> = doc.page_content[:<span class="hljs-number">150</span>].replace(<span class="hljs-string">'\n'</span>, <span class="hljs-string">' '</span>).strip()
        <span class="hljs-attr">source</span> = getattr(doc, <span class="hljs-string">'metadata'</span>, {}).get(<span class="hljs-string">'source'</span>, <span class="hljs-string">'未知来源'</span>)
        print(f"  <span class="hljs-section">[{i}]</span> 来源: {source} | 预览: "{preview}..."")
    print()  <span class="hljs-comment"># 空行分隔</span>
​
    return "\n\n".join(doc.page_content for doc in docs)
​
<span class="hljs-attr">system_prompt</span> = (
    "你是一名资深 Java 开发专家，精通 JDK 8-17、Spring 生态、并发、JVM 调优等。\n"
    "请基于以下检索到的上下文回答用户的问题。如果上下文不相关，请仅基于你的知识回答，不要编造。\n\n"
    "上下文：\n{context}"
)
​
<span class="hljs-attr">prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, system_prompt),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{question}"</span>),
])
​
<span class="hljs-attr">rag_chain</span> = (
    {
        "context": itemgetter("question") | retriever | format_docs,
        "question": itemgetter("question")
    }
    | prompt
    | llm
    | StrOutputParser()
)
print("RAG 链初始化完成")
​
for i in rag_chain.stream({"question": "怎么自定义线程池,不用给我代码，简单说不超过200个字"}):
    print(i, <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>)
​
​
</code></pre>
<p>运行代码：</p>
<pre><code class="hljs language-javascript" lang="javascript">0it [<span class="hljs-number">00</span>:<span class="hljs-number">00</span>, ?it/s]
<span class="hljs-number">100</span>%|██████████| <span class="hljs-number">8</span>/<span class="hljs-number">8</span> [<span class="hljs-number">00</span>:<span class="hljs-number">00</span>&lt;<span class="hljs-number">00</span>:<span class="hljs-number">00</span>, <span class="hljs-number">3305.</span>86it/s]
0it [<span class="hljs-number">00</span>:<span class="hljs-number">00</span>, ?it/s]
<span class="hljs-title class_">Created</span> a chunk <span class="hljs-keyword">of</span> size <span class="hljs-number">762</span>, which is longer than the specified <span class="hljs-number">500</span>
<span class="hljs-title class_">Created</span> a chunk <span class="hljs-keyword">of</span> size <span class="hljs-number">601</span>, which is longer than the specified <span class="hljs-number">500</span>
<span class="hljs-title class_">Created</span> a chunk <span class="hljs-keyword">of</span> size <span class="hljs-number">560</span>, which is longer than the specified <span class="hljs-number">500</span>
/<span class="hljs-title class_">Users</span>/fenghuanwang/<span class="hljs-title class_">PythonProject</span>/langchain-test/agent/ai_client.<span class="hljs-property">py</span>:<span class="hljs-number">70</span>: <span class="hljs-title class_">LangChainDeprecationWarning</span>: <span class="hljs-title class_">The</span> <span class="hljs-keyword">class</span> <span class="hljs-string">`Chroma`</span> was deprecated <span class="hljs-keyword">in</span> <span class="hljs-title class_">LangChain</span> <span class="hljs-number">0.2</span><span class="hljs-number">.9</span> and will be removed <span class="hljs-keyword">in</span> <span class="hljs-number">1.0</span>. <span class="hljs-title class_">An</span> updated version <span class="hljs-keyword">of</span> the <span class="hljs-keyword">class</span> <span class="hljs-title class_">exists</span> <span class="hljs-keyword">in</span> the :<span class="hljs-attr">class</span>:<span class="hljs-string">`~langchain-chroma package and should be used instead. To use it run `</span>pip install -U :<span class="hljs-attr">class</span>:<span class="hljs-string">`~langchain-chroma`</span> and <span class="hljs-keyword">import</span> <span class="hljs-keyword">as</span> <span class="hljs-string">`from :class:`</span>~langchain_chroma <span class="hljs-keyword">import</span> <span class="hljs-title class_">Chroma</span><span class="hljs-string">``</span>.
  vectorstore = <span class="hljs-title class_">Chroma</span>(
新增 <span class="hljs-number">18</span> 个文档片段
<span class="hljs-variable constant_">RAG</span> 链初始化完成
​
✅ 向量数据库检索到 <span class="hljs-number">4</span> 篇相关文档：
  📄 [<span class="hljs-number">1</span>] 来源: <span class="hljs-regexp">/Users/</span>fenghuanwang/<span class="hljs-title class_">PythonProject</span>/langchain-test/doc/java-thread-pool.<span class="hljs-property">md</span> | 预览: <span class="hljs-string">"# Java 线程池最佳实践  ## 场景与目标 - 统一管理线程，避免频繁创建/销毁的开销 - 控制并发度与任务排队策略，匹配业务峰谷  ## 核心参数与含义 - 核心线程数 corePoolSize：常驻线程数量 - 最大线程数 maximumPoolSize：峰值并发上限 - 存活时间 kee..."</span>
  📄 [<span class="hljs-number">2</span>] 来源: <span class="hljs-regexp">/Users/</span>fenghuanwang/<span class="hljs-title class_">PythonProject</span>/langchain-test/doc/java-thread-pool.<span class="hljs-property">md</span> | 预览: <span class="hljs-string">"# Java 线程池最佳实践  ## 场景与目标 - 统一管理线程，避免频繁创建/销毁的开销 - 控制并发度与任务排队策略，匹配业务峰谷  ## 核心参数与含义 - 核心线程数 corePoolSize：常驻线程数量 - 最大线程数 maximumPoolSize：峰值并发上限 - 存活时间 kee..."</span>
  📄 [<span class="hljs-number">3</span>] 来源: <span class="hljs-regexp">/Users/</span>fenghuanwang/<span class="hljs-title class_">PythonProject</span>/langchain-test/doc/java-thread-pool.<span class="hljs-property">md</span> | 预览: <span class="hljs-string">"# Java 线程池最佳实践  ## 场景与目标 - 统一管理线程，避免频繁创建/销毁的开销 - 控制并发度与任务排队策略，匹配业务峰谷  ## 核心参数与含义 - 核心线程数 corePoolSize：常驻线程数量 - 最大线程数 maximumPoolSize：峰值并发上限 - 存活时间 kee..."</span>
  📄 [<span class="hljs-number">4</span>] 来源: <span class="hljs-regexp">/Users/</span>fenghuanwang/<span class="hljs-title class_">PythonProject</span>/langchain-test/doc/java-thread-pool.<span class="hljs-property">md</span> | 预览: <span class="hljs-string">"# Java 线程池最佳实践  ## 场景与目标 - 统一管理线程，避免频繁创建/销毁的开销 - 控制并发度与任务排队策略，匹配业务峰谷  ## 核心参数与含义 - 核心线程数 corePoolSize：常驻线程数量 - 最大线程数 maximumPoolSize：峰值并发上限 - 存活时间 kee..."</span>
​
自定义线程池需设置核心线程数、最大线程数、空闲时间、任务队列、线程工厂和拒绝策略。根据业务类型（<span class="hljs-variable constant_">CPU</span>/<span class="hljs-variable constant_">IO</span>密集型）合理配置参数，使用<span class="hljs-string">`ThreadPoolExecutor`</span>构造函数创建，推荐结合监控和动态调整能力。
<span class="hljs-title class_">Process</span> finished <span class="hljs-keyword">with</span> exit code <span class="hljs-number">0</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅谈weak与unowned]]></title>    <link>https://juejin.cn/post/7602850166732341257</link>    <guid>https://juejin.cn/post/7602850166732341257</guid>    <pubDate>2026-02-05T02:51:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602850166732341257" data-draft-id="7602940720690053166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅谈weak与unowned"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2026-02-05T02:51:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="猪要飞"/> <meta itemprop="url" content="https://juejin.cn/user/4369906906431690"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅谈weak与unowned
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4369906906431690/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    猪要飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T02:51:10.000Z" title="Thu Feb 05 2026 02:51:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>    在iOS的开发中，经常会有A持有B，但是B又持有A的问题，这就是老生常谈的循环引用，目前最常用的方法就是使用weak或者unowned去打破循环。接下来浅谈下两者的底层实现原理以及两者的对比。</p>
<h2 data-id="heading-0">weak</h2>
<p>    weak的底层原理分为<code>Objective-C</code>与<code>swift</code>的两种不同的机制。两者的核心差异是<code>中心化</code>与<code>去中心化</code>。</p>
<h3 data-id="heading-1">Objective-C</h3>
<p>    在Objective-C中维护了一张全局的weak哈希表，所有的weak指针都会存储在这里，此处存储的<strong>key是对象的地址，Value是weak指针的地址</strong>（weak指针就是用的地方的地址，比如weak var a = temp() 那么weak指针就是a的地址），value根据weak指针的数量调整value是一个数组还是一个哈希表。当对象死亡时，会对大哈希表进行查找，然后去找到key对应的weak指针进行置空。</p>
<p>    OC的weak销毁相对来说会比较暴力，下方为一个销毁的例子。</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// 1. 创建对象 (假定 obj 指向 0xA00)</span>
<span class="hljs-built_in">NSObject</span> *obj = [[<span class="hljs-built_in">NSObject</span> alloc] init]; 
<span class="hljs-comment">// 2. 声明 weak 指针 (假定 p 变量本身的地址是 0xB00)</span>
<span class="hljs-comment">// 此时 Runtime 开始介入</span>
__<span class="hljs-keyword">weak</span> <span class="hljs-built_in">NSObject</span> *p = obj;

<span class="hljs-number">1.</span>当 obj 的引用计数为 <span class="hljs-number">0</span> 则准备销毁。
<span class="hljs-number">2.</span>deallc开始调用Runtime的清除函数。
<span class="hljs-number">3.</span>Runtime会拿着obj的地址<span class="hljs-number">0xA00</span>去<span class="hljs-keyword">weak</span>表去查找
<span class="hljs-number">4.</span>找到之后取出Value：[<span class="hljs-number">0xB00</span>,<span class="hljs-number">0xC00</span>,<span class="hljs-number">0xD00</span> ... ]
<span class="hljs-number">5.</span>核心操作：Runtime遍历这个名单，通过地址找到变量p <span class="hljs-number">0xB00</span>
  强行将<span class="hljs-number">0xB00</span>内存里的数据写成<span class="hljs-number">0</span> (<span class="hljs-literal">nil</span>)
<span class="hljs-number">6.</span>销毁<span class="hljs-keyword">weak</span>表中的这条记录
</code></pre>
<h3 data-id="heading-2">swift</h3>
<p>    swift采用了一种更加高效的方式，叫做 <strong>Side table (散列表/辅助表)</strong> 结合 <strong>惰性置空 (Lazy Zroing)</strong>  每一个对象都会拥有类似OC中的weak表，weak指针指向的是这个weak表不是对象本身，如果是强引用则指向的是对象地址。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">HeapObject</span> { <span class="hljs-comment">// 这个是对象的头部</span>
    <span class="hljs-type">Metadata</span> <span class="hljs-operator">*</span>isa;
    <span class="hljs-comment">// 64位仅仅是一个数字，存着 Strong 和 Unowned 计数</span>
    <span class="hljs-comment">// 当有weak指向它，它就会变化为一个指针，指向在堆上额外开辟的Side Table。</span>
    uint64_t refCounts; 
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SideTable</span> {
    <span class="hljs-type">HeapObject</span> <span class="hljs-operator">*</span>object;         <span class="hljs-comment">// 1. 指回原对象的指针</span>
    <span class="hljs-type">Atomic</span>&lt;<span class="hljs-type">StrongRefCount</span>&gt; strong; <span class="hljs-comment">// 2. 强引用计数</span>
    <span class="hljs-type">Atomic</span>&lt;<span class="hljs-type">UnownedRefCount</span>&gt; <span class="hljs-keyword">unowned</span>; <span class="hljs-comment">// 3. 无主引用计数</span>
    <span class="hljs-type">Atomic</span>&lt;<span class="hljs-type">WeakRefCount</span>&gt; <span class="hljs-keyword">weak</span>;     <span class="hljs-comment">// 4. 弱引用计数 (关键！)</span>
}
</code></pre>
<p>    这张图可以作为理解的参考。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0068350497e247f9b2cf5be106533246~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yq6KaB6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770864669&amp;x-signature=6YfMk8HyIZfk0yb1lZGUQh4Bk8w%3D" alt="weak.png" loading="lazy"/></p>
<p>    在学习过程中，又产生个疑问，避免后续忘记现在记录下来，就是当既有weak指向A又有strong指向A，那么strong是怎样工作的？答案是：strong指向A的会直接读取A，发现有side table表就会进行读取指针找到这个表，然后在表上strong计数加一，同理strong消失也会找到此处进行减一。</p>
<p>    惰性置空机制：swift并不像OC那样统一去抹除weak指针，而是在你去访问side table表的时候才会返回nil，并且将weak数减一。这个side table表在对象被销毁的时候，会保留直至weak数等于0才会被释放掉。</p>
<h2 data-id="heading-3">unowned</h2>
<p>     这个就以swift的为主，毕竟这个的使用是非常的少，首先说下对象的三段式生命周期，swift并不是对象一死就消失。</p>





























<table><thead><tr><th>阶段</th><th>条件</th><th>状态描述</th><th>内存情况</th></tr></thead><tbody><tr><td><strong>1. Live (存活)</strong></td><td>Strong &gt; 0</td><td>对象正常工作。</td><td>完整内存。</td></tr><tr><td><strong>2. Deinited (僵尸)</strong></td><td>Strong = 0 <br/> Unowned &gt; 0</td><td><strong>deinit 已执行</strong>，属性已销毁。但<strong>对象头部（HeapObject）还在</strong>。</td><td><strong>属性内存释放，头部内存保留。</strong></td></tr><tr><td><strong>3. Dead (死亡)</strong></td><td>Strong = 0 <br/> Unowned = 0</td><td>对象彻底消失。</td><td><strong>头部内存被 free。</strong></td></tr></tbody></table>
<p><strong>A. 赋值阶段 (unowned var p = obj)</strong><br/>
当在这个引用被赋值时：</p>
<ul>
<li>
<p>Runtime <strong>不会</strong>增加 Strong Count。</p>
</li>
<li>
<p>Runtime <strong>会</strong>增加 Unowned Count (+1)。</p>
</li>
<li>
<p><strong>后果</strong>：只要 p 还在，obj 就算死（Strong=0），也不能死透（进入 Dead 阶段），它必须卡在 Deinited 阶段，保留头部给 p 做检查。</p>
</li>
</ul>
<p><strong>B. 访问阶段 (print(p.name))</strong><br/>
当你访问一个 unowned 变量时，编译器会插入检查代码（swift_unownedLoadStrong）：</p>
<ol>
<li>
<p><strong>直接寻址</strong>：拿着指针直接找到内存中的对象头部（此时内存肯定没被操作系统回收，因为 Unowned Count &gt; 0）。</p>
</li>
<li>
<p><strong>原子检查</strong>：读取头部引用计数的状态位。</p>
</li>
<li>
<p><strong>分支判断</strong>：</p>
<ul>
<li>
<p>如果对象是 <strong>Live</strong>：原子操作让 Strong + 1，正常返回对象引用。</p>
</li>
<li>
<p>如果对象是 <strong>Deinited</strong>：说明对象逻辑已死（属性都没了），此时你还来访问，触发 <strong>swift_abortRetainUnowned</strong>，导致 App <strong>崩溃</strong>。</p>
</li>
</ul>
</li>
</ol>
<p><strong>C. 销毁阶段</strong><br/>
当持有 unowned 引用的变量 p 离开作用域或被销毁时：</p>
<ul>
<li>
<p>它会减少对象的 Unowned Count (-1)。</p>
</li>
<li>
<p>如果此时 Strong == 0 且 Unowned == 0，对象才会真正调用 free() 释放头部的物理内存。</p>
</li>
</ul>
<p><strong>swift中的unowned是相对来说是安全的，仅仅会触发crash并不会变成野指针去访问脏数据</strong></p>
<h2 data-id="heading-4">总结</h2>
<p>    无论是weak还是unowned，都是为了解决循环引用这个问题，他们的解决方式都是，strong的引用记数不增加，而是一个新的代表这个的若引用无主引用的计数，去打破强持有，从而去解决这个有可能产生的循环引用问题。</p>
<p>    整体上来说weak更加安全，就算访问的对象已经销毁也不会导致崩溃，而unowned最好的情况就是崩溃，最坏的情况访问到脏数据，导致展示数据页面等等的错误，但是unowned的速度以极小的优势超过了weak，还是推荐使用weak，非必要不使用unowned。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python GeoPandas基础知识：地图、投影和空间连接]]></title>    <link>https://juejin.cn/post/7602901565025845257</link>    <guid>https://juejin.cn/post/7602901565025845257</guid>    <pubDate>2026-02-05T01:43:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602901565025845257" data-draft-id="7602910573405028390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python GeoPandas基础知识：地图、投影和空间连接"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-02-05T01:43:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深度涌现"/> <meta itemprop="url" content="https://juejin.cn/user/2524932621734990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python GeoPandas基础知识：地图、投影和空间连接
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524932621734990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深度涌现
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T01:43:44.000Z" title="Thu Feb 05 2026 01:43:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>GeoPandas 扩展了 pandas 的功能，使在 Python 中处理地理空间数据更加直观和强大。如果您希望在 Python 中执行地理空间任务，并需要一个具有类似 pandas API 的库，那么 GeoPandas 是一个绝佳的选择。本教程将向您展示如何完成四个常见的地理空间任务：读取数据、绘制地图、应用投影以及进行空间连接。</p>
<p><strong>看完本教程，您将明白：</strong></p>
<ul>
<li><strong>GeoPandas 扩展了 pandas 的</strong>功能，使其支持空间数据。这些数据通常存储在 <code>geometry</code> 列中，并允许进行<strong>空间操作，<strong>例如投影和空间连接；而</strong>Folium</strong>则专注于在数据准备后创建更丰富的交互式 Web 地图。</li>
<li>您可以使用 <code>.crs</code><strong>检查 CRS（Coordinate Reference Systems，坐标参考系统）</strong> ，并使用 <code>.to_crs()</code> 和权威代码（如 <code>EPSG:4326</code> 或 <code>ESRI:54009</code>）<strong>重新投影</strong>数据。</li>
<li><strong>地理坐标参考系</strong>以度为单位存储经度和纬度，而<strong>投影坐标参考</strong>系使用米或英尺等线性单位进行面积和距离计算。</li>
<li>空间连接使用 <code>.sjoin()</code> 以及谓词，例如 <code>"within"</code> 或 <code>"intersects"</code>，并且<strong>两个输入必须共享相同的 CRS</strong> ，否则关系将计算错误。</li>
</ul>
<p>以下是 GeoPandas 与其他替代库的比较：</p>





























<table><thead><tr><th>Use Case</th><th>Pick pandas</th><th>Pick Folium</th><th>Pick GeoPandas</th></tr></thead><tbody><tr><td>Tabular data analysis</td><td>✅</td><td>-</td><td>✅</td></tr><tr><td>Mapping</td><td>-</td><td>✅</td><td>✅</td></tr><tr><td>Projections, spatial joins</td><td>-</td><td>-</td><td>✅</td></tr></tbody></table>
<p>GeoPandas 在 pandas 的基础上，增加了对地理空间数据和操作（例如<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FMap_projection" target="_blank" title="https://en.wikipedia.org/wiki/Map_projection" ref="nofollow noopener noreferrer">投影</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FSpatial_join" target="_blank" title="https://en.wikipedia.org/wiki/Spatial_join" ref="nofollow noopener noreferrer">空间连接）</a>的支持。它还包含用于创建地图的工具。Folium<a href="https://link.juejin.cn?target=https%3A%2F%2Frealpython.com%2Fpython-folium-web-maps-from-data%2F" target="_blank" title="https://realpython.com/python-folium-web-maps-from-data/" ref="nofollow noopener noreferrer">则</a>专注于交互式、基于 Web 的地图，用户可以对其进行更深入的自定义，从而与 GeoPandas 形成互补。</p>
<h2 data-id="heading-0">GeoPandas入门</h2>
<p>首先，您需要准备环境并加载一个小型数据集，该数据集将在整个教程中使用。在接下来的两个小节中，您将安装必要的软件包并读取纽约市行政区边界的示例数据集。这将为您提供一个具体的 GeoDataFrame，供您在学习核心概念的过程中进行探索。</p>
<h3 data-id="heading-1">安装 GeoPandas</h3>
<p>本教程使用两个软件包：<code>geopandas</code> 用于处理地理数据，<code>geodatasets</code> 用于加载示例数据。建议将这些软件包安装在<a href="https://link.juejin.cn?target=https%3A%2F%2Frealpython.com%2Fpython-virtual-environments-a-primer%2F" target="_blank" title="https://realpython.com/python-virtual-environments-a-primer/" ref="nofollow noopener noreferrer">虚拟环境</a>中，这样可以确保项目与系统其他部分隔离，并便于管理其<a href="https://link.juejin.cn?target=https%3A%2F%2Frealpython.com%2Fref%2Fglossary%2Fdependency%2F" target="_blank" title="https://realpython.com/ref/glossary/dependency/" ref="nofollow noopener noreferrer">依赖项</a>。</p>
<p>虚拟环境激活后，您可以<a href="https://link.juejin.cn?target=https%3A%2F%2Frealpython.com%2Fwhat-is-pip%2F" target="_blank" title="https://realpython.com/what-is-pip/" ref="nofollow noopener noreferrer">install both packages with <code>pip</code></a>：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>python -m pip install <span class="hljs-string">"geopandas[all]"</span> geodatasets
</code></pre>
<p>使用 <code>[all]</code> 选项可确保您拥有读取数据、转换坐标系和创建图表所需的一切。对于大多数读者来说，这套方案开箱即用。</p>
<p>如果遇到安装问题，项目维护者在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgeopandas.org%2Fen%2Fstable%2Fgetting_started%2Finstall.html" target="_blank" title="https://geopandas.org/en/stable/getting_started/install.html" ref="nofollow noopener noreferrer">官方安装页面</a>上提供了替代安装选项。</p>
<h3 data-id="heading-2">读取和数据</h3>
<p>大多数地理空间数据集采用<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FGeoJSON" target="_blank" title="https://en.wikipedia.org/wiki/GeoJSON" ref="nofollow noopener noreferrer">GeoJSON</a>或<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FShapefile" target="_blank" title="https://en.wikipedia.org/wiki/Shapefile" ref="nofollow noopener noreferrer">shapefile</a>格式。<code>read_file()</code> 函数可以读取这两种格式，并且接受本地文件路径或 URL 作为参数。</p>
<p>在下面的示例中，您将使用 <code>read_file()</code> 加载纽约市行政区边界 (NYBB) 数据集。<code>geodatasets</code> 包提供了一个便捷的数据集路径，因此您无需手动下载任何内容。您还将删除不必要的列：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> geopandas <span class="hljs-keyword">as</span> gpd
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> geodatasets <span class="hljs-keyword">import</span> get_path
<span class="hljs-meta">&gt;&gt;&gt; </span>path_to_data = get_path(<span class="hljs-string">"nybb"</span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>nybb = gpd.read_file(path_to_data)
<span class="hljs-meta">&gt;&gt;&gt; </span>nybb = nybb[[<span class="hljs-string">"BoroName"</span>, <span class="hljs-string">"Shape_Area"</span>, <span class="hljs-string">"geometry"</span>]]
<span class="hljs-meta">&gt;&gt;&gt; </span>nybb
    BoroName        Shape_Area      geometry
<span class="hljs-number">0</span>   Staten Island   <span class="hljs-number">1.623820e+09</span>    MULTIPOLYGON (((<span class="hljs-number">970217.022</span> <span class="hljs-number">145643.332</span>, ....
<span class="hljs-number">1</span>   Queens          <span class="hljs-number">3.045213e+09</span>    MULTIPOLYGON (((<span class="hljs-number">1029606.077</span> <span class="hljs-number">156073.814</span>, ...
<span class="hljs-number">2</span>   Brooklyn        <span class="hljs-number">1.937479e+09</span>    MULTIPOLYGON (((<span class="hljs-number">1021176.479</span> <span class="hljs-number">151374.797</span>, ...
<span class="hljs-number">3</span>   Manhattan       <span class="hljs-number">6.364715e+08</span>    MULTIPOLYGON (((<span class="hljs-number">981219.056</span> <span class="hljs-number">188655.316</span>, ....
<span class="hljs-number">4</span>   Bronx           <span class="hljs-number">1.186925e+09</span>    MULTIPOLYGON (((<span class="hljs-number">1012821.806</span> <span class="hljs-number">229228.265</span>, ...
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">type</span>(nybb)
&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">'geopandas.geodataframe.GeoDataFrame'</span>&gt;
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">type</span>(nybb[<span class="hljs-string">"geometry"</span>])
&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">'geopandas.geoseries.GeoSeries'</span>&gt;
</code></pre>
<p><code>nybb</code> 是一个<strong>GeoDataFrame。GeoDataFrame</strong>拥有行、列以及<a href="https://link.juejin.cn?target=https%3A%2F%2Frealpython.com%2Fpandas-dataframe%2F" target="_blank" title="https://realpython.com/pandas-dataframe/" ref="nofollow noopener noreferrer">pandas DataFrame</a>的所有方法。区别在于它通常包含一个特殊的 <code>geometry</code> 列，用于存储地理形状，而不是纯数字或文本。</p>
<p><code>geometry</code> 列是一个 <code>GeoSeries</code>。它的行为类似于普通的 pandas <code>Series</code>，但它的值是空间对象，您可以对其进行映射并运行空间查询。在 <code>nybb</code> 数据集中，每个行政区的几何图形都是一个 <code>MultiPolygon</code>——由多个多边形组成——因为每个行政区都包含多个岛屿。很快，您将使用这些几何图形来创建地图并运行空间操作，例如查找某个点属于哪个行政区。</p>
<h2 data-id="heading-3">映射数据</h2>
<p>加载 GeoDataFrame 后，最快捷的数据可视化方法之一就是了解数据。在本节中，您将学习如何创建静态地图和交互式地图。这样，您可以检查形状、发现规律，并确认几何图形是否符合预期。</p>
<h3 data-id="heading-4">创建静态地图</h3>
<p>正如<a href="https://link.juejin.cn?target=https%3A%2F%2Frealpython.com%2Fpandas-plot-python%2F" target="_blank" title="https://realpython.com/pandas-plot-python/" ref="nofollow noopener noreferrer">pandas 绘图指南</a>中所述，pandas <a href="https://link.juejin.cn?target=https%3A%2F%2Frealpython.com%2Fref%2Fglossary%2Fdataframe%2F" target="_blank" title="https://realpython.com/ref/glossary/dataframe/" ref="nofollow noopener noreferrer">DataFrame</a>提供了一个 <code>.plot()</code> 方法，用于快速创建<a href="https://link.juejin.cn?target=https%3A%2F%2Frealpython.com%2Fvisualizing-python-plt-scatter%2F" target="_blank" title="https://realpython.com/visualizing-python-plt-scatter/" ref="nofollow noopener noreferrer">散点图</a>或柱状图等可视化图表。GeoDataFrame 类重写了 <code>.plot()</code> 方法，因此，当数据包含几何图形时，结果会生成地图而不是图表。</p>
<p>在这里，您可以调用 <code>nybb.plot()</code> 来绘制纽约市五个行政区的轮廓：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">&gt;&gt;&gt; </span>nybb.plot()
&lt;Axes: &gt;
<span class="hljs-meta">&gt;&gt;&gt; </span>plt.show()
</code></pre>
<p>生成的图像如下：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4eae949de50241f38da1bf0f7959b22f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex5bqm5raM546w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770860624&amp;x-signature=83l7wXZqXx3%2BB84wWHEAgWZ5va0%3D" alt="Output of GeoPandas nybb.plot()" loading="lazy"/>
这种快速绘图有助于检查数据是否正确加载以及几何图形是否合理。但通常情况下，您需要更进一步，使用颜色来显示每个区域的值。根据列中的值对区域进行着色的地图称为<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FChoropleth_map" target="_blank" title="https://en.wikipedia.org/wiki/Choropleth_map" ref="nofollow noopener noreferrer">等值线</a>图，您可以通过将要可视化的列传递给 <code>column</code> 参数来创建它：</p>
<pre><code class="hljs language-ini" lang="ini">&gt;&gt;&gt; nybb.plot(<span class="hljs-attr">column</span>=<span class="hljs-string">"Shape_Area"</span>, legend=<span class="hljs-literal">True</span>)
&lt;Axes: &gt;
&gt;&gt;&gt; plt.show()
</code></pre>
<p>这将产生以下输出：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6994b2fc42f74bdfa7890c00f4814ac2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex5bqm5raM546w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770860624&amp;x-signature=V%2BABihr9HDCA4bNjuj2DadwtSmM%3D" alt="Output of GeoPandas nybb.plot(column=&quot;Shape_Area&quot;, legend=True)" loading="lazy"/>
在这里，你可以看到每个行政区的相对大小，并用颜色表示。</p>
<h3 data-id="heading-5">创建交互式地图</h3>
<p>您还可以使用 <code>.explore()</code> 方法创建交互式、可缩放的地图。<code>.explore()</code> 方法底层使用<a href="https://link.juejin.cn?target=https%3A%2F%2Frealpython.com%2Fpython-folium-web-maps-from-data%2F" target="_blank" title="https://realpython.com/python-folium-web-maps-from-data/" ref="nofollow noopener noreferrer">Folium</a><a href="https://link.juejin.cn?target=https%3A%2F%2Frealpython.com%2Fref%2Fglossary%2Frepl%2F" target="_blank" title="https://realpython.com/ref/glossary/repl/" ref="nofollow noopener noreferrer">库</a>生成 HTML 地图。REPL 无法直接显示该地图，因此 <code>.show_in_browser()</code> 方法会在您的默认浏览器中打开地图：</p>
<pre><code class="hljs language-scss" lang="scss">&gt;&gt;&gt; nybb<span class="hljs-selector-class">.explore</span>()<span class="hljs-selector-class">.show_in_browser</span>()
</code></pre>
<p>这将在您的浏览器中打开一个交互式地图。您应该会看到类似这样的内容：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a358db3a5f8a468ab5fe154c81e17eca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex5bqm5raM546w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770860624&amp;x-signature=70JmBdDOL8%2F63eH7K5qBJ6CsWr8%3D" alt="Output of GeoPandas .explore() Method on nybb Dataset" loading="lazy"/>
与绘制简单静态形状的<code>.plot()</code>不同，<code>.explore()</code>将您的数据叠加到参考图纸上——参考图纸包含地名、海岸线和缩放控件。这使得在上下文中解读数据以及交互式探索地理环境变得更加容易。</p>
<p>与 <code>.plot()</code> 类似，您可以通过传递列名将其转换为等值线图。这里，您可以根据每个行政区的土地面积为其着色：</p>
<pre><code class="hljs language-ini" lang="ini">&gt;&gt;&gt; nybb.explore(<span class="hljs-attr">column</span>=<span class="hljs-string">"Shape_Area"</span>, legend=<span class="hljs-literal">False</span>).show_in_browser()
</code></pre>
<p>输出结果为：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b8f092f3bc54545a8e2e7f75a7b8156~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex5bqm5raM546w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770860624&amp;x-signature=wbegVEMN%2FERtCHoMMJdsD8W2qwk%3D" alt="GeoPandas .explore() Method on nybb Dataset" loading="lazy"/>
现在，每个行政区的相对大小用颜色表示，让您了解交互式地图如何揭示数据中的模式。为了使这些地图准确且在不同数据集之间具有可比性，接下来您将了解坐标参考系统和投影的工作原理。</p>
<h2 data-id="heading-6">使用坐标参考系统 (CRS) 和投影</h2>
<p>每个 GeoDataFrame 都包含一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FSpatial_reference_system" target="_blank" title="https://en.wikipedia.org/wiki/Spatial_reference_system" ref="nofollow noopener noreferrer">坐标参考系统 (CRS，Coordinate Reference Systems )</a> ，用于解释其坐标如何映射到现实世界的位置。理解 CRS 对于解释几何值、比较数据集和生成精确地图至关重要。在进一步探索之前，请仔细查看 <code>nybb</code> 中的 <code>geometry</code> 列：</p>
<pre><code class="hljs language-erlang" lang="erlang">&gt;&gt;&gt; nybb[[<span class="hljs-string">"BoroName"</span>, <span class="hljs-string">"geometry"</span>]]
     BoroName       geometry
<span class="hljs-number">0</span>    Staten Island  MULTIPOLYGON (((<span class="hljs-number">970217.022</span> <span class="hljs-number">145643.332</span>, <span class="hljs-number">970227</span>....
<span class="hljs-number">1</span>    Queens         MULTIPOLYGON (((<span class="hljs-number">1029606.077</span> <span class="hljs-number">156073.814</span>, <span class="hljs-number">102957</span>...
<span class="hljs-number">2</span>    Brooklyn       MULTIPOLYGON (((<span class="hljs-number">1021176.479</span> <span class="hljs-number">151374.797</span>, <span class="hljs-number">102100</span>...
<span class="hljs-number">3</span>    Manhattan      MULTIPOLYGON (((<span class="hljs-number">981219.056</span> <span class="hljs-number">188655.316</span>, <span class="hljs-number">980940</span>....
<span class="hljs-number">4</span>    Bronx          MULTIPOLYGON (((<span class="hljs-number">1012821.806</span> <span class="hljs-number">229228.265</span>, <span class="hljs-number">101278</span>...
</code></pre>
<p>请注意，<code>geometry</code> 列只是数字——这些值如何与地球上的地点对应并不明显。</p>
<p>每个 GeoDataFrame 的 CRS 位于其 <code>.crs</code> 属性中。以下是 <code>nybb</code> 数据集的 CRS：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">&gt;&gt;&gt;</span> <span class="hljs-string">nybb.crs</span>
<span class="hljs-string">&lt;Projected</span> <span class="hljs-attr">CRS:</span> <span class="hljs-string">EPSG:2263&gt;</span>
<span class="hljs-attr">Name:</span> <span class="hljs-string">NAD83</span> <span class="hljs-string">/</span> <span class="hljs-string">New</span> <span class="hljs-string">York</span> <span class="hljs-string">Long</span> <span class="hljs-string">Island</span> <span class="hljs-string">(ftUS)</span>
<span class="hljs-string">Axis</span> <span class="hljs-string">Info</span> [<span class="hljs-string">cartesian</span>]<span class="hljs-string">:</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">X[east]:</span> <span class="hljs-string">Easting</span> <span class="hljs-string">(US</span> <span class="hljs-string">survey</span> <span class="hljs-string">foot)</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">Y[north]:</span> <span class="hljs-string">Northing</span> <span class="hljs-string">(US</span> <span class="hljs-string">survey</span> <span class="hljs-string">foot)</span>
<span class="hljs-attr">Area of Use:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">United</span> <span class="hljs-string">States</span> <span class="hljs-string">(USA)</span> <span class="hljs-bullet">-</span> <span class="hljs-string">New</span> <span class="hljs-string">York</span> <span class="hljs-bullet">-</span> <span class="hljs-string">counties</span> <span class="hljs-string">of</span> <span class="hljs-string">Bronx;</span> <span class="hljs-string">Kings;</span> <span class="hljs-string">Nassau</span> <span class="hljs-string">...</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">bounds:</span> <span class="hljs-string">(-74.26,</span> <span class="hljs-number">40.47</span><span class="hljs-string">,</span> <span class="hljs-number">-71.8</span><span class="hljs-string">,</span> <span class="hljs-number">41.3</span><span class="hljs-string">)</span>
<span class="hljs-attr">Coordinate Operation:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">SPCS83</span> <span class="hljs-string">New</span> <span class="hljs-string">York</span> <span class="hljs-string">Long</span> <span class="hljs-string">Island</span> <span class="hljs-string">zone</span> <span class="hljs-string">(US</span> <span class="hljs-string">survey</span> <span class="hljs-string">foot)</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">method:</span> <span class="hljs-string">Lambert</span> <span class="hljs-string">Conic</span> <span class="hljs-string">Conformal</span> <span class="hljs-string">(2SP)</span>
<span class="hljs-attr">Datum:</span> <span class="hljs-string">North</span> <span class="hljs-string">American</span> <span class="hljs-string">Datum</span> <span class="hljs-number">1983</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">Ellipsoid:</span> <span class="hljs-string">GRS</span> <span class="hljs-number">1980</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">Prime Meridian:</span> <span class="hljs-string">Greenwich</span>
</code></pre>
<p>每个坐标参考系 (CRS) 都有一个名称和一个代码。在本例中，CRS 的名称为 <code>NAD83 / New York Long Island (ftUS)</code>，代码为 <code>EPSG:2263</code>。x 和 y 坐标表示以美国测量英尺为单位的距离，原点位于纽约市郊外很远的地方。这种位置关系解释了为什么坐标轴的值很大，因为它们表示每个点距离原点的东向和北向距离（以英尺为单位）。</p>
<p><code>EPSG:2263</code> 是一个<em>投影</em>坐标参考系。这意味着 <code>geometry</code> 列中的坐标已经过数学投影转换，使得 x 轴和 y 轴表示线性距离。下一节将介绍<em>地理</em>坐标参考系，其中坐标轴并非表示距离，而是表示纬度和经度。</p>
<h3 data-id="heading-7">探索地理 CRS</h3>
<p>查看世界地图时常用的坐标参考系统 (CRS) 是 WGS 84 (<code>EPSG:4326</code>)。以下是如何使用此 CRS 加载世界地图的方法：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">&gt;&gt;&gt;</span> <span class="hljs-string">world</span> <span class="hljs-string">=</span> <span class="hljs-string">gpd.read_file(get_path("naturalearth</span> <span class="hljs-string">land"))</span>
<span class="hljs-string">&gt;&gt;&gt;</span> <span class="hljs-string">world.crs</span>
<span class="hljs-string">&lt;Geographic</span> <span class="hljs-attr">2D CRS:</span> <span class="hljs-string">EPSG:4326&gt;</span>
<span class="hljs-attr">Name:</span> <span class="hljs-string">WGS</span> <span class="hljs-number">84</span>
<span class="hljs-string">Axis</span> <span class="hljs-string">Info</span> [<span class="hljs-string">ellipsoidal</span>]<span class="hljs-string">:</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">Lat[north]:</span> <span class="hljs-string">Geodetic</span> <span class="hljs-string">latitude</span> <span class="hljs-string">(degree)</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">Lon[east]:</span> <span class="hljs-string">Geodetic</span> <span class="hljs-string">longitude</span> <span class="hljs-string">(degree)</span>
<span class="hljs-attr">Area of Use:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">World.</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">bounds:</span> <span class="hljs-string">(-180.0,</span> <span class="hljs-number">-90.0</span><span class="hljs-string">,</span> <span class="hljs-number">180.0</span><span class="hljs-string">,</span> <span class="hljs-number">90.0</span><span class="hljs-string">)</span>
<span class="hljs-attr">Datum:</span> <span class="hljs-string">World</span> <span class="hljs-string">Geodetic</span> <span class="hljs-string">System</span> <span class="hljs-number">1984 </span><span class="hljs-string">ensemble</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">Ellipsoid:</span> <span class="hljs-string">WGS</span> <span class="hljs-number">84</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">Prime Meridian:</span> <span class="hljs-string">Greenwich</span>
</code></pre>
<p>WGS 84 是一种<em>地理</em>坐标参考系：x 轴和 y 轴分别代表经度和纬度（单位为度）。它们并不代表英尺或米等实际距离。由于度数并非均匀距离，因此直接使用地理坐标参考系绘制图形会扭曲形状和面积，尤其是在两极地区。</p>
<p>以下是绘制世界地图的方法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">&gt;&gt;&gt; </span>world.plot()
&lt;Axes: &gt;
<span class="hljs-meta">&gt;&gt;&gt; </span>plt.show()
</code></pre>
<p>结果如下：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/279448557f7c4f10b217fc47339e175f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex5bqm5raM546w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770860624&amp;x-signature=TivW3hDYo%2FCq%2BzPSv4LokK2990w%3D" alt="A World Map Using the WGS84 Geographic Projection" loading="lazy"/>
由于该 CRS 不是投影的，因此极地附近的区域看起来被拉伸了——格陵兰岛和南极洲看起来比实际大得多。</p>
<h3 data-id="heading-8">改变 CRS</h3>
<p>您可以更改 GeoDataFrame 的坐标参考系统 (CRS)。这很重要，因为 CRS 的选择会影响距离、面积和形状的显示方式。</p>
<p>例如，您刚才看到，WGS 84 投影使格陵兰岛和南极洲看起来比实际大得多。<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FMollweide_projection" target="_blank" title="https://en.wikipedia.org/wiki/Mollweide_projection" ref="nofollow noopener noreferrer">莫尔维德投影（Mollweide projection）</a>是一种等面积投影：每个区域都保持其相对于其他区域的真实面积比例。形状变得更加圆润，距离也会有所变化，但各大洲和国家的相对大小是准确的。</p>
<p>您可以使用方法 <code>.to_crs()</code> 将世界地图的 CRS 从 WGS 84 更改为 Mollweide：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">&gt;&gt;&gt;</span> <span class="hljs-string">world_moll</span> <span class="hljs-string">=</span> <span class="hljs-string">world.to_crs("ESRI:54009")</span>
<span class="hljs-string">&gt;&gt;&gt;</span> <span class="hljs-string">world_moll.crs</span>
<span class="hljs-string">&lt;Projected</span> <span class="hljs-attr">CRS:</span> <span class="hljs-string">ESRI:54009&gt;</span>
<span class="hljs-attr">Name:</span> <span class="hljs-string">World_Mollweide</span>
<span class="hljs-string">Axis</span> <span class="hljs-string">Info</span> [<span class="hljs-string">cartesian</span>]<span class="hljs-string">:</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">E[east]:</span> <span class="hljs-string">Easting</span> <span class="hljs-string">(metre)</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">N[north]:</span> <span class="hljs-string">Northing</span> <span class="hljs-string">(metre)</span>
<span class="hljs-attr">Area of Use:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">World.</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">bounds:</span> <span class="hljs-string">(-180.0,</span> <span class="hljs-number">-90.0</span><span class="hljs-string">,</span> <span class="hljs-number">180.0</span><span class="hljs-string">,</span> <span class="hljs-number">90.0</span><span class="hljs-string">)</span>
<span class="hljs-attr">Coordinate Operation:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">World_Mollweide</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">method:</span> <span class="hljs-string">Mollweide</span>
<span class="hljs-attr">Datum:</span> <span class="hljs-string">World</span> <span class="hljs-string">Geodetic</span> <span class="hljs-string">System</span> <span class="hljs-number">1984</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">Ellipsoid:</span> <span class="hljs-string">WGS</span> <span class="hljs-number">84</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">Prime Meridian:</span> <span class="hljs-string">Greenwich</span>
</code></pre>
<p>与所有投影式 CRS 一样，地图的坐标轴以距离表示，而不是以纬度和经度表示。</p>
<p>你可以像这样使用新的CRS绘制世界地图：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">&gt;&gt;&gt; </span>world_moll.plot()
&lt;Axes: &gt;
<span class="hljs-meta">&gt;&gt;&gt; </span>plt.show()
</code></pre>
<p>输出结果如下：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a83fb9d9b8914703bd8990be0f32594b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex5bqm5raM546w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770860624&amp;x-signature=xliyyBuQSWTlGA06unOokCbouzw%3D" alt="Output of GeoPandas .plot() using a Mollweide Projection" loading="lazy"/>
在这张地图中，格陵兰岛和南极洲看起来比在WGS 84坐标系中小得多。更重要的是，它们的大小与其他陆地相比是准确的。</p>
<h3 data-id="heading-9">比较 CRS</h3>
<p>有时，对两种不同坐标参考系下的数据集进行并排比较会很有帮助。以下示例使用<a href="https://link.juejin.cn?target=https%3A%2F%2Frealpython.com%2Fpython-matplotlib-guide%2F" target="_blank" title="https://realpython.com/python-matplotlib-guide/" ref="nofollow noopener noreferrer">Matplotlib</a> ，分别使用 WGS 84 和 Mollweide 坐标系绘制了同一张世界地图：</p>
<pre><code class="hljs language-scss" lang="scss">&gt;&gt;&gt; fig, axes = plt<span class="hljs-selector-class">.subplots</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">7</span>))
&gt;&gt;&gt; world<span class="hljs-selector-class">.plot</span>(ax=axes[<span class="hljs-number">0</span>])
&lt;Axes: &gt;
&gt;&gt;&gt; axes[<span class="hljs-number">0</span>].<span class="hljs-built_in">set_title</span>(<span class="hljs-string">"EPSG:4326 (WGS84 Lat/Lon)"</span>)
<span class="hljs-built_in">Text</span>(<span class="hljs-number">0.5</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">'EPSG:4326 (WGS84 Lat/Lon)'</span>)
&gt;&gt;&gt; world_moll.<span class="hljs-built_in">plot</span>(ax=axes[<span class="hljs-number">1</span>])
&lt;Axes: &gt;
&gt;&gt;&gt; axes[<span class="hljs-number">1</span>].<span class="hljs-built_in">set_title</span>(<span class="hljs-string">"ESRI:54009 (Mollweide Equal-Area)"</span>)
<span class="hljs-built_in">Text</span>(<span class="hljs-number">0.5</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">'ESRI:54009 (Mollweide Equal-Area)'</span>)
&gt;&gt;&gt; plt.<span class="hljs-built_in">tight_layout</span>()
&gt;&gt;&gt; plt.<span class="hljs-built_in">show</span>()
</code></pre>
<p>这就是最终的对比图：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea69743e48d543b580b9fa4dbe5ae7f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex5bqm5raM546w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770860624&amp;x-signature=HvW%2BL6LYRssnnJ2tsc%2BaQyoG5lo%3D" alt="Comparison of two Projections of a World Map" loading="lazy"/>
从图中可以明显看出，坐标参考系统 (CRS) 的选择会影响地图的渲染方式。由于 WGS 84 将经度和纬度视为 x 坐标和 y 坐标，因此极地附近的区域看起来被拉伸，比实际面积更大。相比之下，莫尔维德投影保留了各陆地相对大小，因此格陵兰岛和南极洲看起来要小得多。</p>
<h3 data-id="heading-10">理解地图投影和中心参考系统</h3>
<p>正如您所见，GeoPandas 使用**坐标参考系统 (CRS)**将坐标映射到现实世界的位置。有些 CRS 是地理坐标系，使用以度为单位的纬度和经度。这些坐标系未经投影。另一些坐标系则经过投影，这意味着它们使用地图投影将地球平面化为以线性单位表示的 x 和 y 坐标。</p>
<p>每个投影都是 CRS 的一部分，但并非每个 CRS 都使用投影。</p>
<h2 data-id="heading-11">执行空间连接（join）</h2>
<p>空间连接允许您根据两个 GeoDataFrame 的几何关系合并它们的信息。与通过共享 ID 或列名匹配行不同，空间连接根据要素在空间中的位置进行匹配——例如，哪些地铁站位于某个行政区内。它相当于数据库连接的地理空间版本，但关键在于位置而非字段值。</p>
<p>在下面的示例中，您将使用空间连接来确定纽约市的哪个行政区包含帝国大厦。首先创建一个包含帝国大厦经度和纬度的 GeoDataFrame。由于这些坐标以度为单位，因此您应该使用 <code>EPSG:4326</code> 作为 CRS：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> shapely.geometry <span class="hljs-keyword">import</span> Point
<span class="hljs-meta">&gt;&gt;&gt; </span>empire_state = gpd.GeoDataFrame(
<span class="hljs-meta">... </span>   [{<span class="hljs-string">"name"</span>: <span class="hljs-string">"Empire State Building"</span>}],
<span class="hljs-meta">... </span>   geometry=[Point(-<span class="hljs-number">73.9857</span>, <span class="hljs-number">40.7484</span>)],
<span class="hljs-meta">... </span>   crs=<span class="hljs-string">"EPSG:4326"</span>
<span class="hljs-meta">... </span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>empire_state
     name                     geometry
<span class="hljs-number">0</span>    Empire State Building    POINT (-<span class="hljs-number">73.9857</span> <span class="hljs-number">40.7484</span>)
</code></pre>
<p>现在您拥有一个只包含一个点的 GeoDataFrame。</p>
<h3 data-id="heading-12">理解空间连接和 CRS</h3>
<p>空间连接要求两个 GeoDataFrame 具有相同的 CRS（中心参考系）。您刚才看到 <code>empire_state</code> DataFrame 使用了 <code>EPSG:4326</code>。之前您看到 <code>nybb</code> 使用了 <code>EPSG:2263</code>。以下是如何将 <code>empire_state</code> 也更改为使用 <code>EPSG:2263</code>：</p>
<pre><code class="hljs language-ini" lang="ini">&gt;&gt;&gt; <span class="hljs-attr">empire_state</span> = empire_state.to_crs(nybb.crs)
&gt;&gt;&gt; empire_state
     name                     geometry
0    Empire State Building    POINT (988212.237 211939.279)
</code></pre>
<p>请注意，当您更改 <code>empire_state</code> 的坐标参考系 (CRS) 时，<code>geometry</code> 列中的值从 <code>(-73.9857</code>、<code>40.7484)</code> 变为 <code>(988212.237</code>、<code>211939.279)</code>。这是因为坐标只有在特定的坐标参考系 (CRS) 下才有意义。当您切换到不同的坐标参考系 (CRS) 时，同一个实际位置会用不同的坐标值来表示。</p>
<h3 data-id="heading-13">使用<code>.sjoin()</code>方法</h3>
<p>GeoPandas 中的空间连接与<a href="https://link.juejin.cn?target=https%3A%2F%2Frealpython.com%2Fpandas-merge-join-and-concat%2F" target="_blank" title="https://realpython.com/pandas-merge-join-and-concat/" ref="nofollow noopener noreferrer">pandas 中的连接</a>方式类似。具体来说，GeoDataFrame 有一个 <code>.sjoin()</code> 实例方法。此方法需要您指定要连接的 GeoDataFrame，以及要使用的连接类型和<strong>谓词</strong>。</p>
<p>在下面的示例中，您使用左连接将 <code>empire_state</code> DataFrame 连接到 <code>nybb</code> DataFrame。使用左连接，您至少可以得到一行结果，该行将来自原始 <code>empire_state</code> DataFrame。</p>
<p>在运行连接操作之前，了解参数 <code>predicate</code> 的工作原理非常重要。参数 <code>predicate</code> 告诉 <code>.sjoin()</code> 如何判断两个几何图形在空间上是否匹配。这里，您使用 <code>"within"</code> 是因为您想测试一个点是否位于某个行政区内：</p>
<pre><code class="hljs language-ini" lang="ini">&gt;&gt;&gt; empire_state.sjoin(nybb, <span class="hljs-attr">how</span>=<span class="hljs-string">"left"</span>, predicate=<span class="hljs-string">"within"</span>)
   name                   geometry               index_right  BoroName  ...
0  Empire State Building  POINT (988212.237 ...  3            Manhattan ...
</code></pre>
<p>由于纽约市各行政区互不重叠，所以只返回一行数据。帝国大厦位于曼哈顿，连接操作也显示了这一点。由于您连接了两个数据框，因此您同时拥有来自 <code>empire_state</code> 和 <code>nybb</code> 的列。</p>
<p>在这个例子中，你了解了<code>"within"</code>谓词，它可以用来测试一个形状是否包含在另一个形状之内。其他谓词可以用来测试两个形状是否接触、重叠、相交等等。</p>
<h2 data-id="heading-14">避免局限性和陷阱</h2>
<p>尽管 GeoPandas 功能强大且对初学者友好，但还是有一些常见的陷阱可能会让人犯错——尤其是在开始处理真实世界数据时。</p>
<p>记住这些要点可以节省您的时间和避免困惑：</p>
<ul>
<li>**依赖项：**安装 GeoPandas 可能比较棘手，因为它依赖于已编译的库（<code>GEOS</code>、<code>PROJ</code>、<code>GDAL</code>）。如果您在使用 <code>pip</code> 安装时遇到问题，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fgeopandas.org%2Fen%2Fstable%2Fgetting_started%2Finstall.html" target="_blank" title="https://geopandas.org/en/stable/getting_started/install.html" ref="nofollow noopener noreferrer">官方安装页面</a>以获取其他安装方案的信息。</li>
<li>**坐标参考系 (CRS) 注意：**务必检查并设置 CRS。在进行空间连接或距离计算之前忘记重新投影可能会导致错误的结果。</li>
<li><strong>地图绘制限制：</strong> <code>.plot()</code> 和 <code>.explore()</code> 非常适合快速绘制地图，但自定义功能有限。如需多图层、弹出窗口和底图等高级交互功能，建议直接使用 Folium。</li>
</ul>
<p>这些都不是什么大问题，这些是值得及早识别的模式，这样你的工作流程才能保持流畅和可预测。</p>
<h2 data-id="heading-15">结论</h2>
<p>GeoPandas 将熟悉的 pandas 工作流程扩展到了地理空间领域。在此过程中，您学习了如何加载常见的地理空间格式、创建静态和交互式地图、使用和更改数据集的 CRS，以及使用空间连接来回答基于位置的问题。</p>
<p>您现在已掌握处理真实世界空间数据并创建能够传达有意义见解的地图所需的核心技能。您可以通过尝试使用自己的数据集、阅读<a href="https://link.juejin.cn?target=https%3A%2F%2Fgeopandas.org%2Fen%2Fstable%2Fgetting_started%2Fintroduction.html" target="_blank" title="https://geopandas.org/en/stable/getting_started/introduction.html" ref="nofollow noopener noreferrer">GeoPandas 文档</a>或参考 Real Python 的<a href="https://link.juejin.cn?target=https%3A%2F%2Frealpython.com%2Fpython-folium-web-maps-from-data%2F" target="_blank" title="https://realpython.com/python-folium-web-maps-from-data/" ref="nofollow noopener noreferrer">Folium 教程</a>来创建交互式 Web 地图，从而进一步提升这些技能。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frealpython.com%2Fgeopandas%2F" target="_blank" title="https://realpython.com/geopandas/" ref="nofollow noopener noreferrer">realpython.com/geopandas/</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F-1MHFlFpfQhtSqNKOGKytg" target="_blank" title="https://mp.weixin.qq.com/s/-1MHFlFpfQhtSqNKOGKytg" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/-1MHFlFpf…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[04｜MCP 服务接口：让本地能力变成 Agent 可调用的 Tools]]></title>    <link>https://juejin.cn/post/7602816610932654143</link>    <guid>https://juejin.cn/post/7602816610932654143</guid>    <pubDate>2026-02-05T01:50:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602816610932654143" data-draft-id="7602928783595503622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="04｜MCP 服务接口：让本地能力变成 Agent 可调用的 Tools"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-05T01:50:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="goingflygo"/> <meta itemprop="url" content="https://juejin.cn/user/3896324936173719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            04｜MCP 服务接口：让本地能力变成 Agent 可调用的 Tools
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3896324936173719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    goingflygo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T01:50:40.000Z" title="Thu Feb 05 2026 01:50:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>到目前为止，你已经知道：</p>
<ul>
<li>数据如何存（SQLite）</li>
<li>事件如何来（生命周期挂钩）</li>
<li>日志如何变薄（摘要压缩）</li>
</ul>
<p>但少了一个关键环节：<strong>Agent 到底怎么“摸到”这些本地能力？</strong></p>
<p>答案就是：<strong>MCP（Model Context Protocol）</strong>。<code>trae-mem</code> 通过实现一个 MCP Server，把本地 Python 逻辑包装成一组“工具（Tools）”，让 Trae 的 Agent 能像调用内置工具一样调用它们。</p>
<p>本文聚焦第四块核心能力：<strong>MCP Service Interface（MCP 服务接口）</strong>，核心实现位于 <a href="https://link.juejin.cn?target=..%2Ftrae_mem%2Fmcp_server.py" target="_blank" title="../trae_mem/mcp_server.py" ref="nofollow noopener noreferrer">mcp_server.py</a>。</p>
<hr/>
<h2 data-id="heading-0">1. 角色划分：Trae / Agent / MCP Server</h2>
<p>你可以用一句话把三者关系讲清楚：</p>
<ul>
<li><strong>Trae（客户端/宿主）</strong>：负责启动 MCP Server，并把“工具菜单”暴露给 Agent</li>
<li><strong>Agent（模型）</strong>：负责理解用户意图，决定调用哪个工具、用什么参数调用</li>
<li><strong>MCP Server（服务端）</strong>：负责实现工具，接收 JSON-RPC 请求并返回结果</li>
</ul>
<p>这也是 MCP 的核心价值：<strong>把“理解（AI）”与“执行（本地能力）”解耦</strong>。</p>
<p>如果你想看更完整的“三角协同”讲解，可配合阅读 <a href="https://link.juejin.cn?target=.%2Fmcp-architecture-deep-dive.md" target="_blank" title="./mcp-architecture-deep-dive.md" ref="nofollow noopener noreferrer">mcp-architecture-deep-dive.md</a>。</p>
<hr/>
<h2 data-id="heading-1">2. 传输层：为什么是 stdio？</h2>
<p><code>trae-mem</code> 选择 stdio（标准输入/输出）作为 MCP 传输方式：</p>
<ul>
<li>Trae 启动 server 进程</li>
<li>Trae 通过 stdin 写入一行行 JSON（请求）</li>
<li>Server 通过 stdout 回写一行行 JSON（响应）</li>
</ul>
<p>优点非常“工程”：</p>
<ul>
<li>不需要监听端口（减少配置与安全风险）</li>
<li>跨平台稳定（macOS/Linux/Windows）</li>
<li>进程生命周期由宿主控制，方便自动重启</li>
</ul>
<p>实现入口是 <a href="https://link.juejin.cn?target=..%2Ftrae_mem%2Fmcp_server.py%23L251-L311" target="_blank" title="../trae_mem/mcp_server.py#L251-L311" ref="nofollow noopener noreferrer">serve_stdio()</a>。</p>
<hr/>
<h2 data-id="heading-2">3. 协议层：JSON-RPC 的最小实现</h2>
<p>在 <code>serve_stdio()</code> 中，server 做了一个极简的 JSON-RPC 循环：</p>
<ol>
<li><code>initialize</code>：握手，声明能力</li>
<li><code>tools/list</code>：返回工具清单</li>
<li><code>tools/call</code>：执行某个工具并返回结果</li>
</ol>
<p>对应代码片段在 <a href="https://link.juejin.cn?target=..%2Ftrae_mem%2Fmcp_server.py%23L270-L305" target="_blank" title="../trae_mem/mcp_server.py#L270-L305" ref="nofollow noopener noreferrer">mcp_server.py</a>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> method == <span class="hljs-string">"initialize"</span>:
    _write(_result(id_value, {...capabilities...}))
    <span class="hljs-keyword">continue</span>

<span class="hljs-keyword">if</span> method == <span class="hljs-string">"tools/list"</span>:
    _write(_result(id_value, {<span class="hljs-string">"tools"</span>: _tools()}))
    <span class="hljs-keyword">continue</span>

<span class="hljs-keyword">if</span> method == <span class="hljs-string">"tools/call"</span>:
    name = <span class="hljs-built_in">str</span>(params.get(<span class="hljs-string">"name"</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>)
    args = params.get(<span class="hljs-string">"arguments"</span>) <span class="hljs-keyword">or</span> {}
    res = _handle_tool_call(name, args)
    _write(_result(id_value, res))
    <span class="hljs-keyword">continue</span>
</code></pre>
<p>注意：这里没有引入任何第三方库，完全靠 Python 标准库就能跑通。</p>
<hr/>
<h2 data-id="heading-3">4. 工具发现：tools/list 为什么这么重要？</h2>
<p>Agent 能调用哪些能力，取决于 <code>tools/list</code> 返回的“工具描述（Schema）”。在 <a href="https://link.juejin.cn?target=..%2Ftrae_mem%2Fmcp_server.py%23L33-L129" target="_blank" title="../trae_mem/mcp_server.py#L33-L129" ref="nofollow noopener noreferrer">mcp_server.py</a> 的 <code>_tools()</code> 里，<code>trae-mem</code> 定义了 7 个工具：</p>
<ul>
<li><code>trae_mem_search</code>：全文检索</li>
<li><code>trae_mem_timeline</code>：按 observation_id 拉时间窗</li>
<li><code>trae_mem_get_observations</code>：按 ID 批量取详情</li>
<li><code>trae_mem_inject</code>：生成可注入上下文块</li>
<li><code>trae_mem_start_session</code>：创建 session</li>
<li><code>trae_mem_log</code>：写入 observation</li>
<li><code>trae_mem_end_session</code>：结束 session 并生成摘要</li>
<li><code>trae_mem_hook_event</code>：适配生命周期事件（把 Trae 事件写进 DB）</li>
</ul>
<p>每个工具都有：</p>
<ul>
<li><code>name</code></li>
<li><code>description</code>：给模型读的说明</li>
<li><code>inputSchema</code>：参数结构（类型、必填字段、枚举值）</li>
</ul>
<p>这是“模型可调用工具”的关键：<strong>description + schema 就是模型的说明书</strong>。</p>
<hr/>
<h2 data-id="heading-4">5. 工具执行：tools/call 如何路由到真实逻辑？</h2>
<p>当 Trae 收到 Agent 输出的“调用某工具”的意图，它会发送 <code>tools/call</code> 给 server。server 在 <code>_handle_tool_call()</code> 内做路由（见 <a href="https://link.juejin.cn?target=..%2Ftrae_mem%2Fmcp_server.py%23L131-L249" target="_blank" title="../trae_mem/mcp_server.py#L131-L249" ref="nofollow noopener noreferrer">mcp_server.py</a>）：</p>
<h3 data-id="heading-5">5.1 示例：trae_mem_inject（上下文注入）</h3>
<ul>
<li>参数：<code>query/limit/project</code></li>
<li>逻辑：调用 <a href="https://link.juejin.cn?target=..%2Ftrae_mem%2Fapi.py%23L98-L141" target="_blank" title="../trae_mem/api.py#L98-L141" ref="nofollow noopener noreferrer">build_injection_block</a> 拼一段文本块</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> name == <span class="hljs-string">"trae_mem_inject"</span>:
    text = build_injection_block(db, query=query, limit=limit, project_path=...)
    <span class="hljs-keyword">return</span> _tool_text_result(text, structured={<span class="hljs-string">"context"</span>: text})
</code></pre>
<p>返回值是 MCP 约定的 ToolResult 结构：<code>content: [{type:"text", text:"..."}]</code>。</p>
<h3 data-id="heading-6">5.2 示例：trae_mem_log（写 observation）</h3>
<p>它会：</p>
<ul>
<li>处理 <code>&lt;private&gt;</code> 脱敏（必要时将整段标记为 private）</li>
<li>调用 <code>db.add_observation(...)</code></li>
<li>返回 <code>observation_id</code></li>
</ul>
<p>见 <a href="https://link.juejin.cn?target=..%2Ftrae_mem%2Fmcp_server.py%23L181-L208" target="_blank" title="../trae_mem/mcp_server.py#L181-L208" ref="nofollow noopener noreferrer">mcp_server.py</a>。</p>
<hr/>
<h2 data-id="heading-7">6. 关键桥梁：trae_mem_hook_event 怎么把 Trae 生命周期“灌进来”？</h2>
<p><code>trae_mem_hook_event</code> 是 <code>trae-mem</code> 的“适配器工具”。它把 Trae 的生命周期事件（SessionStart / PreToolUse 等）转换成 <code>hooks_bridge.py</code> 能处理的形式。</p>
<p>实现位于 <a href="https://link.juejin.cn?target=..%2Ftrae_mem%2Fmcp_server.py%23L229-L245" target="_blank" title="../trae_mem/mcp_server.py#L229-L245" ref="nofollow noopener noreferrer">mcp_server.py</a>：</p>
<p>核心技巧只有一个：<strong>伪造 stdin，复用 hooks_bridge 的 main()</strong>。</p>
<pre><code class="hljs language-python" lang="python">buf = json.dumps(payload, ensure_ascii=<span class="hljs-literal">False</span>)
proc_argv = [<span class="hljs-string">"--event"</span>, event]
stdin_backup = sys.stdin
<span class="hljs-keyword">try</span>:
    sys.stdin = io.StringIO(buf)
    rc = <span class="hljs-built_in">int</span>(hooks_bridge_main(proc_argv))
<span class="hljs-keyword">finally</span>:
    sys.stdin = stdin_backup
</code></pre>
<p>这带来两个好处：</p>
<ul>
<li>hooks_bridge 可以继续保持“命令行风格”（stdin + argv），测试/调试都很方便</li>
<li>MCP server 不需要重复写一遍事件处理逻辑</li>
</ul>
<hr/>
<h2 data-id="heading-8">7. 备用接口：HTTP API 为什么存在？</h2>
<p>除了 MCP，<code>trae-mem</code> 还提供了一个极简 HTTP API（见 <a href="https://link.juejin.cn?target=..%2Ftrae_mem%2Fapi.py" target="_blank" title="../trae_mem/api.py" ref="nofollow noopener noreferrer">api.py</a>）。它的价值是：</p>
<ul>
<li>不依赖 IDE：脚本/浏览器也能查</li>
<li>便于外部集成：比如你写一个 Android Studio 插件，也能直接请求 <code>/inject</code></li>
</ul>
<p>常用端点：</p>
<ul>
<li><code>/search?q=...</code></li>
<li><code>/timeline?observation_id=...</code></li>
<li><code>/inject?q=...&amp;project=...</code></li>
</ul>
<hr/>
<h2 data-id="heading-9">8. 你可以怎么扩展？</h2>
<p>如果你想让 MCP 层更强，常见方向有：</p>
<ul>
<li><strong>更强的 structuredContent</strong>：不仅返回 text，还返回结构化 JSON，便于 Trae 或未来的 UI 做渲染</li>
<li><strong>权限/能力分级</strong>：按项目白名单、按 tool 分类限制，进一步减少误调用风险</li>
<li><strong>资源（Resources）接口</strong>：把 DB 中的 summaries 作为资源暴露，让 IDE 直接浏览</li>
</ul>
<p>至此，四篇模块拆解完成。你可以回到总览文章，从“整体架构”视角串起四块能力，并按需深入。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解读多重身份验证（MFA）绕过码：风险与最佳实践]]></title>    <link>https://juejin.cn/post/7603004323870965803</link>    <guid>https://juejin.cn/post/7603004323870965803</guid>    <pubDate>2026-02-05T02:59:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603004323870965803" data-draft-id="7602921143490084907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解读多重身份验证（MFA）绕过码：风险与最佳实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-05T02:59:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="运维有小邓1"/> <meta itemprop="url" content="https://juejin.cn/user/930603309497018"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解读多重身份验证（MFA）绕过码：风险与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/930603309497018/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    运维有小邓1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T02:59:05.000Z" title="Thu Feb 05 2026 02:59:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>多因素认证（MFA）被广泛视为身份保护的黄金标准。然而，尽管其应用已十分普遍，攻击者仍在不断寻找MFA部署中的漏洞。其中一个常被误解的攻击向量便是MFA绕过码——这是一种一次性的替代认证方式，允许用户在特定、可控的情况下，无需提供主要第二验证因素即可完成登录流程。</p>
<p>本文将深入探讨MFA绕过码的定义、其引入的安全风险、攻击者利用绕过码的常见手段，以及最重要的——企业如何缓解这些威胁。同时，我们还将分析ADSelfService Plus等工具如何帮助企业在维持强效MFA防护的同时，安全管理必要的备用验证机制。</p>
<h3 data-id="heading-0">一、什么是MFA绕过码？</h3>
<p>MFA绕过码是一种替代认证令牌，允许用户（在某些情况下也包括管理员）在特定场景下绕过标准的MFA验证。典型的合法使用场景包括：</p>
<p>用户丢失、更换验证设备，或无法获取短信/邮件验证码；<br/>
当用户的主要MFA验证方式不可用时，管理员发放临时绕过码；<br/>
部分系统允许可信设备或可信网络在可控条件下绕过MFA，例如“记住我”功能或短期会话豁免机制。<br/>
若绕过码部署得当——具备短期有效性、一次性使用属性、可审计性，且仅在经过严格身份验证后发放，就能在不削弱MFA安全优势的前提下，为企业运营提供灵活性。反之，若管理松散、配置不当或过度使用，则会引入显著安全风险。</p>
<h3 data-id="heading-1">二、为何绕过码成为攻击目标？攻击者如何利用？</h3>
<p>绕过码在保障业务连续性方面发挥着重要作用，但也催生了攻击者可能利用的替代认证路径，尤其是当这些机制缺乏严格管控时。以下将解析为何绕过码在当前威胁环境中备受关注，以及攻击者的常见滥用手段。</p>
<p><strong>人为因素与社会工程攻击</strong><br/>
攻击者往往将目标聚焦于人而非系统。他们可能冒充IT人员或终端用户向服务台索要绕过码，或诱骗用户泄露自身的绕过码。尽管MFA疲劳攻击不会直接生成绕过码，但会向用户施压，迫使其批准欺诈性MFA验证请求，进而为攻击者利用恢复流程或可信设备逻辑创造可乘之机。</p>
<p><strong>配置不当与遗留认证路径</strong><br/>
薄弱或过时的配置可能无意中产生MFA绕过条件，例如：</p>
<p>条件访问规则自动信任特定位置或设备，降低MFA验证要求；<br/>
邮局协议（POP）、互联网邮件访问协议（IMAP）等遗留协议完全无法强制执行MFA验证。<br/>
若这些遗留路径未被禁用，实际上就等同于MFA绕过机制，极易成为攻击者规避MFA验证的目标。</p>
<p><strong>脆弱的MFA恢复流程</strong><br/>
重置验证应用、更换可信设备等恢复流程，其安全性往往低于MFA验证本身。薄弱的身份验证、过时的服务台流程或不安全的恢复渠道，都可能让攻击者无需获取用户设备或验证码就能绕过MFA。</p>
<p><strong>绕过码生命周期管理不善</strong><br/>
若绕过码不具备一次性使用属性、有效期过长、发放渠道不安全，或缺乏完整日志记录，就更容易被拦截、复用或未授权发放。而审计不足则会进一步降低对绕过码相关可疑活动的可见性。</p>
<p><strong>管理员账户泄露或权限过度</strong><br/>
管理员通常拥有生成绕过码的权限，这使其账户成为高价值攻击目标。一旦攻击者攻陷管理员账户，或管理员持有不必要的过高权限，就能绕开MFA验证直接发放绕过码，进而获取受保护系统的访问权限。</p>
<p>绕过码本身并非天生不安全，风险核心在于管理薄弱。若能将其严格管控为短期有效、一次性使用、可审计，且与强效身份验证绑定，就能在不削弱MFA防御价值的前提下，提升系统韧性。</p>
<h3 data-id="heading-2">三、风险缓解：MFA绕过码管理最佳实践</h3>
<p>为保护企业免受MFA绕过机制相关威胁，建议部署以下最佳实践：</p>
<p>为所有账户强制执行MFA验证，尤其是特权账户和服务账户。除非有充分合理的理由，否则避免选择性豁免，减少对MFA绕过码的不必要依赖；<br/>
定期审查条件访问规则、会话设置和可信设备策略，减少可信设备与可信位置的绕过场景，确保不存在可作为“隐性绕过路径”的意外或隐藏MFA豁免规则；<br/>
严格管控绕过码：</p>
<p>监控异常MFA行为，例如重复的MFA验证请求、多次申请绕过码、来自陌生或高风险设备/位置的登录尝试；<br/>
开展用户安全教育，强调绕过码属于敏感凭证，严禁共享、通过邮件传输或存储在不安全位置。</p>
<h3 data-id="heading-3">四、ADSelfService Plus如何强化MFA防护并管控绕过风险？</h3>
<p>ADSelfService Plus提供强大且灵活的MFA框架，旨在降低绕过风险，为各类企业环境提供全面的强效认证保障。</p>
<p><strong>1. 绕过码可视化与审计报告</strong></p>
<p>ADSelfService Plus具备全面的审计日志和报告功能，让管理员能全程掌握MFA活动及绕过码使用情况。其中，MFA使用审计报告可追踪每一次认证尝试，包括认证成败、时间戳、终端设备和IP地址等信息，助力快速识别异常行为。</p>
<p>专属的备用码使用报告（ADSelfService Plus中，备用码即受控MFA绕过码）会记录所有备用码的生成与使用实例，捕获用户信息、关联策略、终端设备、IP地址以及操作发起方（用户或管理员）等细节。结合导出功能和定时推送机制，企业能对备用认证流程实现强效监管，减少对不安全恢复方式的依赖，严格管控绕过码，在保障可用性的同时维持稳健的身份安全。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c73afd9083a476c94a59571c68efca9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-Q57u05pyJ5bCP6YKTMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770865144&amp;x-signature=I6Hn3e72iszKJZBFUQOJ3Pck%2BxY%3D" alt="image.png" loading="lazy"/></p>
<p><strong>2. 全面的终端与访问覆盖</strong></p>
<p>ADSelfService Plus支持在Windows、macOS、Linux设备上部署MFA，覆盖域加入账户和本地账户；同时保障远程访问路径安全，包括RDP、VPN（通过RADIUS协议）和Outlook Web Access，确保所有终端均能实现一致的MFA验证。值得注意的是，该解决方案为Windows和macOS提供离线MFA功能，即便设备脱离网络，也能实现安全登录。</p>
<p><strong>3. 自适应MFA</strong></p>
<p>管理员可基于IP地址、设备类型、访问时间和地理位置定义条件访问策略。ADSelfService Plus会根据这些条件动态调整MFA验证的级别或类型，在平衡安全性与可用性的同时，避免过度使用备用或绕过机制。</p>
<p><strong>4. 丰富的认证因素选择</strong></p>
<p>ADSelfService Plus支持20种认证方式，包括生物识别（指纹识别、人脸识别）、YubiKey等FIDO2密钥、基于TOTP的验证应用以及短信/邮件一次性验证码。通过支持安全密钥和设备密钥，企业可部署抗钓鱼的无密码认证方案。这些强效认证因素能减少对绕过码等备用机制的需求，显著提升整体身份安全水平。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bd22a29e0cc428bbc97228b7d99ed53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-Q57u05pyJ5bCP6YKTMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770865144&amp;x-signature=ueVqTguIVlDjLNKnyJk%2BNP8dJM4%3D" alt="image.png" loading="lazy"/></p>
<p><strong>5. 精细化策略控制</strong></p>
<p>管理员可基于组织单元、安全组或域结构制定精细化MFA策略，确保敏感部门或特权用户采用更严格的认证要求，降低MFA被绕过或过度使用绕过码的风险。强制注册规则能确保用户及时完成验证工具注册，而策略级限制可让管理员管控用户可使用的认证因素类型。结合条件访问规则，企业可根据风险等级或访问场景执行差异化的MFA流程。</p>
<p>MFA虽不可或缺，但并非无懈可击。绕过码、可信设备豁免、遗留协议以及社会工程攻击等，均会增加MFA被绕过的风险，因此对备用机制的严格管控至关重要。通过执行严格的绕过码管控、监控绕过码使用模式、部署抗钓鱼认证方案，企业可大幅降低绕过码滥用带来的风险。ADSelfService Plus等解决方案通过强化备用认证路径、提供全面的威胁可见性，助力企业抵御新兴威胁。在身份成为新安全边界的当下，同时保障主MFA流程与备用机制的安全，是实现真正安全韧性的核心要求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Hashids 优雅解决 C 端自增 ID 暴露问题]]></title>    <link>https://juejin.cn/post/7602811649126301747</link>    <guid>https://juejin.cn/post/7602811649126301747</guid>    <pubDate>2026-02-04T13:09:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602811649126301747" data-draft-id="7602634187284185098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Hashids 优雅解决 C 端自增 ID 暴露问题"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-02-04T13:09:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ALGO"/> <meta itemprop="url" content="https://juejin.cn/user/2207475076971502"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Hashids 优雅解决 C 端自增 ID 暴露问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2207475076971502/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ALGO
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T13:09:30.000Z" title="Wed Feb 04 2026 13:09:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 C 端系统中，直接对外暴露数据库自增 ID 往往会带来数据枚举、越权访问等安全隐患。本文将从实际业务场景出发，分析自增 ID 暴露的问题本质，并介绍一种基于 Hashids 的可逆 ID 混淆方案。通过 Hashids，我们可以在不改变数据库结构的前提下，实现对外 ID 的安全化与美观化，兼顾安全性、性能与工程可落地性。</p>
<p><strong>本文主要内容：</strong></p>
<ul>
<li>为什么 C 端系统不能直接暴露自增 ID</li>
<li>解决方案是什么</li>
<li>hashids有那些功能</li>
<li>hashids的代码实现是什么</li>
</ul>
<h2 data-id="heading-0">为什么 C 端系统不能直接暴露自增 ID？</h2>
<p>在后端系统中，我们习惯使用数据库自增 ID，并习惯性的直接返回给C端交互使用，例如：</p>
<blockquote>
<p>登录接口在登录成功后返回的用户基础信息<br/>
{<br/>
"userId": 100,<br/>
"username": "tom",<br/>
"gender": 1,<br/>
"birthday": "2000-10-12 00:00:00"<br/>
}</p>
<p>URL上直接有自增ID：GET /api/user/100</p>
</blockquote>
<h3 data-id="heading-1">可被枚举</h3>
<p>只要有人发现这是<strong>自增 ID，</strong> 例如：GET /api/user/100，自然可以被枚举</p>
<blockquote>
<p>/api/user/101</p>
<p>/api/user/102</p>
<p>/api/user/103</p>
<p>......</p>
</blockquote>
<p>发现了问题没：</p>
<ul>
<li>可以轻松遍历接口、爬虫可以批量扫库</li>
<li>哪怕你有登录态、鉴权，只要 <strong>权限校验有一个点没兜住</strong>，后果极其严重：表数据被批量抓取，隐私数据被遍历、爬光</li>
<li>这类攻击成本极低，甚至不算“攻击”</li>
</ul>
<h3 data-id="heading-2">越权</h3>
<p>越权的风险被无限放大，你“以为”你做了鉴权，其实不一定，现实情况往往是：</p>
<ul>
<li>接口 A 做了用户校验</li>
<li>接口 B 忘了</li>
<li>新接口临时加的，校验漏了</li>
<li>某个内部接口被误暴露</li>
</ul>
<p>一旦 ID 是可预测的：</p>
<ul>
<li>攻击者只需要找到 一个没校验的入口</li>
<li>就可以“横向移动”访问所有数据</li>
</ul>
<p>例如，URL中存在自增ID，在C端非常典型的场景是用户分享链接给朋友，如果朋友修改URL中的ID，就会跳转到本不属于自己能看到的数据内容。</p>
<h3 data-id="heading-3">业务信息全暴露</h3>
<p>通过 ID 就能看穿你的业务信息，例如：</p>
<ul>
<li>📈 <strong>订单量增长速度</strong></li>
<li>👥 <strong>用户规模</strong></li>
<li>⏱️ <strong>业务峰值时段</strong></li>
<li>🧮 <strong>是否删过数据（ID 是否断层）</strong></li>
</ul>
<p>这种在C端用户看来没有意义的数据，如果让用户“看不懂”的 ID，反而更专业。</p>
<ul>
<li>👉 纯数字 ID，看起来像“内部系统”</li>
<li>👉混淆 ID， 更像“产品设计的一部分”</li>
</ul>
<h2 data-id="heading-4">解决方案</h2>
<p>根据以上问题，我们期望有这样一种解决方案可以混淆自增ID</p>
<ul>
<li>唯一不可重复：数据量内都必须唯一，不能重复</li>
<li>支持可逆：ID可以编码为一个看不出规律的串，也可以解码为原ID，不影响数据库ID字段</li>
<li>高效生成与解析：生成、验证的算法必须保证效率，不能占用太多系统资源</li>
<li>不可预测与安全：无规则混淆，规律性不能很明显，不能轻易被人猜测到，防止爆刷</li>
<li>工程成本低：不改表、不迁数据</li>
</ul>
<p><strong>常见但不够优雅的解决方案</strong></p>
<ul>
<li>
<p>UUID</p>
<ul>
<li>字符串过长</li>
<li>URL、二维码不友好</li>
<li>调试体验差</li>
</ul>
</li>
<li>
<p>Snowflake / Base64</p>
<ul>
<li>仍然可能暴露时间信息</li>
<li>前后端实现不统一</li>
</ul>
</li>
<li>
<p>AES / RSA 加密 ID</p>
<ul>
<li>性能与复杂度成本高</li>
<li>对“只是隐藏 ID”来说属于过度设计</li>
</ul>
</li>
</ul>
<p><strong>这个解决方案就是Hashids。</strong></p>
<p><strong>Hashids的核心功能：把一个或多个整数（int / long）转换成一个不可预测、可逆的短字符串。</strong></p>
<p><strong>基本属性</strong></p>
<ul>
<li>输入是整数（支持long型），输出是字符串（只包含：a-z A-Z 0-9，无其他特殊字符）</li>
<li>可以自定义编码字符</li>
<li><strong>可逆</strong>，但不可猜</li>
<li>支持多个ID编码为一个字符串</li>
<li>可控制最小长度，不支持“最长长度”限制，实际长度是不固定的，随输入数字大小变化</li>
</ul>
<p><strong>典型用途：</strong></p>
<ul>
<li>数据库自增 ID ，对外展示用字符串，防止 ID 枚举</li>
<li>短链接 / 邀请码 / 兑换码</li>
<li>URL / 小程序参数更友好</li>
<li>将多个数字（数组）进行混淆，防止参数被篡改</li>
</ul>
<p><strong>注意：</strong> 它是“混淆（obfuscation）”，不是“加密（encryption）”，不能作为密码学类的场景使用。</p>
<h2 data-id="heading-5"><strong>Hashids内部原理</strong></h2>
<p>编码（encdoe）流程：</p>
<blockquote>
<p>原始数字 --&gt; 打乱字符表（依赖 salt） --&gt; 选取 guard / separator --&gt; 进制转换（base-N） --&gt; 按规则拼接 --&gt; 输出字符串</p>
</blockquote>
<p><strong>核心组成元素</strong></p>
<ul>
<li>
<p>核心组成元素</p>
<ul>
<li>字符表（alphabet）：指定那些字符是输出的结果集</li>
<li>默认字符集：abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890</li>
<li>你也可以自定义（例如只用大小写 + 数字，排除 0/O/I/l），注意字符不能重复。</li>
<li>字符集长度 = 进制 base N</li>
</ul>
</li>
<li>
<p>salt</p>
<ul>
<li>决定字符表如何被洗牌</li>
<li>同一个 ID，在不同 salt 下，结果完全不同</li>
<li>不保存 salt，就无法反解</li>
</ul>
</li>
<li>
<p>separators &amp; guards</p>
<ul>
<li>Hashids 会从 alphabet 中分出两类特殊字符：separators，分隔多个数字。guards，控制最小长度、增强不可预测性。</li>
<li>这一步主要是为了：避免输出模式过于规则，同时支持编码多个数字的场景（encode(1,2,3)）</li>
</ul>
</li>
</ul>
<p><strong>怎么实现可逆性的？</strong></p>
<ul>
<li>字符表洗牌（consistent shuffle）</li>
<li>在相同 alphabet + salt下，编码同一ID，结果永远相同</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">from</span> alphabet.length-<span class="hljs-number">1</span> downTo <span class="hljs-number">1</span>:
    j = (salt_char_code + i + previous) % i
    swap(alphabet[i], alphabet[j])
</code></pre>
<p><strong>怎么转换为字符串的？</strong></p>
<ul>
<li>假设字符表（alphabet）的长度为62</li>
<li>数字先模62，得到的余数作为下标从字符表中取得一个字符</li>
<li>再除62，直到数字小于0时停止</li>
<li>得到一个字符串</li>
</ul>
<p><strong>如何支持同时编码多个数字？</strong></p>
<p>例如：encode(1, 2, 3)</p>
<blockquote>
<p>1 → abc<br/>
2 → k9<br/>
3 → z</p>
</blockquote>
<p>中间用 separator（也是来自 alphabet，但经过专门筛选）隔开，最终输出：abcXk9Yz</p>
<p><strong>怎么保证最小长度？</strong></p>
<ul>
<li>在头尾插入 guard</li>
<li>再次洗牌 alphabet</li>
<li>重复直到满足长度，这一步是伪随机填充，不影响 decode。</li>
</ul>
<p><strong>decode的工作流程？</strong></p>
<ul>
<li>去掉 guards</li>
<li>用 separators 切分</li>
<li>复原 alphabet 洗牌</li>
<li>每一段做 base-N → long</li>
</ul>
<p><strong>decode失败怎么处理？</strong></p>
<ul>
<li>salt 不一致 → decode 失败或得到错误值</li>
<li>alphabet 不一致 → decode 失败</li>
</ul>
<h2 data-id="heading-6">代码实现</h2>
<p>终于到了激动人心的代码实现环节，撸起袖子，敲键盘。</p>
<p>在pom中导入依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hashids<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hashids<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-7">简单用法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hashids.Hashids;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.Arrays;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashidsService</span> {

    <span class="hljs-comment">//Bean单例，不存在线程安全问题</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Hashids</span> <span class="hljs-variable">hashids</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashids</span>();

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encode</span><span class="hljs-params">(<span class="hljs-type">int</span> code)</span> {
        <span class="hljs-keyword">return</span> hashids.encode(code);
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encode</span><span class="hljs-params">(<span class="hljs-type">long</span> code)</span> {
        <span class="hljs-keyword">return</span> hashids.encode(code);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">decode</span><span class="hljs-params">(String decoded)</span> {
        <span class="hljs-type">long</span>[] decodes = hashids.decode(decoded);
        <span class="hljs-keyword">if</span> (decodes.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"非法ID"</span>);
        }
        <span class="hljs-keyword">return</span> decodes[<span class="hljs-number">0</span>];
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encodeArr</span><span class="hljs-params">(<span class="hljs-type">int</span>[] codes)</span> {
        <span class="hljs-type">long</span>[] codeArr = Arrays.stream(codes).asLongStream().toArray();
        <span class="hljs-keyword">return</span> hashids.encode(codeArr);
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encodeArr</span><span class="hljs-params">(<span class="hljs-type">long</span>[] codes)</span> {
        <span class="hljs-keyword">return</span> hashids.encode(codes);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span>[] decodeArr(String decoded) {
        <span class="hljs-type">long</span>[] decodes = hashids.decode(decoded);
        <span class="hljs-keyword">if</span> (decodes.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"非法ID"</span>);
        }
        <span class="hljs-keyword">return</span> decodes;
    }

}
</code></pre>
<h3 data-id="heading-8">加盐</h3>
<p>加盐混淆</p>
<ul>
<li>防止别人用同样库解你 ID</li>
<li>salt 一旦上线 绝对不能改</li>
</ul>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">hashids:</span>
  <span class="hljs-attr">salt:</span> <span class="hljs-string">kjsdfiaosudkskldjfa</span> <span class="hljs-comment">#混淆用的盐</span>
  <span class="hljs-attr">min-length:</span> <span class="hljs-number">8</span> <span class="hljs-comment">#最小长度</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.ks.demo.uc.hashids;

<span class="hljs-keyword">import</span> org.hashids.Hashids;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> javax.annotation.PostConstruct;
<span class="hljs-keyword">import</span> java.util.Arrays;

<span class="hljs-comment">/**
 * 加盐混淆
 *
 * salt的作用
 * 防止别人用同样库解你 ID
 * salt 一旦上线 绝对不能改
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashidsSaltService</span> {
    <span class="hljs-meta">@Value("${hashids.salt}")</span>
    <span class="hljs-keyword">private</span> String salt;
    <span class="hljs-meta">@Value("${hashids.min-length}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> minLength;

    <span class="hljs-comment">//new在@Value注入之前</span>
    <span class="hljs-comment">//解决方案：后构造器，在构造器的入参使用@Value，使用@ConfigurationProperties单独注入</span>
    <span class="hljs-comment">//private Hashids hashidsSalt = new Hashids(salt);</span>

    <span class="hljs-keyword">private</span> <span class="hljs-type">Hashids</span> <span class="hljs-variable">hashidsSalt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Hashids</span> <span class="hljs-variable">hashidsMinLen</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        hashidsSalt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashids</span>(salt);
        hashidsMinLen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashids</span>(salt, minLength);
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encode</span><span class="hljs-params">(<span class="hljs-type">int</span> code)</span> {
        <span class="hljs-keyword">return</span> hashidsSalt.encode(code);
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encode</span><span class="hljs-params">(<span class="hljs-type">long</span> code)</span> {
        <span class="hljs-keyword">return</span> hashidsSalt.encode(code);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">decode</span><span class="hljs-params">(String decoded)</span> {
        <span class="hljs-type">long</span>[] decodes = hashidsSalt.decode(decoded);
        <span class="hljs-keyword">if</span> (decodes.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"非法ID"</span>);
        }
        <span class="hljs-keyword">return</span> decodes[<span class="hljs-number">0</span>];
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encodeArr</span><span class="hljs-params">(<span class="hljs-type">int</span>[] codes)</span> {
        <span class="hljs-type">long</span>[] codeArr = Arrays.stream(codes).asLongStream().toArray();
        <span class="hljs-keyword">return</span> hashidsSalt.encode(codeArr);
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encodeArr</span><span class="hljs-params">(<span class="hljs-type">long</span>[] codes)</span> {
        <span class="hljs-keyword">return</span> hashidsSalt.encode(codes);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span>[] decodeArr(String decoded) {
        <span class="hljs-type">long</span>[] decodes = hashidsSalt.decode(decoded);
        <span class="hljs-keyword">if</span> (decodes.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"非法ID"</span>);
        }
        <span class="hljs-keyword">return</span> decodes;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encodeMinLen</span><span class="hljs-params">(<span class="hljs-type">int</span> code)</span> {
        <span class="hljs-keyword">return</span> hashidsMinLen.encode(code);
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encodeMinLen</span><span class="hljs-params">(<span class="hljs-type">long</span> code)</span> {
        <span class="hljs-keyword">return</span> hashidsMinLen.encode(code);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">decodeMinLen</span><span class="hljs-params">(String decoded)</span> {
        <span class="hljs-type">long</span>[] decodes = hashidsMinLen.decode(decoded);
        <span class="hljs-keyword">if</span> (decodes.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"非法ID"</span>);
        }
        <span class="hljs-keyword">return</span> decodes[<span class="hljs-number">0</span>];
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encodeMinLenArr</span><span class="hljs-params">(<span class="hljs-type">int</span>[] codes)</span> {
        <span class="hljs-type">long</span>[] codeArr = Arrays.stream(codes).asLongStream().toArray();
        <span class="hljs-keyword">return</span> hashidsMinLen.encode(codeArr);
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encodeMinLenArr</span><span class="hljs-params">(<span class="hljs-type">long</span>[] codes)</span> {
        <span class="hljs-keyword">return</span> hashidsMinLen.encode(codes);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span>[] decodeMinLenArr(String decoded) {
        <span class="hljs-type">long</span>[] decodes = hashidsMinLen.decode(decoded);
        <span class="hljs-keyword">if</span> (decodes.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"非法ID"</span>);
        }
        <span class="hljs-keyword">return</span> decodes;
    }
}
</code></pre>
<h3 data-id="heading-9">自定义参与编码的字符</h3>
<p><strong>字符集规则：</strong></p>
<ul>
<li>至少 16 个字符</li>
<li>不允许重复字符</li>
</ul>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">hashids:</span>
  <span class="hljs-attr">salt:</span> <span class="hljs-string">kjsdfiaosudkskldjfa</span> <span class="hljs-comment">#混淆用的盐</span>
  <span class="hljs-attr">min-length:</span> <span class="hljs-number">8</span> <span class="hljs-comment">#最小长度</span>
  <span class="hljs-comment">#至少 16 个字符，不允许重复字符</span>
  <span class="hljs-comment">#参与编码的字符，可以剔除调0/O/o,1/I/l等字符，增强可读性</span>
  <span class="hljs-attr">base-char:</span> <span class="hljs-string">0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.ks.demo.uc.hashids;

<span class="hljs-keyword">import</span> org.hashids.Hashids;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> javax.annotation.PostConstruct;
<span class="hljs-keyword">import</span> java.util.Arrays;

<span class="hljs-comment">/**
 * 自定义参与编码的字符
 *
 * 字符集规则：
 * 至少 16 个字符
 * 不允许重复字符
 *
 * 使用场景
 * 避免 0/O、l/1 混淆
 * 只允许大写字母
 *
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashidsBaseCharService</span> {
    <span class="hljs-meta">@Value("${hashids.salt}")</span>
    <span class="hljs-keyword">private</span> String salt;
    <span class="hljs-meta">@Value("${hashids.min-length}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> minLength;
    <span class="hljs-meta">@Value("${hashids.base-char}")</span>
    <span class="hljs-keyword">private</span> String baseChar;

    <span class="hljs-keyword">private</span> <span class="hljs-type">Hashids</span> <span class="hljs-variable">hashids</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        hashids = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashids</span>(salt, minLength, baseChar);
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encode</span><span class="hljs-params">(<span class="hljs-type">int</span> code)</span> {
        <span class="hljs-keyword">return</span> hashids.encode(code);
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encode</span><span class="hljs-params">(<span class="hljs-type">long</span> code)</span> {
        <span class="hljs-keyword">return</span> hashids.encode(code);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">decode</span><span class="hljs-params">(String decoded)</span> {
        <span class="hljs-type">long</span>[] decodes = hashids.decode(decoded);
        <span class="hljs-keyword">if</span> (decodes.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"非法ID"</span>);
        }
        <span class="hljs-keyword">return</span> decodes[<span class="hljs-number">0</span>];
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encodeArr</span><span class="hljs-params">(<span class="hljs-type">int</span>[] codes)</span> {
        <span class="hljs-type">long</span>[] codeArr = Arrays.stream(codes).asLongStream().toArray();
        <span class="hljs-keyword">return</span> hashids.encode(codeArr);
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encodeArr</span><span class="hljs-params">(<span class="hljs-type">long</span>[] codes)</span> {
        <span class="hljs-keyword">return</span> hashids.encode(codes);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span>[] decodeArr(String decoded) {
        <span class="hljs-type">long</span>[] decodes = hashids.decode(decoded);
        <span class="hljs-keyword">if</span> (decodes.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"非法ID"</span>);
        }
        <span class="hljs-keyword">return</span> decodes;
    }

}
</code></pre>
<h2 data-id="heading-10">结尾</h2>
<p>在文章最后，尝试对自己提问一下问题，来检验你是否真正了解到了本文的核心内容。</p>
<ol>
<li>C 端自增 ID 暴露会有那些问题？</li>
<li>hashids的核心特性？为什么可以作为混淆自增id的解决方案？</li>
<li>hashids的功能有那些？</li>
<li>代码怎么写？</li>
</ol>
<p>本文结束。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥 让 Claude 直接读写你的语雀知识库！这款开源工具太香了]]></title>    <link>https://juejin.cn/post/7602901565033742382</link>    <guid>https://juejin.cn/post/7602901565033742382</guid>    <pubDate>2026-02-04T13:28:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602901565033742382" data-draft-id="7602910573403783206" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥 让 Claude 直接读写你的语雀知识库！这款开源工具太香了"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-04T13:28:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小镇cxy"/> <meta itemprop="url" content="https://juejin.cn/user/3318776686718483"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥 让 Claude 直接读写你的语雀知识库！这款开源工具太香了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3318776686718483/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小镇cxy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T13:28:32.000Z" title="Wed Feb 04 2026 13:28:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🔥 让 Claude 直接读写你的语雀知识库！这款开源工具太香了</h2>
<h3 data-id="heading-1">AI时代的知识管理困境</h3>
<p>你是否也曾遇到过这样的场景：</p>
<ul>
<li>💻 写代码时，想查阅团队的技术文档，却要切出 IDE，打开浏览器，登录语雀，搜索关键词...</li>
<li>📝 让 AI 帮你整理文档，结果它完全不知道你知识库里有哪些内容</li>
<li>🔄 团队知识库沉淀了大量干货，却无法与 AI 工作流无缝集成</li>
</ul>
<p><strong>如果 Claude 能直接访问你的语雀知识库，会是什么体验？</strong></p>
<p>今天给大家介绍一个开源项目 —— <strong>yuque-mcp</strong>，让你的 Claude Desktop 或 Claude Code CLI 与语雀知识库完美融合！</p>
<hr/>
<h3 data-id="heading-2">🎯 什么是 yuque-mcp？</h3>
<p><strong>yuque-mcp</strong> 是一个基于 <strong>Model Context Protocol (MCP)</strong> 标准开发的服务器，打通了 Claude Desktop 与语雀知识库之间的壁垒。</p>
<p>简单来说：<strong>安装后，Claude 就能直接搜索、读取、创建、更新语雀文档了！</strong></p>
<hr/>
<h3 data-id="heading-3">✨ 核心功能一览</h3>
<h4 data-id="heading-4">🔍 智能搜索 (search)</h4>
<p>一句话找到你需要的文档：</p>
<blockquote>
<p>"帮我搜索关于 TypeScript 类型系统的语雀文档"</p>
</blockquote>
<h4 data-id="heading-5">📁 目录浏览 (get_toc)</h4>
<p>一键获取知识库完整结构：</p>
<blockquote>
<p>"查看我们团队知识库的目录结构"</p>
</blockquote>
<h4 data-id="heading-6">📖 内容读取 (get_doc)</h4>
<p>精准获取文档详细内容：</p>
<blockquote>
<p>"获取文档 123456 的完整内容"</p>
</blockquote>
<h4 data-id="heading-7">✍️ 文档创建 (create_doc)</h4>
<p>AI 直接帮你写文档并发布到语雀：</p>
<blockquote>
<p>"创建一篇部署指南，内容包括环境准备和部署步骤"</p>
</blockquote>
<h4 data-id="heading-8">📝 文档更新 (update_doc)</h4>
<p>直接修改已有文档，无需手动打开编辑器：</p>
<blockquote>
<p>"更新文档 123456，在末尾添加今天的工作总结"</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">💡 真实使用场景</h3>
<h4 data-id="heading-10">场景一：代码开发时查阅文档</h4>
<pre><code class="hljs language-css" lang="css">你：我想用 React 实现一个表单验证，但不确定团队的最佳实践

Claude：让我先搜索一下你们语雀知识库中的相关文档...

<span class="hljs-selector-attr">[已搜索到 3 篇相关文档]</span>
根据你们团队的《React 表单开发规范》，推荐使用 react-hook-<span class="hljs-selector-tag">form</span>...

你：太方便了！不用切出去查文档了！
</code></pre>
<h4 data-id="heading-11">场景二：AI 辅助文档编写</h4>
<pre><code class="hljs language-erlang" lang="erlang">你：帮我把今天的会议记录整理成文档，发到语雀<span class="hljs-string">"项目纪要"</span>分类下

Claude：好的，我先查看目录结构找到对应分类...

[已获取目录结构]
正在创建文档《<span class="hljs-number">2024</span>-<span class="hljs-number">01</span>-<span class="hljs-number">28</span> 产品需求评审会》...

文档已创建完成！访问链接：https://www.yuque.com/...
</code></pre>
<h4 data-id="heading-12">场景三：迭代更新文档</h4>
<pre><code class="hljs language-erlang" lang="erlang">你：把刚才讨论的方案更新到《技术方案文档》里

Claude：好的，我先获取文档当前内容...

[已获取文档内容]
正在更新文档，在<span class="hljs-string">"方案对比"</span>章节添加新内容...

文档已更新完成！查看链接：https://www.yuque.com/...
</code></pre>
<h4 data-id="heading-13">场景四：知识库智能问答</h4>
<pre><code class="hljs language-erlang" lang="erlang">你：我们之前是怎么解决跨域问题的？

Claude：让我搜索一下...

[找到文档《前端跨域问题解决方案》]
根据你们的技术文档，团队采用的是 Nginx 反向代理方案...
</code></pre>
<hr/>
<h3 data-id="heading-14">🛠️ 技术亮点</h3>
<ul>
<li><strong>标准化协议</strong>：基于 MCP 标准，与 Claude Desktop 原生集成</li>
<li><strong>双模式支持</strong>：同时支持 Claude Desktop 和 Claude Code CLI</li>
<li><strong>TypeScript 打造</strong>：类型安全，代码优雅</li>
<li><strong>零依赖负担</strong>：核心依赖仅 @modelcontextprotocol/sdk 和 zod</li>
<li><strong>开箱即用</strong>：简单配置即可使用</li>
</ul>
<hr/>
<h3 data-id="heading-15">🚀 3分钟快速上手</h3>
<h4 data-id="heading-16">1️⃣ 安装项目</h4>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/wangx-wx/yuque-mcp.git
<span class="hljs-built_in">cd</span> yuque-mcp
npm install
npm run build
</code></pre>
<h4 data-id="heading-17">2️⃣ 获取语雀 Token</h4>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.yuque.com%2Fsettings%2Ftokens" target="_blank" title="https://www.yuque.com/settings/tokens" ref="nofollow noopener noreferrer">语雀 Token 管理页面</a> 创建个人 Token，需要勾选 <code>read</code> 和 <code>write</code> 权限。</p>
<h4 data-id="heading-18">3️⃣ 配置方式（二选一）</h4>
<h5 data-id="heading-19">方式A：Claude Desktop 配置文件</h5>
<p>编辑配置文件（Windows 为 <code>%APPDATA%\Claude\claude_desktop_config.json</code>，macOS 为 <code>~/Library/Application Support/Claude/claude_desktop_config.json</code>）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"yuque"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"E:\\node\\yuque-mcp\\dist\\index.js"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"YUQUE_AUTH_TOKEN"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的语雀Token"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"YUQUE_BASE_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://www.yuque.com"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"YUQUE_GROUP_LOGIN"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"团队路径名（如 leyaoyao）"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"YUQUE_BOOK_SLUG"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"知识库路径（如 fe-docs）"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>💡 <strong>如何获取参数？</strong> 打开你的语雀知识库，URL 格式为 <code>https://www.yuque.com/{group_login}/{book_slug}</code>，从中提取即可。</p>
</blockquote>
<h5 data-id="heading-20">方式B：Claude Code CLI 配置（推荐）</h5>
<p>如果你使用 <strong>Claude Code</strong> 命令行工具，可以通过 CLI 快速添加：</p>
<p><strong>macOS / Linux：</strong></p>
<pre><code class="hljs language-bash" lang="bash">claude mcp add yuque-mcp \
    --scope project \
    --transport stdio \
    -- node <span class="hljs-string">"/path/to/yuque-mcp/dist/index.js"</span> \
    --<span class="hljs-built_in">env</span> YUQUE_AUTH_TOKEN=your-auth-token-here \
    --<span class="hljs-built_in">env</span> YUQUE_BASE_URL=https://www.yuque.com \
    --<span class="hljs-built_in">env</span> YUQUE_GROUP_LOGIN=your-group-login \
    --<span class="hljs-built_in">env</span> YUQUE_BOOK_SLUG=your-book-slug
</code></pre>
<p><strong>Windows (PowerShell)：</strong></p>
<pre><code class="hljs language-powershell" lang="powershell">claude mcp add yuque-mcp `
    --scope project `
    --transport stdio `
    -- node "D:/yuque-mcp/dist/index.js" `
    --env YUQUE_AUTH_TOKEN=your-auth-token-here `
    --env YUQUE_BASE_URL=https://www.yuque.com `
    --env YUQUE_GROUP_LOGIN=your-group-login `
    --env YUQUE_BOOK_SLUG=your-book-slug
</code></pre>
<p><strong>CLI 配置优势：</strong></p>
<ul>
<li>无需手动编辑 JSON 文件</li>
<li>支持项目级配置（<code>--scope project</code>），每个项目可独立配置</li>
<li>快速切换不同知识库环境</li>
</ul>
<h4 data-id="heading-21">4️⃣ 重启并验证</h4>
<ul>
<li><strong>Claude Desktop</strong>：重启应用后即可使用</li>
<li><strong>Claude Code</strong>：直接输入 <code>claude</code> 进入对话，工具会自动加载</li>
</ul>
<p>大功告成！现在就可以在对话中让 Claude 访问你的语雀知识库了！</p>
<hr/>
<h3 data-id="heading-22">🎁 项目地址</h3>
<p><strong>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwangx-wx%2Fyuque-mcp" target="_blank" title="https://github.com/wangx-wx/yuque-mcp" ref="nofollow noopener noreferrer">github.com/wangx-wx/yu…</a></strong></p>
<p>⭐ <strong>如果这个项目对你有帮助，欢迎给个 Star！</strong></p>
<hr/>
<h3 data-id="heading-23">📌 写在最后</h3>
<p>AI 的未来不是取代人类，而是成为我们最得力的助手。</p>
<p>当 Claude 能够直接访问你的团队知识库，它就不再是一个通用的 AI 助手，而是一个真正懂你、懂你业务的 <strong>AI 团队伙伴</strong>。</p>
<p><strong>yuque-mcp</strong> 只是开始，期待 MCP 生态带来更多可能性！</p>
<hr/>
<blockquote>
<p>💬 <strong>你有什么期待的场景或想法？欢迎在评论区留言！</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java反射技术]]></title>    <link>https://juejin.cn/post/7602466689712128015</link>    <guid>https://juejin.cn/post/7602466689712128015</guid>    <pubDate>2026-02-03T14:04:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602466689712128015" data-draft-id="7602472997920620544" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java反射技术"/> <meta itemprop="keywords" content="Java,后端"/> <meta itemprop="datePublished" content="2026-02-03T14:04:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="何中应"/> <meta itemprop="url" content="https://juejin.cn/user/1435305504958535"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java反射技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1435305504958535/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    何中应
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T14:04:20.000Z" title="Tue Feb 03 2026 14:04:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>说明：反射是通过对类的字节码（.class）文件进行解析，实现对javaBean对象操作的技术。使用反射的好处是，所有的javaBean组成都是相同的（成员变量、成员方法、构造器），通过反射解析.class文件，可以把多种类型的对象同时解析出来，实现用同一个配置文件（如properties）实例化多个不同类型对象的效果。另外，反射还可以无视权限修饰符，访问javaBean中的任意成员。</p>
<p>总结，使用反射的好处：（1）通用，创建不同的对象可以动态变化；（2）不受成员权限修饰符的限制
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e39462fc7dbb46c6a0763dccbf037ee8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=2NrR7UWXECi4FzGtuoQCAwqGDlU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">一、获取Class对象</h2>
<h3 data-id="heading-1">方式一：类名.class</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 方式一：类名.class</span>
	Class&lt;Student&gt; studentClass = Student.class;
	System.out.println(studentClass);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8abc8a6daf70479bbdef39bf6329b52a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=66g0xSR6rtxmIfMwUFwtWzIly%2BI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-2">方式二：static Class forName(String fullNameWithPackage)</h3>
<p>需要注意的是，forName()的参数是类的全类名；最前面的Class后面的泛型可去掉</p>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 方式二：Class forName(String fullNameWithPackage)</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	System.out.println(studentClass);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/241deda8508c4e37998ce96eb4181212~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=IjgBFLmoZUS6w2eqC%2BdZ%2FX7G6zY%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1209e35cb74475e86311239e1eecd29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=vUKtcah7ehC0dWfKIRRoL3qk8sY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">方式三：new Object().getClass()</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 方式三：new Object().getClass()</span>
	Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Student</span>&gt; studentClass = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>().getClass();
	System.out.println(studentClass);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a21f2ff20b14e999563eef6c0baa81e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=hNukVB5IP%2FEaPEeAhXNoipzwzZQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-4">小结</h3>
<p>这三种方式获取方式，<strong>推荐使用第二种</strong></p>
<p>另外值得一提的是，<strong>这三种获取方式获取到的Class对象，都是同一个</strong>，比较三者的地址值，都是true</p>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 方式一：类名.class</span>
	Class&lt;Student&gt; studentClass1 = Student.class;
	
	<span class="hljs-comment">// 方式二：Class forName(String fullNameWithPackage)</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass2</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// 方式三：new Object().getClass()</span>
	Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Student</span>&gt; studentClass3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>().getClass();
	
	System.out.println(studentClass1 == studentClass2);
	System.out.println(studentClass1 == studentClass3);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb6f1b4681354d8ba358a6e8dda62e2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=jcx0WuSgD44ZPq9OdF3ng9OcCRs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-5">二、通过Class对象获取Constructor构造器对象</h2>
<p>这里使用到的Student对象类代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
    <span class="hljs-keyword">private</span> String sex;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> {
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(String name, String sex)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.sex = sex;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age, String sex)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
        <span class="hljs-built_in">this</span>.sex = sex;
    }


    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Student{"</span> +
                <span class="hljs-string">"name='"</span> + name + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", age="</span> + age +
                <span class="hljs-string">", sex='"</span> + sex + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">'}'</span>;
    }
}
</code></pre>
<h3 data-id="heading-6">2.1、getConstructors()：获取所有公共构造器对象</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 获取学生类的Class对象（用第二种获取Class对象的方式）</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// getConstructors()：获取所有公共构造器对象</span>
	Constructor[] constructors1 = studentClass.getConstructors();
	System.out.println(<span class="hljs-string">"--------------公共构造器对象如下--------------"</span>);
	<span class="hljs-keyword">for</span> (Constructor constructor : constructors1) {
	    System.out.println(constructor);
	}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1612bbb540b4dbcbcbf67b9a9ce0c4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=idC%2FC%2BMApncYkGflc4LfU35KB4g%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-7">2.2、getDeclaredConstructors()：获取所有构造器对象（公共+非公共的）</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 获取学生类的Class对象（用第二种获取Class对象的方式）</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// getDeclaredConstructors()：获取所有构造器对象</span>
	Constructor[] constructors = studentClass.getDeclaredConstructors();
	System.out.println(<span class="hljs-string">"--------------所有构造器对象（公共+非公共）如下--------------"</span>);
	<span class="hljs-keyword">for</span> (Constructor constructor : constructors) {
	    System.out.println(constructor);
	}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3766ff89541c4fc2894240b081d4bd89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=AvlDHGsIGoJlaBLDKCMEa746OV8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-8">2.3、getConstructor(Class&lt;?&gt;... parameterTypes)：获取一个指定的公共构造器对象</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 获取学生类的Class对象（用第二种获取Class对象的方式）</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// getConstructor(Class&lt;?&gt;... parameterTypes)：获取一个指定的带两个参数的公共构造器对象</span>
	<span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> studentClass.getConstructor(String.class, String.class);
	System.out.println(<span class="hljs-string">"--------------指定获取Student类带两个参数的公共构造器对象--------------"</span>);
	System.out.println(constructor);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f2553626762475aabb6d0e7fb2dc92b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=s8zNwN%2FM4IUKqDFjxy1lgm1q8%2BI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-9">2.4、getDeclaredConstructor(String.class, int.class, String.class)：获取一个指定的私有构造器对象</h3>
<p>需要注意的是，这种方式当然也可以获取指定的私有构造器对象</p>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 获取学生类的Class对象（用第二种获取Class对象的方式）</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// getDeclaredConstructor(Class&lt;?&gt;... parameterTypes)：获取一个指定的带三个参数的私有构造器对象</span>
	<span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> studentClass.getDeclaredConstructor(String.class, <span class="hljs-type">int</span>.class, String.class);
	System.out.println(<span class="hljs-string">"--------------指定获取Student类私有的带三个参数的构造器对象--------------"</span>);
	System.out.println(constructor);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/431251ceacca414f8bfbe854f0ce65a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=5mXKJt%2BiP1ruVSHYB6XKc52fv8A%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-10">三、通过用获取到的Constructor构造器，实例化对象</h2>
<h3 data-id="heading-11">3.1、获取公共无参构造，并通过其创建所属类（Student）的对象</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 1.获取当前类（Student）的Class对象</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// 2.通过当前类（Student）的Class对象获取当前类（Student）的构造方法对象</span>
	<span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> studentClass.getConstructor();
	
	<span class="hljs-comment">// 3.使用当前类（Student）的constructor对象的newInstance方法创建当前类（Student）</span>
	<span class="hljs-comment">// 这里就相当于不用反射技术的：new Student();</span>
	<span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance();
	
	<span class="hljs-comment">// 打印对象，调用对象的toString()方法</span>
	System.out.println(o);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95f1bef85a0649b68f7b7d7d2676d605~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=%2FZ8M0H7fFkCFzkeqqtkMLwkvr34%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-12">3.2、反射获取公共一个参数构造，并通过其创建所属类(Student)的对象</h3>
<pre><code class="hljs language-java" lang="java">        <span class="hljs-comment">// 1.获取当前类（Student）的Class对象</span>
        <span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);

        <span class="hljs-comment">// 2.通过当前类（Student）的Class对象获取当前类（Student）的构造方法对象</span>
        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> studentClass.getConstructor(String.class, String.class);

        <span class="hljs-comment">// 3.使用当前类（Student）的constructor对象的newInstance方法创建当前类（Student）</span>
        <span class="hljs-comment">// 这里就相当于不用反射技术的：new Student("张三", "男");</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(<span class="hljs-string">"张三"</span>, <span class="hljs-string">"男"</span>);

        <span class="hljs-comment">// 打印对象，调用对象的toString()方法</span>
        System.out.println(o);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9dc775da72a4213832b9a8f8bb2abc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=6l4%2B8S46IsPOLpuDcoEIucvXZn8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-13">3.3、反射获取私有全参构造，并通过其创建所属类（Student）的对象</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 1.获取当前类（Student）的Class对象</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// 2.通过当前类（Student）的Class对象获取当前类（Student）的构造方法对象</span>
	<span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> studentClass.getDeclaredConstructor(String.class, <span class="hljs-type">int</span>.class, String.class);
	
	<span class="hljs-comment">// 对于私有的成员，想要操作，需要先暴力反射。否则会报非法访问异常：IllegalAccessException</span>
	constructor.setAccessible(<span class="hljs-literal">true</span>);
	
	<span class="hljs-comment">// 3.使用当前类（Student）的constructor对象的newInstance方法创建当前类（Student）</span>
	<span class="hljs-comment">// 这里就相当于不用反射技术的：new Student("张三", "男");</span>
	<span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(<span class="hljs-string">"张三"</span>, <span class="hljs-number">29</span>, <span class="hljs-string">"男"</span>);
	
	<span class="hljs-comment">// 打印对象，调用对象的toString()方法</span>
	System.out.println(o);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa89bbdab729432292b9c1d6d757b7a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=097beSQicsBfD70vvke49ZMtPHg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-14">3.4、对于3.1 获取公共无参构造，并通过其创建所属类（Student）的对象的情况，可以直接使用Class提供的方法</h3>
<p>但idea在方法上有横线提示，这种方法已过时，不推荐使用</p>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 获取学生类的Class对象（用第二种获取Class对象的方式）</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// Class对象提供了便捷创建所属类对象的方法：newInstance()</span>
	<span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> studentClass.newInstance();
	
	<span class="hljs-comment">// 打印对象，调用对象的toString()方法</span>
	System.out.println(o);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84ebc5697e634f3db8e1b38840d0757f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=kzkSfkHIokK%2B42jg5jtlMaQZFF0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-15">小结</h3>
<p>对于私有的成员，想要操作，需要先暴力反射。否则会报非法访问异常：IllegalAccessException</p>
<h2 data-id="heading-16">四、通过Class对象获取Field成员变量对象</h2>
<h3 data-id="heading-17">4.1、getDeclaredFields()：获取所有成员变量对象（公共+非公共）</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 获取当前类（Student）的Class对象</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// getDeclaredFields()：获取所有成员变量对象（公共+非公共）</span>
	Field[] fields = studentClass.getDeclaredFields();
	
	System.out.println(<span class="hljs-string">"--------------Student对象的所有成员变量对象如下--------------"</span>);
	
	<span class="hljs-comment">// 遍历打印</span>
	<span class="hljs-keyword">for</span> (Field field : fields) {
	    System.out.println(field);
	}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe714c61c04b4ee88dfac5e2ac9510df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=q3GvXNOigyIkMKuucDKL5XFf4NE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-18">4.2、getField(String name)：获取指定的公共成员变量对象</h3>
<p>博主这里先把Student类中的name属性的权限修饰符设置为public</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">// 将name的修饰符设置为public</span>
    <span class="hljs-keyword">public</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
    <span class="hljs-keyword">private</span> String sex;
</code></pre>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 获取当前类（Student）的Class对象</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// getField(String name)：获取指定的公共成员变量对象</span>
	<span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> studentClass.getField(<span class="hljs-string">"name"</span>);
	
	System.out.println(<span class="hljs-string">"--------------Student对象成员变量name对象如下--------------"</span>);
	
	System.out.println(name);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e97d5c5c37574951883497ced142c21d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=uPgIY%2Be%2Bvo%2FRydetVgjzcJemdjA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-19">4.3、getDeclaredField(String name)：获取指定的任意一个(公共或私有等)成员变量对象</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 获取当前类（Student）的Class对象</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// getDeclaredField(String name)：获取指定的任意一个(公共或私有等)成员变量对象</span>
	<span class="hljs-type">Field</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> studentClass.getDeclaredField(<span class="hljs-string">"age"</span>);
	
	System.out.println(<span class="hljs-string">"--------------Student对象成员变量age对象如下--------------"</span>);
	
	System.out.println(age);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3332b07821fa4e799ee5559b56860ca0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=wCtDx1Y6lcErWjGiRdSi7TMoR%2Bc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-20">五、使用获取到的Field对象为成员变量赋值或者取值</h2>
<h3 data-id="heading-21">5.1、获取公共的成员变量name并使用</h3>
<p>需要注意，在4.2那里，我将Student类name属性权限修饰符改为了public</p>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 1.获取当前类（Student）的Class对象</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// 2.通过当前类（Student）的Class对象获取当前类（Student）的属性Field对象</span>
	<span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> studentClass.getField(<span class="hljs-string">"name"</span>);
	
	<span class="hljs-comment">// 3.1 准备一个学生对象</span>
	<span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> studentClass.newInstance();
	
	<span class="hljs-comment">// 3.2 为成员变量赋值</span>
	<span class="hljs-comment">// void set(Object 所属类的对象, Object 要赋的值)</span>
	name.set(o, <span class="hljs-string">"张三"</span>);
	
	<span class="hljs-comment">// 3.3 获取对象的值</span>
	<span class="hljs-comment">// get(Object object)</span>
	System.out.println(name.get(o));
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80ba8cb1e9d54d84a8aa3f445409a6b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=MR6zjeBeD%2F%2B0J9MzzUMfb9uVprE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-22">5.2、获取私有的成员变量age并使用</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 1.获取当前类（Student）的Class对象</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// 2.通过当前类（Student）的Class对象获取当前类（Student）的属性Field对象</span>
	<span class="hljs-type">Field</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> studentClass.getDeclaredField(<span class="hljs-string">"age"</span>);
	
	<span class="hljs-comment">// 3.1 准备一个学生对象</span>
	<span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> studentClass.newInstance();
	
	<span class="hljs-comment">// 暴力反写（因为age属性权限修饰符为private，故少了此行代码，程序会报非法访问异常：IllegalAccessException）</span>
	age.setAccessible(<span class="hljs-literal">true</span>);
	
	<span class="hljs-comment">// 3.2 为成员变量赋值</span>
	<span class="hljs-comment">// void set(Object 所属类的对象, Object 要赋的值)</span>
	age.set(o, <span class="hljs-number">30</span>);
	
	<span class="hljs-comment">// 3.3 获取对象的值</span>
	<span class="hljs-comment">// get(Object object)</span>
	System.out.println(age.get(o));
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6ba083c47b3467e8ffba67cf9043dbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=oxQk1t2T465vRKBiAMyy1Yu1bLM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-23">小结</h3>
<p>公共和私有变量获取使用的区别有以下两点：</p>
<p><strong>获取方法不同：公共变量获取方法是getField()；私有变量获取方法是getDeclaredField()</strong></p>
<p><strong>访问方式不同：公共变量访问不需要暴力破解；私有变量需要加一行代码（变量名.setAccessible(true); ）</strong></p>
<h2 data-id="heading-24">六、通过Class对象获取Method成员方法对象</h2>
<p>我在Student类中添加了四个方法，两个私有，两个公开</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {
    <span class="hljs-comment">// 将name的修饰符设置为public</span>
    <span class="hljs-keyword">public</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
    <span class="hljs-keyword">private</span> String sex;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> {
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(String name, String sex)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.sex = sex;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age, String sex)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
        <span class="hljs-built_in">this</span>.sex = sex;
    }

    <span class="hljs-comment">// 添加以下四个方法</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>{
        System.out.println(<span class="hljs-string">"add......."</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span>{
        System.out.println(<span class="hljs-string">"delete......."</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span>{
        System.out.println(<span class="hljs-string">"update......."</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">find</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span>{
        System.out.println(<span class="hljs-string">"find......."</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Student{"</span> +
                <span class="hljs-string">"name='"</span> + name + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", age="</span> + age +
                <span class="hljs-string">", sex='"</span> + sex + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">'}'</span>;
    }
}
</code></pre>
<h3 data-id="heading-25">6.1、getMethods() 获取所有公共的成员方法</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 1.获取当前类（Student）的Class对象</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// 2.通过当前类（Student）的Class对象获取当前类（Student）的某个方法对象</span>
	Method[] methods = studentClass.getMethods();
	
	System.out.println(<span class="hljs-string">"--------------Student对象的所有公共的成员方法对象如下--------------"</span>);
	<span class="hljs-keyword">for</span> (Method method : methods) {
	    System.out.println(method);
	}
</code></pre>
<p><strong>需要注意的是，这里包括了继承自Object类的一些公共方法</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1aa4e04cde249b2b9ede7e412297c14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=UewiA9OtmLdsoEKeKjwMXwHhP1U%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-26">6.2、getDeclaredMethods() 获取所有的成员方法</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 1.获取当前类（Student）的Class对象</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// 2.通过当前类（Student）的Class对象获取当前类（Student）的某个方法对象</span>
	Method[] methods = studentClass.getDeclaredMethods();
	
	System.out.println(<span class="hljs-string">"--------------Student对象的所有成员方法对象如下--------------"</span>);
	<span class="hljs-keyword">for</span> (Method method : methods) {
	    System.out.println(method);
	}
</code></pre>
<p><strong>需要注意的是，这里不包含继承自Object类的方法，是Student类中的所有成员方法（含私有的）</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d0e9900fac641e9805e2ab2616772cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=F5ZItnCeVNPu3zSob6KIPLaLRnc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-27">6.3、getMethod(String methodName, Class... args) 获取指定的某个公共的成员方法</h3>
<p>值得一提，没有参数的方法可以获取，getMethod()方法的参数二空着就行</p>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 1.获取当前类（Student）的Class对象</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// 2.通过当前类（Student）的Class对象获取当前类（Student）的某个方法对象</span>
	<span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> studentClass.getMethod(<span class="hljs-string">"find"</span>, <span class="hljs-type">int</span>.class);
	
	System.out.println(<span class="hljs-string">"--------------Student对象的指定名称和参数的公共的方法对象如下--------------"</span>);
	System.out.println(method);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5102f80cfde467c9a0026664f1c9ea3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=Jf4oD%2Bfzzejr4A%2F94eOPeTE8PAs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-28">6.4、getDeclaredMethod(String methodName, Class... args)：获取指定的某个私有的成员方法</h3>
<p>当然，这种方式也可获取到非私有方法对象</p>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 1.获取当前类（Student）的Class对象</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// 2.通过当前类（Student）的Class对象获取当前类（Student）的某个方法对象</span>
	<span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> studentClass.getDeclaredMethod(<span class="hljs-string">"delete"</span>, <span class="hljs-type">int</span>.class);
	
	System.out.println(<span class="hljs-string">"--------------Student对象的指定名称和参数的私有的方法对象如下--------------"</span>);
	System.out.println(method);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e474b2b67cd145a28b07fec90e802bd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=RBZI5YyEK1TqTdKCmZ8aYR6rkgs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-29">小结</h3>
<p>getMethods()：获取所有公共的成员方法，<strong>包含了继承自Object类的方法</strong></p>
<p>getDeclaredMethods()：获取所有的成员方法，<strong>不包含继承自Objcet类的方法，是类的成员方法（私有+公共的）</strong></p>
<p>getMethod(String methodName, Class... args)：获取指定的某个公共的成员方法，<strong>只能是公共的</strong></p>
<p>getDeclaredMethod(String methodName, Class... args)：获取指定的某个私有的成员方法，<strong>私有&amp;公共都可以</strong></p>
<h2 data-id="heading-30">七、使用获取到的Method对象反射调用成员方法</h2>
<p>使用invoke()方法调用成员方法，需要注意两点：
（1）<strong>私有成员，使用前需要暴力破解</strong>，否则会报非法访问异常：IllegalAccessException；
（2）<strong>反射调用成员方法前，需要先准备一个当前类的对象</strong></p>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 1.获取当前类（Student）的Class对象</span>
	<span class="hljs-type">Class</span> <span class="hljs-variable">studentClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.essay.Student"</span>);
	
	<span class="hljs-comment">// 2.通过当前类（Student）的Class对象获取当前类（Student）的某个方法对象</span>
	<span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> studentClass.getDeclaredMethod(<span class="hljs-string">"delete"</span>, <span class="hljs-type">int</span>.class);
	
	<span class="hljs-comment">// 3.通过当前类（Student）的方法Method对象的invoke方法调用方法</span>
	
	<span class="hljs-comment">// 私有成员，使用前需要暴力反射，否则报错非法访问异常：IllegalAccessException</span>
	method.setAccessible(<span class="hljs-literal">true</span>);
	
	<span class="hljs-comment">// 3.1 准备一个当前类（Student）的对象</span>
	<span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> studentClass.newInstance();
	
	<span class="hljs-comment">// 3.2 反射调用成员方法</span>
	method.invoke(o, <span class="hljs-number">10</span>);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa14c0bc50cf4feb82c1c4392b76c0c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=o3dPqSV78QtSUCPHG8WOW5nwfLU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-31">总结</h2>
<p>程序执行过程中会有许多运行时异常，需要抛出，建议在方法上直接抛出 Exception
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d78f18aeacf34191becda96a843f8998~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2V5Lit5bqU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819727&amp;x-signature=G%2FBbmITBaUKe6D30A3oceVXvMxg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-32">首次发布</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhezhongying.blog.csdn.net%2Farticle%2Fdetails%2F130801657" target="_blank" title="https://hezhongying.blog.csdn.net/article/details/130801657" ref="nofollow noopener noreferrer">hezhongying.blog.csdn.net/article/det…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[finally 中代码一定会被执行吗？]]></title>    <link>https://juejin.cn/post/7602901565025206281</link>    <guid>https://juejin.cn/post/7602901565025206281</guid>    <pubDate>2026-02-04T15:00:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602901565025206281" data-draft-id="7602850166731128841" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="finally 中代码一定会被执行吗？"/> <meta itemprop="keywords" content="后端,面试"/> <meta itemprop="datePublished" content="2026-02-04T15:00:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Vin_evail"/> <meta itemprop="url" content="https://juejin.cn/user/3974048659038618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            finally 中代码一定会被执行吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3974048659038618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Vin_evail
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T15:00:32.000Z" title="Wed Feb 04 2026 15:00:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">finally 中代码一定会被执行吗？</h2>
<p>2026年02月04日</p>
<p>面试官提出这个问题，通常意在考察以下几个层面的理解：</p>
<ol>
<li><strong>对 Java 异常处理机制基础知识的掌握</strong>：即 <code>finally</code> 块的基本语义和保证执行的承诺。</li>
<li><strong>对 JVM 执行流程和程序状态理解的深度</strong>：面试官不仅仅想知道 “是” 或 “否”，更想知道<strong>在何种极端或特定情况下，<code>finally</code> 块会 “失约”</strong> ，这能反映出候选人是否真正理解程序执行的底层逻辑。</li>
<li><strong>对系统级交互和资源管理的认知</strong>：例如，理解 <code>System.exit()</code> 或守护线程等行为如何影响程序的生命周期，这与编写健壮的、尤其是涉及资源清理的代码紧密相关。</li>
<li><strong>实际编程中的严谨性</strong>：是否了解在 <code>finally</code> 块中写代码的“最佳实践”和“常见陷阱”，避免因认知盲区引入生产 bug。</li>
</ol>
<h3 data-id="heading-1">核心答案</h3>
<p>不，<code>finally</code> 中的代码<strong>不一定会被执行</strong>。虽然它在绝大多数正常情况下都会执行，但在以下几种特殊情况下，<code>finally</code> 块将不会被执行：</p>
<ol>
<li><strong>在 <code>try</code> 或 <code>catch</code> 块中调用了 <code>System.exit(int)</code> 终止了 JVM。</strong></li>
<li>程序所在的<strong>线程在进入 <code>finally</code> 之前被意外终止</strong>（例如，调用了 <code>Thread.stop()</code> 方法，但此方法已被废弃且极其危险）。</li>
<li><strong>守护线程（Daemon Thread）</strong>  中，当所有非守护线程结束时，JVM 会立即退出，此时守护线程中的 <code>finally</code> 块可能来不及执行。</li>
<li>在 <code>try</code> 或 <code>catch</code> 块中遇到了<strong>无限循环</strong>或<strong>死锁</strong>，导致程序无法继续执行到 <code>finally</code> 块。</li>
<li>从操作系统层面<strong>强制杀死了 JVM 进程</strong>（例如，在 Linux 中使用 <code>kill -9 pid</code>）。</li>
</ol>
<h3 data-id="heading-2">深度解析</h3>
<h4 data-id="heading-3">原理/机制</h4>
<p><code>finally</code> 的 “一定执行” 语义是 Java 编译器在<strong>字节码层面</strong>提供的一种保证。编译器会通过生成额外的字节码，将 <code>finally</code> 块中的逻辑复制到 <code>try</code> 块和每个 <code>catch</code> 块的 “正常出口” 和 “异常出口” 之后。你可以将其想象为，JVM 试图在离开 <code>try-catch</code> 作用域前，无论如何都要 “绕路” 去执行一下 <code>finally</code> 中的代码。</p>
<p>然而，这种保证是<strong>在 JVM 正常执行流程内</strong>的。上述提到的例外情况，本质上都是<strong>强行终止了 JVM 的正常执行流程</strong>，使得程序失去了继续执行任何字节码（包括复制的 <code>finally</code> 代码）的机会。</p>
<h4 data-id="heading-4">代码示例</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FinallyNotExecuteDemo</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        case1_SystemExit();
        <span class="hljs-comment">// case2_InfiniteLoop();</span>
    }

    <span class="hljs-comment">// 情况 1：System.exit() 导致 finally 不执行</span>
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">case1_SystemExit</span>()</span> {
        <span class="hljs-keyword">try</span> {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Try block is running."</span>);
            System.exit(<span class="hljs-number">0</span>); <span class="hljs-comment">// JVM 在此处被强制终止</span>
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 这行将永远不会被打印</span>
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Finally block is running."</span>);
        }
    }

    <span class="hljs-comment">// 情况 2：无限循环导致 finally 无法到达</span>
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">case2_InfiniteLoop</span>()</span> {
        <span class="hljs-keyword">try</span> {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Try block is running."</span>);
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) { <span class="hljs-comment">// 无限循环，程序无法退出 try 块</span>
                <span class="hljs-comment">// 模拟长时间操作</span>
            }
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 由于无法退出 try 块，这行同样永远不会被执行</span>
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Finally block is running."</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-5">最佳实践与注意事项</h4>
<ol>
<li>
<p><strong>资源清理首选 <code>try-with-resources</code></strong>：对于实现了 <code>AutoCloseable</code> 接口的资源（如 <code>InputStream</code>、<code>Connection</code>），JDK 7 引入的 <code>try-with-resources</code> 语句是比 <code>try-finally</code> 更优雅、更安全的方案。它能自动关闭资源，并且抑制的异常信息更完整。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优于 try-finally</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"file.txt"</span>)) {
    <span class="hljs-comment">// 使用资源</span>
} <span class="hljs-keyword">catch</span> (IOException e) {
    <span class="hljs-comment">// 处理异常</span>
}
</code></pre>
</li>
<li>
<p><strong>避免在 <code>finally</code> 中引入复杂逻辑或可能抛出异常的操作</strong>：<code>finally</code> 块中的代码应该力求简单、可靠。如果 <code>finally</code> 块中抛出了新的异常，它会 “覆盖” 掉 <code>try</code> 或 <code>catch</code> 块中抛出的异常，导致原始的异常信息丢失，给调试带来巨大困难。</p>
</li>
<li>
<p><strong>守护线程中的资源管理需特别小心</strong>：避免在守护线程中进行重要的、必须完成的资源清理或状态持久化操作，因为其执行无法得到保证。</p>
</li>
</ol>
<h4 data-id="heading-6">常见误区</h4>
<ul>
<li>
<p><strong>误区一：“<code>finally</code> 在 <code>return</code> 之后执行”</strong> ：这是一种非常普遍但错误的表述。<strong><code>finally</code> 块的执行在 <code>return</code> 语句之前</strong>。具体来说，如果 <code>try</code> 或 <code>catch</code> 中有 <code>return</code>，JVM 会先将返回值存储在一个临时变量中，然后执行 <code>finally</code> 块，最后再返回那个临时变量。即使 <code>finally</code> 中修改了要返回的变量，对于基本数据类型和不可变对象（如 <code>String</code>），返回值也不会改变（但对于对象引用，修改对象内部状态是有效的）。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> <span class="hljs-title">testFinallyReturn</span>()</span> {
    <span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 1. 将 i 的值 (0) 存入临时槽</span>
    } <span class="hljs-keyword">finally</span> {
        i = <span class="hljs-number">10</span>; <span class="hljs-comment">// 2. 修改 i，但不影响临时槽中的值</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Finally executed. i = "</span> + i);
        <span class="hljs-comment">// 3. 从临时槽中取出值 (0) 返回</span>
    }
}
<span class="hljs-comment">// 输出：Finally executed. i = 10</span>
<span class="hljs-comment">// 返回：0</span>
</code></pre>
</li>
<li>
<p><strong>误区二：“<code>finally</code> 总能进行资源回收”</strong> ：如上所述，在 <code>System.exit()</code> 或 JVM 崩溃等情况下，<code>finally</code> 中的 <code>close()</code> 方法也无力回天。这强调了关键资源需要有外部管理或更健壮的生命周期管理机制。</p>
</li>
</ul>
<h3 data-id="heading-7">总结</h3>
<p><code>finally</code> 块为代码提供了强大的 “最后清理” 保障，但其执行的前提是 <strong>JVM 能继续维持正常的执行流程</strong>；任何导致 JVM 进程被立即 “杀死” 或执行流被永久 “卡住” 的操作，都会使这份保障失效。在现代 Java 开发中，应优先使用 <code>try-with-resources</code> 管理资源，并在 <code>finally</code> 中保持逻辑简单、健壮。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot实战：用AOP+自定义注解打造零侵入日志系统（附生产避坑指南）]]></title>    <link>https://juejin.cn/post/7602824293164695567</link>    <guid>https://juejin.cn/post/7602824293164695567</guid>    <pubDate>2026-02-04T14:33:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602824293164695567" data-draft-id="7602581823639486464" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot实战：用AOP+自定义注解打造零侵入日志系统（附生产避坑指南）"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-02-04T14:33:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不想打工的码农"/> <meta itemprop="url" content="https://juejin.cn/user/2172290705931335"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot实战：用AOP+自定义注解打造零侵入日志系统（附生产避坑指南）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2172290705931335/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不想打工的码农
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T14:33:11.000Z" title="Wed Feb 04 2026 14:33:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：不想打工的码农<br/>
原创声明：本文基于笔者在金融项目中的真实实践，所有代码经生产环境验证，拒绝纸上谈兵</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、痛点直击：你是否也这样写日志？</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/user"</span>)
public Result <span class="hljs-built_in">createUser</span>(<span class="hljs-variable">@RequestBody</span> User user) {
    <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"【创建用户】参数: {}"</span>, JSON.<span class="hljs-built_in">toJSONString</span>(user)); <span class="hljs-comment">// 1</span>
    <span class="hljs-selector-tag">try</span> {
        <span class="hljs-selector-tag">userService</span><span class="hljs-selector-class">.save</span>(user);
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"【创建用户】成功, 用户ID: {}"</span>, user.<span class="hljs-built_in">getId</span>()); <span class="hljs-comment">// 2</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.ok</span>();
    } <span class="hljs-selector-tag">catch</span> (Exception e) {
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"【创建用户】失败, 原因: {}"</span>, e.<span class="hljs-built_in">getMessage</span>(), e); <span class="hljs-comment">// 3</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-string">"操作失败"</span>);
    }
}
</code></pre>
<p><strong>灵魂三问</strong>：<br/>
❌ 业务代码被日志“腌入味”？<br/>
❌ 修改日志格式要改上百个方法？<br/>
❌ 敏感字段（密码/手机号）裸奔记录？</p>
<p>别急！今天手把手带你用 <strong>AOP+自定义注解</strong> 破局，亲测在日均千万级请求系统中稳定运行2年+。</p>
<hr/>
<h2 data-id="heading-1">二、核心设计思路（拒绝理论堆砌）</h2>






























<table><thead><tr><th>方案</th><th>传统写法</th><th>本文方案</th></tr></thead><tbody><tr><td><strong>侵入性</strong></td><td>每个方法硬编码</td><td>仅需@OptLog("创建用户")</td></tr><tr><td><strong>维护成本</strong></td><td>改一处需全局搜</td><td>改切面类一处生效</td></tr><tr><td><strong>敏感信息</strong></td><td>手动脱敏易遗漏</td><td>切面统一拦截处理</td></tr><tr><td><strong>性能影响</strong></td><td>同步阻塞</td><td>异步+线程池优化</td></tr></tbody></table>
<p><strong>为什么选自定义注解而非直接切Controller？</strong></p>
<blockquote>
<p>笔者踩坑实录：曾直接切execution(* com.xxx.controller..<em>.</em>(..))，结果Swagger接口、健康检查全被记录，日志量暴涨300%！精准控制才是生产环境王道。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">三、实战四步走（附关键细节）</h2>
<h2 data-id="heading-3">1️⃣ 定义灵魂注解（带操作类型枚举）</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Target</span>(ElementType.METHOD)
<span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)
<span class="hljs-variable">@Documented</span>
public <span class="hljs-variable">@interface</span> OptLog {
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">value</span>() <span class="hljs-selector-tag">default</span> ""; <span class="hljs-comment">// 操作描述</span>
    <span class="hljs-selector-tag">OptType</span> <span class="hljs-selector-tag">type</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">OptType</span><span class="hljs-selector-class">.OTHER</span>; <span class="hljs-comment">// 操作类型</span>
    
    <span class="hljs-selector-tag">enum</span> <span class="hljs-selector-tag">OptType</span> {
        <span class="hljs-selector-tag">QUERY</span>(<span class="hljs-string">"查询"</span>), <span class="hljs-selector-tag">SAVE</span>(<span class="hljs-string">"新增"</span>), <span class="hljs-selector-tag">UPDATE</span>(<span class="hljs-string">"修改"</span>), <span class="hljs-selector-tag">DELETE</span>(<span class="hljs-string">"删除"</span>), <span class="hljs-selector-tag">EXPORT</span>(<span class="hljs-string">"导出"</span>), <span class="hljs-selector-tag">OTHER</span>(<span class="hljs-string">"其他"</span>);
        <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">desc</span>;
        <span class="hljs-selector-tag">OptType</span>(String desc) { <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.desc</span> = <span class="hljs-selector-tag">desc</span>; }
        <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">getDesc</span>() { <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">desc</span>; }
    }
}
</code></pre>
<p>✨ <strong>设计巧思</strong>：枚举类型让日志可被ELK按操作类型聚合分析，运维排查效率提升50%</p>
<h2 data-id="heading-4">2️⃣ 编写切面核心（重点处理异常与耗时）</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Aspect</span>
<span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
public class LogAspect {
    
    <span class="hljs-comment">// 异步线程池（避免阻塞业务）</span>
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">ExecutorService</span> <span class="hljs-selector-tag">logExecutor</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">ThreadPoolExecutor</span>(
        <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">60</span>L, TimeUnit.SECONDS,
        new LinkedBlockingQueue&lt;&gt;(<span class="hljs-number">1000</span>),
        r -&gt; new <span class="hljs-built_in">Thread</span>(r, <span class="hljs-string">"async-log-thread"</span>),
        new ThreadPoolExecutor.<span class="hljs-built_in">CallerRunsPolicy</span>()
    );

    @<span class="hljs-selector-tag">Around</span>(<span class="hljs-string">"@annotation(optLog)"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">around</span>(ProceedingJoinPoint pjp, OptLog optLog) <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">Throwable</span> {
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">start</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>();
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">methodName</span> = <span class="hljs-selector-tag">pjp</span><span class="hljs-selector-class">.getSignature</span>()<span class="hljs-selector-class">.toShortString</span>();
        <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">null</span>;
        <span class="hljs-selector-tag">Exception</span> <span class="hljs-selector-tag">exception</span> = <span class="hljs-selector-tag">null</span>;
        
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">pjp</span><span class="hljs-selector-class">.proceed</span>(); <span class="hljs-comment">// 执行目标方法</span>
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">result</span>;
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">exception</span> = <span class="hljs-selector-tag">e</span>;
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">e</span>; <span class="hljs-comment">// 保证异常正常抛出</span>
        } <span class="hljs-selector-tag">finally</span> {
            <span class="hljs-comment">// 异步记录日志（关键！）</span>
            <span class="hljs-selector-tag">logExecutor</span><span class="hljs-selector-class">.execute</span>(() -&gt; <span class="hljs-built_in">buildAndSaveLog</span>(pjp, optLog, result, exception, 
                System.<span class="hljs-built_in">currentTimeMillis</span>() - start, methodName));
        }
    }

    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">buildAndSaveLog</span>(...) {
        <span class="hljs-comment">// 1. 参数脱敏（重点！）</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">argsStr</span> = <span class="hljs-selector-tag">JSON</span><span class="hljs-selector-class">.toJSONString</span>(pjp.<span class="hljs-built_in">getArgs</span>(), 
            SerializerFeature.WriteMapNullValue,
            <span class="hljs-comment">// 自定义过滤器：密码/手机号脱敏</span>
            (o, fieldName, fieldType, features) -&gt; {
                <span class="hljs-selector-tag">if</span> (<span class="hljs-string">"password"</span>.<span class="hljs-built_in">equals</span>(fieldName) || <span class="hljs-string">"phone"</span>.<span class="hljs-built_in">equals</span>(fieldName)) {
                    <span class="hljs-selector-tag">return</span> "******";
                }
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">SerializerFeature</span><span class="hljs-selector-class">.EMPTY</span>;
            });
        
        <span class="hljs-comment">// 2. 构建日志对象（含操作人、IP、耗时等）</span>
        <span class="hljs-selector-tag">SysLog</span> <span class="hljs-selector-tag">log</span> = <span class="hljs-selector-tag">SysLog</span><span class="hljs-selector-class">.builder</span>()
            <span class="hljs-selector-class">.optModule</span>(<span class="hljs-built_in">getModuleName</span>(pjp)) <span class="hljs-comment">// 从包路径提取模块名</span>
            <span class="hljs-selector-class">.optType</span>(optLog.<span class="hljs-built_in">type</span>().<span class="hljs-built_in">getDesc</span>())
            <span class="hljs-selector-class">.optDesc</span>(optLog.<span class="hljs-built_in">value</span>())
            <span class="hljs-selector-class">.requestParam</span>(argsStr)
            <span class="hljs-selector-class">.responseResult</span>(exception == null ? JSON.<span class="hljs-built_in">toJSONString</span>(result) : <span class="hljs-string">"异常:"</span> + exception.<span class="hljs-built_in">getMessage</span>())
            <span class="hljs-selector-class">.costTime</span>(costTime)
            <span class="hljs-selector-class">.createTime</span>(LocalDateTime.<span class="hljs-built_in">now</span>())
            <span class="hljs-selector-class">.build</span>();
        
        <span class="hljs-comment">// 3. 持久化（根据环境选择：开发控制台/生产存DB）</span>
        <span class="hljs-selector-tag">if</span> (env.<span class="hljs-built_in">equals</span>(<span class="hljs-string">"prod"</span>)) {
            <span class="hljs-selector-tag">sysLogService</span><span class="hljs-selector-class">.saveAsync</span>(log); <span class="hljs-comment">// 异步存库</span>
        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"【操作日志】{}"</span>, JSON.<span class="hljs-built_in">toJSONString</span>(log));
        }
    }
}
</code></pre>
<h2 data-id="heading-5">3️⃣ 业务代码清爽示例</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@OptLog</span>(value = <span class="hljs-string">"重置用户密码"</span>, type = OptLog.OptType.<span class="hljs-attribute">UPDATE</span>)
<span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/resetPwd"</span>)
public Result <span class="hljs-built_in">resetPassword</span>(<span class="hljs-variable">@Valid</span> <span class="hljs-variable">@RequestBody</span> ResetPwdDTO dto) {
    <span class="hljs-comment">// 业务逻辑干净得像刚洗过的代码</span>
    <span class="hljs-selector-tag">userService</span><span class="hljs-selector-class">.resetPassword</span>(dto.<span class="hljs-built_in">getUserId</span>(), dto.<span class="hljs-built_in">getNewPassword</span>());
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.ok</span>(<span class="hljs-string">"密码重置成功"</span>);
}
<span class="hljs-comment">// 控制台输出：【操作日志】{"optModule":"用户管理","optType":"修改","optDesc":"重置用户密码",...,"requestParam":"{"userId":1001,"newPassword":"******"}"}</span>
</code></pre>
<h2 data-id="heading-6">4️⃣ 生产环境加固（血泪经验）</h2>
<ul>
<li><strong>防日志风暴</strong>：在切面开头加if (log.isInfoEnabled())判断</li>
<li><strong>大对象处理</strong>：对MultipartFile等参数跳过序列化</li>
<li><strong>线程安全</strong>：ThreadLocal存储操作人信息（配合拦截器）</li>
<li><strong>监控告警</strong>：日志异常时推送企业微信（示例代码略，可私信索取）</li>
</ul>
<hr/>
<h2 data-id="heading-7">四、效果对比 &amp; 价值升华</h2>
<p>表格</p>






























<table><thead><tr><th>维度</th><th>改造前</th><th>改造后</th></tr></thead><tbody><tr><td>单接口代码量</td><td>15+行日志</td><td>0行侵入</td></tr><tr><td>新增日志需求</td><td>全局搜索修改</td><td>仅调整切面</td></tr><tr><td>敏感信息风险</td><td>高（依赖人工）</td><td>低（统一拦截）</td></tr><tr><td>排查效率</td><td>翻找业务日志</td><td>按操作类型精准筛选</td></tr></tbody></table>
<p><strong>不止于日志</strong>：此模式可复用于<br/>
✅ 接口耗时监控（对接Prometheus）<br/>
✅ 操作审计留痕（满足等保要求）<br/>
✅ 灰度发布流量标记</p>
<hr/>
<h2 data-id="heading-8">五、写在最后</h2>
<p>技术没有银弹，但<strong>解耦思维</strong>是永恒的利器。AOP不是炫技，而是让代码回归业务本质的工程实践。笔者在重构某银行核心系统时，仅用3天将200+接口日志统一治理，后续运维反馈“查问题像开了天眼”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 Java 的 PDF 文本水印实现方案（iText7 示例）]]></title>    <link>https://juejin.cn/post/7602841282802516009</link>    <guid>https://juejin.cn/post/7602841282802516009</guid>    <pubDate>2026-02-04T15:29:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602841282802516009" data-draft-id="7603004323869999147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 Java 的 PDF 文本水印实现方案（iText7 示例）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-04T15:29:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Reboot"/> <meta itemprop="url" content="https://juejin.cn/user/254742430491175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 Java 的 PDF 文本水印实现方案（iText7 示例）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742430491175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Reboot
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T15:29:10.000Z" title="Wed Feb 04 2026 15:29:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文介绍如何使用 Java 在 PDF 文档上添加通用的文字水印，示例基于 iText7，强调实现思路和关键 API，便于在任意项目中复用或扩展。</p>
<hr/>
<h3 data-id="heading-0">1. 方案概览</h3>
<ul>
<li>
<p><strong>目标</strong>：在现有 PDF 文件的每一页上添加居中、斜向、半透明的文字水印，例如「xx公司」。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li>预览/下载前对 PDF 加防泄露水印；</li>
<li>批量归档 PDF 时统一添加版权信息；</li>
<li>按用户或租户动态生成个性化水印（用户名、时间、IP 等）。</li>
</ul>
</li>
<li>
<p><strong>核心技术栈</strong>：</p>
<ul>
<li>Java 8+；</li>
<li>iText7（<code>com.itextpdf:itext7-core</code>）；</li>
<li>如需中文，建议引入中文字体依赖（如 <code>font-asian</code> 或自备 TTF/OTF 字体）。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-1">2. 基本依赖配置示例（Maven）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- iText7 主依赖（PDF 内核） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itextpdf<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>itext7-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.2.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
​
    <span class="hljs-comment">&lt;!-- 可选：中文字体支持（也可以使用自带 TTF 字体文件） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itextpdf<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>font-asian<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.2.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<blockquote>
<p>实际版本号可按项目统一依赖管理调整。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">3. 实现思路</h3>
<ol start="0">
<li>
<p>使用 <code>PdfReader</code> 读取原始 PDF 输入流（或文件）。</p>
</li>
<li>
<p>使用 <code>PdfWriter</code> 将处理结果写入输出流（内存或新文件）。</p>
</li>
<li>
<p>构造 <code>PdfDocument</code> 与高级布局对象 <code>Document</code>。</p>
</li>
<li>
<p>选择合适的字体（特别是包含中文的字体）。</p>
</li>
<li>
<p>遍历 PDF 的每一页，计算页面中心坐标，在对应页上绘制水印 <code>Paragraph</code>：</p>
<ul>
<li>文本内容：例如「xx公司」或某个动态字符串；</li>
<li>字体、字号、颜色、透明度；</li>
<li>旋转角度（如 45°）与对齐方式（居中）。</li>
</ul>
</li>
<li>
<p>关闭文档，输出带水印的 PDF。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-3">4. 示例代码：为每页添加对角线文字水印</h3>
<pre><code class="hljs language-ini" lang="ini">
import com.itextpdf.io.font.PdfEncodings<span class="hljs-comment">;</span>
import com.itextpdf.kernel.colors.DeviceRgb<span class="hljs-comment">;</span>
import com.itextpdf.kernel.font.PdfFont<span class="hljs-comment">;</span>
import com.itextpdf.kernel.font.PdfFontFactory<span class="hljs-comment">;</span>
import com.itextpdf.kernel.geom.Rectangle<span class="hljs-comment">;</span>
import com.itextpdf.kernel.pdf.PdfDocument<span class="hljs-comment">;</span>
import com.itextpdf.kernel.pdf.PdfReader<span class="hljs-comment">;</span>
import com.itextpdf.kernel.pdf.PdfWriter<span class="hljs-comment">;</span>
import com.itextpdf.layout.Document<span class="hljs-comment">;</span>
import com.itextpdf.layout.element.Paragraph<span class="hljs-comment">;</span>
import com.itextpdf.layout.properties.TextAlignment<span class="hljs-comment">;</span>
import com.itextpdf.layout.properties.VerticalAlignment<span class="hljs-comment">;</span>
​
import java.io.ByteArrayOutputStream<span class="hljs-comment">;</span>
import java.io.InputStream<span class="hljs-comment">;</span>
​
public class PdfWatermarkUtil {
​
    /**
     * 为 PDF 每一页添加斜向文字水印
     *
     * @param pdfInput     原始 PDF 输入流
     * @param watermark    水印文本（如 "xx公司"）
     * @return 带水印 PDF 的字节数组
     */
    public static byte<span class="hljs-section">[]</span> addTextWatermark(InputStream pdfInput, String watermark) throws Exception {
        try (ByteArrayOutputStream <span class="hljs-attr">out</span> = new ByteArrayOutputStream()) {
            PdfReader <span class="hljs-attr">reader</span> = new PdfReader(pdfInput)<span class="hljs-comment">;</span>
            PdfWriter <span class="hljs-attr">writer</span> = new PdfWriter(out)<span class="hljs-comment">;</span>
            PdfDocument <span class="hljs-attr">pdfDoc</span> = new PdfDocument(reader, writer)<span class="hljs-comment">;</span>
            Document <span class="hljs-attr">document</span> = new Document(pdfDoc)<span class="hljs-comment">;</span>
​
            PdfFont <span class="hljs-attr">font</span> = createFont()<span class="hljs-comment">;</span>
​
            int <span class="hljs-attr">totalPages</span> = pdfDoc.getNumberOfPages()<span class="hljs-comment">;</span>
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">1</span><span class="hljs-comment">; i &lt;= totalPages; i++) {</span>
                Rectangle <span class="hljs-attr">pageSize</span> = pdfDoc.getPage(i).getPageSize()<span class="hljs-comment">;</span>
                float <span class="hljs-attr">x</span> = (pageSize.getLeft() + pageSize.getRight()) / <span class="hljs-number">2</span><span class="hljs-comment">;</span>
                float <span class="hljs-attr">y</span> = (pageSize.getTop() + pageSize.getBottom()) / <span class="hljs-number">2</span><span class="hljs-comment">;</span>
​
                Paragraph <span class="hljs-attr">p</span> = new Paragraph(watermark)
                        .setFont(font)
                        .setFontSize(60)
                        .setFontColor(new DeviceRgb(192, 192, 192))
                        .setOpacity(0.3f)<span class="hljs-comment">;</span>
​
                document.showTextAligned(
                        p,
                        x, y, i,
                        TextAlignment.CENTER,
                        VerticalAlignment.MIDDLE,
                        (float) Math.toRadians(45)
                )<span class="hljs-comment">;</span>
            }
​
            document.close()<span class="hljs-comment">;</span>
            pdfDoc.close()<span class="hljs-comment">;</span>
            return out.toByteArray()<span class="hljs-comment">;</span>
        }
    }
​
    /**
     * 创建字体（示例：使用系统或自带的中文字体）
     */
    private static PdfFont createFont() throws Exception {
        // 示例：使用内置字体或自带 TTF 文件
        // 1）若有自定义字体：
        // return PdfFontFactory.createFont("/path/to/simsun.ttf", PdfEncodings.IDENTITY_H, true)<span class="hljs-comment">;</span>
        // 2）简化示例：使用内置字体（不保证完整中文支持）
        return PdfFontFactory.createFont("STSong-Light", "UniGB-UCS2-H", true)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-4">5. 关键点与扩展建议</h3>
<ul>
<li>
<p><strong>字体选择</strong>：对中文 PDF，尽量使用包含中文的 TTF/OTF 字体文件，并通过 <code>PdfEncodings.IDENTITY_H</code> 创建嵌入字体，避免乱码。</p>
</li>
<li>
<p><strong>透明度与字号</strong>：可根据实际打印/预览效果调整水印的字号和 <code>setOpacity</code>，在可见与不干扰阅读之间取得平衡。</p>
</li>
<li>
<p><strong>动态水印</strong>：业务代码中通常不会写死「xx公司」，而是将水印文案作为参数传入，例如「xx公司（机密）」或「用户名+时间戳」。</p>
</li>
<li>
<p><strong>性能考虑</strong>：对于非常大的 PDF（页数很多），可以：</p>
<ul>
<li>控制只对部分页面加水印；</li>
<li>或在异步任务/批处理服务中执行水印操作。</li>
</ul>
</li>
<li>
<p><strong>安全性</strong>：水印不能防止专业的 PDF 编辑/篡改，但对一般用户的泄露行为有一定威慑与追责作用，可结合权限控制一同使用。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-5">6. 总结</h3>
<p>使用 iText7 给 PDF 添加文字水印的核心就是：<strong>读取现有 PDF → 遍历页面 → 在每页叠加一层半透明文本</strong>。上面的封装方法只依赖 <code>InputStream</code> 与文案字符串，便于集成到上传、下载或文件转换链路中，实现统一的 PDF 水印策略。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 Java 的 Word 文档（DOC/DOCX）文字水印实现（Spire.Doc 示例）]]></title>    <link>https://juejin.cn/post/7603004323870015531</link>    <guid>https://juejin.cn/post/7603004323870015531</guid>    <pubDate>2026-02-04T15:30:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603004323870015531" data-draft-id="7602841282802532393" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 Java 的 Word 文档（DOC/DOCX）文字水印实现（Spire.Doc 示例）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-04T15:30:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Reboot"/> <meta itemprop="url" content="https://juejin.cn/user/254742430491175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 Java 的 Word 文档（DOC/DOCX）文字水印实现（Spire.Doc 示例）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742430491175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Reboot
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T15:30:15.000Z" title="Wed Feb 04 2026 15:30:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文介绍如何在 Java 中为 Word 文档（<code>.doc</code>、<code>.docx</code>）添加页面文字水印，示例基于 Spire.Doc for Java，侧重通用实现方式，不依赖具体业务代码。</p>
<hr/>
<h3 data-id="heading-0">1. 方案概览</h3>
<ul>
<li>
<p><strong>目标</strong>：在 Word 文档的每一页添加斜向、浅灰色的文字水印（例如「xx公司」），以页面水印的形式呈现，不直接修改正文内容。</p>
</li>
<li>
<p><strong>适用格式</strong>：<code>.doc</code>、<code>.docx</code>（如需 <code>.wps</code> 等其他格式，可按同样思路扩展）。</p>
</li>
<li>
<p><strong>核心技术栈</strong>：</p>
<ul>
<li>Java 8+；</li>
<li>Spire.Doc for Java（本文使用其 Free 版本作为示例）。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-1">2. Maven 依赖与仓库示例</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spire.Doc for Java（Free 版本示例，版本号可按需调整） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>e-iceblue<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spire.doc.free<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>com.e-iceblue<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.e-iceblue.cn/repository/maven-public/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
</code></pre>
<blockquote>
<p>生产环境可根据许可证选择付费或更新版本，并统一管理版本号。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">3. 实现思路</h3>
<ol start="0">
<li>
<p>使用 Spire.Doc 的 <code>Document</code> 类从文件或输入流加载 Word 文档：</p>
<ul>
<li>DOCX：<code>loadFromStream(..., FileFormat.Docx)</code>；</li>
<li>DOC：<code>loadFromStream(..., FileFormat.Doc)</code>；</li>
<li>或使用 <code>loadFromFile(...)</code> 从物理文件加载。</li>
</ul>
</li>
<li>
<p>构造一个 <code>TextWatermark</code> 对象，设置水印文本、字号、颜色和布局。</p>
</li>
<li>
<p>通过文档的 <code>Section</code> 对象获取 <code>Document</code> 并调用 <code>setWatermark(TextWatermark)</code> 应用水印：</p>
<ul>
<li>官方推荐用 <code>document.getSections().get(0).getDocument().setWatermark(...)</code>。</li>
</ul>
</li>
<li>
<p>以相应的 <code>FileFormat</code> 保存文档到新文件或输出流，得到带水印的 DOC/DOCX。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-3">4. 示例一：为 DOCX 文档添加文字水印</h3>
<h4 data-id="heading-4">4.1 从文件加载并输出到新文件</h4>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">import</span> com.<span class="hljs-property">spire</span>.<span class="hljs-property">doc</span>.<span class="hljs-property">Document</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">spire</span>.<span class="hljs-property">doc</span>.<span class="hljs-property">FileFormat</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">spire</span>.<span class="hljs-property">doc</span>.<span class="hljs-property">TextWatermark</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">spire</span>.<span class="hljs-property">doc</span>.<span class="hljs-property">documents</span>.<span class="hljs-property">WatermarkLayout</span>;
​
<span class="hljs-keyword">import</span> java.<span class="hljs-property">awt</span>.<span class="hljs-property">Color</span>;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DocxWatermarkExample</span> {
​
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addWatermarkToDocx</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> inputPath, <span class="hljs-built_in">String</span> outputPath, <span class="hljs-built_in">String</span> watermarkText</span>) {
        <span class="hljs-comment">// 1. 加载 DOCX 文档</span>
        <span class="hljs-title class_">Document</span> <span class="hljs-variable language_">document</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>();
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">loadFromFile</span>(inputPath, <span class="hljs-title class_">FileFormat</span>.<span class="hljs-property">Docx</span>);
​
        <span class="hljs-comment">// 2. 创建文字水印</span>
        <span class="hljs-title class_">TextWatermark</span> watermark = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextWatermark</span>();
        watermark.<span class="hljs-title function_">setText</span>(watermarkText);              <span class="hljs-comment">// 如："xx公司"</span>
        watermark.<span class="hljs-title function_">setFontSize</span>(<span class="hljs-number">40</span>);                     <span class="hljs-comment">// 字号</span>
        watermark.<span class="hljs-title function_">setColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">lightGray</span>);           <span class="hljs-comment">// 颜色</span>
        watermark.<span class="hljs-title function_">setLayout</span>(<span class="hljs-title class_">WatermarkLayout</span>.<span class="hljs-property">Diagonal</span>); <span class="hljs-comment">// 斜对角</span>
​
        <span class="hljs-comment">// 3. 通过 Section 的 Document 设置水印（官方推荐方式）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getSections</span>().<span class="hljs-title function_">getCount</span>() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getSections</span>().<span class="hljs-title function_">get</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">getDocument</span>().<span class="hljs-title function_">setWatermark</span>(watermark);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 极端情况下没有 section，可退回到直接设置</span>
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">setWatermark</span>(watermark);
        }
​
        <span class="hljs-comment">// 4. 保存为新的 DOCX</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">saveToFile</span>(outputPath, <span class="hljs-title class_">FileFormat</span>.<span class="hljs-property">Docx</span>);
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">close</span>();
    }
}
</code></pre>
<h4 data-id="heading-5">4.2 从输入流到字节数组（适用于 Web 上传/下载场景）</h4>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">import</span> com.spire.doc.Document;
<span class="hljs-keyword">import</span> com.spire.doc.FileFormat;
<span class="hljs-keyword">import</span> com.spire.doc.TextWatermark;
<span class="hljs-keyword">import</span> com.spire.doc.documents.WatermarkLayout;
​
<span class="hljs-keyword">import</span> java.awt.Color;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.InputStream;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DocxWatermarkUtil</span> {
​
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] addWatermarkToDocx(InputStream inputStream, String watermarkText) <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>()) {
            <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>();
            document.loadFromStream(inputStream, FileFormat.Docx);
​
            <span class="hljs-type">TextWatermark</span> <span class="hljs-variable">watermark</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextWatermark</span>();
            watermark.setText(watermarkText);
            watermark.setFontSize(<span class="hljs-number">40</span>);
            watermark.setColor(Color.lightGray);
            watermark.setLayout(WatermarkLayout.Diagonal);
​
            <span class="hljs-keyword">if</span> (document.getSections().getCount() &gt; <span class="hljs-number">0</span>) {
                document.getSections().get(<span class="hljs-number">0</span>).getDocument().setWatermark(watermark);
            } <span class="hljs-keyword">else</span> {
                document.setWatermark(watermark);
            }
​
            document.saveToStream(out, FileFormat.Docx);
            document.close();
            <span class="hljs-keyword">return</span> out.toByteArray();
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-6">5. 示例二：为 DOC 文档添加文字水印</h3>
<p>DOC 文档与 DOCX 实现方式基本相同，仅在 <code>FileFormat</code> 上有所差异。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">import</span> com.spire.doc.Document;
<span class="hljs-keyword">import</span> com.spire.doc.FileFormat;
<span class="hljs-keyword">import</span> com.spire.doc.TextWatermark;
<span class="hljs-keyword">import</span> com.spire.doc.documents.WatermarkLayout;
​
<span class="hljs-keyword">import</span> java.awt.Color;
<span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;
<span class="hljs-keyword">import</span> java.io.InputStream;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DocWatermarkUtil</span> {
​
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] addWatermarkToDoc(InputStream inputStream, String watermarkText) <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>()) {
            <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>();
            document.loadFromStream(inputStream, FileFormat.Doc);
​
            <span class="hljs-type">TextWatermark</span> <span class="hljs-variable">watermark</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextWatermark</span>();
            watermark.setText(watermarkText);
            watermark.setFontSize(<span class="hljs-number">40</span>);
            watermark.setColor(Color.lightGray);
            watermark.setLayout(WatermarkLayout.Diagonal);
​
            <span class="hljs-keyword">if</span> (document.getSections().getCount() &gt; <span class="hljs-number">0</span>) {
                document.getSections().get(<span class="hljs-number">0</span>).getDocument().setWatermark(watermark);
            } <span class="hljs-keyword">else</span> {
                document.setWatermark(watermark);
            }
​
            document.saveToStream(out, FileFormat.Doc);
            document.close();
            <span class="hljs-keyword">return</span> out.toByteArray();
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-7">6. 关键点与实践建议</h3>
<ul>
<li>
<p><strong>水印文本设计</strong>：可以是固定文案（如「xx公司」「内部资料」），也可以结合用户名、时间戳、IP 等生成个性化水印，便于追责和防泄露。</p>
</li>
<li>
<p><strong>查看模式</strong>：Word 中建议使用「打印布局」查看水印；在某些阅读模式下水印可能被隐藏。</p>
</li>
<li>
<p><strong>Free 版本限制</strong>：Spire.Doc Free 版对于页数或功能有一定限制，大规模生产使用时建议评估付费版本或其他库。</p>
</li>
<li>
<p><strong>与业务集成</strong>：</p>
<ul>
<li>上传文件时在写入存储（本地/对象存储）前先加水印；</li>
<li>或在线预览/下载前临时生成带水印副本，不改变原始文件；</li>
<li>可以按租户、用户级别配置不同水印策略。</li>
</ul>
</li>
<li>
<p><strong>性能考虑</strong>：对于大体积 Word 文档，建议在后台任务中进行水印处理，避免阻塞同步接口。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-8">7. 总结</h3>
<p>使用 Spire.Doc 在 Java 中为 Word 文档添加页面文字水印，核心是：<strong>加载文档 → 构造 TextWatermark → 通过 Section/Document 设置水印 → 以对应格式保存</strong>。上述示例将输入输出封装为 <code>InputStream/byte[]</code> 或文件路径形式，方便在上传、下载或批处理场景中复用，实现对 DOC/DOCX 文档的统一水印控制。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从递归爆炸到闭包优化：彻底搞懂斐波那契数列的性能演进]]></title>    <link>https://juejin.cn/post/7602841282801729577</link>    <guid>https://juejin.cn/post/7602841282801729577</guid>    <pubDate>2026-02-04T10:54:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602841282801729577" data-draft-id="7602776926327570486" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从递归爆炸到闭包优化：彻底搞懂斐波那契数列的性能演进"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2026-02-04T10:54:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NEXT06"/> <meta itemprop="url" content="https://juejin.cn/user/1176918763246011"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从递归爆炸到闭包优化：彻底搞懂斐波那契数列的性能演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1176918763246011/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NEXT06
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T10:54:39.000Z" title="Wed Feb 04 2026 10:54:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端算法面试中，斐波那契数列（Fibonacci Sequence）不仅仅是一道考察递归逻辑的数学题，更是一块考察候选人对<strong>时间复杂度</strong>、<strong>记忆化（Memoization）<strong>以及</strong>JavaScript 闭包机制</strong>理解深度的试金石。</p>
<p>本文将基于一段代码的三个演进版本，带你深入理解如何将一个 </p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">O</span>(<span class="hljs-number">2</span>n) -&gt;<span class="hljs-number">2</span>的n次方
</code></pre>
<p> 的“灾难级”代码优化为 </p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">O</span>(n)
</code></pre>
<p> 的生产级代码。</p>
<h2 data-id="heading-0">一、 数学定义与暴力递归的陷阱</h2>
<p>斐波那契数列的定义非常简洁：从 0 和 1 开始，后续每一项都等于前两项之和。<br/>
即：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">f</span>(n)=<span class="hljs-built_in">f</span>(n−<span class="hljs-number">1</span>)+<span class="hljs-built_in">f</span>(n−<span class="hljs-number">2</span>)<span class="hljs-built_in">f</span>(n)=<span class="hljs-built_in">f</span>(n−<span class="hljs-number">1</span>)+<span class="hljs-built_in">f</span>(n−<span class="hljs-number">2</span>)
</code></pre>
<p>。</p>
<p>将这个公式直接翻译成代码，就是我们最常见的递归写法：</p>
<p>JavaScript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 版本 1：暴力递归</span>
function <span class="hljs-built_in">fib</span>(n) {
    <span class="hljs-comment">// 退出条件</span>
    <span class="hljs-built_in">if</span>(n &lt;= <span class="hljs-number">1</span>){
        return n;
    }
    <span class="hljs-comment">// 递归公式</span>
    return <span class="hljs-built_in">fib</span>(n-<span class="hljs-number">1</span>) + <span class="hljs-built_in">fib</span>(n-<span class="hljs-number">2</span>);
}
</code></pre>
<h3 data-id="heading-1">为什么这种写法在面试中只能得 50 分？</h3>
<p>虽然代码逻辑正确，但它存在严重的性能问题。当你执行 fib(10) 时，计算很快；但一旦尝试 fib(50)，浏览器可能会直接卡死。</p>
<p>原因是<strong>大量的重复计算</strong>。</p>
<p>为了计算 fib(5)，程序需要计算 fib(4) 和 fib(3)。<br/>
而在计算 fib(4) 时，又需要计算 fib(3) 和 fib(2)。<br/>
注意到了吗？fib(3) 被重复计算了多次。随着 n 的增加，这种重复计算呈指数级爆炸，时间复杂度为 </p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">O</span>(<span class="hljs-number">2</span>n) -&gt;<span class="hljs-number">2</span>的n次方
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16bd392eb41b479d963a644e44f2990b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTkVYVDA2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807279&amp;x-signature=f4n%2FtVt2Uma7z99Uy54%2BfmpmW%2FI%3D" alt="image.png" loading="lazy"/>
。</p>
<h2 data-id="heading-2">二、 核心优化思想：用空间换时间</h2>
<p>既然瓶颈在于“重复计算”，解决思路就是：<strong>凡是算过的，都记下来</strong>。下次再遇到相同的参数，直接读取结果，不再重新递归。这就是“记忆化（Memoization）”。</p>
<h3 data-id="heading-3">优化第一步：引入全局缓存</h3>
<p>我们可以引入一个对象作为缓存容器（HashMap）：</p>
<p>JavaScript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 版本 2：外部缓存</span>
const cache = {}; <span class="hljs-comment">// 用空间换时间</span>

function <span class="hljs-built_in">fib</span>(n) {
    <span class="hljs-comment">// 1. 先查缓存</span>
    <span class="hljs-built_in">if</span>(n in cache){
        return cache<span class="hljs-selector-attr">[n]</span>;
    }
    <span class="hljs-comment">// 2. 边界条件</span>
    <span class="hljs-built_in">if</span>(n &lt;= <span class="hljs-number">1</span>){
        cache<span class="hljs-selector-attr">[n]</span> = n;
        return n;
    }
    <span class="hljs-comment">// 3. 计算并写入缓存</span>
    const result = <span class="hljs-built_in">fib</span>(n-<span class="hljs-number">1</span>) + <span class="hljs-built_in">fib</span>(n-<span class="hljs-number">2</span>);
    cache<span class="hljs-selector-attr">[n]</span> = result;
    return result;
}
</code></pre>
<p>通过引入 cache，每个数字只会被计算一次。时间复杂度从指数级 </p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">O</span>(<span class="hljs-number">2</span>n) -&gt;<span class="hljs-number">2</span>的n次方
</code></pre>
<p> 降维到了线性 </p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">O</span>(n)
</code></pre>
<p>。这是一个巨大的性能飞跃。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8076794a6bd48289b8cc5b4da6c2afe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTkVYVDA2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807279&amp;x-signature=gQsvdkrrQbov7pzqYQ7nDGNE3k0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">三、 进阶实现：闭包与 IIFE 的完美结合</h2>
<p>版本 2 虽然解决了性能问题，但在工程上有一个致命缺陷：cache 变量定义在函数外部，是一个<strong>全局变量</strong>（或模块级变量）。这意味着任何外部代码都可以修改它，导致程序不安全，且污染了作用域。</p>
<p>在 JavaScript 中，完美的解决方案是结合 <strong>IIFE（立即执行函数表达式）</strong>  和 <strong>闭包（Closure）</strong> 。</p>
<p>JavaScript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 版本 3：闭包封装</span>
const fib = (function() {
    <span class="hljs-comment">// 闭包内的私有变量，外部无法访问</span>
    const cache = {}; 
    
    <span class="hljs-comment">// 返回实际执行的函数</span>
    return <span class="hljs-built_in">function</span>(n) {
        <span class="hljs-built_in">if</span>(n in cache){
            return cache<span class="hljs-selector-attr">[n]</span>;
        }
        <span class="hljs-built_in">if</span>(n &lt;= <span class="hljs-number">1</span>){
            cache<span class="hljs-selector-attr">[n]</span> = n;
            return n;
        }
        <span class="hljs-comment">// 注意：这里的 fib 指向的是外部接收 IIFE 返回值的那个变量</span>
        cache<span class="hljs-selector-attr">[n]</span> = <span class="hljs-built_in">fib</span>(n-<span class="hljs-number">1</span>) + <span class="hljs-built_in">fib</span>(n-<span class="hljs-number">2</span>);
        return cache<span class="hljs-selector-attr">[n]</span>;
    }
})()
</code></pre>
<h3 data-id="heading-5">代码解析</h3>
<ol>
<li><strong>IIFE (function(){...})()</strong> ：函数定义后立即执行，创建了一个独立的作用域。</li>
<li><strong>闭包</strong>：IIFE 返回的内部函数引用了外层作用域的 cache 变量。即便 IIFE 执行完毕，cache 依然驻留在内存中，不会被销毁，也不会被外部访问。</li>
<li><strong>数据持久化</strong>：当你多次调用 fib(10)、fib(20) 时，它们共享同一个 cache，计算过的结果可以跨函数调用被复用。</li>
</ol>
<p>这种写法不仅实现了性能优化，还体现了优秀的代码封装思想，是面试中的高分回答。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80f80e5742e84c6c977fb2b5c4caaaa9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTkVYVDA2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807279&amp;x-signature=57iQneDuz5vGIADXzD9KAOS5cS8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">四、 面试总结</h2>
<p>当面试官让你手写斐波那契数列时，建议按照以下逻辑展开：</p>
<ol>
<li>
<p><strong>先写基本解法</strong>：快速写出递归版本，并主动指出其 </p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">O</span>(<span class="hljs-number">2</span>n) -&gt;<span class="hljs-number">2</span>的n次方
</code></pre>
<p> 的复杂度问题和爆栈风险。</p>
</li>
<li>
<p><strong>提出优化方案</strong>：阐述“用空间换时间”的记忆化思想。</p>
</li>
<li>
<p><strong>展示语言特性</strong>：使用 <strong>IIFE + 闭包</strong> 的方式实现记忆化函数。这能展示你对 JavaScript 作用域链和闭包机制的深刻理解。</p>
</li>
<li>
<p><strong>扩展思维</strong>：如果面试官进一步追问，可以提到通用记忆化函数（Memoize Helper）的编写，或者提到使用迭代（循环）方式来进一步避免递归深度的限制。</p>
</li>
</ol>
<p>掌握这段代码的演进过程，不仅是为了解决一道算法题，更是为了掌握 JavaScript 函数式编程中“状态保持”的核心模式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Guigu 甑选平台第一篇：项目初始化与配置]]></title>    <link>https://juejin.cn/post/7602901565033562158</link>    <guid>https://juejin.cn/post/7602901565033562158</guid>    <pubDate>2026-02-04T10:55:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602901565033562158" data-draft-id="7602789520035741706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Guigu 甑选平台第一篇：项目初始化与配置"/> <meta itemprop="keywords" content="Vue.js,前端,前端框架"/> <meta itemprop="datePublished" content="2026-02-04T10:55:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="进击的野人"/> <meta itemprop="url" content="https://juejin.cn/user/1458425238667008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Guigu 甑选平台第一篇：项目初始化与配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1458425238667008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    进击的野人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T10:55:56.000Z" title="Wed Feb 04 2026 10:55:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第一章：项目创建 - 使用Create Vue的理由和步骤</h2>
<h3 data-id="heading-1">步骤1：使用官方脚手架创建项目</h3>
<p>使用<code>npm create vue@latest</code>是因为这是Vue团队官方维护的脚手架工具，能够确保项目结构与最新Vue特性完全兼容。它集成了Vue社区的最佳实践和推荐配置，减少了手动配置可能出现的错误。交互式命令行让开发者能够按需选择功能模块。</p>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 执行创建命令</span>
<span class="hljs-string">npm</span> <span class="hljs-string">create</span> <span class="hljs-string">vue@latest</span>

<span class="hljs-comment"># 交互式配置</span>
<span class="hljs-string">√</span> <span class="hljs-attr">Project name:</span> <span class="hljs-string">...</span> <span class="hljs-string">guigu-zhenxuan-platform</span>
<span class="hljs-string">√</span> <span class="hljs-string">Add</span> <span class="hljs-string">TypeScript?</span> <span class="hljs-string">...</span> <span class="hljs-literal">Yes</span>  <span class="hljs-comment"># 选择TypeScript是为了提供类型安全，减少运行时错误</span>
<span class="hljs-string">√</span> <span class="hljs-string">Add</span> <span class="hljs-string">JSX</span> <span class="hljs-string">Support?</span> <span class="hljs-string">...</span> <span class="hljs-literal">No</span>  <span class="hljs-comment"># 不使用JSX是因为Vue推荐使用模板语法，保持项目语法一致性</span>
<span class="hljs-string">√</span> <span class="hljs-string">Add</span> <span class="hljs-string">Vue</span> <span class="hljs-string">Router</span> <span class="hljs-string">for</span> <span class="hljs-string">Single</span> <span class="hljs-string">Page</span> <span class="hljs-string">Application</span> <span class="hljs-string">development?</span> <span class="hljs-string">...</span> <span class="hljs-literal">Yes</span>  <span class="hljs-comment"># 添加Vue Router是因为SPA应用必须的路由管理</span>
<span class="hljs-string">√</span> <span class="hljs-string">Add</span> <span class="hljs-string">Pinia</span> <span class="hljs-string">for</span> <span class="hljs-string">state</span> <span class="hljs-string">management?</span> <span class="hljs-string">...</span> <span class="hljs-literal">Yes</span>  <span class="hljs-comment"># 选择Pinia是因为它是Vue官方推荐的状态管理库</span>
<span class="hljs-string">√</span> <span class="hljs-string">Add</span> <span class="hljs-string">Vitest</span> <span class="hljs-string">for</span> <span class="hljs-string">Unit</span> <span class="hljs-string">Testing?</span> <span class="hljs-string">...</span> <span class="hljs-literal">No</span>  <span class="hljs-comment"># 不先添加单元测试是为了先搭建项目基础架构，测试可以后期添加</span>
<span class="hljs-string">√</span> <span class="hljs-string">Add</span> <span class="hljs-string">an</span> <span class="hljs-string">End-to-End</span> <span class="hljs-string">Testing</span> <span class="hljs-string">Solution?</span> <span class="hljs-string">...</span> <span class="hljs-literal">No</span>  <span class="hljs-comment"># 不添加E2E测试是因为初期项目重点在功能开发</span>
<span class="hljs-string">√</span> <span class="hljs-string">Add</span> <span class="hljs-string">ESLint</span> <span class="hljs-string">for</span> <span class="hljs-string">code</span> <span class="hljs-string">quality?</span> <span class="hljs-string">...</span> <span class="hljs-literal">Yes</span>  <span class="hljs-comment"># 添加ESLint是为了统一代码风格，提高代码质量</span>
<span class="hljs-string">√</span> <span class="hljs-string">Add</span> <span class="hljs-string">Prettier</span> <span class="hljs-string">for</span> <span class="hljs-string">code</span> <span class="hljs-string">formatting?</span> <span class="hljs-string">...</span> <span class="hljs-literal">Yes</span>  <span class="hljs-comment"># 添加Prettier是为了自动格式化代码，避免团队成员间的格式争议</span>

<span class="hljs-comment"># 进入项目并安装基础依赖</span>
<span class="hljs-string">cd</span> <span class="hljs-string">guigu-zhenxuan-platform</span>
<span class="hljs-string">npm</span> <span class="hljs-string">install</span>
</code></pre>
<p><strong>初始化后的项目结构说明</strong>：</p>
<p>text</p>
<p>复制下载</p>
<pre><code class="hljs language-csharp" lang="csharp">guigu-zhenxuan-platform/
├── src/
│   ├── components/    <span class="hljs-meta"># components目录用于存放可复用的UI组件</span>
│   ├── views/         <span class="hljs-meta"># views目录用于存放页面级组件，这是Vue Router的惯例命名</span>
│   ├── router/        <span class="hljs-meta"># router目录用于集中管理路由配置</span>
│   ├── stores/        <span class="hljs-meta"># stores目录用于存放Pinia状态管理文件</span>
│   └── main.ts        <span class="hljs-meta"># main.ts是Vue应用的入口文件</span>
├── <span class="hljs-keyword">public</span>/            <span class="hljs-meta"># public目录用于存放不需要构建处理的静态资源</span>
├── .eslintrc.cjs      <span class="hljs-meta"># ESLint配置文件，使用.cjs扩展名是因为需要CommonJS格式</span>
├── .prettierrc        <span class="hljs-meta"># Prettier代码格式化配置文件</span>
├── index.html         <span class="hljs-meta"># HTML入口文件，浏览器通过这个文件加载应用</span>
├── package.json       <span class="hljs-meta"># 项目配置文件，管理依赖和脚本</span>
├── tsconfig.json      <span class="hljs-meta"># TypeScript编译配置文件</span>
└── vite.config.ts     <span class="hljs-meta"># Vite构建工具配置文件</span>
</code></pre>
<h2 data-id="heading-2">第二章：修改Package.json - 详细配置解析</h2>
<h3 data-id="heading-3">步骤1：更新scripts配置</h3>
<p>scripts配置决定了项目的开发工作流，合理的配置能提高开发效率。</p>
<p>打开package.json，修改scripts部分：</p>
<p>json</p>
<p>复制下载</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite --open"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 配置vite --open是为了启动开发服务器后自动打开浏览器，提升开发体验</span>
  
  <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"run-p type-check "</span>build-only <span class="hljs-punctuation">{</span>@<span class="hljs-punctuation">}</span><span class="hljs-string">" --"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 这样配置build命令是为了并行执行类型检查和构建过程，提高构建速度</span>
  
  <span class="hljs-attr">"preview"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite preview"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// preview命令用于预览生产环境构建结果，验证构建效果是否符合预期</span>
  
  <span class="hljs-attr">"build-only"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 单独的build-only命令用于纯构建操作，方便在组合命令中调用</span>
  
  <span class="hljs-attr">"type-check"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vue-tsc --build"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 使用vue-tsc是因为它专门针对Vue单文件组件进行TypeScript类型检查</span>
  
  <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"run-s lint:*"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 使用run-s是为了顺序执行所有lint相关任务，确保代码检查的完整性</span>
  
  <span class="hljs-attr">"lint:oxlint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"oxlint . --fix"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 配置oxlint是因为它相比ESLint有更好的性能表现，检查速度更快</span>
  
  <span class="hljs-attr">"lint:eslint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint . --fix --cache"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 保留ESLint是因为它有成熟的生态系统和丰富的插件支持</span>
  
  <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prettier --write --experimental-cli src/"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 使用--experimental-cli参数是为了启用Prettier新版本的命令行特性</span>
  
  <span class="hljs-attr">"preinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node ./scripts/preinstall.js"</span>
  <span class="hljs-comment">// preinstall脚本用于在安装依赖前检查开发环境是否符合要求</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-4">步骤2：添加生产依赖</h3>
<p>生产依赖是项目运行时必须的包，每个依赖都有特定的业务用途。</p>
<p>执行以下安装命令：</p>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装Element Plus UI组件库</span>
npm install element-plus
<span class="hljs-comment"># 安装Element Plus是因为它提供了丰富的企业级UI组件，能显著加快开发速度</span>

<span class="hljs-comment"># 安装Element Plus图标库</span>
npm install @element-plus/icons-vue
<span class="hljs-comment"># 安装图标库是为了提供丰富的图标资源，提升用户界面视觉效果</span>

<span class="hljs-comment"># 安装Axios HTTP客户端</span>
npm install axios
<span class="hljs-comment"># 安装Axios是因为它是一个功能强大的HTTP客户端，支持请求拦截、响应拦截等高级特性</span>

<span class="hljs-comment"># 安装Mock.js数据模拟库</span>
npm install mockjs
<span class="hljs-comment"># 安装Mock.js是为了在开发阶段模拟后端API数据，实现前后端并行开发</span>
</code></pre>
<p>package.json中的dependencies部分配置如下：</p>
<p>json</p>
<p>复制下载</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"@element-plus/icons-vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.3.2"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// Element Plus图标组件</span>
  <span class="hljs-attr">"axios"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.13.4"</span><span class="hljs-punctuation">,</span>                    <span class="hljs-comment">// HTTP请求库，用于API调用</span>
  <span class="hljs-attr">"element-plus"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.13.1"</span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// UI组件库，提供基础界面组件</span>
  <span class="hljs-attr">"mockjs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.1.0"</span><span class="hljs-punctuation">,</span>                    <span class="hljs-comment">// 模拟数据生成器</span>
  <span class="hljs-attr">"pinia"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.1.7"</span><span class="hljs-punctuation">,</span>                     <span class="hljs-comment">// 状态管理库，已由create-vue安装</span>
  <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.4.21"</span><span class="hljs-punctuation">,</span>                      <span class="hljs-comment">// Vue核心框架，已由create-vue安装</span>
  <span class="hljs-attr">"vue-router"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.3.0"</span>                 <span class="hljs-comment">// 路由管理库，已由create-vue安装</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">步骤3：添加开发依赖</h3>
<p>开发依赖只在开发阶段使用，用于提升开发体验和保证代码质量。</p>
<p>执行以下安装命令：</p>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 安装TypeScript相关配置</span>
npm install --save-dev <span class="hljs-variable">@tsconfig</span>/node24
<span class="hljs-comment"># 安装<span class="hljs-doctag">@tsconfig</span>/node24是为了使用Node.js 24的TypeScript配置预设</span>

npm install --save-dev <span class="hljs-variable">@vue</span>/tsconfig
<span class="hljs-comment"># 安装<span class="hljs-doctag">@vue</span>/tsconfig是为了使用Vue官方推荐的TypeScript配置预设</span>

npm install --save-dev <span class="hljs-variable">@types</span>/node
<span class="hljs-comment"># 安装<span class="hljs-doctag">@types</span>/node是为了获取Node.js API的类型定义</span>

<span class="hljs-comment"># 安装Vite插件</span>
npm install --save-dev vite-plugin-mock
<span class="hljs-comment"># 安装vite-plugin-mock是为了将Mock数据集成到Vite开发服务器中</span>

npm install --save-dev vite-plugin-svg-icons
<span class="hljs-comment"># 安装vite-plugin-svg-icons是为了优化SVG图标的使用体验</span>

npm install --save-dev vite-plugin-vue-devtools
<span class="hljs-comment"># 安装vite-plugin-vue-devtools是为了增强Vue开发工具的功能</span>

<span class="hljs-comment"># 安装代码质量工具</span>
npm install --save-dev eslint-config-prettier
<span class="hljs-comment"># 安装eslint-config-prettier是为了集成Prettier和ESLint，避免规则冲突</span>

npm install --save-dev eslint-plugin-oxlint
<span class="hljs-comment"># 安装eslint-plugin-oxlint是为了在ESLint中使用oxlint规则</span>

npm install --save-dev oxlint
<span class="hljs-comment"># 安装oxlint是因为它提供了比ESLint更快的JavaScript代码检查</span>

<span class="hljs-comment"># 安装工具库</span>
npm install --save-dev npm-run-all2
<span class="hljs-comment"># 安装npm-run-all2是为了并行或顺序运行多个npm脚本</span>

npm install --save-dev jiti
<span class="hljs-comment"># 安装jiti是为了提供TypeScript文件的即时编译能力</span>
</code></pre>
<p>完整的devDependencies配置如下：</p>
<p>json</p>
<p>复制下载</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-string">"devDependencies"</span>: {
  <span class="hljs-string">"@tsconfig/node24"</span>: <span class="hljs-string">"^24.0.4"</span>,           <span class="hljs-regexp">//</span> Node.js <span class="hljs-number">24</span>的TypeScript配置预设
  <span class="hljs-string">"@types/node"</span>: <span class="hljs-string">"^20.12.7"</span>,              <span class="hljs-regexp">//</span> Node.js API类型定义
  <span class="hljs-string">"@vitejs/plugin-vue"</span>: <span class="hljs-string">"^5.0.4"</span>,         <span class="hljs-regexp">//</span> Vite的Vue单文件组件插件
  <span class="hljs-string">"@vue/eslint-config-typescript"</span>: <span class="hljs-string">"^13.0.0"</span>, <span class="hljs-regexp">//</span> Vue项目的TypeScript ESLint配置
  <span class="hljs-string">"@vue/tsconfig"</span>: <span class="hljs-string">"^0.5.0"</span>,              <span class="hljs-regexp">//</span> Vue项目的TypeScript配置
  <span class="hljs-string">"eslint"</span>: <span class="hljs-string">"^9.0.0"</span>,                     <span class="hljs-regexp">//</span> JavaScript代码检查工具
  <span class="hljs-string">"eslint-config-prettier"</span>: <span class="hljs-string">"^9.1.0"</span>,     <span class="hljs-regexp">//</span> 关闭与Prettier冲突的ESLint规则
  <span class="hljs-string">"eslint-plugin-oxlint"</span>: <span class="hljs-string">"~1.42.0"</span>,      <span class="hljs-regexp">//</span> oxlint的ESLint插件
  <span class="hljs-string">"eslint-plugin-vue"</span>: <span class="hljs-string">"^9.23.0"</span>,         <span class="hljs-regexp">//</span> Vue.js的ESLint插件
  <span class="hljs-string">"jiti"</span>: <span class="hljs-string">"^1.21.0"</span>,                      <span class="hljs-regexp">//</span> TypeScript即时编译工具
  <span class="hljs-string">"npm-run-all2"</span>: <span class="hljs-string">"^8.0.4"</span>,               <span class="hljs-regexp">//</span> 并行运行npm脚本的工具
  <span class="hljs-string">"oxlint"</span>: <span class="hljs-string">"~1.42.0"</span>,                    <span class="hljs-regexp">//</span> 高性能JavaScript linter
  <span class="hljs-string">"prettier"</span>: <span class="hljs-string">"3.2.5"</span>,                    <span class="hljs-regexp">//</span> 代码格式化工具
  <span class="hljs-string">"typescript"</span>: <span class="hljs-string">"~5.3.3"</span>,                 <span class="hljs-regexp">//</span> TypeScript编译器
  <span class="hljs-string">"vite"</span>: <span class="hljs-string">"^5.2.0"</span>,                       <span class="hljs-regexp">//</span> 前端构建工具
  <span class="hljs-string">"vite-plugin-mock"</span>: <span class="hljs-string">"^3.0.2"</span>,           <span class="hljs-regexp">//</span> Vite的Mock数据插件
  <span class="hljs-string">"vite-plugin-svg-icons"</span>: <span class="hljs-string">"^2.0.1"</span>,      <span class="hljs-regexp">//</span> Vite的SVG图标插件
  <span class="hljs-string">"vite-plugin-vue-devtools"</span>: <span class="hljs-string">"^7.3.0"</span>,   <span class="hljs-regexp">//</span> Vite的Vue开发工具插件
  <span class="hljs-string">"vue-tsc"</span>: <span class="hljs-string">"^1.8.27"</span>                    // Vue单文件组件的TypeScript检查器
}
</code></pre>
<h3 data-id="heading-6">步骤4：配置引擎要求和Prettier</h3>
<p>在package.json末尾添加以下配置：</p>
<p>json</p>
<p>复制下载</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^20.19.0 || &gt;=22.12.0"</span>
<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-comment">// 配置engines是为了明确项目所需的Node.js版本范围，确保开发环境一致性</span>

<span class="hljs-attr">"prettier"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ignorePath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".prettierignore"</span>
<span class="hljs-punctuation">}</span>
<span class="hljs-comment">// 配置prettier是为了指定忽略文件配置，避免对特定文件进行格式化</span>
</code></pre>
<h2 data-id="heading-7">第三章：创建环境检查脚本</h2>
<h3 data-id="heading-8">步骤1：创建预安装脚本</h3>
<p>预安装脚本在npm install之前执行，用于检查开发环境是否符合要求。</p>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建scripts目录</span>
<span class="hljs-built_in">mkdir</span> scripts

<span class="hljs-comment"># 创建preinstall.js文件</span>
<span class="hljs-built_in">touch</span> scripts/preinstall.js
</code></pre>
<p>编辑scripts/preinstall.js文件：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 检查Node.js版本是否符合项目要求</span>
<span class="hljs-type">const</span> currentNodeVersion = process.versions.node;
<span class="hljs-type">const</span> semver = currentNodeVersion.<span class="hljs-built_in">split</span>(<span class="hljs-string">'.'</span>);
<span class="hljs-type">const</span> major = <span class="hljs-built_in">parseInt</span>(semver[<span class="hljs-number">0</span>], <span class="hljs-number">10</span>);

<span class="hljs-comment">// 项目要求Node.js 20.19.0或更高版本</span>
<span class="hljs-keyword">if</span> (major &lt; <span class="hljs-number">20</span>) {
  console.<span class="hljs-built_in">error</span>(
    <span class="hljs-string">'你正在使用 Node.js '</span> +
      currentNodeVersion +
      <span class="hljs-string">'。\n'</span> +
      <span class="hljs-string">'本项目需要 Node.js 20.19.0 或更高版本。\n'</span> +
      <span class="hljs-string">'请升级你的 Node.js 版本。'</span>
  );
  process.<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 退出进程，阻止继续安装</span>
}

console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'✅ Node.js 版本检查通过'</span>);
<span class="hljs-comment">// 版本检查通过后，npm install会继续执行</span>
</code></pre>
<p><strong>这个脚本的作用</strong>：确保所有开发者在一致的Node.js环境下工作，避免因版本差异导致的兼容性问题。</p>
<h2 data-id="heading-9">第四章：配置HTML入口文件</h2>
<h3 data-id="heading-10">步骤1：修改index.html</h3>
<p>index.html是Web应用的入口文件，浏览器通过加载这个文件启动整个应用。</p>
<p>编辑index.html文件：</p>
<p>html</p>
<p>复制下载运行</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 指定中文语言是为了更好的无障碍支持和SEO优化 --&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 设置UTF-8编码是为了支持中文等多语言字符 --&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/favicon.ico"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 设置网站图标，提升品牌识别度 --&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 配置viewport是为了实现响应式设计，适配移动设备 --&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>硅谷甑选平台<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 设置页面标题，显示在浏览器标签页上 --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Vue应用挂载点，所有Vue组件将在这个div内渲染 --&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.ts"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 使用type="module"启用ES模块支持，加载应用入口文件 --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-11">第五章：配置TypeScript和Vite</h2>
<h3 data-id="heading-12">步骤1：修改tsconfig.json</h3>
<p>TypeScript配置文件决定了TypeScript编译器如何工作。</p>
<p>打开tsconfig.json，确保配置正确：</p>
<p>json</p>
<p>复制下载</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"extends"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@vue/tsconfig/tsconfig.dom.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 继承Vue官方的TypeScript配置，减少手动配置工作量</span>
  
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ES2020"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 设置编译目标为ES2020，使用较新的JavaScript特性</span>
    
    <span class="hljs-attr">"useDefineForClassFields"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 使用ES2022的类字段定义方式</span>
    
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 使用ES模块系统，支持tree-shaking</span>
    
    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"ES2020"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"DOM"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"DOM.Iterable"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 包含的库文件，提供类型提示</span>
    
    <span class="hljs-attr">"skipLibCheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 跳过库文件的类型检查，加快编译速度</span>
    
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bundler"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 使用bundler的模块解析策略，与Vite保持一致</span>
    
    <span class="hljs-attr">"allowImportingTsExtensions"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 允许导入TypeScript扩展名的文件</span>
    
    <span class="hljs-attr">"resolveJsonModule"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 允许导入JSON文件作为模块</span>
    
    <span class="hljs-attr">"isolatedModules"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 确保每个文件都能单独编译</span>
    
    <span class="hljs-attr">"noEmit"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 不输出编译文件，由Vite处理构建</span>
    
    <span class="hljs-attr">"jsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"preserve"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 保留JSX语法，由其他工具处理</span>
    
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 启用所有严格类型检查</span>
    
    <span class="hljs-attr">"noUnusedLocals"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 检查未使用的局部变量</span>
    
    <span class="hljs-attr">"noUnusedParameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 检查未使用的函数参数</span>
    
    <span class="hljs-attr">"noFallthroughCasesInSwitch"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 检查switch语句的fallthrough情况</span>
    
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 设置基础路径为当前目录</span>
    
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
    <span class="hljs-comment">// 配置路径别名，@表示src目录，简化导入路径</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/**/*.ts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*.tsx"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*.vue"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 包含需要编译的文件类型</span>
  
  <span class="hljs-attr">"references"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./tsconfig.node.json"</span>
    <span class="hljs-punctuation">}</span>
    <span class="hljs-comment">// 引用Node环境的TypeScript配置</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-13">步骤2：修改tsconfig.node.json</h3>
<p>这个文件用于配置Node.js环境的TypeScript编译。</p>
<p>json</p>
<p>复制下载</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"extends"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@tsconfig/node24/tsconfig.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 继承Node.js 24的TypeScript配置预设</span>
  
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"vite.config.ts"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"scripts/**/*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"mock/**/*"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 包含Node环境下的TypeScript文件</span>
  
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"composite"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 启用复合编译，支持项目引用</span>
    
    <span class="hljs-attr">"noEmit"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 不输出编译文件</span>
    
    <span class="hljs-attr">"tsBuildInfoFile"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./node_modules/.tmp/tsconfig.node.tsbuildinfo"</span>
    <span class="hljs-comment">// TypeScript构建信息文件位置</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-14">步骤3：配置Vite构建工具</h3>
<p>Vite配置文件决定了项目的构建行为和开发服务器配置。</p>
<p>打开vite.config.ts，修改为：</p>
<p>typescript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { fileURLToPath, <span class="hljs-variable constant_">URL</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>
<span class="hljs-comment">// 导入URL处理工具，用于处理文件路径</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-comment">// 导入Vite配置函数</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-comment">// 导入Vite的Vue插件，用于处理.vue文件</span>
<span class="hljs-keyword">import</span> { viteMockServe } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-mock'</span>
<span class="hljs-comment">// 导入Mock插件，用于开发阶段的数据模拟</span>
<span class="hljs-keyword">import</span> { createSvgIconsPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-svg-icons'</span>
<span class="hljs-comment">// 导入SVG图标插件，优化图标使用</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueDevTools</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-vue-devtools'</span>
<span class="hljs-comment">// 导入Vue开发工具插件，增强调试能力</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-comment">// 导入路径处理工具</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ command }</span>) =&gt;</span> ({
  <span class="hljs-comment">// 根据命令模式（serve/build）返回不同配置</span>
  
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-comment">// Vue单文件组件插件，必须放在第一个</span>
    
    <span class="hljs-title function_">viteMockServe</span>({
      <span class="hljs-attr">mockPath</span>: <span class="hljs-string">'mock'</span>,
      <span class="hljs-comment">// Mock数据文件存放目录</span>
      <span class="hljs-attr">enable</span>: command === <span class="hljs-string">'serve'</span>,
      <span class="hljs-comment">// 只在开发服务器启用Mock</span>
    }),
    
    <span class="hljs-title function_">createSvgIconsPlugin</span>({
      <span class="hljs-attr">iconDirs</span>: [path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'src/assets/icons'</span>)],
      <span class="hljs-comment">// SVG图标文件目录</span>
      <span class="hljs-attr">symbolId</span>: <span class="hljs-string">'icon-[dir]-[name]'</span>,
      <span class="hljs-comment">// 图标ID生成规则</span>
    }),
    
    <span class="hljs-title class_">VueDevTools</span>(),
    <span class="hljs-comment">// Vue开发工具插件</span>
  ],
  
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./src'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))
      <span class="hljs-comment">// 配置路径别名，@指向src目录</span>
    }
  },
  
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">3000</span>,
    <span class="hljs-comment">// 开发服务器端口号</span>
    <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// 启动后自动打开浏览器</span>
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
        <span class="hljs-comment">// 代理目标地址</span>
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-comment">// 修改请求头中的Origin字段</span>
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>)
        <span class="hljs-comment">// 重写请求路径，移除/api前缀</span>
      }
    }
  }
}))
</code></pre>
<h2 data-id="heading-15">第六章：配置代码质量和样式</h2>
<h3 data-id="heading-16">步骤1：创建样式重置文件</h3>
<p>样式重置文件用于统一不同浏览器的默认样式，提供一致的基准样式。</p>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建styles目录</span>
<span class="hljs-built_in">mkdir</span> src/styles

<span class="hljs-comment"># 创建reset.css文件</span>
<span class="hljs-built_in">touch</span> src/styles/reset.css
</code></pre>
<p>编辑src/styles/reset.css文件：</p>
<p>css</p>
<p>复制下载</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 重置所有元素的默认边距和内边距 */</span>
* {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">box-sizing</span>: border-box;
  <span class="hljs-comment">/* 使用border-box盒模型，更符合开发直觉 */</span>
}

<span class="hljs-comment">/* 设置根元素和body的高度 */</span>
<span class="hljs-selector-tag">html</span>, <span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-comment">/* 确保页面能占满整个视口高度 */</span>
  
  <span class="hljs-attribute">font-family</span>: -apple-system, BlinkMacSystemFont, <span class="hljs-string">'Segoe UI'</span>, Roboto, <span class="hljs-string">'Helvetica Neue'</span>, Arial, sans-serif;
  <span class="hljs-comment">/* 设置字体栈，优先使用系统字体 */</span>
}

<span class="hljs-comment">/* 设置Vue应用容器的样式 */</span>
<span class="hljs-selector-id">#app</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-comment">/* 应用容器占满整个父元素高度 */</span>
}
</code></pre>
<h3 data-id="heading-17">步骤2：修改ESLint配置</h3>
<p>ESLint配置文件定义了代码检查规则，确保代码质量一致性。</p>
<p>打开.eslintrc.cjs，修改为：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/* eslint-env node */</span>
<span class="hljs-comment">// 声明当前文件运行在Node.js环境中</span>

require(<span class="hljs-string">'@rushstack/eslint-patch/modern-module-resolution'</span>)
<span class="hljs-comment">// 使用ESLint补丁，解决模块解析问题</span>

<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  root: <span class="hljs-literal">true</span>,
  <span class="hljs-comment">// 指定为根配置文件，ESLint不会向上查找其他配置</span>
  
  extends: [
    <span class="hljs-string">'plugin:vue/vue3-essential'</span>,
    <span class="hljs-comment">// Vue 3基础规则集</span>
    <span class="hljs-string">'eslint:recommended'</span>,
    <span class="hljs-comment">// ESLint推荐规则</span>
    <span class="hljs-string">'@vue/eslint-config-typescript'</span>,
    <span class="hljs-comment">// Vue的TypeScript配置</span>
    <span class="hljs-string">'@vue/eslint-config-prettier/skip-formatting'</span>
    <span class="hljs-comment">// 跳过Prettier的格式化规则</span>
  ],
  
  parserOptions: {
    ecmaVersion: <span class="hljs-string">'latest'</span>
    <span class="hljs-comment">// 使用最新的ECMAScript版本</span>
  },
  
  rules: {
    <span class="hljs-string">'vue/multi-word-component-names'</span>: <span class="hljs-string">'off'</span>
    <span class="hljs-comment">// 关闭Vue组件必须多单词命名的规则</span>
    <span class="hljs-comment">// 因为有些基础组件如Login、Home使用单单词更合适</span>
  }
}
</code></pre>
<h3 data-id="heading-18">步骤3：创建.prettierignore文件</h3>
<p>Prettier忽略文件指定了哪些文件不需要进行代码格式化。</p>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建Prettier忽略文件</span>
<span class="hljs-built_in">touch</span> .prettierignore
</code></pre>
<p>编辑.prettierignore文件：</p>
<p>plaintext</p>
<p>复制下载</p>
<pre><code class="hljs language-python" lang="python">node_modules
<span class="hljs-comment"># 忽略node_modules目录，因为这是第三方依赖</span>

dist
<span class="hljs-comment"># 忽略构建输出目录</span>

*.<span class="hljs-built_in">min</span>.js
<span class="hljs-comment"># 忽略压缩的JavaScript文件</span>

*.<span class="hljs-built_in">min</span>.css
<span class="hljs-comment"># 忽略压缩的CSS文件</span>
</code></pre>
<h2 data-id="heading-19">第七章：配置项目核心文件</h2>
<h3 data-id="heading-20">步骤1：修改main.ts文件</h3>
<p>main.ts是Vue应用的入口文件，负责初始化Vue应用并注册各种插件。</p>
<p>打开src/main.ts，修改为：</p>
<p>typescript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 导入Vue的createApp函数，用于创建Vue应用实例</span>

<span class="hljs-keyword">import</span> <span class="hljs-string">'./styles/reset.css'</span>
<span class="hljs-comment">// 导入重置样式，确保样式一致性</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-comment">// 导入根组件</span>

<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-comment">// 导入路由配置</span>

<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-comment">// 导入Pinia的createPinia函数，用于创建状态存储</span>

<span class="hljs-comment">// 导入Element Plus</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ElementPlus</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'element-plus/dist/index.css'</span>
<span class="hljs-comment">// 导入Element Plus及其样式</span>

<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">ElementPlusIconsVue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@element-plus/icons-vue'</span>
<span class="hljs-comment">// 导入Element Plus的所有图标组件</span>

<span class="hljs-comment">// 创建Vue应用实例</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)

<span class="hljs-comment">// 创建Pinia状态存储实例</span>
<span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>()

<span class="hljs-comment">// 注册Element Plus插件</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">ElementPlus</span>)
<span class="hljs-comment">// 注册路由</span>
app.<span class="hljs-title function_">use</span>(router)
<span class="hljs-comment">// 注册Pinia状态管理</span>
app.<span class="hljs-title function_">use</span>(pinia)

<span class="hljs-comment">// 注册所有Element Plus图标组件</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, component] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-title class_">ElementPlusIconsVue</span>)) {
  app.<span class="hljs-title function_">component</span>(key, component)
  <span class="hljs-comment">// 将每个图标注册为全局组件</span>
}

<span class="hljs-comment">// 将Vue应用挂载到HTML中的#app元素</span>
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h3 data-id="heading-21">步骤2：修改App.vue文件</h3>
<p>App.vue是应用的根组件，所有其他组件都在这个组件内渲染。</p>
<p>打开src/App.vue，修改为：</p>
<p>vue</p>
<p>复制下载</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="xml">
// 使用<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">语法糖，简化组合式<span class="hljs-variable constant_">API</span>的使用
<span class="hljs-comment">// lang="ts"指定使用TypeScript</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RouterView</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-comment">// 导入RouterView组件，用于渲染当前路由对应的组件</span>
</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 路由视图容器，根据当前路由显示不同的页面 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">RouterView</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* scoped样式，只作用于当前组件 */</span>
<span class="hljs-comment">/* 可以在这里添加全局的样式规则 */</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-22">步骤3：配置路由</h3>
<p>路由配置文件定义了应用的路由结构和页面导航逻辑。</p>
<p>打开src/router/index.ts，确保基本配置：</p>
<p>typescript</p>
<p>复制下载</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createRouter, createWebHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-comment">// 导入Vue Router的创建函数</span>
<span class="hljs-comment">// createWebHistory使用HTML5 History API，URL更美观</span>

<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">RouteRecordRaw</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-comment">// 导入路由记录类型定义</span>

<span class="hljs-comment">// 定义路由数组，每个路由对应一个页面</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">routes</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">RouteRecordRaw</span>&gt; = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
    <span class="hljs-comment">// 根路径</span>
    <span class="hljs-attr">redirect</span>: <span class="hljs-string">'/login'</span>
    <span class="hljs-comment">// 重定向到登录页面，作为默认首页</span>
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/login'</span>,
    <span class="hljs-comment">// 登录页面路径</span>
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Login'</span>,
    <span class="hljs-comment">// 路由名称，用于编程式导航</span>
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/LoginView.vue'</span>)
    <span class="hljs-comment">// 使用动态导入实现路由懒加载，提高首屏加载速度</span>
  }
  <span class="hljs-comment">// 可以在这里添加更多路由配置</span>
]

<span class="hljs-comment">// 创建路由实例</span>
<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">BASE_URL</span>),
  <span class="hljs-comment">// 使用history模式，需要服务器配置支持</span>
  <span class="hljs-comment">// import.meta.env.BASE_URL获取基础URL</span>
  
  routes
  <span class="hljs-comment">// 传入路由配置</span>
})

<span class="hljs-comment">// 导出路由实例，供main.ts使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
<h3 data-id="heading-23">步骤4：配置Pinia Store</h3>
<p>Pinia配置文件定义了应用的状态管理结构。</p>
<p>打开src/stores/index.ts，修改为：</p>
<p>typescript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-comment">// 导入createPinia函数，用于创建Pinia实例</span>

<span class="hljs-comment">// 创建Pinia实例</span>
<span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>()

<span class="hljs-comment">// 导出Pinia实例，供main.ts使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> pinia

<span class="hljs-comment">// 在这里可以导出具体的store模块</span>
<span class="hljs-comment">// 例如：export { useUserStore } from './user'</span>
<span class="hljs-comment">// 这样可以集中管理所有store的导出</span>
</code></pre>
<h2 data-id="heading-24">第八章：创建Mock数据</h2>
<h3 data-id="heading-25">步骤1：创建Mock目录和文件</h3>
<p>Mock数据用于在开发阶段模拟后端API响应，实现前后端并行开发。</p>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建mock目录</span>
<span class="hljs-built_in">mkdir</span> mock

<span class="hljs-comment"># 创建user mock文件</span>
<span class="hljs-built_in">touch</span> mock/user.ts
</code></pre>
<h3 data-id="heading-26">步骤2：配置Mock数据</h3>
<p>编辑mock/user.ts文件：</p>
<p>typescript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/*
 * @Description: Stay hungry，Stay foolish
 * @Author: Huccct
 * @Date: 2024-03-21
 */</span>

<span class="hljs-comment">// 模拟用户列表数据</span>
<span class="hljs-keyword">const</span> userList = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">username</span>: <span class="hljs-string">'admin'</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">'123456'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'超级管理员'</span>,
    <span class="hljs-attr">phone</span>: <span class="hljs-string">'13800138000'</span>,
    <span class="hljs-attr">roleName</span>: <span class="hljs-string">'超级管理员'</span>,
    <span class="hljs-attr">createTime</span>: <span class="hljs-string">'2024-03-21'</span>,
    <span class="hljs-attr">updateTime</span>: <span class="hljs-string">'2024-03-21'</span>,
    <span class="hljs-attr">status</span>: <span class="hljs-number">1</span>,
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">username</span>: <span class="hljs-string">'test'</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">'123456'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'测试用户'</span>,
    <span class="hljs-attr">phone</span>: <span class="hljs-string">'13800138001'</span>,
    <span class="hljs-attr">roleName</span>: <span class="hljs-string">'普通管理员'</span>,
    <span class="hljs-attr">createTime</span>: <span class="hljs-string">'2024-03-21'</span>,
    <span class="hljs-attr">updateTime</span>: <span class="hljs-string">'2024-03-21'</span>,
    <span class="hljs-attr">status</span>: <span class="hljs-number">1</span>,
  },
]

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  <span class="hljs-comment">// 用户登录接口</span>
  {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/user/login'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'post'</span>,
    <span class="hljs-attr">response</span>: <span class="hljs-function">(<span class="hljs-params">{ body }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> { username, password } = body
      <span class="hljs-keyword">const</span> checkUser = userList.<span class="hljs-title function_">find</span>(
        <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">username</span> === username &amp;&amp; item.<span class="hljs-property">password</span> === password,
      )
      <span class="hljs-keyword">if</span> (!checkUser) {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">code</span>: <span class="hljs-number">201</span>, <span class="hljs-attr">data</span>: { <span class="hljs-attr">message</span>: <span class="hljs-string">'账号或者密码不正确'</span> } }
      }
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">data</span>: {<span class="hljs-attr">token</span>:<span class="hljs-string">'Admin Token'</span> }}
    },
  },
  <span class="hljs-comment">// 获取用户信息</span>
  {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/user/info'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'get'</span>,
    <span class="hljs-attr">response</span>: <span class="hljs-function">(<span class="hljs-params">request</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> token = request.<span class="hljs-property">headers</span>.<span class="hljs-property">token</span>
      <span class="hljs-keyword">if</span> (token === <span class="hljs-string">'Admin Token'</span>) {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
          <span class="hljs-attr">data</span>: {
            <span class="hljs-attr">name</span>: <span class="hljs-string">'admin'</span>,
            <span class="hljs-attr">avatar</span>:
              <span class="hljs-string">'https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif'</span>,
            <span class="hljs-attr">roles</span>: [<span class="hljs-string">'admin'</span>],
            <span class="hljs-attr">buttons</span>: [<span class="hljs-string">'cuser.detail'</span>],
            <span class="hljs-attr">routes</span>: [
              <span class="hljs-string">'home'</span>,
              <span class="hljs-string">'Acl'</span>,
              <span class="hljs-string">'User'</span>,
              <span class="hljs-string">'Role'</span>,
              <span class="hljs-string">'Permission'</span>,
              <span class="hljs-string">'Product'</span>,
              <span class="hljs-string">'Trademark'</span>,
              <span class="hljs-string">'Attr'</span>,
              <span class="hljs-string">'Spu'</span>,
              <span class="hljs-string">'Sku'</span>,
            ],
          },
          <span class="hljs-attr">message</span>: <span class="hljs-string">'获取用户信息成功'</span>,
        }
      }
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">code</span>: <span class="hljs-number">201</span>,
        <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">'获取用户信息失败'</span>,
      }
    },
  },
  <span class="hljs-comment">// 获取用户列表</span>
  {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/acl/user/:page/:limit'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'get'</span>,
    <span class="hljs-attr">response</span>: <span class="hljs-function">(<span class="hljs-params">{ query }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> { username } = query
      <span class="hljs-keyword">let</span> filteredList = userList
      <span class="hljs-keyword">if</span> (username) {
        filteredList = userList.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span>
          user.<span class="hljs-property">username</span>.<span class="hljs-title function_">includes</span>(username),
        )
      }
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">data</span>: {
          <span class="hljs-attr">records</span>: filteredList,
          <span class="hljs-attr">total</span>: filteredList.<span class="hljs-property">length</span>,
        },
      }
    },
  },
  <span class="hljs-comment">// 添加/更新用户</span>
  {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/acl/user/save'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'post'</span>,
    <span class="hljs-attr">response</span>: <span class="hljs-function">(<span class="hljs-params">{ body }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> newUser = {
        ...body,
        <span class="hljs-attr">id</span>: userList.<span class="hljs-property">length</span> + <span class="hljs-number">1</span>,
        <span class="hljs-attr">createTime</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">'T'</span>)[<span class="hljs-number">0</span>],
        <span class="hljs-attr">updateTime</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">'T'</span>)[<span class="hljs-number">0</span>],
        <span class="hljs-attr">status</span>: <span class="hljs-number">1</span>,
      }
      userList.<span class="hljs-title function_">push</span>(newUser)
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'添加成功'</span> }
    },
  },
  {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/acl/user/update'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'put'</span>,
    <span class="hljs-attr">response</span>: <span class="hljs-function">(<span class="hljs-params">{ body }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> index = userList.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">id</span> === body.<span class="hljs-property">id</span>)
      <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) {
        userList[index] = {
          ...userList[index],
          ...body,
          <span class="hljs-attr">updateTime</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">'T'</span>)[<span class="hljs-number">0</span>],
        }
      }
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'更新成功'</span> }
    },
  },
  <span class="hljs-comment">// 删除用户</span>
  {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/acl/user/remove/:id'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'delete'</span>,
    <span class="hljs-attr">response</span>: <span class="hljs-function">(<span class="hljs-params">request</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> id = request.<span class="hljs-property">query</span>.<span class="hljs-property">id</span>
      <span class="hljs-keyword">if</span> (!id) {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">code</span>: <span class="hljs-number">201</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'参数错误'</span> }
      }
      <span class="hljs-keyword">const</span> index = userList.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id))
      <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) {
        userList.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'删除成功'</span> }
      }
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">code</span>: <span class="hljs-number">201</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'用户不存在'</span> }
    },
  },
  <span class="hljs-comment">// 批量删除用户</span>
  {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/acl/user/batchRemove'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'delete'</span>,
    <span class="hljs-attr">response</span>: <span class="hljs-function">(<span class="hljs-params">{ body }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> { idList } = body
      idList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> index = userList.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">id</span> === id)
        <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) {
          userList.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)
        }
      })
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'批量删除成功'</span> }
    },
  },
  <span class="hljs-comment">// 获取用户角色</span>
  {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/acl/user/toAssign/:userId'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'get'</span>,
    <span class="hljs-attr">response</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">data</span>: {
          <span class="hljs-attr">assignRoles</span>: [
            {
              <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
              <span class="hljs-attr">roleName</span>: <span class="hljs-string">'超级管理员'</span>,
              <span class="hljs-attr">createTime</span>: <span class="hljs-string">'2024-03-21'</span>,
              <span class="hljs-attr">updateTime</span>: <span class="hljs-string">'2024-03-21'</span>,
            },
          ],
          <span class="hljs-attr">allRolesList</span>: [
            {
              <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
              <span class="hljs-attr">roleName</span>: <span class="hljs-string">'超级管理员'</span>,
              <span class="hljs-attr">createTime</span>: <span class="hljs-string">'2024-03-21'</span>,
              <span class="hljs-attr">updateTime</span>: <span class="hljs-string">'2024-03-21'</span>,
            },
            {
              <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
              <span class="hljs-attr">roleName</span>: <span class="hljs-string">'普通管理员'</span>,
              <span class="hljs-attr">createTime</span>: <span class="hljs-string">'2024-03-21'</span>,
              <span class="hljs-attr">updateTime</span>: <span class="hljs-string">'2024-03-21'</span>,
            },
          ],
        },
      }
    },
  },
  <span class="hljs-comment">// 分配用户角色</span>
  {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/acl/user/doAssignRole'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'post'</span>,
    <span class="hljs-attr">response</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'分配角色成功'</span> }
    },
  },
  <span class="hljs-comment">// 用户登出接口</span>
  {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/user/logout'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'post'</span>,
    <span class="hljs-attr">response</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'退出成功'</span> }
    },
  },
]

</code></pre>
<h2 data-id="heading-27">第九章：总结</h2>
<p>至此，你已经完成了Guigu致选平台项目的初始化配置。通过这个一步一步的教程，你应该能够：</p>
<ol>
<li>✅ 使用create-vue脚手架创建项目</li>
<li>✅ 按照项目文档配置所有依赖</li>
<li>✅ 设置TypeScript和Vite配置</li>
<li>✅ 配置Element Plus和图标</li>
<li>✅ 设置Mock数据服务</li>
<li>✅ 创建基础的项目结构</li>
<li>✅ 启动并验证项目运行</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[v-bind 你用对了吗？]]></title>    <link>https://juejin.cn/post/7602554905271582720</link>    <guid>https://juejin.cn/post/7602554905271582720</guid>    <pubDate>2026-02-04T11:18:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602554905271582720" data-draft-id="7602824293164466191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="v-bind 你用对了吗？"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-02-04T11:18:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SuperEugene"/> <meta itemprop="url" content="https://juejin.cn/user/2366613652515256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            v-bind 你用对了吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2366613652515256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SuperEugene
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T11:18:38.000Z" title="Wed Feb 04 2026 11:18:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">先极简总结（2 句话记死，终身受用）</h2>
<ol>
<li><strong>绑 1 个属性</strong>：用缩写 <strong><code>:属性名="值"</code></strong>（原生标签 / Vue 组件通用，日常 90% 用这个）；</li>
<li><strong>绑 N 个属性</strong>：用 <strong><code>v-bind="属性对象"</code></strong>（无冒号、无属性名，属性越多越简洁，封装组件 / 配置驱动场景必用）。</li>
</ol>
<h3 data-id="heading-1">核心前提先讲透（一句话干货）</h3>
<ul>
<li><code>v-bind</code>是 Vue 用来给<strong>HTML 标签 / Vue 组件</strong>绑定<strong>动态属性值</strong>的指令，只有 2 种核心用法，本质都是「动态传值」，区别仅在于<strong>绑 1 个属性</strong>还是<strong>绑多个属性</strong></li>
</ul>
<ol>
<li>
<p><strong>单个属性绑定</strong>：<code>v-bind:属性名="值"</code> → 缩写 <strong><code>:属性名="值"</code></strong>（日常 90% 高频用）；</p>
</li>
<li>
<p><strong>批量属性绑定</strong>：直接<code>v-bind="属性对象"</code>（无属性名、无冒号，把多个属性打包成对象一次性绑定）；</p>
</li>
</ol>
<p>关键：批量绑定的<code>属性对象</code>，<strong>键 = HTML 标签 / Vue 组件的属性名</strong>，<strong>值 = 要绑定的动态数据</strong>，Vue 会自动解析成「键 = 值」的单个属性，一一绑定到标签上。</p>
<h2 data-id="heading-2">例子 ：原生<code>img</code>图片标签（最易理解的通用场景）</h2>
<p><code>img</code>标签的<code>src</code>（图片地址）、<code>alt</code>（占位文字）、<code>width</code>（宽度）是所有人都认识的原生属性，用它举例最直观，重点看<strong>单个绑定</strong>和<strong>批量绑定</strong>的等价关系。</p>
<h3 data-id="heading-3">步骤 ：先定义 Vue 里的动态数据（脚本部分，通用）</h3>
<pre><code class="hljs language-js" lang="js">&lt;script setup&gt; 
    <span class="hljs-comment">// Vue3基础响应式数据，不用纠结ref，知道是动态值就行 </span>
    <span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span> 
    <span class="hljs-comment">// 图片地址 </span>
    <span class="hljs-keyword">const</span> imgUrl = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'https://picsum.photos/200/200'</span>)
    <span class="hljs-comment">// 图片占位文字 </span>
    <span class="hljs-keyword">const</span> imgText = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'风景图'</span>) 
    <span class="hljs-comment">// 图片宽度 </span>
    <span class="hljs-keyword">const</span> imgW = <span class="hljs-title function_">ref</span>(<span class="hljs-number">200</span>)
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-4">用法 1：单个属性绑定（缩写<code>:</code>，逐个绑）</h3>
<p>最常用的写法，给<code>img</code><strong>逐个绑定</strong>动态属性，每个属性都用<code>:</code>缩写，模板清晰：</p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt; 
    &lt;!-- 核心：每个原生属性前加:，绑定对应的动态值 --&gt; 
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"imgUrl"</span> <span class="hljs-attr">:alt</span>=<span class="hljs-string">"imgText"</span> <span class="hljs-attr">:width</span>=<span class="hljs-string">"imgW"</span> /&gt;</span></span> 
&lt;/template&gt;
</code></pre>
<p>等价于完整<code>v-bind</code>写法（繁琐，几乎没人用）：</p>
<pre><code class="hljs language-js" lang="js">&lt;script setup&gt; 
    <span class="hljs-keyword">import</span> { ref, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span> 
    <span class="hljs-comment">// 1. 先定义零散动态值 </span>
    <span class="hljs-keyword">const</span> imgUrl = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'https://picsum.photos/200/200'</span>) 
    <span class="hljs-keyword">const</span> imgText = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'风景图'</span>) 
    <span class="hljs-keyword">const</span> imgW = <span class="hljs-title function_">ref</span>(<span class="hljs-number">200</span>) 
    <span class="hljs-comment">// 2. 打包成「属性对象」：键=img原生属性名，值=动态值 </span>
    <span class="hljs-keyword">const</span> imgProps = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">src</span>: imgUrl, <span class="hljs-attr">alt</span>: imgText, <span class="hljs-attr">width</span>: imgW }) 
&lt;/script&gt; 
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span> 
    <span class="hljs-comment">&lt;!-- 核心：无属性名、无冒号，v-bind直接绑属性对象 --&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"imgProps"</span> /&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-5">用法 2：批量属性绑定（<code>v-bind="对象"</code>，打包绑）</h3>
<p>把<code>img</code>需要的<strong>所有动态属性</strong>打包成一个<strong>对象</strong>，用<code>v-bind</code>直接绑定这个对象，Vue 会自动解析：</p>
<pre><code class="hljs language-js" lang="js">&lt;script setup&gt; 
    <span class="hljs-keyword">import</span> { ref, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span> 
    <span class="hljs-comment">// 1. 先定义零散动态值 </span>
    <span class="hljs-keyword">const</span> imgUrl = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'https://picsum.photos/200/200'</span>) 
    <span class="hljs-keyword">const</span> imgText = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'风景图'</span>) 
    <span class="hljs-keyword">const</span> imgW = <span class="hljs-title function_">ref</span>(<span class="hljs-number">200</span>) 
    <span class="hljs-comment">// 2. 打包成「属性对象」：键=img原生属性名，值=动态值 </span>
    <span class="hljs-keyword">const</span> imgProps = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">src</span>: imgUrl, <span class="hljs-attr">alt</span>: imgText, <span class="hljs-attr">width</span>: imgW }) 
&lt;/script&gt; 
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span> 
    <span class="hljs-comment">&lt;!-- 核心：无属性名、无冒号，v-bind直接绑属性对象 --&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"imgProps"</span> /&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<p><strong>完全等价于单个绑定的写法</strong>，Vue 会自动把<code>imgProps</code>里的<code>src/alt/width</code>逐个绑定到<code>img</code>标签上，效果一模一样。</p>
<p>单个和批量这两种用法是 Vue 最基础、最高频的语法，不用记复杂概念，只要知道「单个用:，多个用 v-bind = 对象」，就能搞定所有动态属性绑定场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 组件 API 覆盖率工具]]></title>    <link>https://juejin.cn/post/7602841282802040873</link>    <guid>https://juejin.cn/post/7602841282802040873</guid>    <pubDate>2026-02-04T12:19:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602841282802040873" data-draft-id="7602814773496660010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 组件 API 覆盖率工具"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2026-02-04T12:19:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="yddddddddddur"/> <meta itemprop="url" content="https://juejin.cn/user/4283353030463207"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 组件 API 覆盖率工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4283353030463207/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    yddddddddddur
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T12:19:13.000Z" title="Wed Feb 04 2026 12:19:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在组件开发中，我们经常面临一个问题：组件测试是否真正覆盖了组件的所有 API，传统的代码覆盖率工具只能告诉我们代码行数的覆盖情况，却无法准确反映组件的 Props、Events、Slots 和 Exposed Methods 是否被充分测试。</p>
<h3 data-id="heading-1">传统代码覆盖率的局限性</h3>
<p>传统的代码覆盖率工具（如 Istanbul、nyc 等）虽然能够统计代码行的执行情况，但在组件测试场景下存在明显的不足。它们无法检查出以下这些问题：</p>
<ul>
<li><strong>无法追踪对象的某个 key 是否被使用</strong>：这是根本性的限制。传统工具只能知道某行代码被执行了，但无法精确追踪对象的哪些属性被访问。例如，组件的 props 对象被传递了，但不知道具体哪些 prop 键被使用</li>
<li><strong>无法</strong> <strong>测试</strong> <strong>是否遗漏了 Slots 的</strong> <strong>TS</strong> <strong>类型定义</strong>：组件有测试 slots 的功能，但没有声明 slots 的类型</li>
<li><strong>无法找出是否存在冗余的 Props</strong>：定义了某些 props，但未被实际使用</li>
<li><strong>无法检查 Props 的所有枚举值是否都</strong> <strong>测试</strong> <strong>过</strong>：例如 <code>type: 'primary' | 'ghost' | 'dashed'</code> 这种联合类型，可能只测试了 <code>'primary'</code>，而遗漏了其他变体</li>
<li><strong>无法检查 Props 的所有类型是否都</strong> <strong>测试</strong> <strong>过</strong>：例如 <code>value</code> 可能接受 <code>Boolean | String | Number | Array</code>，但测试中只传了字符串</li>
</ul>
<p>这些问题在组件库开发中尤为突出。一个看似 90% 代码覆盖率的组件，实际上可能有大量未经测试的 API 边界情况。传统覆盖率工具基于代码执行行数统计，而组件 API 测试需要的是<strong>基于类型系统和对象属性的精确追踪</strong>。</p>
<h3 data-id="heading-2">实践中的困境</h3>
<p>在早期做公司内部组件库的时候，我们也开启过一轮对组件 API 覆盖率的人工检查。然而，由于组件 API 过多，检查过程极其困难，最终总会有许多漏写的单元测试。人工核对的方式不仅效率低下，而且容易遗漏，标准也难以统一。</p>
<p>为了解决这个问题，我在半年前用 AI 开发了 <code>vc-api-coverage</code>，一个专门为 Vue 3 TSX 组件设计的 API 覆盖率分析工具。本文将深入剖析这个工具的技术实现原理，分享如何利用 TypeScript 类型系统和 AST 分析来实现精准的 API 覆盖率检测。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e00e673a6a8b4a528ab2abbeff6b335f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWRkZGRkZGRkZGR1cg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770812742&amp;x-signature=tli7513bufeQVOtLkDt7R%2BYtUb8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">核心设计思路</h2>
<p>这个工具的核心理念是：<strong>通过静态分析组件定义和</strong> <strong>测试</strong> <strong>代码，建立组件 API 与测试用例之间的映射关系</strong>。</p>
<h3 data-id="heading-4">设计理念</h3>
<p>在大学学过的一门项目管理课程中，讲到了"设备点检"，这是一种预防性设备维护管理制度。通过<strong>定期、定点、定标、定人、定法</strong>的方式对设备进行检查，以确保设备正常运行。</p>
<p>这个覆盖率工具的设计思路与"设备点检"有异曲同工之妙，主要对<strong>定标、定法、定期</strong>这3个环节进行了强化：</p>
<ul>
<li><strong>定标</strong>：将原本模糊、可完成可不完成的测试标准，变成一个明确、量化、强制的标准（如：100% API 覆盖率）。</li>
<li><strong>定法</strong>：将对api覆盖率的手动检查，变成程序自动化的检查。</li>
<li><strong>定期</strong>：将原本一次性的检查，变成CI流水线的周期检查。</li>
</ul>
<p>通过工具化的方式，我们把主观的人工检查转变为客观的自动化检测，把模糊的质量要求转变为精确的量化指标。</p>
<h3 data-id="heading-5">整体架构</h3>
<p>整体架构分为三个核心模块：</p>
<ol>
<li><strong>ComponentAnalyzer</strong>：分析组件定义，提取所有可用的 API</li>
<li><strong>UnitTestAnalyzer</strong>：分析测试代码，识别哪些 API 被测试覆盖</li>
<li><strong>Reporter</strong>：生成可视化的覆盖率报告（CLI、HTML、JSON）</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e4de79e90ea4af393d58cef7a59f0ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWRkZGRkZGRkZGR1cg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770812742&amp;x-signature=5mZVIy7r1Ghn8GwSFFyPsy6IN%2Bo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">技术选型</h2>
<p>在开始介绍具体实现之前，先分享一下技术选型过程中的弯路和思考。</p>
<h3 data-id="heading-7">早期方案</h3>
<p>最初设计这个覆盖率工具时，我的想法是通过 AST（抽象语法树）去分析组件代码，直接提取出 Props、Slots 和 Exposed Methods。这个方案看起来很直接，但在实践中遇到了巨大的挑战：</p>
<p><strong>Vue 组件的写法复杂多变，静态分析难以覆盖所有场景：</strong></p>
<ol>
<li><strong>多种 API 风格</strong>：组件既可以用 Composition API 的 <code>setup</code> 写法，也可以用 Options API 写法</li>
<li><strong>运行时配置</strong>：组件可能配置了 <code>mixins</code>、<code>extends</code> 等，这些内容需要递归分析多个文件</li>
<li><strong>动态计算的 Props</strong>：有些组件的 props 需要运行时才能确定，例如使用 <code>lodash.pick</code> 从另一个对象选取部分 props：</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { pick } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>;
<span class="hljs-keyword">const</span> baseProps = { <span class="hljs-attr">a</span>: <span class="hljs-title class_">String</span>, <span class="hljs-attr">b</span>: <span class="hljs-title class_">Number</span>, <span class="hljs-attr">c</span>: <span class="hljs-title class_">Boolean</span> };
<span class="hljs-keyword">const</span> componentProps = <span class="hljs-title function_">pick</span>(baseProps, [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>]); <span class="hljs-comment">// 静态分析无法得知结果</span>
</code></pre>
<p>4.  <strong>类型信息丢失</strong>：纯 AST 分析只能看到代码结构，很难准确推断出 union 类型、可选属性等类型信息</p>
<p>经过几次尝试，发现要覆盖所有 Vue 组件的写法，需要实现一个接近完整的 Vue 编译器，这显然不现实。</p>
<h3 data-id="heading-8">最终方案</h3>
<p>后来换了一个思路：<strong>既然 Vue 3 组件本身就有完整的类型定义，为什么不直接利用 TypeScript 的类型系统呢？</strong></p>
<p>这个方案的优势非常明显：</p>
<ul>
<li><strong>统一的接口</strong>：无论组件怎么写（setup、options、mixins），最终都会生成统一的组件类型，TypeScript 编译器已经帮我们处理好了所有复杂情况</li>
<li><strong>完整的类型信息</strong>：可以直接获取 union 类型、可选属性、泛型参数等完整的类型信息</li>
<li><strong>简单快捷</strong>：通过 <code>InstanceType&lt;typeof Component&gt;['$props']</code> 就能获取所有 props，无需关心组件内部实现</li>
<li><strong>零维护成本</strong>：随着 Vue 版本升级，只要类型定义更新了，工具就能自动适配</li>
</ul>
<p>这就是为什么最终选择了"类型系统 + AST"的混合方案：</p>
<ul>
<li>用<strong>类型系统</strong>提取 Props、Events、Slots（简单可靠）</li>
<li>用 <strong>AST</strong> 提取单元测试代码（类型系统无法覆盖的场景）</li>
</ul>
<p><strong>技术选型的启示</strong>：不要试图重新实现已有的轮子。TypeScript 编译器已经解决了类型推断的复杂问题，我们应该站在巨人的肩膀上。</p>
<h2 data-id="heading-9">技术实现详解</h2>

<h3 data-id="heading-10">组件 API 提取</h3>
<p>组件的 Props、Events 和 Slots 信息隐藏在 Vue 组件的类型定义中，见<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fplay%2F%3F%23code%2FJYWwDg9gTgLgBAbzgEwKYDNgDtUGELgQ5YwA0cAClBGACoCeYq5AygDYQwDODT5AagDkIaOAF846aiDgByAG4BXVLIDcAKHUBjIl3j5wcALwoM2PAUjEYACgTq4juGGpguALkQOnP9BAie9j7BTjCMqJ4A2iwwUNgA5uSCiiAARqhQALreIWKkOcGpAIZQgQUhjmFMnjFxWPFwRVyUrryoADyyxVAAjLJwAD5y3QBMsgB85U5iBXkFqCDA3GUVcAtLAGL%2BnjZFnnp18QCUxuNwscr5PnM%2BXBzLcADyqQBWqFrwTXDsnDzh7UEKgALVBFNClOA2PwBOAHBInIxnIQiVCzcZXJyoAAekC4ETgkQURTYwGQRRgKky%2BTER00VVQzlczRMAEksHoilgtKg2u16RB0HADGBxoSACQuGhcWTZemw%2B7MuBsjlcnn-fmC4Wi2Riu6-GWaIA" target="_blank" title="https://www.typescriptlang.org/play/?#code/JYWwDg9gTgLgBAbzgEwKYDNgDtUGELgQ5YwA0cAClBGACoCeYq5AygDYQwDODT5AagDkIaOAF846aiDgByAG4BXVLIDcAKHUBjIl3j5wcALwoM2PAUjEYACgTq4juGGpguALkQOnP9BAie9j7BTjCMqJ4A2iwwUNgA5uSCiiAARqhQALreIWKkOcGpAIZQgQUhjmFMnjFxWPFwRVyUrryoADyyxVAAjLJwAD5y3QBMsgB85U5iBXkFqCDA3GUVcAtLAGL+njZFnnp18QCUxuNwscr5PnM+XBzLcADyqQBWqFrwTXDsnDzh7UEKgALVBFNClOA2PwBOAHBInIxnIQiVCzcZXJyoAAekC4ETgkQURTYwGQRRgKky+TER00VVQzlczRMAEksHoilgtKg2u16RB0HADGBxoSACQuGhcWTZemw+7MuBsjlcnn-fmC4Wi2Riu6-GWaIA" ref="nofollow noopener noreferrer">TS Playground示例</a>。我们利用 <code>ts-morph</code> 库来访问 TypeScript 的类型系统：</p>
<h4 data-id="heading-11">1. Props/Events 提取</h4>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// src/analyzer/ComponentAnalyzer.ts:30</span>
<span class="hljs-title function_">analyzePropsAndEmits</span>(<span class="hljs-params">instanceType: Type, exportedExpression: Expression</span>) {
    <span class="hljs-comment">// 通过 $props 属性获取组件的所有 props</span>
    <span class="hljs-keyword">const</span> dollarPropsSymbol = instanceType.<span class="hljs-title function_">getProperty</span>(<span class="hljs-string">'$props'</span>);
    <span class="hljs-keyword">if</span> (!dollarPropsSymbol) returnconst dollarPropsType = dollarPropsSymbol.<span class="hljs-title function_">getTypeAtLocation</span>(exportedExpression);
    dollarPropsType.<span class="hljs-title function_">getProperties</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">propSymbol</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> propName = propSymbol.<span class="hljs-title function_">getName</span>();
        <span class="hljs-comment">// 过滤内部属性</span>
        <span class="hljs-keyword">if</span> (!internalProps.<span class="hljs-title function_">includes</span>(propName)) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-title function_">add</span>(propName);
        }
    });
}
</code></pre>
<p><strong>核心原理</strong>：Vue 3 组件通过 <code>InstanceType&lt;typeof Component&gt;['$props']</code> 暴露了所有 props 的类型信息。我们直接访问这个类型，遍历其所有属性，就能获得完整的 props 列表。</p>
<h4 data-id="heading-12">2. Slots 提取</h4>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// src/analyzer/ComponentAnalyzer.ts:157</span>
<span class="hljs-title function_">analyzeSlots</span>(<span class="hljs-params">instanceType: Type, exportedExpression: Expression</span>) {
    <span class="hljs-keyword">const</span> dollarPropsSymbol = instanceType.<span class="hljs-title function_">getProperty</span>(<span class="hljs-string">'$slots'</span>);
    <span class="hljs-keyword">if</span> (!dollarPropsSymbol) returnconst dollarPropsType = dollarPropsSymbol.<span class="hljs-title function_">getTypeAtLocation</span>(exportedExpression);
    dollarPropsType.<span class="hljs-title function_">getProperties</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">propSymbol</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> propName = propSymbol.<span class="hljs-title function_">getName</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">slots</span>.<span class="hljs-title function_">add</span>(propName);
    });
}
</code></pre>
<p><strong>核心原理</strong>：与 props 类似，通过 <code>$slots</code> 属性获取所有插槽的类型定义。</p>
<h4 data-id="heading-13">3. Exposed Methods 提取</h4>
<p>Exposed methods无法从 TypeScript 类型系统中获取，我们采用了 AST 代码分析的方法：</p>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// src/analyzer/ComponentAnalyzer.ts:176</span>
<span class="hljs-title function_">analyzeExposeContextCalls</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 方法1: 检测 expose({ ... }) 调用</span>
    <span class="hljs-keyword">const</span> matches = <span class="hljs-variable language_">this</span>.<span class="hljs-property">code</span>.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/expose(\s*{([^}]+)}\s*)/g</span>);

    <span class="hljs-keyword">if</span> (matches &amp;&amp; matches.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> match <span class="hljs-keyword">of</span> matches) {
            <span class="hljs-keyword">const</span> propsStr = match.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/expose(\s*{/</span>, <span class="hljs-string">''</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/}\s*)/</span>, <span class="hljs-string">''</span>);
            <span class="hljs-keyword">const</span> propMatches = propsStr.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/(\w+),?/g</span>);

            <span class="hljs-keyword">if</span> (propMatches) {
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> prop <span class="hljs-keyword">of</span> propMatches) {
                    <span class="hljs-keyword">const</span> cleanProp = prop.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/,/g</span>, <span class="hljs-string">''</span>).<span class="hljs-title function_">trim</span>();
                    <span class="hljs-keyword">if</span> (cleanProp) {
                        <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span>.<span class="hljs-title function_">add</span>(cleanProp);
                    }
                }
            }
        }
    }
}
</code></pre>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// src/analyzer/ComponentAnalyzer.ts:202</span>
<span class="hljs-title function_">analyzeExposeArrayOption</span>(<span class="hljs-params">exportedExpression: Expression</span>) {
    <span class="hljs-comment">// 方法2: 检测 defineComponent({ expose: ['method1', 'method2'] })</span>
    <span class="hljs-keyword">const</span> componentOptions = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getComponentOptions</span>(exportedExpression);
    <span class="hljs-keyword">if</span> (!componentOptions) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> exposeArray = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getExposeArrayFromOptions</span>(componentOptions);
    <span class="hljs-keyword">if</span> (!exposeArray) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> exposeItems = exposeArray.<span class="hljs-title function_">getElements</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> exposeItems) {
        <span class="hljs-keyword">const</span> itemName = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getItemName</span>(item);
        <span class="hljs-keyword">if</span> (itemName) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span>.<span class="hljs-title function_">add</span>(itemName);
        }
    }
}
</code></pre>
<p><strong>核心原理</strong>：</p>
<ol>
<li>通过正则表达式匹配 <code>expose({ ... })</code> 调用</li>
<li>通过 AST 分析 <code>defineComponent</code> 的 <code>expose</code> 选项</li>
<li>支持多种写法：字符串字面量、标识符、枚举值等</li>
</ol>

<h3 data-id="heading-14">测试覆盖分析</h3>
<p>测试代码有多种写法，我们需要支持各种常见的测试模式。</p>
<h4 data-id="heading-15">模式 1：传统 mount 方法</h4>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// 测试代码</span>
<span class="hljs-title function_">mount</span>(<span class="hljs-title class_">Button</span>, {
  <span class="hljs-attr">props</span>: { <span class="hljs-attr">variant</span>: <span class="hljs-string">'primary'</span>, <span class="hljs-attr">disabled</span>: <span class="hljs-literal">true</span> },
  <span class="hljs-attr">slots</span>: { <span class="hljs-attr">default</span>: <span class="hljs-string">'Click me'</span> }
});
</code></pre>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// src/analyzer/UnitTestAnalyzer.ts:186</span>
<span class="hljs-title function_">processMountComponent</span>(<span class="hljs-params">componentArgNode: Node, optionsNode?: ObjectLiteralExpression</span>) {
    <span class="hljs-keyword">if</span> (!optionsNode) returnconst componentName = componentArgNode.<span class="hljs-title function_">getText</span>();
    <span class="hljs-keyword">const</span> componentFile = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolveComponentPath</span>(componentArgNode <span class="hljs-keyword">as</span> <span class="hljs-title class_">Identifier</span>);

    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>[componentFile]) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>[componentFile] = {};
    }

    <span class="hljs-comment">// 提取 props、emits、slots</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractProps</span>(optionsNode, <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>[componentFile]);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractEmits</span>(optionsNode, <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>[componentFile]);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractSlots</span>(optionsNode, <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>[componentFile]);
}
</code></pre>
<h4 data-id="heading-16">模式 2：JSX 写法</h4>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// 测试代码</span>
<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">variant</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">disabled</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handler}</span>&gt;</span>
  Click me
<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>);
</code></pre>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// src/analyzer/UnitTestAnalyzer.ts:678</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">analyzeJSXElements</span>(<span class="hljs-params">callExpression: CallExpression</span>) {
    <span class="hljs-keyword">const</span> jsxElements = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findJsxInCallExpression</span>(callExpression);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> jsxElement <span class="hljs-keyword">of</span> jsxElements) {
        <span class="hljs-keyword">const</span> openingElement = <span class="hljs-title class_">Node</span>.<span class="hljs-title function_">isJsxElement</span>(jsxElement)
            ? jsxElement.<span class="hljs-title function_">getOpeningElement</span>()
            : jsxElement;

        <span class="hljs-keyword">const</span> tagName = openingElement.<span class="hljs-title function_">getTagNameNode</span>().<span class="hljs-title function_">getText</span>();
        <span class="hljs-keyword">const</span> filePath = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolveComponentPath</span>(openingElement.<span class="hljs-title function_">getTagNameNode</span>());

        <span class="hljs-comment">// 提取 JSX 属性作为 props</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractJSXAttrs</span>(openingElement, <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>[filePath]);

        <span class="hljs-comment">// 提取 JSX 子元素作为 slots</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Node</span>.<span class="hljs-title function_">isJsxElement</span>(jsxElement)) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractJSXSlots</span>(jsxElement, <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>[filePath]);
        }
    }
}
</code></pre>
<h4 data-id="heading-17">模式 3：Template 字符串</h4>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// 测试代码</span>
<span class="hljs-title function_">mount</span>({
  <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;Button variant="primary" @click="handler"&gt;Click me&lt;/Button&gt;'</span>,
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">Button</span> }
});
</code></pre>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// src/analyzer/UnitTestAnalyzer.ts:269</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">extractPropsFromTemplate</span>(<span class="hljs-params">template: <span class="hljs-built_in">string</span>, componentTagName: <span class="hljs-built_in">string</span>, componentTestUnit: TestUnit</span>) {
    <span class="hljs-comment">// 使用正则表达式解析模板中的属性</span>
    <span class="hljs-keyword">const</span> tagRegex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`&lt;<span class="hljs-subst">${componentTagName}</span>(\s+[^&gt;]*?)?&gt;`</span>, <span class="hljs-string">'ig'</span>);
    <span class="hljs-keyword">let</span> match;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">propsFound</span>: <span class="hljs-built_in">string</span>[] = [];

    <span class="hljs-keyword">while</span> ((match = tagRegex.<span class="hljs-title function_">exec</span>(template)) !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">const</span> attrsString = match[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">if</span> (!attrsString) <span class="hljs-keyword">continue</span>;

        <span class="hljs-comment">// 解析属性名</span>
        <span class="hljs-keyword">const</span> attrRegex = <span class="hljs-regexp">/([@:a-zA-Z0-9_-]+)(?:=(?:"[^"]*"|'[^']*'|[^\s&gt;]*))?/g</span>;
        <span class="hljs-keyword">let</span> attrMatch;
        <span class="hljs-keyword">while</span> ((attrMatch = attrRegex.<span class="hljs-title function_">exec</span>(attrsString)) !== <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">let</span> propName = attrMatch[<span class="hljs-number">1</span>];

            <span class="hljs-comment">// 处理 v-bind:, :, v-model: 等前缀</span>
            <span class="hljs-keyword">if</span> (propName.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">':'</span>)) {
                propName = propName.<span class="hljs-title function_">substring</span>(<span class="hljs-number">1</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (propName.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'v-bind:'</span>)) {
                propName = propName.<span class="hljs-title function_">substring</span>(<span class="hljs-number">7</span>);
            }

            propsFound.<span class="hljs-title function_">push</span>(propName);
        }
    }

    componentTestUnit.<span class="hljs-property">props</span> = [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([...(componentTestUnit.<span class="hljs-property">props</span> || []), ...propsFound])];
}
</code></pre>
<h4 data-id="heading-18">Exposed Methods 检测</h4>
<p>对于暴露的方法，我们采用了一个简单但有效的策略：<strong>方法名匹配</strong>。</p>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// src/analyzer/UnitTestAnalyzer.ts:1381</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">analyzeExposedMethods</span>(<span class="hljs-params">testCall: CallExpression</span>) {
    <span class="hljs-keyword">const</span> calledMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;();

    <span class="hljs-comment">// 查找所有属性访问表达式 (xxx.methodName)</span>
    <span class="hljs-keyword">const</span> propertyAccesses = testCall.<span class="hljs-title function_">getDescendantsOfKind</span>(<span class="hljs-title class_">SyntaxKind</span>.<span class="hljs-property">PropertyAccessExpression</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> access <span class="hljs-keyword">of</span> propertyAccesses) {
        <span class="hljs-keyword">const</span> methodName = access.<span class="hljs-title function_">getName</span>();

        <span class="hljs-comment">// 检查是否为暴露的方法</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isExposedMethod</span>(methodName)) {
            calledMethods.<span class="hljs-title function_">add</span>(methodName);
        }
    }

    <span class="hljs-comment">// 将这些方法添加到组件的覆盖记录中</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> componentFile <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>[componentFile].<span class="hljs-property">exposes</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>[componentFile].<span class="hljs-property">exposes</span> = [];
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> method <span class="hljs-keyword">of</span> calledMethods) {
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>[componentFile].<span class="hljs-property">exposes</span>.<span class="hljs-title function_">includes</span>(method)) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>[componentFile].<span class="hljs-property">exposes</span>.<span class="hljs-title function_">push</span>(method);
            }
        }
    }
}
</code></pre>
<p><strong>核心原理</strong>：扫描测试代码中的所有属性访问表达式（如 <code>wrapper.vm.focus()</code>），提取方法名，然后过滤掉 Vue 内置方法和测试工具方法。</p>
<h3 data-id="heading-19">Strict Mode</h3>
<p>在严格模式下，我们不仅检测 prop 是否被测试，还会检测每个 union 类型的变体是否都被测试。</p>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// src/analyzer/ComponentAnalyzer.ts:42</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">strictMode</span>) {
    <span class="hljs-keyword">const</span> propType = propSymbol.<span class="hljs-title function_">getTypeAtLocation</span>(exportedExpression);
    <span class="hljs-keyword">const</span> nonNullableType = propType.<span class="hljs-title function_">getNonNullableType</span>();
    <span class="hljs-keyword">const</span> variants = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractVariantsFromType</span>(nonNullableType);

    <span class="hljs-keyword">if</span> (variants.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">propsWithVariants</span>.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">name</span>: propName,
            variants
        });
    }
}
</code></pre>
<h4 data-id="heading-20">Union 类型展开</h4>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// src/analyzer/ComponentAnalyzer.ts:62</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">extractVariantsFromType</span>(<span class="hljs-attr">type</span>: <span class="hljs-title class_">Type</span>): <span class="hljs-title class_">PropVariant</span>[] {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">variants</span>: <span class="hljs-title class_">PropVariant</span>[] = [];

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span>.<span class="hljs-title function_">isUnion</span>()) {
        <span class="hljs-keyword">const</span> unionTypes = <span class="hljs-keyword">type</span>.<span class="hljs-title function_">getUnionTypes</span>();

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> unionType <span class="hljs-keyword">of</span> unionTypes) {
            <span class="hljs-comment">// 跳过 undefined 和 null</span>
            <span class="hljs-keyword">if</span> (unionType.<span class="hljs-title function_">isUndefined</span>() || unionType.<span class="hljs-title function_">isNull</span>()) {
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">const</span> variant = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getVariantFromType</span>(unionType);
            <span class="hljs-keyword">if</span> (variant) {
                <span class="hljs-comment">// 跳过 false（boolean 类型只展开 true）</span>
                <span class="hljs-keyword">if</span> (!(variant.<span class="hljs-property">type</span> === <span class="hljs-string">'literal'</span> &amp;&amp; variant.<span class="hljs-property">value</span> === <span class="hljs-literal">false</span>)) {
                    variants.<span class="hljs-title function_">push</span>(variant);
                }
            }
        }
    }

    <span class="hljs-keyword">return</span> variants;
}
</code></pre>
<p><strong>核心原理</strong>：</p>
<ol>
<li>检测 prop 类型是否为 union 类型</li>
<li>遍历所有 union 成员，提取字面量值</li>
<li>Boolean 类型只展开 <code>true</code>（因为 <code>false</code> 通常是默认值）</li>
<li>过滤掉 <code>undefined</code> 和 <code>null</code></li>
</ol>

<h4 data-id="heading-21">测试值提取</h4>
<p>在测试代码中，我们需要提取实际传递的值：</p>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// src/analyzer/UnitTestAnalyzer.ts:942</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">extractPropValue</span>(<span class="hljs-attr">attr</span>: <span class="hljs-title class_">Node</span>): <span class="hljs-title class_">PropValue</span> | <span class="hljs-literal">null</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Node</span>.<span class="hljs-title function_">isJsxAttribute</span>(attr)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">const</span> propName = attr.<span class="hljs-title function_">getNameNode</span>().<span class="hljs-title function_">getText</span>();
    <span class="hljs-keyword">const</span> initializer = attr.<span class="hljs-title function_">getInitializer</span>();

    <span class="hljs-keyword">if</span> (!initializer) {
        <span class="hljs-comment">// 布尔属性 &lt;Button disabled /&gt;</span>
        <span class="hljs-keyword">return</span> { propName, <span class="hljs-attr">value</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'literal'</span> };
    }

    <span class="hljs-comment">// 字符串字面量</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Node</span>.<span class="hljs-title function_">isStringLiteral</span>(initializer)) {
        <span class="hljs-keyword">return</span> { propName, <span class="hljs-attr">value</span>: initializer.<span class="hljs-title function_">getLiteralValue</span>(), <span class="hljs-attr">type</span>: <span class="hljs-string">'literal'</span> };
    }

    <span class="hljs-comment">// JSX 表达式</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Node</span>.<span class="hljs-title function_">isJsxExpression</span>(initializer)) {
        <span class="hljs-keyword">const</span> expression = initializer.<span class="hljs-title function_">getExpression</span>();
        <span class="hljs-keyword">if</span> (!expression) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

        <span class="hljs-comment">// 数字、布尔等字面量</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Node</span>.<span class="hljs-title function_">isNumericLiteral</span>(expression)) {
            <span class="hljs-keyword">return</span> { propName, <span class="hljs-attr">value</span>: <span class="hljs-title class_">Number</span>(expression.<span class="hljs-title function_">getLiteralValue</span>()), <span class="hljs-attr">type</span>: <span class="hljs-string">'literal'</span> };
        }

        <span class="hljs-comment">// 处理变量：通过类型推断获取实际值</span>
        <span class="hljs-keyword">const</span> exprType = expression.<span class="hljs-title function_">getType</span>();
        <span class="hljs-keyword">if</span> (exprType.<span class="hljs-title function_">isLiteral</span>()) {
            <span class="hljs-keyword">const</span> literalValue = exprType.<span class="hljs-title function_">getLiteralValue</span>();
            <span class="hljs-keyword">if</span> (literalValue !== <span class="hljs-literal">undefined</span>) {
                <span class="hljs-keyword">return</span> { propName, <span class="hljs-attr">value</span>: literalValue, <span class="hljs-attr">type</span>: <span class="hljs-string">'literal'</span> };
            }
        }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>核心原理</strong>：</p>
<ol>
<li>直接提取字面量值</li>
<li>对于变量和表达式，利用 TypeScript 的类型推断获取值</li>
<li>支持 ref 值追踪、循环变量展开等复杂场景</li>
</ol>

<h3 data-id="heading-22">组件路径解析</h3>
<p>为了准确关联测试代码和组件定义，我们需要解析 import 语句，找到组件的真实路径：</p>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// src/analyzer/UnitTestAnalyzer.ts:89</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">resolveComponentPath</span>(<span class="hljs-params">identifier: Identifier, importSymbol?: <span class="hljs-built_in">Symbol</span></span>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">let</span> <span class="hljs-attr">originalSymbol</span>: <span class="hljs-title class_">Symbol</span> | <span class="hljs-literal">undefined</span> = importSymbol;
        <span class="hljs-keyword">if</span> (identifier) {
            <span class="hljs-keyword">const</span> typeChecker = <span class="hljs-variable language_">this</span>.<span class="hljs-property">project</span>.<span class="hljs-title function_">getTypeChecker</span>();
            originalSymbol = typeChecker.<span class="hljs-title function_">getSymbolAtLocation</span>(identifier);
        }
        <span class="hljs-keyword">if</span> (!originalSymbol) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

        <span class="hljs-comment">// 解析别名</span>
        <span class="hljs-keyword">while</span> (originalSymbol?.<span class="hljs-title function_">getAliasedSymbol</span>()) {
            originalSymbol = originalSymbol.<span class="hljs-title function_">getAliasedSymbol</span>();
        }

        <span class="hljs-keyword">if</span> (!originalSymbol) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">const</span> declarations = originalSymbol.<span class="hljs-title function_">getDeclarations</span>();
        <span class="hljs-keyword">const</span> declarationNode = declarations[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">if</span> (!declarationNode) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">const</span> declarationSourceFile = declarationNode.<span class="hljs-title function_">getSourceFile</span>();
        <span class="hljs-keyword">const</span> originalPath = declarationSourceFile.<span class="hljs-title function_">getFilePath</span>();

        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isComponentFile</span>(originalPath)) {
            <span class="hljs-comment">// 继续解析转发导出</span>
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolveTsPath</span>(declarationNode);
        }

        <span class="hljs-keyword">return</span> originalPath;
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p><strong>核心原理</strong>：</p>
<ol>
<li>
<p>从 identifier 获取 symbol</p>
</li>
<li>
<p>递归解析 alias symbol（处理 <code>export { Button as Btn }</code> 等情况）</p>
</li>
<li>
<p>获取原始声明文件路径</p>
</li>
<li>
<p>处理中间层的转发导出</p>
</li>
</ol>
<h2 data-id="heading-23">实际应用场景</h2>

<h3 data-id="heading-24">1. CI/CD 集成</h3>
<p>通过 <code>onFinished</code> 回调强制 100% 覆盖：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">test</span>: {
    <span class="hljs-attr">reporters</span>: [[<span class="hljs-string">'vc-api-coverage'</span>, {
      <span class="hljs-attr">onFinished</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> data) {
          <span class="hljs-keyword">if</span> (item.<span class="hljs-property">total</span> &gt; item.<span class="hljs-property">covered</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${item.name}</span> API Coverage is not 100%`</span>)
          }
        }
      }
    }]]
  }
})
</code></pre>
<h3 data-id="heading-25">2. 组件库开发</h3>
<p>对于组件库，确保每个组件的所有 API 都有测试覆盖：</p>
<pre><code class="hljs language-css" lang="css">reporters: [[<span class="hljs-string">'vc-api-coverage'</span>, {
  include: [<span class="hljs-string">'**/src/components/**/*.{tsx,vue}'</span>],
  format: [<span class="hljs-string">'cli'</span>, <span class="hljs-string">'html'</span>],
  openBrowser: true
}]]
</code></pre>
<h3 data-id="heading-26">3. 严格模式下的全面测试</h3>
<p>对关键组件使用严格模式，确保每个 prop 变体都被测试：</p>
<pre><code class="hljs language-lua" lang="lua">reporters: <span class="hljs-string">[['vc-api-coverage', {
  include: ['**/src/components/Button/**/*.tsx'],
  strict: true  // 开启严格模式
}]]</span>
</code></pre>
<h2 data-id="heading-27">总结</h2>
<p><code>vc-api-coverage</code> 通过巧妙地结合 TypeScript 类型系统和 AST 分析，实现了对 Vue 组件 API 覆盖率的精准检测。核心技术点包括：</p>
<ol>
<li><strong>类型系统利用</strong>：通过 <code>$props</code>、<code>$slots</code> 等类型属性提取组件 API</li>
<li><strong>多模式识别</strong>：支持 JSX、模板字符串、mount 对象等多种测试写法</li>
<li><strong>严格模式</strong>：细粒度追踪 union 类型的每个变体</li>
<li><strong>路径解析</strong>：递归追踪 import/export，准确关联测试和组件</li>
</ol>
<p>这个工具不仅提升了组件测试的质量，还为团队提供了可量化的测试指标，让"测试覆盖率"这个概念更加贴近前端组件开发的实际需求。</p>
<h2 data-id="heading-28">后记</h2>
<p>在目前 AI 辅助开发、Markdown 文档泛滥的场景下，其实开发一个<strong>强约束的工具</strong>也是一个不错的方向。相比于只能提供建议的文档和规范，带有强制检查能力的工具能够真正保证代码质量的底线。就像这个 API 覆盖率工具，它不是告诉你“应该写测试”，而是确保“必须写哪些测试”。</p>
<p>最后，感谢 Cursor 和 Claude Code 帮我完成了这个覆盖率工具和这篇分享文档。在 AI 辅助开发的时代，借助这些强大的工具，我们能够快速将想法转化为可用的产品。当然 AI 也不是万能，在某些场景下 AI i写的单测并没有实际测试到组件的功能，所以 AI 写的单测还是要让 AI 去review的。</p>
<h2 data-id="heading-29">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frudyxu1102%2Fvc-api-coverage" target="_blank" title="https://github.com/rudyxu1102/vc-api-coverage" ref="nofollow noopener noreferrer">vc-api-coverage GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fts-morph.com%2F" target="_blank" title="https://ts-morph.com/" ref="nofollow noopener noreferrer">ts-morph 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2FTypeScript%2Fwiki%2FUsing-the-Compiler-API" target="_blank" title="https://github.com/microsoft/TypeScript/wiki/Using-the-Compiler-API" ref="nofollow noopener noreferrer">TypeScript Compiler API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvitest.dev%2Fguide%2Freporters.html" target="_blank" title="https://vitest.dev/guide/reporters.html" ref="nofollow noopener noreferrer">Vitest Custom Reporter</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【性能优化】响应式图片]]></title>    <link>https://juejin.cn/post/7602816610931687487</link>    <guid>https://juejin.cn/post/7602816610931687487</guid>    <pubDate>2026-02-04T13:23:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602816610931687487" data-draft-id="7602776926328127542" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【性能优化】响应式图片"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-02-04T13:23:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="曾富贵"/> <meta itemprop="url" content="https://juejin.cn/user/4212984286289806"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【性能优化】响应式图片
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984286289806/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    曾富贵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T13:23:10.000Z" title="Wed Feb 04 2026 13:23:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在现代 Web 开发中，图片往往占据了页面总资源的 50% 以上。在移动设备和高分辨率屏幕普及的今天，如何让用户以最小的带宽成本获得最优的视觉体验，是性能优化中的关键课题。<strong>响应式图片</strong>正是解决这一问题的核心技术方案。</p>
<p><strong>手段</strong>（从<strong>手段</strong>上通过格式优化与按需加载选图）</p>
<ol>
<li><strong>格式优化</strong>：优先使用现代高效格式（AVIF、WebP），不支持则降级到传统格式（JPG、PNG）</li>
<li><strong>按需加载</strong>：根据图片显示尺寸（槽位分段适配）/视口宽度（视口分段适配）、设备像素比（DPR）选择最合适的图片资源</li>
</ol>
<p><strong>作用</strong>（从<strong>作用</strong>上减少带宽浪费、提升加载速度）</p>
<ol>
<li><strong>减少带宽浪费</strong>：避免在小屏设备上加载过大的图片，避免在低 DPR 设备上加载高清图片</li>
<li><strong>提升加载速度</strong>：更小的图片体积意味着更快的首屏渲染和更流畅的用户体验</li>
</ol>
<hr/>
<h2 data-id="heading-1">一、槽位适配（Slot-based Adaptation）</h2>
<p><strong>定义</strong>：以<strong>分段适配</strong>的方式，预先提供多档尺寸、多档 DPR 的候选图片，根据图片在页面中的<strong>实际显示宽度</strong>、**设备像素比（DPR）**选择最合适的一档资源。</p>
<p><strong>技术实现</strong>：通过 HTML 的 <code>&lt;picture&gt;</code> + <code>srcset</code> + <code>sizes</code> 属性实现。</p>
<p><strong>核心特性</strong>：</p>
<ul>
<li><code>srcset</code> 定义了多个候选图片地址及宽度描述符（如 <code>image-400w.jpg 400w</code>）</li>
<li><code>sizes</code> 由多组「<strong>媒体条件</strong> + <strong>源尺寸值</strong>」组成，描述在不同视口下的槽位宽度（如 <code>(max-width: 600px) 100vw, 50vw</code>）</li>
<li>浏览器根据 <strong>媒体条件</strong> 与 <strong>源尺寸值</strong> 得出槽位宽度，再结合 <strong>设备像素比（DPR）</strong> 与 <strong>宽度描述符</strong> 选择最合适的图片</li>
</ul>
<p><strong>示例代码</strong>：</p>
<p>① 槽位分段 + 多格式（完整用法）：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">picture</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> 
    <span class="hljs-attr">type</span>=<span class="hljs-string">"image/avif"</span> 
    <span class="hljs-attr">srcset</span>=<span class="hljs-string">"/images/hero-400w.avif 400w, /images/hero-800w.avif 800w, /images/hero-1200w.avif 1200w"</span>
    <span class="hljs-attr">sizes</span>=<span class="hljs-string">"(max-width: 600px) 100vw, 50vw"</span>
  /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> 
    <span class="hljs-attr">type</span>=<span class="hljs-string">"image/webp"</span> 
    <span class="hljs-attr">srcset</span>=<span class="hljs-string">"/images/hero-400w.webp 400w, /images/hero-800w.webp 800w, /images/hero-1200w.webp 1200w"</span>
    <span class="hljs-attr">sizes</span>=<span class="hljs-string">"(max-width: 600px) 100vw, 50vw"</span>
  /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
    <span class="hljs-attr">src</span>=<span class="hljs-string">"/images/hero-400w.jpg"</span> 
    <span class="hljs-attr">srcset</span>=<span class="hljs-string">"/images/hero-400w.jpg 400w, /images/hero-800w.jpg 800w, /images/hero-1200w.jpg 1200w"</span>
    <span class="hljs-attr">sizes</span>=<span class="hljs-string">"(max-width: 600px) 100vw, 50vw"</span>
    <span class="hljs-attr">alt</span>=<span class="hljs-string">"Hero Image"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span>
</code></pre>
<p>② DPR + 格式适配（<code>srcset</code> 用 <code>x</code> 描述符，<code>picture</code> 做格式切换）：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">picture</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/avif"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"/images/hero.avif 1x, /images/hero@2x.avif 2x"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/webp"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"/images/hero.webp 1x, /images/hero@2x.webp 2x"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
    <span class="hljs-attr">src</span>=<span class="hljs-string">"/images/hero.jpg"</span> 
    <span class="hljs-attr">srcset</span>=<span class="hljs-string">"/images/hero.jpg 1x, /images/hero@2x.jpg 2x"</span> 
    <span class="hljs-attr">alt</span>=<span class="hljs-string">"Hero Image"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span>
</code></pre>
<hr/>
<h2 data-id="heading-2">二、视口适配（Viewport-based Adaptation）</h2>
<p><strong>定义</strong>：以<strong>分段适配</strong>的方式，结合<strong>格式选择</strong>（AVIF/WebP）、<strong>媒体查询</strong>（视口宽度、设备像素比 DPR）为每一档指定图片，浏览器根据当前视口、DPR 及格式支持情况匹配到对应的一档并加载该资源。</p>
<p><strong>技术实现</strong>：</p>
<ul>
<li><strong>视口 × DPR 分段</strong>：通过 CSS 媒体查询 <code>@media</code> 实现</li>
<li><strong>格式选择</strong>（AVIF/WebP 等）：依赖 <strong>JS 检测</strong>——在应用启动时探测浏览器支持情况，给 <code>&lt;html&gt;</code> 添加 <code>.avif</code>、<code>.webp</code> 等 class，再由 CSS 选择器覆盖对应格式的背景图。CSS 的 <code>@supports</code> 对图片格式不可靠，故采用 JS + class 方案</li>
</ul>
<p><strong>示例代码</strong>（视口 × DPR 分段 + 格式覆盖）：</p>
<p>① 格式检测并往 <code>document</code> 加 class（仅示例 AVIF）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用 1x1 AVIF data URI 探测，支持则在根节点加 .avif</span>
<span class="hljs-keyword">const</span> avifDataUri = <span class="hljs-string">'data:image/avif;base64,AAAAIGZ0eXBhdmlm...'</span>
<span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>()
img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">if</span> (img.<span class="hljs-property">width</span> &gt; <span class="hljs-number">0</span>) <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'avif'</span>) }
img.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> {}
img.<span class="hljs-property">src</span> = avifDataUri
</code></pre>
<p>② 视口 × DPR 分段 + 用 <code>.avif</code> 覆盖格式：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.hero</span> {
  <span class="hljs-comment">// 降级格式（JPG）：视口 × DPR</span>
  <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">resolution</span> &gt;= <span class="hljs-number">1dppx</span>) {
      <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'/images/hero-400w.jpg'</span>);
    }
  }
  <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">768px</span>) {
    <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">resolution</span> &gt;= <span class="hljs-number">2dppx</span>) {
      <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'/images/hero-800w@2x.jpg'</span>);
    }
  }

  <span class="hljs-selector-class">.avif</span> &amp; {
    <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">resolution</span> &gt;= <span class="hljs-number">1dppx</span>) {
        <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'/images/hero-400w.avif'</span>);
      }
    }
    <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">768px</span>) {
      <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">resolution</span> &gt;= <span class="hljs-number">2dppx</span>) {
        <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'/images/hero-800w@2x.avif'</span>);
      }
    }
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-3">三、槽位适配与视口适配的对比</h2>
<h3 data-id="heading-4">3.1 槽位适配更细腻精确</h3>
<p>槽位适配在媒体查询的基础上，还依据<strong>图片在页面中的实际显示宽度</strong>选图，形成“二维精准匹配”。例如：视口 1920px 时，若图片只占 50vw（960px），通过 <code>sizes="50vw"</code> 浏览器会选约 1000w 的图，而视口适配只能按 1920px 选图，容易造成浪费。在复杂布局（多栏、网格等）中，这种差异更明显。</p>
<h3 data-id="heading-5">3.2 适用场景不同</h3>
<p><strong>槽位适配</strong>适用于页面中<strong>某些槽位的显示尺寸会随视口变化而变化</strong>的场景（如多栏、网格、响应式布局中宽度不固定的图片区域）。通过 <code>sizes</code> 声明各视口下的槽位宽度，浏览器按实际显示宽度选图，避免大视口下小槽位仍加载大图。</p>
<p><strong>视口适配</strong>则适合<strong>整体随视口缩放的场景</strong>（如全屏头图、整页背景），只按视口宽度与 DPR 分段选图，不关心图片在页面中的实际占位大小。该方案在 <strong>H5 / 小程序</strong> 等移动端页面中应用广泛。</p>
<h3 data-id="heading-6">3.3 背景图</h3>
<p>槽位适配依赖 HTML 的 <strong><code>sizes</code></strong> 来声明“图片在不同视口下的实际宽度”。<strong>CSS 的 <code>background-image</code> 没有等价语法</strong>，无法描述“背景在容器中的显示宽度”，只能通过媒体查询获知视口宽度与 DPR。因此背景图无法做槽位式选图，只能采用视口分段适配。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始基于Three.js设计3D地图控件系统：小白也能看懂]]></title>    <link>https://juejin.cn/post/7602910573404028966</link>    <guid>https://juejin.cn/post/7602910573404028966</guid>    <pubDate>2026-02-04T14:24:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602910573404028966" data-draft-id="7602789520036249610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始基于Three.js设计3D地图控件系统：小白也能看懂"/> <meta itemprop="keywords" content="three.js"/> <meta itemprop="datePublished" content="2026-02-04T14:24:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三维搬砖者"/> <meta itemprop="url" content="https://juejin.cn/user/433686775868256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始基于Three.js设计3D地图控件系统：小白也能看懂
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/433686775868256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三维搬砖者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T14:24:52.000Z" title="Wed Feb 04 2026 14:24:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">先聊聊三个问题</h2>
<ol>
<li><strong>咱们要做啥？</strong> - 设计一个基于Three.js的3D地图控件系统，包括立方体视图、比例尺、位置信息栏这些常用的控件</li>
<li><strong>这玩意儿是啥？</strong> - 3D地图控件系统就是3D地图里那些用来和用户交互、展示信息的组件，比如你点一下就能切换视角的立方体，显示地图比例的比例尺啥的</li>
<li><strong>咋做呢？</strong> - 我们从最基础的架构开始，一步步实现面板管理、事件监听这些功能，最后做出能用的控件
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdb05bef12844717b2033db2af3dee04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ57u05pCs56CW6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819896&amp;x-signature=xHlbdXA3f6BGpjMGJ58RdOj1bek%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae3f6f6c1a454e2db060d3d1136c79b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ57u05pCs56CW6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819896&amp;x-signature=38mfHqTCbKWMKTSxzvCxFuew5Ic%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5be0f1e924745dc9954cebfaef64da4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ57u05pCs56CW6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770819896&amp;x-signature=NoIW97l36C%2FzRsH7dryNAai5598%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-1">写在前面</h2>
<p>我发现很多做3D地图的朋友，往往把精力都放在了地图渲染本身，却忽略了控件系统的设计。其实啊，控件系统才是最影响用户体验的部分之一。一个好用的控件能让用户操作起来特别顺手，也能展示更多有用的信息。</p>
<p>今天我就想把自己开发3D地图控件系统的经验分享给大家，从最基础的架构到一些高级功能，尽量讲得明白点，希望能给正在做类似项目的朋友一点参考。</p>
<h2 data-id="heading-2">控件系统设计思路</h2>
<h3 data-id="heading-3">1. 控件体系的设计</h3>
<p>设计控件系统的时候，我用了面向对象的思路，建了一个清晰的继承结构：</p>
<ul>
<li><strong>BaseControl</strong>：所有控件的基类，负责处理面板管理、事件监听、位置设置这些基础功能</li>
<li><strong>CubeView</strong>：3D立方体视图控件，点一下就能切换不同视角，特别方便</li>
<li><strong>ScaleLine</strong>：比例尺控件，实时显示当前地图的缩放比例</li>
<li><strong>LocationBar</strong>：位置信息栏控件，显示鼠标在哪里、相机朝向啥的信息</li>
</ul>
<p>这样设计的好处是模块化，后续想加新控件或者改现有控件都特别方便，不用改太多代码。</p>
<h3 data-id="heading-4">2. 面板管理与DOM操作</h3>
<p>每个控件都需要一个面板（panel）来显示UI元素，我在BaseControl里把面板相关的操作都封装好了：</p>
<ul>
<li><code>_initPanel()</code>：初始化面板，子类要是想自定义面板样式，直接重写这个方法就行</li>
<li><code>_createPanel()</code>：创建面板的DOM元素，顺便设置一些基本样式</li>
<li><code>setPosition()</code>：设置面板的位置，支持左上、左下、右上、右下四个位置</li>
</ul>
<p>这样每个控件就不用自己再写一遍面板相关的代码了，直接用基类的方法就行。</p>
<h3 data-id="heading-5">3. 事件驱动架构</h3>
<p>控件系统我用了事件驱动的方式，这样控件和地图、用户之间的交互会更灵活：</p>
<ul>
<li><code>_initEventListeners()</code>：初始化事件监听器，子类要是需要自己的事件，重写这个方法就行</li>
<li><code>_removeEventListeners()</code>：移除事件监听器，这步特别重要，不然容易内存泄漏</li>
<li>支持常见的DOM事件（比如点击、鼠标移动）和自定义事件（比如相机变化事件）</li>
</ul>
<p>简单说就是，当发生什么事的时候，控件会发出一个信号，其他地方收到这个信号就可以做相应的处理，不用硬编码在一起。</p>
<h3 data-id="heading-6">4. 生命周期管理</h3>
<p>为了确保控件能正确创建和销毁，我做了完整的生命周期管理：</p>
<ul>
<li><code>initialize()</code>：初始化控件，把面板添加到地图容器里</li>
<li><code>destroy()</code>：销毁控件，移除事件监听器，清理各种引用</li>
<li><code>release()</code>：释放控件资源，内部会调用destroy方法</li>
</ul>
<p>这样做的好处是，当控件不用的时候，能把它占用的资源都释放掉，避免内存泄漏的问题。</p>
<h3 data-id="heading-7">5. 性能优化小技巧</h3>
<p>在3D场景里，控件的性能也不能忽视，我总结了几个小技巧：</p>
<ul>
<li>使用<code>will-change</code>属性告诉浏览器哪些属性会经常变化，让浏览器提前做好准备</li>
<li>合理用CSS过渡效果，别用太多，不然页面容易卡顿</li>
<li>不用的事件监听器要及时移除，不然容易内存泄漏</li>
<li>对相机变化这种频繁触发的事件做防抖处理，减少没必要的计算</li>
</ul>
<p>这些小细节看起来不起眼，但对提升用户体验特别重要。</p>
<h2 data-id="heading-8">核心技术点详解</h2>
<h3 data-id="heading-9">1. BaseControl：控件系统的基础</h3>
<p>BaseControl是整个控件系统的基础，我把一些通用功能都封装在这里了：</p>
<ul>
<li><strong>面板管理</strong>：创建和管理控件的DOM面板，支持自定义样式和位置</li>
<li><strong>事件系统</strong>：提供事件监听和触发机制，支持多种事件类型</li>
<li><strong>位置管理</strong>：实现了灵活的位置设置，支持四个预设位置</li>
<li><strong>生命周期管理</strong>：提供完整的初始化和销毁流程</li>
</ul>
<p>有了这个基类，后续开发具体控件的时候，就不用再写那些重复的代码了，直接继承它就行。</p>
<h3 data-id="heading-10">2. CubeView：3D立方体视角控制器</h3>
<p>CubeView是我觉得最有趣的一个控件，我用CSS 3D变换做了一个可交互的立方体：</p>
<ul>
<li><strong>3D立方体实现</strong>：用CSS的<code>transform-style: preserve-3d</code>和<code>transform</code>属性做出立方体效果，不用WebGL，轻量又兼容</li>
<li><strong>视角快速切换</strong>：立方体的六个面分别对应不同的视角（前、后、左、右、俯、仰），点一下就能切换</li>
<li><strong>相机同步</strong>：实时监听相机变化，自动更新立方体的旋转角度，让它和当前视角保持一致</li>
<li><strong>交互反馈</strong>：加了鼠标悬停效果，用户操作的时候能有更好的反馈</li>
</ul>
<p>这个控件看起来特别酷，用起来也方便，尤其是需要快速切换视角的时候，比在场景里慢慢调相机方便多了。</p>
<h3 data-id="heading-11">3. ScaleLine：实时比例尺控件</h3>
<p>ScaleLine是个很实用的控件，能让用户一眼就知道当前地图缩放到什么程度了：</p>
<ul>
<li><strong>比例尺计算</strong>：根据相机位置、视场角和屏幕尺寸来算实际距离</li>
<li><strong>动态更新</strong>：监听地图的更新事件，实时调整比例尺的显示</li>
<li><strong>单位自动转换</strong>：根据距离的大小自动切换米和公里单位，显示更合理</li>
</ul>
<p>这个控件虽然看起来简单，但对用户理解地图尺度特别重要，尤其是在大比例尺和小比例尺之间切换的时候。</p>
<h3 data-id="heading-12">4. LocationBar：位置信息显示控件</h3>
<p>LocationBar是个信息展示控件，主要显示鼠标在哪、相机啥状态这些信息：</p>
<ul>
<li><strong>坐标转换</strong>：支持UTM到WGS84坐标转换，显示经度和纬度</li>
<li><strong>信息丰富</strong>：显示经度、纬度、海拔、方向、俯仰角这些信息</li>
<li><strong>实时更新</strong>：监听鼠标移动和相机变化事件，实时更新显示的信息</li>
<li><strong>智能显示</strong>：根据坐标值的大小自动选合适的显示方式，适配不同场景</li>
</ul>
<p>这个控件能给用户提供很多有用的地理信息，尤其是需要精确定位的时候，特别方便。</p>
<h2 data-id="heading-13">使用方法与示例</h2>
<h3 data-id="heading-14">1. 初始化时配置控件</h3>
<p>初始化地图的时候，你可以通过<code>controls</code>参数来配置要添加哪些控件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始化时添加所有控件</span>
<span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Merge3D</span>({
  <span class="hljs-attr">container</span>: <span class="hljs-string">'map-container'</span>,
  <span class="hljs-attr">controls</span>: {
    <span class="hljs-attr">scaleLine</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">locationBar</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">cubeView</span>: <span class="hljs-literal">true</span>
  }
});

<span class="hljs-comment">// 初始化时不添加任何控件</span>
<span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Merge3D</span>({
  <span class="hljs-attr">container</span>: <span class="hljs-string">'map-container'</span>,
  <span class="hljs-attr">controls</span>: {
    <span class="hljs-attr">scaleLine</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">locationBar</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">cubeView</span>: <span class="hljs-literal">false</span>
  }
});

<span class="hljs-comment">// 初始化时添加部分控件</span>
<span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Merge3D</span>({
  <span class="hljs-attr">container</span>: <span class="hljs-string">'map-container'</span>,
  <span class="hljs-attr">controls</span>: {
    <span class="hljs-attr">scaleLine</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">locationBar</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">cubeView</span>: <span class="hljs-literal">true</span>
  }
});
</code></pre>
<h3 data-id="heading-15">2. 动态添加控件</h3>
<p>除了在初始化的时候配置控件，你也可以在运行过程中随时添加控件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建CubeView控件</span>
<span class="hljs-keyword">const</span> cubeView = <span class="hljs-keyword">new</span> merge3D.<span class="hljs-property">control</span>.<span class="hljs-title class_">CubeView</span>({
  <span class="hljs-attr">position</span>: <span class="hljs-string">'righttop'</span>, <span class="hljs-comment">// 位置：lefttop、leftbottom、righttop、rightbottom</span>
  <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>, <span class="hljs-comment">// 宽度</span>
  <span class="hljs-attr">height</span>: <span class="hljs-number">100</span> <span class="hljs-comment">// 高度</span>
});

<span class="hljs-comment">// 添加到地图</span>
map.<span class="hljs-title function_">addControl</span>(cubeView);

<span class="hljs-comment">// 创建ScaleLine控件</span>
<span class="hljs-keyword">const</span> scaleLine = <span class="hljs-keyword">new</span> merge3D.<span class="hljs-property">control</span>.<span class="hljs-title class_">ScaleLine</span>({
  <span class="hljs-attr">position</span>: <span class="hljs-string">'leftbottom'</span> <span class="hljs-comment">// 位置</span>
});

<span class="hljs-comment">// 添加到地图</span>
map.<span class="hljs-title function_">addControl</span>(scaleLine);

<span class="hljs-comment">// 创建LocationBar控件</span>
<span class="hljs-keyword">const</span> locationBar = <span class="hljs-keyword">new</span> merge3D.<span class="hljs-property">control</span>.<span class="hljs-title class_">LocationBar</span>({
  <span class="hljs-attr">position</span>: <span class="hljs-string">'leftbottom'</span> <span class="hljs-comment">// 位置</span>
});

<span class="hljs-comment">// 添加到地图</span>
map.<span class="hljs-title function_">addControl</span>(locationBar);
</code></pre>
<h3 data-id="heading-16">3. 动态删除控件</h3>
<p>如果某个控件你暂时不用了，可以在运行的时候随时删除它：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 假设已添加了cubeView控件</span>
map.<span class="hljs-title function_">removeControl</span>(cubeView);
<span class="hljs-comment">// 清空引用</span>
cubeView = <span class="hljs-literal">null</span>;
</code></pre>
<h3 data-id="heading-17">4. 显示/隐藏控件</h3>
<p>有时候你可能不想完全删掉控件，只是暂时不用它，这时候可以用<code>show()</code>和<code>hide()</code>方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 显示控件</span>
cubeView.<span class="hljs-title function_">show</span>();

<span class="hljs-comment">// 隐藏控件</span>
cubeView.<span class="hljs-title function_">hide</span>();

<span class="hljs-comment">// 切换显示/隐藏状态</span>
<span class="hljs-keyword">if</span> (cubeView.<span class="hljs-property">panel</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> === <span class="hljs-string">'none'</span>) {
  cubeView.<span class="hljs-title function_">show</span>();
} <span class="hljs-keyword">else</span> {
  cubeView.<span class="hljs-title function_">hide</span>();
}
</code></pre>
<h3 data-id="heading-18">5. 动态设置控件位置</h3>
<p>如果你想调整控件的位置，比如把CubeView从右上角移到左上角，你可以重新创建一个实例并设置新位置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 先移除控件</span>
map.<span class="hljs-title function_">removeControl</span>(cubeView);
<span class="hljs-comment">// 创建新的CubeView实例并设置新位置</span>
cubeView = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CubeView</span>({ <span class="hljs-attr">position</span>: <span class="hljs-string">'lefttop'</span> });
<span class="hljs-comment">// 重新添加到地图</span>
map.<span class="hljs-title function_">addControl</span>(cubeView);
</code></pre>
<h3 data-id="heading-19">6. 获取控件实例</h3>
<p>如果你需要获取已经添加到地图里的控件实例，可以用<code>getControl()</code>方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取比例尺控件</span>
<span class="hljs-keyword">const</span> scaleLine = map.<span class="hljs-title function_">getControl</span>(<span class="hljs-string">'scaleLine'</span>);

<span class="hljs-comment">// 获取位置栏控件</span>
<span class="hljs-keyword">const</span> locationBar = map.<span class="hljs-title function_">getControl</span>(<span class="hljs-string">'locationBar'</span>);

<span class="hljs-comment">// 获取立方体视图控件</span>
<span class="hljs-keyword">const</span> cubeView = map.<span class="hljs-title function_">getControl</span>(<span class="hljs-string">'cubeView'</span>);
</code></pre>
<h3 data-id="heading-20">7. 完整示例</h3>
<h4 data-id="heading-21">示例1：动态控件管理</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>动态加载控件示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">font-family</span>: Arial, sans-serif;
        }

        <span class="hljs-selector-id">#map-container</span> {
            <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
            <span class="hljs-attribute">position</span>: relative;
        }

        <span class="hljs-selector-id">#controls</span> {
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">top</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">left</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">background</span>: white;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">10px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
            <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1000</span>;
        }

        <span class="hljs-selector-id">#controls</span> <span class="hljs-selector-tag">h3</span> {
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
        }

        <span class="hljs-selector-id">#controls</span> <span class="hljs-selector-tag">button</span> {
            <span class="hljs-attribute">display</span>: block;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">12px</span>;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">text-align</span>: left;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
            <span class="hljs-attribute">background</span>: white;
            <span class="hljs-attribute">cursor</span>: pointer;
            <span class="hljs-attribute">transition</span>: background <span class="hljs-number">0.2s</span>;
        }

        <span class="hljs-selector-id">#controls</span> <span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#f5f5f5</span>;
        }

        <span class="hljs-selector-id">#controls</span> <span class="hljs-selector-tag">button</span><span class="hljs-selector-class">.active</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#007bff</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#007bff</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"map-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"controls"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>动态控件管理<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"addCubeView"</span>&gt;</span>添加立方体视图控件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"removeCubeView"</span>&gt;</span>删除立方体视图控件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"toggleCubeView"</span>&gt;</span>显示/隐藏立方体视图<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>位置设置<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"setPositionLeftTop"</span>&gt;</span>左上<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"setPositionRightTop"</span>&gt;</span>右上<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"setPositionLeftBottom"</span>&gt;</span>左下<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"setPositionRightBottom"</span>&gt;</span>右下<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">import</span> merge3D <span class="hljs-keyword">from</span> <span class="hljs-string">'../../Merge3D.js'</span>;  
        
        <span class="hljs-comment">// 初始化 Merge3D，中心默认为 0, 0</span>
        <span class="hljs-comment">// 通过 controls 参数设置不加载任何控件</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">map</span> = <span class="hljs-keyword">new</span> merge3D.<span class="hljs-title class_">Map</span>(<span class="hljs-string">"map-container"</span>, {
            <span class="hljs-attr">center</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>], <span class="hljs-comment">// 中心默认值为 0, 0  可选</span>
            <span class="hljs-attr">autoRotate</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 自动旋转 可选</span>
            <span class="hljs-attr">controls</span>: {
                <span class="hljs-attr">scaleLine</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">locationBar</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">cubeView</span>: <span class="hljs-literal">false</span>
            } <span class="hljs-comment">// 初始化时不加载任何控件</span>
        });

        <span class="hljs-comment">// 创建图形图层</span>
        <span class="hljs-keyword">const</span> graphicLayer = <span class="hljs-keyword">new</span> merge3D.<span class="hljs-property">layer</span>.<span class="hljs-title class_">GraphicLayer</span>();
        map.<span class="hljs-title function_">addLayer</span>(graphicLayer);

        <span class="hljs-comment">// 模型位置（米为单位）</span>
        <span class="hljs-keyword">const</span> modelPosition = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>];

        <span class="hljs-comment">// 创建并加载模型</span>
        <span class="hljs-keyword">let</span> model = <span class="hljs-keyword">new</span> merge3D.<span class="hljs-property">graphic</span>.<span class="hljs-title class_">Model</span>({
            <span class="hljs-attr">position</span>: modelPosition,
            <span class="hljs-attr">url</span>: <span class="hljs-string">"../../data/Model/glTF/DamagedHelmet.gltf"</span>,
        });
        graphicLayer.<span class="hljs-title function_">addGraphic</span>(model);

        <span class="hljs-comment">// 监听模型加载完成事件</span>
        model.<span class="hljs-title function_">on</span>(<span class="hljs-string">'model:load'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'模型加载完成'</span>);
            <span class="hljs-comment">// 相机位置：在模型位置基础上偏移</span>
            <span class="hljs-keyword">const</span> cameraPosition = [modelPosition[<span class="hljs-number">0</span>], modelPosition[<span class="hljs-number">1</span>] - <span class="hljs-number">2</span>, <span class="hljs-number">2</span>];
            map.<span class="hljs-title function_">flyTo</span>(cameraPosition, modelPosition, <span class="hljs-number">1000</span>); <span class="hljs-comment">// 1000毫秒 = 1秒</span>
        });

        <span class="hljs-comment">// 全局变量，用于存储 CubeView 实例</span>
        <span class="hljs-keyword">let</span> cubeView = <span class="hljs-literal">null</span>;

        <span class="hljs-comment">// 添加立方体视图控件</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'addCubeView'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 检查是否已经添加了 CubeView 控件</span>
            <span class="hljs-keyword">if</span> (!cubeView) {
                <span class="hljs-comment">// 创建 CubeView 实例</span>
                cubeView = <span class="hljs-keyword">new</span> merge3D.<span class="hljs-property">control</span>.<span class="hljs-title class_">CubeView</span>({ <span class="hljs-attr">position</span>: <span class="hljs-string">"righttop"</span> });
                <span class="hljs-comment">// 添加到地图</span>
                map.<span class="hljs-title function_">addControl</span>(cubeView);
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'立方体视图控件已添加'</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">alert</span>(<span class="hljs-string">'立方体视图控件已经存在'</span>);
            }
        });

        <span class="hljs-comment">// 删除立方体视图控件</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'removeCubeView'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 检查是否已经添加了 CubeView 控件</span>
            <span class="hljs-keyword">if</span> (cubeView) {
                <span class="hljs-comment">// 从地图中删除</span>
                map.<span class="hljs-title function_">removeControl</span>(cubeView);
                <span class="hljs-comment">// 清空引用</span>
                cubeView = <span class="hljs-literal">null</span>;
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'立方体视图控件已删除'</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">alert</span>(<span class="hljs-string">'立方体视图控件不存在'</span>);
            }
        });

        <span class="hljs-comment">// 显示/隐藏立方体视图控件</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'toggleCubeView'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 检查是否已经添加了 CubeView 控件</span>
            <span class="hljs-keyword">if</span> (cubeView) {
                <span class="hljs-comment">// 切换显示状态</span>
                <span class="hljs-keyword">if</span> (cubeView.<span class="hljs-property">panel</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> === <span class="hljs-string">'none'</span>) {
                    cubeView.<span class="hljs-title function_">show</span>();
                } <span class="hljs-keyword">else</span> {
                    cubeView.<span class="hljs-title function_">hide</span>();
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">alert</span>(<span class="hljs-string">'立方体视图控件不存在，请先添加'</span>);
            }
        });

        <span class="hljs-comment">// 设置 CubeView 位置</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">setCubeViewPosition</span>(<span class="hljs-params">position</span>) {
            <span class="hljs-keyword">if</span> (cubeView) {
                <span class="hljs-comment">// 先移除控件</span>
                map.<span class="hljs-title function_">removeControl</span>(cubeView);
                <span class="hljs-comment">// 创建新的 CubeView 实例并设置新位置</span>
                cubeView = <span class="hljs-keyword">new</span> merge3D.<span class="hljs-property">control</span>.<span class="hljs-title class_">CubeView</span>({ <span class="hljs-attr">position</span>: position });
                <span class="hljs-comment">// 重新添加到地图</span>
                map.<span class="hljs-title function_">addControl</span>(cubeView);
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`立方体视图控件位置已设置为：<span class="hljs-subst">${position}</span>`</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">alert</span>(<span class="hljs-string">'立方体视图控件不存在，请先添加'</span>);
            }
        }

        <span class="hljs-comment">// 位置设置按钮事件监听</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'setPositionLeftTop'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">setCubeViewPosition</span>(<span class="hljs-string">'lefttop'</span>);
        });

        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'setPositionRightTop'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">setCubeViewPosition</span>(<span class="hljs-string">'righttop'</span>);
        });

        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'setPositionLeftBottom'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">setCubeViewPosition</span>(<span class="hljs-string">'leftbottom'</span>);
        });

        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'setPositionRightBottom'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">setCubeViewPosition</span>(<span class="hljs-string">'rightbottom'</span>);
        });

    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-22">示例2：控件初始化配置</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>模型定位示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">font-family</span>: Arial, sans-serif;
        }

        <span class="hljs-selector-id">#map-container</span> {
            <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
            <span class="hljs-attribute">position</span>: relative;
        }

        <span class="hljs-selector-id">#controls</span> {
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">top</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">left</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">background</span>: white;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">10px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
            <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1000</span>;
        }

        <span class="hljs-selector-id">#controls</span> <span class="hljs-selector-tag">h3</span> {
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
        }

        <span class="hljs-selector-id">#controls</span> <span class="hljs-selector-tag">button</span> {
            <span class="hljs-attribute">display</span>: block;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">12px</span>;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">text-align</span>: left;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
            <span class="hljs-attribute">background</span>: white;
            <span class="hljs-attribute">cursor</span>: pointer;
            <span class="hljs-attribute">transition</span>: background <span class="hljs-number">0.2s</span>;
        }

        <span class="hljs-selector-id">#controls</span> <span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#f5f5f5</span>;
        }

        <span class="hljs-selector-id">#controls</span> <span class="hljs-selector-tag">button</span><span class="hljs-selector-class">.active</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#007bff</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#007bff</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"map-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"controls"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>初始化配置<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"initWithAllControls"</span>&gt;</span>初始化时添加所有控件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"initWithoutControls"</span>&gt;</span>初始化时不添加任何控件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"initWithSomeControls"</span>&gt;</span>初始化时添加部分控件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>控件控制<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"toggleScaleLine"</span>&gt;</span>显示/隐藏比例尺<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"toggleLocationBar"</span>&gt;</span>显示/隐藏位置栏<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"toggleCubeView"</span>&gt;</span>显示/隐藏立方体视图<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">import</span> merge3D <span class="hljs-keyword">from</span> <span class="hljs-string">'../../Merge3D.js'</span>; 
        
        <span class="hljs-comment">// 初始化 Merge3D，中心默认为 0, 0</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">initMap</span>(<span class="hljs-params">controlsConfig</span>) {
            <span class="hljs-comment">// 清空容器</span>
            <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'map-container'</span>);
            container.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
            
            <span class="hljs-comment">// 初始化地图</span>
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">map</span> = <span class="hljs-keyword">new</span> merge3D.<span class="hljs-title class_">Map</span>(<span class="hljs-string">"map-container"</span>, {
                <span class="hljs-attr">center</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>], <span class="hljs-comment">// 中心默认值为 0, 0  可选</span>
                <span class="hljs-attr">autoRotate</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 自动旋转 可选</span>
                <span class="hljs-attr">controls</span>: controlsConfig <span class="hljs-comment">// 控制是否添加默认控件</span>
            });

            <span class="hljs-comment">// 创建图形图层</span>
            <span class="hljs-keyword">const</span> graphicLayer = <span class="hljs-keyword">new</span> merge3D.<span class="hljs-property">layer</span>.<span class="hljs-title class_">GraphicLayer</span>();
            map.<span class="hljs-title function_">addLayer</span>(graphicLayer);

            <span class="hljs-comment">// 模型位置（米为单位）</span>
            <span class="hljs-keyword">const</span> modelPosition = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>];

            <span class="hljs-comment">// 创建并加载模型</span>
            <span class="hljs-keyword">let</span> model = <span class="hljs-keyword">new</span> merge3D.<span class="hljs-property">graphic</span>.<span class="hljs-title class_">Model</span>({
                <span class="hljs-attr">position</span>: modelPosition,
                <span class="hljs-attr">url</span>: <span class="hljs-string">"../../data/Model/glTF/DamagedHelmet.gltf"</span>,
            });
            graphicLayer.<span class="hljs-title function_">addGraphic</span>(model);

            <span class="hljs-comment">// 监听模型加载完成事件</span>
            model.<span class="hljs-title function_">on</span>(<span class="hljs-string">'model:load'</span>, <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'模型加载完成'</span>);
                <span class="hljs-comment">// 相机位置：在模型位置基础上偏移</span>
                <span class="hljs-keyword">const</span> cameraPosition = [modelPosition[<span class="hljs-number">0</span>], modelPosition[<span class="hljs-number">1</span>] - <span class="hljs-number">2</span>, <span class="hljs-number">2</span>];
                map.<span class="hljs-title function_">flyTo</span>(cameraPosition, modelPosition, <span class="hljs-number">1000</span>); <span class="hljs-comment">// 1000毫秒 = 1秒</span>
            });
        }
        
        <span class="hljs-comment">// 默认初始化时添加所有控件</span>
        <span class="hljs-title function_">initMap</span>({});
        
        <span class="hljs-comment">// 初始化配置按钮事件</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'initWithAllControls'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">initMap</span>({
                <span class="hljs-attr">scaleLine</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">locationBar</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">cubeView</span>: <span class="hljs-literal">true</span>
            });
        });
        
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'initWithoutControls'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">initMap</span>({
                <span class="hljs-attr">scaleLine</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">locationBar</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">cubeView</span>: <span class="hljs-literal">false</span>
            });
        });
        
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'initWithSomeControls'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">initMap</span>({
                <span class="hljs-attr">scaleLine</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">locationBar</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">cubeView</span>: <span class="hljs-literal">true</span>
            });
        });

        <span class="hljs-comment">// 控件控制</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'toggleScaleLine'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">const</span> scaleLine = map.<span class="hljs-title function_">getControl</span>(<span class="hljs-string">'scaleLine'</span>);
            <span class="hljs-keyword">if</span> (scaleLine) {
                <span class="hljs-keyword">if</span> (scaleLine.<span class="hljs-property">panel</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> === <span class="hljs-string">'none'</span>) {
                    scaleLine.<span class="hljs-title function_">show</span>();
                } <span class="hljs-keyword">else</span> {
                    scaleLine.<span class="hljs-title function_">hide</span>();
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">alert</span>(<span class="hljs-string">'比例尺控件未初始化，请先选择"初始化时添加控件"'</span>);
            }
        });

        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'toggleLocationBar'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">const</span> locationBar = map.<span class="hljs-title function_">getControl</span>(<span class="hljs-string">'locationBar'</span>);
            <span class="hljs-keyword">if</span> (locationBar) {
                <span class="hljs-keyword">if</span> (locationBar.<span class="hljs-property">panel</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> === <span class="hljs-string">'none'</span>) {
                    locationBar.<span class="hljs-title function_">show</span>();
                } <span class="hljs-keyword">else</span> {
                    locationBar.<span class="hljs-title function_">hide</span>();
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">alert</span>(<span class="hljs-string">'位置栏控件未初始化，请先选择"初始化时添加控件"'</span>);
            }
        });

        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'toggleCubeView'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">const</span> cubeView = map.<span class="hljs-title function_">getControl</span>(<span class="hljs-string">'cubeView'</span>);
            <span class="hljs-keyword">if</span> (cubeView) {
                <span class="hljs-keyword">if</span> (cubeView.<span class="hljs-property">panel</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> === <span class="hljs-string">'none'</span>) {
                    cubeView.<span class="hljs-title function_">show</span>();
                } <span class="hljs-keyword">else</span> {
                    cubeView.<span class="hljs-title function_">hide</span>();
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">alert</span>(<span class="hljs-string">'立方体视图控件未初始化，请先选择"初始化时添加控件"'</span>);
            }
        });

    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-23">技术亮点</h2>
<h3 data-id="heading-24">1. 基于CSS 3D变换的立方体视图</h3>
<p>做CubeView控件的时候，我没用WebGL，而是用了CSS 3D变换来实现立方体效果。这样做的好处是轻量，而且浏览器兼容性更好。通过<code>transform-style: preserve-3d</code>和<code>transform</code>属性，做出了一个能直观展示不同视角的立方体控件。</p>
<p>这个方法特别巧妙，不用写复杂的WebGL代码，只用CSS就能做出3D效果，而且运行起来特别流畅。</p>
<h3 data-id="heading-25">2. 实时相机同步机制</h3>
<p>为了让CubeView控件更直观，我做了个实时相机同步的功能。通过监听相机的变化事件，实时更新立方体的旋转角度，让它的朝向和当前相机视角保持一致。这样用户看一眼立方体，就知道现在相机正对着哪个方向。</p>
<p>这个功能看起来简单，但实现起来需要处理好相机参数的转换和事件的监听，确保同步的实时性和准确性。</p>
<h3 data-id="heading-26">3. 智能坐标转换</h3>
<p>在LocationBar控件里，我做了个智能坐标转换的功能。它会根据坐标值的大小自动选合适的显示方式：小坐标值直接显示原始值；大坐标值就用UTM到WGS84的转换，显示经度和纬度。这样不管在什么场景下，显示的坐标都特别合理。</p>
<p>这个功能特别实用，尤其是在处理不同尺度的地图数据时，不用用户自己去换算坐标。</p>
<h3 data-id="heading-27">4. 性能优化技巧</h3>
<p>为了让控件在3D场景里运行流畅，我总结了几个实用的优化技巧：</p>
<ul>
<li>使用<code>will-change</code>属性告诉浏览器哪些属性会经常变化，让浏览器提前做好准备</li>
<li>合理用CSS过渡效果，别用太多，不然页面容易卡顿</li>
<li>不用的事件监听器要及时移除，防止内存泄漏</li>
<li>对相机变化这种频繁触发的事件做防抖处理，减少没必要的计算</li>
</ul>
<p>这些优化虽然都是小细节，但对提升用户体验特别重要。你想啊，用户用着用着页面突然卡了，多影响心情啊。</p>
<h2 data-id="heading-28">总结与展望</h2>
<p>通过上面的介绍，相信大家对3D地图控件系统的设计与实现有了个基本的了解。我基于Three.js做了一个功能丰富、性能还不错的3D地图控件系统，用了面向对象的设计思想、事件驱动的架构和一些性能优化技巧。</p>
<p>未来，我打算继续完善这个控件系统，添加一些新功能：</p>
<ul>
<li><strong>时间轴控件</strong>：支持时间序列数据的可视化和交互</li>
<li><strong>图层管理控件</strong>：支持图层的显示/隐藏、透明度调整这些操作</li>
<li><strong>测量工具控件</strong>：支持距离、面积等测量功能</li>
<li><strong>自定义控件API</strong>：提供更灵活的自定义控件开发接口</li>
</ul>
<p>我希望通过不断的技术创新和功能扩展，做出一个更完善、更强大的3D地图控件系统，让用户用3D地图的时候体验更好。</p>
<h2 data-id="heading-29">结语</h2>
<p>3D地图控件系统虽然只是3D地图应用的一小部分，但它的设计质量却直接影响着整个应用的用户体验。一个好用的控件系统能让用户操作起来特别顺手，也能展示更多有用的信息。</p>
<p>我在这篇文章里分享的控件系统设计思路和实现技术，不仅可以用在3D地图应用上，也可以推广到其他3D可视化领域。希望这些内容能给正在做类似项目的朋友一点参考和启发，也欢迎大家在评论区分享自己的经验和想法，咱们一起讨论，共同推动3D可视化技术的发展。</p>
<p>最后，如果你觉得这篇文章对你有帮助，别忘了点个赞和收藏哦！有什么问题也可以随时在评论区留言，我会尽量回复的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[二、Prettier 配置文件指南]]></title>    <link>https://juejin.cn/post/7602800677711822882</link>    <guid>https://juejin.cn/post/7602800677711822882</guid>    <pubDate>2026-02-04T14:56:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602800677711822882" data-draft-id="7602846823325466659" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="二、Prettier 配置文件指南"/> <meta itemprop="keywords" content="前端,代码规范"/> <meta itemprop="datePublished" content="2026-02-04T14:56:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="晨米酱"/> <meta itemprop="url" content="https://juejin.cn/user/712900761892056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            二、Prettier 配置文件指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712900761892056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    晨米酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T14:56:19.000Z" title="Wed Feb 04 2026 14:56:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 概述</h2>
<h3 data-id="heading-1">1.1 配置方式总览</h3>
<p>Prettier 支持多种配置方式，从零配置到精细控制均可实现。</p>



































<table><thead><tr><th>配置方式</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>零配置</td><td>使用 Prettier 默认值</td><td>快速开始、简单项目</td></tr><tr><td>配置文件</td><td>项目根目录的 <code>.prettierrc</code> 等</td><td>团队协作、项目定制</td></tr><tr><td>package.json</td><td>在 <code>prettier</code> 字段中配置</td><td>减少配置文件数量</td></tr><tr><td>CLI 参数</td><td>命令行传递选项</td><td>一次性格式化、脚本</td></tr><tr><td>编辑器设置</td><td>VS Code 等编辑器的设置</td><td>个人偏好</td></tr></tbody></table>
<p><strong>配置优先级（从高到低）：</strong></p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-built_in">CLI</span> 参数 &gt; 配置文件 &gt; 编辑器设置 &gt; 默认值
</code></pre>
<h3 data-id="heading-2">1.2 配置加载优先级</h3>
<p>当项目中存在多个配置来源时，Prettier 从被格式化文件所在目录开始，向上逐级搜索直到找到配置文件或到达文件系统根目录。</p>
<p><strong>配置文件搜索顺序（同一目录内）：</strong></p>





















































































<table><thead><tr><th>优先级</th><th>配置文件</th><th>格式</th></tr></thead><tbody><tr><td>1</td><td><code>.prettierrc</code></td><td>JSON/YAML</td></tr><tr><td>2</td><td><code>.prettierrc.json</code></td><td>JSON</td></tr><tr><td>3</td><td><code>.prettierrc.yml</code></td><td>YAML</td></tr><tr><td>4</td><td><code>.prettierrc.yaml</code></td><td>YAML</td></tr><tr><td>5</td><td><code>.prettierrc.json5</code></td><td>JSON5</td></tr><tr><td>6</td><td><code>.prettierrc.js</code></td><td>JavaScript</td></tr><tr><td>7</td><td><code>.prettierrc.cjs</code></td><td>CommonJS</td></tr><tr><td>8</td><td><code>.prettierrc.mjs</code></td><td>ES Module</td></tr><tr><td>9</td><td><code>.prettierrc.ts</code></td><td>TypeScript</td></tr><tr><td>10</td><td><code>prettier.config.js</code></td><td>JavaScript</td></tr><tr><td>11</td><td><code>prettier.config.cjs</code></td><td>CommonJS</td></tr><tr><td>12</td><td><code>prettier.config.mjs</code></td><td>ES Module</td></tr><tr><td>13</td><td><code>prettier.config.ts</code></td><td>TypeScript</td></tr><tr><td>14</td><td><code>.prettierrc.toml</code></td><td>TOML</td></tr><tr><td>15</td><td><code>package.json</code> 的 prettier 字段</td><td>JSON</td></tr></tbody></table>
<blockquote>
<p><strong>注意</strong>：<code>package.json</code> 是最后搜索的，不是优先级最高的。Prettier 先检查专用配置文件，找不到才查看 <code>package.json</code>。</p>
</blockquote>
<p><strong>搜索路径：</strong></p>
<p>Prettier 从被格式化文件所在目录开始，向上逐级搜索直到找到配置文件或到达文件系统根目录。</p>
<pre><code class="hljs language-bash" lang="bash">project/
├── .prettierrc              <span class="hljs-comment"># 项目级配置</span>
├── src/
│   ├── components/
│   │   └── Button.jsx       <span class="hljs-comment"># 使用项目级配置</span>
│   └── legacy/
│       ├── .prettierrc      <span class="hljs-comment"># 子目录配置（优先级更高）</span>
│       └── old-code.js      <span class="hljs-comment"># 使用 legacy/.prettierrc</span>
└── package.json
</code></pre>
<blockquote>
<p><strong>提示</strong>：建议每个项目只使用一个配置文件，放在项目根目录，避免配置混乱。</p>
</blockquote>
<h2 data-id="heading-3">2. 配置文件类型</h2>
<h3 data-id="heading-4">2.1 JSON 格式</h3>
<p>JSON 是最常用的配置格式，简洁易读。</p>
<p><strong><code>.prettierrc</code> 或 <code>.prettierrc.json</code>：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tabWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"useTabs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es5"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bracketSpacing"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"arrowParens"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"avoid"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>语法简单，易于阅读</li>
<li>编辑器支持良好，有语法高亮和校验</li>
<li>可被大多数工具直接解析</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>不支持注释（标准 JSON）</li>
<li>不支持尾随逗号</li>
</ul>
<blockquote>
<p><strong>提示</strong>：<code>.prettierrc</code>（无扩展名）默认按 JSON 解析，也支持 YAML 语法。</p>
</blockquote>
<h3 data-id="heading-5">2.2 YAML 格式</h3>
<p>YAML 格式支持注释，语法简洁，适合喜欢 YAML 风格的团队。</p>
<p><strong><code>.prettierrc.yaml</code> 或 <code>.prettierrc.yml</code>：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Prettier 配置</span>
<span class="hljs-comment"># 详见：https://prettier.io/docs/en/options</span>

<span class="hljs-comment"># 打印相关</span>
<span class="hljs-attr">printWidth:</span> <span class="hljs-number">100</span>
<span class="hljs-attr">tabWidth:</span> <span class="hljs-number">2</span>
<span class="hljs-attr">useTabs:</span> <span class="hljs-literal">false</span>

<span class="hljs-comment"># 语法风格</span>
<span class="hljs-attr">semi:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">singleQuote:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">trailingComma:</span> <span class="hljs-string">"es5"</span>
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>支持注释，便于说明配置意图</li>
<li>语法简洁，无需引号和逗号</li>
<li>可读性好，适合简单配置</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>不支持动态配置</li>
<li>缩进敏感，容易出错</li>
<li>编辑器支持不如 JSON 普遍</li>
</ul>
<h3 data-id="heading-6">2.3 TOML 格式</h3>
<p>TOML 格式支持注释，语法明确，适合喜欢 TOML 风格的团队。</p>
<p><strong><code>.prettierrc.toml</code>：</strong></p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-comment"># Prettier 配置</span>

<span class="hljs-comment"># 打印相关</span>
<span class="hljs-attr">printWidth</span> = <span class="hljs-number">100</span>
<span class="hljs-attr">tabWidth</span> = <span class="hljs-number">2</span>
<span class="hljs-attr">useTabs</span> = <span class="hljs-literal">false</span>

<span class="hljs-comment"># 语法风格</span>
<span class="hljs-attr">semi</span> = <span class="hljs-literal">true</span>
<span class="hljs-attr">singleQuote</span> = <span class="hljs-literal">true</span>
<span class="hljs-attr">trailingComma</span> = <span class="hljs-string">"es5"</span>
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>支持注释</li>
<li>语法明确，不易歧义</li>
<li>类型清晰（字符串必须加引号）</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>不支持动态配置</li>
<li>使用较少，团队可能不熟悉</li>
<li>嵌套结构（如 overrides）写法较繁琐</li>
</ul>
<h3 data-id="heading-7">2.4 JavaScript 格式</h3>
<p>JavaScript 格式提供最大的灵活性，支持动态配置和注释。</p>
<p><strong><code>.prettierrc.js</code> 或 <code>prettier.config.js</code>（ES Module）：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// prettier.config.js</span>
<span class="hljs-comment">// 支持注释，便于说明配置意图</span>

<span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {<span class="hljs-type">import("prettier").Config</span>} */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 打印宽度</span>
  <span class="hljs-attr">printWidth</span>: <span class="hljs-number">100</span>,

  <span class="hljs-comment">// 使用单引号</span>
  <span class="hljs-attr">singleQuote</span>: <span class="hljs-literal">true</span>,

  <span class="hljs-comment">// 尾随逗号：ES5 兼容模式</span>
  <span class="hljs-attr">trailingComma</span>: <span class="hljs-string">"es5"</span>,

  <span class="hljs-comment">// 插件配置</span>
  <span class="hljs-attr">plugins</span>: [<span class="hljs-string">"prettier-plugin-tailwindcss"</span>],
};
</code></pre>
<p><strong><code>.prettierrc.cjs</code>（CommonJS）：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// prettier.config.cjs</span>
<span class="hljs-comment">// 适用于 package.json 中 "type": "module" 的项目</span>

<span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {<span class="hljs-type">import("prettier").Config</span>} */</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">printWidth</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attr">singleQuote</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">trailingComma</span>: <span class="hljs-string">"es5"</span>,
};
</code></pre>
<p><strong>动态配置示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// prettier.config.js</span>
<span class="hljs-comment">// 根据环境变量动态调整配置</span>

<span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {<span class="hljs-type">import("prettier").Config</span>} */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">printWidth</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">CI</span> ? <span class="hljs-number">120</span> : <span class="hljs-number">80</span>,
  <span class="hljs-attr">singleQuote</span>: <span class="hljs-literal">true</span>,

  <span class="hljs-comment">// 条件性加载插件</span>
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-string">"prettier-plugin-tailwindcss"</span>,
    ...(process.<span class="hljs-property">env</span>.<span class="hljs-property">SORT_IMPORTS</span>
      ? [<span class="hljs-string">"@trivago/prettier-plugin-sort-imports"</span>]
      : []),
  ],
};
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>支持注释和动态配置</li>
<li>可根据环境变量调整行为</li>
<li>有完整的类型提示支持</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>需要注意模块格式（ESM vs CommonJS）</li>
<li>配置文件本身可能需要格式化</li>
</ul>
<h3 data-id="heading-8">2.5 package.json 内嵌</h3>
<p>将配置放在 <code>package.json</code> 的 <code>prettier</code> 字段中，减少项目根目录的文件数量。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-project"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"prettier"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es5"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prettier"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.0.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>适用场景：</strong></p>
<ul>
<li>小型项目，配置简单</li>
<li>希望减少配置文件数量</li>
<li>配置无需注释说明</li>
</ul>
<p><strong>不适用场景：</strong></p>
<ul>
<li>需要使用注释</li>
<li>配置复杂，需要分组说明</li>
<li>使用 overrides 较多</li>
</ul>
<h3 data-id="heading-9">2.6 各格式对比</h3>















































<table><thead><tr><th>格式</th><th>注释支持</th><th>动态配置</th><th>类型提示</th><th>推荐场景</th></tr></thead><tbody><tr><td>JSON</td><td>否</td><td>否</td><td>有限</td><td>简单项目、快速配置</td></tr><tr><td>YAML</td><td>是</td><td>否</td><td>否</td><td>喜欢 YAML 语法</td></tr><tr><td>TOML</td><td>是</td><td>否</td><td>否</td><td>喜欢 TOML 语法</td></tr><tr><td>JavaScript</td><td>是</td><td>是</td><td>是</td><td>复杂项目、需要插件</td></tr><tr><td>package.json</td><td>否</td><td>否</td><td>有限</td><td>减少文件数量</td></tr></tbody></table>
<blockquote>
<p><strong>建议</strong>：大多数项目使用 JSON 格式即可；需要注释说明时选择 YAML；需要动态配置或插件时选择 JavaScript。</p>
</blockquote>
<h2 data-id="heading-10">3. 核心配置选项</h2>
<h3 data-id="heading-11">3.1 打印相关</h3>
<p>控制代码的基本排版方式。</p>





























<table><thead><tr><th>选项</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>printWidth</code></td><td>number</td><td>80</td><td>每行最大字符数</td></tr><tr><td><code>tabWidth</code></td><td>number</td><td>2</td><td>缩进空格数</td></tr><tr><td><code>useTabs</code></td><td>boolean</td><td>false</td><td>使用 Tab 缩进而非空格</td></tr></tbody></table>
<p><strong>printWidth 示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ printWidth: 40（行宽太窄，频繁换行）</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">calculateTotal</span>(items, discount, tax);

<span class="hljs-comment">// ✅ printWidth: 80（默认，平衡可读性）</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">calculateTotal</span>(items, discount, tax);

<span class="hljs-comment">// printWidth: 120（宽屏显示器）</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">calculateTotal</span>(items, discount, tax, shippingCost, serviceFee);
</code></pre>
<blockquote>
<p><strong>提示</strong>：<code>printWidth</code> 不是严格限制，而是 Prettier 的「目标」。某些情况下（如长字符串）可能超出此宽度。</p>
</blockquote>
<p><strong>tabWidth 与 useTabs 示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ tabWidth: 2, useTabs: false（推荐）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> x = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">return</span> x;
}

<span class="hljs-comment">// tabWidth: 4, useTabs: false</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> x = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> x;
}

<span class="hljs-comment">// useTabs: true（使用 Tab 字符）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params"/>) {
→ <span class="hljs-keyword">const</span> x = <span class="hljs-number">1</span>;  <span class="hljs-comment">// → 表示 Tab 字符</span>
→ <span class="hljs-keyword">return</span> x;
}
</code></pre>
<h3 data-id="heading-12">3.2 语法风格</h3>
<p>控制 JavaScript/TypeScript 的语法风格。</p>















































<table><thead><tr><th>选项</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>semi</code></td><td>boolean</td><td>true</td><td>语句末尾添加分号</td></tr><tr><td><code>singleQuote</code></td><td>boolean</td><td>false</td><td>使用单引号而非双引号</td></tr><tr><td><code>jsxSingleQuote</code></td><td>boolean</td><td>false</td><td>JSX 中使用单引号</td></tr><tr><td><code>quoteProps</code></td><td>"as-needed" | "consistent" | "preserve"</td><td>"as-needed"</td><td>对象属性引号策略</td></tr><tr><td><code>trailingComma</code></td><td>"all" | "es5" | "none"</td><td>"all"</td><td>尾随逗号策略</td></tr><tr><td><code>arrowParens</code></td><td>"always" | "avoid"</td><td>"always"</td><td>箭头函数单参数是否加括号</td></tr></tbody></table>
<p><strong>semi 示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ semi: true（默认，推荐）</span>
<span class="hljs-keyword">const</span> name = <span class="hljs-string">"Prettier"</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello"</span>;
}

<span class="hljs-comment">// semi: false（无分号风格）</span>
<span class="hljs-keyword">const</span> name = <span class="hljs-string">"Prettier"</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello"</span>
}
</code></pre>
<p><strong>singleQuote 示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// singleQuote: false（默认）</span>
<span class="hljs-keyword">const</span> message = <span class="hljs-string">"Hello, World!"</span>;

<span class="hljs-comment">// ✅ singleQuote: true（常用于 JavaScript 项目）</span>
<span class="hljs-keyword">const</span> message = <span class="hljs-string">'Hello, World!'</span>;
</code></pre>
<blockquote>
<p><strong>注意</strong>：<code>singleQuote</code> 不影响 JSX 属性，JSX 属性由 <code>jsxSingleQuote</code> 控制。</p>
</blockquote>
<p><strong>jsxSingleQuote 示例：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// jsxSingleQuote: false（默认）</span>
&lt;div className=<span class="hljs-string">"container"</span>&gt;<span class="hljs-title class_">Hello</span>&lt;/div&gt;

<span class="hljs-comment">// jsxSingleQuote: true</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'container'</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre>
<p><strong>quoteProps 示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// quoteProps: "as-needed"（默认，仅在必要时加引号）</span>
<span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"value"</span>,
  <span class="hljs-string">"content-type"</span>: <span class="hljs-string">"application/json"</span>, <span class="hljs-comment">// 包含连字符，必须加引号</span>
};

<span class="hljs-comment">// quoteProps: "consistent"（只要有一个需要引号，全部加引号）</span>
<span class="hljs-keyword">const</span> obj = {
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"value"</span>,
  <span class="hljs-string">"content-type"</span>: <span class="hljs-string">"application/json"</span>,
};

<span class="hljs-comment">// quoteProps: "preserve"（保留原始写法）</span>
<span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"value"</span>, <span class="hljs-comment">// 原来没引号就没引号</span>
  <span class="hljs-string">"origin"</span>: <span class="hljs-string">"prettier.io"</span>, <span class="hljs-comment">// 原来有引号就保留</span>
};
</code></pre>
<p><strong>trailingComma 示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// trailingComma: "none"（不加尾随逗号）</span>
<span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">foo</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">bar</span>: <span class="hljs-number">2</span>
};

<span class="hljs-comment">// trailingComma: "es5"（ES5 支持的地方加逗号）</span>
<span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">foo</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">bar</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// ← 对象和数组可以</span>
};
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params">a, b</span>) {} <span class="hljs-comment">// ← 函数参数不加</span>

<span class="hljs-comment">// ✅ trailingComma: "all"（默认，所有地方都加）</span>
<span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">foo</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">bar</span>: <span class="hljs-number">2</span>,
};
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params">
  a,
  b, <span class="hljs-comment">// ← 函数参数也加</span>
</span>) {}
</code></pre>
<blockquote>
<p><strong>提示</strong>：<code>trailingComma: "all"</code> 有助于减少 Git diff 中的无关变更。</p>
</blockquote>
<blockquote>
<p><strong>注意</strong>：Prettier v3 起，默认值从 <code>"es5"</code> 改为 <code>"all"</code>。如果项目使用 Prettier v2.x，默认值是 <code>"es5"</code>。</p>
</blockquote>
<p><strong>arrowParens 示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ arrowParens: "always"（默认，始终加括号）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">double</span> = (<span class="hljs-params">x</span>) =&gt; x * <span class="hljs-number">2</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;

<span class="hljs-comment">// arrowParens: "avoid"（单参数时省略括号）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">double</span> = x =&gt; x * <span class="hljs-number">2</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b; <span class="hljs-comment">// 多参数仍需括号</span>
</code></pre>
<h3 data-id="heading-13">3.3 括号与空格</h3>
<p>控制括号和空格的使用方式。</p>























<table><thead><tr><th>选项</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>bracketSpacing</code></td><td>boolean</td><td>true</td><td>对象字面量括号内加空格</td></tr><tr><td><code>bracketSameLine</code></td><td>boolean</td><td>false</td><td>多行元素的 <code>&gt;</code> 放在最后一行</td></tr></tbody></table>
<p><strong>bracketSpacing 示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ bracketSpacing: true（默认）</span>
<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">foo</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">bar</span>: <span class="hljs-number">2</span> };

<span class="hljs-comment">// bracketSpacing: false</span>
<span class="hljs-keyword">const</span> obj = {<span class="hljs-attr">foo</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">bar</span>: <span class="hljs-number">2</span>};
</code></pre>
<p><strong>bracketSameLine 示例：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// bracketSameLine: false（默认）</span>
&lt;button
  className=<span class="hljs-string">"primary"</span>
  onClick={handleClick}
&gt;
  <span class="hljs-title class_">Click</span> me
&lt;/button&gt;

<span class="hljs-comment">// bracketSameLine: true</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>
  <span class="hljs-attr">className</span>=<span class="hljs-string">"primary"</span>
  <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>
  Click me
<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-14">3.4 特殊处理</h3>
<p>针对特定场景的配置选项。</p>















































<table><thead><tr><th>选项</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>proseWrap</code></td><td>"always" | "never" | "preserve"</td><td>"preserve"</td><td>Markdown 换行处理</td></tr><tr><td><code>htmlWhitespaceSensitivity</code></td><td>"css" | "strict" | "ignore"</td><td>"css"</td><td>HTML 空白敏感度</td></tr><tr><td><code>endOfLine</code></td><td>"lf" | "crlf" | "cr" | "auto"</td><td>"lf"</td><td>行尾符号</td></tr><tr><td><code>singleAttributePerLine</code></td><td>boolean</td><td>false</td><td>HTML/JSX 每行一个属性</td></tr><tr><td><code>embeddedLanguageFormatting</code></td><td>"auto" | "off"</td><td>"auto"</td><td>嵌入代码格式化</td></tr><tr><td><code>experimentalTernaries</code></td><td>boolean</td><td>false</td><td>实验性三元表达式格式化</td></tr></tbody></table>
<p><strong>proseWrap 示例：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">&lt;!-- proseWrap: "preserve"（默认，保留原始换行） --&gt;

This is a very long line that was written this way in the original file.
It will stay on one line.

&lt;!-- proseWrap: "always"（按 printWidth 自动换行） --&gt;

This is a very long line that was
written this way in the original file.
It will be wrapped.

&lt;!-- proseWrap: "never"（段落合并为一行） --&gt;

This is a very long line that was written this way in the original file. It will stay on one line.
</code></pre>
<p><strong>htmlWhitespaceSensitivity 示例：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- htmlWhitespaceSensitivity: "css"（默认，遵循 CSS display 属性） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>inline<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>block<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-comment">&lt;!-- htmlWhitespaceSensitivity: "strict"（严格保留空白） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>inline<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>block<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-comment">&lt;!-- htmlWhitespaceSensitivity: "ignore"（忽略空白敏感性） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span> inline <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>block<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><strong>endOfLine 示例：</strong></p>






























<table><thead><tr><th>值</th><th>行尾符号</th><th>适用系统</th></tr></thead><tbody><tr><td><code>lf</code></td><td><code>\n</code></td><td>Linux、macOS</td></tr><tr><td><code>crlf</code></td><td><code>\r\n</code></td><td>Windows</td></tr><tr><td><code>cr</code></td><td><code>\r</code></td><td>旧版 macOS（罕见）</td></tr><tr><td><code>auto</code></td><td>保留文件原有</td><td>混合环境</td></tr></tbody></table>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"endOfLine"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lf"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p><strong>提示</strong>：推荐使用 <code>"lf"</code>，配合 Git 的 <code>core.autocrlf</code> 设置处理跨平台问题。</p>
</blockquote>
<p><strong>singleAttributePerLine 示例：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- singleAttributePerLine: false（默认） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-a</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">data-b</span>=<span class="hljs-string">"2"</span> <span class="hljs-attr">data-c</span>=<span class="hljs-string">"3"</span>&gt;</span>content<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-comment">&lt;!-- singleAttributePerLine: true --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">data-a</span>=<span class="hljs-string">"1"</span>
  <span class="hljs-attr">data-b</span>=<span class="hljs-string">"2"</span>
  <span class="hljs-attr">data-c</span>=<span class="hljs-string">"3"</span>&gt;</span>
  content
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-15">3.5 配置选项速查表</h3>

















































































































<table><thead><tr><th>选项</th><th>默认值</th><th>CLI 参数</th><th>说明</th></tr></thead><tbody><tr><td><code>printWidth</code></td><td>80</td><td><code>--print-width &lt;int&gt;</code></td><td>行宽</td></tr><tr><td><code>tabWidth</code></td><td>2</td><td><code>--tab-width &lt;int&gt;</code></td><td>Tab 宽度</td></tr><tr><td><code>useTabs</code></td><td>false</td><td><code>--use-tabs</code></td><td>使用 Tab</td></tr><tr><td><code>semi</code></td><td>true</td><td><code>--no-semi</code></td><td>分号</td></tr><tr><td><code>singleQuote</code></td><td>false</td><td><code>--single-quote</code></td><td>单引号</td></tr><tr><td><code>jsxSingleQuote</code></td><td>false</td><td><code>--jsx-single-quote</code></td><td>JSX 单引号</td></tr><tr><td><code>quoteProps</code></td><td>"as-needed"</td><td><code>--quote-props &lt;as-needed|...&gt;</code></td><td>属性引号</td></tr><tr><td><code>trailingComma</code></td><td>"all"</td><td><code>--trailing-comma &lt;all|...&gt;</code></td><td>尾随逗号</td></tr><tr><td><code>bracketSpacing</code></td><td>true</td><td><code>--no-bracket-spacing</code></td><td>括号空格</td></tr><tr><td><code>bracketSameLine</code></td><td>false</td><td><code>--bracket-same-line</code></td><td>括号同行</td></tr><tr><td><code>arrowParens</code></td><td>"always"</td><td><code>--arrow-parens &lt;always|avoid&gt;</code></td><td>箭头函数括号</td></tr><tr><td><code>proseWrap</code></td><td>"preserve"</td><td><code>--prose-wrap &lt;preserve|...&gt;</code></td><td>Markdown 换行</td></tr><tr><td><code>htmlWhitespaceSensitivity</code></td><td>"css"</td><td><code>--html-whitespace-sensitivity</code></td><td>HTML 空白</td></tr><tr><td><code>endOfLine</code></td><td>"lf"</td><td><code>--end-of-line &lt;lf|crlf|...&gt;</code></td><td>行尾符号</td></tr><tr><td><code>singleAttributePerLine</code></td><td>false</td><td><code>--single-attribute-per-line</code></td><td>单属性一行</td></tr><tr><td><code>embeddedLanguageFormatting</code></td><td>"auto"</td><td><code>--embedded-language-formatting</code></td><td>嵌入代码格式化</td></tr><tr><td><code>experimentalTernaries</code></td><td>false</td><td><code>--experimental-ternaries</code></td><td>实验性三元格式</td></tr></tbody></table>
<h2 data-id="heading-16">4. 配置作用域</h2>
<p>了解了配置选项后，接下来需要理解这些配置在哪里生效——Prettier 支持全局、项目、目录等多个层级的配置。</p>
<h3 data-id="heading-17">4.1 全局配置</h3>
<p>全局配置位于用户主目录，作为所有项目的默认配置。</p>
<p><strong>配置文件位置：</strong></p>





















<table><thead><tr><th>系统</th><th>路径</th></tr></thead><tbody><tr><td>macOS</td><td><code>~/.prettierrc</code></td></tr><tr><td>Linux</td><td><code>~/.prettierrc</code></td></tr><tr><td>Windows</td><td><code>%USERPROFILE%\.prettierrc</code></td></tr></tbody></table>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建全局配置</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'{"singleQuote": true, "semi": false}'</span> &gt; ~/.prettierrc
</code></pre>
<blockquote>
<p><strong>注意</strong>：项目级配置优先于全局配置。全局配置主要用于个人习惯的默认值。</p>
</blockquote>
<h3 data-id="heading-18">4.2 目录级配置</h3>
<p>子目录可以有自己的配置文件，覆盖父目录的配置。</p>
<pre><code class="hljs language-bash" lang="bash">project/
├── .prettierrc              <span class="hljs-comment"># 项目默认配置</span>
│   {
│     <span class="hljs-string">"semi"</span>: <span class="hljs-literal">true</span>,
│     <span class="hljs-string">"singleQuote"</span>: <span class="hljs-literal">true</span>
│   }
├── src/
│   └── index.js             <span class="hljs-comment"># 使用项目配置</span>
├── legacy/
│   ├── .prettierrc          <span class="hljs-comment"># legacy 目录配置</span>
│   │   {
│   │     <span class="hljs-string">"semi"</span>: <span class="hljs-literal">false</span>,     <span class="hljs-comment"># 覆盖项目配置</span>
│   │     <span class="hljs-string">"printWidth"</span>: 120
│   │   }
│   └── old-code.js          <span class="hljs-comment"># 使用 legacy 配置</span>
└── tests/
    └── test.js              <span class="hljs-comment"># 使用项目配置</span>
</code></pre>
<p><strong>配置继承规则：</strong></p>
<ul>
<li>子目录配置<strong>完全覆盖</strong>父目录配置，不是合并</li>
<li>如果需要「继承 + 覆盖」，考虑使用 <code>overrides</code></li>
</ul>
<h3 data-id="heading-19">4.3 overrides 文件级覆盖</h3>
<p><code>overrides</code> 允许为特定文件或目录设置不同的配置，是最灵活的配置方式。</p>
<p><strong>基本语法：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"overrides"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*.test.js"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>files 支持的模式：</strong></p>

































<table><thead><tr><th>模式</th><th>说明</th></tr></thead><tbody><tr><td><code>"*.js"</code></td><td>所有 .js 文件</td></tr><tr><td><code>"**/*.js"</code></td><td>递归匹配所有 .js 文件</td></tr><tr><td><code>"*.{js,jsx}"</code></td><td>.js 和 .jsx 文件</td></tr><tr><td><code>"src/**/*.ts"</code></td><td>src 目录下所有 .ts 文件</td></tr><tr><td><code>"legacy/**/*"</code></td><td>legacy 目录下所有文件</td></tr><tr><td><code>["*.js", "*.ts"]</code></td><td>数组形式，匹配多种模式</td></tr></tbody></table>
<p><strong>完整示例：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">80</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>

  <span class="hljs-attr">"overrides"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*.test.{js,ts}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">120</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"*.json"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"*.jsonc"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"parser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"json"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"none"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*.md"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"proseWrap"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"always"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"legacy/**/*.js"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"tabWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">120</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".prettierrc"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"parser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"json"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>指定解析器：</strong></p>
<p>某些文件 Prettier 无法自动识别类型，需要手动指定 <code>parser</code>。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"overrides"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".babelrc"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"parser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"json"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*.svg"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"parser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"html"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*.wxss"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"parser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"css"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-20">5. .prettierignore</h2>
<h3 data-id="heading-21">5.1 语法规则</h3>
<p><code>.prettierignore</code> 用于指定不需要格式化的文件和目录，语法与 <code>.gitignore</code> 相同。</p>
<p><strong>基本规则：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 这是注释</span>

<span class="hljs-comment"># 忽略整个目录</span>
node_modules/
dist/
build/
coverage/

<span class="hljs-comment"># 忽略特定文件</span>
package-lock.json
pnpm-lock.yaml
yarn.lock

<span class="hljs-comment"># 忽略特定扩展名</span>
*.min.js
*.min.css

<span class="hljs-comment"># 通配符</span>
**/*.snap
**/fixtures/**
</code></pre>
<p><strong>常用语法：</strong></p>





































<table><thead><tr><th>模式</th><th>说明</th></tr></thead><tbody><tr><td><code>#</code></td><td>注释</td></tr><tr><td><code>file.txt</code></td><td>忽略任意位置的 file.txt</td></tr><tr><td><code>/file.txt</code></td><td>仅忽略根目录的 file.txt</td></tr><tr><td><code>dir/</code></td><td>忽略目录</td></tr><tr><td><code>*.log</code></td><td>忽略所有 .log 文件</td></tr><tr><td><code>**/*.test.js</code></td><td>递归忽略所有 .test.js 文件</td></tr><tr><td><code>!important.js</code></td><td>不忽略 important.js（取反）</td></tr></tbody></table>
<h3 data-id="heading-22">5.2 与 .gitignore 的异同</h3>






























<table><thead><tr><th>特性</th><th>.prettierignore</th><th>.gitignore</th></tr></thead><tbody><tr><td>语法</td><td>gitignore 语法</td><td>gitignore 语法</td></tr><tr><td>用途</td><td>排除格式化</td><td>排除版本控制</td></tr><tr><td>默认忽略</td><td>node_modules（v3+）</td><td>无</td></tr><tr><td>继承 .gitignore</td><td>是（自动读取）</td><td>-</td></tr></tbody></table>
<p><strong>Prettier v3 的默认行为：</strong></p>
<p>Prettier v3 默认忽略以下目录，无需在 <code>.prettierignore</code> 中声明：</p>
<pre><code class="hljs language-bash" lang="bash">**/.git
**/.svn
**/.hg
**/node_modules
</code></pre>
<blockquote>
<p><strong>提示</strong>：使用 <code>--with-node-modules</code> 参数可以强制格式化 node_modules 中的文件。</p>
</blockquote>
<h3 data-id="heading-23">5.3 常见忽略模式</h3>
<p><strong>前端项目：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .prettierignore</span>

<span class="hljs-comment"># 构建产物</span>
dist/
build/
.next/
.nuxt/
out/

<span class="hljs-comment"># 依赖</span>
node_modules/

<span class="hljs-comment"># 锁文件</span>
package-lock.json
pnpm-lock.yaml
yarn.lock

<span class="hljs-comment"># 缓存</span>
.cache/
*.tsbuildinfo

<span class="hljs-comment"># 压缩文件</span>
*.min.js
*.min.css

<span class="hljs-comment"># 自动生成的文件</span>
*.generated.*
src/graphql/generated/

<span class="hljs-comment"># 测试覆盖率</span>
coverage/

<span class="hljs-comment"># IDE</span>
.idea/
.vscode/
</code></pre>
<p><strong>Monorepo 项目：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .prettierignore</span>

<span class="hljs-comment"># 全局忽略</span>
**/node_modules/
**/dist/
**/build/
**/coverage/

<span class="hljs-comment"># 锁文件</span>
pnpm-lock.yaml
yarn.lock
package-lock.json

<span class="hljs-comment"># 特定包的忽略</span>
packages/legacy/**
apps/old-app/**

<span class="hljs-comment"># 自动生成</span>
**/generated/
**/*.generated.*
</code></pre>
<h2 data-id="heading-24">6. 实战配置示例</h2>
<p>前面介绍了配置文件的格式、选项和作用域，本节将这些知识整合为可直接使用的配置模板。</p>
<h3 data-id="heading-25">6.1 前端项目配置</h3>
<p>适用于 React/Vue/Angular 等前端项目。</p>
<p><strong><code>.prettierrc.json</code>：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tabWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"useTabs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"jsxSingleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es5"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bracketSpacing"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bracketSameLine"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"arrowParens"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"avoid"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"endOfLine"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lf"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"overrides"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*.json"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"none"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*.md"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"proseWrap"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"preserve"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong><code>.prettierignore</code>：</strong></p>
<pre><code class="hljs language-bash" lang="bash">dist/
build/
coverage/
node_modules/
*.min.js
*.min.css
package-lock.json
</code></pre>
<h3 data-id="heading-26">6.2 全栈项目配置</h3>
<p>适用于 Node.js 后端 + 前端的全栈项目。</p>
<p><strong><code>prettier.config.js</code>：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// prettier.config.js</span>
<span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {<span class="hljs-type">import("prettier").Config</span>} */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 基础配置</span>
  <span class="hljs-attr">printWidth</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attr">tabWidth</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">useTabs</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">semi</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">singleQuote</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">trailingComma</span>: <span class="hljs-string">"es5"</span>,
  <span class="hljs-attr">bracketSpacing</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">arrowParens</span>: <span class="hljs-string">"avoid"</span>,
  <span class="hljs-attr">endOfLine</span>: <span class="hljs-string">"lf"</span>,

  <span class="hljs-comment">// 插件</span>
  <span class="hljs-attr">plugins</span>: [<span class="hljs-string">"prettier-plugin-tailwindcss"</span>],

  <span class="hljs-comment">// 针对不同文件类型的配置</span>
  <span class="hljs-attr">overrides</span>: [
    <span class="hljs-comment">// 前端代码</span>
    {
      <span class="hljs-attr">files</span>: [<span class="hljs-string">"src/client/**/*.{js,jsx,ts,tsx}"</span>],
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">printWidth</span>: <span class="hljs-number">80</span>,
        <span class="hljs-attr">jsxSingleQuote</span>: <span class="hljs-literal">false</span>,
      },
    },
    <span class="hljs-comment">// 后端代码</span>
    {
      <span class="hljs-attr">files</span>: [<span class="hljs-string">"src/server/**/*.{js,ts}"</span>],
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">printWidth</span>: <span class="hljs-number">120</span>,
      },
    },
    <span class="hljs-comment">// 测试文件</span>
    {
      <span class="hljs-attr">files</span>: [<span class="hljs-string">"**/*.test.{js,ts}"</span>, <span class="hljs-string">"**/*.spec.{js,ts}"</span>],
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">printWidth</span>: <span class="hljs-number">120</span>,
      },
    },
    <span class="hljs-comment">// JSON 配置文件</span>
    {
      <span class="hljs-attr">files</span>: [<span class="hljs-string">"*.json"</span>, <span class="hljs-string">".prettierrc"</span>],
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">parser</span>: <span class="hljs-string">"json"</span>,
        <span class="hljs-attr">trailingComma</span>: <span class="hljs-string">"none"</span>,
      },
    },
    <span class="hljs-comment">// Markdown 文档</span>
    {
      <span class="hljs-attr">files</span>: <span class="hljs-string">"*.md"</span>,
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">proseWrap</span>: <span class="hljs-string">"always"</span>,
        <span class="hljs-attr">printWidth</span>: <span class="hljs-number">80</span>,
      },
    },
  ],
};
</code></pre>
<p><strong><code>.prettierignore</code>：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建产物</span>
dist/
build/
.next/

<span class="hljs-comment"># 依赖</span>
node_modules/

<span class="hljs-comment"># 数据库</span>
*.sqlite
*.db

<span class="hljs-comment"># 日志</span>
logs/
*.<span class="hljs-built_in">log</span>

<span class="hljs-comment"># 环境配置</span>
.<span class="hljs-built_in">env</span>*

<span class="hljs-comment"># 锁文件</span>
package-lock.json
pnpm-lock.yaml

<span class="hljs-comment"># 自动生成</span>
src/generated/
prisma/generated/
</code></pre>
<h3 data-id="heading-27">6.3 Monorepo 配置</h3>
<p>适用于使用 pnpm/Yarn/Lerna 的 Monorepo 项目。</p>
<p><strong>项目结构：</strong></p>
<pre><code class="hljs language-bash" lang="bash">monorepo/
├── .prettierrc.js           <span class="hljs-comment"># 根配置</span>
├── .prettierignore          <span class="hljs-comment"># 根忽略文件</span>
├── packages/
│   ├── ui/                  <span class="hljs-comment"># UI 组件库</span>
│   │   └── .prettierrc.js   <span class="hljs-comment"># 可选：包级配置</span>
│   ├── utils/               <span class="hljs-comment"># 工具库</span>
│   └── eslint-config/       <span class="hljs-comment"># ESLint 配置</span>
├── apps/
│   ├── web/                 <span class="hljs-comment"># Web 应用</span>
│   └── docs/                <span class="hljs-comment"># 文档站点</span>
└── package.json
</code></pre>
<p><strong>根目录 <code>.prettierrc.js</code>：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// .prettierrc.js</span>
<span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {<span class="hljs-type">import("prettier").Config</span>} */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 通用配置</span>
  <span class="hljs-attr">printWidth</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attr">tabWidth</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">useTabs</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">semi</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">singleQuote</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">trailingComma</span>: <span class="hljs-string">"es5"</span>,
  <span class="hljs-attr">bracketSpacing</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">arrowParens</span>: <span class="hljs-string">"avoid"</span>,
  <span class="hljs-attr">endOfLine</span>: <span class="hljs-string">"lf"</span>,

  <span class="hljs-comment">// Monorepo 特定配置</span>
  <span class="hljs-attr">overrides</span>: [
    <span class="hljs-comment">// UI 组件库</span>
    {
      <span class="hljs-attr">files</span>: <span class="hljs-string">"packages/ui/**/*.{js,jsx,ts,tsx}"</span>,
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">printWidth</span>: <span class="hljs-number">80</span>,
        <span class="hljs-attr">singleAttributePerLine</span>: <span class="hljs-literal">true</span>,
      },
    },
    <span class="hljs-comment">// 文档站点</span>
    {
      <span class="hljs-attr">files</span>: <span class="hljs-string">"apps/docs/**/*.{md,mdx}"</span>,
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">proseWrap</span>: <span class="hljs-string">"always"</span>,
        <span class="hljs-attr">printWidth</span>: <span class="hljs-number">80</span>,
      },
    },
    <span class="hljs-comment">// 配置文件</span>
    {
      <span class="hljs-attr">files</span>: [
        <span class="hljs-string">"*.config.{js,ts,mjs,cjs}"</span>,
        <span class="hljs-string">".prettierrc.js"</span>,
        <span class="hljs-string">"packages/eslint-config/**/*.js"</span>,
      ],
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">printWidth</span>: <span class="hljs-number">120</span>,
      },
    },
    <span class="hljs-comment">// JSON 文件</span>
    {
      <span class="hljs-attr">files</span>: [<span class="hljs-string">"*.json"</span>, <span class="hljs-string">"**/package.json"</span>],
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">trailingComma</span>: <span class="hljs-string">"none"</span>,
      },
    },
  ],
};
</code></pre>
<p><strong>根目录 <code>.prettierignore</code>：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建产物</span>
**/dist/
**/build/
**/.next/
**/out/

<span class="hljs-comment"># 依赖</span>
**/node_modules/

<span class="hljs-comment"># 锁文件</span>
pnpm-lock.yaml

<span class="hljs-comment"># 缓存</span>
**/.turbo/
**/.cache/
*.tsbuildinfo

<span class="hljs-comment"># 自动生成</span>
**/generated/
**/coverage/

<span class="hljs-comment"># 特殊目录</span>
packages/legacy/
</code></pre>
<p><strong>包级配置（可选）：</strong></p>
<p>如果某个包需要完全不同的配置，可以在包目录下创建独立的配置文件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// packages/legacy/.prettierrc.js</span>
<span class="hljs-comment">// 旧代码使用不同的风格</span>

<span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {<span class="hljs-type">import("prettier").Config</span>} */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">printWidth</span>: <span class="hljs-number">120</span>,
  <span class="hljs-attr">tabWidth</span>: <span class="hljs-number">4</span>,
  <span class="hljs-attr">semi</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">singleQuote</span>: <span class="hljs-literal">false</span>,
};
</code></pre>
<h2 data-id="heading-28">7. 总结</h2>
<h3 data-id="heading-29">7.1 核心要点回顾</h3>





























<table><thead><tr><th>要点</th><th>说明</th></tr></thead><tbody><tr><td>配置优先级</td><td>CLI &gt; 配置文件 &gt; 编辑器 &gt; 默认值</td></tr><tr><td>配置格式选择</td><td>简单项目用 JSON，复杂项目用 JavaScript</td></tr><tr><td>overrides</td><td>为特定文件类型设置不同配置的最佳方式</td></tr><tr><td>.prettierignore</td><td>使用 gitignore 语法排除不需要格式化的文件</td></tr><tr><td>配置继承</td><td>子目录配置完全覆盖父目录，非合并</td></tr></tbody></table>
<h3 data-id="heading-30">7.2 推荐配置</h3>
<p><strong>适合大多数项目的配置：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tabWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"useTabs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es5"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bracketSpacing"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"arrowParens"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"avoid"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"endOfLine"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lf"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-31">7.3 配置检查清单</h3>

































<table><thead><tr><th>检查项</th><th>建议</th></tr></thead><tbody><tr><td>配置文件位置</td><td>项目根目录</td></tr><tr><td>配置文件数量</td><td>一个项目一个配置文件</td></tr><tr><td>overrides 使用</td><td>用于不同文件类型的差异化配置</td></tr><tr><td>.prettierignore</td><td>排除构建产物、依赖、锁文件</td></tr><tr><td>与团队协商</td><td>配置应得到团队一致同意</td></tr><tr><td>版本控制</td><td>配置文件应提交到 Git</td></tr></tbody></table>
<h2 data-id="heading-32">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fprettier.io%2Fdocs%2Fen%2Fconfiguration" target="_blank" title="https://prettier.io/docs/en/configuration" ref="nofollow noopener noreferrer">Prettier Configuration</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fprettier.io%2Fdocs%2Fen%2Foptions" target="_blank" title="https://prettier.io/docs/en/options" ref="nofollow noopener noreferrer">Prettier Options</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fprettier.io%2Fdocs%2Fen%2Fignore" target="_blank" title="https://prettier.io/docs/en/ignore" ref="nofollow noopener noreferrer">Prettier Ignoring Code</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fprettier.io%2Fdocs%2Fen%2Fcli" target="_blank" title="https://prettier.io/docs/en/cli" ref="nofollow noopener noreferrer">Prettier CLI</a></li>
<li><a href="https://juejin.cn/post/7599581687358341170" target="_blank" title="https://juejin.cn/post/7599581687358341170">Prettier 基础概念与原理</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浏览器的垃圾回收机制是什么]]></title>    <link>https://juejin.cn/post/7602834985901834290</link>    <guid>https://juejin.cn/post/7602834985901834290</guid>    <pubDate>2026-02-04T14:52:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602834985901834290" data-draft-id="7602850166730997769" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浏览器的垃圾回收机制是什么"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-04T14:52:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浏览器的垃圾回收机制是什么
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T14:52:50.000Z" title="Wed Feb 04 2026 14:52:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>浏览器的垃圾回收（Garbage Collection，GC）机制是JavaScript引擎自动管理内存的核心机制，用于识别和回收不再使用的内存空间，防止内存泄漏。</p>
<h2 data-id="heading-0">一、垃圾回收的基本原理</h2>
<h3 data-id="heading-1">1. <strong>核心概念</strong></h3>
<ul>
<li><strong>可达性（Reachability）</strong> ：从根对象（全局变量、活动函数局部变量等）出发，能够访问到的对象就是“可达的”，需要保留</li>
<li><strong>不可达对象</strong>：无法从根对象访问到的对象，被视为垃圾，可以被回收</li>
</ul>
<h3 data-id="heading-2">2. <strong>根对象（Roots）</strong></h3>
<ul>
<li>全局对象（window/global）</li>
<li>当前函数的局部变量和参数</li>
<li>嵌套调用链上的其他函数的变量</li>
<li>DOM元素引用</li>
<li>其他全局对象</li>
</ul>
<h2 data-id="heading-3">二、主要的垃圾回收算法</h2>
<h3 data-id="heading-4">1. <strong>标记-清除算法（Mark-and-Sweep）</strong> （最常用）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 示例：对象引用关系</span>
<span class="hljs-keyword">let</span> obj1 = { <span class="hljs-attr">name</span>: <span class="hljs-string">'obj1'</span> };  <span class="hljs-comment">// 可达</span>
<span class="hljs-keyword">let</span> obj2 = obj1;              <span class="hljs-comment">// 可达</span>
obj1 = <span class="hljs-literal">null</span>;                  <span class="hljs-comment">// obj2仍然可达</span>
<span class="hljs-comment">// obj2 = null;               // 如果取消注释，对象变为不可达</span>
</code></pre>
<p><strong>过程</strong>：</p>
<ol>
<li><strong>标记阶段</strong>：从根对象开始，标记所有可达对象</li>
<li><strong>清除阶段</strong>：遍历堆内存，清除未标记的对象</li>
</ol>
<h3 data-id="heading-5">2. <strong>引用计数算法（Reference Counting）</strong> （逐渐被淘汰）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 问题：循环引用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">problem</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> objA = {};  <span class="hljs-comment">// objA引用计数：1</span>
    <span class="hljs-keyword">let</span> objB = {};  <span class="hljs-comment">// objB引用计数：1</span>
    
    objA.<span class="hljs-property">ref</span> = objB;  <span class="hljs-comment">// objB引用计数：2</span>
    objB.<span class="hljs-property">ref</span> = objA;  <span class="hljs-comment">// objA引用计数：2</span>
    
    <span class="hljs-comment">// 函数结束，objA和objB局部引用消失</span>
    <span class="hljs-comment">// objA引用计数：1，objB引用计数：1</span>
    <span class="hljs-comment">// 但两者都无法被访问，却无法回收 - 内存泄漏！</span>
}
</code></pre>
<h2 data-id="heading-6">三、现代浏览器的优化策略</h2>
<h3 data-id="heading-7">1. <strong>分代回收（Generational Collection）</strong></h3>
<ul>
<li>
<p><strong>新生代（Young Generation）</strong> ：新创建的对象</p>
<ul>
<li>使用<strong>Scavenge算法</strong>（复制算法）</li>
<li>分为From空间和To空间</li>
<li>回收频繁，速度快</li>
</ul>
</li>
<li>
<p><strong>老生代（Old Generation）</strong> ：存活时间长的对象</p>
<ul>
<li>使用<strong>标记-清除/标记-整理算法</strong></li>
<li>回收频率低，但耗时较长</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">2. <strong>增量回收（Incremental Collection）</strong></h3>
<ul>
<li>将完整的GC过程分成多个小步骤</li>
<li>与JavaScript执行交替进行</li>
<li>减少单次GC的停顿时间</li>
</ul>
<h3 data-id="heading-9">3. <strong>空闲时间回收（Idle-time Collection）</strong></h3>
<ul>
<li>利用浏览器的空闲时间进行GC</li>
<li>Chrome的Idle Until Urgent机制</li>
</ul>
<h2 data-id="heading-10">四、V8引擎的垃圾回收（以Chrome为例）</h2>
<h3 data-id="heading-11">1. <strong>新生代回收：Scavenge算法</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 新生代空间（通常1-8MB）</span>
<span class="hljs-comment">// 对象晋升条件：</span>
<span class="hljs-comment">// 1. 经历过一次Scavenge回收</span>
<span class="hljs-comment">// 2. To空间使用超过25%</span>
<span class="hljs-comment">// 满足任一条件则晋升到老生代</span>
</code></pre>
<h3 data-id="heading-12">2. <strong>老生代回收：三色标记法</strong></h3>
<ul>
<li><strong>白色</strong>：未被访问的对象（待回收）</li>
<li><strong>灰色</strong>：已被访问，但子引用未检查</li>
<li><strong>黑色</strong>：已被访问，且子引用已检查</li>
</ul>
<h3 data-id="heading-13">3. <strong>并行和并发回收</strong></h3>
<ul>
<li><strong>并行回收</strong>：主线程暂停，多个辅助线程并行GC</li>
<li><strong>并发回收</strong>：辅助线程并发执行GC，主线程继续执行JS</li>
</ul>
<h2 data-id="heading-14">五、内存泄漏常见场景及避免方法</h2>
<h3 data-id="heading-15">1. <strong>意外的全局变量</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ 错误：创建了全局变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">leak</span>(<span class="hljs-params"/>) {
    leaked = <span class="hljs-string">'I am global'</span>;  <span class="hljs-comment">// 没有var/let/const</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">globalVar</span> = <span class="hljs-string">'oops'</span>; <span class="hljs-comment">// 非严格模式下，this指向window</span>
}

<span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">safe</span>(<span class="hljs-params"/>) {
    <span class="hljs-string">'use strict'</span>;
    <span class="hljs-keyword">let</span> local = <span class="hljs-string">'I am local'</span>;
}
</code></pre>
<h3 data-id="heading-16">2. <strong>遗忘的定时器和回调</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ 可能泄漏</span>
<span class="hljs-keyword">let</span> data = <span class="hljs-title function_">getHugeData</span>();
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> node = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'node'</span>);
    <span class="hljs-keyword">if</span> (node) {
        node.<span class="hljs-property">innerHTML</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data); <span class="hljs-comment">// data被闭包引用</span>
    }
}, <span class="hljs-number">1000</span>);

<span class="hljs-comment">// ✅ 及时清理</span>
<span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/* ... */</span> }, <span class="hljs-number">1000</span>);
<span class="hljs-built_in">clearInterval</span>(timer); <span class="hljs-comment">// 不需要时清理</span>
</code></pre>
<h3 data-id="heading-17">3. <strong>DOM引用</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ 泄漏</span>
<span class="hljs-keyword">let</span> elements = {
    <span class="hljs-attr">button</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'button'</span>),
    <span class="hljs-attr">image</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'image'</span>)
};

<span class="hljs-comment">// 即使从DOM移除，JS引用仍然存在</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'button'</span>));

<span class="hljs-comment">// ✅ 清理引用</span>
elements.<span class="hljs-property">button</span> = <span class="hljs-literal">null</span>;
</code></pre>
<h3 data-id="heading-18">4. <strong>闭包</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ 不当使用闭包</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> largeArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'*'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>); <span class="hljs-comment">// 引用了largeArray</span>
    };
}

<span class="hljs-comment">// ✅ 适当释放</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> largeArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'*'</span>);
    <span class="hljs-comment">// 使用后置null</span>
    <span class="hljs-keyword">let</span> result = <span class="hljs-title function_">process</span>(largeArray);
    largeArray = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 帮助GC</span>
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h2 data-id="heading-19">六、开发者工具中的内存分析</h2>
<h3 data-id="heading-20">1. <strong>Chrome DevTools Memory工具</strong></h3>
<ul>
<li><strong>Heap Snapshot</strong>：堆内存快照</li>
<li><strong>Allocation Timeline</strong>：内存分配时间线</li>
<li><strong>Allocation Sampling</strong>：内存分配采样</li>
</ul>
<h3 data-id="heading-21">2. <strong>性能监控</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 监测内存使用</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> memory = performance.<span class="hljs-property">memory</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({
        <span class="hljs-attr">usedJSHeapSize</span>: memory.<span class="hljs-property">usedJSHeapSize</span> / <span class="hljs-number">1048576</span> + <span class="hljs-string">'MB'</span>,
        <span class="hljs-attr">totalJSHeapSize</span>: memory.<span class="hljs-property">totalJSHeapSize</span> / <span class="hljs-number">1048576</span> + <span class="hljs-string">'MB'</span>,
        <span class="hljs-attr">jsHeapSizeLimit</span>: memory.<span class="hljs-property">jsHeapSizeLimit</span> / <span class="hljs-number">1048576</span> + <span class="hljs-string">'MB'</span>
    });
}, <span class="hljs-number">5000</span>);
</code></pre>
<h2 data-id="heading-22">七、最佳实践</h2>
<ol>
<li><strong>及时解除引用</strong>：不再使用的对象设为<code>null</code></li>
<li><strong>避免创建全局变量</strong>：使用严格模式</li>
<li><strong>谨慎使用闭包</strong>：避免不必要的大型对象被闭包引用</li>
<li><strong>清理事件监听器</strong>：使用<code>removeEventListener</code></li>
<li><strong>使用WeakMap/WeakSet</strong>：弱引用不阻止垃圾回收</li>
<li><strong>分批处理大数据</strong>：避免一次性操作大量数据</li>
</ol>
<h2 data-id="heading-23">八、不同浏览器的差异</h2>



































<table><thead><tr><th>浏览器</th><th>引擎</th><th>主要GC算法</th><th>特点</th></tr></thead><tbody><tr><td>Chrome</td><td>V8</td><td>分代 + 增量 + 并行</td><td>性能最好，GC策略最复杂</td></tr><tr><td>Firefox</td><td>SpiderMonkey</td><td>分代 + 增量</td><td>采用Zeal GC，逐步优化</td></tr><tr><td>Safari</td><td>JavaScriptCore</td><td>分代 + 并发</td><td>低延迟GC</td></tr><tr><td>Edge</td><td>Chakra（旧）/V8（新）</td><td>类似V8</td><td>新版Edge已使用V8</td></tr></tbody></table>
<p>浏览器的垃圾回收机制是不断优化的过程，现代浏览器都在努力减少GC暂停时间，提高应用性能。作为开发者，理解这些原理有助于编写更高效、更少内存泄漏的代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[网易二面：常见的登录鉴权方法有哪些？]]></title>    <link>https://juejin.cn/post/7602837527674683407</link>    <guid>https://juejin.cn/post/7602837527674683407</guid>    <pubDate>2026-02-05T01:55:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602837527674683407" data-draft-id="7598947628450201627" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="网易二面：常见的登录鉴权方法有哪些？"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2026-02-05T01:55:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员飞鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1665088861772688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            网易二面：常见的登录鉴权方法有哪些？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1665088861772688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员飞鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T01:55:30.000Z" title="Thu Feb 05 2026 01:55:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>文章内容收录到个人网站，方便阅读</strong>：<a href="https://link.juejin.cn?target=http%3A%2F%2Fhardyfish.top%2F" target="_blank" title="http://hardyfish.top/" ref="nofollow noopener noreferrer">hardyfish.top/</a></p>
<p>登录鉴权的核心任务是两件事：<strong>认证</strong>（Authentication，确认“是谁”）与<strong>授权</strong>（Authorization，确认“能做什么”）。</p>
<p>工程上通常把“登录”视为建立认证态的过程，把“鉴权”视为每次访问资源时的权限校验。</p>
<p>常见方法大致沿着“状态放哪里、凭证怎么传、凭证怎么失效”这条主线展开。</p>
<p><strong>Cookie + Session（服务端会话）</strong></p>
<p>最传统、也最符合“浏览器站点登录”直觉的方案。</p>
<p>登录成功后，服务端创建 <strong>Session</strong>（会话），并把 <code>session_id</code> 写入浏览器 <strong>Cookie</strong>（浏览器自动随请求携带的键值对）。</p>
<ul>
<li>
<p>工作方式</p>
<ul>
<li>用户提交账号密码</li>
<li>服务端校验后生成 <code>session_id</code>，把会话数据存到内存/Redis/数据库</li>
<li>浏览器后续请求自动携带 Cookie，服务端通过 <code>session_id</code> 找回会话并鉴权</li>
</ul>
</li>
<li>
<p>优点</p>
<ul>
<li>权限即时生效、易于踢下线（删除/失效 Session）</li>
<li>适合传统 Web、管理后台</li>
</ul>
</li>
<li>
<p>局限与要点</p>
<ul>
<li>服务端有状态，横向扩展依赖共享存储（常见用 Redis）</li>
<li>需要重点防护 <strong>CSRF</strong>（跨站请求伪造），一般配合 SameSite、CSRF Token</li>
<li>Cookie 安全属性：HttpOnly、Secure、SameSite 需合理配置</li>
</ul>
</li>
</ul>
<p><strong>Token（无状态令牌，典型是 JWT）</strong></p>
<p>登录后服务端签发一个 <strong>Token</strong>（令牌），客户端保存并在请求时携带，服务端通过签名/校验规则判定合法性。</p>
<p>最常见实现是 <strong>JWT</strong>（JSON Web Token，一种自包含的签名令牌格式）。</p>
<ul>
<li>
<p>工作方式</p>
<ul>
<li>登录成功后签发 token（JWT 或自定义随机串）</li>
<li>客户端通过 <code>Authorization: Bearer &lt;token&gt;</code> 发送</li>
<li>服务端校验签名、过期时间、必要的声明（claims）并鉴权</li>
</ul>
</li>
<li>
<p>优点</p>
<ul>
<li>服务端可做到“少状态”甚至无状态，易扩展、适合 API/移动端</li>
<li>跨域与非浏览器客户端更友好</li>
</ul>
</li>
<li>
<p>局限与要点</p>
<ul>
<li>失效与撤销更难：JWT 自包含导致“签发即有效直到过期”，常需黑名单/短过期+刷新机制</li>
<li>Token 存储位置决定风险：放 LocalStorage 易受 XSS 影响；放 Cookie 又要面对 CSRF</li>
<li>JWT 不是加密，默认是签名；敏感信息不应直接放 claims</li>
</ul>
</li>
</ul>
<p><strong>Access Token + Refresh Token（短期访问 + 长期续期）</strong></p>
<p>为解决 Token 过期与频繁登录之间的矛盾，常用“双 Token”机制：<strong>Access Token</strong>（短有效期）用于每次请求；</p>
<p><strong>Refresh Token</strong>（长有效期）用于换取新的 Access Token。</p>
<ul>
<li>
<p>工作方式</p>
<ul>
<li>Access Token 5–30 分钟过期（常见口径），Refresh Token 可更长</li>
<li>Access Token 过期时用 Refresh Token 调用刷新接口换新</li>
<li>Refresh Token 通常需要服务端存储并支持吊销（旋转与黑名单）</li>
</ul>
</li>
<li>
<p>关键实践</p>
<ul>
<li><strong>Refresh Token Rotation</strong>（刷新令牌轮换）：每次刷新都发新的 refresh token，旧的立刻失效</li>
<li>设备维度管理：一台设备一个 refresh token，便于单点退出</li>
<li>风控：异常地理位置、UA 变化、刷新频率异常触发再认证</li>
</ul>
</li>
</ul>
<p><strong>OAuth 2.0 / OpenID Connect（第三方登录与统一身份）</strong></p>
<p>面向“用微信/Google/企业统一账号登录”的场景。</p>
<p><strong>OAuth 2.0</strong> 是授权框架（解决“授权第三方访问资源”），<strong>OpenID Connect（OIDC）</strong> 在 OAuth 2.0 上补齐“登录身份”能力（提供 id_token 等）。</p>
<ul>
<li>
<p>常见流程</p>
<ul>
<li>授权码模式（Authorization Code）+ PKCE：移动端与 SPA 常用，安全性较高</li>
<li>服务端应用：用授权码换取 token，再获取用户信息</li>
</ul>
</li>
<li>
<p>优点</p>
<ul>
<li>统一身份体系，减少自建密码体系风险</li>
<li>适合多应用、多系统的单点登录</li>
</ul>
</li>
<li>
<p>局限与要点</p>
<ul>
<li>需要理解授权服务器（Authorization Server）与资源服务器（Resource Server）的边界</li>
<li>回调地址、state/nonce、PKCE 校验是安全关键点</li>
</ul>
</li>
</ul>
<p><strong>SSO（单点登录：CAS / SAML / OIDC）</strong></p>
<p>企业内多系统互通时常见：一次登录，多处生效。常见协议与实现包括：</p>
<ul>
<li>
<p><strong>SAML 2.0</strong>（更偏企业与传统系统）：浏览器重定向携带断言（Assertion），适合与企业 IdP（身份提供方）对接</p>
</li>
<li>
<p><strong>CAS</strong>（Central Authentication Service）：高校与传统内部系统常见</p>
</li>
<li>
<p><strong>OIDC SSO</strong>：现代化、与 OAuth 生态兼容度高</p>
</li>
<li>
<p>典型关注点</p>
<ul>
<li>会话范围与登出：单点登出（SLO）往往比单点登录难</li>
<li>跨域 Cookie、重定向链路与安全校验（state、签名、时间戳）</li>
</ul>
</li>
</ul>
<p><strong>API Key / HMAC 签名（机器到机器的鉴权）</strong></p>
<p>面向“系统调用系统”的场景，不一定有“登录”概念。</p>
<p>常见做法是给调用方发 <strong>API Key</strong>，并用 <strong>HMAC</strong>（基于密钥的哈希消息认证码）对请求进行签名，防篡改、防重放。</p>
<ul>
<li>
<p>工作方式</p>
<ul>
<li>请求中带 <code>keyId</code> + <code>timestamp</code> + <code>nonce</code> + <code>signature</code></li>
<li>服务端用共享密钥复算签名并校验时间窗与 nonce</li>
</ul>
</li>
<li>
<p>适用场景</p>
<ul>
<li>OpenAPI、支付回调、Webhook、内部服务调用</li>
</ul>
</li>
<li>
<p>要点</p>
<ul>
<li>必须做重放防护（nonce + 时间窗 + 去重存储）</li>
<li>密钥轮换与权限最小化（按应用/按环境发放）</li>
</ul>
</li>
</ul>
<p><strong>多因素认证与无密码登录（增强认证强度）</strong></p>
<p>这类不是独立的“会话形态”，而是登录阶段的增强手段，经常与上述任何一种会话/Token 方案组合使用。</p>
<ul>
<li>
<p><strong>MFA/2FA</strong>（多因素认证）：短信/邮件验证码、TOTP（如 Google Authenticator）、Push、硬件 Key</p>
</li>
<li>
<p><strong>Passkeys/WebAuthn</strong>（通行密钥）：基于公私钥与设备生物识别/安全芯片，逐步替代密码</p>
</li>
<li>
<p>要点</p>
<ul>
<li>风险分级触发：异地登录、敏感操作、异常设备时要求二次验证</li>
<li>恢复流程与社工防护：找回机制往往是薄弱点</li>
</ul>
</li>
</ul>
<p><strong>方法选择的工程取舍（常用组合）</strong></p>
<ul>
<li>浏览器站点/管理后台：Cookie + Session（配 CSRF 防护）或 Cookie 承载短期 Token</li>
<li>移动端/开放 API：Bearer Token（Access/Refresh）</li>
<li>第三方登录：OIDC（或 OAuth 2.0 + 用户信息接口）</li>
<li>企业多系统：SAML 或 OIDC 形态的 SSO</li>
<li>系统对系统：API Key + HMAC 签名，或 mTLS（双向 TLS）增强链路身份</li>
</ul>
<p><strong>容易混淆的术语对照</strong></p>
<ul>
<li><strong>认证</strong>：证明身份（账号密码、短信码、Passkey）</li>
<li><strong>鉴权/授权</strong>：校验权限（RBAC 角色权限、ABAC 属性权限）</li>
<li><strong>Session</strong>：服务端保存登录态</li>
<li><strong>Token</strong>：客户端持有的凭证</li>
<li><strong>JWT</strong>：Token 的一种格式（自包含、可签名）</li>
<li><strong>SSO</strong>：跨系统共享认证态的一套机制与流程</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter——帮助你构建多平台统一的界面和应用]]></title>    <link>https://juejin.cn/post/7602841282802204713</link>    <guid>https://juejin.cn/post/7602841282802204713</guid>    <pubDate>2026-02-04T13:41:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602841282802204713" data-draft-id="7602553969969578038" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter——帮助你构建多平台统一的界面和应用"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2026-02-04T13:41:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码飞一会儿"/> <meta itemprop="url" content="https://juejin.cn/user/555695627842490"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter——帮助你构建多平台统一的界面和应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/555695627842490/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码飞一会儿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T13:41:08.000Z" title="Wed Feb 04 2026 13:41:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、练习代码上手</h2>
<p>掌握基本结构</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">void</span> main()=&gt; runApp(MyApp());

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span></span>{
  <span class="hljs-meta">@override</span>
  Widget build (BuildContext context){

    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'Welcome to Flutter'</span>,
      home: Scaffold(
        appBar: AppBar(
          title:  Text(<span class="hljs-string">'Welcome to Flutter'</span>),
        ),
        body: Center(
          child: Text(<span class="hljs-string">'Hello Worlds'</span>),
        ),
      ),
    );
  }
}
</code></pre>
<h2 data-id="heading-1">二、组件讲解</h2>
<h3 data-id="heading-2">（一）Text组件</h3>
<p>完整代码：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() =&gt; runApp( MyApp());

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span></span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context){
    <span class="hljs-keyword">return</span> MaterialApp(
      title:<span class="hljs-string">'Text Widget'</span>,
      home:Scaffold(
        body:Center(
          child:Text(
              <span class="hljs-string">'Flutter 是 Google 的便携式 UI 工具包，帮助你在移动、web、桌面端创造高质量的绝妙原生体验的应用。 Flutter 可以和世界上的开发人员和开发组织广泛使用的那些现存代码一起使用，并且是开源的、免费的。!'</span>,
              textAlign:TextAlign.right,
              maxLines:<span class="hljs-number">1</span>,
              overflow:TextOverflow.ellipsis,
              style:TextStyle(
                fontSize:<span class="hljs-number">25.0</span>,
                color:Color.fromARGB(<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">125</span>,<span class="hljs-number">125</span>),
                decoration:TextDecoration.underline,
                decorationStyle:TextDecorationStyle.solid,
              )
          ),
        ),
      ),
    );
  }
}
</code></pre>
<ol>
<li>设置对齐方式：right、left、center</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">textAlign:TextAlign.right,
</code></pre>
<ol start="2">
<li>设置最大显示的行数，超出不显示</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">maxLines:<span class="hljs-number">1</span>,
</code></pre>
<ol start="3">
<li>设置超出文本显示方式，ellipsis即显示省略号，fade即显示渐变色（默认从上往下变浅）</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">overflow:TextOverflow.ellipsis,
</code></pre>
<ol start="4">
<li>设置文本样式</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">style:TextStyle()
</code></pre>
<ol start="5">
<li>设置字体大小，最好浮点数</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">fontSize:<span class="hljs-number">25.0</span>,
</code></pre>
<ol start="6">
<li>设置字体颜色，ARGB可以设置透明度</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">color:Color.fromARGB(<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">125</span>,<span class="hljs-number">125</span>),
</code></pre>
<ol start="7">
<li>设置文本样式，underline 设置下划线</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">decoration:TextDecoration.underline,
</code></pre>
<ol start="8">
<li>设置Decoration的样式，这里即前面使用的下划线，设置为实线</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">decorationStyle:TextDecorationStyle.solid,
</code></pre>
<h3 data-id="heading-3">（二） container组件</h3>
<p>完整代码：</p>
<pre><code class="hljs language-dart" lang="dart">imporimport <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() =&gt; runApp( MyApp());

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span></span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context){
    <span class="hljs-keyword">return</span> MaterialApp(
      title:<span class="hljs-string">'Text Widget'</span>,
      home:Scaffold(
        body:Center(
          child:Container(
            alignment:Alignment.topLeft,
            width:<span class="hljs-number">500.0</span>,
            height: <span class="hljs-number">400.0</span>,
            <span class="hljs-comment">// color:Colors.lightBlue,</span>
            padding:<span class="hljs-keyword">const</span> EdgeInsets.fromLTRB(<span class="hljs-number">10.0</span>,<span class="hljs-number">200</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),
            margin: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">10.0</span>) ,
            decoration: <span class="hljs-keyword">new</span> BoxDecoration(
              gradient: <span class="hljs-keyword">const</span> LinearGradient(
                colors: [Colors.lightBlue,Colors.greenAccent,Colors.purple]
              ),
              border: Border.all(width: <span class="hljs-number">5.0</span>,color: Colors.red)
            ),
            child:Text(<span class="hljs-string">'Hello Leo'</span>,style:TextStyle(fontSize:<span class="hljs-number">40.0</span>))
          ),
        ),
      ),
    );
  }
}t <span class="hljs-string">'package:flutter/material.dart'</span>;
</code></pre>
<ol>
<li>设置容器位置（center、centerLeft、centerRight、bottomCenter、bottomLeft、bottomRight、topCenter、topLeft、topRight)</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">alignment:Alignment.center,
</code></pre>
<ol start="2">
<li>设置容器宽度</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">width:<span class="hljs-number">500.0</span>,
</code></pre>
<ol start="3">
<li>设置容器高度</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">height: <span class="hljs-number">400.0</span>,
</code></pre>
<ol start="4">
<li>设置容器底色</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">color:Colors.lightBlue,
</code></pre>
<ol start="5">
<li>设置边距</li>
</ol>
<p>设置内边距：</p>
<pre><code class="hljs language-dart" lang="dart">padding:<span class="hljs-keyword">const</span> EdgeInsets.fromLTRB(<span class="hljs-number">10.0</span>,<span class="hljs-number">300</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),
</code></pre>
<p>设置外边距：</p>
<pre><code class="hljs language-dart" lang="dart">margin: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">10.0</span>),
</code></pre>
<blockquote>
<p>EdgeInsets设置边距，all设置所有边距，all(10.0)设置上下左右都距离10.0，fromLTRB(10.0,300,0,0)设置距离左（Left）10.0，上（Top）300，右（Right）0，下（Bottom）0。</p>
</blockquote>
<ol start="6">
<li>设置其他装饰</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">decoration: <span class="hljs-keyword">new</span> BoxDecoration(
  gradient: <span class="hljs-keyword">const</span> LinearGradient(
    colors: [Colors.lightBlue,Colors.greenAccent,Colors.purple]
  ),
    border: Border.all(width: <span class="hljs-number">5.0</span>,color: Colors.red)
),
</code></pre>
<p>在LinearGradient中的colors设置从左到右渐变的颜色，设置前需要注释掉之前color部分；</p>
<p>在border中设置边框宽度、颜色等。</p>
<h3 data-id="heading-4">（三） image组件</h3>
<p>来源：asset、file、memory、network</p>
<p>示例代码:</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() =&gt; runApp( MyApp());

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span></span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context){
    <span class="hljs-keyword">return</span> MaterialApp(
      title:<span class="hljs-string">'Text Widget'</span>,
      home:Scaffold(
        body:Center(
          child:Container(
            width: <span class="hljs-number">300.0</span>,
            height: <span class="hljs-number">300.0</span>,
            color: Colors.lightBlue,
            child:<span class="hljs-keyword">new</span> Image.network(
                <span class="hljs-string">'URL'</span>,
              <span class="hljs-comment">//fit: BoxFit.scaleDown,</span>
              <span class="hljs-comment">//color: Colors.greenAccent,</span>
              <span class="hljs-comment">//colorBlendMode: BlendMode.lighten,</span>
              repeat: ImageRepeat.repeatY,
            )
          ),
        ),
      ),
    );
  }
}
</code></pre>
<ol>
<li>设置图片适应模式</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">fit: BoxFit.scaleDown
</code></pre>













































<table><thead><tr><th>BoxFit 值</th><th>行为描述</th><th>典型用途</th></tr></thead><tbody><tr><td><code>BoxFit.fill</code></td><td>拉伸图片以完全填充容器，不保持宽高比</td><td>需要铺满背景且允许变形时</td></tr><tr><td><code>BoxFit.contain</code></td><td>缩放图片以完整显示在容器内，保持宽高比，可能留白</td><td>图片预览、图标等需完整显示</td></tr><tr><td><code>BoxFit.cover</code></td><td>缩放图片以完全覆盖容器，保持宽高比，多余部分被裁剪</td><td>背景图、封面图（如头像、海报）</td></tr><tr><td><code>BoxFit.fitWidth</code></td><td>水平方向缩放至容器宽度，高度按比例缩放（可能超出容器）</td><td>强调宽度匹配（如横幅）</td></tr><tr><td><code>BoxFit.fitHeight</code></td><td>垂直方向缩放至容器高度，宽度按比例缩放（可能超出容器）</td><td>强调高度匹配</td></tr><tr><td><code>BoxFit.none</code></td><td>保持图片原始尺寸，不缩放</td><td>显示原始大小图片（常配合 <code>Alignment</code> 使用）</td></tr><tr><td><code>BoxFit.scaleDown</code></td><td>与 <code>contain</code> 类似，但仅缩小，绝不放大（若图片比容器小，则保持原尺寸）</td><td>防止低分辨率图被拉伸模糊</td></tr></tbody></table>
<ol start="2">
<li>设置图片滤镜</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">color: Colors.greenAccent,<span class="hljs-comment">//设置前景色</span>
colorBlendMode: BlendMode.lighten,<span class="hljs-comment">//设置模式</span>
</code></pre>
<ol start="3">
<li>设置重复方式</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">repeat: ImageRepeat.repeatY,
</code></pre>

























<table><thead><tr><th>ImageRepeat 属性</th><th>描述</th></tr></thead><tbody><tr><td><code>ImageRepeat.noRepeat</code></td><td>背景图片不重复，仅展示一次。</td></tr><tr><td><code>ImageRepeat.repeatX</code></td><td>背景图片沿水平方向（X轴）重复。</td></tr><tr><td><code>ImageRepeat.repeatY</code></td><td>背景图片沿垂直方向（Y轴）重复。</td></tr><tr><td><code>ImageRepeat.repeat</code></td><td>背景图片在水平和垂直方向都重复。</td></tr></tbody></table>
<h3 data-id="heading-5">（四）ListView组件</h3>
<h4 data-id="heading-6">静态列表</h4>
<p>横向列表示例代码：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() =&gt; runApp(MyApp());

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'Flutter App Demo'</span>,
      home: Scaffold(
        appBar: AppBar(title: Text(<span class="hljs-string">'ListView Widget'</span>)),
        body: ListView(
          children: &lt;Widget&gt;[
            ListTile(leading: Icon(Icons.home), title: Text(<span class="hljs-string">'文本1'</span>)),
            ListTile(leading: Icon(Icons.settings), title: Text(<span class="hljs-string">'文本2'</span>)),
            ListTile(leading: Icon(Icons.android), title: Text(<span class="hljs-string">'文本3'</span>)),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<blockquote>
<p>该代码实现类似设置页面的列表，左侧图标，右侧文字</p>
</blockquote>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a591c82f59e439e8001defb6a2c4a8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB6aOe5LiA5Lya5YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770817268&amp;x-signature=t2j4kjT%2FYgc2vBbSzrC8QX%2B3Q7M%3D" alt="2026-01-29-17-27-06-image.png" loading="lazy"/></p>
<p>横向列表示例代码：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() =&gt; runApp(MyApp());

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'Flutter App Demo'</span>,
      home: Scaffold(
        appBar: AppBar(title: Text(<span class="hljs-string">'ListView Widget'</span>)),
        body: Center(
          child: Container(
            height: <span class="hljs-number">200.0</span>,
            child: ListView(
              scrollDirection: Axis.horizontal, <span class="hljs-comment">//横向</span>
              children: &lt;Widget&gt;[
                Container(width: <span class="hljs-number">180.0</span>, color: Colors.lightGreen),
                Container(width: <span class="hljs-number">180.0</span>, color: Colors.lightBlue),
                Container(width: <span class="hljs-number">180.0</span>, color: Colors.lightGreenAccent),
                Container(width: <span class="hljs-number">180.0</span>, color: Colors.red),
              ],
            ),
          ),
        ),
      ),
    );
  }
}
</code></pre>
<blockquote>
<p>该代码实现左右滑动列表，类似图库浏览单张图片</p>
</blockquote>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e554f144bd24dcda9b7f3b4dc48783e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB6aOe5LiA5Lya5YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770817268&amp;x-signature=7WPEJwHuhrKjjtrNvSi6vlSwscg%3D" alt="2026-01-29-17-37-06-image.gif" loading="lazy"/></p>
<p>优化后可复用形式代码：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() =&gt; runApp(MyApp());

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'Flutter App Demo'</span>,
      home: Scaffold(
        appBar: AppBar(title: Text(<span class="hljs-string">'ListView Widget'</span>)),
        body: Center(child: Container(height: <span class="hljs-number">200.0</span>, child: MyList())),
      ),
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyList</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> ListView(
      scrollDirection: Axis.horizontal, <span class="hljs-comment">//横向</span>
      children: &lt;Widget&gt;[
        Container(width: <span class="hljs-number">180.0</span>, color: Colors.lightGreen),
        Container(width: <span class="hljs-number">180.0</span>, color: Colors.lightBlue),
        Container(width: <span class="hljs-number">180.0</span>, color: Colors.lightGreenAccent),
        Container(width: <span class="hljs-number">180.0</span>, color: Colors.red),
      ],
    );
  }
}
</code></pre>
<h4 data-id="heading-7">动态列表</h4>
<p>示例代码：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() =&gt;
    runApp(MyApp(items: <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;.generate(<span class="hljs-number">1000</span>, (i) =&gt; <span class="hljs-string">'Items:<span class="hljs-subst">$i</span>'</span>)));

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; items;

  MyApp({Key? key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.items}) : <span class="hljs-keyword">super</span>(key: key);

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'Flutter App Demo'</span>,
      home: Scaffold(
        appBar: AppBar(title: Text(<span class="hljs-string">'ListView Widget'</span>)),
        body: ListView.builder(
          itemCount: items.length,
          itemBuilder: (context, index) {
            <span class="hljs-keyword">return</span> ListTile(title: Text(<span class="hljs-string">'<span class="hljs-subst">${items[index]}</span>'</span>));
          },
        ),
      ),
    );
  }
}
</code></pre>
<ol>
<li>传入动态List数组，在&lt;&gt;里指定数据类型，为了演示，调用Generate来生成字符串传入</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">items: <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;.generate(<span class="hljs-number">1000</span>, (i) =&gt; <span class="hljs-string">'Items:<span class="hljs-subst">$i</span>'</span>)
</code></pre>
<p>2.定义 <code>MyApp</code> 的构造函数，接收一个可空的 <code>Key?</code> 和一个必需的 <code>items</code> 列表，并将 <code>key</code> 传递给父类 <code>StatelessWidget</code> 的构造函数。</p>
<pre><code class="hljs language-dart" lang="dart">MyApp({Key? key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.items}) : <span class="hljs-keyword">super</span>(key: key);
</code></pre>
<p>3.这行代码使用 <code>ListView.builder</code> 高效地构建一个可滚动列表：  根据 <code>items</code> 的长度（<code>items.length</code>）动态生成列表项，每项显示对应字符串内容（<code>${items[index]}</code>），仅渲染可见区域的 item，节省内存和性能。</p>
<pre><code class="hljs language-dart" lang="dart">ListView.builder(  
  itemCount: items.length,  
  itemBuilder: (context, index) {  
    <span class="hljs-keyword">return</span> ListTile(title: Text(<span class="hljs-string">'<span class="hljs-subst">${items[index]}</span>'</span>));  
  },
</code></pre>
<h4 data-id="heading-8">网格列表</h4>
<p>示例代码1：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() =&gt;
    runApp(MyApp(items: <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;.generate(<span class="hljs-number">1000</span>, (i) =&gt; <span class="hljs-string">'Items:<span class="hljs-subst">$i</span>'</span>)));

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; items;

  MyApp({Key? key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.items}) : <span class="hljs-keyword">super</span>(key: key);

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'Flutter App Demo'</span>,
      home: Scaffold(
        appBar: AppBar(title: Text(<span class="hljs-string">'A demo application'</span>)),
        body: GridView.count(
          padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">20.0</span>),
          crossAxisSpacing: <span class="hljs-number">10.0</span>, <span class="hljs-comment">//每格距离</span>
          crossAxisCount: <span class="hljs-number">3</span>, <span class="hljs-comment">//每行列数</span>
          children: &lt;Widget&gt;[
            <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'data1'</span>),
            <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'data2'</span>),
            <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'data3'</span>),
            <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'data4'</span>),
            <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'data5'</span>),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<p>结果：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64702f1a5f5d4f85b735a2a4034758f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB6aOe5LiA5Lya5YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770817268&amp;x-signature=2MiT%2B9qi%2BO3Jx7D4KcOHMsGT8Dg%3D" alt="2026-02-01-16-09-16-image.png" loading="lazy"/></p>
<ol>
<li>这是 Flutter 中创建固定列数（或行数）网格布局的便捷构造方法。它内部使用了 <code>SliverGridDelegateWithFixedCrossAxisCount</code> 作为默认的 <code>gridDelegate</code>。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">GridView.count(
</code></pre>
<ol start="2">
<li>设置交叉轴方向上相邻子项之间的间距。</li>
</ol>
<blockquote>
<p>如果你还想设置上下间距，需要使用 <code>mainAxisSpacing</code> 参数</p>
</blockquote>
<pre><code class="hljs language-dart" lang="dart">  crossAxisSpacing: <span class="hljs-number">10.0</span>, <span class="hljs-comment">// 每格距离</span>
</code></pre>
<ol start="3">
<li>指定在交叉轴方向上显示的子项数量。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">  crossAxisCount: <span class="hljs-number">3</span>, <span class="hljs-comment">// 每行列数</span>
</code></pre>
<p>示例代码2：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() =&gt;
    runApp(MyApp(items: <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;.generate(<span class="hljs-number">1000</span>, (i) =&gt; <span class="hljs-string">'Items:<span class="hljs-subst">$i</span>'</span>)));

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; items;

  <span class="hljs-keyword">const</span> MyApp({Key? key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.items}) : <span class="hljs-keyword">super</span>(key: key);

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'Flutter App Demo'</span>,
      home: Scaffold(
        appBar: AppBar(title: Text(<span class="hljs-string">'A demo application'</span>)),
        body: GridView(
          gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
            crossAxisCount: <span class="hljs-number">3</span>,<span class="hljs-comment">//列数</span>
            mainAxisSpacing: <span class="hljs-number">2.0</span>,<span class="hljs-comment">//上下间距</span>
            crossAxisSpacing: <span class="hljs-number">2.0</span>,<span class="hljs-comment">//左右间距</span>
            childAspectRatio: <span class="hljs-number">1.0</span>,<span class="hljs-comment">//宽高比例</span>
          ),
          children: &lt;Widget&gt;[
            Image.network(
              <span class="hljs-string">'https://pic1.zhimg.com/v2-d15162bd3857af27785242957ac60d92_1440w.jpg'</span>,
              fit: BoxFit.cover,
            ),
            Image.network(
              <span class="hljs-string">'https://pic3.zhimg.com/v2-0084dd60d97d70cb6bcd762e7699274a_1440w.jpg'</span>,
              fit: BoxFit.cover,
            ),
            Image.network(
              <span class="hljs-string">'https://pic3.zhimg.com/v2-4a6ac348db1fd8e99b537e408ae3626c_1440w.jpg'</span>,
              fit: BoxFit.cover,
            ),
            Image.network(
              <span class="hljs-string">'https://pic4.zhimg.com/v2-76c575cdf404b0e860d4b2f1858cf915_1440w.jpg'</span>,
              fit: BoxFit.cover,
            ),
            Image.network(
              <span class="hljs-string">'https://pic3.zhimg.com/v2-af9b8a81df599a22ff4dd72cc3d7fb50_1440w.jpg'</span>,
              fit: BoxFit.cover,
            ),
            Image.network(
              <span class="hljs-string">'https://pic3.zhimg.com/v2-2176e715376a4fe7aa6feb15e60d7cae_1440w.jpg'</span>,
              fit: BoxFit.cover,
            ),
            Image.network(
              <span class="hljs-string">'https://pic1.zhimg.com/v2-77c15a0412cdd2d5e046213c4a620886_1440w.jpg'</span>,
              fit: BoxFit.cover,
            ),
            Image.network(
              <span class="hljs-string">'https://pic4.zhimg.com/v2-1964aaac7710c4b784c5f6f419d88e0f_1440w.jpg'</span>,
              fit: BoxFit.cover,
            ),
            Image.network(
              <span class="hljs-string">'https://pica.zhimg.com/v2-8fa8d813365df3cb4c47128584f8eaec_1440w.jpg'</span>,
              fit: BoxFit.cover,
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<p>结果：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00d4ec2c2a43430a82943777a2807193~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB6aOe5LiA5Lya5YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770817268&amp;x-signature=ghe9Mt9dDbeIkeQuL%2FBv5nAOclM%3D" alt="2026-02-01-17-02-11-image.png" loading="lazy"/></p>
<ol>
<li>这行表示为一个 <code>GridView</code>（或其他支持网格布局的 widget）指定其子项的排列方式<code>gridDelegate</code> 是 <code>GridView</code> 的一个属性，用于定义网格的布局规则。<code>SliverGridDelegateWithFixedCrossAxisCount</code> 是一种内置的网格代理（delegate），它会将网格划分为固定列数或固定行数。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">gridDelegate: SliverGridDelegateWithFixedCrossAxisCount()
</code></pre>
<ol start="2">
<li><code>crossAxisCount</code> 表示在交叉轴（cross axis）上显示的子项数量。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">  crossAxisCount: <span class="hljs-number">3</span>, <span class="hljs-comment">// 列数</span>
</code></pre>
<ol start="3">
<li><code>mainAxisSpacing</code> 表示在主轴方向（main axis）上，相邻子项之间的间距。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">  mainAxisSpacing: <span class="hljs-number">2.0</span>, <span class="hljs-comment">// 上下间距</span>
</code></pre>
<ol start="4">
<li><code>crossAxisSpacing</code> 表示在交叉轴方向上，相邻子项之间的间距。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">  crossAxisSpacing: <span class="hljs-number">2.0</span>, <span class="hljs-comment">// 左右间距</span>
</code></pre>
<ol start="5">
<li><code>childAspectRatio</code> 定义每个子项的宽高比（width / height）。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">  childAspectRatio: <span class="hljs-number">1.0</span>, <span class="hljs-comment">// 宽高比例</span>
</code></pre>
<h3 data-id="heading-9">（五）button组件</h3>
<p>示例代码：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() =&gt; runApp(MyApp());

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'A application demo'</span>,
      home: Scaffold(
        appBar: AppBar(title: Text(<span class="hljs-string">'标题'</span>)),
        body: Row(
          children: &lt;Widget&gt;[
            Expanded(
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.redAccent,
                  foregroundColor: Colors.white,
                ),
                onPressed: () {},
                child: Text(<span class="hljs-string">'红色按钮'</span>),
              ),
            ),
            Expanded(
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.orangeAccent,
                  foregroundColor: Colors.white,
                ),
                onPressed: () {},
                child: Text(<span class="hljs-string">'橙色按钮'</span>),
              ),
            ),
            Expanded(
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.blueAccent,
                  foregroundColor: Colors.white,
                ),
                onPressed: () {},
                child: Text(<span class="hljs-string">'蓝色按钮'</span>),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<ol>
<li>它的作用是让其子组件占据主轴（main axis）上所有可用的剩余空间，如果有多个 <code>Expanded</code>，它们会按 <code>flex</code> 属性（默认为 1）按比例分配剩余空间。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">Expanded()
</code></pre>
<ol start="2">
<li><code>ElevatedButton</code> 是 Material Design 风格的一种常用按钮，带有阴影和点击反馈。必须提供 <code>onPressed</code> 回调（否则会禁用），以及一个 <code>child</code>。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">child: ElevatedButton()
</code></pre>
<p>3.自定义按钮的外观样式: 设置按钮的背景颜色为亮红色,设置按钮上前景内容的颜色为白色。</p>
<pre><code class="hljs language-dart" lang="dart">style: ElevatedButton.styleFrom(
  backgroundColor: Colors.redAccent,
  foregroundColor: Colors.white,
),
</code></pre>
<blockquote>
<p>注意：<code>styleFrom</code> 还支持设置 <code>padding</code>、<code>shape</code>（圆角）、<code>elevation</code>（阴影高度）等。</p>
</blockquote>
<ol start="4">
<li>定义按钮被点击时的回调函数。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">onPressed: () {},
</code></pre>
<h2 data-id="heading-10">三、布局讲解</h2>
<h3 data-id="heading-11">（一）ColumnWidget布局和RowWidget布局</h3>
<p>示例代码：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() =&gt; runApp(MyApp());

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'A application demo'</span>,
      home: Scaffold(
        appBar: AppBar(title: Text(<span class="hljs-string">'标题'</span>)),
        body: Center(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.center, <span class="hljs-comment">//水平对齐方向</span>
            mainAxisAlignment: MainAxisAlignment.center, <span class="hljs-comment">//垂直对齐方向</span>
            children: &lt;Widget&gt;[
              Text(<span class="hljs-string">'文本1哔哩哔哩'</span>),
              Text(<span class="hljs-string">'文本2哈哈哈'</span>),
              Text(<span class="hljs-string">'文本3嗡嗡嗡嗡嗡嗡嗡嗡嗡嗡嗡嗡嗡嗡嗡'</span>),
              Text(<span class="hljs-string">'文本4呃呃呃'</span>),
            ],
          ),
        ),
      ),
    );
  }
}
</code></pre>
<p>结果：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d28871d5355b45d290c3d06b028e8e92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB6aOe5LiA5Lya5YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770817268&amp;x-signature=nyYlLEBomM03aPwW1e2oBlVWbDM%3D" alt="2026-02-02-11-39-07-image.png" loading="lazy"/></p>
<ol>
<li>子项在水平方向居中（交叉轴）</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">crossAxisAlignment: CrossAxisAlignment.center, <span class="hljs-comment">//水平对齐方向</span>
</code></pre>
<ol start="2">
<li>子项在垂直方向居中（主轴）</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">mainAxisAlignment: MainAxisAlignment.center, <span class="hljs-comment">//垂直对齐方向</span>
</code></pre>
<ol start="3">
<li>让其子组件占据主轴（main axis）上所有可用的剩余空间，如果有多个 <code>Expanded</code>，它们会按比例分配剩余空间。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">Expanded()
</code></pre>
<h3 data-id="heading-12">（二）StackWidget布局</h3>
<p>示例代码：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() =&gt; runApp(MyApp());

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">var</span> stack = Stack(
      alignment: FractionalOffset(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.8</span>),
      children: &lt;Widget&gt;[
        CircleAvatar(
          backgroundImage: NetworkImage(
            <span class="hljs-string">'https://vcg01.cfp.cn/creative/vcg/800/new/VCG211314119557.jpg'</span>,
          ),
          radius: <span class="hljs-number">100.0</span>,
        ),
        Container(
          decoration: BoxDecoration(color: Colors.blueAccent),
          padding: EdgeInsets.all(<span class="hljs-number">5.0</span>),
          child: Text(<span class="hljs-string">'HELLO'</span>),
        ),
      ],
    );
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'A application demo'</span>,
      home: Scaffold(
        appBar: AppBar(title: Text(<span class="hljs-string">'标题'</span>)),
        body: Center(child: stack),
      ),
    );
  }
}
</code></pre>
<p>结果：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e8d7169d5444630a615e3aee1728b38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB6aOe5LiA5Lya5YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770817268&amp;x-signature=6YqbQLMx7vYc1gxDbSs1msvNQrk%3D" alt="2026-02-02-11-56-27-image.png" loading="lazy"/></p>
<ol>
<li>使用stack组件。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">var</span> stack = Stack()
</code></pre>
<ol start="2">
<li>设置 <code>Stack</code> 中<strong>未使用 <code>Positioned</code> 包裹的子组件</strong>的默认对齐位置,水平方向<code>0.5</code> （0 = 左边，1 = 右边）,垂直方向<code>0.8</code> 即距离顶部 80% 的位置（0 = 顶部，1 = 底部），如果子组件被 <code>Positioned</code> 包裹，则不受此属性影响。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">alignment: FractionalOffset(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.8</span>),
</code></pre>
<ol start="3">
<li>
<p>创建一个圆形头像控件。CircleAvatar()</p>
</li>
<li>
<p>从网络加载一张图片作为 <code>CircleAvatar</code> 的背景图像。<code>backgroundImage</code> 接收一个 <code>ImageProvider</code>，这里使用 <code>NetworkImage</code> 从 URL 加载图片。</p>
</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">backgroundImage: NetworkImage(<span class="hljs-string">'https://vcg01.cfp.cn/creative/vcg/800/new/VCG211314119557.jpg'</span>),
</code></pre>
<h3 data-id="heading-13">（三）PositionedWidget布局</h3>
<p>示例代码：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() =&gt; runApp(MyApp());

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">var</span> stack = Stack(
      alignment: FractionalOffset(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.8</span>),
      children: &lt;Widget&gt;[
        CircleAvatar(
          backgroundImage: NetworkImage(
            <span class="hljs-string">'https://vcg01.cfp.cn/creative/vcg/800/new/VCG211314119557.jpg'</span>,
          ),
          radius: <span class="hljs-number">100.0</span>,
        ),
        Positioned(top: <span class="hljs-number">10.0</span>, left: <span class="hljs-number">10.0</span>, child: Text(<span class="hljs-string">'变色龙'</span>)),
        Positioned(bottom: <span class="hljs-number">10.0</span>, right: <span class="hljs-number">10.0</span>, child: Text(<span class="hljs-string">'BIANSELONG'</span>)),
      ],
    );
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'A application demo'</span>,
      home: Scaffold(
        appBar: AppBar(title: Text(<span class="hljs-string">'标题'</span>)),
        body: Center(child: stack),
      ),
    );
  }
}
</code></pre>
<p>结果：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fb5acb8d006477995b2a4cdbf6cdb71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB6aOe5LiA5Lya5YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770817268&amp;x-signature=fjfZddQsWXeaqat%2F986LeduVouc%3D" alt="2026-02-02-12-10-32-image.png" loading="lazy"/></p>
<ol>
<li>将文本 <code>'变色龙'</code> <strong>定位在 Stack 容器的左上角附近</strong>，距离顶部 10 像素，距离左边 10 像素。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">Positioned(top: <span class="hljs-number">10.0</span>, left: <span class="hljs-number">10.0</span>, child: Text(<span class="hljs-string">'变色龙'</span>)),
</code></pre>
<ol start="2">
<li>将英文文本 <code>'BIANSELONG'</code> <strong>定位在 Stack 容器的右下角附近</strong>，距离底部 10 像素，距离右边 10 像素。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">Positioned(bottom: <span class="hljs-number">10.0</span>, right: <span class="hljs-number">10.0</span>, child: Text(<span class="hljs-string">'BIANSELONG'</span>)),
</code></pre>
<blockquote>
<ol>
<li>
<p>不要在非 <code>Stack</code> 父组件中使用 `Positioned</p>
</li>
<li>
<p>避免只设置一个方向</p>
</li>
</ol>
</blockquote>
<h3 data-id="heading-14">（四）CardWidget布局</h3>
<p>示例代码：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() =&gt; runApp(MyApp());

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">var</span> card = Card(
      child: Column(
        children: &lt;Widget&gt;[
          ListTile(
            title: Text(
              <span class="hljs-string">'地址文本，中华人民共和国四川省'</span>,
              style: TextStyle(fontWeight: FontWeight.w500),
            ),
            subtitle: Text(<span class="hljs-string">'成都市'</span>),
            leading: Icon(Icons.account_box, color: Colors.lightBlue),
          ),
          ListTile(
            title: Text(
              <span class="hljs-string">'地址文本，中华人民共和国陕西省'</span>,
              style: TextStyle(fontWeight: FontWeight.w500),
            ),
            subtitle: Text(<span class="hljs-string">'西安市'</span>),
            leading: Icon(Icons.account_box, color: Colors.lightBlue),
          ),
          ListTile(
            title: Text(
              <span class="hljs-string">'地址文本，中华人民共和国黑龙江省'</span>,
              style: TextStyle(fontWeight: FontWeight.w500),
            ),
            subtitle: Text(<span class="hljs-string">'哈尔滨市'</span>),
            leading: Icon(Icons.account_box, color: Colors.lightBlue),
          ),
        ],
      ),
    );
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'A application demo'</span>,
      home: Scaffold(
        appBar: AppBar(title: Text(<span class="hljs-string">'标题'</span>)),
        body: Center(child: card),
      ),
    );
  }
}
</code></pre>
<p>结果：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6c38eb54ecd4ee1ae1990b821216afd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB6aOe5LiA5Lya5YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770817268&amp;x-signature=2f8fcbm1mN2twrh%2BRaTHGV4Saqg%3D" alt="2026-02-02-12-41-19-image.png" loading="lazy"/></p>
<ol>
<li>使用Card布局设置Card布局</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">var</span> card = Card()
</code></pre>
<h2 data-id="heading-15">四、导航讲解</h2>
<h3 data-id="heading-16">（一）父子页面跳转</h3>
<p>示例代码：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;  

<span class="hljs-keyword">void</span> main() {  
  runApp(MaterialApp(title: <span class="hljs-string">'导航演示'</span>, home: FirstScreen()));  
}  

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FirstScreen</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{  
  <span class="hljs-keyword">const</span> FirstScreen({<span class="hljs-keyword">super</span>.key});  

  <span class="hljs-meta">@override</span>  
  Widget build(BuildContext context) {  
    <span class="hljs-keyword">return</span> Scaffold(  
      appBar: AppBar(title: Text(<span class="hljs-string">'导航页面'</span>)),  
      body: Center(  
        child: ElevatedButton(  
          onPressed: () {  
            Navigator.push(  
              context,  
              MaterialPageRoute(builder: (context) =&gt; SecondScreen()),  
            );  
          },  
          child: Text(<span class="hljs-string">'查看详情'</span>),  
        ),  
      ),  
    );  
  }  
}  

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecondScreen</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{  
  <span class="hljs-keyword">const</span> SecondScreen({<span class="hljs-keyword">super</span>.key});  

  <span class="hljs-meta">@override</span>  
  Widget build(BuildContext context) {  
    <span class="hljs-keyword">return</span> Scaffold(  
      appBar: AppBar(title: Text(<span class="hljs-string">'详情'</span>)),  
      body: Center(  
        child: ElevatedButton(  
          onPressed: () {  
            Navigator.pop(context);  
          },  
          child: Text(<span class="hljs-string">'返回'</span>),  
        ),  
      ),  
    );  
  }  
}
</code></pre>
<p>结果：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/447667c293924f978c05d1b26bc3ad14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB6aOe5LiA5Lya5YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770817268&amp;x-signature=aCYatoBhLNBqG1TyL6ti9Ff2iF4%3D" alt="2026-02-03-13-53-12-20260203-0553-06.0747534.gif" loading="lazy"/></p>
<ol>
<li>
<p>将一个新的页面（Widget）推入到导航栈（Navigator stack）的顶部，从而<strong>跳转到新页面</strong>。参数：<code>context</code>：当前 widget 的上下文，用于定位 Navigator。<code>MaterialPageRoute</code>：一种页面切换动画（遵循 Material Design），其 <code>builder</code> 返回要跳转的目标页面（如 <code>SecondScreen()</code>）。</p>
<pre><code class="hljs language-dart" lang="dart">Navigator.push(
  context,
  MaterialPageRoute(builder: (context) =&gt; SecondScreen()),
);
</code></pre>
</li>
<li>
<p>从导航栈中<strong>弹出当前页面</strong>，返回上一个页面。<code>context</code>：用于找到当前的 Navigator。可以传入一个 <code>result</code> 参数（如 <code>pop(context, 'data')</code>），将数据返回给前一个页面。</p>
<pre><code class="hljs language-dart" lang="dart">Navigator.pop(context);
</code></pre>
</li>
</ol>
<h3 data-id="heading-17">（二）参数传递</h3>
<p>示例代码：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;  

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Product</span> </span>{  
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> title;  
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> description;  

  Product(<span class="hljs-keyword">this</span>.title, <span class="hljs-keyword">this</span>.description);  
}  

<span class="hljs-keyword">void</span> main() {  
  runApp(  
    MaterialApp(  
      title: <span class="hljs-string">'导航数据传递'</span>,  
      home: ProductList(  
        products: <span class="hljs-built_in">List</span>.generate(<span class="hljs-number">20</span>, (i) =&gt; Product(<span class="hljs-string">'商品<span class="hljs-subst">$i</span>'</span>, <span class="hljs-string">"商品的编号为<span class="hljs-subst">$i</span>"</span>)),  
      ),  
    ),  
  );  
}  

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProductList</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{  
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Product&gt; products;  

  ProductList({Key? key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.products}) : <span class="hljs-keyword">super</span>(key: key);  

  <span class="hljs-meta">@override</span>  
  Widget build(BuildContext context) {  
    <span class="hljs-keyword">return</span> Scaffold(  
      appBar: AppBar(title: Text(<span class="hljs-string">'列表'</span>)),  
      body: ListView.builder(  
        itemCount: products.length,  
        itemBuilder: (context, index) {  
          <span class="hljs-keyword">return</span> ListTile(  
            title: Text(products[index].title),  
            onTap: () {  
              Navigator.push(  
                context,  
                MaterialPageRoute(  
                  builder: (context) =&gt; ProductDetail(product: products[index]),  
                ),  
              );  
            },  
          );  
        },  
      ),  
    );  
  }  
}  

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProductDetail</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{  
  <span class="hljs-keyword">final</span> Product product;  

  ProductDetail({Key? key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.product}) : <span class="hljs-keyword">super</span>(key: key);  

  <span class="hljs-meta">@override</span>  
  Widget build(BuildContext context) {  
    <span class="hljs-keyword">return</span> Scaffold(  
      appBar: AppBar(title: Text(product.title)),  
      body: Center(child: Text(product.description)),  
    );  
  }  
}
</code></pre>
<p>结果：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28209990d21a4d3294a415bcccf6eb6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB6aOe5LiA5Lya5YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770817268&amp;x-signature=CgiRWhhxFO1PQ9%2FKPx3FsQw3aEE%3D" alt="2026-02-03-16-06-23-20260203-0806-11.9230348.gif" loading="lazy"/></p>
<p>示例代码2：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() {
  runApp(MaterialApp(title: <span class="hljs-string">'数据传递'</span>, home: FirstPage()));
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FirstPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">'数据传递'</span>)),
      body: RouteButton(),
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RouteButton</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> ElevatedButton(
      onPressed: () {
        _navigateToPage(context);
      },
      child: Text(<span class="hljs-string">'点一点'</span>),
    );
  }

  _navigateToPage(BuildContext context) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> Navigator.push(
      context,
      MaterialPageRoute(builder: (context) =&gt; ShowPage()),
    );
    ScaffoldMessenger.of(
      context,
    ).showSnackBar(SnackBar(content: Text(<span class="hljs-string">'<span class="hljs-subst">$result</span>'</span>)));
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShowPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">'展示页面'</span>)),
      body: Center(
        child: Column(
          children: &lt;Widget&gt;[
            ElevatedButton(
              onPressed: () {
                Navigator.pop(context, <span class="hljs-string">'点击展示页面：007'</span>);
              },
              child: Text(<span class="hljs-string">'展示页面007'</span>),
            ),
            ElevatedButton(
              onPressed: () {
                Navigator.pop(context, <span class="hljs-string">'点击展示页面：008'</span>);
              },
              child: Text(<span class="hljs-string">'展示页面008'</span>),
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<p>结果：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5ff976f403a41b2a37d0d80e8a2d56c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB6aOe5LiA5Lya5YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770817268&amp;x-signature=lyrpeCInD%2BhAbwRzrywJsqvjUr0%3D" alt="2026-02-03-16-05-02-20260203-0804-50.8576454.gif" loading="lazy"/></p>
<h2 data-id="heading-18">五、资源导入和使用</h2>
<h3 data-id="heading-19">（一） 导入</h3>
<ol>
<li>
<p>在项目根目录下建立<code>asstes</code> 文件夹，和<code>lib</code> 文件夹同级。</p>
</li>
<li>
<p>将资源文件复制到<code>assets</code> 文件夹中。</p>
</li>
<li>
<p>在项目目录下找到<code>pubspec.yaml</code> 文件，找到下面文字区域：</p>
</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># The following section is specific to Flutter packages.</span>
<span class="hljs-attr">flutter:</span>
</code></pre>
<p>添加资源信息，其中文件位置为以<code> assets</code> 文件夹为根目录的相对位置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># The following section is specific to Flutter packages.</span>
<span class="hljs-attr">flutter:</span>
  <span class="hljs-attr">assets:</span>
   <span class="hljs-bullet">-</span> <span class="hljs-string">assets/xxx.xxx</span>
</code></pre>
<blockquote>
<p>可以导入文件也可以直接导入文件夹</p>
</blockquote>
<h3 data-id="heading-20">（二）使用</h3>
<p>在代码中使用以下类似代码调用：</p>
<pre><code class="hljs language-dart" lang="dart">组件.asset(<span class="hljs-string">'assets/xxx.xxx'</span>)
</code></pre>
<h2 data-id="heading-21">六、项目打包</h2>
<p>按照<code>Android</code> 、<code>iOS</code> 、<code>Linux</code> 、<code>Windows</code> 、<code>MacOS</code>、<code>Web</code>的平台架构更改外层文件，例如：图标、软件名称……</p>
<p>然后根据不同平台运行：</p>
<h4 data-id="heading-22">1. Android</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建 APK（适用于大多数设备）</span>
flutter build apk

<span class="hljs-comment"># 构建拆分 APK（按 ABI 分包，减小体积）</span>
flutter build apk --split-per-abi

<span class="hljs-comment"># 构建 AAB（Google Play 推荐格式）</span>
flutter build appbundle
</code></pre>
<h4 data-id="heading-23">2. iOS</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建 release 模式的 iOS 应用（生成 .app）</span>
flutter build ios
</code></pre>
<h4 data-id="heading-24">3. Web</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建 Web 应用（release 模式）</span>
flutter build web
</code></pre>
<h4 data-id="heading-25">4. macOS</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建 macOS 应用</span>
flutter build macos
</code></pre>
<h4 data-id="heading-26">5. Windows</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建 Windows 桌面应用</span>
flutter build windows
</code></pre>
<h4 data-id="heading-27">6. Linux</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建 Linux 桌面应用</span>
flutter build linux
</code></pre>
<p>Flutter 支持三种构建模式：</p>

























<table><thead><tr><th>模式</th><th>用途</th><th>命令示例</th></tr></thead><tbody><tr><td><strong>Debug</strong></td><td>开发调试</td><td>默认 <code>flutter run</code>,也可通过<code>flutter build [平台] --debug</code>构建</td></tr><tr><td><strong>Profile</strong></td><td>性能分析（仅限真机）</td><td><code>flutter build --profile [平台]</code></td></tr><tr><td><strong>Release</strong></td><td>正式发布</td><td><code>flutter build [平台]</code>（也可加<code> -- release</code>）</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringAI开发MCP-Server（一）：0-1的搭建与实现]]></title>    <link>https://juejin.cn/post/7602811649126039603</link>    <guid>https://juejin.cn/post/7602811649126039603</guid>    <pubDate>2026-02-04T11:06:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602811649126039603" data-draft-id="7602834985901293618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringAI开发MCP-Server（一）：0-1的搭建与实现"/> <meta itemprop="keywords" content="MCP"/> <meta itemprop="datePublished" content="2026-02-04T11:06:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Acho"/> <meta itemprop="url" content="https://juejin.cn/user/4191761160999496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringAI开发MCP-Server（一）：0-1的搭建与实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4191761160999496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Acho
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T11:06:12.000Z" title="Wed Feb 04 2026 11:06:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前提概要</h2>
<h3 data-id="heading-1">实现流程</h3>
<ul>
<li>使用 <code>spring-ai-starter-mcp-server-webmvc</code> 把普通 Spring Bean 变成 AI 可调用的 Tool；</li>
<li>在双数据源（含 Doris）场景下安全地暴露只读 SQL 查询能力，包含防注入与限流措施；</li>
<li>将 GB/T‑32960 报文解析逻辑封装为 Tool，让模型直接解析十六进制报文并返回结构化结果；</li>
<li>实现 MethodToolCallbackProvider 注册、SSE 流式响应、以及 Agent 侧的调用配置示例；</li>
<li>生产化建议：鉴权、配额、审计日志、异常策略与监控接入。</li>
</ul>
<h3 data-id="heading-2">成果展示</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6093ec3721154f5581245f6595ad5e6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=sCPzyKrO7EqhwJFzhAvXd4qQLEw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19903d19d12d41e78d5b06c5638b8bdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=YM1kD%2BN3C5hXxF7LInZtJ4ANwqw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41a3ce4cb6394369b525329a864ec2d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=JAuSlvezYTl%2FUh5MsNSlqEZphHc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">二、什么是 MCP-Server?</h2>
<h3 data-id="heading-4">1. 什么是MCP?</h3>
<p>MCP 全称 <strong>Model Context Protocol</strong>，直译就是 <strong>模型上下文协议</strong>。<br/>
它是一个 <strong>标准协议</strong>，用于让 <strong>大模型（LLM）和外部应用/工具</strong> 能够方便、安全地交互。</p>
<h3 data-id="heading-5">2. 什么是MCP-Server</h3>
<p><strong>MCP Server</strong> 就是 MCP 协议的 <strong>具体实现端</strong>，负责把企业的 <strong>业务系统、数据库、工具</strong> 暴露出来，供大模型调用。</p>
<p><strong>MCP Server = 把内部系统包装成标准接口的“翻译官”</strong> 。</p>
<p>模型通过 MCP Client 发送请求，MCP Server 把请求转化为业务系统能理解的操作，再把结果返回给模型。</p>
<p>如果想更加深入的了解MCP，可以参考篇文章</p>
<p>此处为语雀内容卡片，点击链接查看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.yuque.com%2Fu22429903%2Fkf0kog%2Fhpuy0cxw7mztrzne%3FsingleDoc%23" target="_blank" title="https://www.yuque.com/u22429903/kf0kog/hpuy0cxw7mztrzne?singleDoc#" ref="nofollow noopener noreferrer">www.yuque.com/u22429903/k…</a></p>
<h2 data-id="heading-6">三、开发前的准备</h2>
<p>Spring AI 是一个面向人工智能工程的应用框架。其目标是将 Spring 生态系统的可移植性和模块化设计等设计原则应用于人工智能领域，并推广使用 POJO 作为人工智能领域应用程序的构建块。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34f97a4aa12b4746b398f973f9d1eec2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=kFhQ2wt72Q7CScLxZK6U%2BKo0WWg%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">a. Spring AI 简介与架构认知</h4>
<p><strong>Spring AI 是 Spring 团队推出的 AI 应用开发框架，目标是让开发者像写普通 Spring Boot 应用一样，轻松调用大模型、RAG、向量库、Prompt 模板等能力。</strong></p>
<p>核心特性：</p>
<ul>
<li>支持多家模型提供商（OpenAI、Azure、Ollama、Anthropic、百度、阿里、智谱等）</li>
<li>内置 <code>ChatClient</code> / <code>EmbeddingClient</code> / <code>ImageClient</code> 抽象层</li>
<li>统一配置体系（通过 <code>application.yml</code>）</li>
<li>提供 RAG、Prompt Template、Memory（会话上下文）、工具函数调用等扩展</li>
<li>未来版本将内置 <strong>MCP Server Starter</strong></li>
</ul>
<hr/>
<h4 data-id="heading-8">b. 环境与工具准备</h4>





































<table><thead><tr><th>项目</th><th>要求/建议</th></tr></thead><tbody><tr><td><strong>JDK</strong></td><td><strong>17 或更高版本</strong>（Spring Boot 3+ 必须）</td></tr><tr><td><strong>Spring Boot</strong></td><td>3.3.x 或更新版本</td></tr><tr><td><strong>Spring AI</strong></td><td>建议 ≥ <code>1.0.0-M2</code></td></tr><tr><td><strong>构建工具</strong></td><td>Maven 或 Gradle（推荐 Maven）</td></tr><tr><td><strong>IDE</strong></td><td>IntelliJ IDEA / VS Code / Eclipse</td></tr><tr><td><strong>网络代理</strong></td><td>若访问 OpenAI / Azure 等国外服务，需要配置 HTTP/HTTPS 代理，建议直接使用国内的DeepSeek，通义千问，开发与学习已经足够</td></tr><tr><td><strong>GitHub 访问</strong></td><td>建议能拉取 Spring AI 官方 starter 源码（方便调试）</td></tr></tbody></table>
<h4 data-id="heading-9">c. 本项目MCP-Server采取的方式</h4>
<p>本文将采取SSE的通信方式实现MCP-Server，Stdio与这个SSE的方式也是大差不差的</p>
<p>• SSE方式适用于客户端和服务器位于不同物理位置的场景。</p>
<p>• 适用于实时数据更新、消息推送、轻量级监控和实时日志流等场景</p>
<p>• 对于分布式或远程部署的场景，基于 HTTP 和 SSE 的传输方式则更为合适。</p>
<p>• 配置方式非常简单，基本上就一个链接就行，直接复制他的链接填上就行</p>
<p>目前分为了两种，一种是标准SSE,一种就是基于WebSocket SSE。</p>
<h2 data-id="heading-10">四、开发步骤</h2>
<p>前面已经说明了相关的前期准备，JDK版本，Spring Boot版本，这两项是最重要的，一定要提前准备好，在做后面的开发</p>
<h3 data-id="heading-11">1. 项目pom.xml配置</h3>
<p>这是一个 <strong>基于 Spring Boot 3.5.5 + Spring AI 1.0.0 的 MCP Server 工程配置文件</strong>，用于实现一个通过 HTTP/SSE（Server-Sent Events）提供 AI 服务的 <strong>MCP-Server（Model Context Protocol Server）</strong> 。</p>
<h4 data-id="heading-12">a. spring-ai-starter-mcp-server-webmvc 依赖</h4>
<pre><code class="hljs language-xml" lang="xml">        <span class="hljs-comment">&lt;!--   AI    --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-mcp-server-webmvc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h5 data-id="heading-13">ⅰ. <code>spring-ai-starter-mcp-server-webmvc</code> 作用</h5>
<p>这个依赖就是用来让你：</p>
<p>快速在 Spring Boot 中构建一个可供 AI 调用的 <strong>MCP Server</strong></p>
<p>它提供了一整套自动化能力，包括：</p>





























<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td><strong>MCP 协议实现</strong></td><td>自动处理模型发来的 JSON-RPC / WebSocket 消息，符合 Model Context Protocol 规范。</td></tr><tr><td><strong>Tool 注册机制</strong></td><td>允许你编写 <code>@McpTool</code>或实现 <code>McpTool</code>接口的类，自动暴露为 AI 可用的“工具”。</td></tr><tr><td><strong>WebMVC 适配</strong></td><td>支持基于 HTTP 的 MCP 通信（即 <code>spring-boot-starter-web</code>兼容）。</td></tr><tr><td><strong>工具描述生成</strong></td><td>自动生成 MCP 元数据（Tool 名称、参数描述、功能定义），供 AI 模型理解如何使用。</td></tr><tr><td><strong>与 LLM 集成</strong></td><td>可与 Spring AI 的 <code>OpenAI</code>、<code>Ollama</code>、<code>Anthropic</code>等客户端整合，实现端到端 AI 能力。</td></tr></tbody></table>
<hr/>
<h5 data-id="heading-14">ⅱ. 典型应用场景</h5>
<p>在车联网（V2X）或 IoT 系统中，你可以通过 MCP Server 让 AI：</p>





















<table><thead><tr><th>场景</th><th>AI 可以做的事情</th></tr></thead><tbody><tr><td>数据查询</td><td>“请帮我查询今天所有在线车辆的数目” → AI 调用 <code>query()</code>工具，执行 SQL 返回结果。</td></tr><tr><td>告警分析</td><td>“显示当前所有一级风险车辆” → AI 通过 MCP 调用你的告警服务接口。</td></tr><tr><td>报表生成</td><td>“帮我生成上周车辆能耗分析报告” → AI 从 Doris / MySQL 拉取聚合数据。</td></tr></tbody></table>
<p>这些都由 <code>spring-ai-starter-mcp-server-webmvc</code> 帮你处理协议层通信。</p>
<hr/>
<h5 data-id="heading-15">ⅲ. 它与其他依赖的关系</h5>





















<table><thead><tr><th>依赖</th><th>功能</th></tr></thead><tbody><tr><td><code>spring-ai-starter-mcp-server-webmvc</code></td><td>提供 AI 调用接口（你是服务端）</td></tr><tr><td><code>spring-ai-starter-mcp-client</code></td><td>让你的应用去访问别的 MCP 服务（你是客户端）</td></tr><tr><td><code>spring-ai-openai-spring-boot-starter</code></td><td>提供与 OpenAI 模型交互的能力（AI 模型调用 MCP Server）</td></tr></tbody></table>
<p>依赖定位是让外部 AI（比如 Cursor,Hiagent,Dify）可以调用你的业务逻辑的 Server</p>
<hr/>
<h4 data-id="heading-16">b. 完整配置</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span>
  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.acho<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>acho-mcp-parse-gb32960-tool<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>acho-mcp-parse-gb32960-tool<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>HTTP/SSE MCP Server<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>21<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">spring-ai.version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">spring-ai.version</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-mcp-server-webmvc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-ai.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Lombok --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Test --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>


  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>


  <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>${project.artifactId}<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<h3 data-id="heading-17">2. 开发代码</h3>
<h5 data-id="heading-18">ⅰ. 编写mcp-tool</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 车联网平台智能工具
 * 提供 AI MCP Server 可调用的数据库查询能力（基于 Doris）
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AiBusinessTool</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> JdbcTemplate dorisJdbcTemplate;

    <span class="hljs-keyword">public</span> AiBusinessTool(<span class="hljs-meta">@Qualifier(<span class="hljs-string">"dorisJdbcTemplate"</span>)</span> JdbcTemplate dorisJdbcTemplate) {
        <span class="hljs-keyword">this</span>.dorisJdbcTemplate = dorisJdbcTemplate;
    }

    <span class="hljs-comment">/**
     * 通用 SELECT 查询
     * - 仅允许执行 SELECT 语句
     * - 支持 LIMIT 保护防止返回过多数据
     * - 自动格式化结果为 JSON-like 字符串
     */</span>
    <span class="hljs-meta">@Tool(description = <span class="hljs-string">"执行 SELECT 查询并返回结果，仅支持 SELECT 语句。支持 LIMIT 限制，避免数据量过大。"</span>)</span>
    <span class="hljs-keyword">public</span> String query(String sql) {
        log.info(<span class="hljs-string">"执行查询 SQL: {}"</span>, sql);

        <span class="hljs-comment">// 安全防护</span>
        String lowerSql = sql.trim().toLowerCase();
        <span class="hljs-keyword">if</span> (!lowerSql.startsWith(<span class="hljs-string">"select"</span>)) {
            <span class="hljs-keyword">throw</span> new IllegalArgumentException(<span class="hljs-string">"仅允许执行 SELECT 查询。"</span>);
        }
        <span class="hljs-keyword">if</span> (!lowerSql.contains(<span class="hljs-string">"limit"</span>)) {
            sql = sql + <span class="hljs-string">" LIMIT 100"</span>; <span class="hljs-comment">// 默认防止爆量</span>
        }

        <span class="hljs-keyword">try</span> {
            List&lt;Map&lt;String, Object&gt;&gt; result = dorisJdbcTemplate.queryForList(sql);
            <span class="hljs-keyword">if</span> (result.isEmpty()) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"查询成功，但未返回任何结果。"</span>;
            }
            <span class="hljs-keyword">return</span> result.stream()
            .map(row -&gt; row.entrySet().stream()
                 .map(e -&gt; e.getKey() + <span class="hljs-string">"="</span> + e.getValue())
                 .collect(Collectors.joining(<span class="hljs-string">", "</span>, <span class="hljs-string">"{"</span>, <span class="hljs-string">"}"</span>)))
            .collect(Collectors.joining(<span class="hljs-string">"\n"</span>));
        } <span class="hljs-keyword">catch</span> (DataAccessException e) {
            log.error(<span class="hljs-string">"查询执行失败: {}"</span>, e.getMessage(), e);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"查询执行失败: "</span> + e.getMessage();
        }
    }

    <span class="hljs-comment">/**
     * 查询数据库中的所有表名
     */</span>
    <span class="hljs-meta">@Tool(description = <span class="hljs-string">"返回当前 Doris 数据库中的所有表名。"</span>)</span>
    <span class="hljs-keyword">public</span> String listAllTables() {
        log.info(<span class="hljs-string">"获取当前数据库的所有表名..."</span>);
        <span class="hljs-keyword">try</span> {
            List&lt;Map&lt;String, Object&gt;&gt; tables = dorisJdbcTemplate.queryForList(
                <span class="hljs-string">"SELECT table_name FROM information_schema.tables WHERE table_schema = DATABASE()"</span>
            );
            <span class="hljs-keyword">if</span> (tables.isEmpty()) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"未找到任何表。"</span>;
            }
            <span class="hljs-keyword">return</span> tables.stream()
            .map(e -&gt; e.values().iterator().next().toString())
            .collect(Collectors.joining(<span class="hljs-string">", "</span>));
        } <span class="hljs-keyword">catch</span> (DataAccessException e) {
            log.error(<span class="hljs-string">"获取表名失败: {}"</span>, e.getMessage(), e);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"获取表名失败: "</span> + e.getMessage();
        }
    }

    <span class="hljs-comment">/**
     * 查看指定表结构
     */</span>
    <span class="hljs-meta">@Tool(description = <span class="hljs-string">"返回指定表的字段信息，包括字段名、数据类型、是否可为空及默认值。"</span>)</span>
    <span class="hljs-keyword">public</span> String getTableSchema(String tableName) {
        log.info(<span class="hljs-string">"获取表结构: {}"</span>, tableName);
        <span class="hljs-keyword">if</span> (tableName == <span class="hljs-literal">null</span> || tableName.trim().isEmpty()) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"表名不能为空。"</span>;
        }

        <span class="hljs-keyword">try</span> {
            List&lt;Map&lt;String, Object&gt;&gt; columns = dorisJdbcTemplate.queryForList(
                <span class="hljs-string">"SELECT column_name, data_type, is_nullable, column_default "</span> +
                <span class="hljs-string">"FROM information_schema.columns WHERE table_name = ?"</span>, tableName
            );

            <span class="hljs-keyword">if</span> (columns.isEmpty()) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"未找到表结构，请确认表名是否正确: "</span> + tableName;
            }

                String result = columns.stream()
                    .map(map -&gt; map.entrySet().stream()
                            .map(entry -&gt; entry.getKey() + <span class="hljs-string">"="</span> + entry.getValue())
                            .collect(Collectors.joining(<span class="hljs-string">", "</span>, <span class="hljs-string">"{"</span>, <span class="hljs-string">"}"</span>)))
                    .collect(Collectors.joining(<span class="hljs-string">"\n"</span>));

            <span class="hljs-keyword">return</span> <span class="hljs-string">"表 "</span> + tableName + <span class="hljs-string">" 字段信息如下：\n"</span> + result;

        } <span class="hljs-keyword">catch</span> (DataAccessException e) {
            log.error(<span class="hljs-string">"获取表结构失败: {}"</span>, e.getMessage(), e);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"获取表结构失败: "</span> + e.getMessage();
        }
    }


    <span class="hljs-comment">/**
     * 解析报文请求头
     * <span class="hljs-doctag">@param</span> hex 报文
     */</span>
    <span class="hljs-meta">@Tool(description = <span class="hljs-string">"解析地上铁GB32960协议16进制字符串报文,解析报文头数据"</span>)</span>
    <span class="hljs-keyword">public</span> Response&lt;P32960Header&gt; parseHeader(<span class="hljs-meta">@ToolParam(description = <span class="hljs-string">"16进制字符串报文，格式2323开头..."</span>)</span> String hex) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (hex == <span class="hljs-literal">null</span> || hex.isEmpty()){
                <span class="hljs-keyword">return</span> Response.error(<span class="hljs-string">"报文不能为空"</span>);
            }
            byte[] origin = HexUtils.fromHexString(hex);
            <span class="hljs-comment">// 校验数据</span>
            <span class="hljs-keyword">if</span> (!Analysis32960.checkCode(origin)) {
                <span class="hljs-keyword">return</span> Response.error(<span class="hljs-string">"数据校验失败，原始数据无法处理"</span>);
            }
            ByteBuffer buffer = ByteBuffer.wrap(origin);
            P32960Header header = Analysis32960.extractHeader(buffer);
            <span class="hljs-keyword">return</span> Response.succeed(header);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> Response.error(<span class="hljs-string">"处理解析报文异常，异常信息：【{}】"</span>,e);
        }
    }


    <span class="hljs-comment">/**
     * 解析32960实时数据
     * <span class="hljs-doctag">@param</span> hex 报文
     */</span>
    <span class="hljs-meta">@Tool(description = <span class="hljs-string">"解析地上铁GB32960协议16进制字符串报文,解析32960实时数据"</span>)</span>
    <span class="hljs-keyword">public</span> Response&lt;P32960Data02&gt; parseRealTimeData(<span class="hljs-meta">@ToolParam(description = <span class="hljs-string">"16进制字符串报文，格式2323开头..."</span>)</span> String hex) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (hex == <span class="hljs-literal">null</span> || hex.isEmpty()){
                <span class="hljs-keyword">return</span> Response.error(<span class="hljs-string">"报文不能为空"</span>);
            }
            byte[] origin = HexUtils.fromHexString(hex);
            <span class="hljs-comment">// 校验数据</span>
            <span class="hljs-keyword">if</span> (!Analysis32960.checkCode(origin)) {
                <span class="hljs-keyword">return</span> Response.error(<span class="hljs-string">"数据校验失败，原始数据无法处理"</span>);
            }
            ByteBuffer buffer = ByteBuffer.wrap(origin);
            P32960Header header = Analysis32960.extractHeader(buffer);

            <span class="hljs-keyword">if</span> (header.getCmd() != <span class="hljs-number">0x02</span>){
                <span class="hljs-keyword">return</span> Response.error(<span class="hljs-string">"报文解析失败，目前只支持解析02实时数据报文"</span>);
            }
            P32960Data02 data02 = Analysis32960.analysis02(buffer, buffer.limit(), <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">return</span> Response.succeed(data02);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> Response.error(<span class="hljs-string">"处理解析报文异常，异常信息：【{}】"</span>,e);
        }
    }
</code></pre>
<h6 data-id="heading-19">1. 总体结构</h6>





































<table><thead><tr><th>模块</th><th>涉及知识点</th></tr></thead><tbody><tr><td><strong>Spring Boot 服务层</strong></td><td>使用 <code>@Service</code>标注业务组件，配合依赖注入（<code>@Qualifier</code>）实现解耦。</td></tr><tr><td><strong>Spring AI MCP Tool</strong></td><td>通过 <code>@Tool</code>/ <code>@ToolParam</code>注解暴露 AI 可调用的工具方法。</td></tr><tr><td><strong>JDBC 操作 Doris</strong></td><td>通过 <code>JdbcTemplate</code>操作 Doris 数据库，实现表信息与数据查询。</td></tr><tr><td><strong>日志与异常处理</strong></td><td>使用 Lombok 的 <code>@Slf4j</code>打印日志，异常捕获后返回结构化错误信息。</td></tr><tr><td><strong>安全防护</strong></td><td>限制 SQL 类型（仅 SELECT）、添加默认 LIMIT、防止 SQL 注入与爆量查询。</td></tr><tr><td><strong>协议解析模块</strong></td><td>调用 32960 协议解析工具类 <code>Analysis32960</code>，验证、解析报文。</td></tr><tr><td><strong>响应封装</strong></td><td>使用统一的 <code>Response</code>对象（成功/失败），返回给上层或 AI 模型。</td></tr></tbody></table>
<hr/>
<h6 data-id="heading-20">2. Spring AI (MCP Server) 相关知识点</h6>





















<table><thead><tr><th>注解</th><th>含义</th></tr></thead><tbody><tr><td><code>@Tool</code></td><td>将方法暴露为 <strong>AI 可调用的工具函数（Tool）</strong> ，MCP Server 启动时会自动扫描注册。</td></tr><tr><td><code>@ToolParam</code></td><td>用于说明参数的语义和用途，帮助 AI 模型理解参数（用于自动生成 JSON Schema）。</td></tr><tr><td>MCP Server 框架</td><td>自动暴露这些工具为可被 ChatGPT / Claude 调用的 MCP 接口，比如 <code>/mcp/tools/query</code>。</td></tr></tbody></table>
<p><strong>关键点</strong>：AI 模型并不是调用传统 API，而是通过 MCP 协议调用“工具（Tool）”。<br/>
<code>@Tool</code> 注解让普通业务方法变成“AI 能调用的函数”。</p>
<hr/>
<h5 data-id="heading-21">ⅱ. 注册Mcp工具</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 项目启动类
 * @author 张朝
 */</span>
<span class="hljs-variable">@Slf4j</span>
<span class="hljs-variable">@SpringBootApplication</span>(scanBasePackages = {PACKAGE_NAME})
<span class="hljs-variable">@EnableFeignClients</span>(basePackages = PACKAGE_NAME + <span class="hljs-string">".infrastructure.acl"</span>)
<span class="hljs-variable">@EnableDiscoveryClient</span>
<span class="hljs-variable">@MapperScan</span>(basePackages = {PACKAGE_NAME + <span class="hljs-string">".infrastructure.biz.mysql.**.mapper"</span>})
public class DstV2xManagerApplication {

    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">PACKAGE_NAME</span> = "<span class="hljs-selector-tag">dst</span><span class="hljs-selector-class">.v2x</span><span class="hljs-selector-class">.manager</span><span class="hljs-selector-class">.service</span>";

    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-selector-tag">StopWatch</span> <span class="hljs-selector-tag">stopWatch</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">StopWatch</span>();
        <span class="hljs-selector-tag">stopWatch</span><span class="hljs-selector-class">.start</span>();
        <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(DstV2xManagerApplication.class, args);
        <span class="hljs-selector-tag">stopWatch</span><span class="hljs-selector-class">.stop</span>();

        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"【服务："</span> + DstSpringUtil.<span class="hljs-built_in">getAppName</span>() +
                <span class="hljs-string">"；环境："</span> + DstSpringUtil.<span class="hljs-built_in">getActiveProfile</span>() +
                <span class="hljs-string">"】启动成功，耗时："</span> +
                new <span class="hljs-built_in">DecimalFormat</span>(<span class="hljs-string">"#.##"</span>).<span class="hljs-built_in">format</span>(stopWatch.<span class="hljs-built_in">getTotalTimeSeconds</span>()) + <span class="hljs-string">" 秒。"</span>);
    }


    <span class="hljs-comment">/**
     * 注册 MCP 工具
     */</span>
    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ToolCallbackProvider</span> <span class="hljs-selector-tag">parseTools</span>(AiBusinessTool parseTool) {
        <span class="hljs-comment">// 将 ParseTool 暴露为 MCP 的工具</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">MethodToolCallbackProvider</span><span class="hljs-selector-class">.builder</span>()<span class="hljs-selector-class">.toolObjects</span>(parseTool)<span class="hljs-selector-class">.build</span>();
    }

}
</code></pre>
<h6 data-id="heading-22">1. <code>@Bean</code></h6>
<ul>
<li>表示这是一个 <strong>Spring Bean</strong>，由 Spring 容器管理。</li>
<li>MCP Server 会扫描容器中的 <code>ToolCallbackProvider</code> Bean，用来注册可被 AI 调用的工具方法。</li>
</ul>
<h6 data-id="heading-23">2. <code>ToolCallbackProvider</code></h6>
<ul>
<li>Spring AI MCP 的接口，用于 <strong>提供工具回调对象</strong>。</li>
<li>核心作用：告诉 MCP Server 哪些对象的方法可以被 AI 调用。</li>
<li>MCP Server 在收到模型请求时，会通过这个回调查找对应的工具方法。</li>
</ul>
<h6 data-id="heading-24">3. <code>MethodToolCallbackProvider.builder()</code></h6>
<ul>
<li><code>MethodToolCallbackProvider</code> 是 <code>ToolCallbackProvider</code> 的实现类。</li>
<li>它会扫描你提供的对象中的 <strong>所有带</strong> <code>@Tool</code> <strong>注解的方法</strong>。</li>
<li>然后生成 MCP 的工具映射（工具名称、方法、参数信息、描述信息）。</li>
</ul>
<h6 data-id="heading-25">4. <code>.toolObjects(parseTool)</code></h6>
<ul>
<li>将 <code>AiBusinessTool</code> 实例传给 MCP Server。</li>
<li>MCP Server 会扫描这个对象中所有 <code>@Tool</code> 方法，例如：</li>
</ul>

<ul>
<li>
<ul>
<li><code>query(String sql)</code></li>
<li><code>listAllTables()</code></li>
<li><code>getTableSchema(String tableName)</code></li>
<li><code>parseHeader(String hex)</code></li>
<li><code>parseRealTimeData(String hex)</code></li>
</ul>
</li>
</ul>

<ul>
<li>这样 AI 模型就可以通过 MCP 协议调用这些方法。</li>
</ul>
<h6 data-id="heading-26">5. <code>.build()</code></h6>
<ul>
<li>构建 <code>MethodToolCallbackProvider</code> 对象，并注册到 Spring 容器中。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22a73d6a8ad94180962f3f41fadf67e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=vVguk%2B%2FvwPiQXxKXOPvKDzLRn7Q%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-27">3. Sping AI 配置文件</h3>
<p>写在 bootstrap.properties 中，这是SpringBoot框架的根配置文件</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># =======================</span>
<span class="hljs-comment"># Spring AI MCP Server 配置</span>
<span class="hljs-comment"># =======================</span>

<span class="hljs-comment"># MCP Server 名称，用于在 MCP 协议注册时标识</span>
<span class="hljs-attr">spring.ai.mcp.server.name</span>=dst-v2x-manager-service

<span class="hljs-comment"># MCP Server 版本号，用于版本管理</span>
<span class="hljs-attr">spring.ai.mcp.server.version</span>=<span class="hljs-number">1.0</span>.<span class="hljs-number">0</span>

<span class="hljs-comment"># MCP Server 类型，SYNC 表示同步调用，ASYNC 表示异步调用</span>
<span class="hljs-attr">spring.ai.mcp.server.type</span>=SYNC

<span class="hljs-comment"># MCP Server 功能说明，用于 AI 或客户端了解该服务的用途</span>
<span class="hljs-attr">spring.ai.mcp.server.instructions</span>=车联网平台智能工具

<span class="hljs-comment"># 是否启用 MCP Server 功能，true 表示启用</span>
<span class="hljs-attr">spring.ai.mcp.server.enabled</span>=<span class="hljs-literal">true</span>

<span class="hljs-comment"># SSE 消息推送端点，用于客户端订阅服务事件</span>
<span class="hljs-attr">spring.ai.mcp.server.sse-message-endpoint</span>=/sse

<span class="hljs-comment"># =======================</span>
<span class="hljs-comment"># MCP Server 功能能力配置</span>
<span class="hljs-comment"># =======================</span>

<span class="hljs-comment"># 是否支持 Tool 调用功能</span>
<span class="hljs-attr">spring.ai.mcp.server.capabilities.tool</span>=<span class="hljs-literal">true</span>

<span class="hljs-comment"># 是否支持 Resource 资源功能</span>
<span class="hljs-attr">spring.ai.mcp.server.capabilities.resource</span>=<span class="hljs-literal">true</span>

<span class="hljs-comment"># 是否支持 Prompt 输入功能</span>
<span class="hljs-attr">spring.ai.mcp.server.capabilities.prompt</span>=<span class="hljs-literal">true</span>

<span class="hljs-comment"># 是否支持 Completion 输出功能</span>
<span class="hljs-attr">spring.ai.mcp.server.capabilities.completion</span>=<span class="hljs-literal">true</span>
</code></pre>
<h2 data-id="heading-28">五、验证测试</h2>
<p>怎么验证MCP-Server正确的开发完成，可以自己开发MCP clients ，也可以采用市面上成熟的AI集成应用比如HiAgent,Dify,Cursor, Claude等，它们已经包含了MCP clients 能力了，这里就不开发MCP clients 了，这里将采用Cursor和HiAgent做测试</p>
<h3 data-id="heading-29">1、Cursor测试Mcp-Server</h3>
<h4 data-id="heading-30">配置cursor</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73267eaf37a2439a8068d455ad29a57c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=8fPPYaVfs3kmX27D2wquMw4Jqdo%3D" alt="" loading="lazy"/></p>
<p>Cursor创建一个新的项目，创建文件 .cursor ,在其下面再创建文件mcp.json，mcp.json就是放置mcp-server配置的地方，我们刚刚创建的Mcp-Server项目的名称为 dst-v2x-manager-service ，启动端口为：18522</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dst-v2x-manager-service"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
     <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mcp"</span><span class="hljs-punctuation">,</span>
     <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://127.0.0.1:18522/sse"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-31">1️⃣ <code>"mcpServers"</code></h5>
<ul>
<li>顶层字段，表示 <strong>MCP Server 的注册列表</strong>。</li>
<li>可以同时配置多个 MCP Server，每个服务通过唯一名称区分。</li>
</ul>
<h5 data-id="heading-32">2️⃣ <code>"dst-v2x-manager-service"</code></h5>
<ul>
<li>这是 MCP Server 的 <strong>逻辑名称 / 服务名称</strong>，可自定义。</li>
<li>在客户端或者 Spring AI Agent 中调用时，可以通过这个名称引用对应的服务。</li>
</ul>
<h5 data-id="heading-33">3️⃣ <code>"type": "mcp"</code></h5>
<ul>
<li>指明这是一个 <strong>MCP Server 类型</strong>。</li>
<li>Spring AI 支持多种连接方式（比如 <code>openai</code>、<code>mcp</code>），这里使用 <code>mcp</code> 表示标准 <strong>Model Context Protocol Server</strong>。</li>
</ul>
<h5 data-id="heading-34">4️⃣ <code>"url": "http://127.0.0.1:18522/sse"</code></h5>
<ul>
<li>MCP Server 的 <strong>访问地址</strong>。</li>
<li><code>http://127.0.0.1:18522/sse</code> 表示 <strong>本地服务的 SSE（Server-Sent Events）端点</strong>。</li>
<li>这说明 MCP Server 使用 <strong>SSE 协议</strong>与客户端/模型通信。</li>
<li>SSE 模式适合 <strong>持续推送事件 / 实时响应</strong> 的场景，比如 AI 模型订阅工具输出。</li>
</ul>
<h4 data-id="heading-35">结果验证</h4>
<p>打开 cusor 设置页面，点击 Tools / MCP ,会发现刚刚配置的Mcp-Server</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdccf3a19301433798ccd2488c600006~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=u5N1AG7o2B59oB9UG03NJz6V874%3D" alt="" loading="lazy"/></p>
<p>打开启用</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84181716b2cb42a69535de7f902835de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=9O1rp6gOtYjjydbsxyxWFTPCL2I%3D" alt="" loading="lazy"/></p>
<p>会发现底下的红点变为了绿点平且刚刚开发的工具都已经显示，代表配置成功</p>
<h3 data-id="heading-36">2、Hiagent测试Mcp-Server</h3>
<h4 data-id="heading-37">配置MCP插件</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6aecf7e67ac474abe8a42bb1cb48d1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=zbA4nDKWjvRvZbQ2PkbJxKc%2FJpM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-38">接入mcp插件</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eede0b2eaf749b2928999a4ffff5d3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=DPbt6g4Bl9%2FxJrLQuEcy6wTY98A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ee8f7d81ae14b5e995bd627ea1b36ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=UKXyloR5FyM1UP0s6TncqZ9XBsk%3D" alt="" loading="lazy"/></p>
<p>地址就是<a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A18522%2Fsse%25E8%25BF%2599%25E4%25B8%25AA%25E5%259C%25B0%25E5%259D%2580%25EF%25BC%258C%25E6%259A%2582%25E6%2597%25B6%25E9%2580%2589%25E7%2594%25A8%25E6%2597%25A0%25E8%25AE%25A4%25E8%25AF%2581%25E6%2596%25B9%25E5%25BC%258F%25EF%25BC%258C%25E7%25BA%25BF%25E4%25B8%258A%25E7%258E%25AF%25E5%25A2%2583%25E9%259C%2580%25E8%25A6%2581%25E9%2589%25B4%25E6%259D%2583%25E3%2580%2582" target="_blank" title="http://127.0.0.1:18522/sse%E8%BF%99%E4%B8%AA%E5%9C%B0%E5%9D%80%EF%BC%8C%E6%9A%82%E6%97%B6%E9%80%89%E7%94%A8%E6%97%A0%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F%EF%BC%8C%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83%E9%9C%80%E8%A6%81%E9%89%B4%E6%9D%83%E3%80%82" ref="nofollow noopener noreferrer">http://127.0.0.1:18522/sse这个地址，暂时选用无认证方式，线上环境需要鉴权。</a></p>
<h4 data-id="heading-39">同步工具</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3d7a02cde46480ba7ab0ce5f9a9662e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=wGjlr4hlaoWQhRxfq4LGLU%2FUhUg%3D" alt="" loading="lazy"/></p>
<p>这些都是自动生成的，同步成果代表mcp-server正常</p>
<h4 data-id="heading-40">发布MCP</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efd17ade56654ccc9f952a3507af62ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=zRh5n9X1ZHQhKvimy6tMS1ecco0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-41">六、成果展示</h2>
<p>这里就用Hiagent做一个成果展示，因为我的Cusor账号无法登录了（国内封号很严重，如果不封号可以直接在聊天框选择Agent模式聊天，让他调用你的Mcp工具）</p>
<h3 data-id="heading-42">利用这个MCP创建一个Agent</h3>
<h4 data-id="heading-43">a. 创建Agent</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5e733de54fc43188a08b5c4b2198e43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=ZOrBaBlmHgdqy3fKwtJ%2Bx%2FohPDk%3D" alt="" loading="lazy"/></p>
<p>这里需要维护好提示词，以及配置刚刚MCP工具，这样一个简单的Agent就完成了</p>
<h4 data-id="heading-44">b. 聊天测试</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90b45b1c11254a37a7b8b6339e0c2bc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=JTU08XSptw3it9CEUKVIfyPHcNs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8540d1e91f7241d8a7640ac1b4ecfbf8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=4dLuSyOGJ9GBQUOwtEARghVdpLE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d01d82143e54b14bd29a9900b9d878f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=1O8u2BcpbBRAk3Oxr2QHqlO%2F904%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32f2842866224d4eb62f2ea7d2b11c24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770807974&amp;x-signature=DtyGythVrcdhcoFlTZAYaLE0QJg%3D" alt="" loading="lazy"/></p>
<p>如果需要更清晰的回复，这里就需要配置模型，知识库，RAG等，这里就不过多赘述，主要先完成MCP-Server</p>
<p>,到这里就结束了，希望能给你带来帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何创建一个 Agent Skill？]]></title>    <link>https://juejin.cn/post/7602776926327930934</link>    <guid>https://juejin.cn/post/7602776926327930934</guid>    <pubDate>2026-02-04T11:52:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602776926327930934" data-draft-id="7602842876256682030" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何创建一个 Agent Skill？"/> <meta itemprop="keywords" content="Agent,人工智能,掘金翻译计划"/> <meta itemprop="datePublished" content="2026-02-04T11:52:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小星星_ios"/> <meta itemprop="url" content="https://juejin.cn/user/4406498333306407"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何创建一个 Agent Skill？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498333306407/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小星星_ios
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T11:52:15.000Z" title="Wed Feb 04 2026 11:52:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">关于 Skill</h2>
<p>技能是模块化、自包含的软件包，通过提供专业知识、工作流程和工具来扩展 claude 的能力。可以将它们视为特定领域或任务的"入门指南"——它们将 claude 从通用代理转变为配备程序性知识的专业代理，这些知识是任何模型都无法完全掌握的。</p>
<h3 data-id="heading-1">Skill 提供了什么？</h3>
<ol>
<li><strong>专业化工作流程</strong> - 针对特定领域的多步骤程序</li>
<li><strong>工具集成</strong> - 处理特定文件格式或API的说明</li>
<li><strong>领域专业知识</strong> - 公司特定知识、模式、业务逻辑</li>
<li><strong>捆绑资源</strong> - 用于复杂和重复任务的脚本、参考资料和资源</li>
</ol>
<h2 data-id="heading-2">核心原则</h2>
<h3 data-id="heading-3">简洁是关键</h3>
<p>上下文窗口是公共资源。技能会将上下文窗口与 claude 所需的其他所有内容共享：系统提示、对话历史记录、其他技能的元数据以及用户的实际请求。</p>
<p><strong>默认假设：claude 已经非常聪明。</strong> 只添加 claude 原本不了解的背景信息。对每条信息都进行质疑：“claude 真的需要这个解释吗？”以及“这段文字的字数成本合理吗？”</p>
<p>比起冗长的解释，更倾向于简洁的例子。</p>
<h3 data-id="heading-4">设定适当的自由度</h3>
<p>根据任务的脆弱性和可变性调整具体程度：</p>
<p><strong>高自由度（基于文本的说明）</strong> ：当多种方法都有效、决策取决于上下文或启发式方法指导决策时使用。</p>
<p><strong>中等自由度（伪代码或带参数的脚本）</strong> ：当存在首选模式、一些变化是可以接受的，或者配置会影响行为时使用。</p>
<p><strong>低自由度（特定脚本，少量参数）</strong> ：适用于操作脆弱且容易出错、一致性至关重要或必须遵循特定顺序的情况。</p>
<p>把 <code>claude</code> 想象成探索一条道路：一条有悬崖的狭窄桥梁需要特定的护栏（自由度低），而一片开阔的田野则允许许多路线（自由度高）。</p>
<h3 data-id="heading-5">技能剖析</h3>
<p>每项技能都包含一个必需的 <code>SKILL.md</code> 文件和可选的捆绑资源：</p>
<pre><code class="hljs language-swift" lang="swift">skill<span class="hljs-operator">-</span>name<span class="hljs-operator">/</span>
<span class="hljs-operator">├──</span> <span class="hljs-type">SKILL</span>.md (<span class="hljs-keyword">required</span>)
<span class="hljs-operator">│</span>   <span class="hljs-operator">├──</span> <span class="hljs-type">YAML</span> frontmatter metadata (<span class="hljs-keyword">required</span>)
<span class="hljs-operator">│</span>   <span class="hljs-operator">│</span>   <span class="hljs-operator">├──</span> name: (<span class="hljs-keyword">required</span>)
<span class="hljs-operator">│</span>   <span class="hljs-operator">│</span>   <span class="hljs-operator">└──</span> description: (<span class="hljs-keyword">required</span>)
<span class="hljs-operator">│</span>   <span class="hljs-operator">└──</span> <span class="hljs-type">Markdown</span> instructions (<span class="hljs-keyword">required</span>)
<span class="hljs-operator">└──</span> <span class="hljs-type">Bundled</span> <span class="hljs-type">Resources</span> (<span class="hljs-keyword">optional</span>)
    <span class="hljs-operator">├──</span> scripts<span class="hljs-operator">/</span>          <span class="hljs-operator">-</span> <span class="hljs-type">Executable</span> code (<span class="hljs-type">Python</span><span class="hljs-operator">/</span><span class="hljs-type">Bash</span><span class="hljs-operator">/</span>etc.)
    <span class="hljs-operator">├──</span> references<span class="hljs-operator">/</span>       <span class="hljs-operator">-</span> <span class="hljs-type">Documentation</span> intended to be loaded into context <span class="hljs-keyword">as</span> needed
    <span class="hljs-operator">└──</span> assets<span class="hljs-operator">/</span>           <span class="hljs-operator">-</span> <span class="hljs-type">Files</span> used <span class="hljs-keyword">in</span> output (templates, icons, fonts, etc.)
</code></pre>
<h4 data-id="heading-6">SKILL.md（必填）</h4>
<p>每个 SKILL.md 文件都包含：</p>
<ul>
<li><strong>Frontmatter</strong>（YAML）：包含 <code> &lt;skill-name&gt; </code>name<code> 和`description</code>` 字段。claude 仅读取这些字段来判断技能何时使用，因此清晰全面地描述技能及其使用时机至关重要。</li>
<li><strong>正文</strong>（Markdown）：技能使用说明和指南。仅在技能触发后加载。</li>
</ul>
<h4 data-id="heading-7">捆绑资源（可选）</h4>
<h5 data-id="heading-8">脚本（<code>scripts/</code>）</h5>
<p>用于需要确定性可靠性或需要反复重写的任务的可执行代码（Python/Bash 等）。</p>
<ul>
<li><strong>何时需要包含</strong>：当相同的代码被反复重写或需要确定性可靠性时。</li>
<li><strong>例如</strong>：<code>scripts/rotate_pdf.py</code>用于 PDF 旋转任务</li>
<li><strong>优点</strong>：令牌高效、确定性强，无需加载到上下文即可执行</li>
<li><strong>注意</strong>：Claude 可能仍然需要读取脚本以进行修补或针对特定环境的调整。</li>
</ul>
<h5 data-id="heading-9">参考 （<code>references/</code>）</h5>
<p>文档和参考资料旨在根据需要加载到上下文中，以指导 Claude 的创作过程和思考。</p>
<ul>
<li><strong>何时包含</strong>：供 claude 在工作时参考的文档</li>
<li><strong>例如</strong>：<code>references/finance.md</code>财务模式、<code>references/mnda.md</code>公司保密协议模板、<code>references/policies.md</code>公司政策、<code>references/api_docs.md</code>API规范</li>
<li><strong>使用场景</strong>：数据库模式、API文档、领域知识、公司政策、详细工作流程指南</li>
<li><strong>优点</strong>：保持 SKILL.md 文件精简，仅在 Claude 认为需要时才加载。</li>
<li><strong>最佳实践</strong>：如果文件较大（&gt;10k 个单词），请在 SKILL.md 文件中包含 grep 搜索模式。</li>
<li><strong>避免重复</strong>：信息应仅存在于 SKILL.md 文件或参考文件中，两者不可兼得。除非信息对技能至关重要，否则应优先将其放在参考文件中——这样既能保持 SKILL.md 的简洁性，又能确保信息易于查找，且不会占用过多上下文窗口。SKILL.md 中仅保留必要的操作步骤说明和工作流程指南；将详细的参考资料、模式和示例移至参考文件中。</li>
</ul>
<h5 data-id="heading-10">资产（<code>assets/</code>）</h5>
<p>这些文件并非旨在加载到上下文中，而是用于 Claude 生成的输出中。</p>
<ul>
<li><strong>何时包含</strong>：当技能需要最终输出中使用的文件时</li>
<li><strong>例如</strong>：<code>assets/logo.png</code>品牌资产、<code>assets/slides.pptx</code>PowerPoint模板、<code>assets/frontend-template/</code>HTML/React样板代码、<code>assets/font.ttf</code>排版</li>
<li><strong>使用场景</strong>：模板、图像、图标、样板代码、字体、示例文档等，这些内容会被复制或修改。</li>
<li><strong>优点</strong>：将输出资源与文档分离，使 Claude 能够在不将文件加载到上下文中的情况下使用它们。</li>
</ul>
<h4 data-id="heading-11">技能中不应包含哪些内容</h4>
<p>技能应该只包含直接支持其功能的必要文件。请勿创建无关的文档或辅助文件，包括：</p>
<ul>
<li>README.md</li>
<li>安装指南.md</li>
<li>快速参考.md</li>
<li>更新日志.md</li>
<li>ETC。</li>
</ul>
<p>技能本身应该只包含人工智能代理完成当前任务所需的信息，而不应该包含创建过程、设置和测试步骤、用户文档等辅助信息。创建额外的文档文件只会增加混乱和冗余。</p>
<h3 data-id="heading-12">渐进式披露设计原则</h3>
<p>技能采用三级加载系统来高效管理上下文：</p>
<ol>
<li><strong>元数据（名称 + 描述）：</strong> 始终与上下文相关（约 100 字）</li>
<li><strong>SKILL.md 正文：</strong> 技能触发时（小于 5000 字）</li>
<li><strong>捆绑资源：</strong> 根据 claude 的需要（数量不限，因为脚本无需读取上下文窗口即可执行）</li>
</ol>
<h4 data-id="heading-13">渐进式披露模式</h4>
<p>SKILL.md 文件正文应精简至 500 行以内，避免内容冗余。当接近此限制时，请将内容拆分到单独的文件中。拆分内容时，务必在 SKILL.md 中引用这些文件，并清晰说明何时需要阅读它们，以确保技能的读者了解这些文件的存在以及何时使用它们。</p>
<p><strong>关键原则：</strong> 当一项技能支持多种变体、框架或选项时，SKILL.md 中仅保留核心工作流程和选择指南。将特定于变体的细节（模式、示例、配置）移至单独的参考文件中。</p>
<p><strong>模式 1：附参考资料的高级指南</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># PDF Processing</span>

<span class="hljs-section">## Quick start</span>

Extract text with pdfplumber:
[code example]

<span class="hljs-section">## Advanced features</span>

<span class="hljs-bullet">-</span> <span class="hljs-strong">**Form filling**</span>: See [<span class="hljs-string">FORMS.md</span>](<span class="hljs-link">FORMS.md</span>) for complete guide
<span class="hljs-bullet">-</span> <span class="hljs-strong">**API reference**</span>: See [<span class="hljs-string">REFERENCE.md</span>](<span class="hljs-link">REFERENCE.md</span>) for all methods
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Examples**</span>: See [<span class="hljs-string">EXAMPLES.md</span>](<span class="hljs-link">EXAMPLES.md</span>) for common patterns
</code></pre>
<p><code>claude</code> 仅在需要时加载 <code>FORMS.md</code>、<code>REFERENCE.md</code> 或 <code>EXAMPLES.md</code>。</p>
<p>当用户询问销售指标时，claude 只会读取 sales.md 文件。</p>
<p>同样地，对于支持多种框架或变体的技能，请按变体进行组织：</p>
<pre><code class="hljs language-scss" lang="scss">cloud-deploy/
├── SKILL<span class="hljs-selector-class">.md</span> (workflow + provider selection)
└── references/
    ├── aws<span class="hljs-selector-class">.md</span> (AWS deployment patterns)
    ├── gcp<span class="hljs-selector-class">.md</span> (GCP deployment patterns)
    └── azure<span class="hljs-selector-class">.md</span> (Azure deployment patterns)
</code></pre>
<p>当用户选择 <code>AWS</code> 时，<code>claude</code> 只会读取 <code>aws.md</code>。</p>
<p><strong>模式 3：条件细节</strong></p>
<p>显示基础内容，并链接到高级内容：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># DOCX Processing</span>

<span class="hljs-comment">## Creating documents</span>

Use docx-js for new documents. See <span class="hljs-section">[DOCX-JS.md]</span>(DOCX-JS.md).

<span class="hljs-comment">## Editing documents</span>

For simple edits, modify the XML directly.

**For tracked changes**: See <span class="hljs-section">[REDLINING.md]</span>(REDLINING.md)
**For OOXML details**: See <span class="hljs-section">[OOXML.md]</span>(OOXML.md)
</code></pre>
<p>只有当用户需要这些功能时，<code>Claude</code> 才会读取 <code>REDLINEING.md</code> 或 <code>OOXML.md</code>。
<strong>重要准则：</strong></p>
<ul>
<li><strong>避免使用深度嵌套的引用</strong>——所有引用都应仅从 SKILL.md 文件向下嵌套一层。所有引用文件都应直接链接到 SKILL.md 文件。</li>
<li><strong>组织较长的参考文件</strong>- 对于超过 100 行的文件，请在顶部添加目录，以便 Claude 在预览时可以看到完整的内容。</li>
</ul>
<h2 data-id="heading-14">技能创造过程</h2>
<p>技能培养包括以下步骤：</p>
<ol>
<li>通过具体例子理解这项技能</li>
<li>规划可重用的技能内容（脚本、参考资料、素材）</li>
<li>初始化技能（运行 init_skill.py）</li>
<li>编辑技能（添加资源并编写 SKILL.md 文件）</li>
<li>将技能打包（运行 package_skill.py）</li>
<li>根据实际使用情况迭代</li>
</ol>
<p>请按顺序执行以下步骤，只有在有明确理由说明这些步骤不适用时才可跳过。</p>
<h3 data-id="heading-15">第一步：通过具体例子理解技能</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%2Fblob%2Fmain%2Fskills%2Fskill-creator%2FSKILL.md%23step-1-understanding-the-skill-with-concrete-examples" target="_blank" title="https://github.com/anthropics/skills/blob/main/skills/skill-creator/SKILL.md#step-1-understanding-the-skill-with-concrete-examples" ref="nofollow noopener noreferrer"/></p>
<p>只有当技能的使用模式已被完全理解时，才可跳过此步骤。即使是使用已有的技能，此步骤仍然很有价值。</p>
<p>要培养一项有效的技能，必须清楚地了解这项技能的具体应用实例。这种理解可以来自用户的直接反馈，也可以来自用户生成并经用户反馈验证的实例。</p>
<p>例如，在培养图像编辑技能时，相关问题包括：</p>
<ul>
<li>“图像编辑器技能应该支持哪些功能？编辑、旋转，还是其他功能？”</li>
<li>“你能举例说明一下这项技能会如何运用吗？”</li>
<li>“我可以想象用户会要求‘去除图片中的红眼’或‘旋转这张图片’之类的操作。您认为这项技能还有其他用途吗？”</li>
<li>用户说出什么话才能触发这项功能？</li>
</ul>
<p>为了避免给用户造成信息过载，请避免在一条消息中提出过多问题。先提出最重要的问题，然后根据需要进行跟进，以提高效率。</p>
<p>当对该技能应支持的功能有了清晰的认识后，即可完成此步骤。</p>
<h3 data-id="heading-16">步骤二：规划可复用技能内容</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%2Fblob%2Fmain%2Fskills%2Fskill-creator%2FSKILL.md%23step-2-planning-the-reusable-skill-contents" target="_blank" title="https://github.com/anthropics/skills/blob/main/skills/skill-creator/SKILL.md#step-2-planning-the-reusable-skill-contents" ref="nofollow noopener noreferrer"/></p>
<p>要将具体例子转化为有效的技能，请按以下方式分析每个例子：</p>
<ol>
<li>考虑如何从头开始执行示例</li>
<li>确定在重复执行这些工作流程时哪些脚本、参考资料和资源会有所帮助。</li>
</ol>
<p>例如：在构建<code>pdf-editor</code>处理“帮我旋转这个PDF”这类查询的技能时，分析结果显示：</p>
<ol>
<li>每次旋转PDF都需要重新编写相同的代码</li>
<li>将脚本<code>scripts/rotate_pdf.py</code>存储在技能中会很有帮助。</li>
</ol>
<p>例如：在设计<code>frontend-webapp-builder</code>诸如“为我创建一个待办事项应用”或“为我创建一个仪表盘来跟踪我的步数”之类的查询技能时，分析结果显示：</p>
<ol>
<li>编写前端 Web 应用程序每次都需要相同的 HTML/React 样板代码</li>
<li>包含 HTML/React 项目样板文件的模板<code>assets/hello-world/</code>对于技能存储将很有帮助。</li>
</ol>
<p>例如：在构建<code>big-query</code>用于处理“今天有多少用户登录？”这类查询的技能时，分析结果显示：</p>
<ol>
<li>每次查询 BigQuery 都需要重新发现表结构和关系。</li>
<li>将记录表结构的文档<code>references/schema.md</code>存储在技能库中会很有帮助。</li>
</ol>
<p>为了确定技能的内容，分析每个具体示例，创建可重用资源列表，其中包括：脚本、参考资料和资产。</p>
<h3 data-id="heading-17">步骤 3：初始化技能</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%2Fblob%2Fmain%2Fskills%2Fskill-creator%2FSKILL.md%23step-3-initializing-the-skill" target="_blank" title="https://github.com/anthropics/skills/blob/main/skills/skill-creator/SKILL.md#step-3-initializing-the-skill" ref="nofollow noopener noreferrer"/></p>
<p>现在，是时候真正培养这项技能了。</p>
<p>仅当所开发的技能已经存在，且需要迭代或打包时，才可跳过此步骤。在这种情况下，请继续执行下一步。</p>
<p>从零开始创建新技能时，务必运行<code>init_skill.py</code>脚本。该脚本会方便地生成一个新的技能模板目录，其中自动包含技能所需的一切，从而大大提高技能创建过程的效率和可靠性。</p>
<p>用法：</p>
<pre><code class="hljs language-xml" lang="xml">scripts/init_skill.py <span class="hljs-tag">&lt;<span class="hljs-name">skill-name</span>&gt;</span> --path <span class="hljs-tag">&lt;<span class="hljs-name">output-directory</span>&gt;</span>
</code></pre>
<p>剧本：</p>
<ul>
<li>在指定路径创建技能目录</li>
<li>生成包含正确 frontmatter 和 TODO 占位符的 SKILL.md 模板</li>
<li>创建示例资源目录：<code>scripts/</code>、、<code>references/</code>和<code>assets/</code></li>
<li>在每个目录中添加可自定义或删除的示例文件</li>
</ul>
<p>初始化完成后，根据需要自定义或删除生成的 SKILL.md 和示例文件。</p>
<h3 data-id="heading-18">步骤 4：编辑技能</h3>
<p>编辑（新建或已有的）技能时，请记住该技能是为另一个 claude 实例创建的。请添加对 claude 有益且不易察觉的信息。考虑哪些程序性知识、领域特定细节或可重用资源能够帮助另一个 claude 实例更有效地执行这些任务。</p>
<h4 data-id="heading-19">学习经过验证的设计模式</h4>
<p>根据您的技能需求，参考以下实用指南：</p>
<ul>
<li><strong>多步骤流程</strong>：有关顺序工作流和条件逻辑，请参阅 references/workflows.md。</li>
<li><strong>具体输出格式或质量标准</strong>：请参阅 references/output-patterns.md 获取模板和示例模式</li>
</ul>
<p>这些文件包含了有效技能设计的成熟最佳实践。</p>
<h4 data-id="heading-20">从可重复使用的技能内容开始</h4>
<p>要开始实施，请从上面列出的可重用资源入手：<code>scripts/</code>、<code>references/</code>和<code>assets/</code>文件。请注意，此步骤可能需要用户输入。例如，在实施一项<code>brand-guidelines</code>技能时，用户可能需要提供品牌资产或模板以存储在<code>assets/</code>，或者提供文档以存储在<code>references/</code>。</p>
<p>新增的脚本必须通过实际运行进行测试，以确保没有错误且输出结果符合预期。如果有很多类似的脚本，只需测试一个具有代表性的样本，以确保所有脚本都能正常运行，同时兼顾完成时间。</p>
<p>任何技能学习过程中不需要的示例文件和目录都应删除。初始化脚本会在 <code>&lt;example_file&gt;</code>、<code>&lt;example_file&gt;``scripts/</code>和<code>references/`` &lt;example_file&gt;</code> 中创建示例文件<code>assets/</code>以演示结构，但大多数技能学习过程并不需要所有这些文件。</p>
<h4 data-id="heading-21">更新 SKILL.md</h4>
<p><strong>写作指南：</strong> 始终使用祈使句/不定式。</p>
<h5 data-id="heading-22">前言</h5>
<p><code>name</code>使用以下方式编写 YAML frontmatter <code>description</code>：</p>
<ul>
<li>
<p><code>name</code>技能名称</p>
</li>
<li>
<p><code>description</code>这是你技能的主要触发机制，可以帮助 claude 了解何时使用该技能。</p>
<ul>
<li>包括技能的功能以及使用该技能的具体触发条件/情境。</li>
<li>所有“何时使用”的信息都应包含在此处——不要放在技能正文中。技能正文只有在技能触发后才会加载，因此技能正文中的“何时使用此技能”部分对 claude 没有帮助。</li>
<li>技能描述示例<code>docx</code>：“全面支持文档创建、编辑和分析，包括跟踪更改、注释、格式保留和文本提取。当 claude 需要处理专业文档（.docx 文件）时，可以使用此功能，具体包括：(1) 创建新文档；(2) 修改或编辑内容；(3) 使用跟踪更改；(4) 添加注释；或执行任何其他文档任务。”</li>
</ul>
</li>
</ul>
<p>YAML frontmatter 中不要包含任何其他字段。</p>
<h5 data-id="heading-23">正文</h5>
<p>编写使用该技能及其配套资源的说明。</p>
<h3 data-id="heading-24">第五步：包装技能</h3>
<p>技能开发完成后，必须将其打包成可分发的 .skill 文件并与用户共享。打包过程首先会自动验证技能，以确保其满足所有要求：</p>
<pre><code class="hljs language-bash" lang="bash">scripts/package_skill.py &lt;path/to/skill-folder&gt;
</code></pre>
<p>可选的输出目录规范：</p>
<pre><code class="hljs language-bash" lang="bash">scripts/package_skill.py &lt;path/to/skill-folder&gt; ./dist
</code></pre>
<p>打包脚本将：</p>
<ol>
<li>
<p><strong>自动验证</strong>技能，检查以下内容：</p>
<ul>
<li>YAML frontmatter 格式和必填字段</li>
<li>技能命名规则和目录结构</li>
<li>描述的完整性和质量</li>
<li>文件组织和资源引用</li>
</ul>
</li>
<li>
<p>如果验证通过，则将技能<strong>打包</strong><code>my-skill.skill</code>，创建一个以技能名称命名的 .skill 文件（例如），该文件包含所有相关文件并保持正确的目录结构以便分发。.skill 文件是一个扩展名为 .skill 的 zip 文件。</p>
</li>
</ol>
<p>如果验证失败，脚本将报告错误并退出，而不创建软件包。请修复所有验证错误，然后再次运行打包命令。</p>
<h3 data-id="heading-25">步骤 6：迭代</h3>
<p>用户在测试技能后可能会提出改进建议。这种情况通常发生在刚使用完技能之后，因为他们对技能的表现有了更清晰的了解。</p>
<p><strong>迭代工作流程：</strong></p>
<ol>
<li>在实际任务中运用这项技能</li>
<li>注意遇到的困难或效率低下之处</li>
<li>确定如何更新 SKILL.md 或捆绑资源</li>
<li>实施更改并再次测试</li>
</ol>
<h2 data-id="heading-26">参考</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%2Fblob%2Fmain%2Fskills%2Fskill-creator%2FSKILL.md" target="_blank" title="https://github.com/anthropics/skills/blob/main/skills/skill-creator/SKILL.md" ref="nofollow noopener noreferrer">claude code skill-creator</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JS-手写系列：new操作符]]></title>    <link>https://juejin.cn/post/7602940720689741870</link>    <guid>https://juejin.cn/post/7602940720689741870</guid>    <pubDate>2026-02-05T02:02:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602940720689741870" data-draft-id="7602901565025878025" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JS-手写系列：new操作符"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2026-02-05T02:02:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JS-手写系列：new操作符
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T02:02:41.000Z" title="Thu Feb 05 2026 02:02:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在 JavaScript 中，<code>new</code> 关键字就像是一个“工厂加工器”。虽然它看起来只是简单地创建了一个实例，但其背后涉及到了<strong>原型链接、上下文绑定以及返回值的特殊处理</strong>。掌握 <code>new</code> 的实现原理，是通往 JS 高级开发者的必经之路。</p>
<h2 data-id="heading-1">一、 new 操作符的 4 个核心步骤</h2>
<p>当我们执行 <code>new Constructor()</code> 时，JavaScript 引擎在后台完成了以下四件事：</p>
<ol>
<li><strong>开辟空间</strong>：创建一个全新的空对象。</li>
<li><strong>原型链接</strong>：将该对象的隐式原型（<code>__proto__</code>）指向构造函数的显式原型（<code>prototype</code>）。</li>
<li><strong>绑定 this</strong>：执行构造函数，并将其内部的 <code>this</code> 绑定到这个新对象上。</li>
<li><strong>返回结果</strong>：根据构造函数的返回值类型，决定最终返回的对象。</li>
</ol>
<hr/>
<h2 data-id="heading-2">二、 代码实现</h2>
<p>在实现中，我们不仅要处理常规逻辑，还要兼容构造函数可能返回<strong>引用类型</strong>的情况。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">  <span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">Constructor, ...args</span>) {
    <span class="hljs-comment">// 1. 创建一个空对象，并将其原型指向构造函数的 prototype</span>
      <span class="hljs-keyword">const</span> obj = {};
      obj.<span class="hljs-property">__proto__</span> = <span class="hljs-title class_">Constructor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
    <span class="hljs-comment">// 2. 执行构造函数，并将 this 绑定到新创建的对象上</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Constructor</span>.<span class="hljs-title function_">apply</span>(obj, args);

    <span class="hljs-comment">// 3. 处理返回值逻辑：如果构造函数显式返回了一个对象或函数，则返回该结果； 否则，返回我们创建的新对象 obj</span>
    <span class="hljs-keyword">const</span> isObject = <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'object'</span> &amp;&amp; result !== <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">const</span> isFunction = <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'function'</span>;

    <span class="hljs-keyword">return</span> (isObject || isFunction) ? result : obj;
  }

  <span class="hljs-comment">// 测试用例</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }

  <span class="hljs-keyword">const</span> per1 = <span class="hljs-keyword">new</span> (<span class="hljs-title class_">Person</span>)(<span class="hljs-string">'ouyange'</span>, <span class="hljs-number">23</span>);
  <span class="hljs-keyword">const</span> per2 = <span class="hljs-title function_">myNew</span>(<span class="hljs-title class_">Person</span>, <span class="hljs-string">'ouyange'</span>, <span class="hljs-number">23</span>);

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'原生 new 结果:'</span>, per1);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'手写 myNew 结果:'</span>, per2);
</code></pre>
<hr/>
<h2 data-id="heading-3">三、 细节解析</h2>
<h3 data-id="heading-4">1. 构造函数返回值的坑</h3>
<ul>
<li>
<p>如果构造函数 <code>return 123</code>（原始类型），<code>new</code> 会忽略它，依然返回实例对象。</p>
</li>
<li>
<p>如果构造函数 <code>return { a: 1 }</code>（对象类型），<code>new</code> 会丢弃原本生成的实例，转而返回这个对象。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Sentinel与Envoy限流：定位、实现与场景的深度对比]]></title>    <link>https://juejin.cn/post/7603004323870162987</link>    <guid>https://juejin.cn/post/7603004323870162987</guid>    <pubDate>2026-02-05T00:12:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603004323870162987" data-draft-id="7602816610932195391" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Sentinel与Envoy限流：定位、实现与场景的深度对比"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-05T00:12:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Sentinel与Envoy限流：定位、实现与场景的深度对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:12:05.000Z" title="Thu Feb 05 2026 00:12:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在分布式系统架构中，<strong>流量治理</strong>是保障服务稳定性、弹性的核心环节。Sentinel和Envoy作为云原生时代流量治理的明星工具，虽都具备限流能力，但在设计理念、技术实现、适用场景上存在显著差异。本文从核心定位、限流机制、生态集成等维度展开分析，帮助读者理解两者的本质区别。</p>
<h3 data-id="heading-0">一、核心定位：应用层 vs 基础设施层的流量治理</h3>
<h4 data-id="heading-1">Sentinel：聚焦应用层的稳定性“守护者”</h4>
<p>Sentinel 是阿里巴巴开源的<strong>应用层流量治理框架</strong>，核心以 <strong>“流量”为切入点</strong>，覆盖<strong>流量控制、熔断降级、系统负载保护</strong>三大维度，目标是解决微服务场景下的稳定性痛点（如雪崩、过载、热点请求洪峰）。</p>
<ul>
<li>技术属性：深度绑定应用进程（通过 Java SDK、Go SDK 等多语言支持），属于<strong>业务侧流量治理中间件</strong>，需嵌入业务代码（或通过字节码增强、框架集成）生效。</li>
<li>典型场景：电商秒杀接口的 QPS 限流、下游服务熔断（防止 DB 连接池打满拖垮自身）、系统负载过高时的自动降级（如订单服务 CPU 100% 时拒绝非核心请求）。</li>
</ul>
<h4 data-id="heading-2">Envoy：聚焦基础设施层的流量“调度员”</h4>
<p>Envoy 是云原生时代<strong>Service Mesh 架构的数据平面核心组件</strong>，定位为 <strong>“智能代理”</strong> ，主打<strong>全生命周期的流量管理</strong>（路由、负载均衡、限流、观测等），是微服务集群“流量高速公路”的管理者。</p>
<ul>
<li>技术属性：以 Sidecar 模式运行（与业务 Pod 共享网络命名空间），属于<strong>基础设施层流量治理工具</strong>，对业务代码透明（仅需在网格配置中声明流量规则）。</li>
<li>典型场景：多集群间东西向流量的全局 QPS 限制、灰度发布时的流量切分（部分流量到新版本服务）、南北向流量的 mTLS 加密+限流（保障入口网关安全）。</li>
</ul>
<h3 data-id="heading-3">二、限流实现：进程内细粒度 vs 网络层动态化</h3>
<p>限流能力的差异，本质是 <strong>“在哪里限流”和“怎么限流”</strong> 的区别。</p>
<h4 data-id="heading-4">1. 资源粒度：应用内细节 vs 集群级抽象</h4>
<ul>
<li>Sentinel：支持<strong>方法级、接口级甚至自定义资源</strong>的限流。例如：可对某 Java 方法 <code>OrderService.createOrder()</code>单独配置 QPS 限流规则，也能基于“用户 ID（热点参数）”做精细化流控（防止恶意刷单）。资源粒度渗透到业务逻辑层，适合对“单个服务内部环节”的精准管控。</li>
<li>Envoy：限流粒度偏向<strong>基础设施层抽象</strong>，如 HTTP 请求级、Upstream 集群级。例如：对 <code>product-service</code>这个 Upstream 集群整体配置每秒 1000 次请求的限制，或对 <code>/api/v1/users</code>路径的所有请求做限流。资源粒度对应“网络请求”或“服务集群”，更适合全局流量的宏观调控。</li>
</ul>
<h4 data-id="heading-5">2. 算法与规则：内置丰富性 vs 动态可扩展性</h4>
<ul>
<li>Sentinel 内置<strong>令牌桶、漏桶、滑动窗口、热点参数限流</strong>等算法，且提供<strong>规则动态推送</strong>（对接 Nacos/Apollo 等配置中心）。开发者可通过简单配置（如 <code>FlowRule</code>）快速实现“单机 QPS 不超过 500”“集群总 QPS 不超过 5000”等规则，甚至支持自定义流控算法（通过 SPI 扩展）。</li>
<li>Envoy 的限流依赖 <strong>HTTP Filter（如 <code>envoy.filters.http.local_ratelimit</code>）</strong> ​ 或 <strong>Redis 外置限流</strong>（分布式场景），算法以<strong>令牌桶</strong>为核心（通过 <code>rate_limit</code>策略配置填充速率、突发容量）。规则通过 xDS API（如 <code>envoy.config.route.v3.RouteConfiguration</code>）动态下发，适合大规模集群的集中式策略管理，但对“自定义复杂算法”的支持需依赖扩展 Filter。</li>
</ul>
<h4 data-id="heading-6">3. 生效层面：应用内拦截 vs 网络层代理</h4>
<ul>
<li>Sentinel 的限流逻辑<strong>在应用进程内执行</strong>：请求进入业务方法前，会先经过 Sentinel 的流量统计、规则判断，若触发限流则直接抛出 BlockException（或执行 fallback 逻辑）。这种“进程内拦截”对延迟影响极小，但需业务方显式引入 SDK。</li>
<li>Envoy 的限流逻辑<strong>在网络代理层执行</strong>：请求到达 Envoy Sidecar 后，由代理根据配置的路由规则匹配限流策略，再决定是否转发到后端服务。这种“透明代理”模式对业务无侵入，但会引入少量网络延迟（代理层处理开销）。</li>
</ul>
<h3 data-id="heading-7">三、生态与集成：垂直深耕 vs 云原生协同</h3>
<p>生态和集成方式决定了工具的落地成本与适用范围。</p>
<h4 data-id="heading-8">Sentinel：绑定微服务生态，深耕 Java 技术栈</h4>
<ul>
<li>生态绑定：深度集成 Spring Cloud Alibaba、Dubbo、gRPC 等国内主流微服务框架，甚至提供 Spring Boot Starter 简化接入。对于“已有微服务架构、需快速增强稳定性”的团队，Sentinel 是“即插即用”的选择。</li>
<li>多语言支持：除 Java 外，还推出 Go、C++、Python 等语言的 SDK，但在生态成熟度和社区活跃度上，Java 版本占绝对主导（适合以 Java 为核心技术栈的企业）。</li>
</ul>
<h4 data-id="heading-9">Envoy：锚定云原生，支撑 Service Mesh 全局治理</h4>
<ul>
<li>生态协同：作为 Service Mesh 的“标准数据平面”，Envoy 与 Istio（控制平面）深度整合，通过 xDS API 实现配置动态化、服务网格自动化。在 Kubernetes 集群中，Envoy 通常以 Sidecar 形式注入 Pod，成为“流量治理的事实标准”。</li>
<li>跨语言普惠：由于工作在网络层，Envoy 对业务语言无感知（无论后端是 Java、Go 还是 Python 服务，都能统一治理流量）。这种“基础设施层通用”特性，使其成为多语言微服务集群的流量治理首选。</li>
</ul>
<h3 data-id="heading-10">四、场景选择：何时选 Sentinel？何时选 Envoy？</h3>






























<table><thead><tr><th>场景维度</th><th>优先选 Sentinel</th><th>优先选 Envoy</th></tr></thead><tbody><tr><td>治理层级</td><td>应用内流量治理（如接口限流、方法级熔断）</td><td>集群/跨服务流量治理（如全局 QPS 限制）</td></tr><tr><td>技术栈</td><td>以 Java 为核心的微服务体系</td><td>多语言、Kubernetes + Service Mesh 架构</td></tr><tr><td>侵入性要求</td><td>可接受业务代码/框架集成 SDK</td><td>需“零侵入”，依赖网络代理透明治理</td></tr><tr><td>定制化方向</td><td>业务侧精细化流控（如热点参数、自定义规则）</td><td>基础设施侧全局策略（如集群级负载均衡）</td></tr></tbody></table>
<h3 data-id="heading-11">总结：工具互补，而非替代</h3>
<p>Sentinel 和 Envoy 并非“非此即彼”的竞争关系，而是<strong>流量治理体系的不同分层工具</strong>：</p>
<ul>
<li>Sentinel 主打 <strong>“应用内精细化稳定性保障”</strong> ，是业务研发团队守护服务质量的利器；</li>
<li>Envoy 主打 <strong>“基础设施层全局流量调度”</strong> ，是 SRE 团队管理大规模集群流量的基石。</li>
</ul>
<p>在实际架构中，两者常协同工作：例如，在 Service Mesh 架构下，Envoy 负责集群入口的全局限流，Sentinel 负责单个服务内部的细粒度熔断降级，共同构建“从网络到应用”的立体化流量治理体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[春哥的Agent通关秘籍05：工具调用 Function Calling【知识与思路篇】]]></title>    <link>https://juejin.cn/post/7602800677712019490</link>    <guid>https://juejin.cn/post/7602800677712019490</guid>    <pubDate>2026-02-05T00:14:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602800677712019490" data-draft-id="7602800677712003106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="春哥的Agent通关秘籍05：工具调用 Function Calling【知识与思路篇】"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-05T00:14:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="摸鱼的春哥"/> <meta itemprop="url" content="https://juejin.cn/user/1714893870865303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            春哥的Agent通关秘籍05：工具调用 Function Calling【知识与思路篇】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893870865303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    摸鱼的春哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:14:48.000Z" title="Thu Feb 05 2026 00:14:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><p>LLM 问世之后，很长一段时间，人们发现了很多用例可以证明：</p>
<blockquote>
<p>AI不行啊，不是人工智能，而是人工智障。</p>
</blockquote>
<p>比方说，最经典的一个问题就是：</p>
<pre><code class="hljs">7.11 和 7.9 哪个数字更大？
</code></pre>
<p><img src="https://pic.zhangshichun.top/pic/20260201161528631.png" alt="" loading="lazy"/></p>
<p>你也可以修改我们第一节课【春哥的Agent通关秘籍02：搭建环境及语言选择】里的 <code>check_env.py</code>代码，问AI："今天是几月几日？"</p>
<p><code>deepseek</code> 会自信地回答你：</p>
<p><img src="https://pic.zhangshichun.top/pic/20260201161737903.png" alt="" loading="lazy"/></p>
<p>早期的AI对于这样的用例毫无防备，闹了很多笑话。</p>
<p>但是，在Agent时代，这些根本不是问题，你可以稳定解决所有加减乘除，可以准确比较大小，可以知道今天是几月几日。</p>
<p>比如，无论你去deepseek官网，或者是豆包，提问"今天是几月几日？"</p>
<p>都能得到准确而正确的回答：</p>
<p><img src="https://pic.zhangshichun.top/pic/20260201161852635.png" alt="" loading="lazy"/></p>
<p>这是为什么？</p>
<p>因为官网和APP都利用了我们今天要学习的内容：Function Calling。</p>
<p><strong>工具调用</strong>。</p>
<h2 data-id="heading-0">一、Function Call的历史及现状</h2>
<p>为了解决早期大语言模型无法做精细活儿，无法应对准确计算和实时信息获取的问题。</p>
<p>2023年6月13日 ，<code>OPENAI</code> 在发布 gpt-4-0613 和 gpt-3.5-turbo-0613 版本时，推出了一项轰动世界的设计和能力：</p>
<p><strong>Function Calling</strong>。</p>
<h3 data-id="heading-1">发布这个功能之前</h3>
<p>开发者（包括早期的 LangChain 用户）想要让 AI 调用工具，必须使用 ReAct 模式。</p>
<p>做法：你在 System Prompt 里写一大段话：“你是一个可以使用工具的 AI。如果你想用计算器，请输出 Action: Calculator, Input: 1+1。”</p>
<p>痛点：</p>
<ul>
<li>
<p>不稳定：AI 经常忘了格式，或者多打了个标点符号。</p>
</li>
<li>
<p>解析难：开发者必须写复杂的正则表达式（Regex）去抓取 AI 的回复。</p>
</li>
<li>
<p>Token 浪费：你需要把工具的描述写在 Prompt 里，占用大量上下文。</p>
</li>
</ul>
<h3 data-id="heading-2">OpenAI的创新</h3>
<p>OpenAI 受Meta的Toolformer启发，通过微调（Fine-tuning），让模型在底层“原生”支持了调用外部工具的能力。</p>
<p>你不再需要在 Prompt 里求 AI “请按格式输出”。你只需要把 JSON Schema 传给 API，模型就能极度稳定地输出结构化的 JSON 调用指令。</p>
<p>可以说：<strong>Function Calling 是 OpenAI 将“学术界的 Tool Learning”转化为“工业级 API 标准”的产物。</strong></p>
<p>它标志着 AI Agent 开发从“手搓 Prompt 的黑客时代”进入了“标准化工程开发时代”。现在，Anthropic (Claude)、Google (Gemini)、DeepSeek 等主流模型厂商都跟随并支持了这一标准。</p>
<h2 data-id="heading-3">二、Function Calling 基本流程</h2>
<p>我画了一张图，给大家解释当用户输入“北京今天天气如何”之后，整个的架构流转：</p>
<p><img src="https://pic.zhangshichun.top/pic/20260201203345449.png" alt="" loading="lazy"/></p>
<p>你会发现一个重要的定律：</p>
<pre><code class="hljs language-sql" lang="sql">LLM 对于 Agent 而言，其实是无状态的。

当Agent朝LLM发起会话时，需要每次都携带历史记录，以完成多轮会话。

每次都需要携带注册到agent中的<span class="hljs-keyword">function</span>列表，每次都需要写代<span class="hljs-keyword">system</span> prompt。
</code></pre>
<p><img src="https://pic.zhangshichun.top/pic/20260201204006127.png" alt="" loading="lazy"/></p>
<blockquote>
<p>你可以把它想象成电影《初恋50次》里的女主角，或者是一条只有 7 秒记忆的金鱼。 无论你们之前聊得多么热火朝天，当你发起的 HTTP 请求结束那一刻，它就把你彻底忘了。</p>
</blockquote>
<p>因此，这带来了三个很大的负担问题：</p>
<ol>
<li>人设负担
<ul>
<li>每次会话都要重新声明一次人设，不然LLM就会不知道该信息。</li>
</ul>
</li>
<li>技能树负担
<ul>
<li>每次会话都要重新声明一次所有Agent拥有的全技能Json Schema，这会占用巨大的Token。</li>
</ul>
</li>
<li>记忆负担
<ul>
<li>随着对话进行，messages 列表会越来越长。</li>
</ul>
</li>
</ol>
<p>这会导致以下几个问题：</p>
<ul>
<li>费钱：LLM 是按 Input Token 收费的。第 1 句的历史，在第 100 轮对话时被重复计费了 100 次。</li>
<li>变慢：处理的文字越多，首字延迟（TTFT）越高。</li>
<li>溢出：一旦超过模型的上下文上限（比如 32k 或 128k），模型就会报错或强制截断，导致“失忆”。</li>
<li>变蠢：一旦token过长，LLM在巨大的token里关于会话里的关键信息的注意力会被稀释。</li>
</ul>
<p>如何解决这个问题，是所有Agent开发必须面对的。这里不过多展开了，先提一下。</p>
<p><img src="https://pic.zhangshichun.top/pic/20260202181054274.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">三、工具定义与注册</h2>
<p>在让AI知道应该在何时调用工具的第一步，相当于你需要在每次会话里附带一个目录，告诉AI：</p>
<blockquote>
<p>嗨，牢A，我这里有一个名叫<code>get_current_time</code>的工具，它是个方法，作用是“获取当前准确的时间”。</p>
</blockquote>
<p>这样，当没有记忆的LLM面对“当前准确时间是什么”的时候，它才会知道要调用这个工具。</p>
<p>很巧，上节课我们才介绍了 JSON Schema，这节课的 <code>Function Calling</code> 注册工具，也需要用到JSON Schema。</p>
<p>但它不是完全标准的 JSON Schema，你可以先看看结构：</p>
<pre><code class="hljs language-python" lang="python">tools = [
    {
        <span class="hljs-comment"># 1. 类型：目前仅支持 "function"</span>
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
        <span class="hljs-comment"># 2. 函数定义主体</span>
        <span class="hljs-string">"function"</span>: {
            <span class="hljs-comment"># 2.1 (必填) 函数名</span>
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"..."</span>,
            <span class="hljs-comment"># 2.2 (强烈推荐) 给 AI 看的函数说明书</span>
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"..."</span>,
            <span class="hljs-comment"># 2.3 (必填) 参数定义，遵循 JSON Schema 标准</span>
            <span class="hljs-string">"parameters"</span>: {        
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: { ... },
                <span class="hljs-string">"required"</span>: [...]
            },
            <span class="hljs-comment"># (可选) DeepSeek/OpenAI 支持的严格模式，设为 True 强制输出符合 Schema</span>
            <span class="hljs-string">"strict"</span>: <span class="hljs-literal">True</span> 
        }
    }
]
</code></pre>
<p>如果想找官方文档的话，国内开发者优先建议参考 <code>deepseek</code> 的 <code>Function Calling</code> 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi-docs.deepseek.com%2Fzh-cn%2Fguides%2Ffunction_calling" target="_blank" title="https://api-docs.deepseek.com/zh-cn/guides/function_calling" ref="nofollow noopener noreferrer">api-docs.deepseek.com/zh-cn/guide…</a></p>
<p>其中提到：</p>
<blockquote>
<p>用户需要设置 base_url="<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.deepseek.com%2Fbeta" target="_blank" title="https://api.deepseek.com/beta" ref="nofollow noopener noreferrer">api.deepseek.com/beta</a>" 来开启 Beta 功能</p>
</blockquote>
<p>嗯，看到这里，我们可以默默地去修改一下我们 <code>.env</code> 文件的 BASE_URL 参数，以求获得更稳定的返回结构。</p>
<p>另外还可以参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fguides%2Ffunction-calling" target="_blank" title="https://platform.openai.com/docs/guides/function-calling" ref="nofollow noopener noreferrer">platform.openai.com/docs/guides…</a></p>
<p>让我们根据上面学到的，随手注册两个工具方法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 定义工具列表 </span>
tools = [
    <span class="hljs-comment"># 方法A：获取当前精准时间</span>
    {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
        <span class="hljs-string">"function"</span>: {
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"get_current_time"</span>,
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"获取当前精确时间"</span>,
            <span class="hljs-string">"parameters"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>, <span class="hljs-string">"properties"</span>: {}}
        }
    },
    <span class="hljs-comment"># 方法B：计算两个数的乘积</span>
    {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
        <span class="hljs-string">"function"</span>: {
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"calculate_multiply"</span>,
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"计算两个数的乘积"</span>,
            <span class="hljs-string">"parameters"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: {
                    <span class="hljs-string">"a"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"number"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"第一个数字"</span>},
                    <span class="hljs-string">"b"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"number"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"第二个数字"</span>}
                },
                <span class="hljs-string">"required"</span>: [<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>]
            }
        }
    }
]
</code></pre>
<p>有了 <code>Schema</code>，如何添加到会话里去呢？</p>
<p>非常简单！</p>
<pre><code class="hljs language-python" lang="python">response = client.chat.completions.create(
    model=<span class="hljs-string">"deepseek-chat"</span>,
    messages=messages,
    tools=tools, <span class="hljs-comment"># 【关键】把工具箱递给它</span>
)
</code></pre>
<h2 data-id="heading-5">四、识别AI的返回，调用具体的方法</h2>
<p>刚刚我们在请求里附带了tools清单。</p>
<p>那么，怎么识别AI在什么时候需要调用我们的tools呢?</p>
<p>很简单：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 获取 AI 的回复消息</span>
ai_msg = response.choices[<span class="hljs-number">0</span>].message
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"ai_msg.tool_calls：<span class="hljs-subst">{ai_msg.tool_calls}</span>"</span>)
</code></pre>
<p>在ai_msg这个LLM 返回值信息里，我们需要重点关注 <code>ai_msg.tool_calls</code> 这个字段。</p>
<p>如果它是None或者空数组，则表示AI没有想要调用的<code>Function</code>，否则的话，即代表：</p>
<blockquote>
<p>刚才这一次会话，AI没有得到结论，而是希望调用一个或者多个Function。</p>
</blockquote>
<p>所以，我们可以先写出如下的大致逻辑：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> ai_msg.tool_calls:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🤖 AI 决定调用工具！"</span>)
    
    <span class="hljs-comment"># 必须把 AI 的这句“我想调用工具”加入对话历史</span>
    <span class="hljs-comment"># 否则后面通过工具结果回复时，AI 会失忆</span>
    messages.append(ai_msg)

    <span class="hljs-comment"># === 你的代码介入：执行工具 ===</span>
    <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> ai_msg.tool_calls:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🤖 AI 决定调用工具: <span class="hljs-subst">{tool_call.function.name}</span>"</span>)
        func_name = tool_call.function.name
        <span class="hljs-comment"># 解析参数 (JSON 字符串 -&gt; 字典)</span>
        func_args = json.loads(tool_call.function.arguments)
<span class="hljs-keyword">else</span>:
    <span class="hljs-comment"># AI 觉得不需要工具，直接回答</span>
    <span class="hljs-keyword">return</span> ai_msg.content
</code></pre>
<p>拿到方法名与方法参数后，接下来要做的就是执行方法，得到结果，这一点连刚接触编程的新手都知道怎么写了。</p>
<p>拿到结果后，只需要再次执行：</p>
<pre><code class="hljs language-ini" lang="ini">messages.append({
    "role": "tool",
    "tool_call_id": tool_call.id,
    "content": tool_result
})
<span class="hljs-comment"># === 第二轮交互 ===</span>
<span class="hljs-attr">final_response</span> = client.chat.completions.create(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"deepseek-chat"</span>,
    <span class="hljs-attr">messages</span>=messages,
    <span class="hljs-attr">tools</span>=tools
)
</code></pre>
<p>为什么这里的第二轮交互里还要带上 <code>tools</code>？</p>
<p>因为Agent并不知道LLM是否会再发起一次Function Calling，如果不携带tools，LLM就非常可能在遇到问题时无奈地瞎编或者报错。</p>
<p>所以，很显然，我们需要递归，或者循环。</p>
<p>这就涉及到了一个新的，深刻的，重要的，难以规避的核心问题：</p>
<blockquote>
<p>在Agent开发中，应该如何统一AI的思考与行动，并巧妙设计这个循环。</p>
</blockquote>
<p>下一节课再见！</p>
<h2 data-id="heading-6">下一步预告</h2>
<p>下节课，我们将探索 Agent 编程的一个核心问题：</p>
<blockquote>
<p>思考范式。</p>
</blockquote>
<p>敬请期待！</p>
<p><img src="https://pic.zhangshichun.top/pic/ScreenShot_2026-01-26_082327_821.png" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用AI模拟实现一个 Claude Code CLI]]></title>    <link>https://juejin.cn/post/7603004323870179371</link>    <guid>https://juejin.cn/post/7603004323870179371</guid>    <pubDate>2026-02-05T00:35:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603004323870179371" data-draft-id="7602910573404209190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用AI模拟实现一个 Claude Code CLI"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-05T00:35:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用AI模拟实现一个 Claude Code CLI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:35:01.000Z" title="Thu Feb 05 2026 00:35:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>从零开始构建终端 AI 编程助手，探索 REPL 交互、输入缓冲区、终端渲染等技术</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p><strong>重要说明：</strong> 本项目的代码完全由 AI 辅助生成。我扮演产品经理的角色，负责提出需求、明确功能边界，而 AI 负责所有的编码实现。这是一次探索"AI 主导开发"模式的实践。</p>
<p>用过 Claude Code 的开发者都会被它流畅的终端交互体验所吸引。一个简单但功能强大的命令行工具，让 AI 像结对编程伙伴一样在终端中与你协作。</p>
<p>晚上使用AI过程突然心血来潮：能否用 AI 来实现一个类似的工具，顺便了解下这种终端工具是如何实现的 ？说干就干——我只负责描述想要的功能，让 AI 来完成所有的代码编写。</p>
<p>先看看最终实现的效果：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─ CodeCLI v0.1.0 ───────────────────────────────────────────┐
│ Welcome back!                                              │
│                                                            │
│   <span class="hljs-strong">____</span>          _                                         │
│  / <span class="hljs-strong">__<span class="hljs-emphasis">_| _</span>__</span>  <span class="hljs-strong">__| | __</span>_                                    │
│ | |    / _ \/ <span class="hljs-emphasis">_` |/ _</span> \                                   │
│ | |<span class="hljs-strong">__<span class="hljs-emphasis">_|  _</span><span class="hljs-emphasis">_/ (_</span>| |  __</span>/                                   │
│  \<span class="hljs-strong">____</span>|\<span class="hljs-strong">__<span class="hljs-emphasis">_|\_</span><span class="hljs-emphasis">_,_</span>|\__</span><span class="hljs-emphasis">_|                                   │
│                                                            │
│ Project: my-project                                        │
│ Model: Opus                                                │
└────────────────────────────────────────────────────────────┘
──────────────────────────────────────────────────────────────
› _</span>
──────────────────────────────────────────────────────────────
accept edits off (shift+tab to cycle)
</code></pre>
<p>核心功能包括：</p>
<ul>
<li>流畅的多行输入编辑</li>
<li>历史命令搜索</li>
<li>斜杠命令系统</li>
<li>终端内的 Shell 执行</li>
</ul>
<h2 data-id="heading-1">核心架构</h2>
<p>项目只有两个核心文件：</p>
<pre><code class="hljs language-bash" lang="bash">src/
├── index.ts    <span class="hljs-comment"># 入口，处理命令行参数</span>
└── repl.ts     <span class="hljs-comment"># REPL引擎，约1200行</span>
</code></pre>
<p>虽然 <code>repl.ts</code> 代码量不小，但结构非常清晰，可以拆分为几个独立的模块：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────┐
│                    CodeCli                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │ InputBuffer │  │  Renderer   │  │  CommandSet │ │
│  │  (输入状态)  │  │  (终端渲染)  │  │  (命令处理)  │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │  History    │  │KillRing     │  │   Message   │ │
│  │  (历史管理)  │  │(复制粘贴)    │  │  (消息队列)  │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────┘
</code></pre>
<h2 data-id="heading-2">功能介绍</h2>
<h5 data-id="heading-3">一、输入缓冲区：处理多行编辑</h5>
<p>最基础也最关键的是输入缓冲区。它需要维护两个核心状态：文本内容和光标位置。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">InputBuffer</span> {
  value = <span class="hljs-string">""</span>;      <span class="hljs-comment">// 当前文本</span>
  cursor = <span class="hljs-number">0</span>;      <span class="hljs-comment">// 光标位置</span>

  <span class="hljs-title function_">insert</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-comment">// 在光标处插入文本，更新光标</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">cursor</span>) + text + <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cursor</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cursor</span> += text.<span class="hljs-property">length</span>;
  }

  <span class="hljs-title function_">moveWordLeft</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 跳到前一个单词开头</span>
    <span class="hljs-keyword">let</span> i = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cursor</span> - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">while</span> (i &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isWhitespace</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>[i])) i--;
    <span class="hljs-keyword">while</span> (i &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isWordChar</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>[i - <span class="hljs-number">1</span>])) i--;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cursor</span> = i;
  }
}
</code></pre>
<p><strong>设计要点：</strong></p>
<p><strong>1. 光标位置独立跟踪</strong> - 不依赖终端的实际光标，只维护逻辑位置</p>
<p><strong>2. 多行支持</strong> - 内部用 <code>\n</code> 分割，渲染时转换为行列坐标</p>
<p><strong>3. 词操作</strong> - 类似 Emacs，按单词边界移动（Alt+B/F）</p>
<p>这个设计的巧妙之处在于：输入逻辑与渲染逻辑完全解耦。无论终端怎么变化，InputBuffer 只负责维护正确的文本状态。</p>
<h5 data-id="heading-4">二、终端渲染：ANSI 转义序列</h5>
<p>终端渲染的核心是使用 ANSI 转义序列控制屏幕：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">lines</span>: <span class="hljs-built_in">string</span>[] = [];

  <span class="hljs-comment">// 1. 构建所有行的内容</span>
  lines.<span class="hljs-title function_">push</span>(header);
  lines.<span class="hljs-title function_">push</span>(...messages);
  lines.<span class="hljs-title function_">push</span>(inputArea);
  lines.<span class="hljs-title function_">push</span>(modeLine);

  <span class="hljs-comment">// 2. 清屏并输出</span>
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">"\x1b[2J\x1b[H"</span>);  <span class="hljs-comment">// 清屏，光标归位</span>
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(lines.<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>));

  <span class="hljs-comment">// 3. 定位光标</span>
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">`\x1b[<span class="hljs-subst">${row}</span>;<span class="hljs-subst">${col}</span>H`</span>);
}
</code></pre>
<p><strong>常用 ANSI 序列：</strong></p>





























<table><thead><tr><th>序列</th><th>作用</th></tr></thead><tbody><tr><td><code>\x1b[2J</code></td><td>清屏</td></tr><tr><td><code>\x1b[H</code></td><td>光标移到左上角</td></tr><tr><td><code>\x1b[row;colH</code></td><td>移动光标到指定位置</td></tr><tr><td><code>\x1b[?25h</code></td><td>显示光标</td></tr><tr><td><code>\x1b[35m</code></td><td>设置颜色（紫色）</td></tr></tbody></table>
<p>渲染策略采用"全屏刷新"：每次状态变化都重新计算并绘制所有内容。这在现代终端上性能足够好，且代码简洁。</p>
<h5 data-id="heading-5">三、键盘事件：原始模式处理</h5>
<p>Node.js 默认使用" cooked mode"，需要回车才发送输入。我们需要切换到"raw mode"来捕获每个按键：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
  readline.<span class="hljs-title function_">emitKeypressEvents</span>(process.<span class="hljs-property">stdin</span>);
  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">stdin</span>.<span class="hljs-property">isTTY</span>) process.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">setRawMode</span>(<span class="hljs-literal">true</span>);
  process.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">"keypress"</span>, <span class="hljs-function">(<span class="hljs-params">str, key</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onKeypress</span>(str, key));
}

<span class="hljs-keyword">private</span> <span class="hljs-title function_">onKeypress</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span>, key: readline.Key</span>) {
  <span class="hljs-keyword">if</span> (key.<span class="hljs-property">ctrl</span> &amp;&amp; key.<span class="hljs-property">name</span> === <span class="hljs-string">"c"</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">input</span>.<span class="hljs-title function_">setValue</span>(<span class="hljs-string">""</span>);  <span class="hljs-comment">// Ctrl+C 清空</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key.<span class="hljs-property">ctrl</span> &amp;&amp; key.<span class="hljs-property">name</span> === <span class="hljs-string">"r"</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startReverseSearch</span>();  <span class="hljs-comment">// Ctrl+R 历史搜索</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (str &amp;&amp; !key.<span class="hljs-property">ctrl</span> &amp;&amp; !key.<span class="hljs-property">meta</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">input</span>.<span class="hljs-title function_">insert</span>(str);  <span class="hljs-comment">// 普通字符</span>
  }
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();  <span class="hljs-comment">// 每次按键后重绘</span>
}
</code></pre>
<p><strong>事件处理的难点：</strong></p>
<p><strong>组合键识别</strong> - Ctrl/Alt/Shift 需要检查 <code>key.ctrl</code>、<code>key.meta</code> 等标志</p>
<p><strong>特殊键处理</strong> - 方向键、Home/End 等不会产生可打印字符</p>
<p><strong>双击 ESC</strong> - 检测两次 ESC 的间隔来判断 rewind 命令</p>
<h5 data-id="heading-6">四、历史搜索：仿 Emacs 的 Ctrl+R</h5>
<p>历史搜索是提升效率的关键功能。实现思路：</p>
<pre><code class="hljs">┌─────────────────────────────────────────────────────────┐
│  用户输入搜索字符串                                      │
│         ↓                                                │
│  从历史末尾向前遍历查找匹配                              │
│         ↓                                                │
│  实时更新显示的匹配结果                                  │
│         ↓                                                │
│  用户可以继续输入缩小搜索，或 Ctrl+R 查看上一个匹配      │
└─────────────────────────────────────────────────────────┘
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">findHistoryMatch</span>(<span class="hljs-attr">query</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">startIndex</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">if</span> (!query) <span class="hljs-keyword">return</span> startIndex;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = startIndex; i &gt;= <span class="hljs-number">0</span>; i--) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>[i].<span class="hljs-title function_">includes</span>(query)) <span class="hljs-keyword">return</span> i;
  }
  <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
}
</code></pre>
<p>搜索是交互式的：每输入一个字符就重新搜索，实时显示匹配结果。</p>
<h5 data-id="heading-7">五、杀环：Emacs 风格的复制粘贴</h5>
<p>"杀环"（Kill Ring）是 Emacs 的概念，比系统剪贴板更强大：</p>
<pre><code class="hljs">操作          效果
─────────────────────────────
Ctrl+K        删除到行尾，存入杀环
Ctrl+U        删除整行，存入杀环
Ctrl+Y        粘贴最新剪切内容
Alt+Y         循环切换剪贴历史
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-attr">killRing</span>: <span class="hljs-built_in">string</span>[] = [];

<span class="hljs-keyword">private</span> <span class="hljs-title function_">pushKillRing</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">killRing</span>.<span class="hljs-title function_">push</span>(text);  <span class="hljs-comment">// 记录每次删除</span>
}

<span class="hljs-keyword">private</span> <span class="hljs-title function_">yank</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> text = <span class="hljs-variable language_">this</span>.<span class="hljs-property">killRing</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">killRing</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">input</span>.<span class="hljs-title function_">insert</span>(text);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastYankIndex</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">killRing</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">private</span> <span class="hljs-title function_">yankCycle</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// Alt+Y：粘贴后循环切换之前剪切的内容</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastYankIndex</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastYankIndex</span> &lt;= <span class="hljs-number">0</span>
    ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">killRing</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
    : <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastYankIndex</span> - <span class="hljs-number">1</span>;
  <span class="hljs-comment">// 替换刚才粘贴的内容...</span>
}
</code></pre>
<p>这个设计让多次剪切的内容都能被访问，比单一剪贴板灵活得多。</p>
<h5 data-id="heading-8">六、命令系统：斜杠前缀</h5>
<p>命令以 <code>/</code> 开头，类似 Discord/Slash 命令：</p>
<pre><code class="hljs language-bash" lang="bash">/help      显示帮助
/clear     清空对话
/plan      切换到计划模式
/model     切换AI模型
</code></pre>
<p>实现核心是一个简单的路由器：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleCommand</span>(<span class="hljs-params">input: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> parts = input.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/\s+/</span>);
  <span class="hljs-keyword">const</span> cmd = parts[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">const</span> args = parts.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);

  <span class="hljs-keyword">switch</span> (cmd) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"help"</span>: <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showHelp</span>();
    <span class="hljs-keyword">case</span> <span class="hljs-string">"clear"</span>: <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clearAll</span>();
    <span class="hljs-keyword">case</span> <span class="hljs-string">"plan"</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">mode</span> = <span class="hljs-string">"plan"</span>; <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"model"</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setModel</span>(args[<span class="hljs-number">0</span>]); <span class="hljs-keyword">break</span>;
  }
}
</code></pre>
<p><strong>命令补全：</strong> 当用户输入 <code>/</code> 时，实时显示匹配的命令列表，提升发现性。</p>
<h5 data-id="heading-9">七、Shell 模式：感叹号前缀</h5>
<p>用 <code>!</code> 前缀可以直接执行 shell 命令：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用户输入：! git status</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">runShell</span>(<span class="hljs-params">command: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> child = <span class="hljs-title function_">spawn</span>(<span class="hljs-string">"powershell.exe"</span>, [<span class="hljs-string">"-Command"</span>, command]);
  <span class="hljs-keyword">let</span> output = <span class="hljs-string">""</span>;
  child.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">"data"</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> output += data);
  child.<span class="hljs-title function_">on</span>(<span class="hljs-string">"close"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">appendMessage</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-attr">content</span>: output });
  });
}
</code></pre>
<p>这让你在 AI 对话中无缝执行系统命令，结果直接显示在对话中。</p>
<h2 data-id="heading-10">写在最后</h2>
<p>本文介绍了一个简化版的 Claude Code CLI 的关键功能及相关实现代码。虽然这是一个 MVP 实现，但展示了终端应用开发的核心技术，这些技术可应用于任何需要复杂终端交互的项目。</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/yuboon</span><span class="hljs-regexp">/ai-examples/tree</span><span class="hljs-regexp">/main/</span><span class="hljs-number">001</span>-coding-cli
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[10万数据点可视化：Echarts性能优化实战]]></title>    <link>https://juejin.cn/post/7602834985902145586</link>    <guid>https://juejin.cn/post/7602834985902145586</guid>    <pubDate>2026-02-05T00:37:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602834985902145586" data-draft-id="7602910573404553254" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="10万数据点可视化：Echarts性能优化实战"/> <meta itemprop="keywords" content="ECharts,性能优化"/> <meta itemprop="datePublished" content="2026-02-05T00:37:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="谢小飞"/> <meta itemprop="url" content="https://juejin.cn/user/2717648473034823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            10万数据点可视化：Echarts性能优化实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648473034823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    谢小飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:37:54.000Z" title="Thu Feb 05 2026 00:37:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><p>　　最近在工作中遇到了一个颇具挑战的需求，需要在Web页面上通过Echarts图表渲染超过10万条点位数据。对于前端开发来说，大数据量的可视化渲染一直是个棘手的问题，尤其是当数据量达到10万级别时，不仅浏览器请求响应速度变慢，浏览器的渲染性能瓶颈会变得非常明显；因此，本文我们就看下如果在工作中遇到这种场景，应该如何处理。</p>
<p>　　首先介绍一下实际的场景，我们团队最近接到一个物联网设备数据分析需求：业务方需要查看特定设备一段时间范围内的运行状态趋势。这看起来似乎是个简单的折线图需求，但当我们深入了解数据规模时，发现了巨大的挑战。</p>
<p>　　首先是业务方要求不限制时间范围，例如可以跨数年的范围，从2021年到2025年；这对我们前后端来说，意味着查询和渲染数据量会非常庞大，因为设备采集一般都是按照固定的时间频率采集的；比如如果设备每隔15分钟就会采集发送一次数据，一天的数据量就是24小时 × (60分钟/15分钟) = 96个数据点/天，如果查询4年的数据就是4年* 365天* 96个数据点 = 14余万条数据。</p>
<p>　　业务人员给我们的需求很明确："我们需要在这张图上看到四年的完整趋势，能够快速发现异常波动，并且可以随意缩放查看任意时间段的细节"。他们补充道："之前试过按天聚合的数据，但那样会丢失很多重要信息。比如设备在某个具体时间点的瞬时异常，在日度数据中就看不出来了。"</p>
<p>　　我们最初的尝试非常直接，一次性加载所有的数据，然后通过Echarts渲染。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9f9c7295154459fa6306939e5b45d0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856674&amp;x-signature=7dN38vp3w2aDzjwTpSYRaEZujqw%3D" alt="一次性加载" loading="lazy"/></p>
<p>　　但是请求接口的时间就达到了14秒，数据响应时浏览器内存占用激增，非常容易崩溃卡死，完全没有用户体验可言。</p>
<h2 data-id="heading-0">数据分割：化整为零的策略</h2>
<p>　　于是，根据业务需求，我们首先尝试数据分割，将数据按天维度进行分割，然后分别请求数据；下面是分割的核心函数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> dayjs <span class="hljs-keyword">from</span> <span class="hljs-string">"dayjs"</span>;
<span class="hljs-comment">/**
 * 按指定天数分割日期区间
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} startDate 开始日期
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} endDate 结束日期
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} num 分割天数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">separateDate</span>(<span class="hljs-params">startDate, endDate, num = <span class="hljs-number">180</span></span>) {
  <span class="hljs-comment">// 使用dayjs.js创建日期对象</span>
  <span class="hljs-keyword">const</span> start = <span class="hljs-title function_">dayjs</span>(startDate);
  <span class="hljs-keyword">const</span> end = <span class="hljs-title function_">dayjs</span>(endDate);

  <span class="hljs-comment">// 验证日期有效性</span>
  <span class="hljs-keyword">if</span> (!start.<span class="hljs-title function_">isValid</span>() || !end.<span class="hljs-title function_">isValid</span>()) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'无效的日期格式'</span>);
  }

  <span class="hljs-comment">// 确保开始日期早于或等于结束日期</span>
  <span class="hljs-keyword">if</span> (start.<span class="hljs-title function_">isAfter</span>(end)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'开始日期不能晚于结束日期'</span>);
  }

  <span class="hljs-comment">// 计算总天数</span>
  <span class="hljs-keyword">const</span> totalDays = end.<span class="hljs-title function_">diff</span>(start, <span class="hljs-string">'days'</span>);

  <span class="hljs-comment">// 如果总天数小于等于最大分割天数，直接返回一个区间</span>
  <span class="hljs-keyword">if</span> (totalDays &lt;= num) {
    <span class="hljs-keyword">return</span> [
      {
        <span class="hljs-attr">segmentStartDate</span>: start.<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD'</span>),
        <span class="hljs-attr">segmentEndDate</span>: end.<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD'</span>),
        <span class="hljs-attr">segmentStartDay</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">segmentEndDay</span>: totalDays,
      },
    ];
  }
}
</code></pre>
<p>　　在处理时，我们会先校验参数格式并计算总天数，若总天数未超过最大分割天数，则将直接返回该日期区间，不再进行分割处理。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">separateDate</span>(<span class="hljs-params">startDate, endDate, num = <span class="hljs-number">180</span></span>) {
  <span class="hljs-comment">// 省略其他代码...</span>

  <span class="hljs-comment">// 计算需要分割的区间数量</span>
  <span class="hljs-keyword">const</span> numIntervals = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(totalDays / num);

  <span class="hljs-keyword">const</span> result = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; numIntervals; i++) {
    <span class="hljs-comment">// 计算当前区间的开始日期</span>
    <span class="hljs-keyword">const</span> iStart = start.<span class="hljs-title function_">clone</span>().<span class="hljs-title function_">add</span>(i * num, <span class="hljs-string">'days'</span>);

    <span class="hljs-comment">// 计算当前区间的结束日期（最后一个区间使用实际结束日期）</span>
    <span class="hljs-keyword">const</span> iEnd = i === numIntervals - <span class="hljs-number">1</span> ? end : start.<span class="hljs-title function_">clone</span>().<span class="hljs-title function_">add</span>((i + <span class="hljs-number">1</span>) * num - <span class="hljs-number">1</span>, <span class="hljs-string">'days'</span>);

    <span class="hljs-comment">// 确保结束日期不超过实际结束日期</span>
    <span class="hljs-keyword">const</span> actualEnd = iEnd.<span class="hljs-title function_">isAfter</span>(end) ? end : iEnd;

    <span class="hljs-comment">// 计算相对于开始日期的天数</span>
    <span class="hljs-keyword">const</span> segmentStartDay = iStart.<span class="hljs-title function_">diff</span>(start, <span class="hljs-string">'days'</span>);
    <span class="hljs-keyword">const</span> segmentEndDay = actualEnd.<span class="hljs-title function_">diff</span>(start, <span class="hljs-string">'days'</span>);

    result.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">segmentStartDate</span>: iStart.<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD'</span>),
      <span class="hljs-attr">segmentEndDate</span>: actualEnd.<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD'</span>),
      segmentStartDay,
      segmentEndDay,
    });
  }

  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>　　然后通过<code>Math.ceil</code>将数字向上舍入到最接近的整数，得到numIntervals，也就是我们区间的数量。此外在separateDate返回的数据每个分片中，包含了segmentStartDay和segmentEndDay，对应了时间区间的开始和结束的天数，方便后续的数据合并处理。</p>
<p>　　这里<code>separateDate函数</code>是我们整个优化方案的核心基础，它将长时间跨度的数据请求分解为多个可管理的子请求；startDate和endDate接收日历📅组件传入的用户选择的开始和结束日期；num参数默认设置为180天，这个值基于我们后端响应效率和速度的最优分段时长，如果单个时间跨度太长，则达不到分段的效果，而如果太短，则分段数量过多，请求次数太频繁。</p>
<p>　　正是基于separateDate函数分割出的这些独立、合规的日期区间，我们后续的所有优化操作才得以展开；接下来，每一个子区间的数据会进行独立的处理和加载，从而将原本庞大而笨重的单次请求，转化为一次次高效、可管理的并行任务流。</p>
<h2 data-id="heading-1">WebWorker：开辟“第二战线”</h2>
<p>　　在上一节，我们实现了数据的分割，成功将14万+的数据请求分解为多个小请求；但是即使数据分片了，每一分片数据量仍然可能很大（最多180天×96个点/天=17280个点）；如果直接在主线程中处理这些数据，仍然会导致UI卡顿。这时候，Web Worker就派上用场了。</p>
<p>　　<code>Web Worker</code>是HTML5提供的API，允许在浏览器后台运行JavaScript脚本，与主线程并行执行。这意味着我们可以在Worker线程中执行繁重的数据处理任务，而不会阻塞用户界面；如果说主线程是“前台服务员”，既要响应客人（用户）的点击，又要去后厨炒菜（计算），那么Web Worker就是雇来的“专职后厨”；它有以下几个特点：</p>
<ul>
<li>独立线程：运行在独立的线程中，与主线程并行</li>
<li>无DOM访问权限：不能直接操作DOM或访问window对象</li>
<li>通过消息通信：与主线程通过postMessage和onmessage通信</li>
<li>生命周期独立：关闭标签页或Worker脚本执行完毕才会终止</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9ad8b7a99db4ff5999640a54f77f306~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856674&amp;x-signature=o9WAa3hD7Z2zGa3FtCCq%2FeAri4Q%3D" alt="WebWorker" loading="lazy"/></p>
<p>　　首先，我们需要创建一个专门处理数据的Worker文件<code>data-processor.worker.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript">self.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
  <span class="hljs-keyword">var</span> list = e.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>;

  <span class="hljs-keyword">const</span> listHandled = list.<span class="hljs-property">value</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> {
    <span class="hljs-comment">// 对数据进行一系列耗时计算</span>
  });

  self.<span class="hljs-title function_">postMessage</span>({
    <span class="hljs-attr">list</span>: listHandled,
  });
};
</code></pre>
<p>　　这里我们定义了一个专用Worker线程，负责执行所有阻塞型的计算任务，负责对数据进行一些耗时的处理，例如原始数据清洗、复杂指标计算等等，并返回处理后的数据；主线程则专注于UI交互与流畅渲染，仅在需要时（分割数据返回）向Worker派发任务并异步接收其返回的、可直接用于图表（如ECharts）的轻量化结果。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadEchartData</span>(<span class="hljs-params">rangeItem</span>) {
  <span class="hljs-keyword">const</span> { segmentStartDate, segmentEndDate } = rangeItem;
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchListData</span>({
    <span class="hljs-attr">startDate</span>: segmentStartDate,
    <span class="hljs-attr">endDate</span>: segmentEndDate,
  });
  <span class="hljs-keyword">if</span> (res &amp;&amp; res.<span class="hljs-property">data</span>) {
    <span class="hljs-keyword">const</span> { list } = res.<span class="hljs-property">data</span>;

    <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">"/data-processor.worker.js"</span>);
    worker.<span class="hljs-title function_">postMessage</span>({
      <span class="hljs-attr">data</span>: list,
    });
    worker.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
      <span class="hljs-keyword">const</span> { list } = e.<span class="hljs-property">data</span>;
      <span class="hljs-title function_">renderChart</span>(list);
    };
  }
}
</code></pre>
<p>　　我们将前面分割好的数据区间，分发为并发的数据请求进行加载。待数据返回后，主线程会实例化一个Worker线程，并通过postMessage函数，将原始数据调度至Worker进行后续处理。</p>
<p>　　这里还涉及一个数据返回后拼接的问题，我们在循环调用loadEchartData请求数据时，由于是异步返回，分片数据返回的时候，数据会乱序返回，因此不能直接通过数组的push来添加数据。</p>
<p>　　我们在全局定义x轴和y轴两个数组，在页面初始化的时候，根据业务需求，提前预估计算出数组的长度，并使用默认数据进行填充：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">_xList</span>: <span class="hljs-built_in">string</span>[] = []
<span class="hljs-keyword">const</span> <span class="hljs-attr">_yList</span>: <span class="hljs-built_in">number</span>[] = []

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; diffDay; i++) {
    <span class="hljs-keyword">const</span> nowDate = <span class="hljs-title function_">dayjs</span>(startDate.<span class="hljs-property">value</span>).<span class="hljs-title function_">add</span>(i, <span class="hljs-string">'days'</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">96</span>; j++) {
        _xList.<span class="hljs-title function_">push</span>(
            nowDate.<span class="hljs-title function_">add</span>(i * <span class="hljs-number">15</span>, <span class="hljs-string">'minutes'</span>)
            .<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD HH:mm'</span>)
        )
        _yList.<span class="hljs-title function_">push</span>(<span class="hljs-number">0</span>)
    }
}
</code></pre>
<p>　　当响应数据返回后，我们只需要将数据添加到对应的位置即可：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadEchartData</span>(<span class="hljs-params">rangeItem</span>) {
  <span class="hljs-keyword">const</span> { segmentStartDay } = rangeItem;
  <span class="hljs-keyword">if</span> (res &amp;&amp; res.<span class="hljs-property">data</span>) {
    <span class="hljs-keyword">const</span> { list } = res.<span class="hljs-property">data</span>;
    <span class="hljs-keyword">const</span> startIndex = segmentStartDay * <span class="hljs-number">96</span>;
    <span class="hljs-comment">// 在对应索引处添加数据</span>
    _yList.<span class="hljs-title function_">splice</span>(startIndex, list.<span class="hljs-property">length</span>, ...list);
  }
}
</code></pre>
<h2 data-id="heading-2">Echarts渲染优化：让大数据飞起来</h2>
<p>　　至此，我们已经通过分割、处理与加载的优化，为海量数据的渲染搭建了一条高效的前置管线。。然而，当数据最终抵达浏览器并准备在ECharts中绘制时，性能的“最终挑战”才真正开始。如何让ECharts“消化”这数万个数据点并保持流畅交互？本节将深入ECharts的渲染层，拆解那些让图表“飞起来”的关键优化策略。</p>
<p>　　在大数据量的前提下，我们首先需要确保，echarts的渲染器是canvas而不是SVG，因为SVG图像在处理复杂图形时可能会导致性能问题，因此确保你的图表使用canvas进行渲染：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// renderer不是svg</span>
echarts.<span class="hljs-title function_">init</span>(domElement, <span class="hljs-literal">null</span>, { <span class="hljs-attr">renderer</span>: <span class="hljs-string">'canvas'</span> });
</code></pre>
<h3 data-id="heading-3">降采样策略</h3>
<p>　　什么是数据采样？数据采样是ECharts中处理大数据量的优化技术，当图表需要展示的数据点过多时（通常超过几千个点），浏览器渲染性能会显著下降。采样算法可以在保持图表大致趋势不变的前提下，减少实际渲染的数据点数。</p>
<p>　　例如，通过对一万个原始数据点进行分层抽样，我们将渲染节点的数量直接从10,000个缩减至1,000个。这一优化直接带来了渲染性能的激增，帧率得到显著提升。Echarts提供了多种数据采样算法，包括如下：</p>
<ul>
<li>sum：取过滤点的和</li>
<li>average：取过滤点的平均值</li>
<li>min： 取过滤点的最小值</li>
<li>max： 取过滤点最大的值</li>
<li>minmax：取过滤点绝对值的最大极值 (从 v5.5.0 开始支持)</li>
<li>lttb：采用<code>Largest-Triangle-Three-Bucket</code>算法，可以最大程度保证采样后线条的趋势，形状和极值。</li>
</ul>
<p>　　使用时，通过配置series的sampling属性，指定数据采样算法：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">series</span>: [
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"bar"</span>,
      <span class="hljs-attr">sampling</span>: <span class="hljs-string">"lttb"</span>,
      <span class="hljs-attr">data</span>: yourData,
    },
  ];
}
</code></pre>
<p>　　我们对柱状图进行lttb算法采样后，效果如下，我们能够明显看到柱子的密度有些稀疏：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9fd6c129a4f42cea9dbfdfad8fc2bc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856674&amp;x-signature=VFD4Bhg7AkvSr7S7evzj%2BaXHSa0%3D" alt="柱状图的lttb采样效果" loading="lazy"/></p>
<blockquote>
<p><strong>需要注意</strong>的是，数据经过采样后，数据点会减少，采样会丢失细节，因此不适合需要精确值的场景；同时由于数据点的减少，一些图表的交互功能，如tooltip，也会受到影响。</p>
</blockquote>
<p>　　针对折线图，我们也应用了lttb算法进行下采样。从如下效果图中可以观察到，算法在大幅减少数据点的同时，仍保持了原始曲线的核心趋势与形状，整体还原效果非常好。其主要误差出现在变化剧烈的边界区域或极值点附近，导致局部拟合不够平滑。</p>
<p>　　相较之下，在之前柱状图的测试中，lttb算法因会改变离散柱的分布位置而导致信息失真，因此它更适用于折线图这类强连续性的序列数据可视化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c923f7edcec4841820c839306104a05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856674&amp;x-signature=e56y8qdbKJhEXmeh%2FcjjLq5KPLc%3D" alt="折线图的lttb采样效果" loading="lazy"/></p>
<h4 data-id="heading-4">lttb算法原理</h4>
<p>　　鉴于LTTB算法在降采样中表现出的出色效果，我们有必要深入探究其核心实现原理。作为ECharts等主流可视化库采用的关键算法，其核心步骤是将数据点分组为多个连续的“桶”，并在每个桶内仅筛选一个最具代表性的点。那么，这个代表点是如何被选定的？要回答这个问题，关键在于理解其“最大三角形面积”的筛选准则。</p>
<pre><code class="hljs language-text" lang="text">数据点分布：
   ▲
   │                                  
   │             桶A          桶B          桶C
   │          ┌──────┐    ┌──────┐    ┌──────┐
   │          │      │    │      │    │      │
   │          │  •   │    │  •   │    │  •   │
   │          │  •   │    │  •   │    │  •   │
   │          │  • • │    │•  •  │    │  • • │
   │         •│ •  • │   •│•   • │   •│•   • │
   │       • •│•    •│ • •│•    •│• • │•    •│
   │     • •  │     •│• • │     •│• • │     •│
   │   • •    │      │• • │      │• • │      │
   └──────────┴──────┴────┴──────┴────┴──────┴──▶
   0          10     20    30     40    50     60
                 frameSize = 10个点/桶
</code></pre>
<p>　　我们第一个桶A的点选择初始位置的点，当我们开始选取下一个桶B时点时，再下一个桶C的点，我们暂定为这个桶的平均值；这样，我们前后桶的点都确定了，让我们回到桶B点的选择上来；这个时候，我们遍历桶B的所有点，计算ABC三个桶的点形成三角形的面积，并选择面积最大的点作为这个桶的点。</p>
<p>　　为什么面积大的点就能代表这个桶呢？我们想像一下，如果B点靠近了AC连线上，那么B点几乎就没有提供了新的信息了。</p>
<pre><code class="hljs language-text" lang="text">   A─────B─────C
面积 ≈ 0（三点几乎共线）
</code></pre>
<p>　　但是如果B点远离AC连线，那么B点就提供了新的信息，那么B点就可以代表这个桶的点。</p>
<pre><code class="hljs language-text" lang="text">         B
        / \
       /   \
      /     \
     A       C
面积很大，B点代表了重要特征
</code></pre>
<p>　　当我们已知二维平面上上三个点的坐标，利用初中的知识就能推导三角形的面积为：</p>
<blockquote>
<p>三角形面积 = 0.5 × |AB × AC| = 0.5 × |(x2-x1)(y3-y1) - (x3-x1)(y2-y1)|</p>
</blockquote>
<p>　　下面是一个简单的推导过程:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/620a8b7454224f43a51fef951efedc3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856674&amp;x-signature=l8uMBJfaWpv4o%2FZluo0OR0EIjdk%3D" alt="三角形面积公式" loading="lazy"/></p>
<p>　　我们访问Echarts仓库中查看源码，发现lttb算法代码在<code>src/data/DataStore.ts</code>的lttbDownSample函数中实现；有了上面理论的支撑，我们下面就来好好的拆解拆解这个函数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * Large data down sampling using largest-triangle-three-buckets
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">valueDimension</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">targetCount</span>
 */</span>
<span class="hljs-title function_">lttbDownSample</span>(<span class="hljs-params">
    valueDimension: DimensionIndex,
    rate: <span class="hljs-built_in">number</span>
</span>){
  <span class="hljs-comment">// 总数据点数，如 10000</span>
  <span class="hljs-keyword">const</span> len = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">count</span>();

  <span class="hljs-comment">// 每个桶的大小，如rate = 0.1，则frameSize = 10</span>
  <span class="hljs-keyword">const</span> frameSize = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-number">1</span> / rate);
}
</code></pre>
<p>　　首先上面的代码中，我们首先获取数据点的总数，并计算每个桶的大小；这里传入的valueDimension代表值的维度，如果直接传入数据列表，会导致内存占用过高，因此这里的做法是传入数据维度，通过维度来获取数据，从而提高性能。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; len - <span class="hljs-number">1</span>; i += frameSize) {
  <span class="hljs-comment">// 下一个桶的边界</span>
  <span class="hljs-keyword">const</span> nextFrameStart = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(i + frameSize, len - <span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> nextFrameEnd = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(i + frameSize * <span class="hljs-number">2</span>, len);

  <span class="hljs-comment">// 计算下一个桶的平均点</span>
  <span class="hljs-keyword">const</span> avgX = (nextFrameEnd + nextFrameStart) / <span class="hljs-number">2</span>; <span class="hljs-comment">// X坐标平均值</span>
  <span class="hljs-keyword">let</span> avgY = <span class="hljs-number">0</span>; <span class="hljs-comment">// Y坐标平均值</span>
}
</code></pre>
<p>　　然后我们开始遍历数据点，我们发现i是从1开始的，因为我们默认第一个点就是第一个桶的选择点；接着，在当前桶遍历下，我们先要计算出下一个桶C的平均点（avgX， avgY）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; len - <span class="hljs-number">1</span>; i += frameSize) {
  <span class="hljs-comment">// 省略上面代码</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> idx = nextFrameStart; idx &lt; nextFrameEnd; idx++) {
      <span class="hljs-comment">// 获取下一个桶上面每一个点的值</span>
      <span class="hljs-keyword">const</span> y = dimStore[rawIndex] <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;
      avgY += y <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;
  }
  avgY /= (nextFrameEnd - nextFrameStart);
}
</code></pre>
<p>　　然后，我们开始遍历下一个C桶中的每一个数据点，并计算出下一个桶的平均值。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> maxArea;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; len - <span class="hljs-number">1</span>; i += frameSize) {
  <span class="hljs-comment">// 当前桶的起始索引</span>
  <span class="hljs-keyword">const</span> frameStart = i;
  <span class="hljs-comment">// 当前桶的结束索引</span>
  <span class="hljs-keyword">const</span> frameEnd = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(i + frameSize, len);

  <span class="hljs-comment">// 上一个点的X坐标</span>
  <span class="hljs-keyword">const</span> pointAX = i - <span class="hljs-number">1</span>;
  <span class="hljs-comment">// 上一个点的Y值</span>
  <span class="hljs-keyword">const</span> pointAY = dimStore[currentRawIndex] <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;

  <span class="hljs-comment">// 当前桶最大的面积</span>
  maxArea = -<span class="hljs-number">1</span>;
}
</code></pre>
<p>　　紧接着，我们为当前桶B点的遍历准备一下数据，frameStart和frameEnd是当前桶B的边界，pointAX和pointAY是上一个桶A的坐标。</p>
<blockquote>
<p>我们发现这里的pointAX取得是上一个桶最后一个点的坐标i - 1，而不是每次都将上一个桶的选择点存起来使用，这其实是Echarts为了性能优化，牺牲了一点精度，减少变量跟踪。</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 循环遍历每个桶</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; len - <span class="hljs-number">1</span>; i += frameSize) {
  <span class="hljs-comment">// 省略上面代码</span>
  <span class="hljs-comment">// 循环遍历桶B中的数据点</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> idx = frameStart; idx &lt; frameEnd; idx++) {
    <span class="hljs-comment">// 当前点的X坐标</span>
    <span class="hljs-keyword">const</span> rawIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRawIndex</span>(idx);
    <span class="hljs-comment">// 当前点的Y坐标</span>
    <span class="hljs-keyword">const</span> y = dimStore[rawIndex] <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;
    <span class="hljs-comment">// 计算三角形的面积</span>
    area = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>((pointAX - avgX) * (y - pointAY)
      - (pointAX - idx) * (avgY - pointAY)
    );
    <span class="hljs-keyword">if</span> (area &gt; maxArea) {
      maxArea = area;
      nextRawIndex = rawIndex;
    }
  }

  newIndices[sampledIndex++] = nextRawIndex;
}
</code></pre>
<p>　　最后这个代码是整个算法的核心代码,也是最精妙的地方；基于之前桶的循环，我们在当前桶内，遍历桶中每个数据点，rawIndex和y表示当前点的坐标；而这里的area就是我们上面介绍的三角形的计算公式，经过之前对于桶A、桶B、桶C的点准备，相信这里的area计算相信大家都能够理解了；最后如果area超出了记录的最大面积maxArea，则将当前点加入到新的采样数据中进行数据留存。</p>
<p>　　纸上得来终觉浅，算法的精妙，非得亲手试一下不可。为此，笔者写了一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fgallery.xieyufei.com%2Fcase%2Falgorithm%2Flttb" target="_blank" title="https://gallery.xieyufei.com/case/algorithm/lttb" ref="nofollow noopener noreferrer">简单的页面</a>来演示LTTB算法的实际效果，默认设置采样率rate为0.1，同时对折线图数据进行采样对比，就能看到和原始数据之间的细微差异：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68032c1dcb8c4c43a7dae545906e4145~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856674&amp;x-signature=f63zVFdEVw2%2Bhpm6bXwoEBljbME%3D" alt="手写lttb算法采样的效果" loading="lazy"/></p>
<h3 data-id="heading-5">dataZoom分块渲染</h3>
<p>　　在处理海量数据时，启用<code>dataZoom组件</code>是实现性能跃升的核心策略之一。它将渲染模式从一次性承载全量数据，转变为动态的窗口化渲染。初始化时仅加载视口范围内的数据，随着用户滚动或缩放再动态加载其他部分。这种方式将渲染压力分散到多次轻量级操作中，从根本上避免了单次渲染卡顿，大幅提升了交互响应速度。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> option = {
  <span class="hljs-attr">dataZoom</span>: [
    { 
      <span class="hljs-attr">type</span>: <span class="hljs-string">"inside"</span>,
      <span class="hljs-attr">start</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">end</span>: <span class="hljs-number">20</span>
    },
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"slider"</span>,
      <span class="hljs-attr">start</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">end</span>: <span class="hljs-number">20</span>,
    },
  ],
  <span class="hljs-attr">series</span>:[
    <span class="hljs-comment">//...</span>
  ]
};
</code></pre>
<p>　　然而，这里存在一个状态冲突问题，每次从接口获取新数据并重渲染图表时，dataZoom都会被强制重置到初始的[0, 20]区间。如果用户在之前已经通过拖拽缩放浏览了其他数据区域，这个行为就会破坏其探索状态，导致用户体验割裂。</p>
<p>　　第一种常规的解决方案是，我们在核心的图表渲染函数<code>renderChart</code>中引入一个守卫参数isInitial。只有当 isInitial 为 true（例如初次渲染时），才设置dataZoom的区间。在常规的数据更新渲染中，则保留用户当前交互状态，仅刷新数据而不触动缩放组件。</p>
<p>　　另一种解决方案是，在setOption时，使用<code>replaceMerge</code>参数，告诉ECharts只替换指定的组件，其他组件（如 dataZoom）保持不变：</p>
<pre><code class="hljs language-javascript" lang="javascript">echartsInst.<span class="hljs-title function_">setOption</span>({
  <span class="hljs-attr">dataZoom</span>: [
    { 
      <span class="hljs-attr">type</span>: <span class="hljs-string">"inside"</span>,
      <span class="hljs-attr">start</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">end</span>: <span class="hljs-number">20</span>
    },
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"slider"</span>,
      <span class="hljs-attr">start</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">end</span>: <span class="hljs-number">20</span>,
    },
  ],
  <span class="hljs-attr">series</span>:[
    <span class="hljs-comment">//...</span>
  ]
}, {
  <span class="hljs-attr">notMerge</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">replaceMerge</span>: [<span class="hljs-string">"xAxis"</span>, <span class="hljs-string">"series"</span>],
})
</code></pre>
<p>　　这样即使多次setOption也不会重置dataZoom的区间。</p>
<h3 data-id="heading-6">大数据模式与渐进式渲染</h3>
<p>　　经常查看Echarts官方文档的小伙伴，相信都看到过large和progressive等属性，但是什么情况下需要用到large和progressive呢？相信很多小伙伴都一头雾水，这一节，我们就来好好说道说道。</p>
<p>　　<code>large属性</code>是ECharts为海量数据渲染设计的专用性能优化开关，通常指数据量在数万到数百万级别； 当你的数据量预计达到此规模时，开启此选项将直接调用底层优化算法，从而获得显著的渲染性能提升，下面我们通过表格实际感受一下10w+级的实测对比数据：</p>






























<table><thead><tr><th>指标</th><th>未开启 large</th><th>开启 large</th></tr></thead><tbody><tr><td>FPS</td><td>3-10</td><td>51-60</td></tr><tr><td>MS(渲染一帧所需的毫秒数)</td><td>179-246</td><td>17-28</td></tr><tr><td>内存占用(MB)</td><td>277-305</td><td>53-59</td></tr><tr><td>交互响应</td><td>卡顿明显</td><td>基本流畅</td></tr></tbody></table>
<p>　　<code>largeThreshold</code>是与large属性配合使用的阈值参数，它定义了启用大规模优化模式的数据量下限。当且仅当数据项数超过此阈值时，优化绘制逻辑才会生效；反之，系统将使用标准渲染流程，避免不必要的开销；大多数情况下无需手动调整。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">setOption</span>({
  <span class="hljs-attr">series</span>: [
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"bar"</span>,
      data,
      <span class="hljs-attr">large</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">largeThreshold</span>: <span class="hljs-number">1000</span>,
    },
  ],
});
</code></pre>
<blockquote>
<p><strong>需要注意</strong>的是，不是每种类型的图表都支持large和largeThreshold属性的，目前仅有bar和scatter图表支持。</p>
</blockquote>
<p>　　需要指出的是，在large模式下，Echarts出于性能优化的考虑，无法为单个数据点设置独立样式，所有数据点将共享同一套样式配置；比如下面代码中，我们为最后一个数据项单独设置的itemStyle就不会生效：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">setOption</span>({
  <span class="hljs-attr">series</span>: [
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"bar"</span>,
      <span class="hljs-attr">data</span>: [
        <span class="hljs-number">10</span>,
        <span class="hljs-number">20</span>,
        <span class="hljs-number">30</span>,
        <span class="hljs-comment">// 这个不会生效</span>
        { <span class="hljs-attr">value</span>: <span class="hljs-number">40</span>, <span class="hljs-attr">itemStyle</span>: { <span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span> } }
      ],
      <span class="hljs-attr">large</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">largeThreshold</span>: <span class="hljs-number">1000</span>,
      <span class="hljs-attr">itemStyle</span>: {
        <span class="hljs-comment">// 所有柱子都是这个颜色</span>
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>
      }
    },
  ],
});
</code></pre>
<p>　　<code>progressive属性</code>本质是开启“分片渲染”模式，用以解决超大规模图形元素（数千至千万级）造成的浏览器瞬时阻塞风险。启用后，ECharts会将庞大的数据集自动分割为多个小块（chunk），在多个动画帧中依次渲染，从而将一次性的沉重负载分散为平缓的增量任务。我们在散点图上实测此功能，可以清晰地观察到数万个数据点如同雨点般在画布上逐渐浮现：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">Array</span>&lt;[<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>]&gt; = [];
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
  data.<span class="hljs-title function_">push</span>([
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>, 
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>
  ]);
}

<span class="hljs-title function_">setOption</span>({
  <span class="hljs-attr">series</span>: [
    {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"scatter"</span>,
        data,
        <span class="hljs-attr">progressive</span>: <span class="hljs-number">100</span>,
        <span class="hljs-attr">progressiveThreshold</span>: <span class="hljs-number">3000</span>,
        <span class="hljs-attr">progressiveChunkMode</span>: <span class="hljs-string">'mod'</span>
    },
  ],
});
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c802f9023f1c40b7a4fb8beb81f4aeef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856674&amp;x-signature=DyhW2X74eyMmE1K356VMb3xs2dc%3D" alt="progressive属性效果" loading="lazy"/></p>
<p>　　<code>progressive属性</code>控制渐进式渲染的 “粒度”，其值为每一帧渲染的图形数量，默认值为400，设为0，则相当于关闭此功能；而<code>progressiveThreshold属性</code>则设定了启用此功能的 “门槛”。仅当图形总数超过此阈值时，progressive的配置才会生效，开始分帧渲染。</p>
<blockquote>
<p>开启large默认会开启progressive渐进渲染。</p>
</blockquote>
<h2 data-id="heading-7">总结</h2>
<p>　　到这里，我的Echarts性能优化三部曲总算告一段落了；当看到业务方在流畅渲染着四年设备数据的图表前露出满意笑容时，我就知道，这次优化的努力没有白费。</p>
<p>　　我们首先构建了数据分割机制。当用户选择跨年度的查询范围时，系统不再傻乎乎地一次性请求所有数据，而是像一位细心的图书管理员，将厚厚的历史档案按时间章节分册取出。这个简单的策略，将原本长达14秒的接口响应时间分解为多个毫秒级的快速请求，从根本上避免了浏览器的内存过载和界面冻结。</p>
<p>　　接着我们引入了Web Worker并行计算。这相当于给数据处理流程雇佣了一位专属的后台助理。所有耗时的数据清洗、格式转换和指标计算都被转移到独立线程中执行，主线程得以保持轻盈，继续流畅地响应用户的每一次点击和滑动。这种前后台分工协作的模式，让数据处理从“阻塞性任务”变成了“后台服务”。</p>
<p>　　最后，我们在Echarts渲染层施展了一系列组合优化。通过LTTB采样算法，我们在保留数据趋势灵魂的同时，巧妙地减少了渲染负担；借助dataZoom的视口动态加载，我们实现了“所见即所得”的按需渲染；而启用large和progressive模式，则是给图表引擎装上了涡轮增压，让万级数据点的绘制也能达到60帧的流畅体验。</p>
<p>　　现在回顾这段旅程，让我深刻认识到数据可视化的本质——它不仅仅是数据的图形化呈现，更是信息与洞察的艺术表达。好了，我的优化之旅暂告一段落，但技术的探索永无止境。那么，你的项目中是否也藏着需要被驯服的“数据巨兽”呢？带上这份实战心得，开始你的优化之旅吧！</p>
<p>如果觉得写得还不错，请关注我的<a href="//juejin.im/user/580038cebf22ec0064bd0b2d" target="_blank" title="//juejin.im/user/580038cebf22ec0064bd0b2d">掘金主页</a>。更多文章请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fxieyufei.com" target="_blank" title="https://xieyufei.com" ref="nofollow noopener noreferrer">谢小飞的博客</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OoderA2UI BridgeCode 深度解析：从设计原理到 Trae Solo Skill 实践]]></title>    <link>https://juejin.cn/post/7602807243705237567</link>    <guid>https://juejin.cn/post/7602807243705237567</guid>    <pubDate>2026-02-05T00:38:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602807243705237567" data-draft-id="7602841282802729001" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OoderA2UI BridgeCode 深度解析：从设计原理到 Trae Solo Skill 实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-05T00:38:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OoderA2UI BridgeCode 深度解析：从设计原理到 Trae Solo Skill 实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:38:33.000Z" title="Thu Feb 05 2026 00:38:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">摘要</h2>
<p>本文深入解析 ooder 框架的核心 BridgeCode 机制，从设计原理、生成编译流程，到基于此机制的分层 SKILLS 设计，最后展示在 Trae Solo 环境中的 Skill 构建实践。通过源码分析和实战案例，揭示 ooder 如何通过元数据驱动的代码生成实现高效的 A2UI 组件开发。</p>
<h2 data-id="heading-1">一、BridgeCode 设计原理</h2>
<h3 data-id="heading-2">1.1 核心设计理念</h3>
<p>BridgeCode 是 ooder 框架中连接元数据配置与运行时组件的桥梁，其核心设计理念是<strong>元数据驱动</strong>（Metadata-Driven）：</p>
<pre><code class="hljs language-javascript" lang="javascript">元数据配置（<span class="hljs-title class_">JSON</span>/注解）
    ↓
<span class="hljs-title class_">BridgeCode</span> 生成器
    ↓
<span class="hljs-title class_">Java</span> 源代码
    ↓
动态编译
    ↓
运行时组件
</code></pre>
<p><strong>设计目标</strong>：</p>
<ol>
<li><strong>解耦性</strong>：将配置与实现分离，配置通过声明式方式定义</li>
<li><strong>可扩展性</strong>：支持多种组件类型和视图模式</li>
<li><strong>类型安全</strong>：通过编译期检查确保配置的正确性</li>
<li><strong>运行时绑定</strong>：支持动态加载和热更新</li>
</ol>
<h3 data-id="heading-3">1.2 架构层次</h3>
<p>BridgeCode 系统采用三层架构设计：</p>
<pre><code class="hljs language-javascript" lang="javascript">┌─────────────────────────────────────────────┐
│         元数据层（<span class="hljs-title class_">Metadata</span> <span class="hljs-title class_">Layer</span>）         │
│  - <span class="hljs-title class_">CustomViewMeta</span>                        │
│  - <span class="hljs-title class_">CustomDataMeta</span>                        │
│  - <span class="hljs-title class_">MethodConfig</span>                          │
└─────────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│       生成器层（<span class="hljs-title class_">Generator</span> <span class="hljs-title class_">Layer</span>）          │
│  - <span class="hljs-title class_">GenCustomViewJava</span>                     │
│  - <span class="hljs-title class_">GenRepositoryViewJava</span>                  │
│  - <span class="hljs-title class_">GenAggCustomViewJava</span>                 │
└─────────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│       运行时层（<span class="hljs-title class_">Runtime</span> <span class="hljs-title class_">Layer</span>）           │
│  - <span class="hljs-title class_">UIComponent</span>                          │
│  - <span class="hljs-title class_">ModuleUIComponent</span>                     │
│  - <span class="hljs-title class_">AggRootBuild</span>                         │
└─────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-4">1.3 核心类设计</h3>
<h4 data-id="heading-5">1.3.1 AggRootBuild - 聚合根构建器</h4>
<p>AggRootBuild 是 BridgeCode 生成流程的核心协调类，位于 <code>net.ooder.engine.codegen.java.AggRootBuild</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AggRootBuild</span> {
    
    <span class="hljs-keyword">private</span> GenCustomViewJava viewTask;
    <span class="hljs-keyword">private</span> GenRepositoryViewJava voRepositoryTask;
    <span class="hljs-keyword">private</span> GenRepositoryViewJava serviceRepositoryTask;
    <span class="hljs-keyword">private</span> GenAggCustomViewJava rootTask;
    <span class="hljs-keyword">private</span> GenAggCustomJava genAggCustomJava;
    
    <span class="hljs-keyword">public</span> List&lt;JavaGenSource&gt; <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-comment">// 1. 创建子节点</span>
        CustomViewMeta = genChildJava();
        
        <span class="hljs-comment">// 2. 创建视图层</span>
        javaViewSource = buildView();
        
        <span class="hljs-comment">// 3. 创建资源层接口</span>
        repositorySource = buildRepositoryView(<span class="hljs-literal">true</span>);
        
        <span class="hljs-comment">// 4. 预编译一次</span>
        javaGen.dynCompile(getModuleJavaSrc());
        
        <span class="hljs-keyword">return</span> aggServiceRootBean;
    }
}
</code></pre>
<p><strong>关键特性</strong>：</p>
<ul>
<li><strong>任务编排</strong>：协调多个生成任务的执行顺序</li>
<li><strong>依赖管理</strong>：处理生成任务之间的依赖关系</li>
<li><strong>增量构建</strong>：支持只生成变更的部分</li>
<li><strong>错误处理</strong>：统一的异常处理和回滚机制</li>
</ul>
<h4 data-id="heading-6">1.3.2 GenJavaTask - 生成任务基类</h4>
<p>所有代码生成器都继承自 GenJavaTask，提供统一的生成框架：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenJavaTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Callable</span>&lt;List&lt;JavaGenSource&gt;&gt; {
    
    <span class="hljs-keyword">protected</span> JavaGenSource javaGen;
    <span class="hljs-keyword">protected</span> CustomViewMeta viewMeta;
    <span class="hljs-keyword">protected</span> String euClassName;
    <span class="hljs-keyword">protected</span> Chrome chrome;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> List&lt;JavaGenSource&gt; <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JDSException;
    
    <span class="hljs-keyword">protected</span> JavaGenSource <span class="hljs-title function_">createJavaSource</span><span class="hljs-params">(String className, String content)</span> {
        <span class="hljs-type">JavaGenSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaGenSource</span>();
        source.setClassName(className);
        source.setContent(content);
        source.setPackage(viewMeta.getPackageName());
        <span class="hljs-keyword">return</span> source;
    }
}
</code></pre>
<p><strong>设计优势</strong>：</p>
<ul>
<li><strong>统一接口</strong>：所有生成器实现相同的接口</li>
<li><strong>可组合性</strong>：支持生成器的组合和复用</li>
<li><strong>错误隔离</strong>：每个生成器独立处理错误</li>
<li><strong>可测试性</strong>：每个生成器可以独立测试</li>
</ul>
<h4 data-id="heading-7">1.3.3 D2CGenerator - 设计到代码生成器</h4>
<p>D2CGenerator 是核心的代码生成引擎，使用 Freemarker 模板引擎：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">D2CGenerator</span> {
    
    <span class="hljs-keyword">private</span> Configuration freemarkerConfig;
    <span class="hljs-keyword">private</span> TemplateManager templateManager;
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generate</span><span class="hljs-params">(String templateName, Map&lt;String, Object&gt; dataModel)</span> 
            <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> freemarkerConfig.getTemplate(templateName);
            <span class="hljs-type">StringWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();
            template.process(dataModel, writer);
            <span class="hljs-keyword">return</span> writer.toString();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(<span class="hljs-string">"代码生成失败: "</span> + e.getMessage(), e);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dynCompile</span><span class="hljs-params">(List&lt;JavaGenSource&gt; sources)</span> <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-type">JavaCompiler</span> <span class="hljs-variable">compiler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaCompiler</span>();
        compiler.compile(sources);
    }
}
</code></pre>
<p><strong>技术栈</strong>：</p>
<ul>
<li><strong>模板引擎</strong>：Freemarker 2.3.x</li>
<li><strong>编译器</strong>：Java Compiler API</li>
<li><strong>类加载</strong>：自定义 ClassLoader</li>
<li><strong>打包</strong>：JAR 文件生成</li>
</ul>
<h2 data-id="heading-8">二、BridgeCode 生成编译原理</h2>
<h3 data-id="heading-9">2.1 完整生成流程</h3>
<p>BridgeCode 的生成编译流程分为五个阶段：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">阶段</span> <span class="hljs-attr">1:</span> <span class="hljs-string">元数据解析</span>
    <span class="hljs-string">↓</span>
<span class="hljs-string">阶段</span> <span class="hljs-attr">2:</span> <span class="hljs-string">代码生成</span>
    <span class="hljs-string">↓</span>
<span class="hljs-string">阶段</span> <span class="hljs-attr">3:</span> <span class="hljs-string">源码组装</span>
    <span class="hljs-string">↓</span>
<span class="hljs-string">阶段</span> <span class="hljs-attr">4:</span> <span class="hljs-string">动态编译</span>
    <span class="hljs-string">↓</span>
<span class="hljs-string">阶段</span> <span class="hljs-attr">5:</span> <span class="hljs-string">运行时绑定</span>
</code></pre>
<h3 data-id="heading-10">2.2 阶段详解</h3>
<h4 data-id="heading-11">2.2.1 阶段 1：元数据解析</h4>
<p><strong>输入</strong>：</p>
<ul>
<li>JSON 配置文件</li>
<li>Java 注解配置</li>
<li>数据库元数据</li>
</ul>
<p><strong>处理流程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetadataParser</span> {
    
    <span class="hljs-keyword">public</span> MethodConfig <span class="hljs-title function_">parseFromJson</span><span class="hljs-params">(String jsonConfig)</span> {
        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> JSON.parseObject(jsonConfig);
        <span class="hljs-type">MethodConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodConfig</span>();
        
        <span class="hljs-comment">// 解析视图元数据</span>
        config.setView(parseViewMeta(json.getJSONObject(<span class="hljs-string">"view"</span>)));
        
        <span class="hljs-comment">// 解析数据元数据</span>
        config.setDataBean(parseDataMeta(json.getJSONObject(<span class="hljs-string">"data"</span>)));
        
        <span class="hljs-comment">// 解析方法配置</span>
        config.setMethodName(json.getString(<span class="hljs-string">"methodName"</span>));
        config.setUrl(json.getString(<span class="hljs-string">"url"</span>));
        
        <span class="hljs-keyword">return</span> config;
    }
    
    <span class="hljs-keyword">public</span> MethodConfig <span class="hljs-title function_">parseFromAnnotation</span><span class="hljs-params">(Class&lt;?&gt; bridgeClass)</span> {
        <span class="hljs-type">MethodConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodConfig</span>();
        
        <span class="hljs-comment">// 解析 @CustomClass 注解</span>
        <span class="hljs-type">CustomClass</span> <span class="hljs-variable">classAnnotation</span> <span class="hljs-operator">=</span> bridgeClass.getAnnotation(CustomClass.class);
        config.setCaption(classAnnotation.caption());
        
        <span class="hljs-comment">// 解析方法注解</span>
        <span class="hljs-keyword">for</span> (Method method : bridgeClass.getMethods()) {
            <span class="hljs-keyword">if</span> (method.isAnnotationPresent(CustomMenuItem.class)) {
                config.addMenuItem(parseMenuItem(method));
            }
            <span class="hljs-keyword">if</span> (method.isAnnotationPresent(CustomGridEvent.class)) {
                config.addEvent(parseGridEvent(method));
            }
        }
        
        <span class="hljs-keyword">return</span> config;
    }
}
</code></pre>
<p><strong>验证机制</strong>：</p>
<ul>
<li>类型检查：确保字段类型匹配</li>
<li>必填验证：检查必填字段</li>
<li>引用验证：验证引用的实体存在</li>
<li>格式验证：检查 URL、正则表达式等格式</li>
</ul>
<h4 data-id="heading-12">2.2.2 阶段 2：代码生成</h4>
<p><strong>生成器层次</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">GenCustomViewJava (视图层生成器)
    ├── GenLayoutChildModule (布局生成)
    ├── GenTabsChildModule (标签页生成)
    └── GenFormChildModule (表单生成)

GenRepositoryViewJava (仓储层生成器)
    ├── GenEntityJava (实体生成)
    ├── GenEntityServiceJava (服务生成)
    └── GenTableJava (表生成)

GenAggCustomViewJava (聚合层生成器)
    ├── GenAggRootJava (聚合根生成)
    ├── GenAggMenuJava (菜单生成)
    └── GenAggAPIJava (API生成)
</code></pre>
<p><strong>生成示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenCustomViewJava</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenJavaTask</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;JavaGenSource&gt; <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JDSException {
        List&lt;JavaGenSource&gt; sources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-comment">// 1. 生成视图类</span>
        sources.add(generateViewClass());
        
        <span class="hljs-comment">// 2. 生成字段配置</span>
        sources.add(generateFieldConfigs());
        
        <span class="hljs-comment">// 3. 生成事件处理器</span>
        sources.add(generateEventHandlers());
        
        <span class="hljs-keyword">return</span> sources;
    }
    
    <span class="hljs-keyword">private</span> JavaGenSource <span class="hljs-title function_">generateViewClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JDSException {
        Map&lt;String, Object&gt; dataModel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        dataModel.put(<span class="hljs-string">"className"</span>, viewMeta.getClassName());
        dataModel.put(<span class="hljs-string">"packageName"</span>, viewMeta.getPackageName());
        dataModel.put(<span class="hljs-string">"fields"</span>, viewMeta.getFields());
        
        <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> d2cGenerator.generate(<span class="hljs-string">"view.ftl"</span>, dataModel);
        <span class="hljs-keyword">return</span> createJavaSource(viewMeta.getClassName(), content);
    }
}
</code></pre>
<p><strong>模板示例</strong>（Freemarker）：</p>
<pre><code class="hljs language-ftl" lang="ftl">package ${packageName};

import net.ooder.engine.ub.component.*;
import net.ooder.engine.ub.annotation.*;

&lt;#list fields as field&gt;
import ${field.type};
&lt;/#list&gt;

/**
 * ${viewMeta.caption}
 * 自动生成的视图类，请勿手动修改
 */
@CustomView
public class ${className} extends UIComponent {
    
    &lt;#list fields as field&gt;
    private ${field.type} ${field.name};
    &lt;/#list&gt;
    
    public ${className}() {
        super();
        // 初始化组件
    }
}
</code></pre>
<h4 data-id="heading-13">2.2.3 阶段 3：源码组装</h4>
<p><strong>组装策略</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SourceAssembler</span> {
    
    <span class="hljs-keyword">public</span> JavaSrcMeta <span class="hljs-title function_">assemble</span><span class="hljs-params">(List&lt;JavaGenSource&gt; sources)</span> {
        <span class="hljs-type">JavaSrcMeta</span> <span class="hljs-variable">srcMeta</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaSrcMeta</span>();
        
        <span class="hljs-comment">// 1. 按包分组</span>
        Map&lt;String, List&lt;JavaGenSource&gt;&gt; packageMap = 
            sources.stream().collect(Collectors.groupingBy(JavaGenSource::getPackage));
        
        <span class="hljs-comment">// 2. 生成包结构</span>
        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, List&lt;JavaGenSource&gt;&gt; entry : packageMap.entrySet()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">packageName</span> <span class="hljs-operator">=</span> entry.getKey();
            List&lt;JavaGenSource&gt; packageSources = entry.getValue();
            
            <span class="hljs-comment">// 生成包目录</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">packagePath</span> <span class="hljs-operator">=</span> packageName.replace(<span class="hljs-string">'.'</span>, <span class="hljs-string">'/'</span>);
            srcMeta.addPackage(packagePath, packageSources);
        }
        
        <span class="hljs-comment">// 3. 生成导入语句</span>
        srcMeta.addImports(calculateImports(sources));
        
        <span class="hljs-keyword">return</span> srcMeta;
    }
}
</code></pre>
<p><strong>依赖解析</strong>：</p>
<ul>
<li>自动计算类依赖关系</li>
<li>生成正确的 import 语句</li>
<li>处理循环依赖</li>
<li>优化导入顺序</li>
</ul>
<h4 data-id="heading-14">2.2.4 阶段 4：动态编译</h4>
<p><strong>编译流程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicCompiler</span> {
    
    <span class="hljs-keyword">public</span> Class&lt;?&gt; compile(JavaGenSource source) <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 创建 Java 文件</span>
            <span class="hljs-type">File</span> <span class="hljs-variable">javaFile</span> <span class="hljs-operator">=</span> createJavaFile(source);
            
            <span class="hljs-comment">// 2. 编译 Java 文件</span>
            <span class="hljs-type">JavaCompiler</span> <span class="hljs-variable">compiler</span> <span class="hljs-operator">=</span> ToolProvider.getSystemJavaCompiler();
            DiagnosticCollector&lt;JavaFileObject&gt; diagnostics = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DiagnosticCollector</span>&lt;&gt;();
            
            <span class="hljs-type">StandardJavaFileManager</span> <span class="hljs-variable">fileManager</span> <span class="hljs-operator">=</span> 
                compiler.getStandardFileManager(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
            
            Iterable&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JavaFileObject</span>&gt; compilationUnits = 
                fileManager.getJavaFileObjectsFromFiles(Arrays.asList(javaFile));
            
            <span class="hljs-comment">// 3. 执行编译</span>
            compiler.getTask(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, diagnostics, fileManager, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)
                   .call(compilationUnits);
            
            <span class="hljs-comment">// 4. 检查编译错误</span>
            <span class="hljs-keyword">if</span> (!diagnostics.getDiagnostics().isEmpty()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(<span class="hljs-string">"编译失败: "</span> + diagnostics);
            }
            
            <span class="hljs-comment">// 5. 加载编译后的类</span>
            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> fileManager.getClassLoader(<span class="hljs-literal">null</span>);
            <span class="hljs-keyword">return</span> classLoader.loadClass(source.getClassName());
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(<span class="hljs-string">"动态编译失败: "</span> + e.getMessage(), e);
        }
    }
}
</code></pre>
<p><strong>编译优化</strong>：</p>
<ul>
<li>增量编译：只编译变更的文件</li>
<li>并行编译：支持多线程编译</li>
<li>缓存机制：缓存已编译的类</li>
<li>热替换：支持运行时替换类</li>
</ul>
<h4 data-id="heading-15">2.2.5 阶段 5：运行时绑定</h4>
<p><strong>绑定机制</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuntimeBinder</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bind</span><span class="hljs-params">(MethodConfig config, Class&lt;?&gt; bridgeClass)</span> 
            <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 创建 Bridge 实例</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">bridgeInstance</span> <span class="hljs-operator">=</span> bridgeClass.newInstance();
            
            <span class="hljs-comment">// 2. 绑定方法到事件</span>
            <span class="hljs-keyword">for</span> (Event event : config.getEvents()) {
                <span class="hljs-type">Method</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> findHandlerMethod(bridgeClass, event.getHandler());
                bindEvent(event, handler, bridgeInstance);
            }
            
            <span class="hljs-comment">// 3. 绑定菜单项</span>
            <span class="hljs-keyword">for</span> (MenuItem menu : config.getMenus()) {
                <span class="hljs-type">Method</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> findHandlerMethod(bridgeClass, menu.getHandler());
                bindMenuItem(menu, handler, bridgeInstance);
            }
            
            <span class="hljs-comment">// 4. 注册到 UI 框架</span>
            registerToUIFramework(bridgeInstance);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(<span class="hljs-string">"运行时绑定失败: "</span> + e.getMessage(), e);
        }
    }
}
</code></pre>
<p><strong>绑定特性</strong>：</p>
<ul>
<li>反射绑定：使用 Java 反射机制</li>
<li>类型安全：编译期检查类型匹配</li>
<li>生命周期管理：自动管理组件生命周期</li>
<li>事件传播：支持事件冒泡和捕获</li>
</ul>
<h3 data-id="heading-16">2.3 性能优化</h3>
<h4 data-id="heading-17">2.3.1 生成缓存</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenerationCache</span> {
    
    <span class="hljs-keyword">private</span> Map&lt;String, JavaGenSource&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> JavaGenSource <span class="hljs-title function_">getOrGenerate</span><span class="hljs-params">(String key, Callable&lt;JavaGenSource&gt; generator)</span> 
            <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-keyword">return</span> cache.computeIfAbsent(key, k -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> generator.call();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(<span class="hljs-string">"生成失败: "</span> + e.getMessage(), e);
            }
        });
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidate</span><span class="hljs-params">(String key)</span> {
        cache.remove(key);
    }
}
</code></pre>
<h4 data-id="heading-18">2.3.2 并行生成</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParallelGenerator</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">4</span>);
    
    <span class="hljs-keyword">public</span> List&lt;JavaGenSource&gt; <span class="hljs-title function_">generateParallel</span><span class="hljs-params">(
            List&lt;GenJavaTask&gt; tasks)</span> <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-keyword">try</span> {
            List&lt;Future&lt;JavaGenSource&gt;&gt; futures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            
            <span class="hljs-keyword">for</span> (GenJavaTask task : tasks) {
                Future&lt;JavaGenSource&gt; future = executor.submit(task);
                futures.add(future);
            }
            
            List&lt;JavaGenSource&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            <span class="hljs-keyword">for</span> (Future&lt;JavaGenSource&gt; future : futures) {
                results.add(future.get());
            }
            
            <span class="hljs-keyword">return</span> results;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(<span class="hljs-string">"并行生成失败: "</span> + e.getMessage(), e);
        }
    }
}
</code></pre>
<h2 data-id="heading-19">三、分层 SKILLS 设计</h2>
<h3 data-id="heading-20">3.1 Skill 架构设计</h3>
<p>基于 BridgeCode 机制，ooder 设计了分层 SKILLS 架构，为 LLM 提供结构化的知识访问能力：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────────────────────────────────────┐
│      Skill 知识层（Knowledge Layer）       │
│  - Foundation Skill                      │
│  - Module Skill                        │
│  - Component Skill                     │
│  - Metadata Skill                      │
└─────────────────────────────────────────────┘
<span class="hljs-code">                  ↓
┌─────────────────────────────────────────────┐
│     Skill 执行层（Execution Layer）        │
│  - Skill Loader                        │
│  - Skill Context                      │
│  - Skill Orchestrator                 │
└─────────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│     Skill 集成层（Integration Layer）    │
│  - Trae Solo Integration               │
│  - LLM Provider                      │
│  - Tool Registry                      │
└─────────────────────────────────────────────┘
</span></code></pre>
<h3 data-id="heading-21">3.2 Foundation Skill 设计</h3>
<p><strong>职责</strong>：提供基础组件的知识和生成能力</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FoundationSkill</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"foundation"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DESCRIPTION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"基础组件 Skill"</span>;
    
    <span class="hljs-keyword">public</span> SkillContext <span class="hljs-title function_">load</span><span class="hljs-params">()</span> {
        <span class="hljs-type">SkillContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillContext</span>();
        
        <span class="hljs-comment">// 1. 加载 NlpBaseUIComponent 知识</span>
        context.addClass(NlpBaseUIComponent.class);
        
        <span class="hljs-comment">// 2. 加载生成器知识</span>
        context.addGenerator(GenJavaTask.class);
        
        <span class="hljs-comment">// 3. 加载模板知识</span>
        context.addTemplate(<span class="hljs-string">"base.ftl"</span>);
        
        <span class="hljs-keyword">return</span> context;
    }
    
    <span class="hljs-keyword">public</span> List&lt;SkillAction&gt; <span class="hljs-title function_">getActions</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Arrays.asList(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"create-base-component"</span>, <span class="hljs-string">"创建基础组件"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"initialize-component"</span>, <span class="hljs-string">"初始化组件"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"validate-component"</span>, <span class="hljs-string">"验证组件"</span>)
        );
    }
}
</code></pre>
<p><strong>知识内容</strong>：</p>
<ul>
<li>抽象类定义</li>
<li>初始化方法签名</li>
<li>组件类型枚举</li>
<li>基础生成器模板</li>
</ul>
<h3 data-id="heading-22">3.3 Module Skill 设计</h3>
<p><strong>职责</strong>：提供模块组件的知识和生成能力</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ModuleSkill</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"module"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DESCRIPTION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"模块组件 Skill"</span>;
    
    <span class="hljs-keyword">public</span> SkillContext <span class="hljs-title function_">load</span><span class="hljs-params">()</span> {
        <span class="hljs-type">SkillContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillContext</span>();
        
        <span class="hljs-comment">// 1. 加载 ModuleUIComponent 知识</span>
        context.addClass(ModuleUIComponent.class);
        context.addClass(CustomModuleUIComponent.class);
        
        <span class="hljs-comment">// 2. 加载生命周期方法</span>
        context.addMethod(<span class="hljs-string">"setCurrComponent"</span>);
        context.addMethod(<span class="hljs-string">"findComponentByAlias"</span>);
        
        <span class="hljs-comment">// 3. 加载生成器</span>
        context.addGenerator(GenRepositoryViewJava.class);
        
        <span class="hljs-keyword">return</span> context;
    }
    
    <span class="hljs-keyword">public</span> List&lt;SkillAction&gt; <span class="hljs-title function_">getActions</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Arrays.asList(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"create-module"</span>, <span class="hljs-string">"创建模块"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"bind-component"</span>, <span class="hljs-string">"绑定组件"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"manage-lifecycle"</span>, <span class="hljs-string">"管理生命周期"</span>)
        );
    }
}
</code></pre>
<p><strong>知识内容</strong>：</p>
<ul>
<li>模块类定义</li>
<li>生命周期管理方法</li>
<li>组件查找机制</li>
<li>仓储层生成器</li>
</ul>
<h3 data-id="heading-23">3.4 Component Skill 设计</h3>
<p><strong>职责</strong>：提供具体组件的知识和生成能力</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComponentSkill</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"component"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DESCRIPTION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"组件 Skill"</span>;
    
    <span class="hljs-keyword">public</span> SkillContext <span class="hljs-title function_">load</span><span class="hljs-params">()</span> {
        <span class="hljs-type">SkillContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillContext</span>();
        
        <span class="hljs-comment">// 1. 加载具体组件知识</span>
        context.addClass(NlpGroupUIComponent.class);
        context.addClass(NlpGridUIComponent.class);
        context.addClass(TreeGridUIComponent.class);
        
        <span class="hljs-comment">// 2. 加载组件配置</span>
        context.addConfig(<span class="hljs-string">"group-config"</span>);
        context.addConfig(<span class="hljs-string">"grid-config"</span>);
        
        <span class="hljs-comment">// 3. 加载视图生成器</span>
        context.addGenerator(GenCustomViewJava.class);
        
        <span class="hljs-keyword">return</span> context;
    }
    
    <span class="hljs-keyword">public</span> List&lt;SkillAction&gt; <span class="hljs-title function_">getActions</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Arrays.asList(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"create-group"</span>, <span class="hljs-string">"创建分组组件"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"create-grid"</span>, <span class="hljs-string">"创建网格组件"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"create-tree"</span>, <span class="hljs-string">"创建树形组件"</span>)
        );
    }
}
</code></pre>
<p><strong>知识内容</strong>：</p>
<ul>
<li>具体组件类定义</li>
<li>组件配置模式</li>
<li>视图层生成器</li>
<li>组件间关系</li>
</ul>
<h3 data-id="heading-24">3.5 Metadata Skill 设计</h3>
<p><strong>职责</strong>：提供元数据的知识和生成能力</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetadataSkill</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"metadata"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DESCRIPTION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"元数据 Skill"</span>;
    
    <span class="hljs-keyword">public</span> SkillContext <span class="hljs-title function_">load</span><span class="hljs-params">()</span> {
        <span class="hljs-type">SkillContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillContext</span>();
        
        <span class="hljs-comment">// 1. 加载元数据类</span>
        context.addClass(CustomViewMeta.class);
        context.addClass(CustomDataMeta.class);
        context.addClass(MethodConfig.class);
        
        <span class="hljs-comment">// 2. 加载解析器</span>
        context.addParser(MetadataParser.class);
        
        <span class="hljs-comment">// 3. 加载验证规则</span>
        context.addValidator(MetadataValidator.class);
        
        <span class="hljs-keyword">return</span> context;
    }
    
    <span class="hljs-keyword">public</span> List&lt;SkillAction&gt; <span class="hljs-title function_">getActions</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Arrays.asList(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"parse-metadata"</span>, <span class="hljs-string">"解析元数据"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"validate-metadata"</span>, <span class="hljs-string">"验证元数据"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"generate-code"</span>, <span class="hljs-string">"生成代码"</span>)
        );
    }
}
</code></pre>
<p><strong>知识内容</strong>：</p>
<ul>
<li>元数据类定义</li>
<li>元数据解析器</li>
<li>验证规则</li>
<li>生成规则</li>
</ul>
<h3 data-id="heading-25">3.6 Skill 协作机制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkillOrchestrator</span> {
    
    <span class="hljs-keyword">private</span> Map&lt;String, Skill&gt; skills = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerSkill</span><span class="hljs-params">(Skill skill)</span> {
        skills.put(skill.getName(), skill);
    }
    
    <span class="hljs-keyword">public</span> SkillContext <span class="hljs-title function_">execute</span><span class="hljs-params">(String skillName, Map&lt;String, Object&gt; params)</span> 
            <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-type">Skill</span> <span class="hljs-variable">skill</span> <span class="hljs-operator">=</span> skills.get(skillName);
        <span class="hljs-keyword">if</span> (skill == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(<span class="hljs-string">"Skill 不存在: "</span> + skillName);
        }
        
        <span class="hljs-comment">// 1. 加载 Skill 上下文</span>
        <span class="hljs-type">SkillContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> skill.load();
        
        <span class="hljs-comment">// 2. 应用参数</span>
        context.applyParams(params);
        
        <span class="hljs-comment">// 3. 执行 Skill</span>
        <span class="hljs-type">SkillResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> skill.execute(context);
        
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-keyword">public</span> List&lt;SkillAction&gt; <span class="hljs-title function_">getAllActions</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> skills.values().stream()
                .flatMap(skill -&gt; skill.getActions().stream())
                .collect(Collectors.toList());
    }
}
</code></pre>
<h2 data-id="heading-26">四、Trae Solo Skill 构建实践</h2>
<h3 data-id="heading-27">4.1 Trae Solo 环境配置</h3>
<h4 data-id="heading-28">4.1.1 项目结构</h4>
<pre><code class="hljs language-bash" lang="bash">trae-solo-project/
├── .trae/
│   ├── rules/
│   │   ├── project_rules.md       <span class="hljs-comment"># 项目规则</span>
│   │   └── skill_rules.md        <span class="hljs-comment"># Skill 规则</span>
│   └── skills/
│       ├── foundation-skill.md    <span class="hljs-comment"># Foundation Skill</span>
│       ├── module-skill.md        <span class="hljs-comment"># Module Skill</span>
│       ├── component-skill.md     <span class="hljs-comment"># Component Skill</span>
│       └── metadata-skill.md      <span class="hljs-comment"># Metadata Skill</span>
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── net/ooder/
│   │   │       └── engine/
│   │   │           ├── codegen/    <span class="hljs-comment"># 代码生成器</span>
│   │   │           └── ub/         <span class="hljs-comment"># BridgeCode</span>
│   │   └── resources/
│   │       └── templates/   <span class="hljs-comment"># Freemarker 模板</span>
│   └── <span class="hljs-built_in">test</span>/
│       └── java/
│           └── net/ooder/
│               └── engine/
│                   └── codegen/
└── pom.xml
</code></pre>
<h4 data-id="heading-29">4.1.2 配置文件</h4>
<p><strong>.trae/rules/project_rules.md</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Trae Solo 项目规则</span>

<span class="hljs-section">## 代码生成规则</span>

<span class="hljs-bullet">1.</span> 所有生成的代码必须遵循 Java 编码规范
<span class="hljs-bullet">2.</span> 生成的类必须添加 @Generated 注解
<span class="hljs-bullet">3.</span> 生成的代码必须包含完整的 Javadoc
<span class="hljs-bullet">4.</span> 生成的代码必须通过编译检查

<span class="hljs-section">## Skill 使用规则</span>

<span class="hljs-bullet">1.</span> LLM 必须通过 Skill 访问代码生成知识
<span class="hljs-bullet">2.</span> LLM 不能直接修改生成的代码
<span class="hljs-bullet">3.</span> LLM 必须使用 Skill 提供的 Action
<span class="hljs-bullet">4.</span> LLM 必须遵循 Skill 的执行顺序

<span class="hljs-section">## 质量保证规则</span>

<span class="hljs-bullet">1.</span> 所有生成的代码必须经过单元测试
<span class="hljs-bullet">2.</span> 所有生成的代码必须经过集成测试
<span class="hljs-bullet">3.</span> 所有生成的代码必须经过代码审查
</code></pre>
<p><strong>.trae/rules/skill_rules.md</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Skill 规则</span>

<span class="hljs-section">## Skill 定义规则</span>

<span class="hljs-bullet">1.</span> 每个 Skill 必须定义清晰的职责边界
<span class="hljs-bullet">2.</span> 每个 Skill 必须提供完整的知识内容
<span class="hljs-bullet">3.</span> 每个 Skill 必须定义可执行的 Action
<span class="hljs-bullet">4.</span> 每个 Skill 必须提供使用示例

<span class="hljs-section">## Skill 加载规则</span>

<span class="hljs-bullet">1.</span> Skill 必须支持懒加载
<span class="hljs-bullet">2.</span> Skill 必须支持缓存
<span class="hljs-bullet">3.</span> Skill 必须支持热更新
<span class="hljs-bullet">4.</span> Skill 必须支持版本管理

<span class="hljs-section">## Skill 执行规则</span>

<span class="hljs-bullet">1.</span> Skill 执行必须支持参数传递
<span class="hljs-bullet">2.</span> Skill 执行必须支持上下文管理
<span class="hljs-bullet">3.</span> Skill 执行必须支持错误处理
<span class="hljs-bullet">4.</span> Skill 执行必须支持结果返回
</code></pre>
<h3 data-id="heading-30">4.2 Skill 实现实践</h3>
<h4 data-id="heading-31">4.2.1 Foundation Skill 实现</h4>
<p><strong>.trae/skills/foundation-skill.md</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Foundation Skill</span>

<span class="hljs-section">## 概述</span>

Foundation Skill 提供基础组件的知识和生成能力，是所有其他 Skill 的基础。

<span class="hljs-section">## 知识内容</span>

<span class="hljs-section">### 核心类</span>

<span class="hljs-section">#### NlpBaseUIComponent</span>

<span class="hljs-code">```java
public abstract class NlpBaseUIComponent extends UIComponent {
    
    private String componentType;
    private boolean initialized;
    
    public abstract void initializeFromNaturalLanguage(String naturalLanguage);
    public abstract void initializeFromConfig(Object config);
    
    public String getComponentType() {
        return componentType;
    }
    
    public boolean isInitialized() {
        return initialized;
    }
}
</span></code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>提供组件类型管理</li>
<li>提供初始化状态管理</li>
<li>定义抽象初始化方法</li>
</ul>
<h3 data-id="heading-32">生成器</h3>
<h4 data-id="heading-33">GenJavaTask</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenJavaTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Callable</span>&lt;List&lt;JavaGenSource&gt;&gt; {
    
    <span class="hljs-keyword">protected</span> JavaGenSource javaGen;
    <span class="hljs-keyword">protected</span> CustomViewMeta viewMeta;
    <span class="hljs-keyword">protected</span> String euClassName;
    <span class="hljs-keyword">protected</span> Chrome chrome;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> List&lt;JavaGenSource&gt; <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JDSException;
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>提供统一的生成接口</li>
<li>提供通用的生成工具方法</li>
<li>管理生成上下文</li>
</ul>
<h2 data-id="heading-34">可执行 Action</h2>
<h3 data-id="heading-35">create-base-component</h3>
<p><strong>描述</strong>：创建基础组件</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>componentType</code>：组件类型</li>
<li><code>className</code>：类名</li>
<li><code>packageName</code>：包名</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证参数</li>
<li>创建 NlpBaseUIComponent 子类</li>
<li>生成初始化方法</li>
<li>返回生成的代码</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">用户：创建一个基础组件
LLM：使用 Foundation Skill 的 create-<span class="hljs-keyword">base</span>-component Action
参数：{<span class="hljs-string">"componentType"</span>: <span class="hljs-string">"CUSTOM"</span>, <span class="hljs-string">"className"</span>: <span class="hljs-string">"MyComponent"</span>, <span class="hljs-string">"packageName"</span>: <span class="hljs-string">"net.ooder.example"</span>}
结果：生成 MyComponent.java
</code></pre>
<h3 data-id="heading-36">initialize-component</h3>
<p><strong>描述</strong>：初始化组件</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>component</code>：组件实例</li>
<li><code>config</code>：配置对象</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证配置</li>
<li>调用 initializeFromConfig 方法</li>
<li>设置初始化状态</li>
<li>返回初始化结果</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-json" lang="json">用户：初始化组件
LLM：使用 Foundation Skill 的 initialize-component Action
参数：<span class="hljs-punctuation">{</span><span class="hljs-attr">"component"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"myComponent"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"config"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"FORM"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
结果：组件初始化完成
</code></pre>
<h3 data-id="heading-37">validate-component</h3>
<p><strong>描述</strong>：验证组件</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>component</code>：组件实例</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>检查组件类型</li>
<li>检查初始化状态</li>
<li>检查配置完整性</li>
<li>返回验证结果</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-json" lang="json">用户：验证组件
LLM：使用 Foundation Skill 的 validate-component Action
参数：<span class="hljs-punctuation">{</span><span class="hljs-attr">"component"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"myComponent"</span><span class="hljs-punctuation">}</span>
结果：验证通过
</code></pre>
<h2 data-id="heading-38">使用场景</h2>
<h3 data-id="heading-39">场景 1：创建自定义基础组件</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：创建一个自定义基础组件
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Foundation Skill
<span class="hljs-bullet">2.</span> 调用 create-base-component Action
<span class="hljs-bullet">3.</span> 生成组件代码
<span class="hljs-bullet">4.</span> 返回生成的代码
</code></pre>
<h3 data-id="heading-40">场景 2：初始化现有组件</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：初始化一个现有组件
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Foundation Skill
<span class="hljs-bullet">2.</span> 调用 initialize-component Action
<span class="hljs-bullet">3.</span> 执行初始化逻辑
<span class="hljs-bullet">4.</span> 返回初始化结果
</code></pre>
<h2 data-id="heading-41">最佳实践</h2>
<ol>
<li><strong>优先使用 Foundation Skill</strong>：所有基础操作都应该通过 Foundation Skill 完成</li>
<li><strong>遵循初始化流程</strong>：确保组件正确初始化</li>
<li><strong>验证组件状态</strong>：在执行操作前验证组件状态</li>
<li><strong>处理初始化错误</strong>：提供清晰的错误信息</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">
<span class="hljs-comment">#### 4.2.2 Module Skill 实现</span>

**.trae/skills/module-skill.md**：

```markdown
<span class="hljs-comment"># Module Skill</span>

<span class="hljs-comment">## 概述</span>

Module Skill 提供模块组件的知识和生成能力，管理组件的生命周期和依赖关系。

<span class="hljs-comment">## 知识内容</span>

<span class="hljs-comment">### 核心类</span>

<span class="hljs-comment">#### ModuleUIComponent</span>

```java
public class ModuleUIComponent&lt;M extends UIComponent&gt; extends UIComponent&lt;ModuleProperties, ModuleEventEnum&gt; {
    
    private String className<span class="hljs-comment">;</span>
    private String desc<span class="hljs-comment">;</span>
    private ModuleViewType moduleViewType<span class="hljs-comment">;</span>
    private Map&lt;String, Object&gt; valueMap<span class="hljs-comment">;</span>
    private UIModule UIModule<span class="hljs-comment">;</span>
    private CustomModuleMeta moduleBean<span class="hljs-comment">;</span>
    private MethodConfig methodAPIBean<span class="hljs-comment">;</span>
    private DomainInst domainInst<span class="hljs-comment">;</span>
    private ModuleProperties properties<span class="hljs-comment">;</span>
    private M currComponent<span class="hljs-comment">;</span>
    private UIComponent navUIComponent<span class="hljs-comment">;</span>
    private ModuleViewConfig viewConfig<span class="hljs-comment">;</span>
    private List&lt;String&gt; dependencies<span class="hljs-comment">;</span>
    private List&lt;String&gt; required<span class="hljs-comment">;</span>
    private Map&lt;String, ModuleFunction&gt; functions<span class="hljs-comment">;</span>
    private List&lt;ModuleFormulaInst&gt; formulas<span class="hljs-comment">;</span>
    private Map&lt;String, String&gt; customFunctions<span class="hljs-comment">;</span>
    private String customAppend<span class="hljs-comment">;</span>
    private String afterAppend<span class="hljs-comment">;</span>
    private Map&lt;String, String&gt; moduleVar<span class="hljs-comment">;</span>
    private Map&lt;String, UIComponent&gt; components<span class="hljs-comment">;</span>
    
    public void setCurrComponent(M currComponent) {
        <span class="hljs-attr">this.currComponent</span> = currComponent<span class="hljs-comment">;</span>
        if (currComponent != null) {
            <span class="hljs-attr">this.currComponentAlias</span> = currComponent.getAlias()<span class="hljs-comment">;</span>
            if (currComponent.getParent() == null) {
                currComponent.setParent(this)<span class="hljs-comment">;</span>
            }
            this.components.put(currComponentAlias, currComponent)<span class="hljs-comment">;</span>
            ComponentType <span class="hljs-attr">type</span> = ComponentType.fromType(currComponent.getKey())<span class="hljs-comment">;</span>
            <span class="hljs-attr">moduleViewType</span> = ModuleViewType.getModuleViewByCom(type)<span class="hljs-comment">;</span>
            properties.setCurrComponentAlias(currComponentAlias)<span class="hljs-comment">;</span>
        } else {
            <span class="hljs-attr">this.currComponentAlias</span> = null<span class="hljs-comment">;</span>
            properties.setCurrComponentAlias(null)<span class="hljs-comment">;</span>
        }
    }
    
    public UIComponent findComponentByAlias(String alias) {
        List&lt;UIComponent&gt; <span class="hljs-attr">UIComponentList</span> = this.findComponentsByAlias(alias)<span class="hljs-comment">;</span>
        UIComponent <span class="hljs-attr">UIComponent</span> = null<span class="hljs-comment">;</span>
        if (UIComponentList.size() &gt; 0) {
            <span class="hljs-attr">UIComponent</span> = UIComponentList.get(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
        }
        return UIComponent<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>管理模块生命周期</li>
<li>管理组件依赖</li>
<li>提供组件查找功能</li>
<li>处理模块事件</li>
</ul>
<h3 data-id="heading-42">生成器</h3>
<h4 data-id="heading-43">GenRepositoryViewJava</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenRepositoryViewJava</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenJavaTask</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;JavaGenSource&gt; <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JDSException {
        List&lt;JavaGenSource&gt; sources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-comment">// 1. 生成 VO 接口</span>
        sources.add(generateVOInterface());
        
        <span class="hljs-comment">// 2. 生成 Service 接口</span>
        sources.add(generateServiceInterface());
        
        <span class="hljs-comment">// 3. 生成 Repository 接口</span>
        sources.add(generateRepositoryInterface());
        
        <span class="hljs-comment">// 4. 生成 RepositoryImpl 实现</span>
        sources.add(generateRepositoryImpl());
        
        <span class="hljs-keyword">return</span> sources;
    }
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>生成仓储层代码</li>
<li>生成服务层代码</li>
<li>生成数据访问对象</li>
<li>管理依赖关系</li>
</ul>
<h2 data-id="heading-44">可执行 Action</h2>
<h3 data-id="heading-45">create-module</h3>
<p><strong>描述</strong>：创建模块</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>moduleName</code>：模块名称</li>
<li><code>className</code>：类名</li>
<li><code>packageName</code>：包名</li>
<li><code>components</code>：组件列表</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证参数</li>
<li>创建 ModuleUIComponent 子类</li>
<li>生成仓储层代码</li>
<li>绑定组件</li>
<li>返回生成的代码</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">用户：创建一个模块
LLM：使用 <span class="hljs-keyword">Module</span> Skill 的 <span class="hljs-keyword">create</span><span class="hljs-operator">-</span><span class="hljs-keyword">module</span> Action
参数：{"moduleName": "UserModule", "className": "UserModule", "packageName": "net.ooder.example", "components": ["grid", "form"]}
结果：生成 UserModule.java 和相关仓储代码
</code></pre>
<h3 data-id="heading-46">bind-component</h3>
<p><strong>描述</strong>：绑定组件</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>module</code>：模块实例</li>
<li><code>component</code>：组件实例</li>
<li><code>alias</code>：组件别名</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证模块和组件</li>
<li>调用 setCurrComponent 方法</li>
<li>更新组件依赖</li>
<li>返回绑定结果</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-perl" lang="perl">用户：绑定组件
LLM：使用 Module Skill 的 <span class="hljs-keyword">bind</span>-component Action
参数：{<span class="hljs-string">"module"</span>: <span class="hljs-string">"userModule"</span>, <span class="hljs-string">"component"</span>: <span class="hljs-string">"userGrid"</span>, <span class="hljs-string">"alias"</span>: <span class="hljs-string">"grid"</span>}
结果：组件绑定完成
</code></pre>
<h3 data-id="heading-47">manage-lifecycle</h3>
<p><strong>描述</strong>：管理生命周期</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>module</code>：模块实例</li>
<li><code>action</code>：生命周期动作（init/destroy）</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证模块状态</li>
<li>执行生命周期动作</li>
<li>触发生命周期事件</li>
<li>返回执行结果</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">用户：初始化模块
LLM：使用 <span class="hljs-keyword">Module</span> Skill 的 manage<span class="hljs-operator">-</span>lifecycle Action
参数：{"module": "userModule", "action": "init"}
结果：模块初始化完成
</code></pre>
<h2 data-id="heading-48">使用场景</h2>
<h3 data-id="heading-49">场景 1：创建用户管理模块</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：创建一个用户管理模块
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Module Skill
<span class="hljs-bullet">2.</span> 调用 create-module Action
<span class="hljs-bullet">3.</span> 生成模块代码和仓储代码
<span class="hljs-bullet">4.</span> 返回生成的代码
</code></pre>
<h3 data-id="heading-50">场景 2：绑定网格组件到模块</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：绑定网格组件到模块
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Module Skill
<span class="hljs-bullet">2.</span> 调用 bind-component Action
<span class="hljs-bullet">3.</span> 执行绑定逻辑
<span class="hljs-bullet">4.</span> 返回绑定结果
</code></pre>
<h2 data-id="heading-51">最佳实践</h2>
<ol>
<li><strong>使用模块化设计</strong>：将功能分解为独立的模块</li>
<li><strong>管理组件依赖</strong>：明确组件之间的依赖关系</li>
<li><strong>实现生命周期管理</strong>：提供完整的生命周期支持</li>
<li><strong>使用仓储模式</strong>：分离数据访问逻辑</li>
</ol>
<pre><code class="hljs language-scala" lang="scala">
#### <span class="hljs-number">4.2</span><span class="hljs-number">.3</span> <span class="hljs-type">Component</span> <span class="hljs-type">Skill</span> 实现

**.trae/skills/component-skill.md**：

```markdown
# <span class="hljs-type">Component</span> <span class="hljs-type">Skill</span>

## 概述

<span class="hljs-type">Component</span> <span class="hljs-type">Skill</span> 提供具体组件的知识和生成能力，包括分组组件、网格组件、树形组件等。

## 知识内容

### 核心类

#### <span class="hljs-type">NlpGroupUIComponent</span>

```java
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NlpGroupUIComponent&lt;M</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CustomFieldGroupUIComponent&gt;</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CustomModuleUIComponent&lt;M&gt;</span> </span>{
    
    void init(<span class="hljs-type">MethodConfig</span> methodConfig) <span class="hljs-keyword">throws</span> <span class="hljs-type">JDSException</span> {
        <span class="hljs-type">CustomGroupFormViewMeta</span> viewBean = (<span class="hljs-type">CustomGroupFormViewMeta</span>) methodConfig.getView();
        <span class="hljs-type">CustomGroupDataMeta</span> dataBean = (<span class="hljs-type">CustomGroupDataMeta</span>) methodConfig.getDataBean();
        <span class="hljs-keyword">if</span> (dataBean != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">this</span>.dataUrl = dataBean.getDataUrl();
            <span class="hljs-keyword">this</span>.saveUrl = dataBean.getSaveUrl();
            <span class="hljs-keyword">this</span>.searchUrl = dataBean.getSearchUrl();
            <span class="hljs-keyword">this</span>.reSetUrl = dataBean.getReSetUrl();
        }
        <span class="hljs-type">CustomFieldGroupUIComponent</span> currComponent = <span class="hljs-keyword">new</span> <span class="hljs-type">CustomFieldGroupUIComponent</span>(<span class="hljs-type">UIModule</span>, methodConfig, valueMap);
        <span class="hljs-keyword">this</span>.addChildLayoutNav(currComponent);
        <span class="hljs-keyword">this</span>.setCurrComponent((<span class="hljs-type">M</span>) currComponent);
        
        <span class="hljs-keyword">this</span>.fillAction(viewBean);
        <span class="hljs-keyword">this</span>.fillToolBar(viewBean.getToolBar(), currComponent);
        <span class="hljs-keyword">this</span>.fillContextAction(viewBean.getContextMenuBean(), currComponent);
        
        <span class="hljs-keyword">if</span> (viewBean.getOnReady() != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">ModuleOnReadyEventEnum</span> eventEnum : viewBean.getOnReady()) {
                <span class="hljs-keyword">this</span>.addModuleEvent(eventEnum);
            }
        }
        
        <span class="hljs-keyword">if</span> (viewBean.getOnDestroy() != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">CustomOnDestroyEventEnum</span> eventEnum : viewBean.getOnDestroy()) {
                <span class="hljs-keyword">this</span>.addModuleEvent(eventEnum);
            }
        }
    }
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>管理分组字段</li>
<li>处理分组事件</li>
<li>生成 API 调用</li>
<li>管理工具栏和上下文菜单</li>
</ul>
<h4 data-id="heading-52">NlpGridUIComponent</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NlpGridUIComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CustomGridUIComponent</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NlpGridUIComponent</span><span class="hljs-params">(MethodConfig methodConfig)</span> {
        <span class="hljs-built_in">super</span>();
        <span class="hljs-type">CustomGridViewMeta</span> <span class="hljs-variable">viewBean</span> <span class="hljs-operator">=</span> (CustomGridViewMeta) methodConfig.getView();
        init(viewBean);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NlpGridUIComponent</span><span class="hljs-params">(CustomGridViewMeta viewBean)</span> {
        <span class="hljs-built_in">super</span>();
        init(viewBean);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(CustomGridViewMeta viewBean)</span> {
        <span class="hljs-built_in">this</span>.setProperties(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassGridProperties</span>(viewBean));
        <span class="hljs-built_in">this</span>.setAlias(viewBean.getName());
    }
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>管理网格数据</li>
<li>处理网格事件</li>
<li>提供网格交互</li>
<li>支持分页和排序</li>
</ul>
<h3 data-id="heading-53">生成器</h3>
<h4 data-id="heading-54">GenCustomViewJava</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenCustomViewJava</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenJavaTask</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;JavaGenSource&gt; <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JDSException {
        List&lt;JavaGenSource&gt; sources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-comment">// 1. 生成视图类</span>
        sources.add(generateViewClass());
        
        <span class="hljs-comment">// 2. 生成字段配置</span>
        sources.add(generateFieldConfigs());
        
        <span class="hljs-comment">// 3. 生成事件处理器</span>
        sources.add(generateEventHandlers());
        
        <span class="hljs-keyword">return</span> sources;
    }
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>生成视图层代码</li>
<li>生成字段配置</li>
<li>生成事件处理器</li>
<li>管理视图依赖</li>
</ul>
<h2 data-id="heading-55">可执行 Action</h2>
<h3 data-id="heading-56">create-group</h3>
<p><strong>描述</strong>：创建分组组件</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>groupName</code>：分组名称</li>
<li><code>fields</code>：字段列表</li>
<li><code>events</code>：事件列表</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证参数</li>
<li>创建 NlpGroupUIComponent 实例</li>
<li>生成视图代码</li>
<li>生成仓储代码</li>
<li>返回生成的代码</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">用户：创建一个分组组件
LLM：使用 Component Skill 的 <span class="hljs-keyword">create</span><span class="hljs-operator">-</span><span class="hljs-keyword">group</span> Action
参数：{"groupName": "UserGroup", "fields": [...], "events": [...]}
结果：生成 UserGroup.java 和相关代码
</code></pre>
<h3 data-id="heading-57">create-grid</h3>
<p><strong>描述</strong>：创建网格组件</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>gridName</code>：网格名称</li>
<li><code>columns</code>：列配置</li>
<li><code>dataUrl</code>：数据 URL</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证参数</li>
<li>创建 NlpGridUIComponent 实例</li>
<li>生成视图代码</li>
<li>生成仓储代码</li>
<li>返回生成的代码</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-css" lang="css">用户：创建一个网格组件
LLM：使用 Component Skill 的 create-<span class="hljs-attribute">grid</span> Action
参数：{"gridName": <span class="hljs-string">"UserGrid"</span>, <span class="hljs-string">"columns"</span>: [...], <span class="hljs-string">"dataUrl"</span>: <span class="hljs-string">"/api/users"</span>}
结果：生成 UserGrid<span class="hljs-selector-class">.java</span> 和相关代码
</code></pre>
<h3 data-id="heading-58">create-tree</h3>
<p><strong>描述</strong>：创建树形组件</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>treeName</code>：树形名称</li>
<li><code>treeField</code>：树字段</li>
<li><code>parentField</code>：父字段</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证参数</li>
<li>创建 TreeGridUIComponent 实例</li>
<li>生成视图代码</li>
<li>生成仓储代码</li>
<li>返回生成的代码</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-lua" lang="lua">用户：创建一个树形组件
LLM：使用 Component Skill 的 <span class="hljs-built_in">create</span>-tree Action
参数：{<span class="hljs-string">"treeName"</span>: <span class="hljs-string">"DepartmentTree"</span>, <span class="hljs-string">"treeField"</span>: <span class="hljs-string">"id"</span>, <span class="hljs-string">"parentField"</span>: <span class="hljs-string">"parentId"</span>}
结果：生成 DepartmentTree.java 和相关代码
</code></pre>
<h2 data-id="heading-59">使用场景</h2>
<h3 data-id="heading-60">场景 1：创建用户分组表单</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：创建一个用户分组表单
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Component Skill
<span class="hljs-bullet">2.</span> 调用 create-group Action
<span class="hljs-bullet">3.</span> 生成分组组件代码
<span class="hljs-bullet">4.</span> 返回生成的代码
</code></pre>
<h3 data-id="heading-61">场景 2：创建用户数据网格</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：创建一个用户数据网格
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Component Skill
<span class="hljs-bullet">2.</span> 调用 create-grid Action
<span class="hljs-bullet">3.</span> 生成网格组件代码
<span class="hljs-bullet">4.</span> 返回生成的代码
</code></pre>
<h2 data-id="heading-62">最佳实践</h2>
<ol>
<li><strong>选择合适的组件类型</strong>：根据需求选择分组、网格或树形组件</li>
<li><strong>配置字段和列</strong>：合理配置字段和列属性</li>
<li><strong>处理事件和交互</strong>：实现必要的事件处理和交互逻辑</li>
<li><strong>优化性能</strong>：使用分页、懒加载等优化技术</li>
</ol>
<pre><code class="hljs language-scala" lang="scala">
#### <span class="hljs-number">4.2</span><span class="hljs-number">.4</span> <span class="hljs-type">Metadata</span> <span class="hljs-type">Skill</span> 实现

**.trae/skills/metadata-skill.md**：

```markdown
# <span class="hljs-type">Metadata</span> <span class="hljs-type">Skill</span>

## 概述

<span class="hljs-type">Metadata</span> <span class="hljs-type">Skill</span> 提供元数据的知识和生成能力，包括元数据解析、验证和代码生成。

## 知识内容

### 核心类

#### <span class="hljs-type">CustomViewMeta</span>

```java
public <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomViewMeta&lt;F</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FieldFormConfig</span>, <span class="hljs-title">I</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UIItem</span>, <span class="hljs-title">C</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UIComponent&gt;</span> </span>{
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> caption;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> desc;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> methodName;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> domainId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> sourceClassName;
    <span class="hljs-keyword">private</span> <span class="hljs-type">ModuleViewType</span> moduleViewType;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">F</span>&gt; allFields;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">F</span>&gt; fields;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">Event</span>&gt; events;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">MenuItem</span>&gt; menus;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">ToolBar</span>&gt; toolBars;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">BottomBar</span>&gt; bottomBars;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">ContextMenu</span>&gt; contextMenus;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">ModuleFormulaInst</span>&gt; formulas;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">CustomBean</span>&gt; annotationBeans;
    
    public <span class="hljs-keyword">abstract</span> <span class="hljs-type">F</span> createFieldConfig();
    public <span class="hljs-keyword">abstract</span> <span class="hljs-type">I</span> createUIItem();
    public <span class="hljs-keyword">abstract</span> <span class="hljs-type">C</span> createUIComponent();
    
    public <span class="hljs-type">List</span>&lt;<span class="hljs-type">CustomBean</span>&gt; getAnnotationBeans() {
        <span class="hljs-type">List</span>&lt;<span class="hljs-type">CustomBean</span>&gt; annotationBeans = <span class="hljs-keyword">new</span> <span class="hljs-type">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getModuleBean() != <span class="hljs-literal">null</span>) {
            annotationBeans.addAll(<span class="hljs-keyword">this</span>.getModuleBean().getAnnotationBeans());
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getDataBean() != <span class="hljs-literal">null</span>) {
            annotationBeans.add(<span class="hljs-keyword">this</span>.getDataBean());
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getFieldAggConfig() != <span class="hljs-literal">null</span>) {
            annotationBeans.addAll(<span class="hljs-keyword">this</span>.getFieldAggConfig().getAnnotationBeans());
        }
        <span class="hljs-keyword">return</span> annotationBeans;
    }
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>存储视图配置信息</li>
<li>管理字段和事件</li>
<li>支持视图的动态更新</li>
<li>提供注解信息</li>
</ul>
<h4 data-id="heading-63">CustomDataMeta</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomDataMeta</span> {
    
    <span class="hljs-keyword">private</span> String dataUrl;
    <span class="hljs-keyword">private</span> String editorPath;
    <span class="hljs-keyword">private</span> String addPath;
    <span class="hljs-keyword">private</span> String delPath;
    <span class="hljs-keyword">private</span> String sortPath;
    <span class="hljs-keyword">private</span> String saveRowPath;
    <span class="hljs-keyword">private</span> String saveAllRowPath;
    <span class="hljs-keyword">private</span> String searchUrl;
    <span class="hljs-keyword">private</span> String reloadUrl;
    <span class="hljs-keyword">private</span> String selectUrl;
    <span class="hljs-keyword">private</span> String unSelectUrl;
    <span class="hljs-keyword">private</span> String selectAllUrl;
    <span class="hljs-keyword">private</span> String unSelectAllUrl;
    <span class="hljs-keyword">private</span> String exportUrl;
    <span class="hljs-keyword">private</span> String importUrl;
    <span class="hljs-keyword">private</span> String customUrl;
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>存储数据配置信息</li>
<li>管理数据 URL 和路径</li>
<li>支持数据的动态配置</li>
<li>提供数据访问接口</li>
</ul>
<h4 data-id="heading-64">MethodConfig</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodConfig</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CustomViewMeta</span>, K <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CustomDataMeta</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparable</span>&lt;MethodConfig&gt; {
    
    <span class="hljs-keyword">private</span> String className;
    <span class="hljs-keyword">private</span> String desc;
    <span class="hljs-keyword">private</span> ModuleViewType moduleViewType;
    <span class="hljs-keyword">private</span> UIModule UIModule;
    <span class="hljs-keyword">private</span> CustomModuleMeta moduleBean;
    <span class="hljs-keyword">private</span> MethodConfig methodAPIBean;
    <span class="hljs-keyword">private</span> DomainInst domainInst;
    <span class="hljs-keyword">private</span> T view;
    <span class="hljs-keyword">private</span> K dataBean;
    <span class="hljs-keyword">private</span> BridgeClass bridgeClass;
    <span class="hljs-keyword">private</span> BridgeClass parentClass;
    <span class="hljs-keyword">private</span> String url;
    <span class="hljs-keyword">private</span> String caption;
    <span class="hljs-keyword">private</span> String methodName;
    <span class="hljs-keyword">private</span> String expression;
    <span class="hljs-keyword">private</span> String filter;
    <span class="hljs-keyword">private</span> String itemsExpression;
    <span class="hljs-keyword">private</span> String metaInfo;
    <span class="hljs-keyword">private</span> String fieldInfo;
    <span class="hljs-keyword">private</span> RequestMappingBean requestMapping;
    <span class="hljs-keyword">private</span> RequestBodyBean requestBody;
    <span class="hljs-keyword">private</span> Set&lt;RequestParamBean&gt; paramSet;
    <span class="hljs-keyword">private</span> RouteMenuMeta routeMenuBean;
    <span class="hljs-keyword">private</span> FieldAggConfig fieldAggConfig;
    <span class="hljs-keyword">private</span> CustomFieldMeta FieldMeta;
    <span class="hljs-keyword">private</span> RefBean refBean;
    <span class="hljs-keyword">private</span> CustomAPICallMeta api;
    <span class="hljs-keyword">private</span> List&lt;CustomBean&gt; annotationBeans;
    
    <span class="hljs-keyword">public</span> List&lt;CustomBean&gt; <span class="hljs-title function_">getAnnotationBeans</span><span class="hljs-params">()</span> {
        List&lt;CustomBean&gt; annotationBeans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getApi() != <span class="hljs-literal">null</span>) {
            annotationBeans.addAll(<span class="hljs-built_in">this</span>.getApi().getAnnotationBeans());
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isModule()) {
            annotationBeans.addAll(<span class="hljs-built_in">this</span>.getModuleBean().getAnnotationBeans());
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getDataBean() != <span class="hljs-literal">null</span>) {
                annotationBeans.add(<span class="hljs-built_in">this</span>.getDataBean());
            }
        }
        <span class="hljs-keyword">if</span> (routeMenuBean != <span class="hljs-literal">null</span>) {
            annotationBeans.add(routeMenuBean);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getFieldAggConfig() != <span class="hljs-literal">null</span>) {
            List&lt;CustomBean&gt; FieldMetas = <span class="hljs-built_in">this</span>.getFieldAggConfig().getAnnotationBeans();
            <span class="hljs-keyword">for</span> (CustomBean customBean : FieldMetas) {
                <span class="hljs-keyword">if</span> (!annotationBeans.contains(customBean)) {
                    annotationBeans.add(customBean);
                }
            }
        }
        <span class="hljs-keyword">if</span> (requestMapping != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">this</span>.getPublicMethod()) {
            annotationBeans.add(requestMapping);
        }
        <span class="hljs-keyword">if</span> (getResponseBody() || api != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (!annotationBeans.contains(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleCustomBean</span>(ResponseBody.class))) {
                annotationBeans.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleCustomBean</span>(ResponseBody.class));
            }
        }
        <span class="hljs-keyword">return</span> annotationBeans;
    }
    
    <span class="hljs-meta">@JSONField(serialize = false)</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMetaInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getMethod() != <span class="hljs-literal">null</span>) {
            List&lt;RequestParamBean&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(<span class="hljs-built_in">this</span>.getParamSet());
            
            <span class="hljs-keyword">if</span> (isModule() &amp;&amp; parentEuPackage != <span class="hljs-literal">null</span>) {
                <span class="hljs-type">String</span> <span class="hljs-variable">euClassName</span> <span class="hljs-operator">=</span> parentEuPackage + <span class="hljs-string">"."</span> + getJavaSimpleName();
                <span class="hljs-built_in">this</span>.metaInfo = MethodUtil.toMethodStr(<span class="hljs-built_in">this</span>.getMethod(), 
                    getViewType(), euClassName, requestBody, params).toString();
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-built_in">this</span>.metaInfo = MethodUtil.toMethodStr(<span class="hljs-built_in">this</span>.getMethod(), 
                    getViewType(), getJavaSimpleName(), requestBody, params).toString();
            }
        }
        <span class="hljs-keyword">return</span> metaInfo;
    }
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>管理方法的元数据</li>
<li>连接业务方法和 UI 组件</li>
<li>提供注解信息</li>
<li>生成方法签名</li>
</ul>
<h2 data-id="heading-65">可执行 Action</h2>
<h3 data-id="heading-66">parse-metadata</h3>
<p><strong>描述</strong>：解析元数据</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>source</code>：元数据源（JSON/注解）</li>
<li><code>type</code>：元数据类型</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证源格式</li>
<li>解析元数据</li>
<li>验证元数据完整性</li>
<li>返回解析结果</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-swift" lang="swift">用户：解析元数据
<span class="hljs-type">LLM：使用</span> <span class="hljs-type">Metadata</span> <span class="hljs-type">Skill</span> 的 parse<span class="hljs-operator">-</span>metadata <span class="hljs-type">Action</span>
参数：{<span class="hljs-string">"source"</span>: <span class="hljs-string">"{<span class="hljs-subst">\"</span>viewClassName<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>UserView<span class="hljs-subst">\"</span>, ...}"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"json"</span>}
结果：返回 <span class="hljs-type">MethodConfig</span> 对象
</code></pre>
<h3 data-id="heading-67">validate-metadata</h3>
<p><strong>描述</strong>：验证元数据</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>metadata</code>：元数据对象</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证必填字段</li>
<li>验证字段类型</li>
<li>验证引用关系</li>
<li>返回验证结果</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-json" lang="json">用户：验证元数据
LLM：使用 Metadata Skill 的 validate-metadata Action
参数：<span class="hljs-punctuation">{</span><span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> methodConfig<span class="hljs-punctuation">}</span>
结果：验证通过
</code></pre>
<h3 data-id="heading-68">generate-code</h3>
<p><strong>描述</strong>：生成代码</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>metadata</code>：元数据对象</li>
<li><code>type</code>：代码类型</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>选择生成器</li>
<li>执行代码生成</li>
<li>编译生成的代码</li>
<li>返回生成的代码</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-css" lang="css">用户：生成代码
LLM：使用 Metadata Skill 的 generate-<span class="hljs-selector-tag">code</span> Action
参数：{"metadata": methodConfig, <span class="hljs-string">"type"</span>: <span class="hljs-string">"view"</span>}
结果：生成视图代码和仓储代码
</code></pre>
<h2 data-id="heading-69">使用场景</h2>
<h3 data-id="heading-70">场景 1：从 JSON 解析元数据</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：从 JSON 解析元数据
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Metadata Skill
<span class="hljs-bullet">2.</span> 调用 parse-metadata Action
<span class="hljs-bullet">3.</span> 解析 JSON 配置
<span class="hljs-bullet">4.</span> 返回 MethodConfig 对象
</code></pre>
<h3 data-id="heading-71">场景 2：生成组件代码</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：生成组件代码
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Metadata Skill
<span class="hljs-bullet">2.</span> 调用 generate-code Action
<span class="hljs-bullet">3.</span> 生成视图代码和仓储代码
<span class="hljs-bullet">4.</span> 返回生成的代码
</code></pre>
<h2 data-id="heading-72">最佳实践</h2>
<ol>
<li><strong>使用元数据驱动</strong>：通过元数据配置生成代码</li>
<li><strong>验证元数据完整性</strong>：确保元数据配置正确</li>
<li><strong>选择合适的代码类型</strong>：根据需求选择生成的代码类型</li>
<li><strong>优化生成性能</strong>：使用缓存和并行生成</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">
### <span class="hljs-number">4.3</span> Skill 集成实现

#### <span class="hljs-number">4.3</span><span class="hljs-number">.1</span> Skill Loader 实现

```java
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkillLoader</span> {
    
    <span class="hljs-keyword">private</span> Map&lt;<span class="hljs-type">String</span>, Skill&gt; skillCache = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;();
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> Skill <span class="hljs-title">loadSkill</span><span class="hljs-params">(<span class="hljs-type">String</span> skillName)</span> throws JDSException </span>{
        <span class="hljs-comment">// 1. 检查缓存</span>
        Skill cachedSkill = skillCache.<span class="hljs-built_in">get</span>(skillName);
        <span class="hljs-keyword">if</span> (cachedSkill != null) {
            <span class="hljs-keyword">return</span> cachedSkill;
        }
        
        <span class="hljs-comment">// 2. 加载 Skill 定义</span>
        <span class="hljs-type">String</span> skillPath = <span class="hljs-string">".trae/skills/"</span> + skillName + <span class="hljs-string">"-skill.md"</span>;
        <span class="hljs-type">String</span> skillContent = <span class="hljs-built_in">readFile</span>(skillPath);
        
        <span class="hljs-comment">// 3. 解析 Skill 定义</span>
        Skill skill = <span class="hljs-built_in">parseSkillDefinition</span>(skillContent);
        
        <span class="hljs-comment">// 4. 缓存 Skill</span>
        skillCache.<span class="hljs-built_in">put</span>(skillName, skill);
        
        <span class="hljs-keyword">return</span> skill;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">invalidateSkill</span><span class="hljs-params">(<span class="hljs-type">String</span> skillName)</span> </span>{
        skillCache.<span class="hljs-built_in">remove</span>(skillName);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;<span class="hljs-type">String</span>&gt; <span class="hljs-title">getAvailableSkills</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-built_in">File</span> skillsDir = <span class="hljs-keyword">new</span> <span class="hljs-built_in">File</span>(<span class="hljs-string">".trae/skills"</span>);
        <span class="hljs-built_in">File</span>[] skillFiles = skillsDir.<span class="hljs-built_in">listFiles</span>((dir, name) -&gt; 
            name.<span class="hljs-built_in">endsWith</span>(<span class="hljs-string">"-skill.md"</span>));
        
        <span class="hljs-keyword">return</span> Arrays.<span class="hljs-built_in">stream</span>(skillFiles)
                .<span class="hljs-built_in">map</span>(<span class="hljs-built_in">File</span>::getName)
                .<span class="hljs-built_in">map</span>(name -&gt; name.<span class="hljs-built_in">replace</span>(<span class="hljs-string">"-skill.md"</span>, <span class="hljs-string">""</span>))
                .<span class="hljs-built_in">collect</span>(Collectors.<span class="hljs-built_in">toList</span>());
    }
}
</code></pre>
<h4 data-id="heading-73">4.3.2 Skill Context 实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkillContext</span> {
    
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> List&lt;String&gt; loadedClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> List&lt;String&gt; loadedGenerators = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> List&lt;String&gt; loadedTemplates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addClass</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> clazz.getName();
        <span class="hljs-keyword">if</span> (!loadedClasses.contains(className)) {
            loadedClasses.add(className);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addGenerator</span><span class="hljs-params">(Class&lt;?&gt; generator)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">generatorName</span> <span class="hljs-operator">=</span> generator.getName();
        <span class="hljs-keyword">if</span> (!loadedGenerators.contains(generatorName)) {
            loadedGenerators.add(generatorName);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTemplate</span><span class="hljs-params">(String templateName)</span> {
        <span class="hljs-keyword">if</span> (!loadedTemplates.contains(templateName)) {
            loadedTemplates.add(templateName);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyParams</span><span class="hljs-params">(Map&lt;String, Object&gt; params)</span> {
        <span class="hljs-keyword">if</span> (params != <span class="hljs-literal">null</span>) {
            data.putAll(params);
        }
    }
    
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getParam</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">return</span> data.get(key);
    }
    
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getLoadedClasses</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(loadedClasses);
    }
    
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getLoadedGenerators</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(loadedGenerators);
    }
    
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getLoadedTemplates</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(loadedTemplates);
    }
}
</code></pre>
<h4 data-id="heading-74">4.3.3 LLM 集成示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMIntegration</span> {
    
    <span class="hljs-keyword">private</span> SkillOrchestrator orchestrator;
    <span class="hljs-keyword">private</span> SkillLoader skillLoader;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LLMIntegration</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.skillLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillLoader</span>();
        <span class="hljs-built_in">this</span>.orchestrator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillOrchestrator</span>();
        
        <span class="hljs-comment">// 注册所有 Skill</span>
        registerSkills();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerSkills</span><span class="hljs-params">()</span> {
        orchestrator.registerSkill(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FoundationSkill</span>());
        orchestrator.registerSkill(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleSkill</span>());
        orchestrator.registerSkill(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentSkill</span>());
        orchestrator.registerSkill(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MetadataSkill</span>());
    }
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">processUserRequest</span><span class="hljs-params">(String userRequest)</span> <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-comment">// 1. 分析用户请求</span>
        <span class="hljs-type">RequestAnalysis</span> <span class="hljs-variable">analysis</span> <span class="hljs-operator">=</span> analyzeRequest(userRequest);
        
        <span class="hljs-comment">// 2. 选择合适的 Skill</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">skillName</span> <span class="hljs-operator">=</span> selectSkill(analysis);
        
        <span class="hljs-comment">// 3. 准备参数</span>
        Map&lt;String, Object&gt; params = prepareParams(analysis);
        
        <span class="hljs-comment">// 4. 执行 Skill</span>
        <span class="hljs-type">SkillResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> orchestrator.execute(skillName, params);
        
        <span class="hljs-comment">// 5. 返回结果</span>
        <span class="hljs-keyword">return</span> formatResult(result);
    }
    
    <span class="hljs-keyword">private</span> RequestAnalysis <span class="hljs-title function_">analyzeRequest</span><span class="hljs-params">(String userRequest)</span> {
        <span class="hljs-type">RequestAnalysis</span> <span class="hljs-variable">analysis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestAnalysis</span>();
        
        <span class="hljs-comment">// 分析请求类型</span>
        <span class="hljs-keyword">if</span> (userRequest.contains(<span class="hljs-string">"创建"</span>) &amp;&amp; userRequest.contains(<span class="hljs-string">"基础组件"</span>)) {
            analysis.setSkillName(<span class="hljs-string">"foundation"</span>);
            analysis.setActionName(<span class="hljs-string">"create-base-component"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userRequest.contains(<span class="hljs-string">"创建"</span>) &amp;&amp; userRequest.contains(<span class="hljs-string">"模块"</span>)) {
            analysis.setSkillName(<span class="hljs-string">"module"</span>);
            analysis.setActionName(<span class="hljs-string">"create-module"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userRequest.contains(<span class="hljs-string">"创建"</span>) &amp;&amp; userRequest.contains(<span class="hljs-string">"网格"</span>)) {
            analysis.setSkillName(<span class="hljs-string">"component"</span>);
            analysis.setActionName(<span class="hljs-string">"create-grid"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userRequest.contains(<span class="hljs-string">"解析"</span>) &amp;&amp; userRequest.contains(<span class="hljs-string">"元数据"</span>)) {
            analysis.setSkillName(<span class="hljs-string">"metadata"</span>);
            analysis.setActionName(<span class="hljs-string">"parse-metadata"</span>);
        }
        
        <span class="hljs-keyword">return</span> analysis;
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">selectSkill</span><span class="hljs-params">(RequestAnalysis analysis)</span> {
        <span class="hljs-keyword">return</span> analysis.getSkillName();
    }
    
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; <span class="hljs-title function_">prepareParams</span><span class="hljs-params">(RequestAnalysis analysis)</span> {
        Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-comment">// 从用户请求中提取参数</span>
        <span class="hljs-comment">// ...</span>
        
        <span class="hljs-keyword">return</span> params;
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatResult</span><span class="hljs-params">(SkillResult result)</span> {
        <span class="hljs-comment">// 格式化结果</span>
        <span class="hljs-keyword">return</span> result.toString();
    }
}
</code></pre>
<h3 data-id="heading-75">4.4 实战案例</h3>
<h4 data-id="heading-76">4.4.1 案例 1：创建用户管理模块</h4>
<p><strong>用户请求</strong>：</p>
<pre><code class="hljs">创建一个用户管理模块，包含用户列表网格和用户编辑表单
</code></pre>
<p><strong>LLM 处理流程</strong>：</p>
<ol>
<li>
<p><strong>分析请求</strong>：</p>
<ul>
<li>识别为创建模块请求</li>
<li>选择 Module Skill</li>
</ul>
</li>
<li>
<p><strong>执行 Skill</strong>：</p>
<ul>
<li>调用 create-module Action</li>
<li>生成模块代码</li>
</ul>
</li>
<li>
<p><strong>生成组件</strong>：</p>
<ul>
<li>调用 Component Skill 的 create-grid Action</li>
<li>生成用户网格代码</li>
<li>调用 Component Skill 的 create-group Action</li>
<li>生成分组表单代码</li>
</ul>
</li>
<li>
<p><strong>生成仓储</strong>：</p>
<ul>
<li>调用 Metadata Skill 的 generate-code Action</li>
<li>生成仓储代码</li>
</ul>
</li>
<li>
<p><strong>返回结果</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">已成功创建用户管理模块：
<span class="hljs-deletion">- UserModule.java</span>
<span class="hljs-deletion">- UserGrid.java</span>
<span class="hljs-deletion">- UserForm.java</span>
<span class="hljs-deletion">- UserRepository.java</span>
<span class="hljs-deletion">- UserService.java</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-77">4.4.2 案例 2：从 JSON 配置生成代码</h4>
<p><strong>用户请求</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">从以下 <span class="hljs-title class_">JSON</span> 配置生成代码：
{
  <span class="hljs-string">"viewClassName"</span>: <span class="hljs-string">"net.ooder.example.UserTableView"</span>,
  <span class="hljs-string">"moduleViewType"</span>: <span class="hljs-string">"GRIDCONFIG"</span>,
  <span class="hljs-string">"fields"</span>: [
    {<span class="hljs-string">"fieldname"</span>: <span class="hljs-string">"id"</span>, <span class="hljs-string">"caption"</span>: <span class="hljs-string">"ID"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"input"</span>, <span class="hljs-string">"editable"</span>: <span class="hljs-literal">false</span>},
    {<span class="hljs-string">"fieldname"</span>: <span class="hljs-string">"name"</span>, <span class="hljs-string">"caption"</span>: <span class="hljs-string">"姓名"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"input"</span>, <span class="hljs-string">"editable"</span>: <span class="hljs-literal">true</span>},
    {<span class="hljs-string">"fieldname"</span>: <span class="hljs-string">"age"</span>, <span class="hljs-string">"caption"</span>: <span class="hljs-string">"年龄"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"number"</span>, <span class="hljs-string">"editable"</span>: <span class="hljs-literal">true</span>}
  ]
}
</code></pre>
<p><strong>LLM 处理流程</strong>：</p>
<ol>
<li>
<p><strong>分析请求</strong>：</p>
<ul>
<li>识别为元数据解析请求</li>
<li>选择 Metadata Skill</li>
</ul>
</li>
<li>
<p><strong>解析元数据</strong>：</p>
<ul>
<li>调用 parse-metadata Action</li>
<li>解析 JSON 配置</li>
<li>生成 MethodConfig 对象</li>
</ul>
</li>
<li>
<p><strong>生成代码</strong>：</p>
<ul>
<li>调用 generate-code Action</li>
<li>生成视图代码</li>
<li>生成仓储代码</li>
</ul>
</li>
<li>
<p><strong>编译代码</strong>：</p>
<ul>
<li>调用动态编译</li>
<li>生成类文件</li>
</ul>
</li>
<li>
<p><strong>返回结果</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">已成功生成代码：
<span class="hljs-deletion">- UserTableView.java</span>
<span class="hljs-deletion">- UserRepository.java</span>
<span class="hljs-deletion">- UserService.java</span>
编译成功
</code></pre>
</li>
</ol>
<h4 data-id="heading-78">4.4.3 案例 3：创建树形组织结构</h4>
<p><strong>用户请求</strong>：</p>
<pre><code class="hljs">创建一个部门树形组件，显示组织结构
</code></pre>
<p><strong>LLM 处理流程</strong>：</p>
<ol>
<li>
<p><strong>分析请求</strong>：</p>
<ul>
<li>识别为创建树形组件请求</li>
<li>选择 Component Skill</li>
</ul>
</li>
<li>
<p><strong>执行 Skill</strong>：</p>
<ul>
<li>调用 create-tree Action</li>
<li>生成树形组件代码</li>
</ul>
</li>
<li>
<p><strong>生成仓储</strong>：</p>
<ul>
<li>调用 Metadata Skill 的 generate-code Action</li>
<li>生成仓储代码</li>
</ul>
</li>
<li>
<p><strong>返回结果</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">已成功创建部门树形组件：
<span class="hljs-deletion">- DepartmentTree.java</span>
<span class="hljs-deletion">- DepartmentRepository.java</span>
<span class="hljs-deletion">- DepartmentService.java</span>
</code></pre>
</li>
</ol>
<h2 data-id="heading-79">五、总结与展望</h2>
<h3 data-id="heading-80">5.1 关键成果</h3>
<h4 data-id="heading-81">5.1.1 BridgeCode 设计成果</h4>
<ol>
<li>
<p><strong>元数据驱动架构</strong>：</p>
<ul>
<li>实现了配置与实现的完全解耦</li>
<li>支持多种配置方式（JSON/注解）</li>
<li>提供了灵活的扩展能力</li>
</ul>
</li>
<li>
<p><strong>分层生成系统</strong>：</p>
<ul>
<li>视图层、仓储层、聚合层三层生成</li>
<li>31 个生成器覆盖所有场景</li>
<li>支持增量构建和并行生成</li>
</ul>
</li>
<li>
<p><strong>动态编译机制</strong>：</p>
<ul>
<li>运行时编译生成的代码</li>
<li>支持热更新和替换</li>
<li>提供了完整的生命周期管理</li>
</ul>
</li>
</ol>
<h4 data-id="heading-82">5.1.2 分层 SKILLS 设计成果</h4>
<ol>
<li>
<p><strong>清晰的职责划分</strong>：</p>
<ul>
<li>Foundation Skill：基础组件能力</li>
<li>Module Skill：模块管理能力</li>
<li>Component Skill：具体组件能力</li>
<li>Metadata Skill：元数据处理能力</li>
</ul>
</li>
<li>
<p><strong>可扩展的架构</strong>：</p>
<ul>
<li>支持新增 Skill</li>
<li>支持 Skill 组合</li>
<li>支持 Skill 版本管理</li>
</ul>
</li>
<li>
<p><strong>完整的 Action 体系</strong>：</p>
<ul>
<li>每个 Skill 提供多个 Action</li>
<li>Action 支持参数传递</li>
<li>Action 支持结果返回</li>
</ul>
</li>
</ol>
<h4 data-id="heading-83">5.1.3 Trae Solo 实践成果</h4>
<ol>
<li>
<p><strong>完整的集成方案</strong>：</p>
<ul>
<li>Skill Loader：加载和管理 Skill</li>
<li>Skill Context：管理执行上下文</li>
<li>LLM Integration：集成 LLM 和 Skill</li>
</ul>
</li>
<li>
<p><strong>实战验证</strong>：</p>
<ul>
<li>通过多个实战案例验证</li>
<li>覆盖主要使用场景</li>
<li>提供了完整的示例</li>
</ul>
</li>
<li>
<p><strong>最佳实践指导</strong>：</p>
<ul>
<li>提供了详细的最佳实践</li>
<li>提供了常见问题的解决方案</li>
<li>提供了性能优化建议</li>
</ul>
</li>
</ol>
<h3 data-id="heading-84">5.2 技术亮点</h3>
<h4 data-id="heading-85">5.2.1 设计模式应用</h4>
<ol>
<li>
<p><strong>模板方法模式</strong>：</p>
<ul>
<li>GenJavaTask 定义生成流程</li>
<li>子类实现具体生成逻辑</li>
</ul>
</li>
<li>
<p><strong>策略模式</strong>：</p>
<ul>
<li>不同的生成器实现不同的生成策略</li>
<li>运行时选择合适的生成器</li>
</ul>
</li>
<li>
<p><strong>工厂模式</strong>：</p>
<ul>
<li>SkillLoader 创建 Skill 实例</li>
<li>根据名称动态加载 Skill</li>
</ul>
</li>
<li>
<p><strong>观察者模式</strong>：</p>
<ul>
<li>组件生命周期事件通知</li>
<li>Skill 执行结果通知</li>
</ul>
</li>
</ol>
<h4 data-id="heading-86">5.2.2 性能优化</h4>
<ol>
<li>
<p><strong>缓存机制</strong>：</p>
<ul>
<li>Skill 缓存</li>
<li>生成结果缓存</li>
<li>模板缓存</li>
</ul>
</li>
<li>
<p><strong>并行处理</strong>：</p>
<ul>
<li>并行生成</li>
<li>并行编译</li>
<li>异步加载</li>
</ul>
</li>
<li>
<p><strong>增量构建</strong>：</p>
<ul>
<li>只生成变更的部分</li>
<li>只编译变更的文件</li>
<li>减少构建时间</li>
</ul>
</li>
</ol>
<h4 data-id="heading-87">5.2.3 可维护性</h4>
<ol>
<li>
<p><strong>清晰的代码结构</strong>：</p>
<ul>
<li>分层架构</li>
<li>职责明确</li>
<li>易于理解和维护</li>
</ul>
</li>
<li>
<p><strong>完整的文档</strong>：</p>
<ul>
<li>Skill 定义文档</li>
<li>使用示例文档</li>
<li>最佳实践文档</li>
</ul>
</li>
<li>
<p><strong>自动化测试</strong>：</p>
<ul>
<li>单元测试</li>
<li>集成测试</li>
<li>端到端测试</li>
</ul>
</li>
</ol>
<h3 data-id="heading-88">5.3 未来展望</h3>
<h4 data-id="heading-89">5.3.1 短期目标</h4>
<ol>
<li>
<p><strong>完善 Skill 体系</strong>：</p>
<ul>
<li>增加更多 Skill</li>
<li>优化现有 Skill</li>
<li>提高 Skill 质量</li>
</ul>
</li>
<li>
<p><strong>提升生成性能</strong>：</p>
<ul>
<li>优化生成算法</li>
<li>提高并行度</li>
<li>减少内存占用</li>
</ul>
</li>
<li>
<p><strong>增强集成能力</strong>：</p>
<ul>
<li>支持更多 LLM</li>
<li>支持更多工具</li>
<li>提供更好的集成体验</li>
</ul>
</li>
</ol>
<h4 data-id="heading-90">5.3.2 长期目标</h4>
<ol>
<li>
<p><strong>智能化生成</strong>：</p>
<ul>
<li>使用 AI 优化生成</li>
<li>自动检测问题</li>
<li>自动修复错误</li>
</ul>
</li>
<li>
<p><strong>可视化工具</strong>：</p>
<ul>
<li>提供可视化配置工具</li>
<li>提供可视化生成工具</li>
<li>提供可视化调试工具</li>
</ul>
</li>
<li>
<p><strong>生态系统建设</strong>：</p>
<ul>
<li>构建插件系统</li>
<li>构建市场系统</li>
<li>构建社区系统</li>
</ul>
</li>
</ol>
<h2 data-id="heading-91">六、结论</h2>
<p>本文深入解析了 ooder 框架的 BridgeCode 机制，从设计原理、生成编译流程，到分层 SKILLS 设计，最后展示了在 Trae Solo 环境中的 Skill 构建实践。</p>
<h3 data-id="heading-92">关键收获</h3>
<ol>
<li>
<p><strong>BridgeCode 设计原理</strong>：</p>
<ul>
<li>元数据驱动的三层架构</li>
<li>31 个生成器覆盖所有场景</li>
<li>动态编译和运行时绑定</li>
</ul>
</li>
<li>
<p><strong>分层 SKILLS 设计</strong>：</p>
<ul>
<li>Foundation、Module、Component、Metadata 四层 Skill</li>
<li>清晰的职责划分</li>
<li>完整的 Action 体系</li>
</ul>
</li>
<li>
<p><strong>Trae Solo 实践</strong>：</p>
<ul>
<li>完整的集成方案</li>
<li>多个实战案例</li>
<li>详细的最佳实践</li>
</ul>
</li>
</ol>
<p>这种设计既保持了架构的清晰性，又提供了强大的扩展能力，为 LLM 的使用和后续开发提供了坚实的基础。通过元数据驱动的代码生成和分层 SKILLS 设计，ooder 框架实现了高效的 A2UI 组件开发，为开发者提供了强大的工具支持。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第13章、深入并发模型——select、同步与常见模式]]></title>    <link>https://juejin.cn/post/7603004323870212139</link>    <guid>https://juejin.cn/post/7603004323870212139</guid>    <pubDate>2026-02-05T00:40:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603004323870212139" data-draft-id="7602816610932260927" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第13章、深入并发模型——select、同步与常见模式"/> <meta itemprop="keywords" content="后端,Go,编程语言"/> <meta itemprop="datePublished" content="2026-02-05T00:40:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第13章、深入并发模型——select、同步与常见模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:40:25.000Z" title="Thu Feb 05 2026 00:40:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上一章，我们掌握了Go并发的基石 goroutine 与 channel，学会了如何启动轻量协程、实现协程间通信。本章将在此基础上，深入Go并发模型的核心细节——从 select 多路复用、超时控制等基础技巧，到 WaitGroup、Mutex 等同步原语，再到扇入扇出、单例等高频并发模式，全程配套<strong>简短可运行代码</strong>、表格对比、核心图例，标注官方文档及优质资源链接，帮你快速上手Go并发进阶用法，解决实际开发中的并发场景难题。</p>
<h2 data-id="heading-0">一、select多路复用</h2>
<p>select 是Go语言专门为 channel 设计的多路复用机制，类似 Unix 中的 select/poll/epoll，核心作用是：<strong>同时监听多个 channel 的发送/接收操作</strong>，哪个 channel 先就绪（有数据可接收/有空间可发送），就执行对应的分支；若多个同时就绪，随机选择一个执行；若所有 channel 都未就绪，且无 default 分支，则阻塞等待。</p>
<h3 data-id="heading-1">1.1 核心语法（极简版）</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">select</span> {
<span class="hljs-keyword">case</span> &lt;-ch1: <span class="hljs-comment">// 监听ch1接收</span>
    <span class="hljs-comment">// 逻辑</span>
<span class="hljs-keyword">case</span> ch2 &lt;- data: <span class="hljs-comment">// 监听ch2发送</span>
    <span class="hljs-comment">// 逻辑</span>
<span class="hljs-keyword">default</span>: <span class="hljs-comment">// 可选，所有channel未就绪时执行（非阻塞）</span>
    <span class="hljs-comment">// 逻辑</span>
}

</code></pre>
<h3 data-id="heading-2">1.2 关键特性（表格梳理）</h3>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>多路监听</td><td>可同时监听多个channel的发送/接收，不限数量</td></tr><tr><td>随机选择</td><td>多个channel同时就绪时，随机执行一个分支（避免饥饿）</td></tr><tr><td>阻塞/非阻塞</td><td>无default：阻塞至任意channel就绪；有default：非阻塞，未就绪则执行default</td></tr><tr><td>nil channel</td><td>监听nil channel的分支，永远不会被执行</td></tr></tbody></table>
<h3 data-id="heading-3">1.3 简短代码示例（3个核心场景）</h3>
<h4 data-id="heading-4">示例1：基础多路接收</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ch1 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)
    ch2 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)

    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { ch1 &lt;- <span class="hljs-number">100</span> }()
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { ch2 &lt;- <span class="hljs-string">"hello"</span> }()

    <span class="hljs-comment">// 监听两个channel，哪个先就绪执行哪个</span>
    <span class="hljs-keyword">select</span> {
    <span class="hljs-keyword">case</span> num := &lt;-ch1:
        fmt.Printf(<span class="hljs-string">"接收ch1：%d\n"</span>, num)
    <span class="hljs-keyword">case</span> str := &lt;-ch2:
        fmt.Printf(<span class="hljs-string">"接收ch2：%s\n"</span>, str)
    }
}

</code></pre>
<p>运行结果（二选一，随机）：
接收ch1：100 或 接收ch2：hello</p>
<h4 data-id="heading-5">示例2：带default的非阻塞监听</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>) <span class="hljs-comment">// 无缓冲channel，未就绪</span>

    <span class="hljs-keyword">select</span> {
    <span class="hljs-keyword">case</span> num := &lt;-ch:
        fmt.Printf(<span class="hljs-string">"接收数据：%d\n"</span>, num)
    <span class="hljs-keyword">default</span>:
        fmt.Println(<span class="hljs-string">"所有channel未就绪，执行default"</span>)
    }
}

</code></pre>
<p>运行结果：所有channel未就绪，执行default</p>
<h4 data-id="heading-6">示例3：监听发送操作</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">1</span>)
    ch &lt;- <span class="hljs-number">1</span> <span class="hljs-comment">// 缓冲区已满</span>

    <span class="hljs-keyword">select</span> {
    <span class="hljs-keyword">case</span> ch &lt;- <span class="hljs-number">2</span>: <span class="hljs-comment">// 监听发送，缓冲区满则未就绪</span>
        fmt.Println(<span class="hljs-string">"发送成功"</span>)
    <span class="hljs-keyword">default</span>:
        fmt.Println(<span class="hljs-string">"发送失败，缓冲区已满"</span>)
    }
}

</code></pre>
<p>运行结果：发送失败，缓冲区已满</p>
<h3 data-id="heading-7">1.4 常见误区（避坑重点）</h3>
<ul>
<li>
<p>select 仅能监听 channel 的发送/接收操作，不能监听普通变量；</p>
</li>
<li>
<p>多个分支同时就绪时，<strong>随机选择</strong>，而非按顺序执行；</p>
</li>
<li>
<p>避免“空select”（无任何case），会导致当前goroutine永久阻塞（panic级问题）。</p>
</li>
</ul>
<h3 data-id="heading-8">1.5 参考链接</h3>
<ul>
<li>
<p>Go官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Select_statements" target="_blank" title="https://go.dev/ref/spec#Select_statements" ref="nofollow noopener noreferrer">Select statements</a></p>
</li>
<li>
<p>掘金优质文：<a href="https://juejin.cn/post/6844903903633440775" target="_blank" title="https://juejin.cn/post/6844903903633440775">Go select 详解</a></p>
</li>
</ul>
<h2 data-id="heading-9">二、超时控制</h2>
<p>并发开发中，超时控制是保障系统稳定性的关键——若某个goroutine执行过久（如网络请求超时、数据库查询超时），会导致资源泄露、系统阻塞。Go中无需第三方库，可通过 <strong>select + time.After</strong> 轻松实现超时控制，核心原理：time.After 会返回一个channel，指定时间后发送当前时间，select 监听该channel与业务channel，超时则执行超时分支。</p>
<h3 data-id="heading-10">2.1 核心原理（图例简化）</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[启动业务goroutine] -- 执行任务 --&gt; B[业务channel]
    C[time.After超时时间] -- 超时后发送时间 --&gt; D[超时channel]
    E[select] -- 监听 --&gt; B
    E -- 监听 --&gt; D
    E -- 业务先就绪 --&gt; F[执行业务逻辑]
    E -- 超时先就绪 --&gt; G[执行超时逻辑]
</code></pre>
<h3 data-id="heading-11">2.2 简短代码示例（3个高频场景）</h3>
<h4 data-id="heading-12">示例1：基础超时控制（业务goroutine超时）</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-comment">// 模拟耗时业务（如网络请求）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doTask</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> {
    time.Sleep(<span class="hljs-number">2</span> * time.Second) <span class="hljs-comment">// 模拟耗时2秒</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)

    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        ch &lt;- doTask() <span class="hljs-comment">// 业务执行完发送结果</span>
    }()

    <span class="hljs-comment">// 超时控制：1秒未完成则触发超时</span>
    <span class="hljs-keyword">select</span> {
    <span class="hljs-keyword">case</span> res := &lt;-ch:
        fmt.Printf(<span class="hljs-string">"业务完成，结果：%d\n"</span>, res)
    <span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">1</span> * time.Second):
        fmt.Println(<span class="hljs-string">"业务超时（1秒），终止执行"</span>)
    }
}

</code></pre>
<p>运行结果：业务超时（1秒），终止执行</p>
<h4 data-id="heading-13">示例2：channel接收超时</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)

    <span class="hljs-comment">// 监听ch接收，3秒未收到数据则超时</span>
    <span class="hljs-keyword">select</span> {
    <span class="hljs-keyword">case</span> num := &lt;-ch:
        fmt.Printf(<span class="hljs-string">"接收数据：%d\n"</span>, num)
    <span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">3</span> * time.Second):
        fmt.Println(<span class="hljs-string">"接收超时，未收到任何数据"</span>)
    }
}

</code></pre>
<p>运行结果：接收超时，未收到任何数据</p>
<h4 data-id="heading-14">示例3：超时后终止goroutine（避免泄露）</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)
    quit := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}) <span class="hljs-comment">// 终止信号channel</span>

    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">for</span> {
            <span class="hljs-keyword">select</span> {
            <span class="hljs-keyword">case</span> ch &lt;- <span class="hljs-number">1</span>: <span class="hljs-comment">// 持续执行业务</span>
                time.Sleep(<span class="hljs-number">500</span> * time.Millisecond)
            <span class="hljs-keyword">case</span> &lt;-quit: <span class="hljs-comment">// 接收终止信号，退出goroutine</span>
                fmt.Println(<span class="hljs-string">"goroutine已终止"</span>)
                <span class="hljs-keyword">return</span>
            }
        }
    }()

    <span class="hljs-comment">// 超时控制：2秒后终止goroutine</span>
    <span class="hljs-keyword">select</span> {
    <span class="hljs-keyword">case</span> res := &lt;-ch:
        fmt.Printf(<span class="hljs-string">"业务结果：%d\n"</span>, res)
    <span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">2</span> * time.Second):
        fmt.Println(<span class="hljs-string">"超时，终止goroutine"</span>)
        quit &lt;- <span class="hljs-keyword">struct</span>{}{} <span class="hljs-comment">// 发送终止信号</span>
    }

    time.Sleep(<span class="hljs-number">1</span> * time.Second) <span class="hljs-comment">// 等待goroutine退出</span>
}

</code></pre>
<h3 data-id="heading-15">2.3 关键技巧</h3>





















<table><thead><tr><th>技巧点</th><th>说明</th></tr></thead><tbody><tr><td>time.After 注意事项</td><td>time.After 会启动一个goroutine，超时后才释放，高频场景建议复用timer（避免goroutine泄露）</td></tr><tr><td>终止goroutine</td><td>超时后需通过额外channel（如quit）发送终止信号，避免goroutine泄露</td></tr><tr><td>超时时间选择</td><td>根据业务场景设置（如网络请求设1-3秒，数据库查询设5秒），避免过短/过长</td></tr></tbody></table>
<h3 data-id="heading-16">2.4 参考链接</h3>
<ul>
<li>
<p>Go官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fpkg%2Ftime%2F%23After" target="_blank" title="https://go.dev/pkg/time/#After" ref="nofollow noopener noreferrer">time.After</a></p>
</li>
<li>
<p>掘金优质文：<a href="https://juejin.cn/post/7023993854489331749" target="_blank" title="https://juejin.cn/post/7023993854489331749">Go 超时控制最佳实践</a></p>
</li>
</ul>
<h2 data-id="heading-17">三、心跳机制</h2>
<p>心跳机制是并发系统中“检测协程/服务存活状态”的核心手段，核心逻辑：<strong>一方（客户端/子goroutine）定期向另一方（服务端/主goroutine）发送“心跳信号”</strong>，接收方若在指定时间内未收到心跳，则判定对方异常，执行重启、告警等逻辑。Go中可通过 <strong>select + time.Ticker</strong> 实现高效心跳。</p>
<h3 data-id="heading-18">3.1 核心组件（极简说明）</h3>
<ul>
<li>
<p>time.Ticker：定时发送信号的组件，可设置固定间隔，返回一个channel，每次间隔后发送当前时间；</p>
</li>
<li>
<p>心跳信号：通常用空结构体（struct{}）或简单数值，不占用内存；</p>
</li>
<li>
<p>超时判定：接收方通过 select 监听心跳channel和超时channel，未按时收到则判定异常。</p>
</li>
</ul>
<h3 data-id="heading-19">3.2 简短代码示例（2个核心场景）</h3>
<h4 data-id="heading-20">示例1：基础心跳（子goroutine向主goroutine发送心跳）</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    heartbeat := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}) <span class="hljs-comment">// 心跳channel</span>
    quit := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{})

    <span class="hljs-comment">// 子goroutine：每1秒发送一次心跳</span>
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        ticker := time.NewTicker(<span class="hljs-number">1</span> * time.Second)
        <span class="hljs-keyword">defer</span> ticker.Stop() <span class="hljs-comment">// 释放资源</span>

        <span class="hljs-keyword">for</span> {
            <span class="hljs-keyword">select</span> {
            <span class="hljs-keyword">case</span> &lt;-ticker.C:
                heartbeat &lt;- <span class="hljs-keyword">struct</span>{}{} <span class="hljs-comment">// 发送心跳</span>
            <span class="hljs-keyword">case</span> &lt;-quit:
                fmt.Println(<span class="hljs-string">"子goroutine退出"</span>)
                <span class="hljs-keyword">return</span>
            }
        }
    }()

    <span class="hljs-comment">// 主goroutine：监听心跳，3秒未收到则判定异常</span>
    <span class="hljs-keyword">for</span> {
        <span class="hljs-keyword">select</span> {
        <span class="hljs-keyword">case</span> &lt;-heartbeat:
            fmt.Println(<span class="hljs-string">"收到心跳，子goroutine正常"</span>)
        <span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">3</span> * time.Second):
            fmt.Println(<span class="hljs-string">"未收到心跳，子goroutine异常"</span>)
            quit &lt;- <span class="hljs-keyword">struct</span>{}{} <span class="hljs-comment">// 终止子goroutine</span>
            <span class="hljs-keyword">return</span>
        }
    }
}

</code></pre>
<h4 data-id="heading-21">示例2：双向心跳（主-子goroutine互相检测）</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    mainBeat := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{})  <span class="hljs-comment">// 主goroutine心跳</span>
    subBeat := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{})   <span class="hljs-comment">// 子goroutine心跳</span>
    quit := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{})

    <span class="hljs-comment">// 子goroutine</span>
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        ticker := time.NewTicker(<span class="hljs-number">1</span> * time.Second)
        <span class="hljs-keyword">defer</span> ticker.Stop()

        <span class="hljs-keyword">for</span> {
            <span class="hljs-keyword">select</span> {
            <span class="hljs-keyword">case</span> &lt;-ticker.C:
                subBeat &lt;- <span class="hljs-keyword">struct</span>{}{} <span class="hljs-comment">// 发送子心跳</span>
            <span class="hljs-keyword">case</span> &lt;-mainBeat:
                fmt.Println(<span class="hljs-string">"子goroutine：收到主心跳"</span>)
            <span class="hljs-keyword">case</span> &lt;-quit:
                <span class="hljs-keyword">return</span>
            }
        }
    }()

    <span class="hljs-comment">// 主goroutine</span>
    ticker := time.NewTicker(<span class="hljs-number">1</span> * time.Second)
    <span class="hljs-keyword">defer</span> ticker.Stop()

    <span class="hljs-keyword">for</span> {
        <span class="hljs-keyword">select</span> {
        <span class="hljs-keyword">case</span> &lt;-ticker.C:
            mainBeat &lt;- <span class="hljs-keyword">struct</span>{}{} <span class="hljs-comment">// 发送主心跳</span>
        <span class="hljs-keyword">case</span> &lt;-subBeat:
            fmt.Println(<span class="hljs-string">"主goroutine：收到子心跳"</span>)
        <span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">3</span> * time.Second):
            fmt.Println(<span class="hljs-string">"心跳超时，程序退出"</span>)
            quit &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">return</span>
        }
    }
}

</code></pre>
<h3 data-id="heading-22">3.3 核心注意事项</h3>
<ul>
<li>
<p>time.Ticker 使用后必须调用 <code>Stop()</code>，避免资源泄露；</p>
</li>
<li>
<p>心跳间隔需合理（如1-5秒），过短占用资源，过长无法及时检测异常；</p>
</li>
<li>
<p>异常处理：检测到心跳超时后，需执行终止goroutine、重启服务等逻辑，避免资源浪费。</p>
</li>
</ul>
<h3 data-id="heading-23">3.4 参考链接</h3>
<ul>
<li>
<p>Go官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fpkg%2Ftime%2F%23Ticker" target="_blank" title="https://go.dev/pkg/time/#Ticker" ref="nofollow noopener noreferrer">time.Ticker</a></p>
</li>
<li>
<p>掘金优质文：<a href="https://juejin.cn/post/6894335268681961486" target="_blank" title="https://juejin.cn/post/6894335268681961486">Go 心跳机制实现与实践</a></p>
</li>
</ul>
<h2 data-id="heading-24">四、扇入扇出（Fan In/Out）</h2>
<p>扇入扇出是Go并发编程中<strong>提高任务处理效率</strong>的核心模式，适用于“大量独立任务并行处理”场景（如批量数据处理、多接口并行调用）。</p>
<p>核心定义（极简）：</p>
<ul>
<li>
<p>扇出（Fan Out）：将一个大任务，拆分给多个goroutine并行处理（发散）；</p>
</li>
<li>
<p>扇入（Fan In）：将多个goroutine的处理结果，汇总到一个channel中统一处理（聚合）。</p>
</li>
</ul>
<h3 data-id="heading-25">4.1 模式示意图（简化）</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
A[主任务] -- 拆分任务 --&gt; B[goroutine1]
A -- 拆分任务 --&gt; C[goroutine2]
A -- 拆分任务 --&gt; D[goroutine3]
B -- 处理结果 --&gt; E[汇总channel]
C -- 处理结果 --&gt; E
D -- 处理结果 --&gt; E
E -- 统一处理 --&gt; F[最终结果]
</code></pre>
<h3 data-id="heading-26">4.2 简短代码示例（批量数据处理）</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"sync"</span>
)

<span class="hljs-comment">// 单个任务处理（平方计算）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">process</span><span class="hljs-params">(num <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> {
    <span class="hljs-keyword">return</span> num * num
}

<span class="hljs-comment">// 扇出：拆分任务，多goroutine并行处理</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fanOut</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, wg *sync.WaitGroup, resChan <span class="hljs-keyword">chan</span>&lt;- <span class="hljs-type">int</span>)</span></span> {
    <span class="hljs-keyword">defer</span> wg.Done()
    <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> nums {
        resChan &lt;- process(num)
    }
}

<span class="hljs-comment">// 扇入：汇总多goroutine结果</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fanIn</span><span class="hljs-params">(resChan &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, count <span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> {
    <span class="hljs-keyword">var</span> result []<span class="hljs-type">int</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; count; i++ {
        result = <span class="hljs-built_in">append</span>(result, &lt;-resChan)
    }
    <span class="hljs-keyword">return</span> result
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    nums := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>} <span class="hljs-comment">// 原始数据</span>
    resChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(nums))
    <span class="hljs-keyword">var</span> wg sync.WaitGroup

    <span class="hljs-comment">// 扇出：拆分2个goroutine处理</span>
    wg.Add(<span class="hljs-number">2</span>)
    <span class="hljs-keyword">go</span> fanOut(nums[:<span class="hljs-number">3</span>], &amp;wg, resChan) <span class="hljs-comment">// 处理前3个</span>
    <span class="hljs-keyword">go</span> fanOut(nums[<span class="hljs-number">3</span>:], &amp;wg, resChan) <span class="hljs-comment">// 处理后3个</span>

    <span class="hljs-comment">// 等待所有扇出goroutine完成，关闭结果channel</span>
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resChan)
    }()

    <span class="hljs-comment">// 扇入：汇总结果</span>
    result := fanIn(resChan, <span class="hljs-built_in">len</span>(nums))
    fmt.Printf(<span class="hljs-string">"最终结果：%v\n"</span>, result) <span class="hljs-comment">// 输出：[1 4 9 16 25 36]</span>
}

</code></pre>
<h3 data-id="heading-27">4.3 核心优势与适用场景（表格）</h3>





















<table><thead><tr><th>类别</th><th>详情</th></tr></thead><tbody><tr><td>核心优势</td><td>并行处理任务，缩短整体耗时；任务独立，容错性强（单个goroutine异常不影响整体）</td></tr><tr><td>适用场景</td><td>批量数据处理、多接口并行调用、文件批量读取、计算密集型任务</td></tr><tr><td>注意事项</td><td>goroutine数量不宜过多（建议≤CPU核心数*2），避免调度开销；需用WaitGroup等待所有任务完成</td></tr></tbody></table>
<h3 data-id="heading-28">4.4 参考链接</h3>
<ul>
<li>
<p>Go官方博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fblog%2Fpipelines" target="_blank" title="https://go.dev/blog/pipelines" ref="nofollow noopener noreferrer">Go Pipelines and cancellation</a>（扇入扇出核心参考）</p>
</li>
<li>
<p>掘金优质文：<a href="https://juejin.cn/post/6844903901808033800" target="_blank" title="https://juejin.cn/post/6844903901808033800">Go 扇入扇出模式实战</a></p>
</li>
</ul>
<h2 data-id="heading-29">五、WaitGroup（同步等待组）</h2>
<p>WaitGroup 是 sync 包提供的<strong>goroutine同步工具</strong>，核心作用：<strong>等待多个goroutine全部执行完成后，再继续执行主goroutine</strong>，替代了早期的 time.Sleep（不精准、效率低），是并发开发中最常用的同步原语之一。</p>
<h3 data-id="heading-30">5.1 核心方法（3个，极简说明）</h3>





















<table><thead><tr><th>方法</th><th>作用</th></tr></thead><tbody><tr><td>wg.Add(n int)</td><td>设置需要等待的goroutine数量（n为goroutine个数）</td></tr><tr><td>wg.Done()</td><td>当前goroutine执行完成，将等待计数减1（等价于 wg.Add(-1)）</td></tr><tr><td>wg.Wait()</td><td>主goroutine阻塞，直到等待计数变为0（所有goroutine执行完成）</td></tr></tbody></table>
<h3 data-id="heading-31">5.2 简短代码示例（2个高频场景）</h3>
<h4 data-id="heading-32">示例1：基础用法（等待多个goroutine完成）</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">task</span><span class="hljs-params">(id <span class="hljs-type">int</span>, wg *sync.WaitGroup)</span></span> {
    <span class="hljs-keyword">defer</span> wg.Done() <span class="hljs-comment">// 确保执行完成后计数减1</span>
    fmt.Printf(<span class="hljs-string">"任务%d：开始执行\n"</span>, id)
    time.Sleep(<span class="hljs-number">1</span> * time.Second) <span class="hljs-comment">// 模拟耗时</span>
    fmt.Printf(<span class="hljs-string">"任务%d：执行完成\n"</span>, id)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> wg sync.WaitGroup

    <span class="hljs-comment">// 等待3个goroutine</span>
    wg.Add(<span class="hljs-number">3</span>)
    <span class="hljs-keyword">go</span> task(<span class="hljs-number">1</span>, &amp;wg)
    <span class="hljs-keyword">go</span> task(<span class="hljs-number">2</span>, &amp;wg)
    <span class="hljs-keyword">go</span> task(<span class="hljs-number">3</span>, &amp;wg)

    fmt.Println(<span class="hljs-string">"主goroutine：等待所有任务完成..."</span>)
    wg.Wait() <span class="hljs-comment">// 阻塞等待</span>
    fmt.Println(<span class="hljs-string">"主goroutine：所有任务全部完成"</span>)
}

</code></pre>
<h4 data-id="heading-33">示例2：结合扇出模式（等待批量任务）</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"sync"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">process</span><span class="hljs-params">(num <span class="hljs-type">int</span>, wg *sync.WaitGroup)</span></span> {
    <span class="hljs-keyword">defer</span> wg.Done()
    fmt.Printf(<span class="hljs-string">"处理数据：%d，结果：%d\n"</span>, num, num*<span class="hljs-number">2</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    nums := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>}
    <span class="hljs-keyword">var</span> wg sync.WaitGroup

    <span class="hljs-comment">// 扇出：5个goroutine并行处理</span>
    wg.Add(<span class="hljs-built_in">len</span>(nums))
    <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> nums {
        <span class="hljs-keyword">go</span> process(num, &amp;wg)
    }

    wg.Wait()
    fmt.Println(<span class="hljs-string">"所有数据处理完成"</span>)
}

</code></pre>
<h3 data-id="heading-34">5.3 常见误区（避坑重点）</h3>
<ul>
<li>
<p>wg.Add(n) 必须在 goroutine 启动前调用，避免主goroutine先执行 wg.Wait() 导致计数为0，提前退出；</p>
</li>
<li>
<p>wg.Done() 必须放在 goroutine 执行完成的位置，推荐用 <code>defer wg.Done()</code>，确保即使goroutine panic（需 recover）也能执行；</p>
</li>
<li>
<p>WaitGroup 是值类型，传递时必须用<strong>指针</strong>，否则会复制一个新的WaitGroup，无法实现同步。</p>
</li>
</ul>
<h3 data-id="heading-35">5.4 参考链接</h3>
<ul>
<li>Go官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fpkg%2Fsync%2F%23WaitGroup" target="_blank" title="https://go.dev/pkg/sync/#WaitGroup" ref="nofollow noopener noreferrer">sync.WaitGroup</a></li>
</ul>
<h2 data-id="heading-36">六、Mutex互斥锁（并发安全）</h2>
<p>在并发开发中，当多个goroutine同时访问<strong>同一个共享变量</strong>，且至少有一个goroutine进行“写操作”时，会发生<strong>数据竞争</strong>，导致程序运行结果不可预测。Mutex（互斥锁）是 sync 包提供的核心同步原语，核心作用：<strong>保证同一时间只有一个goroutine能访问共享资源（临界区）</strong>，避免数据竞争。</p>
<h3 data-id="heading-37">6.1 核心概念（极简）</h3>
<ul>
<li>
<p>临界区：多个goroutine共同访问的共享资源（如共享变量、全局变量）；</p>
</li>
<li>
<p>互斥锁：通过“加锁-解锁”机制，确保临界区同一时间只有一个goroutine访问；</p>
</li>
<li>
<p>核心方法：Lock()（加锁）、Unlock()（解锁）。</p>
</li>
</ul>
<h3 data-id="heading-38">6.2 简短代码示例（数据竞争解决）</h3>
<h4 data-id="heading-39">示例1：数据竞争演示（未加锁）</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"sync"</span>
)

<span class="hljs-keyword">var</span> count <span class="hljs-type">int</span> = <span class="hljs-number">0</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">increment</span><span class="hljs-params">(wg *sync.WaitGroup)</span></span> {
    <span class="hljs-keyword">defer</span> wg.Done()
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++ {
        count++ <span class="hljs-comment">// 共享变量写操作，无锁会导致数据竞争</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    wg.Add(<span class="hljs-number">2</span>)

    <span class="hljs-keyword">go</span> increment(&amp;wg)
    <span class="hljs-keyword">go</span> increment(&amp;wg)

    wg.Wait()
    fmt.Printf(<span class="hljs-string">"最终count：%d（预期2000，实际随机）\n"</span>, count)
}

</code></pre>
<h4 data-id="heading-40">示例2：加Mutex解决数据竞争</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"sync"</span>
)

<span class="hljs-keyword">var</span> (
    count <span class="hljs-type">int</span> = <span class="hljs-number">0</span>
    mu    sync.Mutex <span class="hljs-comment">// 定义互斥锁</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">increment</span><span class="hljs-params">(wg *sync.WaitGroup)</span></span> {
    <span class="hljs-keyword">defer</span> wg.Done()
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++ {
        mu.Lock()   <span class="hljs-comment">// 加锁，进入临界区</span>
        count++     <span class="hljs-comment">// 临界区操作（共享变量）</span>
        mu.Unlock() <span class="hljs-comment">// 解锁，退出临界区</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    wg.Add(<span class="hljs-number">2</span>)

    <span class="hljs-keyword">go</span> increment(&amp;wg)
    <span class="hljs-keyword">go</span> increment(&amp;wg)

    wg.Wait()
    fmt.Printf(<span class="hljs-string">"最终count：%d（预期2000，结果稳定）\n"</span>, count)
}

</code></pre>
<h3 data-id="heading-41">6.3 关键注意事项（表格）</h3>

























<table><thead><tr><th>注意点</th><th>说明</th></tr></thead><tbody><tr><td>Lock/Unlock 成对出现</td><td>必须用 defer mu.Unlock() 确保解锁，避免goroutine panic导致锁未释放（死锁）</td></tr><tr><td>锁粒度要小</td><td>临界区代码应尽可能精简，只包裹共享资源操作，减少锁的持有时间（提高并发效率）</td></tr><tr><td>避免死锁</td><td>不要在持有锁的情况下，调用其他可能加锁的函数；不要多个锁交叉持有</td></tr><tr><td>读写分离</td><td>若读多写少，推荐用 RWMutex（读写锁），提高读操作并发效率（后续补充）</td></tr></tbody></table>
<h3 data-id="heading-42">6.4 参考链接</h3>
<ul>
<li>
<p>Go官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fpkg%2Fsync%2F%23Mutex" target="_blank" title="https://go.dev/pkg/sync/#Mutex" ref="nofollow noopener noreferrer">sync.Mutex</a></p>
</li>
<li>
<p>掘金优质文：<a href="https://juejin.cn/post/6844903902543136775" target="_blank" title="https://juejin.cn/post/6844903902543136775">Go Mutex 详解与避坑</a></p>
</li>
</ul>
<h2 data-id="heading-43">七、Once单例（只执行一次）</h2>
<p>Once 是 sync 包提供的<strong>单例工具</strong>，核心作用：<strong>保证某个函数在整个程序生命周期中，只被执行一次</strong>，无论有多少个goroutine同时调用，适用于单例初始化、资源一次性加载等场景（替代了传统的双重检查锁，更简洁、安全）。</p>
<h3 data-id="heading-44">7.1 核心原理与方法</h3>
<ul>
<li>
<p>核心方法：<code>once.Do(f func())</code>，传入需要只执行一次的函数f；</p>
</li>
<li>
<p>核心原理：Once 内部维护一个布尔值和一个互斥锁，确保函数f只被执行一次，后续调用会直接返回，不执行f。</p>
</li>
</ul>
<h3 data-id="heading-45">7.2 简短代码示例（2个核心场景）</h3>
<h4 data-id="heading-46">示例1：基础单例初始化</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"sync"</span>
)

<span class="hljs-comment">// 单例对象（模拟配置、数据库连接等）</span>
<span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {
    AppName <span class="hljs-type">string</span>
    Port    <span class="hljs-type">int</span>
}

<span class="hljs-keyword">var</span> (
    config *Config
    once   sync.Once <span class="hljs-comment">// 定义Once实例</span>
)

<span class="hljs-comment">// 初始化单例（确保只执行一次）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initConfig</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"初始化配置（只执行一次）"</span>)
    config = &amp;Config{
        AppName: <span class="hljs-string">"Go并发实战"</span>,
        Port:    <span class="hljs-number">8080</span>,
    }
}

<span class="hljs-comment">// 获取单例对象</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetConfig</span><span class="hljs-params">()</span></span> *Config {
    once.Do(initConfig) <span class="hljs-comment">// 调用once.Do，确保initConfig只执行一次</span>
    <span class="hljs-keyword">return</span> config
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    wg.Add(<span class="hljs-number">5</span>)

    <span class="hljs-comment">// 5个goroutine同时调用GetConfig，验证initConfig只执行一次</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ {
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(id <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            cfg := GetConfig()
            fmt.Printf(<span class="hljs-string">"goroutine%d：获取配置，AppName=%s，Port=%d\n"</span>, id, cfg.AppName, cfg.Port)
        }(i)
    }

    wg.Wait()
}

</code></pre>
<p>运行结果：
初始化配置（只执行一次）
goroutine0：获取配置，AppName=Go并发实战，Port=8080
goroutine1：获取配置，AppName=Go并发实战，Port=8080
goroutine2：获取配置，AppName=Go并发实战，Port=8080
goroutine3：获取配置，AppName=Go并发实战，Port=8080
goroutine4：获取配置，AppName=Go并发实战，Port=8080</p>
<h4 data-id="heading-47">示例2：资源一次性加载（模拟数据库连接）</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"sync"</span>
)

<span class="hljs-keyword">var</span> (
    dbConn <span class="hljs-type">string</span>       <span class="hljs-comment">// 模拟数据库连接</span>
    once   sync.Once    <span class="hljs-comment">// 全局Once实例</span>
)

<span class="hljs-comment">// 模拟数据库连接初始化（耗时操作，需只执行一次）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initDB</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"正在初始化数据库连接..."</span>)
    <span class="hljs-comment">// 模拟耗时操作（如建立TCP连接、认证）</span>
    dbConn = <span class="hljs-string">"mysql://user:pass@localhost:3306/db"</span>
    fmt.Println(<span class="hljs-string">"数据库连接初始化完成"</span>)
}

<span class="hljs-comment">// 获取数据库连接</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetDBConn</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> {
    once.Do(initDB) <span class="hljs-comment">// 确保initDB只执行一次，即使多goroutine并发调用</span>
    <span class="hljs-keyword">return</span> dbConn
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    wg.Add(<span class="hljs-number">3</span>)

    <span class="hljs-comment">// 3个goroutine并发获取数据库连接</span>
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">defer</span> wg.Done()
        conn := GetDBConn()
        fmt.Printf(<span class="hljs-string">"goroutine1：获取DB连接：%s\n"</span>, conn)
    }()

    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">defer</span> wg.Done()
        conn := GetDBConn()
        fmt.Printf(<span class="hljs-string">"goroutine2：获取DB连接：%s\n"</span>, conn)
    }()

    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">defer</span> wg.Done()
        conn := GetDBConn()
        fmt.Printf(<span class="hljs-string">"goroutine3：获取DB连接：%s\n"</span>, conn)
    }()

    wg.Wait()
    fmt.Println(<span class="hljs-string">"程序执行完成"</span>)
}

</code></pre>
<p>运行结果：
正在初始化数据库连接...
数据库连接初始化完成
goroutine1：获取DB连接：mysql://user:pass@localhost:3306/db
goroutine2：获取DB连接：mysql://user:pass@localhost:3306/db
goroutine3：获取DB连接：mysql://user:pass@localhost:3306/db
程序执行完成</p>
<h3 data-id="heading-48">7.3 常见误区（避坑重点）</h3>
<ul>
<li>
<p>once.Do(f) 中的函数f<strong>不能有参数和返回值</strong>，若需传递参数/获取返回值，可通过全局变量、闭包实现（如示例1中的config、示例2中的dbConn）；</p>
</li>
<li>
<p>Once 实例必须是<strong>全局或通过指针传递</strong>，若为局部变量，会导致多个Once实例，无法保证函数只执行一次；</p>
</li>
<li>
<p>即使多个goroutine同时调用 once.Do(f)，也只会有一个goroutine执行f，其他goroutine会阻塞等待f执行完成，而非直接返回；</p>
</li>
<li>
<p>避免在f函数中调用 once.Do(f)（递归调用），会导致死锁。</p>
</li>
</ul>
<h3 data-id="heading-49">7.4 Once vs 双重检查锁（表格对比）</h3>

























<table><thead><tr><th>对比维度</th><th>sync.Once</th><th>双重检查锁（Double-Check Lock）</th></tr></thead><tbody><tr><td>简洁度</td><td>极高，只需调用once.Do(f)，无需手动加锁解锁</td><td>复杂，需手动加锁、解锁，还要两次判断单例是否初始化</td></tr><tr><td>安全性</td><td>官方实现，无并发安全问题，适配所有Go版本</td><td>易出错，需考虑CPU指令重排，低版本Go需用volatile修饰变量</td></tr><tr><td>适用场景</td><td>单例初始化、资源一次性加载，推荐首选</td><td>不推荐在Go中使用，仅用于了解并发安全思想</td></tr></tbody></table>
<h3 data-id="heading-50">7.5 参考链接</h3>
<ul>
<li>
<p>Go官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fpkg%2Fsync%2F%23Once" target="_blank" title="https://go.dev/pkg/sync/#Once" ref="nofollow noopener noreferrer">sync.Once</a></p>
</li>
<li>
<p>掘金优质文：<a href="https://juejin.cn/post/6844903902875686926" target="_blank" title="https://juejin.cn/post/6844903902875686926">Go sync.Once 源码解析与实战</a></p>
</li>
</ul>
<h2 data-id="heading-51">八、本章总结</h2>
<p>本章围绕Go并发进阶核心内容展开，从 select 多路复用、超时控制、心跳机制等基础技巧，到扇入扇出并发模式，再到 WaitGroup、Mutex、Once 三大核心同步原语，全程以“简短可运行代码+避坑提示+优质链接”为核心，覆盖实际开发中80%的并发场景，核心要点汇总如下：</p>
<ul>
<li>
<p>select：专门用于channel多路监听，支持阻塞/非阻塞模式，多个就绪分支随机选择，避免空select；</p>
</li>
<li>
<p>超时控制：基于 select + time.After 实现，无需第三方库，关键是超时后终止goroutine，避免资源泄露；</p>
</li>
<li>
<p>心跳机制：基于 select + time.Ticker 实现，用于检测goroutine/服务存活，Ticker使用后需调用Stop()；</p>
</li>
<li>
<p>扇入扇出：拆分任务并行处理、汇总结果，提高批量任务效率，注意控制goroutine数量避免调度开销；</p>
</li>
<li>
<p>WaitGroup：等待多个goroutine完成，核心是Add/Done/Wait三件套，传递时必须用指针；</p>
</li>
<li>
<p>Mutex：解决数据竞争，保证临界区同一时间只有一个goroutine访问，核心是Lock/Unlock成对出现，控制锁粒度；</p>
</li>
<li>
<p>Once：保证函数只执行一次，适用于单例初始化、资源加载，比双重检查锁更简洁安全。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 年最值得使用的 7 款 PHP 管理后台框架推荐]]></title>    <link>https://juejin.cn/post/7602850166731423753</link>    <guid>https://juejin.cn/post/7602850166731423753</guid>    <pubDate>2026-02-05T00:42:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602850166731423753" data-draft-id="7602910573404667942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 年最值得使用的 7 款 PHP 管理后台框架推荐"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-05T00:42:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 年最值得使用的 7 款 PHP 管理后台框架推荐
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:42:30.000Z" title="Thu Feb 05 2026 00:42:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">2026 年最值得使用的 7 款 PHP 管理后台框架推荐</h2>
<p>搭建企业级 PHP 后台管理系统，选择一款合适的 Laravel admin 框架至关重要。PHP 作为 Web 开发领域最成熟的语言之一，拥有众多优秀的后台管理框架。Laravel 框架凭借优雅的语法和完善的生态，已成为 GitHub 上 stars 最高的 PHP 框架，围绕它诞生了大量优质的 PHP 后台框架。</p>
<p>本文将从开发效率、灵活性、学习成本三个维度，为你推荐 2026 年最值得使用的 7 款 PHP admin 后台管理系统。无论你是需要快速搭建企业后台、开发 SaaS 平台，还是构建电商管理系统，都能找到适合的 Laravel 后台管理解决方案。</p>
<h3 data-id="heading-1">PHP 后台管理框架选型指南</h3>
<p>在选择 PHP 管理后台框架之前，需要先明确项目需求。不同类型的 Laravel admin 框架适用于不同场景，选错框架可能导致后期开发成本大幅增加。下面按抽象程度从低到高，介绍三种主流的 PHP 后台框架类型：</p>
<h4 data-id="heading-2">脚手架型</h4>
<p>脚手架型框架通过命令行自动生成 Model、Controller、路由和基础 CRUD 代码。优势是灵活性高，生成的代码完全可控；劣势是后期维护需要手动修改生成的代码。</p>
<h4 data-id="heading-3">CRUD 接口型</h4>
<p>CRUD 接口型框架提供一套完整的后台管理组件，开发者只需定义资源配置即可自动生成管理界面。代码量相对较少，但遇到复杂业务逻辑时需要额外扩展。本文推荐的 Laravel Nova、CatchAdmin、Filament、Backpack、Orchid 都属于这种类型。这类 PHP 后台管理系统在灵活性和开发效率之间取得了良好平衡，是目前最主流的选择。</p>
<h4 data-id="heading-4">可视化编程</h4>
<p>可视化编程型框架抽象程度最高，通过拖拽或配置即可生成后台界面。部署快速，对编程能力要求较低，但灵活性也相对受限。Voyager 和 QuickAdminPanel 属于这种类型。</p>
<h3 data-id="heading-5">2026 年 7 款 PHP 后台管理框架详解</h3>
<p>以下按推荐顺序介绍 7 款主流的 Laravel admin 后台管理框架，涵盖付费和开源方案，适用于从个人项目到企业级应用的各种场景。</p>
<h4 data-id="heading-6">Laravel Nova - 官方出品的标杆之作</h4>
<ul>
<li><strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fnova.laravel.com%2F" target="_blank" title="https://nova.laravel.com/" ref="nofollow noopener noreferrer">nova.laravel.com/</a></li>
<li><strong>类型</strong>: CRUD 接口型</li>
<li><strong>价格</strong>: <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>99</mn><mtext>（单项目）</mtext><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">99（单项目）/ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">99</span><span class="mord cjk_fallback">（单项目）</span><span class="mord">/</span></span></span></span></span>299（无限项目）</li>
</ul>
<p>Laravel Nova 是 Laravel 框架作者 Taylor Otwell 亲自打造的官方后台管理系统。作为官方产品，Nova 在架构设计和性能优化上都达到了极高水准。</p>
<p>Nova 采用 Vue.js 构建前端，提供了资源管理、搜索过滤、图表统计、自定义操作等开箱即用的功能。扩展生态非常完善，几乎每天都有新的扩展包在 Nova Packages 上线。</p>
<p><strong>优势</strong>:</p>
<ul>
<li>官方维护，更新及时，与 Laravel 版本同步</li>
<li>性能优化到极致，大数据量下表现稳定</li>
<li>扩展生态丰富，覆盖各种业务场景</li>
</ul>
<p><strong>劣势</strong>:</p>
<ul>
<li>付费产品，小团队可能有成本压力</li>
<li>源码不开放，深度定制受限</li>
</ul>
<p><strong>适用场景</strong>: 商业项目、对稳定性要求高的企业级应用。</p>
<h4 data-id="heading-7">CatchAdmin - 企业级前后端分离方案</h4>
<ul>
<li><strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2F" target="_blank" title="https://catchadmin.com/" ref="nofollow noopener noreferrer">catchadmin.com/</a></li>
<li><strong>文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.catchadmin.com%2F" target="_blank" title="https://doc.catchadmin.com/" ref="nofollow noopener noreferrer">doc.catchadmin.com/</a></li>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcatch-admin%2Fcatchadmin" target="_blank" title="https://github.com/catch-admin/catchadmin" ref="nofollow noopener noreferrer">github.com/catch-admin…</a></li>
<li><strong>Demo</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fv5.catchadmin.com" target="_blank" title="https://v5.catchadmin.com" ref="nofollow noopener noreferrer">v5.catchadmin.com</a></li>
</ul>
<p>CatchAdmin 是一款基于 Laravel 12.x 和 Vue 3 + Element Plus 的企业级前后端分离后台管理系统。它充分利用 PHP 8+ 特性，采用现代化架构设计，是目前最受欢迎的开源 Laravel admin 框架之一。</p>
<p>对于需要搭建企业级 PHP 后台管理系统的团队来说，CatchAdmin 提供了开箱即用的完整解决方案。它不仅仅是一个 Laravel 后台框架，更是一套经过生产验证的企业级开发脚手架。</p>
<p>CatchAdmin 的核心优势在于<strong>模块化设计</strong>。每个业务模块拥有独立的控制器、路由、模型和数据表，模块之间完全解耦。这种架构让团队可以并行开发不同模块，后期维护也更加轻松。</p>
<h5 data-id="heading-8">核心功能</h5>
<ul>
<li><strong>用户管理</strong>: 用户增删改查、密码重置、不同用户可配置不同首页和功能模块</li>
<li><strong>部门管理</strong>: 多级组织架构配置，树形结构展示，支持层级调整</li>
<li><strong>角色权限</strong>: 树结构角色体系，支持菜单权限、按钮级权限、数据权限三级管控</li>
<li><strong>菜单管理</strong>: 可视化配置系统菜单、路由与按钮资源，前后端权限一致</li>
<li><strong>代码生成</strong>: 一键生成前后端代码（PHP、Vue）及数据库迁移文件，直接生成到模块</li>
<li><strong>文件上传</strong>: 支持本地、七牛云、阿里云、腾讯云等多种存储方式</li>
<li><strong>日志系统</strong>: 操作日志、登录日志完整记录，支持多维检索</li>
<li><strong>插件系统</strong>: 插件即 Composer 包，深度融入 Composer 生态</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 快速安装，五分钟即可构建</span>
composer create catchadmin/catchadmin
<span class="hljs-built_in">cd</span> catchadmin
php artisan catch:install
</code></pre>
<p>CatchAdmin 还支持 <strong>Vue 即时渲染</strong>，前端代码修改后无需编译即可生效，大幅提升开发调试效率。</p>
<p><strong>优势</strong>:</p>
<ul>
<li>现代化架构，基于 Laravel 12.x + Vue 3 + Element Plus</li>
<li>模块化设计，业务模块完全独立，支持按需加载</li>
<li>一键代码生成，前后端代码 + 数据库迁移一步到位</li>
<li>RBAC 权限系统完善，支持部门数据隔离和 API 接口权限验证</li>
<li>中文文档详尽，社区活跃，持续更新</li>
</ul>
<p><strong>劣势</strong>:</p>
<ul>
<li>需要同时掌握 Vue 和 Laravel</li>
<li>专业版部分高级功能需付费</li>
</ul>
<p><strong>适用场景</strong>: 企业后台管理、SaaS 平台、电商后台、CRM/OA 等企业应用、中大型项目。</p>
<h4 data-id="heading-9">Filament - 社区最火的后起之秀</h4>
<ul>
<li><strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Ffilamentphp.com%2F" target="_blank" title="https://filamentphp.com/" ref="nofollow noopener noreferrer">filamentphp.com/</a></li>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffilamentphp%2Ffilament" target="_blank" title="https://github.com/filamentphp/filament" ref="nofollow noopener noreferrer">github.com/filamentphp…</a></li>
<li><strong>类型</strong>: CRUD 接口型</li>
<li><strong>价格</strong>: 开源免费（MIT 协议）</li>
</ul>
<p>Filament 是 2021 年发布的 Laravel admin 框架，近两年在社区的热度持续攀升，已成为 Laravel 生态中最受欢迎的开源后台框架之一。</p>
<p>Filament 基于 Livewire 和 Alpine.js 构建，采用 Tailwind CSS 设计。它不仅仅是一个后台管理框架，还包含表单构建器、表格构建器、通知系统等独立组件，可以单独使用。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// Filament 资源定义示例</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Filament</span>\<span class="hljs-title">Resources</span>\<span class="hljs-title">Resource</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostResource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Resource</span>
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">static</span> ?<span class="hljs-keyword">string</span> <span class="hljs-variable">$model</span> = <span class="hljs-title class_">Post</span>::<span class="hljs-variable language_">class</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">form</span>(<span class="hljs-params">Form <span class="hljs-variable">$form</span></span>): <span class="hljs-title">Form</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$form</span>-&gt;<span class="hljs-title function_ invoke__">schema</span>([
            <span class="hljs-title class_">TextInput</span>::<span class="hljs-title function_ invoke__">make</span>(<span class="hljs-string">'title'</span>)-&gt;<span class="hljs-title function_ invoke__">required</span>(),
            <span class="hljs-title class_">RichEditor</span>::<span class="hljs-title function_ invoke__">make</span>(<span class="hljs-string">'content'</span>),
            <span class="hljs-title class_">Select</span>::<span class="hljs-title function_ invoke__">make</span>(<span class="hljs-string">'status'</span>)-&gt;<span class="hljs-title function_ invoke__">options</span>([
                <span class="hljs-string">'draft'</span> =&gt; <span class="hljs-string">'草稿'</span>,
                <span class="hljs-string">'published'</span> =&gt; <span class="hljs-string">'已发布'</span>,
            ]),
        ]);
    }
}
</code></pre>
<p><strong>优势</strong>:</p>
<ul>
<li>完全开源，社区贡献活跃</li>
<li>基于 Livewire，无需编写 JavaScript</li>
<li>组件丰富，UI 设计现代</li>
<li>文档详尽，学习曲线平缓</li>
</ul>
<p><strong>劣势</strong>:</p>
<ul>
<li>Livewire 机制对实时性要求高的场景可能不适用</li>
<li>相比 Nova，生态成熟度稍逊</li>
</ul>
<p><strong>适用场景</strong>: 开源项目、个人项目、中小型企业项目。</p>
<h4 data-id="heading-10">Backpack - 灵活与效率的平衡</h4>
<ul>
<li><strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fbackpackforlaravel.com%2F" target="_blank" title="https://backpackforlaravel.com/" ref="nofollow noopener noreferrer">backpackforlaravel.com/</a></li>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flaravel-backpack" target="_blank" title="https://github.com/laravel-backpack" ref="nofollow noopener noreferrer">github.com/laravel-bac…</a></li>
<li><strong>类型</strong>: 混合型</li>
<li><strong>价格</strong>: 非商业免费 / 商业项目 €69 起</li>
</ul>
<p>Backpack 自 2016 年发布以来，一直保持稳定更新。它提供了一套完整的 CRUD 组件和丰富的字段类型，同时还有可视化开发工具 Backpack DevTools。</p>
<p>Backpack 的文档写得非常详尽，配有视频教程，学习成本较低。它的设计哲学是「约定优于配置」，大部分场景下只需简单配置即可完成开发。</p>
<p><strong>优势</strong>:</p>
<ul>
<li>文档优秀，有视频教程</li>
<li>字段类型丰富，覆盖常见需求</li>
<li>DevTools 支持可视化开发</li>
<li>主题可定制</li>
</ul>
<p><strong>劣势</strong>:</p>
<ul>
<li>商业项目需要付费</li>
<li>前端基于 jQuery，技术栈相对传统</li>
</ul>
<p><strong>适用场景</strong>: 快速原型开发、对文档要求高的团队。</p>
<h4 data-id="heading-11">Orchid - 开源社区的优秀选择</h4>
<ul>
<li><strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Forchid.software%2F" target="_blank" title="https://orchid.software/" ref="nofollow noopener noreferrer">orchid.software/</a></li>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Forchidsoftware%2Fplatform" target="_blank" title="https://github.com/orchidsoftware/platform" ref="nofollow noopener noreferrer">github.com/orchidsoftw…</a></li>
<li><strong>类型</strong>: CRUD 接口型</li>
<li><strong>价格</strong>: 开源免费（MIT 协议）</li>
</ul>
<p>Orchid 由俄罗斯开发者 Alexandr Chernyaev 创建，是一个功能完善的 Laravel 后台管理框架。它内置了表单构建器、表格过滤器、排序、搜索等功能，细节处理得非常到位。</p>
<p>Orchid 的亮点在于它的 Screen 概念，将页面逻辑封装在 Screen 类中，代码组织清晰。同时，Orchid 拥有活跃的开源社区和大量的赞助者，保证了项目的持续发展。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// Orchid Screen 示例</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Orchid</span>\<span class="hljs-title">Screen</span>\<span class="hljs-title">Screen</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostListScreen</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Screen</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">query</span>(<span class="hljs-params"/>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-keyword">return</span> [
            <span class="hljs-string">'posts'</span> =&gt; <span class="hljs-title class_">Post</span>::<span class="hljs-title function_ invoke__">paginate</span>(),
        ];
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">layout</span>(<span class="hljs-params"/>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-keyword">return</span> [
            <span class="hljs-title class_">PostListLayout</span>::<span class="hljs-variable language_">class</span>,
        ];
    }
}
</code></pre>
<p><strong>优势</strong>:</p>
<ul>
<li>完全开源，社区活跃</li>
<li>Screen 架构清晰，便于维护</li>
<li>权限系统完善</li>
<li>支持多语言</li>
</ul>
<p><strong>劣势</strong>:</p>
<ul>
<li>学习曲线相对较陡</li>
<li>中文资源较少</li>
</ul>
<p><strong>适用场景</strong>: 开源项目、需要精细权限控制的系统。</p>
<h4 data-id="heading-12">Voyager - 可视化管理的先驱</h4>
<ul>
<li><strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fvoyager.devdojo.com%2F" target="_blank" title="https://voyager.devdojo.com/" ref="nofollow noopener noreferrer">voyager.devdojo.com/</a></li>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthe-control-group%2Fvoyager" target="_blank" title="https://github.com/the-control-group/voyager" ref="nofollow noopener noreferrer">github.com/the-control…</a></li>
<li><strong>类型</strong>: 可视化编程</li>
<li><strong>价格</strong>: 开源免费（MIT 协议）</li>
</ul>
<p>Voyager 与其他 Laravel admin 有所不同，它可以根据数据库表自动创建 BREAD（Browse、Read、Edit、Add、Delete）界面，无需编写代码。</p>
<p>Voyager 内置了媒体管理器，支持在 UI 层面管理文件。菜单构建器让你可以直接在页面上拖拽管理菜单结构。对于需要快速搭建后台的项目，Voyager 是一个不错的选择。</p>
<p><strong>优势</strong>:</p>
<ul>
<li>可视化配置，上手快</li>
<li>内置媒体管理器</li>
<li>菜单构建器直观易用</li>
<li>社区成熟，文档清晰</li>
</ul>
<p><strong>劣势</strong>:</p>
<ul>
<li>灵活性受限，复杂业务场景难以满足</li>
<li>前端基于 Blade，定制成本较高</li>
</ul>
<p><strong>适用场景</strong>: 快速原型、内容管理系统、对灵活性要求不高的项目。</p>
<h4 data-id="heading-13">QuickAdminPanel - 在线生成定制代码</h4>
<ul>
<li><strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fquickadminpanel.com%2F" target="_blank" title="https://quickadminpanel.com/" ref="nofollow noopener noreferrer">quickadminpanel.com/</a></li>
<li><strong>类型</strong>: 可视化编程</li>
<li><strong>价格</strong>: $199/年</li>
</ul>
<p>QuickAdminPanel 的理念就是「快」。整个开发流程在线完成：在官网配置 admin 面板，选择需要的模块，点击下载，获得定制代码，部署到服务器。</p>
<p>这种模式特别适合需求明确、不需要太多灵活性的项目。生成的代码基于 Laravel 标准结构，后期也可以手动修改。</p>
<p><strong>优势</strong>:</p>
<ul>
<li>在线配置，无需本地环境</li>
<li>生成的代码规范，可二次开发</li>
<li>模块丰富，覆盖常见需求</li>
</ul>
<p><strong>劣势</strong>:</p>
<ul>
<li>付费订阅模式</li>
<li>复杂逻辑需要手动编写</li>
</ul>
<p><strong>适用场景</strong>: 快速启动项目、外包项目、MVP 开发。</p>
<h3 data-id="heading-14">PHP 管理后台框架对比</h3>
<p>以下表格从价格、技术栈、学习曲线、灵活性、前后端分离五个维度对比 7 款 Laravel admin 后台管理框架：</p>





































































<table><thead><tr><th>框架</th><th>价格</th><th>技术栈</th><th>学习曲线</th><th>灵活性</th><th>前后端分离</th></tr></thead><tbody><tr><td>Laravel Nova</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>99</mn><mo>−</mo></mrow><annotation encoding="application/x-tex">99-</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">99</span><span class="mord">−</span></span></span></span></span>299</td><td>Vue.js</td><td>中</td><td>高</td><td>✅</td></tr><tr><td>CatchAdmin</td><td>免费</td><td>Vue 3 + Element Plus</td><td>中</td><td>高</td><td>✅</td></tr><tr><td>Filament</td><td>免费</td><td>Livewire + Alpine.js</td><td>低</td><td>中高</td><td>❌</td></tr><tr><td>Backpack</td><td>€69+</td><td>jQuery + Bootstrap</td><td>低</td><td>中</td><td>❌</td></tr><tr><td>Orchid</td><td>免费</td><td>Laravel Blade</td><td>中高</td><td>高</td><td>❌</td></tr><tr><td>Voyager</td><td>免费</td><td>Laravel Blade</td><td>低</td><td>低</td><td>❌</td></tr><tr><td>QuickAdminPanel</td><td>$199/年</td><td>Laravel 标准</td><td>低</td><td>中</td><td>❌</td></tr></tbody></table>
<p>从表格可以看出，如果你需要一款<strong>免费、前后端分离、灵活性高</strong>的 PHP 后台管理框架，CatchAdmin 是为数不多同时满足这三个条件的选择。</p>
<h3 data-id="heading-15">如何选择合适的 PHP 后台管理框架</h3>
<p>选择 Laravel admin 后台管理框架需要综合考虑项目规模、团队技术栈、预算等因素：</p>
<ul>
<li><strong>追求官方稳定和生态</strong>: Laravel Nova 是首选，但需要付费</li>
<li><strong>需要前后端分离架构</strong>: CatchAdmin 提供了完整的 Vue 3 + Laravel 解决方案，且核心功能免费开源</li>
<li><strong>纯后端开发者</strong>: Filament 基于 Livewire，无需编写前端代码</li>
<li><strong>快速原型开发</strong>: Voyager 或 QuickAdminPanel 可以快速启动</li>
<li><strong>精细权限控制</strong>: Orchid 和 CatchAdmin 都提供了完善的 RBAC 权限系统</li>
</ul>
<p>无论选择哪个 Laravel 后台框架，建议先在小项目中试用，评估是否符合团队的开发习惯和项目需求。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-02%2Fphp-admin-panel-2026" target="_blank" title="https://catchadmin.com/post/2026-02/php-admin-panel-2026" ref="nofollow noopener noreferrer">原文 2026 年最值得使用的 7 款 PHP 管理后台框架推荐
</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[10分钟速览Android开发者需要关注的 Kotlin 更新]]></title>    <link>https://juejin.cn/post/7602824293164941327</link>    <guid>https://juejin.cn/post/7602824293164941327</guid>    <pubDate>2026-02-05T00:42:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602824293164941327" data-draft-id="7602634187284660234" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="10分钟速览Android开发者需要关注的 Kotlin 更新"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2026-02-05T00:42:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            10分钟速览Android开发者需要关注的 Kotlin 更新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:42:57.000Z" title="Thu Feb 05 2026 00:42:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3799bf045f9147809c80a685fc00e648~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856976&amp;x-signature=yJ33XXrcEn7wd%2FqsRv23b8lh4Js%3D" alt="2_0.png" loading="lazy"/></p>
<p>Kotlin 2.3.0 带来了稳定的时间 API、显式幕后字段、改进的 Swift 互操作性以及更完善的工具链。</p>
<p>下面我们来一起浏览那些对于 Android 开发者需要关注的新特性。</p>
<h2 data-id="heading-0">稳定的时间 API：Clock 与 Instant</h2>
<p><code>kotlin.time.Clock</code> 和 <code>kotlin.time.Instant</code> API 现已正式稳定，无需再添加 <code>@OptIn</code> 注解即可使用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.time.*

<span class="hljs-comment">// 获取当前时间</span>
<span class="hljs-keyword">val</span> now: Instant = Clock.System.now()

<span class="hljs-comment">// 计算时间差</span>
<span class="hljs-keyword">val</span> eventTime = Instant.parse(<span class="hljs-string">"2025-12-25T10:00:00Z"</span>)
<span class="hljs-keyword">val</span> timeUntilEvent: Duration = eventTime - now
println(<span class="hljs-string">"距离活动开始还有：<span class="hljs-subst">${timeUntilEvent.inWholeHours}</span> 小时"</span>)

<span class="hljs-comment">// 通过时间分量创建 Instant</span>
<span class="hljs-keyword">val</span> deadline = Instant.fromEpochSeconds(<span class="hljs-number">1735084800</span>)

<span class="hljs-comment">// 比较时间</span>
<span class="hljs-keyword">if</span> (now &gt; deadline) {
    println(<span class="hljs-string">"截止时间已过！"</span>)
}
</code></pre>
<p><strong>Android 场景建议</strong>：用它替代 <code>System.currentTimeMillis()</code>，实现更简洁、类型安全的时间处理。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SessionManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> sessionStart: Instant? = <span class="hljs-literal">null</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startSession</span><span class="hljs-params">()</span></span> {
        sessionStart = Clock.System.now()
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getSessionDuration</span><span class="hljs-params">()</span></span>: Duration {
        <span class="hljs-keyword">val</span> start = sessionStart ?: <span class="hljs-keyword">return</span> Duration.ZERO
        <span class="hljs-keyword">return</span> Clock.System.now() - start
    }
}
</code></pre>
<h2 data-id="heading-1">显式幕后字段（实验性）</h2>
<p><em>我终于可以摆脱命名两个变量的困局了！</em></p>
<p>你可以定义与暴露属性类型不同的幕后字段，无需再单独声明私有属性来实现这一点：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@OptIn(ExperimentalBackingFields::class)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserPreferences</span> {
    <span class="hljs-comment">// 幕后字段是可变列表，但对外暴露为不可变列表</span>
    <span class="hljs-keyword">val</span> recentSearches: List&lt;String&gt;
        field = mutableListOf()

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addSearch</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span> {
        recentSearches.add(query) <span class="hljs-comment">// 直接修改幕后字段</span>
        <span class="hljs-keyword">if</span> (recentSearches.size &gt; <span class="hljs-number">10</span>) {
            recentSearches.removeAt(<span class="hljs-number">0</span>)
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">val</span> prefs = UserPreferences()
prefs.addSearch(<span class="hljs-string">"kotlin 2.3"</span>)
prefs.addSearch(<span class="hljs-string">"coroutines"</span>)
<span class="hljs-comment">// 外头是无法使用幕后字段的</span>
<span class="hljs-comment">// prefs.recentSearches.add("flow")</span>
println(prefs.recentSearches) <span class="hljs-comment">// [kotlin 2.3, coroutines]</span>
</code></pre>
<p>Kotlin 2.3 之前你需要这样做（我确实对这个感到厌烦）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserPreferences</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _recentSearches = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">val</span> recentSearches: List&lt;String&gt; <span class="hljs-keyword">get</span>() = _recentSearches.toList()

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addSearch</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span> {
        _recentSearches.add(query)
    }
}
</code></pre>
<p>如果你对实现方法感到好奇：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16b983eecc6648d9a0d01360945316c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856976&amp;x-signature=wsu2JBYeIkg2kNGEZ6ziwbMKTkA%3D" alt="2_2.jpg" loading="lazy"/></p>
<p>其实就是增加了一个 <code>private</code> 的字段用于类的内部使用。</p>
<p>当然，作为实验性功能，你需要添加额外的编译条件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">kotlin {
    compilerOptions {
        freeCompilerArgs.add(<span class="hljs-string">"-Xexplicit-backing-fields"</span>)
    }
}
</code></pre>
<h2 data-id="heading-2">未使用返回值检查器（实验性）</h2>
<p>当你忘记使用某个接口的返回值时，该功能可以帮你捕获这类不易察觉的潜在 Bug。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// 有潜在问题的用法</span>
<span class="hljs-meta">@OptIn(ExperimentalUnusedReturnValueChecker::class)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">badprocess</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> list = mutableListOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)

    <span class="hljs-comment">// 警告：'remove' 的返回值未被使用</span>
    list.remove(<span class="hljs-number">2</span>) <span class="hljs-comment">// 你是否需要检查删除是否成功？</span>

    <span class="hljs-comment">// 警告：'plus' 的返回值未被使用</span>
    list.plus(<span class="hljs-number">4</span>) <span class="hljs-comment">// Bug！此操作不会修改原列表，而是返回一个新列表</span>

   <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 正确用法</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">goodprocess</span><span class="hljs-params">()</span></span> {
    
    <span class="hljs-keyword">val</span> removed = list.remove(<span class="hljs-number">2</span>)
    <span class="hljs-keyword">if</span> (!removed) println(<span class="hljs-string">"元素未找到"</span>)

    <span class="hljs-keyword">val</span> newList = list + <span class="hljs-number">4</span> <span class="hljs-comment">// 使用返回的新列表</span>
}
</code></pre>
<p>当一个表达式返回的不是 <code>Unit</code> 或 <code>Nothing</code> 类型的值，且没有被传递给其他函数、用于条件判断或以其他方式使用时，它就会发出警告。</p>
<p>该功能会帮助开发者检查可能存在的 Bug：</p>

























<table><thead><tr><th>表达式</th><th>Bug</th><th>修复方案</th></tr></thead><tbody><tr><td><code>list.plus(item)</code></td><td>返回新列表，不会修改原列表</td><td><code>list = list + item</code> 或 <code>list.add(item)</code></td></tr><tr><td><code>string.replace("a", "b")</code></td><td>返回新字符串，不会修改原字符串</td><td><code>val result = string.replace(...)</code></td></tr><tr><td><code>map.minus(key)</code></td><td>返回新映射，不会修改原映射</td><td><code>map = map - key</code></td></tr></tbody></table>
<p>额外的编译条件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">kotlin {
    compilerOptions {
        freeCompilerArgs.add(<span class="hljs-string">"-Xreturn-value-checker=check"</span>)
    }
}
</code></pre>
<h2 data-id="heading-3">增强的 UUID 支持（实验性）</h2>
<p>原生支持生成 v4（随机）和 v7（基于时间）类型的 <code>UUID</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.uuid.*

<span class="hljs-meta">@OptIn(ExperimentalUuidApi::class)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">generateIds</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 随机 UUID（v4）</span>
    <span class="hljs-keyword">val</span> randomId = Uuid.random()
    println(randomId) <span class="hljs-comment">// 示例：550e8400-e29b-41d4-a716-446655440000</span>

    <span class="hljs-comment">// 基于时间的 UUID（v7）- 可按创建时间排序</span>
    <span class="hljs-keyword">val</span> timeBasedId = Uuid.randomV7()

    <span class="hljs-comment">// 基于特定时间戳生成 v7 UUID</span>
    <span class="hljs-keyword">val</span> instant = Clock.System.now()
    <span class="hljs-keyword">val</span> historicalId = Uuid.randomV7(instant)

    <span class="hljs-comment">// 安全解析（无效时返回 null 而非抛出异常）</span>
    <span class="hljs-keyword">val</span> parsed: Uuid? = Uuid.parseOrNull(<span class="hljs-string">"invalid-uuid"</span>)

    <span class="hljs-comment">// 按时间顺序比较 v7 UUID</span>
    <span class="hljs-keyword">val</span> id1 = Uuid.randomV7()
    delay(<span class="hljs-number">100</span>)
    <span class="hljs-keyword">val</span> id2 = Uuid.randomV7()
    println(id1 &lt; id2) <span class="hljs-comment">// true - v7 UUID 支持按时间排序</span>
}
</code></pre>
<p>下面提供一个速查表帮助你如何选择合适的 UUID 版本：</p>

















<table><thead><tr><th>UUID 版本</th><th>使用场景</th></tr></thead><tbody><tr><td>v4 (<code>random()</code>)</td><td>通用唯一 ID，无需排序的场景</td></tr><tr><td>v7 (<code>randomV7()</code>)</td><td>数据库主键（可排序）、事件 ID 等需要按创建时间排序的场景</td></tr></tbody></table>
<p>额外的编译条件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">kotlin {
    compilerOptions {
        freeCompilerArgs.add(<span class="hljs-string">"-opt-in=kotlin.uuid.ExperimentalUuidApi"</span>)
    }
}
</code></pre>
<h2 data-id="heading-4">表达式体函数中支持 return</h2>
<p>在具有显式返回类型的单表达式函数中，可以使用 <code>return</code> 语句。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// userId 如果为空，函数返回 "default"</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getDisplayNameOrDefault</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>?)</span></span>: String = getDisplayName(userId ?: <span class="hljs-keyword">return</span> <span class="hljs-string">"default"</span>)

<span class="hljs-comment">// 复杂校验场景</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">validateEmail</span><span class="hljs-params">(email: <span class="hljs-type">String</span>)</span></span>: ValidationResult =
    <span class="hljs-keyword">when</span> {
        email.isBlank() -&gt; <span class="hljs-keyword">return</span> ValidationResult.Error(<span class="hljs-string">"Email required"</span>)
        !email.contains(<span class="hljs-string">"@"</span>) -&gt; <span class="hljs-keyword">return</span> ValidationResult.Error(<span class="hljs-string">"Invalid format"</span>)
        <span class="hljs-keyword">else</span> -&gt; ValidationResult.Success
    }
</code></pre>
<h2 data-id="heading-5">嵌套类型别名</h2>
<p>现在类型别名可以引用其他类型别名。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 基础类型别名</span>
<span class="hljs-keyword">typealias</span> UserId = String
<span class="hljs-keyword">typealias</span> ProductId = String

<span class="hljs-comment">// 嵌套类型别名</span>
<span class="hljs-keyword">typealias</span> UserProducts = Map&lt;UserId, List&lt;ProductId&gt;&gt;
<span class="hljs-keyword">typealias</span> UserProductsCallback = (UserProducts) -&gt; <span class="hljs-built_in">Unit</span>

<span class="hljs-comment">// 使用案例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductRepository</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserProducts</span><span class="hljs-params">(callback: <span class="hljs-type">UserProductsCallback</span>)</span></span> {
        <span class="hljs-keyword">val</span> products: UserProducts = mapOf(
            <span class="hljs-string">"user_1"</span> to listOf(<span class="hljs-string">"prod_a"</span>, <span class="hljs-string">"prod_b"</span>),
            <span class="hljs-string">"user_2"</span> to listOf(<span class="hljs-string">"prod_c"</span>)
        )
        callback(products)
    }
}
</code></pre>
<h2 data-id="heading-6">改进的 Swift 互操作性</h2>
<p>Kotlin 枚举现在会导出为原生 Swift 枚举，并且可变参数（<code>vararg</code>）函数可以正常工作。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin 代码</span>
<span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentStatus</span> {
    PENDING, COMPLETED, FAILED, REFUNDED
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processPayments</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> payments: <span class="hljs-type">Payment</span>)</span></span>: List&lt;Receipt&gt; {
    <span class="hljs-keyword">return</span> payments.map { process(it) }
}
</code></pre>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Swift 代码 - 现在可以自然调用</span>
<span class="hljs-keyword">let</span> status: <span class="hljs-type">PaymentStatus</span> <span class="hljs-operator">=</span> .completed
<span class="hljs-keyword">switch</span> status {
    <span class="hljs-keyword">case</span> .pending: <span class="hljs-built_in">print</span>(<span class="hljs-string">"Waiting..."</span>)
    <span class="hljs-keyword">case</span> .completed: <span class="hljs-built_in">print</span>(<span class="hljs-string">"Done!"</span>)
    <span class="hljs-keyword">case</span> .failed: <span class="hljs-built_in">print</span>(<span class="hljs-string">"Error"</span>)
    <span class="hljs-keyword">case</span> .refunded: <span class="hljs-built_in">print</span>(<span class="hljs-string">"Money back"</span>)
}

<span class="hljs-comment">// 可变参数也能直接使用</span>
<span class="hljs-keyword">let</span> receipts <span class="hljs-operator">=</span> processPayments(payment1, payment2, payment3)
</code></pre>
<h2 data-id="heading-7">Compose 编译器：Release 版本支持清晰堆栈追踪</h2>
<p>借助反混淆的堆栈信息，你可以在生产环境中调试 Compose 的崩溃问题。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build.gradle.kts</span>
composeCompiler {
    <span class="hljs-comment">// 启用组键格式的堆栈追踪（2.3 版本默认开启）</span>
    includeSourceInformation = <span class="hljs-literal">true</span>
}
</code></pre>
<p><strong>优化前</strong>：Release 包中的崩溃日志是混淆后的，难以定位问题。</p>
<p><strong>优化后</strong>：生成清晰的 Compose 组键，可通过 R8 映射文件关联到你的源代码，大幅提升调试效率。</p>
<h2 data-id="heading-8">Gradle 与 AGP 更新</h2>
<p><em>我现在看到 AGP 的更新，只想喊田文镜！</em></p>
<p>版本要求：</p>

























<table><thead><tr><th>工具</th><th>最低版本</th><th>最高版本</th></tr></thead><tbody><tr><td>Gradle</td><td>7.6.3</td><td>9.0.0</td></tr><tr><td>AGP（Android Gradle 插件）</td><td>8.2.2</td><td>8.13.0</td></tr><tr><td>Java</td><td>8</td><td>25</td></tr></tbody></table>
<p>AGP 9.0+ 的一个重要变更：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 旧写法 - 在 AGP 9.0+ 中不再生效</span>
plugins {
    id(<span class="hljs-string">"com.android.application"</span>)
    id(<span class="hljs-string">"kotlin-android"</span>) <span class="hljs-comment">// 需要移除这一行！</span>
}

<span class="hljs-comment">// 新写法 - kotlin-android 已内置到 AGP 9.0+</span>
plugins {
    id(<span class="hljs-string">"com.android.application"</span>)
    <span class="hljs-comment">// Kotlin 支持已自动启用</span>
}
</code></pre>
<h2 data-id="heading-9">数据流的穷举 when 表达式</h2>
<p>更智能的穷举检查，能够理解你的代码执行流程。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : Result&lt;T&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Loading : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleResult</span><span class="hljs-params">(result: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
    <span class="hljs-comment">// 编译器能识别所有分支已被覆盖</span>
    <span class="hljs-keyword">when</span> (result) {
        <span class="hljs-keyword">is</span> Result.Success -&gt; println(result.<span class="hljs-keyword">data</span>)
        <span class="hljs-keyword">is</span> Result.Error -&gt; println(result.message)
        Result.Loading -&gt; println(<span class="hljs-string">"Loading..."</span>)
        <span class="hljs-comment">// 无需写 'else' 分支 — 编译器会验证穷举性</span>
    }
}

<span class="hljs-comment">// 具备数据流感知能力</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">process</span><span class="hljs-params">(result: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt;?)</span></span> {
    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-comment">// 编译器知道此处 result 不为 null</span>
    <span class="hljs-keyword">when</span> (result) {
        <span class="hljs-keyword">is</span> Result.Success -&gt; {}
        <span class="hljs-keyword">is</span> Result.Error -&gt; {}
        Result.Loading -&gt; {}
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPermissionLevel</span><span class="hljs-params">(role: <span class="hljs-type">UserRole</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-comment">// 覆盖了 when 表达式之外的 Admin 场景</span>
    <span class="hljs-keyword">if</span> (role == UserRole.ADMIN) <span class="hljs-keyword">return</span> <span class="hljs-number">99</span>

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (role) {
        UserRole.MEMBER -&gt; <span class="hljs-number">10</span>
        UserRole.GUEST -&gt; <span class="hljs-number">1</span>
        <span class="hljs-comment">// 你不再需要编写这个 else 分支了 </span>
        <span class="hljs-comment">// else -&gt; throw IllegalStateException()</span>
    }
}
</code></pre>
<h2 data-id="heading-10">总结</h2>
<p>Kotlin 2.3.0 主要致力于稳定实验性特性，并改进多平台互操作性。</p>
<p>其中，稳定的时间 API 和显式幕后字段是对 Android 开发者而言最亮眼的更新。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nginx、HAProxy、Envoy、Spring Cloud Gateway、LVS：负载均衡与流量治理工具对比]]></title>    <link>https://juejin.cn/post/7602814773497184298</link>    <guid>https://juejin.cn/post/7602814773497184298</guid>    <pubDate>2026-02-05T00:48:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602814773497184298" data-draft-id="7602816610932293695" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nginx、HAProxy、Envoy、Spring Cloud Gateway、LVS：负载均衡与流量治理工具对比"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-05T00:48:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nginx、HAProxy、Envoy、Spring Cloud Gateway、LVS：负载均衡与流量治理工具对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:48:36.000Z" title="Thu Feb 05 2026 00:48:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代分布式架构中，<strong>负载均衡与流量治理</strong>是保障系统高可用、弹性的核心技术。Nginx、HAProxy、Envoy、Spring Cloud Gateway 和 LVS 作为五类主流工具，虽均承担流量代理职责，但在设计理念、技术实现、适用场景上存在显著差异。本文从<strong>核心定位、功能特性、性能表现</strong>三方面展开分析，帮助读者理解五者的本质区别。</p>
<hr/>
<h2 data-id="heading-0">一、核心定位：从边缘到内部的流量分层治理</h2>
<h3 data-id="heading-1">1. <strong>LVS：四层负载均衡的标杆</strong></h3>
<ul>
<li>
<p><strong>定位</strong>：基于 Linux 内核的<strong>四层（传输层）负载均衡器</strong>，专注于 TCP/UDP 流量的高效分发。</p>
</li>
<li>
<p><strong>技术特性</strong>：</p>
<ul>
<li><strong>内核级处理</strong>：通过修改数据包目标 MAC/IP 实现流量转发，无额外流量产生。</li>
<li><strong>高吞吐量</strong>：单节点可处理百万级并发，延迟低至微秒级。</li>
<li><strong>稳定性</strong>：与 Keepalived 结合实现高可用，适合金融、电商等高并发场景。</li>
</ul>
</li>
<li>
<p><strong>典型场景</strong>：数据库集群代理、缓存服务负载均衡、跨机房流量调度。</p>
</li>
</ul>
<h3 data-id="heading-2">2. <strong>Nginx：七层反向代理的通用方案</strong></h3>
<ul>
<li>
<p><strong>定位</strong>：<strong>七层（应用层）反向代理服务器</strong>，支持 HTTP/HTTPS、TCP 等协议。</p>
</li>
<li>
<p><strong>技术特性</strong>：</p>
<ul>
<li><strong>灵活路由</strong>：基于 URL、域名、请求头等实现复杂路由策略。</li>
<li><strong>Web 服务器功能</strong>：静态资源托管、SSL 终止、缓存加速。</li>
<li><strong>健康检查</strong>：端口级检测，支持被动故障转移。</li>
</ul>
</li>
<li>
<p><strong>典型场景</strong>：Web 应用反向代理、静态资源服务、API 网关基础功能。</p>
</li>
</ul>
<h3 data-id="heading-3">3. <strong>HAProxy：四层/七层混合负载均衡的专家</strong></h3>
<ul>
<li>
<p><strong>定位</strong>：支持四层和七层负载均衡的开源工具，兼顾性能与功能。</p>
</li>
<li>
<p><strong>技术特性</strong>：</p>
<ul>
<li><strong>多协议支持</strong>：TCP 会话保持、HTTP 健康检查、URL 检测。</li>
<li><strong>高级算法</strong>：动态加权轮询、一致性哈希、最少连接数。</li>
<li><strong>会话保持</strong>：Cookie/Source IP 绑定，解决分布式会话问题。</li>
</ul>
</li>
<li>
<p><strong>典型场景</strong>：MySQL 读写分离、微服务混合流量治理。</p>
</li>
</ul>
<h3 data-id="heading-4">4. <strong>Envoy：云原生服务网格的核心组件</strong></h3>
<ul>
<li>
<p><strong>定位</strong>：Service Mesh 数据平面核心组件，管理<strong>东西向服务流量</strong>。</p>
</li>
<li>
<p><strong>技术特性</strong>：</p>
<ul>
<li><strong>动态配置</strong>：通过 xDS API 实时更新路由、熔断等策略。</li>
<li><strong>可观测性</strong>：集成指标、日志、分布式追踪，支持全链路监控。</li>
<li><strong>高级治理</strong>：流量镜像、故障注入、协议转换（如 HTTP/1.1 到 HTTP/2）。</li>
</ul>
</li>
<li>
<p><strong>典型场景</strong>：Kubernetes 服务网格、微服务间流量治理、灰度发布。</p>
</li>
</ul>
<h3 data-id="heading-5">5. <strong>Spring Cloud Gateway：Java 微服务的 API 网关</strong></h3>
<ul>
<li>
<p><strong>定位</strong>：Spring 生态内的 API 网关，专注于<strong>业务侧流量治理</strong>。</p>
</li>
<li>
<p><strong>技术特性</strong>：</p>
<ul>
<li><strong>动态路由</strong>：结合服务注册中心（如 Nacos）自动感知后端变化。</li>
<li><strong>过滤器链</strong>：集成 Sentinel 实现限流熔断、OAuth2 实现鉴权。</li>
<li><strong>响应式架构</strong>：基于 Netty 的异步非阻塞模型。</li>
</ul>
</li>
<li>
<p><strong>典型场景</strong>：Spring Boot 应用入口、微服务 API 网关。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-6">二、功能对比：从基础代理到智能治理</h2>
<h3 data-id="heading-7">1. <strong>协议与负载均衡</strong></h3>



































<table><thead><tr><th>工具</th><th>协议支持</th><th>负载均衡算法</th></tr></thead><tbody><tr><td>LVS</td><td>TCP/UDP</td><td>RR、WRR、LC、WLC</td></tr><tr><td>Nginx</td><td>HTTP/HTTPS、TCP、gRPC</td><td>轮询、IP 哈希、最少连接</td></tr><tr><td>HAProxy</td><td>TCP、HTTP、WebSocket</td><td>RR、加权轮询、一致性哈希</td></tr><tr><td>Envoy</td><td>HTTP/1.1/2、gRPC、Redis</td><td>加权轮询、最少请求、随机</td></tr><tr><td>Spring Gateway</td><td>HTTP/HTTPS、WebSocket</td><td>轮询、随机、权重</td></tr></tbody></table>
<h3 data-id="heading-8">2. <strong>动态配置与扩展性</strong></h3>
<ul>
<li><strong>LVS</strong>：依赖 Keepalived 实现高可用，配置需手动调整，灵活性低。</li>
<li><strong>Nginx</strong>：静态配置需重载生效，扩展依赖 Lua 模块，适合简单场景。</li>
<li><strong>HAProxy</strong>：支持 ACL 和 Lua 脚本，动态扩展能力中等。</li>
<li><strong>Envoy</strong>：通过 xDS API 实现动态配置，支持自定义 Filter，扩展性强。</li>
<li><strong>Spring Gateway</strong>：基于 Spring 生态动态路由，集成 Sentinel 实现限流。</li>
</ul>
<h3 data-id="heading-9">3. <strong>安全与可观测性</strong></h3>



































<table><thead><tr><th>工具</th><th>安全特性</th><th>可观测性支持</th></tr></thead><tbody><tr><td>LVS</td><td>基础 ACL、IP 伪装</td><td>无内置监控，依赖第三方工具</td></tr><tr><td>Nginx</td><td>SSL 终止、请求限速</td><td>日志、基础指标</td></tr><tr><td>HAProxy</td><td>会话保持、TCP 健康检查</td><td>统计页面、连接状态统计</td></tr><tr><td>Envoy</td><td>mTLS、JWT 验证、流量镜像</td><td>指标、日志、分布式追踪</td></tr><tr><td>Spring Gateway</td><td>Spring Security、OAuth2 集成</td><td>Spring Boot Actuator、Prometheus</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">三、性能基准：数据驱动的选择依据</h2>
<h3 data-id="heading-11">1. <strong>纯 HTTP 场景</strong></h3>
<ul>
<li><strong>Nginx</strong>：单节点可处理 <strong>5 万+ QPS</strong>，延迟低于 10ms。</li>
<li><strong>HAProxy</strong>：TCP 场景下吞吐量比 Nginx 高 15-20%，内存占用低 30%。</li>
<li><strong>Envoy</strong>：gRPC 场景性能优于 Nginx，但 HTTP 吞吐量较低（约 900 QPS）。</li>
<li><strong>LVS</strong>：百万级并发，延迟微秒级，但需配合 Keepalived 使用。</li>
</ul>
<h3 data-id="heading-12">2. <strong>复杂治理场景</strong></h3>
<ul>
<li><strong>Envoy</strong>：支持动态路由、熔断降级、流量镜像，适合微服务网格。</li>
<li><strong>Spring Gateway</strong>：集成 Sentinel 实现细粒度限流，适合 Java 业务逻辑。</li>
<li><strong>HAProxy</strong>：支持 URL 检测和会话保持，适合数据库读写分离。</li>
</ul>
<hr/>
<h2 data-id="heading-13">四、选型建议：场景化决策</h2>
<h3 data-id="heading-14">1. <strong>传统 Web 应用</strong></h3>
<ul>
<li><strong>选择 Nginx</strong>：处理静态资源、SSL 终止、高并发 HTTP 请求。</li>
</ul>
<h3 data-id="heading-15">2. <strong>TCP/UDP 服务代理</strong></h3>
<ul>
<li><strong>选择 LVS</strong>：极致性能与低延迟，适合数据库、缓存集群。</li>
<li><strong>选择 HAProxy</strong>：需会话保持或健康检查时使用。</li>
</ul>
<h3 data-id="heading-16">3. <strong>云原生微服务</strong></h3>
<ul>
<li><strong>选择 Envoy</strong>：动态流量管理、服务网格集成，支撑 Kubernetes 生态。</li>
</ul>
<h3 data-id="heading-17">4. <strong>Java 微服务网关</strong></h3>
<ul>
<li><strong>选择 Spring Cloud Gateway</strong>：无缝对接 Spring 生态，快速实现鉴权、限流。</li>
</ul>
<h3 data-id="heading-18">5. <strong>混合负载场景</strong></h3>
<ul>
<li><strong>分层架构</strong>：LVS 作为边缘层处理入口流量，Envoy 或 Spring Gateway 作为内部网关。</li>
</ul>
<hr/>
<h2 data-id="heading-19">五、协同架构：多层网关的实践模式</h2>
<p>现代架构常采用<strong>分层网关</strong>设计：</p>
<ol>
<li><strong>边缘层（LVS/Nginx）</strong> ：抗住外部流量，处理 SSL 终止、DDoS 防护。</li>
<li><strong>内部层（Envoy/Spring Gateway）</strong> ：动态路由、服务治理，适配微服务动态性。</li>
</ol>
<hr/>
<h2 data-id="heading-20">总结</h2>
<p>五类工具各有侧重：</p>
<ul>
<li><strong>LVS</strong>：四层负载均衡性能标杆，适合传统基础设施层。</li>
<li><strong>Nginx</strong>：七层反向代理通用方案，功能全面且部署灵活。</li>
<li><strong>HAProxy</strong>：四层/七层混合负载均衡专家，平衡性能与功能。</li>
<li><strong>Envoy</strong>：云原生服务网格核心组件，支撑复杂治理需求。</li>
<li><strong>Spring Cloud Gateway</strong>：Java 微服务网关首选，深度集成 Spring 生态。</li>
</ul>
<p>选择时需结合<strong>协议需求、性能要求、技术栈适配性</strong>综合考量，必要时通过分层架构发挥协同优势。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>