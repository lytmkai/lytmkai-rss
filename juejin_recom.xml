<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[前端渲染大体积 多页面pdf]]></title>    <link>https://juejin.cn/post/7571278865517051954</link>    <guid>https://juejin.cn/post/7571278865517051954</guid>    <pubDate>2025-11-11T10:41:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571278865517051954" data-draft-id="7571279513246695450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端渲染大体积 多页面pdf"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T10:41:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无名小兵"/> <meta itemprop="url" content="https://juejin.cn/user/1772869560048312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端渲染大体积 多页面pdf
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772869560048312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无名小兵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:41:35.000Z" title="Tue Nov 11 2025 10:41:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">示例</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d690d584981a40688984f792c5da578b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5ZCN5bCP5YW1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462494&amp;x-signature=QTyb7S2hwoUVMbcoGkON1dlt8uM%3D" alt="20251111183906_rec_.gif" loading="lazy"/></p>
<h2 data-id="heading-1">介绍</h2>
<p>首先使用的是 vue-pdf-embed渲染pdf，前段时间测试测出一个bug，当pdf文档页码过多(500页，7M)时，会出现页面卡死现象。首先尝试使用loading解决，css position解决，worker但是无济于事。然后开始研究vue-pdf-embed，发现内部是基于的pdfjs封装了一层，vue-pdf-embed内容是一次性渲染全部pdf。其实也是可以使用翻页的方式，那么就是一页一页的渲染，不会同时渲染很多页pdf。</p>
<h2 data-id="heading-2">技术栈</h2>
<p>vue3 pdfjs</p>
<h2 data-id="heading-3">解决方案</h2>
<p>有一个重要的点是：pdfjs 可以获取到pdf的总页数，以及每一页的pdf的高度。那么先使用一个div撑起父容器，然后滚动父容器，根据scrollTop/pdfHeight 获取到当前视口该展示哪一页 currentPage。</p>
<p>要解决的问题：<strong>向下滚动(相对简单)，向上滚动，快速下拉，快速上拉</strong>。</p>
<p>以下有5种方案，为什么会有这么多种方案呢，都是做着做着 发现更好的方案，以及一些pdfjs的限制问题。最终方案是最后2种。</p>
<ol>
<li>1个canvas渲染，分别渲染前一张pdf的上半部分和后一张pdf的下半部分（放弃，pdfjs不允许使用同一个canvas重复渲染）</li>
<li>2个canvas渲染，例如先绘制第1页和第1页，然后currentPage到2的时候 删除2个canvas，第1个canvas绘制第2页，第2个canvas绘制第3页。以此类推。（放弃每次切换页数的时候，页面都会一闪一闪的）</li>
<li>多个canvas  弊端 向上滚动一页 全部要重新绘制</li>
<li>每滚动一页 将最上面的canvas删除 在最后面添加新的canvas，其中还有边界值需要处理，比如pdf本来就只有1页，pdf 到最后一页和首页。</li>
<li>维护一个数组 数组长度为3（或者5），数组中的每个值对应pageindex,currentPage变化后，更新数组，然后和dom对比，做diff操作。</li>
</ol>
<p>方案5的好处，无须考虑那么多其他的,第4种方案还要解决快速拉动的问题。每次切换pageIndex,前面的canvas被删除掉了(其实不做删除操作也是可以的，因为每个canvas所在的位置是固定的，且不会重叠)，后面的canvas新增了，不会让用户看见一闪的现象。</p>
<h2 data-id="heading-4">全部代码</h2>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  &lt;!-- <span class="hljs-title class_">Canvas</span> 显示区域 --&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
    <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"loading"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"canvas-container"</span>
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"canvasContainer"</span>
    @<span class="hljs-attr">scroll.passive</span>=<span class="hljs-string">"handleScroll"</span>
    <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ overflow: 'auto' }"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mark"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ height: totalHeight + 'px' }"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">

<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> pdfjsLib <span class="hljs-keyword">from</span> <span class="hljs-string">"pdfjs-dist/build/pdf"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">PdfWorker</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"pdfjs-dist/build/pdf.worker.mjs?url"</span>;

<span class="hljs-keyword">import</span> { onMounted, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
pdfjsLib.<span class="hljs-property">GlobalWorkerOptions</span>.<span class="hljs-property">workerSrc</span> = <span class="hljs-title class_">PdfWorker</span>; <span class="hljs-comment">// 使用woker</span>

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">url</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-string">""</span>,
  },

});
<span class="hljs-keyword">const</span> totalHeight = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 总高度</span>
<span class="hljs-keyword">const</span> totalPages = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// 总页码</span>
<span class="hljs-keyword">const</span> pageHeight = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// 一页高度</span>
<span class="hljs-keyword">let</span> currentPage = <span class="hljs-number">1</span>; <span class="hljs-comment">// 当前page</span>
<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">let</span> pdfDoc = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 不能使用ref  会报错</span>
<span class="hljs-keyword">let</span> renderIndex = <span class="hljs-number">0</span>;
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(props.<span class="hljs-property">url</span>, <span class="hljs-string">"props.url"</span>);
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">url</span>) {
    <span class="hljs-title function_">loadPdf</span>(props.<span class="hljs-property">url</span>, renderIndex);
  }
});

<span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">url</span>,
  <span class="hljs-function">(<span class="hljs-params">newVal, oldVal</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (canvasContainer.<span class="hljs-property">value</span>) {
      canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span> = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">let</span> canvases = canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">"canvas"</span>);
      canvases.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
        canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">removeChild</span>(item);
      });
    }
    <span class="hljs-keyword">if</span> (newVal) {
      <span class="hljs-comment">// console.log("newVal", newVal);</span>
      renderIndex++;
      currentPage = <span class="hljs-number">1</span>;
      allCanvasIndex = [];
      <span class="hljs-title function_">loadPdf</span>(newVal, renderIndex);
    }
  }
);
<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">"error"</span>]);
<span class="hljs-keyword">const</span> canvasContainer = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">let</span> allCanvas = [];
<span class="hljs-keyword">let</span> allCanvasIndex = [];
<span class="hljs-comment">// 一次性渲染多少张pdf</span>
<span class="hljs-keyword">let</span> canvasMaxNum = <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;
<span class="hljs-keyword">let</span> t = <span class="hljs-number">0</span>;

<span class="hljs-keyword">let</span> lastScrollTop = <span class="hljs-number">0</span>;
<span class="hljs-keyword">let</span> renderPartialIndex = <span class="hljs-number">0</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentIndexs</span>(<span class="hljs-params">nindex</span>) {
  <span class="hljs-keyword">let</span> currentIndexs = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; canvasMaxNum; i++) {
    <span class="hljs-keyword">if</span> (nindex + i &lt;= totalPages.<span class="hljs-property">value</span>) {
      currentIndexs.<span class="hljs-title function_">push</span>(nindex + i);
    }
  }
  <span class="hljs-keyword">return</span> currentIndexs;
}
<span class="hljs-comment">// 新增单个canvas</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addCanvas</span>(<span class="hljs-params">npageIndex</span>) {
  <span class="hljs-keyword">let</span> ncanvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"canvas"</span>);
  ncanvas.<span class="hljs-property">classList</span> = [<span class="hljs-string">"canvasshow"</span>];
  canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">appendChild</span>(ncanvas);

  ncanvas.<span class="hljs-property">id</span> = <span class="hljs-string">"topCanvas"</span> + npageIndex;
  ncanvas.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${pageHeight.value * (npageIndex - <span class="hljs-number">1</span>)}</span>px`</span>;
  <span class="hljs-title function_">renderPartialA</span>(pdfDoc, npageIndex, ncanvas);
}
<span class="hljs-comment">//监听滚动</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleScroll</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-comment">// console.log(e,'eee');</span>
  
  <span class="hljs-keyword">const</span> canvasContainer0 = e.<span class="hljs-property">target</span>;
  <span class="hljs-keyword">const</span> scrollTop = canvasContainer0.<span class="hljs-property">scrollTop</span>;
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">"scroll"</span>, scrollTop);
  <span class="hljs-built_in">clearTimeout</span>(t);
  <span class="hljs-comment">// 防抖</span>
  t = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (totalPages.<span class="hljs-property">value</span> &lt;= canvasMaxNum) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">let</span> page = scrollTop / pageHeight.<span class="hljs-property">value</span>;
    <span class="hljs-keyword">let</span> npage = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">1</span>, page)); <span class="hljs-comment">// 当前视图</span>

    <span class="hljs-keyword">if</span> (npage != currentPage) {
    <span class="hljs-comment">// 获取视图应该展示的pageIndex</span>
      <span class="hljs-keyword">let</span> currentIndexs = <span class="hljs-title function_">getCurrentIndexs</span>(npage);
      currentIndexs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!allCanvasIndex.<span class="hljs-title function_">includes</span>(item)) {
          <span class="hljs-keyword">if</span> (item &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-title function_">addCanvas</span>(item);
          }
        }
      });
      <span class="hljs-comment">//移除操作</span>
      allCanvasIndex.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!currentIndexs.<span class="hljs-title function_">includes</span>(item)) {
          <span class="hljs-keyword">let</span> canvas = canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#topCanvas"</span> + item);
          <span class="hljs-keyword">if</span> (canvas) {
            canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">removeChild</span>(canvas);
          }
        }
      });
      allCanvasIndex = currentIndexs;
    }
    currentPage = npage;
  },<span class="hljs-number">50</span>);
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadPdf</span>(<span class="hljs-params">url, renderIndex1</span>) {
  <span class="hljs-comment">//   if (!url) return;</span>
  <span class="hljs-keyword">try</span> {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;

    pdfDoc = <span class="hljs-keyword">await</span> pdfjsLib.<span class="hljs-title function_">getDocument</span>({ <span class="hljs-attr">url</span>: url }).<span class="hljs-property">promise</span>;
    <span class="hljs-keyword">if</span> (renderIndex1 !== renderIndex) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// this.pdfDoc=pdfDoc</span>
    totalPages.<span class="hljs-property">value</span> = pdfDoc.<span class="hljs-property">numPages</span>;
    <span class="hljs-comment">// 先渲染全部或者canvasMaxNum</span>
    allCanvas = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(totalPages.<span class="hljs-property">value</span>, canvasMaxNum))
      .<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>)
      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
      <span class="hljs-comment">// 维护allCanvasIndex</span>
        allCanvasIndex.<span class="hljs-title function_">push</span>(index + <span class="hljs-number">1</span>);
        <span class="hljs-keyword">let</span> ncanvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"canvas"</span>);
        ncanvas.<span class="hljs-property">id</span> = <span class="hljs-string">"topCanvas"</span> + (index + <span class="hljs-number">1</span>);
        ncanvas.<span class="hljs-property">classList</span> = [<span class="hljs-string">"canvasshow"</span>];
        <span class="hljs-keyword">return</span> ncanvas;
      });
    renderPartialIndex++;
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">renderPartial</span>(pdfDoc, <span class="hljs-literal">true</span>, renderPartialIndex);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"PDF 加载失败:"</span>, error);
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">"error"</span>, error);
  } <span class="hljs-keyword">finally</span> {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  }
}
<span class="hljs-keyword">let</span> scale0=<span class="hljs-number">1</span>
<span class="hljs-comment">// 绘制单个pdf页</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderPartialA</span>(<span class="hljs-params">pdfDoc, pageIndex, canvas</span>) {
  <span class="hljs-keyword">if</span> (!pdfDoc) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> pdfDoc.<span class="hljs-title function_">getPage</span>(pageIndex);

    <span class="hljs-keyword">const</span> viewport = page.<span class="hljs-title function_">getViewport</span>({ <span class="hljs-attr">scale</span>: scale0 });

    <span class="hljs-keyword">const</span> fullWidth = viewport.<span class="hljs-property">width</span>;
    <span class="hljs-keyword">const</span> fullHeight = viewport.<span class="hljs-property">height</span>;


           canvas.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = fullWidth
        canvas.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = fullHeight
           canvas.<span class="hljs-property">width</span> = fullWidth
        canvas.<span class="hljs-property">height</span> = fullHeight
    <span class="hljs-title function_">renderPartialArea</span>(page, clipParamsTop, canvas);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">//  Cannot read private member #pagePromises from an object whose class did not declare it</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"渲染失败:"</span>, error);
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getPageDimensions</span> = (<span class="hljs-params">ratio</span>) =&gt; {
  <span class="hljs-keyword">let</span> width
  <span class="hljs-keyword">let</span> height

  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">height</span> &amp;&amp; !props.<span class="hljs-property">width</span>) {
    height = props.<span class="hljs-property">height</span>
    width = height / ratio
  } <span class="hljs-keyword">else</span> {
    width = props.<span class="hljs-property">width</span> ?? canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-property">clientWidth</span>
    height = width * ratio
  }

  <span class="hljs-keyword">return</span> [width, height]
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderPartial</span>(<span class="hljs-params">pdfDoc, init, renderPartialIndex1</span>) {
  <span class="hljs-keyword">if</span> (!pdfDoc) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> ps = allCanvas.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> pdfDoc.<span class="hljs-title function_">getPage</span>(<span class="hljs-number">1</span> + index);
    });
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(ps).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">pages</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (renderPartialIndex1 !== renderPartialIndex) {
        <span class="hljs-keyword">return</span>; 
      }
      <span class="hljs-keyword">let</span> page = pages[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">let</span> w = canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-property">clientWidth</span>;
          <span class="hljs-keyword">const</span> viewWidth = page.<span class="hljs-property">view</span>[<span class="hljs-number">2</span>] - page.<span class="hljs-property">view</span>[<span class="hljs-number">0</span>]
           <span class="hljs-keyword">const</span> viewHeight = page.<span class="hljs-property">view</span>[<span class="hljs-number">3</span>] - page.<span class="hljs-property">view</span>[<span class="hljs-number">1</span>]
          <span class="hljs-keyword">let</span> isTransposed=<span class="hljs-literal">false</span>  
           <span class="hljs-keyword">const</span> pageWidth = isTransposed ? viewHeight : viewWidth
            <span class="hljs-keyword">const</span> [actualWidth, actualHeight] = <span class="hljs-title function_">getPageDimensions</span>(
          isTransposed ? viewWidth / viewHeight : viewHeight / viewWidth
        )
    <span class="hljs-keyword">let</span> scale=actualWidth  * <span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>/ pageWidth
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(scale,<span class="hljs-string">'scale'</span>);
      scale0=scale
      <span class="hljs-keyword">const</span> viewport = page.<span class="hljs-title function_">getViewport</span>({ <span class="hljs-attr">scale</span>: scale});
      <span class="hljs-keyword">const</span> fullWidth = viewport.<span class="hljs-property">width</span>;
      <span class="hljs-keyword">const</span> fullHeight = viewport.<span class="hljs-property">height</span>;
      pageHeight.<span class="hljs-property">value</span> = (fullHeight * (w - <span class="hljs-number">10</span>)) / fullWidth;
      totalHeight.<span class="hljs-property">value</span> = totalPages.<span class="hljs-property">value</span> * pageHeight.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">if</span> (init) {
        allCanvas.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (index == <span class="hljs-number">0</span>) {
            item.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-number">0</span>}</span>px`</span>;
          } <span class="hljs-keyword">else</span> {
            item.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${pageHeight.value * index}</span>px`</span>;
          }
          canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">appendChild</span>(item);
        });
      }

      <span class="hljs-comment">// 根据预设计算裁剪参数</span>
 

      pages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">page, index</span>) =&gt;</span> {
          allCanvas[index].<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = fullWidth
        allCanvas[index].<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = fullHeight
          allCanvas[index].<span class="hljs-property">width</span> = fullWidth
        allCanvas[index].<span class="hljs-property">height</span> = fullHeight
        <span class="hljs-title function_">renderPartialArea</span>(page, clipParamsTop, allCanvas[index]);
      });
    });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">//  Cannot read private member #pagePromises from an object whose class did not declare it</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"渲染失败:"</span>, error);
  }
}

<span class="hljs-keyword">const</span> scale = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderPartialArea</span>(<span class="hljs-params">page, clipParams, canvas</span>) {
  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);

  <span class="hljs-keyword">const</span> { clipX, clipY, clipWidth, clipHeight } = clipParams;
  
  <span class="hljs-keyword">const</span> partialViewport = page.<span class="hljs-title function_">getViewport</span>({ <span class="hljs-attr">scale</span>: scale0 }).<span class="hljs-title function_">clone</span>({
    <span class="hljs-attr">scale</span>: scale0,
  });

  <span class="hljs-comment">// 应用裁剪和渲染</span>
  ctx.<span class="hljs-title function_">save</span>();
  ctx.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);

  <span class="hljs-keyword">const</span> renderContext = {
    <span class="hljs-attr">canvasContext</span>: ctx,
    <span class="hljs-attr">viewport</span>: partialViewport,
  };

  <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">render</span>(renderContext).<span class="hljs-property">promise</span>;
  ctx.<span class="hljs-title function_">restore</span>();
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.canvasshow</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">pointer-events</span>: none;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.partial-pdf-viewer</span> {
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
  <span class="hljs-comment">/* border-radius: 8px; */</span>
  <span class="hljs-comment">/* padding: 16px; */</span>
}

<span class="hljs-selector-class">.control-panel</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-wrap</span>: wrap;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#f5f5f5</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}

<span class="hljs-selector-class">.control-group</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.clip-controls</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.clip-controls</span> &gt; <span class="hljs-selector-tag">div</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[type=<span class="hljs-string">"number"</span>]</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">60px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">4px</span>;
}

<span class="hljs-selector-class">.canvas-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">display</span>: inline-block;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>;
  <span class="hljs-attribute">background</span>: white;
}
<span class="hljs-selector-class">.canvas-container</span>::-webkit-scrollbar {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">8px</span>;
}
<span class="hljs-selector-class">.canvas-container</span>::-webkit-scrollbar-thumb {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#c1c1c1</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}
<span class="hljs-selector-class">.mark</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">z-index</span>: -<span class="hljs-number">10</span>;
  <span class="hljs-attribute">pointer-events</span>: none;
}
<span class="hljs-selector-tag">canvas</span> {
  <span class="hljs-attribute">display</span>: block;
}

<span class="hljs-selector-class">.loading</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.7</span>);
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}

<span class="hljs-selector-class">.info-panel</span> {
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#f0f0f0</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 协议（Protocol）指南（三）：Primary Associated Type、some/any 与泛型式协议实战]]></title>    <link>https://juejin.cn/post/7570271574348447753</link>    <guid>https://juejin.cn/post/7570271574348447753</guid>    <pubDate>2025-11-10T00:30:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570271574348447753" data-draft-id="7554198278955712538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 协议（Protocol）指南（三）：Primary Associated Type、some/any 与泛型式协议实战"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2025-11-10T00:30:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 协议（Protocol）指南（三）：Primary Associated Type、some/any 与泛型式协议实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T00:30:22.000Z" title="Mon Nov 10 2025 00:30:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么 Swift 5.7 再次“颠覆”协议</h2>
<p>在 Swift 5.7 之前，带关联类型的协议只能当约束 <code>&lt;T: Sequence&gt;</code>，不能当类型 <code>Sequence</code>。</p>
<p>这导致两个老大难：</p>
<ol>
<li>声明变量/参数/返回值时，必须再包一层类型擦除（<code>AnySequence&lt;Int&gt;</code>）。</li>
<li>泛型函数无法“一眼看出”序列里到底是什么元素。</li>
</ol>
<p>Swift 5.7 一次性给出三把新钥匙：</p>

























<table><thead><tr><th>特性</th><th>关键词</th><th>解决痛点</th></tr></thead><tbody><tr><td>主要关联类型</td><td><code>protocol Sequence&lt;Element&gt;</code></td><td>把最常用的关联类型“提级”到协议名上</td></tr><tr><td>不透明参数</td><td><code>some Sequence&lt;Int&gt;</code></td><td>直接当参数类型，编译期确定，零运行时开销</td></tr><tr><td>存在性类型</td><td><code>any Sequence&lt;Int&gt;</code></td><td>真·变量类型，运行时盒子，语法终于可读</td></tr></tbody></table>
<h2 data-id="heading-1">Primary Associated Type：把“泛型参数”搬到协议头上</h2>
<ol>
<li>标准库示例</li>
</ol>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Swift 5.7 标准库定义</span>
<span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Sequence</span>&lt;<span class="hljs-title class_">Element</span>&gt; {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Iterator</span>: <span class="hljs-type">IteratorProtocol</span> <span class="hljs-keyword">where</span> <span class="hljs-type">Iterator</span>.<span class="hljs-type">Element</span> <span class="hljs-operator">==</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIterator</span>() -&gt; <span class="hljs-type">Iterator</span>
}
</code></pre>
<p><code>Element</code> 被写到协议名后面，成为主要关联类型。</p>
<p>于是我们可以像泛型结构体一样，直接写：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">sum</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">numbers</span>: <span class="hljs-keyword">some</span> <span class="hljs-type">Sequence</span>&lt;<span class="hljs-type">Int</span>&gt;) -&gt; <span class="hljs-type">Int</span> {   <span class="hljs-comment">// ① 参数类型</span>
    numbers.reduce(<span class="hljs-number">0</span>, <span class="hljs-operator">+</span>)
}

<span class="hljs-keyword">let</span> total <span class="hljs-operator">=</span> sum([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] <span class="hljs-operator">+</span> [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>])            <span class="hljs-comment">// ② 数组拼接也适用</span>
</code></pre>
<ol start="2">
<li>为自己协议添加“主关联类型”</li>
</ol>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Feed</span>&lt;<span class="hljs-title class_">Element</span>&gt; {          <span class="hljs-comment">// ① 把最常用的关联类型提出来</span>
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Element</span>?
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">IteratorFeed</span>: <span class="hljs-title class_">Feed</span> {
    <span class="hljs-keyword">var</span> a <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, b <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Int</span>? {
        <span class="hljs-keyword">let</span> next <span class="hljs-operator">=</span> a
        a <span class="hljs-operator">=</span> b
        b <span class="hljs-operator">=</span> next <span class="hljs-operator">+</span> a
        <span class="hljs-keyword">return</span> next
    }
}

<span class="hljs-comment">// ② 立刻享受 some/any 语法</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIntFeed</span>() -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">Feed</span>&lt;<span class="hljs-type">Int</span>&gt; {
    <span class="hljs-type">IteratorFeed</span>()
}

<span class="hljs-keyword">var</span> feeds: [<span class="hljs-keyword">any</span> <span class="hljs-type">Feed</span>&lt;<span class="hljs-type">Int</span>&gt;] <span class="hljs-operator">=</span> []   <span class="hljs-comment">// ③ 数组里放不同实现，无需再包 AnyFeed</span>
</code></pre>
<p>规则</p>
<ul>
<li>只能把一个或多个 <code>associatedtype</code> 声明为“主要”，不强制全部。</li>
<li>主要关联类型顺序不影响使用，但建议按“常用度”排序。</li>
<li>一旦声明，协议就获得“泛型形参”资格，可直接写 <code>Feed&lt;Int&gt;</code>。</li>
</ul>
<h2 data-id="heading-2">some vs. any：一句话区分</h2>



































<table><thead><tr><th>维度</th><th><code>some P</code></th><th><code>any P</code></th></tr></thead><tbody><tr><td>语义</td><td>编译期确定的<strong>某个</strong>具体类型</td><td>运行时存在的<strong>任何</strong>具体类型</td></tr><tr><td>内存布局</td><td>无间接寻址，内联存储</td><td>存在性容器（Box），通过指针引用</td></tr><tr><td>主要用法</td><td>返回值、泛型约束</td><td>变量、集合元素、函数参数</td></tr><tr><td>性能</td><td>零额外开销</td><td>轻微运行时开销（Box管理）</td></tr><tr><td>使用限制</td><td>不能用于<code>var</code>/集合类型声明</td><td>无显式限制</td></tr></tbody></table>
<p>示例对比</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Feed</span>&lt;<span class="hljs-title class_">Element</span>&gt; {          <span class="hljs-comment">// ① 把最常用的关联类型提出来</span>
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Element</span>?
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">IteratorFeed</span>&lt;<span class="hljs-title class_">Iterator</span>: <span class="hljs-title class_">IteratorProtocol</span>&gt;: <span class="hljs-title class_">Feed</span>  {
    <span class="hljs-keyword">var</span> iterator: <span class="hljs-type">Iterator</span>
    <span class="hljs-keyword">init</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">iterator</span>: <span class="hljs-type">Iterator</span>) {
        <span class="hljs-keyword">self</span>.iterator <span class="hljs-operator">=</span> iterator
    }
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Iterator</span>.<span class="hljs-type">Element</span>? {
        iterator.next()
    }
}

<span class="hljs-comment">// 1. 返回值：编译期就知道真实类型</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">uniqueElements</span>&lt;<span class="hljs-type">S</span>: <span class="hljs-type">Sequence</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">seq</span>: <span class="hljs-type">S</span>) -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">Sequence</span>&lt;<span class="hljs-type">S</span>.<span class="hljs-type">Element</span>&gt;
<span class="hljs-keyword">where</span> <span class="hljs-type">S</span>.<span class="hljs-type">Element</span>: <span class="hljs-type">Hashable</span> &amp; <span class="hljs-type">Comparable</span> {
    <span class="hljs-type">Set</span>(seq).sorted()
}

<span class="hljs-comment">// 2. 数组：运行期才知道真实类型</span>
<span class="hljs-keyword">var</span> parsers: [<span class="hljs-keyword">any</span> <span class="hljs-type">Feed</span>&lt;<span class="hljs-type">Int</span>&gt;] <span class="hljs-operator">=</span> [
    <span class="hljs-type">IteratorFeed</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>].makeIterator()),
    <span class="hljs-type">IteratorFeed</span>(<span class="hljs-built_in">stride</span>(from: <span class="hljs-number">0</span>, to: <span class="hljs-number">10</span>, by: <span class="hljs-number">2</span>).makeIterator())
]
</code></pre>
<h2 data-id="heading-3">实战：一行代码写“泛型” SwiftUI View</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Charts

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ChartView</span>&lt;<span class="hljs-title class_">Data</span>: <span class="hljs-title class_">RandomAccessCollection</span>&gt;: <span class="hljs-title class_">View</span> <span class="hljs-title class_">where</span> <span class="hljs-title class_">Data</span>.<span class="hljs-title class_">Element</span> == <span class="hljs-title class_">Double</span> {
    <span class="hljs-keyword">let</span> data: <span class="hljs-type">Data</span>
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-comment">// 老写法：调用方必须写冗长泛型参数</span>
    }
}

<span class="hljs-comment">// ✅ 新写法：直接不透明返回，调用方无感知</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">makeChart</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">data</span>: <span class="hljs-keyword">some</span> <span class="hljs-type">RandomAccessCollection</span>&lt;<span class="hljs-type">Double</span>&gt;) -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
    
    <span class="hljs-type">Chart</span> {
        <span class="hljs-type">ForEach</span>(data.enumerated(), id: \.offset) { idx,value <span class="hljs-keyword">in</span>
            <span class="hljs-type">LineMark</span>(x: .value(<span class="hljs-string">"x"</span>, idx), y: .value(<span class="hljs-string">"y"</span>, value))
        }
    }
}
</code></pre>
<h2 data-id="heading-4">迁移旧代码：把 AnySequence 换成 any Sequence</h2>





















<table><thead><tr><th>旧代码</th><th>新代码</th></tr></thead><tbody><tr><td><code>AnySequence&lt;Int&gt;</code></td><td><code>any Sequence&lt;Int&gt;</code></td></tr><tr><td><code>AnyPublisher&lt;Int, Never&gt;</code></td><td><code>any Publisher&lt;Int, Never&gt;</code></td></tr><tr><td><code>AnyView</code></td><td><code>any View</code>（iOS 17+ 可用，仍需权衡性能）</td></tr></tbody></table>
<p>步骤</p>
<ol>
<li>在协议名后加 <code>&lt;Element&gt;</code>。</li>
<li>把 <code>eraseToAnyPublisher()</code> / <code>AnySequence(...)</code> 改成 <code>any Sequence&lt;Int&gt;</code>。</li>
<li>若返回值无需运行时多态，直接用 <code>some Sequence&lt;Int&gt;</code> 获得零开销。</li>
</ol>
<h2 data-id="heading-5">性能与二进制大小小贴士</h2>
<ul>
<li><code>some P&lt;T&gt;</code> 完全静态派发，零额外内存。</li>
<li><code>any P&lt;T&gt;</code> 引入存在性容器，16 字节 inline + 外挂堆（若值过大）。</li>
<li>滥用 <code>any</code> 会让二进制出现大量“协议见证表”，release 模式下编译器会优化，但debug 增量编译可能变慢。</li>
<li>对 SwiftUI <code>body</code> 这种超高频调用，优先 <code>some View</code>；只在需要运行时异构数组时才用 <code>any View</code>。</li>
</ul>
<h2 data-id="heading-6">总结</h2>

























<table><thead><tr><th>关键词</th><th>适用场景</th><th>记忆口诀</th></tr></thead><tbody><tr><td><code>protocol P&lt;Element&gt;</code></td><td>给自己协议“提级”</td><td>“协议也能带泛参”</td></tr><tr><td><code>some P&lt;T&gt;</code></td><td>返回值、泛型约束</td><td>“编译期就确定”</td></tr><tr><td><code>any P&lt;T&gt;</code></td><td>变量、数组、字典</td><td>“运行期多态盒子”</td></tr></tbody></table>
<p>一句话总结</p>
<p>Swift 5.7 让协议第一次真正拥有了“泛型形参”能力：</p>
<ul>
<li>写库的人：给协议加 <code>&lt;Element&gt;</code>，调用方立刻享受 <code>some/any</code> 语法糖。</li>
<li>写业务的人：用 <code>some Sequence&lt;Int&gt;</code> 替代冗长泛型约束，用 <code>any Sequence&lt;Int&gt;</code> 替代 <code>AnySequence</code>，代码短一半、可读性翻倍。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 协议（Protocol）指南（二）：关联类型、Self 约束与泛型递归，一次彻底搞懂]]></title>    <link>https://juejin.cn/post/7570271574348333065</link>    <guid>https://juejin.cn/post/7570271574348333065</guid>    <pubDate>2025-11-10T00:07:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570271574348333065" data-draft-id="7554225547145461798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 协议（Protocol）指南（二）：关联类型、Self 约束与泛型递归，一次彻底搞懂"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2025-11-10T00:07:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 协议（Protocol）指南（二）：关联类型、Self 约束与泛型递归，一次彻底搞懂
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T00:07:19.000Z" title="Mon Nov 10 2025 00:07:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么“关联类型”是协议的分水岭</h2>
<p>在上面，我们接触的协议都属于“无关联类型协议”——编译期无需知道协议里的泛型占位符具体是什么。</p>
<p>一旦协议里出现了 <code>associatedtype</code>，它就不再是普通类型，而变成了协议泛型：只能当作约束使用，不能当作变量/参数/返回值类型直接出现。</p>
<h2 data-id="heading-1">关联类型基础语法</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Container</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Item</span>                     <span class="hljs-comment">// ① 声明一个占位符</span>
    <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span> { <span class="hljs-keyword">get</span> }
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">append</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">item</span>: <span class="hljs-type">Item</span>)      <span class="hljs-comment">// ② 在方法里使用占位符</span>
    <span class="hljs-keyword">subscript</span>(<span class="hljs-params">index</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Item</span> { <span class="hljs-keyword">get</span> }   <span class="hljs-comment">// ③ 在下标里使用占位符</span>
}
</code></pre>
<p>实现者决定真实类型</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">IntStack</span>: <span class="hljs-title class_">Container</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> items <span class="hljs-operator">=</span> [<span class="hljs-type">Int</span>]()
    <span class="hljs-keyword">typealias</span> <span class="hljs-type">Item</span> <span class="hljs-operator">=</span> <span class="hljs-type">Int</span>      <span class="hljs-comment">// 可省略，编译器自动推断</span>
    
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">append</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">item</span>: <span class="hljs-type">Int</span>) { items.append(item) }
    <span class="hljs-keyword">subscript</span>(<span class="hljs-params">index</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span> { items[index] }
    <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span> { items.count }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">StringQueue</span>: <span class="hljs-title class_">Container</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> items <span class="hljs-operator">=</span> [<span class="hljs-type">String</span>]()
    <span class="hljs-comment">// 不写 typealias，编译器也能从 append 参数推断 Item == String</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">append</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">item</span>: <span class="hljs-type">String</span>) { items.append(item) }
    <span class="hljs-keyword">subscript</span>(<span class="hljs-params">index</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">String</span> { items[index] }
    <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span> { items.count }
}
</code></pre>
<h2 data-id="heading-2">带约束的关联类型</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">//  继承Container，只接收Item是Numeric的类型</span>
<span class="hljs-keyword">protocol</span> <span class="hljs-title class_">SummableContainer</span>: <span class="hljs-title class_">Container</span> <span class="hljs-title class_">where</span> <span class="hljs-title class_">Item</span>: <span class="hljs-title class_">Numeric</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">total</span>() -&gt; <span class="hljs-type">Item</span>
}

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">SummableContainer</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">total</span>() -&gt; <span class="hljs-type">Item</span> {
        <span class="hljs-keyword">var</span> sum: <span class="hljs-type">Item</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span>count { sum <span class="hljs-operator">=</span> sum <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>[i] }
        <span class="hljs-keyword">return</span> sum
    }
}
</code></pre>
<p>使用</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">IntStack</span>: <span class="hljs-title class_">SummableContainer</span> {}   <span class="hljs-comment">// Int 符合 Numeric，自动获得 total()</span>
<span class="hljs-keyword">var</span> s <span class="hljs-operator">=</span> <span class="hljs-type">IntStack</span>()
s.append(<span class="hljs-number">1</span>)
s.append(<span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(s.total()) <span class="hljs-comment">// 3</span>
</code></pre>
<h2 data-id="heading-3">Self 出现在协议里：返回自身类型的需求</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Copyable</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">copy</span>() -&gt; <span class="hljs-keyword">Self</span>        <span class="hljs-comment">// 要求返回“真实类型”本身</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span>: <span class="hljs-title class_">Copyable</span> {
    <span class="hljs-keyword">var</span> name <span class="hljs-operator">=</span> <span class="hljs-string">""</span>
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">init</span>() {}         <span class="hljs-comment">// 必须保证子类也能初始化</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">copy</span>() -&gt; <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">let</span> new <span class="hljs-operator">=</span> <span class="hljs-keyword">Self</span>()       <span class="hljs-comment">// Self 在运行期代表真实动态类型</span>
        new.name <span class="hljs-operator">=</span> name
        <span class="hljs-keyword">return</span> new
    }
}

<span class="hljs-keyword">let</span> husky <span class="hljs-operator">=</span> <span class="hljs-type">Dog</span>()
husky.name <span class="hljs-operator">=</span> <span class="hljs-string">"Husky"</span>
<span class="hljs-keyword">let</span> another <span class="hljs-operator">=</span> husky.copy()     <span class="hljs-comment">// 类型推断为 Dog</span>
</code></pre>
<p>注意</p>
<ul>
<li><code>Self</code> 只能出现在“协议内”或“协议扩展”中，不能出现在普通结构体/类的方法签名里。</li>
<li>如果协议用 <code>associatedtype</code>，<code>Self</code> 就是该类型的别名。</li>
</ul>
<h2 data-id="heading-4">泛型递归约束：where 子句的魔法</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Node</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Value</span>
    <span class="hljs-keyword">var</span> value: <span class="hljs-type">Value</span> { <span class="hljs-keyword">get</span> }
    <span class="hljs-keyword">var</span> children: [<span class="hljs-keyword">Self</span>] { <span class="hljs-keyword">get</span> }        <span class="hljs-comment">// 递归引用自身</span>
}

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">Node</span> <span class="hljs-title class_">where</span> <span class="hljs-title class_">Value</span>: <span class="hljs-title class_">Numeric</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">sumTree</span>() -&gt; <span class="hljs-type">Value</span> {
        value <span class="hljs-operator">+</span> children.reduce(<span class="hljs-number">0</span>) { <span class="hljs-variable">$0</span> <span class="hljs-operator">+</span> <span class="hljs-variable">$1</span>.sumTree() }
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">IntNode</span>: <span class="hljs-title class_">Node</span> {
    <span class="hljs-keyword">let</span> value: <span class="hljs-type">Int</span>
    <span class="hljs-keyword">let</span> children: [<span class="hljs-type">IntNode</span>]
}

<span class="hljs-keyword">let</span> tree <span class="hljs-operator">=</span> <span class="hljs-type">IntNode</span>(value: <span class="hljs-number">10</span>, children: [
    <span class="hljs-type">IntNode</span>(value: <span class="hljs-number">3</span>, children: []),
    <span class="hljs-type">IntNode</span>(value: <span class="hljs-number">5</span>, children: [
        <span class="hljs-type">IntNode</span>(value: <span class="hljs-number">1</span>, children: [])
    ])
])
<span class="hljs-built_in">print</span>(tree.sumTree())  <span class="hljs-comment">// 10+3+5+1 = 19</span>
</code></pre>
<h2 data-id="heading-5">真实案例：Swift 标准库里的 Sequence</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Sequence</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Iterator</span>: <span class="hljs-type">IteratorProtocol</span> <span class="hljs-keyword">where</span> <span class="hljs-type">Iterator</span>.<span class="hljs-type">Element</span> <span class="hljs-operator">==</span> <span class="hljs-type">Element</span>
    
    __consuming <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIterator</span>() -&gt; <span class="hljs-type">Iterator</span>
}

<span class="hljs-keyword">protocol</span> <span class="hljs-title class_">IteratorProtocol</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Element</span>?
}
</code></pre>
<p>自定义序列</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Fibonacci</span>: <span class="hljs-title class_">Sequence</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Iterator</span>: <span class="hljs-title class_">IteratorProtocol</span> {
        <span class="hljs-keyword">var</span> a <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, b <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Int</span>? {
            <span class="hljs-keyword">let</span> next <span class="hljs-operator">=</span> a
            a <span class="hljs-operator">=</span> b
            b <span class="hljs-operator">=</span> next <span class="hljs-operator">+</span> a
            <span class="hljs-keyword">return</span> next
        }
    }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIterator</span>() -&gt; <span class="hljs-type">Iterator</span> { <span class="hljs-type">Iterator</span>() }
}

<span class="hljs-keyword">for</span> (i, n) <span class="hljs-keyword">in</span> <span class="hljs-type">Fibonacci</span>().enumerated().prefix(<span class="hljs-number">10</span>) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"F<span class="hljs-subst">\(i)</span> = <span class="hljs-subst">\(n)</span>"</span>)
}
</code></pre>
<h2 data-id="heading-6">类型擦除（Type Erasure）：解决“关联类型协议不能当返回类型”</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Feed</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Item</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Item</span>?
}

<span class="hljs-comment">// 1. 包装类擦除具体 Item 类型</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">AnyFeed</span>&lt;<span class="hljs-title class_">Item</span>&gt;: <span class="hljs-title class_">Feed</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _next: () -&gt; <span class="hljs-type">Item</span>?
    <span class="hljs-keyword">init</span>&lt;<span class="hljs-type">F</span>: <span class="hljs-type">Feed</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">real</span>: <span class="hljs-type">F</span>) <span class="hljs-keyword">where</span> <span class="hljs-type">F</span>.<span class="hljs-type">Item</span> <span class="hljs-operator">==</span> <span class="hljs-type">Item</span> {
        _next <span class="hljs-operator">=</span> { real.next() }
    }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Item</span>? { _next() }
}

<span class="hljs-comment">// 2. 使用处不再出现关联类型</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIntFeed</span>() -&gt; <span class="hljs-type">AnyFeed</span>&lt;<span class="hljs-type">Int</span>&gt; {
    <span class="hljs-keyword">let</span> fib <span class="hljs-operator">=</span> <span class="hljs-type">Fibonacci</span>().makeIterator()
    <span class="hljs-keyword">return</span> <span class="hljs-type">AnyFeed</span>(<span class="hljs-type">IteratorFeed</span>(fib))
}
</code></pre>
<p>标准库已有</p>
<ul>
<li><code>AnySequence&lt;Element&gt;</code></li>
<li><code>AnyPublisher&lt;Output, Failure&gt;</code> (Combine)</li>
<li><code>AnyView</code> (SwiftUI)</li>
</ul>
<h2 data-id="heading-7">实战技巧清单</h2>





























<table><thead><tr><th>技巧场景</th><th>具体实现技巧</th></tr></thead><tbody><tr><td>想返回“某个遵守协议的对象”</td><td>用泛型 <code>&lt;T: Protocol&gt;</code> 或 <code>some Protocol</code></td></tr><tr><td>协议中定义 <code>associatedtype</code></td><td>仅能作为类型约束，无法直接当作变量类型；需通过“类型擦除”后暴露</td></tr><tr><td>要求子类必须实现指定初始化器</td><td>协议中声明 <code>init()</code>，类侧配合写 <code>required init()</code></td></tr><tr><td>让扩展方法仅对满足部分约束的类型可见</td><td>使用 <code>where</code> 子句，例如 <code>extension Container where Item: Comparable</code></td></tr><tr><td>禁止类型隐式标记为 <code>Sendable</code></td><td>声明 <code>struct File: ~Sendable</code>，或通过 <code>@available(*, unavailable) extension File: Sendable</code> 禁用</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[『OpenGL学习滤镜相机』- Day8: 多重纹理与混合]]></title>    <link>https://juejin.cn/post/7570534000718495807</link>    <guid>https://juejin.cn/post/7570534000718495807</guid>    <pubDate>2025-11-10T08:19:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570534000718495807" data-draft-id="7570534000718479423" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="『OpenGL学习滤镜相机』- Day8: 多重纹理与混合"/> <meta itemprop="keywords" content="Android,OpenGL"/> <meta itemprop="datePublished" content="2025-11-10T08:19:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="下位子"/> <meta itemprop="url" content="https://juejin.cn/user/2313028193761389"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            『OpenGL学习滤镜相机』- Day8: 多重纹理与混合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028193761389/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    下位子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T08:19:05.000Z" title="Mon Nov 10 2025 08:19:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://juejin.cn/post/7567889397497528383" target="_blank" title="https://juejin.cn/post/7567889397497528383">前言: 『OpenGL学习』 从零打造 Android 滤镜相机</a></p>
<p><a href="https://juejin.cn/post/7569871848793948179" target="_blank" title="https://juejin.cn/post/7569871848793948179">上一篇:『OpenGL学习滤镜相机』- Day7: FBO（帧缓冲对象）</a></p>
<p>Github: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaweizi%2FOpenGLTest" target="_blank" title="https://github.com/xiaweizi/OpenGLTest" ref="nofollow noopener noreferrer">OpenGLTest</a></p>
</blockquote>
<h2 data-id="heading-0">📚 今日目标</h2>
<ul>
<li>理解多纹理单元的概念和使用</li>
<li>掌握纹理混合模式（Blend Modes）</li>
<li>学习 Alpha 通道处理和透明度</li>
<li>实现图片水印、纹理叠加等实用效果</li>
</ul>
<p><strong>运行效果：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d0fe85223524f6d85e34d84847cfa31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiL5L2N5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763367544&amp;x-signature=NEY23PHhtHVaLDDj%2FvZ28hR8j1M%3D" alt="Day8.gif" loading="lazy"/></p>
<h2 data-id="heading-1">🎯 学习内容</h2>
<h3 data-id="heading-2">1. 多纹理单元简介</h3>
<p>在 OpenGL ES 中，<strong>纹理单元（Texture Unit）</strong> 允许我们在一次绘制调用中使用多个纹理。</p>
<h4 data-id="heading-3">什么是纹理单元？</h4>
<p>纹理单元是 OpenGL 中的"纹理槽位"，每个槽位可以绑定一个纹理对象。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">GPU</span> <span class="hljs-string">纹理单元</span>
<span class="hljs-string">├──</span> <span class="hljs-string">GL_TEXTURE0</span> <span class="hljs-string">→</span> <span class="hljs-string">纹理</span> <span class="hljs-attr">ID:</span> <span class="hljs-number">123</span><span class="hljs-string">（底图）</span>
<span class="hljs-string">├──</span> <span class="hljs-string">GL_TEXTURE1</span> <span class="hljs-string">→</span> <span class="hljs-string">纹理</span> <span class="hljs-attr">ID:</span> <span class="hljs-number">456</span><span class="hljs-string">（水印）</span>
<span class="hljs-string">├──</span> <span class="hljs-string">GL_TEXTURE2</span> <span class="hljs-string">→</span> <span class="hljs-string">纹理</span> <span class="hljs-attr">ID:</span> <span class="hljs-number">789</span><span class="hljs-string">（遮罩）</span>
<span class="hljs-string">├──</span> <span class="hljs-string">...</span>
<span class="hljs-string">└──</span> <span class="hljs-string">GL_TEXTURE31（OpenGL</span> <span class="hljs-string">ES</span> <span class="hljs-string">至少支持</span> <span class="hljs-number">8</span> <span class="hljs-string">个，通常支持</span> <span class="hljs-number">16</span><span class="hljs-number">-32</span> <span class="hljs-string">个）</span>
</code></pre>
<h4 data-id="heading-4">为什么需要多纹理？</h4>





























<table><thead><tr><th>应用场景</th><th>说明</th></tr></thead><tbody><tr><td><strong>水印效果</strong></td><td>底图 + 水印图</td></tr><tr><td><strong>遮罩效果</strong></td><td>原图 + 遮罩图</td></tr><tr><td><strong>光照贴图</strong></td><td>颜色纹理 + 法线贴图 + 光照贴图</td></tr><tr><td><strong>视频特效</strong></td><td>视频帧 + 滤镜纹理（LUT）</td></tr><tr><td><strong>粒子效果</strong></td><td>粒子纹理 + 渐变纹理</td></tr></tbody></table>
<h3 data-id="heading-5">2. 多纹理的使用流程</h3>
<h4 data-id="heading-6">2.1 激活纹理单元</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 激活纹理单元 0</span>
GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
<span class="hljs-comment">// 绑定第一个纹理</span>
GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture1)

<span class="hljs-comment">// 激活纹理单元 1</span>
GLES20.glActiveTexture(GLES20.GL_TEXTURE1)
<span class="hljs-comment">// 绑定第二个纹理</span>
GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture2)
</code></pre>
<h4 data-id="heading-7">2.2 传递给着色器</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 将纹理单元索引传递给着色器的 sampler2D</span>
GLES20.glUniform1i(texture1Location, <span class="hljs-number">0</span>)  <span class="hljs-comment">// 使用 GL_TEXTURE0</span>
GLES20.glUniform1i(texture2Location, <span class="hljs-number">1</span>)  <span class="hljs-comment">// 使用 GL_TEXTURE1</span>
</code></pre>
<h4 data-id="heading-8">2.3 着色器中采样</h4>
<pre><code class="hljs language-glsl" lang="glsl">precision mediump float;

uniform sampler2D uTexture1;  // 底图
uniform sampler2D uTexture2;  // 水印

varying vec2 vTexCoord;

void main() {
    vec4 color1 = texture2D(uTexture1, vTexCoord);  // 采样底图
    vec4 color2 = texture2D(uTexture2, vTexCoord);  // 采样水印
    
    // 混合两个纹理
    gl_FragColor = mix(color1, color2, color2.a);
}
</code></pre>
<h3 data-id="heading-9">3. 纹理混合模式</h3>
<h4 data-id="heading-10">3.1 常见混合算法</h4>








































<table><thead><tr><th>混合模式</th><th>公式</th><th>效果</th></tr></thead><tbody><tr><td><strong>正常（Normal）</strong></td><td><code>color2</code></td><td>完全覆盖</td></tr><tr><td><strong>Alpha 混合</strong></td><td><code>mix(color1, color2, alpha)</code></td><td>透明叠加</td></tr><tr><td><strong>相加（Add）</strong></td><td><code>color1 + color2</code></td><td>增亮效果</td></tr><tr><td><strong>相乘（Multiply）</strong></td><td><code>color1 * color2</code></td><td>变暗效果</td></tr><tr><td><strong>屏幕（Screen）</strong></td><td><code>1.0 - (1.0 - color1) * (1.0 - color2)</code></td><td>柔光增亮</td></tr><tr><td><strong>叠加（Overlay）</strong></td><td>根据亮度混合相乘和屏幕模式</td><td>保留高光和阴影</td></tr></tbody></table>
<h4 data-id="heading-11">3.2 着色器实现</h4>
<pre><code class="hljs language-glsl" lang="glsl">precision mediump float;

uniform sampler2D uTexture1;  // 底图
uniform sampler2D uTexture2;  // 叠加图
uniform int uBlendMode;       // 混合模式（0-5）
uniform float uAlpha;         // 透明度（0.0 - 1.0）

varying vec2 vTexCoord;

// 正常混合
vec3 blendNormal(vec3 base, vec3 blend) {
    return blend;
}

// 相加混合
vec3 blendAdd(vec3 base, vec3 blend) {
    return min(base + blend, vec3(1.0));
}

// 相乘混合
vec3 blendMultiply(vec3 base, vec3 blend) {
    return base * blend;
}

// 屏幕混合
vec3 blendScreen(vec3 base, vec3 blend) {
    return 1.0 - (1.0 - base) * (1.0 - blend);
}

// 叠加混合
vec3 blendOverlay(vec3 base, vec3 blend) {
    vec3 result;
    result.r = base.r &lt; 0.5 ? (2.0 * base.r * blend.r) : (1.0 - 2.0 * (1.0 - base.r) * (1.0 - blend.r));
    result.g = base.g &lt; 0.5 ? (2.0 * base.g * blend.g) : (1.0 - 2.0 * (1.0 - base.g) * (1.0 - blend.g));
    result.b = base.b &lt; 0.5 ? (2.0 * base.b * blend.b) : (1.0 - 2.0 * (1.0 - base.b) * (1.0 - blend.b));
    return result;
}

// 柔光混合
vec3 blendSoftLight(vec3 base, vec3 blend) {
    vec3 result;
    result.r = blend.r &lt; 0.5 ? (2.0 * base.r * blend.r + base.r * base.r * (1.0 - 2.0 * blend.r)) 
                              : (sqrt(base.r) * (2.0 * blend.r - 1.0) + 2.0 * base.r * (1.0 - blend.r));
    result.g = blend.g &lt; 0.5 ? (2.0 * base.g * blend.g + base.g * base.g * (1.0 - 2.0 * blend.g)) 
                              : (sqrt(base.g) * (2.0 * blend.g - 1.0) + 2.0 * base.g * (1.0 - blend.g));
    result.b = blend.b &lt; 0.5 ? (2.0 * base.b * blend.b + base.b * base.b * (1.0 - 2.0 * blend.b)) 
                              : (sqrt(base.b) * (2.0 * blend.b - 1.0) + 2.0 * base.b * (1.0 - blend.b));
    return result;
}

void main() {
    vec4 base = texture2D(uTexture1, vTexCoord);
    vec4 blend = texture2D(uTexture2, vTexCoord);
    
    vec3 result;
    
    if (uBlendMode == 0) {
        // 正常混合（Alpha 混合）
        result = mix(base.rgb, blend.rgb, blend.a * uAlpha);
    } else if (uBlendMode == 1) {
        // 相加
        result = blendAdd(base.rgb, blend.rgb * uAlpha);
    } else if (uBlendMode == 2) {
        // 相乘
        result = mix(base.rgb, blendMultiply(base.rgb, blend.rgb), uAlpha);
    } else if (uBlendMode == 3) {
        // 屏幕
        result = mix(base.rgb, blendScreen(base.rgb, blend.rgb), uAlpha);
    } else if (uBlendMode == 4) {
        // 叠加
        result = mix(base.rgb, blendOverlay(base.rgb, blend.rgb), uAlpha);
    } else if (uBlendMode == 5) {
        // 柔光
        result = mix(base.rgb, blendSoftLight(base.rgb, blend.rgb), uAlpha);
    } else {
        result = base.rgb;
    }
    
    gl_FragColor = vec4(result, 1.0);
}
</code></pre>
<h3 data-id="heading-12">4. Alpha 通道处理</h3>
<h4 data-id="heading-13">4.1 什么是 Alpha 通道？</h4>
<p><strong>Alpha 通道</strong>表示像素的不透明度：</p>
<ul>
<li><code>alpha = 0.0</code>：完全透明</li>
<li><code>alpha = 0.5</code>：半透明</li>
<li><code>alpha = 1.0</code>：完全不透明</li>
</ul>
<h4 data-id="heading-14">4.2 启用 Alpha 混合</h4>
<p>OpenGL 提供了硬件级别的 Alpha 混合：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 启用混合</span>
GLES20.glEnable(GLES20.GL_BLEND)

<span class="hljs-comment">// 设置混合函数</span>
GLES20.glBlendFunc(GLES20.GL_SRC_ALPHA, GLES20.GL_ONE_MINUS_SRC_ALPHA)
</code></pre>
<p><strong>混合公式</strong>：</p>
<pre><code class="hljs language-css" lang="css">最终颜色 = 源颜色 × 源因子 + 目标颜色 × 目标因子
       = <span class="hljs-attribute">src</span><span class="hljs-selector-class">.rgb</span> × <span class="hljs-attribute">src</span><span class="hljs-selector-class">.a</span> + dst<span class="hljs-selector-class">.rgb</span> × (<span class="hljs-number">1.0</span> - <span class="hljs-attribute">src</span><span class="hljs-selector-class">.a</span>)
</code></pre>
<h4 data-id="heading-15">4.3 常见混合函数</h4>






























<table><thead><tr><th>源因子</th><th>目标因子</th><th>效果</th></tr></thead><tbody><tr><td><code>GL_SRC_ALPHA</code></td><td><code>GL_ONE_MINUS_SRC_ALPHA</code></td><td>标准 Alpha 混合（透明叠加）</td></tr><tr><td><code>GL_ONE</code></td><td><code>GL_ONE</code></td><td>相加混合（增亮）</td></tr><tr><td><code>GL_DST_COLOR</code></td><td><code>GL_ZERO</code></td><td>相乘混合（变暗）</td></tr><tr><td><code>GL_ONE</code></td><td><code>GL_ONE_MINUS_SRC_ALPHA</code></td><td>预乘 Alpha 混合</td></tr></tbody></table>
<h3 data-id="heading-16">5. 实用效果实现</h3>
<h4 data-id="heading-17">5.1 水印效果</h4>
<pre><code class="hljs language-glsl" lang="glsl">// 水印着色器
precision mediump float;

uniform sampler2D uTexture;    // 底图
uniform sampler2D uWatermark;  // 水印
uniform vec2 uWatermarkPos;    // 水印位置（0.0 - 1.0）
uniform vec2 uWatermarkSize;   // 水印大小（0.0 - 1.0）
uniform float uWatermarkAlpha; // 水印透明度

varying vec2 vTexCoord;

void main() {
    vec4 baseColor = texture2D(uTexture, vTexCoord);
    
    // 计算水印区域
    vec2 watermarkCoord = (vTexCoord - uWatermarkPos) / uWatermarkSize;
    
    // 判断是否在水印区域
    if (watermarkCoord.x &gt;= 0.0 &amp;&amp; watermarkCoord.x &lt;= 1.0 &amp;&amp;
        watermarkCoord.y &gt;= 0.0 &amp;&amp; watermarkCoord.y &lt;= 1.0) {
        
        vec4 watermarkColor = texture2D(uWatermark, watermarkCoord);
        
        // Alpha 混合水印
        gl_FragColor = mix(baseColor, watermarkColor, watermarkColor.a * uWatermarkAlpha);
    } else {
        gl_FragColor = baseColor;
    }
}
</code></pre>
<h4 data-id="heading-18">5.2 双重曝光效果</h4>
<pre><code class="hljs language-glsl" lang="glsl">precision mediump float;

uniform sampler2D uTexture1;
uniform sampler2D uTexture2;
uniform float uMixRatio;  // 混合比例

varying vec2 vTexCoord;

void main() {
    vec4 color1 = texture2D(uTexture1, vTexCoord);
    vec4 color2 = texture2D(uTexture2, vTexCoord);
    
    // 屏幕混合模式（双重曝光常用）
    vec3 result = 1.0 - (1.0 - color1.rgb) * (1.0 - color2.rgb * uMixRatio);
    
    gl_FragColor = vec4(result, 1.0);
}
</code></pre>
<h4 data-id="heading-19">5.3 遮罩效果</h4>
<pre><code class="hljs language-glsl" lang="glsl">precision mediump float;

uniform sampler2D uTexture;  // 原图
uniform sampler2D uMask;     // 遮罩（黑白图）

varying vec2 vTexCoord;

void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    vec4 mask = texture2D(uMask, vTexCoord);
    
    // 使用遮罩的亮度作为 Alpha
    float maskAlpha = dot(mask.rgb, vec3(0.299, 0.587, 0.114));
    
    gl_FragColor = vec4(color.rgb, color.a * maskAlpha);
}
</code></pre>
<h3 data-id="heading-20">6. 性能优化</h3>
<h4 data-id="heading-21">6.1 纹理单元管理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextureManager</span> {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TEXTURE_UNIT_BASE = <span class="hljs-number">0</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TEXTURE_UNIT_BLEND = <span class="hljs-number">1</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TEXTURE_UNIT_WATERMARK = <span class="hljs-number">2</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindTextures</span><span class="hljs-params">(baseTexture: <span class="hljs-type">Int</span>, blendTexture: <span class="hljs-type">Int</span>, watermarkTexture: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 底图</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + TEXTURE_UNIT_BASE)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, baseTexture)
        
        <span class="hljs-comment">// 混合图</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + TEXTURE_UNIT_BLEND)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, blendTexture)
        
        <span class="hljs-comment">// 水印</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + TEXTURE_UNIT_WATERMARK)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, watermarkTexture)
    }
}
</code></pre>
<h4 data-id="heading-22">6.2 减少纹理切换</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 不好的做法：频繁切换纹理单元</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">renderObjects</span><span class="hljs-params">(objects: <span class="hljs-type">List</span>&lt;<span class="hljs-type">RenderObject</span>&gt;)</span></span> {
    objects.forEach { obj -&gt;
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, obj.texture)
        obj.draw()
    }
}

<span class="hljs-comment">// ✅ 好的做法：批量渲染相同纹理的对象</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">renderObjectsBatched</span><span class="hljs-params">(objects: <span class="hljs-type">List</span>&lt;<span class="hljs-type">RenderObject</span>&gt;)</span></span> {
    <span class="hljs-keyword">val</span> grouped = objects.groupBy { it.texture }
    grouped.forEach { (texture, objs) -&gt;
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture)
        objs.forEach { it.draw() }
    }
}
</code></pre>
<h4 data-id="heading-23">6.3 纹理压缩</h4>
<p>对于水印等辅助纹理，可以使用较低分辨率或压缩格式：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 调整水印尺寸</span>
<span class="hljs-keyword">val</span> watermarkSize = <span class="hljs-number">256</span>  <span class="hljs-comment">// 不需要很高分辨率</span>
<span class="hljs-keyword">val</span> scaledWatermark = Bitmap.createScaledBitmap(
    originalWatermark, 
    watermarkSize, 
    watermarkSize, 
    <span class="hljs-literal">true</span>
)
</code></pre>
<h3 data-id="heading-24">7. 多纹理的限制</h3>
<h4 data-id="heading-25">7.1 查询纹理单元数量</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> maxTextureUnits = IntArray(<span class="hljs-number">1</span>)
GLES20.glGetIntegerv(GLES20.GL_MAX_TEXTURE_IMAGE_UNITS, maxTextureUnits, <span class="hljs-number">0</span>)
Log.d(TAG, <span class="hljs-string">"设备支持的最大纹理单元数: <span class="hljs-subst">${maxTextureUnits[<span class="hljs-number">0</span>]}</span>"</span>)
</code></pre>
<p>OpenGL ES 2.0 规范要求至少支持 8 个纹理单元，大多数设备支持 16-32 个。</p>
<h4 data-id="heading-26">7.2 纹理内存管理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 监控纹理内存使用</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">estimateTextureMemory</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>, height: <span class="hljs-type">Int</span>, format: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">val</span> bytesPerPixel = <span class="hljs-keyword">when</span> (format) {
        GLES20.GL_RGBA -&gt; <span class="hljs-number">4</span>
        GLES20.GL_RGB -&gt; <span class="hljs-number">3</span>
        GLES20.GL_LUMINANCE_ALPHA -&gt; <span class="hljs-number">2</span>
        GLES20.GL_LUMINANCE -&gt; <span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span> -&gt; <span class="hljs-number">4</span>
    }
    <span class="hljs-keyword">return</span> width * height * bytesPerPixel
}

<span class="hljs-comment">// 示例：1920x1080 RGBA 纹理 = 8.3 MB</span>
<span class="hljs-keyword">val</span> memory = estimateTextureMemory(<span class="hljs-number">1920</span>, <span class="hljs-number">1080</span>, GLES20.GL_RGBA)
Log.d(TAG, <span class="hljs-string">"纹理内存占用: <span class="hljs-subst">${memory / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>}</span> MB"</span>)
</code></pre>
<h2 data-id="heading-27">💻 代码实践</h2>
<h3 data-id="heading-28">今日任务</h3>
<p>实现一个多纹理混合应用：</p>
<ol>
<li><strong>加载两张图片</strong></li>
<li><strong>实现多种混合模式</strong>：
<ul>
<li>Alpha 混合</li>
<li>相加</li>
<li>相乘</li>
<li>屏幕</li>
<li>叠加</li>
<li>柔光</li>
</ul>
</li>
<li><strong>添加水印功能</strong></li>
<li><strong>提供透明度调节</strong></li>
</ol>
<h3 data-id="heading-29">实现效果</h3>
<ul>
<li>🖼️ 同时加载两张纹理</li>
<li>🎨 6 种混合模式实时切换</li>
<li>💧 透明度 SeekBar 调节</li>
<li>🏷️ 水印位置和透明度控制</li>
</ul>
<h3 data-id="heading-30">核心代码结构</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Day08Renderer</span>(context: Context) : GLSurfaceView.Renderer {

    <span class="hljs-comment">// 多纹理 ID</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> texture1: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>  <span class="hljs-comment">// 底图</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> texture2: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>  <span class="hljs-comment">// 叠加图</span>

    <span class="hljs-comment">// 混合模式</span>
    <span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlendMode</span> {
        ALPHA,      <span class="hljs-comment">// Alpha 混合</span>
        ADD,        <span class="hljs-comment">// 相加</span>
        MULTIPLY,   <span class="hljs-comment">// 相乘</span>
        SCREEN,     <span class="hljs-comment">// 屏幕</span>
        OVERLAY,    <span class="hljs-comment">// 叠加</span>
        SOFT_LIGHT  <span class="hljs-comment">// 柔光</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentBlendMode = BlendMode.ALPHA
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> blendAlpha = <span class="hljs-number">0.5f</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDrawFrame</span><span class="hljs-params">(gl: <span class="hljs-type">GL10</span>?)</span></span> {
        <span class="hljs-comment">// 激活纹理单元 0</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture1)
        GLES20.glUniform1i(texture1Location, <span class="hljs-number">0</span>)

        <span class="hljs-comment">// 激活纹理单元 1</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE1)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture2)
        GLES20.glUniform1i(texture2Location, <span class="hljs-number">1</span>)

        <span class="hljs-comment">// 设置混合模式</span>
        GLES20.glUniform1i(blendModeLocation, currentBlendMode.ordinal)
        GLES20.glUniform1f(alphaLocation, blendAlpha)

        <span class="hljs-comment">// 绘制</span>
        drawQuad()
    }
}
</code></pre>
<h2 data-id="heading-31">🧪 练习任务</h2>
<h3 data-id="heading-32">基础任务</h3>
<ol>
<li>✅ 实现两个纹理的加载和绑定</li>
<li>✅ 实现至少 3 种混合模式</li>
<li>✅ 添加透明度调节功能</li>
</ol>
<h3 data-id="heading-33">进阶任务</h3>
<ol>
<li>🎨 实现水印功能（可调节位置和大小）</li>
<li>🖼️ 实现遮罩效果</li>
<li>🌈 实现双重曝光效果</li>
<li>📸 添加预设混合效果（复古、电影、梦幻等）</li>
</ol>
<h3 data-id="heading-34">挑战任务</h3>
<ol>
<li>🚀 实现三个纹理的混合（底图 + 叠加图 + 水印）</li>
<li>🎭 实现动态混合（混合比例随时间变化）</li>
<li>🎬 实现分区域混合（不同区域不同混合模式）</li>
<li>💾 保存混合后的图片到相册</li>
</ol>
<h2 data-id="heading-35">📖 知识点总结</h2>
<h3 data-id="heading-36">纹理单元 vs 纹理对象</h3>






























<table><thead><tr><th>特性</th><th>纹理单元</th><th>纹理对象</th></tr></thead><tbody><tr><td><strong>概念</strong></td><td>GPU 的"纹理槽位"</td><td>实际的纹理数据</td></tr><tr><td><strong>数量</strong></td><td>有限（通常 8-32 个）</td><td>可以创建很多</td></tr><tr><td><strong>操作</strong></td><td><code>glActiveTexture()</code></td><td><code>glBindTexture()</code></td></tr><tr><td><strong>类比</strong></td><td>USB 接口</td><td>U 盘</td></tr></tbody></table>
<h3 data-id="heading-37">混合模式对比</h3>








































<table><thead><tr><th>模式</th><th>视觉效果</th><th>常用场景</th></tr></thead><tbody><tr><td><strong>Alpha</strong></td><td>透明叠加</td><td>水印、UI 叠加</td></tr><tr><td><strong>Add</strong></td><td>增亮、发光</td><td>光效、粒子</td></tr><tr><td><strong>Multiply</strong></td><td>变暗、阴影</td><td>阴影、色彩校正</td></tr><tr><td><strong>Screen</strong></td><td>柔和增亮</td><td>柔光、氛围</td></tr><tr><td><strong>Overlay</strong></td><td>对比增强</td><td>照片滤镜</td></tr><tr><td><strong>Soft Light</strong></td><td>柔和混合</td><td>肖像美化</td></tr></tbody></table>
<h3 data-id="heading-38">最佳实践</h3>
<ol>
<li>✅ <strong>复用纹理单元</strong>：不要每帧都重新激活和绑定</li>
<li>✅ <strong>批量渲染</strong>：相同纹理的对象一起渲染</li>
<li>✅ <strong>纹理压缩</strong>：对辅助纹理使用较低分辨率</li>
<li>✅ <strong>及时释放</strong>：不再使用的纹理要删除</li>
<li>✅ <strong>检查限制</strong>：查询设备支持的最大纹理单元数</li>
</ol>
<h2 data-id="heading-39">🐛 常见问题</h2>
<h3 data-id="heading-40">Q1: 纹理显示是黑色的？</h3>
<p><strong>可能原因</strong>：</p>
<ol>
<li>纹理单元索引错误</li>
<li><code>glUniform1i</code> 传递的值不对应激活的纹理单元</li>
</ol>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 纹理单元 0</span>
GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture1)
GLES20.glUniform1i(texture1Location, <span class="hljs-number">0</span>)  <span class="hljs-comment">// 传递 0，不是 GL_TEXTURE0</span>

<span class="hljs-comment">// 纹理单元 1</span>
GLES20.glActiveTexture(GLES20.GL_TEXTURE1)
GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture2)
GLES20.glUniform1i(texture2Location, <span class="hljs-number">1</span>)  <span class="hljs-comment">// 传递 1，不是 GL_TEXTURE1</span>
</code></pre>
<h3 data-id="heading-41">Q2: 混合效果不正确？</h3>
<p>检查是否启用了 OpenGL 混合：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 如果使用硬件混合</span>
GLES20.glEnable(GLES20.GL_BLEND)
GLES20.glBlendFunc(GLES20.GL_SRC_ALPHA, GLES20.GL_ONE_MINUS_SRC_ALPHA)

<span class="hljs-comment">// 如果使用着色器混合</span>
<span class="hljs-comment">// 不需要启用 glBlend，直接在片段着色器中计算即可</span>
</code></pre>
<h3 data-id="heading-42">Q3: 水印位置不对？</h3>
<p>OpenGL 坐标系原点在左下角，而 UI 坐标系在左上角：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// UI 坐标（左上角为原点）</span>
<span class="hljs-keyword">val</span> uiY = <span class="hljs-number">100f</span>

<span class="hljs-comment">// 转换为 OpenGL 坐标（左下角为原点）</span>
<span class="hljs-keyword">val</span> glY = screenHeight - uiY - watermarkHeight
</code></pre>
<h3 data-id="heading-43">Q4: 如何实现圆形水印？</h3>
<p>在着色器中使用距离函数：</p>
<pre><code class="hljs language-glsl" lang="glsl">void main() {
    vec2 center = vec2(0.5, 0.5);
    float dist = distance(watermarkCoord, center);
    
    // 圆形遮罩
    float alpha = smoothstep(0.5, 0.48, dist);
    
    vec4 watermarkColor = texture2D(uWatermark, watermarkCoord);
    watermarkColor.a *= alpha;
    
    gl_FragColor = mix(baseColor, watermarkColor, watermarkColor.a);
}
</code></pre>
<h2 data-id="heading-44">🔗 参考资料</h2>
<h3 data-id="heading-45">官方文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.khronos.org%2Fopengl%2Fwiki%2FTexture" target="_blank" title="https://www.khronos.org/opengl/wiki/Texture" ref="nofollow noopener noreferrer">OpenGL ES Texture Units</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.khronos.org%2Fopengl%2Fwiki%2FSampler_(GLSL)" target="_blank" title="https://www.khronos.org/opengl/wiki/Sampler_(GLSL)" ref="nofollow noopener noreferrer">GLSL Sampler Types</a></li>
</ul>
<h3 data-id="heading-46">混合模式参考</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fphotoblogstop.com%2Fphotoshop%2Fphotoshop-blend-modes-explained" target="_blank" title="https://photoblogstop.com/photoshop/photoshop-blend-modes-explained" ref="nofollow noopener noreferrer">Photoshop Blend Modes</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjamieowen%2Fglsl-blend" target="_blank" title="https://github.com/jamieowen/glsl-blend" ref="nofollow noopener noreferrer">WebGL Blend Modes</a></li>
</ul>
<h3 data-id="heading-47">推荐阅读</h3>
<ul>
<li>《Real-Time Rendering》- Chapter 5: Visual Appearance</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.nvidia.com%2Fgpugems%2Fgpugems3%2Fpart-iv-image-effects" target="_blank" title="https://developer.nvidia.com/gpugems/gpugems3/part-iv-image-effects" ref="nofollow noopener noreferrer">GPU Gems - Image Processing</a></li>
</ul>
<h2 data-id="heading-48">📝 今日总结</h2>
<p>今天我们深入学习了多重纹理和混合技术：</p>
<ol>
<li>✅ 理解了纹理单元的概念：GPU 中的"纹理槽位"</li>
<li>✅ 掌握了多纹理的使用流程：激活 → 绑定 → 传递索引</li>
<li>✅ 学习了 6 种常用混合模式：Alpha、Add、Multiply、Screen、Overlay、Soft Light</li>
<li>✅ 实现了实用效果：水印、双重曝光、遮罩</li>
</ol>
<p><strong>关键要点</strong>：</p>
<ul>
<li>纹理单元允许我们在一次绘制中使用多个纹理</li>
<li><code>glActiveTexture()</code> 激活纹理单元，<code>glUniform1i()</code> 传递索引（不是 GL_TEXTURE 常量）</li>
<li>混合模式本质是不同的颜色计算公式</li>
<li>Alpha 通道是实现透明效果的关键</li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">下一篇</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[并发丢数据深度剖析：MySQL锁机制与事务实战踩坑及解决方案]]></title>    <link>https://juejin.cn/post/7570579125154725898</link>    <guid>https://juejin.cn/post/7570579125154725898</guid>    <pubDate>2025-11-10T07:58:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570579125154725898" data-draft-id="7570564840429305883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="并发丢数据深度剖析：MySQL锁机制与事务实战踩坑及解决方案"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-10T07:58:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            并发丢数据深度剖析：MySQL锁机制与事务实战踩坑及解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T07:58:21.000Z" title="Mon Nov 10 2025 07:58:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读33分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、理论来源于实践</h2>
<p><strong>现象</strong>：于2025-08-13 21:45:35，事实逻辑表将自身的指标与维度同步到原子服务的实现时，出现同步过来的指标与维度丢失。</p>
<p><strong>核心原因</strong>：两次重复的事实逻辑表同步时间非常相近，导致同步过来的指标与维度丢失。</p>
<p>﻿</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2997262148d24d5eb0167adf0eaa43d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=1VD8L2kEcgSenUN%2F%2FvANMxfw%2Bm4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h2 data-id="heading-1">2、倒带进事故现场</h2>
<p>逻辑表向原子服务同步的核心逻辑是 “先删后增”：删除旧数据→对比新老数据→插入新增数据，具体流程如下：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6649acaff23477fbc1cb6d5647fb50b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=5npYZVg7NlOPfHpPaeAoFn1CjtI%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>整体业务代码精简逻辑如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Transactional</span>(rollbackFor = Exception.class)
public Map&lt;String, Object&gt; driveToAtomService(Map logicTableData, String erp) {
<span class="hljs-comment">//获得环境信息</span>
String env = driveLogicTable<span class="hljs-selector-class">.getString</span>(DRIVE_LOGIC_TABLE_ENV);
<span class="hljs-comment">//获取/更新实现id</span>
 Long logicTableId = <span class="hljs-built_in">getOrAddLogicTableId</span>(atomicServiceId, driveLogicTable, erp, EnvType.of(env));
<span class="hljs-comment">//删除关联指标</span>
 metricImplMapper<span class="hljs-selector-class">.deleteByLogicTableIds</span>(Collections.singletonList(logicId));
<span class="hljs-comment">//获取请求中的所有的指标信息</span>
List&lt;MetricImplBO&gt; metricList = <span class="hljs-built_in">getMetricImpls</span>(logicTableData, logicTableId);
<span class="hljs-comment">//获取需要新增的指标实现(包含了查询库里现有的指标实现)</span>
List&lt;MetricImplRelBO&gt; metricImpls = metricImplMapper<span class="hljs-selector-class">.getMetricImpls</span>(logicTableId);
Set&lt;Long&gt; metricDefIdSet = metricImpls<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.map</span>(MetricImplRelBO::getMetricDefId)<span class="hljs-selector-class">.collect</span>(Collectors.toSet());
List&lt;MetricImplBO&gt; addList = metricList<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.filter</span>(s -&gt; !metricDefIdSet.contains(s.getMetricDefId()))<span class="hljs-selector-class">.collect</span>(Collectors.toList());
<span class="hljs-comment">//将需要新增的指标实现插入数据库</span>
 <span class="hljs-built_in">addMetricImpl</span>(addList);

}
</code></pre>
<p>用一个请求进行举例：</p>
<pre><code class="hljs language-ruby" lang="ruby">{<span class="hljs-string">"header"</span><span class="hljs-symbol">:</span>{<span class="hljs-string">"appKey"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"uuid"</span><span class="hljs-symbol">:<span class="hljs-string">"ce7cef2d-c417-464a-a519-311599fddfca"</span></span>,<span class="hljs-string">"serviceName"</span><span class="hljs-symbol">:<span class="hljs-string">"driveToAtomService"</span></span>,<span class="hljs-string">"context"</span><span class="hljs-symbol">:</span>{<span class="hljs-string">"PIN"</span><span class="hljs-symbol">:<span class="hljs-string">"wanyue3"</span></span>}},<span class="hljs-string">"body"</span><span class="hljs-symbol">:</span>{<span class="hljs-string">"dimList"</span><span class="hljs-symbol">:</span>[{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">72</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2501</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2484</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2502</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4591</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3822</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4523</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4524</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">76</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1767</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1907</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1598</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4620</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4621</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4622</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2504</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2485</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2486</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2487</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2488</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3077</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3080</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3081</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2483</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2482</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3082</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3083</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4851</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2503</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5070</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5044</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5087</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5144</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5145</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3089</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3680</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2223</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5428</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5101</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1315</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5247</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3318</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5262</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4646</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2252</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2254</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2959</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2958</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2728</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2618</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5061</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">6032</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">6375</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">6388</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">6389</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1316</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1081</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1351</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1082</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1499</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"COMBINE"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1596</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1606</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1083</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1108</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>}],<span class="hljs-string">"dimCombineList"</span><span class="hljs-symbol">:[]</span>,<span class="hljs-string">"metricList"</span><span class="hljs-symbol">:</span>[{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19872</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19873</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19875</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19945</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">17263</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"COUNT_DISTINCT"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">28017</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">20242</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">18450</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">20276</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">18452</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">18453</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">18456</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19866</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">21691</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19871</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>}],<span class="hljs-string">"driveLogicTable"</span><span class="hljs-symbol">:<span class="hljs-string">"{"</span>dimensionType<span class="hljs-string">":"</span>DETAIL<span class="hljs-string">","</span>oldNameCn<span class="hljs-string">":"</span></span>七鲜实时交易_for地推中间态新老标志<span class="hljs-string">","</span>atomicAliasProd<span class="hljs-string">":"</span>prod<span class="hljs-string">","</span>implServiceTypeKey<span class="hljs-string">":"</span>realtime<span class="hljs-string">","</span>originPhysicDataSourceId<span class="hljs-string">":0,"</span>nameCn<span class="hljs-string">":"</span>七鲜实时交易_for地推中间态新老标志<span class="hljs-string">","</span>description<span class="hljs-string">":"</span>七鲜实时交易_for地推中间态新老标志<span class="hljs-string">","</span>driveLogicTableId<span class="hljs-string">":9881,"</span>driveLogicTableEnv<span class="hljs-string">":"</span><span class="hljs-variable constant_">DEV</span><span class="hljs-string">","</span>commonDecorateIdList<span class="hljs-string">":"</span><span class="hljs-number">9665</span>,<span class="hljs-number">3269</span>,<span class="hljs-number">3270</span>,<span class="hljs-number">3271</span>,<span class="hljs-number">4556</span>,<span class="hljs-number">8012</span>,<span class="hljs-number">8270</span>,<span class="hljs-number">6030</span>,<span class="hljs-number">7247</span>,<span class="hljs-number">6031</span>,<span class="hljs-number">7248</span>,<span class="hljs-number">6032</span>,<span class="hljs-number">7249</span>,<span class="hljs-number">6033</span>,<span class="hljs-number">7250</span>,<span class="hljs-number">6034</span>,<span class="hljs-number">6035</span>,<span class="hljs-number">2134</span>,<span class="hljs-number">7254</span>,<span class="hljs-number">7255</span>,<span class="hljs-number">2085</span>,<span class="hljs-number">619</span>,<span class="hljs-number">620</span>,<span class="hljs-number">5997</span>,<span class="hljs-number">1586</span>,<span class="hljs-number">7867</span>,<span class="hljs-number">6845</span><span class="hljs-string">","</span>atomicAliasPre<span class="hljs-string">":"</span>pre<span class="hljs-string">","</span>committer<span class="hljs-string">":"</span>panjingrong<span class="hljs-string">","</span>physicDataSourceId<span class="hljs-string">":9494,"</span>storageType<span class="hljs-string">":"</span><span class="hljs-variable constant_">ONLINE</span><span class="hljs-string">","</span>atomicAliasDev<span class="hljs-string">":"</span>pre<span class="hljs-string">"}"</span>,<span class="hljs-string">"atomicServiceId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1088</span>},<span class="hljs-string">"pin"</span><span class="hljs-symbol">:<span class="hljs-string">"wanyue3"</span></span>}
</code></pre>
<p>共计15个指标，64个维度</p>


















































































<table><thead><tr><th>请求1(事务)</th><th>请求2(事务)</th><th>﻿</th><th/><th/></tr></thead><tbody><tr><td>21:06:17.262</td><td>进入同步方法</td><td>21:06:17.263</td><td>进入同步方法</td><td>﻿</td></tr><tr><td>21:06:17.063</td><td>select unify_metric_impl where logic_id = 3245 查询出15条数据(快照读，readview1)</td><td>21:06:17.363</td><td>select unify_metric_impl where logic_id = 3245 查询出15条数据(快照读，readview2)</td><td>﻿</td></tr><tr><td>21:06:17.363</td><td>delete from unify_metric_impl where logic_id = 3245</td><td>21:06:17.372</td><td>delete from unify_metric_impl where logic_id = 3245</td><td>﻿</td></tr><tr><td>21:06:17.459</td><td>select unify_metric_impl where logic_id = 3245 查询出0条数据</td><td>﻿</td><td>delete 由于logic_id不是索引，会表锁阻塞</td><td>﻿</td></tr><tr><td>21:06:18.459</td><td>insert into unify_metric_impl 插入的logic_id = 3245的数据，15条</td><td>﻿</td><td>﻿</td><td>﻿</td></tr><tr><td>21:06:19.408</td><td>方法结束</td><td>﻿</td><td>﻿</td><td>﻿</td></tr><tr><td>﻿</td><td>﻿</td><td>21:06:19.529</td><td>删除成功</td><td>﻿</td></tr><tr><td>﻿</td><td>﻿</td><td>21:06:20.362</td><td>select unify_metric_impl where logic_id = 3245 得到 15条数据</td><td>﻿</td></tr><tr><td>﻿</td><td>﻿</td><td>21:06:20.435</td><td>读出15条数据，比较本次是否有新增指标， 得出没有新增指标，因此不进行新增。addAtomicMetricNameForDrive addList empty</td><td>﻿</td></tr><tr><td>﻿</td><td>﻿</td><td>21:06:21.435</td><td>方法结束</td><td>﻿</td></tr></tbody></table>
<p>﻿</p>
<p><strong>核心结论点</strong>：</p>
<p>1.请求2的删除操作被阻塞了，直到请求1执行完整个方法。</p>
<p>2.请求2中去查看当前实现的指标的时候，发现库里已经存在所有指标不会进行新增，与上一步删除的逻辑相悖。</p>
<p>﻿</p>
<h2 data-id="heading-2">3、结论点深度剖析</h2>
<h3 data-id="heading-3">3.1 分析结论一</h3>
<p>请求2的删除操作被阻塞了，直到请求1执行完整个方法。</p>
<h4 data-id="heading-4">3.1.1 复习mysql的InnoDB锁机制</h4>
<h5 data-id="heading-5">3.1.1.1 不是“一把锁”，而是 “锁矩阵”</h5>



































<table><thead><tr><th>锁粒度</th><th>共享锁（S 锁） （读锁，允许多读）</th><th>排他锁（X 锁） （写锁，独占）</th><th>意向锁（表级，辅助判断）</th></tr></thead><tbody><tr><td><strong>表级</strong></td><td>表 S 锁（极少用，如<code>LOCK TABLES ... READ</code>）</td><td>表 X 锁（极少用，如<code>LOCK TABLES ... WRITE</code>）</td><td>意向 S 锁（IS）、意向 X 锁（IX）</td></tr><tr><td><strong>行级</strong></td><td>行 S 锁（<code>SELECT ... FOR SHARE</code>）</td><td>行 X 锁（<code>UPDATE/DELETE/INSERT</code>默认加）</td><td>（行锁无需意向锁）</td></tr><tr><td><strong>间隙级</strong></td><td>间隙 S 锁（无，间隙只防插入）</td><td>间隙 X 锁（防其他事务插入相同间隙）</td><td>无</td></tr><tr><td><strong>Next-Key</strong></td><td>无</td><td>Next-Key 锁（行锁 + 间隙锁，默认行锁算法）</td><td>无</td></tr></tbody></table>
<p>﻿</p>
<h5 data-id="heading-6">3.1.1.2 一张图总结：InnoDB 锁的 “决策逻辑”</h5>
<p>﻿</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a63fcb8e5894899b983a55a5591fa44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=fE70zOi0aQzyezxUrKWq8xYzwMc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h4 data-id="heading-7">3.1.2 理论应用实践</h4>
<h5 data-id="heading-8">3.1.2.1 本次事故的物料：</h5>
<p>mysql表：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">CREATE</span> <span class="hljs-selector-tag">TABLE</span> `<span class="hljs-selector-tag">unify_metric_impl</span>` (
  <span class="hljs-built_in">`id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">50</span>) unsigned <span class="hljs-keyword">NOT</span> NULL AUTO_INCREMENT COMMENT <span class="hljs-string">'自增ID'</span>,
  <span class="hljs-built_in">`metric_def_id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">11</span>) unsigned <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'指标定义id'</span>,
  <span class="hljs-built_in">`logic_table_id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">11</span>) unsigned <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'逻辑表id'</span>,
  <span class="hljs-built_in">`name_en_atomic`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'真实指标名'</span>,
  <span class="hljs-built_in">`committer`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'负责人'</span>,
  <span class="hljs-built_in">`create_time`</span> timestamp <span class="hljs-keyword">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT <span class="hljs-string">'开始时间'</span>,
  <span class="hljs-built_in">`update_time`</span> timestamp <span class="hljs-keyword">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT <span class="hljs-string">'修改时间'</span>,
  <span class="hljs-built_in">`metric_atomic_name_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'原子指标id'</span>,
  <span class="hljs-built_in">`decorate_id_list_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'修饰列表'</span>,
  <span class="hljs-built_in">`name_cn_alias_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'中文别名'</span>,
  <span class="hljs-built_in">`metric_type_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'指标类型：DERIVE 衍生指标，FORMULA 复合指标'</span>,
  <span class="hljs-built_in">`description_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'指标说明'</span>,
  <span class="hljs-built_in">`data_type_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'数据类型：STRING，DOUBLE, LONG, INT'</span>,
  <span class="hljs-built_in">`data_accuracy_temp`</span> <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'2'</span> COMMENT <span class="hljs-string">'数据精度-小数点后几位'</span>,
  <span class="hljs-built_in">`security_level_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) DEFAULT <span class="hljs-string">'-1'</span> COMMENT <span class="hljs-string">'安全等级'</span>,
  <span class="hljs-built_in">`logic_table_id_excel_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) DEFAULT <span class="hljs-string">'-1'</span> COMMENT <span class="hljs-string">'模型excelId'</span>,
  <span class="hljs-built_in">`implement_type`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'指标实现类型：APP、ATOMIC 原子服务'</span>,
  <span class="hljs-built_in">`app_ori_metric_name_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'所依赖的app层原始名字（适用于导数任务改变字段的情况）'</span>,
  <span class="hljs-built_in">`name_en_depend_atomic`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'指标依赖字段'</span>,
  <span class="hljs-built_in">`name_en_depend_app`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'所依赖的app层原始名字（适用于导数任务改变字段的情况）'</span>,
  <span class="hljs-built_in">`update_status`</span> <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'信息更新状态 0-未完成更新，1-完成更新'</span>,
  <span class="hljs-built_in">`status`</span> <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'信息更新状态 0-未完成更新，1-完成更新'</span>,
  <span class="hljs-built_in">`light_decorate_id_list`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'点灯修饰id列表'</span>,
  <span class="hljs-built_in">`extend_decorate_id_list`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'支持的动态修饰id列表'</span>,
  <span class="hljs-built_in">`extend_function_id_list`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'支持的原子服务函数id列表'</span>,
  <span class="hljs-built_in">`aggregation_type`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'聚合类型:ORIGINAL 原值 COUNT 计数 DISTINCT 指定字段去重 SUM 求和 AVG  均值 MIN 求最大值 MAX 求最小值 QUANTITLE 求分位数'</span>,
  <span class="hljs-built_in">`middle_aggregation_type`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'中间层类型,UNKNOWN:未知,AGG_BY_FIELD:按聚合字段分组后聚合,AGG_BY_DAY:按天去重后累加'</span>,
  <span class="hljs-built_in">`static_decorate_id_list_combination`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'支持的固化修饰id列表组合,[[d1,d2],[d2]]'</span>,
  PRIMARY KEY (<span class="hljs-built_in">`id`</span>),
  KEY <span class="hljs-built_in">`idx_metric_def_id`</span> (<span class="hljs-built_in">`metric_def_id`</span>,<span class="hljs-built_in">`logic_table_id`</span>)
) <span class="hljs-selector-tag">ENGINE</span>=<span class="hljs-selector-tag">InnoDB</span> <span class="hljs-selector-tag">DEFAULT</span> <span class="hljs-selector-tag">CHARSET</span>=<span class="hljs-selector-tag">utf8</span> <span class="hljs-selector-tag">COMMENT</span>='指标实现';
</code></pre>
<h5 data-id="heading-9">3.1.2.2 实践分析</h5>
<p>通过mysql的innoDB的锁决策，可以得出</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">//删除关联指标</span>
 <span class="hljs-selector-tag">metricImplMapper</span><span class="hljs-selector-class">.deleteByLogicTableIds</span>(Collections.<span class="hljs-built_in">singletonList</span>(logicId));
</code></pre>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">delete <span class="hljs-keyword">from</span> unify_metric_impl <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-title">in</span> (<span class="hljs-params"><span class="hljs-number">45631</span></span>)</span>;
</code></pre>
<p>mysql的索引：KEY <code>idx_metric_def_id</code> (<code>metric_def_id</code>,<code>logic_table_id</code>)</p>
<p>删除写操作，不符合最左匹配原则，因此为表x锁。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99194a4d15d54c0191109be0686aee3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=0yUr5CBGAqfBkmNs%2F%2Fhvd9R7yVg%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>因此请求2的删除操作需要等待请求1的事务释放表锁后才可继续进行，符合当时场景。</p>
<p>﻿</p>
<h3 data-id="heading-10">3.2 分析结论二</h3>
<p>请求2中去查看当前实现的指标的时候，发现库里已经存在所有指标不会进行新增，与上一步删除的逻辑相悖。</p>
<h4 data-id="heading-11">3.2.1 复习Mysql的事务</h4>
<h5 data-id="heading-12">3.2.1.1 ACID 不是 "四个独立特性"，而是 "因果链"</h5>
<p>﻿</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dd42117c88e478ca165db2bec4947f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=GauWe4zg0sQbWvYSqOG%2FMF6Mm4Q%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>一句话</strong>：ACID 的核心是<strong>一致性</strong>，其他三个特性都是为了实现它的手段。</p>
<p>•<strong>一致性</strong>（Consistency）：一致性确保事务将数据库从一个一致的状态转变到另一个一致的状态。即使在多个事务同时执行的情况下，数据库也能保持数据的一致性。</p>
<p>•<strong>原子性</strong>（Atomicity）：事务是 "不可分割的工作单元"（要么全成，要么全败），是一致性的<strong>前提</strong>（如果步骤能拆分，中间失败就会破坏一致性）。</p>
<p>•<strong>隔离性</strong>（Isolation）：通过控制多事务并发规则，避免互相干扰，是一致性的<strong>保障</strong>（并发混乱会直接破坏一致性）。</p>
<p>•<strong>耐久性</strong>（Durability）：事务提交后结果永久保存，是一致性的<strong>最终落点</strong>（否则重启后数据丢失，之前的一致性白搭）。</p>
<p>﻿</p>
<h5 data-id="heading-13">3.2.1.2 隔离级别：不是 "越严越好"，而是 "成本与需求的平衡术"</h5>
<p>InnoDB 的 4 种隔离级别，本质是用 "数据可见性" 换 "并发性能"的选择：</p>








































<table><thead><tr><th>隔离级别</th><th>解决的问题</th><th>无法解决的问题</th><th>性能消耗</th><th>典型场景</th></tr></thead><tbody><tr><td>读未提交（RU）</td><td>无</td><td>脏读、不可重复读、幻读</td><td>极低</td><td>实时监控（允许脏数据）</td></tr><tr><td>读已提交（RC）</td><td>脏读</td><td>不可重复读、幻读</td><td>低</td><td>互联网普通业务</td></tr><tr><td>可重复读（RR，默认）</td><td>脏读、不可重复读</td><td>幻读（被 Next-Key 锁解决）</td><td>中</td><td>金融交易、库存管理</td></tr><tr><td>串行化（Serializable）</td><td>所有并发问题</td><td>无</td><td>极高</td><td>银行对账（无并发需求）</td></tr></tbody></table>
<p>﻿</p>
<h5 data-id="heading-14">3.2.1.3 MVCC：事务的 "平行宇宙" 机制（为什么读写不冲突？）</h5>
<p>InnoDB 的<strong>多版本并发控制</strong>是 "无锁读" 的核心，它让读和写像在平行宇宙中运行：</p>
<p><strong>底层逻辑（用 "时间戳" 理解</strong>）：</p>
<p>•每个事务启动时，会拿到一个<strong>全局递增的事务 ID（trx_id）</strong> 。</p>
<p>•每行数据隐藏 3 个字段：</p>
<p>◦<code>DB_TRX_ID</code>：最后修改该行的事务 ID；</p>
<p>◦<code>DB_ROLL_PTR</code>：指向 undo 日志的指针（存储历史版本）；</p>
<p>◦<code>DB_DELETED</code>：标记是否删除（逻辑删除）。</p>
<p><strong>读操作的 "幻术"</strong> ：</p>
<p>•<strong>快照读</strong>（普通 SELECT）：只看 "事务 ID ≤ 自己 ID" 且 "未被删除" 的版本，完全不加锁。 例：事务 A（ID=100）查询时，会忽略所有被 ID&gt;100 的事务修改的数据。</p>
<p>包含 4 个核心字段：</p>
<p>•<code>m_ids</code>：生成 Read View 时，<strong>当前活跃的事务 ID 列表</strong>（未提交的事务）。</p>
<p>•<code>min_trx_id</code>：<code>m_ids</code>中最小的事务 ID。</p>
<p>•<code>max_trx_id</code>：下一个将要分配的事务 ID（非活跃事务 ID，仅用于判断 “未来事务”）。</p>
<p>•<code>creator_trx_id</code>：生成该 Read View 的事务自身 ID。</p>
<p><strong>可见性判断规则</strong>（一条记录是否对当前事务可见，取决于其 “最后修改事务 ID”，记为<code>db_trx_id</code>）：</p>
<p>1.若db_trx_id == creator_trx_id：可见（自己修改的自己可见）。</p>
<p>2.若db_trx_id &lt; min_trx_id：可见（修改记录的事务在当前快照生成前已提交）。</p>
<p>3.若db_trx_id &gt;= max_trx_id：不可见（修改记录的事务在当前快照生成后才启动）。</p>
<p>4.若min_trx_id ≤ db_trx_id &lt; max_trx_id：</p>
<p>◦若db_trx_id在m_ids中：不可见（该事务仍活跃，未提交）。</p>
<p>◦若db_trx_id不在m_ids中：可见（该事务已提交）。</p>
<p>5.当前读（加锁读 / 写操作）：读取最新版本，并加锁防止其他事务修改。</p>
<h5 data-id="heading-15">3.2.1.4 事务日志：InnoDB 的 "安全与性能" 平衡术</h5>
<p>事务能既保证 durability 又不慢，全靠两大日志：</p>
<p>1.<strong>redo log（重做日志）</strong> ：</p>
<p>◦作用：崩溃后恢复未写入磁盘的数据（保证 durability）。</p>
<p>◦反直觉：事务提交时，数据先写 redo log（内存 + 磁盘），再异步刷到数据文件（这叫 WAL 技术）。</p>
<p>◦为什么快？redo log 是<strong>顺序写</strong>（磁盘顺序写比随机写快 100 倍 +）。</p>
<p>2.<strong>undo log（回滚日志）</strong> ：</p>
<p>◦作用：保存数据修改前的版本，用于事务回滚（保证 atomicity）和 MVCC 快照读。</p>
<p>◦注意：undo log 会被 purge 线程定期清理（当没有事务需要旧版本时）。</p>
<h5 data-id="heading-16">3.2.1.5 终极心法：事务设计的 "3 个凡是"</h5>
<p>1.<strong>凡是不需要事务的操作，坚决不用</strong>（如日志插入可关闭自动提交，批量提交）。</p>
<p>2.<strong>凡是能在 RC 解决的，绝不升 RR</strong>（互联网业务优先选 RC，用业务逻辑防不可重复读）。</p>
<p>3.<strong>凡是大事务，必拆分成 "读 - 算 - 写" 三步</strong>（读阶段不加锁，算阶段在应用层，写阶段用最短事务加锁）。</p>
<p>记住：事务的本质不是 "约束"，而是 "工具"—— 能解决问题的最简单事务，才是最好的事务。</p>
<p>﻿</p>
<h4 data-id="heading-17">3.2.2 理论应用实践</h4>
<h5 data-id="heading-18">3.2.2.1 本次事故的物料：</h5>
<p>表的事务等级：</p>
<pre><code class="hljs language-scss" lang="scss">SELECT @<span class="hljs-keyword">@transaction</span>_isolation;
</code></pre>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e9bed606d5345bb811ff2d41995659f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=S8WVV%2FOWw9D4Y6lUA3hODMHPyDE%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>需要删除的指标实现(根据实现id):</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">delete <span class="hljs-keyword">from</span> unify_metric_impl <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-title">in</span> (<span class="hljs-params"><span class="hljs-number">45631</span></span>)</span>;
</code></pre>
<p>需要插入的指标实现：</p>
<pre><code class="hljs language-go" lang="go">INSERT INTO <span class="hljs-string">`unify_metric_impl`</span> (<span class="hljs-string">`id`</span>, <span class="hljs-string">`metric_def_id`</span>, <span class="hljs-string">`logic_table_id`</span>, <span class="hljs-string">`name_en_atomic`</span>, <span class="hljs-string">`committer`</span>, <span class="hljs-string">`create_time`</span>, <span class="hljs-string">`update_time`</span>, <span class="hljs-string">`metric_atomic_name_temp`</span>, <span class="hljs-string">`decorate_id_list_temp`</span>, <span class="hljs-string">`name_cn_alias_temp`</span>, <span class="hljs-string">`metric_type_temp`</span>, <span class="hljs-string">`description_temp`</span>, <span class="hljs-string">`data_type_temp`</span>, <span class="hljs-string">`data_accuracy_temp`</span>, <span class="hljs-string">`security_level_temp`</span>, <span class="hljs-string">`logic_table_id_excel_temp`</span>, <span class="hljs-string">`implement_type`</span>, <span class="hljs-string">`app_ori_metric_name_temp`</span>, <span class="hljs-string">`name_en_depend_atomic`</span>, <span class="hljs-string">`name_en_depend_app`</span>, <span class="hljs-string">`update_status`</span>, <span class="hljs-string">`status`</span>, <span class="hljs-string">`light_decorate_id_list`</span>, <span class="hljs-string">`extend_decorate_id_list`</span>, <span class="hljs-string">`extend_function_id_list`</span>, <span class="hljs-string">`aggregation_type`</span>, <span class="hljs-string">`middle_aggregation_type`</span>, <span class="hljs-string">`static_decorate_id_list_combination`</span>)
VALUES
	(<span class="hljs-number">1358195</span>, <span class="hljs-number">19872</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_user_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358196</span>, <span class="hljs-number">19873</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_sku_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358197</span>, <span class="hljs-number">19875</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_ord_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358198</span>, <span class="hljs-number">19945</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_sku_deal_ord_sku_dis_qtty_main_img_video_num'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358199</span>, <span class="hljs-number">17263</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358200</span>, <span class="hljs-number">28017</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_bd_bd_attendance_offline__store_cnt_bd_attendance_cnt'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'COUNT_DISTINCT'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358201</span>, <span class="hljs-number">20242</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_app__ord_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358202</span>, <span class="hljs-number">18450</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_amt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358203</span>, <span class="hljs-number">20276</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_app__ord_cnt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358204</span>, <span class="hljs-number">18452</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_sku_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358205</span>, <span class="hljs-number">18453</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_user_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358206</span>, <span class="hljs-number">18456</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_sku_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358207</span>, <span class="hljs-number">19866</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_ord_amt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358208</span>, <span class="hljs-number">21691</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_amt_include_moutai'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358209</span>, <span class="hljs-number">19871</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_sku_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>);
</code></pre>
<h5 data-id="heading-19">3.2.2.2 实践分析：</h5>
<p>用sql模拟两个事务的执行过程：</p>
<p>事务1：</p>
<pre><code class="hljs language-javascript" lang="javascript">begin;

select * <span class="hljs-keyword">from</span> unify_metric_impl umi where logic_table_id =  <span class="hljs-number">45631</span>;

<span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> unify_metric_impl where logic_table_id <span class="hljs-keyword">in</span> (<span class="hljs-number">45631</span>);

<span class="hljs-variable constant_">SELECT</span> trx_id, trx_query <span class="hljs-variable constant_">FROM</span> <span class="hljs-variable constant_">INFORMATION_SCHEMA</span>.<span class="hljs-property">INNODB_TRX</span>;

select * <span class="hljs-keyword">from</span> unify_metric_impl umi where logic_table_id =  <span class="hljs-number">45631</span>;

<span class="hljs-variable constant_">INSERT</span> <span class="hljs-variable constant_">INTO</span> <span class="hljs-string">`unify_metric_impl`</span> ( <span class="hljs-string">`metric_def_id`</span>, <span class="hljs-string">`logic_table_id`</span>, <span class="hljs-string">`name_en_atomic`</span>, <span class="hljs-string">`committer`</span>, <span class="hljs-string">`create_time`</span>, <span class="hljs-string">`update_time`</span>, <span class="hljs-string">`metric_atomic_name_temp`</span>, <span class="hljs-string">`decorate_id_list_temp`</span>, <span class="hljs-string">`name_cn_alias_temp`</span>, <span class="hljs-string">`metric_type_temp`</span>, <span class="hljs-string">`description_temp`</span>, <span class="hljs-string">`data_type_temp`</span>, <span class="hljs-string">`data_accuracy_temp`</span>, <span class="hljs-string">`security_level_temp`</span>, <span class="hljs-string">`logic_table_id_excel_temp`</span>, <span class="hljs-string">`implement_type`</span>, <span class="hljs-string">`app_ori_metric_name_temp`</span>, <span class="hljs-string">`name_en_depend_atomic`</span>, <span class="hljs-string">`name_en_depend_app`</span>, <span class="hljs-string">`update_status`</span>, <span class="hljs-string">`status`</span>, <span class="hljs-string">`light_decorate_id_list`</span>, <span class="hljs-string">`extend_decorate_id_list`</span>, <span class="hljs-string">`extend_function_id_list`</span>, <span class="hljs-string">`aggregation_type`</span>, <span class="hljs-string">`middle_aggregation_type`</span>, <span class="hljs-string">`static_decorate_id_list_combination`</span>)
<span class="hljs-variable constant_">VALUES</span>
	(<span class="hljs-number">19872</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_user_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19873</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_sku_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19875</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_ord_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19945</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_sku_deal_ord_sku_dis_qtty_main_img_video_num'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">17263</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">28017</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_bd_bd_attendance_offline__store_cnt_bd_attendance_cnt'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'COUNT_DISTINCT'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">20242</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_app__ord_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">18450</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_amt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">20276</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_app__ord_cnt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">18452</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_sku_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">18453</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_user_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">18456</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_sku_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19866</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_ord_amt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">21691</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_amt_include_moutai'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19871</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_sku_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>);

commit;
</code></pre>
<p>﻿</p>
<p>事务2：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">begin</span>;

<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> unify_metric_impl umi <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-operator">=</span>  <span class="hljs-number">45631</span>;

<span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> unify_metric_impl <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-keyword">in</span> (<span class="hljs-number">45631</span>);

<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> unify_metric_impl umi <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-operator">=</span>  <span class="hljs-number">45631</span>;

<span class="hljs-keyword">commit</span>;
</code></pre>
<p>﻿</p>
<p>流程图(用一行数据进行演示版本控制)：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/259104ee5b684d4cad1073bfca57cde9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=FLMhTrOT5MG0zGyr571kYG0R7X4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>为何事务1的select查询出“为空”，事务2的select查询出“不为空”：</p>






























<table><thead><tr><th>对比维度</th><th>事务 1 查询（读自己的删除版本 V2）</th><th>事务 2 查询（读readview前的V1版本）</th></tr></thead><tbody><tr><td>自己生成的版本</td><td>V2（trx_id=17190，已删除）</td><td>V4（trx_id=17191，已删除）</td></tr><tr><td>对自己版本的处理</td><td>可见，且<strong>事务内需反映自己的删除操作</strong>，所以不追溯前驱 V1</td><td>不可见，但<strong>当前删除的版本是由其他事务得到(V3)</strong> ，并非在readview之前的数据。</td></tr><tr><td>追溯的终止条件</td><td>遇到自己生成的版本，即使已删除，也终止追溯</td><td>遇到自己生成的已删除版本，但不符合"有效删除"，需继续追溯</td></tr><tr><td>最终返回结果</td><td>v2（已删除版本，反映自己的删除操作）</td><td>V1（readview之前有效的版本）</td></tr></tbody></table>
<p>﻿</p>
<h2 data-id="heading-20">4.解决办法</h2>
<p>为了解决事务2的查询"不为空"的问题，分别列出以下方案：</p>

































<table><thead><tr><th>﻿</th><th>解决办法</th><th>优点</th><th>缺点</th><th>倾向</th></tr></thead><tbody><tr><td>方式1</td><td>针对同一个逻辑表的同步添加分布式锁</td><td>实现成本低，影响范围小</td><td>存在长事务的问题</td><td>短期解法</td></tr><tr><td>方式2</td><td>将事务2的select改为当前读(使用slecet...for update)，这样就能查询出最新的数据为空</td><td>实现成本低，</td><td>存在长事务的问题，影响范围大(长事务涉及逻辑多)</td><td>不推荐</td></tr><tr><td>方式3</td><td>将长事务拆分， <strong>"读 - 算 - 写" 三步</strong> 1. 读：无锁读取原子服务与实现数据； 2. 算：在应用层对比新增 / 删除数据； 3. 写：仅对差异数据执行短事务操作</td><td>从根源解决问题</td><td>实现成本大，重构该方法</td><td>长期解法</td></tr></tbody></table>
<p><strong>当前落地情况</strong>：已通过 “分布式锁控制同一逻辑表同步并发” 的短期方案解决事故，后续将在业务迭代中推进 “读 - 算 - 写” 拆分的长期优化，进一步降低事务粒度与锁冲突风险。</p>
<h2 data-id="heading-21">5.附录</h2>
<h3 data-id="heading-22">5.1名词解释</h3>
<p>事实逻辑表：由物理数仓中的事实表和维度逻辑表关联形成的语义表，可以描述业务过程的详细信息，是指标的数据来源。</p>
<p>原子服务：指标的实现方式，一个指标可以有多个实现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[KuiklyUI的ViewRef设计]]></title>    <link>https://juejin.cn/post/7570902804450934794</link>    <guid>https://juejin.cn/post/7570902804450934794</guid>    <pubDate>2025-11-10T09:55:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570902804450934794" data-draft-id="7570902804450836490" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="KuiklyUI的ViewRef设计"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-10T09:55:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            KuiklyUI的ViewRef设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T09:55:33.000Z" title="Mon Nov 10 2025 09:55:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">nativeRef与ViewRef、AbstractBaseView、Pager以及ViewContainer的关系分析</h2>
<p>本文将深入分析KuiklyUI框架中nativeRef与ViewRef、AbstractBaseView、Pager以及ViewContainer与ViewRef之间的关系，帮助您全面理解视图引用系统的设计与实现。</p>
<h3 data-id="heading-1">一、nativeRef的本质与工作机制</h3>
<h4 data-id="heading-2">1.1 nativeRef的定义与生成机制</h4>
<p>nativeRef是KuiklyUI中每个视图实例的唯一标识符，定义在AbstractBaseView类中：</p>
<pre><code class="hljs language-kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/AbstractBaseView.kt" lang="kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/AbstractBaseView.kt">abstract class AbstractBaseView&lt;A : Attr, E : Event&gt; : BaseObject(), IViewPublicApi&lt;A, E&gt;, IModuleAccessor, IPagerId {
    val nativeRef: Int = ++nativeRefProducer
    // ...
    companion object {
        var nativeRefProducer = 0
    }
}
</code></pre>
<p>nativeRef通过一个静态计数器<code>nativeRefProducer</code>自增生成，确保每个视图实例拥有全局唯一的标识符。这种设计使得框架可以在整个应用生命周期内精确识别每一个视图。</p>
<h4 data-id="heading-3">1.2 nativeRef在视图系统中的核心作用</h4>
<p>nativeRef在KuiklyUI框架中扮演着多重关键角色：</p>
<ol>
<li><strong>视图身份标识</strong>：作为视图实例的唯一身份标识</li>
<li><strong>视图引用传递</strong>：在父子视图之间传递引用关系</li>
<li><strong>跨层通信桥梁</strong>：连接Kotlin层与原生渲染层</li>
<li><strong>属性与事件绑定</strong>：在创建Attr和Event对象时被注入，用于后续属性更新和事件分发</li>
</ol>
<p>在AbstractBaseView的内部实现中，我们可以看到nativeRef被注入到Attr和Event对象中：</p>
<pre><code class="hljs language-kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/AbstractBaseView.kt" lang="kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/AbstractBaseView.kt">private fun internalCreateEvent(): E {
    val event = createEvent()
    event.init(pagerId,nativeRef)  // 将nativeRef注入到Event对象
    return event
}

protected fun internalCreateAttr(): A {
    val attr = createAttr()
    attr.pagerId = pagerId
    attr.nativeRef = nativeRef  // 将nativeRef注入到Attr对象
    attr.flexNode = flexNode
    return attr
}
</code></pre>
<h3 data-id="heading-4">二、ViewRef与nativeRef的关系</h3>
<h4 data-id="heading-5">2.1 ViewRef的定义与实现</h4>
<p>ViewRef是一个轻量级的引用封装类，定义在DeclarativeBaseView.kt中：</p>
<pre><code class="hljs language-kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/DeclarativeBaseView.kt" lang="kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/DeclarativeBaseView.kt">class ViewRef&lt;T : DeclarativeBaseView&lt;*, *&gt;&gt;(val pagerId: String, val nativeRef: Int) {
    val view: T?
        get() = PagerManager.getPager(pagerId)
            .getViewWithNativeRef(nativeRef) as? T
}
</code></pre>
<h4 data-id="heading-6">2.2 ViewRef与nativeRef的协作关系</h4>
<p>ViewRef与nativeRef之间存在着紧密的协作关系：</p>
<ol>
<li><strong>组成关系</strong>：ViewRef封装了pagerId和nativeRef两个核心属性</li>
<li><strong>定位机制</strong>：ViewRef通过pagerId和nativeRef组合定位到具体的视图实例</li>
<li><strong>延迟查找</strong>：ViewRef的<code>view</code>属性采用懒加载方式，只有在需要时才通过PagerManager查找视图</li>
<li><strong>类型安全</strong>：ViewRef使用泛型确保返回的视图类型正确</li>
</ol>
<h3 data-id="heading-7">三、ViewRef与AbstractBaseView的关系</h3>
<h4 data-id="heading-8">3.1 ref扩展函数的实现</h4>
<p>在DeclarativeBaseView中，实现了<code>ref</code>扩展函数，作为创建ViewRef的入口：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : DeclarativeBaseView&lt;*, *&gt;</span>&gt; T.<span class="hljs-title">ref</span><span class="hljs-params">(ref: (<span class="hljs-type">viewRef</span>: <span class="hljs-type">ViewRef</span>&lt;<span class="hljs-type">T</span>&gt;) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    ref(ViewRef&lt;T&gt;(pagerId, nativeRef))
}
</code></pre>
<h4 data-id="heading-9">3.2 AbstractBaseView与ViewRef的交互流程</h4>
<p>AbstractBaseView与ViewRef的交互流程如下：</p>
<ol>
<li>AbstractBaseView实例创建时生成唯一的nativeRef</li>
<li>通过ref扩展函数，将当前视图的pagerId和nativeRef传递给ViewRef构造函数</li>
<li>ViewRef持有这些引用信息，但不直接持有视图实例</li>
<li>当需要访问视图时，通过ViewRef的<code>view</code>属性间接获取</li>
</ol>
<p>这种设计实现了视图引用的解耦，使框架能够更灵活地管理视图生命周期和内存。</p>
<h3 data-id="heading-10">四、ViewRef与Pager的协作机制</h3>
<h4 data-id="heading-11">4.1 Pager的视图引用管理</h4>
<p>Pager类实现了IPager接口，负责管理视图引用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Pager中管理视图引用的关键代码</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> nativeRefViewMap = mutableMapOf&lt;<span class="hljs-built_in">Int</span>, AbstractBaseView&lt;*, *&gt;&gt;()

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">putNativeViewRef</span><span class="hljs-params">(nativeRef: <span class="hljs-type">Int</span>, view: <span class="hljs-type">AbstractBaseView</span>&lt;*, *&gt;)</span></span> {
    nativeRefViewMap[nativeRef] = view
}

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">removeNativeViewRef</span><span class="hljs-params">(nativeRef: <span class="hljs-type">Int</span>)</span></span> {
    nativeRefViewMap.remove(nativeRef)
}

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getViewWithNativeRef</span><span class="hljs-params">(nativeRef: <span class="hljs-type">Int</span>)</span></span>: AbstractBaseView&lt;*, *&gt;? {
    <span class="hljs-keyword">return</span> nativeRefViewMap[nativeRef]
}
</code></pre>
<h4 data-id="heading-12">4.2 ViewRef与Pager的协作流程</h4>
<p>ViewRef与Pager的协作流程如下：</p>
<ol>
<li>ViewRef持有pagerId和nativeRef信息</li>
<li>当调用ViewRef的<code>view</code>属性时，通过PagerManager获取对应pagerId的Pager实例</li>
<li>调用Pager的<code>getViewWithNativeRef</code>方法，通过nativeRef查找视图实例</li>
<li>将找到的视图实例转换为泛型T类型并返回</li>
</ol>
<p>这种设计使得ViewRef可以安全地在任何地方访问视图，而不需要直接持有视图实例的强引用，有利于内存管理和视图生命周期控制。</p>
<h3 data-id="heading-13">五、ViewContainer与ViewRef的关系</h3>
<h4 data-id="heading-14">5.1 ViewContainer的视图层次管理</h4>
<p>ViewContainer是所有容器视图的基类，负责管理子视图层次结构：</p>
<pre><code class="hljs language-kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt" lang="kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt">abstract class ViewContainer&lt;A : ContainerAttr, E : Event&gt; : DeclarativeBaseView&lt;A, E&gt;() {
    protected val children = fastArrayListOf&lt;DeclarativeBaseView&lt;*, *&gt;&gt;()
    // ...
}
</code></pre>
<h4 data-id="heading-15">5.2 ViewContainer中nativeRef的应用</h4>
<p>在ViewContainer中，nativeRef主要用于以下几个方面：</p>
<ol>
<li><strong>父视图引用传递</strong>：在添加子视图时，设置子视图的parentRef为当前容器的nativeRef</li>
</ol>
<pre><code class="hljs language-kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt" lang="kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt">private fun internalAddChild(child: DeclarativeBaseView&lt;*, *&gt;, index: Int) {
    child.pagerId = pagerId
    child.willMoveToParentComponent()
    if (index &lt; 0) { // append when index -1
        children.add(child)
    } else {
        children.add(index, child)
    }
    child.parentRef = nativeRef  // 设置父视图引用
    child.didMoveToParentView()
}
</code></pre>
<ol start="2">
<li><strong>渲染视图管理</strong>：在创建和移除渲染视图时，使用nativeRef标识视图</li>
</ol>
<pre><code class="hljs language-kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt" lang="kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt">override fun createRenderView() {
    createRenderViewing = true
    super.createRenderView()
    createRenderViewing = false
    var index = 0
    renderChildren().forEach { child -&gt;
        child.createRenderView()
        renderView?.insertSubRenderView(child.nativeRef, index++)  // 使用nativeRef标识子视图
        child.renderViewDidMoveToParentRenderView()
    }
}
</code></pre>
<ol start="3">
<li><strong>视图引用链建立</strong>：通过nativeRef和parentRef建立完整的视图引用链</li>
</ol>
<h4 data-id="heading-16">5.3 ViewContainer中ViewRef的使用场景</h4>
<p>在ViewContainer中，ViewRef主要用于以下场景：</p>
<ol>
<li><strong>子视图引用获取</strong>：通过ViewRef安全地获取子视图引用，进行操作或通信</li>
<li><strong>跨层级视图访问</strong>：在复杂布局中，通过ViewRef实现跨层级的视图访问</li>
<li><strong>视图生命周期管理</strong>：在视图添加、移除等生命周期事件中，通过ViewRef传递引用信息</li>
</ol>
<h3 data-id="heading-17">六、整体架构与数据流</h3>
<h4 data-id="heading-18">6.1 核心组件关系图</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------+      +------------------+      +------------------+</span>
|                  |      |                  |      |                  |
|  AbstractBaseView|&lt;<span class="hljs-comment">-----&gt;|    ViewRef       |&lt;-----&gt;|     Pager        |</span>
|                  |      |                  |      |                  |
+<span class="hljs-comment">--------^---------+      +------------------+      +------------------+</span>
         |
         |
+<span class="hljs-comment">--------+---------+      +------------------+</span>
|                  |      |                  |
|  ViewContainer   |&lt;<span class="hljs-comment">-----&gt;|   Declarative   |</span>
|                  |      |     BaseView     |
+<span class="hljs-comment">------------------+      +------------------+</span>
</code></pre>
<h4 data-id="heading-19">6.2 数据流向与交互模式</h4>
<p>在KuiklyUI的视图引用系统中，数据流向和交互模式如下：</p>
<ol>
<li><strong>创建阶段</strong>：视图实例创建时生成nativeRef，Pager注册视图引用</li>
<li><strong>引用封装</strong>：通过ref扩展函数创建ViewRef对象，封装pagerId和nativeRef</li>
<li><strong>引用访问</strong>：通过ViewRef的view属性，间接访问视图实例</li>
<li><strong>生命周期管理</strong>：在视图添加到容器或从容器移除时，更新parentRef和视图引用注册状态</li>
<li><strong>销毁阶段</strong>：视图销毁时，从Pager中移除视图引用</li>
</ol>
<h3 data-id="heading-20">七、设计优势与技术亮点</h3>
<h4 data-id="heading-21">7.1 设计优势</h4>
<ol>
<li><strong>解耦视图引用</strong>：ViewRef通过间接引用机制，实现了视图引用与视图实例的解耦</li>
<li><strong>内存优化</strong>：避免了不必要的强引用，有利于内存管理和垃圾回收</li>
<li><strong>类型安全</strong>：泛型设计确保了类型安全，减少了运行时类型转换错误</li>
<li><strong>灵活的视图访问</strong>：可以在任何地方通过ViewRef安全地访问视图，不受生命周期限制</li>
</ol>
<h4 data-id="heading-22">7.2 技术亮点</h4>
<ol>
<li><strong>唯一标识符生成机制</strong>：通过静态计数器生成全局唯一的nativeRef</li>
<li><strong>延迟查找策略</strong>：ViewRef的view属性采用懒加载方式，只有在需要时才查找视图</li>
<li><strong>引用链管理</strong>：通过nativeRef和parentRef建立完整的视图层次引用链</li>
<li><strong>跨平台兼容性</strong>：设计考虑了跨平台需求，nativeRef作为统一的视图标识符</li>
</ol>
<h3 data-id="heading-23">八、代码优化建议</h3>
<p>基于对ViewRef和nativeRef系统的分析，提出以下优化建议：</p>
<ol>
<li>
<p><strong>引用有效性检查增强</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在ViewRef的view属性中添加更完善的有效性检查</span>
<span class="hljs-keyword">val</span> view: T?
    <span class="hljs-keyword">get</span>() {
        <span class="hljs-keyword">val</span> pager = PagerManager.getPager(pagerId)
        <span class="hljs-keyword">if</span> (pager == <span class="hljs-literal">null</span> || !pager.isActive()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        }
        <span class="hljs-keyword">val</span> view = pager.getViewWithNativeRef(nativeRef) <span class="hljs-keyword">as</span>? T
        <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span> &amp;&amp; view.isDestroyed()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        }
        <span class="hljs-keyword">return</span> view
    }
</code></pre>
</li>
<li>
<p><strong>弱引用优化</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在Pager中考虑使用WeakReference存储视图引用，避免内存泄漏</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> nativeRefViewMap = mutableMapOf&lt;<span class="hljs-built_in">Int</span>, WeakReference&lt;AbstractBaseView&lt;*, *&gt;&gt;&gt;()
</code></pre>
</li>
<li>
<p><strong>引用缓存机制</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为频繁访问的ViewRef添加缓存机制</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewRef</span>&lt;<span class="hljs-type">T : DeclarativeBaseView&lt;*, *</span>&gt;&gt;(<span class="hljs-keyword">val</span> pagerId: String, <span class="hljs-keyword">val</span> nativeRef: <span class="hljs-built_in">Int</span>) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cachedView: T? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> lastCacheTime: <span class="hljs-built_in">Long</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">val</span> view: T?
        <span class="hljs-keyword">get</span>() {
            <span class="hljs-keyword">val</span> currentTime = System.currentTimeMillis()
            <span class="hljs-comment">// 缓存有效期100ms</span>
            <span class="hljs-keyword">if</span> (cachedView != <span class="hljs-literal">null</span> &amp;&amp; currentTime - lastCacheTime &lt; <span class="hljs-number">100</span>) {
                <span class="hljs-keyword">return</span> cachedView
            }
            cachedView = PagerManager.getPager(pagerId)
                .getViewWithNativeRef(nativeRef) <span class="hljs-keyword">as</span>? T
            lastCacheTime = currentTime
            <span class="hljs-keyword">return</span> cachedView
        }
}
</code></pre>
</li>
</ol>
<p>总结来看，nativeRef与ViewRef、AbstractBaseView、Pager以及ViewContainer之间形成了一套完整、高效的视图引用管理体系，为KuiklyUI框架提供了灵活、安全的视图访问机制。通过这种设计，框架能够有效地管理视图生命周期、优化内存使用，并提供一致的跨平台体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从一个Bug看Android文本编辑的设计缺陷]]></title>    <link>https://juejin.cn/post/7570932873131294747</link>    <guid>https://juejin.cn/post/7570932873131294747</guid>    <pubDate>2025-11-10T13:24:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570932873131294747" data-draft-id="7570932873131278363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从一个Bug看Android文本编辑的设计缺陷"/> <meta itemprop="keywords" content="Android,Linux"/> <meta itemprop="datePublished" content="2025-11-10T13:24:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WAsbry"/> <meta itemprop="url" content="https://juejin.cn/user/3413335797139511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从一个Bug看Android文本编辑的设计缺陷
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3413335797139511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WAsbry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T13:24:41.000Z" title="Mon Nov 10 2025 13:24:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从一个Bug看Android文本编辑的设计缺陷</h2>
<h3 data-id="heading-1">💡 本文精华</h3>
<ul>
<li><strong>承接上文</strong>：第一篇解析了跨进程通信，本篇深入应用进程内部，剖析文本操作的设计缺陷</li>
<li><strong>核心矛盾</strong>：InputFilter期望控制所有文本操作，但delete()绕过了过滤机制</li>
<li><strong>关键发现</strong>：<code>replaceText()</code>先delete后insert，delete传入空字符串""，InputFilter认为合法放行</li>
<li><strong>深层原因</strong>：Span范围在insert失败后与实际文本不同步，导致范围异常扩展，吞噬更多字符</li>
<li><strong>价值</strong>：理解Android文本编辑框架的设计局限，为第三篇的工程解决方案做准备</li>
</ul>
<hr/>
<h3 data-id="heading-2">一、应用进程内部的文本编辑架构</h3>
<h4 data-id="heading-3">1.1 三大核心组件</h4>
<p>上一篇我们理解了Binder如何将输入法的调用传递到应用进程。现在聚焦应用进程内部：</p>
<pre><code class="hljs language-scss" lang="scss">应用进程内部架构：
┌─────────────────────────────────────────┐
│  TextView / EditText                    │
│    ├─ Editable (SpannableStringBuilder)│ ← 文本缓冲区
│    │    - char<span class="hljs-selector-attr">[]</span> mText                  │
│    │    - <span class="hljs-selector-tag">Object</span><span class="hljs-selector-attr">[]</span> mSpans               │
│    │                                    │
│    ├─ InputFilter<span class="hljs-selector-attr">[]</span>                    │ ← 过滤器链
│    │    - DigitsKeyListener             │
│    │    - LengthFilter                  │
│    │                                    │
│    └─ InputConnection                  │ ← 外部接口
│         - BaseInputConnection           │
└─────────────────────────────────────────┘
</code></pre>
<p><strong>上一篇已讲</strong>：InputConnection是跨进程接口
<strong>本篇聚焦</strong>：Editable、InputFilter、Span如何协同工作</p>
<h4 data-id="heading-4">1.2 Editable接口设计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Editable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CharSequence</span>, Spannable {
    <span class="hljs-comment">// 核心的三个操作</span>
    Editable <span class="hljs-title function_">insert</span><span class="hljs-params">(<span class="hljs-type">int</span> where, CharSequence text)</span>;
    Editable <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-type">int</span> st, <span class="hljs-type">int</span> en)</span>;
    Editable <span class="hljs-title function_">replace</span><span class="hljs-params">(<span class="hljs-type">int</span> st, <span class="hljs-type">int</span> en, CharSequence text)</span>;

    <span class="hljs-comment">// 过滤器管理</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFilters</span><span class="hljs-params">(InputFilter[] filters)</span>;
    InputFilter[] getFilters();
}
</code></pre>
<p><strong>实现类</strong>：SpannableStringBuilder</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpannableStringBuilder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Editable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">char</span>[] mText;           <span class="hljs-comment">// 存储字符</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> mGapStart;          <span class="hljs-comment">// Gap Buffer优化</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> mGapLength;

    <span class="hljs-keyword">private</span> Object[] mSpans;        <span class="hljs-comment">// 存储Span对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] mSpanStarts;      <span class="hljs-comment">// Span起始位置</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] mSpanEnds;        <span class="hljs-comment">// Span结束位置</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] mSpanFlags;       <span class="hljs-comment">// Span标志</span>

    <span class="hljs-comment">// 核心实现</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> SpannableStringBuilder <span class="hljs-title function_">replace</span><span class="hljs-params">(<span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end,
                                          CharSequence tb, <span class="hljs-type">int</span> tbstart, <span class="hljs-type">int</span> tbend)</span> {
        <span class="hljs-comment">// 关键：这里会调用InputFilter链</span>
        InputFilter[] filters = getFilters();
        <span class="hljs-keyword">if</span> (filters != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; filters.length; i++) {
                <span class="hljs-type">CharSequence</span> <span class="hljs-variable">repl</span> <span class="hljs-operator">=</span> filters[i].filter(tb, tbstart, tbend,
                                                      <span class="hljs-built_in">this</span>, start, end);
                <span class="hljs-keyword">if</span> (repl != <span class="hljs-literal">null</span>) {
                    tb = repl;
                    tbstart = <span class="hljs-number">0</span>;
                    tbend = repl.length();
                }
            }
        }

        <span class="hljs-comment">// 执行实际的文本替换</span>
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>insert/delete最终都调用replace()</li>
<li>replace()会触发InputFilter链</li>
<li>但有个例外...</li>
</ul>
<hr/>
<h3 data-id="heading-5">二、设计缺陷的核心：不对称的控制权</h3>
<h4 data-id="heading-6">2.1 InputFilter的接口设计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InputFilter</span> {
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@param</span> source 要插入的新文本
     * <span class="hljs-doctag">@param</span> start  source的起始位置
     * <span class="hljs-doctag">@param</span> end    source的结束位置
     * <span class="hljs-doctag">@param</span> dest   目标文本(当前EditText内容)
     * <span class="hljs-doctag">@param</span> dstart 插入位置的起始
     * <span class="hljs-doctag">@param</span> dend   插入位置的结束
     * <span class="hljs-doctag">@return</span> null  = 接受source
     *         ""    = 拒绝source
     *         其他  = 替换为返回的内容
     */</span>
    CharSequence <span class="hljs-title function_">filter</span><span class="hljs-params">(CharSequence source, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end,
                       Spanned dest, <span class="hljs-type">int</span> dstart, <span class="hljs-type">int</span> dend)</span>;
}
</code></pre>
<p><strong>DigitsKeyListener的实现</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NumberKeyListener.java (父类)</span>
<span class="hljs-keyword">public</span> CharSequence <span class="hljs-title function_">filter</span><span class="hljs-params">(CharSequence source, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end,
                           Spanned dest, <span class="hljs-type">int</span> dstart, <span class="hljs-type">int</span> dend)</span> {
    <span class="hljs-type">char</span>[] accept = getAcceptedChars(); <span class="hljs-comment">// ['0'-'9']</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> start; i &lt; end; i++) {
        <span class="hljs-keyword">if</span> (!ok(accept, source.charAt(i))) {
            <span class="hljs-comment">// 发现非法字符 (如字母 'q')</span>
            <span class="hljs-keyword">if</span> (end - start == <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// 单个字符，直接拒绝</span>
            }
            <span class="hljs-comment">// 多个字符，过滤掉非法的</span>
            <span class="hljs-comment">// ...</span>
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 全部合法，接受</span>
}

<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">ok</span><span class="hljs-params">(<span class="hljs-type">char</span>[] accept, <span class="hljs-type">char</span> c)</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> accept.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
        <span class="hljs-keyword">if</span> (accept[i] == c) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h4 data-id="heading-7">2.2 delete()的特殊实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SpannableStringBuilder.java</span>
<span class="hljs-keyword">public</span> SpannableStringBuilder <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> {
    <span class="hljs-comment">// 关键：delete本质是replace操作，传入空字符串""</span>
    <span class="hljs-keyword">return</span> replace(start, end, <span class="hljs-string">""</span>);
}

<span class="hljs-comment">// 调用链</span>
delete(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
  ↓
replace(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
  ↓
filter(<span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)  ← InputFilter看到的是空字符串
  ↓
<span class="hljs-comment">// DigitsKeyListener的检查</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0</span>; i++) {  <span class="hljs-comment">// start=0, end=0，循环不执行</span>
    <span class="hljs-comment">// 检查字符合法性</span>
}
  ↓
<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 接受！</span>
</code></pre>
<p><strong>问题本质</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────┐
│         InputFilter的视角                        │
├─────────────────────────────────────────────────┤
│                                                 │
│  <span class="hljs-built_in">insert</span>(<span class="hljs-number">5</span>, "abc"):                             │
│    <span class="hljs-built_in">filter</span>(<span class="hljs-string">"abc"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, dest, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>)            │
│    → 检查 <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span> → 拒绝 ✓               │
│                                                 │
│  <span class="hljs-built_in">delete</span>(<span class="hljs-number">5</span>, <span class="hljs-number">8</span>):                                 │
│    <span class="hljs-built_in">filter</span>(<span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, dest, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>)               │
│    → 检查空字符串 → 接受 ✗                     │
│                                                 │
│  InputFilter无法区分：                          │
│  - 插入空字符串 (应接受)                        │
│  - 删除操作 (应该也能拦截吗?)                   │
│                                                 │
└─────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-8">2.3 设计假设 vs 实际情况</h4>



































<table><thead><tr><th>场景</th><th>设计假设</th><th>实际情况</th><th>是否合理</th></tr></thead><tbody><tr><td><strong>用户按删除键</strong></td><td>delete应该无条件执行</td><td>delete绕过InputFilter</td><td>✓ 合理（尊重用户意图）</td></tr><tr><td><strong>InputFilter拦截insert</strong></td><td>拦截非法字符插入</td><td>只能拦截insert</td><td>✓ 符合预期</td></tr><tr><td><strong>组合文本替换</strong></td><td>替换应该原子执行</td><td>delete先于insert，分离执行</td><td>✗ 不合理</td></tr><tr><td><strong>delete+insert组合</strong></td><td>应该保持一致性</td><td>delete绕过，insert拦截</td><td>✗ 不对称</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-9">三、BaseInputConnection的replaceText()实现</h3>
<h4 data-id="heading-10">3.1 核心代码分析</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// BaseInputConnection.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">replaceText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition, <span class="hljs-type">boolean</span> composing)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">Editable</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> getEditable();
    <span class="hljs-keyword">if</span> (content == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span>;
    }

    beginBatchEdit();

    <span class="hljs-comment">// ========== 步骤1: 获取旧的组合文本范围 ==========</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> getComposingSpanStart(content);
    <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> getComposingSpanEnd(content);

    <span class="hljs-keyword">if</span> (b &lt; a) {
        <span class="hljs-type">int</span> <span class="hljs-variable">tmp</span> <span class="hljs-operator">=</span> a;
        a = b;
        b = tmp;
    }

    <span class="hljs-keyword">if</span> (a != -<span class="hljs-number">1</span> &amp;&amp; b != -<span class="hljs-number">1</span>) {
        removeComposingSpans(content);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 如果没有组合范围，使用选中范围</span>
        a = Selection.getSelectionStart(content);
        b = Selection.getSelectionEnd(content);
    }

    <span class="hljs-comment">// ========== 步骤2: 先删除旧范围 ==========</span>
    <span class="hljs-keyword">if</span> (b != a) {
        content.delete(a, b);  <span class="hljs-comment">// ← 关键: 先删除，不经过InputFilter验证！</span>
    }

    <span class="hljs-comment">// ========== 步骤3: 再插入新文本 ==========</span>
    <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span>) {
        content.insert(a, text);  <span class="hljs-comment">// ← 经过InputFilter，可能被拒绝</span>
    }

    <span class="hljs-comment">// ========== 步骤4: 设置新的组合范围 ==========</span>
    <span class="hljs-keyword">if</span> (composing) {
        setComposingSpans(content, a, a + text.length());
    }

    endBatchEdit();
}
</code></pre>
<h4 data-id="heading-11">3.2 Bug触发的完整流程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 前提：EditText内容 "123456"，光标在末尾</span>

<span class="hljs-comment">// ========== 第1次：setComposingText("q") ==========</span>
replaceText(<span class="hljs-string">"q"</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>)
  ↓
步骤<span class="hljs-number">1</span>: 获取组合范围
  a = getComposingSpanStart() → -<span class="hljs-number">1</span> (无旧范围)
  b = getComposingSpanEnd() → -<span class="hljs-number">1</span>
  使用光标位置: a=<span class="hljs-number">6</span>, b=<span class="hljs-number">6</span>
  ↓
步骤<span class="hljs-number">2</span>: 删除
  <span class="hljs-keyword">if</span> (<span class="hljs-number">6</span> != <span class="hljs-number">6</span>) → <span class="hljs-literal">false</span>，不执行delete
  ↓
步骤<span class="hljs-number">3</span>: 插入
  content.insert(<span class="hljs-number">6</span>, <span class="hljs-string">"q"</span>)
    → filter(<span class="hljs-string">"q"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-number">6</span>, <span class="hljs-number">6</span>)
    → 检查: <span class="hljs-string">'q'</span> 不是数字
    → 返回 <span class="hljs-string">""</span> (拒绝)
    → 插入失败
  ↓
步骤<span class="hljs-number">4</span>: 设置组合范围
  setComposingSpans(<span class="hljs-number">6</span>, <span class="hljs-number">6</span> + <span class="hljs-number">0</span>) → [<span class="hljs-number">6</span>, <span class="hljs-number">6</span>)
  ↓
结果: <span class="hljs-string">"123456"</span> (未变)

<span class="hljs-comment">// ========== 第2次：setComposingText("qq") ==========</span>
replaceText(<span class="hljs-string">"qq"</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>)
  ↓
步骤<span class="hljs-number">1</span>: 获取组合范围
  a = getComposingSpanStart() → <span class="hljs-number">5</span> ← 为什么是<span class="hljs-number">5</span>? (稍后分析)
  b = getComposingSpanEnd() → <span class="hljs-number">6</span>
  ↓
步骤<span class="hljs-number">2</span>: 删除 ← Bug开始！
  <span class="hljs-keyword">if</span> (<span class="hljs-number">6</span> != <span class="hljs-number">5</span>) → <span class="hljs-literal">true</span>
  content.delete(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
    → replace(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    → filter(<span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
    → 循环不执行 (start=<span class="hljs-number">0</span>, end=<span class="hljs-number">0</span>)
    → 返回 <span class="hljs-literal">null</span> (接受)
    → 删除成功！字符<span class="hljs-string">'6'</span>被删除
  content = <span class="hljs-string">"12345"</span>
  ↓
步骤<span class="hljs-number">3</span>: 插入
  content.insert(<span class="hljs-number">5</span>, <span class="hljs-string">"qq"</span>)
    → filter(<span class="hljs-string">"qq"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"12345"</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>)
    → 检查: <span class="hljs-string">'q'</span> 不是数字
    → 返回 <span class="hljs-string">""</span> (拒绝)
    → 插入失败
  ↓
步骤<span class="hljs-number">4</span>: 设置组合范围
  setComposingSpans(<span class="hljs-number">5</span>, <span class="hljs-number">5</span> + <span class="hljs-number">0</span>) → [<span class="hljs-number">5</span>, <span class="hljs-number">5</span>)
  ↓
结果: <span class="hljs-string">"12345"</span> ✗ (丢失了<span class="hljs-string">'6'</span>)
</code></pre>
<h4 data-id="heading-12">3.3 为什么先delete后insert？</h4>
<p><strong>设计意图</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 组合文本的替换逻辑</span>
<span class="hljs-comment">// 例如：拼音输入 "zhongguo" → 候选词 "中国"</span>

<span class="hljs-comment">// 旧组合文本: "zhongguo" (8个字符)</span>
<span class="hljs-comment">// 新组合文本: "中国" (2个字符)</span>

<span class="hljs-comment">// 如果先insert后delete：</span>
insert(<span class="hljs-string">"中国"</span>)    → <span class="hljs-string">"123456zhongguo中国"</span>
delete(<span class="hljs-number">6</span>, <span class="hljs-number">14</span>)    → <span class="hljs-string">"123456中国"</span>

<span class="hljs-comment">// 如果先delete后insert：</span>
delete(<span class="hljs-number">6</span>, <span class="hljs-number">14</span>)    → <span class="hljs-string">"123456"</span>
insert(<span class="hljs-string">"中国"</span>)   → <span class="hljs-string">"123456中国"</span>

<span class="hljs-comment">// 两种方式结果相同，但先delete后insert更高效</span>
<span class="hljs-comment">// (避免临时创建过长的字符串)</span>
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>假设了insert总是成功</li>
<li>没有考虑InputFilter拒绝的情况</li>
<li>没有回滚机制</li>
</ul>
<hr/>
<h3 data-id="heading-13">四、Span机制导致的范围异常扩展</h3>
<h4 data-id="heading-14">4.1 COMPOSING Span的作用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// BaseInputConnection.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">COMPOSING</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComposingText</span>();

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComposingText</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NoCopySpan</span> {
    <span class="hljs-comment">// 空实现，只作为标记</span>
}

<span class="hljs-comment">// 获取组合文本范围</span>
<span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getComposingSpanStart</span><span class="hljs-params">(Spannable text)</span> {
    <span class="hljs-keyword">return</span> text.getSpanStart(COMPOSING);
}

<span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getComposingSpanEnd</span><span class="hljs-params">(Spannable text)</span> {
    <span class="hljs-keyword">return</span> text.getSpanEnd(COMPOSING);
}

<span class="hljs-comment">// 设置组合文本范围</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">setComposingSpans</span><span class="hljs-params">(Spannable text, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> {
    <span class="hljs-comment">// 移除旧的COMPOSING Span</span>
    removeComposingSpans(text);

    <span class="hljs-comment">// 设置新的COMPOSING Span</span>
    text.setSpan(COMPOSING, start, end,
                 Spanned.SPAN_EXCLUSIVE_EXCLUSIVE | Spanned.SPAN_COMPOSING);
}
</code></pre>
<h4 data-id="heading-15">4.2 Span范围的动态变化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 初始状态</span>
<span class="hljs-type">SpannableStringBuilder</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpannableStringBuilder</span>(<span class="hljs-string">"123456"</span>);
<span class="hljs-comment">// 无COMPOSING Span</span>

<span class="hljs-comment">// 第1次 setComposingText("q")</span>
setComposingSpans(<span class="hljs-number">6</span>, <span class="hljs-number">6</span>)  <span class="hljs-comment">// 设置空范围Span</span>
<span class="hljs-comment">// text: "123456"</span>
<span class="hljs-comment">// Span: [6, 6) ← 空范围，但Span存在</span>

<span class="hljs-comment">// 第2次 setComposingText("qq")</span>
<span class="hljs-comment">// 1. 获取范围</span>
<span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> getComposingSpanStart() → 返回 <span class="hljs-number">5</span> ← 为什么？
<span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> getComposingSpanEnd() → 返回 <span class="hljs-number">6</span>

<span class="hljs-comment">// 2. delete(5, 6)</span>
text.delete(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
<span class="hljs-comment">// text: "12345"</span>
<span class="hljs-comment">// Span被自动调整...</span>

<span class="hljs-comment">// 3. insert("qq") 失败</span>

<span class="hljs-comment">// 4. setComposingSpans(5, 5)</span>
<span class="hljs-comment">// text: "12345"</span>
<span class="hljs-comment">// Span: [5, 5)</span>
</code></pre>
<h4 data-id="heading-16">4.3 为什么Span范围会从[6,6)变成[5,6)?</h4>
<p><strong>关键代码</strong>：setComposingSpans的实现</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setComposingSpans</span><span class="hljs-params">(Spannable text, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> {
    <span class="hljs-comment">// 获取[start, end)范围内的所有Span</span>
    <span class="hljs-keyword">final</span> Object[] sps = text.getSpans(start, end, Object.class);
    <span class="hljs-keyword">if</span> (sps != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> sps.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> sps[i];
            <span class="hljs-keyword">if</span> (o == COMPOSING) {
                text.removeSpan(o);
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">fl</span> <span class="hljs-operator">=</span> text.getSpanFlags(o);
            <span class="hljs-comment">// 关键：修改其他Span的范围和标志</span>
            <span class="hljs-keyword">if</span> ((fl &amp; (Spanned.SPAN_COMPOSING | Spanned.SPAN_POINT_MARK_MASK))
                    != (Spanned.SPAN_COMPOSING | SPAN_EXCLUSIVE_EXCLUSIVE)) {
                text.setSpan(o, start, end,
                    (fl &amp; ~SPAN_POINT_MARK_MASK)
                    | SPAN_COMPOSING | SPAN_EXCLUSIVE_EXCLUSIVE);
            }
        }
    }

    <span class="hljs-comment">// 设置新的COMPOSING Span</span>
    text.setSpan(COMPOSING, start, end,
        SPAN_EXCLUSIVE_EXCLUSIVE | SPAN_COMPOSING);
}
</code></pre>
<p><strong>问题根源</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">第<span class="hljs-number">1</span>次 <span class="hljs-built_in">setComposingSpans</span>(<span class="hljs-number">6</span>, <span class="hljs-number">6</span>):
  - 设置 COMPOSING Span [<span class="hljs-number">6</span>, <span class="hljs-number">6</span>)
  - text长度: <span class="hljs-number">6</span>
  - 期望: Span在文本末尾

第<span class="hljs-number">2</span>次 <span class="hljs-built_in">insert</span>(<span class="hljs-string">"q"</span>) 失败:
  - text长度仍是<span class="hljs-number">6</span>
  - 但 <span class="hljs-built_in">setComposingSpans</span>(<span class="hljs-number">6</span>, <span class="hljs-number">6</span> + <span class="hljs-string">"q"</span>.<span class="hljs-built_in">length</span>()) 期望长度是<span class="hljs-number">7</span>
  - Span范围计算出现偏差

第<span class="hljs-number">3</span>次 <span class="hljs-built_in">getComposingSpanStart</span>():
  - SpannableStringBuilder内部的Span位置计算
  - 由于text长度与预期不符
  - 返回了错误的起始位置 (<span class="hljs-number">5</span>而不是<span class="hljs-number">6</span>)

连锁反应:
  [<span class="hljs-number">6</span>, <span class="hljs-number">6</span>) → delete不执行 → [<span class="hljs-number">5</span>, <span class="hljs-number">6</span>) → <span class="hljs-built_in">delete</span>(<span class="hljs-number">5</span>,<span class="hljs-number">6</span>) → [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>) → <span class="hljs-built_in">delete</span>(<span class="hljs-number">4</span>,<span class="hljs-number">5</span>) → ...
  范围逐渐向前扩展，吞噬更多字符！
</code></pre>
<h4 data-id="heading-17">4.4 Span范围扩展的可视化</h4>
<pre><code class="hljs language-sql" lang="sql">文本:     "123456"
索引:      <span class="hljs-number">012345</span>

第<span class="hljs-number">1</span>次操作后:
  text:  "123456"
  Span:  [<span class="hljs-number">6</span>, <span class="hljs-number">6</span>)  ← 空范围，在<span class="hljs-string">'6'</span>之后

第<span class="hljs-number">2</span>次操作:
  <span class="hljs-number">1.</span> 获取范围: [<span class="hljs-number">5</span>, <span class="hljs-number">6</span>) ← 异常！为什么变了？
  <span class="hljs-number">2.</span> <span class="hljs-keyword">delete</span>(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>): "12345" ← 删除<span class="hljs-string">'6'</span>
  <span class="hljs-number">3.</span> <span class="hljs-keyword">insert</span>失败
  <span class="hljs-number">4.</span> 设置Span: [<span class="hljs-number">5</span>, <span class="hljs-number">5</span>) ← 在<span class="hljs-string">'5'</span>之后

第<span class="hljs-number">3</span>次操作:
  <span class="hljs-number">1.</span> 获取范围: [<span class="hljs-number">3</span>, <span class="hljs-number">5</span>) ← 继续扩展
  <span class="hljs-number">2.</span> <span class="hljs-keyword">delete</span>(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>): "123" ← 删除<span class="hljs-string">'4'</span>和<span class="hljs-string">'5'</span>
  <span class="hljs-number">3.</span> <span class="hljs-keyword">insert</span>失败
  <span class="hljs-number">4.</span> 设置Span: [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>)

第<span class="hljs-number">4</span>次操作:
  <span class="hljs-number">1.</span> 获取范围: [<span class="hljs-number">0</span>, <span class="hljs-number">3</span>)
  <span class="hljs-number">2.</span> <span class="hljs-keyword">delete</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>): "" ← 删除全部
</code></pre>
<p><strong>底层原因</strong>：SpannableStringBuilder的Span位置计算依赖文本长度，当实际长度与预期不符时，Span的<code>start/end</code>会被错误地调整。</p>
<hr/>
<h3 data-id="heading-18">五、设计缺陷的层次分析</h3>
<h4 data-id="heading-19">5.1 接口层：filter()无法区分操作类型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 当前接口</span>
CharSequence <span class="hljs-title function_">filter</span><span class="hljs-params">(CharSequence source, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end,
                   Spanned dest, <span class="hljs-type">int</span> dstart, <span class="hljs-type">int</span> dend)</span>;
</code></pre>
<p><strong>缺陷</strong>：</p>
<ul>
<li>只看到<code>source</code>（要插入的内容）</li>
<li>看不到操作类型（insert? delete? replace?）</li>
<li>看不到操作来源（用户? 输入法? 系统?）</li>
<li>无法区分"插入空字符串"和"删除操作"</li>
</ul>
<p><strong>理想接口</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">OperationType</span> { INSERT, DELETE, REPLACE }
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">OperationSource</span> { USER_KEY, IME, SYSTEM }

CharSequence <span class="hljs-title function_">filter</span><span class="hljs-params">(CharSequence source, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end,
                   Spanned dest, <span class="hljs-type">int</span> dstart, <span class="hljs-type">int</span> dend,
                   OperationType type,     // 操作类型
                   OperationSource source)</span>; <span class="hljs-comment">// 操作来源</span>
</code></pre>
<h4 data-id="heading-20">5.2 实现层：replaceText()缺乏原子性</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 当前实现（有缺陷）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">replaceText</span><span class="hljs-params">(CharSequence text, ...)</span> {
    <span class="hljs-keyword">if</span> (b != a) {
        content.delete(a, b); <span class="hljs-comment">// 可能删除合法内容</span>
    }
    <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span>) {
        content.insert(a, text); <span class="hljs-comment">// 可能被过滤</span>
    }
    <span class="hljs-comment">// 没有回滚机制！</span>
}
</code></pre>
<p><strong>改进方向1</strong>：先验证</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">replaceText</span><span class="hljs-params">(CharSequence text, ...)</span> {
    <span class="hljs-comment">// 先检查新文本是否合法</span>
    <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span>) {
        <span class="hljs-type">CharSequence</span> <span class="hljs-variable">filtered</span> <span class="hljs-operator">=</span> applyFilters(text, a, a);
        <span class="hljs-keyword">if</span> (filtered.length() == <span class="hljs-number">0</span> &amp;&amp; text.length() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 新文本被完全过滤，放弃替换</span>
            <span class="hljs-keyword">return</span>;
        }
        text = filtered; <span class="hljs-comment">// 使用过滤后的内容</span>
    }

    <span class="hljs-comment">// 再执行替换</span>
    <span class="hljs-keyword">if</span> (b != a) {
        content.delete(a, b);
    }
    <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span>) {
        content.insert(a, text);
    }
}
</code></pre>
<p><strong>改进方向2</strong>：使用原子replace</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不要分开delete和insert，使用Editable.replace()</span>
content.replace(a, b, text);
<span class="hljs-comment">// replace()内部一次性调用filter</span>
<span class="hljs-comment">// filter可以同时看到删除范围[a,b)和插入内容text</span>
</code></pre>
<h4 data-id="heading-21">5.3 协议层：Span范围不可靠</h4>
<p><strong>当前机制</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">setComposingSpans</span>(start, end)
  → 假设文本长度会变为start + text<span class="hljs-selector-class">.length</span>()
  → 实际: insert失败，长度不变
  → Span范围与实际不符
  → 下次getComposingSpanStart/<span class="hljs-built_in">End</span>()返回错误值
</code></pre>
<p><strong>改进方向</strong>：引入版本号</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ComposingState</span> {
    <span class="hljs-type">int</span> start;
    <span class="hljs-type">int</span> end;
    <span class="hljs-type">int</span> textVersion; <span class="hljs-comment">// 文本版本号</span>

    <span class="hljs-comment">// 每次文本操作增加版本号</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        textVersion++;
    }

    <span class="hljs-comment">// 验证Span范围是否仍有效</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">(<span class="hljs-type">int</span> currentVersion)</span> {
        <span class="hljs-keyword">return</span> textVersion == currentVersion;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-22">六、对比：正常场景 vs Bug场景</h3>
<h4 data-id="heading-23">6.1 正常场景：用户主动删除</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 用户按删除键</span>
onKeyDown(KeyEvent.KEYCODE_DEL)
  ↓
BaseInputConnection.deleteSurroundingText(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>)
  ↓
Editable.delete(cursorPos - <span class="hljs-number">1</span>, cursorPos)
  ↓
replace(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
  ↓
filter(<span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
  ↓
返回 <span class="hljs-literal">null</span> (接受)
  ↓
删除成功 ✓
</code></pre>
<p><strong>这种情况下，delete应该被允许</strong>（用户主动操作）。</p>
<h4 data-id="heading-24">6.2 Bug场景：输入法自动替换</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 输入法调用 setComposingText("qq", 1)</span>
BaseInputConnection.setComposingText(<span class="hljs-string">"qq"</span>, <span class="hljs-number">1</span>)
  ↓
replaceText(<span class="hljs-string">"qq"</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>)
  ↓
delete(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>) + insert(<span class="hljs-string">"qq"</span>)
  ↓
delete成功 + insert失败
  ↓
数据丢失 ✗
</code></pre>
<p><strong>这种情况下，delete是"替换的一部分"，应该与insert保持一致</strong>。</p>
<h4 data-id="heading-25">6.3 核心差异</h4>






























<table><thead><tr><th>维度</th><th>用户删除</th><th>输入法替换</th></tr></thead><tbody><tr><td><strong>操作意图</strong></td><td>删除内容</td><td>替换内容（delete+insert）</td></tr><tr><td><strong>原子性</strong></td><td>单个操作</td><td>组合操作</td></tr><tr><td><strong>是否应拦截</strong></td><td>否（尊重用户）</td><td>是（保持一致性）</td></tr><tr><td><strong>实际行为</strong></td><td>delete通过 ✓</td><td>delete通过，insert被拒 ✗</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-26">七、总结：设计的不对称性</h3>
<h4 data-id="heading-27">7.1 核心矛盾</h4>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────┐
│         文本编辑框架的不对称性                    │
├─────────────────────────────────────────────────┤
│                                                 │
│  InputFilter 的期望:                            │
│    控制所有文本操作                              │
│                                                 │
│  Editable 的实现:                               │
│    <span class="hljs-keyword">insert</span>() → 经过<span class="hljs-keyword">filter</span> ✓                     │
│    <span class="hljs-keyword">delete</span>() → 绕过<span class="hljs-keyword">filter</span> ✗                     │
│                                                 │
│  replaceText() 的假设:                          │
│    <span class="hljs-keyword">delete</span>() 总是成功                            │
│    <span class="hljs-keyword">insert</span>() 也总是成功                          │
│                                                 │
│  实际场景:                                       │
│    <span class="hljs-keyword">delete</span>() 成功                                │
│    <span class="hljs-keyword">insert</span>() 被InputFilter拒绝                  │
│    → 数据丢失                                   │
│                                                 │
│  Span 的副作用:                                 │
│    范围计算依赖文本长度                          │
│    <span class="hljs-keyword">insert</span>失败导致长度不符                        │
│    → 范围异常扩展                               │
│                                                 │
└─────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-28">7.2 循序渐进的知识链</h4>
<p><strong>第一篇</strong>：Binder通信机制</p>
<ul>
<li>✓ 理解了输入法→应用的跨进程调用</li>
<li>✓ 理解了异步执行导致的信息不对称</li>
<li>→ setComposingText("qq")被传递到应用进程</li>
</ul>
<p><strong>第二篇（本文）</strong>：文本编辑设计缺陷</p>
<ul>
<li>✓ 理解了replaceText()的先delete后insert</li>
<li>✓ 理解了delete绕过InputFilter的机制</li>
<li>✓ 理解了Span范围异常扩展的原因</li>
<li>→ 理解了为什么数字会被删除</li>
</ul>
<p><strong>第三篇预告</strong>：工程解决方案</p>
<ul>
<li>如何在InputConnection层拦截非法组合文本？</li>
<li>完整的解决方案（保留数字键盘）</li>
<li>三种方案对比与最佳实践</li>
<li>→ 从理论到实践</li>
</ul>
<hr/>
<h3 data-id="heading-29">参考资料</h3>
<ol>
<li>Android源码：<code>frameworks/base/core/java/android/text/SpannableStringBuilder.java</code></li>
<li>Android源码：<code>frameworks/base/core/java/android/view/inputmethod/BaseInputConnection.java</code></li>
<li>Android源码：<code>frameworks/base/core/java/android/text/method/DigitsKeyListener.java</code></li>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Ftext%2FInputFilter" target="_blank" title="https://developer.android.com/reference/android/text/InputFilter" ref="nofollow noopener noreferrer">InputFilter</a></li>
</ol>
<hr/>
<p><strong>下一篇</strong>：《InputConnection机制与跨进程文本操作的工程实践》- 完整的解决方案，既保留数字键盘，又避免数据丢失</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Agent】生成式隐式记忆 MemGen 源码解读]]></title>    <link>https://juejin.cn/post/7570940025580486696</link>    <guid>https://juejin.cn/post/7570940025580486696</guid>    <pubDate>2025-11-10T11:58:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570940025580486696" data-draft-id="7569864390942425139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Agent】生成式隐式记忆 MemGen 源码解读"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2025-11-10T11:58:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Agent】生成式隐式记忆 MemGen 源码解读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T11:58:10.000Z" title="Mon Nov 10 2025 11:58:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Agent】生成式隐式记忆 MemGen 源码解读</h2>
<p>[toc]</p>
<h3 data-id="heading-1">0x00 概要</h3>
<p>MemGen旨在构建一个动态、生成式的记忆框架，其核心由两个协同工作的轻量级模块构成：一个基于强化学习（RL）训练的记忆触发器（Memory Trigger）和一个记忆编织器（Memory Weaver）。</p>
<p>论文：MemGen: Weaving Generative Latent Memory for Self-Evolving Agents</p>
<p>链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2509.24704" target="_blank" title="https://arxiv.org/abs/2509.24704" ref="nofollow noopener noreferrer">arxiv.org/abs/2509.24…</a></p>
<p>代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FKANABOON1%2FMemGen" target="_blank" title="https://github.com/KANABOON1/MemGen" ref="nofollow noopener noreferrer">github.com/KANABOON1/M…</a></p>
<h3 data-id="heading-2">0x01 背景</h3>
<p>MemGen 提出动态生成式记忆框架，由记忆触发器与记忆编织器两个轻量模块协同构成，旨在突破现有智能体记忆范式的局限。</p>
<p>当前主流的记忆实现路径为：</p>
<ul>
<li>参数化记忆通过微调将经验编码进模型参数，虽能深度内化知识却易引发灾难性遗忘；</li>
<li>基于检索的记忆将经验外化存储，虽规避了遗忘问题，但静态的一次性检索机制无法体现记忆与推理动态交互的认知特性。</li>
</ul>
<p>这一现状引出两大核心问题：如何实现记忆与推理在每一步思考中的无缝耦合，以及如何让记忆从提取式升级为满足当前需求的生成式重构，而动态生成式隐式记忆正是应对这些挑战的第三种探索路径。</p>
<h3 data-id="heading-3">0x02 源码解析</h3>
<p>MemGen项目旨在创建一个动态且自生成的记忆框架，该框架由两个协同工作的轻量级模块组成：一个基于强化学习训练的记忆触发器和一个记忆编织器。这一框架的核心思想是解决大型语言模型（LLM）智能体能力涌现时对“自进化”机制的探索需求，其中记忆扮演关键角色。</p>
<h4 data-id="heading-4">2.1 模型</h4>
<p>LatentMemoryModel 是 MemGen 框架的核心实现，旨在构建动态生成式隐式记忆系统，解决传统记忆范式的局限性。通过整合推理器（Reasoner）、记忆编织器（Weaver）和记忆触发器（Trigger），实现记忆与推理过程的无缝耦合，让智能体在任务执行中动态生成、使用记忆，而非依赖静态检索或参数化存储。</p>
<h5 data-id="heading-5">2.1.1  核心特色</h5>
<p>模型的核心特色如下：</p>
<ul>
<li><strong>模块化协同设计</strong>：由推理器（核心推理）、编织器（生成潜在记忆）、触发器（控制记忆触发）三大模块构成，模块间通过投影层实现嵌入空间映射，结构清晰且解耦。</li>
<li><strong>动态记忆增强</strong>：在推理过程中自动识别分隔符位置作为记忆增强点，动态插入编织器生成的潜在记忆，突破静态记忆注入的局限，贴合人类认知中记忆与推理的动态交互特性。</li>
<li><strong>精度与效率优化</strong>：默认使用 bfloat16 精度，推理器采用 Flash Attention 2 提升计算效率；冻结推理器参数，仅训练编织器和触发器，实现参数高效学习。</li>
<li><strong>灵活配置与兼容性</strong>：支持自定义触发器模型、PEFT 微调配置、记忆增强次数等参数；自动处理 Tokenizer 缺失 pad token 的问题，标准化对话模板，提升跨场景兼容性。</li>
<li><strong>损失计算精准过滤</strong>：通过潜在记忆掩码排除记忆嵌入对应的位置，仅对原始输入位置计算损失，确保训练目标聚焦于核心任务性能，避免记忆生成过程干扰主任务学习。</li>
</ul>
<h5 data-id="heading-6">2.1.2  网络结构</h5>
<p>关键说明（核心设计亮点）</p>
<ol>
<li><strong>三大模块协同逻辑</strong>：
<ul>
<li>推理器（Reasoner）：核心推理组件，权重冻结以保留基础能力，仅通过潜在记忆调整解码路径。</li>
<li>触发器（MemGenTrigger）：动态判断记忆插入时机，输出二分类触发概率，决定是否调用编织器。</li>
<li>编织器（MemGenWeaver）：生成针对性潜在记忆，分提示词 / 推理两阶段设计，支持 PEFT 高效微调。</li>
</ul>
</li>
<li><strong>核心流程闭环</strong>：输入 → 推理器生成原始嵌入 → 触发器 + 增强点选择模块确定插入位置 → 编织器生成潜在记忆 → 投影层适配维度 → 重组增强序列 → 推理器完成最终推理 → 过滤无效位置输出。</li>
<li><strong>关键技术细节</strong>：
<ul>
<li>跨模块投影：通过 <code>reasoner_to_weaver</code> 和 <code>weaver_to_reasoner</code> 解决推理器与编织器嵌入维度不匹配问题。</li>
<li>动态记忆增强：按分隔符拆分序列，逐段插入记忆，避免长序列冗余，贴合人类 “思考 - 记忆” 交互模式。</li>
<li>精度与效率：全流程采用 bfloat16 精度，推理器 / 编织器启用 Flash Attention 2，平衡性能与速度。</li>
</ul>
</li>
<li><strong>训练与推理适配</strong>：
<ul>
<li>训练时：通过 <code>labels</code> 和 <code>valid_logits</code> 计算损失，仅优化编织器、触发器及投影层参数。</li>
<li>推理时：无需 <code>labels</code>，自动完成 “触发判断 - 记忆生成 - 推理增强” 全流程，实现动态自进化。</li>
</ul>
</li>
</ol>
<p>具体网络结构如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fedf1bee4f404d00b60b5ade066b5dd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763380690&amp;x-signature=udJwW4ZcYOdkSaA%2FuS5q7k6%2FUAc%3D" alt="MemGen-1.png" loading="lazy"/></p>
<h5 data-id="heading-7">2.1.3 代码</h5>
<p>LatentMemoryModel 的代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@registry.register_model(<span class="hljs-params"><span class="hljs-string">"latmem"</span></span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LatentMemoryModel</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):  <span class="hljs-comment"># 定义了一个名为 LatentMemoryModel 的类，继承自 BaseModel</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self, 
        reasoner_model_name: <span class="hljs-built_in">str</span>,  <span class="hljs-comment"># 推理模型名称</span>
        weaver_model_name: <span class="hljs-built_in">str</span>,  <span class="hljs-comment"># 记忆编织器模型名称</span>
        prompt_latents_len: <span class="hljs-built_in">int</span>,  <span class="hljs-comment"># 提示长度</span>
        inference_latents_len: <span class="hljs-built_in">int</span>,  <span class="hljs-comment"># 推理长度</span>
        weaver_peft_config: <span class="hljs-type">Optional</span>[PeftConfig] = <span class="hljs-literal">None</span>,  <span class="hljs-comment"># 记忆编织器配置，可选</span>
        trigger_model_name: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span>,  <span class="hljs-comment"># 触发模型名称，可选</span>
        trigger_peft_config: <span class="hljs-type">Optional</span>[PeftConfig] = <span class="hljs-literal">None</span>,  <span class="hljs-comment"># 触发器配置，可选</span>
        max_prompt_aug_num: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span>,  <span class="hljs-comment"># 最大提示增强数量</span>
        max_inference_aug_num: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span>,  <span class="hljs-comment"># 最大推理增强数量</span>
    </span>):   
        <span class="hljs-built_in">super</span>().__init__()  <span class="hljs-comment"># 调用父类构造函数</span>

        <span class="hljs-comment"># 构建推理模型</span>
        self.model = AutoModelForCausalLM.from_pretrained(  <span class="hljs-comment"># 从预训练模型加载推理模型</span>
            reasoner_model_name, torch_dtype=torch.bfloat16, attn_implementation=<span class="hljs-string">"flash_attention_2"</span>)
        self.tokenizer = AutoTokenizer.from_pretrained(reasoner_model_name)  <span class="hljs-comment"># 加载入分词器</span>
        self.config = self.model.config  <span class="hljs-comment"># 获取模型配置</span>
        
        <span class="hljs-comment"># 构建记忆编织器</span>
        self.weaver = MemGenWeaver(  <span class="hljs-comment"># 初始化记忆编织器</span>
            weaver_model_name, prompt_latents_len, inference_latents_len, weaver_peft_config
        )
        
        <span class="hljs-comment"># 构建触发器</span>
        self.trigger = NanoTrigger()  <span class="hljs-comment"># 默认触发器，始终返回 true</span>
        <span class="hljs-keyword">if</span> trigger_model_name <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            self.trigger = MemGenTrigger(  <span class="hljs-comment"># 如果指定了触发模型，则加载相应的触发器</span>
                trigger_model_name, trigger_peft_config
            )
            logging.info(<span class="hljs-string">f"Use Trigger: <span class="hljs-subst">{trigger_model_name}</span>"</span>)  <span class="hljs-comment"># 记录日志</span>
        
        <span class="hljs-comment"># 投影层，用于在推理模型和记忆编织器之间映射嵌入</span>
        <span class="hljs-comment"># 将推理模型输入嵌入映射到记忆编织器输入嵌入</span>
        self.reasoner_to_weaver = nn.Linear(  <span class="hljs-comment"># 线性层，从推理模型隐藏层到记忆编织器隐藏层</span>
            self.model.config.hidden_size, self.weaver.config.hidden_size, dtype=torch.bfloat16
        )
        <span class="hljs-comment"># 将记忆编织器隐藏状态映射回推理模型输入嵌入</span>
        self.weaver_to_reasoner = nn.Linear(  <span class="hljs-comment"># 线性层，从记忆编织器隐藏层到推理模型隐藏层</span>
            self.weaver.config.hidden_size, self.model.config.hidden_size, dtype=torch.bfloat16
        )
        
        self.delimiters: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = [<span class="hljs-string">","</span>, <span class="hljs-string">"."</span>, <span class="hljs-string">"\n"</span>]  <span class="hljs-comment"># 用于检测增强点的分隔符</span>
        self.max_prompt_aug_num = max_prompt_aug_num  <span class="hljs-comment"># 提示后提示中插入潜在数量</span>
        self.max_inference_aug_num = max_inference_aug_num  <span class="hljs-comment"># 指定分隔符后插入潜在数量</span>

        <span class="hljs-comment"># 后处理</span>
        self._postprocess_models()  <span class="hljs-comment"># 后处理模型</span>

        self.warnings_issued = {}  <span class="hljs-comment"># 存储发出的警告</span>
        self.model_tags = <span class="hljs-literal">None</span>  <span class="hljs-comment"># 存储模型标签</span>
        log_trainable_params(self)  <span class="hljs-comment"># 记录可训练参数</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_model_tags</span>(<span class="hljs-params">self, tags: <span class="hljs-type">Union</span>[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], <span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-literal">None</span>:  <span class="hljs-comment"># 添加模型标签</span>
        <span class="hljs-string">r"""
        向模型添加自定义标签，这些标签将被推送到 Hugging Face Hub。不会覆盖模型中现有的标签。

        参数：
            tags (`Union[list[str], str]`)：
                要添加到模型的标签

        例子：

        ```python
        from transformers import AutoModel

        model = AutoModel.from_pretrained("google-bert/bert-base-cased")

        model.add_model_tags(["custom", "custom-bert"])

        # 将模型推送到您的命名空间，名称为 "my-custom-bert"。
        model.push_to_hub("my-custom-bert")
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(tags, <span class="hljs-built_in">str</span>):
            tags = [tags]

        <span class="hljs-keyword">if</span> self.model_tags <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.model_tags = []

        <span class="hljs-keyword">for</span> tag <span class="hljs-keyword">in</span> tags:
            <span class="hljs-keyword">if</span> tag <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.model_tags:
                self.model_tags.append(tag)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_postprocess_models</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""
        后处理记忆模型的组件：推理模型、记忆编织器、触发器和分词器。

        步骤：
            1. 冻结推理模型的所有参数（不更新梯度）。
            2. 将所有模型转换为 bfloat16 以提高内存和计算效率。
            3. 确保分词器有一个有效的填充符：
                - 如果缺少填充符，使用 EOS 符作为填充符。
                - 设置 `padding_side` 为 "left" 以兼容生成任务。
            4. 标准化分词器的模板为 `CONVERSATION_TEMPLATE`。
        """</span>
        <span class="hljs-comment"># 默认冻结推理模型的所有参数</span>
        fix_model_parameters(self.model)

        <span class="hljs-comment"># 将所有子模型转换为 bfloat16</span>
        self.model = self.model.bfloat16()
        self.weaver = self.weaver.bfloat16()
        self.trigger = self.trigger.bfloat16()

        <span class="hljs-comment"># 确保分词器有一个填充符</span>
        <span class="hljs-keyword">if</span> self.tokenizer.pad_token <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.tokenizer.pad_token = self.tokenizer.eos_token
            self.tokenizer.pad_token_id = self.tokenizer.eos_token_id
            self.tokenizer.padding_side = <span class="hljs-string">"left"</span>
            logging.info(
                <span class="hljs-string">f"Tokenizer has no pad token. Using EOS token (<span class="hljs-subst">{self.tokenizer.eos_token}</span>) as pad token."</span>
            )

        <span class="hljs-comment"># 标准化分词器的模板</span>
        self.tokenizer.chat_template = CONVERSATION_TEMPLATE
</code></pre>
<h5 data-id="heading-8">2.1.4 插入阶段</h5>
<p>LatentMemoryModel 的两个关键函数 forward 和  generate 区别如下：</p>
<ul>
<li>forward 函数
<ul>
<li>训练时候计算损失，由训练循环自动调用。</li>
</ul>
</li>
<li>generate 函数
<ul>
<li>推理时候生成文本，由代码显式调用。</li>
</ul>
</li>
</ul>
<h6 data-id="heading-9">forward</h6>
<p>forward 函数的主体如下：</p>
<pre><code class="hljs language-python" lang="python">    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_forward</span>(<span class="hljs-params">
        self, 
        input_ids: torch.Tensor,
        attention_mask: torch.Tensor,
        labels: torch.Tensor,   
        **kwargs
    </span>) -&gt; torch.Tensor:
        <span class="hljs-comment"># 预处理输入</span>
        <span class="hljs-keyword">assert</span> input_ids.shape == attention_mask.shape == labels.shape
        
        tokenizer = self.tokenizer
        reasoner = self.model
        weaver = self.weaver
        delimiters = self.delimiters
        max_augment_num = self.max_inference_aug_num  <span class="hljs-comment"># 限制推理增强点的数量以避免过度增强</span>
        device = self.device
        embeds_dtype = reasoner.get_input_embeddings().weight.dtype
        B, _ = input_ids.shape
        hidden_size = reasoner.config.hidden_size

        <span class="hljs-comment"># 选择增强索引</span>
        augmentation_indices = self._select_augment_points_after_delimiter(
            input_ids, labels, delimiters, tokenizer, max_augment_num
        )
        
        <span class="hljs-comment"># 输入嵌入</span>
        inputs_embeds = reasoner.get_input_embeddings()(input_ids)
                 
        <span class="hljs-comment"># 初始化开始索引和空张量以累积处理的段</span>
        current_start_idx = <span class="hljs-number">0</span>
        current_inputs_embeds = torch.empty(B, <span class="hljs-number">0</span>, hidden_size).to(device, dtype=embeds_dtype)
        current_attention_mask = torch.empty(B, <span class="hljs-number">0</span>).to(device, dtype=attention_mask.dtype)
        current_latents_mask = torch.empty(B, <span class="hljs-number">0</span>).to(device, dtype=torch.<span class="hljs-built_in">bool</span>)

        <span class="hljs-comment"># 遍历所选增强点</span>
        <span class="hljs-keyword">for</span> aug_idx <span class="hljs-keyword">in</span> augmentation_indices:
            <span class="hljs-comment"># 切片原始嵌入和注意力掩码</span>
            segment_inputs_embeds = inputs_embeds[:, current_start:aug_idx]
            segment_attention_mask = attention_mask[:, current_start:aug_idx]
            segment_latents_mask = torch.zeros(B, segment_inputs_embeds.size(<span class="hljs-number">1</span>).to(device, dtype=torch.<span class="hljs-built_in">bool</span>)

            <span class="hljs-comment"># 连接当前段到累积嵌入和掩码</span>
            current_inputs_embeds = torch.cat([current_inputs_embeds, segment_inputs_embeds], dim=<span class="hljs-number">1</span>)
            current_mask = torch.cat([current_mask, segment_attention_mask], dim=<span class="hljs-number">1</span>)
            current_position_ids = generate_position_ids(current_mask)
            current_latents = torch.cat([current_latents, segment_latents], dim=<span class="hljs-number">1</span>)

            <span class="hljs-comment"># 将推理模型嵌入映射到记忆编织器嵌入</span>
            weaver_inputs_embeds = self.reasoner_to_weaver(current_inputs_embeds)

            <span class="hljs-comment"># 确定此点是否为提示（增强）的结束</span>
            is_prompt_end_aug = (labels[:, aug_idx] != -<span class="hljs-number">100</span>).<span class="hljs-built_in">all</span>() <span class="hljs-keyword">and</span> (labels[:, aug_idx-<span class="hljs-number">1</span>] == -<span class="hljs-number">100</span>).<span class="hljs-built_in">all</span>().item()
            <span class="hljs-comment"># 根据类型，使用记忆编织器增强提示或推理</span>
            <span class="hljs-keyword">if</span> is_prompt_end_aug:
                weaver_hidden_states, attn_mask, pos_ids = weaver.augment_prompt(
                    weaver_inputs, current_attention_mask, current_position_ids
                )
            <span class="hljs-keyword">else</span>:
                weaver_hidden_states, attn_mask, pos_ids = weaver.augment_inference(
                    weaver_inputs, current_attention_mask, current_position_ids
                ) 

            <span class="hljs-comment"># 将记忆编织器隐藏状态映射回推理模型嵌入</span>
            latent_inputs_embeds = self.weaver_to_reasoner(weaver_hidden_states)

            <span class="hljs-comment"># 更新累积嵌入和掩码与新增强段</span>
            current_inputs_embeds = torch.cat
</code></pre>
<h6 data-id="heading-10">generate</h6>
<h6 data-id="heading-11">核心作用</h6>
<p>该 <code>generate</code> 方法是 MemGen 模型的推理核心，实现了<strong>动态记忆增强与序列生成的无缝融合</strong>。通过迭代生成新 token，每步自适应判断是否插入编织器生成的潜在记忆，让推理器在生成过程中实时利用动态记忆调整解码路径，最终输出增强后的序列（可选返回记忆增强位置掩码）。</p>
<h6 data-id="heading-12">核心特色</h6>
<ul>
<li><strong>双阶段记忆增强</strong>：先执行提示词阶段记忆增强（初始化全局记忆），再在迭代生成中动态触发推理阶段增强（补充实时记忆），适配不同生成阶段的记忆需求。</li>
<li><strong>自适应触发机制</strong>：通过 <code>_should_augment</code> 结合触发器决策，仅对需要记忆支持的序列执行增强，避免无意义的计算开销。</li>
<li><strong>维度对齐优化</strong>：非增强序列采用左填充（<code>_left_pad</code>）方式对齐增强序列维度，确保批次内所有序列格式统一，不影响批量生成效率。</li>
<li>高效推理设计：
<ul>
<li>禁用梯度计算（<code>@torch.no_grad()</code>），节省内存并加速推理；</li>
<li>启用推理器缓存（<code>use_cache=True</code>），减少重复计算；</li>
<li>仅在必要时输出隐藏状态，降低计算成本。</li>
</ul>
</li>
<li><strong>灵活配置与可解释性</strong>：支持控制最大生成 token 数、采样策略等参数；可选返回 <code>augmentation_pos</code> 掩码，标记记忆插入位置，提升模型可解释性。</li>
<li><strong>鲁棒性保障</strong>：提前终止机制（所有序列生成 EOS 或达最大增强次数时终止），避免无效迭代；重构生成配置固定关键参数，确保生成稳定性。</li>
</ul>
<h6 data-id="heading-13">推理生成流程图</h6>
<p>潜在记忆插入的完整流程：</p>
<ul>
<li>初始化阶段：对输入提示进行增强，插入初始潜在记忆。</li>
<li>生成循环：逐个生成token。</li>
<li>条件检查：在每个步骤检查是否满足插入条件。</li>
<li>决策判断：使用trigger模型决定是否插入潜在记忆。</li>
<li>潜在记忆生成：通过weaver模型生成潜在记忆表示。</li>
<li>嵌入连接：将潜在记忆嵌入连接到当前输入序列。</li>
<li>继续生成：使用增强后的序列继续生成下一个token。</li>
</ul>
<p>具体流程如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51a1177007e14bdd916d4e2ea501c2c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763380690&amp;x-signature=aylwPhRKpttlymB%2BFRIe5TqKJmg%3D" alt="MemGen-2.png" loading="lazy"/></p>
<p>代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@torch.no_grad()  </span><span class="hljs-comment"># 禁用梯度计算，适用于推理阶段，提升效率并节省内存</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">
    self, 
    input_ids: torch.Tensor,  <span class="hljs-comment"># 输入token ID序列，形状[batch_size, prompt_len]</span>
    attention_mask: torch.Tensor,  <span class="hljs-comment"># 注意力掩码，形状与input_ids一致</span>
    generation_config: GenerationConfig = <span class="hljs-literal">None</span>,  <span class="hljs-comment"># 生成配置（如最大新token数、采样策略等）</span>
    return_augmentation_mask: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>,  <span class="hljs-comment"># 是否返回记忆增强位置掩码</span>
    **kwargs
</span>) -&gt; <span class="hljs-type">Union</span>[torch.Tensor, <span class="hljs-type">Tuple</span>[torch.Tensor, torch.Tensor]]: 
    <span class="hljs-string">"""
    执行MemGen模型的推理生成流程：动态融合潜在记忆与推理器，生成增强后的输出序列。
    
    核心逻辑：
    1. 初始化提示词阶段的记忆增强
    2. 迭代生成新token，每步判断是否触发推理阶段记忆增强
    3. 对需增强的序列插入编织器生成的潜在记忆，非增强序列左填充对齐维度
    4. 生成完成后返回结果（可选返回增强位置掩码）
    """</span>
    tokenizer = self.tokenizer
    reasoner = self.model
    weaver = self.weaver
    trigger = self.trigger
    delimiters = self.delimiters
    max_augment_num = self.max_inference_aug_num  <span class="hljs-comment"># 单序列最大推理阶段增强次数</span>
    invalid_token_id = -<span class="hljs-number">100</span>  <span class="hljs-comment"># 无效位置标记（用于增强位置掩码）</span>

    <span class="hljs-comment"># 预处理输入：转移到模型所在设备</span>
    input_ids = input_ids.to(self.device)
    attention_mask = attention_mask.to(self.device)
    <span class="hljs-comment"># 提取生成配置关键参数</span>
    max_new_tokens = generation_config.max_new_tokens  <span class="hljs-comment"># 最大生成新token数</span>
    do_sample = generation_config.do_sample  <span class="hljs-comment"># 是否启用采样生成</span>
    temperature = generation_config.temperature  <span class="hljs-comment"># 采样温度（控制随机性）</span>
    pad_token_id = tokenizer.pad_token_id  <span class="hljs-comment"># pad token ID</span>
    eos_token_id = tokenizer.eos_token_id  <span class="hljs-comment"># 结束token ID</span>
    prompt_len = input_ids.size(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 提示词长度</span>
    <span class="hljs-comment"># 重构生成配置（固定必要参数，确保生成稳定性）</span>
    generation_config = GenerationConfig(
        do_sample=do_sample,
        temperature=temperature,
        pad_token_id=pad_token_id,
        eos_token_id=eos_token_id,
        use_cache=<span class="hljs-literal">True</span>  <span class="hljs-comment"># 启用缓存加速生成</span>
    )

    <span class="hljs-comment"># 将输入token ID转换为嵌入向量</span>
    inputs_embeds = reasoner.get_input_embeddings()(input_ids)
    B, _, hidden_size = inputs_embeds.shape  <span class="hljs-comment"># B=batch_size，hidden_size=推理器隐藏层维度</span>
    device = inputs_embeds.device  <span class="hljs-comment"># 模型所在设备（CPU/GPU）</span>

    <span class="hljs-comment"># 初始化生成过程中的关键张量</span>
    current_inputs_embeds = inputs_embeds  <span class="hljs-comment"># 当前输入嵌入（含原始提示词+潜在记忆）</span>
    current_attention_mask = attention_mask  <span class="hljs-comment"># 当前注意力掩码</span>
    current_position_ids = generate_position_ids(current_attention_mask)  <span class="hljs-comment"># 当前位置ID</span>
    current_input_ids = input_ids  <span class="hljs-comment"># 当前已生成的token ID序列</span>
    
    <span class="hljs-comment"># 提示词阶段记忆增强：生成并插入提示词专用潜在记忆</span>
    weaver_inputs_embeds = self.reasoner_to_weaver(current_inputs_embeds)  <span class="hljs-comment"># 映射到编织器嵌入空间</span>
    weaver_hidden_states, attn_mask, pos_ids = weaver.augment_prompt(
        weaver_inputs_embeds, current_attention_mask, current_position_ids
    )
    latent_inputs_embeds = self.weaver_to_reasoner(weaver_hidden_states)  <span class="hljs-comment"># 映射回推理器嵌入空间</span>

    <span class="hljs-comment"># 拼接提示词与增强记忆</span>
    current_inputs_embeds = torch.cat([current_inputs_embeds, latent_inputs_embeds], dim=<span class="hljs-number">1</span>)
    current_attention_mask = torch.cat([current_attention_mask, attn_mask], dim=<span class="hljs-number">1</span>)
    current_position_ids = torch.cat([current_position_ids, pos_ids], dim=<span class="hljs-number">1</span>)

    <span class="hljs-comment"># 生成循环初始化</span>
    sentence_augment_count = torch.zeros(B, dtype=torch.<span class="hljs-built_in">int</span>, device=device)  <span class="hljs-comment"># 各序列已增强次数</span>
    augmentation_pos = torch.full((B, max_new_tokens), fill_value=invalid_token_id, device=device)  <span class="hljs-comment"># 增强位置掩码</span>
    inserted_embeds: <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[torch.Tensor]] = [[] <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(B)]  <span class="hljs-comment"># 记录插入的潜在记忆（用于后处理）</span>
    
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_new_tokens):
        <span class="hljs-comment"># 若所有序列均已生成EOS token，提前终止</span>
        <span class="hljs-keyword">if</span> (current_input_ids[:, -<span class="hljs-number">1</span>] == eos_token_id).<span class="hljs-built_in">all</span>():
            <span class="hljs-keyword">break</span>   

        <span class="hljs-comment"># 若所有序列均已达到最大增强次数，一次性生成剩余token</span>
        <span class="hljs-keyword">if</span> (sentence_augment_count &gt;= max_augment_num).<span class="hljs-built_in">all</span>():
            <span class="hljs-comment"># 调整剩余生成长度</span>
            generation_config.max_new_tokens = max_new_tokens - i
            <span class="hljs-comment"># 推理器生成剩余token</span>
            generated = reasoner.generate(
                inputs_embeds=current_inputs_embeds,
                attention_mask=current_attention_mask,
                generation_config=generation_config,
            )
            current_input_ids = torch.cat([current_input_ids, generated], dim=<span class="hljs-number">1</span>)
            <span class="hljs-keyword">break</span>

        <span class="hljs-comment"># 推理器前向传播，获取当前步输出</span>
        outputs = reasoner(
            inputs_embeds=current_inputs_embeds,
            attention_mask=current_attention_mask,
            position_ids=current_position_ids,
            output_hidden_states=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 推理阶段无需输出隐藏状态，提升效率</span>
        )
        <span class="hljs-comment"># 生成并追加一个新token，更新关键张量</span>
        current_inputs_embeds, current_attention_mask, current_position_ids, current_input_ids = self._append_one_step(
            outputs, current_inputs_embeds, current_attention_mask, current_position_ids, current_input_ids, do_sample, temperature
        )
 
        <span class="hljs-comment"># 若为最后一步生成，终止循环</span>
        <span class="hljs-keyword">if</span> i == max_new_tokens - <span class="hljs-number">1</span>:  
            <span class="hljs-keyword">break</span> 

        <span class="hljs-comment"># 判断当前批次中哪些序列需要进行推理阶段记忆增强</span>
        augment_decision = self._should_augment(
            current_input_ids, current_attention_mask, sentence_augment_count=sentence_augment_count, 
            do_sample=do_sample, temperature=temperature  
        )
        augmentation_pos[:, i + <span class="hljs-number">1</span>] = augment_decision  <span class="hljs-comment"># 记录增强位置（1=增强，0=不增强，-100=无效）</span>
        augment_indices = torch.where(augment_decision == <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]  <span class="hljs-comment"># 需增强的序列索引</span>

        <span class="hljs-comment"># 对需增强的序列执行记忆增强，非增强序列左填充对齐维度</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(augment_indices) &gt; <span class="hljs-number">0</span>:
            <span class="hljs-comment"># 递增需增强序列的增强次数计数</span>
            sentence_augment_count[augment_indices] += <span class="hljs-number">1</span>

            <span class="hljs-comment"># 提取需增强序列的嵌入、掩码和位置ID</span>
            candidate_inputs_embeds = current_inputs_embeds[augment_indices]
            candidate_attention_mask = current_attention_mask[augment_indices]
            candidate_position_ids = current_position_ids[augment_indices]
            
            <span class="hljs-comment"># 编织器生成推理阶段潜在记忆</span>
            weaver_inputs_embeds = self.reasoner_to_weaver(candidate_inputs_embeds)
            weaver_hidden_states, attn_mask, _ = weaver.augment_inference(
                weaver_inputs_embeds, candidate_attention_mask, candidate_position_ids
            )
            latent_inputs_embeds = self.weaver_to_reasoner(weaver_hidden_states)  <span class="hljs-comment"># 映射回推理器空间</span>
            
            <span class="hljs-comment"># 拼接原始嵌入与潜在记忆</span>
            candidate_inputs_embeds = torch.cat([candidate_inputs_embeds, latent_inputs_embeds], dim=<span class="hljs-number">1</span>)
            candidate_attention_mask = torch.cat([candidate_attention_mask, attn_mask], dim=<span class="hljs-number">1</span>)
            
            <span class="hljs-comment"># 构建合并张量（适配所有序列，包括增强和非增强）</span>
            new_len = candidate_inputs_embeds.size(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 增强后序列长度</span>
            merged_inputs_embeds = torch.zeros((B, new_len, hidden_size), device=device, dtype=current_inputs_embeds.dtype)
            merged_attention_mask = torch.zeros((B, new_len), device=device, dtype=current_attention_mask.dtype)
            
            <span class="hljs-comment"># 填充增强序列</span>
            merged_inputs_embeds[augment_indices] = candidate_inputs_embeds
            merged_attention_mask[augment_indices] = candidate_attention_mask
            
            <span class="hljs-comment"># 填充非增强序列（左填充对齐长度）</span>
            non_augment_indices = torch.where(augment_decision != <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(non_augment_indices) &gt; <span class="hljs-number">0</span>:
                non_aug_inputs_embeds = current_inputs_embeds[non_augment_indices]
                non_aug_attention_mask = current_attention_mask[non_augment_indices]
                non_aug_inputs_embeds, non_aug_attention_mask, _ = self._left_pad(
                    non_aug_inputs_embeds, non_aug_attention_mask, <span class="hljs-literal">None</span>, weaver.inference_latents_num
                )
                merged_inputs_embeds[non_augment_indices] = non_aug_inputs_embeds
                merged_attention_mask[non_augment_indices] = non_aug_attention_mask
            
            <span class="hljs-comment"># 更新当前关键张量</span>
            current_inputs_embeds = merged_inputs_embeds
            current_attention_mask = merged_attention_mask
            current_position_ids = generate_position_ids(current_attention_mask)  <span class="hljs-comment"># 重新生成位置ID</span>
            
            <span class="hljs-comment"># 记录插入的潜在记忆（用于后处理或可解释性分析）</span>
            <span class="hljs-keyword">for</span> idx, embed <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(augment_indices, latent_inputs_embeds):
                inserted_embeds[idx].append(embed.clone().detach().cpu())
        
        <span class="hljs-comment"># 后处理：调整增强位置掩码长度与生成结果一致</span>
        new_generated_len = current_input_ids.size(<span class="hljs-number">1</span>) - prompt_len
        augmentation_pos = augmentation_pos[:, :new_generated_len]
         
        <span class="hljs-comment"># 根据配置返回结果：仅生成序列 或 序列+增强位置掩码</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> return_augmentation_mask:
            <span class="hljs-keyword">return</span> current_input_ids
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> current_input_ids, augmentation_pos
</code></pre>
<h4 data-id="heading-14">2.2 Trigger</h4>
<h5 data-id="heading-15">2.2.1. 核心作用</h5>
<p>该模块定义了 MemGen 框架中记忆触发器的核心接口与两种具体实现，核心作用是<strong>动态决策记忆增强的时机</strong>—— 即在推理过程中判断何时插入编织器生成的潜在记忆，实现记忆与推理的动态耦合，突破传统静态记忆注入的局限。</p>
<h5 data-id="heading-16">2.2.2. 核心特色</h5>
<ul>
<li><strong>抽象接口统一规范</strong>：<code>Trigger</code>抽象基类定义了触发器的核心接口，确保后续扩展新触发器时遵循统一标准，提升代码可扩展性。</li>
<li>双实现适配不同场景：
<ul>
<li><code>NanoTrigger</code>：极简实现，始终触发记忆增强，无需训练，适用于快速测试、基线对比或无需动态控制的简单场景。</li>
<li><code>MemGenTrigger</code>：基于预训练 LLM 的智能触发器，通过二分类头适配决策任务，支持 PEFT 参数高效微调，能根据输入序列动态判断是否触发，适配复杂真实场景。</li>
</ul>
</li>
<li>高效适配与灵活扩展：
<ul>
<li>采用 bfloat16 精度和 Flash Attention 2 优化计算效率；</li>
<li>支持 PEFT 微调，在不冻结基础模型的前提下实现参数高效学习；</li>
<li>替换 LLM 原始输出头为二分类头，精准适配 "是否插入记忆" 的决策需求。</li>
</ul>
</li>
<li><strong>模块解耦设计</strong>：触发器决策独立于编织器模块，仅基于输入序列和数据分布做出判断，保证了模块间的低耦合和高内聚。</li>
</ul>
<h5 data-id="heading-17">2.2.3 网络架构</h5>
<p>网络架构图如下。</p>
<p>说明如下：</p>
<ol>
<li>模型支持PEFT参数高效微调（如LoRA），适配于Transformer Blocks层</li>
<li>整体精度采用bfloat16，平衡计算效率与数值稳定性</li>
<li>注意力计算通过Flash Attention 2优化，提升长序列处理速度</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34dd418dca1746b69160336bafae5e6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763380690&amp;x-signature=Av9etmryf2cwP7Mw6AaiNNc%2FzO4%3D" alt="MemGen-3.png" loading="lazy"/></p>
<h5 data-id="heading-18">2.2.4 代码</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Trigger</span>(torch.nn.Module, ABC):
    <span class="hljs-string">"""
    记忆触发器的抽象基类（Trigger）。
    定义了触发器的核心接口，用于决定在推理过程中何时触发记忆增强（插入潜在记忆）。
    所有具体触发器实现都需继承此类并实现forward方法。
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()  <span class="hljs-comment"># 调用父类Module的初始化方法</span>
    
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, **kwargs</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""
        抽象前向传播方法：接收输入数据，返回是否触发记忆增强的决策。
        子类必须实现此方法，定义具体的触发逻辑。
        
        Args:
            **kwargs: 可变关键字参数，包含输入序列、注意力掩码等模型所需数据
            
        Returns:
            bool: 触发决策（True表示触发记忆增强，False表示不触发）
        """</span>
        ...


<span class="hljs-keyword">class</span> <span class="hljs-title class_">NanoTrigger</span>(torch.nn.Module):
    <span class="hljs-string">"""
    极简触发器（NanoTrigger）：始终触发记忆增强的基础实现。
    无需复杂逻辑，固定返回触发决策，适用于基础测试或无需动态控制的场景。
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()  
        <span class="hljs-comment"># 注册一个缓冲区张量，用于获取模型所在设备（无实际计算意义）</span>
        self.register_buffer(<span class="hljs-string">"_device"</span>, torch.tensor(<span class="hljs-number">0.0</span>))
    
<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">device</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取模型所在设备（CPU/GPU）"""</span>
        <span class="hljs-keyword">return</span> self._device.device
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, input_ids: torch.Tensor, attention_mask: torch.Tensor, **kwargs</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-comment"># 该"极简触发器"始终预测需要插入记忆</span>
        <span class="hljs-comment"># 输出logits张量，其中插入决策（索引=1）的概率被设为1.0</span>
        <span class="hljs-comment"># 适用于批次中的每个token位置</span>
        batch_size, seq_len = input_ids.shape

        <span class="hljs-comment"># 初始化logits张量：形状为[batch_size, seq_len, 2]，2表示"不插入"（0）和"插入"（1）两类</span>
        logits = torch.zeros(batch_size, seq_len, <span class="hljs-number">2</span>, device=input_ids.device)
        logits[..., <span class="hljs-number">1</span>] = <span class="hljs-number">1.0</span>  <span class="hljs-comment"># 将所有位置的"插入"决策概率设为1.0</span>
        <span class="hljs-keyword">return</span> logits


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemGenTrigger</span>(torch.nn.Module):
    <span class="hljs-string">"""
    MemGen框架的专用触发器模块（MemGenTrigger）。
    - 输入：接收推理器模型当前解码序列的`inputs_embeds`（或input_ids）
    - 输出：生成形状为[batch_size, seq_len, 2]的logits张量，
      表示每个位置"不插入"（0）和"插入"（1）记忆的概率，用于动态决策记忆增强时机。
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self, 
        pretrained_model_name_or_path: <span class="hljs-built_in">str</span>,  <span class="hljs-comment"># 预训练模型名称或路径（用于初始化触发器LLM）</span>
        peft_config: <span class="hljs-type">Optional</span>[PeftConfig] = <span class="hljs-literal">None</span>  <span class="hljs-comment"># PEFT配置（可选，用于参数高效微调）</span>
    </span>):
        <span class="hljs-built_in">super</span>().__init__()
        
        <span class="hljs-comment"># 构建基础LLM模型（作为触发器的核心推理组件）</span>
        self.model = AutoModelForCausalLM.from_pretrained(
            pretrained_model_name_or_path, 
            torch_dtype=torch.bfloat16,  <span class="hljs-comment"># 使用bfloat16精度提升效率</span>
            attn_implementation=<span class="hljs-string">"flash_attention_2"</span>  <span class="hljs-comment"># 启用Flash Attention 2优化注意力计算</span>
        )
        self.tokenizer = AutoTokenizer.from_pretrained(pretrained_model_name_or_path)  <span class="hljs-comment"># 对应的Tokenizer</span>
        
        <span class="hljs-comment"># 对基础模型进行后处理（设置可训练、替换输出头）</span>
        self.model = self._postprocess(self.model)
        <span class="hljs-comment"># 若提供PEFT配置，应用参数高效微调</span>
        <span class="hljs-keyword">if</span> peft_config <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            self.model = get_peft_model(self.model, peft_config)
        
        self.config = self.model.config  <span class="hljs-comment"># 保存模型配置</span>

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">device</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取模型所在设备（CPU/GPU）"""</span>
        <span class="hljs-keyword">return</span> self.model.device
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_postprocess</span>(<span class="hljs-params">self, model: PreTrainedModel</span>):
        <span class="hljs-string">"""
        对基础模型进行后处理，适配触发器的二分类任务需求。
        
        Args:
            model: 原始预训练LLM模型
            
        Returns:
            处理后的模型（可训练、替换为二分类输出头）
        """</span>
        <span class="hljs-comment"># 设置所有模型参数为可训练</span>
        <span class="hljs-keyword">for</span> parameter <span class="hljs-keyword">in</span> model.parameters():
            parameter.requires_grad = <span class="hljs-literal">True</span>
        
        <span class="hljs-comment"># 将原始语言模型的输出头（lm_head）替换为二分类头</span>
        hidden_size = model.config.hidden_size  <span class="hljs-comment"># 模型隐藏层维度</span>
        classification_head = nn.Linear(hidden_size, <span class="hljs-number">2</span>)  <span class="hljs-comment"># 输出维度为2（不插入/插入）</span>
        model.lm_head = classification_head
        
        <span class="hljs-comment"># 确保新的二分类头参数可训练</span>
        <span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> model.lm_head.parameters():
            param.requires_grad = <span class="hljs-literal">True</span>

        <span class="hljs-keyword">return</span> model

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">
        self, 
        input_ids: <span class="hljs-type">Optional</span>[torch.LongTensor] = <span class="hljs-literal">None</span>,  <span class="hljs-comment"># 生成序列的token ID，形状[batch_size, seq_len]</span>
        attention_mask: <span class="hljs-type">Optional</span>[torch.Tensor] = <span class="hljs-literal">None</span>,  <span class="hljs-comment"># 注意力掩码，避免关注填充token</span>
        **kwargs: Unpack[TransformersKwargs],  <span class="hljs-comment"># 传递给底层模型的额外参数</span>
    </span>) -&gt; torch.Tensor:
        <span class="hljs-string">"""
        序列生成的触发决策机制。
        触发器基于已生成的`input_ids`做出决策，受数据分布影响，但独立于编织器模块。

        Args:
            input_ids (Optional[torch.LongTensor]): 生成序列的token ID张量
            attention_mask (Optional[torch.Tensor]): 注意力掩码，默认None
            **kwargs: 传递给底层模型的额外关键字参数

        Returns:
            torch.Tensor: Logits张量，形状为`(batch_size, seq_len, num_classes)`
                        num_classes=2，分别对应"不插入"（索引0）和"插入"（索引1）的概率
        """</span>   
        <span class="hljs-comment"># 调用基础模型前向传播，返回二分类logits</span>
        <span class="hljs-keyword">return</span> self.model(
            input_ids=input_ids, 
            attention_mask=attention_mask, 
            **kwargs
        ).logits
</code></pre>
<h4 data-id="heading-19">2.3  MemGenWeaver</h4>
<h5 data-id="heading-20">2.3.1 核心作用</h5>
<p>MemGenWeaver 是 MemGen 框架的核心组件之一，负责生成动态潜在记忆并将其与推理器的输入序列融合，从而实现记忆与推理过程的无缝交织。它通过可学习的潜在记忆查询向量，在提示词阶段和推理阶段分别生成针对性的记忆表示，引导推理器调整解码路径，提升智能体的动态决策能力。</p>
<h5 data-id="heading-21">2.3.2 核心特色</h5>
<ul>
<li>双阶段记忆生成：区分提示词阶段（<code>augment_prompt</code>）和推理阶段（<code>augment_inference</code>），使用各自独立的可学习潜在记忆查询向量，适配不同阶段的记忆需求，增强记忆生成的针对性。</li>
<li>灵活的潜在记忆融合：通过<code>_augment</code>方法统一实现潜在记忆与输入序列的融合，包括嵌入拼接、注意力掩码扩展和位置 ID 计算，确保记忆与原始输入在语义空间和时序上的一致性。</li>
<li>高效的模型设计：
<ul>
<li>基于预训练 LLM 构建，支持 PEFT 参数高效微调，在保留基础能力的同时降低训练成本；</li>
<li>采用 bfloat16 精度和 Flash Attention 2 优化，提升计算效率和内存利用率。</li>
</ul>
</li>
<li>动态记忆编织机制：生成的潜在记忆并非静态检索结果，而是基于当前输入序列动态生成的隐藏状态，能够捕捉实时上下文信息，实现 “生成式记忆” 的核心特性。</li>
<li>模块化与可扩展性：与推理器、触发器解耦，通过标准化接口交互；潜在记忆的数量可通过参数灵活配置，适配不同任务对记忆容量的需求。</li>
</ul>
<h5 data-id="heading-22">2.3.3 网络架构</h5>
<p>网络架构图如下。</p>
<p>说明如下：</p>
<ol>
<li>
<p>核心组件：</p>
<ul>
<li>可学习潜在记忆向量：分阶段设计（P=提示词阶段数量，I=推理阶段数量），支持动态生成记忆</li>
<li>预训练LLM：作为记忆生成核心，默认启用bfloat16精度和Flash Attention 2优化</li>
<li>序列融合层：确保输入与记忆在语义、掩码、时序上的一致性</li>
</ul>
</li>
<li>
<p>核心流程：</p>
<ul>
<li>输入 → 选择对应阶段的潜在记忆 → 融合序列 → LLM生成隐藏状态 → 提取潜在记忆输出</li>
<li>支持PEFT参数高效微调（如LoRA），适配于Transformer Blocks层</li>
</ul>
</li>
<li>
<p>输出用途：</p>
<ul>
<li>生成的潜在记忆将通过投影层映射到推理器的嵌入空间，与原始输入融合以引导解码</li>
</ul>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/171332decb0c4154ba66ca9f7de013db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763380690&amp;x-signature=MkDfTVSJzZAmLMpyyKdipXchpbw%3D" alt="MemGen-4.png" loading="lazy"/></p>
<h5 data-id="heading-23">2.3.4 代码</h5>
<p>两个关键变量如下：</p>
<ul>
<li>prompt_query_latents。
<ul>
<li>作用：增强模型在处理prompt时候的表现。 在模型处理完原始提示之后会被注入到序列中，为模型提供额外的上下文信息。</li>
<li>使用场景：在 augment_prompt 方法中使用，在生成阶段的开始阶段使用一次。</li>
</ul>
</li>
<li>inference_query_latents。
<ul>
<li>作用：在生成过程中动态增强模型的推理能力。可以在生成过程中的多个点被注入，以提供实时上下文增强。</li>
<li>使用场景：在 augment_inference 方法中使用，在生成阶段中多次被使用。通常在遇到特定分隔符（逗号，句号等）后触发插入。</li>
</ul>
</li>
</ul>
<p>这两个变量都通过_augment 方法获得（获取学习到的潜在向量，并将其附加到输入嵌入中）。其流程如下：</p>
<ul>
<li>将潜在变量附加到当前输入嵌入序列的末尾。</li>
<li>更新注意力掩码和位置ID，以考虑新增的潜在向量。</li>
<li>将增强后的序列通过Weaver模型处理。</li>
<li>提供于潜在向量位置对应的隐状态作为增强表示。</li>
</ul>
<p>判断是否插入是通过函数 _should_augment 完成的。</p>
<ul>
<li>检查当前生成的文本是否是特殊字符（逗号等）</li>
<li>使用触发模型（trigger model）进一步判断是否应该增强。</li>
<li>考虑最大增强次数限制。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MemGenWeaver</span>(torch.nn.Module):
    <span class="hljs-string">"""
    MemGen模型的编织器模块（MemGenWeaver）。
    - 输入：接收接收来自推理器模型当前当前解码序列的`inputs_embeds`（输入嵌入入）
    - 输出：生成长度为K的隐藏状态序列，
这些状态将与原始`inputs_embeds`拼接，以改变推理器的解码路径
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self, 
        pretrained_model_name_or_path: <span class="hljs-built_in">str</span>,  <span class="hljs-comment"># 预训练模型的名称或路径</span>
        prompt_latents_num: <span class="hljs-built_in">int</span>,    <span class="hljs-comment"># 提示词阶段生成的潜在记忆数量</span>
        inference_latents_num: <span class="hljs-built_in">int</span>, <span class="hljs-comment"># 推理阶段生成的潜在记忆数量</span>
        peft_config: <span class="hljs-type">Optional</span>[PeftConfig] = <span class="hljs-literal">None</span>  <span class="hljs-comment"># PEFT配置（可选）</span>
    </span>):
        <span class="hljs-built_in">super</span>().__init__()
        
        <span class="hljs-comment"># 基础模型初始化</span>
        self.model = AutoModelForCausalLM.from_pretrained(
            pretrained_model_name_or_path,
            torch_dtype=torch.bfloat16,  <span class="hljs-comment"># 使用bfloat16精度以提高效率</span>
            attn_implementation=<span class="hljs-string">"flash_attention_2"</span>  <span class="hljs-comment"># 启用Flash Attentionention 2优化</span>
        )
        self.tokenizer = AutoTokenizer.from_pretrained(pretrained_model_name_or_path)  <span class="hljs-comment"># 对应的分词器</span>
        <span class="hljs-comment"># 若提供PEFT配置，则应用参数高效微调</span>
        <span class="hljs-keyword">if</span> peft_config <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            self.model = get_peft_model(self.model, peft_config)
        
        self.config = self.model.config  <span class="hljs-comment"># 保存模型配置</span>
        
        <span class="hljs-comment"># 提示词阶段的潜在记忆查询向量（可学习参数）</span>
        self.prompt_query_latents = nn.Parameter(
            torch.randn(prompt_latents_num, self.config.hidden_size),  <span class="hljs-comment"># 形状：[prompt_latents_num, hidden_size]</span>
            requires_grad=<span class="hljs-literal">True</span>  <span class="hljs-comment"># 允许反向传播更新</span>
        )

        <span class="hljs-comment"># 推理阶段的潜在记忆查询向量（可学习参数）</span>
        self.inference_query_latents = nn.Parameter(
            torch.randn(inference_latents_num, self.config.hidden_size),  <span class="hljs-comment"># 形状：[inference_latents_num, hidden_size]</span>
            requires_grad=<span class="hljs-literal">True</span>  <span class="hljs-comment"># 允许反向传播更新</span>
        )
    
<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">prompt_latents_num</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">int</span>:
        <span class="hljs-string">"""返回提示词阶段的潜在记忆数量"""</span>
        <span class="hljs-keyword">return</span> self.prompt_query_latents.size(<span class="hljs-number">0</span>)

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inference_latents_num</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">int</span>:
        <span class="hljs-string">"""返回推理阶段的潜在记忆数量"""</span>
        <span class="hljs-keyword">return</span> self.inference_query_latents.size(<span class="hljs-number">0</span>)

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">device</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""返回模型所在的设备（CPU/GPU）"""</span>
        <span class="hljs-keyword">return</span> self.model.device

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_augment</span>(<span class="hljs-params">
        self, 
        latents: torch.Tensor,                <span class="hljs-comment"># 潜在记忆查询向量，形状：[latents_num, hidden_size]</span>
        inputs_embeds: torch.Tensor,          <span class="hljs-comment"># 输入嵌入，形状：[batch_size, seq_len, hidden_size]</span>
        attention_mask: torch.Tensor,         <span class="hljs-comment"># 注意力掩码，形状：[batch_size, seq_len]</span>
        position_ids: torch.Tensor            <span class="hljs-comment"># 位置ID，形状：[batch_size, seq_len]</span>
    </span>) -&gt; <span class="hljs-type">Tuple</span>[torch.Tensor, torch.Tensor, torch.Tensor]:
        <span class="hljs-string">"""
        通用的潜在记忆增强方法：将潜在记忆与输入序列融合，生成增强后的隐藏状态。
        
        参数：
            latents: 潜在记忆查询向量
            inputs_embeds: 输入序列的嵌入表示
            attention_mask: 输入序列的注意力掩码
            position_ids: 输入序列的位置ID
        
        返回：
            三元组 (latents_hidden_states, latents_mask, latents_position_ids)
            - latents_hidden_states: 生成的潜在记忆隐藏状态，形状：[batch_size, latents_num, hidden_size]
            - latents_mask: 潜在记忆的注意力掩码，形状：[batch_size, latents_num]
            - latents_position_ids: 潜在记忆的位置ID，形状：[batch_size, latents_num]
        """</span>
        batch_size = attention_mask.shape[<span class="hljs-number">0</span>]  <span class="hljs-comment"># 获取批次大小</span>
        latents_num = latents.size(<span class="hljs-number">0</span>)         <span class="hljs-comment"># 获取潜在记忆数量</span>
        
        <span class="hljs-comment"># 扩展潜在记忆维度以匹配批次大小：[1, latents_num, hidden_size] → [batch_size, latents_num, hidden_size]</span>
        latents = latents.unsqueeze(<span class="hljs-number">0</span>).repeat(batch_size, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
        
        <span class="hljs-comment"># 将潜在记忆嵌入与输入嵌入拼接：[batch_size, seq_len + latents_num, hidden_size]</span>
        inputs_embeds = torch.cat([inputs_embeds, latents], dim=<span class="hljs-number">1</span>)

        <span class="hljs-comment"># 构建潜在记忆的注意力掩码（全为1，表示有效）并与输入掩码拼接</span>
        latents_mask = torch.ones(latents.shape[:-<span class="hljs-number">1</span>], dtype=attention_mask.dtype, device=attention_mask.device)
        attention_mask = torch.cat([attention_mask, latents_mask], dim=<span class="hljs-number">1</span>)  <span class="hljs-comment"># 形状：[batch_size, seq_len + latents_num]</span>
        
        <span class="hljs-comment"># 生成潜在记忆的位置ID（在输入序列最后位置的基础上递增）</span>
        last_position_ids = position_ids.<span class="hljs-built_in">max</span>(dim=<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]  <span class="hljs-comment"># 获取输入序列的最大位置ID</span>
        latents_relative_positions = torch.arange(latents_num, device=attention_mask.device)  <span class="hljs-comment"># 潜在记忆的相对位置</span>
        <span class="hljs-comment"># 计算绝对位置：输入序列最大位置 + 相对位置 + 1（避免重叠）</span>
        latents_position_ids = last_position_ids.unsqueeze(<span class="hljs-number">1</span>) + latents_relative_positions + <span class="hljs-number">1</span>
        <span class="hljs-comment"># 拼接位置ID：[batch_size, seq_len + latents_num]</span>
        position_ids = torch.cat([position_ids.long(), latents_position_ids.long()], dim=<span class="hljs-number">1</span>) 

        <span class="hljs-comment"># 验证拼接后的维度是否一致</span>
        <span class="hljs-keyword">assert</span> inputs_embeds.shape[:<span class="hljs-number">2</span>] == attention_mask.shape == position_ids.shape

        <span class="hljs-comment"># 模型前向传播，获取隐藏状态</span>
        outputs = self.model(
            inputs_embeds=inputs_embeds,
            attention_mask=attention_mask,
            position_ids=position_ids,  
            output_hidden_states=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 输出所有层的隐藏状态</span>
        )
        <span class="hljs-comment"># 取最后一层的隐藏状态，并提取潜在记忆部分（序列末尾的latents_num个位置）</span>
        hidden_states = outputs.hidden_states[-<span class="hljs-number">1</span>]
        latents_hidden_states = hidden_states[:, -latents_num:, :]

        <span class="hljs-keyword">return</span> latents_hidden_states, latents_mask, latents_position_ids

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">augment_prompt</span>(<span class="hljs-params">
        self, 
        inputs_embeds: torch.Tensor, 
        attention_mask: torch.Tensor, 
        position_ids: torch.Tensor
    </span>) -&gt; <span class="hljs-type">Tuple</span>[torch.Tensor, torch.Tensor, torch.Tensor]:
        <span class="hljs-string">"""
        提示词阶段的潜在记忆增强：使用提示词专用的潜在记忆查询向量。
        
        参数与返回值同_augment方法
        """</span>
        <span class="hljs-keyword">return</span> self._augment(
            latents=self.prompt_query_latents,
            inputs_embeds=inputs_embeds,
            attention_mask=attention_mask,
            position_ids=position_ids
        )


    <span class="hljs-keyword">def</span> <span class="hljs-title function_">augment_inference</span>(<span class="hljs-params">
        self, 
        inputs_embeds: torch.Tensor, 
        attention_mask: torch.Tensor, 
        position_ids: torch.Tensor
    </span>) -&gt; <span class="hljs-type">Tuple</span>[torch.Tensor, torch.Tensor, torch.Tensor]:
        <span class="hljs-string">"""
        推理阶段的潜在记忆增强：使用推理专用的潜在记忆查询向量。
        
        参数与返回值同_augment方法
        """</span>
        <span class="hljs-keyword">return</span> self._augment(
            latents=self.inference_query_latents,
            inputs_embeds=inputs_embeds,
            attention_mask=attention_mask,
            position_ids=position_ids
        )
</code></pre>
<h3 data-id="heading-24">0xFF 参考</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FpqCPoUw0p2oTsnMUj9t2mw" target="_blank" title="https://mp.weixin.qq.com/s/pqCPoUw0p2oTsnMUj9t2mw" ref="nofollow noopener noreferrer">最新成果！Agent记忆的第三种可能：生成式隐式记忆</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[InputConnection机制与跨进程文本操作的工程实践]]></title>    <link>https://juejin.cn/post/7570923924364853311</link>    <guid>https://juejin.cn/post/7570923924364853311</guid>    <pubDate>2025-11-10T13:26:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570923924364853311" data-draft-id="7571060853353824266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="InputConnection机制与跨进程文本操作的工程实践"/> <meta itemprop="keywords" content="Android,Linux"/> <meta itemprop="datePublished" content="2025-11-10T13:26:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WAsbry"/> <meta itemprop="url" content="https://juejin.cn/user/3413335797139511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            InputConnection机制与跨进程文本操作的工程实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3413335797139511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WAsbry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T13:26:16.000Z" title="Mon Nov 10 2025 13:26:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">InputConnection机制与跨进程文本操作的工程实践</h2>
<h3 data-id="heading-1">💡 本文精华</h3>
<ul>
<li><strong>承接前文</strong>：第一篇讲Binder通信，第二篇讲设计缺陷，本篇给出完整的工程解决方案</li>
<li><strong>核心需求</strong>：既保留数字键盘（inputType="number"），又避免字母输入导致数字丢失</li>
<li><strong>最佳方案</strong>：自定义InputConnection在<code>setComposingText()</code>层拦截非法字符，阻止进入delete-insert流程</li>
<li><strong>三种方案对比</strong>：InputConnection拦截（推荐⭐⭐⭐⭐⭐）、TextWatcher过滤（⭐⭐⭐）、自定义InputFilter（⭐⭐⭐⭐）</li>
<li><strong>价值</strong>：提供可直接使用的完整代码，分析方案优劣，指导工程实践</li>
</ul>
<hr/>
<h3 data-id="heading-2">一、需求分析与约束条件</h3>
<h4 data-id="heading-3">1.1 核心需求</h4>
<pre><code class="hljs language-markdown" lang="markdown">用户需求:
<span class="hljs-bullet">1.</span> 点击EditText时，弹出数字键盘（不是全键盘）
<span class="hljs-bullet">2.</span> 只允许输入数字字符
<span class="hljs-bullet">3.</span> 切换到字母键盘输入字母时，不应导致已有数字丢失

技术约束:
<span class="hljs-bullet">1.</span> 必须使用 android:inputType="number" (保证数字键盘)
<span class="hljs-bullet">2.</span> 不能修改Android框架代码
<span class="hljs-bullet">3.</span> 需要兼容主流输入法（百度、搜狗、讯飞等）
<span class="hljs-bullet">4.</span> 性能开销要小
</code></pre>
<h4 data-id="heading-4">1.2 问题回顾</h4>
<p><strong>前两篇已分析的根本原因</strong>：</p>
<pre><code class="hljs language-css" lang="css">输入法进程:
  ic.<span class="hljs-built_in">setComposingText</span>(<span class="hljs-string">"qq"</span>, <span class="hljs-number">1</span>)
  ↓ Binder IPC
应用进程:
  BaseInputConnection.<span class="hljs-built_in">replaceText</span>(<span class="hljs-string">"qq"</span>, <span class="hljs-number">1</span>, true)
  ↓
  <span class="hljs-number">1</span>. <span class="hljs-built_in">delete</span>(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>) → 成功（绕过InputFilter）
  <span class="hljs-number">2</span>. <span class="hljs-built_in">insert</span>(<span class="hljs-string">"qq"</span>) → 失败（被DigitsKeyListener拒绝）
  ↓
  结果: 数据丢失
</code></pre>
<p><strong>解决方向</strong>：</p>
<ul>
<li>在delete执行之前拦截</li>
<li>判断新文本是否合法</li>
<li>如果非法，不进入delete-insert流程</li>
</ul>
<hr/>
<h3 data-id="heading-5">二、解决方案一：InputConnection拦截（推荐⭐⭐⭐⭐⭐）</h3>
<h4 data-id="heading-6">2.1 核心思路</h4>
<pre><code class="hljs language-css" lang="css">原始流程（有Bug）:
<span class="hljs-built_in">setComposingText</span>(<span class="hljs-string">"qq"</span>)
  → <span class="hljs-built_in">replaceText</span>()
  → <span class="hljs-built_in">delete</span>(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>) ← 删除数字
  → <span class="hljs-built_in">insert</span>(<span class="hljs-string">"qq"</span>) ← 被拒绝
  → Bug!

优化后流程:
<span class="hljs-built_in">setComposingText</span>(<span class="hljs-string">"qq"</span>)
  → NumberInputConnectionWrapper.<span class="hljs-built_in">setComposingText</span>()
  → 检测到字母 <span class="hljs-string">'q'</span>
  → 调用 <span class="hljs-built_in">finishComposingText</span>() ← 直接完成组合，不执行delete-insert
  → 数字保持不变 ✓
</code></pre>
<h4 data-id="heading-7">2.2 完整实现代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecommendedNumberEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RecommendedNumberEditText</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RecommendedNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RecommendedNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {
        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> InputConnection <span class="hljs-title function_">onCreateInputConnection</span><span class="hljs-params">(EditorInfo outAttrs)</span> {
        <span class="hljs-comment">// 获取父类创建的InputConnection</span>
        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.onCreateInputConnection(outAttrs);
        <span class="hljs-keyword">if</span> (base == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-comment">// 包装成我们的自定义InputConnection</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NumberInputConnectionWrapper</span>(base, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-comment">/**
     * 自定义InputConnection包装类
     * 拦截setComposingText，检查是否包含非数字字符
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberInputConnectionWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputConnectionWrapper</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">NumberInputConnectionWrapper</span><span class="hljs-params">(InputConnection target, <span class="hljs-type">boolean</span> mutable)</span> {
            <span class="hljs-built_in">super</span>(target, mutable);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
            <span class="hljs-comment">// 关键：在执行delete-insert之前检查</span>
            <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span> &amp;&amp; containsNonDigit(text)) {
                <span class="hljs-comment">// 包含非数字字符，直接完成组合（不执行delete-insert）</span>
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.finishComposingText();
            }

            <span class="hljs-comment">// 纯数字或null，正常处理</span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
        }

        <span class="hljs-comment">/**
         * 检查CharSequence是否包含非数字字符
         */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsNonDigit</span><span class="hljs-params">(CharSequence text)</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
                <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> text.charAt(i);
                <span class="hljs-keyword">if</span> (!Character.isDigit(c)) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 发现非数字字符</span>
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 全部是数字</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-8">2.3 使用方法</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- activity_main.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">com.yourpackage.RecommendedNumberEditText</span>
    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/edit_number"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
    <span class="hljs-attr">android:hint</span>=<span class="hljs-string">"请输入数字"</span>
    <span class="hljs-attr">android:inputType</span>=<span class="hljs-string">"number"</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MainActivity.java</span>
<span class="hljs-type">RecommendedNumberEditText</span> <span class="hljs-variable">editText</span> <span class="hljs-operator">=</span> findViewById(R.id.edit_number);
<span class="hljs-comment">// 正常使用，无需额外代码</span>
</code></pre>
<h4 data-id="heading-9">2.4 方案优势</h4>

































<table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td><strong>拦截时机早</strong></td><td>在delete之前拦截，从源头解决问题</td></tr><tr><td><strong>性能最优</strong></td><td>不执行delete-insert，避免无效操作</td></tr><tr><td><strong>对输入法透明</strong></td><td>返回true，输入法认为成功，不影响正常流程</td></tr><tr><td><strong>不影响正常输入</strong></td><td>数字输入不受影响，仍走原有逻辑</td></tr><tr><td><strong>代码简洁</strong></td><td>只需重写一个方法</td></tr><tr><td><strong>数字键盘保留</strong></td><td>inputType="number"保证数字键盘弹出</td></tr></tbody></table>
<h4 data-id="heading-10">2.5 工作流程图</h4>
<pre><code class="hljs language-css" lang="css">用户操作：
  输入数字 "<span class="hljs-number">123456</span>"
  ↓
  切换到字母键盘
  ↓
  点击 '<span class="hljs-selector-tag">q</span>'

输入法进程:
  ic.<span class="hljs-built_in">setComposingText</span>(<span class="hljs-string">"q"</span>, <span class="hljs-number">1</span>)
  ↓ Binder IPC

应用进程:
  NumberInputConnectionWrapper.<span class="hljs-built_in">setComposingText</span>(<span class="hljs-string">"q"</span>, <span class="hljs-number">1</span>)
  ↓
  <span class="hljs-built_in">containsNonDigit</span>(<span class="hljs-string">"q"</span>) → true (检测到字母)
  ↓
  调用 <span class="hljs-built_in">finishComposingText</span>()
  ↓
  BaseInputConnection.<span class="hljs-built_in">finishComposingText</span>()
    - 移除COMPOSING Span
    - 不执行delete
    - 不执行insert
  ↓
  返回 true
  ↓
  内容保持 <span class="hljs-string">"123456"</span> ✓

继续点击 <span class="hljs-string">'q'</span>:
  同样流程，每次都调用 <span class="hljs-built_in">finishComposingText</span>()
  内容始终保持 <span class="hljs-string">"123456"</span> ✓
</code></pre>
<hr/>
<h3 data-id="heading-11">三、解决方案二：TextWatcher过滤（⭐⭐⭐）</h3>
<h4 data-id="heading-12">3.1 核心思路</h4>
<pre><code class="hljs">原理：
不依赖InputFilter，而是监听文本变化
在文本改变后，过滤掉非数字字符
</code></pre>
<h4 data-id="heading-13">3.2 完整实现代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleNumberEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isFiltering</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 防止递归</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleNumberEditText</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
        init();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
        init();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {
        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);
        init();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 不设置inputType为number，避免DigitsKeyListener</span>
        <span class="hljs-comment">// 但会丢失数字键盘，需要手动设置</span>
        setRawInputType(InputType.TYPE_CLASS_NUMBER);

        addTextChangedListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextWatcher</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeTextChanged</span><span class="hljs-params">(CharSequence s, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> count, <span class="hljs-type">int</span> after)</span> {
                <span class="hljs-comment">// 不需要处理</span>
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onTextChanged</span><span class="hljs-params">(CharSequence s, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> before, <span class="hljs-type">int</span> count)</span> {
                <span class="hljs-comment">// 不需要处理</span>
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterTextChanged</span><span class="hljs-params">(Editable s)</span> {
                <span class="hljs-keyword">if</span> (isFiltering) {
                    <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 避免递归</span>
                }

                <span class="hljs-comment">// 过滤掉非数字字符</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">filtered</span> <span class="hljs-operator">=</span> s.toString().replaceAll(<span class="hljs-string">"[^0-9]"</span>, <span class="hljs-string">""</span>);

                <span class="hljs-keyword">if</span> (!s.toString().equals(filtered)) {
                    isFiltering = <span class="hljs-literal">true</span>;

                    <span class="hljs-comment">// 保存光标位置</span>
                    <span class="hljs-type">int</span> <span class="hljs-variable">cursorPos</span> <span class="hljs-operator">=</span> getSelectionStart();
                    <span class="hljs-type">int</span> <span class="hljs-variable">lengthBefore</span> <span class="hljs-operator">=</span> s.length();

                    <span class="hljs-comment">// 替换为过滤后的内容</span>
                    setText(filtered);

                    <span class="hljs-comment">// 调整光标位置</span>
                    <span class="hljs-type">int</span> <span class="hljs-variable">lengthAfter</span> <span class="hljs-operator">=</span> filtered.length();
                    <span class="hljs-type">int</span> <span class="hljs-variable">diff</span> <span class="hljs-operator">=</span> lengthBefore - lengthAfter;
                    <span class="hljs-type">int</span> <span class="hljs-variable">newCursorPos</span> <span class="hljs-operator">=</span> Math.max(<span class="hljs-number">0</span>, cursorPos - diff);
                    setSelection(Math.min(newCursorPos, filtered.length()));

                    isFiltering = <span class="hljs-literal">false</span>;
                }
            }
        });
    }
}
</code></pre>
<h4 data-id="heading-14">3.3 方案优劣</h4>





























<table><thead><tr><th>维度</th><th>评价</th></tr></thead><tbody><tr><td><strong>优点</strong></td><td>实现简单，易于理解</td></tr><tr><td><strong>优点</strong></td><td>不依赖InputConnection，逻辑独立</td></tr><tr><td><strong>缺点</strong></td><td>需要额外的setText操作，性能略差</td></tr><tr><td><strong>缺点</strong></td><td>光标位置处理复杂</td></tr><tr><td><strong>缺点</strong></td><td>会触发额外的TextWatcher回调</td></tr></tbody></table>
<h4 data-id="heading-15">3.4 性能对比</h4>
<pre><code class="hljs language-css" lang="css">方案一（InputConnection拦截）:
  <span class="hljs-built_in">setComposingText</span>(<span class="hljs-string">"qq"</span>)
    → 检测到字母
    → <span class="hljs-built_in">finishComposingText</span>()
    → <span class="hljs-number">1</span>次操作

方案二（TextWatcher）:
  <span class="hljs-built_in">setComposingText</span>(<span class="hljs-string">"qq"</span>)
    → <span class="hljs-built_in">delete</span>(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>) → 删除<span class="hljs-string">'6'</span>
    → <span class="hljs-built_in">insert</span>(<span class="hljs-string">"qq"</span>) → 被拒绝
    → afterTextChanged触发
    → <span class="hljs-built_in">setText</span>(<span class="hljs-string">"123456"</span>) → 恢复
    → <span class="hljs-number">3</span>次操作

性能差距：方案二约<span class="hljs-number">3</span>倍于方案一
</code></pre>
<hr/>
<h3 data-id="heading-16">四、解决方案三：自定义InputFilter（⭐⭐⭐⭐）</h3>
<h4 data-id="heading-17">4.1 核心思路</h4>
<pre><code class="hljs language-sql" lang="sql">原理：
不仅拦截<span class="hljs-keyword">insert</span>，也拦截<span class="hljs-keyword">delete</span>
通过判断source是否为空来区分操作类型
</code></pre>
<h4 data-id="heading-18">4.2 完整实现代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeNumberEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SafeNumberEditText</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
        init();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SafeNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
        init();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SafeNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {
        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);
        init();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 设置自定义Filter，替换系统的DigitsKeyListener</span>
        setFilters(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputFilter</span>[]{<span class="hljs-keyword">new</span> <span class="hljs-title class_">SafeNumberInputFilter</span>()});
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> InputConnection <span class="hljs-title function_">onCreateInputConnection</span><span class="hljs-params">(EditorInfo outAttrs)</span> {
        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.onCreateInputConnection(outAttrs);
        <span class="hljs-keyword">if</span> (base == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-comment">// 同时使用InputConnection拦截（双重保护）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SafeInputConnectionWrapper</span>(base, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-comment">/**
     * 自定义InputFilter
     * 拦截非数字字符的插入
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeNumberInputFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InputFilter</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> CharSequence <span class="hljs-title function_">filter</span><span class="hljs-params">(CharSequence source, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end,
                                   Spanned dest, <span class="hljs-type">int</span> dstart, <span class="hljs-type">int</span> dend)</span> {
            <span class="hljs-comment">// 过滤掉非数字字符</span>
            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">filtered</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> start; i &lt; end; i++) {
                <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> source.charAt(i);
                <span class="hljs-keyword">if</span> (Character.isDigit(c)) {
                    filtered.append(c);
                }
            }

            <span class="hljs-comment">// 如果全部被过滤掉，返回空字符串</span>
            <span class="hljs-keyword">if</span> (filtered.length() == <span class="hljs-number">0</span> &amp;&amp; end &gt; start) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
            }

            <span class="hljs-comment">// 如果有字符被过滤掉，返回过滤后的内容</span>
            <span class="hljs-keyword">if</span> (filtered.length() &lt; (end - start)) {
                <span class="hljs-keyword">return</span> filtered.toString();
            }

            <span class="hljs-comment">// 全部合法，返回null（接受原始内容）</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">/**
     * InputConnection包装类
     * 作为第二层防护
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeInputConnectionWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputConnectionWrapper</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">SafeInputConnectionWrapper</span><span class="hljs-params">(InputConnection target, <span class="hljs-type">boolean</span> mutable)</span> {
            <span class="hljs-built_in">super</span>(target, mutable);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
            <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span> &amp;&amp; containsNonDigit(text)) {
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.finishComposingText();
            }
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
        }

        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsNonDigit</span><span class="hljs-params">(CharSequence text)</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
                <span class="hljs-keyword">if</span> (!Character.isDigit(text.charAt(i))) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h4 data-id="heading-19">4.3 方案特点</h4>

























<table><thead><tr><th>特点</th><th>说明</th></tr></thead><tbody><tr><td><strong>双重保护</strong></td><td>InputFilter + InputConnection两层拦截</td></tr><tr><td><strong>灵活性高</strong></td><td>可以自定义过滤规则（如允许小数点）</td></tr><tr><td><strong>兼容性好</strong></td><td>适配各种输入场景</td></tr><tr><td><strong>代码复杂</strong></td><td>需要同时实现Filter和Wrapper</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-20">五、三种方案对比与选型指南</h3>
<h4 data-id="heading-21">5.1 全面对比</h4>





















































<table><thead><tr><th>维度</th><th>方案一：InputConnection</th><th>方案二：TextWatcher</th><th>方案三：自定义Filter</th></tr></thead><tbody><tr><td><strong>实现复杂度</strong></td><td>⭐⭐ (简单)</td><td>⭐ (最简单)</td><td>⭐⭐⭐⭐ (复杂)</td></tr><tr><td><strong>性能</strong></td><td>⭐⭐⭐⭐⭐ (最优)</td><td>⭐⭐⭐ (一般)</td><td>⭐⭐⭐⭐ (好)</td></tr><tr><td><strong>拦截时机</strong></td><td>早（delete之前）</td><td>晚（文本已改变）</td><td>早（但有局限）</td></tr><tr><td><strong>数字键盘</strong></td><td>✓ 自动</td><td>✓ 手动设置</td><td>✓ 自动</td></tr><tr><td><strong>光标处理</strong></td><td>✓ 自动</td><td>✗ 需手动</td><td>✓ 自动</td></tr><tr><td><strong>代码量</strong></td><td>~40行</td><td>~60行</td><td>~80行</td></tr><tr><td><strong>推荐度</strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐</td></tr></tbody></table>
<h4 data-id="heading-22">5.2 选型建议</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">场景1: 普通数字输入框</span>
  推荐: 方案一（InputConnection拦截）
  理由: 性能最优，代码最简洁

<span class="hljs-section">场景2: 需要自定义过滤规则（如电话号码：数字 + '-'）</span>
  推荐: 方案三（自定义Filter + InputConnection）
  理由: 灵活性高，可自定义allowed字符集

<span class="hljs-section">场景3: 快速原型开发</span>
  推荐: 方案二（TextWatcher）
  理由: 最简单，快速实现

<span class="hljs-section">场景4: 高性能要求（如大量EditText）</span>
  推荐: 方案一（InputConnection拦截）
  理由: 性能开销最小

<span class="hljs-section">场景5: 复杂输入验证（如金额：数字 + 小数点，最多2位小数）</span>
  推荐: 方案三（自定义Filter）
  理由: 可以在filter()中实现复杂规则
</code></pre>
<h4 data-id="heading-23">5.3 实际项目中的使用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 示例：金额输入框（允许数字和小数点，最多2位小数）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MoneyEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> InputConnection <span class="hljs-title function_">onCreateInputConnection</span><span class="hljs-params">(EditorInfo outAttrs)</span> {
        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.onCreateInputConnection(outAttrs);
        <span class="hljs-keyword">if</span> (base == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MoneyInputConnectionWrapper</span>(base, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MoneyInputConnectionWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputConnectionWrapper</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MoneyInputConnectionWrapper</span><span class="hljs-params">(InputConnection target, <span class="hljs-type">boolean</span> mutable)</span> {
            <span class="hljs-built_in">super</span>(target, mutable);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
            <span class="hljs-comment">// 检查是否符合金额格式</span>
            <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span> &amp;&amp; !isValidMoneyInput(text)) {
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.finishComposingText();
            }
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
        }

        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidMoneyInput</span><span class="hljs-params">(CharSequence text)</span> {
            <span class="hljs-comment">// 允许：数字、小数点</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> text.toString();
            <span class="hljs-comment">// 简单验证：只包含[0-9.]</span>
            <span class="hljs-keyword">return</span> str.matches(<span class="hljs-string">"[0-9.]*"</span>);
        }
    }

    <span class="hljs-comment">// 可以配合InputFilter做更复杂的验证（如最多2位小数）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MoneyInputFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InputFilter</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> CharSequence <span class="hljs-title function_">filter</span><span class="hljs-params">(CharSequence source, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end,
                                   Spanned dest, <span class="hljs-type">int</span> dstart, <span class="hljs-type">int</span> dend)</span> {
            <span class="hljs-comment">// 组合后的完整文本</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">beforeInsert</span> <span class="hljs-operator">=</span> dest.subSequence(<span class="hljs-number">0</span>, dstart).toString();
            <span class="hljs-type">String</span> <span class="hljs-variable">afterInsert</span> <span class="hljs-operator">=</span> dest.subSequence(dend, dest.length()).toString();
            <span class="hljs-type">String</span> <span class="hljs-variable">newText</span> <span class="hljs-operator">=</span> beforeInsert + source.subSequence(start, end) + afterInsert;

            <span class="hljs-comment">// 验证：最多一个小数点</span>
            <span class="hljs-keyword">if</span> (newText.indexOf(<span class="hljs-string">'.'</span>) != newText.lastIndexOf(<span class="hljs-string">'.'</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// 拒绝（多个小数点）</span>
            }

            <span class="hljs-comment">// 验证：小数点后最多2位</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">dotIndex</span> <span class="hljs-operator">=</span> newText.indexOf(<span class="hljs-string">'.'</span>);
            <span class="hljs-keyword">if</span> (dotIndex != -<span class="hljs-number">1</span> &amp;&amp; newText.length() - dotIndex &gt; <span class="hljs-number">3</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// 拒绝（超过2位小数）</span>
            }

            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 接受</span>
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-24">六、工程实践的最佳实践</h3>
<h4 data-id="heading-25">6.1 性能监控</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoredNumberEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> InputConnection <span class="hljs-title function_">onCreateInputConnection</span><span class="hljs-params">(EditorInfo outAttrs)</span> {
        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.onCreateInputConnection(outAttrs);
        <span class="hljs-keyword">if</span> (base == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MonitoredInputConnectionWrapper</span>(base, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoredInputConnectionWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputConnectionWrapper</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MonitoredInputConnectionWrapper</span><span class="hljs-params">(InputConnection target, <span class="hljs-type">boolean</span> mutable)</span> {
            <span class="hljs-built_in">super</span>(target, mutable);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
            <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.nanoTime();

            <span class="hljs-type">boolean</span> result;
            <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span> &amp;&amp; containsNonDigit(text)) {
                result = <span class="hljs-built_in">super</span>.finishComposingText();
            } <span class="hljs-keyword">else</span> {
                result = <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
            }

            <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.nanoTime() - startTime;
            <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">1_000_000</span>) { <span class="hljs-comment">// 超过1ms</span>
                Log.w(<span class="hljs-string">"InputMonitor"</span>, <span class="hljs-string">"setComposingText slow: "</span> + duration / <span class="hljs-number">1_000_000.0</span> + <span class="hljs-string">"ms"</span>);
            }

            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsNonDigit</span><span class="hljs-params">(CharSequence text)</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
                <span class="hljs-keyword">if</span> (!Character.isDigit(text.charAt(i))) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h4 data-id="heading-26">6.2 日志调试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DebugNumberEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"DebugNumberEditText"</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> InputConnection <span class="hljs-title function_">onCreateInputConnection</span><span class="hljs-params">(EditorInfo outAttrs)</span> {
        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.onCreateInputConnection(outAttrs);
        <span class="hljs-keyword">if</span> (base == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DebugInputConnectionWrapper</span>(base, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DebugInputConnectionWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputConnectionWrapper</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">DebugInputConnectionWrapper</span><span class="hljs-params">(InputConnection target, <span class="hljs-type">boolean</span> mutable)</span> {
            <span class="hljs-built_in">super</span>(target, mutable);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
            Log.d(TAG, <span class="hljs-string">"setComposingText: text='"</span> + text + <span class="hljs-string">"', cursor="</span> + newCursorPosition);

            <span class="hljs-type">boolean</span> <span class="hljs-variable">hasNonDigit</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
                    <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> text.charAt(i);
                    <span class="hljs-keyword">if</span> (!Character.isDigit(c)) {
                        hasNonDigit = <span class="hljs-literal">true</span>;
                        Log.w(TAG, <span class="hljs-string">"  Detected non-digit: '"</span> + c + <span class="hljs-string">"' at index "</span> + i);
                    }
                }
            }

            <span class="hljs-type">boolean</span> result;
            <span class="hljs-keyword">if</span> (hasNonDigit) {
                Log.d(TAG, <span class="hljs-string">"  Action: finishComposingText() (rejecting non-digit input)"</span>);
                result = <span class="hljs-built_in">super</span>.finishComposingText();
            } <span class="hljs-keyword">else</span> {
                Log.d(TAG, <span class="hljs-string">"  Action: setComposingText() (accepting digit input)"</span>);
                result = <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
            }

            Log.d(TAG, <span class="hljs-string">"  Result: "</span> + result);
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">commitText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
            Log.d(TAG, <span class="hljs-string">"commitText: text='"</span> + text + <span class="hljs-string">"', cursor="</span> + newCursorPosition);
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.commitText(text, newCursorPosition);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">finishComposingText</span><span class="hljs-params">()</span> {
            Log.d(TAG, <span class="hljs-string">"finishComposingText"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.finishComposingText();
        }
    }
}
</code></pre>
<h4 data-id="heading-27">6.3 单元测试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(RobolectricTestRunner.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberEditTextTest</span> {

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDigitInput</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 测试正常数字输入</span>
        <span class="hljs-type">RecommendedNumberEditText</span> <span class="hljs-variable">editText</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RecommendedNumberEditText</span>(ApplicationProvider.getApplicationContext());
        editText.setText(<span class="hljs-string">"123"</span>);

        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">ic</span> <span class="hljs-operator">=</span> editText.onCreateInputConnection(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EditorInfo</span>());
        ic.setComposingText(<span class="hljs-string">"456"</span>, <span class="hljs-number">1</span>);

        assertEquals(<span class="hljs-string">"123456"</span>, editText.getText().toString());
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLetterInput</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 测试字母输入（应该被拒绝）</span>
        <span class="hljs-type">RecommendedNumberEditText</span> <span class="hljs-variable">editText</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RecommendedNumberEditText</span>(ApplicationProvider.getApplicationContext());
        editText.setText(<span class="hljs-string">"123"</span>);

        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">ic</span> <span class="hljs-operator">=</span> editText.onCreateInputConnection(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EditorInfo</span>());
        ic.setComposingText(<span class="hljs-string">"abc"</span>, <span class="hljs-number">1</span>);

        <span class="hljs-comment">// 内容不应该变化</span>
        assertEquals(<span class="hljs-string">"123"</span>, editText.getText().toString());
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMixedInput</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 测试混合输入</span>
        <span class="hljs-type">RecommendedNumberEditText</span> <span class="hljs-variable">editText</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RecommendedNumberEditText</span>(ApplicationProvider.getApplicationContext());
        editText.setText(<span class="hljs-string">"123"</span>);

        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">ic</span> <span class="hljs-operator">=</span> editText.onCreateInputConnection(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EditorInfo</span>());
        ic.setComposingText(<span class="hljs-string">"4a5"</span>, <span class="hljs-number">1</span>);

        <span class="hljs-comment">// 包含字母，应该被拒绝</span>
        assertEquals(<span class="hljs-string">"123"</span>, editText.getText().toString());
    }
}
</code></pre>
<h4 data-id="heading-28">6.4 兼容性测试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 测试不同输入法的兼容性
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IMECompatibilityTest</span> {

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testBaiduIME</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟百度输入法的行为</span>
        <span class="hljs-comment">// ...</span>
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSogouIME</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟搜狗输入法的行为</span>
        <span class="hljs-comment">// ...</span>
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGboard</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟Google Gboard的行为</span>
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-29">七、常见问题与解答</h3>
<h4 data-id="heading-30">7.1 为什么不直接去掉inputType="number"？</h4>
<p><strong>问题</strong>：去掉inputType后，不会有Bug，为什么不这样做？</p>
<p><strong>解答</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">去掉 <span class="hljs-attr">inputType</span>=<span class="hljs-string">"number"</span> 的后果:
1. 弹出全键盘（而不是数字键盘）
2. 用户体验变差（输入数字需要切换键盘）
3. 无法使用系统的数字键盘优化

保留 <span class="hljs-attr">inputType</span>=<span class="hljs-string">"number"</span> + InputConnection拦截:
1. 保留数字键盘（用户体验好）
2. 避免数据丢失（技术正确）
3. 最佳实践
</code></pre>
<h4 data-id="heading-31">7.2 为什么调用finishComposingText()？</h4>
<p><strong>问题</strong>：为什么不直接return false？</p>
<p><strong>解答</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误做法</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
    <span class="hljs-keyword">if</span> (containsNonDigit(text)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// ✗ 输入法会认为失败，可能重试或报错</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
}

<span class="hljs-comment">// 正确做法</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
    <span class="hljs-keyword">if</span> (containsNonDigit(text)) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.finishComposingText(); <span class="hljs-comment">// ✓ 告诉输入法"组合已完成"</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
}
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li><code>finishComposingText()</code> 是合法的操作，输入法会正常处理</li>
<li>返回 <code>false</code> 表示操作失败，输入法可能出现异常行为</li>
<li><code>finishComposingText()</code> 会清除COMPOSING Span，避免后续问题</li>
</ul>
<h4 data-id="heading-32">7.3 为什么不用setFilters完全替代？</h4>
<p><strong>问题</strong>：为什么不只用InputFilter，还要用InputConnection？</p>
<p><strong>解答</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">单独使用 InputFilter 的问题:
<span class="hljs-bullet">1.</span> 无法阻止delete操作（delete绕过Filter）
<span class="hljs-bullet">2.</span> 仍会触发Bug

单独使用 InputConnection 的优势:
<span class="hljs-bullet">1.</span> 拦截时机早（delete之前）
<span class="hljs-bullet">2.</span> 从源头解决问题

最佳实践:
  InputConnection拦截为主（方案一）
  或 InputFilter + InputConnection双重保护（方案三）
</code></pre>
<h4 data-id="heading-33">7.4 如何支持小数点？</h4>
<p><strong>扩展方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidNumberInput</span><span class="hljs-params">(CharSequence text)</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
        <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> text.charAt(i);
        <span class="hljs-comment">// 允许数字和小数点</span>
        <span class="hljs-keyword">if</span> (!Character.isDigit(c) &amp;&amp; c != <span class="hljs-string">'.'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
    <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span> &amp;&amp; !isValidNumberInput(text)) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.finishComposingText();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
}

<span class="hljs-comment">// 同时设置inputType</span>
setInputType(InputType.TYPE_CLASS_NUMBER | InputType.TYPE_NUMBER_FLAG_DECIMAL);
</code></pre>
<hr/>
<h3 data-id="heading-34">八、总结：从理论到实践的完整链路</h3>
<h4 data-id="heading-35">8.1 三篇文章的知识链</h4>
<pre><code class="hljs language-sql" lang="sql">第一篇：Binder通信机制
  ├─ 三进程架构
  ├─ AIDL接口定义
  ├─ Stub<span class="hljs-operator">/</span>Proxy实现
  ├─ 线程切换
  └─ 信息不对称
       ↓ 为什么输入法不知道实际结果

第二篇：文本编辑设计缺陷
  ├─ InputFilter接口局限
  ├─ <span class="hljs-keyword">delete</span>绕过<span class="hljs-keyword">Filter</span>
  ├─ replaceText先<span class="hljs-keyword">delete</span>后<span class="hljs-keyword">insert</span>
  ├─ Span范围异常扩展
  └─ 不对称的控制权
       ↓ 为什么数字会被删除

第三篇（本文）：工程解决方案
  ├─ InputConnection拦截（推荐）
  ├─ TextWatcher过滤（简单）
  ├─ 自定义InputFilter（灵活）
  ├─ 三种方案对比
  ├─ 选型指南
  ├─ 最佳实践
  └─ 完整代码
       ↓ 如何在实际项目中解决
</code></pre>
<h4 data-id="heading-36">8.2 最佳实践总结</h4>






























<table><thead><tr><th>场景</th><th>推荐方案</th><th>核心代码</th></tr></thead><tbody><tr><td><strong>普通数字输入</strong></td><td>InputConnection拦截</td><td><code>finishComposingText()</code></td></tr><tr><td><strong>自定义规则</strong></td><td>自定义Filter + IC</td><td><code>filter()</code> + <code>finishComposingText()</code></td></tr><tr><td><strong>快速开发</strong></td><td>TextWatcher</td><td><code>afterTextChanged()</code> + <code>setText()</code></td></tr><tr><td><strong>高性能</strong></td><td>InputConnection拦截</td><td>避免多余操作</td></tr></tbody></table>
<h4 data-id="heading-37">8.3 核心要点</h4>
<pre><code class="hljs language-markdown" lang="markdown">关键设计决策:
<span class="hljs-bullet">1.</span> 保留 inputType="number" （数字键盘）
<span class="hljs-bullet">2.</span> 重写 onCreateInputConnection() （拦截入口）
<span class="hljs-bullet">3.</span> 包装 InputConnectionWrapper （扩展功能）
<span class="hljs-bullet">4.</span> 拦截 setComposingText() （关键方法）
<span class="hljs-bullet">5.</span> 调用 finishComposingText() （正确处理）

为什么这样设计:
<span class="hljs-bullet">1.</span> 用户体验：数字键盘更方便
<span class="hljs-bullet">2.</span> 性能优化：拦截早，开销小
<span class="hljs-bullet">3.</span> 兼容性好：对输入法透明
<span class="hljs-bullet">4.</span> 代码简洁：只需40行代码
<span class="hljs-bullet">5.</span> 易于维护：逻辑清晰
</code></pre>
<h4 data-id="heading-38">8.4 延伸应用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 可以扩展到其他场景:</span>

<span class="hljs-comment">// 1. 手机号输入（数字 + 空格/横线）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PhoneNumberEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 2. 邮箱输入（限制特殊字符）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 3. 用户名输入（字母 + 数字 + 下划线）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UsernameEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 4. 密码输入（增强安全）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurePasswordEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-39">九、完整示例项目结构</h3>
<pre><code class="hljs language-css" lang="css">app/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/java/com/yourpackage/
├─ widget/
│  ├─ RecommendedNumberEditText<span class="hljs-selector-class">.java</span>   ← 方案一（推荐）
│  ├─ SimpleNumberEditText<span class="hljs-selector-class">.java</span>        ← 方案二
│  ├─ SafeNumberEditText<span class="hljs-selector-class">.java</span>          ← 方案三
│  ├─ MoneyEditText<span class="hljs-selector-class">.java</span>               ← 扩展：金额输入
│  ├─ PhoneNumberEditText<span class="hljs-selector-class">.java</span>         ← 扩展：电话输入
│  └─ DebugNumberEditText<span class="hljs-selector-class">.java</span>         ← 调试版本
│
├─ utils/
│  └─ InputValidationUtils<span class="hljs-selector-class">.java</span>        ← 通用验证工具
│
└─ MainActivity<span class="hljs-selector-class">.java</span>

app/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/res/layout/
└─ activity_main<span class="hljs-selector-class">.xml</span>

app/<span class="hljs-attribute">src</span>/test/java/com/yourpackage/
└─ NumberEditTextTest<span class="hljs-selector-class">.java</span>             ← 单元测试
</code></pre>
<hr/>
<h3 data-id="heading-40">参考资料</h3>
<ol>
<li>Android源码：<code>frameworks/base/core/java/android/view/inputmethod/InputConnectionWrapper.java</code></li>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fview%2Finputmethod%2FInputConnectionWrapper" target="_blank" title="https://developer.android.com/reference/android/view/inputmethod/InputConnectionWrapper" ref="nofollow noopener noreferrer">InputConnectionWrapper</a></li>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fview%2Finputmethod%2FInputConnection" target="_blank" title="https://developer.android.com/reference/android/view/inputmethod/InputConnection" ref="nofollow noopener noreferrer">InputConnection</a></li>
<li>本系列前两篇：
<ul>
<li>第一篇：《Android输入法框架的Binder通信机制剖析》</li>
<li>第二篇：《从一个Bug看Android文本编辑的设计缺陷》</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-41">附录：完整可运行的示例代码</h3>
<p><strong>RecommendedNumberEditText.java</strong>（直接复制可用）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.yourpackage.widget;

<span class="hljs-keyword">import</span> android.content.Context;
<span class="hljs-keyword">import</span> android.util.AttributeSet;
<span class="hljs-keyword">import</span> android.view.inputmethod.EditorInfo;
<span class="hljs-keyword">import</span> android.view.inputmethod.InputConnection;
<span class="hljs-keyword">import</span> android.view.inputmethod.InputConnectionWrapper;
<span class="hljs-keyword">import</span> androidx.appcompat.widget.AppCompatEditText;

<span class="hljs-comment">/**
 * 推荐的数字输入框实现
 * 解决 inputType="number" 时，切换字母键盘导致数字丢失的问题
 *
 * 使用方法:
 * &lt;com.yourpackage.widget.RecommendedNumberEditText
 *     android:inputType="number"
 *     ... /&gt;
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecommendedNumberEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RecommendedNumberEditText</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RecommendedNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RecommendedNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {
        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> InputConnection <span class="hljs-title function_">onCreateInputConnection</span><span class="hljs-params">(EditorInfo outAttrs)</span> {
        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.onCreateInputConnection(outAttrs);
        <span class="hljs-keyword">if</span> (base == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NumberInputConnectionWrapper</span>(base, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-comment">/**
     * 自定义InputConnection包装类
     * 拦截setComposingText，检查是否包含非数字字符
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberInputConnectionWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputConnectionWrapper</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">NumberInputConnectionWrapper</span><span class="hljs-params">(InputConnection target, <span class="hljs-type">boolean</span> mutable)</span> {
            <span class="hljs-built_in">super</span>(target, mutable);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
            <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span> &amp;&amp; containsNonDigit(text)) {
                <span class="hljs-comment">// 包含非数字字符，直接完成组合（不执行delete-insert）</span>
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.finishComposingText();
            }
            <span class="hljs-comment">// 纯数字或null，正常处理</span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
        }

        <span class="hljs-comment">/**
         * 检查是否包含非数字字符
         */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsNonDigit</span><span class="hljs-params">(CharSequence text)</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
                <span class="hljs-keyword">if</span> (!Character.isDigit(text.charAt(i))) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<p><strong>activity_main.xml</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>
    <span class="hljs-attr">android:padding</span>=<span class="hljs-string">"16dp"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"推荐方案（InputConnection拦截）："</span>
        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"16sp"</span>
        <span class="hljs-attr">android:textStyle</span>=<span class="hljs-string">"bold"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">com.yourpackage.widget.RecommendedNumberEditText</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/edit_recommended"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:hint</span>=<span class="hljs-string">"请输入数字"</span>
        <span class="hljs-attr">android:inputType</span>=<span class="hljs-string">"number"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"24dp"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"测试说明："</span>
        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"14sp"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"8dp"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"1. 输入数字 123456\n2. 切换到字母键盘\n3. 连续点击字母 'q'\n4. 数字不会被删除 ✓"</span>
        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"12sp"</span> /&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>
</code></pre>
<hr/>
<p><strong>系列完结</strong>。从Binder通信机制，到文本编辑设计缺陷，再到完整的工程解决方案，希望这三篇文章能帮助你深入理解Android输入法框架，并在实际项目中游刃有余地解决类似问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[FastAPI × SQLAlchemy 2.0 Async：从“能跑”到“可压测”的完整工程实践]]></title>    <link>https://juejin.cn/post/7570903763722289162</link>    <guid>https://juejin.cn/post/7570903763722289162</guid>    <pubDate>2025-11-10T15:02:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570903763722289162" data-draft-id="7570897638441238555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FastAPI × SQLAlchemy 2.0 Async：从“能跑”到“可压测”的完整工程实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-10T15:02:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java私教"/> <meta itemprop="url" content="https://juejin.cn/user/3394924618197325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FastAPI × SQLAlchemy 2.0 Async：从“能跑”到“可压测”的完整工程实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3394924618197325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java私教
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T15:02:02.000Z" title="Mon Nov 10 2025 15:02:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>一句话总结<br/>
用 <strong>SQLAlchemy 2.0 AsyncIO</strong> 模式，把 FastAPI 的并发优势兑现成 <strong>真正的数据库吞吐</strong>；再叠上连接池、事务、迁移、测试四件套，<strong>直接上线不踩坑</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">1. 为什么要“异步 ORM”？</h2>

























<table><thead><tr><th>场景</th><th>同步 SQLAlchemy</th><th>异步 SQLAlchemy</th></tr></thead><tbody><tr><td>100 个并发上传</td><td>开 100 线程 → 100 个连接 → DB 被打爆</td><td>单线程 20 连接即可跑满 CPU</td></tr><tr><td>请求等待 I/O</td><td>线程上下文切换 8 ms</td><td>协程切换 0.3 ms</td></tr><tr><td>代码风格</td><td>到处 <code>run_in_threadpool</code></td><td>原生 <code>await</code> 一路到底</td></tr></tbody></table>
<blockquote>
<p>一句话：<strong>同步模式把 FastAPI 的异步事件循环拖回解放前</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">2. 最小可运行版本（MVP）</h2>
<p><strong>安装依赖</strong></p>
<pre><code class="hljs language-bash" lang="bash">pip install <span class="hljs-string">"fastapi[all]"</span> \
            <span class="hljs-string">"sqlalchemy[asyncio]&gt;=2.0"</span> \
            asyncpg alembic pydantic[email]
</code></pre>
<blockquote>
<p>数据库以 PostgreSQL 为例，MySQL 换成 <code>asyncmy</code> 即可。</p>
</blockquote>
<p><strong>项目骨架</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">app/
 ├─ api/
 │   └─ user.py
 ├─ core/
 │   ├─ db.py
 │   └─ config.py
 ├─ models/
 │   └─ user.py
 ├─ schemas/
 │   └─ user.py
 └─ main.py
</code></pre>
<hr/>
<h2 data-id="heading-2">3. 核心代码：Session 生命周期一条龙</h2>
<p><strong>app/core/config.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseSettings

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Settings</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    database_url: <span class="hljs-built_in">str</span> = <span class="hljs-string">"postgresql+asyncpg://user:pass@localhost:5432/demo"</span>
    pool_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span>
    max_overflow: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>
    echo_sql: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>:
        env_file = <span class="hljs-string">".env"</span>

settings = Settings()
</code></pre>
<p><strong>app/core/db.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> (
    AsyncEngine, AsyncSession, async_sessionmaker, create_async_engine
)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncDatabaseSession</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span>, *, pool_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span>, max_overflow: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>, echo: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span></span>):
        self.engine: AsyncEngine = create_async_engine(
            url,
            pool_size=pool_size,
            max_overflow=max_overflow,
            echo=echo,
            pool_pre_ping=<span class="hljs-literal">True</span>,          <span class="hljs-comment"># 心跳保活</span>
        )
        self.session_factory = async_sessionmaker(
            self.engine,
            expire_on_commit=<span class="hljs-literal">False</span>,      <span class="hljs-comment"># 防止懒加载异常</span>
            class_=AsyncSession,
        )

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">close</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">await</span> self.engine.dispose()

db = AsyncDatabaseSession(
    settings.database_url,
    pool_size=settings.pool_size,
    echo=settings.echo_sql,
)
</code></pre>
<p><strong>main.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
<span class="hljs-keyword">from</span> app.core.db <span class="hljs-keyword">import</span> db
<span class="hljs-keyword">from</span> app.api <span class="hljs-keyword">import</span> user

app = FastAPI(title=<span class="hljs-string">"Async SQLAlchemy Demo"</span>)

app.include_router(user.router)

<span class="hljs-meta">@app.on_event(<span class="hljs-params"><span class="hljs-string">"startup"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">startup</span>():
    <span class="hljs-comment"># 可选：建表</span>
    <span class="hljs-comment"># from app.models import Base</span>
    <span class="hljs-comment"># async with db.engine.begin() as conn:</span>
    <span class="hljs-comment">#     await conn.run_sync(Base.metadata.create_all)</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-meta">@app.on_event(<span class="hljs-params"><span class="hljs-string">"shutdown"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">shutdown</span>():
    <span class="hljs-keyword">await</span> db.close()
</code></pre>
<hr/>
<h2 data-id="heading-3">4. 依赖注入：每次请求一个 Session，自动回滚</h2>
<p><strong>app/core/deps.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> AsyncGenerator
<span class="hljs-keyword">from</span> app.core.db <span class="hljs-keyword">import</span> db
<span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> AsyncSession
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Depends

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_session</span>() -&gt; AsyncGenerator[AsyncSession, <span class="hljs-literal">None</span>]:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> db.session_factory() <span class="hljs-keyword">as</span> session:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">yield</span> session
        <span class="hljs-keyword">except</span> Exception:
            <span class="hljs-keyword">await</span> session.rollback()
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            <span class="hljs-keyword">await</span> session.close()
</code></pre>
<blockquote>
<p>用 <code>yield</code> + <code>rollback</code> 保证<strong>请求级事务</strong>；抛异常自动回滚，正常则 commit。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">5. Model / Schema / CRUD 一条龙</h2>
<p><strong>app/models/user.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> String
<span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> DeclarativeBase, Mapped, mapped_column

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span>(<span class="hljs-title class_ inherited__">DeclarativeBase</span>):
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">Base</span>):
    __tablename__ = <span class="hljs-string">"users"</span>

    <span class="hljs-built_in">id</span>: Mapped[<span class="hljs-built_in">int</span>] = mapped_column(primary_key=<span class="hljs-literal">True</span>, index=<span class="hljs-literal">True</span>)
    email: Mapped[<span class="hljs-built_in">str</span>] = mapped_column(String(<span class="hljs-number">320</span>), unique=<span class="hljs-literal">True</span>, index=<span class="hljs-literal">True</span>)
    full_name: Mapped[<span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span>]
</code></pre>
<p><strong>app/schemas/user.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, EmailStr

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserCreate</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    email: EmailStr
    full_name: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRead</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">int</span>
    email: EmailStr
    full_name: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span>

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>:
        orm_mode = <span class="hljs-literal">True</span>
</code></pre>
<p><strong>app/api/user.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter, Depends, HTTPException
<span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> AsyncSession
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select
<span class="hljs-keyword">from</span> app.models <span class="hljs-keyword">import</span> User
<span class="hljs-keyword">from</span> app.schemas <span class="hljs-keyword">import</span> UserCreate, UserRead
<span class="hljs-keyword">from</span> app.core.deps <span class="hljs-keyword">import</span> get_session

router = APIRouter(prefix=<span class="hljs-string">"/users"</span>, tags=[<span class="hljs-string">"users"</span>])

<span class="hljs-meta">@router.post(<span class="hljs-params"><span class="hljs-string">""</span>, response_model=UserRead</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_user</span>(<span class="hljs-params">payload: UserCreate, session: AsyncSession = Depends(<span class="hljs-params">get_session</span>)</span>):
    user = User(**payload.<span class="hljs-built_in">dict</span>())
    session.add(user)
    <span class="hljs-keyword">await</span> session.flush()          <span class="hljs-comment"># 获取 id</span>
    <span class="hljs-keyword">await</span> session.commit()
    <span class="hljs-keyword">await</span> session.refresh(user)
    <span class="hljs-keyword">return</span> user

<span class="hljs-meta">@router.get(<span class="hljs-params"><span class="hljs-string">"/{uid}"</span>, response_model=UserRead</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_user</span>(<span class="hljs-params">uid: <span class="hljs-built_in">int</span>, session: AsyncSession = Depends(<span class="hljs-params">get_session</span>)</span>):
    user = <span class="hljs-keyword">await</span> session.get(User, uid)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:
        <span class="hljs-keyword">raise</span> HTTPException(<span class="hljs-number">404</span>, <span class="hljs-string">"User not found"</span>)
    <span class="hljs-keyword">return</span> user
</code></pre>
<hr/>
<h2 data-id="heading-5">6. 迁移：Alembic 同样能异步</h2>
<p><strong>初始化</strong></p>
<pre><code class="hljs language-bash" lang="bash">alembic init -t async migrations
</code></pre>
<p><strong>修改 <code>alembic.ini</code> 中的 <code>sqlalchemy.url</code> 为 <code>postgresql+asyncpg://...</code></strong></p>
<p><strong>migrations/env.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> app.core.config <span class="hljs-keyword">import</span> settings
<span class="hljs-keyword">from</span> app.models <span class="hljs-keyword">import</span> Base
target_metadata = Base.metadata

<span class="hljs-keyword">def</span> <span class="hljs-title function_">do_run_migrations</span>(<span class="hljs-params">connection</span>):
    context.configure(connection=connection, target_metadata=target_metadata)
    <span class="hljs-keyword">with</span> context.begin_transaction():
        context.run_migrations()

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_async_migrations</span>():
    <span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> AsyncEngine
    connectable = AsyncEngine(create_async_engine(settings.database_url))
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> connectable.connect() <span class="hljs-keyword">as</span> connection:
        <span class="hljs-keyword">await</span> connection.run_sync(do_run_migrations)
    <span class="hljs-keyword">await</span> connectable.dispose()
</code></pre>
<p><strong>生成 / 升级</strong></p>
<pre><code class="hljs language-bash" lang="bash">alembic revision --autogenerate -m <span class="hljs-string">"init"</span>
alembic upgrade <span class="hljs-built_in">head</span>
</code></pre>
<hr/>
<h2 data-id="heading-6">7. 测试：pytest-asyncio + 异步数据库事务</h2>
<p><strong>tests/conftest.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> httpx <span class="hljs-keyword">import</span> AsyncClient
<span class="hljs-keyword">from</span> app.main <span class="hljs-keyword">import</span> app
<span class="hljs-keyword">from</span> app.core.db <span class="hljs-keyword">import</span> db <span class="hljs-keyword">as</span> db_instance
<span class="hljs-keyword">from</span> sqlalchemy.pool <span class="hljs-keyword">import</span> StaticPool
<span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> AsyncEngine, create_async_engine

<span class="hljs-meta">@pytest.fixture(<span class="hljs-params">scope=<span class="hljs-string">"session"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">engine</span>() -&gt; AsyncEngine:
    <span class="hljs-comment"># 内存 SQLite 也可以异步，但 PostgreSQL 更真实</span>
    engine = create_async_engine(
        <span class="hljs-string">"postgresql+asyncpg://test:test@localhost:5432/test"</span>,
        poolclass=StaticPool,
    )
    <span class="hljs-keyword">yield</span> engine
    <span class="hljs-keyword">await</span> engine.dispose()

<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">session</span>(<span class="hljs-params">engine: AsyncEngine</span>):
    conn = <span class="hljs-keyword">await</span> engine.begin()
    sess = db_instance.session_factory(bind=conn)
    <span class="hljs-keyword">yield</span> sess
    <span class="hljs-keyword">await</span> sess.close()
    <span class="hljs-keyword">await</span> conn.rollback()
    <span class="hljs-keyword">await</span> conn.close()

<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">client</span>() -&gt; AsyncGenerator[AsyncClient, <span class="hljs-literal">None</span>]:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> AsyncClient(app=app, base_url=<span class="hljs-string">"http://test"</span>) <span class="hljs-keyword">as</span> c:
        <span class="hljs-keyword">yield</span> c
</code></pre>
<p><strong>tests/test_user.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select
<span class="hljs-keyword">from</span> app.models <span class="hljs-keyword">import</span> User

<span class="hljs-meta">@pytest.mark.asyncio</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_create_user</span>(<span class="hljs-params">client, session</span>):
    res = <span class="hljs-keyword">await</span> client.post(<span class="hljs-string">"/users"</span>, json={<span class="hljs-string">"email"</span>: <span class="hljs-string">"a@b.com"</span>, <span class="hljs-string">"full_name"</span>: <span class="hljs-string">"abc"</span>})
    <span class="hljs-keyword">assert</span> res.status_code == <span class="hljs-number">201</span>
    data = res.json()
    <span class="hljs-keyword">assert</span> data[<span class="hljs-string">"email"</span>] == <span class="hljs-string">"a@b.com"</span>

    user = <span class="hljs-keyword">await</span> session.get(User, data[<span class="hljs-string">"id"</span>])
    <span class="hljs-keyword">assert</span> user <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>
</code></pre>
<hr/>
<h2 data-id="heading-7">8. 性能调优 checklist</h2>



































<table><thead><tr><th>参数</th><th>建议值</th><th>说明</th></tr></thead><tbody><tr><td><code>pool_size</code></td><td>CPU 核心 × 2</td><td>20 并发已能压到 10k RPS</td></tr><tr><td><code>max_overflow</code></td><td>0</td><td>防止突发连接打爆 DB</td></tr><tr><td><code>pool_pre_ping=True</code></td><td>必须</td><td>网络闪断后自动重连</td></tr><tr><td><code>expire_on_commit=False</code></td><td>必须</td><td>否则 commit 后属性失效</td></tr><tr><td><code>echo=False</code></td><td>生产关闭</td><td>减少序列化开销</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">9. 常见错误速查表</h2>






























<table><thead><tr><th>异常</th><th>原因</th><th>解法</th></tr></thead><tbody><tr><td><code>greenlet_spawn has not been called</code></td><td>用了同步引擎</td><td><code>create_async_engine</code></td></tr><tr><td><code>DetachedInstanceError</code></td><td>会话关闭后访问属性</td><td><code>expire_on_commit=False</code> + <code>await session.refresh()</code></td></tr><tr><td><code>InterfaceError: connection already closed</code></td><td>协程间复用 Session</td><td>一个请求一个 Session，禁止全局单例</td></tr><tr><td><code>ImportError: asyncmy</code></td><td>MySQL 驱动未装</td><td><code>pip install asyncmy</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">10. 结语</h2>
<p>FastAPI 的异步生态里，<strong>数据库是最后一道闸门</strong>。<br/>
用上 SQLAlchemy 2.0 AsyncIO 之后，<strong>I/O 等待不再是瓶颈</strong>，压测曲线直接多一个量级。<br/>
把本文的 <code>db.py</code> + <code>deps.py</code> 复制走，<strong>10 分钟就能让老项目原地起飞</strong>。Happy async coding!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 开发环境搭建全攻略（2025版）]]></title>    <link>https://juejin.cn/post/7571338749197090866</link>    <guid>https://juejin.cn/post/7571338749197090866</guid>    <pubDate>2025-11-11T11:49:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571338749197090866" data-draft-id="7571191453126770714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 开发环境搭建全攻略（2025版）"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-11T11:49:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java私教"/> <meta itemprop="url" content="https://juejin.cn/user/3394924618197325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 开发环境搭建全攻略（2025版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3394924618197325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java私教
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T11:49:56.000Z" title="Tue Nov 11 2025 11:49:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文将详细介绍如何在本地搭建一个高效、可维护的 Node.js 开发环境，适用于 Windows、macOS 与 Linux。无论你是后端新手还是资深全栈工程师，都能通过本文快速构建一个标准化的 Node.js 开发环境。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、什么是 Node.js？</h2>
<p><strong>Node.js</strong> 是一个基于 Chrome V8 引擎的 JavaScript 运行时，它让开发者可以在服务器端运行 JavaScript。
它以 <strong>事件驱动、非阻塞 I/O</strong> 的特性著称，非常适合构建高性能的 Web 服务和微服务架构。</p>
<hr/>
<h2 data-id="heading-1">二、安装 Node.js</h2>
<h3 data-id="heading-2">1. 使用官方安装包（适合初学者）</h3>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2F" target="_blank" title="https://nodejs.org/" ref="nofollow noopener noreferrer">Node.js 官方网站</a>
你会看到两个版本：</p>
<ul>
<li><strong>LTS（长期支持版）</strong>：稳定可靠，推荐生产环境使用</li>
<li><strong>Current（最新功能版）</strong>：包含最新特性，适合尝鲜或测试</li>
</ul>
<p>下载并运行对应操作系统的安装包后，命令行输入以下命令验证安装：</p>
<pre><code class="hljs language-bash" lang="bash">node -v
npm -v
</code></pre>
<p>你应能看到类似输出：</p>
<pre><code class="hljs">v20.18.1
10.5.2
</code></pre>
<hr/>
<h3 data-id="heading-3">2. 使用 Node 版本管理器（推荐）</h3>
<p>在实际项目中，<strong>不同项目可能依赖不同版本的 Node.js</strong>。
因此推荐使用版本管理工具，如：</p>
<h4 data-id="heading-4">macOS / Linux：</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 nvm（Node Version Manager）</span>
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/master/install.sh | bash

<span class="hljs-comment"># 载入配置</span>
<span class="hljs-built_in">source</span> ~/.bashrc  <span class="hljs-comment"># 或 ~/.zshrc</span>

<span class="hljs-comment"># 安装并使用指定版本</span>
nvm install 20
nvm use 20
</code></pre>
<h4 data-id="heading-5">Windows：</h4>
<p>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcoreybutler%2Fnvm-windows" target="_blank" title="https://github.com/coreybutler/nvm-windows" ref="nofollow noopener noreferrer">nvm-windows</a>：</p>
<pre><code class="hljs language-powershell" lang="powershell">nvm install 20.18.1
nvm use 20.18.1
</code></pre>
<p>验证版本：</p>
<pre><code class="hljs language-bash" lang="bash">node -v
nvm list
</code></pre>
<p>✅ <strong>优势：</strong></p>
<ul>
<li>多版本 Node 共存</li>
<li>快速切换项目环境</li>
<li>更易于 CI/CD 集成</li>
</ul>
<hr/>
<h2 data-id="heading-6">三、配置 npm（包管理工具）</h2>
<p>Node.js 自带的 <strong>npm</strong> 是 JavaScript 生态的核心包管理器。</p>
<h3 data-id="heading-7">常见配置：</h3>
<h4 data-id="heading-8">1. 修改全局镜像源（加速安装）</h4>
<p>默认源在国外，安装速度较慢，可以改为国内镜像：</p>
<pre><code class="hljs language-bash" lang="bash">npm config <span class="hljs-built_in">set</span> registry https://registry.npmmirror.com
</code></pre>
<p>查看是否成功：</p>
<pre><code class="hljs language-bash" lang="bash">npm config get registry
</code></pre>
<h4 data-id="heading-9">2. 安装全局工具</h4>
<pre><code class="hljs language-bash" lang="bash">npm install -g yarn pnpm nodemon
</code></pre>
<p>常用工具说明：</p>

























<table><thead><tr><th>工具</th><th>作用</th></tr></thead><tbody><tr><td><code>yarn</code> / <code>pnpm</code></td><td>更快的包管理器</td></tr><tr><td><code>nodemon</code></td><td>自动重启 Node 服务</td></tr><tr><td><code>typescript</code></td><td>TypeScript 支持</td></tr><tr><td><code>eslint</code></td><td>代码规范检查</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">四、创建一个 Node.js 项目</h2>
<h3 data-id="heading-11">1. 初始化项目</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> my-node-app
<span class="hljs-built_in">cd</span> my-node-app
npm init -y
</code></pre>
<p>这会生成一个基本的 <code>package.json</code> 文件。</p>
<h3 data-id="heading-12">2. 创建主文件</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">touch</span> index.js
</code></pre>
<p>编辑内容：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);

<span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, {<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span>});
  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">'Hello Node.js!'</span>);
});

server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Server running at http://localhost:3000/'</span>);
});
</code></pre>
<p>运行：</p>
<pre><code class="hljs language-bash" lang="bash">node index.js
</code></pre>
<p>访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000" target="_blank" title="http://localhost:3000" ref="nofollow noopener noreferrer">http://localhost:3000</a> 即可看到结果。</p>
<hr/>
<h2 data-id="heading-13">五、使用现代化开发工具</h2>
<h3 data-id="heading-14">1. VS Code 配置</h3>
<p>安装推荐扩展：</p>
<ul>
<li><strong>ESLint</strong>：代码规范检查</li>
<li><strong>Prettier</strong>：自动格式化</li>
<li><strong>Node.js Extension Pack</strong>：常用 Node 工具集成</li>
</ul>
<p>添加 <code>.vscode/settings.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"editor.formatOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"editor.codeActionsOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"source.fixAll.eslint"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-15">2. 使用 <code>.env</code> 管理环境变量</h3>
<p>安装 dotenv：</p>
<pre><code class="hljs language-bash" lang="bash">npm install dotenv
</code></pre>
<p>在项目根目录添加 <code>.env</code> 文件：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span>
</code></pre>
<p>修改代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'dotenv'</span>).<span class="hljs-title function_">config</span>();
<span class="hljs-keyword">const</span> port = process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-number">3000</span>;
</code></pre>
<hr/>
<h2 data-id="heading-16">六、使用 TypeScript（可选）</h2>
<p>现代 Node 项目推荐使用 TypeScript。</p>
<pre><code class="hljs language-bash" lang="bash">npm install -D typescript ts-node @types/node
npx tsc --init
</code></pre>
<p>修改 <code>tsconfig.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ES2020"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"commonjs"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"rootDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-17">七、总结</h2>








































<table><thead><tr><th>步骤</th><th>内容</th><th>目的</th></tr></thead><tbody><tr><td>1</td><td>安装 Node.js 或 nvm</td><td>管理运行时环境</td></tr><tr><td>2</td><td>配置 npm 源</td><td>加速依赖安装</td></tr><tr><td>3</td><td>初始化项目</td><td>生成 package.json</td></tr><tr><td>4</td><td>编写入口文件</td><td>启动服务器</td></tr><tr><td>5</td><td>配置编辑器与 ESLint</td><td>提升开发体验</td></tr><tr><td>6</td><td>可选启用 TypeScript</td><td>增强类型安全</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-18">八、结语</h2>
<p>到这里，你已经拥有一个完整、可扩展的 Node.js 开发环境。
后续可以基于此环境继续学习：</p>
<ul>
<li>使用 <strong>Express / Koa / NestJS</strong> 构建后端服务</li>
<li>使用 <strong>TypeScript + Jest</strong> 构建测试体系</li>
<li>使用 <strong>Docker</strong> 容器化部署</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Activity启动流程详细分析]]></title>    <link>https://juejin.cn/post/7571281406509973555</link>    <guid>https://juejin.cn/post/7571281406509973555</guid>    <pubDate>2025-11-11T10:11:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571281406509973555" data-draft-id="7571088527678996506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Activity启动流程详细分析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T10:11:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="姝然_9527"/> <meta itemprop="url" content="https://juejin.cn/user/1025189696514199"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Activity启动流程详细分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1025189696514199/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    姝然_9527
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:11:34.000Z" title="Tue Nov 11 2025 10:11:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Android Activity启动流程详细分析</h2>
<h3 data-id="heading-1">概述</h3>
<p>Activity启动是Android系统中最核心的功能之一。本文将从Activity的startActivity方法开始，一步一步详细分析Activity是如何启动另一个Activity的完整流程。整个流程涉及应用进程和系统进程之间的协作，通过Binder IPC进行通信。</p>
<h3 data-id="heading-2">启动流程总览</h3>
<p>Activity启动流程可以分为三个主要阶段：</p>
<ol start="0">
<li>应用进程准备阶段</li>
<li>系统进程决策与调度阶段</li>
<li>应用进程执行阶段</li>
</ol>
<h3 data-id="heading-3">详细启动流程分析</h3>
<h4 data-id="heading-4">1. 应用进程准备阶段</h4>
<h5 data-id="heading-5">1.1 Activity.startActivity() 方法调用</h5>
<p>当我们在Activity中调用startActivity(Intent intent)方法时，实际调用的是Activity类中的以下代码：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Override</span>
public void <span class="hljs-built_in">startActivity</span>(Intent intent, <span class="hljs-variable">@Nullable</span> Bundle options) {
    <span class="hljs-selector-tag">getAutofillClientController</span>()<span class="hljs-selector-class">.onStartActivity</span>(intent, mIntent);
    <span class="hljs-selector-tag">if</span> (options != null) {
        <span class="hljs-selector-tag">startActivityForResult</span>(intent, -<span class="hljs-number">1</span>, options);
    } <span class="hljs-selector-tag">else</span> {
        <span class="hljs-comment">// Note we want to go through this call for compatibility with</span>
        <span class="hljs-comment">// applications that may have overridden the method.</span>
        <span class="hljs-selector-tag">startActivityForResult</span>(intent, -<span class="hljs-number">1</span>);
    }
}
</code></pre>
<h5 data-id="heading-6">1.2 Activity.startActivityForResult() 方法</h5>
<p>startActivityForResult方法进一步处理启动请求：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">startActivityForResult</span>(<span class="hljs-variable">@RequiresPermission</span> Intent intent, int requestCode,
                                   <span class="hljs-variable">@Nullable</span> Bundle options) {
    <span class="hljs-selector-tag">Instrumentation</span><span class="hljs-selector-class">.ActivityResult</span> <span class="hljs-selector-tag">ar</span> =
            <span class="hljs-selector-tag">mInstrumentation</span><span class="hljs-selector-class">.execStartActivity</span>(
                    this, mMainThread.<span class="hljs-built_in">getApplicationThread</span>(), mToken, this,
                    intent, requestCode, options);
}
</code></pre>
<p>这里将启动任务委托给了Instrumentation类。</p>
<h5 data-id="heading-7">1.3 Instrumentation.execStartActivity() 方法</h5>
<p>Instrumentation是应用进程与系统进程之间的桥梁，它的execStartActivity()方法负责执行实际的启动操作：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@UnsupportedAppUsage</span>
<span class="hljs-keyword">public</span> ActivityResult <span class="hljs-title function_">execStartActivity</span><span class="hljs-params">(
        Context who, IBinder contextThread, IBinder token, Activity target,
        Intent intent, <span class="hljs-type">int</span> requestCode, Bundle options)</span> {
    <span class="hljs-type">IApplicationThread</span> <span class="hljs-variable">whoThread</span> <span class="hljs-operator">=</span> (IApplicationThread) contextThread;
​
    <span class="hljs-keyword">try</span> {
        intent.migrateExtraStreamToClipData(who);
        intent.prepareToLeaveProcess(who);
        <span class="hljs-comment">//获取到 IActivityTaskManager，实际就是 ActivityTaskManagerService</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ActivityTaskManager.getService().startActivity(whoThread,
                who.getOpPackageName(), who.getAttributionTag(), intent,
                intent.resolveTypeIfNeeded(who.getContentResolver()), token,
                target != <span class="hljs-literal">null</span> ? target.mEmbeddedID : <span class="hljs-literal">null</span>, requestCode, <span class="hljs-number">0</span>, <span class="hljs-literal">null</span>, options);
        checkStartActivityResult(result, intent);
    } <span class="hljs-keyword">catch</span> (RemoteException e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Failure from system"</span>, e);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p>在这个方法中，通过ActivityTaskManager.getService()获取到系统服务的Binder代理对象，然后调用其startActivity()方法，这是一个跨进程调用。</p>
<h4 data-id="heading-8">2. 系统进程决策与调度阶段</h4>
<h5 data-id="heading-9">2.1 ActivityTaskManagerService接收请求</h5>
<p>系统进程中的ActivityTaskManagerService（ATMS）接收到来自应用进程的启动请求：</p>
<pre><code class="hljs language-arduino" lang="arduino">@<span class="hljs-function">Override
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title">startActivity</span><span class="hljs-params">(IApplicationThread caller, <span class="hljs-type">String</span> callingPackage,
                               Intent intent, <span class="hljs-type">String</span> resolvedType, IBinder resultTo, <span class="hljs-type">String</span> resultWho, <span class="hljs-type">int</span> requestCode,
                               <span class="hljs-type">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">startActivityAsUser</span>(caller, callingPackage, intent, resolvedType, resultTo,
            resultWho, requestCode, startFlags, profilerInfo, bOptions,
            UserHandle.<span class="hljs-built_in">getCallingUserId</span>());
}
</code></pre>
<pre><code class="hljs language-scss" lang="scss">int <span class="hljs-built_in">startActivityAsUser</span>(IApplicationThread caller, String callingPackage,
                        Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode,
                        int startFlags, ProfilerInfo profilerInfo, Bundle bOptions, int userId,
                        boolean validateIncomingUser) {
    <span class="hljs-built_in">enforceNotIsolatedCaller</span>("startActivityAsUser");
​
    userId = <span class="hljs-built_in">getActivityStartController</span>()<span class="hljs-selector-class">.checkTargetUser</span>(userId, validateIncomingUser,
            Binder.getCallingPid(), Binder<span class="hljs-selector-class">.getCallingUid</span>(), "startActivityAsUser");
​
    <span class="hljs-comment">// getActivityStartController返回的是 ActivityStarter</span>
    return <span class="hljs-built_in">getActivityStartController</span>()<span class="hljs-selector-class">.obtainStarter</span>(intent, "startActivityAsUser")
            <span class="hljs-selector-class">.setCaller</span>(caller)
            <span class="hljs-selector-class">.setCallingPackage</span>(callingPackage)
            <span class="hljs-selector-class">.setResolvedType</span>(resolvedType)
            <span class="hljs-selector-class">.setResultTo</span>(resultTo)
            <span class="hljs-selector-class">.setResultWho</span>(resultWho)
            <span class="hljs-selector-class">.setRequestCode</span>(requestCode)
            <span class="hljs-selector-class">.setStartFlags</span>(startFlags)
            <span class="hljs-selector-class">.setProfilerInfo</span>(profilerInfo)
            <span class="hljs-selector-class">.setActivityOptions</span>(bOptions)
            <span class="hljs-selector-class">.setMayWait</span>(userId)
            <span class="hljs-selector-class">.execute</span>();
}
</code></pre>
<h5 data-id="heading-10">2.2 ActivityStarter.execute() 方法</h5>
<p>ActivityStarter是启动Activity的"大脑"，负责所有的校验和决策逻辑：</p>
<pre><code class="hljs language-scss" lang="scss">int <span class="hljs-built_in">execute</span>() {
    try {
        <span class="hljs-comment">// TODO(b/64750076): Look into passing request directly to these methods to allow</span>
        <span class="hljs-comment">// for transactional diffs and preprocessing.</span>
        if (mRequest.mayWait) {
            return <span class="hljs-built_in">startActivityMayWait</span>(mRequest.caller, mRequest.callingUid,
                    mRequest.callingPackage, mRequest.realCallingPid, mRequest.realCallingUid,
                    mRequest.intent, mRequest.resolvedType,
                    mRequest.voiceSession, mRequest.voiceInteractor, mRequest.resultTo,
                    mRequest.resultWho, mRequest.requestCode, mRequest.startFlags,
                    mRequest.profilerInfo, mRequest.waitResult, mRequest.globalConfig,
                    mRequest.activityOptions, mRequest.ignoreTargetSecurity, mRequest.userId,
                    mRequest.inTask, mRequest.reason,
                    mRequest.allowPendingRemoteAnimationRegistryLookup,
                    mRequest.originatingPendingIntent, mRequest.allowBackgroundActivityStart);
        } else {
            return <span class="hljs-built_in">startActivity</span>(mRequest.caller, mRequest.intent, mRequest.ephemeralIntent,
                    mRequest.resolvedType, mRequest.activityInfo, mRequest.resolveInfo,
                    mRequest.voiceSession, mRequest.voiceInteractor, mRequest.resultTo,
                    mRequest.resultWho, mRequest.requestCode, mRequest.callingPid,
                    mRequest.callingUid, mRequest.callingPackage, mRequest.realCallingPid,
                    mRequest.realCallingUid, mRequest.startFlags, mRequest.activityOptions,
                    mRequest.ignoreTargetSecurity, mRequest.componentSpecified,
                    mRequest.outActivity, mRequest.inTask, mRequest.reason,
                    mRequest.allowPendingRemoteAnimationRegistryLookup,
                    mRequest.originatingPendingIntent, mRequest.allowBackgroundActivityStart);
        }
    } finally {
        <span class="hljs-built_in">onExecutionComplete</span>();
    }
}
</code></pre>
<h5 data-id="heading-11">2.3 startActivityMayWait() 方法</h5>
<p>当需要等待Activity启动结果时（通常情况），会调用startActivityMayWait()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">startActivityMayWait</span><span class="hljs-params">(IApplicationThread caller, <span class="hljs-type">int</span> callingUid,
        String callingPackage, <span class="hljs-type">int</span> requestRealCallingPid, <span class="hljs-type">int</span> requestRealCallingUid,
        Intent intent, String resolvedType, IVoiceInteractionSession voiceSession,
        IVoiceInteractor voiceInteractor, IBinder resultTo, String resultWho, <span class="hljs-type">int</span> requestCode,
        <span class="hljs-type">int</span> startFlags, ProfilerInfo profilerInfo, WaitResult outResult,
        Configuration globalConfig, SafeActivityOptions options, <span class="hljs-type">boolean</span> ignoreTargetSecurity,
        <span class="hljs-type">int</span> userId, TaskRecord inTask, String reason,
        <span class="hljs-type">boolean</span> allowPendingRemoteAnimationRegistryLookup,
        PendingIntentRecord originatingPendingIntent, <span class="hljs-type">boolean</span> allowBackgroundActivityStart)</span> {
    
    <span class="hljs-comment">// 1. 检查Intent中的文件描述符，防止泄露</span>
    <span class="hljs-keyword">if</span> (intent != <span class="hljs-literal">null</span> &amp;&amp; intent.hasFileDescriptors()) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"File descriptors passed in Intent"</span>);
    }
    
    <span class="hljs-comment">// 2. 解析Intent获取目标Activity信息</span>
    <span class="hljs-type">ResolveInfo</span> <span class="hljs-variable">rInfo</span> <span class="hljs-operator">=</span> mSupervisor.resolveIntent(intent, resolvedType, userId,
            <span class="hljs-number">0</span> <span class="hljs-comment">/* matchFlags */</span>, computeResolveFilterUid(
                    callingUid, requestRealCallingUid, mRequest.filterCallingUid));
    
    <span class="hljs-comment">// 3. 获取ActivityInfo</span>
    <span class="hljs-type">ActivityInfo</span> <span class="hljs-variable">aInfo</span> <span class="hljs-operator">=</span> rInfo != <span class="hljs-literal">null</span> ? rInfo.activityInfo : <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (aInfo != <span class="hljs-literal">null</span>) {
        aInfo = mService.mAmInternal.getActivityInfoForUser(aInfo, userId);
    }
    
    <span class="hljs-comment">// 4. 处理特殊情况（如重量级应用、托管应用等）</span>
    <span class="hljs-comment">// ...</span>
    
    <span class="hljs-comment">// 5. 调用startActivity()方法继续执行</span>
    <span class="hljs-keyword">return</span> startActivity(caller, intent, ephemeralIntent, resolvedType, aInfo, rInfo,
            voiceSession, voiceInteractor, resultTo, resultWho, requestCode, callingPid,
            callingUid, callingPackage, realCallingPid, realCallingUid, startFlags, options,
            ignoreTargetSecurity, componentSpecified, outActivity, inTask, reason,
            allowPendingRemoteAnimationRegistryLookup, originatingPendingIntent,
            allowBackgroundActivityStart);
}
</code></pre>
<h5 data-id="heading-12">2.4 startActivity() 方法</h5>
<p>startActivity()方法是核心的启动方法：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title">startActivity</span><span class="hljs-params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,
        <span class="hljs-type">String</span> resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,
        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,
        IBinder resultTo, <span class="hljs-type">String</span> resultWho, <span class="hljs-type">int</span> requestCode, <span class="hljs-type">int</span> callingPid, <span class="hljs-type">int</span> callingUid,
        <span class="hljs-type">String</span> callingPackage, <span class="hljs-type">int</span> realCallingPid, <span class="hljs-type">int</span> realCallingUid, <span class="hljs-type">int</span> startFlags,
        SafeActivityOptions options,
        <span class="hljs-type">boolean</span> ignoreTargetSecurity, <span class="hljs-type">boolean</span> componentSpecified, ActivityRecord[] outActivity,
        TaskRecord inTask, <span class="hljs-type">boolean</span> allowPendingRemoteAnimationRegistryLookup,
        PendingIntentRecord originatingPendingIntent, <span class="hljs-type">boolean</span> allowBackgroundActivityStart)</span> </span>{
    
    <span class="hljs-comment">// 1. 权限检查</span>
    <span class="hljs-comment">// 2. Intent解析</span>
    <span class="hljs-comment">// 3. 创建ActivityRecord对象</span>
    <span class="hljs-comment">// 4. 调用startActivityUnchecked()方法</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">startActivityUnchecked</span>(r, sourceRecord, voiceSession, voiceInteractor,
            startFlags, doResume, options, inTask, outActivity, restrictedBgActivity);
}
</code></pre>
<h5 data-id="heading-13">2.5 startActivityUnchecked() 方法</h5>
<p>这是Activity启动流程中最核心的方法，负责具体的启动逻辑：</p>
<pre><code class="hljs language-scss" lang="scss">private int <span class="hljs-built_in">startActivityUnchecked</span>(final ActivityRecord r, ActivityRecord sourceRecord,
        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,
        int startFlags, boolean doResume, ActivityOptions options, TaskRecord inTask,
        ActivityRecord[] outActivity, boolean restrictedBgActivity) {
    
    <span class="hljs-comment">// 1. 初始化状态</span>
    <span class="hljs-built_in">setInitialState</span>(r, options, inTask, doResume, startFlags, sourceRecord,
            voiceSession, voiceInteractor, restrictedBgActivity);
    
    <span class="hljs-comment">// 2. 计算启动标志</span>
    <span class="hljs-built_in">computeLaunchingTaskFlags</span>();
    
    <span class="hljs-comment">// 3. 计算源任务栈</span>
    <span class="hljs-built_in">computeSourceStack</span>();
    
    <span class="hljs-comment">// 4. 查找可复用的Activity</span>
    ActivityRecord reusedActivity = <span class="hljs-built_in">getReusableIntentActivity</span>();
    
    <span class="hljs-comment">// 5. 处理复用情况</span>
    if (reusedActivity != null) {
        <span class="hljs-comment">// 如果找到可复用的Activity</span>
        reusedActivity = <span class="hljs-built_in">setTargetStackAndMoveToFrontIfNeeded</span>(reusedActivity);
        <span class="hljs-built_in">setTaskFromIntentActivity</span>(reusedActivity);
        <span class="hljs-comment">// ...</span>
    } else {
        <span class="hljs-comment">// 6. 处理不复用情况</span>
        <span class="hljs-comment">// 根据不同情况调用不同的任务创建方法</span>
        if (mStartActivity.resultTo == null &amp;&amp; mInTask == null &amp;&amp; !mAddingToTask
                &amp;&amp; (mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 创建新任务</span>
            result = <span class="hljs-built_in">setTaskFromReuseOrCreateNewTask</span>(taskToAffiliate);
        } else if (mSourceRecord != null) {
            <span class="hljs-comment">// 在源任务中启动</span>
            result = <span class="hljs-built_in">setTaskFromSourceRecord</span>();
        } else if (mInTask != null) {
            <span class="hljs-comment">// 在指定任务中启动</span>
            result = <span class="hljs-built_in">setTaskFromInTask</span>();
        } else {
            <span class="hljs-comment">// 在当前顶部任务中启动</span>
            result = <span class="hljs-built_in">setTaskToCurrentTopOrCreateNewTask</span>();
        }
    }
    
    <span class="hljs-comment">// 7. 权限处理</span>
    mService<span class="hljs-selector-class">.mUgmInternal</span><span class="hljs-selector-class">.grantUriPermissionFromIntent</span>(mCallingUid, mStartActivity.packageName,
            mIntent, mStartActivity.getUriPermissionsLocked(), mStartActivity<span class="hljs-selector-class">.mUserId</span>);
    
    <span class="hljs-comment">// 8. 启动Activity</span>
    mTargetStack<span class="hljs-selector-class">.startActivityLocked</span>(mStartActivity, topFocused, newTask, mKeepCurTransition,
            mOptions);
    
    <span class="hljs-comment">// 9. 恢复Activity</span>
    if (mDoResume) {
        mRootActivityContainer<span class="hljs-selector-class">.resumeFocusedStacksTopActivities</span>(
                mTargetStack, mStartActivity, mOptions);
    }
    
    return START_SUCCESS;
}
</code></pre>
<h5 data-id="heading-14">2.6 任务栈管理</h5>
<p>在startActivityUnchecked()方法中，系统会根据launch mode和Intent flags来决定如何管理任务栈：</p>
<ol start="0">
<li><strong>setTaskFromReuseOrCreateNewTask()</strong> : 创建新任务或复用现有任务</li>
<li><strong>setTaskFromSourceRecord()</strong> : 在源Activity的任务中启动</li>
<li><strong>setTaskFromInTask()</strong> : 在指定任务中启动</li>
<li><strong>setTaskToCurrentTopOrCreateNewTask()</strong> : 在当前顶部任务中启动</li>
</ol>
<h4 data-id="heading-15">3. 应用进程执行阶段</h4>
<h5 data-id="heading-16">3.1 跨进程回调应用进程</h5>
<p>系统进程通过Binder IPC回调到目标Activity所在的应用进程。这个回调的接收者是ApplicationThread。</p>
<h5 data-id="heading-17">3.2 ApplicationThread接收回调</h5>
<p>ApplicationThread是ActivityThread的内部类，它是一个Binder对象，运行在应用进程中。它接收到scheduleTransaction()调用，其中包含了启动Activity的指令。</p>
<h5 data-id="heading-18">3.3 H(Handler)处理消息</h5>
<p>ApplicationThread将接收到的Binder调用转换成Message，通过一个Handler（名为H）发送到应用进程的主线程消息队列中。</p>
<h5 data-id="heading-19">3.4 ActivityThread处理指令</h5>
<p>主线程的H处理消息，调用ActivityThread的handleLaunchActivity()方法：</p>
<pre><code class="hljs language-scss" lang="scss">public Activity <span class="hljs-built_in">handleLaunchActivity</span>(ActivityClientRecord r,
        PendingTransactionActions pendingActions, Intent customIntent) {
    <span class="hljs-comment">// 1. 创建Activity实例</span>
    Activity <span class="hljs-selector-tag">a</span> = <span class="hljs-built_in">performLaunchActivity</span>(r, customIntent);
    
    <span class="hljs-comment">// 2. 调用Activity的onResume方法</span>
    if (a != null) {
        r<span class="hljs-selector-class">.createdConfig</span> = new <span class="hljs-built_in">Configuration</span>(mConfiguration);
        <span class="hljs-built_in">reportSizeConfigurations</span>(r);
        if (!r.activity.mFinished &amp;&amp; pendingActions != null) {
            pendingActions<span class="hljs-selector-class">.setOldState</span>(r.state);
            pendingActions<span class="hljs-selector-class">.setRestoreInstanceState</span>(true);
        }
        <span class="hljs-built_in">handleResumeActivity</span>(r.token, false, r.isForward,
                !r.activity.mFinished &amp;&amp; pendingActions != null);
    }
    
    return <span class="hljs-selector-tag">a</span>;
}
</code></pre>
<h5 data-id="heading-20">3.5 performLaunchActivity() 创建Activity</h5>
<pre><code class="hljs language-ini" lang="ini">private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) {
    ActivityInfo <span class="hljs-attr">aInfo</span> = r.activityInfo<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">r.packageInfo</span> == null) {
        return null<span class="hljs-comment">;</span>
    }

    ComponentName <span class="hljs-attr">component</span> = r.intent.getComponent()<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">component</span> == null) {
        <span class="hljs-attr">component</span> = r.intent.resolveActivity(
            mInitialApplication.getPackageManager())<span class="hljs-comment">;</span>
        r.intent.setComponent(component)<span class="hljs-comment">;</span>
    }

    if (r.activityInfo.targetActivity != null) {
        <span class="hljs-attr">component</span> = new ComponentName(r.activityInfo.packageName,
                r.activityInfo.targetActivity)<span class="hljs-comment">;</span>
    }

    ContextImpl <span class="hljs-attr">appContext</span> = createBaseContextForActivity(r)<span class="hljs-comment">;</span>
    Activity <span class="hljs-attr">activity</span> = null<span class="hljs-comment">;</span>
    try {
        // 1. 通过类加载器创建Activity实例
        java.lang.ClassLoader <span class="hljs-attr">cl</span> = appContext.getClassLoader()<span class="hljs-comment">;</span>
        <span class="hljs-attr">activity</span> = mInstrumentation.newActivity(
                cl, component.getClassName(), r.intent)<span class="hljs-comment">;</span>
        StrictMode.incrementExpectedActivityCount(activity.getClass())<span class="hljs-comment">;</span>
        r.intent.setExtrasClassLoader(cl)<span class="hljs-comment">;</span>
        r.intent.prepareToEnterProcess()<span class="hljs-comment">;</span>
        if (r.state != null) {
            r.state.setClassLoader(cl)<span class="hljs-comment">;</span>
        }
    } catch (Exception e) {
        if (!mInstrumentation.onException(activity, e)) {
            throw new RuntimeException(
                "Unable to instantiate activity " + component
                + ": " + e.toString(), e)<span class="hljs-comment">;</span>
        }
    }

    try {
        // 2. 创建Application实例（如果尚未创建）
        Application <span class="hljs-attr">app</span> = r.packageInfo.makeApplication(<span class="hljs-literal">false</span>, mInstrumentation)<span class="hljs-comment">;</span>

        if (activity != null) {
            // 3. 创建ContextImpl
            ContextImpl <span class="hljs-attr">appContext</span> = createBaseContextForActivity(r)<span class="hljs-comment">;</span>
            
            // 4. 调用Activity.attach()绑定上下文
            activity.attach(appContext, this, getInstrumentation(), r.token,
                    r.ident, app, r.intent, r.activityInfo, title, r.parent,
                    r.embeddedID, r.lastNonConfigurationInstances, config,
                    r.referrer, r.voiceInteractor, window, r.configCallback)<span class="hljs-comment">;</span>

            if (customIntent != null) {
                <span class="hljs-attr">activity.mIntent</span> = customIntent<span class="hljs-comment">;</span>
            }
            <span class="hljs-attr">r.lastNonConfigurationInstances</span> = null<span class="hljs-comment">;</span>
            checkAndBlockForNetworkAccess()<span class="hljs-comment">;</span>
            <span class="hljs-attr">activity.mStartedActivity</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
            int <span class="hljs-attr">theme</span> = r.activityInfo.getThemeResource()<span class="hljs-comment">;</span>
            if (theme != 0) {
                activity.setTheme(theme)<span class="hljs-comment">;</span>
            }

            // 5. 调用Activity的onCreate方法
            <span class="hljs-attr">activity.mCalled</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
            if (r.isPersistable()) {
                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState)<span class="hljs-comment">;</span>
            } else {
                mInstrumentation.callActivityOnCreate(activity, r.state)<span class="hljs-comment">;</span>
            }
            
            // ...
        }
        <span class="hljs-attr">r.paused</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>

        mActivities.put(r.token, r)<span class="hljs-comment">;</span>

    } catch (SuperNotCalledException e) {
        throw e<span class="hljs-comment">;</span>

    } catch (Exception e) {
        if (!mInstrumentation.onException(activity, e)) {
            throw new RuntimeException(
                "Unable to start activity " + component
                + ": " + e.toString(), e)<span class="hljs-comment">;</span>
        }
    }

    return activity<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-21">4. 后续生命周期调用</h4>
<p>在handleLaunchActivity()之后，系统进程会继续通过同样的IPC -&gt; Handler机制，依次调度start、resume等方法。</p>
<h3 data-id="heading-22">关键概念详解</h3>
<h4 data-id="heading-23">Launch Mode</h4>
<p>Android支持四种启动模式：</p>
<ol start="0">
<li><strong>standard</strong>：默认模式，每次启动都会创建新实例</li>
<li><strong>singleTop</strong>：如果Activity已在栈顶，则复用并调用onNewIntent()</li>
<li><strong>singleTask</strong>：在整个系统中只有一个实例，会清除其上的所有Activity</li>
<li><strong>singleInstance</strong>：独占一个任务栈，只有一个实例</li>
</ol>
<h4 data-id="heading-24">Intent Flags</h4>
<p>常用的Intent Flags：</p>
<ul>
<li><strong>FLAG_ACTIVITY_NEW_TASK</strong>：在新任务中启动Activity</li>
<li><strong>FLAG_ACTIVITY_CLEAR_TOP</strong>：清除目标Activity之上的所有Activity</li>
<li><strong>FLAG_ACTIVITY_SINGLE_TOP</strong>：如果Activity已在栈顶则复用</li>
<li><strong>FLAG_ACTIVITY_NO_HISTORY</strong>：Activity不会保留在历史栈中</li>
</ul>
<h3 data-id="heading-25">启动流程时序图</h3>
<pre><code class="hljs language-scss" lang="scss">客户端ActivityInstrumentationActivityTaskManagerServiceActivityStarterActivityStack目标应用进程<span class="hljs-built_in">ActivityThreadActivitystartActivity</span>()<span class="hljs-built_in">startActivity</span>() <span class="hljs-selector-attr">[IPC]</span><span class="hljs-built_in">obtainStarter</span>()<span class="hljs-selector-class">.execute</span>()<span class="hljs-built_in">startActivityMayWait</span>()<span class="hljs-built_in">startActivity</span>()<span class="hljs-built_in">startActivityUnchecked</span>()<span class="hljs-built_in">setInitialState</span>()<span class="hljs-built_in">computeLaunchingTaskFlags</span>()<span class="hljs-built_in">computeSourceStack</span>()<span class="hljs-built_in">getReusableIntentActivity</span>()<span class="hljs-built_in">setTargetStackAndMoveToFrontIfNeeded</span>()<span class="hljs-built_in">setTaskFromIntentActivity</span>()<span class="hljs-built_in">setTaskFromReuseOrCreateNewTask</span>()/<span class="hljs-built_in">setTaskFromSourceRecord</span>()alt<span class="hljs-selector-attr">[ 找到可复用Activity ]</span><span class="hljs-selector-attr">[ 未找到可复用Activity ]</span><span class="hljs-built_in">startActivityLocked</span>()<span class="hljs-built_in">scheduleLaunchActivity</span>() <span class="hljs-selector-attr">[IPC]</span>H<span class="hljs-selector-class">.handleMessage</span>()<span class="hljs-built_in">handleLaunchActivity</span>()<span class="hljs-built_in">performLaunchActivity</span>()<span class="hljs-built_in">onCreate</span>()<span class="hljs-built_in">scheduleResumeActivity</span>() <span class="hljs-selector-attr">[IPC]</span>H<span class="hljs-selector-class">.handleMessage</span>()<span class="hljs-built_in">onResume</span>()alt<span class="hljs-selector-attr">[ 需要恢复 ]</span>客户端ActivityInstrumentationActivityTaskManagerServiceActivityStarterActivityStack目标应用进程ActivityThreadActivity
</code></pre>
<h3 data-id="heading-26">总结</h3>
<p>Activity启动流程是一个复杂而精密的过程，涉及多个组件的协作：</p>
<ol start="0">
<li><strong>应用进程</strong>负责发起启动请求，并在系统调度后执行具体的生命周期方法</li>
<li><strong>系统进程</strong>（ATMS/ActivityStarter）负责权限检查、Intent解析、任务栈管理等核心决策</li>
<li><strong>Binder IPC</strong>是应用进程和系统进程之间通信的桥梁</li>
<li><strong>Instrumentation</strong>作为监控钩子，贯穿整个启动流程</li>
<li><strong>ActivityStack</strong>负责管理Activity的回退栈</li>
</ol>
<p>理解这个流程对于Android开发和系统优化都有重要意义，特别是在处理启动性能、任务管理、生命周期等问题时。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Compose SideEffect（副作用）实例加倍详解]]></title>    <link>https://juejin.cn/post/7571077686107897919</link>    <guid>https://juejin.cn/post/7571077686107897919</guid>    <pubDate>2025-11-11T08:19:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571077686107897919" data-draft-id="7566294664786001955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Compose  SideEffect（副作用）实例加倍详解"/> <meta itemprop="keywords" content="APP,Android"/> <meta itemprop="datePublished" content="2025-11-11T08:19:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="参宿四南河三"/> <meta itemprop="url" content="https://juejin.cn/user/3479267728427543"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Compose  SideEffect（副作用）实例加倍详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3479267728427543/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    参宿四南河三
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:19:36.000Z" title="Tue Nov 11 2025 08:19:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前几天的文章，整理了上个月的学习心得。这段时间又仔细研究了下SideEffect，秉着闲着找事干，有事干才不想着去洗脚的原则，我又开始了读书笔记式的码字。<code>源码在文章末尾。各副作用函数特性表也在文章末尾</code>。<br/>
<strong>部分例子在实际开发中是可能存在一定瑕疵的，旨在让大家明白如何使用。使用时请注意</strong></p>
<h2 data-id="heading-0">一、副作用到底有哪些？</h2>
<ul>
<li>LaunchedEffect</li>
<li>DisposableEffect</li>
<li>SideEffect</li>
<li>rememberCoroutineScope</li>
<li>produceState<br/>
副作用函数关联概念（<strong>个人觉得不是副函数</strong>）：</li>
<li>derivedStateOf</li>
<li>rememberUpdatedState</li>
</ul>
<p>上篇文章我已经简单介绍了这几个副作用函数，可总觉得太过简略，例子也很简单，完全不贴合实际开发，以后我怎么抄代码嘛。好的，下面我们就从实际出发举例子，让大家更好抄更好理解。</p>
<h2 data-id="heading-1">LaunchedEffect</h2>
<h3 data-id="heading-2">1、概括</h3>
<p>LaunchedEffect(key) = 页面进入时自动启动协程，key变了就取消旧的，重启新的。</p>
<h3 data-id="heading-3">2、核心机制</h3>





















<table><thead><tr><th>机制</th><th>说明</th></tr></thead><tbody><tr><td><strong>自动启动</strong></td><td>Composable 进入组合时，自动 <code>launch</code> 协程</td></tr><tr><td><strong>key 控制</strong></td><td><code>key</code> 不变 → 协程继续；<code>key</code> 变 → <strong>取消旧协程，启动新协程</strong></td></tr><tr><td><strong>自动取消</strong></td><td>离开页面 → 自动 <code>cancel()</code>，<strong>零泄漏</strong></td></tr></tbody></table>
<h3 data-id="heading-4">3、实际开发中的场景</h3>
<ul>
<li>场景一：加载网络数据（最常见）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">FetchUserInfo</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-keyword">var</span> user <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;User?&gt;(<span class="hljs-literal">null</span>) }
    <span class="hljs-keyword">var</span> loading <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">true</span>) }
    <span class="hljs-keyword">var</span> error <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;String?&gt;(<span class="hljs-literal">null</span>) }

    LaunchedEffect(userId) {  <span class="hljs-comment">// key = userId</span>
        loading = <span class="hljs-literal">true</span>
        error = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> result = withContext(Dispatchers.IO) {
                RetrofitClient.apiService.getUsersById(userId) 
            }
            user = result
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            error = e.message
        } <span class="hljs-keyword">finally</span> {
            loading = <span class="hljs-literal">false</span>
        }
    }

    <span class="hljs-keyword">when</span> {
        loading -&gt; CircularProgressIndicator()
        error != <span class="hljs-literal">null</span> -&gt; Text(<span class="hljs-string">"错误: <span class="hljs-variable">$error</span>"</span>, color = Color.Red)
        user != <span class="hljs-literal">null</span> -&gt; Column {
            Text(<span class="hljs-string">"用户名: <span class="hljs-subst">${user!!.name}</span>"</span>, style = MaterialTheme.typography.bodyLarge)
            Text(<span class="hljs-string">"邮箱: <span class="hljs-subst">${user!!.email}</span>"</span>)
        }
    }
}
</code></pre>
<p>代码核心：切换 userId → 自动取消旧请求，发起新请求</p>
<ul>
<li>场景二：一次性任务初始化（日志、埋点、第三方初始化）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">AnalyticsScreen</span><span class="hljs-params">(screenName: <span class="hljs-type">String</span>)</span></span> {
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {  <span class="hljs-comment">// 只执行一次</span>
        <span class="hljs-comment">//Analytics.uploadPoint(screenName)</span>
        Log.i(<span class="hljs-string">"当前页面: <span class="hljs-variable">$screenName</span>"</span>)
    }

    Text(<span class="hljs-string">"当前页面: <span class="hljs-variable">$screenName</span>"</span>)
}
</code></pre>
<p>为什么使用Unit？<strong>Unit在Kotlin里面是常量，意味着key永远不变</strong>，所以只在页面首次进入时执行一次。<br/>
小知识：LaunchedEffect(true)和LaunchedEffect(Unit)行为一致，因为 true 也是常量。但 true容易让人误解为“每次都执行”，建议统一用 Unit。</p>
<ul>
<li>场景三：轮询(实时获取数据)</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">GoldPrice</span><span class="hljs-params">(symbol: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">var</span> price <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;Price?&gt;(<span class="hljs-literal">null</span>) }
    LaunchedEffect(symbol) {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            price = withContext(Dispatchers.IO) {
                GoldPriceRetrofitClient.apiService.getGoldPrice(symbol)
            }
            delay(<span class="hljs-number">30_000</span>)
        }
    }
    Card(
        modifier = Modifier.padding(<span class="hljs-number">16.</span>dp),
        elevation = CardDefaults.cardElevation(defaultElevation = <span class="hljs-number">4.</span>dp)
    ) {
        Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
            Text(symbol, style = MaterialTheme.typography.bodyMedium)
            Text(<span class="hljs-string">"¥<span class="hljs-subst">${price?.price?:<span class="hljs-string">"未知"</span>}</span>"</span>, style = MaterialTheme.typography.bodyLarge)
        }
    }
}
</code></pre>
<p>代码核心：每30秒获取一次金价。调整商品编码时，自动停止旧商品轮询，开始新轮询。</p>
<ul>
<li>场景四：执行一个协程</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoadData</span><span class="hljs-params">(viewModel: <span class="hljs-type">SideEffectsViewModel</span> = viewModel()</span></span>) {
    <span class="hljs-keyword">var</span> user <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;User?&gt;( <span class="hljs-literal">null</span>) }
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        user = viewModel.getUserInfo(<span class="hljs-number">1</span>)
    }
}
</code></pre>
<p>代码核心：执行获取用户查询的supend的方法</p>
<h3 data-id="heading-5">4、快速记忆</h3>
<p>进入页 → 自动启动 → key变化自动重启 → 离开自动取消</p>
<h3 data-id="heading-6">5、常犯错误</h3>

























<table><thead><tr><th>错误</th><th>后果</th><th>正确</th></tr></thead><tbody><tr><td><code>LaunchedEffect(true)</code></td><td>易产生语义歧义</td><td>用 <code>Unit</code></td></tr><tr><td>不用 <code>withContext(IO)</code></td><td>阻塞 UI</td><td>必须切线程</td></tr><tr><td>忘记 <code>key</code></td><td>数据不更新</td><td>必须加依赖参数</td></tr></tbody></table>
<h3 data-id="heading-7">6、总结</h3>
<p>LaunchedEffect 是Compose中<strong>页面级异步任务</strong>的首选，key+自动取消是其核心。</p>
<h2 data-id="heading-8">DisposableEffect</h2>
<h3 data-id="heading-9">1、概括</h3>
<p>DisposableEffect(key) = 「进入时注册，离开时自动清理」的资源管理神器</p>
<h3 data-id="heading-10">2、核心机制</h3>





















<table><thead><tr><th>机制</th><th>说明</th></tr></thead><tbody><tr><td><strong>进入时执行</strong></td><td>Composable 进入组合时，执行 <code>effect</code> 块</td></tr><tr><td><strong>key 控制</strong></td><td><code>key</code> 变化 → <strong>先 <code>onDispose</code>，再重新注册</strong></td></tr><tr><td><strong>离开时自动清理</strong></td><td>离开页面 → <strong>自动调用 <code>onDispose</code></strong>，防止内存泄漏</td></tr></tbody></table>
<h3 data-id="heading-11">3、实际开发中场景</h3>
<ul>
<li>场景一：注册/注销广播接收器（最常见）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">NetworkChangeListener</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
    <span class="hljs-keyword">val</span> connectivityManager = remember { 
        context.getSystemService(Context.CONNECTIVITY_SERVICE) <span class="hljs-keyword">as</span> ConnectivityManager 
    }
    <span class="hljs-keyword">var</span> isConnected <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">true</span>) }

    DisposableEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">val</span> callback = <span class="hljs-keyword">object</span> : ConnectivityManager.NetworkCallback() {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAvailable</span><span class="hljs-params">(network: <span class="hljs-type">Network</span>)</span></span> {
                isConnected = <span class="hljs-literal">true</span>
            }
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLost</span><span class="hljs-params">(network: <span class="hljs-type">Network</span>)</span></span> {
                isConnected = <span class="hljs-literal">false</span>
            }
        }

        connectivityManager.registerDefaultNetworkCallback(callback)

        onDispose {
            connectivityManager.unregisterNetworkCallback(callback) <span class="hljs-comment">// 必须清理！</span>
        }
    }

    Card(
        colors = CardDefaults.cardColors(
            containerColor = <span class="hljs-keyword">if</span> (isConnected) Color.Green <span class="hljs-keyword">else</span> Color.Red
        )
    ) {
        Text(
            text = <span class="hljs-keyword">if</span> (isConnected) <span class="hljs-string">"在线"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"离线"</span>,
            color = Color.White,
            modifier = Modifier.padding(<span class="hljs-number">8.</span>dp)
        )
    }
}
</code></pre>
<p>代码核心：监听设备网络状态，断开网络显示离线，否则显示在线。</p>
<ul>
<li>场景二：添加移除传感器</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">StepCounter</span><span class="hljs-params">(sensorManager: <span class="hljs-type">SensorManager</span>)</span></span> {
    <span class="hljs-keyword">var</span> steps <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }

    DisposableEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">val</span> sensor = sensorManager.getDefaultSensor(Sensor.TYPE_STEP_COUNTER)
        <span class="hljs-keyword">val</span> listener = <span class="hljs-keyword">object</span> : SensorEventListener {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSensorChanged</span><span class="hljs-params">(event: <span class="hljs-type">SensorEvent</span>)</span></span> {
                steps = event.values[<span class="hljs-number">0</span>].toInt()
            }
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAccuracyChanged</span><span class="hljs-params">(sensor: <span class="hljs-type">Sensor</span>, accuracy: <span class="hljs-type">Int</span>)</span></span> {}
        }

        sensorManager.registerListener(listener, sensor, SensorManager.SENSOR_DELAY_UI)

        onDispose {
            sensorManager.unregisterListener(listener)
        }
    }

    Text(<span class="hljs-string">"今日步数: <span class="hljs-variable">$steps</span> 步"</span>, style = MaterialTheme.typography.headlineMedium)
}
</code></pre>
<p>代码核心：实时监测运动传感器，统计步数。</p>
<ul>
<li>场景三：订阅取消Flow(ViewModel 搭配使用)</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">FlowSubscription</span><span class="hljs-params">(viewModel: <span class="hljs-type">SideEffectsViewModel</span> = viewModel()</span></span>) {
    <span class="hljs-keyword">var</span> message <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">"等待消息..."</span>) }

    DisposableEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">val</span> job = viewModel.messageFlow
            .onEach { message = it }
            .launchIn(viewModel.viewModelScope)

        onDispose {
            job.cancel() <span class="hljs-comment">// 取消订阅</span>
        }
    }
    Column(modifier = Modifier.fillMaxSize()) {
        Button(onClick = {
            viewModel.sendMessage()
        }, modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
            Text(<span class="hljs-string">"点击发消息"</span>)
        }

        Text(message)
    }
}
</code></pre>
<p>代码核心：离开时，自动取消Flow</p>
<ul>
<li>场景四：key变化时，重置资源（如切换用户）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserSessionTracker</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
    DisposableEffect(userId) {
        LoginManager.login(userId)
        println(<span class="hljs-string">"用户 <span class="hljs-variable">$userId</span> 已登录"</span>)

        onDispose {
            LoginManager.logout()
            println(<span class="hljs-string">"用户已登出"</span>)
        }
    }

    Text(<span class="hljs-string">"当前用户: <span class="hljs-variable">$userId</span>"</span>)
}
</code></pre>
<p>代码核心：切换 userId → 自动登出旧用户，登录新用户</p>
<h3 data-id="heading-12">4、快速记忆</h3>
<p>进入注册 → key变化重置 → 离开自动清理 → 安全无泄漏</p>
<h3 data-id="heading-13">5、常见错误</h3>

























<table><thead><tr><th>错误</th><th>后果</th><th>正确</th></tr></thead><tbody><tr><td>忘记 <code>onDispose</code></td><td>内存泄漏</td><td>必须清理</td></tr><tr><td>用 <code>LaunchedEffect</code> 注册监听</td><td>无法手动清理</td><td>用 <code>DisposableEffect</code></td></tr><tr><td><code>key</code> 写错</td><td>重复注册</td><td>用稳定 key</td></tr></tbody></table>
<h3 data-id="heading-14">6、总结</h3>
<p>DisposableEffect 是 Compose 中「资源生命周期管理」的唯一正确方式， 掌握 onDispose + key，解决内存泄漏的问题</p>
<h2 data-id="heading-15">SideEffect</h2>
<h3 data-id="heading-16">1、一句话概括</h3>
<p>SideEffect = 「每次重组都执行一次」的轻量副作用，不自动取消，适合日志、埋点、同步非 Compose 状态</p>
<h3 data-id="heading-17">2、核心机制</h3>





















<table><thead><tr><th>机制</th><th>说明</th></tr></thead><tbody><tr><td><strong>每次重组都执行</strong></td><td>只要 UI 重组，<code>SideEffect</code> 就运行一次</td></tr><tr><td><strong>无 key 控制</strong></td><td>不支持 <code>key</code>，<strong>不能重启或取消</strong></td></tr><tr><td><strong>不自动清理</strong></td><td>离开页面不会自动取消，<strong>需手动控制</strong></td></tr></tbody></table>
<h3 data-id="heading-18">3、实际开发中的四大场景</h3>
<ul>
<li>场景一：页面曝光埋点（常见）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">AnalyticsScreen</span><span class="hljs-params">(screenName: <span class="hljs-type">String</span>)</span></span> {
    SideEffect {
        Analytics.logScreenView(screenName)  <span class="hljs-comment">// 每次重组都上报</span>
        Log.i(<span class="hljs-string">"compose 曝光"</span>,<span class="hljs-string">"曝光: <span class="hljs-variable">$screenName</span>"</span>)
    }

    Text(<span class="hljs-string">"当前页面: <span class="hljs-variable">$screenName</span>"</span>)
}
</code></pre>
<ul>
<li>场景二：日志输出及调试</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DebugRecomposition</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }

    SideEffect {
        Log.d(<span class="hljs-string">"compose日志"</span>,<span class="hljs-string">"重组发生了！count = <span class="hljs-variable">$count</span>"</span>)
    }

    Column {
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
        Button(onClick = { count++ }) { Text(<span class="hljs-string">"加1"</span>) }
    }
}
</code></pre>
<ul>
<li>场景三：同步或发送数据到外部（如SharedPreferences、EventBus、ViewModel）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SyncTheme</span><span class="hljs-params">(isDark: <span class="hljs-type">Boolean</span>)</span></span> {
    <span class="hljs-keyword">val</span> prefs = LocalContext.current.getSharedPreferences(<span class="hljs-string">"settings"</span>, Context.MODE_PRIVATE)
    SideEffect {
        prefs.edit().putBoolean(<span class="hljs-string">"dark_mode"</span>, isDark).apply()
        Log.d(<span class="hljs-string">"compose 日志"</span>, <span class="hljs-string">"主题已保存: <span class="hljs-subst">${if (isDark) <span class="hljs-string">"深色"</span> else <span class="hljs-string">"浅色"</span>}</span>"</span>)
        EventBus.post(isDark)
    }

    <span class="hljs-comment">// UI...</span>
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BrightnessControl</span><span class="hljs-params">(viewModel: <span class="hljs-type">SideEffectsViewModel</span> = viewModel()</span></span>) {
    <span class="hljs-keyword">var</span> brightness <span class="hljs-keyword">by</span> remember { mutableFloatStateOf(<span class="hljs-number">0.5f</span>) }

    <span class="hljs-comment">// 每次 brightness 改变并重组完成后，同步到 ViewModel</span>
    SideEffect {
        viewModel.currentBrightness = brightness
    }

    Column(horizontalAlignment = Alignment.CenterHorizontally) {
        Text(<span class="hljs-string">"当前亮度: <span class="hljs-subst">${(brightness * <span class="hljs-number">100</span>).toInt()}</span>%"</span>)
        Slider(value = brightness, onValueChange = { brightness = it })
    }
}
</code></pre>
<p>核心：每次切换主题 → 自动保存到本地，并通知其他页面</p>
<ul>
<li>场景四：与非 Compose 组件通信（如 TextureView）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CameraPreview</span><span class="hljs-params">(textureView: <span class="hljs-type">TextureView</span>)</span></span> {
    SideEffect {
        CameraManager.bind(textureView.surfaceTexture)
    }

    AndroidView(factory = { textureView })
}
</code></pre>
<h3 data-id="heading-19">4、快速记忆</h3>
<p>重组就跑，轻量选它，日志埋点，首选SideEffect。</p>
<h3 data-id="heading-20">5、常见错误</h3>

























<table><thead><tr><th>错误</th><th>后果</th><th>正确</th></tr></thead><tbody><tr><td>放网络请求</td><td>每次重组都请求</td><td>用 <code>LaunchedEffect</code></td></tr><tr><td>放耗时操作(非轻量)</td><td>卡 UI</td><td>用 <code>withContext(IO)</code> + <code>LaunchedEffect</code></td></tr><tr><td>期望只执行一次</td><td>不会</td><td>用 <code>LaunchedEffect(Unit)</code></td></tr></tbody></table>
<p>总结：每次重组都会执行。注意：<code>SideEffect</code> 是在 <strong>重组完成后立即执行</strong>，没有协程。而 <code>LaunchedEffect</code> 是在进入组合时启动协程。</p>
<h2 data-id="heading-21">rememberCoroutineScope</h2>
<h3 data-id="heading-22">1、一句话概括：</h3>
<p>rememberCoroutineScope() = 「<strong>手动、可控、生命周期安全</strong>」的协程作用域，<strong>重组不重启，离开页面自动取消</strong>。</p>
<h3 data-id="heading-23">2、核心机制</h3>





















<table><thead><tr><th>机制</th><th>说明</th></tr></thead><tbody><tr><td><strong>手动启动</strong></td><td>必须 <code>scope.launch { }</code> 才执行</td></tr><tr><td><strong>重组不影响</strong></td><td>重组时 <strong>同一个 scope</strong>，不会重新创建</td></tr><tr><td><strong>自动取消</strong></td><td>离开页面 → <strong>自动 <code>cancel()</code></strong> ，所有协程停止</td></tr></tbody></table>
<h3 data-id="heading-24">3、常用场景</h3>
<ul>
<li>场景一：异步操作（如文件保存，最常见）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SaveButton</span><span class="hljs-params">(viewModel: <span class="hljs-type">SaveViewModel</span>)</span></span> {
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    <span class="hljs-keyword">var</span> saving <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }

    Button(
        enabled = !saving,
        onClick = {
            saving = <span class="hljs-literal">true</span>
            scope.launch {
                <span class="hljs-keyword">try</span> {
                    viewModel.saveData()  <span class="hljs-comment">// 模拟文件保存</span>
                } <span class="hljs-keyword">finally</span> {
                    saving = <span class="hljs-literal">false</span>  <span class="hljs-comment">// 发送错误时，重置UI</span>
                }
            }
        }
    ) {
        Text(<span class="hljs-keyword">if</span> (saving) <span class="hljs-string">"保存中..."</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"保存"</span>)
    }
}
</code></pre>
<p>场景二：定时任务</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">TimerWithCoroutineScope</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableIntStateOf(<span class="hljs-number">0</span>) }
    
    Button(onClick = {
        scope.launch {
            repeat(<span class="hljs-number">10</span>) {
                delay(<span class="hljs-number">1000</span>)
                count++
            }
        }
    }) {
        Text(<span class="hljs-string">"开始定时任务"</span>)
    }
    
    Text(<span class="hljs-string">"计数: <span class="hljs-variable">$count</span>"</span>)
}
</code></pre>
<p>场景三：批量处理</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BatchProcess</span><span class="hljs-params">(items: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    <span class="hljs-keyword">var</span> progress <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }

    Button(onClick = {
        scope.launch {
            items.forEachIndexed { index, item -&gt;
                processItem(item)
                progress = index + <span class="hljs-number">1</span>
            }
        }
    }) {
        Text(<span class="hljs-string">"处理 <span class="hljs-subst">${items.size}</span> 项"</span>)
    }
    LinearProgressIndicator(progress = progress / items.size.toFloat())
}
</code></pre>
<ul>
<li>场景四：与Snackbar搭配（Material3 常见用法）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@OptIn(ExperimentalMaterial3Api::class)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SnackbarExample</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> snackbarHostState = remember { SnackbarHostState() }
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()

    Scaffold(
        snackbarHost = { SnackbarHost(snackbarHostState) },
        floatingActionButton = {
            FloatingActionButton(onClick = {
                scope.launch {
                    snackbarHostState.showSnackbar(<span class="hljs-string">"Hello Snackbar!"</span>)
                }
            }) {
                Text(<span class="hljs-string">"点我"</span>)
            }
        }
    ) { padding -&gt;
        Box(Modifier.fillMaxSize().padding(padding), contentAlignment = Alignment.Center) {
            Text(<span class="hljs-string">"点击右下角按钮显示 Snackbar"</span>)
        }
    }
}

</code></pre>
<h3 data-id="heading-25">4、快速记忆</h3>
<p>rememberCoroutineScope → 手动 launch → 自动取消 → 重组不重启<br/>
它与 <code>LaunchedEffect</code> 最大的区别是：<strong>需要事件触发</strong> 而不是自动执行。</p>
<h3 data-id="heading-26">5、常见错误</h3>

























<table><thead><tr><th>错误</th><th>后果</th><th>正确</th></tr></thead><tbody><tr><td>用 <code>LaunchedEffect</code> 放点击</td><td>每次重组都弹</td><td>用 <code>scope.launch</code></td></tr><tr><td>不用 <code>remember</code></td><td>每次重组新 scope</td><td>必须 <code>rememberCoroutineScope()</code></td></tr><tr><td>用 <code>GlobalScope</code></td><td>无法取消</td><td>禁止使用！</td></tr></tbody></table>
<h3 data-id="heading-27">6、总结</h3>
<p>rememberCoroutineScope 是 Compose 中「用户交互 → 异步操作」的最佳实践，需要手动启动协程，首选选他。</p>
<h2 data-id="heading-28">ProduceState</h2>
<h3 data-id="heading-29">1、一句话概括</h3>
<p>produceState = 「外部数据源 转化为 Compose State」的桥梁，自动协程 + 自动取消 + 支持 key</p>
<h3 data-id="heading-30">2、核心机制</h3>

























<table><thead><tr><th>机制</th><th>说明</th></tr></thead><tbody><tr><td><strong>协程生产 State</strong></td><td>在协程中 <code>value = xxx</code> → 自动触发 UI 重组</td></tr><tr><td><strong>自动生命周期</strong></td><td>进入 → 启动协程；离开 → 自动取消</td></tr><tr><td><strong>key 控制重启</strong></td><td><code>key</code> 变 → 取消旧协程，启动新协程</td></tr><tr><td>其更像是collectAsState()的增强版本，支持任意数据源，而collectAsState则只能来源于Flow。</td><td/></tr></tbody></table>
<h3 data-id="heading-31">常用场景</h3>
<ul>
<li>场景一：请求网络数据(最常见)</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserInfo</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-keyword">val</span> user <span class="hljs-keyword">by</span> produceState&lt;User?&gt;(initialValue = <span class="hljs-literal">null</span>, userId) {
        value = withContext(Dispatchers.IO) {
            RetrofitClient.apiService.getUsersById(userId)  <span class="hljs-comment">//根据userId获取用户数据</span>
        }
    }

    <span class="hljs-keyword">when</span> (user) {
        <span class="hljs-literal">null</span> -&gt; CircularProgressIndicator()
        <span class="hljs-keyword">else</span> -&gt; Text(<span class="hljs-string">"欢迎，<span class="hljs-subst">${user!!.name}</span>"</span>)
    }
}
</code></pre>
<ul>
<li>场景二：Flow -&gt; State（较常见），替代collectAsState</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SideEffectsViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _count = MutableStateFlow(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">val</span> countFlow = _count.asStateFlow()
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span></span> = _count.value++
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">FlowCounter</span><span class="hljs-params">(viewModel: <span class="hljs-type">SideEffectsViewModel</span> = viewModel()</span></span>) {
    <span class="hljs-comment">//原写法</span>
    <span class="hljs-comment">// val count by viewModel.collectAsState()</span>
    <span class="hljs-keyword">val</span> count <span class="hljs-keyword">by</span> produceState(initialValue = <span class="hljs-number">0</span>) {
        viewModel.countFlow.collect { value = it }
    }

    Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
}
</code></pre>
<ul>
<li>场景三：回调函数-&gt; State</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LocationNow</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, locationManager: <span class="hljs-type">LocationManager</span>)</span></span> {
    <span class="hljs-keyword">val</span> location <span class="hljs-keyword">by</span> produceState&lt;String?&gt;(initialValue = <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">val</span> listener = LocationListener { location -&gt; value = <span class="hljs-string">"经度: <span class="hljs-subst">${location.longitude}</span>, 纬度: <span class="hljs-subst">${location.latitude}</span>"</span> }
        <span class="hljs-comment">//权限检查代码省略</span>
        locationManager.requestLocationUpdates(
            LocationManager.GPS_PROVIDER,
            <span class="hljs-number">2000L</span>,
            <span class="hljs-number">1f</span>,
            listener)

        awaitDispose {
            locationManager.removeUpdates(listener)
        }
    }
    
    <span class="hljs-keyword">if</span> (location == <span class="hljs-literal">null</span>) {
        Text(<span class="hljs-string">"正在获取位置..."</span>)
    } <span class="hljs-keyword">else</span> {
        Text(<span class="hljs-string">"location"</span>)
    }
}
</code></pre>
<ul>
<li>场景四：状态处理</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-keyword">object</span> Loading : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : Result&lt;T&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">loadData</span><span class="hljs-params">(
    key: <span class="hljs-type">Any</span>?,
    block: <span class="hljs-type">suspend</span> () -&gt; <span class="hljs-type">T</span>
)</span></span>: State&lt;Result&lt;T&gt;&gt; = produceState&lt;Result&lt;T&gt;&gt;(Result.Loading, key) {
    <span class="hljs-keyword">try</span> {
        value = Result.Success(block())
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        value = Result.Error(e.message ?: <span class="hljs-string">"未知错误"</span>)
    }
}
</code></pre>
<h3 data-id="heading-32">4、快速记忆</h3>
<p>生产 State → 协程运行 → 自动取消 → key 控制重启</p>
<h3 data-id="heading-33">5、常见错误</h3>

























<table><thead><tr><th>错误</th><th>后果</th><th>正确</th></tr></thead><tbody><tr><td>不用 <code>withContext(IO)</code></td><td>阻塞 UI</td><td>必须切线程</td></tr><tr><td>忘记 <code>key</code></td><td>数据不更新</td><td>加依赖参数</td></tr><tr><td>返回 <code>State</code></td><td>编译错误</td><td>必须 <code>by produceState</code></td></tr></tbody></table>
<h3 data-id="heading-34">6、相似对比</h3>

























<table><thead><tr><th>项目</th><th><code>produceState</code></th><th><code>collectAsState()</code></th></tr></thead><tbody><tr><td>数据源</td><td>任意</td><td>仅 Flow</td></tr><tr><td>支持 key</td><td>Yes</td><td>No</td></tr><tr><td>自动取消</td><td>Yes</td><td>Yes</td></tr></tbody></table>
<h3 data-id="heading-35">7.总结：</h3>
<p>produceState 是 Compose 中【外部数据源 -&gt; State】的最好桥梁， 熟悉它，你就能实现任意数据源驱动UI变化了。</p>
<h2 data-id="heading-36">derivedStateOf</h2>
<p>有人把这个归于副作用函数之类，但我个人觉得不是。原因如下：</p>
<ul>
<li>纯函数计算：基于其他状态计算的派送状态，不产生任何外部影响</li>
<li>无外部交互：不执行I/O操作，不启动异步任务、不修改外部状态</li>
<li>不直接参与UI更新：虽然在 Composable 中触发，但只是影响 UI 的“外部世界”</li>
</ul>
<h3 data-id="heading-37">1、一句话概括：</h3>
<p>derivedStateOf { } = 「只有当结果真正变化时才触发重组」，避免重复计算 + 减少 UI 闪烁</p>
<h3 data-id="heading-38">2、为什么需要derivedStateOf？</h3>
<p>问题：频繁重组导致性能拉胯</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserFilter</span><span class="hljs-params">(nameItems: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;, query: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">val</span> filtered = nameItems.filter { it.contains(query) }  <span class="hljs-comment">// 每次重组都过滤！</span>

    LazyColumn {
        nameItems(filtered) { Text(it) }
    }
}
</code></pre>
<p>这段代码你会发现query 变 → 重组 → <strong>每次都重新 filter</strong>。 即使结果没变，也会触发 LazyColumn 重绘 → <strong>性能差 + 闪烁</strong>。<br/>
相关改进参考场景一</p>
<h3 data-id="heading-39">3、常用场景</h3>
<ul>
<li>场景一：搜索过滤</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SearchStr</span><span class="hljs-params">(nameItems: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;, query: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 使用 derivedStateOf 只在 query 或 nameItems 变化时重新计算</span>
    <span class="hljs-keyword">var</span> searchQuery <span class="hljs-keyword">by</span> remember { mutableStateOf(query) }
    <span class="hljs-keyword">val</span> filteredItems <span class="hljs-keyword">by</span> derivedStateOf {
        nameItems.filter { it.contains(searchQuery, ignoreCase = <span class="hljs-literal">true</span>) }
    }
    Column {
        TextField(value = searchQuery,
            onValueChange = { searchQuery = it },
            label = { Text(<span class="hljs-string">"搜索"</span>) })
        LazyColumn {
            items(filteredItems) { item -&gt;
                Text(item)
            }
        }
    }
}
</code></pre>
<p>代码核心：快速输入时 → 只有结果变了才更新列表，降低了重组次数</p>
<ul>
<li>场景二：分页加载判断</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">InfiniteList</span><span class="hljs-params">(items: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;, onLoadMore: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> listState = rememberLazyListState()
    
    <span class="hljs-comment">// 只有到达底部时才触发</span>
    <span class="hljs-keyword">val</span> shouldLoadMore <span class="hljs-keyword">by</span> derivedStateOf {
        <span class="hljs-keyword">val</span> lastVisible = listState.layoutInfo.visibleItemsInfo.lastOrNull()?.index ?: <span class="hljs-number">0</span>
        lastVisible &gt;= items.size - <span class="hljs-number">2</span>
    }

    LaunchedEffect(shouldLoadMore) {
        <span class="hljs-keyword">if</span> (shouldLoadMore) onLoadMore()
    }

    LazyColumn(state = listState) {
        items(items) { Text(it) }
    }
}
</code></pre>
<p>代码核心：计算是否距离底部还有两个Item，是的话触发加载下一页回调操作。</p>
<ul>
<li>场景三：关联数据或状态实时计算（常见用途）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span>  <span class="hljs-title">SumAndAvg</span><span class="hljs-params">(numbers: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Int</span>&gt;)</span></span> {
    <span class="hljs-keyword">val</span> sum <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            numbers.sum()
        }
    }
    <span class="hljs-keyword">val</span> avg <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            numbers.average()
        }
    }

    Card {
        Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
            Text(<span class="hljs-string">"总和: <span class="hljs-variable">$sum</span>"</span>)
            Text(<span class="hljs-string">"平均: %.2f"</span>.format(avg))
            Text(<span class="hljs-string">"Numbers 总数: <span class="hljs-subst">${numbers.size}</span>"</span>)
        }
    }
}
</code></pre>
<p>-场景四：控件显示状态判断 （常见）</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">TopButtonShow</span><span class="hljs-params">(listState: <span class="hljs-type">LazyListState</span>)</span></span> {
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    <span class="hljs-keyword">val</span> showButton <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            listState.firstVisibleItemIndex &gt; <span class="hljs-number">0</span>
        }
    }

    AnimatedVisibility(showButton) {
        FloatingActionButton(onClick = {
            <span class="hljs-comment">// 回到顶部</span>
            scope.launch { 
                listState.animateScrollToItem(<span class="hljs-number">0</span>)
            }
        }, modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
            Icon(Icons.Default.KeyboardArrowUp, contentDescription = <span class="hljs-string">"回到顶部"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-40">4、快速记忆</h3>
<p>数据派生 -&gt; 重组少 -&gt; 性能优 -&gt; 体验棒</p>
<h3 data-id="heading-41">5、常见错误</h3>

























<table><thead><tr><th>错误</th><th>后果</th><th>正确</th></tr></thead><tbody><tr><td>不用 <code>derivedStateOf</code></td><td>频繁重组</td><td>必须用</td></tr><tr><td>放 <code>LaunchedEffect</code></td><td>无法驱动 UI</td><td>用 <code>by derivedStateOf</code></td></tr><tr><td>计算太重</td><td>卡 UI</td><td>移到 IO 线程</td></tr></tbody></table>
<h3 data-id="heading-42">6、总结</h3>
<p>derivedStateOf 是 Compose 中「计算优化 + 防闪烁」的最优解之一，掌握它能让你的UI更流畅。</p>
<h2 data-id="heading-43">rememberUpdatedState</h2>
<p>我同样认为这不属于副作用函数，理由与derivedStateOf类似。但它与副作用LaunchedEffect函数配合紧密，所以一起介绍了。其实这里面涉及到一个<code>闭包</code>的概念。这里面就不展开讲，不了解的小伙伴去问AI吧。</p>
<h3 data-id="heading-44">1、一句话概括</h3>
<p>rememberUpdatedState(value) = 「让 LaunchedEffect 里的协程，始终拿到最新的值」，即使它在重组时被捕获了旧值。</p>
<h3 data-id="heading-45">2、解决了什么问题</h3>
<p>先看问题代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">GreetingMessage</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 启动一个协程，每隔2秒打印一次 message</span>
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            delay(<span class="hljs-number">2000</span>)
            Log.d(<span class="hljs-string">"message的值"</span>，<span class="hljs-string">"当前 message: <span class="hljs-variable">$message</span>"</span>)  <span class="hljs-comment">//  闭包捕获旧值</span>
        }
    }
}
</code></pre>
<p>存在的问题：当 <code>message</code> 改变时，<code>LaunchedEffect(Unit)</code> 不会重启，因为key未发生变化；
因此协程里打印的仍然是“第一次 Composition”时的旧值； 这就叫「<strong>stale capture（过期捕获）</strong> 」。</p>
<p>解决方案：使用rememberUpdatedState进行修正</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UpdateNewMessage</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 让协程中总能访问最新 message</span>
    <span class="hljs-keyword">val</span> currentMessage <span class="hljs-keyword">by</span> rememberUpdatedState(message)

    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            delay(<span class="hljs-number">2000</span>)
            println(<span class="hljs-string">"当前 message: <span class="hljs-variable">$currentMessage</span>"</span>)  <span class="hljs-comment">// ✅ 始终是最新值</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-46">3、应用场景</h3>
<ul>
<li>场景一：防抖（推荐此方式实现Compose的防抖）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DebouncedSearch</span><span class="hljs-params">(
    query: <span class="hljs-type">String</span>,
    onDebouncedQueryChange: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    <span class="hljs-keyword">var</span> searchQuery <span class="hljs-keyword">by</span> remember { mutableStateOf(query) }
    <span class="hljs-keyword">val</span> currentOnDebouncedQueryChange <span class="hljs-keyword">by</span> rememberUpdatedState(onDebouncedQueryChange)

    LaunchedEffect(searchQuery) {
        delay(<span class="hljs-number">300</span>) <span class="hljs-comment">// 300ms 防抖延迟</span>
        <span class="hljs-keyword">if</span>(searchQuery.isNotBlank()) {
            currentOnDebouncedQueryChange(query)
        }

    }
    TextField( value = searchQuery,
        onValueChange = { searchQuery = it },
        label = { Text(<span class="hljs-string">"搜索"</span>) } )
}
</code></pre>
<ul>
<li>场景二：事件监听中保持回调更新（最常见）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LocationChange</span><span class="hljs-params">(onLocationUpdate: (<span class="hljs-type">Location</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> currentCallback <span class="hljs-keyword">by</span> rememberUpdatedState(onLocationUpdate)
    
    DisposableEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">val</span> listener = LocationListener { location -&gt;
            currentCallback(location) <span class="hljs-comment">// 使用最新的回调</span>
        }
        
        locationManager.requestLocationUpdates(listener)
        
        onDispose {
            locationManager.removeUpdates(listener)
        }
    }
}
</code></pre>
<p>代码核心：时刻保持最新的回调，解决持有旧回调的问题</p>
<ul>
<li>场景三：定时器动态轮询（根据情况调整轮询时间）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 每次调用调整轮询间隔，不触发重启
 */</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">PollingData</span><span class="hljs-params">(intervalMs: <span class="hljs-type">Long</span>)</span></span> {
    <span class="hljs-keyword">val</span> updatedInterval <span class="hljs-keyword">by</span> rememberUpdatedState(intervalMs)
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">"加载中..."</span>) }

    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">data</span> = withContext(Dispatchers.IO) {
                RetrofitClient.apiService.getUsersById(<span class="hljs-number">1</span>).toString()
            }
            delay(updatedInterval)  <span class="hljs-comment">// 动态间隔</span>
        }
    }

    Column {
        Text(<span class="hljs-string">"数据: <span class="hljs-variable">$data</span>"</span>)
        Text(<span class="hljs-string">"轮询间隔: <span class="hljs-variable">$updatedInterval</span> ms"</span>)
    }
}
</code></pre>
<ul>
<li>场景四：延迟提示（优化部分情况下，控件多次显示隐藏导致的闪烁）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DelayedTooltip</span><span class="hljs-params">(visible: <span class="hljs-type">Boolean</span>, text: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">val</span> updatedVisible <span class="hljs-keyword">by</span> rememberUpdatedState(visible)

    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        delay(<span class="hljs-number">1000</span>)  <span class="hljs-comment">// 延迟显示</span>
        <span class="hljs-keyword">if</span> (updatedVisible) {
            showTooltip(text)
        }
    }

    <span class="hljs-comment">// UI...</span>
}
</code></pre>
<h3 data-id="heading-47">4、快速记忆</h3>
<p>协程不重启，值要最新值，那就使用UpdatedState<br/>
<code>LaunchedEffect(Unit)</code> + <code>rememberUpdatedState(value)</code> = 不重启协程也能拿到最新值</p>
<h3 data-id="heading-48">5、常犯错误</h3>

























<table><thead><tr><th>错误</th><th>后果</th><th>正确</th></tr></thead><tbody><tr><td>不用 <code>rememberUpdatedState</code></td><td>协程用旧值</td><td>必须用</td></tr><tr><td>配合 <code>LaunchedEffect(value)</code></td><td>频繁重启</td><td>用 <code>Unit</code></td></tr><tr><td>放 <code>SideEffect</code></td><td>每次重组都执行</td><td>错！</td></tr></tbody></table>
<h3 data-id="heading-49">六、总结</h3>
<p>rememberUpdatedState 是 Compose 中「协程 + 动态参数」的黄金搭档，经常与LaunchedEffect(Unit)搭配实现多场景功能。</p>
<h2 data-id="heading-50">总结：</h2>
<p>Compose 的副作用函数本质是：<strong>在声明式UI中执行命令式逻辑的入口</strong>。<br/>
<code>LaunchedEffect</code>、<code>DisposableEffect</code>、<code>SideEffect</code> 解决不同生命周期阶段的副作用；<br/>
而 <code>rememberCoroutineScope</code>、<code>produceState</code>、<code>derivedStateOf</code>、<code>rememberUpdatedState</code> 则是围绕状态、协程与性能优化的工具。理解它们的生命周期、触发时机与取消机制，是写好 Compose 的关键。<br/>
本文只列出了我能想到的一些场景，肯定有很多的遗漏，还是需要大家在使用中去完善了解</p>
<p>各副作用函数机制速查表：</p>






















































































<table><thead><tr><th>函数</th><th>启动时机</th><th>重组触发</th><th>自动取消（随生命周期销毁）</th><th>常见用途</th><th>是否可持久运行（如轮询）</th><th>是否依赖 key</th></tr></thead><tbody><tr><td><strong><code>SideEffect</code></strong></td><td>每次成功重组后执行</td><td>✅ 每次重组都会执行</td><td>❌ 不会自动取消</td><td>把 Compose 状态同步到非 Compose 系统（如 Log、ViewModel 状态等）</td><td>❌</td><td>否</td></tr><tr><td><strong><code>LaunchedEffect(key)</code></strong></td><td>进入 Composition 时执行一次</td><td>✅ key 变化会重启协程</td><td>✅ key 改变或退出 Composition 时自动取消</td><td>执行一次性任务、启动协程、监听 Flow</td><td>✅</td><td>是</td></tr><tr><td><strong><code>DisposableEffect(key)</code></strong></td><td>进入 Composition 时执行一次</td><td>✅ key 变化或离开 Composition 时触发 onDispose</td><td>✅ 自动触发 onDispose</td><td>注册/注销监听、启动/停止外部资源</td><td>✅</td><td>是</td></tr><tr><td><strong><code>rememberCoroutineScope()</code></strong></td><td>组合时创建一个可记忆的协程作用域</td><td>❌ 不会因重组重新创建</td><td>✅ Composition 离开时自动取消</td><td>需要在回调中手动启动协程（如按钮点击）</td><td>✅</td><td>否</td></tr><tr><td><strong><code>produceState()</code></strong></td><td>进入 Composition 时启动协程</td><td>✅ key 变化会重启生产逻辑</td><td>✅ 自动取消旧协程</td><td>把异步任务结果转为 State（如网络请求）</td><td>✅</td><td>是</td></tr><tr><td><strong><code>derivedStateOf()</code></strong></td><td>依赖 State 变化时计算</td><td>✅ 依赖的值变化才重新计算</td><td>❌（纯计算，此处无意义）</td><td>优化计算型状态，避免不必要重组</td><td>❌</td><td>否</td></tr><tr><td><strong><code>rememberUpdatedState()</code></strong></td><td>每次重组更新内部值</td><td>❌ 不会导致重组</td><td>❌</td><td>让长期副作用中访问最新参数（如协程/回调）</td><td>✅</td><td>否</td></tr><tr><td><strong><code>snapshotFlow { }</code></strong></td><td>在协程中把 State 转换为 Flow</td><td>✅ State 变化时发射新值</td><td>✅ 协程取消即停止</td><td>响应式收集 State 变化</td><td>✅</td><td>否</td></tr></tbody></table>
<h2 data-id="heading-51">源码</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftcyang123456%2FTestCompose.git" target="_blank" title="https://github.com/tcyang123456/TestCompose.git" ref="nofollow noopener noreferrer">github.com/tcyang12345…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Root-> A ->B -> C page, 当前C page, 如何返回B，又如何直接返回A page呢]]></title>    <link>https://juejin.cn/post/7571304204754042934</link>    <guid>https://juejin.cn/post/7571304204754042934</guid>    <pubDate>2025-11-11T10:12:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204754042934" data-draft-id="7571105461099233323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Root-&gt; A -&gt;B -&gt; C page, 当前C page, 如何返回B，又如何直接返回A page呢"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T10:12:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="littleplayer"/> <meta itemprop="url" content="https://juejin.cn/user/1926000099198813"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Root-&gt; A -&gt;B -&gt; C page, 当前C page, 如何返回B，又如何直接返回A page呢
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1926000099198813/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    littleplayer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:12:57.000Z" title="Tue Nov 11 2025 10:12:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 SwiftUI 中，从 C 页面返回到 B 或直接返回到 A 页面有多种方式。以下是具体的实现方法：</p>
<h2 data-id="heading-0">1. 使用 NavigationStack 和 NavigationPath</h2>
<h3 data-id="heading-1">基本设置</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Route</span>: <span class="hljs-title class_">Hashable</span> {
    <span class="hljs-keyword">case</span> a
    <span class="hljs-keyword">case</span> b
    <span class="hljs-keyword">case</span> c
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navigationPath <span class="hljs-operator">=</span> <span class="hljs-type">NavigationPath</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span>(path: <span class="hljs-variable">$navigationPath</span>) {
            <span class="hljs-type">AView</span>()
                .navigationDestination(for: <span class="hljs-type">Route</span>.<span class="hljs-keyword">self</span>) { route <span class="hljs-keyword">in</span>
                    <span class="hljs-keyword">switch</span> route {
                    <span class="hljs-keyword">case</span> .a:
                        <span class="hljs-type">AView</span>()
                    <span class="hljs-keyword">case</span> .b:
                        <span class="hljs-type">BView</span>()
                    <span class="hljs-keyword">case</span> .c:
                        <span class="hljs-type">CView</span>()
                    }
                }
        }
        .environment(\.navigationPath, <span class="hljs-variable">$navigationPath</span>)
    }
}
</code></pre>
<h2 data-id="heading-2">2. 从 C 返回 B，或直接返回 A</h2>
<h3 data-id="heading-3">使用环境变量传递导航控制</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 定义环境Key</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">NavigationPathKey</span>: <span class="hljs-title class_">EnvironmentKey</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> defaultValue: <span class="hljs-type">Binding</span>&lt;<span class="hljs-type">NavigationPath</span>&gt;? <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">EnvironmentValues</span> {
    <span class="hljs-keyword">var</span> navigationPath: <span class="hljs-type">Binding</span>&lt;<span class="hljs-type">NavigationPath</span>&gt;? {
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">self</span>[<span class="hljs-type">NavigationPathKey</span>.<span class="hljs-keyword">self</span>] }
        <span class="hljs-keyword">set</span> { <span class="hljs-keyword">self</span>[<span class="hljs-type">NavigationPathKey</span>.<span class="hljs-keyword">self</span>] <span class="hljs-operator">=</span> newValue }
    }
}

<span class="hljs-comment">// A 页面</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">AView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Environment</span>(\.navigationPath) <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navigationPath
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"A 页面"</span>)
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"前往 B 页面"</span>) {
                navigationPath<span class="hljs-operator">?</span>.wrappedValue.append(<span class="hljs-type">Route</span>.b)
            }
            .padding()
        }
        .navigationTitle(<span class="hljs-string">"A 页面"</span>)
    }
}

<span class="hljs-comment">// B 页面</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">BView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Environment</span>(\.navigationPath) <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navigationPath
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"B 页面"</span>)
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"前往 C 页面"</span>) {
                navigationPath<span class="hljs-operator">?</span>.wrappedValue.append(<span class="hljs-type">Route</span>.c)
            }
            .padding()
        }
        .navigationTitle(<span class="hljs-string">"B 页面"</span>)
    }
}

<span class="hljs-comment">// C 页面 - 关键部分</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">CView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Environment</span>(\.navigationPath) <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navigationPath
    <span class="hljs-meta">@Environment</span>(\.dismiss) <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dismiss
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">20</span>) {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"C 页面"</span>)
            
            <span class="hljs-comment">// 方法1: 返回上一页 (B)</span>
            <span class="hljs-type">Button</span>(<span class="hljs-string">"返回上一页 (B)"</span>) {
                dismiss() <span class="hljs-comment">// 或者 navigationPath?.wrappedValue.removeLast()</span>
            }
            
            <span class="hljs-comment">// 方法2: 直接返回 A 页面</span>
            <span class="hljs-type">Button</span>(<span class="hljs-string">"直接返回 A 页面"</span>) {
                <span class="hljs-comment">// 移除最后2个页面 (C 和 B)</span>
                navigationPath<span class="hljs-operator">?</span>.wrappedValue.removeLast(<span class="hljs-number">2</span>)
            }
            
            <span class="hljs-comment">// 方法3: 返回根页面 (A)</span>
            <span class="hljs-type">Button</span>(<span class="hljs-string">"返回根页面 (A)"</span>) {
                <span class="hljs-comment">// 移除所有页面，回到根</span>
                navigationPath<span class="hljs-operator">?</span>.wrappedValue.removeLast(navigationPath<span class="hljs-operator">?</span>.wrappedValue.count <span class="hljs-operator">??</span> <span class="hljs-number">0</span>)
            }
            
            <span class="hljs-comment">// 方法4: 特定路径跳转</span>
            <span class="hljs-type">Button</span>(<span class="hljs-string">"跳转到 A 页面"</span>) {
                <span class="hljs-comment">// 清空路径，然后添加 A</span>
                navigationPath<span class="hljs-operator">?</span>.wrappedValue <span class="hljs-operator">=</span> <span class="hljs-type">NavigationPath</span>()
                navigationPath<span class="hljs-operator">?</span>.wrappedValue.append(<span class="hljs-type">Route</span>.a)
            }
        }
        .navigationTitle(<span class="hljs-string">"C 页面"</span>)
    }
}
</code></pre>
<h2 data-id="heading-4">3. 使用导航管理器 (推荐)</h2>
<h3 data-id="heading-5">创建导航管理器</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NavigationManager</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> path <span class="hljs-operator">=</span> <span class="hljs-type">NavigationPath</span>()
    
    <span class="hljs-comment">// 返回上一页</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">goBack</span>() {
        <span class="hljs-keyword">guard</span> <span class="hljs-operator">!</span>path.isEmpty <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
        path.removeLast()
    }
    
    <span class="hljs-comment">// 返回到特定页面</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">goBackToA</span>() {
        <span class="hljs-comment">// 假设路径是 [B, C]，移除最后2个</span>
        <span class="hljs-keyword">if</span> path.count <span class="hljs-operator">&gt;=</span> <span class="hljs-number">2</span> {
            path.removeLast(<span class="hljs-number">2</span>)
        }
    }
    
    <span class="hljs-comment">// 返回到根页面</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">goToRoot</span>() {
        path.removeLast(path.count)
    }
    
    <span class="hljs-comment">// 导航到特定页面</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">navigateTo</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">route</span>: <span class="hljs-type">Route</span>) {
        path.append(route)
    }
}
</code></pre>
<h3 data-id="heading-6">在视图中使用</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AppView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navManager <span class="hljs-operator">=</span> <span class="hljs-type">NavigationManager</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span>(path: <span class="hljs-variable">$navManager</span>.path) {
            <span class="hljs-type">AView</span>()
                .navigationDestination(for: <span class="hljs-type">Route</span>.<span class="hljs-keyword">self</span>) { route <span class="hljs-keyword">in</span>
                    <span class="hljs-keyword">switch</span> route {
                    <span class="hljs-keyword">case</span> .a: <span class="hljs-type">AView</span>()
                    <span class="hljs-keyword">case</span> .b: <span class="hljs-type">BView</span>()
                    <span class="hljs-keyword">case</span> .c: <span class="hljs-type">CView</span>()
                    }
                }
        }
        .environmentObject(navManager)
    }
}

<span class="hljs-comment">// C 页面使用导航管理器</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">CView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@EnvironmentObject</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navManager: <span class="hljs-type">NavigationManager</span>
    <span class="hljs-meta">@Environment</span>(\.dismiss) <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dismiss
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">20</span>) {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"C 页面"</span>)
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"返回上一页 (B)"</span>) {
                navManager.goBack()
            }
            .buttonStyle(.bordered)
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"直接返回 A 页面"</span>) {
                navManager.goBackToA()
            }
            .buttonStyle(.borderedProminent)
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"返回根页面"</span>) {
                navManager.goToRoot()
            }
            .buttonStyle(.bordered)
            
            <span class="hljs-comment">// 当前路径信息</span>
            <span class="hljs-type">Text</span>(<span class="hljs-string">"当前导航栈深度: <span class="hljs-subst">\(navManager.path.count)</span>"</span>)
        }
        .navigationTitle(<span class="hljs-string">"C 页面"</span>)
        .navigationBarBackButtonHidden(<span class="hljs-literal">true</span>) <span class="hljs-comment">// 隐藏默认返回按钮</span>
        .toolbar {
            <span class="hljs-type">ToolbarItem</span>(placement: .navigationBarLeading) {
                <span class="hljs-type">Button</span>(<span class="hljs-string">"返回"</span>) {
                    navManager.goBack()
                }
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-7">4. 使用 @Binding 传递控制 (简单场景)</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Binding</span> <span class="hljs-keyword">var</span> path: <span class="hljs-type">NavigationPath</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"C 页面"</span>)
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"返回 B"</span>) {
                path.removeLast()
            }
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"返回 A"</span>) {
                <span class="hljs-comment">// 移除 B 和 C</span>
                <span class="hljs-keyword">if</span> path.count <span class="hljs-operator">&gt;=</span> <span class="hljs-number">2</span> {
                    path.removeLast(<span class="hljs-number">2</span>)
                }
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-8">总结</h2>
<p><strong>从 C 返回 B 的方法：</strong></p>
<ul>
<li><code>dismiss()</code> - 最简单的返回上一页</li>
<li><code>navigationPath.removeLast()</code> - 编程式返回</li>
<li><code>navManager.goBack()</code> - 通过管理器返回</li>
</ul>
<p><strong>从 C 直接返回 A 的方法：</strong></p>
<ul>
<li><code>navigationPath.removeLast(2)</code> - 移除最后2个页面</li>
<li><code>navigationPath.removeLast(navigationPath.count)</code> - 清空所有页面</li>
<li><code>navManager.goBackToA()</code> - 通过管理器精确控制</li>
</ul>
<p>推荐使用导航管理器的方式，因为它提供了更好的代码组织和可维护性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[提示词工程化实践：我如何构建可复用的Suno工作流系统]]></title>    <link>https://juejin.cn/post/7571281406509989939</link>    <guid>https://juejin.cn/post/7571281406509989939</guid>    <pubDate>2025-11-11T10:15:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571281406509989939" data-draft-id="7571281406509662259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="提示词工程化实践：我如何构建可复用的Suno工作流系统"/> <meta itemprop="keywords" content="AIGC,Coze"/> <meta itemprop="datePublished" content="2025-11-11T10:15:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HYI"/> <meta itemprop="url" content="https://juejin.cn/user/2261030112603613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            提示词工程化实践：我如何构建可复用的Suno工作流系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2261030112603613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HYI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:15:10.000Z" title="Tue Nov 11 2025 10:15:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">当音乐小白遇上 Suno</h2>
<p>最近迷上了用 Suno AI 生成音乐，但很快就遇到了两个痛点：</p>
<ol>
<li>作为乐理小白，我不知道如何写出完整的歌词和音乐结构</li>
<li>即使有模糊的想法，也很难转化为 Suno 能理解的精准提示词</li>
</ol>
<p>最初的解决方案很简单：让大模型帮我补全。但很快发现，这种“一次性”的生成方式存在很大随机性，无法积累经验，也无法系统化提升输出质量。</p>
<h2 data-id="heading-1">思路转变：从单次生成到流程设计</h2>
<p>我意识到，需要建立一个可重复、可优化的创作流程。经过多次迭代，最终形成了一套模块化的工作流系统。</p>
<p><strong>核心演进历程：</strong></p>
<ul>
<li><strong>V1</strong>：简单的角色设定+任务说明，手动串联各个步骤</li>
<li><strong>V2</strong>：引入标准化步骤概念，开始定义输入输出</li>
<li><strong>V3</strong>：关键的模块化转变，通过文件契约建立接口规范</li>
<li><strong>V4</strong>：完善的调度系统，支持调试、开发和知识库扩展</li>
</ul>
<h2 data-id="heading-2">最终工作流架构设计</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start([流程开始]) --&gt; Step1

    subgraph Step1 [前置流程认知]
        A1[角色: 音乐制作调度引擎] --&gt; A2[载入模块]
    end

    A2 --&gt; Step2[知识库插件&lt;br&gt;提供术语与标签库]

    subgraph Step3 [需求解析引擎]
        B1[输入: 用户原始灵感] --&gt; B2{是否模糊?}
        B2 -- 是 --&gt; B3[追问具体细节]
        B3 --&gt; B1
        B2 -- 否 --&gt; B4[生成项目需求规范]
        B4 --&gt; B5[输出: ProjectSpec.md]
    end

    Step2 --&gt; Step3

    subgraph Step4 [定义音乐内核]
        C1[输入: ProjectSpec.md] --&gt; C2[转化为专业音乐术语]
        C2 --&gt; C3[生成核心创意蓝图]
        C3 --&gt; C4[输出: CreativeCore.md]
    end

    B5 --&gt; Step4

    subgraph Step5 [歌词生成]
        D1[输入: CreativeCore.md] --&gt; D2[创作结构化歌词]
        D2 --&gt; D3[输出: Lyrics.md]
        D2 --&gt; D4[输出: VocalDesign.md]
    end

    C4 --&gt; Step5

    subgraph Step6 [作曲生成]
        E1[输入:&lt;br&gt;CreativeCore.md&lt;br&gt;Lyrics.md&lt;br&gt;VocalDesign.md] --&gt; E2[生成Suno提示词]
        E2 --&gt; E3[输出: MusicPrompt.md]
    end

    D3 --&gt; Step6
    D4 --&gt; Step6

    subgraph Step7 [质量校验引擎]
        F1[输入: 所有前期产出] --&gt; F2{一致性检查?}
        F2 -- 不通过 --&gt; F3[返回对应模块修正]
        F3 --&gt; Step5
        F2 -- 通过 --&gt; F4[生成质量报告]
        F4 --&gt; F5[输出: QualityReport.md]
    end

    E3 --&gt; Step7

    subgraph Step8 [衍生内容引擎]
        G1[输入: 完整作品包] --&gt; G2[生成营销材料]
        G2 --&gt; G3[输出: DerivativeContent.md]
    end

    F5 --&gt; Step8 --&gt; End([流程结束])

    %% 样式定义
    classDef process fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef decision fill:#fff3e0,stroke:#ef6c00,stroke-width:2px;
    classDef inputoutput fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px;
    classDef startend fill:#fce4ec,stroke:#c2185b,stroke-width:2px;
    
    class Step1,Step3,Step4,Step5,Step6,Step7,Step8 process;
    class B2,F2 decision;
    class B5,C4,D3,D4,E3,F5,G3 inputoutput;
    class Start,End startend;
</code></pre>
<p>经过多次迭代，我最终确立了一套标准化音乐生产管线。该系统的核心思想是 <strong>“模块化分工”</strong> 与 <strong>“契约化协作”</strong> ，每个模块职责单一，并通过标准化的文件接口传递数据，确保流程的稳定性和输出质量。</p>
<h3 data-id="heading-3">系统架构总览</h3>
<p>整个工作流是一个严格的瀑布模型，上游模块的输出是下游模块的唯一输入：</p>
<p><code>[需求解析引擎] → [定义音乐内核] → [作词引擎] → [作曲引擎] → [质量校验引擎] → [衍生内容引擎]</code></p>
<p>此外，还有一个独立的 <code>[知识库插件]</code> 可为各模块提供专业术语支持。</p>
<h3 data-id="heading-4">核心模块详解</h3>
<h4 data-id="heading-5">1. 需求解析引擎</h4>
<p><strong>角色</strong>：音乐项目分析师
<strong>任务</strong>：将模糊、感性的用户灵感，转化为清晰、无歧义、可执行的需求文档。
<strong>输入</strong>：用户原始需求（如：“做一首科技感、热血的歌”）
<strong>输出</strong>：<code>ProjectSpec.md</code>
<strong>核心价值</strong>：通过“反模糊规则”强制具体化，奠定项目质量基石。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目需求规范</span>
<span class="hljs-section">## 核心情绪</span>
<span class="hljs-bullet">-</span> 主导基调：科技感的热血与憧憬
<span class="hljs-bullet">-</span> 情感动态：从理性观察到感性释放
<span class="hljs-section">## 风格方向</span>
<span class="hljs-bullet">-</span> 感觉描述：未来都市天际线在黎明时的景象
<span class="hljs-bullet">-</span> 动态比喻：如数据洪流汇聚成澎湃浪潮
<span class="hljs-section">## 核心意象</span>
<span class="hljs-bullet">-</span> 视觉符号：外滩建筑群、流动的代码光带
...
</code></pre>
<h4 data-id="heading-6">2. 定义音乐内核</h4>
<p><strong>角色</strong>：音乐创意架构师
<strong>任务</strong>：将标准化的需求，创造性转化为一份具备深度与执行性的核心创意蓝图。
<strong>输入</strong>：<code>ProjectSpec.md</code>
<strong>输出</strong>：<code>CreativeCore.md</code>
<strong>核心价值</strong>：完成从“需求是什么”到“音乐怎么做”的关键跳跃。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 核心创意蓝图</span>
<span class="hljs-section">## 音乐概念设计</span>
<span class="hljs-bullet">-</span> 核心张力：数字合成的精确与人性温暖的对抗融合
<span class="hljs-bullet">-</span> 风格定位：以Synthwave为基底，融入Cinematic元素
<span class="hljs-section">## 声音设计框架</span>
<span class="hljs-bullet">-</span> 节奏与律动：128 BPM/4/4 - 强劲电子鼓组与脉冲贝斯
...
</code></pre>
<h4 data-id="heading-7">3. 作词引擎</h4>
<p><strong>角色</strong>：音乐剧本作家
<strong>任务</strong>：基于创意蓝图，生成结构创新、情感精准且符合Suno格式标准的歌词脚本。
<strong>输入</strong>：<code>CreativeCore.md</code>
<strong>输出</strong>：</p>
<ul>
<li><code>Lyrics.md</code> (歌词文件)</li>
<li><code>VocalDesign.md</code> (演唱设计文件)
<strong>核心价值</strong>：输出非模板化的、具有戏剧张力的歌词，并附带专业的演唱指导。</li>
</ul>
<pre><code class="hljs language-text" lang="text">[Intro] (氛围感电子音效) /
城市在重启 代码的潮汐 /
[Verse 1] (冷静叙述)
穿过外滩的风 听见未来的回音 /
...
</code></pre>
<h4 data-id="heading-8">4. 作曲引擎</h4>
<p><strong>角色</strong>：Suno音效设计师
<strong>任务</strong>：将创意蓝图和歌词“翻译”成Suno能理解的、精确的音乐风格提示词。
<strong>输入</strong>：<code>CreativeCore.md</code>, <code>Lyrics.md</code>, <code>VocalDesign.md</code>
<strong>输出</strong>：<code>MusicPrompt.md</code>
<strong>核心价值</strong>：实现“音色叙事”，将文字概念转化为具体的声音描述。</p>
<pre><code class="hljs language-text" lang="text">Synthwave fused with Cinematic Pop, uplifting and futuristic.
Powerful male vocals with rap sections. 128 BPM.
Featuring soaring synthesizer leads and pounding electronic drums.
</code></pre>
<h4 data-id="heading-9">5. 质量校验引擎</h4>
<p><strong>角色</strong>：音乐质量审计师
<strong>任务</strong>：对歌词和音乐提示词进行一致性校验，确保所有产出符合艺术标准和技术规范。
<strong>输入</strong>：<code>CreativeCore.md</code>, <code>Lyrics.md</code>, <code>MusicPrompt.md</code>
<strong>输出</strong>：<code>QualityReport.md</code>
<strong>核心价值</strong>：作为质量守门员，形成创作闭环，确保最终产出与最初愿景一致。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 质量校验报告</span>
<span class="hljs-section">## 一致性检查</span>
<span class="hljs-bullet">-</span> [x] 歌词主题与创意蓝图的核心张力一致
<span class="hljs-bullet">-</span> [x] 音乐风格与内核定义匹配
<span class="hljs-section">## 优化建议</span>
<span class="hljs-bullet">-</span> 副歌部分可增加和声设计的描述
</code></pre>
<h4 data-id="heading-10">6. 衍生内容引擎</h4>
<p><strong>角色</strong>：音乐产品经理
<strong>任务</strong>：基于完整的音乐作品包，自动生成配套的营销和发行材料。
<strong>输入</strong>：所有前期产出文件
<strong>输出</strong>：<code>DerivativeContent.md</code>
<strong>核心价值</strong>：最大化作品价值，提供开箱即用的宣发素材。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 衍生内容包</span>
<span class="hljs-section">## 歌曲名称</span>
<span class="hljs-section">## 封面图片</span>
<span class="hljs-section">## 歌曲简介</span>
一首关于...的Synthwave作品。
</code></pre>
<h2 data-id="heading-11">心理路程</h2>
<h3 data-id="heading-12">v1</h3>
<blockquote>
<p>直接描述需求-粘贴歌词生成提示词-粘贴音乐提示词生成-融合前面的输入，整合输出最后产物
v1可以输出内容，但流程还是不满意，虽然够用。之后构思新流程，后面的所有步骤都是按照新的流程 <code>模糊需求提示词目标填空需求 - 理解需求输出清晰标准的需求 - 根据标准的需求生成内核 - 生产歌词 -生成风格提示词 - 校验 - 输出</code></p>
</blockquote>
<pre><code class="hljs language-md" lang="md"><span class="hljs-section"># 角色设定</span>
<span class="hljs-section"># 任务说明</span>
<span class="hljs-section"># 输入信息</span>
<span class="hljs-section"># 输出要求</span>
</code></pre>
<h3 data-id="heading-13">v2</h3>
<blockquote>
<p>v2的前面核心流程走通了，可是提示词很乱，最后约束与限制和示例对照表未完成就转v3</p>
</blockquote>
<pre><code class="hljs language-md" lang="md"><span class="hljs-section"># Step [步骤名称]</span>
<span class="hljs-section">## 角色设定（Role）</span>
<span class="hljs-section">## 任务目标（Task）</span>
<span class="hljs-section">## 输入参数（Inputs）</span>
<span class="hljs-section">### 输出格式（Outputs）</span>
<span class="hljs-section">## 约束与限制（Constraints）</span>
<span class="hljs-section">## 示例对照表（Example） </span>
</code></pre>
<h3 data-id="heading-14">v3</h3>
<blockquote>
<p>v3之前是阶段概念，这里引入模块概念，引入知识库概念，新的模板格式更清晰</p>
</blockquote>
<pre><code class="hljs language-md" lang="md"><span class="hljs-section"># Module - {{modelName}}</span>
<span class="hljs-section">## Role</span>
<span class="hljs-section">## Task</span>
<span class="hljs-section">## Inputs</span>
<span class="hljs-section">## Outputs</span>
<span class="hljs-quote">&gt; <span class="hljs-strong">**文件名**</span>：`{{fileName}}.md`</span>
<span class="hljs-quote">&gt; <span class="hljs-strong">**格式**</span>：严格遵循以下Markdown模板</span>

<span class="hljs-code">```markdown ```</span>
<span class="hljs-section">## Rules</span>
<span class="hljs-section">## Example</span>
| 输入 | 输出 |
| :--- | :--- |
</code></pre>
<h3 data-id="heading-15">v4</h3>
<blockquote>
<p>我一直是对话流，为了区分不同功能，引入了标签包裹提示词，增加了 debug、dev、module、plugin 等标签，用于指定不同的功能模块。
debug真的好用，在我不知道为什么输出不符合要求使，在debug标签内要求模型自己分析一下为什么，效率很高非常方便。</p>
</blockquote>
<pre><code class="hljs language-md" lang="md"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span></span>
<span class="hljs-section"># Module - {{modelName}}</span>
<span class="hljs-section">## Role</span>
<span class="hljs-section">## Task</span>
<span class="hljs-section">## Inputs</span>
<span class="hljs-section">## Outputs</span>
<span class="hljs-quote">&gt; <span class="hljs-strong">**文件名**</span>：`{{fileName}}.md`</span>
<span class="hljs-quote">&gt; <span class="hljs-strong">**格式**</span>：严格遵循以下Markdown模板</span>

<span class="hljs-code">```markdown ```</span>
<span class="hljs-section">## Rules</span>
<span class="hljs-section">## Example</span>
| 输入 | 输出 |
| :--- | :--- |
<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-16">v4.1</h3>
<p>查找资料，总结更完善的suno规则</p>
<p><strong>资源分享：</strong>
在实践中整理的详细文档，供参考：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fqcn0ge2z1yhd.feishu.cn%2Fwiki%2FV7qtwgdDCiLfWfkWIglcEU1AnVc" target="_blank" title="https://qcn0ge2z1yhd.feishu.cn/wiki/V7qtwgdDCiLfWfkWIglcEU1AnVc" ref="nofollow noopener noreferrer">Suno AI 提示词</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fqcn0ge2z1yhd.feishu.cn%2Fwiki%2FV06vwRsvbiPqhzk0qP6cmMdYnsh" target="_blank" title="https://qcn0ge2z1yhd.feishu.cn/wiki/V06vwRsvbiPqhzk0qP6cmMdYnsh" ref="nofollow noopener noreferrer">Suno AI 提示词规则</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fqcn0ge2z1yhd.feishu.cn%2Fwiki%2FTkp8wZFZtiHtyDkhlLxcOND5nad" target="_blank" title="https://qcn0ge2z1yhd.feishu.cn/wiki/Tkp8wZFZtiHtyDkhlLxcOND5nad" ref="nofollow noopener noreferrer">AI音乐生成指南V4</a></li>
</ul>
<h2 data-id="heading-17">结语</h2>
<h3 data-id="heading-18">学到了什么？</h3>
<p>通过从零开始设计和迭代这套Suno音乐工作流，我获得了关于AI智能体构建的第一手经验。这不仅仅是一个提示词优化过程，更是一次完整的智能体系统开发生命周期实践：
好的，如果我是你，回顾整个探索过程，我学到了最核心的三点：</p>
<ol>
<li><strong>从“下指令”到“建系统”的思维跃迁</strong>
最大的收获不是写出了更好的提示词，而是学会了不直接向AI要结果，而是为它设计一套分工明确、接口清晰的协作系统。我从“用户”变成了“架构师”。</li>
<li><strong>“契约”比“模型”更关键</strong>
我发现，确保多个AI智能体稳定协作的核心，不是找到一个最强大的模型，而是为它们设计好像 <code>ProjectSpec.md</code> 这样的标准化“契约”（接口）。清晰的接口定义是系统稳定性的基石。</li>
<li><strong>创造力可以“工程化”</strong>
我成功地将看似依赖灵感的音乐创作，分解成了一个可重复、可优化、可控的工程流程。这证明了复杂创意任务可以通过系统化的方法变得稳定和可靠。</li>
</ol>
<h3 data-id="heading-19">其他</h3>
<p>下一步就是把v4搬到扣子、dify工作流实现更便捷的ui操作，再增加<strong>点子王模块</strong>节点，使用循环节点输出多风格版本。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🏮一眼就会🗂️大文件分片上传，白送前后端全套功法]]></title>    <link>https://juejin.cn/post/7570268773333205019</link>    <guid>https://juejin.cn/post/7570268773333205019</guid>    <pubDate>2025-11-09T23:09:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570268773333205019" data-draft-id="7568706594881683466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🏮一眼就会🗂️大文件分片上传，白送前后端全套功法"/> <meta itemprop="keywords" content="Node.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-09T23:09:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vilan_微澜"/> <meta itemprop="url" content="https://juejin.cn/user/2225067267199320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🏮一眼就会🗂️大文件分片上传，白送前后端全套功法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067267199320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vilan_微澜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T23:09:25.000Z" title="Sun Nov 09 2025 23:09:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>快看！前方好像有什么人在争吵。</p>
<p>我这个文件上传了这么多，怎么又要重新开始上传啊？</p>
<p>我这个网页怎么又卡住了。</p>
<p>切图仔快来看看！</p>
<p><strong>啊啊啊！</strong> 前方突然传来一声尖叫，只见一个年轻人“颤颤巍巍”地从工位上站起，指着他后方的同事，随后大喊一声：“你不要再叫我切图仔啦！”</p>
<p>话音刚落，只见后方同事表现出一副嗤之以鼻的样子，随后带着一丝轻蔑，对着那个年轻人又撂下一句：“切图仔！”。</p>
<p>随即，那个年轻人全身都在颤抖，仿佛就要......</p>
<h2 data-id="heading-0">引言</h2>
<p>开始学习。</p>
<p>下文将带你打通从前端文件分片、文件哈希计算、<code>Web Worker</code>用法、文件断点续传和秒传，到后端分片接收、文件合并的完整技术链条。</p>
<p><strong>后端</strong>基于 <strong>Node.js + Express</strong> 框架，使用 <strong>formidable</strong> 库高效处理分片数据，最终将分片合并为完整文件。</p>
<p><strong>前端</strong>采用 <strong>Vue 3 + TS + Vite</strong> 构建，使用 <strong>Naive UI</strong> 写个好看点的上传进度监控界面，并利用 <strong>Web Worker</strong> 线程计算文件哈希。</p>
<p><strong>关键词：</strong> 文件分片、文件秒传、断点续传、上传进度、文件hash、Web Worker、Node.js</p>
<h2 data-id="heading-1">实现原理图解</h2>
<p>下面<strong>两张图</strong>展示了从<strong>前端</strong>上传文件分片到<strong>后端</strong>解析分片数据并写入文件、合并分片文件的<strong>全套功法</strong>。</p>
<h3 data-id="heading-2">前端实现图解</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7398d3f7c7e43349c2106ff954bb2ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlsYW5f5b6u5r6c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763339326&amp;x-signature=OtpaAiZGapc7u35U%2FtY6wB95Yf4%3D" alt="前端.png" loading="lazy"/></p>
<h3 data-id="heading-3">后端实现图解</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39b1ad33662f4a1597ac084d99f70a6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlsYW5f5b6u5r6c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763339326&amp;x-signature=OaZCU5BRxPmO4xlasyj3XF5nmuY%3D" alt="无标题-2025-11-08-2359.png" loading="lazy"/></p>
<p>看完图解大概理解实现流程就可以上手写代码了</p>
<h2 data-id="heading-4">前端实现代码</h2>
<p>首先我们的目的是封装一个提供大文件上传功能的函数，由于函数中又涉及到页面的一些<strong>响应式状态</strong>，比如上传进度，那么我们姑且就叫它为<code>hook</code>函数吧，然后把它命名为<code>useBigFileUpload.ts</code></p>
<p>下面先把需要用到的<strong>属性和类型</strong>先写上，其他方法后面再逐步完善。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> axios, { <span class="hljs-keyword">type</span> <span class="hljs-title class_">AxiosProgressEvent</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">AxiosResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"axios"</span>;
<span class="hljs-keyword">import</span> { createDiscreteApi } <span class="hljs-keyword">from</span> <span class="hljs-string">"naive-ui"</span>;
<span class="hljs-keyword">import</span> { computed, markRaw, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">const</span> baseUrl = <span class="hljs-string">"http://localhost:3000"</span>;

<span class="hljs-comment">// axios实例化</span>
<span class="hljs-keyword">const</span> http = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: baseUrl,
});

<span class="hljs-keyword">const</span> { message } = <span class="hljs-title function_">createDiscreteApi</span>([<span class="hljs-string">"message"</span>]);

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Props</span> = {
  <span class="hljs-attr">chunkSize</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ChunkRequestQueue</span> = {
  <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AxiosResponse</span>&gt;;
  <span class="hljs-attr">abortController</span>: <span class="hljs-title class_">AbortController</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Chunk</span> = {
  <span class="hljs-comment">// 切片数据</span>
  <span class="hljs-attr">chunk</span>: <span class="hljs-title class_">Blob</span>;
  <span class="hljs-comment">// 当前切片索引</span>
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 切片文件名</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">// 总大小</span>
  <span class="hljs-attr">size</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 已上传大小</span>
  <span class="hljs-attr">uploaded</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 请求总进度</span>
  <span class="hljs-attr">requestSize</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 是否完成上传</span>
  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 上传进度</span>
  <span class="hljs-attr">progress</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useBigFileUpload</span> = (<span class="hljs-params">
  props: Props = {
    chunkSize: <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1</span>,
  }
</span>) =&gt; {

  <span class="hljs-comment">// 当前计算hash进度</span>
  <span class="hljs-keyword">const</span> hashProgress = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 是否暂停了上传</span>
  <span class="hljs-keyword">const</span> isPuase = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-comment">// 当前上传的文件</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">fileTarget</span>: <span class="hljs-title class_">File</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// 文件哈希值+文件后缀名</span>
  <span class="hljs-keyword">let</span> fileHash = <span class="hljs-string">""</span>;

  <span class="hljs-comment">// 当前上传切片数组</span>
  <span class="hljs-keyword">const</span> chunks = ref&lt;<span class="hljs-title class_">Chunk</span>[]&gt;([]);

  <span class="hljs-comment">// 当前上传请求队列</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">chunkReqQueueList</span>: <span class="hljs-title class_">ChunkRequestQueue</span>[] = [];

  <span class="hljs-comment">// 当前上传完成的切片/总切片数</span>
  <span class="hljs-keyword">const</span> percentage = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> chunkSize = chunks.<span class="hljs-property">value</span>.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">if</span> (chunkSize === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">const</span> conpletedChunks = chunks.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> chunk.<span class="hljs-property">completed</span>);
    <span class="hljs-keyword">return</span> (conpletedChunks.<span class="hljs-property">length</span> / chunkSize) * <span class="hljs-number">100</span>;
  });

  <span class="hljs-keyword">return</span> {
    percentage,
    chunks,
    isPuase,
    hashProgress,
  };
};

</code></pre>
<h3 data-id="heading-5">文件切片</h3>
<p>创建<code>createChunks</code>方法，对大文件进行切片</p>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// 创建切片，切片大小可根据自身需求调整</span>
  <span class="hljs-keyword">const</span> createChunks = (
    <span class="hljs-attr">file</span>: <span class="hljs-title class_">File</span>,
    <span class="hljs-attr">chunkSize</span>: <span class="hljs-built_in">number</span> = props.<span class="hljs-property">chunkSize</span>
  ): <span class="hljs-title class_">Blob</span>[] =&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">chunks</span>: <span class="hljs-title class_">Blob</span>[] = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; file.<span class="hljs-property">size</span>; i += chunkSize, j++) {
      chunks.<span class="hljs-title function_">push</span>(file.<span class="hljs-title function_">slice</span>(i, i + chunkSize));
    }
    <span class="hljs-keyword">return</span> chunks;
  };
</code></pre>
<p>通过分片计算文件<code>hash</code>值，其中有两种计算类型：</p>
<p>1.<strong>抽样分片计算</strong>。通过抽取文件的一部分分片进行一部分文件内容的hash值计算，这种方法可以节省计算耗时。</p>
<p>2.<strong>全量分片计算</strong>。通过所有分片计算完整的文件内容hash值，这个方法计算的值会比较准确，但是计算耗时相对多一些。</p>
<p>下面我们<strong>采用</strong>的是<strong>第二种</strong>方法进行计算。</p>
<h3 data-id="heading-6">文件hash计算</h3>
<p>在你的项目的utils工具包中创建<code>file-hash.work.js</code>文件，计算文件内容hash值的<code>Web Worker</code>方法</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 在 utils/workers/file-hash.work.js 中</span>
<span class="hljs-comment">// 引入 SparkMD5 计算文件内容hash</span>
<span class="hljs-comment">// importScripts('/spark-md5@3.0.2/spark-md5.min.js');</span>
importScripts(<span class="hljs-string">'https://cdn.jsdelivr.net/npm/spark-md5@3.0.2/spark-md5.min.js'</span>);

self.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
  <span class="hljs-comment">// 从主线程接收分片数据</span>
  <span class="hljs-keyword">const</span> { chunks } = e.<span class="hljs-property">data</span>;
  <span class="hljs-comment">// 创建 SparkMD5 实例</span>
  <span class="hljs-keyword">const</span> spark = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SparkMD5</span>.<span class="hljs-title class_">ArrayBuffer</span>();

  <span class="hljs-comment">// 读取切片</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">readChunk</span>(<span class="hljs-params">index</span>) {
    <span class="hljs-keyword">if</span> (index &gt;= chunks.<span class="hljs-property">length</span>) {
      <span class="hljs-comment">// 所有分片处理完毕，计算最终哈希</span>
      <span class="hljs-keyword">const</span> hash = spark.<span class="hljs-title function_">end</span>();
      <span class="hljs-comment">// 向主线程发送最终计算的哈希值</span>
      self.<span class="hljs-title function_">postMessage</span>({ index, hash });
      <span class="hljs-comment">// 所有分片处理完毕，关闭worker</span>
      self.<span class="hljs-title function_">close</span>();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 创建 FileReader 实例, 用于读取分片数据</span>
    <span class="hljs-keyword">const</span> fileReader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>();
    <span class="hljs-comment">// 读取分片数据</span>
    fileReader.<span class="hljs-title function_">readAsArrayBuffer</span>(chunks[index]);
    <span class="hljs-comment">// 分片数据加载完成事件监听</span>
    fileReader.<span class="hljs-property">onload</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-comment">// 追加到 SparkMD5 实例</span>
      spark.<span class="hljs-title function_">append</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>);
      <span class="hljs-comment">// 向主线程发送计算进度索引</span>
      self.<span class="hljs-title function_">postMessage</span>({ index });
      <span class="hljs-comment">// 读取下一个分片</span>
      <span class="hljs-title function_">readChunk</span>(index + <span class="hljs-number">1</span>);
    };
  }
  <span class="hljs-comment">// 从索引0开始读取分片</span>
  <span class="hljs-title function_">readChunk</span>(<span class="hljs-number">0</span>);
};
</code></pre>
<p>在<code>utils</code>文件夹下写好<code>worker</code>工具函数后，继续在<code>useBigFileUpload</code>函数当中添加<code>getHashWorker</code>方法异步获取文件<code>hash</code>值。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 计算文件哈希值
 * <span class="hljs-doctag">@param</span> tempChunks 切片数组
 * <span class="hljs-doctag">@returns</span> 文件哈希值
 */</span>
<span class="hljs-keyword">const</span> getHashWorker = <span class="hljs-keyword">async</span> (<span class="hljs-attr">tempChunks</span>: <span class="hljs-title class_">Blob</span>[]): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; =&gt; {
  hashProgress.<span class="hljs-property">value</span> = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-comment">// 导入worker线程，计算文件哈希值</span>
    <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(
      <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">"../utils/workers/file-hash.work.js"</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>)
    );
    <span class="hljs-comment">// 向worker线程发送消息，计算文件哈希值</span>
    worker.<span class="hljs-title function_">postMessage</span>({
      <span class="hljs-attr">chunks</span>: tempChunks,
    });
    <span class="hljs-comment">// 监听worker线程消息，获取计算文件哈希值结果</span>
    worker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> { index, hash } = e.<span class="hljs-property">data</span>;
      <span class="hljs-comment">// 计算当前计算hash进度</span>
      <span class="hljs-keyword">if</span> (tempChunks.<span class="hljs-property">length</span>) {
        hashProgress.<span class="hljs-property">value</span> = (index / tempChunks.<span class="hljs-property">length</span>) * <span class="hljs-number">100</span>;
      }
      <span class="hljs-keyword">if</span> (hash) {
        <span class="hljs-comment">// 完成计算哈希值</span>
        <span class="hljs-title function_">resolve</span>(hash);
      }
    };
  });
};
</code></pre>
<p>拿到hash值后就可以通过该值查询服务器是否存在该文件，来实现大文件秒传</p>
<h3 data-id="heading-7">文件秒传</h3>
<p>通过<code>hash</code>查询服务器是否<strong>存在该文件</strong>，前端根据返回结果判断是否需要进行文件上传，已存在则直接显示上传完成，否则接着下面进行分片上传。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 检查文件是否已经上传
 * <span class="hljs-doctag">@param</span> fileHash 文件哈希值
 * <span class="hljs-doctag">@returns</span> 检查结果
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkFileApi</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">fileHash: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-comment">// 通过文件hash检查是否已经上传了该文件</span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> http.<span class="hljs-title function_">get</span>(<span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span>/check/file?fileHash=<span class="hljs-subst">${fileHash}</span>`</span>);
  <span class="hljs-comment">// 返回检查结果</span>
  <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>.<span class="hljs-property">hasExist</span>
}
</code></pre>
<h3 data-id="heading-8">文件断点续传</h3>
<p>主要是通过检查服务器是否已经<strong>存在该分片</strong>，并返回查询结果，前端根据查询结果判断是否需要调用分片上传请求方法。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 检查切片是否已经上传
 * <span class="hljs-doctag">@param</span> chunkName 切片名
 * <span class="hljs-doctag">@returns</span> 检查结果
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkChunkApi</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">chunkName: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-comment">// 创建中断请求器</span>
  <span class="hljs-keyword">const</span> abortController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();

  <span class="hljs-comment">// 发生请求前先验证切片是否已经上传</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">res</span>: <span class="hljs-title class_">AxiosResponse</span>&lt;{
    <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">hasExist</span>: <span class="hljs-built_in">boolean</span>;
  }&gt; = <span class="hljs-keyword">await</span> http.<span class="hljs-title function_">get</span>(<span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span>/chunk/check?chunkName=<span class="hljs-subst">${chunkName}</span>`</span>, {
    <span class="hljs-attr">signal</span>: abortController.<span class="hljs-property">signal</span>,
  });

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">res</span>: res,
    abortController,
  }
};
</code></pre>
<h3 data-id="heading-9">分片上传请求</h3>
<p>创建开始分片上传请求方法<code>uploadChunkApi</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 上传切片
 * <span class="hljs-doctag">@param</span> data 切片数据
 * <span class="hljs-doctag">@returns</span> ChunkRequestQueue 上传请求对象
 */</span>
<span class="hljs-keyword">const</span> uploadChunkApi = (<span class="hljs-attr">data</span>: <span class="hljs-title class_">Chunk</span>): <span class="hljs-function"><span class="hljs-params">ChunkRequestQueue</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> { name, index, chunk } = data;
  <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
  formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">"chunk"</span>, chunk);

  <span class="hljs-comment">// 创建中断请求器</span>
  <span class="hljs-keyword">const</span> abortController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();

  <span class="hljs-keyword">const</span> promise = http.<span class="hljs-title function_">post</span>(<span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span>/chunk?chunkName=<span class="hljs-subst">${name}</span>`</span>, formData, {
    <span class="hljs-attr">signal</span>: abortController.<span class="hljs-property">signal</span>,
    <span class="hljs-attr">onUploadProgress</span>: <span class="hljs-function">(<span class="hljs-params">progressEvent: AxiosProgressEvent</span>) =&gt;</span> {
      <span class="hljs-comment">// 计算上传进度</span>
      <span class="hljs-keyword">if</span> (
        chunks.<span class="hljs-property">value</span>[index] &amp;&amp;
        progressEvent.<span class="hljs-property">total</span> &amp;&amp;
        progressEvent.<span class="hljs-property">progress</span>
      ) {
        <span class="hljs-comment">// 记录当前上传切片请求进度。</span>
        <span class="hljs-comment">// 注意，由于网络请求具有额外开销，上传进度可能会和切片大小不一样</span>
        chunks.<span class="hljs-property">value</span>[index].<span class="hljs-property">uploaded</span> = progressEvent.<span class="hljs-property">loaded</span>;
        <span class="hljs-comment">// 记录当前上传切片请求总大小</span>
        <span class="hljs-comment">// 注意，由于网络请求具有额外开销，上传进度可能会和切片大小不一样</span>
        chunks.<span class="hljs-property">value</span>[index].<span class="hljs-property">requestSize</span> = progressEvent.<span class="hljs-property">total</span>;
        <span class="hljs-comment">// 计算上传进度</span>
        chunks.<span class="hljs-property">value</span>[index].<span class="hljs-property">progress</span> = progressEvent.<span class="hljs-property">progress</span>;
      }
    },
  });

  <span class="hljs-keyword">return</span> {
    promise,
    abortController,
  };
};
</code></pre>
<p>在发送分片上传<code>http</code>请求的方法中，监听了<code>axios</code>的<code>onUploadProgress</code>回调方法，在该方法里面可以拿到请求的完成进度，其中记录了<code>AxiosProgressEvent</code>的3个属性：<code>uploaded</code>、<code>total</code>、<code>progress</code>。主要是<code>progress</code>页面显示上传进度需要，其他如果页面不需要显示，可有可无吧。</p>
<p>最后把当前请求的<code>promise</code>对象和中断请求的<code>abortController</code>对象返回，放入请求队列当中。</p>
<p>当需要暂停上传时，可以使用<code>abortController</code>进行中断请求。</p>
<h3 data-id="heading-10">分片合并请求</h3>
<p>创建合并切片请求方法<code>mergeChunksApi</code>，当请求队列中的分片都成功上传后，调用该方法并携带<code>fileHash</code>文件标识，用于服务器找到该文件分片所在位置，合并成功后，文件即上传完成。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 合并切片
 * <span class="hljs-doctag">@param</span> fileHash 文件哈希值
 * <span class="hljs-doctag">@returns</span> 合并结果
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">mergeChunksApi</span> = (<span class="hljs-params">fileHash: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> http.<span class="hljs-title function_">post</span>(<span class="hljs-string">`/merge-chunk`</span>, {
    fileHash,
  });
};
</code></pre>
<h3 data-id="heading-11">开始上传文件</h3>
<p>上面的准备工作就绪后，就可以创建上传文件方法了。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 开始上传
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">file</span>
 * <span class="hljs-doctag">@param</span> resume 是否恢复上传
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">startUpload</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">file: File, resume: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span></span>) =&gt; {
  <span class="hljs-keyword">if</span> (!file) {
    message.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请先选择文件!"</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 恢复上传不用重新创建切片，延续之前的切片进度</span>
  <span class="hljs-keyword">if</span> (!resume) {
    <span class="hljs-comment">// 保存文件，用于后续恢复上传</span>
    fileTarget = file;
    <span class="hljs-comment">// 重置暂停状态，避免重复上传时暂停状态为true导致问题</span>
    isPuase.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-comment">// 创建切片</span>
    <span class="hljs-keyword">const</span> tempChunks = <span class="hljs-title function_">createChunks</span>(file);
    <span class="hljs-comment">// 计算文件哈希值，并拼接文件后缀名</span>
    fileHash =
      (<span class="hljs-keyword">await</span> <span class="hljs-title function_">getHashWorker</span>(tempChunks)) + <span class="hljs-string">"."</span> + file.<span class="hljs-property">name</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">"."</span>).<span class="hljs-title function_">pop</span>();
    <span class="hljs-comment">// 构建切片对象数组</span>
    chunks.<span class="hljs-property">value</span> = tempChunks.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">chunk, i</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">name</span>: <span class="hljs-title function_">buildChunkName</span>(fileHash, i),
        <span class="hljs-attr">chunk</span>: <span class="hljs-title function_">markRaw</span>(chunk),
        <span class="hljs-attr">index</span>: i,
        <span class="hljs-attr">size</span>: props.<span class="hljs-property">chunkSize</span>,
        <span class="hljs-attr">uploaded</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">requestSize</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">progress</span>: <span class="hljs-number">0</span>,
        <span class="hljs-keyword">get</span> <span class="hljs-title function_">completed</span>() {
          <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">progress</span> === <span class="hljs-number">1</span>;
        },
      };
    });
  }

  <span class="hljs-comment">// 通过文件hash检查是否已经上传了该文件</span>
  <span class="hljs-keyword">const</span> hasExist = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkFileApi</span>(fileHash);
  <span class="hljs-keyword">if</span> (hasExist) {
    message.<span class="hljs-title function_">warning</span>(<span class="hljs-string">"文件已存在，无需重复上传"</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 如果是暂停后恢复上传时，过滤出未上传完成的切片</span>
  <span class="hljs-keyword">const</span> waitUploadChunks = chunks.<span class="hljs-property">value</span>
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> !chunk.<span class="hljs-property">completed</span>;
    });

  <span class="hljs-comment">// 遍历未完成上传的切片</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; waitUploadChunks.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> chunk = waitUploadChunks[i] <span class="hljs-keyword">as</span> <span class="hljs-title class_">Chunk</span>;
    <span class="hljs-keyword">const</span> name = chunk.<span class="hljs-property">name</span>;

    <span class="hljs-comment">// 创建中断请求器</span>
    <span class="hljs-keyword">const</span> abortController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();

    <span class="hljs-comment">// 发生请求前先验证切片是否已经上传</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">res</span>: <span class="hljs-title class_">AxiosResponse</span>&lt;{
      <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
      <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
      <span class="hljs-attr">hasExist</span>: <span class="hljs-built_in">boolean</span>;
    }&gt; = <span class="hljs-keyword">await</span> http.<span class="hljs-title function_">get</span>(<span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span>/chunk/check?chunkName=<span class="hljs-subst">${name}</span>`</span>, {
      <span class="hljs-attr">signal</span>: abortController.<span class="hljs-property">signal</span>,
    });

    <span class="hljs-comment">// 暂停了直接退出for循环，且不再执行for循环后面的代码</span>
    <span class="hljs-keyword">if</span> (isPuase.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span>.<span class="hljs-property">hasExist</span>) {
      chunkReqQueueList[i] = {
        <span class="hljs-comment">// 返回校验结果</span>
        <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(res),
        <span class="hljs-comment">// 校验切片是否存在中断器</span>
        abortController,
      };
      chunk.<span class="hljs-property">progress</span> = <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 切片不存在，继续上传</span>
      chunkReqQueueList[i] = <span class="hljs-title function_">uploadChunkApi</span>(chunk);
    }
  }

  <span class="hljs-keyword">if</span> (chunkReqQueueList.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
      chunkReqQueueList.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">promise</span>)
    );

    <span class="hljs-comment">// 合并切片</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">mergeChunksApi</span>(fileHash);
  }
};
</code></pre>
<p><strong>buildChunkName方法</strong></p>
<p>构建和服务器达成约定的分片名称，服务器可通过<code>-</code>分割获取分片所属文件；在合并分片时可根据<code>index</code>索引进行排序合并，保证文件的完整性。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">/**
   * 构建切片名
   * <span class="hljs-doctag">@param</span> hash 文件哈希值
   * <span class="hljs-doctag">@param</span> index 切片索引
   * <span class="hljs-doctag">@returns</span> 切片名
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">buildChunkName</span> = (<span class="hljs-params">hash: <span class="hljs-built_in">string</span>, index: <span class="hljs-built_in">number</span></span>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${hash}</span>-<span class="hljs-subst">${index}</span>`</span>;
  };
</code></pre>
<p>在开始上传的<code>startUpload</code>方法中具有两种情况，分别为<strong>开始上传</strong>和<strong>恢复上传</strong>。</p>
<p>开始上传时，执行完整的步骤；在恢复上传时，可根据开始上传时的状态，过滤出未上传的分片<code>waitUploadChunks</code>数组，再发送分片上传请求，避免不必要的性能损耗。</p>
<h3 data-id="heading-12">暂停上传文件</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 暂停切片上传</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">pauseUpload</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (!isPuase.<span class="hljs-property">value</span>) {
    isPuase.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
    chunkReqQueueList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">req</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (req.<span class="hljs-property">abortController</span>) {
        req.<span class="hljs-property">abortController</span>.<span class="hljs-title function_">abort</span>(<span class="hljs-string">"用户取消上传!"</span>);
      }
    });
    <span class="hljs-comment">// 清空上传队列</span>
    chunkReqQueueList = [];
  } <span class="hljs-keyword">else</span> {
    message.<span class="hljs-title function_">warning</span>(<span class="hljs-string">"文件已暂停上传！"</span>);
  }
};
</code></pre>
<h3 data-id="heading-13">恢复上传文件</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 恢复切片上传</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">resumeUpload</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (fileTarget &amp;&amp; isPuase.<span class="hljs-property">value</span>) {
    isPuase.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-title function_">startUpload</span>(fileTarget, <span class="hljs-literal">true</span>);
  } <span class="hljs-keyword">else</span> {
    message.<span class="hljs-title function_">warning</span>(<span class="hljs-string">"文件正在上传中！"</span>);
  }
};
</code></pre>
<h3 data-id="heading-14">ui页面构建(用法)</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bafc8e9c01864aed9f677bd5f85b4cdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlsYW5f5b6u5r6c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763339326&amp;x-signature=%2FIezwXzIXT5L9OINZIurqLU5sJI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-15">BigFileUpload.vue</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-file"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">n-upload</span> @<span class="hljs-attr">before-upload</span>=<span class="hljs-string">"onUpload"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">n-button</span>&gt;</span>上传文件<span class="hljs-tag">&lt;/<span class="hljs-name">n-button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">n-upload</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"section"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>文件内容hash计算进度：<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">n-progress</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"line"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"green"</span> <span class="hljs-attr">:percentage</span>=<span class="hljs-string">"hashProgress"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"percentage section"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>上传进度：<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">n-progress</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"line"</span> <span class="hljs-attr">:percentage</span>=<span class="hljs-string">"progress"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"actions section"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>操作：<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">n-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"default"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"onPause"</span>&gt;</span>暂停<span class="hljs-tag">&lt;/<span class="hljs-name">n-button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">n-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"onResume"</span>&gt;</span>继续<span class="hljs-tag">&lt;/<span class="hljs-name">n-button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">n-tag</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"error"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isPuase"</span>&gt;</span>已暂停<span class="hljs-tag">&lt;/<span class="hljs-name">n-tag</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"chunk-list"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>分片上传列表<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ChunkDetail</span>
        <span class="hljs-attr">:list</span>=<span class="hljs-string">"chunks"</span>
      &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ChunkDetail</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NUpload</span>, <span class="hljs-title class_">NButton</span>, useMessage, <span class="hljs-title class_">NProgress</span>, <span class="hljs-title class_">NTag</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"naive-ui"</span>;
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">UploadFileInfo</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"naive-ui"</span>;
<span class="hljs-keyword">import</span> { useBigFileUpload } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/hooks/useBigFileUpload"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChunkDetail</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./ChunkDetail.vue"</span>;
<span class="hljs-keyword">import</span> { computed } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">const</span> {
  percentage,
  startUpload,
  pauseUpload,
  resumeUpload,
  chunks,
  isPuase,
  hashProgress
} = <span class="hljs-title function_">useBigFileUpload</span>();
<span class="hljs-keyword">const</span> message = <span class="hljs-title function_">useMessage</span>();

<span class="hljs-keyword">const</span> progress = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseFloat</span>(percentage.<span class="hljs-property">value</span>.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>))
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">onUpload</span> = (<span class="hljs-params">data: {
  file: UploadFileInfo;
  fileList: <span class="hljs-built_in">Array</span>&lt;UploadFileInfo&gt;;
  event?: Event;
}</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
  <span class="hljs-keyword">const</span> file = data.<span class="hljs-property">file</span>.<span class="hljs-property">file</span>;
  <span class="hljs-keyword">if</span> (!file) {
    message.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请选择文件!"</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-title function_">startUpload</span>(file);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">onPause</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">pauseUpload</span>();
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">onResume</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">resumeUpload</span>();
};

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.upload-file</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">1000px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}
<span class="hljs-selector-class">.actions</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;
}

<span class="hljs-selector-class">.chunk-list</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">600px</span>;
  <span class="hljs-attribute">overflow-y</span>: auto;
}
<span class="hljs-selector-class">.section</span> {
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

</span></code></pre>
<h4 data-id="heading-16">ChunkDetail.vue</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"chunk"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">n-table</span> <span class="hljs-attr">:bordered</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">:single-line</span>=<span class="hljs-string">"false"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">align</span>=<span class="hljs-string">"center"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>索引<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>名称<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>分片大小(byte)<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>请求总大小(byte)<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>已上传(byte)<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>上传进度<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>是否完成<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"data in list"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"data.index"</span> <span class="hljs-attr">align</span>=<span class="hljs-string">"center"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{ data.index }}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{ data.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{ data.size}}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{ data.requestSize }}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{ data.uploaded }}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{ (data.progress * 100).toFixed(2) }}%<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">n-tag</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"data.completed"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"success"</span>&gt;</span>是<span class="hljs-tag">&lt;/<span class="hljs-name">n-tag</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">n-tag</span> <span class="hljs-attr">v-else</span>&gt;</span>否<span class="hljs-tag">&lt;/<span class="hljs-name">n-tag</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">n-table</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NTable</span>, <span class="hljs-title class_">NTag</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"naive-ui"</span>;
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">Chunk</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/hooks/useBigFileUpload"</span>;

defineProps&lt;{
  <span class="hljs-attr">list</span>: <span class="hljs-title class_">Chunk</span>[];
}&gt;();

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-17">后端实现代码</h2>
<h3 data-id="heading-18">文件上传目录示例</h3>
<blockquote>
<p>temp: 解析分片数据写入的临时目录，写入的分片可能不完整；</p>
<p>chunks: 写入完成的分片文件目录；</p>
<p>upload: 分片合并完成的文件目录；</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bff382a156b4def836c9f59007ecd54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlsYW5f5b6u5r6c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763339326&amp;x-signature=bRQZhw%2FiWUccJixQ0cCTJNKHhoE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-19">查询文件是否存在接口</h3>
<p>在<code>upload</code>文件夹下，通过文件hash查询，是否存在该hash文件名的文件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af95c2a86d204461abc4fbb9ff1c3d42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlsYW5f5b6u5r6c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763339326&amp;x-signature=p2AfhHDQf%2BRl%2FgegGhMf1UceJCA%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 查询mergeDir目录下是否存在上传的文件</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/check/file'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> fileHash = req.<span class="hljs-property">query</span>.<span class="hljs-property">fileHash</span>;
  <span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(mergeDir, fileHash);
  <span class="hljs-keyword">const</span> hasExistFile = fs.<span class="hljs-title function_">existsSync</span>(filePath);
  <span class="hljs-keyword">if</span> (hasExistFile) {
    res.<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'文件已存在'</span>,
      <span class="hljs-attr">hasExist</span>: <span class="hljs-literal">true</span>
    })
  } <span class="hljs-keyword">else</span> {
    res.<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'文件不存在'</span>,
      <span class="hljs-attr">hasExist</span>: <span class="hljs-literal">false</span>
    })
  }
})
</code></pre>
<h3 data-id="heading-20">查询分片是否存在接口</h3>
<p>在<code>chunks</code>目录下的文件<code>hash</code>所属目录下，查询是否存在该<strong>hash索引</strong>的分片。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd26b4674cb8455bb4f8e4dfe6d86ea7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlsYW5f5b6u5r6c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763339326&amp;x-signature=9Vj4putG4L1LkBx9rW%2BnRzh1jss%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 验证切片是否已存在接口</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/chunk/check'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {

  <span class="hljs-comment">// 切片文件名称</span>
  <span class="hljs-keyword">const</span> chunkName = req.<span class="hljs-property">query</span>.<span class="hljs-property">chunkName</span>

  <span class="hljs-comment">// 从切片文件名称中提取文件hash</span>
  <span class="hljs-keyword">const</span> fileHash = <span class="hljs-title function_">extractFileHash</span>(chunkName);

  <span class="hljs-comment">// 待合并的分片目录路径</span>
  <span class="hljs-keyword">const</span> chunkPath = path.<span class="hljs-title function_">join</span>(chunkDir, fileHash, chunkName);

  <span class="hljs-comment">// 检查当前切片文件是否已经存在</span>
  <span class="hljs-keyword">const</span> hasExistFile = fs.<span class="hljs-title function_">existsSync</span>(chunkPath);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hasExistFile'</span>, hasExistFile, chunkPath);
  <span class="hljs-keyword">if</span> (hasExistFile) {
    <span class="hljs-comment">// 直接响应。不再执行后续中间件，如后面的回调upload.single('chunk')、切片上传成功回调</span>
    res.<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'切片已存在，跳过该切片上传'</span>,
      <span class="hljs-attr">hasExist</span>: <span class="hljs-literal">true</span>
    })
    <span class="hljs-keyword">return</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 切片不存在</span>
    res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'切片不存在，继续上传'</span>, <span class="hljs-attr">hasExist</span>: <span class="hljs-literal">false</span> })
  }
  <span class="hljs-keyword">return</span> hasExistFile
})
</code></pre>
<h3 data-id="heading-21">分片上传接口</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 从分片名称提取文件hash</span>
<span class="hljs-comment">// 如：chunkName: 91a509c780df16d509e69d604292e870.mp4-0</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">extractFileHash</span>(<span class="hljs-params">chunkName</span>) {
  <span class="hljs-keyword">return</span> chunkName.<span class="hljs-title function_">split</span>(<span class="hljs-string">'-'</span>)[<span class="hljs-number">0</span>];
}

<span class="hljs-comment">// 分片存放路径</span>
<span class="hljs-keyword">const</span> chunkDir = path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'chunks'</span>);

<span class="hljs-comment">// 处理分片文件上传。</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/chunk'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {

  <span class="hljs-keyword">const</span> chunkName = req.<span class="hljs-property">query</span>.<span class="hljs-property">chunkName</span>;

  <span class="hljs-keyword">const</span> fileHash = <span class="hljs-title function_">extractFileHash</span>(chunkName);

  <span class="hljs-comment">// 判断当前目录没有temp文件夹，则创建</span>
  <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(<span class="hljs-string">'./temp'</span>)) {
    fs.<span class="hljs-title function_">mkdirSync</span>(<span class="hljs-string">'./temp'</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
  }

  <span class="hljs-comment">// 使用formidable解析表单数据</span>
  <span class="hljs-keyword">const</span> form = <span class="hljs-title function_">formidable</span>({
    <span class="hljs-attr">uploadDir</span>: <span class="hljs-string">'./temp'</span>, <span class="hljs-comment">// 临时存储路径</span>
    <span class="hljs-attr">keepExtensions</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">filename</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> chunkName
    }
  });

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 解析表单数据，并把分片写入临时目录中</span>
    <span class="hljs-keyword">const</span> [fields, files] = <span class="hljs-keyword">await</span> form.<span class="hljs-title function_">parse</span>(req);
    <span class="hljs-keyword">const</span> chunkFile = files.<span class="hljs-property">chunk</span>[<span class="hljs-number">0</span>];

    <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(chunkDir)) {
      fs.<span class="hljs-title function_">mkdirSync</span>(chunkDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
    }
    <span class="hljs-comment">// 将临时文件移动到 chunkDir 目录</span>
    <span class="hljs-keyword">const</span> fileHashDir = path.<span class="hljs-title function_">join</span>(chunkDir, fileHash);
    <span class="hljs-keyword">const</span> targetPath = path.<span class="hljs-title function_">join</span>(fileHashDir, chunkName);
    <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(fileHashDir)) {
      fs.<span class="hljs-title function_">mkdirSync</span>(fileHashDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
    }
    fs.<span class="hljs-title function_">renameSync</span>(chunkFile.<span class="hljs-property">filepath</span>, targetPath)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">msg</span>: <span class="hljs-string">'分片上传失败'</span>, <span class="hljs-attr">error</span>: error });
  }

  res.<span class="hljs-title function_">send</span>({
    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'分片上传成功'</span>,
    <span class="hljs-attr">file</span>: req.<span class="hljs-property">file</span>
  });
});
</code></pre>
<h3 data-id="heading-22">合并分片接口</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 合并切片</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/merge-chunk'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { fileHash } = req.<span class="hljs-property">body</span>;
  <span class="hljs-keyword">if</span> (!fileHash) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'缺少fileHash参数'</span> });
  }
  <span class="hljs-comment">// 合并后的文件路径，如果不存在则创建该目录</span>
  <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(mergeDir)) {
    fs.<span class="hljs-title function_">mkdirSync</span>(mergeDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
  }
  <span class="hljs-keyword">const</span> mergeFilePath = path.<span class="hljs-title function_">join</span>(mergeDir, fileHash);
  <span class="hljs-keyword">const</span> chunkHashDir = path.<span class="hljs-title function_">join</span>(chunkDir, fileHash);

  <span class="hljs-comment">// 读取目录下所有切片文件，按 index 排序</span>
  <span class="hljs-keyword">const</span> chunkFilenames = fs.<span class="hljs-title function_">readdirSync</span>(chunkHashDir)
    <span class="hljs-comment">// 按 index 排序</span>
    .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> indexA = <span class="hljs-built_in">parseInt</span>(a.<span class="hljs-title function_">split</span>(<span class="hljs-string">'-'</span>).<span class="hljs-title function_">pop</span>(), <span class="hljs-number">10</span>);
      <span class="hljs-keyword">const</span> indexB = <span class="hljs-built_in">parseInt</span>(b.<span class="hljs-title function_">split</span>(<span class="hljs-string">'-'</span>).<span class="hljs-title function_">pop</span>(), <span class="hljs-number">10</span>);
      <span class="hljs-keyword">return</span> indexA - indexB;
    });

  <span class="hljs-comment">// 创建可写流，合并切片</span>
  <span class="hljs-keyword">const</span> writeStream = fs.<span class="hljs-title function_">createWriteStream</span>(mergeFilePath);
  <span class="hljs-keyword">let</span> mergedSize = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> chunkname <span class="hljs-keyword">of</span> chunkFilenames) {
      <span class="hljs-comment">// 创建可读流，读取切片</span>
      <span class="hljs-keyword">const</span> chunkPath = path.<span class="hljs-title function_">join</span>(chunkHashDir, chunkname);
      <span class="hljs-comment">// 读取切片</span>
      <span class="hljs-keyword">const</span> data = fs.<span class="hljs-title function_">readFileSync</span>(chunkPath);
      <span class="hljs-comment">// 写入合并后的文件</span>
      writeStream.<span class="hljs-title function_">write</span>(data);
      <span class="hljs-comment">// 累加合并后的文件大小</span>
      mergedSize += data.<span class="hljs-property">length</span>;
      <span class="hljs-comment">// 删除已合并的切片</span>
      fs.<span class="hljs-title function_">unlinkSync</span>(chunkPath);
    }
    <span class="hljs-comment">// 删除空目录</span>
    fs.<span class="hljs-title function_">rmdirSync</span>(chunkHashDir);
    <span class="hljs-comment">// 合并完成后关闭流</span>
    writeStream.<span class="hljs-title function_">end</span>();
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'合并失败!'</span>, <span class="hljs-attr">error</span>: err.<span class="hljs-property">message</span> });
  }

  res.<span class="hljs-title function_">send</span>({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'文件合并成功'</span>,
    <span class="hljs-attr">file</span>: {
      fileHash,
      <span class="hljs-attr">size</span>: mergedSize,
      <span class="hljs-attr">path</span>: mergeFilePath,
      chunkFilenames
    }
  });
});
</code></pre>
<h2 data-id="heading-23">总结</h2>
<p>本文使用文件对象的<code>slice</code>方法对大文件进行分片，使用<code>SparkMD5</code>对文件内容进行<code>hash</code>计算，并把计算过程执行在<code>Web Worker</code>线程当中，避免阻塞主线程；</p>
<p>实现<strong>分片上传</strong>的<strong>核心</strong>是使用文件<code>hash</code>和分片<strong>索引</strong>，对分片名称进行<strong>标识</strong>和<strong>排序</strong>，方便后端查找和排序分片，最后合并分片为一个完整的文件。</p>
<h2 data-id="heading-24">前后端完整源码</h2>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjava6688%2Fbig-file-upload" target="_blank" title="https://github.com/java6688/big-file-upload" ref="nofollow noopener noreferrer">大文件上传示例代码</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[对我来说，那个框架就是 Flutter。]]></title>    <link>https://juejin.cn/post/7570201730992472090</link>    <guid>https://juejin.cn/post/7570201730992472090</guid>    <pubDate>2025-11-10T01:26:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570201730992472090" data-draft-id="7566131671172890633" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="对我来说，那个框架就是 Flutter。"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-10T01:26:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JarvanMo"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565845704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            对我来说，那个框架就是 Flutter。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565845704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JarvanMo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T01:26:24.000Z" title="Mon Nov 10 2025 01:26:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    52
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>哪个程序员没经历过这事儿：老是心痒痒地想去试试下一个“爆款”新技术？</strong> 新框架一在 Twitter（或 X）上冒出来，博文就吹它是“颠覆者”，然后 YouTube 教程立马铺天盖地而来。</p>
<p>这种感觉我太懂了。那几年，我就是这么一个框架换一个框架地折腾——<a href="https://link.juejin.cn?target=https%3A%2F%2Freactnative.dev%2F" target="_blank" title="https://reactnative.dev/" ref="nofollow noopener noreferrer">React Native</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fionicframework.com%2F" target="_blank" title="https://ionicframework.com/" ref="nofollow noopener noreferrer">Ionic</a>，甚至还直接玩儿过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2F" target="_blank" title="https://kotlinlang.org/" ref="nofollow noopener noreferrer">Kotlin</a>。每个都说自己性能更顺畅、开发更快，或者发布应用更容易。可结果呢，每次试完一圈，我又回到了原地：<strong>人累了，思路也乱了，离我想做的项目还是一点没靠近。</strong></p>
<hr/>
<h2 data-id="heading-0">🚀 为什么我停止追逐“下一个大框架”</h2>
<p>在我下定决心使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fflutter.dev%2F" target="_blank" title="https://flutter.dev/" ref="nofollow noopener noreferrer">Flutter</a> 的时候，那种不断切换框架的循环就结束了。并不是说 Flutter 有多完美（剧透一下：它并不完美），而是因为它教会了我一个重要的道理：<strong>追逐框架给我带来的消耗，远大于它带来的好处。</strong></p>
<p>让我来告诉你，我为什么不再跑去追逐“下一个大框架”了——以及为什么坚持使用 Flutter，成了我职业生涯中最有价值的决定。</p>
<hr/>
<h3 data-id="heading-1">框架 FOMO（错失恐惧症）的陷阱</h3>
<p>开发者们特别容易陷入 <strong>FOMO（Fear of Missing Out，错失恐惧症）</strong> 的陷阱。技术圈子跑得飞快，当你看到“某公司用 Y 框架重写了他们的应用，业绩大涨”这类标题时，很容易觉得自己落伍了。</p>
<p>但关键在于：<strong>每个框架都有它的“蜜月期”</strong> 。早期使用者把它吹上天，社区热情高涨，各种教程让一切看起来毫不费力。然而，一旦你深入接触，你会发现还是老问题：工具链的各种怪癖、文档上的空白，以及那些可能耗费你数小时的随机 Bug。</p>
<p>不断切换框架让我有了<strong>广度，但没有深度</strong>。我成了一个“框架万事通，专业没一个”。而且我换得越多，实际的生产效率就越低。</p>
<hr/>
<h3 data-id="heading-2">为什么 Flutter 脱颖而出</h3>
<p>那为什么是 Flutter 呢？说实话，我不是对它一见钟情。一开始我很怀疑——“又一个跨平台框架？” 但随着我用它来做东西，有三点让我留了下来：</p>
<ul>
<li><strong>跨平台的一致性：</strong> Flutter 不只是给原生组件包一层壳。它的渲染引擎让我可以实现<strong>像素级的完美控制</strong>，无论是在 iOS、Android，甚至 Web 还是桌面端。再也不会出现那种在 Android 上看着没事，但在 iOS 上就错位的奇怪样式问题了。</li>
<li><strong>开发者体验：</strong> <strong>热重载（Hot Reload）</strong> 彻底改变了我的编码方式。快速迭代、即时看到 UI 变化、不用重启应用就能测试新想法——这感觉就像是框架在<strong>配合我</strong>工作，而不是处处跟我作对。</li>
<li><strong>社区和生态：</strong> Flutter 的社区很有热情，而且有 Google 撑腰，给了它长期的可信度。各种包（Packages）在不断成熟，文档有了巨大的进步，我很少感觉自己是在黑暗中独自摸索。</li>
</ul>
<p><strong>这一次，我不再觉得自己学的是临时性的东西了。我感觉自己是在投资一个能长久使用的工具。</strong></p>
<hr/>
<h3 data-id="heading-3">不断切换的隐性成本</h3>
<p>追逐框架不只是学习曲线带来的挫败感——它还有隐性成本：</p>
<ul>
<li><strong>脑力消耗：</strong> 每个框架都带有一套新的工具、新的调试技巧和新的怪癖。不停地切换会烧掉你的精力，而这些精力本可以用在开发真正的应用上。</li>
<li><strong>知识肤浅：</strong> 浅尝辄止多个框架意味着你很难真正精通任何一个。这在调试复杂问题或对应用进行扩展时会让你很痛苦。</li>
<li><strong>时间浪费：</strong> 说真的，用三种不同的框架把一个 Side Project 重写三次，这不叫成长。<strong>这是披着学习外衣的拖延症。</strong></li>
</ul>
<p>我意识到，我爱的其实是<strong>学习框架</strong>，而不是<strong>构建产品</strong>。Flutter 给了我所需要的稳定性，让我能重新专注于真正重要的事情：<strong>把东西交付出去（Shipping）。</strong></p>
<hr/>
<h3 data-id="heading-4">广度与深度，深度的力量</h3>
<p>坚持使用 Flutter 让我获得了深度成长，这是不断切换框架做不到的。我更深入地研究了状态管理模式、架构决策和性能优化。我做出来的 Side Project 不只是开了头，而是<strong>完成了</strong>。</p>
<p>深度带来了清晰度。我不再需要浪费时间去 Google 搜索“框架 X 怎么处理导航？”，而是对 Flutter 的生态系统了如指掌。这种信心会随着时间不断积累，让我成为一个更快、更可靠的开发者。</p>
<hr/>
<h3 data-id="heading-5">但 Flutter 是“永远的答案”吗？</h3>
<p>没有哪个框架是永恒的。Flutter 会发展，也许五到十年后会有更好的东西出现。但我学到的是，重点不在于挑选一个“完美”的框架，而在于<strong>挑选一个稳定的框架，并坚持足够长的时间去创造出有意义的作品。</strong></p>
<p>框架是工具。我们用它们创造出的价值才是最重要的。而 Flutter，恰好是我职业生涯这个阶段最适合我的工具。</p>
<hr/>
<h3 data-id="heading-6">给同行的建议</h3>
<p>如果你发现自己总是在切换框架，不妨问问自己：</p>
<ul>
<li>我是为了<strong>构建出真正的产品</strong>才学的，还是仅仅为了满足好奇心？</li>
<li>比起在一个新的生态里重新开始，我如果在一个生态里<strong>钻得更深</strong>会不会成长得更快？</li>
<li>我这种不断切换思路的成本到底有多大？</li>
</ul>
<p>探索是好的——它能让你思维更敏锐。但在某个节点，你得下定决心。对我来说，这个决心就是 <strong>Flutter</strong>。</p>
<hr/>
<h3 data-id="heading-7">最后的想法</h3>
<p>追逐“下一个大框架”感觉很刺激，但这其实就像在跑步机上。我跑得很快，但哪儿都没去。Flutter 给了我一个机会，让我可以走下跑步机，专注于真正的产品，并且作为一名开发者，<strong>获得了深度而非仅仅是广度上的成长。</strong></p>
<p>那么，我以后再也不会碰其他框架了吗？当然不是——我还会关注生态变化。但我不会再让炒作来干扰我的专注了。</p>
<p>说到底，框架来来去去。我们交付的代码、构建的应用，以及它们所创造的影响——<strong>那才是永恒的。</strong></p>
<p>对我来说，Flutter 就是帮助我实现这一切的工具。🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[历经4个月，基于 Tiptap 和 NestJs 打造一款 AI 驱动的智能文档协作平台 🚀🚀🚀]]></title>    <link>https://juejin.cn/post/7570271574348496905</link>    <guid>https://juejin.cn/post/7570271574348496905</guid>    <pubDate>2025-11-10T00:56:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570271574348496905" data-draft-id="7570271574348480521" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="历经4个月，基于 Tiptap 和 NestJs 打造一款 AI 驱动的智能文档协作平台 🚀🚀🚀"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-10T00:56:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            历经4个月，基于 Tiptap 和 NestJs 打造一款 AI 驱动的智能文档协作平台 🚀🚀🚀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T00:56:07.000Z" title="Mon Nov 10 2025 00:56:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>当 AI 技术刚刚兴起时，我加入了一家 AI 初创公司。由于我们在项目中有着对高级编辑功能的需求，我第一次接触到了 Tiptap。让我印象深刻的是，Tiptap 与其他编辑器相比，最大亮点在于它的灵活性和可扩展性。这种高度的定制能力，让我们能够根据需求随时调整和扩展编辑器的功能，完全满足了我们的独特要求。</p>
<p>经过一段时间的研究，我渐渐认为 Tiptap 应该是我未来选择的首选编辑器。另外现在公司很久就不干了，项目也没有上线，我完全可以复刻里面的核心功能。</p>
<p>现在在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codecrack.cn%2Fdashboard" target="_blank" title="https://www.codecrack.cn/dashboard" ref="nofollow noopener noreferrer">dashboard</a> 页面上能看到的基本就是将来要实现的核心功能了。</p>
<p>首先先贴相关地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">Github 地址</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codecrack.cn%2F" target="_blank" title="https://www.codecrack.cn/" ref="nofollow noopener noreferrer">在线预览</a></p>
<p>微信联系方式或加群：<code>yunmz777</code></p>
<h2 data-id="heading-0">项目介绍</h2>
<p>DocFlow 是一个基于 Tiptap 和 Yjs 构建的智能协作写作平台，类似飞书的文档功能，支持多人实时协作编辑。平台结合了 AI 生成内容和 RAG 知识库搜索，帮助用户在创作过程中快速获取相关信息，并提供智能写作建议。</p>
<p>DocFlow 还将具备类似 Dify 的工作流编排功能，用户可以创建自动化流程，定义不同任务和操作的执行顺序，实现任务的不同输入输出。通过这个功能，团队可以高效地管理创作过程，构建智能代理（Agent）来自动处理内容生成、文档整理等任务，极大提升生产力。</p>
<p>无论是文档写作、知识管理，还是复杂流程的自动化，DocFlow 都能提供强大的支持，帮助团队优化工作流并提升创作效率。</p>
<p>项目采用的 NextJs 和 NestJs 的全栈架构，</p>
<p>首选是前端的技术栈核心主要有以下几个：</p>
<ol>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2F" target="_blank" title="https://nextjs.org/" ref="nofollow noopener noreferrer">Next.js</a>：用于构建 React 应用，支持服务器端渲染（SSR）和静态生成（SSG），非常适合 SEO 优化和提升页面加载速度。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftiptap.dev%2F" target="_blank" title="https://tiptap.dev/" ref="nofollow noopener noreferrer">Tiptap</a>：现代化的富文本编辑器，支持高度定制和扩展，适合各种文档编辑需求，并与 React 集成良好。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2F" target="_blank" title="https://tailwindcss.com/" ref="nofollow noopener noreferrer">TailwindCSS</a>：通过实用类构建响应式和现代化界面的 CSS 框架，提高开发效率和灵活性。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.radix-ui.com%2F" target="_blank" title="https://www.radix-ui.com/" ref="nofollow noopener noreferrer">Radix UI</a>：提供高质量、无样式的 UI 组件库，帮助开发者快速构建无障碍和响应式界面。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.framer.com%2Fmotion%2F" target="_blank" title="https://www.framer.com/motion/" ref="nofollow noopener noreferrer">Framer Motion</a>： 用于 React 应用的动画库，提供丰富的动画效果，增强用户体验。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Fquery" target="_blank" title="https://tanstack.com/query" ref="nofollow noopener noreferrer">React Query</a>：高效的数据获取和同步库，用于管理远程数据的加载、缓存和同步。</p>
</li>
</ol>
<p>未来做流程编排的话会使用 React Flow。</p>
<p>后端核心技术：</p>
<ol>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnestjs.com%2F" target="_blank" title="https://nestjs.com/" ref="nofollow noopener noreferrer">NestJS</a>：用于构建高效、可扩展的 Node.js 后端应用，支持模块化开发和依赖注入，非常适合构建企业级应用。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.fastify.io%2F" target="_blank" title="https://www.fastify.io/" ref="nofollow noopener noreferrer">Fastify</a>： 高性能、低开销的 Node.js HTTP 框架，专注于优化速度，适合高并发和高效的 API 服务。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.prisma.io%2F" target="_blank" title="https://www.prisma.io/" ref="nofollow noopener noreferrer">Prisma</a>： 现代的 ORM 工具，提供类型安全的数据库查询支持，适用于 PostgreSQL、MySQL 等数据库。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudamqp.com%2F" target="_blank" title="https://www.cloudamqp.com/" ref="nofollow noopener noreferrer">MQ (消息队列)</a>： 用于处理异步任务和消息传递，支持高并发、高可靠性的数据传输和任务调度。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsocket.io%2F" target="_blank" title="https://socket.io/" ref="nofollow noopener noreferrer">Socket.io</a>：实时通信库，支持 WebSockets，帮助轻松实现实时消息推送和 Web 应用之间的实时通信。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain.com%2F" target="_blank" title="https://langchain.com/" ref="nofollow noopener noreferrer">Langchain</a>： 用于与多种语言模型（如 OpenAI 的 GPT）交互的框架，支持 AI 功能的集成，如文本生成、知识图谱等。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyjs.dev%2F" target="_blank" title="https://yjs.dev/" ref="nofollow noopener noreferrer">Yjs</a>：用于构建实时协作应用的框架，支持高效的数据同步，适合实时编辑和多人协作场景。</p>
</li>
</ol>
<h4 data-id="heading-1">目录结构</h4>
<p>目录结构采用比较常见的结构：</p>
<pre><code class="hljs language-tree" lang="tree">src/
├── app/                # Next.js 应用目录，包含页面路由、布局配置等
├── components/         # 可复用的 UI 组件库
├── extensions/         # Tiptap 编辑器的自定义扩展功能
├── hooks/              # 自定义 React Hooks
├── services/           # 业务逻辑服务层（如 API 调用、请求封装等）
├── stores/             # 状态管理（如使用 Zustand、Jotai 等）
├── styles/             # 全局样式和样式模块
├── types/              # 全局 TypeScript 类型定义
├── utils/              # 工具函数、辅助方法
├── worker/             # Web Worker 实现，用于异步或性能密集型任务
└── middleware.ts       # Next.js 中间件，用于请求拦截、认证控制等
</code></pre>
<p>其中 styles 里面包含了大量的 tiptap 的 css 样式，这些 CSS 文件用于为 Tiptap 提供完整的富文本样式支持。由于 Tiptap 是无头组件，所有样式（如段落、代码块、表格、列表、协同编辑等）都需自行定义。每个 CSS 文件针对一个功能模块进行样式分离，便于维护与扩展。这种拆分方式能保持样式结构清晰、职责明确。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/716300c203454023869475fe75a8d00a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=Y%2B%2B%2BUaBYGB8O%2BRJFLg3Zuq%2FmxKI%3D" alt="20250923084026" loading="lazy"/></p>
<p>每个文件代表不同插件的样式配置。例如，<code>code.css</code> 定义了代码块 <code>&lt;pre&gt;&lt;code&gt;</code> 的样式，包括背景色、字体、行号等，适配 <code>CodeBlock</code> 插件，并支持语法高亮效果。</p>
<p>在 <code>components</code> 目录下，组件被分为两个不同的分类：</p>
<ul>
<li>
<p>src 目录中的组件是全局公共组件或业务中可复用的组件，适用于多个页面或功能模块。</p>
</li>
<li>
<p>app 目录下的组件则是针对特定页面或布局路由组的业务组件，为避免与路由冲突，推荐将这些组件命名为 <code>_components</code>。</p>
</li>
</ul>
<h4 data-id="heading-2">核心模块</h4>
<h5 data-id="heading-3">Service 封装和调用</h5>
<p>service 目录下的 <code>request.ts</code> 为全局的 <code>fetch</code> 封装：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c909afc96314e999c00f91eeef8957a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=fQJFeeFplV69XQZJgHuYP4BSeUc%3D" alt="20250923084309" loading="lazy"/></p>
<p>这段代码封装了一个基于 <code>fetch</code> 的请求工具类，支持统一的请求拦截、超时控制、错误处理和自动重试等高级功能。它提供了 <code>get</code>、<code>post</code>、<code>put</code>、<code>delete</code>、<code>patch</code> 等 HTTP 请求方法，并返回统一格式的响应结果，方便在项目中稳定复用。</p>
<p>对于不同模块的请求，可以在 services 目录下创建新的子目录进行模块化封装。例如，对于 user 模块，可以在 <code>user</code> 目录下创建 <code>index.ts</code> 来封装函数逻辑，<code>type.ts</code> 用于定义接口的入参和出参类型。通过这种方式，不同模块的请求逻辑清晰分离，便于维护和扩展。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a2a861874ea47b398e7989d94acd2c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=lEgHHPGo1xxhJuG4I0RRjZB%2BlRA%3D" alt="image.png" loading="lazy"/></p>
<p>在实际调用时，无需显式使用 <code>try...catch</code> 来捕获错误。可以通过传入不同的错误处理逻辑，统一的 <code>fetch</code> 实例会自动处理错误并执行相应的处理方式。</p>
<h5 data-id="heading-4">Tiptap</h5>
<p>借助 Tiptap 强大的扩展功能，我们可以在原有基础上轻松添加所需的功能，甚至可以在 Tiptap 上扩展整个页面。</p>
<p>创建扩展时，一般遵循以下原则：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Node</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@tiptap/core"</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">NodeViewWrapper</span>, <span class="hljs-comment">// 用于包装 React 组件为 NodeView</span>
  <span class="hljs-title class_">ReactNodeViewRenderer</span>, <span class="hljs-comment">// 用于包裹 React 节点，Tiptap 会识别它作为 NodeView 的容器</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">"@tiptap/react"</span>;

<span class="hljs-comment">// 👉 你的自定义组件（实际渲染逻辑）</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyReactComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./MyReactComponent"</span>;

<span class="hljs-comment">// 👉 定义扩展</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">MyNode</span> = <span class="hljs-title class_">Node</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"myNode"</span>, <span class="hljs-comment">// 节点名称，必须唯一</span>
  <span class="hljs-attr">group</span>: <span class="hljs-string">"block"</span>, <span class="hljs-comment">// 节点分组，可选 block / inline / list</span>
  <span class="hljs-attr">atom</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 原子节点，不可编辑内部内容</span>
  <span class="hljs-attr">draggable</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否允许拖拽移动</span>
  <span class="hljs-attr">inline</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否是 inline 类型，默认为 block</span>

  <span class="hljs-comment">// HTML -&gt; Node 映射（反序列化）</span>
  <span class="hljs-title function_">parseHTML</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> [
      {
        <span class="hljs-attr">tag</span>: <span class="hljs-string">'div[data-type="my-node"]'</span>, <span class="hljs-comment">// 将 HTML 标签映射到该节点</span>
      },
    ];
  },

  <span class="hljs-comment">// Node -&gt; HTML 映射（序列化）</span>
  <span class="hljs-title function_">renderHTML</span>(<span class="hljs-params">{ HTMLAttributes }</span>) {
    <span class="hljs-keyword">return</span> [
      <span class="hljs-string">"div"</span>,
      { ...<span class="hljs-title class_">HTMLAttributes</span>, <span class="hljs-string">"data-type"</span>: <span class="hljs-string">"my-node"</span> }, <span class="hljs-comment">// 使用自定义数据属性</span>
      <span class="hljs-string">""</span>, <span class="hljs-comment">// 空的内容，原子节点不包含可编辑内容</span>
    ];
  },

  <span class="hljs-comment">// 客户端渲染视图（NodeView）—— 仅在浏览器中执行</span>
  <span class="hljs-title function_">addNodeView</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 仅在客户端执行 NodeView 渲染</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">"undefined"</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">ReactNodeViewRenderer</span>(<span class="hljs-title class_">MyReactComponent</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// SSR 时跳过 NodeView</span>
  },

  <span class="hljs-comment">// 自定义命令：插入该节点</span>
  <span class="hljs-title function_">addCommands</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">insertMyNode</span>:
        <span class="hljs-function">() =&gt;</span>
        <span class="hljs-function">(<span class="hljs-params">{ commands }</span>) =&gt;</span> {
          <span class="hljs-keyword">return</span> commands.<span class="hljs-title function_">insertContent</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>,
          });
        },
    };
  },
});
</code></pre>
<p>创建完成之后可以在这里添加并导出：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5dfa192c43246a4866d98f881fdf14f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=ig70A8sw1Dx63YBotOTmwN31%2BAM%3D" alt="20250923084804" loading="lazy"/></p>
<p>这两个文件都要。</p>
<h5 data-id="heading-5">Prisma</h5>
<p>Prisma 非常好用，懂的都懂，项目目前 Mysql 的架构如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/396b5cbd58644d48808cc183b0574633~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=4kJuiqWVpewzJwgolof7lWvtq3I%3D" alt="20250923092635" loading="lazy"/></p>
<h5 data-id="heading-6">Rabbitmq</h5>
<p>目前项目中的 AI 播客生成采用消息队列机制进行处理，主要是因为 TTS 接口存在较高的请求并发。通过使用消息队列，我们确保每次只处理一个请求，从而避免了并发请求对系统性能的影响。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61f9408866724ec2b53a41cff6fe1532~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=OYn%2FYzwrvM2CFO3TcFD2Wo07Nfg%3D" alt="20250923163214" loading="lazy"/></p>
<h2 data-id="heading-7">功能展示</h2>
<h3 data-id="heading-8">协同编辑</h3>
<p>协同编辑我们可以再文档这里点击文件进行分享，并且可以设置文件的权限以及是否需要密码等：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/268079e703b747b98a6740683a076a7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=6bat0oIBr2IGHmARjkdoLlQ33y8%3D" alt="20250923174959" loading="lazy"/></p>
<p>之后可以将这个 URL 分享给其他用户，点击之后会有这样的效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a2a5660df5a49ab99276ed3f57bd504~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=jc6IleveeFlQfBdzeT3PQC7tz4Y%3D" alt="20250923175045" loading="lazy"/></p>
<p>这个功能跟百度网盘之类的分享类似，这里的主要使用了 RBAC 和 ACL 进行权限控制。</p>
<p>之后我们就可以进行协同编辑了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aedcf6842f7442adb742e63b8999e8e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=jaAk2nngFKNFXrKxLtP2nHzHzHk%3D" alt="output.gif" loading="lazy"/></p>
<h3 data-id="heading-9">AI 续写和 AI 问答</h3>
<p>AI 续写和 AI 问答的功能正在逐步实现，目前以及支持 RAG 了，先看效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34f061b856c349cdadc722a0c9d4ab39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=AfTsVdhH2PhlPJdsWqaprUDvZZk%3D" alt="continue.gif" loading="lazy"/></p>
<p>上面的是续写的，接下来展示 AI 问答的，首先我们可以上传我们自己的一些内容：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ec71db6892c4f3d889a31052089fdc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=rjPizlOpDDlXpL3zm1NKkYIZqoQ%3D" alt="20250923182314" loading="lazy"/></p>
<p>之后我们执行 AI 问答：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25e04abf36414adcbd4972c795ae604f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=xtYPv%2FqGFA8NwXfX%2FCdZDTnKk5A%3D" alt="20250923182418" loading="lazy"/></p>
<p>你可以看到我们添加的内容被我们输出到了这里了，这个就是我们当前的 RAG 的功能，当然后续会继续增强：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70bd0fd961d346009265538bd12446a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=WYGAscg5Ym1y3WnuShzabbi00fA%3D" alt="20250923182554" loading="lazy"/></p>
<p>他的原理如下流程图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1aa164498134d7ca1e138e44dfadb39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=hHBlonBxbC%2Fmpln3o6xjAIIYObw%3D" alt="image.png" loading="lazy"/></p>
<p>从文档处理角度来看，实现流程如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3709c07259544ada985fd43ee5640542~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=LApUV4R4An6pu04fuFc%2F56tVCjc%3D" alt="20250923183138" loading="lazy"/></p>
<h3 data-id="heading-10">AI 播客</h3>
<p>AI 播客处理流程是用户上传简历和选择相对应的面试官，但是最好是相同简历对应面试官类型，不然可能生成出来的内容乱七八糟的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3724a28049644525b0f0f8cbe0bda515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=CxZUjh6LtnI6h87Gw72%2Fh29LFm4%3D" alt="20250923183508" loading="lazy"/></p>
<h3 data-id="heading-11">其他</h3>
<p>关于编辑器里面还有很多内容没有介绍到，更多的可自行体验:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/735843b624ec4454963873465b7404ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=3eZbFrtUsiJ9v%2FdKBc3eXVx0BVE%3D" alt="20250923183627" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04ef7ba8aa0e42d8b72b454ce75a45c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=n%2Bg162vDDQBtjA20mKyQxr4f4Bo%3D" alt="20250923183658" loading="lazy"/></p>
<p>后续会继续增强，添加导入导出等功能。</p>
<h2 data-id="heading-12">未来</h2>
<p>将来要做的内容非常核心，例如侧边栏这边的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f0e6e9a0fee4ddb92a84540602f036c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=qIAxFFo%2FpJo7GmJDt6I23OpX530%3D" alt="20250923183820" loading="lazy"/></p>
<p>除了前面讲了这这些 Agent 和流程编排，将来还会实现如下核心功能：</p>
<ol>
<li>
<p>添加组织，增强权限管理。</p>
</li>
<li>
<p>对应文档支持评论功能</p>
</li>
<li>
<p>接入 Sentry 埋点监控</p>
</li>
<li>
<p>后端接入 Prometheus 监控</p>
</li>
</ol>
<h2 data-id="heading-13">总结</h2>
<p>如果你对 AI 应用与富文本编辑器生态感兴趣，欢迎为本仓库点亮 Star 并开启 Watch，获取最新迭代。</p>
<p>希望了解更多服务（企业咨询、插件定制、参与开发、私有化部署等），请添加微信 <code>yunmz777</code>（备注：DocFlow）。我将邀请你进入技术交流群，与一线开发者交流实践经验、获取路线图。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">Github 地址</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codecrack.cn%2F" target="_blank" title="https://www.codecrack.cn/" ref="nofollow noopener noreferrer">在线预览</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我用AI重构了一段500行的屎山代码，这是我的Prompt和思考过程]]></title>    <link>https://juejin.cn/post/7570630923710054452</link>    <guid>https://juejin.cn/post/7570630923710054452</guid>    <pubDate>2025-11-10T04:06:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570630923710054452" data-draft-id="7570533058840739875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我用AI重构了一段500行的屎山代码，这是我的Prompt和思考过程"/> <meta itemprop="keywords" content="前端,JavaScript,架构"/> <meta itemprop="datePublished" content="2025-11-10T04:06:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我用AI重构了一段500行的屎山代码，这是我的Prompt和思考过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T04:06:06.000Z" title="Mon Nov 10 2025 04:06:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb98623d8769476daf7d1403c737a111~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763352366&amp;x-signature=Hvk6BXnS9P%2BYX5MAILrp0denCkI%3D" alt="image.png" loading="lazy"/></p>
<p>大家好，我来了🙂。</p>
<p>我们团队，维护着一个有5年历史的史诗级中后台项目😖。在这座屎山里，有一个叫<code>handleOrderSubmit.js</code>的文件。</p>
<p>可以下载瞧一瞧 有多屎👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpub-e8cc0cb9ebf94a2386b76f4ac3ac6ad2.r2.dev%2FhandleOrderSubmit.js" target="_blank" title="https://pub-e8cc0cb9ebf94a2386b76f4ac3ac6ad2.r2.dev/handleOrderSubmit.js" ref="nofollow noopener noreferrer">handleOrderSubmit.js</a></p>
<p>它是一个<strong>长达500多行</strong>的React <code>useEffect</code> 钩子函数（是的，你没看错，一个<code>useEffect</code>）。</p>
<p>它混合了订单数据的<strong>本地校验</strong>、<strong>价格计算</strong>、<strong>优惠券应用</strong>、<strong>API请求</strong>、<strong>全局状态更新</strong>、以及<strong>错误弹窗处理</strong>... 所有的逻辑，都塞在一个函数里，用<code>if/else</code>和<code>try/catch</code>层层嵌套。</p>
<p><strong>没人敢动它😖。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40160288790c4322a54fa4ec39e1a6ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763352366&amp;x-signature=p9brzeAHElowFo7kT0xLwhguEpE%3D" alt="本事试试看.gif" loading="lazy"/></p>
<p>每次产品经理提一个小需求，比如在提交订单时，增加一种新的优惠券类型，我们整个团队的表情都像被雷劈了。因为我们知道，改这个函数，要么加班一周，要么就等着P0级事故。</p>
<p>上周，产品经理要求我们在这个函数里，加入一个全新的风控逻辑。</p>
<p>我评估了一下，手动重构，至少需要一个资深工程师一周的时间，而且风险极大。</p>
<p>我受够了。我决定，把这个烫手的任务，扔给我的实习生——<strong>AI</strong>（我用的是GPT-5 mini，穷😂）。</p>
<p>这篇文章，就是我人机协作，啃下这块硬骨头的完整复盘，大家继续看。</p>
<hr/>
<h4 data-id="heading-0"><strong>我不能直接说重构它</strong></h4>
<p>我犯的第一个错误，是直接把500行代码贴给AI，然后说：<strong>帮我重构这段代码</strong>。</p>
<p>AI很听话，它给我的，是一段看起来更整洁的代码——它把<code>if/else</code>换成了<code>switch</code>，提了几个变量... <strong>这不叫重构，这叫重新排版</strong>，毫无意义。</p>
<p>我很快意识到：<strong>AI是一个能力超强、但没有灵魂的执行者。我，作为开发者，必须给它提供一个清晰的方案。</strong></p>
<p>于是，我制定了一个<strong>五步重构法</strong>。</p>
<hr/>
<h4 data-id="heading-1"><strong>我的Prompt和思考</strong></h4>
<p>我的核心思想是：<strong>AI负责执行，我负责决策。</strong> 我要像一个指挥家一样，一步一步地引导AI，把这500行的代码，拆解成高内聚、低耦合的模块。</p>
<h5 data-id="heading-2"><strong>第一步：先让AI读懂屎山</strong></h5>
<p>我不能上来就让AI改。我得先确认，它和我对这段代码的理解，在一个频道上。</p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>你是一个资深的React架构师。请分析下面这段500行的<code>useEffect</code>代码。</p>
<ol>
<li><strong>告诉我它做了几件主要的事情？（职责分析）</strong></li>
<li><strong>找出所有的副作用</strong>（比如API请求、<code>localStorage</code>操作、全局状态更新）。</li>
<li><strong>找出所有的纯逻辑</strong>（比如数据校验、价格计算）。</li>
<li><strong>评价它的可维护性和可测试性</strong>。</li>
</ol>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35d5a1e7897d4611b2e6063d63081384~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763352366&amp;x-signature=aXLE5rLPbGHmYg3X5B3MvGtaHaM%3D" alt="image.png" loading="lazy"/></p>
<p>GPT的回答，给了我一个惊喜。它清晰地列出了：</p>
<ol>
<li><strong>职责</strong>：它承担了至少5个职责：表单校验、价格计算、库存检查、创建订单、处理UI反馈。</li>
<li><strong>副作用</strong>：<code>api.post(...)</code>, <code>setLoading(true)</code>, <code>showToast(...)</code>...</li>
<li><strong>纯逻辑</strong>：<code>validateForm(...)</code>, <code>calculateTotalPrice(...)</code>...</li>
<li><strong>评价</strong>：可维护性极低，单一职责原则被严重违反，几乎不可测试。</li>
</ol>
<p>很好，AI看懂了！我们就可以可以开始了😁。</p>
<h5 data-id="heading-3"><strong>第二步：先分离纯逻辑代码</strong></h5>
<p>这是最关键的一步。我要把计算和动作分开。</p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>非常好。现在，请你<strong>只针对纯逻辑部分</strong>（表单校验、价格计算）进行重构。</p>
<ol>
<li>把这些逻辑，从原函数中<strong>提取</strong>出来，变成<strong>独立的、可导出的纯函数</strong>。</li>
<li>这些函数必须是纯的：<strong>不能有任何副作用</strong>（不能调用<code>api</code>或<code>setLoading</code>）。</li>
<li><strong>使用TypeScript</strong>，为这些新函数的入参和返回值，提供清晰的类型定义。</li>
</ol>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d384affa5b6b488db2870ea7a7f2e350~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763352366&amp;x-signature=yC3uRhUdQgDBQbR2mBv1aKp6ZuM%3D" alt="image.png" loading="lazy"/></p>
<p>AI立刻唰唰唰地给了我几个文件：</p>
<p><code>validate.ts</code>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">validateOrder</span>(<span class="hljs-params">formData: OrderForm</span>): <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">if</span> (!formData.<span class="hljs-property">user</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'用户信息不能为空'</span>;
  <span class="hljs-keyword">if</span> (formData.<span class="hljs-property">items</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'商品不能为空'</span>;
  <span class="hljs-comment">// ... 10 more rules</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><code>calculator.ts</code>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateTotalPrice</span>(<span class="hljs-params">items: Item[], coupon: Coupon</span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">let</span> total = items.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, item</span>) =&gt;</span> sum + item.<span class="hljs-property">price</span> * item.<span class="hljs-property">quantity</span>, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">if</span> (coupon.<span class="hljs-property">type</span> === <span class="hljs-string">'PERCENT'</span>) {
    total *= (<span class="hljs-number">1</span> - coupon.<span class="hljs-property">value</span> / <span class="hljs-number">100</span>);
  }
  <span class="hljs-comment">// ... 20 more rules</span>
  <span class="hljs-keyword">return</span> total;
}
</code></pre>
<h5 data-id="heading-4"><strong>第三步：让AI为自己的代码做测试</strong></h5>
<p>我怎么知道AI提炼的逻辑，是对的还是错的？
<strong>答案：让它自己写单元测试来证明。</strong></p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>你现在是一个QA工程师。请使用<code>Vitest</code>，为你刚才提取的<code>validateOrder</code>和<code>calculateTotalPrice</code>这两个函数，<strong>编写全面的单元测试用例</strong>。
必须覆盖所有边界情况，包括正常、异常、和边缘值。</p>
</blockquote>
<p>AI再次给了我惊喜。它生成的测试用例，比我手写的还要全：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// calculator.test.ts</span>
<span class="hljs-keyword">import</span> { describe, it, expect } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitest'</span>;
<span class="hljs-keyword">import</span> { calculateTotalPrice } <span class="hljs-keyword">from</span> <span class="hljs-string">'./calculator'</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">'calculateTotalPrice'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should return 0 for empty cart'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">calculateTotalPrice</span>([], <span class="hljs-literal">null</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">0</span>);
  });
  
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should apply percent coupon'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> items = [{ <span class="hljs-attr">price</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">1</span> }];
    <span class="hljs-keyword">const</span> coupon = { <span class="hljs-attr">type</span>: <span class="hljs-string">'PERCENT'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">10</span> };
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">calculateTotalPrice</span>(items, coupon)).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">90</span>);
  });
  <span class="hljs-comment">// ... 省略更多</span>
});
</code></pre>
<p>我把这些测试用例跑了一遍，<strong>全部通过</strong>。我现在信心大增😁。</p>
<h5 data-id="heading-5"><strong>第四步：重写协调层</strong></h5>
<p>现在，纯逻辑已经被分离并验证了。原来的500行屎山，只剩下副作用和流程控制代码了。是时候重写它了。</p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>干得漂亮。现在，我们来重构那个<strong>原始的<code>useEffect</code>函数</strong>。</p>
<ol>
<li>它现在唯一的职责是<strong>协调</strong>。</li>
<li><strong>调用</strong>我们刚才创建的<code>validateOrder</code>和<code>calculateTotalPrice</code>纯函数。</li>
<li>把所有的副作用（API请求、<code>setLoading</code>、<code>showToast</code>）<strong>清晰地编排</strong>起来。</li>
<li><strong>使用<code>async/await</code></strong>，让异步流程更清晰，用<code>try/catch</code>处理错误。</li>
</ol>
</blockquote>
<p>这次，AI给我的，是一个只有<strong>30行</strong>左右的、清晰的流程代码：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 重构后的 useEffect</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">submitOrder</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 协调：验证 (纯)</span>
      <span class="hljs-keyword">const</span> errorMsg = <span class="hljs-title function_">validateOrder</span>(formData);
      <span class="hljs-keyword">if</span> (errorMsg) {
        <span class="hljs-title function_">showToast</span>(errorMsg);
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 2. 协调：计算 (纯)</span>
      <span class="hljs-keyword">const</span> totalPrice = <span class="hljs-title function_">calculateTotalPrice</span>(formData.<span class="hljs-property">items</span>, formData.<span class="hljs-property">coupon</span>);

      <span class="hljs-comment">// 3. 协调：副作用（不纯）</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/order/submit'</span>, { ...formData, totalPrice });
      
      <span class="hljs-comment">// 4. 协调：响应（不纯）</span>
      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-title function_">showToast</span>(<span class="hljs-string">'订单提交成功！'</span>);
        router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/success'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">showToast</span>(result.<span class="hljs-property">message</span>);
      }
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-title function_">showToast</span>(err.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    }
  };

  <span class="hljs-keyword">if</span> (isSubmitting) { <span class="hljs-comment">// 假设一个触发条件</span>
    <span class="hljs-title function_">submitOrder</span>();
    <span class="hljs-title function_">setIsSubmitting</span>(<span class="hljs-literal">false</span>);
  }
}, [isSubmitting, formData <span class="hljs-comment">/* ...其他依赖 */</span>]);
</code></pre>
<h5 data-id="heading-6"><strong>第五步：最后守卫工作，加入新功能</strong></h5>
<p>别忘了，我重构的目的，是为了加风控这个新功能。</p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>最后一步。请在API请求之前，加入一个风控检查的逻辑（调用<code>riskControl.check(...)</code>）。这是一个异步函数，如果检查不通过，它会抛出一个错误。</p>
</blockquote>
<p>AI在第2步和第3步之间，加了几行代码，完美收工。</p>
<hr/>
<p>这次重构，我总共花了大概5个小时，而不是原计划的一周。</p>
<p>总觉得 AI 不会淘汰会写代码的工程师。</p>
<p>只会降维打击那些只会堆砌代码的工程师。</p>
<p>那段500行的屎山，在过去，是我的噩梦；现在，有了AI的帮助，它变成了我的靶场。</p>
<p>这种感觉，真爽🙌。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 2.x 和 3.x 的核心区别，这些变化你必须知道]]></title>    <link>https://juejin.cn/post/7570191839593332799</link>    <guid>https://juejin.cn/post/7570191839593332799</guid>    <pubDate>2025-11-10T00:34:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570191839593332799" data-draft-id="7564573165705216015" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 2.x 和 3.x 的核心区别，这些变化你必须知道"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-11-10T00:34:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 2.x 和 3.x 的核心区别，这些变化你必须知道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T00:34:08.000Z" title="Mon Nov 10 2025 00:34:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>大家好，我是大华！有很多朋友不知道<code>Springboot2.x和3.x</code>有什么区别，用着感觉都差不多。其实3.x是一个重大版本升级。</p>
<h4 data-id="heading-1">为什么 Spring Boot 3.x 这么重要？</h4>
<p>因为它不仅仅是加了几个新功能，而是<strong>整个技术地基都变了</strong>。</p>
<p>下面我们举几个例子来了解一下。</p>
<hr/>
<h3 data-id="heading-2">1. 包名的更新：<code>javax</code> → <code>jakarta</code></h3>
<p>这是2.x升级到3.x时，<strong>改动最大的地方</strong>。</p>
<h4 data-id="heading-3">Spring Boot 2.x（老代码）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;

<span class="hljs-meta">@Entity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-comment">// getter/setter</span>
}
</code></pre>
<h4 data-id="heading-4">Spring Boot 3.x（新代码）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> jakarta.persistence.Entity;  <span class="hljs-comment">// 注意：javax → jakarta</span>
<span class="hljs-keyword">import</span> jakarta.persistence.Id;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletRequest; <span class="hljs-comment">// 同样变了</span>

<span class="hljs-meta">@Entity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-comment">// getter/setter</span>
}
</code></pre>
<p><strong>划重点</strong>：</p>
<ul>
<li>所有 <code>javax.*</code> 都要改成 <code>jakarta.*</code>！</li>
<li>如果你用的是 JPA、Servlet、Validation 等技术，<strong>几乎每个 Java 文件都要改</strong>。</li>
<li>建议使用 IDE 的全局替换功能，但要小心第三方库是否支持。</li>
</ul>
<hr/>
<h3 data-id="heading-5">2. 安全配置</h3>
<p>Spring Boot 3.x 默认使用 <strong>Spring Security 6</strong>，配置方式大变。</p>
<h4 data-id="heading-6">Spring Boot 2.x 配置方式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSecurity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http
            .authorizeRequests()
                .antMatchers(<span class="hljs-string">"/public/**"</span>).permitAll()
                .anyRequest().authenticated()
            .and()
            .formLogin();
    }
}
</code></pre>
<p>注意：<code>WebSecurityConfigurerAdapter</code>在<code>Spring Security 6</code>中<strong>已被废弃</strong>！</p>
<h4 data-id="heading-7">Spring Boot 3.x 推荐方式（使用 Lambda DSL）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSecurity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">filterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http
            .authorizeHttpRequests(authz -&gt; authz
                .requestMatchers(<span class="hljs-string">"/public/**"</span>).permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(form -&gt; form
                .loginPage(<span class="hljs-string">"/login"</span>)
                .permitAll()
            );
        <span class="hljs-keyword">return</span> http.build();
    }
}
</code></pre>
<p><strong>好处</strong>：</p>
<ul>
<li>更函数式，代码更清晰。</li>
<li>不用继承，更灵活。</li>
<li>编译时就能发现错误，而不是运行时报错。</li>
</ul>
<hr/>
<h3 data-id="heading-8">3. 原生镜像（GraalVM）</h3>
<p>Spring Boot 3.x 原生支持 GraalVM，可以把 Java 应用编译成<strong>原生可执行文件</strong>。</p>
<h4 data-id="heading-9">如何启用原生镜像？</h4>
<p>在 <code>pom.xml</code> 中加入插件：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.graalvm.buildtools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>native-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre>
<p>然后运行：</p>
<pre><code class="hljs language-bash" lang="bash">./mvnw -Pnative native:compile
</code></pre>
<p>编译完成后，你会得到一个<strong>不依赖 JVM 的可执行文件</strong>，比如 <code>myapp</code>。</p>
<p>运行它：</p>
<pre><code class="hljs language-bash" lang="bash">./myapp
</code></pre>
<p>你会发现：</p>
<ul>
<li>启动时间：从 5 秒 → <strong>0.1 秒</strong></li>
<li>内存占用：从 300MB → <strong>50MB</strong></li>
</ul>
<p>特别适合：Serverless、微服务、边缘计算等资源敏感场景。</p>
<hr/>
<h3 data-id="heading-10">4. 云原生支持：Liveness 和 Readiness</h3>
<p>Spring Boot 3.x 的健康检查更专业，适合 Kubernetes。</p>
<h4 data-id="heading-11">配置 <code>application.yml</code></h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoint:</span>
    <span class="hljs-attr">health:</span>
      <span class="hljs-attr">show-details:</span> <span class="hljs-string">always</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">health,info,liveness,readiness</span>
</code></pre>
<h4 data-id="heading-12">访问新端点</h4>
<ul>
<li><code>GET /actuator/health/liveness</code> → 检查应用是否“活着”（是否崩溃）</li>
<li><code>GET /actuator/health/readiness</code> → 检查应用是否“就绪”（是否可以接收流量）</li>
</ul>
<p>K8s 可以用这两个接口做更精准的健康检查，避免误杀或误导流。</p>
<hr/>
<h3 data-id="heading-13">那我现在该升级吗？</h3>
<p>看情况！分两种：</p>
<h4 data-id="heading-14">推荐升级的情况：</h4>
<ul>
<li><strong>新项目</strong>：直接上 Spring Boot 3.x + Java 17！</li>
<li><strong>想玩原生镜像</strong>：追求极致性能和启动速度。</li>
<li><strong>云原生项目</strong>：用 K8s、微服务架构。</li>
</ul>
<h4 data-id="heading-15">暂缓升级的情况：</h4>
<ul>
<li><strong>还在用 Java 8</strong>：必须先升级 JDK。</li>
<li><strong>依赖老旧库</strong>：比如某些中间件 SDK 还不支持 <code>jakarta</code>。</li>
<li><strong>项目稳定，无大改动</strong>：可以等下次大版本迭代时再升级。</li>
</ul>
<hr/>
<h3 data-id="heading-16">总结对比表</h3>








































<table><thead><tr><th>特性</th><th>Spring Boot 2.x</th><th>Spring Boot 3.x</th></tr></thead><tbody><tr><td><strong>最低 Java 版本</strong></td><td>Java 8</td><td><strong>Java 17</strong></td></tr><tr><td><strong>包名</strong></td><td><code>javax.*</code></td><td><code>jakarta.*</code></td></tr><tr><td><strong>原生镜像</strong></td><td>不支持</td><td><strong>原生支持</strong></td></tr><tr><td><strong>Spring Security</strong></td><td>继承 <code>WebSecurityConfigurerAdapter</code></td><td>使用 <strong>DSL 配置</strong></td></tr><tr><td><strong>云原生支持</strong></td><td><code>/health</code></td><td><code>/liveness</code>, <code>/readiness</code></td></tr><tr><td><strong>未来支持</strong></td><td>逐渐停止</td><td><strong>主推版本</strong></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">最后一句话</h3>
<p>SpringBoot3.x不是可选项，而是<strong>Java 开发现代化的必经之路</strong>。</p>
<p>早点了解，早点准备，别等到公司要求升级时，你还在问“<code>javax</code>和<code>jakarta</code>有啥区别？”</p>
<p>另外<code>SpringBoot4.x</code>很快就发布正式版了，可以关注一下。</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-18">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FP7SMincYFKERZbNKAFtzGQ" target="_blank" title="https://mp.weixin.qq.com/s/P7SMincYFKERZbNKAFtzGQ" ref="nofollow noopener noreferrer">《这20条SQL优化方案，让你的数据库查询速度提升10倍》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fy-GJ26kl0-yT6hE3fy2KjQ" target="_blank" title="https://mp.weixin.qq.com/s/y-GJ26kl0-yT6hE3fy2KjQ" ref="nofollow noopener noreferrer">《MySQL 为什么不推荐用雪花ID 和 UUID 做主键？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1Th3DuMqYpt4Xg5hEywIww" target="_blank" title="https://mp.weixin.qq.com/s/1Th3DuMqYpt4Xg5hEywIww" ref="nofollow noopener noreferrer">《用html写了个超好用的网页主题切换插件》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FfSMv8b_2Z-kozaBeiCgqrA" target="_blank" title="https://mp.weixin.qq.com/s/fSMv8b_2Z-kozaBeiCgqrA" ref="nofollow noopener noreferrer">《SpringBoot3+Vue3实现的数据库文档工具》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[几种虚拟列表技术方案调研]]></title>    <link>https://juejin.cn/post/7570162686580523050</link>    <guid>https://juejin.cn/post/7570162686580523050</guid>    <pubDate>2025-11-10T01:55:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570162686580523050" data-draft-id="7569798982941999140" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="几种虚拟列表技术方案调研"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-10T01:55:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="至简简"/> <meta itemprop="url" content="https://juejin.cn/user/4212984286819384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            几种虚拟列表技术方案调研
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984286819384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    至简简
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T01:55:17.000Z" title="Mon Nov 10 2025 01:55:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    21
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<h3 data-id="heading-1">什么是虚拟列表？</h3>
<p>虚拟列表（Virtual List）是一种优化长列表渲染性能的技术。其核心思想是<strong>只渲染可见区域的列表项</strong>，而不是渲染所有数据。当用户滚动时，动态地创建和销毁 DOM 元素，从而大幅减少 DOM 节点数量，提升渲染性能。</p>
<p>本篇文章中，笔者从Vue3的技术框架来讲解虚拟列表不同场景中的用法，不涉及虚拟列表的原理。社区里有很多讲解虚拟列表的原理的文章，笔者不再赘述。笔者从虚拟列表的分类上统筹每一种虚拟列表技术方案，并给出参考示例。</p>
<h3 data-id="heading-2">为什么使用虚拟列表？</h3>
<p><strong>传统列表的性能瓶颈：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 渲染 10000 条数据</span>
<span class="hljs-keyword">const</span> items = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">10000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i)

<span class="hljs-comment">// ❌ 传统方式：创建 10000 个 DOM 节点</span>
&lt;div v-<span class="hljs-keyword">for</span>=<span class="hljs-string">"item in items"</span> :key=<span class="hljs-string">"item"</span>&gt;{{ item }}&lt;/div&gt;
<span class="hljs-comment">// 结果：首次渲染缓慢、滚动卡顿、内存占用高</span>
</code></pre>
<p><strong>虚拟列表的优势：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 虚拟列表：只渲染可见的 ~10-20 个节点</span>
<span class="hljs-comment">// 即使有 10000 条数据，DOM 中只有可见区域的节点</span>
<span class="hljs-comment">// 结果：快速渲染、流畅滚动、低内存占用</span>
</code></pre>
<h3 data-id="heading-3">@vueuse/core 简介</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fvueuse.org%2F" target="_blank" title="https://vueuse.org/" ref="nofollow noopener noreferrer">@vueuse/core</a> 是一个强大的 Vue 3 组合式 API 工具集，其中 <code>useVirtualList</code> 提供了开箱即用的虚拟列表解决方案。后续所有的示例代码均使用 <code>useVirtualList</code> 实现</p>
<p><strong>快速开始</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install @vueuse/core
<span class="hljs-comment"># 或</span>
pnpm add @vueuse/core
</code></pre>
<p>不得不说，Vue的技术生态中，很多第三方依赖开箱即用，这一点非常棒！</p>
<h2 data-id="heading-4">useVirtualList API 详解</h2>
<h3 data-id="heading-5">基本用法</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useVirtualList } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vueuse/core'</span>

<span class="hljs-keyword">const</span> { list, containerProps, wrapperProps } = <span class="hljs-title function_">useVirtualList</span>(
  items,    <span class="hljs-comment">// 数据源</span>
  options   <span class="hljs-comment">// 配置选项</span>
)
</code></pre>
<h3 data-id="heading-6">参数说明</h3>
<h4 data-id="heading-7">items (必需)</h4>
<p><strong>类型：</strong> <code>MaybeRef&lt;T[]&gt;</code><br/>
<strong>说明：</strong> 要渲染的数据数组，可以是响应式引用或普通数组</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方式 1: 响应式引用</span>
<span class="hljs-keyword">const</span> items = <span class="hljs-title function_">ref</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, ...])

<span class="hljs-comment">// 方式 2: 普通数组</span>
<span class="hljs-keyword">const</span> items = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, ...]

<span class="hljs-comment">// 方式 3: computed</span>
<span class="hljs-keyword">const</span> items = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> originalData.<span class="hljs-title function_">filter</span>(...))
</code></pre>
<h4 data-id="heading-8">options (必需)</h4>
<p><strong>类型：</strong> <code>UseVirtualListOptions</code></p>























<table><thead><tr><th>选项</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>itemHeight</code></td><td><code>number | (index: number) =&gt; number</code></td><td><strong>必需</strong></td><td>项目高度，可以是固定值或计算函数</td></tr><tr><td><code>overscan</code></td><td><code>number</code></td><td><code>5</code></td><td>预渲染的额外项目数量，提升滚动流畅度</td></tr></tbody></table>
<h3 data-id="heading-9">返回值说明</h3>
<h4 data-id="heading-10">list</h4>
<p><strong>类型：</strong> <code>ComputedRef&lt;ListItem&lt;T&gt;[]&gt;</code><br/>
<strong>说明：</strong> 当前应该渲染的列表项数组</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ListItem</span>&lt;T&gt; {
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>    <span class="hljs-comment">// 在原数组中的索引</span>
  <span class="hljs-attr">data</span>: T         <span class="hljs-comment">// 原始数据</span>
}
</code></pre>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;div v-for="item in list" :key="item.index"&gt;
  &lt;div&gt;索引: {{ item.index }}&lt;/div&gt;
  &lt;div&gt;数据: {{ item.data }}&lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h4 data-id="heading-11">containerProps (非常重要)</h4>
<p><strong>类型：</strong> <code>Object</code><br/>
<strong>说明：</strong> 需要绑定到容器元素的属性对象</p>
<p><strong>包含属性：</strong></p>
<ul>
<li><code>ref</code>: 容器的引用</li>
<li><code>onScroll</code>: 滚动事件处理函数</li>
<li><code>style</code>: 容器样式（可能包含 overflow 等）</li>
</ul>
<p><strong>使用方式：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;div v-bind="containerProps" style="height: 400px; overflow-y: auto;"&gt;
  &lt;!-- 内容 --&gt;
&lt;/div&gt;
</code></pre>
<h4 data-id="heading-12">wrapperProps (非常重要)</h4>
<p><strong>类型：</strong> <code>Object</code><br/>
<strong>说明：</strong> 需要绑定到包装器元素的属性对象</p>
<p><strong>包含属性：</strong></p>
<ul>
<li><code>style</code>: 包装器样式，包含计算的总高度</li>
</ul>
<p><strong>作用：</strong></p>
<ul>
<li>设置内部容器的总高度（基于所有项目的总高度）</li>
<li>创建正确的滚动区域</li>
<li>支持虚拟化定位</li>
</ul>
<p><strong>使用方式：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;div v-bind="containerProps"&gt;
  &lt;div v-bind="wrapperProps"&gt;
    &lt;!-- 列表项 --&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h3 data-id="heading-13">工作原理</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5900c2e31e3b4f7cafe7d17c335d4d88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iez566A566A:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763345274&amp;x-signature=xqul89Zk8kzLIxbUgnhlULmCCJI%3D" alt="image.png" loading="lazy"/></p>
<p><strong>关键点：</strong></p>
<ol>
<li><strong>容器（Container）：</strong> 固定高度，overflow 可滚动</li>
<li><strong>包装器（Wrapper）：</strong> 高度 = 所有项目的总高度</li>
<li><strong>列表项：</strong> 只渲染可见区域的项目 （useVirtualList返回的 listitems）</li>
</ol>
<h2 data-id="heading-14">四种虚拟列表实现方案</h2>
<p>经过笔者的调研，主要有四种虚拟列表技术方案</p>
<h3 data-id="heading-15">固定项高度 + 固定容器高度</h3>
<h4 data-id="heading-16">📌 方案特点</h4>
<ul>
<li><strong>项目高度：</strong> 固定（如 50px）</li>
<li><strong>容器高度：</strong> 固定（如 400px）</li>
<li><strong>适用场景：</strong> 标准列表、表格、聊天记录等统一高度的场景</li>
</ul>
<h4 data-id="heading-17">🎯 适用场景</h4>

























<table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td>数据列表</td><td>表格数据、商品列表、用户列表</td></tr><tr><td>日志查看器</td><td>系统日志、操作记录</td></tr><tr><td>聊天记录</td><td>简单文本消息列表</td></tr><tr><td>文件浏览器</td><td>文件/文件夹列表</td></tr></tbody></table>
<h4 data-id="heading-18">💻 完整实现代码</h4>
<p><strong>组件代码：</strong> <code>FixedHeightVirtualList.vue</code></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from "vue";
import { useVirtualList } from "@vueuse/core";

const props = defineProps({
  items: {
    type: Array,
    default: () =&gt; [],
    required: true,
  },
  itemHeight: {
    type: Number,
    default: 50,
  },
  containerHeight: {
    type: Number,
    default: 400,
  },
});

const container = ref(null);

// 🔑 关键配置：itemHeight 为固定数值
const { list, containerProps, wrapperProps } = useVirtualList(props.items, {
  itemHeight: props.itemHeight,  // 固定高度
  overscan: 5,
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div
    ref="container"
    class="virtual-list-container"
    :style="{ height: `${containerHeight}px` }"  &lt;!-- 固定容器高度 --&gt;
    v-bind="containerProps"
  &gt;
    &lt;div class="virtual-list-wrapper" v-bind="wrapperProps"&gt;
      &lt;div
        v-for="item in list"
        :key="item.index"
        class="virtual-list-item"
        :style="{ height: `${itemHeight}px` }"  &lt;!-- 固定项目高度 --&gt;
      &gt;
        &lt;div class="item-content"&gt;
          &lt;span class="item-index"&gt;{{ item.data.id }}&lt;/span&gt;
          &lt;span class="item-text"&gt;{{ item.data.name }}&lt;/span&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.virtual-list-container {
  overflow: hidden;  /* 🔑 关键：overflow hidden */
  border: 1px solid #e8e8e8;
  border-radius: 8px;
}

.virtual-list-item {
  display: flex;
  align-items: center;
  border-bottom: 1px solid #f0f0f0;
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-19">📝 使用示例</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from 'vue'
import FixedHeightVirtualList from './components/FixedHeightVirtualList.vue'

const items = ref(
  Array.from({ length: 1000 }, (_, index) =&gt; ({
    id: index + 1,
    name: `项目 ${index + 1}`
  }))
)
&lt;/script&gt;

&lt;template&gt;
  &lt;FixedHeightVirtualList
    :items="items"
    :item-height="50"
    :container-height="400"
  /&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-20">✅ 优点</h4>
<ul>
<li>实现简单，性能最优</li>
<li>滚动最流畅</li>
<li>计算开销最小</li>
</ul>
<h4 data-id="heading-21">❌ 缺点</h4>
<ul>
<li>所有项目必须高度一致</li>
<li>容器高度固定，不够灵活</li>
</ul>
<hr/>
<h3 data-id="heading-22">固定项高度 + 动态容器高度</h3>
<h4 data-id="heading-23">🌊 方案特点</h4>
<ul>
<li><strong>项目高度：</strong> 固定（如 50px）</li>
<li><strong>容器高度：</strong> 动态自适应（max-height）</li>
<li><strong>适用场景：</strong> 响应式布局、下拉菜单、弹窗列表</li>
</ul>
<h4 data-id="heading-24">🎯 适用场景</h4>





























<table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td>下拉选择器</td><td>数据量不确定的下拉列表</td></tr><tr><td>搜索建议</td><td>搜索结果列表（数量动态变化）</td></tr><tr><td>弹窗列表</td><td>Modal 中的列表内容</td></tr><tr><td>侧边栏菜单</td><td>响应式侧边导航</td></tr><tr><td>响应式布局</td><td>需要适应不同屏幕尺寸</td></tr></tbody></table>
<h4 data-id="heading-25">💻 完整实现代码</h4>
<p><strong>组件代码：</strong> <code>DynamicHeightVirtualList.vue</code></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from "vue";
import { useVirtualList } from "@vueuse/core";

const props = defineProps({
  items: {
    type: Array,
    default: () =&gt; [],
    required: true,
  },
  itemHeight: {
    type: Number,
    default: 50,
  },
  maxHeight: {
    type: Number,
    default: 500,
  },
});

const container = ref(null);

// 🔑 关键配置：itemHeight 为固定数值
const { list, containerProps, wrapperProps } = useVirtualList(props.items, {
  itemHeight: props.itemHeight,
  overscan: 5,
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div
    ref="container"
    class="virtual-list-container"
    :style="{ maxHeight: `${maxHeight}px` }"  &lt;!-- 🔑 max-height 实现动态 --&gt;
    v-bind="containerProps"
  &gt;
    &lt;div class="virtual-list-wrapper" v-bind="wrapperProps"&gt;
      &lt;div
        v-for="item in list"
        :key="item.index"
        class="virtual-list-item"
        :style="{ height: `${itemHeight}px` }"
      &gt;
        &lt;div class="item-content"&gt;
          &lt;span class="item-index"&gt;{{ item.data.id }}&lt;/span&gt;
          &lt;span class="item-text"&gt;{{ item.data.name }}&lt;/span&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.virtual-list-container {
  overflow-y: auto;  /* 🔑 关键：overflow-y auto */
  border: 1px solid #e8e8e8;
  border-radius: 8px;
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-26">📝 使用示例</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from 'vue'
import DynamicHeightVirtualList from './components/DynamicHeightVirtualList.vue'

// 数据量少
const fewItems = ref(
  Array.from({ length: 4 }, (_, index) =&gt; ({
    id: index + 1,
    name: `项目 ${index + 1}`
  }))
)

// 数据量多
const manyItems = ref(
  Array.from({ length: 1000 }, (_, index) =&gt; ({
    id: index + 1,
    name: `项目 ${index + 1}`
  }))
)
&lt;/script&gt;

&lt;template&gt;
  &lt;!-- 数据少时，容器高度 = 4 * 50 = 200px --&gt;
  &lt;DynamicHeightVirtualList
    :items="fewItems"
    :item-height="50"
    :max-height="400"
  /&gt;

  &lt;!-- 数据多时，容器高度 = max-height = 400px，出现滚动条 --&gt;
  &lt;DynamicHeightVirtualList
    :items="manyItems"
    :item-height="50"
    :max-height="400"
  /&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-27">🔄 关键差异对比</h4>






























<table><thead><tr><th>属性</th><th>固定容器</th><th>动态容器</th></tr></thead><tbody><tr><td>容器样式</td><td><code>height: 400px</code></td><td><code>max-height: 400px</code></td></tr><tr><td>overflow</td><td><code>overflow: hidden</code></td><td><code>overflow-y: auto</code></td></tr><tr><td>数据少时</td><td>仍占据 400px</td><td>自动缩小</td></tr><tr><td>数据多时</td><td>显示滚动条</td><td>显示滚动条</td></tr></tbody></table>
<h4 data-id="heading-28">✅ 优点</h4>
<ul>
<li>容器高度自适应，更灵活</li>
<li>数据少时不浪费空间</li>
<li>性能依然优秀</li>
</ul>
<h4 data-id="heading-29">❌ 缺点</h4>
<ul>
<li>需要正确处理 overflow-y</li>
<li>布局可能因高度变化而跳动</li>
</ul>
<hr/>
<h3 data-id="heading-30">动态项高度 + 固定容器高度</h3>
<h4 data-id="heading-31">🎨 方案特点</h4>
<ul>
<li><strong>项目高度：</strong> 动态计算（通过函数）</li>
<li><strong>容器高度：</strong> 固定（如 450px）</li>
<li><strong>适用场景：</strong> 多样化内容、卡片列表、复杂布局</li>
</ul>
<h4 data-id="heading-32">🎯 适用场景</h4>





























<table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td>新闻列表</td><td>标题长度不一，内容预览不同</td></tr><tr><td>卡片流</td><td>不同类型的卡片高度不同</td></tr><tr><td>评论列表</td><td>评论内容长度不一</td></tr><tr><td>商品展示</td><td>不同商品信息复杂度不同</td></tr><tr><td>邮件列表</td><td>带附件、标签等额外信息</td></tr></tbody></table>
<h4 data-id="heading-33">💻 完整实现代码</h4>
<p><strong>组件代码：</strong> <code>VariableHeightVirtualList.vue</code></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from "vue";
import { useVirtualList } from "@vueuse/core";

const props = defineProps({
  items: {
    type: Array,
    default: () =&gt; [],
    required: true,
  },
  containerHeight: {
    type: Number,
    default: 400,
  },
});

const container = ref(null);

// 🔑 关键：动态计算每个项的高度
const getItemHeight = (index) =&gt; {
  // 方式 1: 根据索引模式
  const heightPattern = index % 3;
  if (heightPattern === 0) return 60;  // 小项
  if (heightPattern === 1) return 80;  // 中项
  return 100;                          // 大项
  
  // 方式 2: 根据数据内容
  // const item = props.items[index];
  // return item.type === 'large' ? 100 : 50;
  
  // 方式 3: 根据文本长度
  // const textLength = props.items[index].text.length;
  // return Math.max(50, Math.ceil(textLength / 20) * 30);
};

// 🔑 关键配置：itemHeight 为函数
const { list, containerProps, wrapperProps } = useVirtualList(props.items, {
  itemHeight: getItemHeight,  // 函数，不是数值！
  overscan: 5,
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div
    ref="container"
    class="virtual-list-container"
    :style="{ height: `${containerHeight}px` }"
    v-bind="containerProps"
  &gt;
    &lt;div class="virtual-list-wrapper" v-bind="wrapperProps"&gt;
      &lt;div
        v-for="item in list"
        :key="item.index"
        class="virtual-list-item"
        :style="{ height: `${getItemHeight(item.index)}px` }"  &lt;!-- 动态高度 --&gt;
        :data-height="getItemHeight(item.index)"
      &gt;
        &lt;div class="item-content"&gt;
          &lt;span class="item-index"&gt;{{ item.data.id }}&lt;/span&gt;
          &lt;div class="item-info"&gt;
            &lt;span class="item-text"&gt;{{ item.data.name }}&lt;/span&gt;
            &lt;span class="item-height-tag"&gt;高度: {{ getItemHeight(item.index) }}px&lt;/span&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.virtual-list-container {
  overflow: hidden;
}

/* 根据高度添加不同的视觉样式 */
.virtual-list-item[data-height="60"] {
  background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
}

.virtual-list-item[data-height="80"] {
  background: linear-gradient(135deg, #e6f7ff 0%, #ffffff 100%);
}

.virtual-list-item[data-height="100"] {
  background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%);
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-34">📝 使用示例</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from 'vue'
import VariableHeightVirtualList from './components/VariableHeightVirtualList.vue'

const items = ref(
  Array.from({ length: 400 }, (_, index) =&gt; ({
    id: index + 1,
    name: `项目 ${index + 1}`
  }))
)
&lt;/script&gt;

&lt;template&gt;
  &lt;VariableHeightVirtualList
    :items="items"
    :container-height="450"
  /&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-35">🎨 高度计算函数示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 示例 1: 基于索引的规律模式</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-number">50</span> + (index % <span class="hljs-number">3</span>) * <span class="hljs-number">25</span>;  <span class="hljs-comment">// 50, 75, 100 循环</span>
};

<span class="hljs-comment">// 示例 2: 基于数据类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">const</span> item = props.<span class="hljs-property">items</span>[index];
  <span class="hljs-keyword">switch</span>(item.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'header'</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">80</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'content'</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">120</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'footer'</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">60</span>;
    <span class="hljs-attr">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">50</span>;
  }
};

<span class="hljs-comment">// 示例 3: 基于内容长度</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">const</span> item = props.<span class="hljs-property">items</span>[index];
  <span class="hljs-keyword">const</span> textLength = item.<span class="hljs-property">description</span>?.<span class="hljs-property">length</span> || <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> lines = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(textLength / <span class="hljs-number">40</span>);  <span class="hljs-comment">// 假设每行 40 字符</span>
  <span class="hljs-keyword">return</span> <span class="hljs-number">50</span> + (lines - <span class="hljs-number">1</span>) * <span class="hljs-number">20</span>;  <span class="hljs-comment">// 基础高度 + 额外行高度</span>
};

<span class="hljs-comment">// 示例 4: 基于属性组合</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">const</span> item = props.<span class="hljs-property">items</span>[index];
  <span class="hljs-keyword">let</span> height = <span class="hljs-number">60</span>;  <span class="hljs-comment">// 基础高度</span>
  <span class="hljs-keyword">if</span> (item.<span class="hljs-property">hasImage</span>) height += <span class="hljs-number">200</span>;
  <span class="hljs-keyword">if</span> (item.<span class="hljs-property">hasTags</span>) height += <span class="hljs-number">30</span>;
  <span class="hljs-keyword">if</span> (item.<span class="hljs-property">hasActions</span>) height += <span class="hljs-number">40</span>;
  <span class="hljs-keyword">return</span> height;
};
</code></pre>
<h4 data-id="heading-36">⚠️ 重要注意事项</h4>
<ol>
<li><strong>高度必须可预测：</strong> <code>getItemHeight(index)</code> 对同一个 index 必须始终返回相同的值</li>
<li><strong>性能考虑：</strong> 函数会被频繁调用，避免复杂计算</li>
<li><strong>实际高度匹配：</strong> CSS 实际高度必须与计算高度一致</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误：随机高度（不可预测）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-number">50</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">50</span>;  <span class="hljs-comment">// 每次调用结果不同！</span>
};

<span class="hljs-comment">// ❌ 错误：异步计算</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>(index);  <span class="hljs-comment">// 不支持异步！</span>
  <span class="hljs-keyword">return</span> data.<span class="hljs-property">height</span>;
};

<span class="hljs-comment">// ✅ 正确：可预测、同步</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">return</span> props.<span class="hljs-property">items</span>[index].<span class="hljs-property">preCalculatedHeight</span>;  <span class="hljs-comment">// 提前计算好的高度</span>
};
</code></pre>
<h4 data-id="heading-37">✅ 优点</h4>
<ul>
<li>支持不同高度的项目</li>
<li>容器高度固定，布局稳定</li>
<li>视觉效果更丰富</li>
</ul>
<h4 data-id="heading-38">❌ 缺点</h4>
<ul>
<li>高度必须提前可计算</li>
<li>不支持真正的动态内容（如图片加载后才知道高度）</li>
<li>计算开销略高于固定高度</li>
</ul>
<hr/>
<h3 data-id="heading-39">动态项高度 + 动态容器高度</h3>
<h4 data-id="heading-40">🌈 方案特点</h4>
<ul>
<li><strong>项目高度：</strong> 动态计算（通过函数）</li>
<li><strong>容器高度：</strong> 动态自适应（max-height）</li>
<li><strong>适用场景：</strong> 最灵活的场景，结合前三种优势</li>
</ul>
<h4 data-id="heading-41">🎯 适用场景</h4>





























<table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td>复杂弹窗</td><td>弹窗内的复杂列表，高度不确定</td></tr><tr><td>搜索结果</td><td>不同类型的搜索结果混合</td></tr><tr><td>通知中心</td><td>不同类型通知，数量动态变化</td></tr><tr><td>购物车</td><td>不同商品信息，数量动态</td></tr><tr><td>活动页面</td><td>不同类型的活动卡片</td></tr></tbody></table>
<h4 data-id="heading-42">💻 完整实现代码</h4>
<p><strong>组件代码：</strong> <code>FullyDynamicVirtualList.vue</code></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from "vue";
import { useVirtualList } from "@vueuse/core";

const props = defineProps({
  items: {
    type: Array,
    default: () =&gt; [],
    required: true,
  },
  maxHeight: {
    type: Number,
    default: 500,
  },
});

const container = ref(null);

// 🔑 关键：动态计算每个项的高度
const getItemHeight = (index) =&gt; {
  const heightPattern = index % 3;
  if (heightPattern === 0) return 60;
  if (heightPattern === 1) return 80;
  return 100;
};

// 🔑 关键配置：itemHeight 为函数 + 容器使用 max-height
const { list, containerProps, wrapperProps } = useVirtualList(props.items, {
  itemHeight: getItemHeight,
  overscan: 5,
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div
    ref="container"
    class="virtual-list-container"
    :style="{ maxHeight: `${maxHeight}px` }"  &lt;!-- 🔑 max-height 动态容器 --&gt;
    v-bind="containerProps"
  &gt;
    &lt;div class="virtual-list-wrapper" v-bind="wrapperProps"&gt;
      &lt;div
        v-for="item in list"
        :key="item.index"
        class="virtual-list-item"
        :style="{ height: `${getItemHeight(item.index)}px` }"
        :data-height="getItemHeight(item.index)"
      &gt;
        &lt;div class="item-content"&gt;
          &lt;span class="item-index"&gt;{{ item.data.id }}&lt;/span&gt;
          &lt;div class="item-info"&gt;
            &lt;span class="item-text"&gt;{{ item.data.name }}&lt;/span&gt;
            &lt;span class="item-height-tag"&gt;高度: {{ getItemHeight(item.index) }}px&lt;/span&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.virtual-list-container {
  overflow-y: auto;  /* 🔑 关键：overflow-y auto */
  border: 1px solid #e8e8e8;
  border-radius: 8px;
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-43">📝 使用示例</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from 'vue'
import FullyDynamicVirtualList from './components/FullyDynamicVirtualList.vue'

const items = ref(
  Array.from({ length: 200 }, (_, index) =&gt; ({
    id: index + 1,
    name: `项目 ${index + 1}`
  }))
)
&lt;/script&gt;

&lt;template&gt;
  &lt;FullyDynamicVirtualList
    :items="items"
    :max-height="600"
  /&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-44">🎯 适配不同数据量</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 数据少：容器自动缩小 --&gt;
  &lt;FullyDynamicVirtualList
    :items="[1, 2, 3]"
    :max-height="400"
  /&gt;
  &lt;!-- 实际高度约: 60 + 80 + 100 = 240px --&gt;

  &lt;!-- 数据多：容器达到最大高度，显示滚动条 --&gt;
  &lt;FullyDynamicVirtualList
    :items="Array(200)"
    :max-height="400"
  /&gt;
  &lt;!-- 实际高度: 400px (max-height) --&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-45">✅ 优点</h4>
<ul>
<li>最大的灵活性</li>
<li>项目高度可变</li>
<li>容器高度自适应</li>
<li>适应各种复杂场景</li>
</ul>
<h4 data-id="heading-46">❌ 缺点</h4>
<ul>
<li>实现相对复杂</li>
<li>需要同时处理两种动态性</li>
<li>性能略低于前三种方案</li>
</ul>
<hr/>
<h2 data-id="heading-47">性能对比与最佳实践</h2>
<h3 data-id="heading-48">性能对比</h3>








































<table><thead><tr><th>方案</th><th>性能</th><th>灵活性</th><th>实现难度</th><th>适用场景</th></tr></thead><tbody><tr><td>固定+固定</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐</td><td>⭐</td><td>标准列表</td></tr><tr><td>固定+动态</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐</td><td>响应式布局</td></tr><tr><td>动态+固定</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>多样化内容</td></tr><tr><td>动态+动态</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>复杂场景</td></tr></tbody></table>
<h3 data-id="heading-49">渲染效率对比</h3>
<p><strong>测试条件：</strong> 10,000 条数据</p>















































<table><thead><tr><th>方案</th><th>DOM 节点数</th><th>首次渲染时间</th><th>滚动 FPS</th><th>内存占用</th></tr></thead><tbody><tr><td>传统列表</td><td>10,000</td><td>~2000ms</td><td>&lt;30 FPS</td><td>~50MB</td></tr><tr><td>虚拟列表（固定+固定）</td><td>~15</td><td>~50ms</td><td>60 FPS</td><td>~5MB</td></tr><tr><td>虚拟列表（固定+动态）</td><td>~15</td><td>~50ms</td><td>60 FPS</td><td>~5MB</td></tr><tr><td>虚拟列表（动态+固定）</td><td>~15</td><td>~60ms</td><td>55-60 FPS</td><td>~5MB</td></tr><tr><td>虚拟列表（动态+动态）</td><td>~15</td><td>~60ms</td><td>55-60 FPS</td><td>~5MB</td></tr></tbody></table>
<h3 data-id="heading-50">方案选择决策树</h3>
<pre><code class="hljs">开始
  │
  ├─ 所有项目高度是否相同？
  │   ├─ 是 ──&gt; 容器高度是否固定？
  │   │         ├─ 是 ──&gt; 【方案1: 固定+固定】最优性能 ⭐⭐⭐⭐⭐
  │   │         └─ 否 ──&gt; 【方案2: 固定+动态】响应式布局 ⭐⭐⭐⭐⭐
  │   │
  │   └─ 否 ──&gt; 容器高度是否固定？
  │             ├─ 是 ──&gt; 【方案3: 动态+固定】多样化内容 ⭐⭐⭐⭐
  │             └─ 否 ──&gt; 【方案4: 动态+动态】最大灵活性 ⭐⭐⭐⭐
</code></pre>
<h3 data-id="heading-51">最佳实践</h3>
<h4 data-id="heading-52">overscan 参数调优</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基础配置</span>
<span class="hljs-attr">overscan</span>: <span class="hljs-number">5</span>  <span class="hljs-comment">// 默认值，适合大多数场景</span>

<span class="hljs-comment">// 快速滚动场景</span>
<span class="hljs-attr">overscan</span>: <span class="hljs-number">10</span>  <span class="hljs-comment">// 增加预渲染，防止白屏</span>

<span class="hljs-comment">// 性能敏感场景</span>
<span class="hljs-attr">overscan</span>: <span class="hljs-number">3</span>  <span class="hljs-comment">// 减少预渲染，降低开销</span>

<span class="hljs-comment">// 移动端</span>
<span class="hljs-attr">overscan</span>: <span class="hljs-number">8</span>  <span class="hljs-comment">// 移动端滚动更快，建议增加</span>
</code></pre>
<h4 data-id="heading-53">高度计算缓存</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 不推荐：每次都计算</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">const</span> item = props.<span class="hljs-property">items</span>[index];
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">calculateComplexHeight</span>(item);  <span class="hljs-comment">// 复杂计算</span>
};

<span class="hljs-comment">// ✅ 推荐：缓存计算结果</span>
<span class="hljs-keyword">const</span> heightCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">if</span> (heightCache.<span class="hljs-title function_">has</span>(index)) {
    <span class="hljs-keyword">return</span> heightCache.<span class="hljs-title function_">get</span>(index);
  }
  
  <span class="hljs-keyword">const</span> item = props.<span class="hljs-property">items</span>[index];
  <span class="hljs-keyword">const</span> height = <span class="hljs-title function_">calculateComplexHeight</span>(item);
  heightCache.<span class="hljs-title function_">set</span>(index, height);
  <span class="hljs-keyword">return</span> height;
};

<span class="hljs-comment">// 数据变化时清除缓存</span>
<span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">items</span>, <span class="hljs-function">() =&gt;</span> {
  heightCache.<span class="hljs-title function_">clear</span>();
}, { <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span> });
</code></pre>
<h4 data-id="heading-54">响应式优化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 不推荐：直接传入响应式对象</span>
<span class="hljs-keyword">const</span> items = <span class="hljs-title function_">reactive</span>([...]);

<span class="hljs-comment">// ✅ 推荐：使用 ref</span>
<span class="hljs-keyword">const</span> items = <span class="hljs-title function_">ref</span>([...]);

<span class="hljs-comment">// ✅ 更好：使用 shallowRef（大数据量）</span>
<span class="hljs-keyword">const</span> items = <span class="hljs-title function_">shallowRef</span>([...]);
</code></pre>
<h4 data-id="heading-55">大数据量优化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 数据量 &gt; 50,000 时的优化策略</span>

<span class="hljs-comment">// 1. 使用 shallowRef</span>
<span class="hljs-keyword">const</span> items = <span class="hljs-title function_">shallowRef</span>(largeDataArray);

<span class="hljs-comment">// 2. 增加 overscan</span>
<span class="hljs-attr">overscan</span>: <span class="hljs-number">15</span>

<span class="hljs-comment">// 3. 防抖滚动事件（如果需要自定义处理）</span>
<span class="hljs-keyword">const</span> handleScroll = <span class="hljs-title function_">useDebounceFn</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 处理滚动</span>
}, <span class="hljs-number">16</span>);  <span class="hljs-comment">// 约 60fps</span>

<span class="hljs-comment">// 4. 虚拟滚动条（可选）</span>
<span class="hljs-comment">// 使用自定义滚动条替代原生滚动条</span>
</code></pre>
<h4 data-id="heading-56">避免常见错误</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误 1：在模板中直接访问原数组</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in items"</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 错误！应该用 list --&gt;</span>
    {{ item }}
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="hljs-comment">// ✅ 正确：使用 list</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in list"</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 正确！--&gt;</span>
    {{ item.data }}
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="hljs-comment">// ❌ 错误 2：忘记绑定 props</span>
&lt;div class="container"&gt;  &lt;!-- 错误！缺少 v-bind --&gt;
  &lt;div class="wrapper"&gt;  &lt;!-- 错误！缺少 v-bind --&gt;

// ✅ 正确：绑定 containerProps 和 wrapperProps
&lt;div v-bind="containerProps"&gt;
  &lt;div v-bind="wrapperProps"&gt;

// ❌ 错误 3：高度计算不准确
.item {
  height: 50px;
  padding: 10px;  /* 实际高度 = 50 + 20 = 70px */
}

// ✅ 正确：确保计算高度包含 padding/border
itemHeight: 70  // 或使用 box-sizing: border-box
</code></pre>
<hr/>
<h2 data-id="heading-57">常见问题与解决方案</h2>
<h3 data-id="heading-58">滚动位置跳动</h3>
<p><strong>问题：</strong> 滚动时列表位置跳动</p>
<p><strong>原因：</strong> 计算高度与实际高度不匹配</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 使用 box-sizing: border-box</span>
.<span class="hljs-property">virtual</span>-list-item {
  box-<span class="hljs-attr">sizing</span>: border-box;
  <span class="hljs-attr">height</span>: 50px;  <span class="hljs-comment">/* 包含 padding 和 border */</span>
  <span class="hljs-attr">padding</span>: 10px;
}

<span class="hljs-comment">// 2. 确保高度计算准确</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">const</span> baseHeight = <span class="hljs-number">50</span>;
  <span class="hljs-keyword">const</span> padding = <span class="hljs-number">20</span>;  <span class="hljs-comment">// top + bottom</span>
  <span class="hljs-keyword">const</span> border = <span class="hljs-number">2</span>;    <span class="hljs-comment">// top + bottom</span>
  <span class="hljs-keyword">return</span> baseHeight + padding + border;
};
</code></pre>
<h3 data-id="heading-59">首次渲染白屏</h3>
<p><strong>问题：</strong> 首次加载时短暂白屏</p>
<p><strong>原因：</strong> overscan 太小或数据加载慢</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 增加 overscan</span>
<span class="hljs-attr">overscan</span>: <span class="hljs-number">10</span>

<span class="hljs-comment">// 2. 添加骨架屏</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"loading"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">SkeletonItem</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"i in 10"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"i"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"containerProps"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 虚拟列表 --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="hljs-comment">// 3. 预加载数据</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
  loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  items.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
  loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
});
</code></pre>
<h3 data-id="heading-60">滚动到指定位置</h3>
<p><strong>问题：</strong> 如何滚动到指定索引的项目</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方法 1: 计算滚动位置（固定高度）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToIndex</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">const</span> scrollTop = index * itemHeight;
  container.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span> = scrollTop;
};

<span class="hljs-comment">// 方法 2: 计算滚动位置（动态高度）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToIndex</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">let</span> scrollTop = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; index; i++) {
    scrollTop += <span class="hljs-title function_">getItemHeight</span>(i);
  }
  container.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span> = scrollTop;
};

<span class="hljs-comment">// 方法 3: 使用 scrollIntoView</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToIndex</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-comment">// 需要在 list 中找到对应的元素</span>
  <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">`[data-index="<span class="hljs-subst">${index}</span>"]`</span>);
  element?.<span class="hljs-title function_">scrollIntoView</span>({ <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span>, <span class="hljs-attr">block</span>: <span class="hljs-string">'start'</span> });
};
</code></pre>
<h3 data-id="heading-61">数据更新后滚动位置重置</h3>
<p><strong>问题：</strong> 数据更新后滚动位置跳回顶部</p>
<p><strong>原因：</strong> items 引用变化导致重新计算</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误：直接赋值新数组</span>
items.<span class="hljs-property">value</span> = newData;  <span class="hljs-comment">// 引用变化，滚动位置重置</span>

<span class="hljs-comment">// ✅ 正确：保持引用，修改内容</span>
<span class="hljs-comment">// 方法 1: 使用 splice</span>
items.<span class="hljs-property">value</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, items.<span class="hljs-property">value</span>.<span class="hljs-property">length</span>, ...newData);

<span class="hljs-comment">// 方法 2: 逐项更新</span>
newData.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
  items.<span class="hljs-property">value</span>[index] = item;
});

<span class="hljs-comment">// 方法 3: 记录并恢复滚动位置</span>
<span class="hljs-keyword">const</span> scrollTop = container.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span>;
items.<span class="hljs-property">value</span> = newData;
<span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
  container.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span> = scrollTop;
});
</code></pre>
<h3 data-id="heading-62">在 TypeScript 中使用</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { ref, <span class="hljs-title class_">Ref</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { useVirtualList, <span class="hljs-title class_">UseVirtualListOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vueuse/core'</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ListItem</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  description?: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">items</span>: <span class="hljs-title class_">Ref</span>&lt;<span class="hljs-title class_">ListItem</span>[]&gt; = <span class="hljs-title function_">ref</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Item 1'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Item 2'</span> }
])

<span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">UseVirtualListOptions</span> = {
  <span class="hljs-attr">itemHeight</span>: <span class="hljs-number">50</span>,
  <span class="hljs-attr">overscan</span>: <span class="hljs-number">5</span>
}

<span class="hljs-keyword">const</span> { list, containerProps, wrapperProps } = <span class="hljs-title function_">useVirtualList</span>(items, options)

<span class="hljs-comment">// list 的类型是 ComputedRef&lt;{ index: number; data: ListItem }[]&gt;</span>
</code></pre>
<h3 data-id="heading-63">服务端渲染 (SSR) 支持</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在 SSR 环境中，需要注意以下几点：</span>

<span class="hljs-comment">// 1. 容器高度必须明确</span>
&lt;div :style=<span class="hljs-string">"{ height: '400px' }"</span>&gt;  &lt;!-- <span class="hljs-variable constant_">SSR</span> 需要明确高度 --&gt;

<span class="hljs-comment">// 2. 避免在服务端计算滚动</span>
<span class="hljs-keyword">import</span> { onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">setupVirtualList</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> === <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">return</span>  <span class="hljs-comment">// SSR 环境跳过</span>
  
  <span class="hljs-keyword">const</span> { list, containerProps, wrapperProps } = <span class="hljs-title function_">useVirtualList</span>(...)
  <span class="hljs-keyword">return</span> { list, containerProps, wrapperProps }
}

<span class="hljs-comment">// 3. 使用 ClientOnly 组件（Nuxt.js）</span>
&lt;<span class="hljs-title class_">ClientOnly</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">VirtualList</span> <span class="hljs-attr">:items</span>=<span class="hljs-string">"items"</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">ClientOnly</span>&gt;
</code></pre>
<hr/>
<h2 data-id="heading-64">总结与对比表</h2>
<h3 data-id="heading-65">四种方案完整对比</h3>











































































<table><thead><tr><th>特性</th><th>固定+固定</th><th>固定+动态</th><th>动态+固定</th><th>动态+动态</th></tr></thead><tbody><tr><td><strong>项目高度</strong></td><td>固定值</td><td>固定值</td><td>函数计算</td><td>函数计算</td></tr><tr><td><strong>容器高度</strong></td><td>height</td><td>max-height</td><td>height</td><td>max-height</td></tr><tr><td><strong>overflow</strong></td><td>hidden</td><td>auto</td><td>hidden</td><td>auto</td></tr><tr><td><strong>itemHeight</strong></td><td><code>50</code></td><td><code>50</code></td><td><code>(i) =&gt; ...</code></td><td><code>(i) =&gt; ...</code></td></tr><tr><td><strong>性能评分</strong></td><td>5/5</td><td>5/5</td><td>4/5</td><td>4/5</td></tr><tr><td><strong>灵活性评分</strong></td><td>2/5</td><td>3/5</td><td>4/5</td><td>5/5</td></tr><tr><td><strong>实现难度</strong></td><td>简单</td><td>简单</td><td>中等</td><td>中等</td></tr><tr><td><strong>典型应用</strong></td><td>表格</td><td>下拉菜单</td><td>卡片列表</td><td>复杂弹窗</td></tr><tr><td><strong>数据量建议</strong></td><td>无限制</td><td>无限制</td><td>&lt; 100,000</td><td>&lt; 100,000</td></tr></tbody></table>
<h3 data-id="heading-66">API 参数速查表</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useVirtualList 配置</span>
<span class="hljs-keyword">const</span> { list, containerProps, wrapperProps } = <span class="hljs-title function_">useVirtualList</span>(items, {
  <span class="hljs-attr">itemHeight</span>: <span class="hljs-number">50</span> | (<span class="hljs-function">(<span class="hljs-params">index: number</span>) =&gt;</span> number),  <span class="hljs-comment">// 必需</span>
  <span class="hljs-attr">overscan</span>: <span class="hljs-number">5</span>                                     <span class="hljs-comment">// 可选，默认 5</span>
})
</code></pre>
<h3 data-id="heading-67">关键代码片段速查</h3>
<h4 data-id="heading-68">固定高度配置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">itemHeight</span>: <span class="hljs-number">50</span>
</code></pre>
<h4 data-id="heading-69">动态高度配置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">itemHeight</span>: <span class="hljs-function">(<span class="hljs-params">index</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> index % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? <span class="hljs-number">60</span> : <span class="hljs-number">80</span>
}
</code></pre>
<h4 data-id="heading-70">固定容器</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;div :style="{ height: '400px' }" v-bind="containerProps"&gt;
</code></pre>
<h4 data-id="heading-71">动态容器</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;div :style="{ maxHeight: '400px' }" v-bind="containerProps"&gt;
</code></pre>
<h4 data-id="heading-72">完整模板结构</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;div v-bind="containerProps" :style="{ height: '400px' }"&gt;
  &lt;div v-bind="wrapperProps"&gt;
    &lt;div v-for="item in list" :key="item.index"&gt;
      {{ item.data }}
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<hr/>
<h2 data-id="heading-73">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvueuse.org%2F" target="_blank" title="https://vueuse.org/" ref="nofollow noopener noreferrer">VueUse 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvueuse.org%2Fcore%2FuseVirtualList%2F" target="_blank" title="https://vueuse.org/core/useVirtualList/" ref="nofollow noopener noreferrer">useVirtualList API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2F" target="_blank" title="https://vuejs.org/" ref="nofollow noopener noreferrer">Vue 3 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FPerformance%2FVirtualization" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Performance/Virtualization" ref="nofollow noopener noreferrer">虚拟滚动原理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FIntersection_Observer_API" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API" ref="nofollow noopener noreferrer">Intersection Observer API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAkryum%2Fvue-virtual-scroller" target="_blank" title="https://github.com/Akryum/vue-virtual-scroller" ref="nofollow noopener noreferrer">vue-virtual-scroller</a> - 功能更强大，支持真正的动态高度</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbvaughn%2Freact-window" target="_blank" title="https://github.com/bvaughn/react-window" ref="nofollow noopener noreferrer">react-window</a> - React 生态的虚拟列表库（参考对比）</li>
</ul>
<h2 data-id="heading-74">完整项目结构</h2>
<pre><code class="hljs language-csharp" lang="csharp">vue3-sample/
├── src/
│   ├── components/
│   │   ├── FixedHeightVirtualList.vue       <span class="hljs-meta"># 固定+固定</span>
│   │   ├── DynamicHeightVirtualList.vue     <span class="hljs-meta"># 固定+动态</span>
│   │   ├── VariableHeightVirtualList.vue    <span class="hljs-meta"># 动态+固定</span>
│   │   └── FullyDynamicVirtualList.vue      <span class="hljs-meta"># 动态+动态</span>
│   ├── App.vue                               <span class="hljs-meta"># 使用示例</span>
│   └── main.js
├── docs/
│   └── <span class="hljs-keyword">virtual</span>-list-guide.md                 <span class="hljs-meta"># 本文档</span>
├── package.json
└── README.md
</code></pre>
<h2 data-id="heading-75">快速开始</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 克隆项目</span>
git <span class="hljs-built_in">clone</span> https://github.com/ilcherry/virtuallist-examples

<span class="hljs-comment"># 2. 安装依赖</span>
<span class="hljs-built_in">cd</span> vue3-sample
pnpm install

<span class="hljs-comment"># 3. 运行开发服务器</span>
pnpm dev

<span class="hljs-comment"># 4. 访问</span>
<span class="hljs-comment"># 打开浏览器访问 http://localhost:5173</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7713a4ca37da45889fc95437abf5910a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iez566A566A:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763345274&amp;x-signature=a0IXGeB36N62EduHDm7pdDQ21lw%3D" alt="localhost_5173_.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor 无法跨项目读取源码怎么办？MCP Easy Code Reader 帮你解决！]]></title>    <link>https://juejin.cn/post/7570405675432935424</link>    <guid>https://juejin.cn/post/7570405675432935424</guid>    <pubDate>2025-11-10T00:17:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570405675432935424" data-draft-id="7569909335908761609" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor 无法跨项目读取源码怎么办？MCP Easy Code Reader 帮你解决！"/> <meta itemprop="keywords" content="后端,Cursor,MCP"/> <meta itemprop="datePublished" content="2025-11-10T00:17:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="方圆想当图灵"/> <meta itemprop="url" content="https://juejin.cn/user/386633160473101"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor 无法跨项目读取源码怎么办？MCP Easy Code Reader 帮你解决！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/386633160473101/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    方圆想当图灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T00:17:35.000Z" title="Mon Nov 10 2025 00:17:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    102
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 <strong>方圆</strong>。本篇文章主要介绍 MCP Server <strong>Easy Code Reader</strong>，它可以帮助你在使用 Cursor/VSCode/IDEA 编写代码时，根据调用链路将多个项目或 Jar 包中相关的代码读取到上下文中，供 Code Agent 帮我们分析逻辑和编写代码，而无需再手动将源码复制到对话框中发送给 AI，提高 Code Agent 准确度和编码效率。MCP 已发布 Github 和 MCP.so，欢迎大家前往下载使用：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFangYuan33%2Feasy-code-reader" target="_blank" title="https://github.com/FangYuan33/easy-code-reader" ref="nofollow noopener noreferrer">Github: easy-code-reader</a>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFangYuan33%2Feasy-code-reader" target="_blank" title="https://github.com/FangYuan33/easy-code-reader" ref="nofollow noopener noreferrer">github.com/FangYuan33/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmcp.so%2Fserver%2Feasy-code-reader%2FFangYuan33" target="_blank" title="https://mcp.so/server/easy-code-reader/FangYuan33" ref="nofollow noopener noreferrer">MCP.so: Easy Code Reader</a>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmcp.so%2Fserver%2Feasy-code-reader%2FFangYuan33" target="_blank" title="https://mcp.so/server/easy-code-reader/FangYuan33" ref="nofollow noopener noreferrer">mcp.so/server/easy…</a></li>
</ul>
<p>在介绍如何接入 Easy Code Reader 之前，我们先来看看它到底能做什么：</p>
<h3 data-id="heading-0">Easy Code Reader 最佳实践</h3>
<p>Easy Code Reader 特别适合与 Claude、ChatGPT 等大模型配合使用，接下来以 Copilot Code Agent 结合 Claude4.5 模型为例，介绍一些最佳实践：</p>
<h4 data-id="heading-1">1. 跨项目调用，根据调用链路分析源码</h4>
<p>在比较复杂的项目中一般会拆分多个微服务，某些功能的实现可能会跨多个项目调用，如果靠人梳理相关逻辑会比较耗时，所以可以将涉及的代码 clone 到本地后使用 Easy Code Reader MCP 并结合 Code Agent 进行分析。接下来我们以 Nacos 项目为例，假设我们想了解 Nacos 的服务注册功能是如何实现的，可以按照以下步骤操作：</p>
<p>首先，比如我们创建了一个 Nacos Client 客户端，在这段逻辑中执行服务注册：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(Main.class);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NacosException, InterruptedException {
        logger.info(<span class="hljs-string">"开始初始化 Nacos 客户端..."</span>);

        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        properties.put(PropertyKeyConst.SERVER_ADDR, <span class="hljs-string">"127.0.0.1:8848"</span>);
        properties.put(PropertyKeyConst.NAMESPACE, <span class="hljs-string">"7430d8fe-99ce-4b20-866e-ed021a0652c9"</span>);

        <span class="hljs-type">NamingService</span> <span class="hljs-variable">namingService</span> <span class="hljs-operator">=</span> NacosFactory.createNamingService(properties);

        System.out.println(<span class="hljs-string">"=== 注册服务实例 ==="</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 注册一个服务实例</span>
            namingService.registerInstance(<span class="hljs-string">"test-service0"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">8080</span>);
            <span class="hljs-comment">// 添加事件监听器</span>
            namingService.subscribe(<span class="hljs-string">"test-service"</span>, event -&gt; {
                System.out.println(<span class="hljs-string">"服务实例变化: "</span> + event);
            });
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.out.println(<span class="hljs-string">"服务注册失败(预期，因为服务器可能未启动): "</span> + e.getMessage());
        }

        TimeUnit.HOURS.sleep(<span class="hljs-number">3</span>);
    }
}
</code></pre>
<p>因为我们创建 Nacos Client 执行服务注册时是由 Nacos 提供的 SDK 直接调用 <code>NamingService#registerInstance</code> 方法实现的，我们并不清楚底层是如何实现的，如果我们想要了解实现细节，那么可以将 Nacos 的源码 Clone 下来，并使用 Easy Code Reader 读取相关源码，下面是一个示例 Prompt：</p>
<pre><code class="hljs language-text" lang="text">你是一位 Java 专家，请你帮我分析 #file:Main.java 中 namingService.registerInstance 方法的逻辑，这段逻辑的实现在本地项目的 nacos 中，所以你需要在 nacos 读取一系列相关的源码才能了解它的核心逻辑，读取 nacos 项目的代码你可以借助 easy-code-reader MCP，其中包含你可以获取项目信息、项目中所有的文件信息和某个文件的工具
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6be97ddfbf9741beb2a970d0add5d12d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pa55ZyG5oOz5b2T5Zu-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763427930&amp;x-signature=be2xGWHfCln7%2BByZcuXPYDNBI28%3D" alt="img.png" loading="lazy"/></p>
<p>如图所示，它会不断地根据源码调用链路，读取相关源码并进行分析，最终我们就能了解服务注册的实现细节，会使用到 MCP Easy Code Reader 提供的多个工具 <code>list_all_project</code>、<code>list_project_files</code> 和 <code>read_project_code</code>， 具体调用细节图示如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/199bdefe268e44239bf176494d5e5629~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pa55ZyG5oOz5b2T5Zu-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763427930&amp;x-signature=BMAcqma6TG3bAiLSWchFWWiY7sc%3D" alt="image.png" loading="lazy"/></p>
<p>最终得到分析结果，节省很多时间：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e6272d0af8547a7a8904df6ab85419d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pa55ZyG5oOz5b2T5Zu-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763427930&amp;x-signature=5JtLHqWBDU%2FXPNnGomiHvxLNJGY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-2">2. 阅读 jar 包源码，根据源码完成代码编写</h4>
<p>在使用第三方或其他外部依赖时，Copilot 或其他 Code Agent 并不能直接读取 jar 包中的源码，往往需要我们将源码内容手动复制到提示词中才能完成，费时费力。在 Easy Code Reader 中提供了 <code>read_jar_source</code> 工具来读取 jar 包中的源码，帮我们完成开发实现。我们还是以如下代码为例，现在我想实现多个服务实例的注册，但是我又不了解 <code>NamingService</code> 的实现，便可以借助 <code>read_jar_source</code> 来完成：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(Main.class);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NacosException, InterruptedException {
        logger.info(<span class="hljs-string">"开始初始化 Nacos 客户端..."</span>);

        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        properties.put(PropertyKeyConst.SERVER_ADDR, <span class="hljs-string">"127.0.0.1:8848"</span>);
        properties.put(PropertyKeyConst.NAMESPACE, <span class="hljs-string">"7430d8fe-99ce-4b20-866e-ed021a0652c9"</span>);

        <span class="hljs-type">NamingService</span> <span class="hljs-variable">namingService</span> <span class="hljs-operator">=</span> NacosFactory.createNamingService(properties);

        System.out.println(<span class="hljs-string">"=== 注册服务实例 ==="</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 注册一个服务实例</span>
            namingService.registerInstance(<span class="hljs-string">"test-service0"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">8080</span>);
            <span class="hljs-comment">// 添加事件监听器</span>
            namingService.subscribe(<span class="hljs-string">"test-service"</span>, event -&gt; {
                System.out.println(<span class="hljs-string">"服务实例变化: "</span> + event);
            });
            <span class="hljs-comment">// 注册多个服务实例</span>

        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.out.println(<span class="hljs-string">"服务注册失败(预期，因为服务器可能未启动): "</span> + e.getMessage());
        }

        TimeUnit.HOURS.sleep(<span class="hljs-number">3</span>);
    }
}
</code></pre>
<pre><code class="hljs language-text" lang="text">你是一位 Java 技术专家，精通 Nacos 框架，请你帮我在 #file:Main.java 中完成注册多个服务实例的逻辑，在编写代码前，你需要先使用 easy-code-reader 的 read_jar_source 工具读取 com.alibaba.nacos.api.naming.NamingService 的源码信息来了解注册多个服务实例的方法
</code></pre>
<p>处理过程如下所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5660f4ee0073455cb83fed66a7dd0658~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pa55ZyG5oOz5b2T5Zu-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763427930&amp;x-signature=W4sOhDWciJmY5HLfkXj4BmGmM%2Bo%3D" alt="image.png" loading="lazy"/></p>
<p>这样我们便能够快速地了解 <code>NamingService</code> 的实现细节，从而完成代码编写工作，节省了大量时间。</p>
<h4 data-id="heading-3">3. 跨项目阅读源码，根据源码完成本项目实现</h4>
<p>在大型项目中，某些功能的实现可能会跨多个模块或微服务，如果部分逻辑已经实现并且后续其他应用的逻辑需要依赖这部分逻辑时，可以借助 Easy Code Reader 读取相关模块的源码，帮助我们更好地理解和实现当前项目的功能，示例 Prompt 如下：</p>
<pre><code class="hljs language-text" lang="text">你是一位 Java 技术专家，现在我要实现 XXX 的业务逻辑，这部分逻辑的实现需要调用本地项目 A 中 XXX 的接口及其实现，请你借助 MCP easy-code-reader 来帮我读取 A 项目中的源码，并帮我实现 XXX 的业务逻辑
</code></pre>
<p>当然除了这三种应用场景以外，还可以使用 Easy Code Reader 完成以下事项：</p>
<ul>
<li><strong>异常问题快速溯源</strong>：如果有异常信息是外部 jar 包依赖中抛出来的，可以使用 <code>read_jar_source</code> 工具根据异常堆栈日志快速定位异常点</li>
<li><strong>依赖升级影响评估（旧/新版本差异核对）</strong>：同样是使用 <code>read_jar_source</code> 工具来完成新旧版本的实现差异，评估升级影响</li>
<li><strong>业务代码逻辑评审</strong>：如果业务逻辑开发实现在多个项目中，可以借助读取本地项目代码的工具 <code>list_all_project</code>、<code>list_project_files</code> 和 <code>read_project_code</code>，来分析新增的逻辑是否满足业务要求</li>
<li><strong>新人快速上手多个微服务</strong>：借助读取本地项目代码的工具，可以根据接口调用链路快速理清微服务项目代码之间的关系，提高上手速度</li>
</ul>
<hr/>
<p>既然它有这么多的应用场景，那么我们该如何接入 Easy Code Reader 呢？下面我们来介绍一下接入步骤：</p>
<p><a id="user-content-quick-start-uvx" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-4">快速接入（方法一）：使用 uvx（推荐 - 开箱即用）</h3>
<p>它的环境要求如下：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fastral-sh%2Fuv" target="_blank" title="https://github.com/astral-sh/uv" ref="nofollow noopener noreferrer">uv</a> - Python 包和项目管理工具</li>
<li>Python 3.10 或更高版本</li>
<li>Java Development Kit (JDK) - 用于运行反编译器，要求至少 Java 8</li>
</ul>
<p>如果您还没有安装 uv，可以通过以下方式快速安装：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS/Linux</span>
curl -LsSf https://astral.sh/uv/install.sh | sh

<span class="hljs-comment"># Windows</span>
powershell -c <span class="hljs-string">"irm https://astral.sh/uv/install.ps1 | iex"</span>

<span class="hljs-comment"># 或使用 pip</span>
pip install uv
</code></pre>
<p>或者参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fastral-sh%2Fuv" target="_blank" title="https://github.com/astral-sh/uv" ref="nofollow noopener noreferrer">uv 官网</a> 进行安装，并配置 uv 的安装路径添加到系统 PATH 中，以便可以直接使用 <code>uvx</code> 命令。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fastral-sh%2Fuv" target="_blank" title="https://github.com/astral-sh/uv" ref="nofollow noopener noreferrer">uv</a> 是一个极快的 Python 包和项目管理工具。使用 <code>uvx</code> 可以无需预先安装，直接运行，参考以下 MCP 客户端配置：</p>
<ul>
<li><code>--maven-repo</code>: 指定 Maven 仓库路径，将 <code>/custom/path/to/maven/repository</code> 内容替换为本地 Maven 仓库路径即可，不配置默认使用 <strong>MAVEN_HOME</strong> 目录或 <code>~/.m2/repository</code></li>
<li><code>--project-dir</code>: 指定本地项目目录路径，将 <code>/customer/path/to/project-dir</code> 替换为实际保存所有项目的路径</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"easy-code-reader"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uvx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"easy-code-reader"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--maven-repo"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"/custom/path/to/maven/repository"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--project-dir"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"/customer/path/to/project-dir"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>将以上内容配置好后，AI 助手即可通过 MCP 协议调用 Easy Code Reader 提供的工具，完成多项目、多依赖的 Java 源代码读取工作。</p>
<h3 data-id="heading-5">快速接入（方法二）：使用 uv 安装到本地（不推荐）</h3>
<p>如果使用 <strong>快速接入（方法一）</strong> 安装运行失败，那么可以采用直接安装到本地的方法，运行如下命令：</p>
<pre><code class="hljs language-bash" lang="bash">uv tool install easy-code-reader
</code></pre>
<p>安装成功后，执行以下命令获取安装目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">which</span> easy-code-reader
</code></pre>
<p>比如，输出结果是：/Users/fangyuan/.local/bin/easy-code-reader，那么需要按照如下方式配置 MCP 客户端：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"easy-code-reader"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/fangyuan/.local/bin/easy-code-reader"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"--maven-repo"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"/custom/path/to/maven/repository"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--project-dir"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"/customer/path/to/project-dir"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>一般这样操作都能完成安装，后续如果有版本更新，可以通过以下命令进行升级：</p>
<pre><code class="hljs language-bash" lang="bash">uv tool install --upgrade easy-code-reader
</code></pre>
<h3 data-id="heading-6">常见问题</h3>
<h4 data-id="heading-7">Q1: spawn uvx ENOENT spawn uvx ENOENT</h4>
<p>uv 命令未找到，确保已正确安装 uv 并将其路径添加到系统 PATH 中，参考 <a href="#quick-start-uvx" title="#quick-start-uvx">快速接入（方法一）</a>，并尝试重启 IDE 后再启动 MCP Server。</p>
<hr/>
<p>以上内容就是 MCP Easy Code Reader 的介绍和接入方法，接下来的内容主要介绍一下它的实现原理，感兴趣的朋友可以继续往下看。</p>
<h3 data-id="heading-8">Easy Code Reader 实现原理</h3>
<p>其实编写一个 MCP Server 并不复杂，大家可以参考这篇 Github 上的文章 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FliaokongVFX%2FMCP-Chinese-Getting-Started-Guide" target="_blank" title="https://github.com/liaokongVFX/MCP-Chinese-Getting-Started-Guide" ref="nofollow noopener noreferrer">Model Context Protocol(MCP) 编程极速入门</a>。Easy Code Reader 通过 Python 语言实现，它提供了 4 个主要工具来协同完成源码读取工作：</p>
<ol>
<li><code>list_all_project</code>: <strong>列出所有本地项目</strong>，这个工具能将配置的项目目录 <code>--project-dir</code> 下所有的文件夹都读取出来，每个文件夹代表一个项目，这样 Code Agent 便能根据项目名称来选择需要读取的项目</li>
<li><code>list_project_files</code>: <strong>列出指定项目中的所有文件名</strong>，这个工具能将指定项目下的所有源码文件名都读取出来，Code Agent 便能根据调用链路选择需要读取的文件</li>
<li><code>read_project_code</code>: <strong>读取指定项目中的某个文件源码</strong>，通过以上两个工具，Code Agent 能够定位到需要读取的文件，然后使用这个工具将源码内容读取出来，供 Code Agent 进行分析</li>
<li><code>read_jar_source</code>: <strong>读取指定 jar 包中的某个类源码</strong>，如果调用链路中有外部 jar 包依赖的话，Code Agent 便可以使用这个工具将 jar 包中的源码读取出来，供分析和编写代码</li>
</ol>
<p>这四个工具协同工作，便能实现跨项目、多依赖的源码读取工作，帮助 Code Agent 更好地理解代码逻辑，从而提高代码编写效率和准确度，以下是 MCP Tool 实现的技术细节：</p>
<h4 data-id="heading-9">list_all_project</h4>
<p>列举项目目录下所有的项目文件夹名称。</p>
<p><strong>用途：</strong></p>
<ul>
<li>查看所有可用的项目</li>
<li>当输入不完整的项目名时，帮助推理出最接近的项目名</li>
<li>验证项目是否存在</li>
<li>支持项目名称模糊匹配，快速查找特定项目</li>
</ul>
<p><strong>参数：</strong></p>
<ul>
<li><code>project_dir</code> (可选): 项目目录路径，如未提供则使用启动时配置的路径</li>
<li><code>project_name_pattern</code> (可选): 项目名称模糊匹配模式（不区分大小写），用于过滤项目列表
<ul>
<li>支持左右模糊匹配，例如 <code>nacos</code> 将匹配包含 <code>nacos</code>、<code>Nacos</code>、<code>NACOS</code> 的项目名</li>
<li>⚠️ <strong>使用建议</strong>：如果匹配模式过于严格可能导致遗漏目标项目</li>
<li>💡 <strong>最佳实践</strong>：若未找到预期结果，建议不传此参数重新查询完整列表</li>
</ul>
</li>
</ul>
<p><strong>智能提示机制：</strong></p>
<ul>
<li>当使用 <code>project_name_pattern</code> 但未匹配到项目时，返回结果会包含提示信息</li>
<li>建议 AI 助手在未找到预期项目时，不传 <code>project_name_pattern</code> 参数重新查询</li>
<li>有效减少因过度过滤导致的查询失败</li>
</ul>
<p><strong>示例 1 - 列出所有项目：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>示例 2 - 使用项目名称模糊匹配：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name_pattern"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"spring"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回格式：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_dir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/path/to/projects"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"project_name_pattern"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"spring"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"total_projects"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"projects"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"spring-boot"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"spring-cloud-demo"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"hint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"已使用项目名称模式 'spring' 进行过滤。如果未找到预期的项目，可能是模式匹配过于严格。建议：不传入 project_name_pattern 参数重新调用 list_all_project 工具查看完整项目列表。"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"total_all_projects"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>提示信息说明：</strong></p>
<ul>
<li>当使用 <code>project_name_pattern</code> 但未匹配到任何项目时，<code>hint</code> 字段会提示模式可能过于严格，并显示总项目数 <code>total_all_projects</code></li>
<li>当使用 <code>project_name_pattern</code> 且有匹配结果时，<code>hint</code> 字段会提醒如果结果不符合预期可以不传参数重新查询，同时显示总项目数</li>
<li>这个智能提示机制帮助 AI 助手更好地调整查询策略，避免因过度过滤错过目标项目</li>
</ul>
<h4 data-id="heading-10">list_project_files</h4>
<p>列出 Java 项目中的源代码文件和配置文件路径。</p>
<p><strong>用途：</strong></p>
<ul>
<li>了解项目结构和文件组织</li>
<li>查找特定的类或配置文件</li>
<li>分析类之间的关系和依赖</li>
<li>当项目文件过多时，聚焦特定模块</li>
<li>支持文件名模糊匹配，快速定位目标文件</li>
</ul>
<p><strong>支持两种模式：</strong></p>
<ol>
<li><strong>全项目模式</strong>（不指定 <code>sub_path</code>）：列出整个项目的所有文件</li>
<li><strong>聚焦模式</strong>（指定 <code>sub_path</code>）：只列出指定子目录下的文件</li>
</ol>
<p><strong>参数：</strong></p>
<ul>
<li><code>project_name</code> (必需): 项目名称，例如 <code>nacos</code></li>
<li><code>sub_path</code> (可选): 指定项目内的子目录路径，例如 <code>core</code> 或 <code>address/src/main/java</code></li>
<li><code>file_name_pattern</code> (可选): 文件名模糊匹配模式（不区分大小写），用于进一步过滤文件列表
<ul>
<li>支持左右模糊匹配，例如 <code>Service</code> 将匹配包含 <code>service</code>、<code>Service</code>、<code>SERVICE</code> 的文件名</li>
<li>⚠️ <strong>使用建议</strong>：如果匹配模式过于严格可能导致遗漏目标文件</li>
<li>💡 <strong>最佳实践</strong>：若未找到预期结果，建议不传此参数重新查询完整列表</li>
</ul>
</li>
<li><code>project_dir</code> (可选): 项目所在的父目录路径，如未提供则使用启动时配置的路径</li>
</ul>
<p><strong>自动过滤内容：</strong></p>
<ul>
<li>✅ 包含：Java 源代码 (.java)、配置文件 (.xml, .properties, .yaml, .json 等)、构建脚本、文档</li>
<li>❌ 排除：测试目录 (<code>src/test</code>)、编译产物 (<code>target</code>, <code>build</code>)、IDE 配置、版本控制文件</li>
</ul>
<p><strong>智能提示机制：</strong></p>
<ul>
<li>当使用 <code>file_name_pattern</code> 但未匹配到文件时，返回结果会包含提示信息</li>
<li>建议 AI 助手在未找到预期文件时，不传 <code>file_name_pattern</code> 参数重新查询</li>
<li>有效减少因过度过滤导致的查询失败</li>
</ul>
<p><strong>示例 1 - 列出整个项目：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nacos"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>示例 2 - 只列出 core 模块：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nacos"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sub_path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"core"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>示例 3 - 使用文件名模糊匹配：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nacos"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file_name_pattern"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Service"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回格式：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nacos"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"project_dir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/path/to/projects/nacos"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"search_scope"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"core"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file_name_pattern"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Service"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"total_files"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"core/src/main/java/com/alibaba/nacos/core/service/NacosService.java"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"api/src/main/java/com/alibaba/nacos/api/naming/NamingService.java"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"..."</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"hint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"已使用文件名模式 'Service' 进行过滤。如果未找到预期的文件，可能是模式匹配过于严格。建议：不传入 file_name_pattern 参数重新调用 list_project_files 工具查看完整文件列表。"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>提示信息说明：</strong></p>
<ul>
<li>当使用 <code>file_name_pattern</code> 但未匹配到任何文件时，<code>hint</code> 字段会提示模式可能过于严格</li>
<li>当使用 <code>file_name_pattern</code> 且有匹配结果时，<code>hint</code> 字段会提醒如果结果不符合预期可以不传参数重新查询</li>
<li>这个智能提示机制帮助 AI 助手更好地调整查询策略，避免因过度过滤错过目标文件</li>
</ul>
<h4 data-id="heading-11">read_project_code</h4>
<p>从本地项目目录中读取指定文件的源代码或配置文件内容。</p>
<p><strong>用途：</strong></p>
<ul>
<li>读取具体类或文件的完整源代码</li>
<li>查看配置文件内容（pom.xml、application.yml、application.properties 等）</li>
<li>读取项目文档（README.md、SQL 脚本等）</li>
<li>支持多模块 Maven/Gradle 项目</li>
<li>自动搜索常见的源代码和配置文件路径</li>
</ul>
<p><strong>参数：</strong></p>
<ul>
<li><code>project_name</code> (必需): 项目名称，例如 <code>my-project</code></li>
<li><code>file_path</code> (必需): 文件标识符：可以是完全限定的 Java 类名或文件相对路径
<ul>
<li>Java 类名格式：<code>com.example.MyClass</code> (自动查找对应的 .java 文件)</li>
<li>相对路径格式：<code>src/main/java/com/example/MyClass.java</code></li>
<li>模块相对路径：<code>core/src/main/java/com/example/MyClass.java</code></li>
<li>配置文件路径：<code>src/main/resources/application.yml</code>、<code>pom.xml</code></li>
<li>文档文件：<code>README.md</code>、<code>docs/setup.md</code></li>
</ul>
</li>
<li><code>project_dir</code> (可选): 项目目录路径，如未提供则使用启动时配置的路径</li>
</ul>
<p><strong>支持的文件类型：</strong></p>
<ul>
<li>Java 源代码 (.java)</li>
<li>配置文件 (.xml, .properties, .yaml, .yml, .json, .conf, .config)</li>
<li>构建脚本 (.gradle, .gradle.kts, pom.xml)</li>
<li>文档文件 (.md, .txt)</li>
<li>SQL 脚本 (.sql)</li>
<li>Shell 脚本 (.sh, .bat)</li>
</ul>
<p><strong>自动搜索路径：</strong></p>
<ul>
<li>对于 Java 类名：<code>src/main/java/{class_path}.java</code>、<code>src/{class_path}.java</code>、<code>{class_path}.java</code></li>
<li>对于配置文件：项目根目录、<code>src/main/resources/</code>、<code>src/</code>、<code>config/</code> 及子模块</li>
<li>支持多模块项目中的子模块路径</li>
</ul>
<p><strong>推荐工作流程：</strong></p>
<ol>
<li>使用 <code>list_all_project</code> 确认项目存在</li>
<li>使用 <code>list_project_files</code>（建议带 <code>file_name_pattern</code> 参数）查看文件列表</li>
<li>使用本工具读取具体文件内容</li>
</ol>
<p><strong>示例 1 - 使用类名读取 Java 源代码：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-spring-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file_path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.example.service.UserService"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>示例 2 - 使用相对路径读取 Java 文件：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nacos"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file_path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"address/src/main/java/com/alibaba/nacos/address/component/AddressServerGeneratorManager.java"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>示例 3 - 读取配置文件：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-spring-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file_path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/resources/application.yml"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>示例 4 - 读取项目根目录的文件：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-spring-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file_path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pom.xml"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回格式：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-spring-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"class_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.example.service.UserService"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file_path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/path/to/projects/my-spring-app/src/main/java/com/example/service/UserService.java"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"package com.example.service;\n\nimport ...\n\npublic class UserService {\n    // ...\n}"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-12">read_jar_source</h4>
<p>从 Maven 依赖中读取 Java 类的源代码（优先从 sources jar，否则反编译）。</p>
<p><strong>参数：</strong></p>
<ul>
<li><code>group_id</code> (必需): Maven group ID，例如 <code>org.springframework</code></li>
<li><code>artifact_id</code> (必需): Maven artifact ID，例如 <code>spring-core</code></li>
<li><code>version</code> (必需): Maven version，例如 <code>5.3.21</code></li>
<li><code>class_name</code> (必需): 完全限定的类名，例如 <code>org.springframework.core.SpringVersion</code></li>
<li><code>prefer_sources</code> (可选，默认 <code>true</code>): 优先使用 sources jar 而不是反编译</li>
</ul>
<p><strong>工作原理：</strong></p>
<ol>
<li>首先尝试从 <code>-sources.jar</code> 中提取源代码（如果 <code>prefer_sources=true</code>）</li>
<li>如果 sources jar 不存在或提取失败，自动回退到反编译主 JAR 文件</li>
<li>支持 SNAPSHOT 版本的智能处理</li>
</ol>
<p><strong>智能错误提示：</strong></p>
<p>当 JAR 文件未找到时，工具会提供详细的排查建议：</p>
<ul>
<li>提示可能的原因（依赖未安装、Maven 坐标错误）</li>
<li>建议使用 <code>read_project_code</code> 工具读取项目的 <code>pom.xml</code> 文件</li>
<li>指导在 <code>&lt;dependencies&gt;</code> 部分核对正确的 Maven 坐标</li>
<li>提示确认坐标后重新调用工具</li>
<li>说明可能需要执行 Maven 构建命令安装依赖</li>
</ul>
<p>这个智能提示机制特别适合与 AI 助手配合使用，能有效减少因 Maven 坐标错误导致的重复尝试。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"group_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"org.springframework"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"artifact_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"spring-core"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5.3.21"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"class_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"org.springframework.core.SpringVersion"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回格式：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"class_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"org.springframework.core.SpringVersion"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"artifact"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"org.springframework:spring-core:5.3.21"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"source_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sources.jar"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"package org.springframework.core;\n\npublic class SpringVersion {\n    // ...\n}"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>source_type 字段说明：</strong></p>
<p><code>source_type</code> 字段标识源码的来源，帮助 AI 助手了解代码的可靠性和新鲜度：</p>
<ul>
<li><code>"sources.jar"</code>: 从 Maven 的 sources JAR 文件中提取（最可靠，与发布版本完全一致）</li>
<li><code>"decompiled"</code>: 通过反编译器新反编译生成（可能存在反编译不完整的情况）</li>
<li><code>"decompiled_cache"</code>: 从之前反编译的缓存中读取（避免重复反编译，提升性能）</li>
</ul>
<p>💡 <strong>使用建议</strong>：</p>
<ul>
<li><code>sources.jar</code> 来源的代码最准确，可直接作为分析依据</li>
<li><code>decompiled</code> 来源的代码可能会有语法糖恢复、泛型擦除等反编译特征</li>
<li><code>decompiled_cache</code> 与 <code>decompiled</code> 质量相同，只是从缓存读取以提升效率</li>
</ul>
<h5 data-id="heading-13">反编译器选择与缓存机制</h5>
<p><code>read_jar_source</code> 工具支持多个反编译器，并根据 Java 版本自动选择最合适的：</p>




















<table><thead><tr><th>Java 版本</th><th>推荐反编译器</th><th>说明</th></tr></thead><tbody><tr><td>8 - 20</td><td>CFR</td><td>自动使用 <strong>CFR</strong> 反编译器（兼容 Java 8+），已包含在包中：<code>src/easy_code_reader/decompilers/cfr.jar</code></td></tr><tr><td>21+</td><td>Fernflower</td><td>自动使用 <strong>Fernflower</strong> 反编译器（IntelliJ IDEA 使用的反编译器），已包含在包中：<code>src/easy_code_reader/decompilers/fernflower.jar</code></td></tr></tbody></table>
<p>反编译后的文件会被缓存在 JAR 包所在目录的 <code>easy-code-reader/</code> 子目录中，例如：</p>
<p>如果 JAR 包位置为：</p>
<pre><code class="hljs language-bash" lang="bash">~/.m2/repository/org/springframework/spring-core/5.3.21/spring-core-5.3.21.jar
</code></pre>
<p>反编译后的源文件将存储在：</p>
<pre><code class="hljs language-bash" lang="bash">~/.m2/repository/org/springframework/spring-core/5.3.21/easy-code-reader/spring-core-5.3.21.jar
</code></pre>
<p>缓存文件本身也是一个 JAR 格式的压缩包，包含所有反编译后的 <code>.java</code> 文件，这样可以避免重复反编译相同的 JAR 包，提高性能。但 <strong>针对 SNAPSHOT 版本需要特殊处理：</strong> 因为 Maven 针对快照版本会生成带时间戳的 JAR（如 <code>artifact-1.0.0-20251030.085053-1.jar</code>），Easy Code Reader 会自动查找最新的带时间戳版本进行反编译，并且以缓存以 <code>artifact-1.0.0-20251030.085053-1.jar</code> 名称存储，提供版本判断的依据，当检测到新版本时，会自动清理旧的 SNAPSHOT 缓存，生成新的缓存文件。</p>
<hr/>
<h3 data-id="heading-14">巨人的肩膀</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmcp.so%2Fserver%2Feasy-code-reader%2FFangYuan33" target="_blank" title="https://mcp.so/server/easy-code-reader/FangYuan33" ref="nofollow noopener noreferrer">MCP.so: Easy Code Reader</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFangYuan33%2Feasy-code-reader" target="_blank" title="https://github.com/FangYuan33/easy-code-reader" ref="nofollow noopener noreferrer">Github: easy-code-reader</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsalitaba%2Fmaven-decoder-mcp" target="_blank" title="https://github.com/salitaba/maven-decoder-mcp" ref="nofollow noopener noreferrer">Github: maven-decoder-mcp</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJetBrains%2Ffernflower" target="_blank" title="https://github.com/JetBrains/fernflower" ref="nofollow noopener noreferrer">Github: fernflower</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端架构中的中间层设计：构建稳健可维护的组件体系]]></title>    <link>https://juejin.cn/post/7570651893869936692</link>    <guid>https://juejin.cn/post/7570651893869936692</guid>    <pubDate>2025-11-10T06:19:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570651893869936692" data-draft-id="7570651893869903924" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端架构中的中间层设计：构建稳健可维护的组件体系"/> <meta itemprop="keywords" content="前端,面试,代码规范"/> <meta itemprop="datePublished" content="2025-11-10T06:19:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大知闲闲i"/> <meta itemprop="url" content="https://juejin.cn/user/3799545205237111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端架构中的中间层设计：构建稳健可维护的组件体系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3799545205237111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大知闲闲i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T06:19:53.000Z" title="Mon Nov 10 2025 06:19:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    84
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代前端开发中，中间层架构设计已成为构建大型复杂应用的关键策略。特别是在组件化开发中，合理的中间层设计能够显著提升代码质量、团队协作效率和系统可维护性。</p>
<p>================================================================================</p>
<h2 data-id="heading-0">一、什么是组件中间层？</h2>
<p>组件中间层是位于业务逻辑与基础UI组件之间的抽象层，它通过对底层组件（如 Ant Design、Element UI 等）进行统一封装，为业务开发提供标准化、增强型的组件接口。</p>
<p><strong>架构层次示意：</strong></p>
<pre><code class="hljs language-scss" lang="scss">业务组件层 (Business Components)
    ↓
组件中间层 (Component Middleware) ← 核心抽象层
    ↓
基础UI库 (UI Libraries) ← AntD、Element UI 等
    ↓
原生<span class="hljs-selector-tag">HTML</span>元素 (Native HTML)
</code></pre>
<h2 data-id="heading-1">二、中间层设计的核心价值</h2>
<h3 data-id="heading-2">1. 技术栈解耦与风险控制</h3>
<p><strong>问题场景：</strong> 业务代码直接依赖特定UI库，导致技术栈切换成本极高</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 直接依赖 - 危险的做法</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Table</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserManagement</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>&gt;</span>删除用户<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Table</span> <span class="hljs-attr">dataSource</span>=<span class="hljs-string">{data}</span> /&gt;</span></span>
  );
}

<span class="hljs-comment">// ✅ 中间层封装 - 安全的做法</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrimaryButton</span>, <span class="hljs-title class_">DataTable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserManagement</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">PrimaryButton</span>&gt;</span>删除用户<span class="hljs-tag">&lt;/<span class="hljs-name">PrimaryButton</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">DataTable</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span> /&gt;</span></span>
  );
}
</code></pre>
<p><strong>优势体现：</strong> 当需要从 Ant Design 迁移到其他UI库时，只需修改中间层实现，业务代码无需改动。</p>
<h3 data-id="heading-3">2. 统一设计规范与用户体验</h3>
<p>通过中间层强制实施设计系统规范，确保整个应用交互一致性：</p>
<pre><code class="hljs language-ini" lang="ini">// components/EnhancedTable/index.tsx
import React from 'react'<span class="hljs-comment">;</span>
import { Table, Empty, Spin, Alert } from 'antd'<span class="hljs-comment">;</span>

interface EnhancedTableProps {
  loading?: boolean<span class="hljs-comment">;</span>
  error?: Error | null<span class="hljs-comment">;</span>
  data: any<span class="hljs-section">[]</span><span class="hljs-comment">;</span>
  columns: any<span class="hljs-section">[]</span><span class="hljs-comment">;</span>
  onRetry?: () =&gt; void<span class="hljs-comment">;</span>
}

export const EnhancedTable: React.FC&lt;EnhancedTableProps&gt; = ({
  <span class="hljs-attr">loading</span> = <span class="hljs-literal">false</span>,
  <span class="hljs-attr">error</span> = null,
  <span class="hljs-attr">data</span> = [],
  columns,
  onRetry,
  ...rest
}) =&gt; {
  if (error) {
    return (
      &lt;Alert
        <span class="hljs-attr">message</span>=<span class="hljs-string">"数据加载失败"</span>
        <span class="hljs-attr">description</span>={error.message}
        <span class="hljs-attr">type</span>=<span class="hljs-string">"error"</span>
        <span class="hljs-attr">action</span>={
          &lt;Button <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-literal">on</span>Click={<span class="hljs-literal">on</span>Retry}&gt;
            重试
          &lt;/Button&gt;
        }
      /&gt;
    )<span class="hljs-comment">;</span>
  }

  return (
    &lt;Spin <span class="hljs-attr">spinning</span>={loading}&gt;
      &lt;Table
        <span class="hljs-attr">dataSource</span>={data}
        <span class="hljs-attr">columns</span>={columns}
        <span class="hljs-attr">locale</span>={{
          emptyText: (
            &lt;Empty 
              <span class="hljs-attr">description</span>={loading ? <span class="hljs-string">'加载中...'</span> : <span class="hljs-string">'暂无数据'</span>}
              <span class="hljs-attr">image</span>={Empty.PRESENTED_IMAGE_SIMPLE}
            /&gt;
          )
        }}
        <span class="hljs-attr">pagination</span>={{
          showSizeChanger: true,
          showQuickJumper: true,
          showTotal: (total) =&gt; `共 ${total} 条`,
          pageSizeOptions: <span class="hljs-section">['10', '20', '50', '100']</span>,
        }}
        {...rest}
      /&gt;
    &lt;/Spin&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-4">3. 功能增强与横切关注点处理</h3>
<p>中间层天然适合处理跨组件的通用逻辑：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// components/SecureButton/index.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span>, message, <span class="hljs-title class_">Modal</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-keyword">import</span> { usePermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/usePermission'</span>;
<span class="hljs-keyword">import</span> { useTracking } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useTracking'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecureButtonProps</span> {
  <span class="hljs-comment">// 权限控制</span>
  permission?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">// 操作确认</span>
  confirm?: <span class="hljs-built_in">string</span> | { <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span> };
  <span class="hljs-comment">// 埋点追踪</span>
  tracking?: { <span class="hljs-attr">event</span>: <span class="hljs-built_in">string</span>; data?: <span class="hljs-built_in">any</span> };
  <span class="hljs-comment">// 防重复提交</span>
  debounce?: <span class="hljs-built_in">number</span>;
  onClick?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">SecureButton</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">SecureButtonProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
  permission,
  confirm,
  tracking,
  debounce = <span class="hljs-number">300</span>,
  onClick,
  children,
  ...props
}</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { hasPermission } = <span class="hljs-title function_">usePermission</span>();
  <span class="hljs-keyword">const</span> { trackEvent } = <span class="hljs-title function_">useTracking</span>();
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-comment">// 权限校验</span>
  <span class="hljs-keyword">if</span> (permission &amp;&amp; !<span class="hljs-title function_">hasPermission</span>(permission)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 确认对话框</span>
    <span class="hljs-keyword">if</span> (confirm) {
      <span class="hljs-keyword">const</span> confirmed = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
        <span class="hljs-title class_">Modal</span>.<span class="hljs-title function_">confirm</span>({
          <span class="hljs-attr">title</span>: <span class="hljs-keyword">typeof</span> confirm === <span class="hljs-string">'string'</span> ? <span class="hljs-string">'确认操作'</span> : confirm.<span class="hljs-property">title</span>,
          <span class="hljs-attr">content</span>: <span class="hljs-keyword">typeof</span> confirm === <span class="hljs-string">'string'</span> ? confirm : confirm.<span class="hljs-property">content</span>,
          <span class="hljs-attr">onOk</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">true</span>),
          <span class="hljs-attr">onCancel</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">false</span>),
        });
      });
      
      <span class="hljs-keyword">if</span> (!confirmed) <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 埋点记录</span>
    <span class="hljs-keyword">if</span> (tracking) {
      <span class="hljs-title function_">trackEvent</span>(tracking.<span class="hljs-property">event</span>, tracking.<span class="hljs-property">data</span>);
    }

    <span class="hljs-comment">// 加载状态与防重复</span>
    <span class="hljs-keyword">if</span> (!loading) {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> onClick?.();
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>), debounce);
      }
    }
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
      {<span class="hljs-attr">...props</span>}
      <span class="hljs-attr">loading</span>=<span class="hljs-string">{loading}</span>
      <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>
      <span class="hljs-attr">disabled</span>=<span class="hljs-string">{props.disabled</span> || <span class="hljs-attr">loading</span>}
    &gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-5">4. 类型安全与开发体验提升</h3>
<p>通过 TypeScript 提供精确的类型提示和约束：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// types/table.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TableColumn</span>&lt;T = <span class="hljs-built_in">any</span>&gt; {
  <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">dataIndex</span>: keyof T;
  render?: <span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">any</span>, record: T, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;
  sorter?: <span class="hljs-built_in">boolean</span> | (<span class="hljs-function">(<span class="hljs-params">a: T, b: T</span>) =&gt;</span> <span class="hljs-built_in">number</span>);
  filters?: { <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">value</span>: <span class="hljs-built_in">any</span> }[];
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaginationConfig</span> {
  <span class="hljs-attr">current</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">pageSize</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">onChange</span>: <span class="hljs-function">(<span class="hljs-params">page: <span class="hljs-built_in">number</span>, pageSize?: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-comment">// components/DataTable/index.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TableColumn</span>, <span class="hljs-title class_">PaginationConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types/table'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">DataTableProps</span>&lt;T&gt; {
  <span class="hljs-attr">data</span>: T[];
  <span class="hljs-attr">columns</span>: <span class="hljs-title class_">TableColumn</span>&lt;T&gt;[];
  pagination?: <span class="hljs-title class_">PaginationConfig</span>;
  loading?: <span class="hljs-built_in">boolean</span>;
  rowKey?: keyof T | (<span class="hljs-function">(<span class="hljs-params">record: T</span>) =&gt;</span> <span class="hljs-built_in">string</span>);
}
</code></pre>
<h2 data-id="heading-6">三、中间层设计模式与实践</h2>
<h3 data-id="heading-7">1. 组合模式 (Composition)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// components/SearchTable/index.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EnhancedTable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../EnhancedTable'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SearchBar</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../SearchBar'</span>;
<span class="hljs-keyword">import</span> { usePagination } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/usePagination'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">SearchTable</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">SearchTableProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
  searchFields,
  onSearch,
  ...tableProps
}</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { pagination, setPagination } = <span class="hljs-title function_">usePagination</span>();
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSearch</span> = (<span class="hljs-params">values: <span class="hljs-built_in">any</span></span>) =&gt; {
    onSearch?.(values);
    <span class="hljs-title function_">setPagination</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ ...prev, <span class="hljs-attr">current</span>: <span class="hljs-number">1</span> }));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"search-table"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">SearchBar</span> <span class="hljs-attr">fields</span>=<span class="hljs-string">{searchFields}</span> <span class="hljs-attr">onSearch</span>=<span class="hljs-string">{handleSearch}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">EnhancedTable</span>
        {<span class="hljs-attr">...tableProps</span>}
        <span class="hljs-attr">pagination</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">...pagination</span>,
          <span class="hljs-attr">onChange:</span> <span class="hljs-attr">setPagination</span>,
        }}
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-8">2. 高阶组件模式 (HOC)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// hooks/withErrorBoundary.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> withErrorBoundary&lt;P <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span>&gt;(
  <span class="hljs-title class_">Component</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ComponentType</span>&lt;P&gt;,
  fallback?: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>
) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span>&lt;P, { <span class="hljs-attr">hasError</span>: <span class="hljs-built_in">boolean</span> }&gt; {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props: P</span>) {
      <span class="hljs-variable language_">super</span>(props);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span> };
    }

    <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span> };
    }

    <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error: <span class="hljs-built_in">Error</span>, errorInfo: React.ErrorInfo</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Component Error:'</span>, error, errorInfo);
    }

    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) {
        <span class="hljs-keyword">return</span> fallback || <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>组件渲染失败<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
      }

      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span> {<span class="hljs-attr">...this.props</span>} /&gt;</span></span>;
    }
  };
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">EnhancedTableWithErrorBoundary</span> = <span class="hljs-title function_">withErrorBoundary</span>(<span class="hljs-title class_">EnhancedTable</span>);
</code></pre>
<h3 data-id="heading-9">3. 自定义 Hook 模式</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// hooks/useTable.ts</span>
<span class="hljs-keyword">import</span> { useState, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useTable&lt;T&gt;(<span class="hljs-attr">initialData</span>: T[] = []) {
  <span class="hljs-keyword">const</span> [data, setData] = useState&lt;T[]&gt;(initialData);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;<span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> refresh = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">fetchFunction</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;T[]&gt;) =&gt; {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchFunction</span>();
      <span class="hljs-title function_">setData</span>(result);
      <span class="hljs-keyword">return</span> result;
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-title function_">setError</span>(err <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>);
      <span class="hljs-keyword">throw</span> err;
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    }
  }, []);

  <span class="hljs-keyword">return</span> {
    data,
    loading,
    error,
    setData,
    refresh,
  };
}
</code></pre>
<h2 data-id="heading-10">四、实际业务场景应用</h2>
<h3 data-id="heading-11">场景：用户管理系统表格</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// features/user/components/UserTable.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SearchTable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/SearchTable'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SecureButton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/SecureButton'</span>;
<span class="hljs-keyword">import</span> { useUserTable } <span class="hljs-keyword">from</span> <span class="hljs-string">'../hooks/useUserTable'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserTable</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> {
    data,
    loading,
    pagination,
    searchFields,
    handleSearch,
    handleDelete,
    handleEdit,
  } = <span class="hljs-title function_">useUserTable</span>();

  <span class="hljs-keyword">const</span> columns = [
    {
      <span class="hljs-attr">key</span>: <span class="hljs-string">'name'</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">'姓名'</span>,
      <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">'name'</span>,
    },
    {
      <span class="hljs-attr">key</span>: <span class="hljs-string">'email'</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">'邮箱'</span>,
      <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">'email'</span>,
    },
    {
      <span class="hljs-attr">key</span>: <span class="hljs-string">'actions'</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">'操作'</span>,
      <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">SecureButton</span>
            <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleEdit(record)}
            permission="user:edit"
          &gt;
            编辑
          <span class="hljs-tag">&lt;/<span class="hljs-name">SecureButton</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">SecureButton</span>
            <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span>
            <span class="hljs-attr">danger</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleDelete(record.id)}
            permission="user:delete"
            confirm="确定删除该用户吗？"
            tracking={{ event: 'user_delete' }}
          &gt;
            删除
          <span class="hljs-tag">&lt;/<span class="hljs-name">SecureButton</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
      ),
    },
  ];

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SearchTable</span>
      <span class="hljs-attr">columns</span>=<span class="hljs-string">{columns}</span>
      <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span>
      <span class="hljs-attr">loading</span>=<span class="hljs-string">{loading}</span>
      <span class="hljs-attr">pagination</span>=<span class="hljs-string">{pagination}</span>
      <span class="hljs-attr">searchFields</span>=<span class="hljs-string">{searchFields}</span>
      <span class="hljs-attr">onSearch</span>=<span class="hljs-string">{handleSearch}</span>
      <span class="hljs-attr">rowKey</span>=<span class="hljs-string">"id"</span>
    /&gt;</span></span>
  );
};
</code></pre>
<h2 data-id="heading-12">五、架构收益与长期价值</h2>
<h3 data-id="heading-13">可度量的技术收益</h3>
<ul>
<li>
<p><strong>开发效率</strong>：组件复用率提升 40-60%</p>
</li>
<li>
<p><strong>维护成本</strong>：UI库升级工作量减少 70-80%</p>
</li>
<li>
<p><strong>代码质量</strong>：类型覆盖率提升至 90%+</p>
</li>
<li>
<p><strong>团队协作</strong>：新成员上手时间缩短 50%</p>
</li>
</ul>
<h3 data-id="heading-14">战略价值</h3>
<ol>
<li>
<p><strong>技术债务控制</strong>：通过中间层隔离变化，有效控制技术债务积累</p>
</li>
<li>
<p><strong>渐进式重构</strong>：支持老系统渐进式迁移和重构</p>
</li>
<li>
<p><strong>多端适配</strong>：为小程序、移动端等不同平台提供统一API</p>
</li>
<li>
<p><strong>A/B测试</strong>：在中间层实现无侵入的功能开关和实验配置</p>
</li>
</ol>
<h2 data-id="heading-15">六、最佳实践与注意事项</h2>
<h3 data-id="heading-16">实施建议</h3>
<ol>
<li>
<p><strong>渐进式推进</strong>：从最常用的组件开始封装，逐步覆盖</p>
</li>
<li>
<p><strong>文档驱动</strong>：为每个中间层组件提供完整的使用文档和示例</p>
</li>
<li>
<p><strong>版本管理</strong>：建立中间层组件的版本发布和更新机制</p>
</li>
<li>
<p><strong>性能监控</strong>：监控中间层组件的性能影响和错误率</p>
</li>
</ol>
<h3 data-id="heading-17">避免的陷阱</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 过度封装 - 增加了不必要的复杂度</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">SuperButton</span> = (<span class="hljs-params">{ 
  ultraProp, 
  megaConfig, 
  ...rest 
}</span>) =&gt; {
  <span class="hljs-comment">// 过于复杂的逻辑...</span>
};

<span class="hljs-comment">// ✅ 适度封装 - 保持简单清晰</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">PrimaryButton</span> = (<span class="hljs-params">{ 
  confirm, 
  tracking, 
  ...buttonProps 
}</span>) =&gt; {
  <span class="hljs-comment">// 聚焦核心增强功能...</span>
};
</code></pre>
<h2 data-id="heading-18">总结</h2>
<p>前端组件中间层设计不仅是技术实现，更是架构思维的体现。它通过合理的抽象和封装，在保证开发体验的同时，为应用长期演进提供了坚实的技术基础。成功的中间层设计应该像一座精心设计的桥梁，既连接现在与未来，又承载着团队协作和业务发展的重任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零到一：这篇JavaScript指南让你成为独立开发者]]></title>    <link>https://juejin.cn/post/7570187256105517062</link>    <guid>https://juejin.cn/post/7570187256105517062</guid>    <pubDate>2025-11-09T23:30:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570187256105517062" data-draft-id="7570162686580015146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零到一：这篇JavaScript指南让你成为独立开发者"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-09T23:30:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="良山有风来"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零到一：这篇JavaScript指南让你成为独立开发者
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    良山有风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T23:30:56.000Z" title="Sun Nov 09 2025 23:30:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    27
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是不是曾经看着满屏的代码感到无从下手？或者跟着教程做项目时总是一头雾水？别担心，今天这篇文章就是为你准备的。学完这篇内容，你就能真正理解JavaScript的精髓，独立开发出属于自己的应用。</p>
<p>我会带你从最基础的概念开始，一步步构建完整的应用思维。不用担心自己是新手，我会用最通俗易懂的方式讲解每个关键点。读完这篇文章，你将获得完整的JavaScript开发能力，能够独立设计和实现前端应用。</p>
<h2 data-id="heading-0">JavaScript的核心概念</h2>
<p>让我们先来理解JavaScript的几个核心概念。很多人学不会编程，就是因为一开始被各种术语吓住了。其实编程就像学做菜，先搞清楚油盐酱醋是干什么的，再学炒菜就简单了。</p>
<p>变量就像厨房里的调料瓶，用来存放各种数据。在JavaScript中，我们常用let和const来声明变量。看这个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// let用于声明可以改变的变量</span>
<span class="hljs-keyword">let</span> userName = <span class="hljs-string">'小明'</span>;
userName = <span class="hljs-string">'小红'</span>; <span class="hljs-comment">// 这样可以改变</span>

<span class="hljs-comment">// const用于声明不变的常量</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_USERS</span> = <span class="hljs-number">100</span>;
<span class="hljs-comment">// MAX_USERS = 200; 这样会报错，因为常量不能重新赋值</span>
</code></pre>
<p>函数就像是预制的调味料组合，一次调配，多次使用。理解函数是独立开发的第一步：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义一个简单的函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greetUser</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`你好，<span class="hljs-subst">${name}</span>！欢迎使用我们的应用。`</span>;
}

<span class="hljs-comment">// 使用函数</span>
<span class="hljs-keyword">const</span> greeting = <span class="hljs-title function_">greetUser</span>(<span class="hljs-string">'张三'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(greeting); <span class="hljs-comment">// 输出：你好，张三！欢迎使用我们的应用。</span>
</code></pre>
<p>对象和数组让我们能够组织更复杂的数据。想象你要开发一个待办事项应用，就需要用这些结构来存储任务数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用对象表示一个任务</span>
<span class="hljs-keyword">const</span> task = {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">'学习JavaScript'</span>,
    <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">dueDate</span>: <span class="hljs-string">'2024-12-31'</span>
};

<span class="hljs-comment">// 用数组存储多个任务</span>
<span class="hljs-keyword">const</span> taskList = [
    task,
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'写项目文档'</span>,
        <span class="hljs-attr">completed</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">dueDate</span>: <span class="hljs-string">'2024-11-15'</span>
    }
];
</code></pre>
<h2 data-id="heading-1">现代JavaScript开发必备技能</h2>
<p>掌握了基础概念，接下来要了解现代JavaScript开发的必备技能。这些是你能独立开发应用的基石。</p>
<p>异步编程是必须掌握的重点。现在的应用都需要与服务器通信，理解Promise和async/await至关重要：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟从服务器获取数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUserData</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">if</span> (userId === <span class="hljs-number">1</span>) {
                <span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">28</span> });
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">reject</span>(<span class="hljs-string">'用户不存在'</span>);
            }
        }, <span class="hljs-number">1000</span>);
    });
}

<span class="hljs-comment">// 使用async/await处理异步操作</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">displayUserInfo</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'正在加载用户信息...'</span>);
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUserData</span>(userId);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`用户姓名：<span class="hljs-subst">${user.name}</span>，年龄：<span class="hljs-subst">${user.age}</span>`</span>);
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'出错啦：'</span>, error);
    }
}

<span class="hljs-comment">// 调用函数</span>
<span class="hljs-title function_">displayUserInfo</span>(<span class="hljs-number">1</span>);
</code></pre>
<p>DOM操作让JavaScript能够与网页交互。这是前端开发的核心能力：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建新的任务元素并添加到页面</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addTaskToDOM</span>(<span class="hljs-params">task</span>) {
    <span class="hljs-comment">// 创建任务容器</span>
    <span class="hljs-keyword">const</span> taskElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    taskElement.<span class="hljs-property">className</span> = <span class="hljs-string">'task-item'</span>;
    taskElement.<span class="hljs-property">id</span> = <span class="hljs-string">`task-<span class="hljs-subst">${task.id}</span>`</span>;
    
    <span class="hljs-comment">// 设置任务内容</span>
    taskElement.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
        &lt;input type="checkbox" <span class="hljs-subst">${task.completed ? <span class="hljs-string">'checked'</span> : <span class="hljs-string">''</span>}</span>&gt;
        &lt;span class="task-title"&gt;<span class="hljs-subst">${task.title}</span>&lt;/span&gt;
        &lt;span class="due-date"&gt;<span class="hljs-subst">${task.dueDate}</span>&lt;/span&gt;
        &lt;button class="delete-btn"&gt;删除&lt;/button&gt;
    `</span>;
    
    <span class="hljs-comment">// 添加到任务列表</span>
    <span class="hljs-keyword">const</span> taskList = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'task-list'</span>);
    taskList.<span class="hljs-title function_">appendChild</span>(taskElement);
    
    <span class="hljs-comment">// 添加删除功能</span>
    <span class="hljs-keyword">const</span> deleteBtn = taskElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.delete-btn'</span>);
    deleteBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        taskElement.<span class="hljs-title function_">remove</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`删除了任务：<span class="hljs-subst">${task.title}</span>`</span>);
    });
}
</code></pre>
<h2 data-id="heading-2">构建完整的待办事项应用</h2>
<p>现在让我们把这些知识点串联起来，构建一个完整的待办事项应用。这个例子会涵盖数据管理、用户交互、本地存储等核心概念。</p>
<p>首先，我们需要一个应用状态管理器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TodoApp</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadTasks</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> ? 
            <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(...<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">id</span>)) + <span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-comment">// 从本地存储加载任务</span>
    <span class="hljs-title function_">loadTasks</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> saved = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'todoTasks'</span>);
        <span class="hljs-keyword">return</span> saved ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(saved) : [];
    }
    
    <span class="hljs-comment">// 保存任务到本地存储</span>
    <span class="hljs-title function_">saveTasks</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'todoTasks'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>));
    }
    
    <span class="hljs-comment">// 添加新任务</span>
    <span class="hljs-title function_">addTask</span>(<span class="hljs-params">title, dueDate</span>) {
        <span class="hljs-keyword">const</span> newTask = {
            <span class="hljs-attr">id</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentId</span>++,
            <span class="hljs-attr">title</span>: title,
            <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">dueDate</span>: dueDate,
            <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
        };
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>(newTask);
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveTasks</span>();
        <span class="hljs-keyword">return</span> newTask;
    }
    
    <span class="hljs-comment">// 切换任务完成状态</span>
    <span class="hljs-title function_">toggleTask</span>(<span class="hljs-params">id</span>) {
        <span class="hljs-keyword">const</span> task = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">id</span> === id);
        <span class="hljs-keyword">if</span> (task) {
            task.<span class="hljs-property">completed</span> = !task.<span class="hljs-property">completed</span>;
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveTasks</span>();
        }
    }
    
    <span class="hljs-comment">// 删除任务</span>
    <span class="hljs-title function_">deleteTask</span>(<span class="hljs-params">id</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">id</span> !== id);
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveTasks</span>();
    }
    
    <span class="hljs-comment">// 获取所有任务</span>
    <span class="hljs-title function_">getAllTasks</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>;
    }
    
    <span class="hljs-comment">// 获取未完成的任务</span>
    <span class="hljs-title function_">getActiveTasks</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> !t.<span class="hljs-property">completed</span>);
    }
    
    <span class="hljs-comment">// 获取已完成的任务</span>
    <span class="hljs-title function_">getCompletedTasks</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">completed</span>);
    }
}
</code></pre>
<p>接下来是用户界面控制器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TodoUI</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">app</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span> = app;
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initializeEventListeners</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
    }
    
    <span class="hljs-comment">// 初始化事件监听</span>
    <span class="hljs-title function_">initializeEventListeners</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> addButton = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'add-task-btn'</span>);
        <span class="hljs-keyword">const</span> taskInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'new-task-input'</span>);
        <span class="hljs-keyword">const</span> dueDateInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'due-date-input'</span>);
        
        addButton.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleAddTask</span>(taskInput, dueDateInput);
        });
        
        taskInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keypress'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleAddTask</span>(taskInput, dueDateInput);
            }
        });
    }
    
    <span class="hljs-comment">// 处理添加任务</span>
    <span class="hljs-title function_">handleAddTask</span>(<span class="hljs-params">taskInput, dueDateInput</span>) {
        <span class="hljs-keyword">const</span> title = taskInput.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
        <span class="hljs-keyword">const</span> dueDate = dueDateInput.<span class="hljs-property">value</span>;
        
        <span class="hljs-keyword">if</span> (title) {
            <span class="hljs-keyword">const</span> newTask = <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">addTask</span>(title, dueDate);
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
            taskInput.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
            dueDateInput.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
            
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`添加了新任务："<span class="hljs-subst">${title}</span>"`</span>);
        }
    }
    
    <span class="hljs-comment">// 渲染任务列表</span>
    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> taskList = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'task-list'</span>);
        taskList.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
        
        <span class="hljs-keyword">const</span> tasks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">getAllTasks</span>();
        
        tasks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span> {
            <span class="hljs-keyword">const</span> taskElement = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createTaskElement</span>(task);
            taskList.<span class="hljs-title function_">appendChild</span>(taskElement);
        });
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateStats</span>();
    }
    
    <span class="hljs-comment">// 创建任务元素</span>
    <span class="hljs-title function_">createTaskElement</span>(<span class="hljs-params">task</span>) {
        <span class="hljs-keyword">const</span> taskElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
        taskElement.<span class="hljs-property">className</span> = <span class="hljs-string">`task-item <span class="hljs-subst">${task.completed ? <span class="hljs-string">'completed'</span> : <span class="hljs-string">''</span>}</span>`</span>;
        taskElement.<span class="hljs-property">id</span> = <span class="hljs-string">`task-<span class="hljs-subst">${task.id}</span>`</span>;
        
        taskElement.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
            &lt;div class="task-content"&gt;
                &lt;input type="checkbox" <span class="hljs-subst">${task.completed ? <span class="hljs-string">'checked'</span> : <span class="hljs-string">''</span>}</span> 
                    class="task-checkbox"&gt;
                &lt;span class="task-title"&gt;<span class="hljs-subst">${task.title}</span>&lt;/span&gt;
                <span class="hljs-subst">${task.dueDate ? <span class="hljs-string">`&lt;span class="due-date"&gt;截止：<span class="hljs-subst">${task.dueDate}</span>&lt;/span&gt;`</span> : <span class="hljs-string">''</span>}</span>
            &lt;/div&gt;
            &lt;button class="delete-btn"&gt;删除&lt;/button&gt;
        `</span>;
        
        <span class="hljs-comment">// 添加复选框事件</span>
        <span class="hljs-keyword">const</span> checkbox = taskElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.task-checkbox'</span>);
        checkbox.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">toggleTask</span>(task.<span class="hljs-property">id</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
        });
        
        <span class="hljs-comment">// 添加删除按钮事件</span>
        <span class="hljs-keyword">const</span> deleteBtn = taskElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.delete-btn'</span>);
        deleteBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">deleteTask</span>(task.<span class="hljs-property">id</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
        });
        
        <span class="hljs-keyword">return</span> taskElement;
    }
    
    <span class="hljs-comment">// 更新统计信息</span>
    <span class="hljs-title function_">updateStats</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> totalTasks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">getAllTasks</span>().<span class="hljs-property">length</span>;
        <span class="hljs-keyword">const</span> activeTasks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">getActiveTasks</span>().<span class="hljs-property">length</span>;
        <span class="hljs-keyword">const</span> completedTasks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">getCompletedTasks</span>().<span class="hljs-property">length</span>;
        
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`总任务：<span class="hljs-subst">${totalTasks}</span>，待完成：<span class="hljs-subst">${activeTasks}</span>，已完成：<span class="hljs-subst">${completedTasks}</span>`</span>);
    }
}
</code></pre>
<p>最后是应用的初始化代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 应用启动函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initializeApp</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建应用实例</span>
    <span class="hljs-keyword">const</span> todoApp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TodoApp</span>();
    <span class="hljs-keyword">const</span> todoUI = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TodoUI</span>(todoApp);
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'待办事项应用已启动！'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前任务数量：'</span>, todoApp.<span class="hljs-title function_">getAllTasks</span>().<span class="hljs-property">length</span>);
    
    <span class="hljs-keyword">return</span> { todoApp, todoUI };
}

<span class="hljs-comment">// 当页面加载完成后启动应用</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, initializeApp);
</code></pre>
<h2 data-id="heading-3">进阶技巧和最佳实践</h2>
<p>当你能够独立完成基础应用后，这些进阶技巧会让你的代码更加专业和可维护。</p>
<p>模块化是现代JavaScript开发的重要概念。我们可以使用ES6模块来组织代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/dateHelper.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">formatDate</span>(<span class="hljs-params">dateString</span>) {
    <span class="hljs-keyword">const</span> options = { <span class="hljs-attr">year</span>: <span class="hljs-string">'numeric'</span>, <span class="hljs-attr">month</span>: <span class="hljs-string">'short'</span>, <span class="hljs-attr">day</span>: <span class="hljs-string">'numeric'</span> };
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(dateString).<span class="hljs-title function_">toLocaleDateString</span>(<span class="hljs-string">'zh-CN'</span>, options);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isOverdue</span>(<span class="hljs-params">dueDate</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(dueDate) &lt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
}

<span class="hljs-comment">// 在另一个文件中导入使用</span>
<span class="hljs-keyword">import</span> { formatDate, isOverdue } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/dateHelper.js'</span>;

<span class="hljs-keyword">const</span> dueDate = <span class="hljs-string">'2024-12-31'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`格式化日期：<span class="hljs-subst">${formatDate(dueDate)}</span>`</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`是否过期：<span class="hljs-subst">${isOverdue(dueDate)}</span>`</span>);
</code></pre>
<p>错误处理是专业开发者的标志。学会优雅地处理各种异常情况：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataValidator</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">validateTask</span>(<span class="hljs-params">task</span>) {
        <span class="hljs-keyword">const</span> errors = [];
        
        <span class="hljs-keyword">if</span> (!task.<span class="hljs-property">title</span> || task.<span class="hljs-property">title</span>.<span class="hljs-title function_">trim</span>().<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
            errors.<span class="hljs-title function_">push</span>(<span class="hljs-string">'任务标题不能为空'</span>);
        }
        
        <span class="hljs-keyword">if</span> (task.<span class="hljs-property">title</span> &amp;&amp; task.<span class="hljs-property">title</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">100</span>) {
            errors.<span class="hljs-title function_">push</span>(<span class="hljs-string">'任务标题不能超过100个字符'</span>);
        }
        
        <span class="hljs-keyword">if</span> (task.<span class="hljs-property">dueDate</span> &amp;&amp; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(task.<span class="hljs-property">dueDate</span>) &lt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()) {
            errors.<span class="hljs-title function_">push</span>(<span class="hljs-string">'截止日期不能是过去的时间'</span>);
        }
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">isValid</span>: errors.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>,
            <span class="hljs-attr">errors</span>: errors
        };
    }
}

<span class="hljs-comment">// 使用验证器</span>
<span class="hljs-keyword">const</span> newTask = {
    <span class="hljs-attr">title</span>: <span class="hljs-string">'学习JavaScript高级技巧'</span>,
    <span class="hljs-attr">dueDate</span>: <span class="hljs-string">'2024-12-31'</span>
};

<span class="hljs-keyword">const</span> validation = <span class="hljs-title class_">DataValidator</span>.<span class="hljs-title function_">validateTask</span>(newTask);
<span class="hljs-keyword">if</span> (!validation.<span class="hljs-property">isValid</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'验证失败：'</span>, validation.<span class="hljs-property">errors</span>);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务数据有效，可以保存'</span>);
}
</code></pre>
<p>性能优化让你的应用更加流畅。这里有一些实用的优化技巧：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用防抖优化搜索功能</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, wait</span>) {
    <span class="hljs-keyword">let</span> timeout;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">executedFunction</span>(<span class="hljs-params">...args</span>) {
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">later</span> = (<span class="hljs-params"/>) =&gt; {
            <span class="hljs-built_in">clearTimeout</span>(timeout);
            <span class="hljs-title function_">func</span>(...args);
        };
        <span class="hljs-built_in">clearTimeout</span>(timeout);
        timeout = <span class="hljs-built_in">setTimeout</span>(later, wait);
    };
}

<span class="hljs-comment">// 搜索任务</span>
<span class="hljs-keyword">const</span> searchTasks = <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">searchTerm</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> filteredTasks = todoApp.<span class="hljs-title function_">getAllTasks</span>().<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span>
        task.<span class="hljs-property">title</span>.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">includes</span>(searchTerm.<span class="hljs-title function_">toLowerCase</span>())
    );
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`找到 <span class="hljs-subst">${filteredTasks.length}</span> 个匹配的任务`</span>);
}, <span class="hljs-number">300</span>);

<span class="hljs-comment">// 在输入框中使用</span>
<span class="hljs-keyword">const</span> searchInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'search-input'</span>);
searchInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-title function_">searchTasks</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
});
</code></pre>
<h2 data-id="heading-4">从学习到实战的转变</h2>
<p>很多人学完基础知识后，不知道如何开始真正的项目开发。这里给你一个清晰的路径。</p>
<p>首先选择适合的练习项目。从简单到复杂，逐步提升：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 项目难度分级</span>
<span class="hljs-keyword">const</span> projectRoadmap = [
    {
        <span class="hljs-attr">level</span>: <span class="hljs-string">'初级'</span>,
        <span class="hljs-attr">projects</span>: [
            <span class="hljs-string">'个人博客页面'</span>,
            <span class="hljs-string">'计算器应用'</span>,
            <span class="hljs-string">'天气查询小工具'</span>,
            <span class="hljs-string">'简单的游戏（如井字棋）'</span>
        ],
        <span class="hljs-attr">skills</span>: [<span class="hljs-string">'基础DOM操作'</span>, <span class="hljs-string">'事件处理'</span>, <span class="hljs-string">'条件判断'</span>]
    },
    {
        <span class="hljs-attr">level</span>: <span class="hljs-string">'中级'</span>,
        <span class="hljs-attr">projects</span>: [
            <span class="hljs-string">'待办事项应用（带本地存储）'</span>,
            <span class="hljs-string">'记账应用'</span>,
            <span class="hljs-string">'图片画廊'</span>,
            <span class="hljs-string">'API数据展示应用'</span>
        ],
        <span class="hljs-attr">skills</span>: [<span class="hljs-string">'异步编程'</span>, <span class="hljs-string">'本地存储'</span>, <span class="hljs-string">'模块化'</span>, <span class="hljs-string">'错误处理'</span>]
    },
    {
        <span class="hljs-attr">level</span>: <span class="hljs-string">'高级'</span>,
        <span class="hljs-attr">projects</span>: [
            <span class="hljs-string">'实时聊天应用'</span>,
            <span class="hljs-string">'任务管理系统'</span>,
            <span class="hljs-string">'数据可视化仪表板'</span>,
            <span class="hljs-string">'小型电商网站'</span>
        ],
        <span class="hljs-attr">skills</span>: [<span class="hljs-string">'框架使用'</span>, <span class="hljs-string">'状态管理'</span>, <span class="hljs-string">'性能优化'</span>, <span class="hljs-string">'测试'</span>]
    }
];
</code></pre>
<p>学会阅读文档和查找资料。这是独立开发者最重要的能力：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟解决问题的过程</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">solveProblem</span>(<span class="hljs-params">problemDescription</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'问题：'</span>, problemDescription);
    
    <span class="hljs-comment">// 第一步：分析问题</span>
    <span class="hljs-keyword">const</span> analysis = <span class="hljs-title function_">analyzeProblem</span>(problemDescription);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'问题分析：'</span>, analysis);
    
    <span class="hljs-comment">// 第二步：查找相关资料</span>
    <span class="hljs-keyword">const</span> resources = <span class="hljs-keyword">await</span> <span class="hljs-title function_">searchResources</span>(analysis.<span class="hljs-property">keywords</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'相关资源：'</span>, resources);
    
    <span class="hljs-comment">// 第三步：尝试解决方案</span>
    <span class="hljs-keyword">const</span> solution = <span class="hljs-title function_">trySolutions</span>(resources);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'解决方案：'</span>, solution);
    
    <span class="hljs-comment">// 第四步：总结学习</span>
    <span class="hljs-keyword">const</span> learnings = <span class="hljs-title function_">summarizeLearnings</span>(problemDescription, solution);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'学习总结：'</span>, learnings);
    
    <span class="hljs-keyword">return</span> solution;
}
</code></pre>
<p>建立自己的代码库和工具集。这会大大提高你的开发效率：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 个人工具函数库</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DevUtils</span> {
    <span class="hljs-comment">// 深度复制对象</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj));
    }
    
    <span class="hljs-comment">// 生成随机ID</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">generateId</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>) + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>).<span class="hljs-title function_">substr</span>(<span class="hljs-number">2</span>);
    }
    
    <span class="hljs-comment">// 格式化文件大小</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">formatFileSize</span>(<span class="hljs-params">bytes</span>) {
        <span class="hljs-keyword">const</span> sizes = [<span class="hljs-string">'Bytes'</span>, <span class="hljs-string">'KB'</span>, <span class="hljs-string">'MB'</span>, <span class="hljs-string">'GB'</span>];
        <span class="hljs-keyword">if</span> (bytes === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'0 Bytes'</span>;
        <span class="hljs-keyword">const</span> i = <span class="hljs-built_in">parseInt</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">log</span>(bytes) / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1024</span>)));
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(bytes / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">1024</span>, i), <span class="hljs-number">2</span>) + <span class="hljs-string">' '</span> + sizes[i];
    }
    
    <span class="hljs-comment">// 等待指定时间</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-params">ms</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, ms));
    }
}

<span class="hljs-comment">// 使用工具函数</span>
<span class="hljs-keyword">const</span> originalObject = { <span class="hljs-attr">name</span>: <span class="hljs-string">'测试'</span>, <span class="hljs-attr">data</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] };
<span class="hljs-keyword">const</span> clonedObject = <span class="hljs-title class_">DevUtils</span>.<span class="hljs-title function_">deepClone</span>(originalObject);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'克隆的对象：'</span>, clonedObject);
</code></pre>
<h2 data-id="heading-5">持续学习和进步</h2>
<p>编程是一个需要持续学习的领域。建立好的学习习惯会让你走得更远。</p>
<p>制定合理的学习计划：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 周学习计划示例</span>
<span class="hljs-keyword">const</span> weeklyLearningPlan = {
    <span class="hljs-attr">monday</span>: {
        <span class="hljs-attr">focus</span>: <span class="hljs-string">'新技术探索'</span>,
        <span class="hljs-attr">tasks</span>: [
            <span class="hljs-string">'阅读一篇技术文章'</span>,
            <span class="hljs-string">'尝试一个新的JavaScript特性'</span>,
            <span class="hljs-string">'写一个小demo验证理解'</span>
        ],
        <span class="hljs-attr">time</span>: <span class="hljs-string">'1-2小时'</span>
    },
    <span class="hljs-attr">wednesday</span>: {
        <span class="hljs-attr">focus</span>: <span class="hljs-string">'项目实践'</span>,
        <span class="hljs-attr">tasks</span>: [
            <span class="hljs-string">'在个人项目上工作'</span>,
            <span class="hljs-string">'重构旧代码'</span>,
            <span class="hljs-string">'添加新功能'</span>
        ],
        <span class="hljs-attr">time</span>: <span class="hljs-string">'2-3小时'</span>
    },
    <span class="hljs-attr">friday</span>: {
        <span class="hljs-attr">focus</span>: <span class="hljs-string">'总结和复习'</span>,
        <span class="hljs-attr">tasks</span>: [
            <span class="hljs-string">'整理本周学习笔记'</span>,
            <span class="hljs-string">'回顾遇到的问题和解决方案'</span>,
            <span class="hljs-string">'规划下周学习内容'</span>
        ],
        <span class="hljs-attr">time</span>: <span class="hljs-string">'1小时'</span>
    }
};
</code></pre>
<p>参与开源项目和编程社区：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 参与开源的建议步骤</span>
<span class="hljs-keyword">const</span> openSourceGuide = {
    <span class="hljs-attr">step1</span>: <span class="hljs-string">'寻找感兴趣的项目'</span>,
    <span class="hljs-attr">criteria</span>: [
        <span class="hljs-string">'有清晰的文档'</span>,
        <span class="hljs-string">'有活跃的维护者'</span>,
        <span class="hljs-string">'有good first issue标签'</span>
    ],
    
    <span class="hljs-attr">step2</span>: <span class="hljs-string">'理解项目结构'</span>,
    <span class="hljs-attr">actions</span>: [
        <span class="hljs-string">'阅读README和贡献指南'</span>,
        <span class="hljs-string">'在本地运行项目'</span>,
        <span class="hljs-string">'查看现有代码风格'</span>
    ],
    
    <span class="hljs-attr">step3</span>: <span class="hljs-string">'从小处着手'</span>,
    <span class="hljs-attr">suggestions</span>: [
        <span class="hljs-string">'修复文档错误'</span>,
        <span class="hljs-string">'解决简单的bug'</span>,
        <span class="hljs-string">'添加测试用例'</span>
    ],
    
    <span class="hljs-attr">step4</span>: <span class="hljs-string">'提交贡献'</span>,
    <span class="hljs-attr">tips</span>: [
        <span class="hljs-string">'遵循项目规范'</span>,
        <span class="hljs-string">'编写清晰的提交信息'</span>,
        <span class="hljs-string">'耐心等待代码审查'</span>
    ]
};
</code></pre>
<h2 data-id="heading-6">真正的独立开发之路</h2>
<p>读完这篇文章，你已经掌握了从零开始独立开发JavaScript应用的核心知识和技能。从基础语法到完整应用架构，从代码编写到问题解决，你现在具备了独立探索和创造的能力。</p>
<p>记住，成为真正的独立开发者不在于记住所有API，而在于培养解决问题的能力。当你遇到未知的挑战时，能够冷静分析、寻找资源、尝试方案，这才是最宝贵的技能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java性能调优的7个被低估的技巧：从代码到JVM全链路优化]]></title>    <link>https://juejin.cn/post/7570533058841198627</link>    <guid>https://juejin.cn/post/7570533058841198627</guid>    <pubDate>2025-11-10T04:19:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570533058841198627" data-draft-id="7570651893867774004" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java性能调优的7个被低估的技巧：从代码到JVM全链路优化"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-10T04:19:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java性能调优的7个被低估的技巧：从代码到JVM全链路优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T04:19:27.000Z" title="Mon Nov 10 2025 04:19:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Java性能调优的7个被低估的技巧：从代码到JVM全链路优化</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>在Java开发中，性能优化是一个永恒的话题。虽然大多数开发者熟悉基础的优化手段（如使用缓存、减少数据库查询等），但许多深层次的技巧往往被低估或忽视。本文将深入探讨7个鲜为人知但极具价值的Java性能调优技巧，涵盖从代码编写到JVM参数配置的全链路优化。这些技巧基于真实的实践经验和权威资料（如Oracle官方文档、JVM规范及性能专家的建议），旨在帮助开发者挖掘更深层次的性能潜力。</p>
<hr/>
<h3 data-id="heading-2">1. 字符串操作的隐藏陷阱与优化</h3>
<p>字符串操作是Java中最常见的性能瓶颈之一，尤其是<code>String</code>的不可变性导致的频繁对象创建。以下是两个关键优化点：</p>
<h4 data-id="heading-3">使用<code>StringBuilder</code>替代字符串拼接</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 低效写法</span>
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
    result += i;
}

<span class="hljs-comment">// 高效写法</span>
<span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
    sb.append(i);
}
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> sb.toString();
</code></pre>
<p><strong>原理</strong>：每次<code>+=</code>操作会创建一个新的<code>String</code>对象，而<code>StringBuilder</code>通过可变字符数组避免重复分配内存。</p>
<h4 data-id="heading-4">预分配<code>StringBuilder</code>容量</h4>
<p>默认情况下，<code>StringBuilder</code>的初始容量为16字节，频繁扩容会消耗资源。通过预估大小提前分配容量可显著提升性能：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-number">1024</span>); <span class="hljs-comment">// 预分配1KB空间</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">2. 集合类的选择与调优</h3>
<p>不同的集合类在不同场景下性能差异巨大：</p>
<h4 data-id="heading-6"><code>ArrayList</code> vs <code>LinkedList</code></h4>
<ul>
<li><strong>随机访问</strong>：<code>ArrayList</code>的复杂度为O(1)，而<code>LinkedList</code>为O(n)。</li>
<li><strong>插入/删除</strong>：在头部插入时，<code>LinkedList</code>（O(1)）优于<code>ArrayList</code>（O(n)）。</li>
</ul>
<h4 data-id="heading-7">HashMap的负载因子与初始化大小</h4>
<p>默认负载因子（0.75）和初始容量（16）可能不适用于高频场景。例如，若预期存储10,000个元素：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;String, Integer&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">16384</span>, <span class="hljs-number">0.5f</span>); <span class="hljs-comment">// 减少扩容次数</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">3. JIT编译器的冷启动优化</h3>
<p>Java的JIT（Just-In-Time）编译器虽然能动态优化热点代码，但冷启动阶段仍可能成为瓶颈。以下方法可缓解问题：</p>
<h4 data-id="heading-9"><strong>分层编译策略</strong></h4>
<p>通过JVM参数启用分层编译（默认已开启）：</p>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+TieredCompilation</span>
</code></pre>
<p><strong>作用</strong>：结合解释执行与编译执行的优势，逐步提升性能。</p>
<h4 data-id="heading-10"><strong>预热关键路径代码</strong></h4>
<p>在高并发系统中，可通过模拟请求提前触发JIT编译核心逻辑。</p>
<hr/>
<h3 data-id="heading-11">4. 逃逸分析与栈上分配</h3>
<p>逃逸分析（Escape Analysis）是JVM的一项高级优化技术，用于判断对象是否“逃逸”出当前方法或线程作用域。若未逃逸，JVM可能直接在栈上分配对象（而非堆），减少GC压力。</p>
<h4 data-id="heading-12"><strong>如何利用逃逸分析？</strong></h4>
<ul>
<li><strong>局部化对象生命周期</strong>：尽量缩小对象的作用域。</li>
<li><strong>避免返回内部数组引用</strong>：防止对象逃逸到外部。</li>
</ul>
<p>示例对比：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 可能导致逃逸</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getData</span><span class="hljs-params">()</span> {
    <span class="hljs-type">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(data); <span class="hljs-comment">// data通过String逃逸</span>
}

<span class="hljs-comment">// 更优写法（若不需返回）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processData</span><span class="hljs-params">()</span> {
    <span class="hljs-type">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>]; <span class="hljs-comment">// 可能栈上分配</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-13">5. GC调优的低成本高回报技巧</h3>
<h4 data-id="heading-14"><strong>选择合适的垃圾收集器</strong></h4>

























<table><thead><tr><th>GC类型</th><th>适用场景</th><th>JVM参数</th></tr></thead><tbody><tr><td>G1GC</td><td>大堆、低延迟需求</td><td><code>-XX:+UseG1GC</code></td></tr><tr><td>ZGC</td><td>TB级堆、亚毫秒暂停</td><td><code>-XX:+UseZGC</code></td></tr><tr><td>Shenandoah</td><td>NUMA架构、低延迟</td><td><code>-XX:+UseShenandoahGC</code></td></tr></tbody></table>
<h4 data-id="heading-15"><strong>调整Survivor区比例</strong></h4>
<p>对于短生命周期对象多的应用，可通过调整Survivor区比例减少晋升到老年代的频率：</p>
<pre><code class="hljs language-ini" lang="ini">-XX:<span class="hljs-attr">SurvivorRatio</span>=<span class="hljs-number">8</span> -XX:NewRatio=<span class="hljs-number">2</span>
</code></pre>
<hr/>
<h3 data-id="heading-16">6. Native Memory的监控与泄漏防范</h3>
<p>Java应用的内存问题不限于堆内存，Native Memory泄漏同样致命。以下工具可用于诊断：</p>
<h4 data-id="heading-17"><strong>NMT（Native Memory Tracking）</strong></h4>
<p>启用NMT监控：</p>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:NativeMemoryTracking=detail</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UnlockDiagnosticVMOptions</span>
</code></pre>
<p>查看报告：</p>
<pre><code class="hljs language-bash" lang="bash">jcmd &lt;pid&gt; VM.native_memory summary
</code></pre>
<h4 data-id="heading-18"><strong>常见泄漏场景</strong></h4>
<ul>
<li>JNI调用未释放的资源。</li>
<li>Direct ByteBuffer未显式回收。</li>
</ul>
<hr/>
<h3 data-id="heading-19">7. CPU缓存友好性编程</h3>
<p>现代CPU的多级缓存对性能影响极大。以下方法可提升缓存命中率：</p>
<h4 data-id="heading-20"><strong>数据局部性原理的应用</strong></h4>
<ul>
<li><strong>紧凑数据结构</strong>：避免稀疏数据布局（如二维数组优先行存储）。</li>
<li><strong>伪共享问题的解决</strong> ：使用填充或注解对齐缓存行：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Contended</span> <span class="hljs-comment">// JDK8+支持 </span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> counter;
</code></pre>
<hr/>
<h3 data-id="heading-21">总结</h3>
<p>Java性能调优是一个涉及代码、JVM乃至硬件的系统性工程。本文介绍的7个技巧——从字符串操作的微观优化到CPU缓存的宏观设计——覆盖了容易被忽视却至关重要的领域。实际应用中需结合Profiling工具（如Async Profiler、VisualVM）量化分析瓶颈点，避免过早优化带来的复杂性上升。记住：“没有银弹”，只有持续测量与迭代才能构建真正高性能的系统！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot实现隐式参数注入]]></title>    <link>https://juejin.cn/post/7570187256105533446</link>    <guid>https://juejin.cn/post/7570187256105533446</guid>    <pubDate>2025-11-09T23:55:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570187256105533446" data-draft-id="7569920331118854184" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot实现隐式参数注入"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-09T23:55:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot实现隐式参数注入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T23:55:57.000Z" title="Sun Nov 09 2025 23:55:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    29
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：一个痛点</h2>
<p>想象一下这样的场景：用户请求带着 JWT Token 进入你的系统，Filter 层面解析 Token 得到用户 ID，接下来需要：</p>
<ul>
<li>在 Controller 层获取用户信息</li>
<li>在 Service 层进行权限验证</li>
<li>在某些业务逻辑中记录操作日志</li>
</ul>
<p>每一个环节都需要知道"当前用户是谁"，看看目前常用的解决方案。</p>
<h4 data-id="heading-1">传统方案的"缺陷"</h4>
<p><strong>方案一：ThreadLocal</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 看起来很"Hack"</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Long&gt; currentUser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
</code></pre>
<ul>
<li><strong>线程安全问题</strong>：在异步环境下可能出现数据错乱</li>
<li><strong>内存泄漏风险</strong>：ThreadLocal 使用不当可能导致内存泄漏</li>
<li><strong>代码可读性差</strong>：隐式的数据传递方式让代码逻辑变得难以追踪</li>
</ul>
<p><strong>方案二：HttpServletRequest.setAttribute()</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 看起来很"丑"</span>
<span class="hljs-meta">@GetMapping("/me")</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getMyProfile</span><span class="hljs-params">(HttpServletRequest request)</span> {
    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> (Long) request.getAttribute(<span class="hljs-string">"currentUserId"</span>);
    <span class="hljs-keyword">return</span> userService.getById(userId);
}
</code></pre>
<ul>
<li><strong>类型不安全</strong>：需要手动进行类型转换，容易出现 ClassCastException</li>
<li><strong>代码冗余</strong>：每个需要用户信息的 Controller 都要重复相同的逻辑</li>
<li><strong>违反了 Controller 的"纯净性"</strong>：引入了 Servlet API 依赖</li>
<li><strong>字符串魔法值</strong>：属性名称容易写错，编译时无法检查</li>
</ul>
<h2 data-id="heading-2">Spring MVC：HandlerMethodArgumentResolver</h2>
<p>Spring MVC 提供了一个解决方案：<strong>自定义参数解析器（HandlerMethodArgumentResolver）</strong>。</p>
<p>这个设计模式体现了 Spring 框架一贯的"约定优于配置"的理念。它不要求我们改变 Filter 层面的实现，而是在参数解析这个环节做文章，通过扩展框架的能力来解决问题。</p>
<h4 data-id="heading-3">设计思路</h4>
<p>Spring MVC 的 HandlerMethodArgumentResolver 机制实际上是一种"适配器模式"的应用。它将不同来源的参数（Request 参数、Path 变量、Header 信息、Session 数据等）统一适配成 Controller 方法可以直接使用的形式。</p>
<p>这种设计的巧妙之处在于：</p>
<ul>
<li><strong>职责分离</strong>：Filter 负责认证和设置状态，Resolver 负责参数转换</li>
<li><strong>可扩展性</strong>：可以轻松添加新的参数解析逻辑</li>
<li><strong>无侵入性</strong>：不影响现有的代码结构</li>
</ul>
<p>这个方案的核心思想是：<strong>将 request.getAttribute() 操作，封装成类型安全的方法参数</strong>。</p>
<h4 data-id="heading-4">核心实现</h4>
<h5 data-id="heading-5">第一步：创建自定义注解</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.PARAMETER)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> CurrentUser {
}
</code></pre>
<h5 data-id="heading-6">第二步：实现参数解析器</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurrentUserArgumentResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerMethodArgumentResolver</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supportsParameter</span><span class="hljs-params">(MethodParameter parameter)</span> {
        <span class="hljs-comment">// 只解析被 @CurrentUser 标记的参数</span>
        <span class="hljs-keyword">return</span> parameter.hasParameterAnnotation(CurrentUser.class);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">resolveArgument</span><span class="hljs-params">(MethodParameter parameter,
                                 ModelAndViewContainer mavContainer,
                                 NativeWebRequest webRequest,
                                 WebDataBinderFactory binderFactory)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 从 request 中获取之前设置的用户ID</span>
        <span class="hljs-keyword">return</span> webRequest.getAttribute(<span class="hljs-string">"currentUserId"</span>, WebRequest.SCOPE_REQUEST);
    }
}
</code></pre>
<h5 data-id="heading-7">第三步：注册解析器</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CurrentUserArgumentResolver currentUserArgumentResolver;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addArgumentResolvers</span><span class="hljs-params">(List&lt;HandlerMethodArgumentResolver&gt; resolvers)</span> {
        resolvers.add(currentUserArgumentResolver);
    }
}
</code></pre>
<h2 data-id="heading-8">方案示例</h2>
<h4 data-id="heading-9">Filter 层面</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JwtService jwtService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request,
                                   HttpServletResponse response,
                                   FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {

        <span class="hljs-type">String</span> <span class="hljs-variable">authorizationHeader</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"Authorization"</span>);

        <span class="hljs-keyword">if</span> (authorizationHeader != <span class="hljs-literal">null</span> &amp;&amp; authorizationHeader.startsWith(<span class="hljs-string">"Bearer "</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> authorizationHeader.substring(<span class="hljs-number">7</span>);
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> jwtService.extractUserId(token);
                <span class="hljs-comment">// 标准：使用 request.setAttribute 设置</span>
                request.setAttribute(<span class="hljs-string">"currentUserId"</span>, userId);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-comment">// token 无效，继续执行后续逻辑</span>
            }
        }

        filterChain.doFilter(request, response);
    }
}
</code></pre>
<h4 data-id="heading-10">Controller 层面</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;

    <span class="hljs-meta">@GetMapping("/me")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">getCurrentUser</span><span class="hljs-params">(<span class="hljs-meta">@CurrentUser</span> Long userId)</span> {
        <span class="hljs-comment">// userId 被"魔法般"地自动注入了！</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findById(userId);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(user);
    }

    <span class="hljs-meta">@PutMapping("/me")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">updateCurrentUser</span><span class="hljs-params">(<span class="hljs-meta">@CurrentUser</span> Long userId,
                                                 <span class="hljs-meta">@RequestBody</span> UserUpdateRequest request)</span> {
        <span class="hljs-comment">// 每个 Controller 方法都可以直接使用 @CurrentUser</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">updatedUser</span> <span class="hljs-operator">=</span> userService.updateUser(userId, request);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(updatedUser);
    }

    <span class="hljs-meta">@GetMapping("/permissions")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;Permission&gt;&gt; <span class="hljs-title function_">getUserPermissions</span><span class="hljs-params">(<span class="hljs-meta">@CurrentUser</span> Long userId)</span> {
        <span class="hljs-comment">// 完全类型安全，无需手动类型转换</span>
        List&lt;Permission&gt; permissions = userService.getUserPermissions(userId);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(permissions);
    }
}
</code></pre>
<h2 data-id="heading-11">原理解析</h2>
<h4 data-id="heading-12">HandlerMethodArgumentResolver 工作流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[HTTP请求] --&gt; B[Filter链]
    B --&gt; C[DispatcherServlet]
    C --&gt; D[HandlerMapping]
    D --&gt; E[HandlerAdapter]
    E --&gt; F[HandlerMethodArgumentResolver]
    F --&gt; G{supportsParameter?}
    G --&gt;|Yes| H[resolveArgument]
    G --&gt;|No| I[使用默认解析器]
    H --&gt; J[参数注入]
    I --&gt; J
    J --&gt; K[Controller方法执行]
</code></pre>
<p>在这个流程中，Spring MVC 会按照注册的顺序遍历所有的 HandlerMethodArgumentResolver，对于每个需要解析的参数，都会调用 <code>supportsParameter()</code> 方法判断是否支持，如果支持则调用 <code>resolveArgument()</code> 方法进行实际的参数解析。</p>
<h4 data-id="heading-13">方案优势</h4>
<p>这个方案的优势不仅体现在代码层面，更重要的是它符合软件工程的多个重要原则：</p>
<p><strong>1. 类型安全</strong>：编译时检查，避免运行时类型转换错误。当你错误地将 <code>@CurrentUser Long</code> 写成 <code>@CurrentUser String</code> 时，编译器会立刻提醒你。</p>
<p><strong>2. 代码简洁</strong>：Controller 方法专注于业务逻辑。不再需要每次都写 <code>request.getAttribute()</code> 的样板代码，让业务逻辑更加清晰。</p>
<p><strong>3. 可测试性</strong>：Mock 变得简单直接。在单元测试中，你只需要模拟参数值，而不需要构建整个 HttpServletRequest 对象。</p>
<p><strong>4. 可维护性</strong>：统一的用户信息获取方式。当需要修改用户信息的获取逻辑时，只需要修改 Resolver，而不需要修改每个 Controller 方法。</p>
<p><strong>5. 扩展性</strong>：轻松支持更多用户相关属性。通过修改 Resolver 的逻辑，可以支持返回 User 对象、用户权限、用户偏好设置等复杂信息。</p>
<p><strong>6. 关注点分离</strong>：Filter 专注于认证逻辑，Resolver 专注于参数解析，Controller 专注于业务逻辑，各司其职，代码结构更加清晰。</p>
<h2 data-id="heading-14">进阶用法：传递完整用户对象</h2>
<p>在真实的项目中，我们往往需要的不仅仅是用户 ID，而是完整的用户信息、权限数据、或者用户偏好设置。HandlerMethodArgumentResolver 的强大之处就在于它可以智能地根据参数类型返回不同的对象。</p>
<h4 data-id="heading-15">扩展解析器支持复杂对象</h4>
<p>这里的核心思想是<strong>根据 Controller 方法的参数类型动态决定返回什么对象</strong>，这样可以最大程度地提高代码的灵活性和复用性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurrentUserArgumentResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerMethodArgumentResolver</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supportsParameter</span><span class="hljs-params">(MethodParameter parameter)</span> {
        <span class="hljs-keyword">return</span> parameter.hasParameterAnnotation(CurrentUser.class);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">resolveArgument</span><span class="hljs-params">(MethodParameter parameter,
                                 ModelAndViewContainer mavContainer,
                                 NativeWebRequest webRequest,
                                 WebDataBinderFactory binderFactory)</span> <span class="hljs-keyword">throws</span> Exception {

        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> (Long) webRequest.getAttribute(<span class="hljs-string">"currentUserId"</span>, WebRequest.SCOPE_REQUEST);

        <span class="hljs-keyword">if</span> (userId == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 或者抛出异常</span>
        }

        <span class="hljs-comment">// 根据参数类型决定返回什么</span>
        Class&lt;?&gt; parameterType = parameter.getParameterType();

        <span class="hljs-keyword">if</span> (parameterType == Long.class || parameterType == <span class="hljs-type">long</span>.class) {
            <span class="hljs-keyword">return</span> userId;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parameterType == User.class) {
            <span class="hljs-keyword">return</span> userService.findById(userId);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parameterType == UserProfile.class) {
            <span class="hljs-keyword">return</span> userService.getUserProfile(userId);
        }

        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Unsupported parameter type: "</span> + parameterType);
    }
}
</code></pre>
<h4 data-id="heading-16">Controller 中的多种用法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvancedUserController</span> {

    <span class="hljs-meta">@GetMapping("/user/id")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;String&gt; <span class="hljs-title function_">getUserId</span><span class="hljs-params">(<span class="hljs-meta">@CurrentUser</span> Long userId)</span> {
        <span class="hljs-keyword">return</span> ResponseEntity.ok(<span class="hljs-string">"User ID: "</span> + userId);
    }

    <span class="hljs-meta">@GetMapping("/user/info")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">getUserInfo</span><span class="hljs-params">(<span class="hljs-meta">@CurrentUser</span> User user)</span> {
        <span class="hljs-keyword">return</span> ResponseEntity.ok(user);
    }

    <span class="hljs-meta">@GetMapping("/user/profile")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;UserProfile&gt; <span class="hljs-title function_">getUserProfile</span><span class="hljs-params">(<span class="hljs-meta">@CurrentUser</span> UserProfile profile)</span> {
        <span class="hljs-keyword">return</span> ResponseEntity.ok(profile);
    }
}
</code></pre>
<h2 data-id="heading-17">实战技巧与注意事项</h2>
<p>在实际项目中使用 HandlerMethodArgumentResolver 时，还需要考虑一些实际的工程问题。下面是一些常见的场景和解决方案。</p>
<h4 data-id="heading-18">1. 异常处理</h4>
<p>在用户未登录或者 Token 无效的情况下，我们需要优雅地处理异常情况，而不是让系统抛出难以理解的错误信息。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurrentUserArgumentResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerMethodArgumentResolver</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">resolveArgument</span><span class="hljs-params">(...)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> (Long) webRequest.getAttribute(<span class="hljs-string">"currentUserId"</span>, WebRequest.SCOPE_REQUEST);

        <span class="hljs-keyword">if</span> (userId == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">"用户未登录"</span>);
        }

        <span class="hljs-keyword">return</span> userId;
    }
}

<span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {

    <span class="hljs-meta">@ExceptionHandler(UnauthorizedException.class)</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;String&gt; <span class="hljs-title function_">handleUnauthorized</span><span class="hljs-params">(UnauthorizedException e)</span> {
        <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">401</span>).body(e.getMessage());
    }
}
</code></pre>
<h4 data-id="heading-19">2. 与 Spring Security 集成</h4>
<p>在许多企业级应用中，我们使用 Spring Security 进行认证和授权。如何将 Spring Security 的用户信息与我们的自定义 Resolver 结合使用是一个常见问题。</p>
<p>Spring Security 提供了 <code>SecurityContextHolder</code> 来存储当前用户的认证信息，我们可以直接从中获取用户详情，然后转换成我们需要的格式。这种集成方式的优势是可以复用 Spring Security 的完整认证体系，包括各种认证方式（JWT、OAuth2、Session 等）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurrentUserArgumentResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerMethodArgumentResolver</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">resolveArgument</span><span class="hljs-params">(...)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> SecurityContextHolder.getContext().getAuthentication();

        <span class="hljs-keyword">if</span> (authentication != <span class="hljs-literal">null</span> &amp;&amp; authentication.isAuthenticated()) {
            <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> (UserDetails) authentication.getPrincipal();
            <span class="hljs-keyword">return</span> Long.parseLong(userDetails.getUsername()); <span class="hljs-comment">// 假设username存储的是userId</span>
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h4 data-id="heading-20">3. 多租户场景</h4>
<p>在 SaaS 应用中，多租户是一个常见的需求。除了当前用户信息，我们还需要知道当前租户的信息。通过创建多个自定义注解和对应的 Resolver，我们可以轻松实现这种需求。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.PARAMETER)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> CurrentTenant {
}

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurrentTenantArgumentResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerMethodArgumentResolver</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supportsParameter</span><span class="hljs-params">(MethodParameter parameter)</span> {
        <span class="hljs-keyword">return</span> parameter.hasParameterAnnotation(CurrentTenant.class);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">resolveArgument</span><span class="hljs-params">(...)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">return</span> webRequest.getAttribute(<span class="hljs-string">"currentTenantId"</span>, WebRequest.SCOPE_REQUEST);
    }
}

<span class="hljs-meta">@GetMapping("/tenant/data")</span>
<span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;Data&gt;&gt; <span class="hljs-title function_">getTenantData</span><span class="hljs-params">(<span class="hljs-meta">@CurrentUser</span> Long userId,
                                               <span class="hljs-meta">@CurrentTenant</span> Long tenantId)</span> {
    <span class="hljs-comment">// 同时获取当前用户和租户信息</span>
    List&lt;Data&gt; data = dataService.findByUserAndTenant(userId, tenantId);
    <span class="hljs-keyword">return</span> ResponseEntity.ok(data);
}
</code></pre>
<h2 data-id="heading-21">总结</h2>
<p>通过 Spring MVC 的 HandlerMethodArgumentResolver我们实现了一个可以"跨 Filter 与 Controller 传参"的技术实现方案。将底层 Servlet API 的 request.getAttribute() 操作抽象为编译时类型安全的方法参数注入，实现了框架层面的参数解析适配，既保持了架构的纯净性，又提供了强大的扩展能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[软件测试 | 测试开发 | 专项测试技术初识Hook]]></title>    <link>https://juejin.cn/post/7137925953270841351</link>    <guid>https://juejin.cn/post/7137925953270841351</guid>    <pubDate>2022-08-31T06:38:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7137925953270841351" data-draft-id="7137925302356803597" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="软件测试 | 测试开发 | 专项测试技术初识Hook"/> <meta itemprop="keywords" content="测试"/> <meta itemprop="datePublished" content="2022-08-31T06:38:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="霍格沃兹_测试"/> <meta itemprop="url" content="https://juejin.cn/user/1983934618934887"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            软件测试 | 测试开发 | 专项测试技术初识Hook
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1983934618934887/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    霍格沃兹_测试
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2022-08-31T06:38:27.000Z" title="Wed Aug 31 2022 06:38:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2022-08-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    42
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文节选自霍格沃兹测试学院内部教材Hook 技术需要预先分析目标应用的源代码和逻辑，根据目标测试场景设置目标、逻辑和数据，然后运行时动态的对目标函数参数值、逻辑或者返回值做修改，达到修改现有函数逻辑、实现目标测试场景的目的。Hook的价值在测试中，虽然通过修改数据以实现测试场景的需求，大部分情况下都可以通过 Mock 技术实现，但是还有一小部分场景，例如需要修改应用内部函数的参数、返回值或运行逻辑等情况，这时就需要用到 Hook 技术。单元测试之外，Mock 技术的主要作用是对服务、接口进行 Mock，通过代理等方式将被测服务发送到依赖服务的请求转发给 Mock 服务，再由 Mock 服务根据规则组装预期的返回数据响应给被测服务，达到预期的测试场景。Hook 技术主要用于服务内部代码逻辑上的修改，当函数间传递的参数或者函数内的逻辑需要进行修改时，数据的传递并没有经过网络，Mock 服务无法对其进行操作，只能通过 Hook 技术通过在运行的代码中插入额外的代码或者在内存中进行操作。这种更精细更底层的修改，相比 Mock 技术能实现更多的修改范围，适用性更广，难度也更大。​</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/040ff9dd86f34fd6b9b5055d18802a9a~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<p>JVM Sandbox简介</p>
<p>JVM-Sandbox 是 alibaba 开源的一个 JVM 沙箱容器，只能处理目标为 Java 应用的场景，主要的特点是支持热插拔（可以在目标应用运行中随时进行 Hook 的加载和解除）、可以同时操作挂载多个目标应用，相互之间独立设置互不干扰、支持的目标应用 JDK 版本较广（6-11）。工具本身功能很多，在这里仅介绍和使用它用作 Hook 的部分功能。</p>
<p>JVM Sandbox安装与启动</p>
<p>下载</p>
<p>项目的 github 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fjvm-sandbox%25E3%2580%2582" target="_blank" title="https://github.com/alibaba/jvm-sandbox%E3%80%82" ref="nofollow noopener noreferrer">github.com/alibaba/jvm…</a></p>
<p>下载所需版本的二进制压缩包，解压（演示所使用的版本为 1.3.3）。</p>
<p>环境准备</p>
<p>官方声明支持的系统有：Linux／UNIX／MacOS，这几个系统只需要下载解压缩就可以直接运行。</p>
<p>官方并未支持 Windows 系统，所以需要进行如下修改：</p>
<p>安装 Git Bash。</p>
<p>安装 JDK（版本 6-11，演示所用版本为 1.8.0_192），路径中不能带有空格。</p>
<p>在 Shell 脚本中会有 Java 命令的调用，所以电脑中需要，并且因为 Git Bash 运行 Shell 脚本时的目录问题。</p>
<p>修改启动脚本bin/sandbox.sh ，将脚本中 183-188 行内容注释。​</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a498c5fef5cd4959b8826dfd432fb4ea~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<p>启动脚本</p>
<p>由于启动脚本中使用了相对路径，所以运行时需要切换到项目的 bin 目录下操作。</p>
<p>在 bin 目录中执行语句./sandbox.sh -p 目标应用pid ，当出现如下提示信息，说明 JVM-Sandbox 已经成功启动了。</p>
<pre><code class="hljs language-yaml" lang="yaml">                <span class="hljs-string">$</span> <span class="hljs-string">./sandbox.sh</span> <span class="hljs-string">-p</span> <span class="hljs-number">6204</span>
                <span class="hljs-attr">NAMESPACE :</span> <span class="hljs-string">default</span>

                  <span class="hljs-attr">VERSION :</span> <span class="hljs-number">1.3</span><span class="hljs-number">.3</span>

                     <span class="hljs-attr">MODE :</span> <span class="hljs-string">ATTACH</span>

              <span class="hljs-attr">SERVER_ADDR :</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>

              <span class="hljs-attr">SERVER_PORT :</span> <span class="hljs-number">4543</span>

           <span class="hljs-attr">UNSAFE_SUPPORT :</span> <span class="hljs-string">ENABLE</span>

             <span class="hljs-attr">SANDBOX_HOME :</span> <span class="hljs-string">e:/Download/sandbox/bin/..</span>

        <span class="hljs-attr">SYSTEM_MODULE_LIB :</span> <span class="hljs-string">e:/Download/sandbox/bin/..\module</span>

          <span class="hljs-attr">USER_MODULE_LIB :</span> <span class="hljs-string">E:\Download\sandbox\sandbox-module;~/.sandbox-module;</span>

      <span class="hljs-attr">SYSTEM_PROVIDER_LIB :</span> <span class="hljs-string">e:/Download/sandbox/bin/..\provider</span>

       <span class="hljs-attr">EVENT_POOL_SUPPORT :</span> <span class="hljs-string">DISABLE</span>
</code></pre>
<p>JVM-Sandbox 同时还会对外提供接口，可以通过请求直接操作 JVM-Sandbox，这样就能方便的与自己的测试代码结合使用。</p>
<p>JVM Sandbox示例</p>
<p>目标应用为一段简单的 Java 代码，代码中启动了一个死循环，每次循环会打印report 方法接收到的参数值，参数值已经在代码中固定传入，所以运行之后的结果是一串相同的输出内容。具体内容如下：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HookTarget</span> {
<span class="hljs-function">final <span class="hljs-keyword">void</span> <span class="hljs-title">report</span>(<span class="hljs-params">String stringParam, boolean boolParam, <span class="hljs-built_in">int</span> intParam</span>)</span> {

    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"stringParam is "</span> + stringParam);

    <span class="hljs-keyword">if</span> (boolParam) {

        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"boolParam is true!"</span>);

    } <span class="hljs-keyword">else</span> {

        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"boolParam is false"</span>);

    }

    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"intParam is "</span> + intParam);

}

<span class="hljs-function">final <span class="hljs-keyword">void</span> <span class="hljs-title">loopReport</span>() throws InterruptedException</span> {

    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {

        report(<span class="hljs-string">"a"</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">666</span>);

        Thread.sleep(<span class="hljs-number">1000</span>);

        System.<span class="hljs-keyword">out</span>.println();

    }

}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String... args</span>) throws InterruptedException</span> {

    <span class="hljs-keyword">new</span> HookTarget().loopReport();

}
}
</code></pre>
<p>要编写符合 JVM-Sandbox 的 hook 脚本，需要引入sandbox-api 和 sandbox-debug-module 两个依赖。</p>
<p>通过实现 jvm.sandbox 中的 Module 接口，在 AdviceListener 方法中重写 before 方法，这样写入的语句就会在目标方法体执行之前进行执行，能够修改目标方法收到的参数数据。通过advice.changeParameter 方法，修改对应位置的参数数值，第一个参数为目标参数的位置，从 0 开始，第二个参数为替换的值。具体代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.jvm.sandbox.api.Information;
<span class="hljs-keyword">import</span> com.alibaba.jvm.sandbox.api.Module;
<span class="hljs-keyword">import</span> com.alibaba.jvm.sandbox.api.annotation.Command;
<span class="hljs-keyword">import</span> com.alibaba.jvm.sandbox.api.listener.ext.Advice;
<span class="hljs-keyword">import</span> com.alibaba.jvm.sandbox.api.listener.ext.AdviceListener;
<span class="hljs-keyword">import</span> com.alibaba.jvm.sandbox.api.listener.ext.EventWatchBuilder;
<span class="hljs-keyword">import</span> com.alibaba.jvm.sandbox.api.resource.ModuleEventWatcher;
<span class="hljs-keyword">import</span> org.kohsuke.MetaInfServices;
<span class="hljs-keyword">import</span> javax.annotation.Resource;
<span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-meta">@MetaInfServices(Module.class)</span>
<span class="hljs-meta">@Information(id = "ceshiren.com", author = "ceshiren.com")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">hook_jvm</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Module</span> {

    <span class="hljs-meta">@Resource</span>

    <span class="hljs-keyword">private</span> ModuleEventWatcher moduleEventWatcher;

    <span class="hljs-meta">@Command("ceshiren")</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ceshiren</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Map&lt;String, String&gt; param)</span> {

        <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventWatchBuilder</span>(moduleEventWatcher)

                .onClass(<span class="hljs-string">"HookTarget"</span>)

                .onBehavior(<span class="hljs-string">"report"</span>)

                .onWatch(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AdviceListener</span>() {

                    <span class="hljs-meta">@Override</span>

                    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">(Advice advice)</span> <span class="hljs-keyword">throws</span> Throwable {

                        advice.changeParameter(<span class="hljs-number">0</span>, <span class="hljs-string">"Change By Hook!"</span>);

                        advice.changeParameter(<span class="hljs-number">1</span>, <span class="hljs-literal">false</span>);

                        advice.changeParameter(<span class="hljs-number">2</span>, <span class="hljs-number">965</span>);

                    }

                });

    }

}
</code></pre>
<p>}项目通过 maven 管理依赖，对应的pom.xml 文件内容如下：</p>
<pre><code class="hljs language-xml" lang="xml">    <span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>

     <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ceshiren_book<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.jvm.sandbox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sandbox-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.jvm.sandbox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sandbox-debug-module<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>

                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>

                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>

                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>attached<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>

                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>

                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>

                    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>

                        <span class="hljs-tag">&lt;<span class="hljs-name">descriptorRefs</span>&gt;</span>

                            <span class="hljs-tag">&lt;<span class="hljs-name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">descriptorRef</span>&gt;</span>

                        <span class="hljs-tag">&lt;/<span class="hljs-name">descriptorRefs</span>&gt;</span>

                    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>

                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>

            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>

        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<p>脚本编写完毕之后，将项目打成 Jar 包，放到下载的 JVM-Sandbox 项目下 sandbox-module 目录中。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d4a9414d8a4f4c32894834ac76bf588f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<p>启动写好的 java 目标程序，运行之后命令行开始循环打印之前设置好的语句，内容如下：</p>
<pre><code class="hljs language-csharp" lang="csharp">stringParam <span class="hljs-keyword">is</span> a

boolParam <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span>

intParam <span class="hljs-keyword">is</span> <span class="hljs-number">666</span>

stringParam <span class="hljs-keyword">is</span> a

boolParam <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span>

intParam <span class="hljs-keyword">is</span> <span class="hljs-number">666</span>
</code></pre>
<p>在 gitbash 命令行中打开sandbox/bin 目录，执行语句./sandbox.sh -p 目标应用进程号 -d 'ceshiren.com/ceshiren' ，启动 JVM-Sandbox 并对目标程序进行 Hook 操作，变更report 方法中传入的参数值，这时再回到目标程序运行的命令行中查看，可以看到命令行中输出的内容已经变更，如下</p>
<p>输出内容的变更，说明 Hook 已经生效。这样在目标程序运行中修改了方法传入的参数值，达到了 Hook 的目的。现在执行语句./sandbox.sh -p 目标应用进程号 -S 可以关闭修改，命令行中输出的内容变回了原始的输出内容。示例简单展示了 JVM-Sandbox 用作 Hook 工具的功能，通过 Hook 功能就可以对 Java 项目的内部运行逻辑和参数、返回值进行修改。测试场景的构建、测试用例的执行都变得更加方便</p>
<pre><code class="hljs language-vbnet" lang="vbnet">stringParam <span class="hljs-built_in">is</span> Change <span class="hljs-keyword">By</span> Hook!

boolParam <span class="hljs-built_in">is</span> <span class="hljs-literal">false</span>

intParam <span class="hljs-built_in">is</span> <span class="hljs-number">965</span>

stringParam <span class="hljs-built_in">is</span> Change <span class="hljs-keyword">By</span> Hook!

boolParam <span class="hljs-built_in">is</span> <span class="hljs-literal">false</span>

intParam <span class="hljs-built_in">is</span> <span class="hljs-number">965</span>
</code></pre>
<ul>
<li>输出内容的变更，说明 Hook 已经生效。这样在目标程序运行中修改了方法传入的参数值，达到了 Hook 的目的。</li>
<li>现在执行语句./sandbox.sh -p 目标应用进程号 -S 可以关闭修改，命令行中输出的内容变回了原始的输出内容。</li>
</ul>
<p>示例简单展示了 JVM-Sandbox 用作 Hook 工具的功能，通过 Hook 功能就可以对 Java 项目的内部运行逻辑和参数、返回值进行修改。测试场景的构建、测试用例的执行都变得更加方便</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fqrcode.ceba.ceshiren.com%2Flink%3Fname%3Darticle%26project_id%3Dqrcode%26from%3Djuejin%26timestamp%3D1661940023%26author%3Dxueqi" target="_blank" title="https://qrcode.ceba.ceshiren.com/link?name=article&amp;project_id=qrcode&amp;from=juejin&amp;timestamp=1661940023&amp;author=xueqi" ref="nofollow noopener noreferrer">更多资料</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor在回收团队的实践]]></title>    <link>https://juejin.cn/post/7570500819888439339</link>    <guid>https://juejin.cn/post/7570500819888439339</guid>    <pubDate>2025-11-10T03:52:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570500819888439339" data-draft-id="7569977160276852779" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor在回收团队的实践"/> <meta itemprop="keywords" content="Cursor"/> <meta itemprop="datePublished" content="2025-11-10T03:52:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor在回收团队的实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:52:37.000Z" title="Mon Nov 10 2025 03:52:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>最近一段时间，回收团队一直坚持用Cursor来辅助开发，并在AI开发模式上进行了多次迭代。今天，我想和大家分享一些我们在AI编程方面的实践心得。</p>
<p>首先要明确的是，AI编程并不能取代程序员的独立编码能力，也不是说简单配置几个MCP就能让AI的编程能力发生质的飞跃。今天我将重点从实际应用出发，分享一些AI编程的思路与流程优化经验，帮助各位真正的在项目开发中，把AI用起来。</p>
<h2 data-id="heading-1">我们到底能用Cursor干什么</h2>
<p>我一直在思考，作为一个月使用成本超过100块的“权威”工具来说，如果只让他做一些bean的生成，mapper的生成，未免太过于浪费。但是如果直接把需求文档喂给他，生成的代码距离我们的期望又太大。我们总说，想让AI生成符合要求的代码，需要详细的将我们的需求写成提示词告诉AI，但是到底如何才算详细呢？如何才能写出这份详细的提示词呢？</p>
<p>下面是我使用Cursor进行项目开发的三步走：</p>
<ol>
<li>由Cursor帮助开发者拆分项目——初步完成提示词框架</li>
<li>由开发者帮助Cursor理解项目——丰富提示词内容</li>
<li>完成开发后由Cursor帮助开发者进行回归验证</li>
</ol>
<br/>
<h3 data-id="heading-2">一、让cursor帮助你更好的拆分项目</h3>
<p>既然直接生成代码难度太大，我们能不能先尝试让AI做一些更简单的事情，比如分析一下需求文档。</p>
<p>一般来讲，对于一个项目的分析主要分两步：</p>
<ol>
<li>对于项目新流程的分析</li>
<li>对于相关现状的分析</li>
</ol>
<p>上述步骤步完成后我们期望Cursor能够基于需求PRD文档，帮我们总结一份兼容当下系统逻辑的初步的功能分析文档（不需要功能的具体实现方案，只需要确定有哪些功能即可），包括一些实体类、VO对象的定义，接口定义，数据库表定义等等。</p>
<h4 data-id="heading-3">1、针对新流程（PRD文档）的分析</h4>
<p>Cursor可以很好的分析并总结PRD文档的内容，但产品给出的PRD文档中不可避免的会对一些“众所周知”的上下文进行省略，Cursor也因此无法得知项目的全貌，单纯把PRD文档喂给Cursor并不能让他直接生成符合我们期望的代码。</p>
<p>但这不代表我们在这一阶段完全无法让Cursor为我们创造价值。我们可以利用Cursor的分析总结能力，梳理PRD文档中的功能点与要点，加速自己理解项目，并结合自己对prd的理解进行双向验证。避免后期开发时出现与产品理解不符或者遗漏功能点。</p>
<p>使用Cursor读取并分析本次需求PRD文档的内容时，为了不被上下文长度所限制，我们需要让Cursor将他的思考结果进行记录。例如下面的提示词：</p>
<pre><code class="hljs language-ini" lang="ini">https://dashen.zhuanspirit.com/pages/viewpage.action?<span class="hljs-attr">pageId</span>=xxxxxxxx 
提取一下上面链接的文档中的内容。帮我提炼【XXXXX账单】部分相关功能，有哪些需要开发的功能点，注意，我们本次仅需要查询XXXX列表以及查询XXXX流水详情，其余相关功能和组件已经实现完成。
分析你需要拆分出多少个功能点以及接口

在我让你写代码之前不要生成代码，先逐步分析需求，再说明你打算怎么做
将你的思考以md的形式保存在.docs/技术设计.md下
</code></pre>
<blockquote>
<p>也许你的在线PRD文档需要登陆才可查看，这里给出两个解决方案：</p>
<ol>
<li>找到你的本地cookie，让Cursor带着cookie对你的在线文档进行访问</li>
<li>使用mcp，具体方法这里不进行展开</li>
</ol>
</blockquote>
<p>然后，反复与AI进行沟通，明确告诉他我们需要什么，不需要什么，例如下面的提示词。</p>
<pre><code class="hljs">我们不做数据同步与保存相关的工作，从设计方案中剔除，所有的数据已经准备就绪，我们只需要查询就可以了
帮我设计这个接口的查询的参数与返回值
</code></pre>
<br/>
<p>下面是基于Cursor进行PRD文档分析的基本流程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/153b7c74e3f042a487efe480cc838e0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351557&amp;x-signature=%2BV%2Feyj2gMMJXYNrs%2BPxo%2BkdpoJQ%3D" alt="Cursor辅助确认PRD文档功能点的过程" loading="lazy"/></p>
<p>首先明确一点：不要试图让Cursor来教我们如何做项目，而是让它协助完成每个环节。所以如果觉得自己可以更快更准确的修改文档的某一部分，主动去修改，不要让AI来做。比如，AI帮忙设计了一个实体对象，但是其中部分字段命名不符合我们的业务要求，我们就不要让AI来修改了，直接动手修改md文档。</p>
<p>另外，如果你亲自改动的内容很多，建议下次跟Cursor沟通的时候新开启一个对话框，重新让他读取PRD文档及对应的分析文档，否则Cursor会保留之前生成的记忆，导致你的改动可能不会生效。</p>
<p>下面是此阶段生成的功能分析文档的部分展示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cad7926278946eb98ab687225d1ef9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351557&amp;x-signature=phbq6jfAKDVncGSDsG3orHZC9H4%3D" alt="img" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d701f588f6b74d6aa757431eeafd1267~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351557&amp;x-signature=guqaeK7MweqHyD3xrcqpN%2BN1Whk%3D" alt="Cursor基于PRD文档初步生成的文档" loading="lazy"/></p>
<h4 data-id="heading-4">2、对于目前已有代码的分析，以及影响范围分析</h4>
<p>相比于开发者来说，Cursor会更贴近代码。我们可以在Cursor的协助下更好的完成现有业务流程的梳理。
更具体的讲，我们可以从需求的目标改动点开始，梳理其所属功能和实现方式，包含数据管理、交互流程等等。
这里介绍一下我们常用的Cursor插件：
Mermaid Preview插件，与Markdown Preview Enhanced插件。</p>
<blockquote>
<p>流程图生成插件
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2936d20205f84e8096c5483082f0f7c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351557&amp;x-signature=WhNhktifJKbaS%2BXV%2BkEzB8fqYcA%3D" alt="img" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6c1026715a04c2e9af783feef7551fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351557&amp;x-signature=c5jVMHbT5BU7uYDSapg1APaFJpQ%3D" alt="img" loading="lazy"/></p>
</blockquote>
<p>安装完插件并重启cursor后我们便可以通过如下提示词进行流程图生成了。</p>
<pre><code class="hljs language-arduino" lang="arduino">com.xxx.xxx.xxx.xxx.facade.SxxxxxxxxFacade<span class="hljs-meta">#getxxxxxx</span>
针对该方法帮我生成一个.md的业务流程图
</code></pre>
<br/>
<p>对于复杂的系统流程来说，我们可以基于此种方法生成流程图，辅助确定本次改动的代码的影响范围。</p>
<h3 data-id="heading-5">二、帮助Cursor更好的理解项目，并生成代码</h3>
<p>我们总是希望有一个工具来帮助我们挖掘AI的潜力，让他更好的明白我们的系统，了解我们的业务，例如各种知识库，各种Rule｡即使AI的思维能力可以与真人媲美，我们也很难想象让你身边的某一位经验丰富的同事仅依靠产品文档就可以准确的完成项目开发。项目过程中必然会经历多次沟通,多次方案修正，最终多方达成一致，再进入开发阶断。
同样，在正式进行开发前，我们也需要有一份技术文档来指导Cursor进行开发。<strong>不同于前面需求文档的简单分析，这一部分的分析需要对每一个功能有详细的描述</strong>。我们可以基于之前落地md文档继续进行完善。这一阶段的主要目标是为Cursor补充上下文细节并核验Cursor结论的过程。我们需要针对每一个功能点：</p>
<ol>
<li><strong>调整AI的命名方式与代码生成位置</strong>（可以使用Rule进行简化）。</li>
<li><strong>调整AI使用的工具类与服务类。</strong></li>
<li><strong>调整AI的逻辑细节</strong>（例如调整校验规则，判断顺序等）。</li>
<li><strong>调整AI的业务细节</strong>（优先从PRD文档上节选原文，尝试让Cursor理解。如果PRD文档没有写清业务流程，就自己动手描述流程或者干脆直接让Cursor跳过生成并预留方法，方便后面自己动手补充逻辑）。</li>
</ol>
<p>最终我们得到了这样一份详细描述了业务功能的md文档：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6681742d8fa54dbb8528f5c798412597~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351557&amp;x-signature=ud5L%2BwVmxA3ksQenWshch2Is3rQ%3D" alt="img" loading="lazy"/></p>
<p>如此一来，得到的这份文档实际上是我们与Cursor都能理解，并且达成一致的。我们终于得到了那份可以供我们用作“生成提示词”的功能分析文档，基于这份文档后续Cursor生成的代码也都基本可以满足要求。</p>
<p>下图为使用Cursor生成代码的整体逻辑流程：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f17d9f31e86452ab4bb6a83b6e4a9fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351557&amp;x-signature=wIoB931QkHRBWXsDetZcpDQh7lU%3D" alt="img" loading="lazy"/></p>
<p>需要注意的是，我们每次只就一个功能点进行分析，并且一旦你觉得这个功能点已经相对完善，尽快落地成代码，不要留在一起，让AI最后一起生成。
一方面AI在处理过多的内容时会不可避免的产生偏差，另一方面，如果项目过大，我们也容易忘记一些细节，导致花费额外的时间来进行回忆与验证。</p>
<h3 data-id="heading-6">三、Cursor帮助开发者进行回归验证</h3>
<p>除去开发阶段的辅助作用，Cursor另一大作用体现在开发后的辅助质量保证上。通常体现在以下两个方面：</p>
<ol>
<li>改动影响评估</li>
<li>功能验证</li>
</ol>
<p>为了实现上述能力，我们按照三步走的方式来进行</p>
<h4 data-id="heading-7">1、改动范围整理</h4>
<p>使用下面的命令逐个文件分析当前分支改动点并输出到cr.diff 文件中，随后在md文件末尾进行总结：git diff origin/master  &gt; cr.diff</p>
<h4 data-id="heading-8">2、基本代码审查</h4>
<p>我们可以使用下面的提示词引导Cursor进行基本代码审查：</p>
<pre><code class="hljs language-markdown" lang="markdown">扫描diff 文件中的差异代码。reviwe 的规则如下

<span class="hljs-bullet">1.</span> 方法体行数应少于100行, 不包括空行,和注释
<span class="hljs-bullet">2.</span> 枚举定义需要有两个以上属性, code, name, 并且需要有通过code获取枚举项的方法
<span class="hljs-bullet">3.</span> 接口返回false , 前端是否有对false进行处理 
<span class="hljs-bullet">4.</span> throw 了异常的位置, 一定要打log日志 
<span class="hljs-bullet">5.</span> 所有的public 公有方法都要打印入参log.info日志 
<span class="hljs-bullet">6.</span> 所有的public 公有方法, 结束都要打印结束日志 
<span class="hljs-bullet">7.</span> 所有调用rpc的方法, 都要打印日志
<span class="hljs-bullet">8.</span> 所有方法都要有方法级别的注释
<span class="hljs-bullet">9.</span> try catch异常后, 如果在catch 中又抛出了新创建的异常时, 需要将原异常赋值给新异常
<span class="hljs-bullet">10.</span> 不能调用被标记@Deprecated 的属性或方法或类
<span class="hljs-bullet">11.</span> 定义的常量值, 给出清晰的注释说明用途, 避免硬编码
<span class="hljs-bullet">12.</span> 标注了@transactional的方法要明确回滚异常类型, 对于只读操作要标注只读readOnly=true 提高性能
<span class="hljs-bullet">13.</span> 3次以上字符串拼接使用StringBuilder代替字符串拼接
<span class="hljs-bullet">14.</span> 检查是否存在其他破坏兼容性的改动或逻辑上的错误
<span class="hljs-bullet">15.</span> 检查是否存在循环调用导致的逻辑问题
16、新增的页面提交和支付相关流程要考虑幂等处理
17、接口可能被重复调用和mq消息重复接收场景要考虑并发和事务冲突和数据覆盖，要善用分布式锁
18、针对数据库单一字段的修改，尽可能要精确修改，使用整体对象进行修改
19、是否存在重复代码
20、修改逻辑是否设计到计数系统口径的修改
21、数据交互过程中（数据库和外部调用）的空指针判断和处理
22、状态流转过程和涉及资产损失的部分要对前置状态进行校验
23、涉及数据库和外部事务的接口，要保证整体事务的一致性，无法保证的要有补偿机制
24、涉及异步回调的场景，要考虑中间态的处理
25、不允许把配置规则交给运营同学
26、返回的list类型，要给定默认值，不能给null
27、主键必须设置自增或者使用分布式id
28、数据库表是否建立了索引
29、异常场景要打印报警，尽可能优先多打印
遍历所有规则, 一个规则一个规则的去检查增量代码的规范性, 每个规则进行Review时, 使用独立的上下文, 最后归纳所有的Review结果.
输出违反规则的文件位置, 在我说可以修改之前不要修改文件
</code></pre>
<h4 data-id="heading-9">3、功能辅助验证</h4>
<p>在完成代码生成与初步审查后，我们进入功能验证阶段。此时可利用Cursor分析代码变更，自动生成自测用例清单。通过提示词引导Cursor结合业务逻辑、接口输入输出及异常分支，输出覆盖核心路径、边界条件和错误处理的测试场景。</p>
<p>例如：</p>
<pre><code class="hljs">基于当前代码变更，列出需要自测的功能点和边界情况，包括正常流程、异常输入、状态校验等，输出为表格形式，包含用例编号、场景描述、预期结果。
</code></pre>
<p>该过程不仅是测试准备，更是对整体逻辑的再确认。通过Cursor辅助验证，提升自测完整性，减少后期回归成本，确保交付质量。</p>
<h2 data-id="heading-10">小结</h2>
<p>至此，本文分享了回收团队在AI编程实践中的经验，重点介绍了如何高效使用Cursor辅助开发。通过分阶段协作——从需求分析，现状梳理到技术设计，代码生成，再到测试验证。</p>
<p>AI时代，开发者的核心竞争力正从“掌握知识”转向“提出问题”。工具如Cursor并非替代开发人员，而是通过人机协同，提升需求理解、技术设计与代码质量的效率。我们要以专业积累构建清晰上下文，引导AI完成拆解、分析、生成与验证，最终实现高效、高质量的开发闭环。</p>
<blockquote>
<p>关于作者，黄敬乾，侠客汇Java开发工程师。</p>
</blockquote>
<blockquote>
<p>转转研发中心及业界小伙伴们的技术学习交流平台，定期分享一线的实战经验及业界前沿的技术话题。
关注公众号「转转技术」（综合性）、「大转转FE」（专注于FE）、「转转QA」（专注于QA），更多干货实践，欢迎交流分享~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor 一年深度开发实践：前端开发的效率革命]]></title>    <link>https://juejin.cn/post/7570648023111499814</link>    <guid>https://juejin.cn/post/7570648023111499814</guid>    <pubDate>2025-11-10T08:00:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570648023111499814" data-draft-id="7570579125154742282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor 一年深度开发实践：前端开发的效率革命"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-10T08:00:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor 一年深度开发实践：前端开发的效率革命
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T08:00:15.000Z" title="Mon Nov 10 2025 08:00:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 AI Coding 提效这件事上，我想我的经历让我有充分的发言权。今年上半年，作为团队中的 24 届 JDS，我承接了两位离职同事的业务模块。面对密集的大促需求，我不仅扛住了“以一当三”的交付压力，同时保证了线上零事故。这一切，离不开 Cursor 的深度辅助——我的订阅也从去年的 Pro 升至 Pro+，甚至在大促攻坚与黑马程序员大赛期间，不惜投入每月 200 美元升级至 Ultra Plan，只为将开发效率推向极致。</p>
<p>先上干货：</p>
<h2 data-id="heading-0">Cursor 实战 case 展示</h2>
<p>以下展示了过去一年中，我使用 Cursor 开发的部分前端项目。这些页面平均的 AI 生成代码占比超过 60%，<strong>业务场景横跨 B/C 两端，技术栈全面覆盖 Vue、React、通天塔楼层以及 Tailwindcss、Antd 等多种方案</strong>，充分体现了 Cursor 全面的技术能力与显著的效率提升。</p>
<h3 data-id="heading-1">移动端</h3>
<p><strong>京粉app h5</strong>页面，中秋前夕晚上 22 点业务来电话说想要一个中秋推广的活动页，使用豆包生成背景图，使用cursor进行样式设计，0-1开发仅耗费两个半小时，0:30 完成上线：<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6617b777954b41d48ef3162cd5117440~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=0H0Em6oo2Yy8olycYb4CqxEsn%2FM%3D" alt="image.png" loading="lazy"/><br/>
<strong>信息流广告中间页</strong>，UI 提供的初版 Lottie 动画是一个完整页面，无法拆分。由于大促排期紧张，等待 UI 支持较慢。为此，我借助 Cursor 直接解读 Lottie 的 JSON 配置文件，成功将火焰、杀价、折扣等核心动效元素，精准地解析为独立的动画，并通过CSS实现，降低了引入资源体积的同时还优化了动画的效果，加速通过了协同工作的卡点：<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/502ee5bee1cb41799ac9a04df4067c56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=ovHR4K4cwAOKmMba0f5Uf5OYDWg%3D" alt="录屏2025-10-31 16.23.17.gif" loading="lazy"/></p>
<h3 data-id="heading-2">pc端</h3>
<p><strong>东皇钟资损防控平台</strong>，该项目由研发发起，在没有产品原型和UI设计的情况下，借助 Cursor 结合 Shadcn UI，我独立完成了平台 0-1 的交互与界面构建，最终成果获得了后端与测试团队的一致好评：<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc14f89e9953458ea60f167d80caa1a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=vg0hWPXFpLjQHgROGxTCiHnQkv4%3D" alt="image.png" loading="lazy"/><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62c10f0d9ce349049db5b91b907ce6eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=6kdPdSKMd5sdsVjttndFArFxgeg%3D" alt="image.png" loading="lazy"/><br/>
<strong>落地页中心动态分流</strong>，该模块核心代码近万行，表单联动逻辑复杂，整体由 Cursor 生成实现。面对 5 层以上的嵌套数据结构，人工理解其层级关系并控制动态联动不仅难度大，且极易出错。通过引入 Cursor，深入解析数据结构与联动逻辑，显著降低研发的理解成本，提升整体开发效率。<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0d553fe14b249eeb23e6631c53b22bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=wSLmiddquPlqi7kM6VMNAHWLBxI%3D" alt="image.png" loading="lazy"/><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62d743dc370548d2bdae7ed693da8777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=hM8DtSA8OamFyoeDoD%2BO8Nk7g1o%3D" alt="image.png" loading="lazy"/><br/>
<strong>精准链路分析项目</strong>，黑马参赛项目，基于 Cursor 从零启动，单人仅用两天便快速构建出功能完整的精美 Demo。项目完整实现了基于 React Flow 的 <strong>JAVA 调用链路展示与组合</strong>、<strong>AI 流式报告</strong>及<strong>智能Agent对话</strong>等多种高级能力。<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bacd361ad13d40a68de96cc68ec1f260~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=RnFknAOKPq9Alw0%2FDcqcV5z%2Bxxo%3D" alt="image.png" loading="lazy"/><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56e167130df7428d8177983305468e82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=9MfJ7YCjLgQNJpjvwvlLoq%2B6b7A%3D" alt="image.png" loading="lazy"/><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26e41967aa754cd1a748b734969b384b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=BmMXT7p6pOMu7zLZ1sYScJ6fw70%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">工程化</h3>
<p>工程化历来是前端领域的核心挑战，充斥着依赖版本冲突与繁杂的配置逻辑。为验证 Cursor 处理系统级任务的能力，我尝试将完整升级流程交由它主导：从依赖分析、版本管理到工程配置更新，让其直接操控终端、执行 npm 命令。</p>
<p>在 京粉 App H5 项目中，我基于 Cursor 成功完成了从旧版本到 Vue 2.7.16 + Webpack 5 的升级全流程：<a href="https://link.juejin.cn?target=http%3A%2F%2Fsd.jd.com%2Farticle%2F49646%3FshareId%3D299380%26isHideShareButton%3D1" target="_blank" title="http://sd.jd.com/article/49646?shareId=299380&amp;isHideShareButton=1" ref="nofollow noopener noreferrer">《京粉AppH5 升级 Vue 2.7.16 + Webpack 5 记录》</a></p>
<p>cursor 提供的升级方案（部分对话）：<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c27c86370b740358c970e81c0842304~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=gPI9zdWsVzI0NoFeXBYVXQwj82M%3D" alt="image.png" loading="lazy"/></p>
<p>更新依赖版本和配置文件（部分对话）：<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dae2cf714374433885de428c06b191b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=%2FIhE2QEZuEY7ShiKhso8FVkiXs8%3D" alt="image.png" loading="lazy"/></p>
<p>自动执行终端命令与修复报错（部分对话）：<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1aeeb78e7aa47029480e5c43d648c92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=9VrPQBz%2FjGL%2F7EB7ArPqNt4swjA%3D" alt="image.png" loading="lazy"/></p>
<p>此外，我也让 Cursor 实现了京粉 h5 从 Webpack 到 Vite 的迁移路径验证，核心构建流程已全部跑通。目前因部分边界场景报错尚未完全解决，未形成正式文章，但该实践已初步验证 Cursor 在复杂工程链路中具备可行的辅助潜力。</p>
<h2 data-id="heading-4">Cursor 使用经验分享</h2>
<h3 data-id="heading-5">重中之重：模型的选择</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6d75ac76a3f4ac683683b9e97015fc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=UMxuI74EeTe5ZL8WOOMZO3WXtG8%3D" alt="image.png" loading="lazy"/><br/>
模型是 AI 的基座，地基不牢，地动山摇。在此直接上结论：<strong>无脑选择 Claude</strong>。<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00c23d944ac24e788f51ed0807ba2d76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=orJ0cRZPTJc%2BlFHHNpdqAJdVdrw%3D" alt="image.png" loading="lazy"/><br/>
这不仅因为在大模型代码能力评测中 Claude 持续领先（如上图所示），更是笔者自 Sonnet 3.5 版本发布以来，实际体验 Claude 在代码生成、逻辑理解与上下文关联方面的能力，相比同时期的模型，确实一骑绝尘。</p>
<p>需要注意的两点：</p>
<ol>
<li><strong>警惕 Auto 模式：</strong> 若账号用量不足，Cursor 会自动切换至 Auto 模式，此时可能分配到性能较弱的模型，输出质量会显著下降。该模式可用于技术交流，但不建议用于代码生成与编辑。这也是我升级了订阅计划的原因。</li>
<li><strong>关注上下文长度：</strong> Cursor 会实时显示上下文使用情况。若接近限制，可主动选择支持更长上下文的模型，或开启多倍计费的 Max Mode 以扩展处理能力，避免上下文丢失带来的输出质量下降。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9af52be13734df7bc54192020b599f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=Nk4CYoUOU7pEHP%2BKKrLwBH9NhIs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">Talk is cheap. Show me the code.</h3>
<p>相信研发同学对这句话都不陌生。这句话，在此处不妨视作 Cursor 对我们提出的要求。与 Cursor 协作的第一原则是：<strong>能提供代码片段，绝不用文字描述；能用变量名指代的，绝不用中文名</strong>。</p>
<h4 data-id="heading-7">手动添加上下文</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1527ed6674104bafaa1ec8ec8eb65b0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=j4OqMTnnZASa2SBODFZfZ1k%2BTmA%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>选中代码片段，点击“添加到聊天上下文”按钮（快捷键 Ctrl+I）；</li>
<li>若仅提问不希望 Cursor 改动代码，可使用 Ctrl+L；</li>
<li>在目录中右键点击文件或文件夹，将其加入对话；</li>
<li>在输入框中输入 @，手动选择要引用的文件或目录。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb80af9643314e1aaf5790460c50913c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=To8kMJCmaRYUN2CovjA9sO70Vkc%3D" alt="image.png" loading="lazy"/><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cde5197eaf68412e84d05d157bb8fa80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=5HHGk7RlujMv8gG7UWZ2DaktRZE%3D" alt="image.png" loading="lazy"/></p>
<p>尤其在涉及多文件改动时，主动告知 Cursor 相关文件路径，效果远优于依赖其自行检索。</p>
<h4 data-id="heading-8">统一语义表达</h4>
<p>在业务沟通中，请始终使用精准的变量名与 Cursor 交互。例如，在价格相关需求中，应直接使用 <code>purchasePrice</code>、<code>wlPrice</code> 等已有变量名，而非口语化的“到手价”、“京东价”。这能确保 AI 在后续所有交互中对概念理解一致，无需反复推理映射关系。</p>
<p>同样，在描述界面元素与交互逻辑时，精准引用标识符而非依赖自然语言描述，是提升 Cursor 理解准确度的关键。</p>
<ul>
<li><strong>定位界面元素</strong>，应明确指出其 <code>className</code> 或 <code>id</code>，而非使用模糊的自然语言。<br/>
例如：❌ “那个下载按钮” → ✅ “类名为 <code>.download-btn</code> 的按钮” 或 “ID 为 <code>#export-download</code> 的元素”。</li>
<li>描述交互逻辑，应直接提供回调函数名或方法名称，而非笼统描述行为意图。<br/>
例如：❌ “点击按钮后弹窗” → ✅ “在 <code>handleConfirmClick</code> 函数中调用 <code>showModal()</code> 方法”。</li>
</ul>
<p>这种方式能够有效避免界面中存在多个相似元素时造成的歧义，也便于 Cursor 直接在代码库中定位相关逻辑，实现精准编辑。</p>
<h3 data-id="heading-9">如何使用 cursor 定位故障？</h3>
<p>在“AI 能否取代程序员”的持续讨论中，精准定位并修复线上故障一直被视作人类工程师的关键优势。其根本原因在于：AI 虽能较好地解析静态代码结构，却难以感知系统运行时的动态状态。而很多深层问题——如内存泄漏、线程竞争、环境依赖异常等——恰恰隐藏在静态代码与动态执行之间的鸿沟中，这构成了当前 AI 在故障处理中的认知边界。</p>
<p>那么，我们如何为 AI 架起一座跨越这道鸿沟的桥梁？</p>
<p>答案正在于我们人类最熟悉的调试手段：<strong>日志</strong>。既然日志能够成为开发者和运行中系统之间的沟通媒介，那么它同样可以转化为 AI 理解运行时行为的关键信息来源。</p>
<h4 data-id="heading-10">引导 AI 插入关键日志</h4>
<p>当你发现某个功能异常，可指示 Cursor 在关键逻辑路径上添加日志点。只需简单指令，如：“请帮我在xx功能相关的函数内部添加 console.log，输出关键变量的值。”<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3f0e59dc9ee4ea0af188d7f201af461~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=XU8lve9jnDk5nHwGM2qPvZcm4c4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">运行代码并捕获日志</h4>
<p>执行添加日志后的代码，复制运行时所生成的完整日志输出。<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abaaad556241481bababc70f742ced4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=dj%2F0JMCOARWV0aHGxaKrGosmiYg%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-12">将日志与代码共同提交给 AI 分析</h4>
<p>然后再将日志复制发送给cursor，神奇的事发生了，本来它改动了几遍都没能解决的问题，一下就定位到了根因：<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78888e9bc9724128991a2ec28ed27ee5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=w%2BjKXc4VEjAkEEet3cWrdxU9uA8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">技巧背后的逻辑</h4>
<p>此方法之所以有效，是因为它将 AI 从纯粹的代码静态分析者，转变为了一个具备“运行时视野”的调试伙伴。通过日志，AI 能够：</p>
<ul>
<li>追踪变量的实际变化轨迹</li>
<li>识别逻辑分支的真实执行路径</li>
<li>发现数据流与预期不符的具体位置</li>
</ul>
<h3 data-id="heading-14">添加 Rules：让 AI 记住你的工程规范</h3>
<p>在使用日志与 Cursor 协作调试时，我遇到了一个典型问题：项目中已有大量日志，新增的调试信息很快被淹没，难以快速定位。我希望 Cursor 在每次插入调试日志时，自动在开头附加 【xx功能调试】 这样的标识，以便在控制台中快速筛选。但若每次对话都重复这一要求，既低效又容易遗漏。</p>
<p>这时，Cursor 的 Rules 功能便可发挥关键作用。你可以在规则中固话这类常见的工程约束或团队规范，例如：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb87a25660914fd3966a081425da5dd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=X%2FCHVWAsr29VGzAUQuIe9J1d1zs%3D" alt="image.png" loading="lazy"/></p>
<p>Cursor 支持为不同项目配置独立的规则集，灵活适配各工程的特定规范。具体设置方法详见官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.cursor.com%2Fzh%2Fcontext%2Frules" target="_blank" title="https://docs.cursor.com/zh/context/rules" ref="nofollow noopener noreferrer">Cursor - 规则</a></p>
<p>完成规则配置后，我们重新执行之前的调试对话。如下图所示，现在每个 <code>console.log</code> 语句的开头都已自动加上了对应的函数名作为标识，极大方便了在控制台中的筛选与查看：<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecef71dd93d541b4b85e5b3ef8ca151f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=nfbJBcxolpQFD9EKaLlUJH992M4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-15">集成 MCP：拓展能力边界</h3>
<p>在使用日志辅助 Cursor 进行调试的过程中，我逐渐发现两个影响效率的典型问题：</p>
<ul>
<li><strong>手动复制繁琐</strong>：频繁从控制台复制日志再粘贴至 Cursor，本质上仍是一种重复劳动，与 AI 协作的自动化理念相悖。</li>
<li><strong>日志内容杂乱</strong>：控制台中的引用类型数据（如对象、数组）若不展开或格式不当，难以完整复制；同时，控制台自动插入的代码位置信息（文件路径与行号）常混杂在日志正文中，导致最终提供给 Cursor 的文本结构混乱、难以解析。<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b0c5645e36340e5bffc424f7f2fd5be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=KQZ%2F1wpL6VAlLpX6ngZ%2FSd3ESZA%3D" alt="image.png" loading="lazy"/><br/>
上图正是这一问题的直观体现：日志中穿插了源代码位置，而对象数据未完整展开，这样的信息直接交给 Cursor，会影响其理解与推理的准确性。</li>
</ul>
<p><strong>而此时，正是 MCP（Model Context Protocol）可大显身手的场景。</strong> 通过为 Cursor 配置浏览器 MCP 服务，我实现了工作流的质的飞跃：<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d07d07c1874d40b8a243f67595ae34a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=p%2B3lEiSMz%2B%2B1MuSXvzvkacDqKJY%3D" alt="image.png" loading="lazy"/><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b69a150787204362abf6d59f156ab04f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=%2F5U%2Bi%2FAJ%2BZrRh%2BhLslk%2FQ1bORNk%3D" alt="image.png" loading="lazy"/><br/>
MCP 赋予 Cursor 直接控制浏览器的能力，使其能够：</p>
<ul>
<li><strong>自动捕获页面截图</strong></li>
<li><strong>直接读取控制台日志</strong></li>
<li><strong>分析 DOM 结构</strong><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8ae8b724ff349f0b278037aa78196f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=829ebCf7Xjy5bhiNT3j8CKoy3yE%3D" alt="image.png" loading="lazy"/></li>
</ul>
<p>当前 Cursor 的浏览器 MCP 仅支持内置窗口与 Chrome。若你使用 Edge 或其他浏览器，可选用微软推出的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplaywright.dev%2Fdocs%2Fintro" target="_blank" title="https://playwright.dev/docs/intro" ref="nofollow noopener noreferrer">Playwright</a> 作为替代方案。</p>
<p>同时，主流前端工具已纷纷提供 MCP 或知识库。以 Ant Design 为例，将其官方知识库 <a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design%2Fdocs%2Freact%2Fllms-cn" target="_blank" title="https://ant.design/docs/react/llms-cn" ref="nofollow noopener noreferrer">LLMs.txt - Ant Design</a> ，添加到 Cursor 的指定位置：<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae497460395545fc8787fee79068b9cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=5T9ntUUmCJDrfZf0YH8JzBO%2B9jY%3D" alt="image.png" loading="lazy"/><br/>
添加后，Cursor 即可基于官方最新文档提供准确的组件使用建议。</p>
<h3 data-id="heading-16">优先选用 AI “擅长”的技术栈</h3>
<p>何为 AI “擅长”的技术栈？简单来说：<strong>React、TailwindCSS 属于 AI 表现优异的技术栈；微信小程序次之；而像 Taro、uni-app 这类一码多端的框架，则往往是 AI 的弱项。</strong></p>
<p>其背后的逻辑在于数据可见性：<strong>开源生态越丰富、网络公开样本越多的技术，大模型在训练时接触到的相关代码就越充分，生成质量自然更高</strong>。反之，<strong>闭源、文档稀少的场景，AI 由于缺乏学习材料，表现往往不尽如人意</strong>。</p>
<p>在实际的 Taro 项目中，当我尝试让 AI 协助处理 H5、小程序与 RN 三端的代码适配时，其表现确实令人沮丧。我最常遇到的状况是：好不容易让 AI 修复了 H5 端的样式错位，转头就发现小程序端布局崩溃；当 RN 端的交互问题被解决后，H5 端又出现了新的渲染异常。</p>
<p>因此，在 AI Coding 日益普及的背景下，我们不得不重新审视如 Taro、UniApp 等一码多端框架的效率等式：其带来的跨端便利，是否足以抵消因 AI 支持薄弱而导致的额外研发成本？这一点值得深思。</p>
<p><strong>破局之道或许在于深度拥抱 AI 生态。如果这类框架能官方的推出强大的 MCP 服务，将其多端差异和配置逻辑“结构化”地注入 AI 的认知过程，它们将有潜力从当前的“AI 洼地”转变为“智能跨端”的典范。</strong></p>
<h3 data-id="heading-17">反直觉：0-1不难，1-100 更难？</h3>
<p>读过不少 AI 编程文章的人都会发现，多数内容都在展示如何从 0 到 1 快速搭建应用。但实际上存在一个反直觉的真相：<strong>用 AI 从 0 到 1 并不难，真正难的是让它接手和维护存量代码。</strong></p>
<p>在新项目中，AI 面对的是清晰的上下文和现代技术栈。而在存量代码中，它需要理解混乱的命名、隐含的业务逻辑和特殊的实现方式，同时要避免“修复一个 bug 引入两个新 bug”的连锁反应。这就像让新人从头做项目，远比让他修改复杂的老系统要简单。</p>
<p>要让 AI 有效接手存量代码，关键在于像帮助新人一样为它提供清晰的指引。核心方法有二：</p>
<h4 data-id="heading-18">为 AI 优化的代码注释</h4>
<p>传统的业务背景介绍对 AI 帮助有限，应该采用更代码化的注释方式。避免长篇大论地介绍业务逻辑，而是清晰地指出代码和业务之间的关系，魔法数字的具体含义等。</p>
<p>比如，不要写“这里是价格计算模块，因为历史原因需要区分新老用户”，而应该写“新用户(level=1)享受首单优惠，老用户(level&gt;=2)按原价计算，优惠金额固定为20”。重点注释魔法数字的实际含义、复杂条件判断的业务背景、接口字段的映射关系等。</p>
<h4 data-id="heading-19">TypeScript 的天然优势</h4>
<p>在接手现有项目上，TypeScript 有着得天独厚的优势。类型定义相当于强制展示了一遍代码结构，如果再加上每个变量的注释，就是现成的知识库。</p>
<p>通过“精准注释 + 完整类型”的组合，即使是最复杂的遗留代码，AI 也能快速理解并安全修改，真正突破从 1 到 100 的瓶颈。</p>
<h2 data-id="heading-20">AI Coding时代，优秀研发需要哪些新特质？</h2>
<p>聊了这么多 Cursor 的强大表现，难免让人心生疑问：研发是否正在被 AI 取代？恰恰相反，我认为 AI 正在急剧拉大开发者之间的能力差距。今年几乎人人都用上了 AI 编程工具，可能是 Cursor，也可能是 Joycode。但如果你去 review 团队中的代码，就会发现：<strong>强者的代码因AI而更优秀，弱者的代码因AI而更紊乱</strong>。</p>
<p>结合实践中的经验，我总结了 AI 编码时代一名优秀开发者最应具备的几种核心能力：</p>
<h3 data-id="heading-21">1️⃣有责任心，做代码的owner</h3>
<p>早期使用Cursor时，我常常陷入一种状态：<strong>AI生成的代码占比太高，以至于我对新增部分失去理解和掌控。一旦被问及业务逻辑，或是出现线上问题，甚至会不知从何查起。</strong></p>
<p>这就像一位艺术家通过AI生成画作，很难像对待自己亲笔作品那样珍视并负责。我的改进方案是：<strong>在每次 Agent 完成编码之后，阅读其改动总结；在每次提交前，仔细Review Cursor生成代码的Diff</strong>。这个过程强制我理解每一行变更，重新建立起对代码的掌控感。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c13c3d6fa85247dbbcd68f86c1130145~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=VNKRLKIYXpJJo5dT4T2FsQAcyLE%3D" alt="image.png" loading="lazy"/></p>
<p>如上图，通常 cursor 在修改完成后都会自动生成总结（也可以通过添加 rules 控制），可以结合总结阅读 diff。</p>
<h3 data-id="heading-22">2️⃣代码品味，超越能跑就行</h3>
<p>AI生成的代码能运行、测试通过、上线不出事故，就足够了吗？如果你的技术认知水平在 AI 之下，无法判断其实现是否为最佳实践，就可能在系统中埋下无数隐患。</p>
<p>举个例子，上周在体验 relay 设计稿 AI 转代码的时候遇到过一件事：<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/030b1e0b9829497fb64e83d1cace5222~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=mE7FdFJfIP3KEKuveC8PtJ823Vc%3D" alt="image.png" loading="lazy"/><br/>
AI 将图中的商品列表拆分为多行布局——一行图片、一行商品名、一行价格、一行按钮。然而，具备前端组件化思维的同学一眼就能看出，更合理的做法是将其封装为独立的商品卡片组件进行循环渲染：<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b670905e5964ac5a0783e21091c136b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=duiD%2FTkgEjsxhZOc763fB3cuK%2FQ%3D" alt="image.png" loading="lazy"/><br/>
尽管 AI 的产出在功能上可以运行，测试、产品与用户也难以察觉差异，但这样的结构严重缺乏可复用性。若未来其他页面需要复用相同样式的商品展示，我们将不得不重复编写样式与逻辑，违背了组件化的设计初衷。</p>
<p>因此，我的建议是：<strong>坚持阅读高质量的代码，无论是优秀的开源项目，还是身边同事的成熟实现</strong>。遇到问题时，不必过度沉溺于调试错误实现，而应主动学习并理解最佳实践，勇于对不合理的代码进行果断重构。。</p>
<h3 data-id="heading-23">3️⃣知识广度，做好技术决策</h3>
<p>AI在执行明确、具体的指令时表现更佳。这要求开发者既要有广泛的知识储备，又要能精准描述需求。<strong>研发就像行政总厨，而AI是精通各菜系的厨师——总厨必须清楚做什么菜的时候，需要备哪些料，使用哪些厨具餐具，才能调度后厨高效产出。</strong></p>
<p>以前端开发为例，若能明确指定使用某个具体的 JavaScript 库，AI 的响应质量将显著提升。例如，在实现“前端解析 Excel 文件”功能时，若直接提示 Cursor 使用 xlsx 库，仅需二三十行代码即可获得目标数据结构：<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c44437336a74f879ba002ca8c953310~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=5D0rxbTfrbgd4PAvGHTTDPaKNQc%3D" alt="image.png" loading="lazy"/><br/>
而若未提供任何技术栈提示，AI 可能倾向于使用原生 JS 实现，代码量激增五倍以上，且逻辑复杂、未经充分验证：<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30a5d98db4d542a29a37c89d38ca9066~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366415&amp;x-signature=cl6W7Pd%2FLeKiPttUNamTtgYqf90%3D" alt="image.png" loading="lazy"/></p>
<p>因此，<strong>持续在技术社区交流，关注经典工具与前沿方案</strong>，是提升技术决策能力的关键。 只有清楚“用什么”和“为什么用”，才能最大限度地发挥 AI 的编码潜力。</p>
<h3 data-id="heading-24">4️⃣表达精度，说 AI 听得懂的话</h3>
<p><strong>一个不善于使用搜索引擎的人，往往也难以通过AI获得理想结果。</strong> 从模糊的需求到清晰的提示词，本质上是一种结构化与抽象能力的体现。</p>
<p>继续用行政总厨的比喻：<strong>如果只说“番茄炒蛋要甜一点”，厨师会困惑——是加糖还是加番茄酱？如果能明确“300克番茄配3个鸡蛋，需要加5克白糖”，产出质量就有保障。</strong></p>
<p>精准表达的能力，与个人知识储备和语言表达能力相关，不好举例说明。建议<strong>有意识地阅读完整书籍、观看有深度的长播客</strong>，避免被短视频时代的碎片化表达削弱这种能力。</p>
<h2 data-id="heading-25">对未来的展望</h2>
<p>笔者作为 Joycode 的早期深度用户，为其界面交互提出过被采纳的优化建议；我也是团队中最早体验并给研发同事安利 Cursor，给产品同事安利使用 v0 生成原型图的人，我很高兴看到如今公司已全面拥抱 AI。</p>
<p>然而，当业产研测各环节都在大力推进“+AI”时，我不禁思考：AI 提效，是否真的等同于在现有流程的每个环节简单叠加 AI？</p>
<p><strong>这让我想起从功能机到智能机的过渡时期：早期的触摸屏设备仍保留着大量实体按键，或者在屏幕底部保留了触摸版的菜单键和返回键，交互逻辑仍是旧时代的延伸。直到多年后，真正的全面屏与手势导航出现，才彻底释放了触摸交互的潜力。</strong></p>
<p><strong>我们当前对 AI 的应用，或许正处在那个“仍带着实体按键”的阶段。</strong> 若只满足于在原有流程上“+AI”，恐怕难以触及其真正的变革性潜力。AI 不应仅是效率工具，更应成为流程重构与体验重塑的催化剂——而这，才是我们接下来需要共同探索的方向。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你行你上！MoonBit LOGO 重构有奖征集令]]></title>    <link>https://juejin.cn/post/7571191453126311962</link>    <guid>https://juejin.cn/post/7571191453126311962</guid>    <pubDate>2025-11-11T10:37:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571191453126311962" data-draft-id="7571295102850023450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你行你上！MoonBit LOGO 重构有奖征集令"/> <meta itemprop="keywords" content="前端,后端,设计"/> <meta itemprop="datePublished" content="2025-11-11T10:37:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MoonBit"/> <meta itemprop="url" content="https://juejin.cn/user/3609050528885565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你行你上！MoonBit LOGO 重构有奖征集令
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3609050528885565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MoonBit
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:37:01.000Z" title="Tue Nov 11 2025 10:37:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在一些社媒平台上有关心 MoonBit 的社区用户对 MoonBit LOGO  进行批评和调侃。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22e576795cbb4e36aa543c12d81f0415~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462221&amp;x-signature=YGXqt%2BAR5IGoVRZZ9K9Yy%2BXrO0A%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6c878a6842e41e781776f73707c71a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462221&amp;x-signature=j75MKe80HvtawpItjAWm%2FCv7cHY%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1267ecd62585438c95f8d70a41442dac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462221&amp;x-signature=Dfz12gHsVHsqyAiS33FJHCAFI8A%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2923933ad9f4a65ac60e9c658de96f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462221&amp;x-signature=Qh40SRrbfh7w7Px%2FC0bZZPj%2B3sw%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc618ee8b85442dc927217fd2aa49cb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462221&amp;x-signature=z2Ybp5I5tVvPNQrJ8ZyLDO0A3NY%3D" alt="" loading="lazy"/>（图源：知乎社区，已打码）</p>
<p>在此我们要说：很感谢大家提出建议，我们决定响应大家的声音，举办本次 MoonBit LOGO 有奖征集令，和社区用户共建 MoonBit 的未来！当然都不白来，我们准备了丰厚的奖品～</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbd8a3f426c34a5bb4e611d54ffbc9d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462221&amp;x-signature=yfQBwOBauwP1aIVT5NSKFo23D5E%3D" alt="image.png" loading="lazy"/></p>
<p>含义诠释：一只充满科技感的带着 VR 眼镜的紫色垂耳兔，兔子耳朵呈现 M 形状，正在月球上用代码构筑未来世界。</p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0c7a9d746404ff5a15a5138566e25c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462221&amp;x-signature=fN0MPV8UFW%2BAUTSup%2BzTiAMS2Ow%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-0">灵感展示</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36c1b54cc5354d46b8ede8688144b632~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462221&amp;x-signature=yTm7ZYrHoOYSCCzCgCSVyGNXO68%3D" alt="" loading="lazy"/></p>
<p>我们的一位同事做了这个兔耳朵形状的设计，希望大家也可以灵感爆棚提出好作品！</p>
<h3 data-id="heading-1">投稿链接</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fbxup9uklfcb.feishu.cn%2Fshare%2Fbase%2Fform%2Fshrcn0GZodPRjHj3A6AcwrJuhpc" target="_blank" title="https://bxup9uklfcb.feishu.cn/share/base/form/shrcn0GZodPRjHj3A6AcwrJuhpc" ref="nofollow noopener noreferrer">bxup9uklfcb.feishu.cn/share/base/…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d3db57fed93477794c7fc045c91b50e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462221&amp;x-signature=9sDQF50FXNyuQXMc%2F5Xsp5P7HS0%3D" alt="" loading="lazy"/>没有限制、没有门槛、没有框架就让创意决定未来。MoonBit 的新 Logo，等你来定！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AGI为何被“判死刑”？李飞飞最新万字长文，指出一个致命缺失]]></title>    <link>https://juejin.cn/post/7571304204754157622</link>    <guid>https://juejin.cn/post/7571304204754157622</guid>    <pubDate>2025-11-11T10:46:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204754157622" data-draft-id="7571258854901022763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AGI为何被“判死刑”？李飞飞最新万字长文，指出一个致命缺失"/> <meta itemprop="keywords" content="人工智能,资讯"/> <meta itemprop="datePublished" content="2025-11-11T10:46:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="算家计算"/> <meta itemprop="url" content="https://juejin.cn/user/1426490793396571"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AGI为何被“判死刑”？李飞飞最新万字长文，指出一个致命缺失
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1426490793396571/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    算家计算
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:46:05.000Z" title="Tue Nov 11 2025 10:46:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>刚刚，李飞飞指出了AI被忽视的关键缺陷——AI仍然是个“黑暗中的文字匠”。</p>
</blockquote>
<p>在科技巨头纷纷宣称即将实现通用人工智能的喧嚣中，李飞飞用万字长文定义了AI未来十年。昨晚，斯坦福大学教授、AI领军人物李飞飞发表了题为《从文字到世界：空间智能是AI的下一个前沿》的长文。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79a748fef1f049bc95776a30dec43f2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg566X5a626K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462847&amp;x-signature=t78LHPpiZ72Uj9GiG0LXwFOBA6Y%3D" alt="图片" loading="lazy"/></p>
<p>李飞飞认为，要让AI实现更长远的目标，即真正实现AGI，空间智能至关重要，这也是该文章的核心观点。</p>
<p>她在文章中明确指出现有大语言模型的根本局限：它们本质上是“黑暗中的文字匠”，能言善辩却无实际经验，知识渊博但缺乏现实根基。这一判断直接挑战了当前仅通过扩展参数和数据就能实现AGI的主流观点。</p>
<p>空间智能，即人类理解、导航并与三维世界交互的底层能力，正是当前AI系统最缺乏的核心要素。</p>
<p>作为人类，我们可以轻松地接住抛来的钥匙、在拥挤人行道穿行而不碰撞，或是半睡半醒间准确将咖啡倒入杯中。然而，就是这些我们习以为常的物理交互，成为了机器难以企及的空间智能。</p>
<p>这种能力的缺失使得AI在与物理世界交互时显得极其笨拙。李飞飞指出，最先进的多模态大语言模型在估算距离、方向、大小等任务上，表现往往不比随机猜测好多少。它们无法进行“心智旋转”物体，不能导航迷宫识别捷径，也难以预测基本的物理规律。</p>
<p><strong>空间智能的双重挑战：数据与算法</strong></p>
<p>实际上，关于空间智能的研究并不算少，但其发展缓慢的背后，是远比文本处理复杂的数据与算法挑战。这也是为什么语言模型发展如此迅速，而世界模型似乎难以实现更大的突破。</p>
<p>这或许也是AGI短期难以实现的核心障碍。</p>
<p>互联网为AI训练提供了海量文本数据，但适合训练空间智能的三维空间数据却极为稀缺。人类通过“感知-行动”循环来学习世界，而当前的AI缺乏这种与环境的持续互动能力。</p>
<p>谷歌DeepMind首席执行官Demis Hassabis曾在一档播客节目中指出，缺乏一致性是AGI至今无法实现的关键因素。这种一致性在空间智能中体现为感知、几何与物理规则的一致性，而当前AI生成的视频往往在几秒钟后就失去连贯性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fccc9a2eb93f46c8b749e7ed7ed4e888~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg566X5a626K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462847&amp;x-signature=l4UpYG9IWvStdkFOiq%2B0W1VT11o%3D" alt="图片" loading="lazy"/></p>
<p>李飞飞提出，实现空间智能需要构建全新的“世界模型”，这种模型必须具备三大核心能力：</p>
<p>1.生成性，能创造遵守物理定律、空间一致的世界；</p>
<p>2.多模态，能处理从图像、视频到动作的多模态输入；</p>
<p>3.交互性，能预测世界随时间演变或互动的状态。</p>
<p><strong>具身智能：从感知到行动的关键路径</strong></p>
<p>作为当下的热门领域，具身智能是否能为空间智能提供突破点？李飞飞的观点暗示了肯定的答案。</p>
<p>她在文章中提到，自主机器人的愿景依然诱人却遥远。这并非技术悲观主义，而是对现实挑战的清醒认知。当前的机器人只能在高度受限的环境中执行简单操作，远未达到在复杂现实场景中自主行动的水平。</p>
<p>真正的突破可能来自于将计算机视觉与机器人学习相结合的研究路径。李飞飞在斯坦福的实验室过去十年一直致力于此。这种结合创建了从感知到行动的闭环，是实现空间智能的关键步骤。</p>
<p>具身智能的意义在于为AI提供了学习物理规则的“身体”。就像婴儿通过玩耍与环境互动来认识世界一样，具身智能体可以通过与环境的互动获得对物理世界的直观理解。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e79a11982244c2dabea6d999998aa77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg566X5a626K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462847&amp;x-signature=avy0UxZoUwJTudU%2BwYee0dNe5ZU%3D" alt="深度 一文带你读懂“具身智能” - 知乎" loading="lazy"/></p>
<p><strong>通往AGI的技术路径：世界模型的三大突破</strong></p>
<p>实现AGI需要在世界模型的技术架构上取得根本性突破。</p>
<p>生成性世界模型需要解决物理一致性问题。当前AI生成的视频虽然令人惊艳，但常常违反物理规律。李飞飞认为，世界模型必须能够生成无穷无尽、多种多样的模拟世界，这些世界在几何、物理和动态上保持一致。</p>
<p>多模态处理需要超越简单的文本-图像对应。理想的世界模型应该能处理各种形式的输入——图像、视频、深度图、文本指令、手势或动作，并预测或生成尽可能完整的世界状态。</p>
<p>交互性是实现真正智能的关键。李飞飞强调，世界模型必须能够根据输入的操作预测世界的演变。这种能力将使AI不再是被动的信息处理器，而是能够主动与环境互动的智能体。</p>
<p><strong>AI下一个十年：从语言到世界</strong></p>
<p>李飞飞的文章描绘了AI发展的范式转变：从追求更大的语言模型转向构建更理解物理世界的智能体。</p>
<p>这一转变的意义不亚于从专家系统到深度学习的转变。它要求我们重新思考AI的发展方向：不再仅仅满足于处理抽象知识，而是要创建能够理解并与物理世界交互的系统。</p>
<p>实现这一目标需要跨学科的努力。正如李飞飞创建的World Labs所展示的，计算机视觉、机器人学、认知科学等领域的深度融合将是关键。</p>
<p>李飞飞的长文或许为我们提供了清醒的认识：AGI不会在短期内实现，因为我们还没有解决最基础的空间智能问题。</p>
<p>但是通过专注于世界模型的构建，通过跨学科的深入合作，我们可能最终会迈向真正智能的系统。</p>
<p>大家怎么看？欢迎交流讨论~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[4.6 Docker Model Runner Chat]]></title>    <link>https://juejin.cn/post/7571191453125787674</link>    <guid>https://juejin.cn/post/7571191453125787674</guid>    <pubDate>2025-11-11T08:53:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571191453125787674" data-draft-id="7571191453125771290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="4.6 Docker Model Runner Chat"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T08:53:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴祖贤"/> <meta itemprop="url" content="https://juejin.cn/user/1961184475492103"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            4.6 Docker Model Runner Chat
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1961184475492103/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴祖贤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:53:01.000Z" title="Tue Nov 11 2025 08:53:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Docker Model Runner Chat</h2>
<blockquote>
<p>Spring AI 参考文档 - Docker Model Runner 聊天模型集成指南</p>
</blockquote>
<h3 data-id="heading-1">概述</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.docker.com%2Fdesktop%2Ffeatures%2Fmodel-runner%2F" target="_blank" title="https://docs.docker.com/desktop/features/model-runner/" ref="nofollow noopener noreferrer">Docker Model Runner</a> 是一个 AI 推理引擎，提供来自<a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.docker.com%2Fu%2Fai" target="_blank" title="https://hub.docker.com/u/ai" ref="nofollow noopener noreferrer">各种提供者</a>的广泛模型。</p>
<p>Spring AI 通过重用现有的 <a href="https://link.juejin.cn?target=openai-chat.html" target="_blank" title="openai-chat.html" ref="nofollow noopener noreferrer">OpenAI</a> 支持的 <code>ChatClient</code> 与 Docker Model Runner 集成。
为此，请将基础 URL 设置为 <code>localhost:12434/engines</code> 并选择提供的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.docker.com%2Fu%2Fai" target="_blank" title="https://hub.docker.com/u/ai" ref="nofollow noopener noreferrer">LLM 模型</a>之一。</p>
<p>查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai%2Fblob%2Fmain%2Fmodels%2Fspring-ai-openai%2Fsrc%2Ftest%2Fjava%2Forg%2Fspringframework%2Fai%2Fopenai%2Fchat%2Fproxy%2FDockerModelRunnerWithOpenAiChatModelIT.java" target="_blank" title="https://github.com/spring-projects/spring-ai/blob/main/models/spring-ai-openai/src/test/java/org/springframework/ai/openai/chat/proxy/DockerModelRunnerWithOpenAiChatModelIT.java" ref="nofollow noopener noreferrer">DockerModelRunnerWithOpenAiChatModelIT.java</a> 测试，
了解如何在 Spring AI 中使用 Docker Model Runner 的示例。</p>
<h3 data-id="heading-2">先决条件</h3>
<ul>
<li>下载 Docker Desktop for Mac 4.40.0。</li>
</ul>
<p>选择以下选项之一来启用 Model Runner：</p>
<p><strong>选项 1：</strong></p>
<ul>
<li>启用 Model Runner <code>docker desktop enable model-runner --tcp 12434</code>。</li>
<li>将 base-url 设置为 <code>localhost:12434/engines</code></li>
</ul>
<p><strong>选项 2：</strong></p>
<ul>
<li>启用 Model Runner <code>docker desktop enable model-runner</code>。</li>
<li>使用 Testcontainers 并按如下方式设置 base-url：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Container</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">DockerModelRunnerContainer</span> <span class="hljs-variable">DMR</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DockerModelRunnerContainer</span>(<span class="hljs-string">"alpine/socat:1.7.4.3-r0"</span>);

<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> OpenAiApi <span class="hljs-title function_">chatCompletionApi</span><span class="hljs-params">()</span> {
	<span class="hljs-type">var</span> <span class="hljs-variable">baseUrl</span> <span class="hljs-operator">=</span> DMR.getOpenAIEndpoint();
	<span class="hljs-keyword">return</span> OpenAiApi.builder().baseUrl(baseUrl).apiKey(<span class="hljs-string">"test"</span>).build();
}
</code></pre>
<p>您可以通过阅读 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.docker.com%2Fblog%2Frun-llms-locally%2F" target="_blank" title="https://www.docker.com/blog/run-llms-locally/" ref="nofollow noopener noreferrer">Run LLMs Locally with Docker</a> 博客文章来了解更多关于 Docker Model Runner 的信息。</p>
<h3 data-id="heading-3">自动配置</h3>
<blockquote>
<p><strong>注意</strong>：Spring AI 启动模块的构件 ID 自版本 1.0.0.M7 以来已重命名。依赖项名称现在应遵循模型、向量存储和 MCP 启动器的更新命名模式。
请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2Fupgrade-notes.html" target="_blank" title="https://docs.spring.io/spring-ai/reference/upgrade-notes.html" ref="nofollow noopener noreferrer">升级说明</a>了解更多信息。</p>
</blockquote>
<p>Spring AI 为 OpenAI 聊天客户端提供 Spring Boot 自动配置。
要启用它，请将以下依赖项添加到您项目的 Maven <code>pom.xml</code> 文件中：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-openai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>或者将以下内容添加到您的 Gradle <code>build.gradle</code> 构建文件中：</p>
<pre><code class="hljs language-groovy" lang="groovy">dependencies {
    implementation 'org.springframework.ai:spring-ai-starter-model-openai'
}
</code></pre>
<blockquote>
<p><strong>提示</strong>：请参考<a href="https://link.juejin.cn?target=..%2F..%2Fgetting-started.html%23dependency-management" target="_blank" title="../../getting-started.html#dependency-management" ref="nofollow noopener noreferrer">依赖管理</a>部分，将 Spring AI BOM 添加到您的构建文件中。</p>
</blockquote>
<h4 data-id="heading-4">聊天属性</h4>
<h5 data-id="heading-5">重试属性</h5>
<p>前缀 <code>spring.ai.retry</code> 用作属性前缀，让您可以为 OpenAI 聊天模型配置重试机制。</p>













































<table><thead><tr><th>属性</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>spring.ai.retry.max-attempts</td><td>最大重试尝试次数</td><td>10</td></tr><tr><td>spring.ai.retry.backoff.initial-interval</td><td>指数退避策略的初始睡眠持续时间</td><td>2 秒</td></tr><tr><td>spring.ai.retry.backoff.multiplier</td><td>退避间隔乘数</td><td>5</td></tr><tr><td>spring.ai.retry.backoff.max-interval</td><td>最大退避持续时间</td><td>3 分钟</td></tr><tr><td>spring.ai.retry.on-client-errors</td><td>如果为 false，则抛出 NonTransientAiException，并且不会尝试重试 <code>4xx</code> 客户端错误代码</td><td>false</td></tr><tr><td>spring.ai.retry.exclude-on-http-codes</td><td>不应触发重试的 HTTP 状态代码列表（例如，抛出 NonTransientAiException）</td><td>空</td></tr><tr><td>spring.ai.retry.on-http-codes</td><td>应触发重试的 HTTP 状态代码列表（例如，抛出 TransientAiException）</td><td>空</td></tr></tbody></table>
<h5 data-id="heading-6">连接属性</h5>
<p>前缀 <code>spring.ai.openai</code> 用作属性前缀，让您可以连接到 OpenAI。</p>




















<table><thead><tr><th>属性</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>spring.ai.openai.base-url</td><td>连接的 URL。必须设置为 <code>hub.docker.com/u/ai</code></td><td>-</td></tr><tr><td>spring.ai.openai.api-key</td><td>任何字符串</td><td>-</td></tr></tbody></table>
<h5 data-id="heading-7">配置属性</h5>
<blockquote>
<p><strong>注意</strong>：启用和禁用聊天自动配置现在通过前缀为 <code>spring.ai.model.chat</code> 的顶级属性完成。</p>
<p>要启用：<code>spring.ai.model.chat=openai</code>（默认启用）</p>
<p>要禁用：<code>spring.ai.model.chat=none</code>（或任何不匹配 openai 的值）</p>
<p>此更改允许在应用程序中配置多个模型。</p>
</blockquote>
<p>前缀 <code>spring.ai.openai.chat</code> 是属性前缀，让您可以为 OpenAI 配置聊天模型实现。</p>














































































































<table><thead><tr><th>属性</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>spring.ai.openai.chat.enabled (已移除，不再有效)</td><td>启用 OpenAI 聊天模型</td><td>true</td></tr><tr><td>spring.ai.model.chat</td><td>启用 OpenAI 聊天模型</td><td>openai</td></tr><tr><td>spring.ai.openai.chat.base-url</td><td>可选地覆盖 <code>spring.ai.openai.base-url</code> 以提供聊天特定的 URL。必须设置为 <code>localhost:12434/engines</code></td><td>-</td></tr><tr><td>spring.ai.openai.chat.api-key</td><td>可选地覆盖 spring.ai.openai.api-key 以提供聊天特定的 api-key</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.model</td><td>要使用的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.docker.com%2Fu%2Fai" target="_blank" title="https://hub.docker.com/u/ai" ref="nofollow noopener noreferrer">LLM 模型</a></td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.temperature</td><td>控制生成完成的明显创造性的采样温度。较高的值会使输出更随机，而较低的值会使结果更聚焦和确定性。不建议同时修改温度和 top_p 的相同完成请求，因为这两个设置的相互作用难以预测。</td><td>0.8</td></tr><tr><td>spring.ai.openai.chat.options.frequencyPenalty</td><td>-2.0 到 2.0 之间的数字。正值根据新令牌在文本中的现有频率对其进行惩罚，降低模型逐字重复同一行的可能性。</td><td>0.0f</td></tr><tr><td>spring.ai.openai.chat.options.maxTokens</td><td>在聊天完成中生成的最大令牌数。输入令牌和生成令牌的总长度受模型的上下文长度限制。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.n</td><td>为每个输入消息生成多少聊天完成选择。请注意，您将根据所有选择中生成的令牌数量计费。保持 n 为 1 以最小化成本。</td><td>1</td></tr><tr><td>spring.ai.openai.chat.options.presencePenalty</td><td>-2.0 到 2.0 之间的数字。正值根据新令牌是否出现在文本中来对其进行惩罚，增加模型谈论新主题的可能性。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.responseFormat</td><td>指定模型必须输出的格式的对象。设置为 <code>{ "type": "json_object" }</code> 启用 JSON 模式，保证模型生成的消息是有效的 JSON。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.seed</td><td>此功能处于 Beta 阶段。如果指定，我们的系统将尽力进行确定性采样，使得具有相同种子和参数的重复请求应返回相同结果。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.stop</td><td>最多 4 个序列，API 将停止生成进一步的令牌。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.topP</td><td>温度采样的替代方案，称为核采样，其中模型考虑具有 top_p 概率质量的令牌结果。因此 0.1 意味着只考虑构成前 10% 概率质量的令牌。我们通常建议更改此参数或温度，但不要同时更改两者。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.tools</td><td>模型可能调用的工具列表。目前，仅支持函数作为工具。使用此项提供模型可能为其生成 JSON 输入的函数列表。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.toolChoice</td><td>控制模型调用哪个（如果有）函数。none 表示模型不会调用函数而是生成消息。auto 表示模型可以选择生成消息或调用函数。通过 {"type: "function", "function": {"name": "my_function"}} 指定特定函数强制模型调用该函数。当没有函数时 none 是默认值。如果有函数，auto 是默认值。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.user</td><td>代表您的最终用户的唯一标识符，可以帮助 OpenAI 监控和检测滥用。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.functions</td><td>在单个提示请求中启用函数调用的函数名称列表。具有这些名称的函数必须存在于 functionCallbacks 注册表中。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.stream-usage</td><td>（仅用于流式传输）设置为添加包含整个请求的令牌使用统计的额外块。此块的 <code>choices</code> 字段是空数组，所有其他块也将包含 usage 字段，但值为 null。</td><td>false</td></tr><tr><td>spring.ai.openai.chat.options.proxy-tool-calls</td><td>如果为 true，Spring AI 将不会内部处理函数调用，而是将它们代理给客户端。然后是客户端的责任来处理函数调用，将它们分派给适当的函数，并返回结果。如果为 false（默认值），Spring AI 将内部处理函数调用。仅适用于支持函数调用的聊天模型</td><td>false</td></tr></tbody></table>
<blockquote>
<p><strong>提示</strong>：所有以 <code>spring.ai.openai.chat.options</code> 为前缀的属性都可以通过向 <code>Prompt</code> 调用添加请求特定的<a href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E9%80%89%E9%A1%B9" title="#%E8%BF%90%E8%A1%8C%E6%97%B6%E9%80%89%E9%A1%B9">运行时选项</a>在运行时覆盖。</p>
</blockquote>
<h3 data-id="heading-8">运行时选项</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai%2Fblob%2Fmain%2Fmodels%2Fspring-ai-openai%2Fsrc%2Fmain%2Fjava%2Forg%2Fspringframework%2Fai%2Fopenai%2FOpenAiChatOptions.java" target="_blank" title="https://github.com/spring-projects/spring-ai/blob/main/models/spring-ai-openai/src/main/java/org/springframework/ai/openai/OpenAiChatOptions.java" ref="nofollow noopener noreferrer">OpenAiChatOptions.java</a> 提供模型配置，例如要使用的模型、温度、频率惩罚等。</p>
<p>在启动时，可以使用 <code>OpenAiChatModel(api, options)</code> 构造函数或 <code>spring.ai.openai.chat.options.*</code> 属性配置默认选项。</p>
<p>在运行时，您可以通过向 <code>Prompt</code> 调用添加新的请求特定选项来覆盖默认选项。
例如，要覆盖特定请求的默认模型和温度：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ChatResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> chatModel.call(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Prompt</span>(
        <span class="hljs-string">"Generate the names of 5 famous pirates."</span>,
        OpenAiChatOptions.builder()
            .model(<span class="hljs-string">"ai/gemma3:4B-F16"</span>)
        .build()
    ));
</code></pre>
<blockquote>
<p><strong>提示</strong>：除了模型特定的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai%2Fblob%2Fmain%2Fmodels%2Fspring-ai-openai%2Fsrc%2Fmain%2Fjava%2Forg%2Fspringframework%2Fai%2Fopenai%2FOpenAiChatOptions.java" target="_blank" title="https://github.com/spring-projects/spring-ai/blob/main/models/spring-ai-openai/src/main/java/org/springframework/ai/openai/OpenAiChatOptions.java" ref="nofollow noopener noreferrer">OpenAiChatOptions</a> 外，您还可以使用通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai%2Fblob%2Fmain%2Fspring-ai-model%2Fsrc%2Fmain%2Fjava%2Forg%2Fspringframework%2Fai%2Fchat%2Fprompt%2FDefaultChatOptionsBuilder.java" target="_blank" title="https://github.com/spring-projects/spring-ai/blob/main/spring-ai-model/src/main/java/org/springframework/ai/chat/prompt/DefaultChatOptionsBuilder.java" ref="nofollow noopener noreferrer">ChatOptions#builder()</a> 创建的可移植 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai%2Fblob%2Fmain%2Fspring-ai-model%2Fsrc%2Fmain%2Fjava%2Forg%2Fspringframework%2Fai%2Fchat%2Fprompt%2FChatOptions.java" target="_blank" title="https://github.com/spring-projects/spring-ai/blob/main/spring-ai-model/src/main/java/org/springframework/ai/chat/prompt/ChatOptions.java" ref="nofollow noopener noreferrer">ChatOptions</a> 实例。</p>
</blockquote>
<h3 data-id="heading-9">函数调用</h3>
<p>Docker Model Runner 在选择支持它的模型时支持工具/函数调用。</p>
<p>您可以使用您的 ChatModel 注册自定义 Java 函数，并让提供的模型智能地选择输出包含调用一个或多个注册函数参数的 JSON 对象。
这是将 LLM 功能与外部工具和 API 连接的强大技术。</p>
<h4 data-id="heading-10">工具示例</h4>
<p>以下是如何在 Spring AI 中使用 Docker Model Runner 函数调用的简单示例：</p>
<pre><code class="hljs language-properties" lang="properties">spring.ai.openai.api-key=test
spring.ai.openai.base-url=http://localhost:12434/engines
spring.ai.openai.chat.options.model=ai/gemma3:4B-F16
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DockerModelRunnerLlmApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(DockerModelRunnerLlmApplication.class, args);
    }

    <span class="hljs-meta">@Bean</span>
    CommandLineRunner <span class="hljs-title function_">runner</span><span class="hljs-params">(ChatClient.Builder chatClientBuilder)</span> {
        <span class="hljs-keyword">return</span> args -&gt; {
            <span class="hljs-type">var</span> <span class="hljs-variable">chatClient</span> <span class="hljs-operator">=</span> chatClientBuilder.build();

            <span class="hljs-type">var</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> chatClient.prompt()
                .user(<span class="hljs-string">"What is the weather in Amsterdam and Paris?"</span>)
                .functions(<span class="hljs-string">"weatherFunction"</span>) <span class="hljs-comment">// 通过 bean 名称引用。</span>
                .call()
                .content();

            System.out.println(response);
        };
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Description("Get the weather in location")</span>
    <span class="hljs-keyword">public</span> Function&lt;WeatherRequest, WeatherResponse&gt; <span class="hljs-title function_">weatherFunction</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MockWeatherService</span>();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MockWeatherService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Function</span>&lt;WeatherRequest, WeatherResponse&gt; {

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">WeatherRequest</span><span class="hljs-params">(String location, String unit)</span> {}
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">WeatherResponse</span><span class="hljs-params">(<span class="hljs-type">double</span> temp, String unit)</span> {}

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> WeatherResponse <span class="hljs-title function_">apply</span><span class="hljs-params">(WeatherRequest request)</span> {
            <span class="hljs-type">double</span> <span class="hljs-variable">temperature</span> <span class="hljs-operator">=</span> request.location().contains(<span class="hljs-string">"Amsterdam"</span>) ? <span class="hljs-number">20</span> : <span class="hljs-number">25</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeatherResponse</span>(temperature, request.unit);
        }
    }
}
</code></pre>
<p>在此示例中，当模型需要天气信息时，它将自动调用 <code>weatherFunction</code> bean，然后可以获取实时天气数据。
预期的响应是："阿姆斯特丹目前的天气是 20 摄氏度，巴黎目前的天气是 25 摄氏度。"</p>
<p>阅读更多关于 OpenAI <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2Fapi%2Fchat%2Ffunctions%2Fopenai-chat-functions.html" target="_blank" title="https://docs.spring.io/spring-ai/reference/api/chat/functions/openai-chat-functions.html" ref="nofollow noopener noreferrer">函数调用</a>的信息。</p>
<h3 data-id="heading-11">示例控制器</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fstart.spring.io%2F" target="_blank" title="https://start.spring.io/" ref="nofollow noopener noreferrer">创建</a>一个新的 Spring Boot 项目，并将 <code>spring-ai-starter-model-openai</code> 添加到您的 pom（或 gradle）依赖项中。</p>
<p>在 <code>src/main/resources</code> 目录下添加 <code>application.properties</code> 文件，以启用和配置 OpenAI 聊天模型：</p>
<pre><code class="hljs language-properties" lang="properties">spring.ai.openai.api-key=test
spring.ai.openai.base-url=http://localhost:12434/engines
spring.ai.openai.chat.options.model=ai/gemma3:4B-F16

# Docker Model Runner 不支持嵌入，所以我们需要禁用它们。
spring.ai.openai.embedding.enabled=false
</code></pre>
<p>这是一个使用聊天模型进行文本生成的简单 <code>@Controller</code> 类示例。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OpenAiChatModel chatModel;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatController</span><span class="hljs-params">(OpenAiChatModel chatModel)</span> {
        <span class="hljs-built_in">this</span>.chatModel = chatModel;
    }

    <span class="hljs-meta">@GetMapping("/ai/generate")</span>
    <span class="hljs-keyword">public</span> Map <span class="hljs-title function_">generate</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-keyword">return</span> Map.of(<span class="hljs-string">"generation"</span>, <span class="hljs-built_in">this</span>.chatModel.call(message));
    }

    <span class="hljs-meta">@GetMapping("/ai/generateStream")</span>
	<span class="hljs-keyword">public</span> Flux&lt;ChatResponse&gt; <span class="hljs-title function_">generateStream</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-type">Prompt</span> <span class="hljs-variable">prompt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Prompt</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>(message));
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.chatModel.stream(prompt);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[冷查第一，再登榜首！Apache Doris 3.1 全面刷新 JSONBench 性能纪录]]></title>    <link>https://juejin.cn/post/7571191453125885978</link>    <guid>https://juejin.cn/post/7571191453125885978</guid>    <pubDate>2025-11-11T09:10:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571191453125885978" data-draft-id="7571279513246760986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="冷查第一，再登榜首！Apache Doris 3.1 全面刷新 JSONBench 性能纪录"/> <meta itemprop="keywords" content="数据库,Apache"/> <meta itemprop="datePublished" content="2025-11-11T09:10:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            冷查第一，再登榜首！Apache Doris 3.1 全面刷新 JSONBench 性能纪录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:10:25.000Z" title="Tue Nov 11 2025 09:10:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在半结构化数据分析领域，真正的挑战往往不在于“热数据”，即常被访问、已加载至缓存的数据，而在于“<strong>冷数据”</strong> ——那些规模庞大、未被缓存，且需直接从磁盘读取的 JSON 文件。</p>
<p>在 9 月份发布的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fselectdb.com%2Fblog%2F1490" target="_blank" title="https://selectdb.com/blog/1490" ref="nofollow noopener noreferrer">Apache Doris 3.1 </a>版本中，对 Variant 引擎进行系统性优化，包括引入稀疏子列与子列模板化机制、优化列裁剪与路径索引、向量化 JSON 列裁剪引擎。这些改进推动 Doris 在冷查场景下实现性能及稳定性的全面突破。</p>
<p><strong>与此同时，基于 Apache Doris 3.1 版本，在最新的  <a href="https://link.juejin.cn?target=https%3A%2F%2Fjsonbench.com%2F%3F%23eyJzeXN0ZW0iOnsiQ2xpY2tIb3VzZSAobHo0KSI6dHJ1ZSwiQ2xpY2tIb3VzZSAoenN0ZCkiOnRydWUsIkFwYWNoZSBEb3JpcyI6dHJ1ZSwiRHVja0RCIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIGx6NCkiOnRydWUsIkVsYXN0aWNzZWFyY2ggKHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChsejQpIjp0cnVlLCJGZXJyZXREQiAoc25hcHB5KSI6dHJ1ZSwiRmVycmV0REIgKHpzdGQpIjp0cnVlLCJHcmVwdGltZURCIjp0cnVlLCJNb25nb0RCIChzbmFwcHkpIjp0cnVlLCJNb25nb0RCICh6c3RkKSI6dHJ1ZSwiUG9zdGdyZVNRTCI6dHJ1ZSwiU2luZ2xlU3RvcmUiOnRydWUsIlN0YXJyb2NrcyI6dHJ1ZSwiVmljdG9yaWFMb2dzIjp0cnVlfSwic2NhbGUiOjEwMDAwMDAwMDAsIm1ldHJpYyI6ImNvbGQiLCJxdWVyaWVzIjpbdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlXSwicmV0YWluX3N0cnVjdHVyZSI6eyJ5ZXMiOnRydWUsIm5vIjpmYWxzZX19" target="_blank" title="https://jsonbench.com/?#eyJzeXN0ZW0iOnsiQ2xpY2tIb3VzZSAobHo0KSI6dHJ1ZSwiQ2xpY2tIb3VzZSAoenN0ZCkiOnRydWUsIkFwYWNoZSBEb3JpcyI6dHJ1ZSwiRHVja0RCIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIGx6NCkiOnRydWUsIkVsYXN0aWNzZWFyY2ggKHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChsejQpIjp0cnVlLCJGZXJyZXREQiAoc25hcHB5KSI6dHJ1ZSwiRmVycmV0REIgKHpzdGQpIjp0cnVlLCJHcmVwdGltZURCIjp0cnVlLCJNb25nb0RCIChzbmFwcHkpIjp0cnVlLCJNb25nb0RCICh6c3RkKSI6dHJ1ZSwiUG9zdGdyZVNRTCI6dHJ1ZSwiU2luZ2xlU3RvcmUiOnRydWUsIlN0YXJyb2NrcyI6dHJ1ZSwiVmljdG9yaWFMb2dzIjp0cnVlfSwic2NhbGUiOjEwMDAwMDAwMDAsIm1ldHJpYyI6ImNvbGQiLCJxdWVyaWVzIjpbdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlXSwicmV0YWluX3N0cnVjdHVyZSI6eyJ5ZXMiOnRydWUsIm5vIjpmYWxzZX19" ref="nofollow noopener noreferrer">JSONBench 基准测试</a> 中，获得在冷查性能第一的优异成绩，超越 ClickHouse、Elasticsearch 等同类数据库；热查询也获得第二的成绩；综合性能全面领先！</strong></p>
<h3 data-id="heading-0">什么是 JSONBench</h3>
<p>JSONBench 是最具代表性的 JSON 数据分析性能基准，由 ClickHouse 社区发起。该基准测试采用真实场景 Bluesky 数据集（ 10 亿级 JSON 数据），包含多层嵌套、键值不固定的 JSON 结构，对数据库的查询优化、列存设计、解析引擎都是严苛考验，是业内公认的半结构化性能试金石。</p>
<h3 data-id="heading-1">Doris 冷查性能 Top 1</h3>
<p>根据最新的内部测试与 JSONBench 官方公布结果， Apache Doris 3.1 冷查在 Q3–Q5 查询表现最佳，且在冷查询（无缓存）场景下性能远超其他所有对比系统，位居榜首，综合性能全面领先。</p>
<p>具体测试结果如下：</p>
<ul>
<li>JSONBench 榜单已同步 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjsonbench.com%3F%23eyJzeXN0ZW0iOnsiQ2xpY2tIb3VzZSAobHo0KSI6dHJ1ZSwiQ2xpY2tIb3VzZSAoenN0ZCkiOnRydWUsIkFwYWNoZSBEb3JpcyI6dHJ1ZSwiRHVja0RCIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIGx6NCkiOnRydWUsIkVsYXN0aWNzZWFyY2ggKHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChsejQpIjp0cnVlLCJGZXJyZXREQiAoc25hcHB5KSI6dHJ1ZSwiRmVycmV0REIgKHpzdGQpIjp0cnVlLCJHcmVwdGltZURCIjp0cnVlLCJNb25nb0RCIChzbmFwcHkpIjp0cnVlLCJNb25nb0RCICh6c3RkKSI6dHJ1ZSwiUG9zdGdyZVNRTCI6dHJ1ZSwiU2luZ2xlU3RvcmUiOnRydWUsIlN0YXJyb2NrcyI6dHJ1ZSwiVmljdG9yaWFMb2dzIjp0cnVlfSwic2NhbGUiOjEwMDAwMDAwMDAsIm1ldHJpYyI6ImNvbGQiLCJxdWVyaWVzIjpbdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlXSwicmV0YWluX3N0cnVjdHVyZSI6eyJ5ZXMiOnRydWUsIm5vIjpmYWxzZX19" target="_blank" title="https://jsonbench.com?#eyJzeXN0ZW0iOnsiQ2xpY2tIb3VzZSAobHo0KSI6dHJ1ZSwiQ2xpY2tIb3VzZSAoenN0ZCkiOnRydWUsIkFwYWNoZSBEb3JpcyI6dHJ1ZSwiRHVja0RCIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIGx6NCkiOnRydWUsIkVsYXN0aWNzZWFyY2ggKHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChsejQpIjp0cnVlLCJGZXJyZXREQiAoc25hcHB5KSI6dHJ1ZSwiRmVycmV0REIgKHpzdGQpIjp0cnVlLCJHcmVwdGltZURCIjp0cnVlLCJNb25nb0RCIChzbmFwcHkpIjp0cnVlLCJNb25nb0RCICh6c3RkKSI6dHJ1ZSwiUG9zdGdyZVNRTCI6dHJ1ZSwiU2luZ2xlU3RvcmUiOnRydWUsIlN0YXJyb2NrcyI6dHJ1ZSwiVmljdG9yaWFMb2dzIjp0cnVlfSwic2NhbGUiOjEwMDAwMDAwMDAsIm1ldHJpYyI6ImNvbGQiLCJxdWVyaWVzIjpbdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlXSwicmV0YWluX3N0cnVjdHVyZSI6eyJ5ZXMiOnRydWUsIm5vIjpmYWxzZX19" ref="nofollow noopener noreferrer">Doris 3.1 结果</a></li>
<li>更多测试数据及报告详见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1421" target="_blank" title="https://www.selectdb.com/blog/1421" ref="nofollow noopener noreferrer">SelectDB 官方博客</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4a41c258c9e41d787e55046678cce6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763457025&amp;x-signature=F9SQYgzBFePZQUFjr%2BcFkLWjD%2BE%3D" alt="Doris 冷查性能 Top 1.png" loading="lazy"/></p>
<p>从榜单可以清晰地看到，Doris （分数 1.57） 具备压倒性的性能优势：其速度约是 MongoDB （分数 258.21） 的 164 倍，是 PostgreSQL （分数 1687.29） 的 1074 倍。同时，以近 2 倍的优势领先于 Elasticsearch （分数 3.01），成为更具竞争力的选择。</p>
<p>此外，Doris 在热查询下也表现优异，仅次于榜单发起者 ClickHouse，位居第二。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11724280a246484aaeefe672f8e29543~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763457025&amp;x-signature=irD8G8OU0EFXZq7V1C%2BlvCeiSBU%3D" alt="Doris 冷查性能 Top 1-1.PNG" loading="lazy"/></p>
<h3 data-id="heading-2">性能登顶的背后</h3>
<p>Apache Doris 在冷查询场景下的卓越性能，得益于其在以下几方面的协同：</p>
<ul>
<li><strong>高效 I/O 路径</strong>：通过 Path 级别列裁剪和延迟物化机制，冷读 JSON 子列时仅加载必需的数据，精确命中、减少数据读放大问题；</li>
<li><strong>Variant 子列级索引</strong>：支持 JSON 路径索引（ZoneMap、BloomFilter 等稀疏索引）和谓词下推，支持文件级别裁剪，可加速过滤条件的定位；</li>
<li><strong>强大的查询引擎</strong>：具备高效的向量化执行引擎以及并发查询机制，显著提升查询效率；</li>
<li><strong>智能缓存策略</strong>：在冷查时，结合预读与页缓存，可提升系统整体吞吐。</li>
</ul>
<p>同时，在 Doris 3.1 版本中，Doris 对 Variant 类型进行了系统性优化，使其在冷查场景下有更为可观的性能提升：</p>
<ul>
<li><strong>稀疏子列（Sparse Sub-Column）机制</strong>：仅列式存储高频出现的 JSON 键，减少 I/O 与元数据开销；</li>
<li>**子列模板化（Schema Template）机制：**固定子列类型，确保索引命中更加稳定；</li>
<li><strong>列裁剪与路径索引优化</strong>：冷读时可精确定位目标子列，避免全字段扫描，并能实现更稳定的索引命中。</li>
</ul>
<p>详情参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2F3.x%2Fsql-manual%2Fbasic-element%2Fsql-data-types%2Fsemi-structured%2FVARIANT" target="_blank" title="https://doris.apache.org/zh-CN/docs/3.x/sql-manual/basic-element/sql-data-types/semi-structured/VARIANT" ref="nofollow noopener noreferrer">Variant 数据类型</a></p>
<h3 data-id="heading-3">选择 Apache Doris</h3>
<p>对于追求稳定、高效、低延迟的半结构化分析系统而言，Apache Doris 3.1 正在成为新的性能标杆。其核心价值体现在：</p>
<ul>
<li><strong>秒级查询响应</strong>：在日志、埋点、事件数据分析场景中，实现秒级响应，支持实时探索；</li>
<li><strong>适用存算分离架构</strong>：即使在基于 S3、HDFS 的大规模存算分离架构中，冷查询性能依然强劲；</li>
<li><strong>极低 I/O 成本</strong>：在相同查询规模下，Doris 的冷查 I/O 成本相比 Elasticsearch 可降低 60% 以上；</li>
<li><strong>技术架构升级</strong>：从上文可知，Doris 在 JSON 分析场景中，性能远超 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FClickHouse%2FJSONBench%2Fblob%2Fmain%2Fmongodb%2Fresults%2Fm6i.8xlarge_bluesky_1000m_snappy.json" target="_blank" title="https://github.com/ClickHouse/JSONBench/blob/main/mongodb/results/m6i.8xlarge_bluesky_1000m_snappy.json" ref="nofollow noopener noreferrer">MongoDB</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FClickHouse%2FJSONBench%2Fblob%2Fmain%2Fpostgresql%2Fresults%2Fm6i.8xlarge_bluesky_1000m.json" target="_blank" title="https://github.com/ClickHouse/JSONBench/blob/main/postgresql/results/m6i.8xlarge_bluesky_1000m.json" ref="nofollow noopener noreferrer">PostgreSQL</a> 以及 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FClickHouse%2FJSONBench%2Fblob%2Fmain%2Felasticsearch%2Fresults%2Fm6i.8xlarge_bluesky_source_1000m_default_compression.json" target="_blank" title="https://github.com/ClickHouse/JSONBench/blob/main/elasticsearch/results/m6i.8xlarge_bluesky_source_1000m_default_compression.json" ref="nofollow noopener noreferrer">Elasticsearch</a>，是当下更具竞争力的半结构化数据分析的选择。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[8. DPDK：多队列与流分类]]></title>    <link>https://juejin.cn/post/7571278865516560434</link>    <guid>https://juejin.cn/post/7571278865516560434</guid>    <pubDate>2025-11-11T09:08:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571278865516560434" data-draft-id="7571278865516331058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="8. DPDK：多队列与流分类"/> <meta itemprop="keywords" content="后端,网络协议"/> <meta itemprop="datePublished" content="2025-11-11T09:08:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yefimov"/> <meta itemprop="url" content="https://juejin.cn/user/2573309794326910"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            8. DPDK：多队列与流分类
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2573309794326910/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yefimov
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:08:11.000Z" title="Tue Nov 11 2025 09:08:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1 为什么单个CPU核处理不过来了？</h2>
<blockquote>
<p>想象一下，你让一个单线程CPU去处理每秒 10Gbps 的网络流量——  这就像让一个人单手接住从天上掉下的一万颗玻璃珠。</p>
<p>结果显而易见：CPU中断风暴、缓存失效、丢包频发。</p>
<p>于是，<strong>多核CPU的崛起</strong>带来了新的思路：  “如果网卡能把不同的流分给不同的CPU核来处理，就能实现并行处理。”</p>
<p>这就是 <strong>网卡多队列技术（Multi-Queue NIC）</strong> 的诞生。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1.1 硬件视角：Intel 82580 的多队列架构</h3>
<p>每个<strong>队列（Queue）</strong> 就像是一条独立的“数据高速公路”， 拥有自己的<strong>DMA通道、描述符环（Descriptor Ring）和中断号</strong>。</p>
<p>当数据包到达时，网卡会根据一定的规则（哈希或流分类），决定它应该进入哪个接收队列（Rx Queue）。<br/>
这些队列随后可以<strong>绑定到不同CPU核</strong>上实现并行处理。</p>
<blockquote>
<p>💡 类比理解：<br/>
如果说传统单队列网卡是一条高速路所有车辆都挤在一个收费口，  那么多队列网卡则是“多收费口并行放行”，极大缓解了瓶颈。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">1.2 Linux 内核对多队列的利用</h3>
<p>Linux 内核为多队列网卡提供了完善的支持，包括：</p>
<h5 data-id="heading-3">接收侧（Rx）</h5>
<ul>
<li>每个接收队列可对应独立中断，通过 <strong>IRQ Affinity</strong> 绑定到特定核。</li>
<li>可使用 <strong>RPS（Receive Packet Steering）</strong> 模拟硬件多队列效果，将不同流的软中断分散到多核。</li>
</ul>
<h5 data-id="heading-4">发送侧（Tx）</h5>
<ul>
<li>使用 <strong>XPS（Transmit Packet Steering）</strong> 机制，为每个CPU指定发送队列。</li>
<li>减少锁竞争，提升cache命中率。</li>
</ul>
<p>代码片段：</p>
<pre><code class="hljs language-ini" lang="ini">int dev_queue_xmit(struct sk_buff *skb) {
    struct net_device *<span class="hljs-attr">dev</span> = skb-&gt;dev<span class="hljs-comment">;</span>
    <span class="hljs-attr">txq</span> = dev_pick_tx(dev, skb)<span class="hljs-comment">; // 选择合适的发送队列</span>
    spin_lock_prefetch(&amp;txq-&gt;lock)<span class="hljs-comment">;</span>
    ...
}
</code></pre>
<p>Linux的策略很灵活，但<strong>仍有锁与上下文切换开销</strong>。</p>
<hr/>
<h3 data-id="heading-5">1.3 DPDK的革命性改进：核-队列一对一绑定</h3>
<p>DPDK抛弃内核协议栈后，采用<strong>用户态直接访问网卡队列</strong>的模型：</p>
<ul>
<li>每个核（lcore）只负责一个接收队列 + 一个发送队列。</li>
<li>收发包都在该核上完成，无需锁。</li>
<li>数据缓存在本地HugePage内存池中，cache命中率极高。</li>
</ul>
<p>代码（摘自l3fwd）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ret</span> = rte_eth_dev_configure(portid, nb_rx_queue, nb_tx_queue, &amp;port_conf)<span class="hljs-comment">;</span>
<span class="hljs-attr">ret</span> = rte_eth_tx_queue_setup(portid, queueid, nb_txd, socketid, txconf)<span class="hljs-comment">;</span>
qconf-&gt;tx_queue_id<span class="hljs-section">[portid]</span> = queueid<span class="hljs-comment">;</span>
...
rte_eth_tx_burst(port, queueid, m_table, n)<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>小结：DPDK 的多队列模型 = 零锁 + 零拷贝 + 高亲和。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">1.4 队列分配策略：RSS 与 Flow Director</h3>
<p>网卡分流的核心是<strong>Queue Select</strong>逻辑：</p>
<ol>
<li><strong>RSS（Receive Side Scaling）</strong> ：基于哈希（四元组）平均分配流量，负载均衡。</li>
<li><strong>Flow Director（Intel FD）</strong> ：基于流表匹配，将特定流导向特定队列（如特定核或VM）。</li>
</ol>
<p>现代网卡（如 Intel XL710）同时支持多种策略，可实现更精细的流量控制。</p>
<h2 data-id="heading-7">2. 为什么网卡要学会“分类”？</h2>
<blockquote>
<p>在传统的单队列网卡中，所有流量都混在一条流水线中。<br/>
这就像所有车辆都挤在一个收费站口——无论是紧急车辆还是普通车辆，都得排队。</p>
<p>而现代的智能网卡（SmartNIC）则能在硬件层面进行“流分类（Flow Classification）”：<br/>
它能识别出不同类型的流量，并将它们导向不同的处理队列。</p>
<p>这就是今天要讲的主角 —— <strong>流分类（Flow Classification）</strong> 。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">2.1 网卡眼中的“包类型”：识别是第一步</h3>
<p>要做分类，首先得<strong>看得懂包</strong>。</p>
<p>以 Intel XL710 为例，它能直接识别出以下包类型：</p>

























<table><thead><tr><th>层级</th><th>示例</th></tr></thead><tbody><tr><td>L2</td><td>以太网、VLAN</td></tr><tr><td>L3</td><td>IPv4、IPv6</td></tr><tr><td>L4</td><td>TCP、UDP</td></tr><tr><td>隧道</td><td>VXLAN、NVGRE</td></tr></tbody></table>
<p>网卡会把这些信息写进接收描述符（Rx Descriptor），DPDK应用程序就能直接从 <code>rte_mbuf.packet_type</code> 字段中读取到：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">rte_mbuf</span> {
    <span class="hljs-keyword">union</span> {
        <span class="hljs-type">uint32_t</span> packet_type; <span class="hljs-comment">/**&lt; L2/L3/L4/tunnel 信息 */</span>
        <span class="hljs-keyword">struct</span> {
            <span class="hljs-type">uint32_t</span> l2_type:<span class="hljs-number">4</span>;
            <span class="hljs-type">uint32_t</span> l3_type:<span class="hljs-number">4</span>;
            <span class="hljs-type">uint32_t</span> l4_type:<span class="hljs-number">4</span>;
            <span class="hljs-type">uint32_t</span> tun_type:<span class="hljs-number">4</span>;
            ...
        };
    };
};
</code></pre>
<p>这意味着：</p>
<ul>
<li>应用层<strong>无需再自己解析包头</strong>；</li>
<li>可以<strong>直接判断包类型</strong>，从而决定处理逻辑；</li>
<li>还能结合流分类机制，决定该包属于哪个队列。</li>
</ul>
<hr/>
<h3 data-id="heading-9">2.2 RSS：最经典的负载均衡算法</h3>
<p><strong>RSS（Receive-Side Scaling）</strong> 是最常见、最基础的流分类技术。</p>
<p>它的核心思想非常简单：</p>
<blockquote>
<p>“用哈希算法把流均匀分配到不同的队列。”</p>
</blockquote>
<p>具体过程如下：</p>
<ol>
<li>从包中抽取关键字（Key），如 <code>源IP、目的IP、源端口、目的端口</code>；</li>
<li>用哈希函数（通常是 Toeplitz Hash）计算出哈希值；</li>
<li>用哈希值映射到某个队列编号；</li>
<li>数据包DMA到对应的接收队列。</li>
</ol>
<p>以IPv4 UDP 为例，关键字是四元组：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Key</span> = SrcIP + DstIP + SrcPort + DstPort
</code></pre>
<p>Intel XL710 网卡支持多种哈希算法（包括对称哈希），这样双向流（A→B 与 B→A）可以被分配到同一个队列上，非常适合防火墙、负载均衡等场景。</p>
<blockquote>
<p>🧠 类比：RSS 就像一台“高速公路匝道分流器”，<br/>
它不会管车是什么类型，只负责“均匀分车道”。</p>
</blockquote>
<p>DPDK中可通过 <code>rte_eth_dev_configure()</code> 和 <code>rte_eth_dev_rss_hash_update()</code> 等API配置RSS。</p>
<hr/>
<h3 data-id="heading-10">2.3 Flow Director：让网卡“定向分流”</h3>
<p><strong>Flow Director（FDIR）</strong> 是RSS的“进阶版”。<br/>
RSS是<strong>哈希随机分流</strong>，而Flow Director是<strong>规则匹配分流</strong>。</p>
<p>其原理：</p>
<ul>
<li>网卡中维护一张 <strong>Flow Table</strong>；</li>
<li>驱动或应用可以动态添加规则；</li>
<li>当网卡收到数据包时，会根据关键字段匹配表项；</li>
<li>匹配成功后执行对应动作（如：导入特定队列、丢弃）。</li>
</ul>
<p>示意：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[Packet]</span> --&gt; <span class="hljs-selector-attr">[Flow Director Table]</span> --&gt; <span class="hljs-selector-attr">[Action: Queue 3 / Drop / Forward]</span>
</code></pre>
<p>例如，你可以设置：</p>
<blockquote>
<p>所有 <code>S-IP=10.0.0.1, D-Port=80</code> 的TCP包 → 队列1<br/>
所有 <code>S-IP=10.0.0.2, D-Port=443</code> 的TCP包 → 队列2</p>
</blockquote>
<p>这样，特定业务流量（如HTTP、HTTPS）可以绑定到不同核处理，提高cache命中率、减少锁争用。</p>
<p><strong>RSS vs Flow Director 对比表</strong></p>






























<table><thead><tr><th>特性</th><th>RSS</th><th>流量导向器</th></tr></thead><tbody><tr><td>分流规则</td><td>哈希（平均分配）</td><td>精确匹配</td></tr><tr><td>动态可配置</td><td>否</td><td>是</td></tr><tr><td>典型场景</td><td>负载均衡</td><td>精确流控、QoS、NFV</td></tr><tr><td>实现复杂度</td><td>低</td><td>高（需硬件支持）</td></tr></tbody></table>
<blockquote>
<p>Flow Director 的哲学： <strong>“不平均，但精确。”</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-11">2.4 QoS：网卡级的服务质量调度</h3>
<p>在大型数据中心或NFV环境中，不同业务流量有不同的优先级，QoS（Quality of Service）就是要在<strong>网卡层面实现优先级调度</strong>。</p>
<p>Intel 82599 网卡支持 DCB（Data Center Bridging）模型：</p>
<h5 data-id="heading-12">发送方向（Tx）</h5>
<ul>
<li>通过 VLAN Tag 中的 <strong>UP（User Priority）字段</strong> 确定业务类型；</li>
<li>不同 UP → 不同 TC（Traffic Class）；</li>
<li>每个 TC 拥有独立队列和 buffer；</li>
<li>网卡使用 <strong>加权严格优先级（WSP）</strong> 调度算法决定先发哪个队列。</li>
</ul>
<h5 data-id="heading-13">接收方向（Rx）</h5>
<ul>
<li>根据 UP 决定TC；</li>
<li>TC 内部再通过RSS或Flow Director细分。</li>
</ul>
<blockquote>
<p>类比：QoS 就像机场的登机口分区，<br/>
头等舱、商务舱、经济舱虽然都上飞机，但排队顺序不一样。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">2.5 虚拟化场景下的多队列调度</h3>
<p>在SR-IOV或VMDQ场景中，<strong>每个虚拟机（VF）或虚拟池（POOL）</strong>  都对应一组独立的硬件队列。</p>
<p>例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable constant_">PF</span>（物理功能）
 ├── <span class="hljs-title class_">VF0</span> → <span class="hljs-title class_">Queue</span> <span class="hljs-title class_">Set</span> <span class="hljs-number">0</span>
 ├── <span class="hljs-title class_">VF1</span> → <span class="hljs-title class_">Queue</span> <span class="hljs-title class_">Set</span> <span class="hljs-number">1</span>
 └── <span class="hljs-title class_">VF2</span> → <span class="hljs-title class_">Queue</span> <span class="hljs-title class_">Set</span> <span class="hljs-number">2</span>
</code></pre>
<p>这使得虚拟机能直接接收属于自己的流量，避免VM之间的干扰。<br/>
DPDK中可通过 <code>rte_eth_dev_set_vf_rx_queue_assignment()</code> 等API管理VF队列。</p>
<hr/>
<h3 data-id="heading-15">2.6 流过滤（Flow Filtering）：最后一道防线</h3>
<p>在所有分类动作之前，网卡会先进行合法性过滤：</p>
<ol>
<li>MAC 地址过滤（L2Filter）</li>
<li>VLAN 标签过滤</li>
<li>管理控制帧过滤（如ARP、LLDP）</li>
</ol>
<p>Intel 网卡还提供：</p>
<ul>
<li><strong>Src MAC/VLAN Antispoofing</strong>（防欺骗）</li>
<li><strong>N-Tuple Filter</strong>（自定义五元组匹配）</li>
<li><strong>Cloud Filter</strong>（VXLAN/NVGRE等隧道过滤）</li>
</ul>
<blockquote>
<p>总结：过滤 ≈ “保安岗”；分类 ≈ “分流岗”。<br/>
一前一后，保障安全与性能并重。</p>
</blockquote>
<h3 data-id="heading-16">3. 控制流与数据流的分治难题</h3>
<p>在DPDK的高速转发场景中，我们常常面临这样的设计矛盾：</p>
<ul>
<li><strong>转发流量（Data Plane）</strong> 要求<strong>高吞吐、低延迟</strong>，需要多个核心并行；</li>
<li><strong>控制流量（Control Plane）</strong> 数量不大，但要求<strong>稳定、可靠</strong>，而且逻辑完全不同。</li>
</ul>
<p>举个例子：</p>
<blockquote>
<p>路由器需要高速转发数据包（多核并行），  但同时也要解析少量控制报文（如ARP、心跳等），  你不希望这点控制包影响主数据流的性能。</p>
</blockquote>
<p>那么，<strong>如何在硬件层面实现“分流”</strong> ？<br/>
这正是DPDK结合<strong>RSS + Flow Director</strong>的经典应用场景👇</p>
<hr/>
<h4 data-id="heading-17">3.1 DPDK配置实战：让网卡学会智能分流</h4>
<p>下面是一段完整的配置逻辑，我们以 Intel® 82599 为例。</p>
<h5 data-id="heading-18">（1）初始化网卡配置</h5>
<p>这里需要同时打开 <strong>RSS</strong> 和 <strong>Flow Director</strong> 两种分类机制：</p>
<pre><code class="hljs language-ini" lang="ini">static struct rte_eth_conf <span class="hljs-attr">port_conf</span> = {
    .<span class="hljs-attr">rxmode</span> = {
        .<span class="hljs-attr">mq_mode</span> = ETH_MQ_RX_RSS, // 启用多队列 + RSS
    },
    .<span class="hljs-attr">rx_adv_conf</span> = {
        .<span class="hljs-attr">rss_conf</span> = {
            .<span class="hljs-attr">rss_key</span> = NULL,
            .<span class="hljs-attr">rss_hf</span> = ETH_RSS_IP | ETH_RSS_UDP |
                      ETH_RSS_TCP | ETH_RSS_SCTP,
        },
    },
    .<span class="hljs-attr">fdir_conf</span> = {
        .<span class="hljs-attr">mode</span> = RTE_FDIR_MODE_PERFECT,      // 精确匹配模式
        .<span class="hljs-attr">pballoc</span> = RTE_FDIR_PBALLOC_64K,    // 表大小
        .<span class="hljs-attr">status</span> = RTE_FDIR_REPORT_STATUS,   // 报文上报
        .<span class="hljs-attr">mask</span> = {
            .<span class="hljs-attr">ipv4_mask</span> = {
                .<span class="hljs-attr">src_ip</span> = <span class="hljs-number">0</span>xFFFFFFFF,
                .<span class="hljs-attr">dst_ip</span> = <span class="hljs-number">0</span>xFFFFFFFF,
            },
            .<span class="hljs-attr">src_port_mask</span> = <span class="hljs-number">0</span>xFFFF,
            .<span class="hljs-attr">dst_port_mask</span> = <span class="hljs-number">0</span>xFFFF,
        },
        .<span class="hljs-attr">drop_queue</span> = <span class="hljs-number">127</span>, // 匹配失败的流默认丢弃
    },
}<span class="hljs-comment">;</span>

rte_eth_dev_configure(port, 4, 4, &amp;port_conf)<span class="hljs-comment">; // 启用4个收发队列</span>
</code></pre>
<blockquote>
<p>提示：RSS和FDIR都依赖硬件资源，配置时要注意网卡是否支持（如82599/XL710均支持）。</p>
</blockquote>
<hr/>
<h5 data-id="heading-19">（2）配置收发队列</h5>
<pre><code class="hljs language-ini" lang="ini">struct rte_mempool *<span class="hljs-attr">mbuf_pool</span> =
    rte_pktmbuf_pool_create("MBUF_POOL", 8192, 256, 0,
                            RTE_MBUF_DEFAULT_BUF_SIZE, rte_socket_id())<span class="hljs-comment">;</span>

for (int <span class="hljs-attr">q</span> = <span class="hljs-number">0</span><span class="hljs-comment">; q &lt; 4; q++) {</span>
    rte_eth_rx_queue_setup(port, q, 128,
        rte_eth_dev_socket_id(port), NULL, mbuf_pool)<span class="hljs-comment">;</span>
    rte_eth_tx_queue_setup(port, q, 128,
        rte_eth_dev_socket_id(port), NULL)<span class="hljs-comment">;</span>
}
</code></pre>
<hr/>
<h5 data-id="heading-20">（3）启动设备</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">rte_eth_dev_start</span>(port);
</code></pre>
<hr/>
<h5 data-id="heading-21">（4）添加Flow Director规则</h5>
<p>将特定UDP报文（源IP=2.2.2.3，目的IP=2.2.2.5，端口=1024）<br/>
直接导入队列3：</p>
<pre><code class="hljs language-ini" lang="ini">struct rte_eth_fdir_filter <span class="hljs-attr">filter</span> = {
    .<span class="hljs-attr">soft_id</span> = <span class="hljs-number">1</span>,
    .<span class="hljs-attr">input</span> = {
        .<span class="hljs-attr">flow_type</span> = RTE_ETH_FLOW_NONFRAG_IPV4_UDP,
        .<span class="hljs-attr">flow</span> = {
            .<span class="hljs-attr">udp4_flow</span> = {
                .<span class="hljs-attr">ip</span> = {
                    .<span class="hljs-attr">src_ip</span> = RTE_IPV4(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>),
                    .<span class="hljs-attr">dst_ip</span> = RTE_IPV4(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>),
                },
                .<span class="hljs-attr">src_port</span> = rte_cpu_to_be_16(<span class="hljs-number">1024</span>),
                .<span class="hljs-attr">dst_port</span> = rte_cpu_to_be_16(<span class="hljs-number">1024</span>),
            },
        },
    },
    .<span class="hljs-attr">action</span> = {
        .<span class="hljs-attr">rx_queue</span> = <span class="hljs-number">3</span>,
        .<span class="hljs-attr">behavior</span> = RTE_ETH_FDIR_ACCEPT,
        .<span class="hljs-attr">report_status</span> = RTE_ETH_FDIR_REPORT_ID,
    },
}<span class="hljs-comment">;</span>

rte_eth_dev_filter_ctrl(port, RTE_ETH_FILTER_FDIR,
                        RTE_ETH_FILTER_ADD, &amp;filter)<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>这一行代码的意义：<br/>
Flow Director将特定UDP流量“精准派送”到队列3，由控制核单独处理。</p>
</blockquote>
<hr/>
<h5 data-id="heading-22">（5）调整RSS分配表（RETA）</h5>
<p>由于RSS默认会在0~3队列均衡分配，我们需要把队列3“剔除”，<br/>
让它只用于控制流。</p>
<pre><code class="hljs language-ini" lang="ini">struct rte_eth_rss_reta_entry64 reta_conf<span class="hljs-section">[2]</span><span class="hljs-comment">;</span>
int idx, i, <span class="hljs-attr">q</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
for (<span class="hljs-attr">idx</span> = <span class="hljs-number">0</span><span class="hljs-comment">; idx &lt; 2; idx++) {</span>
    reta_conf<span class="hljs-section">[idx]</span>.<span class="hljs-attr">mask</span> = ~<span class="hljs-number">0</span>ULL<span class="hljs-comment">;</span>
    for (<span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; RTE_RETA_GROUP_SIZE; i++, q++) {</span>
        if (<span class="hljs-attr">q</span> == <span class="hljs-number">3</span>) q = <span class="hljs-number">0</span><span class="hljs-comment">;  // 不分配到队列3</span>
        reta_conf<span class="hljs-section">[idx]</span>.reta<span class="hljs-section">[i]</span> = q<span class="hljs-comment">;</span>
    }
}
rte_eth_dev_rss_reta_update(port, reta_conf, 128)<span class="hljs-comment">;</span>
</code></pre>
<p>这样：</p>
<ul>
<li>队列0~2 → RSS数据流；</li>
<li>队列3 → Flow Director控制流。</li>
</ul>
<hr/>
<h5 data-id="heading-23">（6）核心线程绑定与收发逻辑</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 每个核绑定一个接收队列</span>
<span class="hljs-built_in">rte_eal_remote_launch</span>(lcore_data_loop, (void*)<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
<span class="hljs-built_in">rte_eal_remote_launch</span>(lcore_data_loop, (void*)<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
<span class="hljs-built_in">rte_eal_remote_launch</span>(lcore_data_loop, (void*)<span class="hljs-number">2</span>, <span class="hljs-number">3</span>);
<span class="hljs-built_in">rte_eal_remote_launch</span>(lcore_ctrl_loop, (void*)<span class="hljs-number">3</span>, <span class="hljs-number">4</span>);
</code></pre>
<p>在 <code>lcore_ctrl_loop()</code> 中单独处理UDP控制包，即可完成控制/数据分治。</p>
<h2 data-id="heading-24">4. 什么是 RMT（Reconfigurable Match Table）</h2>
<p>RMT，全称 <strong>Reconfigurable Match Table（可重构匹配表）</strong> ，最早由斯坦福大学在 SDN（Software Defined Networking）架构中提出，用于抽象网络设备的<strong>数据平面可编程能力</strong>。</p>
<h3 data-id="heading-25">4.1 传统网络处理方式</h3>
<p>在传统 ASIC（固定逻辑）网络设备中，<strong>匹配 + 动作（Match + Action）</strong> 是固化的：</p>
<ul>
<li>只能匹配特定字段（如 MAC、IP、TCP 端口）。</li>
<li>动作集有限（如转发、丢弃、修改头部）。</li>
<li>一旦芯片逻辑定死，就无法修改。</li>
</ul>
<p>因此，当我们要引入新协议（VXLAN、Geneve、SRv6）或新处理逻辑时，就必须等芯片厂商推出新硬件。</p>
<hr/>
<h3 data-id="heading-26">4.2 RMT 的核心思想</h3>
<p>RMT 提出了一个通用抽象模型：  把<strong>数据包处理流程</strong>抽象为一系列可配置的「匹配+动作（Match-Action）」表组成的流水线（Pipeline）。</p>
<blockquote>
<p>每一级表：</p>
<ul>
<li>对输入包的某些字段进行匹配；</li>
<li>执行对应动作；</li>
<li>将结果（可能修改后的包）交给下一级表继续处理。</li>
</ul>
<p>硬件不再固定支持哪些协议或规则，而是提供「匹配表模板」，由软件定义匹配字段和动作逻辑。</p>
</blockquote>
<hr/>
<h3 data-id="heading-27">4.3 在 DPDK 中的意义</h3>
<p>虽然 DPDK 运行在软件层，但它与 RMT 思想天然契合。<br/>
例如：</p>
<ul>
<li><strong>rte_flow</strong> 定义的流表项（flow rule）→ 就是「Match + Action」模型；</li>
<li><strong>DOCA Flow、Mellanox mlx5、Intel ice PMD</strong> 都是把硬件的 Match-Action 能力开放出来。</li>
</ul>
<p>RMT 的提出，让我们可以从更抽象的层面理解：</p>
<blockquote>
<p>不同的网卡流分类机制，本质上只是匹配字段和动作集不同而已。</p>
</blockquote>
<hr/>
<h3 data-id="heading-28">4.4 可实践的代码示例：rte_flow 模拟 RMT</h3>
<p>在软件层，你可以通过 DPDK 的 <code>rte_flow</code> 接口，构建类似 RMT 的多级匹配规则。</p>
<p>例如，匹配 IPv4 源地址并重定向：</p>
<pre><code class="hljs language-ini" lang="ini">struct rte_flow_attr <span class="hljs-attr">attr</span> = { .ingress = <span class="hljs-number">1</span> }<span class="hljs-comment">;</span>
struct rte_flow_item pattern<span class="hljs-section">[3]</span><span class="hljs-comment">;</span>
struct rte_flow_action action<span class="hljs-section">[2]</span><span class="hljs-comment">;</span>

// 匹配 IPv4 源地址
struct rte_flow_item_ipv4 <span class="hljs-attr">ip_spec</span> = { .hdr.src_addr = RTE_BE32(<span class="hljs-number">0</span>xC0A80101) }<span class="hljs-comment">; // 192.168.1.1</span>
struct rte_flow_item_ipv4 <span class="hljs-attr">ip_mask</span> = { .hdr.src_addr = <span class="hljs-number">0</span>xFFFFFFFF }<span class="hljs-comment">;</span>
pattern<span class="hljs-section">[0]</span>.<span class="hljs-attr">type</span> = RTE_FLOW_ITEM_TYPE_IPV4<span class="hljs-comment">;</span>
pattern<span class="hljs-section">[0]</span>.<span class="hljs-attr">spec</span> = &amp;ip_spec<span class="hljs-comment">;</span>
pattern<span class="hljs-section">[0]</span>.<span class="hljs-attr">mask</span> = &amp;ip_mask<span class="hljs-comment">;</span>
pattern<span class="hljs-section">[1]</span>.<span class="hljs-attr">type</span> = RTE_FLOW_ITEM_TYPE_END<span class="hljs-comment">;</span>

// 动作：重定向到队列1
struct rte_flow_action_queue <span class="hljs-attr">queue</span> = { .index = <span class="hljs-number">1</span> }<span class="hljs-comment">;</span>
action<span class="hljs-section">[0]</span>.<span class="hljs-attr">type</span> = RTE_FLOW_ACTION_TYPE_QUEUE<span class="hljs-comment">;</span>
action<span class="hljs-section">[0]</span>.<span class="hljs-attr">conf</span> = &amp;queue<span class="hljs-comment">;</span>
action<span class="hljs-section">[1]</span>.<span class="hljs-attr">type</span> = RTE_FLOW_ACTION_TYPE_END<span class="hljs-comment">;</span>

struct rte_flow *<span class="hljs-attr">flow</span> = rte_flow_create(port_id, &amp;attr, pattern, action, &amp;error)<span class="hljs-comment">;</span>
</code></pre>
<p>这个简单示例本质上就是一个最小化的「RMT 一级表」：</p>
<ol>
<li>匹配 IPv4 地址 → 执行动作（重定向）。</li>
<li>多级匹配可以用多个 <code>rte_flow</code> pipeline 串联实现。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 useState 到 URLState：为什么大佬们都在删状态管理代码？]]></title>    <link>https://juejin.cn/post/7571126773808988170</link>    <guid>https://juejin.cn/post/7571126773808988170</guid>    <pubDate>2025-11-11T09:17:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571126773808988170" data-draft-id="7571279513246793754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 useState 到 URLState：为什么大佬们都在删状态管理代码？"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-11T09:17:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 useState 到 URLState：为什么大佬们都在删状态管理代码？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:17:26.000Z" title="Tue Nov 11 2025 09:17:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>当你打开这个网址时：</p>
<pre><code class="hljs language-plain" lang="plain">https://prismjs.com/download.html#themes=prism&amp;languages=markup+css+clike+javascript&amp;plugins=line-numbers
</code></pre>
<p>你会发现，所有你需要的主题、语言、插件已经被自动勾选：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/440237b179154fa19996d810fff3ef00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763457446&amp;x-signature=7pH71TFkjLgtncWsRf93PhzwmQE%3D" alt="" loading="lazy"/></p>
<p>当你在页面修改配置时，URL 也会随之改变。</p>
<p>你看，这个 URL 不仅仅是一个链接，更是一个<strong>完整的状态容器</strong>，保存了我的所有配置。无需数据库、cookie 或 localStorage，一个 URL 就解决了一切。</p>
<h2 data-id="heading-1">2. 被忽视的 URL 超能力</h2>
<p>URL 是互联网最伟大的创意之一，通过 URL 请求，我们可以查找到网络上的唯一资源。</p>
<p>它的标准格式为：<code>&lt;scheme&gt;://&lt;netloc&gt;/&lt;path&gt;?&lt;query&gt;#&lt;fragment&gt;</code>。</p>
<p>但 URL 的价值远不止于此——它们是<strong>天然的状态管理解决方案</strong>。想想 URL 给我们带来的好处：</p>
<ul>
<li><strong>可分享性</strong>：发送链接，对方会看到与你完全相同的内容</li>
<li><strong>可书签化</strong>：保存 URL 就是保存一个特定时刻的状态</li>
<li><strong>浏览器历史</strong>：后退按钮正常工作</li>
<li><strong>深度链接</strong>：直接跳转到应用的特定状态</li>
</ul>
<p>URL 使 Web 应用具有<strong>韧性和可预测性</strong>。它们是 Web 最初的状态管理方案，自 1990 年以来就开始使用，所以千万不要忘记使用这种方式。</p>
<h2 data-id="heading-2">3. URL 如何编码状态？</h2>
<p>URL 的不同部分编码不同类型的状态：</p>
<p><strong>路径段（/path/to/myfile.html）</strong>：最适合层次化资源导航</p>
<pre><code class="hljs language-plain" lang="plain">/users/123/posts        # 用户123的文章
/docs/api/authentication # 文档结构
</code></pre>
<p><strong>查询参数（?key1=value1&amp;key2=value2）</strong>：完美用于过滤器、选项和配置</p>
<pre><code class="hljs language-plain" lang="plain">?theme=dark&amp;lang=en     # UI 偏好设置
?page=2&amp;limit=20        # 分页
?status=active&amp;sort=date # 数据过滤
</code></pre>
<p><strong>锚点片段（#SomewhereInTheDocument）</strong>：适合客户端导航和页面部分</p>
<pre><code class="hljs language-plain" lang="plain">#L20-L35        # GitHub 行高亮
#features       # 滚动到某个章节
</code></pre>
<h2 data-id="heading-3">4. URL 编码状态常见模式</h2>
<h3 data-id="heading-4">4.1. 多个带分隔符的值</h3>
<pre><code class="hljs language-plain" lang="plain">?languages=javascript+typescript+python
?tags=frontend,react,hooks
</code></pre>
<p>这种方式简洁易读，但需要在服务器端手动解析。</p>
<h3 data-id="heading-5">4.2. 嵌套或结构化数据</h3>
<pre><code class="hljs language-plain" lang="plain">?filters=status:active,owner:me,priority:high
?config=eyJyaWNrIjoicm9sbCJ9==  (base64-encoded JSON)
</code></pre>
<p>开发者有时会将复杂的筛选器或配置对象编码到单个查询字符串中。</p>
<p>一种简单的约定是使用逗号分隔的键值对，而其他方法则会序列化 JSON，甚至为了安全起见对其进行 Base64 编码。</p>
<h3 data-id="heading-6">4.3. 数组处理（方括号表示法）</h3>
<pre><code class="hljs language-plain" lang="plain">?tags[]=frontend&amp;tags[]=react&amp;tags[]=hooks
?ids[0]=42&amp;ids[1]=73
</code></pre>
<p>一种古老的模式是方括号表示法，它用于在查询参数中表示数组。这种表示法起源于早期的 Web 框架，例如 PHP，在 <code>[]</code> 参数名称后添加括号表示多个值应该组合在一起。</p>
<p>许多现代框架和解析器（例如 Node 的 qs 库或 Express 中间件）仍然能够自动识别这种模式。然而，它并未在 URL 规范中正式标准化，因此其行为可能因服务器或客户端的实现而异。</p>
<h3 data-id="heading-7">4.4. 布尔处理</h3>
<p>对于 flag 或开关，通常会显式传递布尔值，或者依赖于键值是否为真。这样可以缩短 URL 长度，并简化功能切换。</p>
<pre><code class="hljs language-plain" lang="plain">?debug=true&amp;analytics=false
?mobile  (presence = true)
</code></pre>
<h3 data-id="heading-8">4.5. 结论</h3>
<p>使用哪种模式都是可以的，关键在于保持一致性。选择适合你应用场景的模式，并坚持使用。</p>
<h2 data-id="heading-9">5. 实际应用案例</h2>
<p><strong>GitHub 行高亮：</strong></p>
<pre><code class="hljs language-plain" lang="plain">https://github.com/zepouet/Xee-xCode-4.5/blob/master/XeePhotoshopLoader.m#L108-L136
</code></pre>
<p>链接到特定文件，同时高亮显示 108-136 行。点击此链接，你会直接定位到讨论的确切代码部分。</p>
<p><strong>电商数据过滤器：</strong></p>
<pre><code class="hljs language-plain" lang="plain">https://store.com/laptops?brand=dell+hp&amp;price=500-1500&amp;rating=4&amp;sort=price-asc
</code></pre>
<p>这是最常见的实现。每个过滤条件、排序选项都被保存。用户可以用书签保存他们的筛选条件。</p>
<p><strong>谷歌地图：</strong></p>
<pre><code class="hljs language-plain" lang="plain">https://www.google.com/maps/@22.443842,-74.220744,19z
</code></pre>
<p>坐标、缩放级别和地图类型都包含在 URL 中。分享此链接，任何人都可以看到完全相同的地图视图。</p>
<h2 data-id="heading-10">6. 什么状态应该放入 URL？</h2>
<p>然而<strong>并非所有状态都应该属于 URL，那什么样的状态应该放入 URL 呢？</strong></p>
<p><strong>适合 URL 状态：</strong></p>
<ul>
<li>搜索查询和筛选器</li>
<li>分页和排序</li>
<li>视图模式（列表/网格、深色/浅色）</li>
<li>日期范围和时间段</li>
<li>选中项或活动标签</li>
<li>影响内容的 UI 配置</li>
<li>功能开关和 A/B 测试版本</li>
</ul>
<p><strong>不适合 URL 状态：</strong></p>
<ul>
<li>敏感信息（密码、令牌、个人身份信息）</li>
<li>临时 UI 状态（模态框打开/关闭）</li>
<li>表单输入进行中（未保存的更改）</li>
<li>极其庞大或复杂的嵌套数据</li>
<li>高频瞬态（鼠标位置、滚轮位置）</li>
</ul>
<p>简单来说，你的判断标准是：</p>
<p><strong>如果别人点击这个 URL，他们应该看到相同的状态吗？</strong></p>
<p>如果是，它就属于 URL。</p>
<h2 data-id="heading-11">7. 实现方案</h2>
<h3 data-id="heading-12">7.1. 使用纯 JavaScript 实现</h3>
<p>现代 URLSearchParams API 使 URL 状态管理变得简单：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 读取URL参数</span>
<span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
<span class="hljs-keyword">const</span> view = params.<span class="hljs-title function_">get</span>(<span class="hljs-string">"view"</span>) || <span class="hljs-string">"grid"</span>; <span class="hljs-comment">// 默认值</span>
<span class="hljs-keyword">const</span> page = <span class="hljs-built_in">parseInt</span>(params.<span class="hljs-title function_">get</span>(<span class="hljs-string">"page"</span>)) || <span class="hljs-number">1</span>;

<span class="hljs-comment">// 更新URL参数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateFilters</span>(<span class="hljs-params">filters</span>) {
  <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);

  params.<span class="hljs-title function_">set</span>(<span class="hljs-string">"status"</span>, filters.<span class="hljs-property">status</span>);
  params.<span class="hljs-title function_">set</span>(<span class="hljs-string">"sort"</span>, filters.<span class="hljs-property">sort</span>);

  <span class="hljs-comment">// 更新URL而不重新加载页面</span>
  <span class="hljs-keyword">const</span> newUrl = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.location.pathname}</span>?<span class="hljs-subst">${params.toString()}</span>`</span>;
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({}, <span class="hljs-string">""</span>, newUrl);
}

<span class="hljs-comment">// 处理后/前进按钮</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"popstate"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
  <span class="hljs-keyword">const</span> filters = {
    <span class="hljs-attr">status</span>: params.<span class="hljs-title function_">get</span>(<span class="hljs-string">"status"</span>) || <span class="hljs-string">"all"</span>,
    <span class="hljs-attr">sort</span>: params.<span class="hljs-title function_">get</span>(<span class="hljs-string">"sort"</span>) || <span class="hljs-string">"date"</span>,
  };
  <span class="hljs-title function_">renderContent</span>(filters);
});
</code></pre>
<h3 data-id="heading-13">7.2. 使用 React 实现</h3>
<p>React Router 提供了更简洁的钩子：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useSearchParams } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [searchParams, setSearchParams] = <span class="hljs-title function_">useSearchParams</span>();

  <span class="hljs-keyword">const</span> color = searchParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">"color"</span>) || <span class="hljs-string">"all"</span>;
  <span class="hljs-keyword">const</span> sort = searchParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">"sort"</span>) || <span class="hljs-string">"price"</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleColorChange</span> = (<span class="hljs-params">newColor</span>) =&gt; {
    <span class="hljs-title function_">setSearchParams</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(prev);
      params.<span class="hljs-title function_">set</span>(<span class="hljs-string">"color"</span>, newColor);
      <span class="hljs-keyword">return</span> params;
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{color}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> handleColorChange(e.target.value)}&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"all"</span>&gt;</span>所有颜色<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"silver"</span>&gt;</span>银色<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-14">8. URL 使用最佳实践</h2>
<h3 data-id="heading-15">8.1. <strong>优雅处理默认值</strong></h3>
<p>不要在 URL 中使用默认值：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ❌</span>
?theme=light&amp;lang=en&amp;page=<span class="hljs-number">1</span>&amp;sort=date

<span class="hljs-comment">// ✅</span>
?theme=dark  <span class="hljs-comment">// light 是默认的，但 dark 不是默认的</span>
</code></pre>
<p>在代码中读取参数时使用默认值：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getTheme</span>(<span class="hljs-params">params</span>) {
  <span class="hljs-keyword">return</span> params.<span class="hljs-title function_">get</span>(<span class="hljs-string">"theme"</span>) || <span class="hljs-string">"light"</span>; <span class="hljs-comment">// 在代码中设置默认值</span>
}
</code></pre>
<h3 data-id="heading-16">8.2. URL 更新防抖动</h3>
<p>对于高频更新（例如边输入边搜索），要对 URL 更改进行防抖处理：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { debounce } <span class="hljs-keyword">from</span> <span class="hljs-string">"lodash"</span>;

<span class="hljs-keyword">const</span> updateSearchParam = <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
  <span class="hljs-keyword">if</span> (value) {
    params.<span class="hljs-title function_">set</span>(<span class="hljs-string">"q"</span>, value);
  } <span class="hljs-keyword">else</span> {
    params.<span class="hljs-title function_">delete</span>(<span class="hljs-string">"q"</span>);
  }
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">replaceState</span>({}, <span class="hljs-string">""</span>, <span class="hljs-string">`?<span class="hljs-subst">${params.toString()}</span>`</span>);
}, <span class="hljs-number">300</span>);
</code></pre>
<h3 data-id="heading-17">8.3. URL 传达意义</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-attr">https</span>:<span class="hljs-comment">//example.com/p?id=x7f2k&amp;v=3 ❌</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//example.com/products/laptop?color=silver&amp;sort=price ✅</span>
</code></pre>
<p>第一个链接隐藏了意图，第二个链接则意义清晰。人可以阅读它并理解其含义。机器可以解析它并提取有意义的结构。这才是优秀的 URL。</p>
<h2 data-id="heading-18">9. 使用时要避免的反模式</h2>
<h3 data-id="heading-19">9.1. 状态都保存在内存中的单页应用程序</h3>
<pre><code class="hljs language-plain" lang="plain">// 用户一刷新，状态都丢失了
const [filters, setFilters] = useState({});
</code></pre>
<p>如果你的应用在刷新后丢失了之前的状态，你就破坏了网络的一项基本功能。用户期望 URL 能够保留上下文。</p>
<h3 data-id="heading-20">9.2. 包含敏感数据</h3>
<pre><code class="hljs language-plain" lang="plain">// 别这样干
?password=secret123
</code></pre>
<h3 data-id="heading-21">9.3. 命名不一致或晦涩难懂</h3>
<pre><code class="hljs language-plain" lang="plain">// 晦涩难懂
?foo=true&amp;bar=2&amp;x=dark

// 自文档化且风格保持一致
?mobile=true&amp;page=2&amp;theme=dark
</code></pre>
<h3 data-id="heading-22">9.4. 注意 URL 长度限制</h3>
<p>浏览器和服务器对 URL 长度都有实际的限制（通常在 2000 到 8000 个字符之间），但实际情况更为复杂，会有来自浏览器行为、服务器配置、CDN 甚至搜索引擎的限制等多种因素。</p>
<p>如果你遇到了这些限制，那就说明你需要重新考虑你的策略了。</p>
<h2 data-id="heading-23">10. 总结</h2>
<p>好的 URL 不仅仅是指向内容，它更是描述了用户和应用程序之间的对话。</p>
<p>我们已经构建了复杂的状态管理库，但有时最好的解决方案其实是最简单的那一个。<strong>当你的应用在点击刷新时失去了状态，想一想，你是否错过了这个 Web 最古老、最优雅的特性？</strong></p>
<h2 data-id="heading-24">11. 参考链接</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Falfy.blog%2F2025%2F10%2F31%2Fyour-url-is-your-state.html" target="_blank" title="https://alfy.blog/2025/10/31/your-url-is-your-state.html" ref="nofollow noopener noreferrer">Your URL Is Your State</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[限流算法实现]]></title>    <link>https://juejin.cn/post/7571102074038435881</link>    <guid>https://juejin.cn/post/7571102074038435881</guid>    <pubDate>2025-11-11T09:09:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571102074038435881" data-draft-id="7565716907011014697" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="限流算法实现"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T09:09:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GKunLi"/> <meta itemprop="url" content="https://juejin.cn/user/430664725579725"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            限流算法实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664725579725/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GKunLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:09:12.000Z" title="Tue Nov 11 2025 09:09:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>由于 API 接口无法控制调用方的行为，因此当遇到瞬时请求量激增时，会导致接口占用过多服务器资源，使得其他请求响应速度降低或是超时，更有甚者可能导致服务器宕机。</p>
</blockquote>
<blockquote>
<p>限流(Ratelimiting)指对应用服务的请求进行限制，例如某一接口的请求限制为 100 个每秒,对超过限制的请求则进行快速失败或丢弃。</p>
</blockquote>
<h3 data-id="heading-0">拦截器 vs 过滤器在限流中的使用选择</h3>
<h4 data-id="heading-1">过滤器（Filter）更合理的理由：</h4>
<ol>
<li>
<p><strong>执行时机更早</strong></p>
<ul>
<li><code>Filter</code> 在请求进入Spring MVC框架之前执行</li>
<li>能够更早地拦截和拒绝过多请求，节省框架初始化开销</li>
</ul>
</li>
<li>
<p><strong>更底层的控制</strong></p>
<ul>
<li>基于Servlet规范，不依赖Spring MVC框架</li>
<li>可以拦截所有类型的请求（包括静态资源）</li>
</ul>
</li>
<li>
<p><strong>性能优势</strong></p>
<ul>
<li>避免不必要的Spring上下文初始化</li>
<li>减少请求处理链路长度</li>
</ul>
</li>
<li>
<p><strong>适用场景匹配</strong></p>
<ul>
<li>适合做通用的基础设施功能（如限流、安全检查）</li>
<li>对所有HTTP请求进行统一处理</li>
</ul>
</li>
</ol>
<h4 data-id="heading-2">拦截器（Interceptor）的局限性：</h4>
<ol>
<li>
<p><strong>执行时机较晚</strong></p>
<ul>
<li>在<code>DispatcherServlet</code>之后执行</li>
<li>已经完成了部分Spring MVC框架的初始化工作</li>
</ul>
</li>
<li>
<p><strong>依赖Spring MVC</strong></p>
<ul>
<li>只能处理经过Spring MVC的请求</li>
<li>无法处理静态资源等非Controller请求</li>
</ul>
</li>
</ol>
<h4 data-id="heading-3">结论</h4>
<p>对于<strong>固定窗口限流</strong>这种基础设施级别的功能，<strong>过滤器更为合理</strong>，因为：</p>
<ul>
<li>能够在最早阶段拒绝过多请求</li>
<li>不依赖具体的应用框架</li>
<li>性能开销更小</li>
<li>控制粒度更粗，适合全局限流策略</li>
</ul>
<p><strong>使用redis作为中间件</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Spring Boot Starter Data Redis --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2 data-id="heading-4">固定窗口计数器算法</h2>
<p><strong>固定窗口其实就是时间窗口，其原理是将时间划分为固定大小的窗口，在每个窗口内限制请求的数量或速率，即固定窗口计数器算法规定了系统单位时间处理的请求数量。</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 限流器接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RateLimiter</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span>;
}
</code></pre>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">import</span> com.example.demo.infrastructure.RateLimiter;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Collections;

<span class="hljs-comment">/**
 * 基于 Redis 的固定窗口限流器
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component("redisRateLimiter")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisFixedWindowRateLimiter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RateLimiter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> failOpen;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String keyPrefix;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LUA_SCRIPT</span> <span class="hljs-operator">=</span>
            <span class="hljs-string">"local key = KEYS[1]\n"</span> +
                    <span class="hljs-string">"local limit = tonumber(ARGV[1])\n"</span> +
                    <span class="hljs-string">"local window_ms = tonumber(ARGV[2])\n"</span> +
                    <span class="hljs-string">"local current = redis.call('INCR', key)\n"</span> +
                    <span class="hljs-string">"if current == 1 then\n"</span> +
                    <span class="hljs-string">"    redis.call('PEXPIRE', key, window_ms)\n"</span> +
                    <span class="hljs-string">"end\n"</span> +
                    <span class="hljs-string">"if current &lt;= limit then\n"</span> +
                    <span class="hljs-string">"    return 1\n"</span> +
                    <span class="hljs-string">"else\n"</span> +
                    <span class="hljs-string">"    return 0\n"</span> +
                    <span class="hljs-string">"end"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; redisScript;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisFixedWindowRateLimiter</span><span class="hljs-params">(
            StringRedisTemplate stringRedisTemplate,
            <span class="hljs-meta">@Value("${rate.limit.fail-open:false}")</span> <span class="hljs-type">boolean</span> failOpen,
            <span class="hljs-meta">@Value("${rate.limit.redis.key-prefix:myapp:rl}")</span> String keyPrefix)</span> {
        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;
        <span class="hljs-built_in">this</span>.failOpen = failOpen;
        <span class="hljs-built_in">this</span>.keyPrefix = keyPrefix;
        <span class="hljs-built_in">this</span>.redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(LUA_SCRIPT, Long.class);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span> {
        <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || key.isEmpty() || limit &lt;= <span class="hljs-number">0</span> || windowMs &lt;= <span class="hljs-number">0</span>) {
            log.warn(<span class="hljs-string">"Invalid rate limit params: key={}, limit={}, windowMs={}"</span>, key, limit, windowMs);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-comment">// 防止窗口过小导致 TTL=0</span>
        <span class="hljs-keyword">if</span> (windowMs &lt; <span class="hljs-number">10</span>) {
            log.warn(<span class="hljs-string">"Window too small: {}ms, using 10ms"</span>, windowMs);
            windowMs = <span class="hljs-number">10</span>;
        }

        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> keyPrefix + <span class="hljs-string">":"</span> + key + <span class="hljs-string">":"</span> + (System.currentTimeMillis() / windowMs);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(
                    redisScript,
                    Collections.singletonList(redisKey),
                    String.valueOf(limit),
                    String.valueOf(windowMs)
            );
            <span class="hljs-type">boolean</span> <span class="hljs-variable">allowed</span> <span class="hljs-operator">=</span> result != <span class="hljs-literal">null</span> &amp;&amp; result == <span class="hljs-number">1L</span>;
            <span class="hljs-keyword">if</span> (!allowed) {
                log.warn(<span class="hljs-string">"Rate limit exceeded | key={}"</span>, key);
            }
            <span class="hljs-keyword">return</span> allowed;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Redis rate limiter error | key={}"</span>, key, e);
            <span class="hljs-keyword">return</span> failOpen;
        }
    }
}
</code></pre>
<h2 data-id="heading-5">滑动窗口计数算法</h2>
<p><strong>滑动窗口限流算法（Sliding Window Rate Limiting Algorithm） 是一种用于控制系统单位时间内请求频率的流量控制机制。它将时间划分为连续、动态移动的时间窗口，通过统计当前窗口内已发生的请求数量（或估算值），并与预设阈值比较，从而决定是否允许新请求通过</strong></p>
<pre><code class="hljs language-图示" lang="图示">         上一窗口                  当前窗口
|----------|----------|----------|----------|
          ↑                     ↑
   1672531200000         1672531201000      now→1672531201500

prev_count = 80        current_count = 60
               ←─────── offset = 500ms ───────┘
weight = 0.5 → 只算 prev_count 的一半 → 40
             total = 60 + 40 = 100 ≤ limit(100) → 放行
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 限流器接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RateLimiter</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span>;
}
</code></pre>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Arrays;

<span class="hljs-comment">/**
 * 基于 Redis 的滑动窗口计数器限流器、
 * &lt;p&gt;
 * 算法：Sliding Window Counter（非日志型，避免高内存消耗）
 * 特点：
 * - 使用两个 Redis Key：当前窗口 + 上一窗口
 * - Lua 脚本原子计算估算请求数
 * - 支持毫秒级窗口
 * - 自动清理过期窗口
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component("slidingWindowRateLimiter")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisSlidingWindowRateLimiter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RateLimiter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> failOpen;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String keyPrefix;

    <span class="hljs-comment">// Lua 脚本：实现滑动窗口计数逻辑</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LUA_SCRIPT</span> <span class="hljs-operator">=</span>
            <span class="hljs-string">"-- KEYS[1]: current window key\n"</span> +
                    <span class="hljs-string">"-- KEYS[2]: previous window key\n"</span> +
                    <span class="hljs-string">"-- ARGV[1]: limit\n"</span> +
                    <span class="hljs-string">"-- ARGV[2]: window_ms (毫秒)\n"</span> +
                    <span class="hljs-string">"-- ARGV[3]: current_time_ms\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"local current_key = KEYS[1]\n"</span> +
                    <span class="hljs-string">"local prev_key = KEYS[2]\n"</span> +
                    <span class="hljs-string">"local limit = tonumber(ARGV[1])\n"</span> +
                    <span class="hljs-string">"local window_ms = tonumber(ARGV[2])\n"</span> +
                    <span class="hljs-string">"local now = tonumber(ARGV[3])\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 获取当前窗口和上一窗口的计数\n"</span> +
                    <span class="hljs-string">"local current_count = redis.call('GET', current_key)\n"</span> +
                    <span class="hljs-string">"local prev_count = redis.call('GET', prev_key)\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"current_count = current_count and tonumber(current_count) or 0\n"</span> +
                    <span class="hljs-string">"prev_count = prev_count and tonumber(prev_count) or 0\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 计算窗口偏移量（当前时间在窗口中的位置）\n"</span> +
                    <span class="hljs-string">"local window_start = now - (now % window_ms)\n"</span> +
                    <span class="hljs-string">"local offset = now - window_start  -- [0, window_ms)\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 估算总请求数：当前窗口 + 上一窗口 * (1 - offset/window_ms)\n"</span> +
                    <span class="hljs-string">"local weight = (window_ms - offset) / window_ms\n"</span> +
                    <span class="hljs-string">"local estimated = current_count + (prev_count * weight)\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 如果超过限制，拒绝\n"</span> +
                    <span class="hljs-string">"if estimated &gt;= limit then\n"</span> +
                    <span class="hljs-string">"    return 0\n"</span> +
                    <span class="hljs-string">"end\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 允许请求：增加当前窗口计数，并设置 TTL\n"</span> +
                    <span class="hljs-string">"redis.call('INCR', current_key)\n"</span> +
                    <span class="hljs-string">"redis.call('PEXPIRE', current_key, window_ms * 2)  -- 保留两个窗口周期\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"return 1"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; redisScript;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisSlidingWindowRateLimiter</span><span class="hljs-params">(
            StringRedisTemplate stringRedisTemplate,
            <span class="hljs-meta">@Value("${rate.limit.fail-open:false}")</span> <span class="hljs-type">boolean</span> failOpen,
            <span class="hljs-meta">@Value("${rate.limit.redis.key-prefix:myapp:rl}")</span> String keyPrefix)</span> {
        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;
        <span class="hljs-built_in">this</span>.failOpen = failOpen;
        <span class="hljs-built_in">this</span>.keyPrefix = keyPrefix;
        <span class="hljs-built_in">this</span>.redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(LUA_SCRIPT, Long.class);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span> {
        <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || key.isEmpty() || limit &lt;= <span class="hljs-number">0</span> || windowMs &lt;= <span class="hljs-number">0</span>) {
            log.warn(<span class="hljs-string">"Invalid rate limit params: key={}, limit={}, windowMs={}"</span>, key, limit, windowMs);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">if</span> (windowMs &lt; <span class="hljs-number">10</span>) {
            log.warn(<span class="hljs-string">"Window too small: {}ms, using 10ms"</span>, windowMs);
            windowMs = <span class="hljs-number">10</span>;
        }

        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-comment">// 当前窗口编号</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">windowSlot</span> <span class="hljs-operator">=</span> now / windowMs;

        <span class="hljs-type">String</span> <span class="hljs-variable">currentKey</span> <span class="hljs-operator">=</span> buildKey(key, windowSlot);
        <span class="hljs-type">String</span> <span class="hljs-variable">prevKey</span> <span class="hljs-operator">=</span> buildKey(key, windowSlot - <span class="hljs-number">1</span>);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(
                    redisScript,
                    Arrays.asList(currentKey, prevKey),
                    String.valueOf(limit),
                    String.valueOf(windowMs),
                    String.valueOf(now)
            );

            <span class="hljs-type">boolean</span> <span class="hljs-variable">allowed</span> <span class="hljs-operator">=</span> result != <span class="hljs-literal">null</span> &amp;&amp; result == <span class="hljs-number">1L</span>;
            <span class="hljs-keyword">if</span> (!allowed) {
                log.warn(<span class="hljs-string">"Sliding window rate limit exceeded | key={}"</span>, key);
            }
            <span class="hljs-keyword">return</span> allowed;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Redis sliding window rate limiter error | key={}"</span>, key, e);
            <span class="hljs-keyword">return</span> failOpen;
        }
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildKey</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> slot)</span> {
        <span class="hljs-keyword">return</span> keyPrefix + <span class="hljs-string">":sw:"</span> + key + <span class="hljs-string">":"</span> + slot;
    }
}
</code></pre>
<h2 data-id="heading-6">漏桶算法</h2>
<p><strong>漏桶算法（Leaky Bucket Algorithm） 是一种流量整形与限流机制，它将请求比作“水滴”注入一个固定容量的“桶”中，桶以恒定速率“漏水”（即处理请求）；当桶满时，新请求被丢弃或拒绝，从而平滑突发流量、确保系统以稳定速率处理请求。</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 限流器接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RateLimiter</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span>;
}

limit → 桶容量（capacity）
rate = <span class="hljs-number">1000</span> / windowMs → 每秒处理速率（req/s）
例如：tryAcquire(<span class="hljs-string">"api"</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1000</span>) 表示 桶容量=<span class="hljs-number">5</span>，每秒匀速处理<span class="hljs-number">1</span>个请求。
</code></pre>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Collections;

<span class="hljs-comment">/**
 * 基于 Redis 的漏桶限流算法（Leaky Bucket）实现
 * &lt;p&gt;
 * 特点：
 * - 恒定输出速率，平滑突发流量
 * - 使用惰性漏水策略（Lazy Leaking）
 * - Lua 脚本保证原子性
 * - 支持毫秒级精度
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component("leakyBucketRateLimiter")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisLeakyBucketRateLimiter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RateLimiter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> failOpen;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String keyPrefix;

    <span class="hljs-comment">// Lua 脚本：实现漏桶惰性漏水逻辑</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LUA_SCRIPT</span> <span class="hljs-operator">=</span>
            <span class="hljs-string">"-- KEYS[1]: bucket key\n"</span> +
                    <span class="hljs-string">"-- ARGV[1]: capacity (桶容量)\n"</span> +
                    <span class="hljs-string">"-- ARGV[2]: rate_per_sec (每秒处理请求数)\n"</span> +
                    <span class="hljs-string">"-- ARGV[3]: current_time_ms\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"local key = KEYS[1]\n"</span> +
                    <span class="hljs-string">"local capacity = tonumber(ARGV[1])\n"</span> +
                    <span class="hljs-string">"local rate = tonumber(ARGV[2])\n"</span> +
                    <span class="hljs-string">"local now = tonumber(ARGV[3])\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 获取当前桶状态: \"water:last_leak_time\"\n"</span> +
                    <span class="hljs-string">"local bucket = redis.call('GET', key)\n"</span> +
                    <span class="hljs-string">"local water = 0\n"</span> +
                    <span class="hljs-string">"local last_leak_time = now\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"if bucket then\n"</span> +
                    <span class="hljs-string">"    local parts = {}\n"</span> +
                    <span class="hljs-string">"    for part in string.gmatch(bucket, \"([^:]+)\") do\n"</span> +
                    <span class="hljs-string">"        table.insert(parts, part)\n"</span> +
                    <span class="hljs-string">"    end\n"</span> +
                    <span class="hljs-string">"    water = tonumber(parts[1]) or 0\n"</span> +
                    <span class="hljs-string">"    last_leak_time = tonumber(parts[2]) or now\n"</span> +
                    <span class="hljs-string">"end\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 惰性漏水：计算应漏出的水量\n"</span> +
                    <span class="hljs-string">"local delta = now - last_leak_time\n"</span> +
                    <span class="hljs-string">"if delta &gt; 0 and rate &gt; 0 then\n"</span> +
                    <span class="hljs-string">"    local leaked = math.floor((delta * rate) / 1000)\n"</span> +
                    <span class="hljs-string">"    water = math.max(0, water - leaked)\n"</span> +
                    <span class="hljs-string">"    last_leak_time = now\n"</span> +
                    <span class="hljs-string">"end\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 尝试加入新请求\n"</span> +
                    <span class="hljs-string">"if water + 1 &lt;= capacity then\n"</span> +
                    <span class="hljs-string">"    water = water + 1\n"</span> +
                    <span class="hljs-string">"    -- 更新桶状态，并设置合理 TTL（防止永久残留）\n"</span> +
                    <span class="hljs-string">"    redis.call('SET', key, water .. ':' .. last_leak_time, 'PX', 86400000) -- 24h\n"</span> +
                    <span class="hljs-string">"    return 1\n"</span> +
                    <span class="hljs-string">"else\n"</span> +
                    <span class="hljs-string">"    return 0\n"</span> +
                    <span class="hljs-string">"end"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; redisScript;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisLeakyBucketRateLimiter</span><span class="hljs-params">(
            StringRedisTemplate stringRedisTemplate,
            <span class="hljs-meta">@Value("${rate.limit.fail-open:false}")</span> <span class="hljs-type">boolean</span> failOpen,
            <span class="hljs-meta">@Value("${rate.limit.redis.key-prefix:myapp:rl}")</span> String keyPrefix)</span> {
        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;
        <span class="hljs-built_in">this</span>.failOpen = failOpen;
        <span class="hljs-built_in">this</span>.keyPrefix = keyPrefix;
        <span class="hljs-built_in">this</span>.redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(LUA_SCRIPT, Long.class);
    }

    <span class="hljs-comment">/**
     * 语义映射：
     * - limit → 桶容量（capacity）
     * - windowMs → 处理一个请求所需毫秒数 → rate = 1000 / windowMs (req/s)
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span> {
        <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || key.isEmpty() || limit &lt;= <span class="hljs-number">0</span> || windowMs &lt;= <span class="hljs-number">0</span>) {
            log.warn(<span class="hljs-string">"Invalid leaky bucket params: key={}, capacity={}, processTimeMs={}"</span>, key, limit, windowMs);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-comment">// 桶容量</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">capacity</span> <span class="hljs-operator">=</span> limit;
        <span class="hljs-comment">// 每秒处理请求数</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">ratePerSec</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000.0</span> / windowMs;

        <span class="hljs-comment">// 防止 rate 过大导致精度问题</span>
        <span class="hljs-keyword">if</span> (ratePerSec &gt; <span class="hljs-number">10000</span>) {
            log.warn(<span class="hljs-string">"Rate too high: {} req/s, capped at 10000"</span>, ratePerSec);
            ratePerSec = <span class="hljs-number">10000</span>;
        }

        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> keyPrefix + <span class="hljs-string">":lb:"</span> + key;
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(
                    redisScript,
                    Collections.singletonList(redisKey),
                    String.valueOf(capacity),
                    String.valueOf(Math.round(ratePerSec)), <span class="hljs-comment">// 取整避免 Lua 浮点问题</span>
                    String.valueOf(now)
            );

            <span class="hljs-type">boolean</span> <span class="hljs-variable">allowed</span> <span class="hljs-operator">=</span> result != <span class="hljs-literal">null</span> &amp;&amp; result == <span class="hljs-number">1L</span>;
            <span class="hljs-keyword">if</span> (!allowed) {
                log.warn(<span class="hljs-string">"Leaky bucket overflow | key={}"</span>, key);
            }
            <span class="hljs-keyword">return</span> allowed;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Redis leaky bucket error | key={}"</span>, key, e);
            <span class="hljs-keyword">return</span> failOpen;
        }
    }
}

</code></pre>
<h2 data-id="heading-7">令牌桶算法</h2>
<p><strong>令牌桶算法（Token Bucket Algorithm） 是一种流量控制机制，它以恒定速率向一个固定容量的“桶”中添加令牌，每个请求需消耗一个令牌才能被处理；当桶中有足够令牌时，请求可立即通过（支持突发流量），若桶空则请求被限流。该算法既能限制平均请求速率，又能允许一定程度的突发流量，兼具灵活性与稳定性。</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 限流器接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RateLimiter</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span>;
}
limit → 桶容量（capacity）
windowMs → 生成 limit 个令牌所需时间（毫秒）
⇒ 令牌生成速率 rate = limit / (windowMs / <span class="hljs-number">1000</span>) = (limit * <span class="hljs-number">1000</span>) / windowMs （单位：tokens/sec）
💡 示例：tryAcquire(<span class="hljs-string">"api"</span>, <span class="hljs-number">10</span>, <span class="hljs-number">1000</span>) 表示：
桶容量=<span class="hljs-number">10</span>，每秒生成<span class="hljs-number">10</span>个令牌（即 <span class="hljs-number">10</span> QPS），允许瞬间<span class="hljs-number">10</span>个请求通过
</code></pre>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Collections;

<span class="hljs-comment">/**
 * 基于 Redis 的令牌桶限流算法（Token Bucket）实现
 * &lt;p&gt;
 * 特点：
 * - 支持突发流量（桶内有令牌即可立即通过）
 * - 恒定速率补充令牌
 * - 惰性计算令牌（Lazy Token Refill）
 * - Lua 脚本保证原子性
 * - 符合阿里生产规范
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component("tokenBucketRateLimiter")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisTokenBucketRateLimiter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RateLimiter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> failOpen;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String keyPrefix;

    <span class="hljs-comment">// Lua 脚本：实现令牌桶惰性补充逻辑</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LUA_SCRIPT</span> <span class="hljs-operator">=</span>
            <span class="hljs-string">"-- KEYS[1]: token bucket key\n"</span> +
                    <span class="hljs-string">"-- ARGV[1]: capacity (桶容量)\n"</span> +
                    <span class="hljs-string">"-- ARGV[2]: rate_per_sec (每秒生成令牌数)\n"</span> +
                    <span class="hljs-string">"-- ARGV[3]: current_time_ms\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"local key = KEYS[1]\n"</span> +
                    <span class="hljs-string">"local capacity = tonumber(ARGV[1])\n"</span> +
                    <span class="hljs-string">"local rate = tonumber(ARGV[2])\n"</span> +
                    <span class="hljs-string">"local now = tonumber(ARGV[3])\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 获取当前桶状态: \"tokens:last_refill_time\"\n"</span> +
                    <span class="hljs-string">"local bucket = redis.call('GET', key)\n"</span> +
                    <span class="hljs-string">"local tokens = capacity\n"</span> +
                    <span class="hljs-string">"local last_refill = now\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"if bucket then\n"</span> +
                    <span class="hljs-string">"    local parts = {}\n"</span> +
                    <span class="hljs-string">"    for part in string.gmatch(bucket, \"([^:]+)\") do\n"</span> +
                    <span class="hljs-string">"        table.insert(parts, part)\n"</span> +
                    <span class="hljs-string">"    end\n"</span> +
                    <span class="hljs-string">"    tokens = tonumber(parts[1]) or capacity\n"</span> +
                    <span class="hljs-string">"    last_refill = tonumber(parts[2]) or now\n"</span> +
                    <span class="hljs-string">"end\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 惰性补充令牌\n"</span> +
                    <span class="hljs-string">"local delta = now - last_refill\n"</span> +
                    <span class="hljs-string">"if delta &gt; 0 and rate &gt; 0 then\n"</span> +
                    <span class="hljs-string">"    local new_tokens = math.floor((delta * rate) / 1000)\n"</span> +
                    <span class="hljs-string">"    tokens = math.min(capacity, tokens + new_tokens)\n"</span> +
                    <span class="hljs-string">"    last_refill = now\n"</span> +
                    <span class="hljs-string">"end\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 尝试获取1个令牌\n"</span> +
                    <span class="hljs-string">"if tokens &gt;= 1 then\n"</span> +
                    <span class="hljs-string">"    tokens = tokens - 1\n"</span> +
                    <span class="hljs-string">"    redis.call('SET', key, tokens .. ':' .. last_refill, 'PX', 86400000) -- TTL 24h\n"</span> +
                    <span class="hljs-string">"    return 1\n"</span> +
                    <span class="hljs-string">"else\n"</span> +
                    <span class="hljs-string">"    return 0\n"</span> +
                    <span class="hljs-string">"end"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; redisScript;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisTokenBucketRateLimiter</span><span class="hljs-params">(
            StringRedisTemplate stringRedisTemplate,
            <span class="hljs-meta">@Value("${rate.limit.fail-open:false}")</span> <span class="hljs-type">boolean</span> failOpen,
            <span class="hljs-meta">@Value("${rate.limit.redis.key-prefix:myapp:rl}")</span> String keyPrefix)</span> {
        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;
        <span class="hljs-built_in">this</span>.failOpen = failOpen;
        <span class="hljs-built_in">this</span>.keyPrefix = keyPrefix;
        <span class="hljs-built_in">this</span>.redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(LUA_SCRIPT, Long.class);
    }

    <span class="hljs-comment">/**
     * 语义映射：
     * - limit → 桶容量（capacity）
     * - windowMs → 生成 limit 个令牌所需时间（毫秒）
     *   ⇒ rate = (limit * 1000) / windowMs （tokens/sec）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span> {
        <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || key.isEmpty() || limit &lt;= <span class="hljs-number">0</span> || windowMs &lt;= <span class="hljs-number">0</span>) {
            log.warn(<span class="hljs-string">"Invalid token bucket params: key={}, capacity={}, refillWindowMs={}"</span>, key, limit, windowMs);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-type">long</span> <span class="hljs-variable">capacity</span> <span class="hljs-operator">=</span> limit;
        <span class="hljs-type">double</span> <span class="hljs-variable">ratePerSec</span> <span class="hljs-operator">=</span> (limit * <span class="hljs-number">1000.0</span>) / windowMs;

        <span class="hljs-comment">// 防止速率过高导致精度问题或 Redis 压力</span>
        <span class="hljs-keyword">if</span> (ratePerSec &gt; <span class="hljs-number">100000</span>) {
            log.warn(<span class="hljs-string">"Token rate too high: {} tokens/s, capped at 100000"</span>, ratePerSec);
            ratePerSec = <span class="hljs-number">100000</span>;
        }

        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> keyPrefix + <span class="hljs-string">":tb:"</span> + key;
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(
                    redisScript,
                    Collections.singletonList(redisKey),
                    String.valueOf(capacity),
                    String.valueOf(Math.round(ratePerSec)), <span class="hljs-comment">// 取整避免 Lua 浮点误差</span>
                    String.valueOf(now)
            );

            <span class="hljs-type">boolean</span> <span class="hljs-variable">allowed</span> <span class="hljs-operator">=</span> result != <span class="hljs-literal">null</span> &amp;&amp; result == <span class="hljs-number">1L</span>;
            <span class="hljs-keyword">if</span> (!allowed) {
                log.warn(<span class="hljs-string">"Token bucket exhausted | key={}"</span>, key);
            }
            <span class="hljs-keyword">return</span> allowed;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Redis token bucket error | key={}"</span>, key, e);
            <span class="hljs-keyword">return</span> failOpen;
        }
    }
}
</code></pre>


















































<table><thead><tr><th>算法</th><th>核心思想</th><th>是否支持突发流量</th><th>输出是否匀速</th><th>内存/计算开销</th><th>精度</th><th>典型适用场景</th></tr></thead><tbody><tr><td>固定窗口（Fixed Window）</td><td>将时间划分为固定长度窗口，统计窗口内请求数</td><td>✅ 是（窗口切换时可能双倍突发）</td><td>❌ 否</td><td>⭐ 极低（仅计数器）</td><td>⭐ 低（存在边界突刺）</td><td>- 对精度要求不高的粗略限流- 内部系统简单防护</td></tr><tr><td>滑动窗口（Sliding Window）</td><td>动态移动的时间窗口，精确统计最近 N 毫秒内请求量</td><td>✅ 是</td><td>❌ 否</td><td>⭐⭐ 中（需维护多个窗口或日志）</td><td>⭐⭐⭐ 高</td><td>- API 网关 QPS 控制- 开放平台接口限流- 防刷、防爬场景</td></tr><tr><td>漏桶（Leaky Bucket）</td><td>请求入桶，以恒定速率“漏水”处理；桶满则丢弃</td><td>❌ 否</td><td>✅ 是</td><td>⭐⭐ 中（需记录水量和时间）</td><td>⭐⭐ 中</td><td>- 流量整形（Traffic Shaping）- 保护下游系统免受突发冲击- 消息队列匀速消费</td></tr><tr><td>令牌桶（Token Bucket）</td><td>以恒定速率生成令牌，请求消耗令牌；桶空则拒绝</td><td>✅ 是（只要桶中有令牌）</td><td>❌ 否</td><td>⭐⭐ 中（需记录令牌数和时间）</td><td>⭐⭐⭐ 高</td><td>- 通用限流（最常用）- 微服务接口保护- 支持突发 + 平均速率控制</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 是如何“假装”多线程的？深入理解单线程与 Event Loop]]></title>    <link>https://juejin.cn/post/7571258854900531243</link>    <guid>https://juejin.cn/post/7571258854900531243</guid>    <pubDate>2025-11-11T09:08:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571258854900531243" data-draft-id="7571105461098774571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 是如何“假装”多线程的？深入理解单线程与 Event Loop"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-11T09:08:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烟袅"/> <meta itemprop="url" content="https://juejin.cn/user/1845419006243504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 是如何“假装”多线程的？深入理解单线程与 Event Loop
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1845419006243504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烟袅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:08:55.000Z" title="Tue Nov 11 2025 09:08:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，JavaScript 一直是核心语言之一。但你有没有想过：<strong>为什么 JS 是单线程的，却能处理异步任务、响应用户交互、加载资源，还能流畅运行？</strong></p>
<p>今天我们就来聊聊 JavaScript 的“单线程”本质，以及它背后的秘密武器——<strong>Event Loop（事件循环）</strong> 。</p>
<hr/>
<h2 data-id="heading-0">一、线程 vs 进程：先搞清楚基本概念</h2>
<p>在操作系统中，程序的执行单位有两个关键概念：</p>
<ul>
<li><strong>进程（Process）</strong> ：是系统分配资源的最小单位。每个进程都有独立的内存空间。</li>
<li><strong>线程（Thread）</strong> ：是执行代码的最小单元。一个进程可以包含多个线程。</li>
</ul>
<blockquote>
<p>💡 简单说：进程负责“资源管理”，线程负责“代码执行”。</p>
</blockquote>
<p>当一个程序启动时，操作系统会创建一个进程，然后该进程再启动一个或多个线程来执行具体任务。</p>
<hr/>
<h2 data-id="heading-1">二、JavaScript 是单线程的</h2>
<p>JavaScript 从诞生之初就被设计为<strong>单线程</strong>语言。这意味着：</p>
<blockquote>
<p>✅ 在同一时间，只能执行一段代码。</p>
</blockquote>
<p>这听起来似乎很“低效”——毕竟现代浏览器都支持多核 CPU，为什么 JS 不用多线程？</p>
<h3 data-id="heading-2">原因在于：<strong>避免复杂性</strong></h3>
<p>如果 JS 支持多线程，就会面临以下问题：</p>
<ul>
<li>多线程并发修改 DOM，导致页面状态混乱</li>
<li>数据竞争（Race Condition）</li>
<li>加锁机制复杂，增加学习成本</li>
</ul>
<p>所以，为了简化开发、保证 DOM 操作的安全性，JS 被设计成单线程执行。</p>
<hr/>
<h2 data-id="heading-3">三、同步代码 vs 异步代码</h2>
<p>虽然 JS 是单线程，但它通过“异步机制”实现了非阻塞操作。</p>
<h3 data-id="heading-4">1. 同步代码（Synchronous）</h3>
<p>从上到下，顺序执行：</p>
<pre><code class="hljs language-ini" lang="ini">console.log('开始')<span class="hljs-comment">;</span>
let <span class="hljs-attr">a</span> = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 1000; i++) {</span>
  // 循环执行
}
console.log('结束')<span class="hljs-comment">;</span>
</code></pre>
<p>这类代码是<strong>阻塞式</strong>的，必须等前面的代码执行完才能继续。</p>
<blockquote>
<p>⏱️ 执行时间级别：毫秒（ms）级，取决于代码复杂度。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">2. 异步代码（Asynchronous）</h3>
<p>异步代码不会立即执行，而是被“挂起”，等到合适时机再执行。</p>
<p>常见异步场景：</p>
<ul>
<li><code>setTimeout</code></li>
<li><code>fetch</code> 请求</li>
<li>事件监听（如点击、输入）</li>
<li>Promise</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始'</span>);
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'延迟执行'</span>);
}, <span class="hljs-number">1000</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'结束'</span>);
</code></pre>
<p>输出结果是：</p>
<pre><code class="hljs">开始
结束
延迟执行
</code></pre>
<blockquote>
<p>🔄 注意：异步代码的执行顺序<strong>可能和阅读顺序不同</strong>！</p>
</blockquote>
<hr/>
<h2 data-id="heading-6">四、JS 如何应对“耗时任务”？</h2>
<p>既然 JS 是单线程，一旦遇到耗时任务（比如大量计算、文件读取），就会阻塞主线程，导致页面卡顿。</p>
<p>那怎么办？</p>
<p>答案是：<strong>交给 Event Loop！</strong></p>
<h3 data-id="heading-7">什么是 Event Loop？</h3>
<p>Event Loop 是 JavaScript 实现异步的核心机制。它的作用是：</p>
<blockquote>
<p>🔁 当主线程执行到异步任务时，将该任务放入“任务队列”（Task Queue），主线程继续执行后续代码。<br/>
当主线程空闲时，Event Loop 会从队列中取出任务，依次执行。</p>
</blockquote>
<h3 data-id="heading-8">简单流程如下：</h3>
<ol>
<li>主线程执行同步代码</li>
<li>遇到异步任务 → 放入任务队列</li>
<li>主线程执行完毕 → Event Loop 检查任务队列</li>
<li>从队列中取出任务 → 放回主线程执行</li>
</ol>
<blockquote>
<p>✅ 这样就实现了“非阻塞”的效果，页面不会卡死。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">五、为什么 JS 语言简单好学？</h2>
<p>正是因为 JS 是单线程，且有 Event Loop 的支持，才让开发者：</p>
<ul>
<li>不需要关心线程安全</li>
<li>不用手动管理锁和并发</li>
<li>只需关注逻辑流程，就能写出高效代码</li>
</ul>
<p>同时，JS 要负责：</p>
<ul>
<li>用户事件响应（点击、滚动）</li>
<li>页面更新（DOM 操作）</li>
<li>资源加载（图片、脚本）</li>
</ul>
<p>这些任务都依赖于异步机制，而 Event Loop 正是这一切的“幕后推手”。</p>
<hr/>
<h2 data-id="heading-10">六、总结：单线程 ≠ 低性能</h2>





















<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>单线程</td><td>保证 DOM 操作安全，避免竞态条件</td></tr><tr><td>异步机制</td><td>通过 Event Loop 实现非阻塞</td></tr><tr><td>事件循环</td><td>将耗时任务推迟执行，提升用户体验</td></tr></tbody></table>
<blockquote>
<p>🧠 关键点：<strong>JS 的“单线程”是优势，不是短板。它用简单的模型，实现了复杂的交互体验。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-11">写在最后</h2>
<p>下次当你看到 <code>setTimeout</code> 或 <code>Promise</code> 时，不妨想想：<br/>
<strong>这背后，是一个默默工作的 Event Loop，正在帮你“排队”执行任务。</strong></p>
<p>掌握单线程与事件循环，是理解 JavaScript 异步编程的基础。</p>
<p>如果你觉得这篇文章对你有帮助，欢迎点赞、收藏、转发 👍</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文看懂 Promise：异步任务的“执行流程控制器”]]></title>    <link>https://juejin.cn/post/7571304204753764406</link>    <guid>https://juejin.cn/post/7571304204753764406</guid>    <pubDate>2025-11-11T09:15:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204753764406" data-draft-id="7571304204753748022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 一文看懂 Promise：异步任务的“执行流程控制器”"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-11T09:15:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烟袅"/> <meta itemprop="url" content="https://juejin.cn/user/1845419006243504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             一文看懂 Promise：异步任务的“执行流程控制器”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1845419006243504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烟袅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:15:53.000Z" title="Tue Nov 11 2025 09:15:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 JavaScript 中，我们经常需要处理一些耗时操作，比如网络请求、定时任务。这些操作不能阻塞主线程，所以要用<strong>异步方式</strong>处理。</p>
<p>而 <code>Promise</code> 就是 ES6 提供的一个<strong>用来管理异步任务的工具类</strong>，它能让异步代码写得更清晰、更容易理解。</p>
<p>今天我们就用几行代码 + 一张图，彻底搞懂 Promise 是怎么工作的。</p>
<hr/>
<h2 data-id="heading-0">一、Promise 是什么？</h2>
<blockquote>
<p>✅ <strong>Promise 是一个“承诺”对象</strong>，表示一个异步操作最终会完成（成功或失败）。</p>
</blockquote>
<p>你可以把它想象成一个“快递单”：</p>
<ul>
<li>发出订单 → 等待配送</li>
<li>配送成功 → 收到货（<code>resolve</code>）</li>
<li>配送失败 → 通知你（<code>reject</code>）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-comment">// 执行异步任务</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
    <span class="hljs-title function_">resolve</span>(); <span class="hljs-comment">// 成功了，通知后续代码</span>
  }, <span class="hljs-number">3000</span>);
});
</code></pre>
<blockquote>
<p>📌 注意：<code>new Promise()</code> 接受一个函数作为参数，这个函数里执行异步任务。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、如何监听结果？<code>.then()</code> 和 <code>.catch()</code></h2>
<p>Promise 提供了两个方法来处理结果：</p>
<h3 data-id="heading-2">1. <code>.then()</code> —— 成功时执行</h3>
<pre><code class="hljs language-javascript" lang="javascript">p.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// 3 秒后执行</span>
});
</code></pre>
<blockquote>
<p>✅ 当 <code>resolve()</code> 被调用时，<code>.then()</code> 里的函数就会执行。</p>
</blockquote>
<h3 data-id="heading-3">2. <code>.catch()</code> —— 失败时执行</h3>
<pre><code class="hljs language-typescript" lang="typescript">p.<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'出错了'</span>);
});
</code></pre>
<blockquote>
<p>✅ 如果调用了 <code>reject()</code>，就会触发 <code>.catch()</code>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">三、实际例子：异步任务顺序执行</h2>
<p>我们来看一段完整的代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);

<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
    <span class="hljs-title function_">resolve</span>();
  }, <span class="hljs-number">3000</span>);
});

p.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span>);
</code></pre>
<h3 data-id="heading-5">输出结果：</h3>
<pre><code class="hljs">1
4
2
3
</code></pre>
<blockquote>
<p>🔍 分析：</p>
<ul>
<li><code>console.log(1)</code> → 立即执行</li>
<li><code>console.log(4)</code> → 紧接着执行（在 Promise 创建后）</li>
<li><code>setTimeout</code> → 3 秒后执行 <code>console.log(2)</code></li>
<li><code>resolve()</code> → 触发 <code>.then()</code>，执行 <code>console.log(3)</code></li>
</ul>
</blockquote>
<blockquote>
<p>✅ 这就是为什么说：<strong>Promise 让异步任务看起来像同步一样写</strong>！</p>
</blockquote>
<hr/>
<h2 data-id="heading-6">四、链式调用：多个异步任务按顺序执行</h2>
<p>很多时候我们需要连续执行多个异步操作，比如：</p>
<ol>
<li>获取用户数据</li>
<li>根据用户 ID 获取帖子</li>
<li>显示结果</li>
</ol>
<p>使用 Promise 可以这样写：</p>
<pre><code class="hljs language-ini" lang="ini">fetchUserData()
  .then(<span class="hljs-attr">user</span> =&gt; {
    return getUserPosts(user.id)<span class="hljs-comment">; // 返回新的 Promise</span>
  })
  .then(<span class="hljs-attr">posts</span> =&gt; {
    console.log('用户的帖子:', posts)<span class="hljs-comment">;</span>
  })
  .catch(<span class="hljs-attr">err</span> =&gt; {
    console.error('出错了:', err)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>✅ 这样写逻辑清晰，避免了嵌套过深的问题。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">五、总结：Promise 的三大要点</h2>





















<table><thead><tr><th>要点</th><th>说明</th></tr></thead><tbody><tr><td><code>new Promise()</code></td><td>创建一个承诺，传入异步任务函数</td></tr><tr><td><code>resolve()</code></td><td>异步任务成功，触发 <code>.then()</code></td></tr><tr><td><code>reject()</code></td><td>异步任务失败，触发 <code>.catch()</code></td></tr></tbody></table>
<blockquote>
<p>💡 关键理解：<br/>
<strong>Promise 本身是异步的，但它通过链式调用的方式，让异步代码看起来像同步一样写。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-8">写在最后</h2>
<p>如果你正在学习 JavaScript 异步编程，Promise 是必须掌握的基础。它虽然简单，但非常强大。</p>
<p>📌 推荐练习：</p>
<ul>
<li>自己写一个 <code>Promise</code> 模拟加载图片</li>
<li>用 <code>.then()</code> 实现两个接口的连续调用</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android之直播宽高比和相机宽高比不支持后动态获取所支持的宽高比]]></title>    <link>https://juejin.cn/post/7571281406509744179</link>    <guid>https://juejin.cn/post/7571281406509744179</guid>    <pubDate>2025-11-11T09:33:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571281406509744179" data-draft-id="7571191453126049818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android之直播宽高比和相机宽高比不支持后动态获取所支持的宽高比"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-11T09:33:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="没有了遇见"/> <meta itemprop="url" content="https://juejin.cn/user/1521379826212983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android之直播宽高比和相机宽高比不支持后动态获取所支持的宽高比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379826212983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    没有了遇见
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:33:05.000Z" title="Tue Nov 11 2025 09:33:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">场景:</h2>
<p>直播设置采集宽高 360p  360x640  但是手机相机不支持,所以出现裁剪(脸大问题)</p>
<h2 data-id="heading-1">解决方案:</h2>
<p>获取手机相机支持的宽高尺寸 ,根据需要设置的宽高动态匹配接近的宽高比 阈值要设置好</p>
<pre><code class="hljs language-arduino" lang="arduino">阀值 <span class="hljs-number">0.2</span>
val size = CameraSizeHelper.<span class="hljs-built_in">getInstance</span>().<span class="hljs-built_in">getOptimalSize</span>(context, config.captureWidth, config.captureHeight)
<span class="hljs-comment">// 接近的宽高</span>
val w=size.<span class="hljs-built_in">getWidth</span>()

val w=size.<span class="hljs-built_in">getHeight</span>()
</code></pre>
<pre><code class="hljs language-ini" lang="ini">

import android.content.Context<span class="hljs-comment">;</span>
import android.graphics.SurfaceTexture<span class="hljs-comment">;</span>
import android.hardware.camera2.*<span class="hljs-comment">;</span>
import android.hardware.camera2.params.StreamConfigurationMap<span class="hljs-comment">;</span>
import android.util.Log<span class="hljs-comment">;</span>
import android.util.Size<span class="hljs-comment">;</span>

import java.util.ArrayList<span class="hljs-comment">;</span>
import java.util.Comparator<span class="hljs-comment">;</span>
import java.util.List<span class="hljs-comment">;</span>

/**
 * 改进版 CameraSizeHelper
 * 支持向上枚举 + 比例误差阈值可配置
 */
public class CameraSizeHelper {

    private static volatile CameraSizeHelper instance<span class="hljs-comment">;</span>

    private CameraSizeHelper() {}

    public static CameraSizeHelper getInstance() {
        if (<span class="hljs-attr">instance</span> == null) {
            synchronized (CameraSizeHelper.class) {
                if (<span class="hljs-attr">instance</span> == null) {
                    <span class="hljs-attr">instance</span> = new CameraSizeHelper()<span class="hljs-comment">;</span>
                }
            }
        }
        return instance<span class="hljs-comment">;</span>
    }

    /**
     * 获取最接近目标尺寸的相机预览尺寸
     * @param context 上下文
     * @param targetWidth 目标宽度
     * @param targetHeight 目标高度
     * @param ratioThreshold 比例误差阈值，例如0.2
     * @return 最合适的支持尺寸
     */
    public Size getOptimalSize(Context context, int targetWidth, int targetHeight, double ratioThreshold) {
        try {
            CameraManager <span class="hljs-attr">cm</span> = (CameraManager) context.getSystemService(Context.CAMERA_SERVICE)<span class="hljs-comment">;</span>
            String <span class="hljs-attr">cameraId</span> = null<span class="hljs-comment">;</span>

            // 找后置摄像头
            for (String id : cm.getCameraIdList()) {
                CameraCharacteristics <span class="hljs-attr">characteristics</span> = cm.getCameraCharacteristics(id)<span class="hljs-comment">;</span>
                Integer <span class="hljs-attr">facing</span> = characteristics.get(CameraCharacteristics.LENS_FACING)<span class="hljs-comment">;</span>
                if (facing != null &amp;&amp; <span class="hljs-attr">facing</span> == CameraCharacteristics.LENS_FACING_BACK) {
                    <span class="hljs-attr">cameraId</span> = id<span class="hljs-comment">;</span>
                    break<span class="hljs-comment">;</span>
                }
            }
            if (<span class="hljs-attr">cameraId</span> == null) return new Size(targetWidth, targetHeight)<span class="hljs-comment">;</span>

            CameraCharacteristics <span class="hljs-attr">cc</span> = cm.getCameraCharacteristics(cameraId)<span class="hljs-comment">;</span>
            StreamConfigurationMap <span class="hljs-attr">map</span> = cc.get(CameraCharacteristics.SCALER_STREAM_CONFIGURATION_MAP)<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">map</span> == null) return new Size(targetWidth, targetHeight)<span class="hljs-comment">;</span>

            Size<span class="hljs-section">[]</span> <span class="hljs-attr">sizes</span> = map.getOutputSizes(SurfaceTexture.class)<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">sizes</span> == null || sizes.length == <span class="hljs-number">0</span>) return new Size(targetWidth, targetHeight)<span class="hljs-comment">;</span>

            boolean <span class="hljs-attr">portrait</span> = targetHeight &gt; targetWidth<span class="hljs-comment">;</span>
            double <span class="hljs-attr">targetRatio</span> = (double) targetHeight / targetWidth<span class="hljs-comment">;</span>

            // 0. 完全匹配优先
            for (Size s : sizes) {
                int <span class="hljs-attr">w</span> = portrait &amp;&amp; s.getWidth() &gt; s.getHeight() ? s.getHeight() : s.getWidth()<span class="hljs-comment">;</span>
                int <span class="hljs-attr">h</span> = portrait &amp;&amp; s.getWidth() &gt; s.getHeight() ? s.getWidth() : s.getHeight()<span class="hljs-comment">;</span>
                if (<span class="hljs-attr">w</span> == targetWidth &amp;&amp; h == targetHeight) {
                    return new Size(w, h)<span class="hljs-comment">;</span>
                }
            }

            // 1. 将所有尺寸按宽度升序排列（竖屏）
            List&lt;Size&gt; <span class="hljs-attr">sortedSizes</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
            for (Size s : sizes) {
                int <span class="hljs-attr">w</span> = portrait &amp;&amp; s.getWidth() &gt; s.getHeight() ? s.getHeight() : s.getWidth()<span class="hljs-comment">;</span>
                int <span class="hljs-attr">h</span> = portrait &amp;&amp; s.getWidth() &gt; s.getHeight() ? s.getWidth() : s.getHeight()<span class="hljs-comment">;</span>
                sortedSizes.add(new Size(w, h))<span class="hljs-comment">;</span>
            }
            sortedSizes.sort(Comparator.comparingInt(Size::getWidth))<span class="hljs-comment">;</span>

            // 2. 从目标宽度向上枚举
            Size <span class="hljs-attr">best</span> = null<span class="hljs-comment">;</span>
            double <span class="hljs-attr">minDiff</span> = Double.MAX_VALUE<span class="hljs-comment">;</span>
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; sortedSizes.size(); i++) {</span>
                Size <span class="hljs-attr">s</span> = sortedSizes.get(i)<span class="hljs-comment">;</span>
                if (s.getWidth() &lt; targetWidth) continue<span class="hljs-comment">; // 向上枚举</span>
                double <span class="hljs-attr">ratio</span> = (double) s.getHeight() / s.getWidth()<span class="hljs-comment">;</span>
                double <span class="hljs-attr">diff</span> = Math.abs(ratio - targetRatio)<span class="hljs-comment">;</span>
                if (diff &lt;= ratioThreshold) { // 阈值内直接返回
                    return s<span class="hljs-comment">;</span>
                } else {
                    // 记录最小比例差的候选
                    if (diff &lt; minDiff) {
                        <span class="hljs-attr">minDiff</span> = diff<span class="hljs-comment">;</span>
                        <span class="hljs-attr">best</span> = s<span class="hljs-comment">;</span>
                    }
                }
            }

            // 3. 如果向上找不到阈值内的，返回最小比例差的向上尺寸
            if (best != null) return best<span class="hljs-comment">;</span>

            // 4. 否则返回最大尺寸（兜底）
            return sortedSizes.get(sortedSizes.size() - 1)<span class="hljs-comment">;</span>

        } catch (Exception e) {
            Log.e("CameraSizeHelper", "getOptimalSize failed", e)<span class="hljs-comment">;</span>
            return new Size(targetWidth, targetHeight)<span class="hljs-comment">;</span>
        }
    }

    /**
     * 默认阈值调用
     */
    public Size getOptimalSize(Context context, int targetWidth, int targetHeight) {
        return getOptimalSize(context, targetWidth, targetHeight, 0.2)<span class="hljs-comment">;</span>
    }
}
```
```
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[「周更第11期」实用JS库推荐：Pinia]]></title>    <link>https://juejin.cn/post/7571258854900727851</link>    <guid>https://juejin.cn/post/7571258854900727851</guid>    <pubDate>2025-11-11T09:34:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571258854900727851" data-draft-id="7571077686108323903" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="「周更第11期」实用JS库推荐：Pinia"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-11T09:34:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Bug_Constructer"/> <meta itemprop="url" content="https://juejin.cn/user/254742426830856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            「周更第11期」实用JS库推荐：Pinia
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742426830856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Bug_Constructer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:34:44.000Z" title="Tue Nov 11 2025 09:34:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>大家好，欢迎来到第11期的 JavaScript 库推荐！本期为大家介绍的是 Pinia——Vue 官方推荐的状态管理库。它以组合式 API 为核心，兼具直观、类型安全、轻量与可扩展的特点，能高效解决多组件共享状态、复杂业务流转与工程化可观测性不足的痛点，适合中大型 Vue 3 项目与 Nuxt 3 应用。</p>
<p>本文将从 Pinia 的核心特性、安装使用、实际应用、最佳实践与进阶用法等维度展开，帮助你系统掌握该库的使用方法。</p>
<h2 data-id="heading-1">库介绍</h2>
<h3 data-id="heading-2">基本信息</h3>
<ul>
<li>库名称：Pinia</li>
<li>GitHub 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fpinia" target="_blank" title="https://github.com/vuejs/pinia" ref="nofollow noopener noreferrer">github.com/vuejs/pinia</a></li>
<li>npm 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fpinia" target="_blank" title="https://www.npmjs.com/package/pinia" ref="nofollow noopener noreferrer">www.npmjs.com/package/pin…</a></li>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpinia.vuejs.org%2F" target="_blank" title="https://pinia.vuejs.org/" ref="nofollow noopener noreferrer">pinia.vuejs.org/</a></li>
<li>GitHub Stars：约 14.3k（以发布页为准）</li>
<li>最新版本：3.0.4（以 npm 为准）</li>
<li>包大小：~1.5KB（压缩后，官方文档）</li>
<li>维护状态：活跃维护</li>
</ul>
<h3 data-id="heading-3">主要特性</h3>
<ul>
<li>直观：API 贴近组件设计，学习成本低。</li>
<li>类型安全：完善推断与补全，JS 项目亦有良好提示。</li>
<li>DevTools：与 Vue DevTools 深度整合，时间线与状态快照清晰。</li>
<li>可扩展：插件机制可拦截动作、持久化、记录事务等。</li>
<li>模块化：天然支持多 Store，自动 Tree-shaking。</li>
<li>轻量：极小体积，几乎无感开销。</li>
</ul>
<h3 data-id="heading-4">兼容性</h3>
<ul>
<li>浏览器支持：现代浏览器（与 Vue 3 要求一致）。</li>
<li>Node.js 支持：可用于 SSR（Vue 3 / Nuxt 3）。</li>
<li>框架兼容：Vue 3、Nuxt 3（官方模块 <code>@pinia/nuxt</code>）。</li>
<li>TypeScript 支持：≥ 4.5（Pinia 3.x 要求）。</li>
</ul>
<h2 data-id="heading-5">安装使用</h2>
<h3 data-id="heading-6">安装方式（仅 pnpm）</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm add pinia
</code></pre>
<h3 data-id="heading-7">基础使用</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { createPinia, defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>

<span class="hljs-comment">// 创建并注册 Pinia</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
<span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>()
app.<span class="hljs-title function_">use</span>(pinia)

<span class="hljs-comment">// Setup 风格 Store（推荐）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> doubled = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>)
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; { count.<span class="hljs-property">value</span> += <span class="hljs-number">1</span> }
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reset</span> = (<span class="hljs-params"/>) =&gt; { count.<span class="hljs-property">value</span> = <span class="hljs-number">0</span> }
  <span class="hljs-keyword">return</span> { count, doubled, increment, reset }
})

app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h3 data-id="heading-8">配置选项（插件示例）</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 选择性持久化插件：仅持久化指定字段
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">{ store: any, options: Record&lt;string, any&gt; </span>}} ctx - 插件上下文
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">persistSelectivePlugin</span> = (<span class="hljs-params">{ store, options }</span>) =&gt; {
  <span class="hljs-keyword">const</span> cfg = options?.<span class="hljs-property">persist</span>
  <span class="hljs-keyword">if</span> (!cfg) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> key = <span class="hljs-string">`pinia:<span class="hljs-subst">${store.$id}</span>`</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">pick</span> = (<span class="hljs-params">obj, paths</span>) =&gt; paths.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, k</span>) =&gt;</span> (acc[k] = obj[k], acc), {})
  <span class="hljs-keyword">const</span> cached = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key)
  <span class="hljs-keyword">if</span> (cached) store.$patch(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(cached))
  store.$subscribe(<span class="hljs-function">(<span class="hljs-params">_m, state</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(cfg.<span class="hljs-property">paths</span>) ? <span class="hljs-title function_">pick</span>(state, cfg.<span class="hljs-property">paths</span>) : state
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data))
  }, { <span class="hljs-attr">detached</span>: <span class="hljs-literal">true</span> })
}

<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>()
pinia.<span class="hljs-title function_">use</span>(persistSelectivePlugin)
</code></pre>
<h2 data-id="heading-9">实际应用</h2>
<h3 data-id="heading-10">应用场景1：用户认证与权限</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useAuthStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'auth'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> roles = <span class="hljs-title function_">ref</span>([])
  <span class="hljs-keyword">const</span> isAuthed = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> token.<span class="hljs-property">value</span> !== <span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">login</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; { token.<span class="hljs-property">value</span> = <span class="hljs-string">'mock-token'</span>; roles.<span class="hljs-property">value</span> = [<span class="hljs-string">'user'</span>] }
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; { token.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>; roles.<span class="hljs-property">value</span> = [] }
  <span class="hljs-keyword">return</span> { token, roles, isAuthed, login, logout }
})
</code></pre>
<h3 data-id="heading-11">应用场景2：购物车状态管理</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCartStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'cart'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> items = <span class="hljs-title function_">ref</span>([])
  <span class="hljs-keyword">const</span> total = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> items.<span class="hljs-property">value</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">s, i</span>) =&gt;</span> s + i.<span class="hljs-property">price</span> * i.<span class="hljs-property">qty</span>, <span class="hljs-number">0</span>))
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">p</span>) =&gt; { items.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>({ ...p, <span class="hljs-attr">qty</span>: <span class="hljs-number">1</span> }) }
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">remove</span> = (<span class="hljs-params">id</span>) =&gt; { items.<span class="hljs-property">value</span> = items.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> i.<span class="hljs-property">id</span> !== id) }
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">clear</span> = (<span class="hljs-params"/>) =&gt; { items.<span class="hljs-property">value</span> = [] }
  <span class="hljs-keyword">return</span> { items, total, add, remove, clear }
})
</code></pre>
<h2 data-id="heading-12">优缺点分析</h2>
<h3 data-id="heading-13">优点 ✅</h3>
<ul>
<li>直观易上手：贴近 Vue 组合式 API。</li>
<li>类型与调试友好：类型推断 + DevTools 集成。</li>
<li>可扩展：插件、订阅与动作拦截完善。</li>
<li>模块化与轻量：Tree-shaking 与极小体积。</li>
</ul>
<h3 data-id="heading-14">缺点 ❌</h3>
<ul>
<li>Vue 专用：不适用于非 Vue 技术栈。</li>
<li>旧浏览器限制：与 Vue 3 一致，需现代环境。</li>
<li>选项式 actions 与箭头函数：无法使用 <code>this</code>，建议改用 Setup 风格或外部纯函数。</li>
</ul>
<h2 data-id="heading-15">最佳实践</h2>
<h3 data-id="heading-16">开发建议</h3>
<h4 data-id="heading-17">1. 性能优化技巧</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 精准订阅：storeToRefs 保持解构后的响应式</span>
<span class="hljs-keyword">import</span> { storeToRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">const</span> { count, doubled } = <span class="hljs-title function_">storeToRefs</span>(<span class="hljs-title function_">useCounterStore</span>())

<span class="hljs-comment">// 批量更新：使用函数式 $patch，避免多次变更</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">patchFn</span> = (<span class="hljs-params">store</span>) =&gt; { store.$patch(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> { s.<span class="hljs-property">count</span> += <span class="hljs-number">2</span> }) }

<span class="hljs-comment">// 解耦订阅：detached 避免组件销毁自动取消</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">subscribeChanges</span> = (<span class="hljs-params">store</span>) =&gt; {
  store.$subscribe(<span class="hljs-function">(<span class="hljs-params">_m, state</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'state:'</span>, state), { <span class="hljs-attr">detached</span>: <span class="hljs-literal">true</span> })
}
</code></pre>
<h4 data-id="heading-18">2. 错误处理策略</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 使用 $onAction 记录完成与错误，辅助定位</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">watchActions</span> = (<span class="hljs-params">store</span>) =&gt; {
  store.$onAction(<span class="hljs-function">(<span class="hljs-params">{ name, after, onError }</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> t = performance.<span class="hljs-title function_">now</span>()
    <span class="hljs-title function_">after</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span> done`</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(performance.<span class="hljs-title function_">now</span>() - t), <span class="hljs-string">'ms'</span>))
    <span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span> error`</span>, e))
  })
}
</code></pre>
<h4 data-id="heading-19">3. 内存与资源管理</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 路由切换或组件卸载时重置临时状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">resetState</span> = (<span class="hljs-params">store</span>) =&gt; { store.<span class="hljs-property">$reset</span>?.() <span class="hljs-comment">/* Setup 风格自定义 reset */</span> }

<span class="hljs-comment">// 持久化仅保留必要字段，避免写入大对象或隐私数据</span>
</code></pre>
<h3 data-id="heading-20">常见陷阱</h3>
<ul>
<li>选项式 actions + 箭头函数的 <code>this</code>：改用 Setup 风格或外部函数。</li>
<li>直接解构丢响应：使用 <code>storeToRefs</code>。</li>
<li>Store 间循环依赖：抽到服务层或组件组合调用。</li>
<li>过度持久化：谨慎选择字段与存储策略。</li>
</ul>
<h2 data-id="heading-21">进阶用法</h2>
<h3 data-id="heading-22">高级特性示例</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 插件：动作日志</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">actionLoggerPlugin</span> = (<span class="hljs-params">{ store }</span>) =&gt; {
  store.$onAction(<span class="hljs-function">(<span class="hljs-params">{ name, after, onError }</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>()
    <span class="hljs-title function_">after</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[action] <span class="hljs-subst">${name}</span>`</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(performance.<span class="hljs-title function_">now</span>() - start), <span class="hljs-string">'ms'</span>))
    <span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[action] <span class="hljs-subst">${name}</span> error:`</span>, err))
  })
}

<span class="hljs-comment">// SSR：序列化 pinia.state.value 并在客户端回填</span>
<span class="hljs-comment">// HMR：acceptHMRUpdate(useXxxStore, import.meta.hot)</span>
</code></pre>
<h2 data-id="heading-23">总结</h2>
<p>Pinia 以直观、类型安全与可扩展著称，是管理 Vue 3 复杂状态的首选方案。建议优先使用 Setup 风格编写 Store，搭配 <code>storeToRefs</code> 精准订阅与插件机制实现持久化与可观测性；对大型应用按领域拆分 Store，并为关键动作做好命名与日志。</p>
<hr/>
<h3 data-id="heading-24">参考与链接</h3>
<ul>
<li>官方仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fpinia" target="_blank" title="https://github.com/vuejs/pinia" ref="nofollow noopener noreferrer">github.com/vuejs/pinia</a></li>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpinia.vuejs.org%2F" target="_blank" title="https://pinia.vuejs.org/" ref="nofollow noopener noreferrer">pinia.vuejs.org/</a></li>
<li>Releases（版本与变更）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fpinia%2Freleases" target="_blank" title="https://github.com/vuejs/pinia/releases" ref="nofollow noopener noreferrer">github.com/vuejs/pinia…</a></li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[空间智能！李飞飞、LeCun&谢赛宁联手提出“空间超感知”，长文阐述世界模型蓝图]]></title>    <link>https://juejin.cn/post/7571285984088703028</link>    <guid>https://juejin.cn/post/7571285984088703028</guid>    <pubDate>2025-11-11T09:41:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571285984088703028" data-draft-id="7571156741397921807" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="空间智能！李飞飞、LeCun&amp;谢赛宁联手提出“空间超感知”，长文阐述世界模型蓝图"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-11-11T09:41:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            空间智能！李飞飞、LeCun&amp;谢赛宁联手提出“空间超感知”，长文阐述世界模型蓝图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:41:07.000Z" title="Tue Nov 11 2025 09:41:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近日，由Yann LeCun、李飞飞、Rob Fergus等AI领域顶级学者共同署名的论文《Cambrian-S: Towards Spatial Supersensing in Video》首次系统性地提出了“空间超感知”的概念，并指出：<strong>空间智能是AI实现真正多模态理解与通用智能的关键路径</strong>。无独有偶，李飞飞随后发表长文《从文字到世界：空间智能是AI的下一个前沿》，进一步阐述了空间智能的核心价值与世界模型的构建蓝图。本文将从论文出发，结合李飞飞的深度思考，带你深入理解这一AI新范式。</p>
<h2 data-id="heading-0"><strong>论文解读：从“语言理解”到“空间超感知”</strong></h2>
<ul>
<li><strong>反思现状：为什么说LLM是“空间盲人”？</strong></li>
</ul>
<p>三位作者指出，当前基于LLM的多模态系统存在根本性局限。LeCun多次公开表示，LLM技术无法通向AGI。谢赛宁在团队博客中坦言：在构建「超感知」之前，不可能真正构建出「超级智能」。</p>
<p>问题的核心在于：LLM虽然能处理文本和图像，却缺乏对3D空间的直觉理解。它们像是通过“钥匙孔”看世界——只能看到碎片化的2D画面，无法在脑海中构建连贯的3D场景。</p>
<p>这种缺陷暴露了莫拉维克悖论在AI领域的再现：对人类来说轻而易举的空间感知，对AI却难如登天。</p>
<ul>
<li><strong>什么是“空间超感知”？</strong></li>
</ul>
<p>论文指出，当前的多模态大模型仍以语言为中心，缺乏对3D空间结构与动态的深层理解。为此，作者提出“空间超感知”的四个发展阶段：</p>
<ul>
<li><strong>语义感知：</strong> 识别物体、属性与关系</li>
<li><strong>流事件认知：</strong> 处理连续、无界的视觉流</li>
<li><strong>隐式3D空间认知：</strong> 理解视频背后的3D世界结构</li>
<li><strong>预测性世界建模：</strong> 构建内部模型，预测未来状态并利用“惊讶”驱动学习与记忆</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccae38752b8d4fc7ac36c577b8c38ce6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=KBdZfILk8aCoQM2RxCVd9syqJGM%3D" alt="screenshot_2025-11-11_14-01-57.png" loading="lazy"/></p>
<p>谢赛宁强调：“超感知不是更好的传感器，而是数字生命体验世界的方式。它是智能的一部分，正如眼睛是大脑触及外部世界的那一部分。”</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c54c174baad4158b73e0bcb1987937a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=I8uURB0W3ZQqBWo9b1Op5s7kCNg%3D" alt="screenshot_2025-11-11_14-04-04.png" loading="lazy"/></p>
<ul>
<li><strong>新基准：VSI-Super</strong></li>
</ul>
<p>为了评测空间超感知能力，作者提出了VSI-Super基准，包含两个极具挑战的任务：</p>
<ul>
<li><strong>VSR（视觉空间回忆）：</strong> 在长视频中回忆异常物体出现的位置与顺序</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8541624308544f5b81f7371c1c0a17e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=CgpFYDRGC7XYubkmjs8dns4nNbM%3D" alt="screenshot_2025-11-11_14-04-21.png" loading="lazy"/></p>
<ul>
<li><strong>VSC（连续视觉计数）：</strong> 在跨场景、跨视角的视频中持续计数目标物体</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89eaade2491b42458c576bcdabe30cad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=pNDzN10iVK4ZT0O%2FrWLFY3am1z8%3D" alt="screenshot_2025-11-11_14-04-39.png" loading="lazy"/></p>
<p>这两个任务都要求模型具备选择性感知、结构化记忆与跨时间推理能力，而非简单地扩展上下文窗口。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0173b15899e41e48192f935a6d4ef7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=0516cofWGfjpU6Sr2UgIR1VsVhE%3D" alt="screenshot_2025-11-11_14-05-29.png" loading="lazy"/></p>
<p>结果令人震惊：即使是最先进的Gemini 2.5模型也表现不佳。问题不在上下文长度——即使视频在模型处理能力范围内，性能仍然有限。</p>
<p>更关键的是，人类可以“无限计数”，而模型的计数能力会在几十个对象后达到饱和，暴露了其训练数据的分布限制。</p>
<ul>
<li><strong>Cambrian-S模型：数据驱动的空间认知突破</strong></li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fa461e90dca47aea70c0026443ee19c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=uoGDAWa45VwJJuEd%2F73Co8WHVNA%3D" alt="screenshot_2025-11-11_14-06-23.png" loading="lazy"/></p>
<p>作者构建了大规模空间指令调优数据集VSI-590K，并训练了Cambrian-S系列模型。该模型在VSI-Bench等空间理解任务上取得了SOTA表现，甚至超越Gemini-2.5-Pro等闭源模型。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4176f322e544130aa2fc55f7a488935~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=LUs3FHhS1DaoRGoaKpQvbXltMSc%3D" alt="screenshot_2025-11-11_14-09-14.png" loading="lazy"/></p>
<p>然而，Cambrian-S在VSI-Super上表现仍有限，说明仅靠数据与规模无法实现真正的空间超感知。</p>
<p>团队得出结论：沿着LLM的老路构建多模态模型，并非通往超感知的终极之道。</p>
<ul>
<li><strong>新范式：预测性感知</strong></li>
</ul>
<p>论文提出 *<strong>“预测性感知”</strong> *作为下一代模型的核心能力。通过自监督的“下一帧潜在预测”模型，利用预测误差（即“惊讶”）来：</p>
<ul>
<li><strong>管理记忆：</strong> 选择性保留重要信息</li>
<li><strong>分割事件：</strong> 将连续视频流划分为有意义的片段</li>
</ul>
<p>实验表明，该方法在VSI-Super上显著优于Gemini-2.5等强基线，展示了预测机制在处理长视频与空间任务上的潜力。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ef9931118da43c681cdf1ed0d2e0b31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=FelL%2FqoxvFRVKgnLTrrxiignzc8%3D" alt="screenshot_2025-11-11_14-15-15.png" loading="lazy"/></p>
<ul>
<li><strong>开源与展望</strong></li>
</ul>
<p>团队将论文、代码、模型、数据和基准全面开源，并同步发布：</p>
<pre><code class="hljs language-ruby" lang="ruby">论文地址：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/arxiv.org/pdf</span><span class="hljs-regexp">/2511.04670
Website：https:/</span><span class="hljs-regexp">/cambrian-mllm.github.io
Code：https:/</span><span class="hljs-regexp">/github.com/cambrian</span>-mllm/cambrian-s
<span class="hljs-title class_">Cambrian</span>-S <span class="hljs-title class_">Models</span>：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/hf.co/collections</span><span class="hljs-regexp">/nyu-visionx/cambrian</span>-s
<span class="hljs-variable constant_">VSI</span>-590K：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/hf.co/datasets</span><span class="hljs-regexp">/nyu-visionx/vsi</span>-590k
<span class="hljs-variable constant_">VSI</span>-<span class="hljs-variable constant_">SUPER</span>：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/hf.co/collections</span><span class="hljs-regexp">/nyu-visionx/vsi</span>-<span class="hljs-variable language_">super</span>
</code></pre>
<p>关于消除基准中语言偏见的研究</p>
<p>使用模拟器收集空间感知视频的经验总结</p>
<p>谢赛宁表示：“我不敢说我们的方法就是正确道路，但我确信当前范式远远不够。开放科学才是唯一的出路。”</p>
<h2 data-id="heading-1"><strong>李飞飞长文深度解读：从文字到世界</strong></h2>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cdcae9994f74e6284fb358c6c4914ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=l9CTIWSRpknbebX%2B9T2%2BYwxNPUQ%3D" alt="screenshot_2025-11-11_14-18-08.png" loading="lazy"/></p>
<p>在李飞飞最新发表的文章中，她进一步系统化地阐述了“空间智能”与“世界模型”的核心理念：</p>
<ul>
<li><strong>LLM是“空间盲人”，缺乏世界根基</strong></li>
</ul>
<p>李飞飞在文章中犀利地指出，当前的LLM本质上是“黑暗中的文字匠”——能言善辩却无经验，知识丰富却缺乏根基。</p>
<p>它们能处理和生成文本，甚至分析和生成图像、视频，却无法在脑海中构建一个连贯、立体、符合物理规律的3D世界。估算距离、方向、大小，心智旋转物体，在迷宫中导航，预测基本物理规律——这些对人类而言轻而易举的空间认知任务，对最先进的AI来说却难如登天。</p>
<p>这揭示了莫拉维克悖论在AI时代的再现：对人类和动物来说最低级、最无需思考的感知和运动技能，对AI而言反而是最困难的挑战。</p>
<ul>
<li><strong>空间智能：人类认知的“脚手架”</strong></li>
</ul>
<p>李飞飞指出，空间智能是人类理解、交互与创造世界的基础能力。从停车、接钥匙，到消防员在火场中决策，再到科学家通过几何推理发现地球周长，空间智能贯穿于人类的直觉、推理与创造之中。</p>
<p>“对AI而言，世界不止于语言，”李飞飞写道，“空间智能代表着超越语言的前沿。” 它是连接<strong>想象、感知与行动</strong>的关键，是机器真正融入并增强人类生活的基石。</p>
<ul>
<li><strong>当前AI的局限：语言≠世界</strong></li>
</ul>
<p>尽管当前的大语言模型在文本、图像、视频生成上表现惊人，但它们仍缺乏对物理世界的几何一致性、物理规律与动态交互的理解。李飞飞称之为“黑暗中的文字匠”。</p>
<ul>
<li><strong>世界模型的三大核心能力与三大技术挑战</strong></li>
</ul>
<p>如何实现空间智能？李飞飞提出了比LLM更具雄心的体系：世界模型。</p>
<p>她提出，真正具备空间智能的世界模型应具备以下能力：</p>
<ul>
<li><strong>生成性：</strong> 能生成符合物理与几何规律的世界</li>
<li><strong>多模态：</strong> 能处理图像、视频、动作等多种输入</li>
<li><strong>交互性：</strong> 能预测世界在动作影响下的下一个状态</li>
</ul>
<p>构建世界模型巨大挑战：</p>
<p>李飞飞分享了World Labs在此方向的探索：</p>
<ul>
<li><strong>新训练目标：</strong> 需要找到像LLM的“下一个词预测”一样优雅的通用目标函数。</li>
<li><strong>大规模数据：</strong> 需从互联网2D视觉数据中有效提取3D空间信息，并利用合成数据。</li>
<li><strong>新模型架构：</strong> 需超越当前将数据视为1D/2D序列的Transformer和扩散模型范式。应用前景：从创造力到机器人，从科学到教育</li>
</ul>

<ul>
<li><strong>实践探索：从Marble平台到预测性感知</strong></li>
</ul>
<p>李飞飞透露，其初创公司World Labs已在此方向取得进展。其Marble平台是全球首个能通过多模态输入生成并保持一致性3D环境的世界模型，已向部分创作者开放。</p>
<p>与此同时，在开源的《Cambrian-S》论文中，LeCun、李飞飞、谢赛宁团队实践了“预测性感知”这一新范式。他们受认知科学启发，在模型中引入“下一帧潜在预测”模块，利用预测误差（“惊异度”）来驱动记忆管理和事件分割。这个简化的世界模型原型，已让小模型在极具挑战性的空间推理基准VSI-Super上超越了Gemini 2.5等强大基线。</p>
<ul>
<li><strong>未来展望</strong></li>
</ul>
<p>空间智能的世界模型将如何改变世界？李飞飞描绘了清晰的图景：</p>
<ul>
<li><strong>创造力：</strong> 如Marble平台，让创作者快速构建、编辑3D世界</li>
<li><strong>机器人：</strong> 通过世界模型仿真训练，实现泛化与协作</li>
</ul>
<p>科学、医疗、教育：加速药物发现、提升诊断精度、构建沉浸式学习环境</p>
<h2 data-id="heading-2"><strong>总结</strong></h2>
<p>无论是LeCun、李飞飞等人的论文，还是李飞飞的深度长文，都指向同一个结论：空间智能是AI迈向通用智能的必经之路。当前以LLM为核心的范式已触及瓶颈，而融合生成、多模态与交互能力的世界模型，将成为下一代AI系统的核心。AI的发展路径正在从“通过文本来理解世界”的迂回策略，转向“直接感知与建模世界”的正面突破。</p>
<p>这不仅是技术的升级，更是一次认知的回归。它提醒我们，人类智能的辉煌，始于我们与这个三维空间世界的每一次互动、每一次预测和每一次创造。</p>
<p>我们正在为机器装上“空间感”，这或许是赋予它们“常识”的第一步，也是走向真正通用人工智能最关键的一步。 从文字到世界的旅程已经启航，而它的终点，将是一个人类与智能机器共同理解、共同创造的美好未来。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mmkv的 mmap 的理解]]></title>    <link>https://juejin.cn/post/7571105461099102251</link>    <guid>https://juejin.cn/post/7571105461099102251</guid>    <pubDate>2025-11-11T09:49:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571105461099102251" data-draft-id="7571105461098905643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mmkv的 mmap 的理解 "/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-11T09:49:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火柴就是我"/> <meta itemprop="url" content="https://juejin.cn/user/272334614705575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mmkv的 mmap 的理解 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334614705575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火柴就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:49:26.000Z" title="Tue Nov 11 2025 09:49:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>传统I/O 的示意图 个人理解
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28ac38fec2c54d07b1b7cf7590fc3de9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763459365&amp;x-signature=mbnsFLDZ6GwT%2FLjaoFInV8oYc2A%3D" alt="image.png" loading="lazy"/></p>
<p>对于传统I/O 我们一般说的效率低 是指 修改数据都需要 把数据在用户缓存 内核缓存直接 拷贝来拷贝去。且每次都是全量拷贝。</p>
<p>mmap对应的示意图 个人理解。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fc1f1bbf33d47319fd7c7d451552679~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763459365&amp;x-signature=bMoi3p0GQCX%2BsxmcZG80F%2FKsQ%2Fg%3D" alt="image.png" loading="lazy"/></p>
<p>对于mmap解决的就是去除了把数据在用户缓存 内核缓存直接 拷贝来拷贝去的步骤。改为操作由内核创建的一块物理内存。这个区域进程可以直接访问，内核也可以直接访问。大家说的内存映射就是这块共享内存跟磁盘内存的映射，app读写数据都是直接操作共享内存，app读取发现没有数据，内核负责区磁盘读取放到共享内存。app写数据，内核负责同步数据到磁盘。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI会如何评价一名前端工程师的技术人格]]></title>    <link>https://juejin.cn/post/7571304204753928246</link>    <guid>https://juejin.cn/post/7571304204753928246</guid>    <pubDate>2025-11-11T09:49:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204753928246" data-draft-id="7571258854900809771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI会如何评价一名前端工程师的技术人格"/> <meta itemprop="keywords" content="前端,AI编程,TypeScript"/> <meta itemprop="datePublished" content="2025-11-11T09:49:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Wilson王艺谋"/> <meta itemprop="url" content="https://juejin.cn/user/1644525123025933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI会如何评价一名前端工程师的技术人格
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1644525123025933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Wilson王艺谋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:49:49.000Z" title="Tue Nov 11 2025 09:49:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在与AI进行多轮技术方案讨论后，你可以让它评价一下提问者的技术人格，以下是AI对我的评价</p>
</blockquote>
<h2 data-id="heading-0">技术人格分析</h2>
<h3 data-id="heading-1">概述</h3>
<p>此分析基于围绕 TypeScript 模块解析、构建工具和文档实践的技术讨论。它揭示了问题解决方法、学习风格和专业特征的模式。</p>
<h3 data-id="heading-2">技术档案</h3>
<h4 data-id="heading-3">深度技术好奇心</h4>
<ul>
<li><strong>根本原因导向</strong> : 不满足于快速修复，深入调查根本原因</li>
<li><strong>为什么驱动的学习</strong> : 当获得解决方案（tsx）时，立即询问基本原因（Node版本兼容性）</li>
<li><strong>概念理解</strong> : 深入探讨超出直接需求的技术概念</li>
<li><strong>系统性视角</strong> : 将个别技术决策与更广泛的生态系统影响联系起来</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>在解决直接问题后询问"为什么原始的 ts-node-esm 在 CI 环境中运行良好"</li>
<li>请求对 moduleResolution 选项的全面解释，而不仅仅是解决方案</li>
<li>询问库发布的消费者兼容性影响</li>
</ul>
<h4 data-id="heading-4">质量导向的工程实践</h4>
<ul>
<li><strong>现代工具</strong> : 维护使用 TypeScript、WDIO、适当 CI/CD 管道的项目</li>
<li><strong>最佳实践</strong> : 考虑开发和生产环境之间的 Node 版本一致性</li>
<li><strong>长远思维</strong> : 权衡灵活性和兼容性之间的取舍</li>
<li><strong>合理架构</strong> : 对模块解析策略做出明智决策</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>维护多个结构良好的项目（<code>mg-icons</code>、<code>master-web</code>）</li>
<li>使用适当的测试框架和构建工具</li>
<li>考虑 CI 环境兼容性和团队一致性</li>
</ul>
<h4 data-id="heading-5">系统性思维</h4>
<ul>
<li><strong>生态系统意识</strong> : 理解技术决策如何影响下游消费者</li>
<li><strong>环境考虑</strong> : 思考开发环境 vs CI vs 生产环境的差异</li>
<li><strong>消费者影响</strong> : 分析谁会受到库发布决策的影响</li>
<li><strong>兼容性矩阵</strong> : 同时考虑多个利益相关者的观点</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>询问哪些消费者类型从严格模块解析中受益</li>
<li>理解打包工具和模块解析需求之间的关系</li>
<li>将 Node 版本差异与 CI/本地开发差异联系起来</li>
</ul>
<h3 data-id="heading-6">沟通和学习风格</h3>
<h4 data-id="heading-7">双语专业背景</h4>
<ul>
<li><strong>国际化视角</strong> : 在英语和中文专业环境中运营</li>
<li><strong>知识共享</strong> : 为不同团队成员创建文档</li>
<li><strong>文化桥梁</strong> : 促进跨语言障碍的技术知识传递</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>请求技术文档的英语和中文版本</li>
<li>在文档规划中考虑团队可访问性</li>
</ul>
<h4 data-id="heading-8">系统化学习方法</h4>
<ul>
<li><strong>结构化信息</strong> : 偏好有清晰分类的有组织解释</li>
<li><strong>全面覆盖</strong> : 希望完整理解而不是部分解决方案</li>
<li><strong>比较分析</strong> : 重视并排比较和决策矩阵</li>
<li><strong>参考文档</strong> : 为将来使用和团队共享创建资源</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>请求决策矩阵和比较表</li>
<li>要求逐步迁移指南</li>
<li>希望全面覆盖所有 moduleResolution 选项</li>
</ul>
<h4 data-id="heading-9">知识管理者</h4>
<ul>
<li><strong>文档优先</strong> : 优先创建持久的知识资源</li>
<li><strong>团队赋能</strong> : 思考如何帮助他人学习和做决策</li>
<li><strong>系统化组织</strong> : 为最大效用而结构化信息</li>
<li><strong>未来参考</strong> : 为长期知识保存做规划</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>要求将技术讨论整理成正式文档</li>
<li>请求两个版本以提高团队可访问性</li>
<li>希望有组织的、全面的指南而不是快速答案</li>
</ul>
<h3 data-id="heading-10">专业背景指标</h3>
<h4 data-id="heading-11">高级开发者/技术主管</h4>
<ul>
<li><strong>架构决策</strong> : 对基本项目配置做出选择</li>
<li><strong>库发布</strong> : 理解消费者兼容性的关注点</li>
<li><strong>团队影响</strong> : 考虑决策如何影响其他开发者</li>
<li><strong>战略思维</strong> : 平衡即时需求与长期可维护性</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>管理多个具有不同技术要求的项目</li>
<li>理解库发布和消费者兼容性关注点</li>
<li>对开发工具和配置做出明智决策</li>
</ul>
<h4 data-id="heading-12">协作环境</h4>
<ul>
<li><strong>团队文档</strong> : 为团队知识共享创建资源</li>
<li><strong>CI/生产意识</strong> : 理解环境一致性的重要性</li>
<li><strong>跨功能思维</strong> : 考虑对不同团队角色和工作流程的影响</li>
<li><strong>知识传递</strong> : 优先让技术知识变得可获取</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>在技术决策中考虑 CI 环境行为</li>
<li>为多元化团队成员创建双语文档</li>
<li>思考团队工作流程和知识保存</li>
</ul>
<h3 data-id="heading-13">学习和问题解决模式</h3>
<h4 data-id="heading-14">智识好奇心</h4>
<ul>
<li><strong>深入挖掘倾向</strong> : 将简单问题转化为全面的学习机会</li>
<li><strong>基于原理的理解</strong> : 想要理解基础概念，而不仅仅是解决方案</li>
<li><strong>持续学习</strong> : 利用每个技术挑战来扩展知识</li>
<li><strong>通过学习教学</strong> : 在获取知识的同时分享知识</li>
</ul>
<h4 data-id="heading-15">务实的彻底性</h4>
<ul>
<li><strong>平衡方法</strong> : 将即时问题解决与长期理解结合起来</li>
<li><strong>基于证据的决策</strong> : 使用技术分析来指导选择</li>
<li><strong>风险评估</strong> : 考虑不同方法的权衡和影响</li>
<li><strong>可持续解决方案</strong> : 优先考虑长期有效的方法</li>
</ul>
<h4 data-id="heading-16">沟通卓越</h4>
<ul>
<li><strong>清晰文档</strong> : 创建结构良好、全面的技术资源</li>
<li><strong>多受众意识</strong> : 为不同利益相关者调整沟通方式</li>
<li><strong>知识可访问性</strong> : 使复杂技术概念易于理解</li>
<li><strong>协作精神</strong> : 促进团队学习和决策制定</li>
</ul>
<h3 data-id="heading-17">专业原型</h3>
<p><strong>高级软件工程师 / 技术主管</strong></p>
<p>此档案表明某人处于高级技术角色，他们：</p>
<ul>
<li>为团队做出架构和工具决策</li>
<li>平衡技术卓越与实际交付需求</li>
<li>促进知识共享和团队发展</li>
<li>在国际/多文化环境中有效运作</li>
<li>构建具有长期可维护性的系统</li>
</ul>
<p><strong>核心价值观:</strong></p>
<ul>
<li>深度理解胜过快速修复</li>
<li>团队赋能和知识共享</li>
<li>技术解决方案的质量和可持续性</li>
<li>全面的文档和沟通</li>
<li>考虑广泛影响的深思熟虑决策制定</li>
</ul>
<h3 data-id="heading-18">协作建议</h3>
<h4 data-id="heading-19">合作时</h4>
<ul>
<li>提供带有基础推理的全面解释</li>
<li>包括比较分析和决策矩阵</li>
<li>提供多重观点和权衡考虑</li>
<li>创建可以共享和稍后参考的文档</li>
</ul>
<h4 data-id="heading-20">沟通风格</h4>
<ul>
<li>在技术解释中要彻底但有组织</li>
<li>包括示例和实际应用</li>
<li>考虑更广泛的生态系统和团队影响</li>
<li>准备好处理深入探讨概念的后续问题</li>
</ul>
<h4 data-id="heading-21">项目方法</h4>
<ul>
<li>为长期可维护性和团队知识传递做规划</li>
<li>在技术决策中考虑多个利益相关者的观点</li>
<li>为将来参考记录决策和推理</li>
<li>平衡即时需求与战略技术方向</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Observability：适用于 PHP 的 OpenTelemetry：EDOT PHP 加入 OpenTelemetry 项目]]></title>    <link>https://juejin.cn/post/7571304204753879094</link>    <guid>https://juejin.cn/post/7571304204753879094</guid>    <pubDate>2025-11-11T09:38:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204753879094" data-draft-id="7571077686108389439" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Observability：适用于 PHP 的 OpenTelemetry：EDOT PHP 加入 OpenTelemetry 项目"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-11-11T09:38:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Observability：适用于 PHP 的 OpenTelemetry：EDOT PHP 加入 OpenTelemetry 项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:38:14.000Z" title="Tue Nov 11 2025 09:38:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fobservability-labs%2Fauthor%2Fpawel-filipczak" title="https://www.elastic.co/observability-labs/author/pawel-filipczak" target="_blank" ref="nofollow noopener noreferrer">Pawel Filipczak</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06534fc5cfdd4100a4240b81f038a19b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458694&amp;x-signature=BC5mtMgZleq%2B8I3JOhsq4Tv5cDs%3D" alt="" loading="lazy"/></p>
<p>了解 Elastic 向 OpenTelemetry 社区捐赠其 EDOT PHP 的详情，并发现这如何让适用于 PHP 的 OpenTelemetry 变得更简单、更易用。</p>
<p>OpenTelemetry 社区已正式接受 Elastic 的提案，贡献其适用于 PHP 的 <strong>Elastic 版 OpenTelemetry（EDOT PHP）</strong>—— 这标志着为全球最广泛使用的网络语言之一带来一流可观测性的一个重要里程碑。</p>
<p>几十年来，PHP 支撑了从小型企业网站到大型 SaaS 平台的一切。然而，PHP 的可观测性通常需要手动设置、编译器、自定义扩展或修改应用代码 —— 这些挑战限制了其在生产环境中的采用。此次即将完成的捐赠旨在改变这一点，使适用于 PHP 的 OpenTelemetry 与<strong>其他运行时一样易于部署</strong>。</p>
<h2 data-id="heading-0">未来展望</h2>
<p>一旦贡献过程完成，EDOT PHP 将成为 OpenTelemetry 项目的一部分 —— 提供一个完整的、可用于生产的发行版，优化了性能、简便性和可扩展性。</p>
<p>EDOT PHP 为 PHP 可观测性引入了新方法：</p>
<ul>
<li>
<p><strong>简单安装</strong> —— 安装适用于 PHP 的 OpenTelemetry 将像安装标准系统包一样简单。从此，代理会自动检测并监控 PHP 应用 —— 无需修改代码，无需手动设置。</p>
</li>
<li>
<p><strong>自动代理加载</strong> —— 在云和容器环境中透明工作，无需修改应用部署。</p>
</li>
<li>
<p><strong>零配置</strong> —— 以单个自包含二进制文件发布；无需安装或编译任何外部扩展。</p>
</li>
<li>
<p><strong>原生 C++ 性能</strong> —— 内置 C++ 序列化器将遥测开销降低最多 5 倍。</p>
</li>
<li>
<p><strong>自动监控</strong> —— 开箱即用地监控流行框架和库。</p>
</li>
<li>
<p><strong>推断跨度</strong> —— 即使是未监控的代码路径，也能揭示行为，实现完整追踪覆盖。</p>
</li>
<li>
<p><strong>自动根跨度</strong> —— 即使在遗留或部分监控的应用中，也能确保完整追踪。</p>
</li>
<li>
<p><strong>OpAMP 准备</strong> —— 虽然 OpenTelemetry 社区仍在标准化配置模式和管理工作流，EDOT PHP 的实现已完全准备好支持这些即将到来的规范 —— 确保 OpAMP 生态成熟后无缝采用。</p>
</li>
<li>
<p><strong>异步后端通信</strong> —— 遥测数据异步导出到 OpenTelemetry Collector 或后端，不会阻塞被监控的应用。这确保了即使在高负载下，跨度和指标导出也不会增加用户请求延迟或影响响应时间。</p>
</li>
</ul>
<p>综合来看，这些功能使 EDOT PHP 成为首个真正零工作量的 PHP 可观测性解决方案 —— 从本地测试到云规模生产系统都适用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7baaffb460174b82add969a24d4567fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458694&amp;x-signature=u8OLrHz4qU9uiILLLS1SI%2Fp%2Bp7Y%3D" alt="" loading="lazy"/> EDOT PHP 中的原生 C++ 序列化器和异步导出管道将平均请求时间从 49 毫秒降低到 23 毫秒，比纯 PHP 实现快超过 2 倍。</p>
<h2 data-id="heading-1">在现有基础上构建</h2>
<p>EDOT PHP 并不替代现有的 OpenTelemetry PHP SDK —— 它是在其基础上进行扩展和增强。它将 SDK、自动监控和原生扩展打包为单个统一的代理包，与现有的 OpenTelemetry 规范和 API 无缝兼容。</p>
<p>通过贡献这项工作，Elastic 帮助 OpenTelemetry 社区加速 PHP 的采用，实现跨语言的一致实现，并让分布式追踪真正普及。</p>
<blockquote>
<p>这不是一次交接 —— 而是一次合作。我们贡献了多年的开发成果，以帮助适用于 PHP 的 OpenTelemetry 更快发展、更高效运行，并覆盖每个环境中的更多用户。</p>
<p>Elastic Observability 团队</p>
</blockquote>
<h2 data-id="heading-2">持续改进</h2>
<p>在 EDOT PHP 集成到 OpenTelemetry 之前，Elastic 仍在持续投资推进其发展。团队目前重点关注<strong>降低资源使用和内存占用</strong>，尤其是在<strong>多工作进程服务器环境</strong>中，如 PHP-FPM 或 Apache prefork。这些优化旨在使代理在高负载下更加可预测和高效 —— 确保即使在大规模生产部署中，遥测仍保持轻量。</p>
<p>除此之外，我们正在探索进一步的改进，以提升性能和互操作性。研究的方向包括高并发场景下更智能的协调、更好地在工作进程间共享遥测资源，以及未来与额外 OpenTelemetry 信号（如指标和日志）的对齐。</p>
<p>这些努力将帮助 EDOT PHP 不仅更快，而且更具适应性，并能无缝集成到多样的运行时架构中。</p>
<h2 data-id="heading-3">重要性</h2>
<p>这项贡献不仅关乎性能 —— 更在于<strong>消除障碍</strong>。通过使适用于 PHP 的 OpenTelemetry 可作为简单系统包安装，并自动加载到正在运行的应用中，该项目向每位 PHP 开发者、运维人员和平台提供者开放可观测性。</p>
<p>对于 OpenTelemetry 生态系统而言，它填补了最后一个主要语言空白，将可视化扩展到互联网上的绝大部分 —— 所有这些都在开放治理和社区协作下进行。</p>
<h2 data-id="heading-4">展望未来</h2>
<p>在接下来的几个月里，Elastic 与 OpenTelemetry PHP SIG 将紧密合作，推进技术集成、文档和社区入门流程。一旦过渡完成，开发者将获得一个完全开源、社区驱动、可用于生产的 OpenTelemetry 代理 —— “开箱即用”，无需摩擦、配置或修改代码。</p>
<p>我们共同构建一个未来，使<strong>可观测性真正无障碍 —— 适用于每种语言、每个框架和每种环境</strong>。</p>
<h2 data-id="heading-5">更多信息：</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fopentelemetry" title="https://www.elastic.co/docs/reference/opentelemetry" target="_blank" ref="nofollow noopener noreferrer">EDOT 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fobservability-labs%2Fblog%2Felastic-managed-otlp-endpoint-for-opentelemetry" title="https://www.elastic.co/observability-labs/blog/elastic-managed-otlp-endpoint-for-opentelemetry" target="_blank" ref="nofollow noopener noreferrer">了解</a> OTLP Endpoint</li>
</ul>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fobservability-labs%2Fblog%2Fopentelemetry-accepts-elastics-donation-of-edot" title="https://www.elastic.co/observability-labs/blog/opentelemetry-accepts-elastics-donation-of-edot" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/observabili…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解集群消费与广播消费的进度管理策略]]></title>    <link>https://juejin.cn/post/7571077686108520511</link>    <guid>https://juejin.cn/post/7571077686108520511</guid>    <pubDate>2025-11-11T09:48:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571077686108520511" data-draft-id="7571077686108438591" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解集群消费与广播消费的进度管理策略"/> <meta itemprop="keywords" content="RocketMQ"/> <meta itemprop="datePublished" content="2025-11-11T09:48:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解集群消费与广播消费的进度管理策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:48:59.000Z" title="Tue Nov 11 2025 09:48:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎯 RocketMQ 消费进度管理机制详解</h2>
<blockquote>
<p>深入理解集群消费与广播消费的进度管理策略</p>
</blockquote>
<h3 data-id="heading-1">💡 核心概念</h3>
<p><strong>关键理解：ConsumeQueue 本身不记录消费进度！</strong></p>
<p>ConsumeQueue 只是一个<strong>消息索引</strong>，它存储的是消息在 CommitLog 中的位置信息，是一个<strong>只读的、所有消费者共享的数据结构</strong>。</p>
<p>**消费进度（Offset）**是单独存储和管理的，存储位置根据消费模式不同而不同：</p>
<ul>
<li><strong>集群消费模式：</strong> 进度存储在 Broker 端（远程存储）</li>
<li><strong>广播消费模式：</strong> 进度存储在 Consumer 端（本地存储）</li>
</ul>
<hr/>
<h3 data-id="heading-2">🔄 两种消费模式</h3>
<h4 data-id="heading-3">📊 消费模式对比图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph Modes["RocketMQ 消费模式"]
        direction LR
        
        subgraph Clustering["集群消费 CLUSTERING"]
            C1["ConsumerGroup&lt;br/&gt;共享消费"]
            C1_1["Consumer 1"]
            C1_2["Consumer 2"]
            C1_3["Consumer 3"]
            OFF1["Broker存储进度&lt;br/&gt;共享Offset"]
            
            C1 --&gt; C1_1
            C1 --&gt; C1_2
            C1 --&gt; C1_3
            C1_1 -.-&gt; OFF1
            C1_2 -.-&gt; OFF1
            C1_3 -.-&gt; OFF1
        end
        
        subgraph Broadcasting["广播消费 BROADCASTING"]
            B1["ConsumerGroup&lt;br/&gt;独立消费"]
            B1_1["Consumer 1&lt;br/&gt;本地Offset"]
            B1_2["Consumer 2&lt;br/&gt;本地Offset"]
            B1_3["Consumer 3&lt;br/&gt;本地Offset"]
            
            B1 --&gt; B1_1
            B1 --&gt; B1_2
            B1 --&gt; B1_3
        end
    end
</code></pre>
<hr/>
<h4 data-id="heading-4">🟢 集群消费模式（CLUSTERING）</h4>
<h5 data-id="heading-5">特点</h5>
<ul>
<li><strong>负载均衡：</strong> 同一个 ConsumerGroup 中的消费者会分摊消息</li>
<li><strong>每条消息只被消费一次：</strong> 一个 Queue 的消息只会被分配给一个 Consumer</li>
<li><strong>进度共享：</strong> 同一个 ConsumerGroup 内的所有 Consumer 共享消费进度</li>
<li><strong>Broker 存储：</strong> 消费进度保存在 Broker 端，便于集中管理和监控</li>
</ul>
<h5 data-id="heading-6">消费进度存储位置</h5>
<pre><code class="hljs language-arduino" lang="arduino">Broker 端存储路径：
$ROCKETMQ_HOME/store/config/consumerOffset.json

存储格式：
{
  <span class="hljs-string">"offsetTable"</span>: {
    <span class="hljs-string">"order-topic@order-consumer-group"</span>: {
      <span class="hljs-string">"0"</span>: <span class="hljs-number">1234</span>,   <span class="hljs-comment">// Queue 0 的消费进度</span>
      <span class="hljs-string">"1"</span>: <span class="hljs-number">5678</span>,   <span class="hljs-comment">// Queue 1 的消费进度</span>
      <span class="hljs-string">"2"</span>: <span class="hljs-number">9012</span>,   <span class="hljs-comment">// Queue 2 的消费进度</span>
      <span class="hljs-string">"3"</span>: <span class="hljs-number">3456</span>    <span class="hljs-comment">// Queue 3 的消费进度</span>
    }
  }
}
</code></pre>
<h5 data-id="heading-7">工作流程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant C1 as Consumer1
    participant C2 as Consumer2
    participant B as Broker
    participant CQ as ConsumeQueue
    participant CL as CommitLog

    Note over C1,C2: 同一个 ConsumerGroup
    
    C1-&gt;&gt;B: 拉取 Queue0 消息
    B-&gt;&gt;B: 查询 Queue0 的 Offset (如: 100)
    B-&gt;&gt;CQ: 从 Offset=100 开始查询
    CQ-&gt;&gt;CL: 根据索引读取消息
    CL--&gt;&gt;B: 返回消息内容
    B--&gt;&gt;C1: 推送消息
    
    C1-&gt;&gt;C1: 消费消息
    C1-&gt;&gt;B: 提交新 Offset (如: 110)
    B-&gt;&gt;B: 更新 consumerOffset.json
    
    Note over C2: Consumer2 同时处理其他 Queue
    C2-&gt;&gt;B: 拉取 Queue1 消息
    B-&gt;&gt;B: 查询 Queue1 的 Offset
</code></pre>
<h5 data-id="heading-8">典型应用场景</h5>
<ul>
<li><strong>订单处理系统：</strong> 保证每个订单只被处理一次</li>
<li><strong>日志收集：</strong> 多个消费者分摊处理大量日志</li>
<li><strong>数据同步：</strong> 多个消费者并行同步数据，提高效率</li>
</ul>
<hr/>
<h4 data-id="heading-9">🔵 广播消费模式（BROADCASTING）</h4>
<h5 data-id="heading-10">特点</h5>
<ul>
<li><strong>全量消费：</strong> 每个 Consumer 都会收到所有消息</li>
<li><strong>独立进度：</strong> 每个 Consumer 维护自己的消费进度</li>
<li><strong>本地存储：</strong> 消费进度保存在各自的本地文件系统</li>
<li><strong>无负载均衡：</strong> 不会分配 Queue，每个 Consumer 都消费所有 Queue</li>
</ul>
<h5 data-id="heading-11">消费进度存储位置</h5>
<pre><code class="hljs language-perl" lang="perl">Consumer 本地存储路径：
~<span class="hljs-regexp">/.rocketmq_offsets/</span>${clientId}/${ConsumerGroup}/offsets.json

存储格式：
{
  <span class="hljs-string">"offsetTable"</span>: {
    <span class="hljs-string">"config-topic@broker-a@0"</span>: <span class="hljs-number">123</span>,
    <span class="hljs-string">"config-topic@broker-a@1"</span>: <span class="hljs-number">456</span>,
    <span class="hljs-string">"config-topic@broker-a@2"</span>: <span class="hljs-number">789</span>,
    <span class="hljs-string">"config-topic@broker-a@3"</span>: <span class="hljs-number">101</span>
  }
}
</code></pre>
<h5 data-id="heading-12">工作流程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant C1 as Consumer1&lt;br/&gt;(本地Offset)
    participant C2 as Consumer2&lt;br/&gt;(本地Offset)
    participant B as Broker
    participant CQ as ConsumeQueue

    Note over C1,C2: 同一个 ConsumerGroup&lt;br/&gt;但独立消费

    par Consumer1 消费
        C1-&gt;&gt;C1: 读取本地 Offset
        C1-&gt;&gt;B: 拉取消息(从本地Offset开始)
        B-&gt;&gt;CQ: 查询所有 Queue
        CQ--&gt;&gt;B: 返回消息索引
        B--&gt;&gt;C1: 推送消息
        C1-&gt;&gt;C1: 消费消息
        C1-&gt;&gt;C1: 更新本地 Offset
    and Consumer2 消费
        C2-&gt;&gt;C2: 读取本地 Offset
        C2-&gt;&gt;B: 拉取消息(从本地Offset开始)
        B-&gt;&gt;CQ: 查询所有 Queue
        CQ--&gt;&gt;B: 返回消息索引
        B--&gt;&gt;C2: 推送消息
        C2-&gt;&gt;C2: 消费消息
        C2-&gt;&gt;C2: 更新本地 Offset
    end

    Note over C1,C2: 两个 Consumer 收到相同的消息&lt;br/&gt;但进度独立管理
</code></pre>
<h5 data-id="heading-13">典型应用场景</h5>
<ul>
<li><strong>配置推送：</strong> 应用配置更新，所有实例都需要接收</li>
<li><strong>缓存刷新：</strong> 缓存失效通知，所有节点都需要更新</li>
<li><strong>实时监控：</strong> 多个监控系统同时接收相同的监控数据</li>
</ul>
<hr/>
<h3 data-id="heading-14">📊 集群消费与广播消费对比</h3>













































<table><thead><tr><th>维度</th><th>集群消费（CLUSTERING）</th><th>广播消费（BROADCASTING）</th></tr></thead><tbody><tr><td><strong>消息分配</strong></td><td>负载均衡，每条消息只被一个Consumer消费</td><td>每个Consumer都收到所有消息</td></tr><tr><td><strong>进度存储位置</strong></td><td>Broker 端（远程）</td><td>Consumer 端（本地）</td></tr><tr><td><strong>进度管理</strong></td><td>ConsumerGroup 共享进度</td><td>每个Consumer独立管理进度</td></tr><tr><td><strong>扩展性</strong></td><td>增加Consumer可以提高消费能力</td><td>增加Consumer不会提高消费能力</td></tr><tr><td><strong>可靠性</strong></td><td>高（Broker集中管理）</td><td>中（依赖本地文件）</td></tr><tr><td><strong>监控难度</strong></td><td>容易（集中查询）</td><td>困难（分散在各个Consumer）</td></tr><tr><td><strong>典型场景</strong></td><td>订单处理、日志收集</td><td>配置推送、缓存刷新</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-15">🛠️ 消费进度管理详解</h3>
<h4 data-id="heading-16">集群模式的进度管理机制</h4>
<h5 data-id="heading-17">1. 进度提交流程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Consumer消费消息] --&gt; B[返回CONSUME_SUCCESS]
    B --&gt; C[框架自动提交Offset]
    C --&gt; D[更新内存中的Offset]
    D --&gt; E[定期持久化到Broker]
    
    E --&gt; F[Broker写入consumerOffset.json]
    
    style A fill:#e3f2fd
    style F fill:#e8f5e9
</code></pre>
<h5 data-id="heading-18">2. 进度存储结构</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"offsetTable"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"TopicTest@GroupTest"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"0"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12345</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// MessageQueue: broker-a, queueId=0, offset=12345</span>
      <span class="hljs-attr">"1"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">67890</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// MessageQueue: broker-a, queueId=1, offset=67890</span>
      <span class="hljs-attr">"2"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">23456</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// MessageQueue: broker-b, queueId=0, offset=23456</span>
      <span class="hljs-attr">"3"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">78901</span>      <span class="hljs-comment">// MessageQueue: broker-b, queueId=1, offset=78901</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"OrderTopic@OrderGroup"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"0"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"1"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2000</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-19">3. 关键特性</h5>
<ul>
<li><strong>自动持久化：</strong> Consumer 定期（默认 5 秒）将内存中的 Offset 持久化到 Broker</li>
<li><strong>故障恢复：</strong> Consumer 重启后，从 Broker 读取上次的 Offset 继续消费</li>
<li><strong>重平衡支持：</strong> Consumer 增减时，新分配的 Queue 会从 Broker 获取上次的进度</li>
</ul>
<hr/>
<h4 data-id="heading-20">广播模式的进度管理机制</h4>
<h5 data-id="heading-21">1. 进度提交流程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Consumer消费消息] --&gt; B[返回CONSUME_SUCCESS]
    B --&gt; C[框架自动提交Offset]
    C --&gt; D[更新内存中的Offset]
    D --&gt; E[定期持久化到本地文件]
    
    E --&gt; F[写入~/.rocketmq_offsets/]
    
    style A fill:#e3f2fd
    style F fill:#fff3e0
</code></pre>
<h5 data-id="heading-22">2. 本地存储路径</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Linux/Mac</span>
~/.rocketmq_offsets/<span class="hljs-variable">${clientId}</span>/<span class="hljs-variable">${ConsumerGroup}</span>/offsets.json

<span class="hljs-comment"># Windows</span>
C:\Users\<span class="hljs-variable">${username}</span>\.rocketmq_offsets\<span class="hljs-variable">${clientId}</span>\<span class="hljs-variable">${ConsumerGroup}</span>\offsets.json

<span class="hljs-comment"># 示例</span>
/home/user/.rocketmq_offsets/192.168.1.100@12345/config-consumer-group/offsets.json
</code></pre>
<h5 data-id="heading-23">3. 存储格式</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"offsetTable"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ConfigTopic@broker-a@0"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ConfigTopic@broker-a@1"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ConfigTopic@broker-a@2"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">300</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ConfigTopic@broker-a@3"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">400</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-24">4. 关键特性</h5>
<ul>
<li><strong>本地管理：</strong> Broker 不存储任何广播模式的消费进度</li>
<li><strong>独立恢复：</strong> 每个 Consumer 重启后从自己的本地文件恢复进度</li>
<li><strong>无中心化：</strong> 无法在 Broker 端统一查询所有 Consumer 的进度</li>
</ul>
<hr/>
<h3 data-id="heading-25">💻 代码示例</h3>
<h4 data-id="heading-26">集群消费模式配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 代码示例 - 集群消费模式</span>
<span class="hljs-type">DefaultMQPushConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQPushConsumer</span>(<span class="hljs-string">"order-consumer-group"</span>);
consumer.setNamesrvAddr(<span class="hljs-string">"192.168.1.100:9876"</span>);

<span class="hljs-comment">// 设置为集群消费模式（默认）</span>
consumer.setMessageModel(MessageModel.CLUSTERING);

consumer.subscribe(<span class="hljs-string">"OrderTopic"</span>, <span class="hljs-string">"*"</span>);

consumer.registerMessageListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageListenerConcurrently</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ConsumeConcurrentlyStatus <span class="hljs-title function_">consumeMessage</span><span class="hljs-params">(
            List&lt;MessageExt&gt; msgs, 
            ConsumeConcurrentlyContext context)</span> {
        
        <span class="hljs-keyword">for</span> (MessageExt msg : msgs) {
            <span class="hljs-comment">// 处理消息</span>
            System.out.println(<span class="hljs-string">"消费消息: "</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(msg.getBody()));
        }
        
        <span class="hljs-comment">// 返回成功，框架会自动提交消费进度到 Broker</span>
        <span class="hljs-keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
    }
});

consumer.start();

<span class="hljs-comment">// 注意：</span>
<span class="hljs-comment">// 1. 消费进度自动保存到 Broker</span>
<span class="hljs-comment">// 2. 同一个 ConsumerGroup 的消费者会分摊消息</span>
<span class="hljs-comment">// 3. 消费者重启后从 Broker 恢复进度</span>
</code></pre>
<h4 data-id="heading-27">广播消费模式配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 代码示例 - 广播消费模式</span>
<span class="hljs-type">DefaultMQPushConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQPushConsumer</span>(<span class="hljs-string">"config-consumer-group"</span>);
consumer.setNamesrvAddr(<span class="hljs-string">"192.168.1.100:9876"</span>);

<span class="hljs-comment">// 设置为广播消费模式</span>
consumer.setMessageModel(MessageModel.BROADCASTING);

consumer.subscribe(<span class="hljs-string">"ConfigUpdateTopic"</span>, <span class="hljs-string">"*"</span>);

consumer.registerMessageListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageListenerConcurrently</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ConsumeConcurrentlyStatus <span class="hljs-title function_">consumeMessage</span><span class="hljs-params">(
            List&lt;MessageExt&gt; msgs, 
            ConsumeConcurrentlyContext context)</span> {
        
        <span class="hljs-keyword">for</span> (MessageExt msg : msgs) {
            <span class="hljs-comment">// 处理配置更新</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(msg.getBody());
            System.out.println(<span class="hljs-string">"收到配置更新: "</span> + config);
            <span class="hljs-comment">// 更新本地配置</span>
            updateLocalConfig(config);
        }
        
        <span class="hljs-comment">// 返回成功，框架会自动保存进度到本地文件</span>
        <span class="hljs-keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
    }
});

consumer.start();

<span class="hljs-comment">// 注意：</span>
<span class="hljs-comment">// 1. 消费进度自动保存到本地文件</span>
<span class="hljs-comment">// 2. 每个消费者都会收到所有消息</span>
<span class="hljs-comment">// 3. 消费者重启后从本地文件恢复进度</span>
<span class="hljs-comment">// 4. 本地进度文件路径: ~/.rocketmq_offsets/</span>
</code></pre>
<h4 data-id="heading-28">手动管理消费进度</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查询消费进度（集群模式）</span>
<span class="hljs-type">long</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> consumer.getOffsetStore().readOffset(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueue</span>(<span class="hljs-string">"OrderTopic"</span>, <span class="hljs-string">"broker-a"</span>, <span class="hljs-number">0</span>),
    ReadOffsetType.READ_FROM_STORE
);
System.out.println(<span class="hljs-string">"当前消费进度: "</span> + offset);

<span class="hljs-comment">// 重置消费进度（集群模式）</span>
consumer.getOffsetStore().updateOffset(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueue</span>(<span class="hljs-string">"OrderTopic"</span>, <span class="hljs-string">"broker-a"</span>, <span class="hljs-number">0</span>),
    <span class="hljs-number">1000L</span>,  <span class="hljs-comment">// 新的 offset</span>
    <span class="hljs-literal">false</span>
);

<span class="hljs-comment">// 持久化进度</span>
consumer.getOffsetStore().persistAll(
    Collections.singleton(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueue</span>(<span class="hljs-string">"OrderTopic"</span>, <span class="hljs-string">"broker-a"</span>, <span class="hljs-number">0</span>)
    )
);
</code></pre>
<hr/>
<h3 data-id="heading-29">❓ 常见问题解答</h3>
<h4 data-id="heading-30">Q1: 为什么集群模式下多个消费者不会重复消费？</h4>
<p><strong>A:</strong> 因为 RocketMQ 有负载均衡机制。一个 Queue 只会分配给一个 Consumer，所以不会重复消费。</p>
<ul>
<li>假设有 4 个 Queue，2 个 Consumer</li>
<li>Consumer1 分配到 Queue0 和 Queue1</li>
<li>Consumer2 分配到 Queue2 和 Queue3</li>
<li>他们各自消费不同的 Queue，进度独立记录</li>
</ul>
<hr/>
<h4 data-id="heading-31">Q2: 广播模式下，如果有 100 个消费者，是否需要 100 份进度记录？</h4>
<p><strong>A:</strong> 是的！但这些进度记录不在 Broker，而是分散在各个消费者的本地文件系统中。</p>
<ul>
<li>每个消费者在自己的机器上维护进度</li>
<li>Broker 不需要为广播模式存储任何进度信息</li>
<li>这也是为什么广播模式无法集中管理进度的原因</li>
</ul>
<hr/>
<h4 data-id="heading-32">Q3: ConsumeQueue 和消费进度（Offset）的关系是什么？</h4>
<p><strong>A:</strong> 可以类比为"书"和"书签"的关系：</p>
<ul>
<li><strong>ConsumeQueue：</strong> 就像一本书的目录，告诉你每页内容在哪里</li>
<li><strong>消费进度（Offset）：</strong> 就像书签，记录你读到第几页了</li>
<li>所有人看的是同一本书（ConsumeQueue），但每个人的书签（Offset）可以不一样</li>
</ul>
<hr/>
<h4 data-id="heading-33">Q4: 如果 Consumer 崩溃了，消费进度会丢失吗？</h4>
<p><strong>A:</strong> 取决于消费模式：</p>
<ul>
<li><strong>集群模式：</strong> 不会丢失，因为进度存储在 Broker，Consumer 重启后可以恢复</li>
<li><strong>广播模式：</strong> 如果本地文件没有损坏，也不会丢失；但如果本地文件损坏或删除，则会从头开始消费</li>
</ul>
<hr/>
<h4 data-id="heading-34">Q5: 能否让广播模式的进度也存储在 Broker？</h4>
<p><strong>A:</strong> 理论上可以实现，但 RocketMQ 没有这样设计，原因：</p>
<ul>
<li>广播模式的消费者数量可能非常多（成百上千）</li>
<li>如果都存储在 Broker，会给 Broker 带来巨大的存储和管理压力</li>
<li>广播模式的典型场景（配置推送）对进度管理要求不高</li>
<li>本地存储更加轻量、高效</li>
</ul>
<hr/>
<h3 data-id="heading-35">📝 总结</h3>
<h4 data-id="heading-36">核心要点回顾</h4>
<ol>
<li>
<p><strong>ConsumeQueue 只是索引，不记录消费进度</strong></p>
<ul>
<li>ConsumeQueue 是只读的、共享的数据结构</li>
<li>它只负责快速定位消息在 CommitLog 中的位置</li>
</ul>
</li>
<li>
<p><strong>消费进度（Offset）是单独管理的</strong></p>
<ul>
<li>集群模式：存储在 Broker，由 ConsumerGroup 共享</li>
<li>广播模式：存储在各个 Consumer 本地文件</li>
</ul>
</li>
<li>
<p><strong>两种消费模式的本质区别</strong></p>
<ul>
<li>集群模式：负载均衡，消息只被消费一次</li>
<li>广播模式：全量消费，每个消费者都收到所有消息</li>
</ul>
</li>
<li>
<p><strong>进度管理策略的权衡</strong></p>
<ul>
<li>集群模式：集中管理，便于监控和恢复</li>
<li>广播模式：分散管理，轻量高效但难以统一查看</li>
</ul>
</li>
</ol>
<hr/>
<h4 data-id="heading-37">架构总览</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph RocketMQ["RocketMQ 完整架构"]
        direction TB
        
        subgraph Storage["存储层"]
            CL[CommitLog&lt;br/&gt;消息存储]
            CQ[ConsumeQueue&lt;br/&gt;消息索引&lt;br/&gt;不记录进度]
            
            CL -.-&gt; CQ
        end
        
        subgraph Offset["进度管理层"]
            direction LR
            
            subgraph Cluster["集群模式"]
                BOff["Broker端&lt;br/&gt;集中存储"]
            end
            
            subgraph Broadcast["广播模式"]
                LOff["Consumer端&lt;br/&gt;本地存储"]
            end
        end
        
        subgraph Consumer["消费层"]
            CMode["消费模式选择"]
            
            CMode --&gt; ClusterC["集群消费&lt;br/&gt;负载均衡"]
            CMode --&gt; BroadC["广播消费&lt;br/&gt;全量消费"]
        end
        
        CQ --&gt; CMode
        ClusterC -.-&gt;|读写进度| BOff
        BroadC -.-&gt;|读写进度| LOff
    end
</code></pre>
<hr/>
<h4 data-id="heading-38">🎯 关键记忆点</h4>
<p><strong>ConsumeQueue 是"地图"，Offset 是"你的位置"。</strong></p>
<p>地图（ConsumeQueue）是公开的，所有人都可以看；但每个人的位置（Offset）是私有的，需要各自记录。在集群模式下，大家的位置记录在 Broker 的统一记录本上；在广播模式下，每个人都在自己的小本子上记录。</p>
<hr/>
<blockquote>
<p>希望这份文档能帮助您彻底理解 RocketMQ 的消费进度管理机制！</p>
<p>© 2025 - 深入浅出 RocketMQ</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[被问性能后，我封装了这个 PHP 错误上报工具]]></title>    <link>https://juejin.cn/post/7571102074038747177</link>    <guid>https://juejin.cn/post/7571102074038747177</guid>    <pubDate>2025-11-11T09:49:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571102074038747177" data-draft-id="7571102074038698025" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="被问性能后，我封装了这个 PHP 错误上报工具"/> <meta itemprop="keywords" content="PHP,Composer"/> <meta itemprop="datePublished" content="2025-11-11T09:49:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏琢玉"/> <meta itemprop="url" content="https://juejin.cn/user/3551890356308556"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            被问性能后，我封装了这个 PHP 错误上报工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3551890356308556/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏琢玉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:49:56.000Z" title="Tue Nov 11 2025 09:49:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近我把自己常用的一套错误上报逻辑封装成了一个 Composer 包，叫 <strong>​<code>hejunjie/lazylog</code>​</strong>。<br/>
功能很简单也很实用：<strong>安全地写本地日志 + 把异常信息上报到远端（支持同步/异步）</strong> 。本文讲讲为什么我要做这个库、实现思路、在不同运行环境下如何选择（以及我推荐的优化方案）。</p>
<hr/>
<h2 data-id="heading-0">起因：为啥要做这个工具？</h2>
<p>先讲个背景。之前我写了一个 Go 项目 —— <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzxc7563598%2Foh-shit-logger" target="_blank" title="https://github.com/zxc7563598/oh-shit-logger" ref="nofollow noopener noreferrer">oh-shit-logger</a>，目标是把不同语言、不同项目里的错误集中收集到一个地方。Go 做服务天然快、部署也简单： GitHub Actions自动打包，我只要把包丢主机上一键启动就好了。</p>
<p>但上线后有朋友问：</p>
<blockquote>
<p>“PHP 上报错误会不会太耗性能？网络 I/O 会不会成为瓶颈？”</p>
</blockquote>
<p>这是个很合理的问题。网络 I/O 的确有成本，但异常本身在多数系统里不是那种持续不断、高频率的事件（如果异常多到经常并发，那系统可能已经在出问题了）。</p>
<p>与其空谈“会不会慢”，我更愿意把常用做法封装一下，直接给出一个实战好用的方案——于是 <code>hejunjie/lazylog</code> 诞生了。</p>
<hr/>
<h2 data-id="heading-1">思路概览：伪异步 + 可回退的同步</h2>
<p>​<code>lazylog</code> 的核心思路很简单：</p>
<ul>
<li><strong>本地写日志</strong>：线程安全、支持按行数/大小自动切分，长期运行不会把单个日志文件撑爆。</li>
<li><strong>远程上报</strong>：提供两种方式：
<ul>
<li><strong>异步上报（伪异步）</strong> ：通过 <code>proc_open()</code> 或 <code>exec()</code> fork 出一个 PHP CLI 子进程来发送 HTTP POST，不阻塞主进程。适用于 PHP-FPM、一次性 CLI 脚本等短生命周期环境。</li>
<li><strong>同步上报</strong>：直接在当前进程做一个带超时的 HTTP POST，适合常驻内存框架（Webman、Swoole、RoadRunner 等）或需要保证上报结果的场景。</li>
</ul>
</li>
</ul>
<p>我把这些行为都封装在一个很小的包里：<code>composer require hejunjie/lazylog</code>，在任何项目里都能快速复用。</p>
<hr/>
<h2 data-id="heading-2">异步实现细节：为什么是“伪异步”？</h2>
<p>PHP 没有内置线程（除非用扩展），但我们可以通过子进程实现“非阻塞式”的上报：</p>
<ul>
<li>​<code>proc_open()</code>：启动子进程并可拿到 stdin/stdout/stderr，控制能力强；但会创建管道资源，需要注意关闭管道以免资源泄露。</li>
<li>​<code>exec()</code>：简单粗暴，把命令交给 shell 去做 <code>fork</code>，父进程可立即返回（命令后面加 <code>&amp;</code>）。语义上更轻量，但控制能力弱。</li>
</ul>
<p>两者的本质都是 fork 一个新进程去跑 PHP CLI，然后子进程读取临时文件（或者接收传参）、发 POST、删临时文件、退出。主进程不会等子进程走完就返回给用户，所以对用户体验几乎零影响。</p>
<p><strong>优点</strong>：实现简单、跨平台、即插即用；适合错误信息本身不高频的场景。<br/>
<strong>缺点</strong>：在“极高并发”场景下（比如每秒上千条错误）会比较吃资源，子进程启动和网络请求仍然有成本。</p>
<hr/>
<h2 data-id="heading-3">常驻内存框架（Webman/Swoole）该怎么办？</h2>
<p>这是个重要的实践问题：<strong>在常驻内存框架中，我更推荐用同步上报或队列，而不是频繁 fork 子进程。</strong></p>
<p>原因很直观：</p>
<ul>
<li>常驻框架的 Worker 是长期存在的，fork 子进程会带来额外的资源管理问题（僵尸进程、内存增长、文件描述符等）。</li>
<li>同步上报虽然会阻塞当前 Worker，但只影响当前 Worker，不会像在传统短生命周期中影响整个请求模型。对于大多数低频异常而言，这个阻塞代价是可以接受的。</li>
<li>更稳妥的做法是：<strong>把异常先格式化成数组，投递到队列，由专门的队列 worker 来异步上报</strong>。这样既避免了直接 fork，又能在不影响主流程的情况下批量/可靠地上报。</li>
</ul>
<p>我在包里同时提供了 <code>reportSync()</code>（同步上报）和 <code>reportAsync()</code>（伪异步上报），并提供 <code>Logger::formatThrowable()</code> 帮你把异常转成纯数据结构，方便推队列或序列化。</p>
<hr/>
<h2 data-id="heading-4">实际使用示例</h2>
<blockquote>
<p>这里只放伪代码以示意，实际代码见仓库。</p>
</blockquote>
<p><strong>本地写日志</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title class_">Logger</span>::<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-string">'/var/logs'</span>, <span class="hljs-string">'error/app.log'</span>, <span class="hljs-string">'Task Failed'</span>, [<span class="hljs-string">'msg'</span> =&gt; <span class="hljs-string">'something wrong'</span>]);
</code></pre>
<p><strong>短生命周期场景（异步上报）</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// ...</span>
} <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) {
  <span class="hljs-title class_">Logger</span>::<span class="hljs-title function_ invoke__">reportAsync</span>(<span class="hljs-variable">$e</span>, <span class="hljs-string">'https://your-collector/collect'</span>, <span class="hljs-string">'my-project'</span>);
}
</code></pre>
<p><strong>常驻框架（推荐同步或队列）</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// ...</span>
} <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) {
  <span class="hljs-comment">// 同步上报（简单、直接）</span>
  <span class="hljs-title class_">Logger</span>::<span class="hljs-title function_ invoke__">reportSync</span>(<span class="hljs-variable">$e</span>, <span class="hljs-string">'https://your-collector/collect'</span>, <span class="hljs-string">'my-project'</span>);

  <span class="hljs-comment">// 或者：转成数组，投递队列，由 Worker 负责上报（推荐）</span>
  <span class="hljs-variable">$payload</span> = <span class="hljs-title class_">Logger</span>::<span class="hljs-title function_ invoke__">formatThrowable</span>(<span class="hljs-variable">$e</span>, <span class="hljs-string">'my-project'</span>);
  <span class="hljs-title class_">Queue</span>::<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-string">'error_report'</span>, <span class="hljs-variable">$payload</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-5">性能那些事儿</h2>
<p>有人担心“网络 I/O 会把 PHP 卡死”。我的观点是：</p>
<ul>
<li><strong>错误本身通常是低频事件</strong>。如果你的系统错误频率高到持续占用大量带宽/请求，那说明系统正常运行已经有更严重的问题了。</li>
<li>对于多数业务，<strong>一次 fork 一个子进程并做一次 HTTP POST 的开销在可接受范围</strong>，用户体验影响极小。</li>
<li>在对性能要求极苛刻或错误量非常大的场景，正确做法是<strong>把上报变成队列 + 批量发送</strong>或将上报移动到专门的后端处理链路，而不是在业务路径里频繁 fork。</li>
</ul>
<p>总之：<strong>衡量利弊后选择适合你业务的方式</strong>。<code>lazylog</code> 提供了两端（sync/async）以及格式化功能，方便你按需设计。</p>
<hr/>
<h2 data-id="heading-6">最后</h2>
<p>我把它做成 composer 包的原因很直接：我希望 <strong>快速把 PHP 项目的错误上报到我自己的 Go 服务（oh-shit-logger）</strong> ，而不是每个项目都重复造轮子。把常用逻辑抽出来，项目里 <code>composer require hejunjie/lazylog</code> 就能统一上报方式——既省事又稳妥。</p>
<p>如果你想快速了解这个项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzread.ai%2Fzxc7563598%2Fphp-lazylog" target="_blank" title="https://zread.ai/zxc7563598/php-lazylog" ref="nofollow noopener noreferrer">Zread 解析文档</a></p>
<ul>
<li>如果你是在 <strong>PHP-FPM / CLI</strong> 的短生命周期环境：<code>reportAsync()</code> 很方便，能保证主流程不被阻塞。</li>
<li>如果你是在 <strong>Webman/Swoole 等常驻内存框架</strong>：优先考虑 <code>reportSync()</code> 或推队列再上报。</li>
<li>如果你面临的是<strong>极高并发的错误量</strong>：把上报放队列，批量发送，或交由专门的采集基础设施处理。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Webpack系列-构建性能优化实战：从开发到生产]]></title>    <link>https://juejin.cn/post/7571088527678914586</link>    <guid>https://juejin.cn/post/7571088527678914586</guid>    <pubDate>2025-11-11T09:51:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571088527678914586" data-draft-id="7571028035018899482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Webpack系列-构建性能优化实战：从开发到生产"/> <meta itemprop="keywords" content="前端,Webpack,性能优化"/> <meta itemprop="datePublished" content="2025-11-11T09:51:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云枫晖"/> <meta itemprop="url" content="https://juejin.cn/user/835284567331021"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Webpack系列-构建性能优化实战：从开发到生产
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/835284567331021/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云枫晖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:51:44.000Z" title="Tue Nov 11 2025 09:51:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>构建速度慢，是每一位前端开发者在使用 webpack 时都可能遇到的“心头之痛”。每次保存都要等上好几秒，热更新也变成了“热等待”，这不仅影响开发体验，更在无情地吞噬我们的高效编码时间。本文将从开发和生产两个维度，深入剖析 webpack 构建性能优化的原理与实战，助你彻底告别构建等待！</p>
<h2 data-id="heading-0">为什么你的 webpack 构建这么慢？</h2>
<p>在开始优化之前，我们首先需要建立一个核心认知：<strong>优化不是一蹴而就的，它是一个持续分析和改进的过程。</strong>  不同的项目瓶颈各不相同，盲目套用配置可能收效甚微。
构建速度主要消耗在以下几个方面：</p>
<ul>
<li><strong>模块解析和转换</strong>：特别是 <code>node_modules</code> 中的庞大库文件和复杂的 JSX/Babel 转译。</li>
<li><strong>插件/加载器执行</strong>：某些插件或加载器的执行逻辑本身就很耗时。</li>
<li><strong>输出文件生成</strong>：文件数量多、体积大，会导致写磁盘操作变慢。</li>
</ul>
<p>接下来，我们将兵分两路，针对<strong>开发环境</strong>（追求更快的启动速度和热更新）和<strong>生产环境</strong>（追求更小的打包体积和更快的构建流水线）分别制定优化策略。</p>
<h2 data-id="heading-1">开发环境的优化</h2>
<p>开发环境的终极目标是：<strong>更快的启动速度（<code>build</code>）和更快的二次编译速度（<code>rebuild</code>）</strong></p>
<h3 data-id="heading-2">1. 设置mode为development</h3>
<p>在<code>Webpack</code>中<code>mode</code>分为<code>none</code>、<code>development</code>、<code>production</code></p>
<ul>
<li><code>none</code>： <code>Webpack</code>将不会采用任何优化手段</li>
<li><code>development</code>：<code>Webpack</code>按照开发环境特点进行默认优化</li>
<li><code>production</code>：<code>Webpack</code>按照生产环境特点进行默认优化</li>
</ul>
<p><code>mode</code>设置为<code>development</code>，默认情况下将<code>optimization</code>选项不会开启代码压缩、作用域提升等优化。将能极大
提升构建速度</p>
<h3 data-id="heading-3">2. 添加缓存缓存</h3>
<p>在<code>Webpack5</code>带来了强大的持久化缓存，开发环境下非常有效的优化手段。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">cache</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'filesystem'</span>, <span class="hljs-comment">// 使用文件系统缓存</span>
    <span class="hljs-attr">buildDependencies</span>: {
      <span class="hljs-attr">config</span>: [__filename], <span class="hljs-comment">// 当 webpack 配置文件发生变化时，缓存失效</span>
    },
    <span class="hljs-attr">cacheDirectory</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'node_modules/.cache/webpack'</span>), <span class="hljs-comment">// 缓存存放位置</span>
  },
};
</code></pre>
<blockquote>
<p>💡提示<br/>
对于Webpack4项目，可以采用<code>cache-loader</code>，但是性能上不如Webpack5的内置缓存</p>
</blockquote>
<h3 data-id="heading-4">3. 缩小模块范围</h3>
<p>通过<code>resolve</code>选项告知<code>Webpack</code>在解析模块时，减少不必要的查找，可以节省大量时间。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-comment">// 优先使用 ES6 模块化语法的文件</span>
    <span class="hljs-attr">mainFields</span>: [<span class="hljs-string">'browser'</span>, <span class="hljs-string">'module'</span>, <span class="hljs-string">'main'</span>],
    <span class="hljs-comment">// 准确配置扩展名，减少尝试</span>
    <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'.js'</span>, <span class="hljs-string">'.jsx'</span>, <span class="hljs-string">'.ts'</span>, <span class="hljs-string">'.tsx'</span>, <span class="hljs-string">'.json'</span>],
    <span class="hljs-comment">// 使用别名，直接指向确切路径，避免递归查找</span>
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>),
      <span class="hljs-string">'react-dom'</span>: <span class="hljs-string">'@hot-loader/react-dom'</span>, <span class="hljs-comment">// 例如，使用热更新增强的 react-dom</span>
    },
    <span class="hljs-comment">// 限制在指定目录内查找，排除 node_modules 的层层递归（慎用，确保你的模块都在这里）</span>
    <span class="hljs-comment">// modules: [path.resolve(__dirname, 'src'), 'node_modules']</span>
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.jsx?$/</span>,
        <span class="hljs-comment">// 使用 include 精确指定需要处理的目录，排除 node_modules</span>
        <span class="hljs-attr">include</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>),
        <span class="hljs-attr">use</span>: <span class="hljs-string">'babel-loader'</span>
      }
    ]
  }
};
</code></pre>
<h3 data-id="heading-5">4. 使用更快的loader或轻量级插件</h3>
<h4 data-id="heading-6"><code>esbuild-loader</code>/<code>swc-loader</code>替代<code>babel-loader</code></h4>
<ul>
<li><code>esbuild-loader</code>/<code>swc-loader</code>替代<code>babel-loader</code>进行转译，因为它们由<code>Go</code>/<code>Rust</code>语言编写，速度极快。如果项目简单，建议采用<code>esbuild-loader</code>，如果项目需要更加接近<code>babel</code>并能更加完善的兼容的话，建议采用<code>swc-loader</code>。具体用法如下：</li>
</ul>
<h5 data-id="heading-7">在项目根目录下添加.swcrc文件</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"parser"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"syntax"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ecmascript"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"jsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"dynamicImport"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"numericSeparator"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"classPrivateProperty"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"classPrivateMethod"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"classProperty"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"functionBind"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"exportDefaultFrom"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"exportNamespaceFrom"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"transform"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"runtime"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"automatic"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"refresh"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"externalHelpers"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"keepClassNames"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"minify"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"compress"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"mangle"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"usage"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"coreJs"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"targets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"browsers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"&gt; 1%"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"last 2 versions"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"not ie &lt;= 8"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es6"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"minify"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-8">项目根目录添加.browserslistrc文件</h5>
<pre><code class="hljs language-text" lang="text">[production]
&gt; 0.5%
last 2 versions
Firefox ESR
not dead
not ie 11

[development]
last 1 chrome version
last 1 firefox version
last 1 safari version
</code></pre>
<p>SWC会自动读取<code>.browserslistrc</code>，根据不同环境获取对应配置。</p>
<h4 data-id="heading-9">移除不必要的插件</h4>
<p>在开发环境中有些插件是没有必要的，例如<code>MiniCssExtractPlugin</code>改用<code>style-loader</code>。因为<code>MiniCssExtractPlugin</code>不支持HMR。</p>
<h3 data-id="heading-10">5. devServer优化</h3>
<p>devSever优化主要是减少控制台的输出内容</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">devServer</span>: {
    <span class="hljs-attr">stats</span>: <span class="hljs-string">'minimal'</span> <span class="hljs-comment">// 减少控制台输出，从而提高re-build性能</span>
  }
}
</code></pre>
<h2 data-id="heading-11">生产环境优化</h2>
<p>生产环境的核心目标是：<strong>减少最终打包体积，并提升构建流水线的速度</strong>。</p>
<h3 data-id="heading-12">1. 采用多进程/多实例并行构建</h3>
<p>将耗时的加载器操作并行化，充分利用多核 CPU。可以采用<code>thread-loader</code>实现，将它放入其他加载器之前，其后的加载器会放入到worker池中运行。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.jsx?$/</span>,
        <span class="hljs-attr">include</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>),
        <span class="hljs-attr">use</span>: [
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'thread-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">workers</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>).<span class="hljs-title function_">cpus</span>().<span class="hljs-property">length</span> - <span class="hljs-number">1</span>, <span class="hljs-comment">// CPU 核心数 -1</span>
              <span class="hljs-attr">poolTimeout</span>: <span class="hljs-title class_">Infinity</span>, <span class="hljs-comment">// 防止进程退出</span>
            },
          },
          <span class="hljs-string">'babel-loader'</span>,
        ],
      },
    ],
  },
};
</code></pre>
<blockquote>
<p>📢 注意 <br/>
进程启动和通信有一定开销，在非常小的项目中可能达不到提高构建提速效果，反而会变慢</p>
</blockquote>
<h3 data-id="heading-13">2. 分包优化</h3>
<p>合理的分包可以充分利用浏览器缓存，虽然可能略微增加构建时间，但对长期缓存收益巨大。主要从几个方面考虑：</p>
<ul>
<li><strong>第三方库分离</strong>：将<code>node_modules</code>依赖进行提取，利用缓存，减少重复打包</li>
<li><strong>公共模块提取</strong> 提取重复引用多次的模块，减少代码体积</li>
<li><strong>动态导入语懒加载</strong> 使用<code>import()</code>动态导入/路由懒加载，按需加载，加速首屏</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// JS引入模块</span>
<span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: "my-chunk-name" */</span> <span class="hljs-string">'./module'</span>);
<span class="hljs-comment">// React 路由懒加载</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">Suspense</span>, lazy } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MyComponent</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./MyComponent'</span>));
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">MyComponent</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span>
  );
}
<span class="hljs-comment">// Vue路由懒加载</span>
<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/home'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/Home.vue'</span>) <span class="hljs-comment">// 访问/home时才会加载</span>
  }
];
</code></pre>
<ul>
<li><strong>运行时代码分离</strong> 避免频繁变更代码影响到库缓存</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">optimization</span>: {
  <span class="hljs-comment">// 提取运行时代码</span>
  <span class="hljs-attr">runtimeChunk</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"manifest"</span>,
  },
  <span class="hljs-attr">splitChunks</span>: {
    <span class="hljs-attr">chunks</span>: <span class="hljs-string">"all"</span>,
    <span class="hljs-attr">minSize</span>: <span class="hljs-number">20000</span>,
    <span class="hljs-attr">minChunks</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">cacheGroups</span>: {
      <span class="hljs-attr">vendor</span>: {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"vendors"</span>,
        <span class="hljs-attr">chunks</span>: <span class="hljs-string">"all"</span>,
        <span class="hljs-attr">priority</span>: <span class="hljs-number">20</span>, <span class="hljs-comment">// 优先级高</span>
      },
      <span class="hljs-attr">common</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"common"</span>,
        <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// 被两个及以上chunk引用才提取</span>
        <span class="hljs-attr">chunks</span>: <span class="hljs-string">"all"</span>,
        <span class="hljs-attr">priority</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 避免模块重复打包</span>
      },
    },
  },
},
</code></pre>
<h3 data-id="heading-14">3. 采用各种工具进行压缩</h3>
<h4 data-id="heading-15">Terser多进程并行压缩</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">TerserPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'terser-webpack-plugin'</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">optimization</span>: {
    <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">minimizer</span>: [
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>({
        <span class="hljs-attr">parallel</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启多进程并行</span>
        <span class="hljs-comment">// terserOptions: { ... }</span>
      }),
    ],
  },
};
</code></pre>
<h4 data-id="heading-16">css-minimizer-webpack-plugin插件对CSS进行压缩</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MiniCssExtractPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mini-css-extract-plugin'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CssMinimizerPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'css-minimizer-webpack-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,
        <span class="hljs-comment">// 使用 MiniCssExtractPlugin.loader 替换 style-loader</span>
        <span class="hljs-attr">use</span>: [<span class="hljs-title class_">MiniCssExtractPlugin</span>.<span class="hljs-property">loader</span>, <span class="hljs-string">'css-loader'</span>],
      },
    ],
  },
  <span class="hljs-attr">optimization</span>: {
    <span class="hljs-attr">minimizer</span>: [
      <span class="hljs-string">'...'</span>, <span class="hljs-comment">// 这表示继承 Webpack 默认的 JS 压缩器（如Terser）</span>
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">CssMinimizerPlugin</span>(),
    ],
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MiniCssExtractPlugin</span>({
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].[contenthash].css'</span>,
    }),
  ],
};
</code></pre>
<p>如果是大型项目的话，可以开启多进程并行进行压缩从而提高构建速度。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">CssMinimizerPlugin</span>({
  <span class="hljs-attr">parallel</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用并行压缩</span>
  <span class="hljs-comment">// parallel: 4, // 也可以指定具体的进程数量</span>
})
</code></pre>
<h4 data-id="heading-17">image-minimizer-webpack-plugin</h4>
<ul>
<li>安装依赖</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">npm i -D image-minimizer-webpack-plugin sharp imagemin-sharp
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageMinimizerPlugin</span>({
  <span class="hljs-attr">minimizer</span>: {
    <span class="hljs-attr">implementation</span>: <span class="hljs-title class_">ImageMinimizerPlugin</span>.<span class="hljs-property">sharpMinify</span>,
    <span class="hljs-attr">options</span>: {
      <span class="hljs-attr">encodeOptions</span>: {
        <span class="hljs-attr">mozjpeg</span>: {
          <span class="hljs-attr">quality</span>: <span class="hljs-number">80</span>,
        },
        <span class="hljs-attr">pngquant</span>: {
          <span class="hljs-attr">quality</span>: [<span class="hljs-number">0.8</span>, <span class="hljs-number">0.9</span>],
        },
        <span class="hljs-attr">webp</span>: {
          <span class="hljs-attr">quality</span>: <span class="hljs-number">80</span>,
        },
      },
    },
  },
}),
</code></pre>
<h3 data-id="heading-18">4. 精确匹配<code>externals</code></h3>
<p>对于一些通过 CDN 引入的巨型库（如 <code>echarts</code>, <code>three.js</code>），可以配置 <code>externals</code> 将其排除在打包范围之外。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">externals</span>: {
    <span class="hljs-attr">echarts</span>: <span class="hljs-string">'echarts'</span>,
  },
};
<span class="hljs-comment">// 然后在 index.html 中通过 &lt;script&gt; 标签引入 CDN 链接</span>
</code></pre>
<h3 data-id="heading-19">5. Tree Shaking</h3>
<p>Tree Shaking 就是 Webpack 在打包时帮你<strong>自动删除那些未被使用的代码（也称为 "dead-code"）</strong> ，这能有效减小最终打包文件的体积</p>
<h4 data-id="heading-20">合理配置sideEffects</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json 示例</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your-project"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
  <span class="hljs-comment">// 或者，如果你有需要保留副作用的文件</span>
  <span class="hljs-comment">// "sideEffects": [</span>
  <span class="hljs-comment">//   "*.css",</span>
  <span class="hljs-comment">//   "src/polyfill.js"</span>
  <span class="hljs-comment">// ]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-21">良好的编码习惯</h4>
<ul>
<li><strong>坚持使用ES6模块</strong> 因为<code>CommonJS</code>的<code>require()</code>具有动态性，<code>Webpack</code>难以进行静态分析。</li>
<li><strong>避免导入整个库</strong> 尽量使用具名导入引入需要使用的部分</li>
</ul>
<h2 data-id="heading-22">构建分析工具</h2>
<h3 data-id="heading-23">Webpack Bundle Analyzer</h3>
<p>它以可视化的树状图形式分析打包后文件的构成，帮助你发现体积过大的模块。</p>
<pre><code class="hljs language-bash" lang="bash">npm install --save-dev webpack-bundle-analyzer
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-bundle-analyzer'</span>).<span class="hljs-property">BundleAnalyzerPlugin</span>;

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span>({
      <span class="hljs-attr">analyzerMode</span>: <span class="hljs-string">'server'</span>, <span class="hljs-comment">// 启动一个本地服务器查看报告</span>
      <span class="hljs-attr">openAnalyzer</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 完成后自动打开浏览器</span>
    })
  ]
};
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3f1941f7f624f9a9be8dfc9acbce168~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5p6r5pmW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763459503&amp;x-signature=jscsBeuE02bucOCNTHGwIJbNt%2BI%3D" alt="image-20251110104912944.png" loading="lazy"/></p>
<p>通过该工具分析可以识别：</p>
<ul>
<li>较大依赖从而进行分包</li>
<li>检查重复代码</li>
<li>进行更加有效的代码分割</li>
</ul>
<h3 data-id="heading-24">Speed-measure-webpack-plugin</h3>
<p>主要测量各 loader 和 plugin 的执行时间，webpack5中<code>Speed-measure-webpack-plugin</code>与<code>mini-css-extract-plugin</code>之间存在兼容性问题</p>
<pre><code class="hljs language-bash" lang="bash">npm i -D speed-measure-webpack-plugin
</code></pre>
<p>具体配置</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HtmlWebpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"html-webpack-plugin"</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MiniCssExtractPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"mini-css-extract-plugin"</span>);
<span class="hljs-keyword">const</span> isProd = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">"production"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">SpeedMeasurePlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"speed-measure-webpack-plugin"</span>);
<span class="hljs-keyword">const</span> smp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpeedMeasurePlugin</span>({
  <span class="hljs-attr">outputFormat</span>: <span class="hljs-string">"humanVerbose"</span>,
  <span class="hljs-comment">// 排除影响的插件</span>
  <span class="hljs-attr">exclude</span>: [<span class="hljs-string">"/html-webpack-plugin/"</span>, <span class="hljs-string">"/mini-css-extract-plugin/"</span>],
});
<span class="hljs-keyword">const</span> webpackConfig = {
  <span class="hljs-attr">mode</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> || <span class="hljs-string">"development"</span>,
  <span class="hljs-attr">entry</span>: <span class="hljs-string">"./src/index.js"</span>,
  <span class="hljs-attr">devtool</span>: isProd ? <span class="hljs-string">"source-map"</span> : <span class="hljs-string">"eval-cheap-module-source-map"</span>,
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"dist"</span>),
    <span class="hljs-attr">filename</span>: <span class="hljs-string">"js/[name].[contenthash:8].bundle.js"</span>,
    <span class="hljs-attr">chunkFilename</span>: <span class="hljs-string">"js/[name].[contenthash:8].chunk.js"</span>,
    <span class="hljs-attr">clean</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">publicPath</span>: isProd ? <span class="hljs-string">"./"</span> : <span class="hljs-string">"/"</span>,
  },
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">extensions</span>: [<span class="hljs-string">".jsx"</span>, <span class="hljs-string">".js"</span>, <span class="hljs-string">".json"</span>],
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">"@"</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"src"</span>),
    },
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,
        <span class="hljs-attr">use</span>: [
          isProd
            ? {
                <span class="hljs-attr">loader</span>: <span class="hljs-title class_">MiniCssExtractPlugin</span>.<span class="hljs-property">loader</span>,
                <span class="hljs-attr">options</span>: {
                  <span class="hljs-attr">publicPath</span>: <span class="hljs-string">"../"</span>,
                },
              }
            : <span class="hljs-string">"style-loader"</span>,
          <span class="hljs-string">"css-loader"</span>,
        ],
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(js|jsx)$/</span>,
        <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>,
        <span class="hljs-attr">use</span>: <span class="hljs-string">"babel-loader"</span>,
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(png|jpe?g|gif|svg)$/i</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">"asset"</span>,
        <span class="hljs-attr">parser</span>: {
          <span class="hljs-attr">dataUrlCondition</span>: {
            <span class="hljs-attr">maxSize</span>: <span class="hljs-number">8</span> * <span class="hljs-number">1024</span>,
          },
        },
        <span class="hljs-attr">generator</span>: {
          <span class="hljs-attr">filename</span>: <span class="hljs-string">"images/[name].[hash:8][ext]"</span>,
        },
      },
    ],
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>({
      <span class="hljs-attr">template</span>: <span class="hljs-string">"./public/index.html"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">"index.html"</span>,
    }),
    ,
  ],
};
<span class="hljs-keyword">const</span> config = smp.<span class="hljs-title function_">wrap</span>(webpackConfig);
<span class="hljs-comment">// 在包裹之后添加MiniCssExtractPlugin插件</span>
config.<span class="hljs-property">plugins</span>.<span class="hljs-title function_">push</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">MiniCssExtractPlugin</span>({
    <span class="hljs-attr">filename</span>: <span class="hljs-string">"css/[name].[contenthash:8].css"</span>,
    <span class="hljs-attr">chunkFilename</span>: <span class="hljs-string">"css/[name].[contenthash:8].chunk.css"</span>,
  })
);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = config;
</code></pre>
<p>构建后会在<code>控制台</code>中输出信息:</p>
<pre><code class="hljs language-text" lang="text">SMP  ⏱  
General output time took 2,375 ms

 SMP  ⏱  Plugins
HtmlWebpackPlugin took 80 ms

 SMP  ⏱  Loaders
babel-loader took 409 ms
  median       = 392 ms
  mean         = 205 ms
  s.d.         = 265.166 ms
  range        = (17 ms --&gt; 392 ms)
  module count = 2
modules with no loaders took 253 ms
  median       = 4 ms
  mean         = 6 ms
  s.d.         = 14.107 ms
  range        = (0 ms --&gt; 145 ms)
  module count = 218
mini-css-extract-plugin, and 
css-loader took 167 ms
  median       = 164 ms
  mean         = 164 ms
  s.d.         = 0 ms
  range        = (164 ms --&gt; 164 ms)
  module count = 2
css-loader took 54 ms
  median       = 54 ms
  mean         = 35 ms
  s.d.         = 26.87 ms
  range        = (16 ms --&gt; 54 ms)
  module count = 2
html-webpack-plugin took 18 ms
  median       = 18 ms
  mean         = 18 ms
  range        = (18 ms --&gt; 18 ms)
  module count = 1
</code></pre>
<p>通过该工具可以知道哪些<code>loader</code>和<code>plugin</code>执行时间过长，从而对它们进行更加有效的配置或者替换。</p>
<h2 data-id="heading-25">小结</h2>
<p>Webpack 构建优化是一个系统性的工程，没有“银弹”配置可以放之四海而皆准。通过本文的探讨，我们可以将优化思路提炼为以下核心纲领：</p>
<ol>
<li><strong>明确目标，区别对待</strong>：始终明确开发环境追求<strong>速度</strong>，生产环境兼顾<strong>速度与体积</strong>。为此采取不同的配置策略是优化的基石。</li>
<li><strong>诊断先行，对症下药</strong>：善用 <code>webpack-bundle-analyzer</code> 和 <code>speed-measure-webpack-plugin</code> 等分析工具，精准定位瓶颈，避免盲目优化。</li>
<li><strong>拥抱缓存，减少重复</strong>：无论是 Webpack 5 的持久化缓存，还是 loader 自身的缓存，都是提升二次构建速度最有效的手段之一。</li>
<li><strong>缩小范围，精准打击</strong>：通过 <code>include</code>、<code>exclude</code>、<code>resolve</code> 配置等手段，让 Webpack 只处理它该处理的模块，避免无谓的搜索和转译。</li>
<li><strong>善用利器，并行不悖</strong>：利用 <code>thread-loader</code>、<code>esbuild</code>、<code>swc</code> 等现代工具进行并行构建和高性能转译，充分利用多核 CPU 性能。</li>
<li><strong>拆分有度，缓存为王</strong>：合理的代码分割（SplitChunks、动态导入）不仅能减小首包体积，更能利用浏览器缓存，带来长久的性能收益。</li>
</ol>
<p>优化之路永无止境。最好的优化策略是结合你项目的具体规模、技术栈和团队习惯，建立持续的监控和分析机制，在迭代中不断调整和验证。希望本文能为你提供清晰的思路和实用的方法，让你和团队的开发体验“快上加快”，彻底告别构建等待的烦恼！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SwiftUI 导航]]></title>    <link>https://juejin.cn/post/7571258854900858923</link>    <guid>https://juejin.cn/post/7571258854900858923</guid>    <pubDate>2025-11-11T09:49:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571258854900858923" data-draft-id="7571077686108471359" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SwiftUI 导航"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T09:49:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="littleplayer"/> <meta itemprop="url" content="https://juejin.cn/user/1926000099198813"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SwiftUI 导航
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1926000099198813/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    littleplayer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:49:38.000Z" title="Tue Nov 11 2025 09:49:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>SwiftUI 提供了多种导航方式，让我为你详细介绍主要的导航模式和相关组件。</p>
<h2 data-id="heading-0">1. NavigationStack (iOS 16+)</h2>
<h3 data-id="heading-1">基本用法</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span> {
            <span class="hljs-type">List</span> {
                <span class="hljs-type">NavigationLink</span>(<span class="hljs-string">"前往详情页"</span>, value: <span class="hljs-string">"详情内容"</span>)
                <span class="hljs-type">NavigationLink</span>(<span class="hljs-string">"设置"</span>, value: <span class="hljs-string">"设置页面"</span>)
            }
            .navigationDestination(for: <span class="hljs-type">String</span>.<span class="hljs-keyword">self</span>) { value <span class="hljs-keyword">in</span>
                <span class="hljs-type">DetailView</span>(content: value)
            }
        }
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">DetailView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">let</span> content: <span class="hljs-type">String</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Text</span>(<span class="hljs-string">"详情: <span class="hljs-subst">\(content)</span>"</span>)
            .navigationTitle(<span class="hljs-string">"详情页"</span>)
    }
}
</code></pre>
<h3 data-id="heading-2">多类型导航</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Route</span>: <span class="hljs-title class_">Hashable</span> {
    <span class="hljs-keyword">case</span> product(<span class="hljs-type">Int</span>)
    <span class="hljs-keyword">case</span> category(<span class="hljs-type">String</span>)
    <span class="hljs-keyword">case</span> settings
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span> {
            <span class="hljs-type">VStack</span> {
                <span class="hljs-type">NavigationLink</span>(<span class="hljs-string">"产品123"</span>, value: <span class="hljs-type">Route</span>.product(<span class="hljs-number">123</span>))
                <span class="hljs-type">NavigationLink</span>(<span class="hljs-string">"电子产品"</span>, value: <span class="hljs-type">Route</span>.category(<span class="hljs-string">"electronics"</span>))
                <span class="hljs-type">NavigationLink</span>(<span class="hljs-string">"设置"</span>, value: <span class="hljs-type">Route</span>.settings)
            }
            .navigationDestination(for: <span class="hljs-type">Route</span>.<span class="hljs-keyword">self</span>) { route <span class="hljs-keyword">in</span>
                <span class="hljs-keyword">switch</span> route {
                <span class="hljs-keyword">case</span> .product(<span class="hljs-keyword">let</span> id):
                    <span class="hljs-type">ProductView</span>(productId: id)
                <span class="hljs-keyword">case</span> .category(<span class="hljs-keyword">let</span> name):
                    <span class="hljs-type">CategoryView</span>(category: name)
                <span class="hljs-keyword">case</span> .settings:
                    <span class="hljs-type">SettingsView</span>()
                }
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-3">2. NavigationView (iOS 13-16)</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationView</span> {
            <span class="hljs-type">List</span> {
                <span class="hljs-type">NavigationLink</span>(destination: <span class="hljs-type">DetailView</span>()) {
                    <span class="hljs-type">Label</span>(<span class="hljs-string">"详情页面"</span>, systemImage: <span class="hljs-string">"star"</span>)
                }
                <span class="hljs-type">NavigationLink</span>(destination: <span class="hljs-type">SettingsView</span>()) {
                    <span class="hljs-type">Label</span>(<span class="hljs-string">"设置"</span>, systemImage: <span class="hljs-string">"gear"</span>)
                }
            }
            .navigationTitle(<span class="hljs-string">"主页面"</span>)
        }
    }
}
</code></pre>
<h2 data-id="heading-4">3. 编程式导航</h2>
<h3 data-id="heading-5">使用 NavigationPath</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navigationPath <span class="hljs-operator">=</span> <span class="hljs-type">NavigationPath</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span>(path: <span class="hljs-variable">$navigationPath</span>) {
            <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">20</span>) {
                <span class="hljs-type">Button</span>(<span class="hljs-string">"跳转到产品页"</span>) {
                    navigationPath.append(<span class="hljs-type">Route</span>.product(<span class="hljs-number">456</span>))
                }
                
                <span class="hljs-type">Button</span>(<span class="hljs-string">"跳转到分类页"</span>) {
                    navigationPath.append(<span class="hljs-type">Route</span>.category(<span class="hljs-string">"books"</span>))
                }
                
                <span class="hljs-type">Button</span>(<span class="hljs-string">"多层级跳转"</span>) {
                    navigationPath.append(<span class="hljs-type">Route</span>.category(<span class="hljs-string">"electronics"</span>))
                    navigationPath.append(<span class="hljs-type">Route</span>.product(<span class="hljs-number">789</span>))
                }
                
                <span class="hljs-type">Button</span>(<span class="hljs-string">"返回根页面"</span>) {
                    navigationPath.removeLast(navigationPath.count)
                }
                
                <span class="hljs-type">Button</span>(<span class="hljs-string">"上一步"</span>) {
                    <span class="hljs-keyword">guard</span> <span class="hljs-operator">!</span>navigationPath.isEmpty <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
                    navigationPath.removeLast()
                }
            }
            .navigationDestination(for: <span class="hljs-type">Route</span>.<span class="hljs-keyword">self</span>) { route <span class="hljs-keyword">in</span>
                <span class="hljs-comment">// 路由处理...</span>
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-6">4. Sheet 和 FullScreenCover</h2>
<h3 data-id="heading-7">模态展示</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> showingSheet <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> showingFullScreen <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">20</span>) {
            <span class="hljs-type">Button</span>(<span class="hljs-string">"显示 Sheet"</span>) {
                showingSheet <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
            }
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"全屏显示"</span>) {
                showingFullScreen <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
            }
        }
        .sheet(isPresented: <span class="hljs-variable">$showingSheet</span>) {
            <span class="hljs-type">SheetView</span>()
        }
        .fullScreenCover(isPresented: <span class="hljs-variable">$showingFullScreen</span>) {
            <span class="hljs-type">FullScreenView</span>()
        }
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SheetView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Environment</span>(\.dismiss) <span class="hljs-keyword">var</span> dismiss
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationView</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"这是 Sheet 视图"</span>)
                .toolbar {
                    <span class="hljs-type">ToolbarItem</span>(placement: .navigationBarTrailing) {
                        <span class="hljs-type">Button</span>(<span class="hljs-string">"完成"</span>) {
                            dismiss()
                        }
                    }
                }
        }
    }
}
</code></pre>
<h2 data-id="heading-8">5. TabView 标签导航</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MainTabView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">TabView</span> {
            <span class="hljs-type">HomeView</span>()
                .tabItem {
                    <span class="hljs-type">Label</span>(<span class="hljs-string">"首页"</span>, systemImage: <span class="hljs-string">"house"</span>)
                }
            
            <span class="hljs-type">SearchView</span>()
                .tabItem {
                    <span class="hljs-type">Label</span>(<span class="hljs-string">"搜索"</span>, systemImage: <span class="hljs-string">"magnifyingglass"</span>)
                }
            
            <span class="hljs-type">ProfileView</span>()
                .tabItem {
                    <span class="hljs-type">Label</span>(<span class="hljs-string">"我的"</span>, systemImage: <span class="hljs-string">"person"</span>)
                }
        }
    }
}
</code></pre>
<h2 data-id="heading-9">6. 复杂导航示例</h2>
<h3 data-id="heading-10">带导航栏的完整示例</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MainView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navigationPath <span class="hljs-operator">=</span> <span class="hljs-type">NavigationPath</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span>(path: <span class="hljs-variable">$navigationPath</span>) {
            <span class="hljs-type">ProductListView</span>()
                .navigationTitle(<span class="hljs-string">"产品列表"</span>)
                .toolbar {
                    <span class="hljs-type">ToolbarItem</span>(placement: .navigationBarTrailing) {
                        <span class="hljs-type">Button</span>(<span class="hljs-string">"设置"</span>) {
                            navigationPath.append(<span class="hljs-type">AppRoute</span>.settings)
                        }
                    }
                }
                .navigationDestination(for: <span class="hljs-type">AppRoute</span>.<span class="hljs-keyword">self</span>) { route <span class="hljs-keyword">in</span>
                    route.destination
                }
        }
    }
}

<span class="hljs-keyword">enum</span> <span class="hljs-title class_">AppRoute</span>: <span class="hljs-title class_">Hashable</span> {
    <span class="hljs-keyword">case</span> productDetail(<span class="hljs-type">Product</span>)
    <span class="hljs-keyword">case</span> category(<span class="hljs-type">String</span>)
    <span class="hljs-keyword">case</span> settings
    <span class="hljs-keyword">case</span> profile
    
    <span class="hljs-meta">@ViewBuilder</span>
    <span class="hljs-keyword">var</span> destination: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-keyword">switch</span> <span class="hljs-keyword">self</span> {
        <span class="hljs-keyword">case</span> .productDetail(<span class="hljs-keyword">let</span> product):
            <span class="hljs-type">ProductDetailView</span>(product: product)
        <span class="hljs-keyword">case</span> .category(<span class="hljs-keyword">let</span> category):
            <span class="hljs-type">CategoryView</span>(category: category)
        <span class="hljs-keyword">case</span> .settings:
            <span class="hljs-type">SettingsView</span>()
        <span class="hljs-keyword">case</span> .profile:
            <span class="hljs-type">ProfileView</span>()
        }
    }
}
</code></pre>
<h3 data-id="heading-11">自定义导航栏</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CustomNavigationView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Environment</span>(\.dismiss) <span class="hljs-keyword">var</span> dismiss
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationView</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"自定义导航栏"</span>)
                .navigationTitle(<span class="hljs-string">"标题"</span>)
                .navigationBarTitleDisplayMode(.inline)
                .toolbar {
                    <span class="hljs-comment">// 左侧按钮</span>
                    <span class="hljs-type">ToolbarItem</span>(placement: .navigationBarLeading) {
                        <span class="hljs-type">Button</span>(<span class="hljs-string">"取消"</span>) {
                            dismiss()
                        }
                    }
                    
                    <span class="hljs-comment">// 右侧按钮</span>
                    <span class="hljs-type">ToolbarItem</span>(placement: .navigationBarTrailing) {
                        <span class="hljs-type">Button</span>(<span class="hljs-string">"保存"</span>) {
                            <span class="hljs-comment">// 保存操作</span>
                        }
                        .bold()
                    }
                }
        }
    }
}
</code></pre>
<h2 data-id="heading-12">7. 导航状态管理</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NavigationManager</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> path <span class="hljs-operator">=</span> <span class="hljs-type">NavigationPath</span>()
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">navigateToProduct</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">id</span>: <span class="hljs-type">Int</span>) {
        path.append(<span class="hljs-type">Route</span>.product(id))
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">navigateToCategory</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">name</span>: <span class="hljs-type">String</span>) {
        path.append(<span class="hljs-type">Route</span>.category(name))
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">popToRoot</span>() {
        path.removeLast(path.count)
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">AppView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navManager <span class="hljs-operator">=</span> <span class="hljs-type">NavigationManager</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span>(path: <span class="hljs-variable">$navManager</span>.path) {
            <span class="hljs-type">ContentView</span>()
                .navigationDestination(for: <span class="hljs-type">Route</span>.<span class="hljs-keyword">self</span>) { route <span class="hljs-keyword">in</span>
                    <span class="hljs-comment">// 路由处理</span>
                }
        }
        .environmentObject(navManager)
    }
}
</code></pre>
<h2 data-id="heading-13">主要特点总结</h2>
<ol>
<li><strong>NavigationStack</strong>: iOS 16+ 推荐使用，支持类型安全的路由</li>
<li><strong>编程式导航</strong>: 通过状态管理控制导航流程</li>
<li><strong>模态展示</strong>: Sheet 和 FullScreenCover 用于临时内容</li>
<li><strong>标签导航</strong>: TabView 用于主要功能模块切换</li>
<li><strong>灵活的路由系统</strong>: 支持复杂导航逻辑和深度链接</li>
</ol>
<p>这些导航方式可以组合使用，创建出符合你应用需求的完整导航体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[简单聊下enum（枚举）]]></title>    <link>https://juejin.cn/post/7571279513247055898</link>    <guid>https://juejin.cn/post/7571279513247055898</guid>    <pubDate>2025-11-11T10:01:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571279513247055898" data-draft-id="7571279513246990362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="简单聊下enum（枚举）"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2025-11-11T10:01:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="来碗盐焗星球"/> <meta itemprop="url" content="https://juejin.cn/user/3316551988553709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            简单聊下enum（枚举）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3316551988553709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    来碗盐焗星球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:01:24.000Z" title="Tue Nov 11 2025 10:01:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当你需要定义一些固定值的集合的场景时，你通常都是如何考虑的?例如对于一个订单状态集合，未支付、支付成功、支付失败、已取消、已发货、已签收、已退款，对应的数字分别是:1、2、3、4、5、6、7。</p>
<h3 data-id="heading-0">type字面量联合类型</h3>
<p>你会选择定义一个单纯的类型，简洁直观，无运行开销吗?</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">OrderStatus</span> = <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">3</span> | <span class="hljs-number">4</span> | <span class="hljs-number">5</span> | <span class="hljs-number">6</span> | <span class="hljs-number">7</span>
</code></pre>
<p>但这并非理想方案。它本质是类型约束，而非 “集合”—— 无法通过 “键”（如 “未支付”）访问对应的值（1），必须手动写数字或字符串，即使 TypeScript 会校验，仍存在拼写或记错值的风险。</p>
<h3 data-id="heading-1">普通对象</h3>
<p>最初我使用普通对象去满足这项要求:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">OrderStatus</span> = {
  <span class="hljs-attr">UNPAID</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">PAID_SUCCESS</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">PAID_FAILED</span>: <span class="hljs-number">3</span>,
  <span class="hljs-attr">CANCELLED</span>: <span class="hljs-number">4</span>,
  <span class="hljs-attr">SHIPPED</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">SIGNED</span>: <span class="hljs-number">6</span>,
  <span class="hljs-attr">REFUNDED</span>: <span class="hljs-number">7</span>,
}
</code></pre>
<p>可以直接通过"键"访问值，例如<code>OrderStatus.UNPAID</code>，这是我想要的。
但是这种方式也有一些不直观的地方，类型松散，TS会自动推断该对象的类型为<code>{ UNPAID: number, PAID_SUCCESS: number, PAID_FAILED: number, CANCELLED: number, SHIPPED: number, SIGNED: number, REFUNDED: number }</code>，这显然不是我想要的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dd143989da340758618ff4ceae4a5f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2l56KX55uQ54SX5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763460084&amp;x-signature=cULQhHwPVeJnweOfc0YVakO%2FF8o%3D" alt="1.png" loading="lazy"/>
另外，虽然枚举类型规定了1-7，但是我直接赋值其他number类型数字，也是没啥问题的，TS也不会报错。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c24ba10b317b4e6ca917b75ff7a89a03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2l56KX55uQ54SX5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763460084&amp;x-signature=OkPdGr9sg5%2FP6XE60enKYEBZYk8%3D" alt="2.png" loading="lazy"/></p>
<p>当然这个也有解决方式，就是使用<code>as const</code>断言，将对象的所有属性都变成只读的字面量类型。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">OrderStatus</span> = {
  <span class="hljs-attr">UNPAID</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">PAID_SUCCESS</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">PAID_FAILED</span>: <span class="hljs-number">3</span>,
  <span class="hljs-attr">CANCELLED</span>: <span class="hljs-number">4</span>,
  <span class="hljs-attr">SHIPPED</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">SIGNED</span>: <span class="hljs-number">6</span>,
  <span class="hljs-attr">REFUNDED</span>: <span class="hljs-number">7</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>
</code></pre>
<p>这样，TS就会自动推断该对象的类型为<code>{ readonly UNPAID: 1, readonly PAID_SUCCESS: 2, readonly PAID_FAILED: 3, readonly CANCELLED: 4, readonly SHIPPED: 5, readonly SIGNED: 6, readonly REFUNDED: 7 }</code>，这显然是我想要的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/052fd75949e24b7e8f0dd1521b29c8b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2l56KX55uQ54SX5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763460084&amp;x-signature=%2FEtYqmsvQVv2%2FJue2oYDfZbNuX4%3D" alt="3.png" loading="lazy"/></p>
<p>兼具了普通对象的"键"访问值的便利性，同时也具备了枚举类型的"值"访问键的便利性。
但是它又不能当作类型去使用，需要手动使用<code>typeof OrderStatus</code>来提取它的联合类型。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">OrderStatusT</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">OrderStatus</span>[keyof <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">OrderStatus</span>]
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/230b6984806a4cbf892435e965c9ed2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2l56KX55uQ54SX5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763460084&amp;x-signature=EZ2mnjOdziG5ShFzLJPBcTO9vqI%3D" alt="4.png" loading="lazy"/></p>
<p>所以要兼具普通对象的"键"访问值的便利性，同时也具备了枚举类型的"值"访问键的便利性，以及使用联合类型。那么只能另辟蹊径了。</p>
<h3 data-id="heading-2">enum</h3>
<p>最后可以选择使用枚举类型去满足:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatus</span> {
  <span class="hljs-variable constant_">UNPAID</span> = <span class="hljs-number">1</span>,
  <span class="hljs-variable constant_">PAID_SUCCESS</span> = <span class="hljs-number">2</span>,
  <span class="hljs-variable constant_">PAID_FAILED</span> = <span class="hljs-number">3</span>,
  <span class="hljs-variable constant_">CANCELLED</span> = <span class="hljs-number">4</span>,
  <span class="hljs-variable constant_">SHIPPED</span> = <span class="hljs-number">5</span>,
  <span class="hljs-variable constant_">SIGNED</span> = <span class="hljs-number">6</span>,
  <span class="hljs-variable constant_">REFUNDED</span> = <span class="hljs-number">7</span>,
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/372b14860f3e40b3a13ea4bbf0b8d7c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2l56KX55uQ54SX5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763460084&amp;x-signature=MMklT9xLA6qJsE4kmHtFFAItH4U%3D" alt="5.png" loading="lazy"/>
如图所示，优势不言而喻了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>