<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Firebase CLI 一直关联失败]]></title>    <link>https://juejin.cn/post/7581666412021874697</link>    <guid>https://juejin.cn/post/7581666412021874697</guid>    <pubDate>2025-12-09T14:06:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581666412021874697" data-draft-id="7581666412021858313" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Firebase CLI 一直关联失败"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-09T14:06:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="J船长"/> <meta itemprop="url" content="https://juejin.cn/user/1820446987136903"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Firebase CLI 一直关联失败
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1820446987136903/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    J船长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T14:06:03.000Z" title="Tue Dec 09 2025 14:06:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>比如执行`firebase login``然后跳转浏览器，进行关联</p>
<h2 data-id="heading-0">解决办法：</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> https_proxy=http:<span class="hljs-comment">//127.0.0.1:xxxx</span>
<span class="hljs-keyword">export</span> http_proxy=http:<span class="hljs-comment">//127.0.0.1:xxxx</span>
<span class="hljs-keyword">export</span> all_proxy=socks5:<span class="hljs-comment">//127.0.0.1:xxxx</span>
firebase login
</code></pre>
<hr/>
<h2 data-id="heading-1">原因:</h2>
<p>macOS 上开 V 只是让浏览器等应用走代理，但终端默认不走代理。终端里的命令（如 firebase）需要手动设置 http_proxy 和 https_proxy 环境变量才能走代理访问 Google 服务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么在 Agent 时代，我选择了 Bun？]]></title>    <link>https://juejin.cn/post/7581678301216964608</link>    <guid>https://juejin.cn/post/7581678301216964608</guid>    <pubDate>2025-12-09T14:04:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581678301216964608" data-draft-id="7581664445241606159" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么在 Agent 时代，我选择了 Bun？"/> <meta itemprop="keywords" content="JavaScript,Bun,Agent"/> <meta itemprop="datePublished" content="2025-12-09T14:04:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mCell"/> <meta itemprop="url" content="https://juejin.cn/user/2280829967146779"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么在 Agent 时代，我选择了 Bun？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2280829967146779/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mCell
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T14:04:58.000Z" title="Tue Dec 09 2025 14:04:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>同步至个人站点：<a href="https://link.juejin.cn?target=https%3A%2F%2Fstack.mcell.top%2Ftopics%2Fbun%2F01_start" target="_blank" title="https://stack.mcell.top/topics/bun/01_start" ref="nofollow noopener noreferrer">为什么在 Agent 时代，我选择了 Bun？ - Bun 指南</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3cd035dbd624c1fbaae35c03f9cd479~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbUNlbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765893954&amp;x-signature=ccCGXokJPpTUBsibIK%2FRWU3KAgI%3D" alt="076.webp" loading="lazy"/></p>
<h2 data-id="heading-0">一切都从那条「收购 Bun」的新闻开始</h2>
<p>上周三，看到 Anthropic 的一则新闻：他们宣布收购 Bun，并在文中明确写到——对 Claude Code 的用户来说，这次收购意味着<strong>更快的性能、更高的稳定性以及全新的能力</strong>。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fanthropic-acquires-bun-as-claude-code-reaches-usd1b-milestone" title="https://www.anthropic.com/news/anthropic-acquires-bun-as-claude-code-reaches-usd1b-milestone" target="_blank" ref="nofollow noopener noreferrer">Anthropic</a>)</p>
<p>简单翻译一下就是：</p>
<blockquote>
<p>我们要把整个编码 Agent 的基础设施，换成一个更快、更顺手的 JS/TS 运行时。</p>
</blockquote>
<p>这条新闻对我触动很大，至少暴露出两个事实：</p>
<ol>
<li>
<p><strong>Agent 时代的基础设施在变化</strong>
以前我们写 CLI、写后端，Node 足够用了；但到了 Agent 这种「到处起小进程、到处跑工具」的场景里，<strong>启动速度、冷启动性能、all-in-one 工具链</strong>，突然变得非常关键。</p>
</li>
<li>
<p><strong>Bun 不再只是一个「新玩具」</strong>
它已经成为一家头部 AI 公司的底层组件之一：Anthropic 早就在内部用 Bun 跑 Claude Code，现在索性直接收购，把它当作下一代 AI 软件工程的基础设施。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fbun.sh%2F" title="https://bun.sh/" target="_blank" ref="nofollow noopener noreferrer">bun.sh</a>)</p>
</li>
</ol>
<p>当我再去翻 Bun 的官网时，就会发现：</p>
<blockquote>
<p>这是一个集 <strong>JavaScript/TypeScript 运行时、包管理器、打包器、测试运行器</strong> 于一身的 all-in-one 工具。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fbun.sh%2F" title="https://bun.sh/" target="_blank" ref="nofollow noopener noreferrer">bun.sh</a>)</p>
</blockquote>
<p>这和我对「传统 JS 运行时」的印象已经完全不一样了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ee9e9a5a084460ea7f346a8a1127782~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbUNlbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765893954&amp;x-signature=zpNVA%2BQw9bpf6xk%2FCO10dMKNzS0%3D" alt="078.webp" loading="lazy"/></p>
<h2 data-id="heading-1">先说说我的技术背景：为什么要写这个专题？</h2>
<p>我平时写代码偏向两类技术栈：</p>
<ul>
<li><strong>TypeScript</strong>：前端、工具脚本、Node 小服务</li>
<li><strong>Go</strong>：服务端、一些偏底层的活</li>
</ul>
<p>很长一段时间里，我对 Node 的使用场景大概就是这几种：</p>
<ul>
<li>写个小脚本：<code>ts-node</code> / <code>tsx</code> + 一点配置，跑完就扔</li>
<li>写个中小型服务端：Express / Nest 这一类</li>
</ul>
<p>这些场景里，一个很明显的感受是：</p>
<ul>
<li>Node <strong>够成熟</strong>：生态庞大，资料多，出了问题很容易搜到坑</li>
<li>但 Node 也<strong>够「厚重」</strong>：一堆配置、各种工具组合、打包测试 lint 各种链路</li>
</ul>
<p>直到我开始认真看 Bun 的文档，第一次有一种很强烈的对比感：</p>
<blockquote>
<p>「哦，原来现在写 JS/TS 后端已经可以这么简单了？」</p>
</blockquote>
<ul>
<li>不用写 <code>tsconfig.json</code>（很多时候默认就很好用）</li>
<li>dev / build / test 基本就是一行命令：
<code>bun run</code> / <code>bun build</code> / <code>bun test</code></li>
<li>起一个 HTTP server，用的还是 JS/TS，但 API 明显更简洁，很多地方甚至不需要 Node 的那一套底层 API</li>
</ul>
<p>再加上我最近在做 Agent 相关的东西，自然就顺势产生了一个问题：</p>
<blockquote>
<p>既然我本来就想用 TS 写一个 ReAct Agent，那为什么不干脆用 Bun 来做 runtime 呢？</p>
</blockquote>
<h2 data-id="heading-2">Agent CLI 的选型：为什么会想到 Bun？</h2>
<p>在开搞之前，我特地去看了一圈现在比较热门的 Agent CLI 都是怎么选技术栈的：</p>
<ul>
<li>Google 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle-gemini%2Fgemini-cli" target="_blank" title="https://github.com/google-gemini/gemini-cli" ref="nofollow noopener noreferrer">Gemini CLI</a>：<strong>Node</strong></li>
<li>OpenAI 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fcodex" target="_blank" title="https://github.com/openai/codex" ref="nofollow noopener noreferrer">Codex CLI</a>：<strong>Rust</strong>写核心逻辑，UI交给<strong>Node和TypeScript</strong></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fclaude-code" target="_blank" title="https://github.com/anthropics/claude-code" ref="nofollow noopener noreferrer">Claude Code CLI</a> 和基础设施：<strong>Bun</strong>(<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.reuters.com%2Fbusiness%2Fmedia-telecom%2Fanthropic-acquires-developer-tool-startup-bun-scale-ai-coding-2025-12-02%2F" title="https://www.reuters.com/business/media-telecom/anthropic-acquires-developer-tool-startup-bun-scale-ai-coding-2025-12-02/" target="_blank" ref="nofollow noopener noreferrer">Reuters</a>)</li>
</ul>
<p>如果你把这些信息放在一起，会大致看到一个趋势：</p>
<ul>
<li>Rust：更偏向<strong>极致性能、可控性、安全性</strong>，适合那种「我要把一套工具做到很底层、很稳」的团队。</li>
<li>Node：稳定、生态成熟，但随着项目往 AI 工程、Agent 方向发展，在<strong>冷启动、工具链整合</strong>上没有那么「顺手」。</li>
<li>Bun：尝试在 Node 的生态基础上，往前推进一步，做一个<strong>all-in-one、性能极强的 JS/TS 运行时</strong>。</li>
</ul>
<p>而我这个人，有个很明显的偏好：</p>
<blockquote>
<p>能用 TS 解决的，就先别急着上 Rust。</p>
</blockquote>
<p>所以，当我看到：</p>
<ul>
<li>Anthropic 在 Agent 业务上，押注 Bun</li>
<li>Bun 自己的定位又是：<strong>“把你写 Node 的那套事，全部做到更快、更简单”</strong>(<a href="https://link.juejin.cn?target=https%3A%2F%2Fbun.sh%2F" title="https://bun.sh/" target="_blank" ref="nofollow noopener noreferrer">bun.sh</a>)</li>
</ul>
<p>那我心里那个问题就更具体了：</p>
<blockquote>
<p><strong>在「写 Agent」这个具体场景里，Bun 真的比 Node 体验更好吗？</strong></p>
</blockquote>
<p>我不太喜欢只看 benchmark，于是就决定写点实打实的东西来试试看。</p>
<h2 data-id="heading-3">一个不到百行的 ReAct Agent Demo</h2>
<p>为了验证这个问题，我给自己定了一个很小的练习目标：</p>
<blockquote>
<p>用 <strong>Bun + TypeScript</strong>，写一个「不到百行代码」的极简 ReAct Agent Demo。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b908fc9be8984806815ffdb3a53db679~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbUNlbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765893954&amp;x-signature=p1FDHkeA85pyGFzyX%2Bvg%2BAqK684%3D" alt="079.webp" loading="lazy"/></p>
<p>这个 Agent 不追求多复杂的功能，专注这几件事：</p>
<ol>
<li>
<p>维护一个最小可用的 <strong>ReAct loop</strong>（思考 → 行动 → 观察 → 再思考）</p>
</li>
<li>
<p>内置少量工具，比如：</p>
<ul>
<li><code>read</code>：读取文件内容</li>
<li><code>write</code>：写入/更新文件</li>
</ul>
</li>
<li>
<p>整个项目尽量清爽，不做多余封装</p>
</li>
</ol>
<p>写的过程非常「AI 化」：</p>
<ul>
<li>先用 Node 写了一版最朴素的版本</li>
<li>再让 AI 帮我<strong>改写为 Bun 的 API</strong></li>
<li>我负责补坑、重构、整理结构</li>
</ul>
<p>结果出乎意料地顺畅：</p>
<ul>
<li>很多原来需要 <code>fs</code> 模块、各种工具库的地方，在 Bun 里可以用自己的 API 写得更简洁，比如 <code>Bun.file()</code>、<code>Bun.write()</code> 这种。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fbun.sh%2F" title="https://bun.sh/" target="_blank" ref="nofollow noopener noreferrer">bun.sh</a>)</li>
<li>dev / build / test 自己都不用纠结，直接 <code>bun xxx</code> 的那一套就行，几乎不需要额外配置。</li>
<li>Agent loop 那段代码本身是比较核心的逻辑，集中精力在这里就好了，不太需要为工程化配置分心。</li>
</ul>
<p>更关键的是：</p>
<blockquote>
<p>整个 Demo 框架搭好后，我有一种「这个东西是可以往前认真维护」的感觉，而不是写完就丢。</p>
</blockquote>
<p>这和我之前写很多 Node 小脚本的心理预期是完全不一样的。</p>
<h2 data-id="heading-4">再聊一句「全栈」：TS 之后，运行时是谁？</h2>
<p>周末刷 X，看到老许的<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fxushiwei%2Fstatus%2F1997328503985852798" target="_blank" title="https://x.com/xushiwei/status/1997328503985852798" ref="nofollow noopener noreferrer">帖子</a>，如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9769d9e9c45f48d8b4e9c60a9497b6f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbUNlbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765893954&amp;x-signature=PDVyJaTf04nuXCHyDoai5h4yKyQ%3D" alt="080.webp" loading="lazy"/></p>
<p>这句话我很认同。
前后端统一 TS 技术栈，对个人开发者来说太友好了：</p>
<ul>
<li>一门语言，从浏览器跑到服务端、再到 CLI、工具链</li>
<li>类型系统本身就成为你的「文档 + 校验器」</li>
</ul>
<p>那顺着这个思路，下一步的问题就自然来了：</p>
<blockquote>
<p>既然语言是 TypeScript，那<strong>运行时</strong>呢？
未来的 TS 运行时，会不会从 Node，逐渐走向 Bun（一部分场景）？</p>
</blockquote>
<p>我不打算在这里给出一个结论——毕竟 Node 的体量、生态、历史沉淀摆在那里，而 Bun 目前也还只是一个「两年多一点」的新 runtime。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fbun.sh%2F" title="https://bun.sh/" target="_blank" ref="nofollow noopener noreferrer">bun.sh</a>)</p>
<p>但从我自己的体验看，有两点很值得关注：</p>
<ol>
<li>
<p><strong>Bun 是为「现代 JS/TS 开发」重新设计过的</strong>
它自带 bundler、test runner、包管理器，不再是「一个 runtime + 一堆第三方工具拼装」的模式。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fbun.sh%2F" title="https://bun.sh/" target="_blank" ref="nofollow noopener noreferrer">bun.sh</a>)</p>
</li>
<li>
<p><strong>Bun 和 Agent、AI 工程这类新场景的契合度异常高</strong></p>
<ul>
<li>CLI 需要冷启动快 → Bun 做得很好</li>
<li>项目喜欢 all-in-one 工具链 → Bun 直接内置</li>
<li>你本来就写 TS → Bun 对 TS 原生友好</li>
</ul>
</li>
</ol>
<p>这些特性，叠加起来就会让人产生那种感觉：</p>
<blockquote>
<p>「如果我要重写一遍现在手里这些 Node 脚本、工具、Agent，那好像真的可以考虑直接上 Bun。」</p>
</blockquote>
<h2 data-id="heading-5">这个专题想写些什么？</h2>
<p>既然已经有了实践的契机（ReAct Agent Demo），再加上我一贯「学新东西喜欢顺手写点东西」的习惯，那干脆就开一个新专题：《Bun 指南》。</p>
<p><strong>这第一篇就是引言，只回答一个问题：为什么要学 Bun？</strong></p>
<p>后面的几篇，我打算按这样的节奏展开（暂定）：</p>
<ol>
<li>
<p><strong>安装与上手：从 Node 迁移到 Bun 有多难？</strong></p>
<ul>
<li>安装 Bun</li>
<li>跑起第一个 <code>bun run</code> / <code>bun dev</code></li>
<li>把一个简单的 Node 脚本迁移到 Bun</li>
</ul>
</li>
<li>
<p><strong>Bun 的 all-in-one 工具链</strong></p>
<ul>
<li>包管理器：<code>bun install</code> vs npm/pnpm</li>
<li><code>bun test</code>：内置测试如何用</li>
<li><code>bun build</code>：打包、构建、单文件可执行</li>
</ul>
</li>
<li>
<p><strong>用 Bun 写 HTTP 服务</strong></p>
<ul>
<li><code>Bun.serve()</code> 的基本用法(<a href="https://link.juejin.cn?target=https%3A%2F%2Fbun.sh%2F" title="https://bun.sh/" target="_blank" ref="nofollow noopener noreferrer">bun.sh</a>)</li>
<li>和 Node / Express 的直观对比</li>
<li>简单的 API 服务实战</li>
</ul>
</li>
<li>
<p><strong>文件、进程与工具脚本：Bun 的标准库体验</strong></p>
<ul>
<li><code>Bun.file()</code> / <code>Bun.write()</code> 等常用 API</li>
<li>用 Bun 写一个实用 CLI 小工具</li>
</ul>
</li>
<li>
<p><strong>实战篇：用 Bun + TS 写一个 ReAct Agent Demo</strong></p>
<ul>
<li>核心 loop 逻辑拆解</li>
<li>如何组织「工具」层（read / write / 调用外部接口）</li>
<li>运行、调试与「AI Coding 助攻」的一些经验</li>
</ul>
</li>
<li>
<p><strong>踩坑记录 &amp; 迁移经验</strong></p>
<ul>
<li>哪些地方真的爽了</li>
<li>哪些地方还不如 Node 成熟</li>
<li>写给准备从 Node 迁到 Bun 的你</li>
</ul>
</li>
</ol>
<p>如果你已经会写 JavaScript / Node，这个专题不会从「什么是 Promise」讲起，而会更聚焦在：</p>
<ul>
<li><strong>从 Node 迁移到 Bun 时，大脑需要切换的那一小部分东西</strong></li>
<li><strong>在 Bun 里，如何用尽量少的代码做更多事</strong></li>
<li><strong>结合 Agent / AI 工程场景，感受下一代 JS/TS runtime 的味道</strong></li>
</ul>
<h2 data-id="heading-6">写在最后</h2>
<p>我并不打算把 Bun 神化成「Node 杀手」——至少短期内，它更像是：</p>
<blockquote>
<p>一个极适合「个人开发者 / 小团队 / 新项目 / Agent 工程」尝鲜的 JS/TS 运行时。</p>
</blockquote>
<p>而这个系列，就是我在这个尝试过程中的「实践笔记」：</p>
<ul>
<li>一部分是 Bun 本身的能力整理</li>
<li>一部分是我做 ReAct Agent 的真实踩坑经验</li>
<li>还有一部分，是在这个过程中我对「全栈 / TS / runtime 演进」的一些小思考</li>
</ul>
<p>如果你：</p>
<ul>
<li>已经会 Node / TS</li>
<li>正在关注 Agent / AI 工程</li>
<li>又对「更快、更简洁的 JS/TS 运行时」有点好奇</li>
</ul>
<p>那欢迎一起把这个系列看下去，也欢迎你在实践中告诉我：
<strong>在你的场景里，Bun 到底是不是一个更好的选择？</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.reuters.com%2Fbusiness%2Fmedia-telecom%2Fanthropic-acquires-developer-tool-startup-bun-scale-ai-coding-2025-12-02%2F" target="_blank" title="https://www.reuters.com/business/media-telecom/anthropic-acquires-developer-tool-startup-bun-scale-ai-coding-2025-12-02/" ref="nofollow noopener noreferrer">Reuters</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[requestAnimationFrame 与 JS 事件循环：宏任务执行顺序分析]]></title>    <link>https://juejin.cn/post/7581666412021891081</link>    <guid>https://juejin.cn/post/7581666412021891081</guid>    <pubDate>2025-12-09T14:21:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581666412021891081" data-draft-id="7531888171584897059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="requestAnimationFrame 与 JS 事件循环：宏任务执行顺序分析"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-09T14:21:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            requestAnimationFrame 与 JS 事件循环：宏任务执行顺序分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T14:21:41.000Z" title="Tue Dec 09 2025 14:21:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="arduino-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#434f54}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#00979d}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code,.hljs-literal{color:#d35400}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#00979d}.hljs-deletion,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#005c5f}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-comment{color:rgba(149,165,166,.8)}.hljs-meta-keyword{color:#728e00}.hljs-meta{color:#434f54}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-function{color:#728e00}.hljs-number{color:#8a7b52}</style><h2 data-id="heading-0">一、先理清核心概念</h2>
<p>在讲解执行顺序前，先明确几个关键概念：</p>
<ol>
<li><strong>宏任务（Macrotask）</strong> ：常见的有 <code>setTimeout</code>、<code>setInterval</code>、I/O 操作、script 整体代码、UI 渲染（注意：渲染是独立阶段，不是宏任务，但和 rAF 强相关）。</li>
<li><strong>微任务（Microtask）</strong> ：<code>Promise.then/catch/finally</code>、<code>queueMicrotask</code>、<code>MutationObserver</code> 等，会在宏任务执行完后、渲染 / 下一个宏任务前立即执行。</li>
<li><strong>requestAnimationFrame</strong>：不属于宏任务 / 微任务，是浏览器专门为动画设计的 API，会在<strong>浏览器重绘（渲染）之前</strong>执行，执行时机在微任务之后、宏任务之前（下一轮）。</li>
</ol>
<h2 data-id="heading-1">二、事件循环的执行流程</h2>
<p>一个完整的事件循环周期执行顺序：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 执行当前宏任务（如 script 主代码）
<span class="hljs-bullet">2.</span> 执行所有微任务（微任务队列清空）
<span class="hljs-bullet">3.</span> 执行 requestAnimationFrame 回调
<span class="hljs-bullet">4.</span> 浏览器进行 UI 渲染（重绘/回流）
<span class="hljs-bullet">5.</span> 取出下一个宏任务执行，重复上述流程
</code></pre>
<h2 data-id="heading-2">三、代码分析</h2>
<p><strong>代码执行优先级</strong>：同步代码 &gt; 微任务 &gt; rAF（当前帧） &gt; 普通宏任务（setTimeout） &gt; rAF（下一帧） &gt; 后续普通宏任务。</p>
<h4 data-id="heading-3">场景 1：基础顺序（script + 微任务 + rAF + 宏任务）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 同步代码（属于第一个宏任务：script 整体）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'同步代码执行'</span>);

<span class="hljs-comment">// 微任务</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'微任务执行'</span>);
});

<span class="hljs-comment">// requestAnimationFrame</span>
<span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'requestAnimationFrame 执行'</span>);
});

<span class="hljs-comment">// 宏任务（setTimeout 是宏任务）</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout 宏任务执行'</span>);
}, <span class="hljs-number">0</span>);

<span class="hljs-comment">// 执行结果顺序大部分情况下是这样的：</span>
<span class="hljs-comment">// 同步代码执行</span>
<span class="hljs-comment">// 微任务执行</span>
<span class="hljs-comment">// requestAnimationFrame 执行</span>
<span class="hljs-comment">// setTimeout 宏任务执行</span>
</code></pre>
<p><strong>代码解释1</strong>：</p>
<ul>
<li>第一步：执行同步代码，打印「同步代码执行」；</li>
<li>第二步：微任务队列有 <code>Promise.then</code>，执行并打印「微任务执行」；</li>
<li>第三步：浏览器准备渲染前，执行 rAF 回调，打印「requestAnimationFrame 执行」；</li>
<li>第四步：浏览器完成渲染后，取出下一个宏任务（setTimeout）执行，打印「setTimeout 宏任务执行」。</li>
</ul>
<p><strong>代码解释2</strong>：</p>
<ul>
<li>
<p><strong>正常浏览器环境（60Hz 屏幕，无阻塞）</strong> ：输出顺序是按上方写的先后顺序执行的：</p>
<pre><code class="hljs language-arduino" lang="arduino">同步代码执行
微任务执行
requestAnimationFrame 执行
setTimeout 宏任务执行
</code></pre>
<p>原因：浏览器每 16.7ms 刷新一次，<code>requestAnimationFrame</code> 会在<strong>下一次重绘前</strong>执行，而 <code>setTimeout</code> 即使设为 0，也会有 4ms 左右的最小延迟（浏览器限制），所以 <code>requestAnimationFrame</code> 先执行。</p>
</li>
<li>
<p><strong>极端情况（主线程阻塞 / 浏览器刷新延迟）</strong> ：可能出现顺序互换：</p>
<pre><code class="hljs language-arduino" lang="arduino">同步代码执行
微任务执行
setTimeout 宏任务执行
requestAnimationFrame 执行
</code></pre>
<p><strong>原因</strong>：如果主线程处理完微任务后，<code>requestAnimationFrame</code> 的回调还没到执行时机（比如浏览器还没到重绘节点），但 <code>setTimeout</code> 的最小延迟已到，就会先执行 <code>setTimeout</code>。</p>
</li>
</ul>
<h3 data-id="heading-4">总结</h3>
<ol>
<li>
<p><strong>固定顺序</strong>：同步代码 → 微任务，这两步是绝对固定的，不受任何因素影响。</p>
</li>
<li>
<p><strong>不固定顺序</strong>：<code>requestAnimationFrame</code> 和 <code>setTimeout</code> 的执行先后不绝对，前者优先级更高但依赖渲染时机，后者受最小延迟限制，多数场景下前者先执行，但不能当作 “绝对结论”。</p>
</li>
<li>
<p>核心原则：<code>requestAnimationFrame</code> 属于 “渲染相关回调”，优先级高于普通宏任务（如 <code>setTimeout</code>），但并非 ECMAScript 标准定义的 “微任务 / 宏任务” 范畴，而是浏览器的扩展机制，因此执行时机存在微小不确定性。</p>
</li>
</ol>
<h4 data-id="heading-5">场景 2：嵌套场景（rAF 内嵌套微任务 / 宏任务）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'同步代码'</span>);

<span class="hljs-comment">// 第一个 rAF</span>
<span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'rAF 1 执行'</span>);
  
  <span class="hljs-comment">// rAF 内的微任务</span>
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'rAF 1 内的微任务'</span>);
  });
  
  <span class="hljs-comment">// rAF 内的宏任务</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'rAF 1 内的 setTimeout'</span>);
  }, <span class="hljs-number">0</span>);
  
  <span class="hljs-comment">// rAF 内嵌套 rAF</span>
  <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'rAF 2 执行'</span>);
  });
});

<span class="hljs-comment">// 外层微任务</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'外层微任务'</span>);
});

<span class="hljs-comment">// 外层宏任务</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'外层 setTimeout'</span>);
}, <span class="hljs-number">0</span>);

<span class="hljs-comment">// 执行结果顺序：</span>
<span class="hljs-comment">// 同步代码</span>
<span class="hljs-comment">// 外层微任务</span>
<span class="hljs-comment">// rAF 1 执行</span>
<span class="hljs-comment">// rAF 1 内的微任务</span>
<span class="hljs-comment">// 外层 setTimeout</span>
<span class="hljs-comment">// （浏览器下一次渲染前）</span>
<span class="hljs-comment">// rAF 2 执行</span>
<span class="hljs-comment">// rAF 1 内的 setTimeout</span>
</code></pre>
<p><strong>代码解释</strong>：</p>
<ol>
<li>先执行同步代码 → 外层微任务；</li>
<li>执行 rAF 1 → 立即执行 rAF 1 内的微任务（微任务会在当前阶段清空）；</li>
<li>浏览器渲染后，执行下一轮宏任务：外层 setTimeout；</li>
<li>下一次事件循环的渲染阶段，执行嵌套的 rAF 2；</li>
<li>最后执行 rAF 1 内的 setTimeout（下下轮宏任务）。</li>
</ol>
<h4 data-id="heading-6">场景 3：rAF 与多个宏任务对比</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 宏任务1：setTimeout 0</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout 1'</span>);
}, <span class="hljs-number">0</span>);

<span class="hljs-comment">// rAF</span>
<span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'rAF 执行'</span>);
});

<span class="hljs-comment">// 宏任务2：setTimeout 0</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout 2'</span>);
}, <span class="hljs-number">0</span>);

<span class="hljs-comment">// 执行结果顺序：</span>
<span class="hljs-comment">// rAF 执行</span>
<span class="hljs-comment">// setTimeout 1</span>
<span class="hljs-comment">// setTimeout 2</span>
</code></pre>
<p><strong>结论</strong>：即使多个宏任务排在前面，rAF 依然会在「微任务后、渲染前」优先执行，然后才执行所有待处理的宏任务。</p>
<h2 data-id="heading-7">四、实际应用</h2>
<p>rAF 的这个执行特性，常用来做高性能动画（比如 DOM 动画），因为它能保证在渲染前执行，避免「布局抖动」：</p>
<pre><code class="hljs language-ini" lang="ini">// 用 rAF 实现平滑移动动画
const <span class="hljs-attr">box</span> = document.getElementById(<span class="hljs-string">'box'</span>)<span class="hljs-comment">;</span>
let <span class="hljs-attr">left</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>

function moveBox() {
  left += 1<span class="hljs-comment">;</span>
  <span class="hljs-attr">box.style.left</span> = `<span class="hljs-variable">${left}</span>px`<span class="hljs-comment">;</span>
  
  // 动画未结束则继续调用 rAF
  if (left &lt; 300) {
    requestAnimationFrame(moveBox)<span class="hljs-comment">;</span>
  }
}

// 启动动画
requestAnimationFrame(moveBox)<span class="hljs-comment">;</span>
</code></pre>
<p>这个代码的优势：rAF 会和浏览器的刷新频率（通常 60Hz，每 16.7ms 一次）同步，不会像 <code>setTimeout</code> 那样可能出现丢帧，因为 <code>setTimeout</code> 是宏任务，执行时机不固定，可能错过渲染时机。</p>
<h3 data-id="heading-8">总结</h3>
<ol>
<li><strong>核心执行顺序</strong>：同步代码 → 所有微任务 → requestAnimationFrame → 浏览器渲染 → 下一轮宏任务（setTimeout/setInterval 等）。</li>
<li><strong>rAF 本质</strong>：不属于宏 / 微任务，是浏览器渲染阶段的「专属回调」，优先级高于下一轮宏任务。</li>
<li><strong>实战价值</strong>：rAF 适合做 UI 动画，能保证动画流畅；宏任务（setTimeout）适合非渲染相关的异步操作，避免阻塞渲染。</li>
</ol>
<h2 data-id="heading-9">相比传统的计时器防抖与节流</h2>
<h3 data-id="heading-10">实战代码：rAF 实现节流（最常用）</h3>
<p>rAF 做节流的核心优势：和浏览器渲染同步，不会出现「执行次数超过渲染帧」的无效执行，尤其适合 <code>resize</code>、<code>scroll</code>、<code>mousemove</code> 这类和 UI 相关的高频事件。</p>
<h4 data-id="heading-11">基础版 rAF 节流</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">rafThrottle</span>(<span class="hljs-params">callback</span>) {
  <span class="hljs-keyword">let</span> isPending = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 标记是否已有待执行的回调</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (isPending) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 已有待执行任务，直接返回</span>
    
    isPending = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// 绑定 this 指向，传递参数</span>
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;
    <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
      callback.<span class="hljs-title function_">apply</span>(context, args); <span class="hljs-comment">// 执行回调</span>
      isPending = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 执行完成后重置标记</span>
    });
  };
}

<span class="hljs-comment">// 测试：监听滚动事件</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-title function_">rafThrottle</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'滚动节流执行'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>);
}));
</code></pre>
<p><strong>代码解释</strong>：</p>
<ol>
<li><code>isPending</code> 标记是否有 rAF 回调待执行，避免同一帧内多次触发；</li>
<li>每次触发事件时，若没有待执行任务，就通过 rAF 注册回调；</li>
<li>rAF 会在<strong>下一次渲染前执行回调</strong>，执行完后重置标记，确保每帧只执行一次。</li>
</ol>
<h4 data-id="heading-12">对比传统 setTimeout 节流</h4>
<pre><code class="hljs language-ini" lang="ini">// 传统 setTimeout 节流（对比用）
function timeoutThrottle(callback, <span class="hljs-attr">delay</span> = <span class="hljs-number">16.7</span>) {
  let <span class="hljs-attr">timer</span> = null<span class="hljs-comment">;</span>
  return function(...args) {
    if (timer) return<span class="hljs-comment">;</span>
    <span class="hljs-attr">timer</span> = setTimeout(() =&gt; {
      callback.apply(this, args)<span class="hljs-comment">;</span>
      <span class="hljs-attr">timer</span> = null<span class="hljs-comment">;</span>
    }, delay)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p>rAF 节流的优势：</p>
<ul>
<li><strong>执行时机和浏览器渲染帧完全同步，不会出现「回调执行了但渲染没跟上」的无效操作</strong>；</li>
<li><strong>无需手动设置延迟（如 16.7ms），自动适配浏览器刷新率（60Hz/144Hz 都能兼容）</strong>。</li>
</ul>
<h3 data-id="heading-13">实战代码：rAF 实现防抖</h3>
<p>rAF 实现防抖需要结合「延迟 + 取消 rAF」的逻辑，核心是「触发事件后，只保留最后一次 rAF 回调」。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">rafDebounce</span>(<span class="hljs-params">callback</span>) {
  <span class="hljs-keyword">let</span> rafId = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 保存 rAF 的 ID，用于取消</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;
    <span class="hljs-comment">// 若已有待执行的 rAF，先取消</span>
    <span class="hljs-keyword">if</span> (rafId) {
      <span class="hljs-title function_">cancelAnimationFrame</span>(rafId);
    }
    <span class="hljs-comment">// 重新注册 rAF，延迟到下一帧执行</span>
    rafId = <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
      callback.<span class="hljs-title function_">apply</span>(context, args);
      rafId = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 执行后清空 ID</span>
    });
  };
}

<span class="hljs-comment">// 测试：监听输入框输入</span>
<span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'input'</span>);
input.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-title function_">rafDebounce</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'输入防抖执行'</span>, e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
}));
</code></pre>
<p><strong>代码解释</strong>：</p>
<ol>
<li>每次触发事件时，先通过 <code>cancelAnimationFrame</code> 取消上一次未执行的 rAF 回调；</li>
<li>重新注册新的 rAF 回调，确保只有「最后一次触发」的回调会执行；</li>
<li>防抖的延迟本质是「一帧的时间（16.7ms）」，若需要更长延迟，可结合 <code>setTimeout</code>。</li>
</ol>
<h4 data-id="heading-14">带自定义延迟的 rAF 防抖</h4>
<pre><code class="hljs language-ini" lang="ini">function rafDebounceWithDelay(callback, <span class="hljs-attr">delay</span> = <span class="hljs-number">300</span>) {
  let <span class="hljs-attr">rafId</span> = null<span class="hljs-comment">;</span>
  let <span class="hljs-attr">timer</span> = null<span class="hljs-comment">;</span>
  return function(...args) {
    const <span class="hljs-attr">context</span> = this<span class="hljs-comment">;</span>
    // 取消之前的定时器和 rAF
    if (timer) clearTimeout(timer)<span class="hljs-comment">;</span>
    if (rafId) cancelAnimationFrame(rafId)<span class="hljs-comment">;</span>
    
    // 先延迟，再用 rAF 执行（保证渲染前执行）
    <span class="hljs-attr">timer</span> = setTimeout(() =&gt; {
      <span class="hljs-attr">rafId</span> = requestAnimationFrame(() =&gt; {
        callback.apply(context, args)<span class="hljs-comment">;</span>
        <span class="hljs-attr">rafId</span> = null<span class="hljs-comment">;</span>
        <span class="hljs-attr">timer</span> = null<span class="hljs-comment">;</span>
      })<span class="hljs-comment">;</span>
    }, delay)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-15">四、适用场景 vs 不适用场景</h3>



































<table><thead><tr><th>场景</th><th>是否适合用 rAF 做防抖 / 节流</th><th>原因</th></tr></thead><tbody><tr><td>scroll/resize 事件</td><td>✅ 非常适合</td><td>和 UI 渲染强相关，rAF 保证每帧只执行一次</td></tr><tr><td>mousemove/mouseover 事件</td><td>✅ 适合</td><td>高频触发，rAF 减少无效执行，提升性能</td></tr><tr><td>输入框 input/change 事件</td><td>✅ 适合（防抖）</td><td>保证输入完成后，在渲染前执行回调（如搜索联想）</td></tr><tr><td>网络请求（如按钮点击提交）</td><td>❌ 不适合</td><td>网络请求和 UI 渲染无关，用传统 setTimeout 防抖更合适</td></tr><tr><td>后端数据处理（无 UI 交互）</td><td>❌ 不适合</td><td>rAF 是浏览器 API，Node.js 环境不支持，且无渲染需求</td></tr></tbody></table>
<h3 data-id="heading-16">总结</h3>
<ol>
<li><strong>rAF 适合做防抖 / 节流</strong>，尤其在「和 UI 交互相关的高频事件」（scroll/resize/mousemove）场景下，性能优于传统 setTimeout；</li>
<li><strong>rAF 节流</strong>：核心是「每帧只执行一次」，利用 <code>isPending</code> 标记避免重复执行；</li>
<li><strong>rAF 防抖</strong>：核心是「取消上一次 rAF，保留最后一次」，可结合 setTimeout 实现自定义延迟；</li>
<li>非 UI 相关的防抖 / 节流（如网络请求），优先用传统 setTimeout，避免依赖浏览器渲染机制。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开发提效利器 - 用好Snippets]]></title>    <link>https://juejin.cn/post/7581698074361610249</link>    <guid>https://juejin.cn/post/7581698074361610249</guid>    <pubDate>2025-12-09T14:23:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581698074361610249" data-draft-id="7581691182003535882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开发提效利器 - 用好Snippets"/> <meta itemprop="keywords" content="前端,JavaScript,Visual Studio Code"/> <meta itemprop="datePublished" content="2025-12-09T14:23:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小寒"/> <meta itemprop="url" content="https://juejin.cn/user/694547078987287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开发提效利器 - 用好Snippets
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078987287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T14:23:50.000Z" title="Tue Dec 09 2025 14:23:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p><code>snippets</code> 意思是<strong>片段</strong>，在 <code>vscode</code> 中可以通过 <code>Snippets：Configure Snippets</code> 命令，可以定义<code>全局级（global）、项目级（Project）、语言级（Language）</code>代码片段，可以按照自定义的规则来快速生成一段代码，进而大幅提升我们的开发效率，可谓是工作提效利器。</p>
<h2 data-id="heading-1">1、如何创建 snippets？</h2>
<ol>
<li>第一步，在 vscode 按 <code>ctrl/command + shift + p</code>，输入 snippets，选择 <code>Snippets：Configure Snippets</code>，可以看到如下界面。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c45813bd7b5e4894bc36283a689f765e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895030&amp;x-signature=Qo%2FIsfeXkkAFrp64W3r0DjmhY64%3D" alt="" loading="lazy"/></p>
<p>可根据需要选择 snippets 的创建类型，一般选择 global 全局级别的 snippets 即可。</p>
<ol start="2">
<li>第二步，选择 <code>New Global Snippets file</code>，输入文件名，按 <code>enter</code> 键，即进入 <code>snippets</code> 配置文件设置。</li>
</ol>
<p>snippets 文件以 JSON 编写，里面支持书写注释，并可定义无限数量的 snippets。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"snippet"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
	<span class="hljs-attr">"scope"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"javascript,typescript"</span><span class="hljs-punctuation">,</span>
	<span class="hljs-attr">"prefix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"snippet"</span><span class="hljs-punctuation">,</span>
	<span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
		<span class="hljs-string">"console.log('$1');"</span><span class="hljs-punctuation">,</span>
	<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
	<span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"a simple snippet"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong>prefix</strong>：必填，可以定义一个或多个触发词，由于子字符串匹配不是严格匹配的，类似正则匹配，比如输入 <code>ts</code> 可以匹配到 <code>test</code>。</li>
<li><strong>body</strong>：必填，表示正文，是一行或多行内容，插入时会合并为多行。换行和嵌入的标签页将根据插入摘要的上下文进行格式化。</li>
<li><strong>description</strong>：可选，表示片段的描述。</li>
<li><strong>scope</strong>：可选，表示支持的语言，默认支持所有。</li>
</ul>
<h2 data-id="heading-2">2、snippets 支持语法</h2>
<h3 data-id="heading-3">2.1 光标控制</h3>
<ul>
<li>在 body 正文，它里面可以使用占位符：<code>$0、$1、$2...</code>，代表光标位置，<code>$0</code> 代表光标最后停留的位置，<code>$1</code> 代表光标第一个停留的位置，<code>$2</code> 代表光标第二个停留的位置，以此类推，在使用 <code>prefix</code> 触发词触发词生成代码片段后，可使用 <code>Tab</code> 键跳转到光标位置。</li>
<li>同名光标可以同时使用多个，比如可以使用多个 <code>$1</code>，就可以实现<strong>多光标同时编辑</strong>。</li>
<li>光标也可以加上默认值，比如 <code>${1：element}</code>，默认值为 <code>element</code>，如果触发词触发后，不输入任何内容，则光标位置默认为 <code>element</code>。</li>
<li>光标也可以提供多个值来选择，比如 <code>${1|element1,element2,element3|}</code>，当按 <code>Tab</code> 键移动到对应光标时，会出现下拉框可供选择。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfee01939b7b43a79f3423ce199291c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895030&amp;x-signature=R7Qdjzbk7YyVRRQheP8yfSKZ%2Bi8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2.2 Variables 变量</h3>
<p>在 body 正文可以使用变量，语法是 <code>$name</code> 或 <code>${name：default}</code>。其中 <code>default</code> 表示默认值（占位符），当变量未知（即其名称未定义）时，会采用这个默认值。</p>
<p>vscode 中内置一些变量：</p>
<ul>
<li><code>${TM_FILENAME}</code>：当前文件名。</li>
<li><code>${TM_FILENAME_BASE}</code>：当前文件名（不带扩展名）。</li>
<li><code>${TM_DIRECTORY}</code>：当前文件所在目录。</li>
<li><code>${TM_FILEPATH}</code>：当前文件路径。</li>
<li><code>${RELATIVE_FILEPATH}</code>：当前文档的相对（相对于已打开的工作区或文件夹）文件路径。</li>
<li><code>${RELATIVE_FILEPATH}</code>：当前文档的相对（相对于已打开的工作区或文件夹）文件路径。</li>
<li><code>${CLIPBOARD}</code>：剪切板的内容。</li>
<li><code>${TM_SELECTED_TEXT}</code>：当前选择的文本或空字符串。</li>
<li><code>${CURRENT_SECONDS_UNIX}</code>：10位 unix 时间戳。</li>
<li>...等等。</li>
</ul>
<p>更多变量可查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2Fdocs%2Fediting%2Fuserdefinedsnippets%23_variables" target="_blank" title="https://code.visualstudio.com/docs/editing/userdefinedsnippets#_variables" ref="nofollow noopener noreferrer">vscode snippets 官方文档</a>。</p>
<h3 data-id="heading-5">2.3 Transform 变换</h3>
<p>还支持对变量做正则替换。</p>
<p>举个例子，变量 <code>${TM_FILENAME}</code> 是表示当前文件名，比如当前文件名为 <code>test.js</code>，使用 <code>"${TM_FILENAME/[\\.]/_/}"</code>，表示将文件名中的 <code>.</code> 替换为 <code>_</code>，会把 <code>test.js</code> 变成 <code>test_js</code>。</p>
<p>这个语法怎么理解呢？</p>
<p>拿 js 对比来说，比如当前字符串 s 为 <code>test.js</code>，使用正则替换 <code>s.replace(/(.+)\.js/i, '$1df')</code>，其输出结果为 <code>testdf</code>，而在 vscode 中，如果当前文件名为 <code>test.js</code>，使用 <code>${TM_FILENAME/(.+)\\.js/$1df/i}</code>，也能得到同样的结果。</p>
<p><strong>具体规则差异总结如下</strong>：</p>
<ul>
<li>也就是不用逗号分开，而改为 <code>/</code>。</li>
<li>在以前 <code>\.js</code> 的正则语法中，需要增加一个 <code>\</code> 表示再多转义一次，要不然会报错。</li>
</ul>
<h2 data-id="heading-6">3、多人项目协作时如何实现 snippets 共享？</h2>
<p>之前说过，snippets 可以定义在<strong>全局级、项目级、语言级</strong>，所以，如果多人协作时，可以把 snippets 定义在项目级，这样 vscode 在根目录生成配置配置，目录如下： <code>根目录/.vscode/[snippet名].code-snippets</code>，可以在这个文件提交到 <code>git</code> 仓库中，这样项目成员都可以共享该 <code>snippets</code> 了。</p>
<h2 data-id="heading-7">4、如何在 markdown 文件中使用 vscode snippets?</h2>
<p>默认在 <code>vscode</code> 中，在<code>markdown</code> 文件编写内容是默认不支持 snippets 的，比如我平时写一些 <code>markdown</code> 表格时，会配置一个 <code>markdown</code> 表格的 <code>snippets</code>，但发现在 <code>markdown</code> 文件中输入触发词 <code>prefix</code> 根本无法使用。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
	<span class="hljs-attr">"md-table"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
		<span class="hljs-attr">"prefix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"md-table"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
			<span class="hljs-string">"| 列1标题 | 列2标题 | 列3标题 |"</span><span class="hljs-punctuation">,</span>
			<span class="hljs-string">"|---------|---------|---------|"</span><span class="hljs-punctuation">,</span>
			<span class="hljs-string">"| 内容A   | 内容B   | 内容C   |"</span><span class="hljs-punctuation">,</span>
			<span class="hljs-string">"| 内容D   | 内容E   | 内容F   |"</span>
		<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"markdown 表格"</span>
	<span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>后面发现可以手动插入 snippets。在 vscode 按 <code>ctrl/command + shift + p</code>，输入 snippets，选择 <code>Snippets：Insert Snippet</code>，就可以看到所有之前配置好对的 <code>snippets</code> 了，选择对应的 <code>snippet</code> 插入即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad056f39a5e543b0b3666bc72a6634fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895030&amp;x-signature=dfiKOIHUCsRPq6fW5PBcp0Z2tNQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">小结</h2>
<ul>
<li>vscode 支持<code>全局级（global）、项目级（Project）、语言级（Language）</code>代码片段，一般个人使用的话为了方便，直接定义<code>全局级</code>即可，需要进行多人协助时，可使用<code>项目级</code> snippets，将生成的配置文件上传到 <code>git</code> 仓库即可。</li>
<li>snippets 支持语法：<strong>光标控制、Variables 变量、Transform 变换</strong>等语法，可按需使用。</li>
<li>markdown 中默认不支持 snippets，但可以通过手动插入 snippets 来使用。</li>
</ul>
<p>最后为了方便，snippets 配置文件的编写可以使用这个工具网站进行生成：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsnippet-generator.app%2F%3Fdescription%3D%26tabtrigger%3D%26snippet%3D%26mode%3Dvscode" target="_blank" title="https://snippet-generator.app/?description=&amp;tabtrigger=&amp;snippet=&amp;mode=vscode" ref="nofollow noopener noreferrer">snippet-generator</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f57013cd7a5845ebaa7061e265696d52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895030&amp;x-signature=clLBVG8S7xpt%2F243wzD9G5PtyTk%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不敢把个人信息喂给 AI？OneAIFW 简单搞定隐私保护！]]></title>    <link>https://juejin.cn/post/7581693431740022847</link>    <guid>https://juejin.cn/post/7581693431740022847</guid>    <pubDate>2025-12-09T14:24:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581693431740022847" data-draft-id="7581689310643535914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不敢把个人信息喂给 AI？OneAIFW 简单搞定隐私保护！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-09T14:24:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不敢把个人信息喂给 AI？OneAIFW 简单搞定隐私保护！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T14:24:36.000Z" title="Tue Dec 09 2025 14:24:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近，在做几个落地的 AI 项目，发现“<strong>隐私</strong>”是无法绕开的一个关键挑战。</p>
<p>不是简单的达到“合规”，而是真正的避免客户的手机号、姓名等个人信息上传到云端大模型。</p>
<blockquote>
<p>本文暂不讨论私有部署大模型和端侧模型——它们虽理想，但并非所有场景都适用。</p>
</blockquote>
<p>我也了解了挺多方案，但是感觉都不那么自然或者简单，直到我看到 <code>OneAIFW</code> （一个AI防火墙？）。</p>
<h2 data-id="heading-0">OneAIFW</h2>
<p>连名字都是那么的朴实无华。</p>
<p><code>OneAIFW</code> 开源在 <code>GitHub</code> 上，采用 <code>MIT</code> 协议。</p>
<p>虽然目前 <code>star</code> 还不多，但我感觉前途可期。</p>
<p>它的原理简单概括就是：</p>
<ol>
<li><strong>脱敏</strong>：将发给大模型的文字中的隐私数据替换为为结构化占位符。</li>
<li>大模型接收的数据依然保留原有结构，不影响语义理解。</li>
<li><strong>还原</strong>：将大模型返回的文字中的为结构化占位符替换为原始文字。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50875c0df15b4c728b911a0e5fc628d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895075&amp;x-signature=c%2FflggbAYMLHxS4qfz0fsZhPVlI%3D" alt="" loading="lazy"/></p>
<p>是不是很简单，了解原理后我只有一个感觉：<strong>这么简单的思路，我为什么没有想出来。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e4701f02bd74e4cb5eebd9c16019aaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895075&amp;x-signature=1ShMAnQSRThZ3JpMCTMmqHKsdPs%3D" alt="屏幕录制 2025-12-09 192135.gif" loading="lazy"/></p>
<h3 data-id="heading-1">保护内容</h3>
<p>目前支持脱敏的内容：</p>
<ul>
<li>物理地址</li>
<li>邮箱地址</li>
<li>姓名 / 用户名</li>
<li>公司 / 组织名</li>
<li>电话号码</li>
<li>银行账户 / 卡号</li>
<li>支付信息</li>
<li>验证码</li>
<li>密码</li>
<li>随机种子</li>
<li>私钥</li>
<li>URL 地址</li>
</ul>
<h2 data-id="heading-2">在线体验</h2>
<p>光说不练假把式，不如直接上手试试。</p>
<p>官方提供了一个线上 <code>demo</code>，可以在线体验。</p>
<p>地址：<code>https://oneaifw.com/</code></p>
<p>可以直接分析敏感信息，也可以直接尝试脱敏的效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07f6aea8fe9440fd84aa22969f7f670f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895075&amp;x-signature=xyNPHdz9Pc6aEPIXKApzYUU%2B5NE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">使用方式</h2>
<p>该项目另一个很赞的点就是，它提供了我们常用的各种方式使用，包括本地 Web、浏览器插件、本地 API、本地命令行。</p>
<h3 data-id="heading-4">本地 Web</h3>
<p>一个轻量前端，依赖 <code>@oneaifw/aifw-js</code> 库，在浏览器里跑完整流程。</p>
<p>适合快速验证或嵌入现有 <code>Web</code> 应用。</p>
<h3 data-id="heading-5">浏览器插件</h3>
<p>提供 <code>Chrome/Edge</code> 扩展示例，可以注入到各类大模型网站，在你点击“发送”前自动脱敏。</p>
<p>这个估计是日常使用最佳的方式了。</p>
<h3 data-id="heading-6">本地 API</h3>
<p>通过 <code>py-origin</code> 或 <code>cli/python</code> 启动一个本地 HTTP 服务，提供 <code>/api/mask_text</code>、<code>/api/restore_text</code>、<code>/api/call</code> 等接口。</p>
<p>如果你和我一样正在开发 AI 项目，可以考虑通过 <code>API</code> 方式接入。</p>
<h3 data-id="heading-7">本地命令行</h3>
<p>装好 Python 包后，支持命令行直接调用，比如：</p>
<pre><code class="hljs language-perl" lang="perl">python -m aifw call <span class="hljs-string">"请把如下文本翻译为中文: My email address is test@example.com, and my phone number is 18744325579."</span>
</code></pre>
<p>非常适合脚本调用或自动化流程。</p>
<h2 data-id="heading-8">结语</h2>
<p>今天主要给大家分享了一个 AI 项目中解决<strong>隐私</strong>问题的产品，重点是设计思路，希望可以帮到大家。</p>
<p>我已经在跑通了 Web 版本，部署体验将在后续更新。</p>
<p>基座模型或许遥不可及，但 AI 时代的真正机会，往往藏在像 <code>OneAIFW</code> 这样的“<strong>小而关键</strong>”的环节里——它不炫技，只是让智能变得更安全、更可用。而这，正是我们每个人都能参与的方向。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分享 4 款基于 C# 编写、实用、开源的 Visual Studio 扩展插件]]></title>    <link>https://juejin.cn/post/7581698635865505818</link>    <guid>https://juejin.cn/post/7581698635865505818</guid>    <pubDate>2025-12-09T14:31:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581698635865505818" data-draft-id="7581698074361643017" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分享 4 款基于 C# 编写、实用、开源的 Visual Studio 扩展插件"/> <meta itemprop="keywords" content="后端,.NET,Visual Studio"/> <meta itemprop="datePublished" content="2025-12-09T14:31:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分享 4 款基于 C# 编写、实用、开源的 Visual Studio 扩展插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T14:31:29.000Z" title="Tue Dec 09 2025 14:31:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">EFCore.Visualizer</h2>
<p>EFCore.Visualizer 是一款可以直接在 Visual Studio 中查看 EF Core 查询计划调试器可视化工具（帮助开发者分析和优化数据库查询性能），目前，该可视化工具支持 SQL Server、PostgreSQL、SQLite、MySQL 和 Oracle。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGiorgi%2FEFCore.Visualizer" target="_blank" title="https://github.com/Giorgi/EFCore.Visualizer" ref="nofollow noopener noreferrer">github.com/Giorgi/EFCo…</a></li>
</ul>
<p><strong>SQL Server：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e691787d16a948af9e5d7a8ba5230db8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=EX9RWOjdSPUmlm34MLpKQC7ivlQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a0fa37859cb4ebeb2228d9183c4936f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=dTAyyB8FKUyhxA9mEei8GJOQCAA%3D" alt="" loading="lazy"/></p>
<p><strong>PostgreSQL：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c864e10f0dd54195a00034b3a0580080~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=HWji9kk5CIz6ibWqFxR%2BWn0JV6k%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3cd6e9076be42bb85881edfcfa06115~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=d5d6tB2MtVqdEaEMFmkQt6NlXao%3D" alt="" loading="lazy"/></p>
<p><strong>MySQL：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cba82dafcbe44c5f9fa47ac1ee2e770c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=MNldPXCOcpcNmSW7%2F9sFXgDnnN0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3a918d0160243f1b024aae56c1f4958~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=VAr4mvXtTuSrV9rCo9Ln%2BwrJmzI%3D" alt="" loading="lazy"/></p>
<p><strong>SQLite：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df060161a1de45ea96d7641f21b8eae7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=LVYFrHftoPIQZ90gXorkuuZwKiI%3D" alt="" loading="lazy"/></p>
<p><strong>Oracle：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e781551b6adc4046a6e33cc848ea20bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=ZRy3dO7dLM9LuE1FpRWqTrsg%2FjE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4041db549b1418ea151ff96e2d358b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=NBqvhT5ds9JJF2U6tp3XQgrKPN0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">EFCorePowerTools</h2>
<p>EF Core Power Tools 是一款基于 C# 编写、开源免费（MIT license）、在 EF Core 命令行工具的基础上构建的适用于 Visual Studio 2022 中的 EF Core 反向工程和模型可视化扩展插件。它提供了反向工程、迁移和模型可视化、生成关系图、生成SQL语句等功能，旨在降低使用 EF Core 的门槛，并通过图形用户界面（GUI）辅助开发者进行数据库的反向工程和DbContext模型的可视化。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FErikEJ%2FEFCorePowerTools" target="_blank" title="https://github.com/ErikEJ/EFCorePowerTools" ref="nofollow noopener noreferrer">github.com/ErikEJ/EFCo…</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f767bde05bfb4a018e63a031b75cca84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=qBIHeZ%2B9tMmVxMS5mTEwIlG4OTs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d76878419950449399eff07f3a51fc54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=M9HASn8HCNTk39CHw79CGGYMqB8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">AntDeploy</h2>
<p>AntDeploy 是一款由 .NET 开源、实用的 Visual Studio 发布部署插件，支持部署 Docker、IIS、Windows 和 Linux 服务，同时支持 .NET Framework 和 .NET Core，支持回滚和增量部署，在支持 Visual Studio 2019 和 2022 中使用。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyuzd%2FAntDeploy" target="_blank" title="https://github.com/yuzd/AntDeploy" ref="nofollow noopener noreferrer">github.com/yuzd/AntDep…</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef13464ed4e6407f92658906d6b21ace~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=QMKzcsOmoFQlbeTB%2FY31QAWdhL0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af8bc977ac27411a8c48387d41d3aa43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=1EUmS8duA55ynRMHlDoaqErQkuk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">FileEncoding</h2>
<p>FileEncoding 是一个专为 Visual Studio 设计的扩展插件，它能够在 Visual Studio 的文本编辑器右下角实时显示当前打开文档的编码格式。这一功能对于快速识别文件的编码非常有帮助，尤其是在处理来自不同平台或团队的代码时。更重要的是，通过简单的点击操作，用户还可以轻松修改文件的编码格式，无需借助外部工具或进行复杂的设置调整。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgenrwoody%2Fvs_file_encoding" target="_blank" title="https://github.com/genrwoody/vs_file_encoding" ref="nofollow noopener noreferrer">github.com/genrwoody/v…</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3cdf1686f64422c8a480f4f17c39ff1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=EnbPlaGqCYDNP0MJPTvZD238VaI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f51f232298ba471b9d36fb101d99fdaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895489&amp;x-signature=Cy5IgElvafg7wD5YSAWY9Hjdl3U%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">优秀项目和框架精选</h2>
<p>本文所有项目都已收录到C#/.NET/.NET Core优秀项目和框架精选中，关注优秀项目和框架精选能让你及时了解C#、.NET和.NET Core领域的最新动态和最佳实践，提高开发工作效率和质量。假如你有更好的推荐，欢迎大家踊跃提交PR推荐或自荐（<strong>让优秀的项目和框架不被埋没</strong>🤞）。</p>
<ul>
<li><strong>GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
<li><strong>Gitee开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fysgdaydayup%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">gitee.com/ysgdaydayup…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何设置你的 PWN 环境]]></title>    <link>https://juejin.cn/post/7581728606307008564</link>    <guid>https://juejin.cn/post/7581728606307008564</guid>    <pubDate>2025-12-09T14:36:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581728606307008564" data-draft-id="7581678301217013760" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何设置你的 PWN 环境"/> <meta itemprop="keywords" content="安全"/> <meta itemprop="datePublished" content="2025-12-09T14:36:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCultureBoy"/> <meta itemprop="url" content="https://juejin.cn/user/2664871913355463"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何设置你的 PWN 环境
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2664871913355463/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCultureBoy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T14:36:17.000Z" title="Tue Dec 09 2025 14:36:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你首先需要的是 <strong>Linux Shell</strong> ，因为大多数 pwn 挑战通常是 <strong>64 位 ELF 可执行文件</strong> 。我会写两个不同的部分，分别针对 Windows 和 MacOS。如果你已经用<strong>过任何 Linux 发行</strong>版，这部分你就没问题了！对于剩下的 Windows/MacOS 用户，我强烈建议安装 <strong>Debian Bookworm</strong> 作为首选发行版，因为它目前使用 <code>glibc 2.36</code>，尚未实现<strong>完整的 RELRO，</strong>  且利用起来稍微容易一些。</p>
<h2 data-id="heading-0">Windows</h2>
<p>对于正在阅读本文的 Windows 用户，你可以按照链接的说明书轻松下载 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fwindows%2Fwsl%2Finstall" target="_blank" title="https://learn.microsoft.com/en-us/windows/wsl/install" ref="nofollow noopener noreferrer">WSL</a></strong>。如果你懒得看，这里有一份你应该执行的命令列表。</p>
<p>安装使用 Debian for WSL</p>
<pre><code class="hljs language-arduino" lang="arduino">wsl.exe --update
wsl --set-<span class="hljs-keyword">default</span>-version <span class="hljs-number">2</span>
wsl install -d Debian
</code></pre>
<p>就是这样！从现在起，你可以通过开始<strong>菜单</strong>中的 <code>Debian 搜索 Debian</code>，或者在命令行中运行 <code>Debian</code>，进入你的 <strong>Debian shell</strong>。关于上述 <strong>WSL 2</strong> 的要求，WSL 2 允许你在 WSL 内部的集成桌面模式下使用 GUI 应用。这其实没什么特别的意义，除了<strong>你可以让你的调试器在一个新窗口里弹出，不用 <code>tmux</code>，这对我来说简直是个大胜利!!</strong></p>
<p>补充一点，你可能需要<strong>更新系统包</strong> ，并下载文本编辑器，以避免在 WSL 终端和其他窗口之间切换。你可以用以下命令完成： <code>sudo apt update &amp;&amp; sudo apt dist-upgrade &amp;&amp; sudo apt(-get) install &lt;editor of choice&gt;</code> 。</p>
<p>如果你想要完全懒散的体验和最少的 Linux shell 作，你可以挂<strong>载你的 Windows 文件系统</strong> ，并在 <strong>Downloads</strong> 目录中使用以下命令（不区分大小写！）： <code>cd /mnt/c/users/your\ name/downloads</code></p>
<h2 data-id="heading-1">macOS</h2>
<p>不幸的是，对于 MacOS 用户来说，我觉得没有像 Windows 用户那样的集成桌面。所以，我建议你按照这个指南作，尽可能多<strong>地在终端里作</strong> ，你会在其中花费比预期更多的时间。好消息是，有 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flima-vm%2Flima" target="_blank" title="https://github.com/lima-vm/lima" ref="nofollow noopener noreferrer">Lima</a></strong>，我们可以用它帮助简化创建 x64 Linux 壳，即使是在 <strong>Apple Silicon</strong> 上。</p>
<p>这里有一份快速入门的推荐清单。</p>
<pre><code class="hljs language-arduino" lang="arduino">brew install lima
limactl start --name=x64-debian <span class="hljs-keyword">template</span>:<span class="hljs-comment">//debian --arch=x86_64</span>
limactl shell x64-debian 
sudo apt install tmux
</code></pre>
<p>你<strong>会</strong>遇到终端颜色的问题，解决方案完全<strong>取决于你的终端模拟器</strong> ，所以你自己找解决方案。</p>
<p>额外加分：可写主机文件系统！</p>
<p><code>LiMactl 编辑 x64-debian</code> 以编辑配置
添加以下不安全的配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">mounts:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">location:</span> <span class="hljs-string">"~"</span>
  <span class="hljs-attr">writable:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>现在你拥有了一个运行在 x64 上的 Linux <strong>Shell</strong> ，可以不受限制地访问你的主机文件系统！
你可以用<code>标签</code>自动补全<strong>你的虚拟机名字</strong>拼写！</p>
<p>恭喜你通过了 Linux 安装！繁琐的部分现在开始了......我们先着手安装调试器和基础工具。</p>
<h3 data-id="heading-2">工具安装</h3>
<hr/>
<p>恭喜你完成了Linux安装！乏味的部分现在开始了...让我们先安装调试器和基本工具。</p>
<h4 data-id="heading-3">实用工具</h4>
<hr/>
<h5 data-id="heading-4">pwntools</h5>
<ol>
<li><code>sudo apt install python3</code> 安装python</li>
<li><code>sudo apt-get install python3-pwntools</code> 安装pwntools</li>
<li><code>pwn checksec /lib/x86_64-linux-gnu/libc.so.6</code> 验证它是否工作</li>
</ol>
<h5 data-id="heading-5">one gadget</h5>
<ol>
<li><code>sudo apt install rubygems</code> 安装gem</li>
<li><code>gem install one_gadget</code> 安装one gadget</li>
<li><code>one_gadget /lib/x86_64-linux-gnu/libc.so.6</code> 验证它是否工作</li>
</ol>
<h5 data-id="heading-6">rop gadget</h5>
<ol>
<li><code>sudo -H python3 -m pip install ROPgadget</code> 安装ROPgadget</li>
<li><code>ROPgadget /lib/x86_64-linux-gnu/libc.so.6</code> 验证它是否工作（警告：输出量很大！！）</li>
</ol>
<h4 data-id="heading-7">调试器</h4>
<hr/>
<p>我<strong>强烈推荐<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbata24%2Fgef" target="_blank" title="https://github.com/bata24/gef" ref="nofollow noopener noreferrer">bata-gef</a></strong>，你也应该使用它！</p>
<p>我不建议盲目运行安装脚本。相反，<strong>克隆仓库</strong>并在你的<code>.gdbinit</code>中source它的<code>gef.py</code>。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> ~
git <span class="hljs-built_in">clone</span> https://github.com/bata24/gef
vi ~/.gdbinit

<span class="hljs-comment">#.gdbinit</span>
<span class="hljs-built_in">source</span> /path/to/gef.py
</code></pre>
<p>对于没有集成桌面模式的MacOS用户，<strong>使用我们之前安装的tmux</strong>。只需运行以下命令：</p>
<ol>
<li><code>tmux</code> 启动tmux</li>
<li><code>[Ctrl] + B</code> 进入命令模式</li>
<li><code>]</code> 启用滚动</li>
<li><code>[Ctrl] + C</code> 重置状态</li>
<li><code>[Ctrl] + B</code>，然后<code>&lt;arrow&gt;</code> 切换焦点标签页</li>
</ol>
<h4 data-id="heading-8">反编译器/反汇编器</h4>
<hr/>
<p>太好了！现在我们有了开始编写和调试_pwn_脚本所需的一切，这<strong>技术上</strong>就是我们需要的全部，但有时，挑战不提供<strong>源代码</strong>。在这种情况下，需要进行一些<strong>逆向工程工作</strong>。让我们下载**<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FNationalSecurityAgency%2Fghidra" target="_blank" title="https://github.com/NationalSecurityAgency/ghidra" ref="nofollow noopener noreferrer">Ghidra</a>**。</p>
<p>设置相当简单，你只需要一个<strong>Java运行时</strong>，我推荐<strong>Temurin</strong>，你可以在</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fadoptium.net%2Fen-GB%2Ftemurin%2Freleases" target="_blank" title="https://adoptium.net/en-GB/temurin/releases" ref="nofollow noopener noreferrer">这里</a>
找到它。</p>
<p>一旦你安装了运行时，只需运行<code>ghidraRun</code>或<code>ghidraRun.bat</code>来启动<strong>Ghidra</strong>。</p>
<h5 data-id="heading-9">使用Ghidra</h5>
<p>Ghidra实际上相当不错且用户友好，你所要做的就是<strong>创建一个空项目</strong>，然后<strong>拖放</strong>你的挑战二进制文件到其中，并给它一点时间来生成反汇编和反编译！</p>
<h3 data-id="heading-10">容器化和服务器复制</h3>
<hr/>
<p><strong>恭喜</strong>你走到这一步！你已经准备好处理几乎所有pwn挑战了。然而，我们可以做得更好。</p>
<p>有时，善意的挑战作者会提供<strong>libc、ld和/或Dockerfile</strong>。这些文件特别有用，因为它们帮助你确保你的挑战<strong>使用与服务器相同的库</strong>，确保你永远不会遇到_"在我的机器上可以运行"_的问题！所以，我将介绍如何处理这些文件的各种组合。</p>
<h4 data-id="heading-11">给定了Libc、ld和Dockerfile</h4>
<hr/>
<p>这是最好的情况，因为你不需要做太多。这里有一个你可以运行的命令来使用给定的<code>libc</code>和<code>ld</code>：</p>
<p><code>./ld-linux-x86-64.so.2 --library-path . ./chal</code></p>
<p>这将运行<strong>链接器</strong>，并告诉它使用<strong>你目录中的库</strong>来启动挑战。<strong>就这样！</strong> 你现在正在使用给定的库。但是，我们如何复制服务器呢？</p>
<p>首先，我们必须安装<strong>Docker</strong>。过程相当长，但请相信</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.docker.com%2Fengine%2Finstall%2Fdebian%2F" target="_blank" title="https://docs.docker.com/engine/install/debian/" ref="nofollow noopener noreferrer">文档</a>
并遵循它。</p>
<p>一旦你安装了<strong>Docker</strong>，你所要做的就是运行以下命令：</p>
<p><code>docker run -p YOUR_PORT:CONTAINER_PORT -d --privileged $(docker build -q .)</code></p>
<p>这将构建容器，然后以<strong>特权</strong>运行它，这通常是_pwn.red/jail_模板所需要的。请将<code>CONTAINER_PORT</code>占位符替换为容器提供挑战的端口，将<code>YOUR_PORT</code>替换为宿主机上的任何未使用端口。默认情况下，这将<strong>绑定到所有接口</strong>。</p>
<p>设置完成后，你可以像这样连接到容器并运行挑战：</p>
<p><code>nc 127.0.0.1 YOUR_PORT</code></p>
<p>就这样！你已经成功复制了服务器使用的库，以及服务器本身！完成后，你应该通过运行<code>docker ps</code>找到容器哈希，然后运行<code>docker stop &lt;hash&gt;</code>来清理正在运行的容器。</p>
<h4 data-id="heading-12">只提供了Dockerfile</h4>
<hr/>
<p>有时，作者只提供<code>Dockerfile</code>。这很糟糕，但没关系，因为我们可以自己提取<code>libc</code>和<code>ld</code>。我们首先使用上述步骤启动容器，然后执行以下操作：</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">cp</span> 1a2b:/lib/x86_64-linux-gnu/libc.so.6 ./libc.so.6
docker <span class="hljs-built_in">cp</span> 1a2b:/lib/x86_64-linux-gnu/ld-linux-x86-64 ./ld-linux-x86-64.so.2
</code></pre>
<p>记得将<code>1a2b</code>替换为容器哈希的<strong>前4个字符</strong>，启动时会显示给你。有时，<strong>Dockerfile</strong>会从另一个<strong>Linux发行版</strong>复制文件到一个文件夹来提供服务，以便使用该发行版的<code>libc</code>。在这种情况下，只需在路径前加上前缀。使用一个容器执行<code>COPY --from=debian:bookworm / /srv</code>的例子，我们只需在<code>/lib</code>前加上<code>/srv</code>来从服务器的文件中复制。</p>
<h3 data-id="heading-13">结论</h3>
<hr/>
<p>通过以上所有设置和安装，你应该拥有所有工具，以及开始处理pwn挑战的基本知识。<strong>快乐pwning！</strong> 如果你现在想了解更多关于pwn的一般知识，请阅读我的博客文章</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[精选 8 个基于 .NET 开源、功能强大的 AI 和 LLM 相关项目框架]]></title>    <link>https://juejin.cn/post/7581848286387109934</link>    <guid>https://juejin.cn/post/7581848286387109934</guid>    <pubDate>2025-12-09T14:38:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581848286387109934" data-draft-id="7581666412021907465" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="精选 8 个基于 .NET 开源、功能强大的 AI 和 LLM 相关项目框架"/> <meta itemprop="keywords" content=".NET,AI编程"/> <meta itemprop="datePublished" content="2025-12-09T14:38:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            精选 8 个基于 .NET 开源、功能强大的 AI 和 LLM 相关项目框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T14:38:25.000Z" title="Tue Dec 09 2025 14:38:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>如今，AI 应用正以前所未有的速度蓬勃发展，在各行各业展现出巨大的潜力与深远的影响力。今天，大姚为大家精心整理了 8 个基于 .NET 开源、功能强大的 AI 与大语言模型（LLM）相关项目框架，希望能为你的开发和探索提供有价值的参考。如果你有更优秀的项目推荐，欢迎通过提交 PR 或在文末留言分享！</p>
<h2 data-id="heading-1">Microsoft Agent Framework</h2>
<p>Microsoft Agent Framework 是一个面向 .NET 和 Python 的开源开发套件，用于构建 AI 智能体及多智能体工作流。它融合并扩展了 Semantic Kernel 与 AutoGen 项目的核心理念，在结合两者优势的基础上，进一步引入了全新能力。该框架由原班团队打造，将成为未来构建 AI 智能体的统一基础平台。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fagent-framework" target="_blank" title="https://github.com/microsoft/agent-framework" ref="nofollow noopener noreferrer">github.com/microsoft/a…</a></li>
<li>在线文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fagent-framework" target="_blank" title="https://learn.microsoft.com/en-us/agent-framework" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/agent…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/721ddf6a94624cbea1e6e6ad9b461d9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=047CxFYAMCM1u2KPvjO%2BOWjYPOg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c76fa44200c47bf8f3058e2c3d3ddef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=lXbg59XTc99O3T3CrZPwFA4QC%2Fc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">AutoGen</h2>
<p>AutoGen 是一个开源编程框架，它通过多个代理进行对话以解决任务，从而实现 LLM 应用的开发。AutoGen 代理可定制、可对话，并且能够无缝地允许人类参与。它们可以在不同的模式下运行，使用 LLM、人类输入和工具的组合。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fautogen" target="_blank" title="https://github.com/microsoft/autogen" ref="nofollow noopener noreferrer">github.com/microsoft/a…</a></li>
<li>在线文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmicrosoft.github.io%2Fautogen" target="_blank" title="https://microsoft.github.io/autogen" ref="nofollow noopener noreferrer">microsoft.github.io/autogen</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06c4024230364c5bbb7f04fc77d2bdab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=Oz31D7Rdq43UUYm%2F138Wrdn5AdU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/111d34687c5e45dbb94b82bdc36117c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=P9UKOLBSK3hCrXx%2FsI%2B%2FJrOjAU4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">Semantic Kernel</h2>
<p>Semantic Kernel 是一个开源的软件开发工具包（SDK），旨在将大型语言模型（LLM）如OpenAI、Azure OpenAI和Hugging Face与传统的编程语言如C#、Python和Java集成。这个项目通过提供插件系统，允许开发者轻松地创建能够调用这些大型语言模型的应用程序。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fsemantic-kernel" target="_blank" title="https://github.com/microsoft/semantic-kernel" ref="nofollow noopener noreferrer">github.com/microsoft/s…</a></li>
<li>在线文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fzh-cn%2Fsemantic-kernel%2Foverview%2F" target="_blank" title="https://learn.microsoft.com/zh-cn/semantic-kernel/overview/" ref="nofollow noopener noreferrer">learn.microsoft.com/zh-cn/seman…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70d925378e974620b90b390162ffab19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=wisfEKrq5fYlfWcmXMiHilgWbBc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a5141450d9446bda6c70382130da282~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=AwAgKzbhoVVGvCF%2Bd9zoxugNmRY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">BotSharp</h2>
<p>BotSharp 是一个面向企业级 LLM 应用的开源 AI 框架，旨在促进智能机器人助手在面向业务系统中的开发和应用。该项目涉及自然语言理解、计算机视觉和音频处理技术，并旨在推动智能机器人助手在企业级系统中的开发和应用。BotSharp 提供了开箱即用的机器学习算法，使普通程序员能够更快、更轻松地开发人工智能应用程序。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSciSharp%2FBotSharp" target="_blank" title="https://github.com/SciSharp/BotSharp" ref="nofollow noopener noreferrer">github.com/SciSharp/Bo…</a></li>
<li>在线文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbotsharp.readthedocs.io%2F" target="_blank" title="https://botsharp.readthedocs.io/" ref="nofollow noopener noreferrer">botsharp.readthedocs.io/</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3aed24fa0fec4f81b70f65063130e852~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=iLc3MViotFGHOoWrTL%2BOH4I%2BWBM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e06fec7b98514f2cbec883ba54579c87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=FGLjJRFkA4hs6XiTP2jK51KWVDE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/421b859bb7b14175b556d390b9e8bb2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=QZYFCD02VZG%2BW2mqiZ1%2BzU39g%2Bc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">Kernel Memory</h2>
<p>Kernel Memory（KM）是一种多模态AI服务，RAG 架构，使用 LLM 和自然语言索引和查询任何数据、跟踪来源、显示引用、异步内存模式。该存储库提供了特定 AI 和 LLMs 应用场景中内存的最佳实践和参考架构。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fkernel-memory" target="_blank" title="https://github.com/microsoft/kernel-memory" ref="nofollow noopener noreferrer">github.com/microsoft/k…</a></li>
<li>在线文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmicrosoft.github.io%2Fkernel-memory" target="_blank" title="https://microsoft.github.io/kernel-memory" ref="nofollow noopener noreferrer">microsoft.github.io/kernel-memo…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ab00cb6efaa4d0691566a947bf4ae00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=6MEJ27aRjuDBmgf2tuEKikIS7Bw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09b2ba121b6e4c59a1da017996bffcb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=lDCrMcJTs3%2FV8qdMYAts8EGPPVs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">LLamaSharp</h2>
<p>LLamaSharp是一个跨平台库，用于在本地设备上运行LLaMA/LLaVA模型（以及其他模型）。它基于llama.cpp，能够在CPU和GPU上高效进行推理。通过提供高级API和RAG支持，LLamaSharp使得在应用程序中部署大型语言模型（LLM）变得方便。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSciSharp%2FLLamaSharp" target="_blank" title="https://github.com/SciSharp/LLamaSharp" ref="nofollow noopener noreferrer">github.com/SciSharp/LL…</a></li>
<li>在线文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fscisharp.github.io%2FLLamaSharp%2Flatest%2F" target="_blank" title="https://scisharp.github.io/LLamaSharp/latest/" ref="nofollow noopener noreferrer">scisharp.github.io/LLamaSharp/…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04709de314bb44a0a69e08e970b4afed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=7Kcf3n735ZOundSEVDxMlkYDFu0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f89f47c63c5425db079a6986b749351~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=tIwQjqhpTcZ%2FF9E9nrZCnCfdRI8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">AntSK</h2>
<p>AntSK 是一个基于 .NET 9 和 Blazor 技术栈构建的企业级AI知识库和智能体平台，集成了 Semantic Kernel 和 Kernel Memory，提供完整的AI应用开发解决方案。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAIDotNet%2FAntSK" target="_blank" title="https://github.com/AIDotNet/AntSK" ref="nofollow noopener noreferrer">github.com/AIDotNet/An…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6940f925ca824af2a238d97c7693c321~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=ikRfhxjUUpfoUnlw5MHkJCipRmI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0913b94e5de149cc9ebf6002fe205ab3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=bPUDCXEd7nzAPv3FM6vL3plAGIo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">OllamaSharp</h2>
<p>OllamaSharp 旨在通过提供.NET绑定，使得开发者能够轻松地在.NET应用程序中使用Ollama API。简化了 .NET 与 Ollama 的本地和远程交互。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fawaescher%2FOllamaSharp" target="_blank" title="https://github.com/awaescher/OllamaSharp" ref="nofollow noopener noreferrer">github.com/awaescher/O…</a></li>
<li>在线文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Follama%2Follama%2Fblob%2Fmain%2Fdocs%2Fapi.md" target="_blank" title="https://github.com/ollama/ollama/blob/main/docs/api.md" ref="nofollow noopener noreferrer">github.com/ollama/olla…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef628a92ca64421981c65fd2a6c347e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765895905&amp;x-signature=g91D1OTExi53sH1WyvG2gc8DJro%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">优秀项目和框架精选</h2>
<p>本文所有项目都已收录到C#/.NET/.NET Core优秀项目和框架精选中，关注优秀项目和框架精选能让你及时了解C#、.NET和.NET Core领域的最新动态和最佳实践，提高开发工作效率和质量。假如你有更好的推荐，欢迎大家踊跃提交PR推荐或自荐（<strong>让优秀的项目和框架不被埋没</strong>🤞）。</p>
<ul>
<li><strong>GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
<li><strong>Gitee开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fysgdaydayup%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">gitee.com/ysgdaydayup…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浙江头部城商行：每日 700 万查询、秒级响应，Apache Doris 查算分离架构破局资源冲突]]></title>    <link>https://juejin.cn/post/7581688255625707572</link>    <guid>https://juejin.cn/post/7581688255625707572</guid>    <pubDate>2025-12-09T14:58:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581688255625707572" data-draft-id="7581728606307057716" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浙江头部城商行：每日 700 万查询、秒级响应，Apache Doris 查算分离架构破局资源冲突"/> <meta itemprop="keywords" content="Apache,数据库,后端"/> <meta itemprop="datePublished" content="2025-12-09T14:58:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浙江头部城商行：每日 700 万查询、秒级响应，Apache Doris 查算分离架构破局资源冲突
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T14:58:38.000Z" title="Tue Dec 09 2025 14:58:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在当前银行业务全面线上化、实时化的驱动下，浙江省头部城商行亟需构建一个能够同时承载海量数据加工与高并发实时查询的数据平台，以支撑精准营销、实时风控和智能决策等关键业务。</p>
<p>在这一数字化转型进程中，我们最终引入了 Apache Doris 作为湖仓一体架构的核心组件。Doris 凭借其卓越的查询性能、高吞吐、对标准 SQL 的完整支持以及高效的实时数据摄入能力，在多个候选方案中脱颖而出。尤其值得一提的是，其架构的灵活度及可扩展性、极大降低了运维难度和成本投入。<strong>截至目前，我们已顺利完成 200TB+ 历史数据的平滑迁移与落地，为后续的深度应用奠定了坚实基础</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f63bef9fcecb4e38962c8b6f95f1133f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765897117&amp;x-signature=cZtiLPeCAlQb%2FTrqTNYoX9qHwSo%3D" alt="1-整体架构图.PNG" loading="lazy"/></p>
<p>然而，在实践过程中，“算”（批量数据处理）与“查”（业务实时查询）这两种负载在资源需求与业务目标上的根本性矛盾逐渐凸显，解决这一矛盾已成为当下首要目标。</p>
<h2 data-id="heading-0">核心矛盾：“算”与“查”的资源争抢</h2>
<p>当“计算”和“查询”共用一个 Doris 集群时，资源争抢问题十分突出。例如，批量计算任务会在短时间内会占用大量 CPU、内存和 IO 资源，集群负载骤升，直接影响同时运行的业务查询的稳定性。其根本原因在于：</p>
<ul>
<li><strong>“算”的核心是吞吐量与任务交付</strong>。数仓专注于大规模数据的批量加工（如ETL、数据清洗与聚合计算），需要在有限资源下高效处理TB/PB级数据，确保任务在业务时间窗口内完成。其关键指标是任务成功率与产出时效，而对单个任务的响应时间并不敏感，只要能在业务允许的时间窗口内交付结果，即便耗时数小时亦可接受。</li>
<li><strong>“查”的核心是响应速度与服务可用性</strong>。它直接面向一线业务端（如实时风控、客户画像、经营报表），通常是对数仓加工后的结果数据进行即时查询，对查询响应速度和高可用有着严格要求——业务人员往往需要在秒级甚至毫秒级获取查询结果，且不能出现因集群问题导致的查询中断，否则会直接影响业务正常运转。</li>
</ul>
<h2 data-id="heading-1">解决方案：查算分离架构设计</h2>
<p>正因如此，我们意识到，<strong>要兼顾数据仓库“计算”的效率与业务“查询”的性能，“查算分离”架构是必然之选</strong>。该架构旨在将“计算”和“查询”的负载拆分到不同的集群中，使它们在各自专属的资源环境下运行。这样既能够充分发挥数据仓库的计算能力，又能确保业务查询的响应时间和稳定性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77a0e6418dbc4fcf8f35eb075058a46b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765897117&amp;x-signature=dQcplujt8sVTy0n6PN6PA3wxORs%3D" alt="2-解决方案：查算分离架构设计.PNG" loading="lazy"/></p>
<p>结合上图所示的存算分离架构，我们通过以下四个方面的设计，系统性地实现了查算分离目标：</p>
<ol>
<li><strong>查询低延迟保障</strong>：
为确保查询的低延迟，在 Doris 中部署了独立的查询集群，实现与计算集群的物理资源隔离，从根本上避免批量任务对线上查询的干扰。</li>
<li><strong>数据实时同步</strong>：
为打通计算与查询集群之间的数据链路，引入<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F112" target="_blank" title="https://www.selectdb.com/blog/112" ref="nofollow noopener noreferrer">跨集群数据复制功能 CCR</a>，实现表级数据的近实时同步。<strong>CCR 基于 Doris Binlog 的增量物理复制机制，可确保数据产出后快速同步至查询集群，且不影响线上查询性能。基于该能力，已成功上线 500 张表、30TB 数据， 在跑批高峰期主从延迟也能控制在 15 分钟内</strong>。</li>
<li><strong>高可用与容灾</strong>：
我们构建了双集群热备体系，日常将 95% 的查询流量导向查询集群，5% 流量分流至计算集群。通过持续的流量压测，确保两集群随时具备故障切换能力。</li>
<li><strong>成本投入控制</strong>：
在保障查询性能的前提下，为控制整体投入，我们在计算集群中创建了与查询集群规格相近的 Workload Group（查询 WG），并设置资源软限制策略，允许 ETL 任务弹性复用其闲置资源。该设计在常态下显著节约资源，尽管极端故障场景下全量切流可能引发短暂性能波动，但发生概率极低，风险整体可控。</li>
</ol>
<h2 data-id="heading-2">优化实践：性能提升百倍、 CPU 消耗仅 10%</h2>
<p>查询性能优化向来就是一个复杂的课题，它与 SQL 语句写法、数据量的大小、建表的设计等多个因素共同影响，难以一蹴而就。在业务从原有系统迁移至新环境时， 我们暂未针对 Doris 进行优化，因此在业务上线初期遭遇性能挑战：集群 QPS 仅维持在 10 左右，而 CPU 消耗却高达 90%。这样的表现显然无法满足业务正常运转的需求。</p>
<p>为此，我们从分区裁剪、记录过滤、并发执行和查询结果获取这四个维度进行全面的优化。优化后，<strong>查询性能相比之前提升百倍</strong>；在相同负载下，<strong>集群 CPU 消耗从 90% 下降到 10% 内</strong>，效果十分显著。在这次优化过程中，积累了不少实用经验，在此分享给大家。</p>
<p><strong>01 拆分查询 SQL 、优化分区裁剪，查询性能提升 6 倍</strong></p>
<p>下方代码块展示了我们最常见的 SQL 模板，其典型特征是根据 <code>etl_job_flag</code> 表中记录的数据产出时间筛选最新的业务数据。由于分区字段 <code>data_dt</code> 的查询条件是一个子查询，导致 Doris 在执行时无法动态裁剪分区，只能扫描所有历史分区，从而产生大量无效 IO。</p>
<p>我们对其进行了优化，首先将查询 SQL 拆分成两条 SQL 语句，先获取数据产出时间，再查询目标数据。其次将分区字段 <code>data_dt</code> 的条件调整为常量，限制其只扫描一个分区。<strong>通过该优化，实现了查询性能 6 倍的提升</strong>。</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-operator">/</span><span class="hljs-operator">/</span>  原始 <span class="hljs-keyword">SQL</span>
<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t <span class="hljs-keyword">where</span> data_dt <span class="hljs-operator">=</span> (<span class="hljs-keyword">select</span> <span class="hljs-built_in">max</span>(data_dt) <span class="hljs-keyword">from</span> etl_job_flag wehre etl_table <span class="hljs-operator">=</span><span class="hljs-string">'t'</span>) <span class="hljs-keyword">and</span>  其他过滤条件

<span class="hljs-operator">/</span><span class="hljs-operator">/</span>  优化后 <span class="hljs-keyword">SQL</span>
<span class="hljs-keyword">select</span> <span class="hljs-built_in">max</span>(busi_dt) <span class="hljs-keyword">from</span> etl_job_flag <span class="hljs-keyword">where</span>  etl_table <span class="hljs-operator">=</span> <span class="hljs-string">'t'</span>
<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t  <span class="hljs-keyword">where</span> data_dt  <span class="hljs-operator">=</span> xxx <span class="hljs-keyword">and</span> 其他过滤条件
</code></pre>
<p><strong>02 合理设计 Key 和索引，查询性能提升 6-7 倍</strong></p>
<p>Doris 的记录过滤遵循“成本从低到高”的顺序，依次为 Key Range 、索引过滤、 ZoneMap 和 BloomFilter 等轻量级过滤，最后执行谓词评估。由此可知，合理设计 Key 和索引是提升筛选效率的关键。在实践中，通过补充合适的 Key 和索引，<strong>查询性能获得 6-7 倍的提升</strong>。</p>
<p>以用户信息表 <code>user_info</code> 为例：</p>
<ul>
<li>将高频查询字段 <code>user_id</code>设为 Unique Key 和分桶字段，以利用 Key Range 快速定位数据范围。</li>
<li>对次高频查询字段 <code>user_name</code>建立倒排索引，提高查询效率。</li>
<li>控制分桶大小在 1G～10G，减少 segment 文件数量，提升倒排索引查询速度（Doris 每个 segment 文件对应独立的倒排索引）。</li>
</ul>
<p><strong>03 参数调试， 查询吞吐率提升 2-3 倍</strong></p>
<p>高并发和低响应时间是查询集群的核心需求，适当调整 Doris 的执行相关参数可有效提升查询吞吐量</p>
<ul>
<li><code>parallel_pipeline_task_num</code>：Pipeline task 是 Doris 执行调度的基本单元，<code>parallel_pipeline_task_num</code> 决定了单个查询的最大并发度。该参数的默认值为 0，即 BE CPU 核心数的一半。</li>
<li><code>num_scanner_threads</code>：Scan 算子负责数据扫描，为 Pipeline task 提供数据。<code>num_scanner_threads</code> 是单个 Scan 算子一次性提交到 Scan 线程池的任务数量，它直接影响查询扫描数据的并发度。该参数默认值也为 0，动态计算。</li>
</ul>
<p>如果将两个参数的默认值设置为高值，可能导致单一查询占用过多资源，进而引发 CPU 缓存污染。根据实际应用经验以及测试结果，建议可将 <code>parallel_pipeline_task_num</code> 设置为 8，将 <code>num_scanner_threads</code> 设置为 2，<strong>查询吞吐率可提升 2 - 3 倍</strong>。此处作为参考，具体数值可根据实际业务情况来调整。</p>
<p><strong>04  开启行存、降低 IO 开销，查询性能提升 30%</strong></p>
<p>在业务中，如果存在大量 <code>SELECT *</code> 的全列查询，Doris 将默认采用按列存储的方式，该方式需要读取所有列并拼接成行返回。而对于字段较多的表，这并不是最佳处理方式，会导致极高的 IO 成本。</p>
<p>因此，我们在建表或修改表时配置 <code>"store_row_column" = "true"</code>，开启行存模式。避免了多列拼接的额外开销，<strong>查询性能提升约 30%</strong>。</p>
<h2 data-id="heading-3">优化利器：慢查询监测 + 性能压测</h2>
<p><strong>01 报表 + Profile，全局观测慢查询</strong></p>
<p>在性能优化中，慢查询监测为我们提供了关键的数据洞察。通过对慢查询的持续追踪与分析，我们能够快速定位根因、实施针对性优化，并最终验证策略的有效性，确保我们的工作始终朝着正确的方向推进。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a29113ce156a4a67894fd9ec71f3d465~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765897117&amp;x-signature=XgLjH492%2BSTl%2F9H%2BmDNANoe%2FklA%3D" alt="3-优化利器：慢查询监测 + 性能压测.png" loading="lazy"/></p>
<p>作为监控集群查询状态的核心入口，<strong>查询报表在全局观测中扮演着重要角色</strong>。它基于审计日志（Audit log）及其他系统表构建，包括慢查询榜单、响应时间统计和错误统计等信息。</p>
<p><strong>Doris Profile 能够详细记录查询执行的统计信息</strong>，包括执行计划、每个算子的耗时和数据扫描量等，为定位查询性能问题提供了关键依据。Doris 默认的 Profile 存储机制是保存在内存中，默认保留 500 个；而我们因业务需求，需对 3 天内历史查询问题进行保留，以便问题追溯。因此，<strong>我们基于 Doris Profile 开发了 Profile 归档服务</strong>。</p>
<p><strong>具体工作原理为</strong>：当查询报表识别出慢查询时，Profile 归档服务会自动从 Doris 集群下载对应的 Profile 文件并保存至本地，同时生成专属的 HTTP 链接。管理员在浏览慢查询报表时，只需点击链接，即可直接查看对应的完整 Profile，无需担心因内存中 Profile 被清理而失去关键诊断信息，从而显著提升历史问题追溯的效率。</p>
<p>我们已在集群全局启用 Profile 功能，并将 <code>auto_profile_threshold_ms</code> 设置为 1000ms，这意味着所有执行时长超过 1 秒的查询都会自动记录 Profile，为后续分析提供充分的诊断依据。</p>
<p>查询报表与 Profile 的联动，构建了一套高效的性能优化闭环。一旦集群出现异常，报表会通过内部 IM 自动告警，管理员随即针对慢查询榜单，借助 Profile 进行深度分析、精准定位瓶颈。整个过程形成了从发现问题、精准定位到解决跟踪的完整闭环。</p>
<p><strong>02 查询压测工具，容量评估模拟器</strong></p>
<p>此外，我们基于 Python 开发了查询压测工具，用于上线新业务、扩容集群或优化配置之前，准确评估 Doris 集群的承载能力。</p>
<p>其设计理念是还原真实负载：从 Doris Audit log 中提取历史查询记录，通过多线程随机回放的方式，模拟生产环境中的实际查询压力。在压测过程中，工具会实时统计查询吞吐量、响应时间分布等关键指标。通过这些数据，我们能够评估集群的容量上限，或验证优化措施的有效性，为集群的资源规划与架构调整提供重要依据。</p>
<h2 data-id="heading-4">结束语</h2>
<p>通过以上优化，<strong>Doris 查询集群不仅实现了每日超 700 万次查询的稳定运行，99.95% 的查询响应时间均在 1 秒以内，更在压测中达到了 1500 QPS</strong>，充分验证了其已具备支撑实时查询的高性能与高稳定性，为 Doris 在湖仓一体平台中深度应用中扫清关键障碍。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[今夜，智谱把“手机贾维斯”的源代码，扔到了GitHub上]]></title>    <link>https://juejin.cn/post/7581698635865604122</link>    <guid>https://juejin.cn/post/7581698635865604122</guid>    <pubDate>2025-12-09T15:00:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581698635865604122" data-draft-id="7581698635865587738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="今夜，智谱把“手机贾维斯”的源代码，扔到了GitHub上"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-09T15:00:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            今夜，智谱把“手机贾维斯”的源代码，扔到了GitHub上
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T15:00:33.000Z" title="Tue Dec 09 2025 15:00:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025年12月9日，科技圈发生了一件可能会被载入AI发展史的大事。</p>
<p>当大部分人还在讨论哪家的大模型写诗更押韵时，智谱AI默默干了一件事：他们把自家的核心AI Agent模型——AutoGLM，正式开源了。</p>
<p>这不仅仅是开源了一个模型，更像是把一把通往“真·智能手机”时代的钥匙，交到了每一个开发者，甚至是普通玩家手里。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fasdasf-1.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/asdasf-1.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3d85c176f01409eb4443c924789aaa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765897233&amp;x-signature=NGPImYzvseZJKORyivXGpSYr%2BZg%3D" alt="asdasf" loading="lazy"/></a></p>
<h3 data-id="heading-0">真的能看懂屏幕的AI</h3>
<p>先别急着划走，我们得搞清楚AutoGLM和Siri、小爱同学到底有什么区别。</p>
<p>传统的语音助手，本质上是在调用APP提供的接口。如果APP不开接口，助手就是个瞎子。但AutoGLM走的是一条完全拟人的路子：<strong>视觉理解</strong>。</p>
<p>简单说，它像人眼一样“看”你的手机屏幕截图，用大模型分析界面上的按钮、文字、输入框在哪里，然后通过ADB指令模拟手指的点击和滑动。</p>
<p>这意味着什么？意味着它不需要微信给你开API，也能帮你回消息；不需要美团授权，也能帮你点外卖。</p>
<p>在智谱放出的演示里，这个9B参数量的模型（AutoGLM-Phone-9B），已经能熟练地在微信、淘宝、抖音、美团等50多个我们每天都在用的APP里“冲浪”。点外卖、订机票、发红包，这些需要跨应用、甚至长达几十步的操作，它都能自己搞定。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fv2-e6b5d85ff6306e3bd6990d1cca6ec2aa_r-1024x756.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/v2-e6b5d85ff6306e3bd6990d1cca6ec2aa_r-1024x756.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e22e6c80543d4f9d950ae9136e7f23b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765897233&amp;x-signature=TormdyNj%2B%2Bv8DVN78bedx5G09T8%3D" alt="v2-e6b5d85ff6306e3bd6990d1cca6ec2aa_r" loading="lazy"/></a></p>
<h3 data-id="heading-1">为什么说这是“掀桌子”？</h3>
<p>在前段时间，字节跳动的“豆包手机助手”刚让大家见识了AI操作手机的威力。就在各大巨头准备筑起高墙、圈地自萌的时候，智谱反手就是一个开源。</p>
<p>这一招，直接把技术门槛拉到了地板上。</p>
<p><strong>1. 每个人都能有自己的定制管家</strong> 开源意味着硬件厂商不用从头造轮子，华强北的开发者、甚至是你我这样懂点代码的极客，都可以基于AutoGLM，为自己的设备装上一个“大脑”。想做一个专门帮你抢演唱会门票的Agent？或者一个只在这个点帮你自动领游戏签到奖励的脚本？现在，底座有了。</p>
<p><strong>2. 隐私狂魔的福音</strong> 这是开源最核心的杀手锏。很多人不敢用云端AI操作手机，怕隐私泄露。AutoGLM支持本地部署。只要你的设备跑得动，所有的数据处理、屏幕识别、操作指令，全部都在你本地完成，不需要上传任何一字节的敏感信息给云端服务器。你的手机，完全由你掌控。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-09_22.55.13-811x1024.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-09_22.55.13-811x1024.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e3bdb5386094ef38c78fcf15d03092a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765897233&amp;x-signature=bu5%2BX0h7kAEjL8bpQO7DqTlkYn4%3D" alt="iShot_2025-12-09_22.55.13" loading="lazy"/></a></p>
<h3 data-id="heading-2">32个月的磨剑</h3>
<p>这个项目不是一时兴起。据透露，智谱团队从2023年4月就开始折腾这事儿了。</p>
<p>早期的版本很不稳定，像个刚学步的孩子，经常点错或者卡住。经过32个月的打磨，特别是AutoGLM 2.0版本，在数千个虚拟设备里进行了强化学习，现在的它已经具备了相当强悍的泛化能力。也就是说，哪怕APP更新了，界面微调了，它依然能认出“确认支付”的按钮在哪。</p>
<h3 data-id="heading-3">下一代手机的雏形</h3>
<p>我们总在喊“AI手机”元年，但如果AI手机只是多了一个画图功能，那未免太无聊了。</p>
<p>真正的AI手机，应该是你对它说“帮我订张明天去上海的票，要靠窗”，然后你就可以把手机扔一边去洗澡，出来时票已经出好了。AutoGLM的开源，正在把这个场景变成所有安卓设备的标配，而不再是某一款旗舰机的专属。</p>
<p>目前，项目代码已经托管在GitHub，模型权重也上了Hugging Face。虽然现在它可能还不够完美，偶尔也会犯傻，但开源社区的力量是恐怖的。也许下周，就会有大神魔改出更惊艳的版本。</p>
<p>对于开发者来说，这是风口；对于普通用户来说，那个像《钢铁侠》里贾维斯一样的管家，可能真的不远了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-09_22.55.08.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-09_22.55.08.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5ce46e99ca746499509b606a47c3b9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765897233&amp;x-signature=u38J41ooWuF1Itwm8uTDpMakHgw%3D" alt="iShot_2025-12-09_22.55.08" loading="lazy"/></a></p>
<p><strong>最后提个醒：</strong> 虽然代码开源了，但在让AI帮你花钱或者发消息之前，记得把那个“关键操作需人工确认”的开关打开。毕竟，你也不想一觉醒来，发现AI帮你清空了购物车，对吧？</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[屌炸天！一句话搞定一个商用级的商城列表页面]]></title>    <link>https://juejin.cn/post/7581676787380174867</link>    <guid>https://juejin.cn/post/7581676787380174867</guid>    <pubDate>2025-12-09T15:01:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581676787380174867" data-draft-id="7581678032336764970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="屌炸天！一句话搞定一个商用级的商城列表页面"/> <meta itemprop="keywords" content="Trae,AI编程,HTML"/> <meta itemprop="datePublished" content="2025-12-09T15:01:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            屌炸天！一句话搞定一个商用级的商城列表页面
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T15:01:50.000Z" title="Tue Dec 09 2025 15:01:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 V 哥，TRAE SOLO 实在太好用了，输入一句话，就可以生成一个你想要的程序，上一篇文章，V 哥试了一下一句话生成一个简易版的飞机大战，今天我们来玩一玩生成一个商城商品列表页面，废话不多说，马上开整。</p>
<p>先来看一下最终的效果图：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0defe0a98df34fbc98298684e6e8a67a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765897310&amp;x-signature=CfKbgLnm5%2BnA6%2BvtbpUkpYyjAhI%3D" alt="" loading="lazy"/></p>
<p>首先打开 TRAE AI 开发工具，新建一个任务，如下图：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19088870d2554702aa7343d39c997855~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765897310&amp;x-signature=Q%2F%2FsB%2BM232Na1BWfAHIHJ4BkSzw%3D" alt="" loading="lazy"/></p>
<p>在聊天窗口输入：请帮我生成一个V哥商城的商品列表页面</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7963fc8cda3747cd9a73abe51bb29cbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765897310&amp;x-signature=xaWVcB05fmYiTrNrg7i0DRpxvi0%3D" alt="" loading="lazy"/></p>
<p>咔咔咔，RRAE SOLO 就开始工作了，生成的过程是这样的：</p>
<pre><code class="hljs language-markdown" lang="markdown">我需要先了解当前项目的结构和技术栈，然后生成V哥商城的商品列表页面。
<span class="hljs-code">        
            
toolName: view_folder
            
status: success
          
/Users/vince/Trae/demo1
          
让我先查看index.html文件的内容，了解当前页面结构。
        
            
toolName: view_files
            
status: success
          
            
filePath: /Users/vince/Trae/demo1/index.html
          
现在查看script.js文件，了解当前的JavaScript逻辑。
        
            
toolName: view_files
            
status: success
          
            
filePath: /Users/vince/Trae/demo1/script.js
          
现在查看style.css文件，了解当前的样式设计。
        
            
toolName: view_files
            
status: success
          
            
filePath: /Users/vince/Trae/demo1/style.css
          
现在我需要运行项目，查看实际效果，确保页面正常显示。
        
            
toolName: run_command
            
status: running
          
command: python3 -m http.server 8000 undefined
          
服务器已成功启动，现在预览页面效果。
        
            
toolName: open_preview
            
status: success
          
预览
          
页面标题需要从“京东商品列表”修改为“V哥商城”，让我更新index.html文件。
        
            
toolName: edit_file_search_replace
            
status: success
          
            
filePath: /Users/vince/Trae/demo1/index.html
          
changes: undefined
          
我已经成功生成了“V哥商城”的商品列表页面。以下是完成的工作：
</span>
<span class="hljs-section">## 页面特点</span>

<span class="hljs-bullet">1.</span> <span class="hljs-strong">**完整的商城布局**</span>
<span class="hljs-bullet">   -</span> 顶部导航栏（含logo、搜索框、用户功能）
<span class="hljs-bullet">   -</span> 分类导航菜单
<span class="hljs-bullet">   -</span> 商品筛选栏
<span class="hljs-bullet">   -</span> 响应式商品列表
<span class="hljs-bullet">   -</span> 页脚信息

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**丰富的功能**</span>
<span class="hljs-bullet">   -</span> 商品搜索功能
<span class="hljs-bullet">   -</span> 分类筛选功能
<span class="hljs-bullet">   -</span> 排序功能
<span class="hljs-bullet">   -</span> 商品卡片悬停效果
<span class="hljs-bullet">   -</span> 返回顶部按钮
<span class="hljs-bullet">   -</span> 移动端适配（汉堡菜单）

<span class="hljs-bullet">3.</span> <span class="hljs-strong">**美观的设计**</span>
<span class="hljs-bullet">   -</span> 现代化的UI设计
<span class="hljs-bullet">   -</span> 清晰的商品信息展示（图片、标题、价格、销量、店铺）
<span class="hljs-bullet">   -</span> 商品标签（热卖、新品、优惠）
<span class="hljs-bullet">   -</span> 响应式布局，适配各种设备尺寸

<span class="hljs-bullet">4.</span> <span class="hljs-strong">**技术实现**</span>
<span class="hljs-bullet">   -</span> 使用HTML、CSS、JavaScript开发
<span class="hljs-bullet">   -</span> 响应式设计，适配移动端、平板和桌面端
<span class="hljs-bullet">   -</span> 动态生成商品列表
<span class="hljs-bullet">   -</span> 流畅的交互效果

<span class="hljs-section">## 文件修改</span>

<span class="hljs-bullet">-</span> 更新了<span class="hljs-code">`index.html`</span>文件，将页面标题从“京东商品列表”改为“V哥商城”

<span class="hljs-section">## 访问地址</span>

页面已通过本地HTTP服务器启动，您可以通过以下地址访问：
http://localhost:8000

页面已经完全可用，包含了商城商品列表的所有基本功能和美观的设计。
</code></pre>
<p>搞定！</p>
<p>我们来看一下生成的代码，一共是3个文件：</p>
<ol>
<li>index.html页面</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>V哥商城<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"style.css"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 顶部导航栏 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header-top"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-shopping-cart"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>V 哥商城<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"search-box"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"搜索商品"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-search"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"user-info"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-user"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 登录<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-heart"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 收藏<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-shopping-bag"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 购物车<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-comment">&lt;!-- 汉堡菜单按钮 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"hamburger-menu"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-bars"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header-nav"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"active"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>手机<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>电脑<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>家电<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>服装<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>美妆<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>食品<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>运动<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 主体内容 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 筛选栏 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"filter-bar"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"filter-item"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"filter-label"</span>&gt;</span>分类：<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"filter-link active"</span>&gt;</span>全部<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"filter-link"</span>&gt;</span>手机<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"filter-link"</span>&gt;</span>电脑<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"filter-link"</span>&gt;</span>平板<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"filter-item"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"filter-label"</span>&gt;</span>排序：<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"filter-link active"</span>&gt;</span>综合<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"filter-link"</span>&gt;</span>销量<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"filter-link"</span>&gt;</span>价格<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"filter-link"</span>&gt;</span>评价<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

            <span class="hljs-comment">&lt;!-- 商品列表 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"product-list"</span>&gt;</span>
                <span class="hljs-comment">&lt;!-- 商品项将通过JavaScript动态生成 --&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 返回顶部按钮 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"back-to-top"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"backToTop"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-arrow-up"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 底部 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">footer</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"footer"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-symbol">&amp;copy;</span> 2024 V 哥商城 版权所有<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"script.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<ol start="2">
<li>style.css 样式表</li>
</ol>
<pre><code class="hljs language-css" lang="css">* {
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">box-sizing</span>: border-box;
}

<span class="hljs-selector-tag">body</span> {
    <span class="hljs-attribute">font-family</span>: -apple-system, BlinkMacSystemFont, <span class="hljs-string">'Segoe UI'</span>, Roboto, <span class="hljs-string">'Helvetica Neue'</span>, Arial, sans-serif;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;
}

<span class="hljs-selector-class">.container</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">1200px</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
}

<span class="hljs-comment">/* 顶部导航栏 */</span>
<span class="hljs-selector-class">.header</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">8px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
    <span class="hljs-attribute">position</span>: sticky;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">100</span>;
}

<span class="hljs-selector-class">.header-top</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-number">80px</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">justify-content</span>: space-between;
}

<span class="hljs-selector-class">.logo</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">24px</span>;
    <span class="hljs-attribute">font-weight</span>: bold;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#e1251b</span>;
}

<span class="hljs-selector-class">.logo</span> <span class="hljs-selector-tag">i</span> {
    <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">10px</span>;
}

<span class="hljs-selector-class">.search-box</span> {
    <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">max-width</span>: <span class="hljs-number">500px</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">50px</span>;
    <span class="hljs-attribute">display</span>: flex;
}

<span class="hljs-selector-class">.search-box</span> <span class="hljs-selector-tag">input</span> {
    <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">15px</span>;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#e1251b</span>;
    <span class="hljs-attribute">border-right</span>: none;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">20px</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    <span class="hljs-attribute">outline</span>: none;
}

<span class="hljs-selector-class">.search-box</span> <span class="hljs-selector-tag">button</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">60px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e1251b</span>;
    <span class="hljs-attribute">border</span>: none;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-number">20px</span> <span class="hljs-number">0</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">cursor</span>: pointer;
    <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">0.3s</span>;
}

<span class="hljs-selector-class">.search-box</span> <span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#c81623</span>;
}

<span class="hljs-selector-class">.user-info</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-selector-class">.user-info</span> <span class="hljs-selector-tag">a</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
    <span class="hljs-attribute">text-decoration</span>: none;
    <span class="hljs-attribute">transition</span>: color <span class="hljs-number">0.3s</span>;
}

<span class="hljs-selector-class">.user-info</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#e1251b</span>;
}

<span class="hljs-selector-class">.user-info</span> <span class="hljs-selector-tag">i</span> {
    <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">5px</span>;
}

<span class="hljs-comment">/* 汉堡菜单 */</span>
<span class="hljs-selector-class">.hamburger-menu</span> {
    <span class="hljs-attribute">display</span>: none;
    <span class="hljs-attribute">background</span>: none;
    <span class="hljs-attribute">border</span>: none;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#e1251b</span>;
    <span class="hljs-attribute">cursor</span>: pointer;
}

<span class="hljs-selector-class">.header-nav</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e1251b</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
    <span class="hljs-attribute">transition</span>: max-height <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-selector-class">.header-nav</span> <span class="hljs-selector-tag">ul</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">list-style</span>: none;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
}

<span class="hljs-selector-class">.header-nav</span> <span class="hljs-selector-tag">li</span> {
    <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">30px</span>;
}

<span class="hljs-selector-class">.header-nav</span> <span class="hljs-selector-tag">a</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">text-decoration</span>: none;
    <span class="hljs-attribute">font-weight</span>: bold;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span>;
    <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">0.3s</span>;
}

<span class="hljs-selector-class">.header-nav</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span>,
<span class="hljs-selector-class">.header-nav</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.active</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#c81623</span>;
}

<span class="hljs-comment">/* 主体内容 */</span>
<span class="hljs-selector-class">.main</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">/* 筛选栏 */</span>
<span class="hljs-selector-class">.filter-bar</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">gap</span>: <span class="hljs-number">40px</span>;
}

<span class="hljs-selector-class">.filter-item</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">flex-wrap</span>: wrap;
    <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;
}

<span class="hljs-selector-class">.filter-label</span> {
    <span class="hljs-attribute">font-weight</span>: bold;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;
    <span class="hljs-attribute">white-space</span>: nowrap;
}

<span class="hljs-selector-class">.filter-link</span> {
    <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">10px</span>;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">5px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
    <span class="hljs-attribute">text-decoration</span>: none;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">5px</span> <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">15px</span>;
    <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">13px</span>;
}

<span class="hljs-selector-class">.filter-link</span><span class="hljs-selector-pseudo">:hover</span>,
<span class="hljs-selector-class">.filter-link</span><span class="hljs-selector-class">.active</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e1251b</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
}

<span class="hljs-comment">/* 商品列表 */</span>
<span class="hljs-selector-class">.product-list</span> {
    <span class="hljs-attribute">display</span>: grid;
    <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">5</span>, <span class="hljs-number">1</span>fr);
    <span class="hljs-attribute">gap</span>: <span class="hljs-number">15px</span>;
}

<span class="hljs-selector-class">.product-item</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">8px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
    <span class="hljs-attribute">overflow</span>: hidden;
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span>, box-shadow <span class="hljs-number">0.3s</span>;
    <span class="hljs-attribute">cursor</span>: pointer;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
}

<span class="hljs-selector-class">.product-item</span><span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">5px</span>);
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-number">15px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>);
}

<span class="hljs-selector-class">.product-image</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    aspect-ratio: <span class="hljs-number">1</span> / <span class="hljs-number">1</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">justify-content</span>: center;
}

<span class="hljs-selector-class">.product-image</span> <span class="hljs-selector-tag">img</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">object-fit</span>: contain;
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;
}

<span class="hljs-selector-class">.product-item</span><span class="hljs-selector-pseudo">:hover</span> <span class="hljs-selector-class">.product-image</span> <span class="hljs-selector-tag">img</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.05</span>);
}

<span class="hljs-selector-class">.product-info</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
}

<span class="hljs-selector-class">.product-title</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.4</span>;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">8px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
    <span class="hljs-attribute">text-overflow</span>: ellipsis;
    <span class="hljs-attribute">display</span>: -webkit-box;
    -webkit-line-clamp: <span class="hljs-number">2</span>;
    -webkit-box-orient: vertical;
    <span class="hljs-attribute">flex-shrink</span>: <span class="hljs-number">0</span>;
}

<span class="hljs-selector-class">.product-price</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">font-weight</span>: bold;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#e1251b</span>;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">8px</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: baseline;
    <span class="hljs-attribute">gap</span>: <span class="hljs-number">6px</span>;
}

<span class="hljs-selector-class">.product-price</span> <span class="hljs-selector-class">.original-price</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#999</span>;
    <span class="hljs-attribute">text-decoration</span>: line-through;
    <span class="hljs-attribute">font-weight</span>: normal;
}

<span class="hljs-selector-class">.product-sales</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">justify-content</span>: space-between;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#999</span>;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.sales-count</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">gap</span>: <span class="hljs-number">4px</span>;
}

<span class="hljs-selector-class">.sales-count</span> <span class="hljs-selector-tag">i</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#e1251b</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">11px</span>;
}

<span class="hljs-selector-class">.shop-name</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;
    <span class="hljs-attribute">text-decoration</span>: none;
    <span class="hljs-attribute">transition</span>: color <span class="hljs-number">0.3s</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
}

<span class="hljs-selector-class">.shop-name</span><span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#e1251b</span>;
}

<span class="hljs-selector-class">.product-tags</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-wrap</span>: wrap;
    <span class="hljs-attribute">gap</span>: <span class="hljs-number">5px</span>;
    <span class="hljs-attribute">margin-top</span>: auto;
}

<span class="hljs-selector-class">.tag</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">3px</span> <span class="hljs-number">8px</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">10px</span>;
    <span class="hljs-attribute">font-weight</span>: bold;
}

<span class="hljs-selector-class">.tag-hot</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff1f0</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#e1251b</span>;
}

<span class="hljs-selector-class">.tag-new</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f6ffed</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#52c41a</span>;
}

<span class="hljs-selector-class">.tag-discount</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff7e6</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#faad14</span>;
}

<span class="hljs-comment">/* 返回顶部按钮 */</span>
<span class="hljs-selector-class">.back-to-top</span> {
    <span class="hljs-attribute">position</span>: fixed;
    <span class="hljs-attribute">bottom</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">right</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">45px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">45px</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e1251b</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">border</span>: none;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>;
    <span class="hljs-attribute">cursor</span>: pointer;
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">10px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>);
    <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">visibility</span>: hidden;
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">99</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">justify-content</span>: center;
}

<span class="hljs-selector-class">.back-to-top</span><span class="hljs-selector-class">.visible</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">visibility</span>: visible;
}

<span class="hljs-selector-class">.back-to-top</span><span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#c81623</span>;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">3px</span>);
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">15px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>);
}

<span class="hljs-comment">/* 触摸反馈效果 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
    <span class="hljs-selector-class">.product-item</span>,
    <span class="hljs-selector-class">.filter-link</span>,
    <span class="hljs-selector-class">.search-box</span> <span class="hljs-selector-tag">button</span>,
    <span class="hljs-selector-class">.hamburger-menu</span> {
        -webkit-tap-highlight-<span class="hljs-attribute">color</span>: transparent;
    }
    
    <span class="hljs-selector-class">.product-item</span><span class="hljs-selector-pseudo">:active</span> {
        <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">0.98</span>);
    }
    
    <span class="hljs-selector-class">.filter-link</span><span class="hljs-selector-pseudo">:active</span> {
        <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">0.95</span>);
    }
}

<span class="hljs-comment">/* 底部 */</span>
<span class="hljs-selector-class">.footer</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span> <span class="hljs-number">0</span>;
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#999</span>;
    <span class="hljs-attribute">border-top</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e5e5e5</span>;
    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">40px</span>;
}

<span class="hljs-comment">/* 响应式设计 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">1200px</span>) {
    <span class="hljs-selector-class">.container</span> {
        <span class="hljs-attribute">width</span>: <span class="hljs-number">95%</span>;
    }
    
    <span class="hljs-selector-class">.product-list</span> {
        <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>fr);
    }
}

<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">992px</span>) {
    <span class="hljs-selector-class">.product-list</span> {
        <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>fr);
    }
    
    <span class="hljs-selector-class">.search-box</span> {
        <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span>;
    }
}

<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
    <span class="hljs-selector-class">.header-top</span> {
        <span class="hljs-attribute">flex-direction</span>: row;
        <span class="hljs-attribute">height</span>: <span class="hljs-number">60px</span>;
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">15px</span>;
        <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;
    }
    
    <span class="hljs-selector-class">.logo</span> {
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>;
    }
    
    <span class="hljs-selector-class">.search-box</span> {
        <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
        <span class="hljs-attribute">max-width</span>: none;
        <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span>;
    }
    
    <span class="hljs-selector-class">.search-box</span> <span class="hljs-selector-tag">input</span> {
        <span class="hljs-attribute">height</span>: <span class="hljs-number">35px</span>;
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">13px</span>;
    }
    
    <span class="hljs-selector-class">.search-box</span> <span class="hljs-selector-tag">button</span> {
        <span class="hljs-attribute">width</span>: <span class="hljs-number">50px</span>;
        <span class="hljs-attribute">height</span>: <span class="hljs-number">35px</span>;
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    }
    
    <span class="hljs-selector-class">.user-info</span> {
        <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;
    }
    
    <span class="hljs-selector-class">.user-info</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">span</span> {
        <span class="hljs-attribute">display</span>: none;
    }
    
    <span class="hljs-comment">/* 显示汉堡菜单 */</span>
    <span class="hljs-selector-class">.hamburger-menu</span> {
        <span class="hljs-attribute">display</span>: block;
    }
    
    <span class="hljs-comment">/* 隐藏桌面导航 */</span>
    <span class="hljs-selector-class">.header-nav</span> {
        <span class="hljs-attribute">height</span>: auto;
        <span class="hljs-attribute">max-height</span>: <span class="hljs-number">0</span>;
        <span class="hljs-attribute">overflow</span>: hidden;
    }
    
    <span class="hljs-selector-class">.header-nav</span><span class="hljs-selector-class">.active</span> {
        <span class="hljs-attribute">max-height</span>: <span class="hljs-number">300px</span>;
    }
    
    <span class="hljs-selector-class">.header-nav</span> <span class="hljs-selector-tag">ul</span> {
        <span class="hljs-attribute">flex-direction</span>: column;
        <span class="hljs-attribute">overflow-x</span>: visible;
        <span class="hljs-attribute">white-space</span>: normal;
    }
    
    <span class="hljs-selector-class">.header-nav</span> <span class="hljs-selector-tag">li</span> {
        <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">0</span>;
        <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">1px</span>;
    }
    
    <span class="hljs-selector-class">.header-nav</span> <span class="hljs-selector-tag">a</span> {
        <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
        <span class="hljs-attribute">padding-left</span>: <span class="hljs-number">20px</span>;
    }
    
    <span class="hljs-selector-class">.filter-bar</span> {
        <span class="hljs-attribute">flex-direction</span>: column;
        <span class="hljs-attribute">gap</span>: <span class="hljs-number">15px</span>;
        <span class="hljs-attribute">align-items</span>: flex-start;
    }
    
    <span class="hljs-selector-class">.product-list</span> {
        <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>fr);
    }
}

<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">480px</span>) {
    <span class="hljs-selector-class">.product-list</span> {
        <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr;
    }
}
</code></pre>
<ol start="3">
<li>script.js文件</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟商品数据</span>
<span class="hljs-keyword">const</span> products = [
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'Apple iPhone 15 Pro Max (A3104) 256GB 原色钛金属 支持移动联通电信5G 双卡双待手机'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">9999</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">10999</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">12580</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'Apple官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%23FF6B6B%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22white%22%3EiPhone 15%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'hot'</span>, <span class="hljs-string">'discount'</span>]
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'华为 Mate 60 Pro 麒麟9000S 5G手机 12GB+512GB 雅川青 昆仑玻璃 超可靠玄武架构 卫星通话'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">7999</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">8999</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">8920</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'华为官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%234ECDC4%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22white%22%3EMate 60%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'new'</span>, <span class="hljs-string">'hot'</span>]
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'小米14 Pro 徕卡光学Summilux镜头 第二代骁龙8 领先版 2K LTPO屏幕 12GB+256GB 钛合金版'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">4999</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">5499</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">15600</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'小米官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%2345B7D1%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22white%22%3EXiaomi 14%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'hot'</span>, <span class="hljs-string">'discount'</span>]
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">4</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'OPPO Find X7 Ultra 1英寸哈苏影像 第二代骁龙8 2K 120Hz 东方屏 16GB+512GB 大漠银月'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">5999</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">6499</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">6780</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'OPPO官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%2396CEB4%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22white%22%3EFind X7%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'new'</span>]
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">5</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'vivo X100 Pro 天玑9300 5G手机 120W闪充 蔡司四摄 12GB+256GB 华夏红 曲面屏'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">4999</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">5499</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">7890</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'vivo官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%23FFEAA7%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22black%22%3Evivo X100%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'new'</span>, <span class="hljs-string">'hot'</span>]
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">6</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'三星 Galaxy S24 Ultra 5G手机 12GB+256GB 钛灰 骁龙8 Gen3 智能S Pen 2亿像素主摄'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">8999</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">9999</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">4560</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'三星官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%23DDA0DD%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22white%22%3EGalaxy S24%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'hot'</span>]
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">7</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'荣耀Magic6 Pro 第二代骁龙8旗舰芯片 AI大模型手机 16GB+512GB 燃橙色'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">5699</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">6199</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">5670</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'荣耀官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%2398D8C8%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22white%22%3EMagic6%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'new'</span>]
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">8</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'一加 Ace 3 Pro 第二代骁龙8 24GB+1TB 150W超级闪充 120Hz电竞直屏 5G游戏手机'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">3999</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">4499</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">9120</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'一加官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%23F7DC6F%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22black%22%3EOnePlus Ace3%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'discount'</span>]
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">9</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'realme 真我GT5 Pro 第二代骁龙8 24GB+1TB 240W满级秒充 2K直屏 5G游戏手机'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">3899</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">4299</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">6780</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'realme官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%23BB8FCE%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22white%22%3EGT5 Pro%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'discount'</span>, <span class="hljs-string">'hot'</span>]
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'Redmi K70 Pro 第二代骁龙8 至尊版 2K 120Hz 中国屏 16GB+512GB 墨羽 5G智能手机'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">3699</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">3999</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">11230</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'Redmi官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%2385C1E9%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22white%22%3EK70 Pro%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'hot'</span>]
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">11</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'索尼（SONY）Xperia 1 V 5G智能手机 4K HDR OLED 专业影像 12GB+256GB 黑色'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">8499</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">9499</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">2340</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'索尼官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%23F8C471%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22black%22%3EXperia 1V%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'new'</span>]
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">12</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'魅族 21 骁龙8 Gen3 无界全面屏 5000mAh电池 12GB+256GB 独白 5G手机'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">3399</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">3799</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">4560</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'魅族官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%2382E0AA%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22white%22%3E魅族21%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'discount'</span>]
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">13</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'努比亚 Z60 Ultra 骁龙8 Gen3 35mm+85mm黄金双焦段 16GB+512GB 黑礁 5G手机'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">4999</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">5499</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">3450</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'努比亚官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%23F1948A%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22white%22%3EZ60 Ultra%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'new'</span>]
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">14</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'摩托罗拉 moto edge X50 Pro 骁龙8 Gen3 2K 165Hz 曲屏 12GB+256GB 墨韵黑 5G手机'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">3999</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">4399</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">2890</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'摩托罗拉官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%23D2B4DE%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22white%22%3EEdge X50%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'discount'</span>]
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">15</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'iQOO 12 Pro 第二代骁龙8 2K 144Hz E7屏 200W闪充 16GB+512GB 赛道版 5G游戏手机'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">4999</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">5499</span>,
        <span class="hljs-attr">sales</span>: <span class="hljs-number">5670</span>,
        <span class="hljs-attr">shopName</span>: <span class="hljs-string">'iQOO官方旗舰店'</span>,
        <span class="hljs-attr">image</span>: <span class="hljs-string">'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%23AED6F1%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22white%22%3EiQOO 12%3C/text%3E%3C/svg%3E'</span>,
        <span class="hljs-attr">tags</span>: [<span class="hljs-string">'hot'</span>]
    }
];

<span class="hljs-comment">// DOM加载完成后执行</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">renderProducts</span>(products);
    <span class="hljs-title function_">initEventListeners</span>();
});

<span class="hljs-comment">// 渲染商品列表</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderProducts</span>(<span class="hljs-params">products</span>) {
    <span class="hljs-keyword">const</span> productList = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.product-list'</span>);
    productList.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
    
    products.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> productItem = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
        productItem.<span class="hljs-property">className</span> = <span class="hljs-string">'product-item'</span>;
        
        <span class="hljs-comment">// 生成标签HTML</span>
        <span class="hljs-keyword">const</span> tagsHtml = product.<span class="hljs-property">tags</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">tag</span> =&gt;</span> {
            <span class="hljs-keyword">let</span> tagClass = <span class="hljs-string">''</span>;
            <span class="hljs-keyword">switch</span>(tag) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">'hot'</span>:
                    tagClass = <span class="hljs-string">'tag-hot'</span>;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'new'</span>:
                    tagClass = <span class="hljs-string">'tag-new'</span>;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'discount'</span>:
                    tagClass = <span class="hljs-string">'tag-discount'</span>;
                    <span class="hljs-keyword">break</span>;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;span class="tag <span class="hljs-subst">${tagClass}</span>"&gt;<span class="hljs-subst">${tag === <span class="hljs-string">'hot'</span> ? <span class="hljs-string">'热卖'</span> : tag === <span class="hljs-string">'new'</span> ? <span class="hljs-string">'新品'</span> : <span class="hljs-string">'优惠'</span>}</span>&lt;/span&gt;`</span>;
        }).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
        
        productItem.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
            &lt;div class="product-image"&gt;
                &lt;img src="<span class="hljs-subst">${product.image}</span>" alt="<span class="hljs-subst">${product.title}</span>"&gt;
            &lt;/div&gt;
            &lt;div class="product-info"&gt;
                &lt;h3 class="product-title"&gt;<span class="hljs-subst">${product.title}</span>&lt;/h3&gt;
                &lt;div class="product-price"&gt;
                    ￥<span class="hljs-subst">${product.price.toFixed(<span class="hljs-number">2</span>)}</span>
                    &lt;span class="original-price"&gt;￥<span class="hljs-subst">${product.originalPrice.toFixed(<span class="hljs-number">2</span>)}</span>&lt;/span&gt;
                &lt;/div&gt;
                &lt;div class="product-sales"&gt;
                    &lt;div class="sales-count"&gt;
                        &lt;i class="fas fa-fire"&gt;&lt;/i&gt;
                        已售<span class="hljs-subst">${product.sales.toLocaleString()}</span>
                    &lt;/div&gt;
                    &lt;a href="#" class="shop-name"&gt;<span class="hljs-subst">${product.shopName}</span>&lt;/a&gt;
                &lt;/div&gt;
                &lt;div class="product-tags"&gt;
                    <span class="hljs-subst">${tagsHtml}</span>
                &lt;/div&gt;
            &lt;/div&gt;
        `</span>;
        
        <span class="hljs-comment">// 添加商品点击事件</span>
        productItem.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-comment">// 这里可以添加商品详情页跳转逻辑</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'商品被点击:'</span>, product.<span class="hljs-property">id</span>);
        });
        
        productList.<span class="hljs-title function_">appendChild</span>(productItem);
    });
}

<span class="hljs-comment">// 初始化事件监听器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initEventListeners</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 汉堡菜单交互</span>
    <span class="hljs-keyword">const</span> hamburgerMenu = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hamburger-menu'</span>);
    <span class="hljs-keyword">const</span> headerNav = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.header-nav'</span>);
    
    hamburgerMenu.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        headerNav.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">'active'</span>);
    });
    
    <span class="hljs-comment">// 筛选链接点击事件</span>
    <span class="hljs-keyword">const</span> filterLinks = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.filter-link'</span>);
    filterLinks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">link</span> =&gt;</span> {
        link.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
            e.<span class="hljs-title function_">preventDefault</span>();
            
            <span class="hljs-comment">// 移除同组其他链接的active类</span>
            <span class="hljs-keyword">const</span> parent = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">closest</span>(<span class="hljs-string">'.filter-item'</span>);
            parent.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.filter-link'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">l</span> =&gt;</span> {
                l.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'active'</span>);
            });
            
            <span class="hljs-comment">// 添加当前链接的active类</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'active'</span>);
            
            <span class="hljs-comment">// 这里可以添加筛选逻辑</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'筛选:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">textContent</span>);
        });
    });
    
    <span class="hljs-comment">// 导航链接点击事件</span>
    <span class="hljs-keyword">const</span> navLinks = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.header-nav a'</span>);
    navLinks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">link</span> =&gt;</span> {
        link.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
            e.<span class="hljs-title function_">preventDefault</span>();
            
            <span class="hljs-comment">// 移除其他链接的active类</span>
            navLinks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">l</span> =&gt;</span> {
                l.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'active'</span>);
            });
            
            <span class="hljs-comment">// 添加当前链接的active类</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'active'</span>);
            
            <span class="hljs-comment">// 在移动端点击导航后关闭菜单</span>
            headerNav.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'active'</span>);
            
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'导航到:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">textContent</span>);
        });
    });
    
    <span class="hljs-comment">// 搜索功能</span>
    <span class="hljs-keyword">const</span> searchBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.search-box button'</span>);
    <span class="hljs-keyword">const</span> searchInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.search-box input'</span>);
    
    searchBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> keyword = searchInput.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
        <span class="hljs-keyword">if</span> (keyword) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'搜索:'</span>, keyword);
            <span class="hljs-comment">// 这里可以添加搜索逻辑</span>
            <span class="hljs-keyword">const</span> filteredProducts = products.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> 
                product.<span class="hljs-property">title</span>.<span class="hljs-title function_">includes</span>(keyword)
            );
            <span class="hljs-title function_">renderProducts</span>(filteredProducts);
        }
    });
    
    <span class="hljs-comment">// 回车键搜索</span>
    searchInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keypress'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
        <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span>) {
            searchBtn.<span class="hljs-title function_">click</span>();
        }
    });
    
    <span class="hljs-comment">// 返回顶部按钮功能</span>
    <span class="hljs-keyword">const</span> backToTopBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'backToTop'</span>);
    
    <span class="hljs-comment">// 滚动检测</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">pageYOffset</span> &gt; <span class="hljs-number">300</span>) {
            backToTopBtn.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'visible'</span>);
        } <span class="hljs-keyword">else</span> {
            backToTopBtn.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'visible'</span>);
        }
    });
    
    <span class="hljs-comment">// 点击返回顶部</span>
    backToTopBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>({
            <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span>
        });
    });
    

}

<span class="hljs-comment">// 格式化价格</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">formatPrice</span>(<span class="hljs-params">price</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'￥'</span> + price.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
}

<span class="hljs-comment">// 格式化销量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">formatSales</span>(<span class="hljs-params">sales</span>) {
    <span class="hljs-keyword">if</span> (sales &gt;= <span class="hljs-number">10000</span>) {
        <span class="hljs-keyword">return</span> (sales / <span class="hljs-number">10000</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">1</span>) + <span class="hljs-string">'万'</span>;
    }
    <span class="hljs-keyword">return</span> sales.<span class="hljs-title function_">toLocaleString</span>();
}
</code></pre>
<p>我们可以看到，图片的位置是用 svg 色块绘制出来的，我们可以很方便的替换成自己想要的图片素材。</p>
<p>生成完成后，我们来看一下最终的页面效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac970f94f8fa4800a6aef1153aefb2ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765897310&amp;x-signature=MIGXW9QPzpDu37cuPAtsHFGDn9Y%3D" alt="image.png" loading="lazy"/>
页面里自动有了一些简单的交互效果，太棒了！看到这里，你是不是也跟 V 哥一样有相同的想法，我 TMD 再也不用前端给我画页面，后端的小伙伴可以直接把前端开发的活给包了，^_^，这里，有前端的小伙伴一定不服，“想要挤掉我们前端的工作，没门！”，说实话，如果你只会前端，那你的工作真的会被 AI 所取代，AI 时代，让程序员们都成为了全栈开发，如果你是前端，可要抓紧学习后端开发了，要不然真的危险了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[掌握原型链，写出不翻车的 JS 继承]]></title>    <link>https://juejin.cn/post/7581664445241524239</link>    <guid>https://juejin.cn/post/7581664445241524239</guid>    <pubDate>2025-12-09T13:16:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581664445241524239" data-draft-id="7581670270844665896" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="掌握原型链，写出不翻车的 JS 继承"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-09T13:16:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="谎言西西里"/> <meta itemprop="url" content="https://juejin.cn/user/332466136029851"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            掌握原型链，写出不翻车的 JS 继承
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/332466136029851/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    谎言西西里
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T13:16:49.000Z" title="Tue Dec 09 2025 13:16:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><h2 data-id="heading-0">原型与原型链基础</h2>
<p>在学习之前需要回顾一下这些基础知识</p>
<ul>
<li><strong><code>prototype</code></strong> 是<strong>所有函数</strong>都包含的一个属性（对象），而对于内置构造函数通常在上面预定义了部分方法，例如：<code>.push</code>、<code>.toString</code>等。</li>
<li><strong><code>__proto__</code></strong> 是<strong>所有 JS 对象</strong>都有的一个内部属性，指向该对象的原型对象（即父对象的prototype）。</li>
<li><strong><code>constructor</code></strong> <strong>每个 <code>prototype</code> 对象</strong>都有一个默认的 <code>constructor</code> 属性，指回其构造函数。</li>
</ul>
<p>不妨来看个例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 构造函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
} 

<span class="hljs-keyword">const</span> alice = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'Alice'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(alice.<span class="hljs-property">__proto__</span>) <span class="hljs-comment">// Person.prototype</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span>) <span class="hljs-comment">// Person</span>
</code></pre>
<p>而它的原型链就是：</p>
<pre><code class="hljs language-bash" lang="bash">// --&gt; 代表.__proto__属性
alice --&gt; Person.prototype --&gt; Object.prototype --&gt; null（所有原型链的终点都是 null）
</code></pre>
<h2 data-id="heading-1">四种原型继承方式详解</h2>
<h3 data-id="heading-2">1. 直接赋值父类原型（不推荐）</h3>
<p>先来看一个例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父类构造函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}
<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">species</span> = <span class="hljs-string">"动物"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params">color, name, age</span>) {
    <span class="hljs-comment">// 继承父类的属性</span>
    <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, [name, age]);
    <span class="hljs-comment">// 使用 .call 也可以</span>
    <span class="hljs-comment">// Animal.call(this, name, age);</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
}
        
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>; <span class="hljs-comment">// 指向父类原型</span>
</code></pre>
<blockquote>
<p>补充一下 <code>call</code> 和 <code>apply</code> 的区别：</p>
<ul>
<li><code>call</code> 是 <strong>逐个传参</strong>，即：<code>fn.call(this, arg1, arg2, ...)</code></li>
<li><code>apply</code> 是 <strong>数组传参</strong>，即：<code>fn.apply(this, [arg1, arg2, ...])</code></li>
</ul>
</blockquote>
<p>这样做下来感觉并没有什么不合适，继承了父类的属性，同时也指向了父类的原型对象。但是这样并不完整，因为如果调用子类的<code>prototype</code>上的<code>constructor</code>属性，正确的继承应该是指向子类自身。</p>
<p>而当我们在代码中执行<code>console.log(Cat.prototype.constructor)</code>最后得到的结果却是 <code>Animal</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc0137010d1541eb9a48b216f2d4aba7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCO6KiA6KW_6KW_6YeM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765891009&amp;x-signature=qsZI2cQm%2BcPZPrhlcTexOBIAIuA%3D" alt="image.png" loading="lazy"/></p>
<p>所以在最后还需要<strong>手动修复构造函数指向</strong>，即添加：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Cat</span>;
</code></pre>
<p>但是这样做并非万无一失，在这里我们需要了解 JS 的一个特性，那就是 <strong>引用式赋值</strong> 。在 JS 中，基本数据类型（8种）是<strong>按值赋值</strong>的，而对象类型是<strong>按引用赋值</strong>的</p>
<p><strong>引用式赋值</strong>：指当我将一个对象赋值给另一个变量时，并不是复制了这个对象本身，而是复制了对象在内存中的地址引用，这样就导致两个变量都指向同一个内存位置，不论修改哪个都会对另一个造成影响。</p>
<p>举个最简单的例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> obj1 = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span> };
<span class="hljs-keyword">let</span> obj2 = obj1;      <span class="hljs-comment">// 引用式赋值</span>
obj2.<span class="hljs-property">name</span> = <span class="hljs-string">'Bob'</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj1.<span class="hljs-property">name</span>); <span class="hljs-comment">// "Bob"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj1 === obj2); <span class="hljs-comment">// true（指向同一对象）</span>
</code></pre>
<p>回到我们的继承函数，里面就有一个是引用式赋值</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
</code></pre>
<p>这就导致了当我们在<code>Cat.prototype</code>上添加方法还是什么的，会污染<code>Animal.prototype</code>，所以尽量别使用直接赋值父类原型</p>
<h3 data-id="heading-3">2. 原型链继承（有点缺点）</h3>
<p>我们将上面的例子拿下来</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}
<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">species</span> = <span class="hljs-string">"动物"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params">color, name, age</span>) {
    <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, [name, age]);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
}
</code></pre>
<p>但是我们这里使用原型链式继承</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>(); 
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Cat</span>; <span class="hljs-comment">// 修复构造函数指向     </span>
</code></pre>
<p>而这里需要了解一下 <code>new</code> 的伪代码了</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码 new Animal()</span>
<span class="hljs-keyword">let</span> obj = {};
<span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(obj); <span class="hljs-comment">// 也可以用 apply</span>
obj.<span class="hljs-property">__proto__</span> = <span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
<span class="hljs-keyword">return</span> obj
</code></pre>
<p>首先创建一个空对象，再将父类的<code>this</code>指向空对象，并将空对象的<code>__proto__</code>指向父类的<code>prototype</code>，也就是连上原型链，最后再返还这个空对象。</p>
<p>但是需要注意的是，这里后续创建的所有实例都是共享父类的属性的，在任意一个实例中对父类属性进行修改都会对其他实例造成影响，例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span> = [<span class="hljs-string">'red'</span>, <span class="hljs-string">'blue'</span>]; <span class="hljs-comment">// 引用类型属性</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params"/>) {}
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>(); <span class="hljs-comment">// 所有 Cat 实例共享 colors</span>
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Cat</span>;

<span class="hljs-keyword">const</span> cat1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();
<span class="hljs-keyword">const</span> cat2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();
cat1.<span class="hljs-property">colors</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'green'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat2.<span class="hljs-property">colors</span>); <span class="hljs-comment">// ['red', 'blue', 'green'] 共享引用</span>
</code></pre>
<h3 data-id="heading-4">3. 空对象中介模式（经典解决方案）</h3>
<p>在直接赋值中，不论怎样都会对父类造成影响，那么如果我们在 父类和子类 中间找一个中介来隔断，是不是就能解决这个问题，而这也是我们最经典的解决方法----空对象中介模式</p>
<p>依旧将前面的例子拿来：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}
<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">species</span> = <span class="hljs-string">"动物"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params">color, name, age</span>) {
    <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, [name, age]);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
}
</code></pre>
<p>不妨来看看中介模式是怎么使用的</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> F = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {}; <span class="hljs-comment">// 空对象中介</span>
F.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_">F</span>();
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Cat</span>;
</code></pre>
<p>其中我们将<code>F.prototype</code>直接继承<code>Animal.prototype</code>，虽然会导致 引用式赋值，但是只要我对<code>Cat.prototype</code>修改不对<code>F</code>造成影响，那么间接对<code>Animal</code>就没有影响。</p>
<p>而最精妙一点就是<code>Cat.prototype = new F();</code>这步，我们根据之前的伪代码可以知道，这步是将<code>Cat.prototype.__proto__ = F.prototype</code>，也就在变相变成<code>Cat.prototype.__proto__ = Animal.prototype</code></p>
<p>那么即使我们对<code>Cat.prototype</code>本身进行重新赋值，或者添加任何其他属性也不会影响<code>Cat.prototype.__proto__</code>，除非我们显示修改它（或者对修改<code>F.prototype</code>）</p>
<h4 data-id="heading-5">拓展：</h4>
<p>当然我们也可以将其写成继承函数（extend），这也算手写题吧 QwQ</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">extend</span>(<span class="hljs-params">Parent, Child</span>) {
    <span class="hljs-comment">// 中介函数</span>
    <span class="hljs-keyword">var</span> F = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {}; <span class="hljs-comment">// 函数表达式（有内存开销，但是因为是空函数问题不大）</span>
    <span class="hljs-comment">// 指向父类原型</span>
    F.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
    <span class="hljs-comment">// 指向空对象实例</span>
    <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_">F</span>(); <span class="hljs-comment">// 实例的修改不会影响原型对象</span>
    <span class="hljs-comment">// 修复构造函数指向</span>
    <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Child</span>; 
}

<span class="hljs-title function_">extend</span>(<span class="hljs-title class_">Animal</span>, <span class="hljs-title class_">Cat</span>)
</code></pre>
<h3 data-id="heading-6">4. Object.create()（ES5 推荐方式）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Cat</span>;
</code></pre>
<p>以 <code>Animal.prototype</code> 为原型创建新对象，在不污染父类构造函数的前提下，更安全地建立子类到父类的原型链连接，并且更加适配现代继承写法。</p>
<h2 data-id="heading-7">总结</h2>






























<table><thead><tr><th>继承方式</th><th>是否推荐</th><th>说明</th></tr></thead><tbody><tr><td>直接赋值原型</td><td>❌</td><td>污染父类 constructor</td></tr><tr><td>原型链继承</td><td>❌</td><td>引用属性共享问题</td></tr><tr><td>中介函数</td><td>✅（兼容旧环境）</td><td>安全隔离</td></tr><tr><td><code>Object.create()</code></td><td>✅✅</td><td>现代标准，语义清晰</td></tr></tbody></table>
<h3 data-id="heading-8">最佳实践：</h3>
<ol>
<li><strong>属性继承</strong> → 用 <code>Parent.call(this, ...args)</code></li>
<li><strong>方法继承</strong> → 用 <code>Child.prototype = Object.create(Parent.prototype)</code></li>
<li><strong>修复 constructor</strong> → 显式设置 <code>Child.prototype.constructor = Child</code></li>
</ol>
<p>原型继承是 JS 的灵魂。理解 <code>call</code>/<code>apply</code> ，掌握 <code>Object.create</code> 如何安全构建原型链，了解其他构建方法有何不妥，为我们写出健壮的继承结构添一把力</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next AI Draw.io：当AI遇见Draw.io图表绘制]]></title>    <link>https://juejin.cn/post/7581693431739875391</link>    <guid>https://juejin.cn/post/7581693431739875391</guid>    <pubDate>2025-12-09T13:19:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581693431739875391" data-draft-id="7581678032336650282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next AI Draw.io：当AI遇见Draw.io图表绘制"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2025-12-09T13:19:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next AI Draw.io：当AI遇见Draw.io图表绘制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T13:19:58.000Z" title="Tue Dec 09 2025 13:19:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在AI技术重塑应用格局的时代，智能图表绘制工具正逐渐成为技术文档编写、系统设计与团队协作中不可或缺的利器。过去我常使用 draw.io 制作图表，而最近在 GitHub 上发现了一个为 draw.io 集成 AI 能力的项目——这无疑是为这款工具插上了智能的翅膀。今天，就让我们一起来了解这个令人期待的项目。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5344ca1344ed483486e6f11dd545ae9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765891198&amp;x-signature=Hq2ZFHad2lAP55%2BfjN8jf04c5ns%3D" alt="17153200_30108ea40e.png" loading="lazy"/></p>
<p>17153200_30108ea40e.png</p>
<h2 data-id="heading-0">🌟 项目简介</h2>
<p>在当今AI技术飞速发展的背景下，<strong>Next AI Draw.io</strong> 正是一款将人工智能与专业图表绘制完美融合的开源项目。这个基于Next.js的AI驱动图表创建工具，通过自然语言交互，让复杂的技术图表绘制变得前所未有的简单和高效。</p>
<p>想象一下，你只需说“给我画一个云原生微服务架构图”，AI就能在draw.io画布上为你生成专业的架构图表——这正是Next AI Draw.io带给我们的魔法体验。</p>
<p>当前项目在github上已有5.6k star</p>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDayuanJiang%2Fnext-ai-draw-io" target="_blank" title="https://github.com/DayuanJiang/next-ai-draw-io" ref="nofollow noopener noreferrer">github.com/DayuanJiang…</a></p>
<p>演示地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnext-ai-drawio.jiang.jp%2F" target="_blank" title="https://next-ai-drawio.jiang.jp/" ref="nofollow noopener noreferrer">next-ai-drawio.jiang.jp/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f0a01ae09b346a09db0e27a4662e00f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765891198&amp;x-signature=w9Dfq1R1TUXCEUmAqa9qlVvvifc%3D" alt="_20251209_190422.png" loading="lazy"/></p>
<p>_20251209_190422.png</p>
<h2 data-id="heading-1">✨ 核心特性</h2>
<h3 data-id="heading-2">🤖 AI驱动的智能图表创建</h3>
<ul>
<li><strong>自然语言生成图表</strong>：用对话的方式描述你的需求，AI自动生成相应的draw.io图表</li>
<li><strong>多云架构图支持</strong>：特别优化了AWS、GCP、Azure等云服务架构图的生成</li>
<li><strong>图像转图表功能</strong>：上传现有图表或截图，AI帮你自动复制和增强</li>
</ul>
<h3 data-id="heading-3">🎯 专业级图表功能</h3>
<ul>
<li><strong>动画连接器</strong>：在图表元素间创建动态的连接线，让数据流动和关系更直观</li>
<li><strong>完整的版本历史</strong>：每次AI修改都有记录，可以随时回退到之前的版本</li>
<li><strong>多提供商支持</strong>：兼容市面上主流的大语言模型服务</li>
</ul>
<h3 data-id="heading-4">🔧 开发者友好设计</h3>
<ul>
<li><strong>本地API密钥管理</strong>：你的API密钥只保存在浏览器本地，确保数据安全</li>
<li><strong>模块化架构</strong>：清晰的代码结构便于二次开发和定制</li>
<li><strong>完整的类型支持</strong>：基于TypeScript开发，提供优秀的开发体验</li>
</ul>
<h2 data-id="heading-5">🚀 快速部署指南</h2>
<h3 data-id="heading-6">Docker一键部署（推荐）</h3>
<p>对于想要快速体验的用户，Docker是最佳选择：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用OpenAI GPT-4o模型，如果使用代理地址，指定OPENAI_BASE_URL</span>
docker run -d -p 3000:3000 \
  -e <span class="hljs-attr">AI_PROVIDER</span>=openai \
  -e <span class="hljs-attr">AI_MODEL</span>=gpt-<span class="hljs-number">4</span>o \
  -e <span class="hljs-attr">OPENAI_API_KEY</span>=your_openai_key \
  -e <span class="hljs-attr">OPENAI_BASE_URL</span>=your_proxy_url \
  ghcr.io/dayuanjiang/next-ai-draw-io:latest
</code></pre>
<p>我本地使用的是docker-compose部署，一下是yml内容</p>
<pre><code class="hljs language-ini" lang="ini">services:
  next-ai-draw-io:
  <span class="hljs-comment"># 若官方镜像下载慢，可以使用博主转存的镜像 registry.cn-hangzhou.aliyuncs.com/xjpublic/next-ai-draw-io:latest</span>
    image: ghcr.io/dayuanjiang/next-ai-draw-io:latest 
    container_name: next-ai-draw-io
    restart: unless-stopped
    ports:
      - "3100:3000"
      <span class="hljs-comment"># 我使用的是kimi的模型，OPENAI_BASE_URL改为kimi的地址即可</span>
    environment:
      - <span class="hljs-attr">AI_PROVIDER</span>=openai
      - <span class="hljs-attr">AI_MODEL</span>=kimi-k2-turbo-preview
      - <span class="hljs-attr">OPENAI_BASE_URL</span>=https://api.moonshot.cn/v1
      - <span class="hljs-attr">OPENAI_API_KEY</span>=_API_KEY
</code></pre>
<p>若官方镜像下载慢，可以使用博主转存的镜像 <code>registry.cn-hangzhou.aliyuncs.com/xjpublic/next-ai-draw-io:latest</code></p>
<p>使用以下命令启动项目</p>
<pre><code class="hljs">docker-compose up -d 
</code></pre>
<p>访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Fip%3Aport" target="_blank" title="http://ip:port" ref="nofollow noopener noreferrer">http://ip:port</a> 即可使用</p>
<h2 data-id="heading-7">🎨 使用示例</h2>
<h3 data-id="heading-8">创建系统流程图</h3>
<pre><code class="hljs">提示词：设计一个用户登录系统的流程图，包含验证、session管理和错误处理
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e43165d4f62346dc8b1c1509c5eff3a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765891198&amp;x-signature=9828jyeu%2Fix3HPfjMjto8pB%2Fdmo%3D" alt="ScreenShot_2025-12-09_192048_443.png" loading="lazy"/></p>
<p>ScreenShot_2025-12-09_192048_443.png</p>
<h3 data-id="heading-9">绘制网络拓扑</h3>
<pre><code class="hljs">提示词：绘制一个企业级网络拓扑图，包含防火墙、交换机、路由器和服务器集群
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d6970a5eb9345c1b5f4a9ebf9e00e24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765891198&amp;x-signature=ZVGM4DtufbqHXOOM8FIIQztuqn8%3D" alt="ScreenShot_2025-12-09_192735_685.png" loading="lazy"/></p>
<p>ScreenShot_2025-12-09_192735_685.png</p>
<h3 data-id="heading-10">复制和优化现有图表</h3>
<p>上传现有的架构图或设计草图，AI会自动：</p>
<ol>
<li>识别图中的元素和结构</li>
<li>生成规范的draw.io图表</li>
<li>根据需求进行优化和增强</li>
</ol>
<h2 data-id="heading-11">🔌 支持的AI服务商</h2>
<p>Next AI Draw.io支持几乎所有的主流AI服务，让你的选择更加灵活：</p>








































<table><thead><tr><th>服务商</th><th>推荐模型</th><th>特点</th></tr></thead><tbody><tr><td>Anthropic</td><td>Claude 3.5 Sonnet</td><td>对AWS图表特别优化，逻辑推理能力强</td></tr><tr><td>OpenAI</td><td>GPT-4o, GPT-4 Turbo</td><td>通用性强，响应速度快</td></tr><tr><td>Google AI</td><td>Gemini 2.0</td><td>多模态能力强</td></tr><tr><td>DeepSeek</td><td>DeepSeek-R1</td><td>性价比高，中文支持好</td></tr><tr><td>Ollama</td><td>本地模型</td><td>数据安全，完全离线</td></tr><tr><td>Azure OpenAI</td><td>GPT-4</td><td>企业级合规需求</td></tr></tbody></table>
<p>如果你使用的模型不在支持列表中，则可以使用通用openai参照以下配置</p>
<pre><code class="hljs language-ini" lang="ini">- <span class="hljs-attr">AI_PROVIDER</span>=openai     <span class="hljs-comment"># 使用openai，几乎所有模型都兼容openai格式</span>
- <span class="hljs-attr">AI_MODEL</span>=kimi-k2-turbo-preview   <span class="hljs-comment"># 模型名称</span>
- <span class="hljs-attr">OPENAI_BASE_URL</span>=https://api.moonshot.cn/v1 <span class="hljs-comment"># 模型地址</span>
- <span class="hljs-attr">OPENAI_API_KEY</span>=_API_KEY <span class="hljs-comment"># api key</span>
</code></pre>
<h2 data-id="heading-12">💡 使用技巧</h2>
<h3 data-id="heading-13">1. 提供明确的需求</h3>
<p>越详细的描述，AI生成的图表越精准。包括：</p>
<ul>
<li>图表类型（架构图、流程图、时序图等）</li>
<li>使用的图标库（AWS、Azure、GCP或通用）</li>
<li>具体的组件和连接关系</li>
</ul>
<h3 data-id="heading-14">2. 利用版本历史</h3>
<p>每次AI修改都会创建新的版本，你可以：</p>
<ul>
<li>查看每次修改的具体内容</li>
<li>比较不同版本间的差异</li>
<li>随时回退到之前的版本</li>
</ul>
<h3 data-id="heading-15">3. 渐进式优化</h3>
<p>先让AI生成基础框架，然后通过对话逐步优化：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"添加监控告警组件"</span>
<span class="hljs-string">"将所有存储改为SSD"</span>
<span class="hljs-string">"增加灾备恢复流程"</span>
</code></pre>
<h2 data-id="heading-16">🛠️ 开发者进阶</h2>
<h3 data-id="heading-17">项目架构</h3>
<pre><code class="hljs language-bash" lang="bash">app/
├── api/chat/          <span class="hljs-comment"># AI聊天API端点</span>
├── page.tsx           <span class="hljs-comment"># 主页面</span>
components/
├── chat-panel.tsx     <span class="hljs-comment"># 聊天界面</span>
├── history-dialog.tsx <span class="hljs-comment"># 历史记录查看器</span>
lib/
├── ai-providers.ts    <span class="hljs-comment"># AI服务商配置</span>
└── utils.ts           <span class="hljs-comment"># 工具函数</span>
</code></pre>
<h3 data-id="heading-18">添加自定义功能</h3>
<p>如果你想扩展功能，可以：</p>
<ol>
<li>在<code>lib/ai-providers.ts</code>中添加新的AI服务商</li>
<li>修改<code>components/chat-panel.tsx</code>增强用户界面</li>
<li>扩展<code>app/api/chat/route.ts</code>中的AI工具集</li>
</ol>
<h2 data-id="heading-19">📊 性能优化建议</h2>
<h3 data-id="heading-20">模型选择策略</h3>
<ul>
<li><strong>复杂架构图</strong>：推荐使用Claude 3.5 Sonnet或GPT-4</li>
<li><strong>简单流程图</strong>：可以使用GPT-4o或DeepSeek-R1节省成本</li>
<li><strong>本地部署</strong>：考虑使用Ollama+本地模型保证数据安全</li>
</ul>
<h3 data-id="heading-21">成本控制</h3>
<ol>
<li>设置访问密码，防止未授权访问</li>
<li>对于团队使用，考虑配置使用限额</li>
<li>定期检查API使用情况，优化提示词</li>
</ol>
<h2 data-id="heading-22">🔮 未来展望</h2>
<p>随着AI技术的不断发展，Next AI Draw.io也在持续进化：</p>
<ul>
<li><strong>实时协作</strong>：多用户同时编辑和AI辅助</li>
<li><strong>模板库</strong>：预置行业标准图表模板</li>
<li><strong>智能分析</strong>：基于图表内容的智能建议</li>
<li><strong>插件生态</strong>：支持第三方扩展和集成</li>
</ul>
<h2 data-id="heading-23">🎯 结语</h2>
<p>在AI重塑应用的时代，Next AI Draw.io为我们展示了AI如何与传统工具结合，创造出1+1&gt;2的价值。无论你是系统架构师、技术文档工程师，还是项目经理，这个工具都能大幅提升你的工作效率。</p>
<p>通过简单的部署步骤，你就能拥有一个强大的AI图表助手。开源的力量让每个人都能享受到最前沿的技术红利。</p>
<h2 data-id="heading-24">✅ 附: draw-io部署</h2>
<p>docker-compose.yml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">draw:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">jgraph/drawio</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">draw</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">3000</span><span class="hljs-string">:8080</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手动实现 Spring Boot 日志链路追踪，无需引入组件，日志定位更方便！]]></title>    <link>https://juejin.cn/post/7581676787380060179</link>    <guid>https://juejin.cn/post/7581676787380060179</guid>    <pubDate>2025-12-09T13:27:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581676787380060179" data-draft-id="7581689310643421226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手动实现 Spring Boot 日志链路追踪，无需引入组件，日志定位更方便！"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2025-12-09T13:27:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮皮林551"/> <meta itemprop="url" content="https://juejin.cn/user/2447981921436084"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手动实现 Spring Boot 日志链路追踪，无需引入组件，日志定位更方便！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2447981921436084/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮皮林551
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T13:27:38.000Z" title="Tue Dec 09 2025 13:27:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ul>
<li>前言</li>
<li>正文</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb5895eea56a4656b663568d1e75a96a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765891657&amp;x-signature=6S4gnqU5Xr%2FZ94Lw5fsKetV4CLA%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<hr/>
<h2 data-id="heading-0"><strong>前言</strong></h2>
<p>从文章标题就知道，这篇文章是介绍些什么。</p>
<p>这是我一位朋友的问题反馈：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e3908004aa64944b539be89f8692cfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765891657&amp;x-signature=7EMKwLnTjExdWxrkqRfg%2FAW5nGM%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>好像是的，确实这种现象是普遍存在的。</p>
<p>有时候一个业务调用链场景，很长，调了各种各样的方法，看日志的时候，各个接口的日志穿插，确实让人头大。</p>
<p>模糊匹配搜索日志能解决吗？ 能解决一点点。 但是不能完全呈现出整个链路相关的日志。</p>
<p>那要做到方便，很显然，我们需要的是把同一次的业务调用链上的日志串起来。</p>
<p>什么效果？ 先看一个实现后的效果图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6ab2ba536984c27a9999c2687177357~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765891657&amp;x-signature=ox7S9MCFXfClrwcQK%2BiZXATyzHM%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>这样下来，我们再配合模糊匹配查找日志，效果不就刚刚的了。</p>
<pre><code class="hljs language-matlab" lang="matlab"><span class="hljs-built_in">cat</span> -n info.<span class="hljs-built_in">log</span> |grep <span class="hljs-string">"a415ad50dbf84e99b1b56a31aacd209c"</span>
</code></pre>
<p>或者</p>
<pre><code class="hljs language-c" lang="c">grep <span class="hljs-number">-10</span> <span class="hljs-string">'a415ad50dbf84e99b1b56a31aacd209c'</span> info.<span class="hljs-built_in">log</span>   （<span class="hljs-number">10</span>是指上下<span class="hljs-number">10</span>行）
</code></pre>
<p>不多说，开整。</p>
<h2 data-id="heading-1"><strong>正文</strong></h2>
<p>惯例，先看一眼这次实战最终工程的结构：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeca86e02240434bb3bc28469f474a37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765891657&amp;x-signature=Gqm2YBRw7Yn7Hu9G3V1jBjq9k94%3D" alt="185a167e3731a6f0326eae8e559f9c9c.png" loading="lazy"/></p>
<p>图片</p>
<p><strong>①pom.xml 依赖</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!--lombok配置--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.16.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<p><strong>②整合logback，打印日志，logback-spring.xml (简单配置下)</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">configuration</span> <span class="hljs-attr">debug</span>=<span class="hljs-string">"false"</span>&gt;</span>
    <span class="hljs-comment">&lt;!--日志存储路径--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"log"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"D:/test/log"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- 控制台输出 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"console"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span>&gt;</span>
            <span class="hljs-comment">&lt;!--输出格式化--&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>[%X{TRACE_ID}]  %d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 按天生成日志文件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span>
            <span class="hljs-comment">&lt;!--日志文件名--&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">FileNamePattern</span>&gt;</span>${log}/%d{yyyy-MM-dd}.log<span class="hljs-tag">&lt;/<span class="hljs-name">FileNamePattern</span>&gt;</span>
            <span class="hljs-comment">&lt;!--保留天数--&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">MaxHistory</span>&gt;</span>30<span class="hljs-tag">&lt;/<span class="hljs-name">MaxHistory</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>[%X{TRACE_ID}]  %d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span>
        <span class="hljs-comment">&lt;!--日志文件最大的大小--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">triggeringPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">MaxFileSize</span>&gt;</span>10MB<span class="hljs-tag">&lt;/<span class="hljs-name">MaxFileSize</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">triggeringPolicy</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 日志输出级别 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"INFO"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"console"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"file"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<p>application.yml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8826</span>
<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">config:</span> <span class="hljs-string">classpath:logback-spring.xml</span>
</code></pre>
<p><strong>③自定义日志拦截器 LogInterceptor.java</strong></p>
<p>用途：每一次链路，线程维度，添加最终的链路ID TRACE_ID。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> org.<span class="hljs-property">slf4j</span>.<span class="hljs-property">MDC</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">lang</span>.<span class="hljs-property">Nullable</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">util</span>.<span class="hljs-property">StringUtils</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">servlet</span>.<span class="hljs-property">HandlerInterceptor</span>;

<span class="hljs-keyword">import</span> javax.<span class="hljs-property">servlet</span>.<span class="hljs-property">http</span>.<span class="hljs-property">HttpServletRequest</span>;
<span class="hljs-keyword">import</span> javax.<span class="hljs-property">servlet</span>.<span class="hljs-property">http</span>.<span class="hljs-property">HttpServletResponse</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">UUID</span>;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Author</span>: JCccc
 * <span class="hljs-doctag">@Date</span>: 2022-5-30 10:45
 * <span class="hljs-doctag">@Description</span>:
 */</span>
<span class="hljs-keyword">public</span><span class="hljs-keyword">class</span> <span class="hljs-title class_">LogInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {

    privatestaticfinal <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">TRACE_ID</span> = <span class="hljs-string">"TRACE_ID"</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">preHandle</span>(<span class="hljs-params">HttpServletRequest request, HttpServletResponse response, <span class="hljs-built_in">Object</span> handler</span>) {
        <span class="hljs-title class_">String</span> tid = <span class="hljs-variable constant_">UUID</span>.<span class="hljs-title function_">randomUUID</span>().<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">replace</span>(<span class="hljs-string">"-"</span>, <span class="hljs-string">""</span>);
        <span class="hljs-comment">//可以考虑让客户端传入链路ID，但需保证一定的复杂度唯一性；如果没使用默认UUID自动生成</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">StringUtils</span>.<span class="hljs-title function_">isEmpty</span>(request.<span class="hljs-title function_">getHeader</span>(<span class="hljs-string">"TRACE_ID"</span>))){
            tid=request.<span class="hljs-title function_">getHeader</span>(<span class="hljs-string">"TRACE_ID"</span>);
        }
        <span class="hljs-variable constant_">MDC</span>.<span class="hljs-title function_">put</span>(<span class="hljs-variable constant_">TRACE_ID</span>, tid);
        returntrue;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">afterCompletion</span>(<span class="hljs-params">HttpServletRequest request, HttpServletResponse response, <span class="hljs-built_in">Object</span> handler,
                                <span class="hljs-meta">@Nullable</span> Exception ex</span>) {
        <span class="hljs-variable constant_">MDC</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-variable constant_">TRACE_ID</span>);
    }

}
</code></pre>
<p>MDC(Mapped Diagnostic Context)诊断上下文映射，是@Slf4j提供的一个支持动态打印日志信息的工具。</p>
<p>WebConfigurerAdapter.java 添加拦截器</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">context</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Bean</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">context</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Configuration</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">servlet</span>.<span class="hljs-property">config</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">InterceptorRegistry</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">servlet</span>.<span class="hljs-property">config</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">WebMvcConfigurer</span>;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Author</span>: JCccc
 * <span class="hljs-doctag">@Date</span>: 2022-5-30 10:47
 * <span class="hljs-doctag">@Description</span>:
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span><span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConfigurerAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">LogInterceptor</span> <span class="hljs-title function_">logInterceptor</span>(<span class="hljs-params"/>) {
        returnnew <span class="hljs-title class_">LogInterceptor</span>();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addInterceptors</span>(<span class="hljs-params">InterceptorRegistry registry</span>) {
        registry.<span class="hljs-title function_">addInterceptor</span>(<span class="hljs-title function_">logInterceptor</span>());
        <span class="hljs-comment">//可以具体制定哪些需要拦截，哪些不拦截，其实也可以使用自定义注解更灵活完成</span>
<span class="hljs-comment">//                .addPathPatterns("/**")</span>
<span class="hljs-comment">//                .excludePathPatterns("/testxx.html");</span>
    }
}
</code></pre>
<p>ps: 其实这个拦截的部分改为使用自定义注解+aop也是很灵活的。</p>
<p>到这时候，其实已经完成，就是这么简单。</p>
<p>我们写个测试接口，看下效果：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"doTest"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">doTest</span>(<span class="hljs-meta">@RequestParam</span>(<span class="hljs-string">"name"</span>) <span class="hljs-title class_">String</span> name) throws <span class="hljs-title class_">InterruptedException</span> {
    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"入参 name={}"</span>,name);
    <span class="hljs-title function_">testTrace</span>();
    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"调用结束 name={}"</span>,name);
    <span class="hljs-keyword">return</span><span class="hljs-string">"Hello,"</span>+name;
}
<span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">testTrace</span>(<span class="hljs-params"/>){
    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"这是一行info日志"</span>);
    log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"这是一行error日志"</span>);
    <span class="hljs-title function_">testTrace2</span>();
}
<span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">testTrace2</span>(<span class="hljs-params"/>){
    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"这也是一行info日志"</span>);

}
</code></pre>
<p>效果（OK的）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cb5ab24585640ea96a509db4943ce70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765891657&amp;x-signature=mYJ4QYjI0%2BRSZQdVAKaz1dq9ebg%3D" alt="942981f88d0519b8db91d48d3bfb7cd4.png" loading="lazy"/></p>
<p>图片</p>
<p>还没完。</p>
<p>接下来看一个场景， 使用子线程的场景：</p>
<p>故意写一个异步线程，加入这个调用里面：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b5cbd7125fd45b5b68ba01946d9283c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765891657&amp;x-signature=PXJMSQcBllC2y9C%2B21TfW7PxYVk%3D" alt="0e36925e12430b60afeec92f33bae252.png" loading="lazy"/></p>
<p>图片</p>
<p>再次执行看开效果，显然子线程丢失了trackId：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76a8b290d2ef4af7ae862c230e7f6cc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765891657&amp;x-signature=64JskJB6kC4uEaF7uUjCApPYOZw%3D" alt="fd248434242615608dd4494d94c0df56.png" loading="lazy"/></p>
<p>图片</p>
<p>所以我们需要针对子线程使用情形，做调整，思路： 将父线程的trackId传递下去给子线程即可。</p>
<p><strong>①ThreadPoolConfig.java 定义线程池，交给spring管理</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> org.springframework.context.<span class="hljs-keyword">annotation</span>.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.<span class="hljs-keyword">annotation</span>.Configuration;
<span class="hljs-keyword">import</span> org.springframework.scheduling.<span class="hljs-keyword">annotation</span>.EnableAsync;
<span class="hljs-keyword">import</span> java.util.concurrent.Executor;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Author</span>: JCccc
 * <span class="hljs-doctag">@Date</span>: 2022-5-30 11:07
 * <span class="hljs-doctag">@Description</span>:
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAsync</span>
<span class="hljs-keyword">public</span><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolConfig</span> {
    <span class="hljs-comment">/**
     * 声明一个线程池
     *
     * <span class="hljs-doctag">@return</span> 执行器
     */</span>
    <span class="hljs-meta">@Bean(<span class="hljs-string">"MyExecutor"</span>)</span>
    <span class="hljs-keyword">public</span> Executor asyncExecutor() {
        MyThreadPoolTaskExecutor executor = new MyThreadPoolTaskExecutor();
        <span class="hljs-comment">//核心线程数5：线程池创建时候初始化的线程数</span>
        executor.setCorePoolSize(<span class="hljs-number">5</span>);
        <span class="hljs-comment">//最大线程数5：线程池最大的线程数，只有在缓冲队列满了之后才会申请超过核心线程数的线程</span>
        executor.setMaxPoolSize(<span class="hljs-number">5</span>);
        <span class="hljs-comment">//缓冲队列500：用来缓冲执行任务的队列</span>
        executor.setQueueCapacity(<span class="hljs-number">500</span>);
        <span class="hljs-comment">//允许线程的空闲时间60秒：当超过了核心线程出之外的线程在空闲时间到达之后会被销毁</span>
        executor.setKeepAliveSeconds(<span class="hljs-number">60</span>);
        <span class="hljs-comment">//线程池名的前缀：设置好了之后可以方便我们定位处理任务所在的线程池</span>
        executor.setThreadNamePrefix(<span class="hljs-string">"asyncJCccc"</span>);
        executor.initialize();
        <span class="hljs-keyword">return</span> executor;
    }
}
</code></pre>
<p><strong>② MyThreadPoolTaskExecutor.java 是我们自己写的，重写了一些方法：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.slf4j.MDC;
<span class="hljs-keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;

<span class="hljs-keyword">import</span> java.util.concurrent.Callable;
<span class="hljs-keyword">import</span> java.util.concurrent.Future;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Author</span>: JCccc
 * <span class="hljs-doctag">@Date</span>: 2022-5-30 11:13
 * <span class="hljs-doctag">@Description</span>:
 */</span>
publicfinalclass MyThreadPoolTaskExecutor  <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>  {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyThreadPoolTaskExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>();
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Runnable task)</span> {
        <span class="hljs-built_in">super</span>.execute(ThreadMdcUtil.wrap(task, MDC.getCopyOfContextMap()));
    }


    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; Future&lt;T&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(Callable&lt;T&gt; task)</span> {
        returnsuper.submit(ThreadMdcUtil.wrap(task, MDC.getCopyOfContextMap()));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Future&lt;?&gt; submit(Runnable task) {
        returnsuper.submit(ThreadMdcUtil.wrap(task, MDC.getCopyOfContextMap()));
    }
}
</code></pre>
<p><strong>③ThreadMdcUtil.java</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> org.<span class="hljs-property">slf4j</span>.<span class="hljs-property">MDC</span>;

<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Map</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">UUID</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">Callable</span>;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Author</span>: JCccc
 * <span class="hljs-doctag">@Date</span>: 2022-5-30 11:14
 * <span class="hljs-doctag">@Description</span>:
 */</span>
publicfinal<span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadMdcUtil</span> {
    privatestaticfinal <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">TRACE_ID</span> = <span class="hljs-string">"TRACE_ID"</span>;

    <span class="hljs-comment">// 获取唯一性标识</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">generateTraceId</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">UUID</span>.<span class="hljs-title function_">randomUUID</span>().<span class="hljs-title function_">toString</span>();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setTraceIdIfAbsent</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">MDC</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable constant_">TRACE_ID</span>) == <span class="hljs-literal">null</span>) {
            <span class="hljs-variable constant_">MDC</span>.<span class="hljs-title function_">put</span>(<span class="hljs-variable constant_">TRACE_ID</span>, <span class="hljs-title function_">generateTraceId</span>());
        }
    }

    <span class="hljs-comment">/**
     * 用于父线程向线程池中提交任务时，将自身MDC中的数据复制给子线程
     *
     * <span class="hljs-doctag">@param</span> <span class="hljs-variable">callable</span>
     * <span class="hljs-doctag">@param</span> <span class="hljs-variable">context</span>
     * <span class="hljs-doctag">@param</span> &lt;T&gt;
     * <span class="hljs-doctag">@return</span>
     */</span>
    publicstatic &lt;T&gt; <span class="hljs-title class_">Callable</span>&lt;T&gt; <span class="hljs-title function_">wrap</span>(<span class="hljs-params">final Callable&lt;T&gt; callable, final <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; context</span>) {
        <span class="hljs-keyword">return</span> () -&gt; {
            <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) {
                <span class="hljs-variable constant_">MDC</span>.<span class="hljs-title function_">clear</span>();
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-variable constant_">MDC</span>.<span class="hljs-title function_">setContextMap</span>(context);
            }
            <span class="hljs-title function_">setTraceIdIfAbsent</span>();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> callable.<span class="hljs-title function_">call</span>();
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-variable constant_">MDC</span>.<span class="hljs-title function_">clear</span>();
            }
        };
    }

    <span class="hljs-comment">/**
     * 用于父线程向线程池中提交任务时，将自身MDC中的数据复制给子线程
     *
     * <span class="hljs-doctag">@param</span> <span class="hljs-variable">runnable</span>
     * <span class="hljs-doctag">@param</span> <span class="hljs-variable">context</span>
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">Runnable</span> <span class="hljs-title function_">wrap</span>(<span class="hljs-params">final Runnable runnable, final <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; context</span>) {
        <span class="hljs-keyword">return</span> () -&gt; {
            <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) {
                <span class="hljs-variable constant_">MDC</span>.<span class="hljs-title function_">clear</span>();
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-variable constant_">MDC</span>.<span class="hljs-title function_">setContextMap</span>(context);
            }
            <span class="hljs-title function_">setTraceIdIfAbsent</span>();
            <span class="hljs-keyword">try</span> {
                runnable.<span class="hljs-title function_">run</span>();
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-variable constant_">MDC</span>.<span class="hljs-title function_">clear</span>();
            }
        };
    }
}
</code></pre>
<p>OK，重启服务，再看看效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fd7ab3f7bf54acd9a101031b0a87bf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765891657&amp;x-signature=aHTSQDW9wKc76Ok4w7uMPglyd4w%3D" alt="50cce9456a6ac156a0f208b5b04ec494.png" loading="lazy"/></p>
<p>图片</p>
<p>可以看的，子线程的日志也被串起来了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[位运算第1篇-异或运算-快速找出重复数字]]></title>    <link>https://juejin.cn/post/7581666815003115571</link>    <guid>https://juejin.cn/post/7581666815003115571</guid>    <pubDate>2025-12-09T12:39:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581666815003115571" data-draft-id="7581698074361413641" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="位运算第1篇-异或运算-快速找出重复数字"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-09T12:39:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            位运算第1篇-异或运算-快速找出重复数字
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T12:39:03.000Z" title="Tue Dec 09 2025 12:39:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：本文介绍了异或运算的特点和运算规律，并通过利用异或运算解决了一个算法题目：找出1-n连续数组中的惟一重复数字。</p>
<h2 data-id="heading-0">异或运算的巧妙应用：快速找出重复数字</h2>
<h3 data-id="heading-1">引言</h3>
<p>异或运算（XOR）是一种基础的二进制运算，在编程面试和算法设计中有着意想不到的妙用。本文将深入探讨如何利用异或运算的数学特性，以 O(n) 时间复杂度和 O(1) 空间复杂度找出数组中的重复数字。</p>
<h3 data-id="heading-2">问题定义</h3>
<p>给定一个长度为 n+1 的数组，包含 1 到 n 之间的整数，<strong>恰好有一个数字重复出现一次</strong>，其余数字各出现一次。例如：</p>
<ul>
<li>输入：<code>[1, 2, 3, 4, 5, 5]</code></li>
<li>输出：<code>5</code></li>
</ul>
<h3 data-id="heading-3">异或运算的基本性质</h3>
<p>在深入解决方案之前，先回顾异或运算的关键特性：</p>
<ol>
<li><strong>交换律</strong>：<code>a ⊕ b = b ⊕ a</code></li>
<li><strong>结合律</strong>：<code>(a ⊕ b) ⊕ c = a ⊕ (b ⊕ c)</code></li>
<li><strong>自反性</strong>：<code>a ⊕ a = 0</code></li>
<li><strong>单位元</strong>：<code>a ⊕ 0 = a</code></li>
<li><strong>消去律</strong>：<code>a ⊕ b ⊕ a = b</code></li>
</ol>
<p>背后是位运算的本质。</p>
<p>0 ⊕ 0 = 0， 0 ⊕ 1 = 1</p>
<p>通俗理解就是： 0和0不相等吗？否，他们相等，否用0表示， 是用1表示，所以前面的0是数字，后面的0是否， 位运算的0和1的双重含义是位运算的基础。</p>
<p>这些性质意味着异或运算可以任意重新组合和抵消相同项。</p>
<h3 data-id="heading-4">常见误区与正确解法</h3>
<h4 data-id="heading-5">误区：直接对数组所有元素进行异或</h4>
<pre><code class="hljs language-python" lang="python">xor_all = <span class="hljs-number">1</span> ⊕ <span class="hljs-number">2</span> ⊕ <span class="hljs-number">3</span> ⊕ <span class="hljs-number">4</span> ⊕ <span class="hljs-number">5</span> ⊕ <span class="hljs-number">5</span>
        = (<span class="hljs-number">1</span> ⊕ <span class="hljs-number">2</span> ⊕ <span class="hljs-number">3</span> ⊕ <span class="hljs-number">4</span>) ⊕ (<span class="hljs-number">5</span> ⊕ <span class="hljs-number">5</span>)
        = (<span class="hljs-number">1</span> ⊕ <span class="hljs-number">2</span> ⊕ <span class="hljs-number">3</span> ⊕ <span class="hljs-number">4</span>) ⊕ <span class="hljs-number">0</span>
        = <span class="hljs-number">4</span>
</code></pre>
<p>结果不是重复数字，而是其他数字的异或值。<strong>直接异或整个数组无法找出重复数</strong>，因为重复数出现两次会相互抵消。</p>
<h4 data-id="heading-6">正确解法：数组异或与范围异或相结合</h4>
<p>设数组为 A，长度为 n+1，包含 1 到 n 的整数，其中一个数字重复。</p>
<p>计算：</p>
<ol>
<li>数组所有元素的异或值：<code>xor_arr = A[0] ⊕ A[1] ⊕ ... ⊕ A[n]</code></li>
<li>1 到 n 的异或值：<code>xor_range = 1 ⊕ 2 ⊕ ... ⊕ n</code></li>
<li>重复数字 = <code>xor_arr ⊕ xor_range</code></li>
</ol>
<h4 data-id="heading-7">原理分析</h4>
<p>将两个异或值合并考虑：</p>
<pre><code class="hljs language-ini" lang="ini">xor_arr ⊕ <span class="hljs-attr">xor_range</span> 
= (每个元素按出现次数异或) ⊕ (1到n各出现一次)
</code></pre>
<ul>
<li><strong>非重复数字</strong>：在数组中出现 1 次，在 1~n 中出现 1 次 → 总共出现 2 次 → 异或抵消</li>
<li><strong>重复数字</strong>：在数组中出现 2 次，在 1~n 中出现 1 次 → 总共出现 3 次 → 保留该数字</li>
</ul>
<p>因为：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span> ⊕ <span class="hljs-selector-tag">a</span> ⊕ <span class="hljs-selector-tag">a</span> = (<span class="hljs-selector-tag">a</span> ⊕ <span class="hljs-selector-tag">a</span>) ⊕ <span class="hljs-selector-tag">a</span> = <span class="hljs-number">0</span> ⊕ <span class="hljs-selector-tag">a</span> = <span class="hljs-selector-tag">a</span>
</code></pre>
<h4 data-id="heading-8">实例验证</h4>
<p>对于数组 <code>[1, 2, 3, 4, 5, 5]</code>（n=5）：</p>
<ol>
<li><code>xor_arr = 1 ⊕ 2 ⊕ 3 ⊕ 4 ⊕ 5 ⊕ 5 = 1 ⊕ 2 ⊕ 3 ⊕ 4 = 4</code></li>
<li><code>xor_range = 1 ⊕ 2 ⊕ 3 ⊕ 4 ⊕ 5</code>
<ul>
<li>逐步计算：<code>1 ⊕ 2 = 3</code>，<code>3 ⊕ 3 = 0</code>，<code>0 ⊕ 4 = 4</code>，<code>4 ⊕ 5 = 1</code></li>
</ul>
</li>
<li>重复数字 = <code>4 ⊕ 1 = 5</code></li>
</ol>
<p>✅ 正确找出重复数字 5。</p>
<h3 data-id="heading-9">算法实现</h3>
<h4 data-id="heading-10">Python 实现</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_duplicate</span>(<span class="hljs-params">nums</span>):
    n = <span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span>
    
    <span class="hljs-comment"># 计算数组所有元素的异或</span>
    xor_arr = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> nums:
        xor_arr ^= num
    
    <span class="hljs-comment"># 计算 1 到 n 的异或</span>
    xor_range = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, n + <span class="hljs-number">1</span>):
        xor_range ^= i
    
    <span class="hljs-comment"># 重复数字</span>
    <span class="hljs-keyword">return</span> xor_arr ^ xor_range

<span class="hljs-comment"># 更简洁的写法</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">find_duplicate_compact</span>(<span class="hljs-params">nums</span>):
    result = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i, num <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(nums):
        result ^= num ^ (i + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> result ^ <span class="hljs-built_in">len</span>(nums)  <span class="hljs-comment"># 修正边界</span>
</code></pre>
<h4 data-id="heading-11">时间复杂度与空间复杂度</h4>
<ul>
<li><strong>时间复杂度</strong>：O(n)，只需遍历数组一次</li>
<li><strong>空间复杂度</strong>：O(1)，只使用常数个额外变量</li>
</ul>
<h3 data-id="heading-12">扩展应用</h3>
<h4 data-id="heading-13">变体问题：找到重复和缺失的数字</h4>
<p>如果数组长度为 n，包含 1 到 n 的数字，但有一个数字重复，一个数字缺失，可以使用类似的异或技巧：</p>
<ol>
<li>计算 <code>xor_all = (所有数组元素异或) ⊕ (1到n异或)</code></li>
<li><code>xor_all</code> 的二进制表示中最低位的 1，表示重复数和缺失数在该位不同</li>
<li>根据该位将数字分成两组，分别异或得到两个数字</li>
<li>判断哪个是重复的，哪个是缺失的</li>
</ol>
<h4 data-id="heading-14">其他应用场景</h4>
<ol>
<li><strong>找出现奇数次的数字</strong>：在一组数字中，只有一个数字出现奇数次，其余出现偶数次</li>
<li><strong>交换两个变量</strong>：不使用临时变量交换两个整数</li>
<li><strong>加密中的简单混淆</strong>：基于异或的简单加密算法</li>
</ol>
<h3 data-id="heading-15">注意事项</h3>
<ol>
<li><strong>前提条件</strong>：该方法要求恰好一个数字重复，且数字范围明确（1 到 n）</li>
<li><strong>边界情况</strong>：注意数组索引和范围的对应关系</li>
<li><strong>溢出问题</strong>：异或运算不会引起溢出问题</li>
</ol>
<h3 data-id="heading-16">总结</h3>
<p>异或运算不仅是一种基本的逻辑运算，更是算法设计中的有力工具。通过巧妙的数学变换，我们可以：</p>
<ol>
<li>利用自反性消除成对出现的数字</li>
<li>结合范围异或来分离重复项</li>
<li>在 O(1) 额外空间内解决问题</li>
</ol>
<p>这种解法体现了计算机科学中一个重要的思想：<strong>通过数学变换将问题转化为更容易处理的形式</strong>。掌握异或运算的特性，对于解决位操作相关问题有着重要意义。</p>
<h3 data-id="heading-17">思考题</h3>
<ol>
<li>如果数组中有两个数字重复，还能用异或法解决吗？</li>
<li>如果数字范围不是从 1 开始，而是从 m 到 n，方法需要如何调整？</li>
<li>如何用异或运算判断一个整数是否是 2 的幂？</li>
</ol>
<hr/>
<p><strong>关键点</strong>：异或运算的抵消特性使其成为处理"成对出现"问题的理想工具，而结合数学范围限制可以进一步分离出异常项。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[百度慧播星数字人技术演进]]></title>    <link>https://juejin.cn/post/7581667332307058726</link>    <guid>https://juejin.cn/post/7581667332307058726</guid>    <pubDate>2025-12-09T11:16:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581667332307058726" data-draft-id="7581448482545729562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="百度慧播星数字人技术演进"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-09T11:16:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百度Geek说"/> <meta itemprop="url" content="https://juejin.cn/user/4186596000416094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            百度慧播星数字人技术演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4186596000416094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百度Geek说
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T11:16:37.000Z" title="Tue Dec 09 2025 11:16:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">导读</h2>
<p>从2023年成立到如今日均服务2万+直播间，百度慧播星已演进为覆盖脚本生成、实时问答、智能决策、音视频克隆的全链路AI直播平台。本文深入解读其技术架构：如何通过检索增强和强化学习生成高转化脚本；如何利用强化学习智能中控动态优化直播策略；以及如何将语音与形象克隆效率提升至“小时级”；如何构建“先验-后验”数据飞轮，让模型自主进化；。罗永浩数字人直播GMV突破5500万的案例，验证了其“超越真人”的带货能力。未来，慧播星正朝着更智能、更拟真、更高效的方向持续迭代。</p>
<h2 data-id="heading-1">01 慧播星介绍</h2>
<p>电商数字人直播（慧播星）正式成立于2023年，是一款汇集了百度在视觉，语音和语言方面AI能力的原生AI应用产品，致力于打造代际领先的超越真人的直播体验。25年底日均开播直播间已达2万多个，覆盖电商、教育、健康、金融、泛知识内容等多个行业。经过两年多的产品打磨和技术突破，慧播星数字人直播已具备超越真人的能力。例如，这些能力支撑了罗永浩2025年6月15 日的数字人直播首秀，吸引了超 1300 万人次观看，GMV（商品交易总额）突破 5500 万元，这一成绩超过了其同年 5 月的真人直播首秀（GMV 5000 万）。</p>
<h3 data-id="heading-2"><strong>1.1 商家业务视角——开播流程</strong></h3>
<p>商家在慧播星获得带货权限后，即可自助开启数字人直播，主要包括如下流程。</p>
<p><strong><strong>1. 商品选择</strong></strong>，可从百度直营店铺（度小店），三方电商平台（京东淘宝拼多多）和百度本地生活的海量商品中选择带货商品</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/557f4c963c6b42179a86199d3abd9ad7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=okGenty3I32z70Li1KGsUP0WESo%3D" alt="图片" loading="lazy"/></p>
<p><strong><strong>△ 海量内外部商品一键挂接</strong></strong></p>
<ol start="2">
<li>形象选择或者定制，从7800+公共库形象中选择主播形象，或通过自助录制5分钟视频定制私有形象</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c5e0c560dba4557ac49927efdfd3f71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=a353H7iCTkr%2FH4h2A4M8ZljzuCc%3D" alt="图片" loading="lazy"/></p>
<p><strong><strong>△ 形象选择或定制</strong></strong></p>
<ol start="3">
<li>直播间装修，从3600+套直播间模板中选择装修风格和元素，或通过AI自动生成直播间背景图和营销挂件</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b08ad9617da24ef8be731f2cb3c22f3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=KawLZHZw1RSuXEDtT%2FM6furB8O0%3D" alt="图片" loading="lazy"/></p>
<p><strong><strong>△ 直播间装修，丰富的模板&amp;组件</strong></strong></p>
<ol start="4">
<li>脚本生成，从多种公共风格中选择脚本带货风格，或自定义目标带货风格，补充少量营销信息，一键生成专业的直播脚本</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6722665ea1442bea61959e6841f8e15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=m0kcnkSRV6NN7XOXUIjmV2w2U10%3D" alt="图片" loading="lazy"/></p>
<p><strong><strong>△ 一键脚本生成</strong></strong></p>
<ol start="5">
<li>音色选择，从3200+个公共库音色中选择主播音色，或通过手百自助录制，3天内得到私有定制音色</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02614cedc6004945860e83bfafc51972~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=aJBbL4o6oN7dKiC3AigPBXZgx4Q%3D" alt="图片" loading="lazy"/></p>
<p><strong><strong>△ 音色选择或制作</strong></strong></p>
<p><strong><strong>6. 直播间互动配置</strong></strong>，一键开启一言问答接管，也支持手动配置预置问答对，补充商家知识</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd27b788b5de4b18af9d1608c304a189~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=mMFtu%2BSZNG0OLXLesypCc114C3E%3D" alt="图片" loading="lazy"/></p>
<p><strong><strong>△ 直播间互动配置</strong></strong></p>
<h2 data-id="heading-3">02 整体技术架构</h2>
<p>慧播星整体架构主要由商家端、视觉语音和文本各模态模型、实时渲染引擎、站内外分发系统组成。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e66640862c864ac7a1976c710018e95c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=%2F6HlK1drXxQbDxT6FZdXNJAX8SU%3D" alt="图片" loading="lazy"/></p>
<p>为实现更好的直播体验，数字人采用云端生成方案，云端生成系统主要包括如下几个子系统。</p>
<p><strong><strong>1. 商品理解</strong></strong>，为脚本，问答，互动等各种内容生成模型提供商品知识增强</p>
<p><strong><strong>2. 脚本生成</strong></strong>，围绕商品自动生成风格化口语化的带货脚本</p>
<p><strong><strong>3. 智能问答</strong></strong>，用户提问时实时检索商品知识，生成精准的回复，支持弹幕和口播回复</p>
<p><strong><strong>4. 智能互动</strong></strong>，以直播效果（评论率、用户退场率、观看时长等）为目标主动向用户发起互动</p>
<p><strong><strong>5. 直播间装修</strong></strong>，智能生成直播间背景，合成带营销内容的挂件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8090789c91445938b24846f747de1f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=qK%2FAhl4zvwUzklChgxvYgDuAxC0%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">03 内容生成</h2>
<h2 data-id="heading-5"><strong>3.1 风格化脚本生成</strong></h2>
<p>直播脚本水平与带货效果息息相关，优秀主播的脚本能够打动用户，循循善进引导用户成交。由于普通商家的带货营销水平有限，商家希望仅表达学习某某主播，系统自动为其生成风格相似的脚本。在此需求背景下，慧播星利用多模态商品理解富集构建商品知识库，借助EB4/turbo在电商直播语料上进行大规模预训练，结合人工专家精标数据SFT，通用和电商知识增强等手段实现一键风格化仿写。</p>
<ul>
<li>商家仅需选定商品和补充少量营销信息，即可按预设风格或者自定风格（提供最少400字的带货文案）一键生成风格相似的带货脚本。<strong><strong>客户采纳率92%，开播渗透率67%，相比客户脚本转化率+14%。</strong></strong></li>
<li>考虑到风格化脚本创作需求的独立性，慧播星已将脚本生成独立为工具，商家可脱离直播业务流使用工具。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4df0405b9dfe425f88c428dadb9f2a0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=AR1O2ADY3LtIJsw7odYJmK6sTtU%3D" alt="图片" loading="lazy"/></p>
<p><strong><strong>△ 风格化脚本生成工具UI</strong></strong></p>
<h4 data-id="heading-6"><strong><strong>技术架构</strong></strong></h4>
<p>整体技术主要包括商品理解、检索增强、强化学习风格化生成和后处理阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f61f0a627b3c4adb8de0de0e556d98e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=MKlRiH1bnNmYjw1xUVOUix%2FCXy8%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>商品理解</strong>。系统通过多模态商品解析技术对商品详情页、海报图、参数图等视觉素材进行 OCR、版面结构识别与多模态模型融合，自动抽取核心卖点、适用人群、功能亮点、使用场景等结构化商品知识。可在单张图里同时捕获“文本内容 + 图示含义 + 排版语义”等特征，并利用 LLM 对解析结果进行归一化和字段对齐，形成高覆盖、高一致性的商品知识库。</li>
<li><strong><strong>检索增强（RAG）链路</strong></strong>。用户输入的风格范文（不少于 400 字）会先经过标签分析模块，由大模型识别出其关键风格维度，如：表达节奏（快/慢）、情绪浓度（热情/克制）、营造气氛策略（故事、对比、疑问句）、用户痛点定位、直播常用带货技巧（强调稀缺、促单压力、利益点递进）等。基于这些风格标签，系统自动生成 Query，用于从通用知识库与电商知识库中检索对应表达方式、句式模板与知识上下文（卖点顺序推荐、商品类别常用话术、场景化句法等）。</li>
<li><strong><strong>风格化生成模型</strong></strong>。模型基于电商专精的电商直播语料预训练能力，并结合海量运营专家的精细化标注数据（SFT），能够在保持范文风格一致性的同时，将内容自动替换为目标商品的卖点和营销逻辑。为确保生成内容既符合直播场景使用习惯，又具备高情绪感染力，系统引入轻量级 RLHF/强化学习优化，通过人类偏好数据持续调优，使模型能够稳定输出“自然、顺畅、带货效果强”的脚本。为持续提升模型能力，通过数据飞轮对该生成模型进行对齐。</li>
<li><strong>标签化与后处理</strong>。脚本被进一步结构化，包括：分镜逻辑、开场引导、利益点铺垫、情绪高点、促单推进、收尾金句等，方便商家在实际直播中灵活调用或进行定制化编辑。</li>
</ul>
<h4 data-id="heading-7"><strong><strong>脚本数据飞轮</strong></strong></h4>
<p>数字人直播的内容绝大部分来自大模型生成，前期领域专家知识为生成标准，脚本、问答、互动场景的生成质量已达到普通真人主播的水平。然而人工先验知识存在主观偏差，且缺乏全面性和快速适应新变化的能力，完全依赖人工只能达到次优水平。为持续攀升超越域内外头部真人主播，需建立业务和大模型的数据飞轮，通过飞轮效应持续提升模型在数字人直播场景的后验效果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df2e50ddd78b4d0dac0e8ba425c55d0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=mJxK5DQi%2F528oBm%2FhhV7AizMFlI%3D" alt="图片" loading="lazy"/></p>
<h5 data-id="heading-8">先验对齐</h5>
<p>在真实直播场景中，数字人模型最终追求的是“后验效果最优”——即用户停留、评论增长、转化提升等真实业务指标。然而后验目标往往天然伴随风险：例如激进促单、夸大效果、模糊描述等内容可能在短期内获得更高的用户反馈，却越过事实边界与平台规范，形成安全问题。因此，在模型全面对齐后验之前，必须构建一套稳健、可解释、与平台规范一致的<strong><strong>先验对齐体系</strong></strong>作为基础。先验奖励模型作为“守门人”，以推理专家模型为判断核心，通过结构化的偏好评分与规则奖励引导模型学习合规、高质、可控的内容风格，实现“先验对齐 → 强化学习 → 专精模型 → 回流验证”的闭环。</p>
<p>自动偏好合成。传统先验奖励完全依赖人工标注，成本高且存在主观性。为解决这一问题，我们集成了多个先进推理类基模型（如 EB4-4T、Deepseek-R1/V3、GPT-o 系列等），通过多模型投票、结果对比分级等方式自动合成偏好。这一自动化偏好生成机制能够模拟“专家标注”，但具备：</p>
<ul>
<li><strong>一致性更高</strong>，减少人工主观波动</li>
<li><strong>覆盖范围更广</strong>，数百万级先验数据</li>
<li><strong>适应变化更快</strong>，模型可随平台规范或内容趋势变化即时更新</li>
</ul>
<p>最终形成先验 RM（Reward Model）的核心训练数据。先验 RM 的核心职责是确保模型在任何情况下都不会突破内容安全边界，为后续后验对齐提供稳固底座。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e5b1f71c94046f38e5f3e3badadbefb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=mfgGchxOlC1NJpdZJAX6v%2BNY3Bc%3D" alt="图片" loading="lazy"/></p>
<h5 data-id="heading-9">后验数据飞轮</h5>
<p>为了让模型吸收用户的真实后验反馈，慧播星构建了一套以“内容探索 + 奖励建模”为两条主线的数据飞轮，实现模型的自主进化与持续增强。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a564f0eb435143f3b01088065dff61f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=kSqVL3Hg2kUJ1TlAhH47ImUBQ1g%3D" alt="图片" loading="lazy"/></p>
<p><strong><strong>基于后验统计的内容探索</strong></strong>：可控、高解释的偏好数据生成链路。后验统计路径主要面向<strong><strong>高精度、强可控、可解释性强</strong></strong>的偏好数据生产需求，结合在线实验框架，通过真实用户反馈驱动的方式生成偏好样本。通过高频在线实验，系统不断沉淀千级规模的偏好数据，支撑后续的模型偏好对齐训练（如 DPO/IPO 等策略优化方法）。</p>
<p><strong><strong>可泛化的奖励 uplift 建模</strong></strong>：大规模偏好数据的高效补充路径。相比基于后验统计的实验方式，uplift 建模路径旨在解决<strong><strong>用户行为稀疏、实验成本高</strong></strong>的问题，通过泛化模型直接对用户偏好进行预测，生成百万级的偏好数据，实现更高效的数据扩容。采用 S-Learner / T-Learner 等 uplift 方法，构建用户行为因果效应模型，直接预测“某段内容是否会提升用户的互动/评论/停留等关键指标？”</p>
<h3 data-id="heading-10"><strong>3.2 智能问答</strong></h3>
<p>慧播星建设了一套完备的直播场景RAG系统，包括电商领域知识检索模型，通过千亿模型蒸馏的低时延生成模型（12s-&gt;2s)，数据飞轮。目前已实现多模素材调度，高拟真明星问答，客户个性化表达，垂类适配，商家/商品知识库等产品能力。客户可一键开启智能问答，问答端到端可用率95%，优质率90%，客户开启率94%，运营和客户反馈较好。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ff151fa418b40c2a4b7c1f249a813de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=54klu3AphX0ojEVY%2FA459XiRJl0%3D" alt="图片" loading="lazy"/></p>
<p><strong><strong>△ 智能问答架构</strong></strong></p>
<h4 data-id="heading-11"><strong><strong>技术架构</strong></strong></h4>
<p>慧播星的直播实时问答系统在工程上形成了知识整合 → 领域检索 → 低延迟生成 → 后处理 → 数据飞轮的完整闭环，为超拟真数字人提供了媲美真人的实时互动能力。</p>
<ul>
<li>在<strong><strong>知识整合层</strong></strong>，系统将商家侧的商品图文、卖点、FAQ、视频脚本、类目属性以及运营沉淀的数据统一入库，并通过向量化处理构建高可用的电商知识底座。</li>
<li><strong><strong>领域知识检索模块</strong></strong>结合了千帧蒸馏后的 EB-lite/行业模型与高维向量语义搜索，通过「意图识别 → 精准匹配 → 语义聚类 → 知识召回」的流水线，确保系统能够从复杂直播语境中准确捕捉用户提问意图。直播场景中存在大量口语化、短句化、甚至噪声语料（如： “这个能用多久啊”。“有别的颜色吗？”），系统通过深度语义 embedding（如 ernie embedding）实现高鲁棒性的实时检索，使检索召回的准确率在实时环境下依然保持稳定。</li>
<li><strong><strong>低延时生成模块</strong></strong>。基于千亿模型蒸馏结果构建，针对直播高并发、低时延、强一致性的要求，模型经过结构裁剪、张量并行优化与 Prompt 规约，使单轮响应时延从 12s 压缩到 2s，在保证语义丰富度和口播自然度的同时提升端到端体验。</li>
<li><strong><strong>数据飞轮实现持续自我优化</strong></strong>：运营反馈、用户互动日志、误匹配案例以及高质问答样本会自动回流到数据处理模块，驱动知识库更新与模型重训练。</li>
</ul>
<h3 data-id="heading-12"><strong>3.3 智能中控</strong></h3>
<hr/>
<p>真人主播会根据直播间实时状态决策当前应发起何种动作（action），比如直播间互动氛围差的时候是应该邀评，换卖点讲解还是促单？确定动作后主播知道如何最好的的执行动作，例如怎么把邀评讲出来？说什么话，用什么语气，邀请特定观众还是所有观众。行为决策和行为内容生成两者相结合实现直播间下单，关注，留联等最大化目标。超拟真数字人需要具备上述两种核心能力，即给定一个长期目标（如每场次的订单总数，评论总数，观看时长等），要求数字人1）判断在不同直播间状态下应该做出什么行为，是切换卖点讲解，促单逼单，邀评还是多轮互动？2）确定某种行为后生成适合的的行为内容，如塑品讲解，优惠讲解，促单逼单等的具体口播内容。</p>
<h4 data-id="heading-13"><strong>技术架构</strong></h4>
<p>智能中控架构核心由基于强化学习的决策Agent，和基于一言大模型的多任务融合两个部分组成。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/790be0e44cd64c319c3d7e3f8a0ccf6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=L0Aa8%2FwjKUk1f71Hra6IYWqhCjU%3D" alt="图片" loading="lazy"/></p>
<h5 data-id="heading-14"><strong><strong>基于强化学习的行为决策Agent</strong></strong></h5>
<p>行为决策的目标是在不同直播状态下选择最优动作，最大化长期目标（订单、评论、观看时长等）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/186556a5ded14b7689f0e103ad1bd198~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=XCjczdAU7vLnnWd%2FsbTqGNk84PY%3D" alt="图片" loading="lazy"/></p>
<p>上图展示了直播环境与RL决策Agent的交互流程：</p>
<ul>
<li><strong><strong>状态 St</strong></strong>：观看人数、评论频率、当前商品、用户行为序列、是否有提问等</li>
<li><strong><strong>动作 At</strong></strong>：邀评 / 多轮互动 / 促单 / 动态讲解 / 切换卖点 / 回答问题……</li>
<li><strong><strong>奖励 Rt</strong></strong>：订单数变化、评论数增加、停留时长、转化率提升等</li>
<li>Agent 通过不断试错 &amp; 策略迭代，获得最优策略。</li>
</ul>
<p>这使数字人能够像真人主播一样：氛围低时发起互动，用户观望时进行促单，新观众进入时进行商品介绍。RL 的优势在于目标导向：不是优化单句话，而是优化<strong><strong>整场直播的 KPI</strong></strong>。</p>
<h5 data-id="heading-15"><strong><strong>基于大模型的行为内容生成与融合</strong></strong></h5>
<p>当 RL Agent 选择了一个动作后，例如“促单”，还需要生成对应的动作参数：如促单的口播内容，使用什么语气？内容是偏温和还是强节奏？是否引用当前观众的评论？实践中我们通过强化学习训练了一系列action内容生成专精模型，能够生成特定参数指定的直播内容。</p>
<p>未来我们将以语言模型为基座对决策和内容生成任务进行端到端训练，减少分阶段建模带来的累计误差。</p>
<h2 data-id="heading-16">04 语音克隆与合成</h2>
<p>普通商家原声演绎状态不佳，缺乏带货感。慧播星利用风格迁移TTS技术自动合成感染力强，拟真度高的直播音频。经过两年多的迭代TTS开播使用率从<strong><strong>30.3%提升至92.8% <strong><strong><strong><strong>，<strong><strong>制作时效性从</strong></strong>1</strong></strong></strong></strong>月降低到1分钟。</strong></strong></p>
<p>电商TTS发展主要经历两个阶段：</p>
<p><strong>第一阶段（2023.3~2024.Q2)</strong> **：语音定制工牌麦收音，依赖大量人工传导，整个周期长达一个月</p>
<p><strong>第二阶段（2024.Q3至今)</strong> **：小程序自助收音提高收音效率，自动训练架构升级，抑扬顿挫带货效果持续优化</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e131f912caf45d5a80d85c896fd865b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=mT1FtvGBJm4QE1tuyPqbbmsN5kE%3D" alt="8a3ff4868bef454dc11f0b3d563dfd55.png" loading="lazy"/></p>
<p>第一阶段：工牌麦收音效率低下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bff8f71283b4450ebb997c56d0dd19a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=O%2F8xLTP9rpI%2Bxl2xOimUEiUA5TA%3D" alt="9c59c70847e98a944f17b4d9b65d9842.jpg" loading="lazy"/></p>
<p>第二阶段：小程序自助录制</p>
<p>现状：当前慧播星支持原生和激情带货两种音色克隆，客户仅需在手百小程序上录制15分钟语音，系统在1天内自动为客户生成克隆音（对比如下）。目前慧播星已制作12w多个音色，2.7w多个客户定制音色。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/913244b09c984110b1298a69e25cc16d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=mOgLh40EEfc3eyI84ZyVFLBSoPQ%3D" alt="b8fb96d6e796ac2b84b99e0421469492.png" loading="lazy"/></p>
<p>两种音效可选</p>
<p><strong>1. 原声效果</strong>：还原本人说话特点，如语速和语调</p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fblob%3Ahttps%3A%2F%2Funitools.fun%2Ffb87134d-97ec-42a5-a0a0-b74980b1cfc3" target="_blank" title="http://blob:https://unitools.fun/fb87134d-97ec-42a5-a0a0-b74980b1cfc3" ref="nofollow noopener noreferrer">http://blob:https://unitools.fun/fb87134d-97ec-42a5-a0a0-b74980b1cfc3</a></p>
<p><strong><strong>2. 激情带货效果</strong></strong>：让整体情绪更激昂，抑扬顿挫</p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fblob%3Ahttps%3A%2F%2Funitools.fun%2F85e53903-5672-4988-85ae-19a4c867a607" target="_blank" title="http://blob:https://unitools.fun/85e53903-5672-4988-85ae-19a4c867a607" ref="nofollow noopener noreferrer">http://blob:https://unitools.fun/85e53903-5672-4988-85ae-19a4c867a607</a></p>
<p>未来计划利用海量直播场景的语料数据，进一步<strong>降低克隆门槛</strong>（对齐竞品的30s）、<strong>提升克隆效率</strong>（分钟级可完成克隆进行合成）、<strong>优化朗读效果</strong>（对标直播/视频/讲述/咨询等不同语境的真人） ，同时从单声音的克隆和合成成本达到业内头部领先水平。</p>
<h4 data-id="heading-17">克隆+合成技术架构</h4>
<p>整体架构主要包括离线声纹注册和模型训练，在线合成三个部分。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05cafc99d65448928cc873a2fb1c82d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=dxyOPM5pPPM1kaLd1PezrzvNO%2Fk%3D" alt="图片" loading="lazy"/></p>
<p><strong><strong>△ 形象克隆及合成架构</strong></strong></p>
<h2 data-id="heading-18">05 形象克隆与合成</h2>
<p>主播形象是直播的核心要素，高拟真形象能够提升用户观看时长，进而提升成单效果。慧播星与视觉技术部深度合作，基于2D数字人技术针对直播场景定制形象克隆和合成能力，建设了接近7800+个公共库形象，有效地支撑商家在慧播星的前期探索，为自建形象做好准备。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2038c211400f4c8782963825c774a053~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=ScwJWd6D5YeJ%2FbPGvocNZoUXcgM%3D" alt="图片" loading="lazy"/></p>
<p><strong><strong>△ 慧播星形象制作</strong></strong></p>
<p>形象克隆技术发展主要经历了四个阶段：</p>
<p><strong>第一阶段（2023.3~2023Q4)</strong> ：V1版本唇形驱动方案适配电商直播场景，跑通录制约束较多的**闭嘴且无遮挡录制+**形象克隆流程，建立起第一批公共库形象</p>
<p><strong>第二阶段（2024.Q4~2024.Q2)</strong> ：V3V4版本唇形驱动通过数据建设和模型算法优化<strong>实现张嘴录制和更自然的唇动效果</strong></p>
<p><strong>第三阶段（2024.Q3~2025.Q2)</strong> ：进一步降低录制门槛，支持<strong>录制中遮挡、大幅度侧脸和人脸出镜</strong>。</p>
<p>当前阶段客户仅需上传5分钟左右的自然演绎视频，系统在3小时内即可自动为客户生成克隆形象。时至25年底慧播星已累计<strong>制作<strong><strong>32万多</strong></strong>多个形象，8万多个客户定制形象，线上可用率95%</strong> 。</p>
<p><strong>第三阶段（2025.Q3~至今）：<strong>突破唇形驱动，建设</strong>多人出镜，动作驱动，表情驱动，持物驱动</strong>等下一代形象生成能力（多模协同的超级主播）。</p>
<h4 data-id="heading-19"><strong>视觉技术</strong></h4>
<p>实时场景下早期的唇动方案采用单阶段建模（如wav2lip），输入音频直接输出像素空间的唇形图片。实践中单阶段方案无法达到逼真的唇动效果，后来的商用方案几乎都采用两阶段方案：<strong>第一阶段将音频转化为2D关键点或3D人脸模型作为中间表达，第二阶段将中间表达利用GAN网络解码到像素空间。</strong></p>
<p><strong><strong>视觉生成模型</strong></strong></p>
<p>核心由三个模型组成，<strong><strong>3D人脸重建模型</strong></strong>，<strong><strong>音频到3D人脸生成模型</strong></strong>，<strong><strong>3D空间到像素空间人脸生模型。</strong></strong></p>
<ul>
<li>3D人脸重建利用3DMM将人脸图片（像素）转换为3D mesh（三维空间点）</li>
<li>基于Faceformer改进的音频到3D mesh预估模型，mesh作为中间表达携带了丰富的面部动态，使得生成模型能够生成逼真的唇形图片。</li>
<li>基于StyleGan2改进的人脸生成模型，训练目标包括像素空间的重建损失，特征空间的感知损失，以及对抗生成损失。实现个性化增量微调方案，复用预训练底座只学习每个主播的个性化唇动风格，新形象仅需微调，3小时内完成制作。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/327325ef703c4b1796e8d0b243cd1392~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=OG5fucWulVDUHuKfkdWhfRI01l8%3D" alt="a257f774f7b3f261f4d91b5ac0fac33c.png" loading="lazy"/></p>
<p>模型pipeline</p>
<p><strong><strong>在线合成架构</strong></strong></p>
<p>形象合成以tts音频、底板视频帧和直播间背景为输入，通过生成模型实时合成主播嘴部区域，最后组装成视频流推送给用户。其中任务队列建立缓冲区，保障了视频流的连续性。目前已实现单卡多路流式渲染，支撑2万多直播间同时开播</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cf3daab00bb4870a0c3ddc5ab65f239~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883797&amp;x-signature=Xiv9rg4zpDya87Mk7nrz9IHgrsg%3D" alt="f2a61d2b808afc9c277bca6b01b11654.jpg" loading="lazy"/></p>
<p>在线流式合成架构</p>
<h2 data-id="heading-20">06 总结</h2>
<p>历经两年多的持续打磨与技术突破，慧播星已经从一款数字人直播工具，成长为覆盖脚本生成、实时问答、智能中控、语音克隆、形象合成等多模态全链路的原生 AI 直播平台。它不仅复刻了真人主播的内容表达与带货节奏，更通过商品理解增强、强化学习决策、先验—后验数据飞轮、大规模音视频生成模型等关键技术，实现了“超越真人”的直播能力。随着业务规模的快速扩张与技术体系的持续演进，慧播星已在日均2万+直播间、万级定制形象与音色、覆盖电商与泛行业场景的真实生产环境中验证了 AI 直播的成熟度和商业价值。未来慧播星将继续沿着“更智能、更具说服力、更高效”的方向迭代：让脚本更精准、互动更自然、视觉更逼真、声音更生动、决策更智慧，并通过持续运转的数据飞轮不断突破直播体验的天花板。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RabbitMQ 如何保证消息不丢失和不重复消费？掌握这 4 个关键点就够了]]></title>    <link>https://juejin.cn/post/7581688255625052212</link>    <guid>https://juejin.cn/post/7581688255625052212</guid>    <pubDate>2025-12-09T11:44:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581688255625052212" data-draft-id="7573958996668661787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RabbitMQ 如何保证消息不丢失和不重复消费？掌握这 4 个关键点就够了"/> <meta itemprop="keywords" content="后端,Java,RabbitMQ"/> <meta itemprop="datePublished" content="2025-12-09T11:44:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RabbitMQ 如何保证消息不丢失和不重复消费？掌握这 4 个关键点就够了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T11:44:08.000Z" title="Tue Dec 09 2025 11:44:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在开发中，我们经常用<strong>RabbitMQ</strong>来做系统之间的传话筒。</p>
<p>比如用户下单后，通知库存系统减库存、通知物流系统准备发货。</p>
<p>但问题来了：<strong>万一消息丢了怎么办？或者同一条消息被处理了两次怎么办？</strong></p>
<p>别担心！只要做好以下几点，就能让 RabbitMQ 变得既<strong>可靠</strong>又<strong>安全</strong>。</p>
<hr/>
<h3 data-id="heading-0">消息可能在哪丢？</h3>
<p>假设发快递：</p>
<ul>
<li>你（生产者）把包裹交给快递员（RabbitMQ）；</li>
<li>快递员把包裹送到收件人（消费者）手上。</li>
</ul>
<p>在这个过程中，包裹可能在三个地方出问题：</p>
<ol>
<li><strong>你刚寄出，快递员没收到</strong> → 消息没到 RabbitMQ；</li>
<li><strong>快递员收到了，但仓库门没开</strong> → RabbitMQ 宕机，消息没了；</li>
<li><strong>收件人签收前手机没电了</strong> → 消费者处理失败，消息丢失。</li>
</ol>
<p>所以，我们要从<strong>发送方、中间方、接收方</strong>三处下手！</p>
<h3 data-id="heading-1">先配好配置文件（<code>application.yml</code>）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">rabbitmq:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span>
    <span class="hljs-comment"># 开启 publisher confirm 和 return</span>
    <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">correlated</span>
    <span class="hljs-attr">publisher-returns:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">template:</span>
      <span class="hljs-attr">mandatory:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 使 returns 生效</span>
    <span class="hljs-attr">listener:</span>
      <span class="hljs-attr">simple:</span>
        <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">manual</span>  <span class="hljs-comment"># 手动 ACK</span>
        <span class="hljs-attr">retry:</span>
          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span>  <span class="hljs-comment"># 我们自己控制重试逻辑</span>

  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">1. 声明队列、交换器（持久化！）</h3>
<p>创建队列或交换器时，设置<code>durable=true</code>队列持久化。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMqConfig</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ORDER_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order.exchange"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ORDER_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order.queue"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ORDER_ROUTING_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order.create"</span>;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">orderExchange</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// durable = true（默认就是 true）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(ORDER_EXCHANGE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">orderQueue</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// durable = true</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(ORDER_QUEUE, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">binding</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> BindingBuilder.bind(orderQueue())
                .to(orderExchange())
                .with(ORDER_ROUTING_KEY);
    }
}
</code></pre>
<h3 data-id="heading-3">2. 生产者发送消息（带唯一 ID + Confirm 回调）</h3>
<p>发送消息时，设置 <code>deliveryMode=2</code> 消息持久化。</p>
<p>同时增加异步非阻塞操作，发完消息立刻返回，RabbitMQ 后台异步确认。支持批量确认、单条确认。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderProducer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;

    <span class="hljs-comment">// 生成唯一消息ID（实际可用 UUID 或业务ID）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendOrderMessage</span><span class="hljs-params">(String orderId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">msgId</span> <span class="hljs-operator">=</span> <span class="hljs-string">"msg_"</span> + System.currentTimeMillis(); <span class="hljs-comment">// 简化版唯一ID</span>

        <span class="hljs-type">MessageProperties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageProperties</span>();
        props.setMessageId(msgId); <span class="hljs-comment">// 设置唯一ID，用于幂等</span>
        props.setDeliveryMode(MessageDeliveryMode.PERSISTENT); <span class="hljs-comment">// 持久化</span>

        <span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>((orderId).getBytes(StandardCharsets.UTF_8), props);

        <span class="hljs-comment">// 发送并监听 confirm</span>
        rabbitTemplate.convertAndSend(
            RabbitMqConfig.ORDER_EXCHANGE,
            RabbitMqConfig.ORDER_ROUTING_KEY,
            message,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorrelationData</span>(msgId) <span class="hljs-comment">// CorrelationData 用于关联 confirm</span>
        );

        <span class="hljs-comment">// 设置 confirm 回调</span>
        rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -&gt; {
            <span class="hljs-keyword">if</span> (ack) {
                System.out.println(<span class="hljs-string">"消息已确认送达 RabbitMQ: "</span> + correlationData.getId());
            } <span class="hljs-keyword">else</span> {
                System.err.println(<span class="hljs-string">"消息发送失败: "</span> + cause);
                <span class="hljs-comment">// 可在此处记录日志、重发、存 DB 等</span>
            }
        });

        <span class="hljs-comment">// （可选）设置 return 回调，处理路由失败</span>
        rabbitTemplate.setReturnsCallback(returned -&gt; {
            System.err.println(<span class="hljs-string">"消息无法路由: "</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(returned.getMessage().getBody()));
        });
    }
}
</code></pre>
<p><strong>生产环境建议把失败的消息存入数据库，由定时任务补偿重发。</strong></p>
<p>到这里很多人以为只要设置了<code>durable=true</code>和<code>deliveryMode=2</code>，消息就万无一失了。</p>
<p>其实不然！RabbitMQ 收到持久化消息后，会先写入内存缓冲区，再异步刷盘（fsync）。</p>
<p>如果在这之间服务器断电，消息还是会丢！</p>
<h4 data-id="heading-4">解决方案：</h4>
<p><strong>传统方案</strong>：镜像队列（Mirrored Queue）多节点备份，但存在脑裂、数据不一致风险。</p>
<p><strong>现代方案（RabbitMQ 3.8+）</strong>：Quorum Queue（仲裁队列）</p>
<ul>
<li>基于 Raft 共识算法，强一致性；</li>
<li>自动选主、故障转移；</li>
<li>写入多数节点才返回成功，真正防丢。</li>
</ul>
<p>在SpringBoot中声明 <code>Quorum Queue</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">quorumOrderQueue</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> QueueBuilder
        .durable(<span class="hljs-string">"order.quorum.queue"</span>)
        .quorum() <span class="hljs-comment">// 关键！</span>
        .build();
}
</code></pre>
<hr/>
<h3 data-id="heading-5">3.消费者：手动 ACK + 幂等处理（防重复）</h3>
<p><strong>手动 ACK 是什么？</strong>
等待消费者调用<code>basicAck</code>，收到 ACK 后，才从队列中删除消息。</p>
<p><strong>什么是幂等？</strong>
一个操作执行一次和执行多次，结果完全相同。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderConsumer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CONSUMED_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"mq:consumed:"</span>;

    <span class="hljs-meta">@RabbitListener(queues = RabbitMqConfig.ORDER_QUEUE)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrder</span><span class="hljs-params">(Message message, Channel channel)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">String</span> <span class="hljs-variable">msgId</span> <span class="hljs-operator">=</span> message.getMessageProperties().getMessageId();
        <span class="hljs-type">String</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(message.getBody(), StandardCharsets.UTF_8);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1.幂等检查：是否已处理过？</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> CONSUMED_KEY_PREFIX + msgId;
            <span class="hljs-type">Boolean</span> <span class="hljs-variable">hasConsumed</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(key, <span class="hljs-string">"1"</span>, Duration.ofHours(<span class="hljs-number">24</span>));
            <span class="hljs-keyword">if</span> (Boolean.FALSE.equals(hasConsumed)) {
                System.out.println(<span class="hljs-string">"重复消息，跳过处理: "</span> + msgId);
                channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// 2.处理业务逻辑（比如减库存、发短信）</span>
            System.out.println(<span class="hljs-string">"正在处理订单: "</span> + orderId);

            <span class="hljs-comment">// 模拟业务耗时</span>
            Thread.sleep(<span class="hljs-number">1000</span>);

            <span class="hljs-comment">// 3.业务成功 → 手动 ACK</span>
            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);
            System.out.println(<span class="hljs-string">"消费成功，已 ACK: "</span> + msgId);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"消费失败: "</span> + e.getMessage());
            <span class="hljs-comment">// 拒绝消息，不 requeue（避免死循环），或根据策略决定是否重试</span>
            channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);
            <span class="hljs-comment">// 或者：basicReject + 记录到死信队列</span>
        }
    }
}
</code></pre>
<p>关键点：</p>
<ul>
<li><code>setIfAbsent</code> 实现 Redis 分布式锁式去重；</li>
<li><strong>先检查幂等，再处理业务，最后 ACK</strong>；</li>
<li>异常时用 <code>basicNack</code> 拒绝消息，避免无限重试。</li>
</ul>
<hr/>
<h3 data-id="heading-6">完整可靠性链路图</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[生产者]</span>
   │
   ├── 开启 Confirm → 确保消息到达 Broker
   └── 消息带唯一ID → 用于后续幂等
        │
        ▼
<span class="hljs-section">[RabbitMQ Broker]</span>
   ├── 队列/交换器持久化
   ├── 消息持久化（<span class="hljs-attr">deliveryMode</span>=<span class="hljs-number">2</span>）
   └── 使用 Quorum Queue（高可用+强一致）
        │
        ▼
<span class="hljs-section">[消费者]</span>
   ├── 手动 ACK（<span class="hljs-attr">autoAck</span>=<span class="hljs-literal">false</span>）
   ├── 先查幂等（Redis/setIfAbsent）
   ├── 再执行业务
   └── 最后 ACK（失败则 NACK 或进死信队列）
</code></pre>
<hr/>
<h3 data-id="heading-7">常见误区</h3>

























<table><thead><tr><th>误区</th><th>正确做法</th></tr></thead><tbody><tr><td>“开了持久化就不会丢”</td><td>还需 Confirm + 高可用队列</td></tr><tr><td>“自动 ACK 更简单”</td><td>自动 ACK 极易丢消息！必须手动</td></tr><tr><td>“RabbitMQ 能保证不重复”</td><td>不能！必须消费者自己幂等</td></tr><tr><td>“消息ID用时间戳就行”</td><td>时间戳可能重复！建议用 UUID 或雪花ID</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">总结</h3>
<p>保证 RabbitMQ 消息不丢和不重复，记住这四个关键点：</p>
<p><strong>1. 生产者确认（Confirm）</strong></p>
<ul>
<li>开启 <code>publisher-confirm</code>，确保消息成功发到 RabbitMQ。</li>
</ul>
<p><strong>2. 消息持久化</strong></p>
<ul>
<li>队列和消息都设置成持久化，防止 RabbitMQ 重启后数据丢失。</li>
</ul>
<p><strong>3. 消费者手动确认（ACK）</strong></p>
<ul>
<li>关闭自动 ACK，业务处理成功后，再手动确认消息。</li>
</ul>
<p><strong>4. 消费幂等性</strong></p>
<ul>
<li>每条消息带唯一 ID，消费者先检查是否处理过，避免重复消费。</li>
</ul>
<p><strong>简单来说：</strong></p>
<ul>
<li><strong>防丢失</strong>：Confirm + 持久化 + 手动 ACK</li>
<li><strong>防重复</strong>：消息唯一 ID + 幂等检查</li>
</ul>
<p>没有100%的不丢失，只有无限接近99.99%的可靠性。</p>
<p>做好这四点，你的 RabbitMQ 就足够可靠了！</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-9">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F6V83qjR6u0nyfzL-14xYAw" target="_blank" title="https://mp.weixin.qq.com/s/6V83qjR6u0nyfzL-14xYAw" ref="nofollow noopener noreferrer">《async/await 到底要不要加 try-catch？异步错误处理最佳实践》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPQ_w7CDVoIZPn-CVH2DKJg" target="_blank" title="https://mp.weixin.qq.com/s/PQ_w7CDVoIZPn-CVH2DKJg" ref="nofollow noopener noreferrer">《Vue3 和 Vue2 的核心区别？很多开发者都没完全搞懂的 10 个细节》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fp0n2mN5RDDDaIWuHHVRUZQ" target="_blank" title="https://mp.weixin.qq.com/s/p0n2mN5RDDDaIWuHHVRUZQ" ref="nofollow noopener noreferrer">《Java 开发必看：什么时候用 for，什么时候用 Stream？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqI3TRTdDfRJSH9kCTqAQUw" target="_blank" title="https://mp.weixin.qq.com/s/qI3TRTdDfRJSH9kCTqAQUw" ref="nofollow noopener noreferrer">《这 10 个 MySQL 高级用法，让你的代码又快又好看》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Scheduler为何采用MessageChannel调度?]]></title>    <link>https://juejin.cn/post/7581678032336240682</link>    <guid>https://juejin.cn/post/7581678032336240682</guid>    <pubDate>2025-12-09T09:43:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581678032336240682" data-draft-id="7581428845683884075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Scheduler为何采用MessageChannel调度? "/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-09T09:43:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="原来是小仙女呀"/> <meta itemprop="url" content="https://juejin.cn/user/1239904846362055"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Scheduler为何采用MessageChannel调度? 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904846362055/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    原来是小仙女呀
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T09:43:59.000Z" title="Tue Dec 09 2025 09:43:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style>





















































<table><thead><tr><th>特性</th><th><strong>setTimeout</strong></th><th><strong>requestAnimationFrame</strong></th><th><strong>requestIdleCallback</strong></th><th><strong>MessageChannel</strong></th></tr></thead><tbody><tr><td><strong>本质</strong></td><td>定时器宏任务</td><td>动画回调钩子</td><td>空闲期回调钩子</td><td>消息通信宏任务</td></tr><tr><td><strong>执行时机</strong></td><td>延迟指定毫秒后（不精确）</td><td><strong>下一帧渲染之前</strong>（与刷新率同步）</td><td><strong>浏览器空闲时</strong>（一帧的末尾）</td><td><strong>下一轮事件循环</strong>（作为宏任务）</td></tr><tr><td><strong>主要设计目的</strong></td><td>延迟执行代码</td><td>实现流畅动画</td><td>执行低优先级后台任务</td><td>不同上下文间通信</td></tr><tr><td><strong>关键优势</strong></td><td>通用、灵活、兼容性好</td><td><strong>动画流畅、节能</strong>（后台暂停）</td><td><strong>不阻塞渲染与交互</strong>，利用空闲时间</td><td><strong>延迟极短且稳定</strong>，可精准控制任务切片</td></tr><tr><td><strong>关键缺陷</strong></td><td><strong>时序不精确</strong>，嵌套有最小延迟（如4ms）</td><td><strong>依赖渲染周期</strong>，执行频率固定（~16.7ms）</td><td><strong>执行时机不可控</strong>，可能长期得不到调用</td><td><strong>非用于调度</strong>，是“创造性”用法</td></tr><tr><td><strong>React调度的适用性</strong></td><td>❌ 延迟不可控，不适合精细调度</td><td>❌ 依赖渲染节奏，无法在帧中多次调度</td><td>❌ 时机不可靠，无法满足及时响应需求</td><td>✅ <strong>在事件循环中及时插入任务，实现可中断调度的理想选择</strong></td></tr></tbody></table>
<h3 data-id="heading-0">📝 各API功能与特性详解</h3>
<p>下面我们来具体看看每个API的核心工作机制和适用场景。</p>
<ol>
<li>
<p><strong>setTimeout</strong></p>
<ul>
<li><strong>功能</strong>：最基础的异步定时器，用于在指定的延迟（毫秒）后，将回调函数推入任务队列等待执行</li>
<li><strong>执行机制</strong>：它设置的是一个“<strong>最小延迟</strong>”，而非精确时间。回调的实际执行时间会受到主线程上其他任务（如同步代码、微任务、UI渲染）的阻塞，延迟可能远大于设定值</li>
<li><strong>使用场景</strong>：适用于对时间精度要求不高的延迟操作，如防抖/节流、轮询检查等。</li>
</ul>
</li>
<li>
<p><strong>requestAnimationFrame</strong></p>
<ul>
<li><strong>功能</strong>：专为动画设计的API，其回调函数会在<strong>浏览器下一次重绘（即绘制下一帧）之前执行</strong></li>
<li><strong>执行机制</strong>：与显示器的刷新率（通常是60Hz，约16.7ms/帧）同步。浏览器会自动优化调用，在页面不可见时（如标签页被隐藏）会自动暂停，以节省资源</li>
<li><strong>使用场景</strong>：<strong>实现任何需要平滑过渡的动画效果</strong>，是替代<code>setTimeout</code>做动画的最佳实践</li>
</ul>
</li>
<li>
<p><strong>requestIdleCallback</strong></p>
<ul>
<li><strong>功能</strong>：允许你在<strong>浏览器空闲时期</strong>调度低优先级任务</li>
<li><strong>执行机制</strong>：在<strong>一帧处理完用户输入、<code>requestAnimationFrame</code>回调、布局和绘制等关键任务后，如果还有剩余时间</strong>，才会执行它的回调回调函数会接收一个<code>IdleDeadline</code>参数，告诉你当前帧还剩余多少空闲时间</li>
<li><strong>使用场景</strong>：适合执行一些非紧急的后台任务，如数据上报、非关键的数据预取等。</li>
</ul>
</li>
<li>
<p><strong>MessageChannel</strong></p>
<ul>
<li><strong>功能</strong>：用于在不同浏览器上下文（如两个iframe、主线程与Web Worker）间建立双向通信的通道</li>
<li><strong>执行机制</strong>：调用<code>port.postMessage()</code>方法，会向<strong>消息队列添加一个宏任务</strong>。这个任务会在当前事件循环的微任务执行完毕后、下一次事件循环中执行。</li>
<li><strong>使用场景</strong>：主要应用于跨上下文通信。它在React调度中的用法，是利用其<strong>能产生一个在下一轮事件循环中尽早执行的宏任务</strong>的特性。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-1">⚙️ 为什么React最终选择了MessageChannel？</h3>
<p>React调度器的核心目标是：<strong>实现可中断的并发渲染，将长任务切成小片，在每一帧中插入执行，同时能快速响应高优先级更新</strong>。这就要求调度器能主动、及时地“让出”主线程。</p>
<p>结合上表和分析，其他API不适用于此的原因如下：</p>
<ul>
<li><strong><code>setTimeout</code></strong>：<strong>延迟不稳定且不可控</strong>。其最小延迟（如4ms）在密集调度时会造成浪费，更严重的是，延迟时间可能被拉长，导致调度器无法在预期时间内“苏醒”并交还主线程，影响页面响应</li>
<li><strong><code>requestAnimationFrame</code></strong>：<strong>调用频率被锁死在屏幕刷新率（约16.7ms一次）</strong> 。这意味着即便一帧中有大量空闲时间，调度器也无法插入更多任务切片，无法充分利用帧内的空闲资源</li>
<li><strong><code>requestIdleCallback</code></strong>：<strong>执行时机“太被动”且不稳定</strong>。它依赖于浏览器的“空闲通知”，但空闲期可能很短或很久都不出现。对于需要主动、可预测地进行任务切片的调度器来说，这不可靠，同时，其兼容性也不够理想。</li>
</ul>
<p><strong><code>MessageChannel</code>的优势</strong>正在于解决了上述问题：</p>
<ol>
<li><strong>主动且及时的调度</strong>：通过<code>port.postMessage()</code>，React可以<strong>主动</strong>在下一个事件循环中创建一个宏任务来继续工作。这让调度器能精确地在每个5ms左右的时间片（这是React设定的切片时间目标<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.cn%2Fdeveloper%2Farticle%2F2440386" target="_blank" title="https://cloud.tencent.cn/developer/article/2440386" ref="nofollow noopener noreferrer">-7</a>）结束后“中断”自己，及时归还主线程给浏览器进行渲染或处理交互。</li>
<li><strong>更高的执行频率</strong>：它不依赖屏幕刷新率，可以在<strong>同一帧内的多次事件循环中连续调度</strong>，从而更密集、更充分地利用一帧之内的计算资源。</li>
<li><strong>避免微任务的弊端</strong>：为什么不直接用<code>Promise</code>（微任务）？因为微任务会在当前事件循环中<strong>连续执行直到队列清空</strong>，这同样会长时间阻塞主线程，达不到“可中断”的目的</li>
</ol>
<h3 data-id="heading-2">💎 总结</h3>
<p>React选择<code>MessageChannel</code>，是基于其<strong>能产生一个在事件循环中及时、稳定执行的宏任务</strong>这一特性。这为React实现<strong>主动、可中断、基于时间片的任务调度</strong>提供了最合适的底层机制，从而在实现并发渲染的同时，保障了浏览器的渲染和用户交互能获得最高优先级的响应。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[webpack和vite区别及原理实现]]></title>    <link>https://juejin.cn/post/7581698074360971273</link>    <guid>https://juejin.cn/post/7581698074360971273</guid>    <pubDate>2025-12-09T09:52:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581698074360971273" data-draft-id="7581658157145358386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="webpack和vite区别及原理实现"/> <meta itemprop="keywords" content="Vite,Webpack,掘金·金石计划"/> <meta itemprop="datePublished" content="2025-12-09T09:52:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="光影少年"/> <meta itemprop="url" content="https://juejin.cn/user/3184663905962126"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            webpack和vite区别及原理实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3184663905962126/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    光影少年
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T09:52:08.000Z" title="Tue Dec 09 2025 09:52:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>Webpack</strong> 和 <strong>Vite</strong> 都是用于构建现代前端应用的构建工具，它们在原理和实现上有显著的区别。下面我将详细比较它们的异同，帮助你了解两者的工作原理以及各自的优势。</p>
<hr/>
<h2 data-id="heading-0">✅ <strong>一、Webpack 和 Vite 的核心区别</strong></h2>








































<table><thead><tr><th>特性</th><th>Webpack</th><th>Vite</th></tr></thead><tbody><tr><td><strong>构建速度</strong></td><td>较慢，特别是大型项目</td><td>快，几乎是即时的</td></tr><tr><td><strong>构建原理</strong></td><td>通过打包所有资源，生成最终的 bundle</td><td>采用按需编译，利用浏览器原生支持 ES 模块</td></tr><tr><td><strong>开发模式</strong></td><td>一开始就进行全部的打包，编译速度较慢</td><td>通过浏览器原生支持 ES Modules，只有请求的模块才会被处理</td></tr><tr><td><strong>构建产物</strong></td><td>生成一个或多个 bundle 文件</td><td>基于 ES Module 按需加载，不同于 Webpack 完整的打包</td></tr><tr><td><strong>支持类型</strong></td><td>支持所有 JavaScript，CSS，图片，字体等</td><td>主要支持 ES 模块，针对现代浏览器优化</td></tr><tr><td><strong>使用体验</strong></td><td>配置复杂，适用于各种需求和优化</td><td>配置简单，适合快速开发，但功能不如 Webpack 灵活</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-1">✅ <strong>二、Webpack 原理和实现</strong></h2>
<h4 data-id="heading-2"><strong>1. 传统的打包工具</strong></h4>
<p>Webpack 是一个 <strong>模块打包器</strong>，它将所有的静态资源（JavaScript、CSS、图片等）当作模块处理，并生成一个或多个 bundle 文件，最终这些文件将被浏览器加载。</p>
<h4 data-id="heading-3"><strong>2. 打包过程：</strong></h4>
<p>Webpack 的打包过程主要包含以下几个阶段：</p>
<ol>
<li>
<p><strong>解析阶段（Parsing）</strong></p>
<ul>
<li>Webpack 从入口文件（entry）开始，递归地解析每一个依赖，生成依赖图。</li>
<li>在解析时，Webpack 会调用 <strong>loader</strong> 对不同类型的文件进行预处理（如 Babel 转译、Sass 编译等）。</li>
</ul>
</li>
<li>
<p><strong>构建阶段（Building）</strong></p>
<ul>
<li>Webpack 会通过 <strong>loader</strong> 和 <strong>plugin</strong> 处理所有模块，生成最终的 <strong>AST（抽象语法树）</strong> 。</li>
<li>使用 <strong>module bundling</strong> 将所有模块合并成一个或多个文件（bundle）。</li>
</ul>
</li>
<li>
<p><strong>优化阶段（Optimization）</strong></p>
<ul>
<li>Webpack 会对生成的 bundle 进行优化，如：分割代码（Code Splitting）、压缩（Terser）等。</li>
</ul>
</li>
<li>
<p><strong>输出阶段（Output）</strong></p>
<ul>
<li>最终将 bundle 输出到指定的目录，并生成相应的文件供浏览器使用。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-4"><strong>3. Webpack 需要时间打包所有资源</strong></h4>
<p>由于 Webpack 会将所有资源都打包成一个或多个文件，所以当你做 <code>webpack --mode development</code> 命令时，它必须编译所有文件，这就导致开发过程中启动时间较长。</p>
<hr/>
<h2 data-id="heading-5">✅ <strong>三、Vite 原理和实现</strong></h2>
<h4 data-id="heading-6"><strong>1. 基于浏览器原生支持的 ES Modules</strong></h4>
<p>Vite 的核心原理是利用浏览器原生支持 <strong>ES Modules</strong>，它并不像 Webpack 那样进行完整的打包，而是通过 <strong>按需加载</strong> 来提高构建速度。</p>
<h4 data-id="heading-7"><strong>2. Vite 开发流程：</strong></h4>
<p>Vite 的开发过程分为两个阶段：</p>
<h5 data-id="heading-8"><strong>开发阶段：</strong></h5>
<ol>
<li>
<p><strong>按需编译</strong>：</p>
<ul>
<li>当你启动 Vite 时，它不会一次性打包整个项目，而是仅对 <strong>首次请求的模块</strong> 进行编译和服务。比如，只有用户第一次访问某个页面时，Vite 才会编译该页面依赖的 JavaScript 和 CSS。</li>
</ul>
</li>
<li>
<p><strong>热模块替换（HMR）</strong> ：</p>
<ul>
<li>Vite 提供了 <strong>即时的热模块替换</strong>，当你在开发过程中修改了某个模块，Vite 会只编译并替换该模块，而不是重新打包整个项目。这大大提高了开发体验。</li>
</ul>
</li>
</ol>
<h5 data-id="heading-9"><strong>构建阶段：</strong></h5>
<ol start="3">
<li>
<p><strong>生产构建（build）</strong> ：</p>
<ul>
<li>在生产环境下，Vite 使用 <strong>Rollup</strong>（一个现代的 JavaScript 打包工具）进行最终的打包，将所有模块合并成一个优化过的 bundle，进行代码拆分，压缩等优化，生成最终的静态文件。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-10"><strong>3. 不需要一直打包全部资源</strong></h4>
<p>Vite 的按需编译和快速响应机制，使得开发过程非常迅速。只有在页面访问时，才会处理该页面的依赖，避免了 Webpack 那种完全打包的性能消耗。</p>
<hr/>
<h2 data-id="heading-11">✅ <strong>四、Webpack 与 Vite 优缺点对比</strong></h2>








































<table><thead><tr><th>特性</th><th>Webpack</th><th>Vite</th></tr></thead><tbody><tr><td><strong>构建速度</strong></td><td>较慢（尤其是大型项目时）</td><td>极快，尤其是冷启动和热更新</td></tr><tr><td><strong>配置复杂性</strong></td><td>配置较为复杂，需要处理许多细节</td><td>配置简单，开箱即用，少配置即可</td></tr><tr><td><strong>开发体验</strong></td><td>开发中每次更改都会触发完整编译</td><td>热更新速度快，修改后的内容即时反应</td></tr><tr><td><strong>支持的功能</strong></td><td>功能强大，支持的插件丰富，几乎无所不包</td><td>适合现代前端开发，特性较为简洁和聚焦</td></tr><tr><td><strong>构建产物</strong></td><td>生成一个或多个较大的 bundle</td><td>生成多个按需加载的小文件</td></tr><tr><td><strong>适用场景</strong></td><td>适合中大型复杂项目，支持更多自定义需求</td><td>适合中小型项目、现代前端框架（如 React/Vue）</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-12">✅ <strong>五、总结</strong></h2>
<ol>
<li>
<p><strong>Webpack：</strong></p>
<ul>
<li>适用于复杂的前端项目，支持插件和加载器的灵活扩展。</li>
<li>在开发时，启动和热更新较慢，尤其是大型项目。</li>
<li>配置复杂，需要更多的手动配置来实现项目定制。</li>
</ul>
</li>
<li>
<p><strong>Vite：</strong></p>
<ul>
<li>更适合现代前端开发，特别是对开发速度和用户体验有高要求的场景。</li>
<li>使用浏览器原生的 ES Modules 来实现按需编译和即时热更新，开发体验极佳。</li>
<li>适用于现代前端框架（如 Vue、React），并在生产环境中使用 Rollup 进行高效构建。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-13">📌 <strong>推荐场景：</strong></h2>
<ul>
<li><strong>Webpack</strong> 适合 <strong>大型、复杂的前端项目</strong>，尤其是有多种技术栈、框架，或者需要更多自定义构建的项目。</li>
<li><strong>Vite</strong> 更适合 <strong>快速开发、现代化前端应用</strong>，尤其是小型或中型项目，或者想要享受极速开发体验的团队。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MFC核心架构深度解析]]></title>    <link>https://juejin.cn/post/7581097111896277046</link>    <guid>https://juejin.cn/post/7581097111896277046</guid>    <pubDate>2025-12-08T10:28:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581097111896277046" data-draft-id="7581210455827365924" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MFC核心架构深度解析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-08T10:28:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MFC核心架构深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T10:28:39.000Z" title="Mon Dec 08 2025 10:28:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读42分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>尽管MFC（Microsoft Foundation Classes）常被视为“过时”的遗留技术，但其设计思想对理解Windows编程本质和框架设计哲学仍具重要价值。作为一套经典的C++框架，MFC成功将过程式的Win32 API封装为面向对象的类库，其消息映射机制和文档/视图架构体现了早期框架设计者对软件复杂性的深刻思考。本文旨在系统性剖析MFC的核心架构，为开发者提供一个结构化的认知框架。</p>
<h2 data-id="heading-0">第一章：MFC的消息映射机制——Windows事件驱动的革命性封装</h2>
<h3 data-id="heading-1">一、Win32 SDK的原始困境：集中式消息处理的复杂性</h3>
<p>在深入理解MFC的消息映射之前，必须首先审视传统Win32 SDK编程的消息处理模式。这种模式的核心是一个集中式的窗口过程函数（Window Procedure，简称WndProc），它接收并处理发送到窗口的所有消息。</p>
<p>典型的Win32 SDK消息处理代码如下所示：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">LRESULT CALLBACK <span class="hljs-title">WndProc</span><span class="hljs-params">(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)</span>
</span>{
    <span class="hljs-keyword">switch</span> (message)
    {
        <span class="hljs-keyword">case</span> WM_PAINT:
        {
            PAINTSTRUCT ps;
            HDC hdc = <span class="hljs-built_in">BeginPaint</span>(hWnd, &amp;ps);
            <span class="hljs-comment">// 绘图代码...</span>
            <span class="hljs-built_in">EndPaint</span>(hWnd, &amp;ps);
        }
        <span class="hljs-keyword">break</span>;
        
        <span class="hljs-keyword">case</span> WM_MOUSEMOVE:
        {
            <span class="hljs-type">int</span> xPos = <span class="hljs-built_in">LOWORD</span>(lParam);
            <span class="hljs-type">int</span> yPos = <span class="hljs-built_in">HIWORD</span>(lParam);
            <span class="hljs-comment">// 处理鼠标移动...</span>
        }
        <span class="hljs-keyword">break</span>;
        
        <span class="hljs-keyword">case</span> WM_COMMAND:
        {
            <span class="hljs-type">int</span> wmId = <span class="hljs-built_in">LOWORD</span>(wParam);
            <span class="hljs-keyword">switch</span> (wmId)
            {
                <span class="hljs-keyword">case</span> IDM_FILE_OPEN:
                    <span class="hljs-comment">// 处理文件打开...</span>
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> IDM_FILE_SAVE:
                    <span class="hljs-comment">// 处理文件保存...</span>
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-comment">// 更多菜单项...</span>
            }
        }
        <span class="hljs-keyword">break</span>;
        
        <span class="hljs-keyword">case</span> WM_DESTROY:
            <span class="hljs-built_in">PostQuitMessage</span>(<span class="hljs-number">0</span>);
            <span class="hljs-keyword">break</span>;
            
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">DefWindowProc</span>(hWnd, message, wParam, lParam);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>这种模式存在几个显著问题：</p>
<ol>
<li><strong>代码膨胀</strong>：随着消息类型的增加，switch-case语句变得异常庞大，一个成熟的应用程序可能处理数百种消息类型，导致代码可读性急剧下降。</li>
<li><strong>高度耦合</strong>：所有消息处理逻辑集中在单一函数中，不同类型的消息处理代码相互交织，难以模块化。</li>
<li><strong>维护困难</strong>：添加新消息处理或修改现有逻辑时，需要在庞大的switch-case结构中定位，容易引入错误。</li>
</ol>
<h3 data-id="heading-2">二、MFC的解决方案：面向对象的消息映射机制</h3>
<p>MFC的消息映射机制是对上述问题的革命性改进。它基于两个核心设计原则：</p>
<ol>
<li><strong>分散处理</strong>：将消息处理分散到各个窗口类中，每个类只处理与自己相关的消息。</li>
<li><strong>编译时绑定</strong>：通过宏在编译时建立消息到处理函数的映射关系，避免运行时的类型判断开销。</li>
</ol>
<h4 data-id="heading-3">2.1 消息映射的实现机制</h4>
<p>消息映射的实现依赖于一组精心设计的宏和静态数据结构。以下是其核心实现机制：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 典型的MFC类消息映射声明</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CMyWnd</span> : <span class="hljs-keyword">public</span> CWnd
{
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">CMyWnd</span>();
    
<span class="hljs-keyword">protected</span>:
    <span class="hljs-comment">// 消息处理函数声明</span>
    <span class="hljs-function">afx_msg <span class="hljs-type">void</span> <span class="hljs-title">OnPaint</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function">afx_msg <span class="hljs-type">void</span> <span class="hljs-title">OnMouseMove</span><span class="hljs-params">(UINT nFlags, CPoint point)</span></span>;
    <span class="hljs-function">afx_msg <span class="hljs-type">void</span> <span class="hljs-title">OnFileOpen</span><span class="hljs-params">()</span></span>;
    
    <span class="hljs-comment">// 关键：声明消息映射</span>
    <span class="hljs-built_in">DECLARE_MESSAGE_MAP</span>()
};

<span class="hljs-comment">// 实现文件中的消息映射定义</span>
<span class="hljs-built_in">BEGIN_MESSAGE_MAP</span>(CMyWnd, CWnd)
    <span class="hljs-built_in">ON_WM_PAINT</span>()
    <span class="hljs-built_in">ON_WM_MOUSEMOVE</span>()
    <span class="hljs-built_in">ON_COMMAND</span>(ID_FILE_OPEN, &amp;CMyWnd::OnFileOpen)
<span class="hljs-built_in">END_MESSAGE_MAP</span>()
</code></pre>
<h4 data-id="heading-4">2.2 消息映射表的内部结构</h4>
<p>当编译器处理上述代码时，会生成类似下面的静态数据结构：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 消息映射表条目结构（简化版本）</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">AFX_MSGMAP_ENTRY</span>
{
    UINT nMessage;      <span class="hljs-comment">// Windows消息ID</span>
    UINT nCode;         <span class="hljs-comment">// 控件通知码或其它</span>
    UINT nID;           <span class="hljs-comment">// 控件ID（命令消息用）</span>
    UINT nLastID;       <span class="hljs-comment">// 控件ID范围结束（用于范围映射）</span>
    UINT nSig;          <span class="hljs-comment">// 函数签名类型</span>
    AFX_PMSG pfn;       <span class="hljs-comment">// 指向成员函数的指针</span>
};

<span class="hljs-comment">// 为CMyWnd类生成的消息映射表</span>
<span class="hljs-type">static</span> <span class="hljs-type">const</span> AFX_MSGMAP_ENTRY _messageEntries[] =
{
    <span class="hljs-comment">// 标准Windows消息</span>
    { WM_PAINT, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, AfxSig_vv, (AFX_PMSG)&amp;CMyWnd::OnPaint },
    { WM_MOUSEMOVE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, AfxSig_vwp, (AFX_PMSG)&amp;CMyWnd::OnMouseMove },
    
    <span class="hljs-comment">// 命令消息</span>
    { WM_COMMAND, <span class="hljs-number">0</span>, ID_FILE_OPEN, ID_FILE_OPEN, AfxSig_vv, 
      (AFX_PMSG)&amp;CMyWnd::OnFileOpen },
      
    <span class="hljs-comment">// 结束标记</span>
    { <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, AfxSig_end, (AFX_PMSG)<span class="hljs-number">0</span> }
};
</code></pre>
<h4 data-id="heading-5">2.3 消息派发流程</h4>
<p>MFC框架的消息派发过程遵循明确的算法：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 伪代码展示MFC消息派发逻辑</span>
<span class="hljs-function">LRESULT <span class="hljs-title">CWnd::WindowProc</span><span class="hljs-params">(UINT message, WPARAM wParam, LPARAM lParam)</span>
</span>{
    <span class="hljs-comment">// 1. 获取当前类的消息映射表</span>
    <span class="hljs-type">const</span> AFX_MSGMAP* pMessageMap = <span class="hljs-built_in">GetMessageMap</span>();
    
    <span class="hljs-comment">// 2. 沿着继承链向上查找消息处理函数</span>
    <span class="hljs-keyword">while</span> (pMessageMap != <span class="hljs-literal">NULL</span>)
    {
        <span class="hljs-comment">// 在当前类的消息映射表中查找</span>
        <span class="hljs-type">const</span> AFX_MSGMAP_ENTRY* pEntries = pMessageMap-&gt;lpEntries;
        
        <span class="hljs-keyword">for</span> (; pEntries-&gt;nSig != AfxSig_end; pEntries++)
        {
            <span class="hljs-keyword">if</span> (pEntries-&gt;nMessage == message)
            {
                <span class="hljs-comment">// 找到匹配项，调用处理函数</span>
                <span class="hljs-keyword">union</span> <span class="hljs-title class_">MessageMapFunctions</span> mmf;
                mmf.pfn = pEntries-&gt;pfn;
                
                <span class="hljs-comment">// 根据函数签名调用相应的处理函数</span>
                <span class="hljs-keyword">switch</span> (pEntries-&gt;nSig)
                {
                    <span class="hljs-keyword">case</span> AfxSig_vv:  <span class="hljs-comment">// void func(void)</span>
                        (<span class="hljs-keyword">this</span>-&gt;*mmf.pfn_vv)();
                        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
                        
                    <span class="hljs-keyword">case</span> AfxSig_vwp: <span class="hljs-comment">// void func(UINT, CPoint)</span>
                        (<span class="hljs-keyword">this</span>-&gt;*mmf.pfn_vwp)(wParam, 
                                            <span class="hljs-built_in">CPoint</span>(<span class="hljs-built_in">GET_X_LPARAM</span>(lParam), 
                                                  <span class="hljs-built_in">GET_Y_LPARAM</span>(lParam)));
                        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
                    <span class="hljs-comment">// 更多函数签名处理...</span>
                }
            }
        }
        
        <span class="hljs-comment">// 3. 未找到则继续在基类中查找</span>
        pMessageMap = pMessageMap-&gt;pBaseMessageMap;
    }
    
    <span class="hljs-comment">// 4. 未找到任何处理函数，调用默认窗口过程</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">DefWindowProc</span>(message, wParam, lParam);
}
</code></pre>
<h3 data-id="heading-6">三、消息映射的分类与高级特性</h3>
<h4 data-id="heading-7">3.1 四类消息及其处理方式</h4>
<p>MFC将Windows消息系统性地分为四类，每类有不同的映射宏和处理模式：</p>








































<table><thead><tr><th>消息类型</th><th>典型示例</th><th>映射宏</th><th>处理函数特征</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>标准Windows消息</strong></td><td>WM_PAINT, WM_SIZE</td><td><code>ON_WM_XXXX()</code></td><td>固定签名，如<code>OnPaint()</code></td><td>窗口绘制、大小调整等基础操作</td></tr><tr><td><strong>命令消息</strong></td><td>菜单点击、工具栏按钮</td><td><code>ON_COMMAND(id, func)</code></td><td>无参数void函数</td><td>用户命令响应</td></tr><tr><td><strong>控件通知消息</strong></td><td>按钮点击通知、列表项选择</td><td><code>ON_NOTIFY(code, id, func)</code></td><td>接收NMHDR结构体</td><td>复杂控件交互</td></tr><tr><td><strong>反射消息</strong></td><td>WM_CTLCOLOR, WM_DRAWITEM</td><td><code>ON_WM_CTLCOLOR_REFLECT()</code></td><td>子控件自我处理</td><td>控件自定义绘制</td></tr></tbody></table>
<h4 data-id="heading-8">3.2 消息反射机制</h4>
<p>消息反射是MFC中一个巧妙的设计，它允许子控件处理通常由父窗口处理的消息。这种机制通过以下步骤实现：</p>
<ol>
<li>父窗口收到子控件的通知消息（如WM_CTLCOLOR）</li>
<li>MFC框架检查子控件是否能处理反射消息</li>
<li>如果能，将消息反射回子控件</li>
<li>子控件在自己的消息映射表中处理反射消息</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 自定义按钮类处理反射消息的示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CMyButton</span> : <span class="hljs-keyword">public</span> CButton
{
    <span class="hljs-built_in">DECLARE_MESSAGE_MAP</span>()
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">afx_msg HBRUSH <span class="hljs-title">CtlColor</span><span class="hljs-params">(CDC* pDC, UINT nCtlColor)</span></span>;
};

<span class="hljs-built_in">BEGIN_MESSAGE_MAP</span>(CMyButton, CButton)
    <span class="hljs-built_in">ON_WM_CTLCOLOR_REFLECT</span>()  <span class="hljs-comment">// 反射消息处理</span>
<span class="hljs-built_in">END_MESSAGE_MAP</span>()

<span class="hljs-function">HBRUSH <span class="hljs-title">CMyButton::CtlColor</span><span class="hljs-params">(CDC* pDC, UINT nCtlColor)</span>
</span>{
    <span class="hljs-comment">// 按钮自行决定背景色，而不是由对话框统一控制</span>
    pDC-&gt;<span class="hljs-built_in">SetTextColor</span>(<span class="hljs-built_in">RGB</span>(<span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>));  <span class="hljs-comment">// 红色文字</span>
    pDC-&gt;<span class="hljs-built_in">SetBkColor</span>(<span class="hljs-built_in">RGB</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>));  <span class="hljs-comment">// 黄色背景</span>
    
    <span class="hljs-function"><span class="hljs-type">static</span> CBrush <span class="hljs-title">yellowBrush</span><span class="hljs-params">(RGB(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>))</span></span>;
    <span class="hljs-keyword">return</span> yellowBrush;
}
</code></pre>
<h4 data-id="heading-9">3.3 消息范围映射</h4>
<p>对于处理一系列连续ID的相似命令，MFC提供了消息范围映射机制：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 处理ID从ID_TOOL_BUTTON_FIRST到ID_TOOL_BUTTON_LAST的所有工具栏按钮</span>
<span class="hljs-built_in">BEGIN_MESSAGE_MAP</span>(CMyView, CView)
    <span class="hljs-built_in">ON_COMMAND_RANGE</span>(ID_TOOL_BUTTON_FIRST, ID_TOOL_BUTTON_LAST, OnToolButtonClicked)
<span class="hljs-built_in">END_MESSAGE_MAP</span>()

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyView::OnToolButtonClicked</span><span class="hljs-params">(UINT nID)</span>
</span>{
    <span class="hljs-comment">// 根据具体ID执行相应操作</span>
    <span class="hljs-type">int</span> buttonIndex = nID - ID_TOOL_BUTTON_FIRST;
    <span class="hljs-comment">// 处理逻辑...</span>
}
</code></pre>
<h3 data-id="heading-10">四、消息映射的性能与设计权衡</h3>
<h4 data-id="heading-11">4.1 性能分析</h4>
<p>MFC消息映射机制在性能上做出了以下权衡：</p>
<ol>
<li><strong>空间换时间</strong>：为每个窗口类生成静态消息映射表，占用额外内存，但避免了运行时的动态查找开销。</li>
<li><strong>线性查找</strong>：消息映射表通常较小，线性查找效率可接受。对于有大量消息处理的大型类，查找效率可能成为瓶颈。</li>
<li><strong>继承链查找</strong>：当消息在当前类未找到时，需要沿继承链向上查找，这增加了处理未处理消息的开销。</li>
</ol>
<h4 data-id="heading-12">4.2 与替代方案的对比</h4>
<p>与其它框架的消息/事件处理机制相比：</p>








































<table><thead><tr><th>机制</th><th>代表框架</th><th>实现方式</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>消息映射</strong></td><td>MFC</td><td>编译时静态绑定，线性查找</td><td>类型安全，编译时检查</td><td>不够灵活，继承链查找开销</td></tr><tr><td><strong>虚函数表</strong></td><td>早期OWL</td><td>每个消息对应虚函数</td><td>直接调用，性能高</td><td>虚函数表膨胀，二进制兼容性差</td></tr><tr><td><strong>信号槽</strong></td><td>Qt</td><td>运行时连接，字符串匹配</td><td>高度灵活，跨线程安全</td><td>运行时开销，类型安全检查弱</td></tr><tr><td><strong>委托/事件</strong></td><td>.NET</td><td>多播委托，引用计数</td><td>类型安全，支持多订阅者</td><td>垃圾回收依赖，非实时系统可能不适合</td></tr></tbody></table>
<h3 data-id="heading-13">五、现代框架中的消息映射遗产</h3>
<p>虽然MFC本身已不再是主流开发框架，但其消息映射的思想影响了后续众多UI框架：</p>
<ol>
<li><strong>.NET WinForms</strong>：事件处理模型借鉴了消息映射的对象化思想</li>
<li><strong>WPF/UWP</strong>：路由事件概念可以视为消息映射的进化形式</li>
<li><strong>Qt信号槽</strong>：虽然实现机制不同，但解决的问题域高度相似</li>
</ol>
<p>在现代C++ UI开发中，我们可以观察到类似的消息处理模式：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 现代C++ UI框架中的类似模式（概念示例）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ModernButton</span> : <span class="hljs-keyword">public</span> UIWidget
{
    <span class="hljs-comment">// 声明事件处理器</span>
    EventHandler&lt;<span class="hljs-built_in">void</span>()&gt; onClick;
    
    <span class="hljs-comment">// 连接事件</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setupEventHandlers</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-comment">// 类似于MFC的消息映射，但更灵活</span>
        onMouseDown += [<span class="hljs-keyword">this</span>](MouseEvent e) { <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">handleMouseDown</span>(e); };
        onClick += []() { <span class="hljs-comment">/* 处理点击 */</span> };
    }
};
</code></pre>
<h3 data-id="heading-14">六、总结：消息映射的设计哲学</h3>
<p>MFC消息映射机制的核心价值在于它成功地将Windows API的过程式消息处理转化为面向对象的范式。这一转化基于以下设计哲学：</p>
<ol>
<li><strong>关注点分离</strong>：不同窗口类只处理自己的消息，符合单一职责原则。</li>
<li><strong>编译时安全</strong>：通过宏在编译时建立映射，早期发现类型不匹配错误。</li>
<li><strong>框架透明性</strong>：开发者只需关注处理函数本身，复杂的消息路由由框架处理。</li>
</ol>
<p>然而，这一机制也有其历史局限性，特别是与现代反射和委托机制相比，它缺乏足够的灵活性和表达能力。理解MFC消息映射不仅有助于维护遗留代码，更重要的是，它展示了框架设计者如何通过抽象和封装来管理平台API的复杂性，这一设计思维对今天的软件开发依然具有启示意义。</p>
<h2 data-id="heading-15">第二章：MFC文档/视图架构——数据与界面的分离实践</h2>
<h3 data-id="heading-16">一、设计起源：从单体应用到模块化架构的演进</h3>
<p>在早期的Windows应用程序中，一个普遍的问题是数据管理、用户界面和业务逻辑高度耦合。以简单的文本编辑器为例，传统设计将文件操作、文本显示和用户输入处理全部混杂在窗口过程中，导致代码难以维护和扩展。</p>
<p>MFC文档/视图架构的提出，是为了解决这种“大泥球”架构问题。该架构的核心思想借鉴了软件工程中的<strong>模型-视图-控制器（MVC）模式</strong>，但根据Windows平台的特点和C++语言的特性进行了调整和优化。</p>
<h3 data-id="heading-17">二、架构组成：四大核心组件的协同工作</h3>
<p>文档/视图架构由四个核心类构成，它们各自承担明确的职责：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 架构核心类关系示意代码</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CDocument</span>;  <span class="hljs-comment">// 数据管理层</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CView</span>;      <span class="hljs-comment">// 数据显示与交互层  </span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CFrameWnd</span>;  <span class="hljs-comment">// 窗口容器层</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CDocTemplate</span>; <span class="hljs-comment">// 工厂与协调层</span>

<span class="hljs-comment">// 应用程序初始化时的典型设置</span>
<span class="hljs-function">BOOL <span class="hljs-title">CMyApp::InitInstance</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// 1. 创建文档模板（关键粘合剂）</span>
    CSingleDocTemplate* pDocTemplate;
    pDocTemplate = <span class="hljs-keyword">new</span> <span class="hljs-built_in">CSingleDocTemplate</span>(
        IDR_MAINFRAME,          <span class="hljs-comment">// 资源ID（菜单、图标等）</span>
        <span class="hljs-built_in">RUNTIME_CLASS</span>(CMyDoc),  <span class="hljs-comment">// 文档类</span>
        <span class="hljs-built_in">RUNTIME_CLASS</span>(CMainFrame), <span class="hljs-comment">// 框架类</span>
        <span class="hljs-built_in">RUNTIME_CLASS</span>(CMyView)  <span class="hljs-comment">// 视图类</span>
    );
    
    <span class="hljs-comment">// 2. 注册模板</span>
    <span class="hljs-built_in">AddDocTemplate</span>(pDocTemplate);
    
    <span class="hljs-comment">// 3. 创建或打开文档</span>
    <span class="hljs-built_in">OnFileNew</span>(); <span class="hljs-comment">// 创建新文档</span>
    
    <span class="hljs-keyword">return</span> TRUE;
}
</code></pre>
<h4 data-id="heading-18">2.1 CDocument：数据的守护者</h4>
<p>文档类是架构中的“模型”部分，负责所有与数据相关的操作：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CMyDocument</span> : <span class="hljs-keyword">public</span> CDocument
{
<span class="hljs-keyword">protected</span>:
    <span class="hljs-built_in">CMyDocument</span>();
    
<span class="hljs-comment">// 属性</span>
<span class="hljs-keyword">private</span>:
    CString m_strTitle;      <span class="hljs-comment">// 文档标题</span>
    CStringArray m_lines;    <span class="hljs-comment">// 文本行数据</span>
    BOOL m_bModified;        <span class="hljs-comment">// 修改标志</span>
    
<span class="hljs-comment">// 操作</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 数据访问接口</span>
    <span class="hljs-function"><span class="hljs-type">const</span> CString&amp; <span class="hljs-title">GetLine</span><span class="hljs-params">(<span class="hljs-type">int</span> nIndex)</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> m_lines[nIndex]; }
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">GetLineCount</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> m_lines.<span class="hljs-built_in">GetSize</span>(); }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">AddLine</span><span class="hljs-params">(<span class="hljs-type">const</span> CString&amp; strLine)</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DeleteLine</span><span class="hljs-params">(<span class="hljs-type">int</span> nIndex)</span></span>;
    
    <span class="hljs-comment">// 重写基类关键方法</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> BOOL <span class="hljs-title">OnNewDocument</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> BOOL <span class="hljs-title">OnOpenDocument</span><span class="hljs-params">(LPCTSTR lpszPathName)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> BOOL <span class="hljs-title">OnSaveDocument</span><span class="hljs-params">(LPCTSTR lpszPathName)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">DeleteContents</span><span class="hljs-params">()</span></span>;
    
    <span class="hljs-comment">// 序列化 - 核心数据持久化机制</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">Serialize</span><span class="hljs-params">(CArchive&amp; ar)</span></span>;
    
    <span class="hljs-comment">// 视图通知</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">UpdateAllViews</span><span class="hljs-params">(CView* pSender, LPARAM lHint = <span class="hljs-number">0L</span>, CObject* pHint = <span class="hljs-literal">NULL</span>)</span></span>;
    
    <span class="hljs-built_in">DECLARE_DYNCREATE</span>(CMyDocument)
    <span class="hljs-built_in">DECLARE_MESSAGE_MAP</span>()
};
</code></pre>
<p><strong>文档的关键职责包括：</strong></p>
<ol>
<li><strong>数据存储与管理</strong>：维护应用程序的核心数据结构</li>
<li><strong>持久化支持</strong>：通过Serialize方法实现文件读写</li>
<li><strong>修改追踪</strong>：管理“脏标志”（修改状态）</li>
<li><strong>视图协调</strong>：通知所有关联视图数据变更</li>
</ol>
<h4 data-id="heading-19">2.2 CView：数据的观察者与交互界面</h4>
<p>视图类是架构中的“视图”部分，负责数据的可视化呈现和用户交互：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CMyView</span> : <span class="hljs-keyword">public</span> CView
{
<span class="hljs-keyword">protected</span>:
    <span class="hljs-built_in">CMyView</span>();
    
<span class="hljs-comment">// 属性</span>
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> m_nCurrentLine;      <span class="hljs-comment">// 当前选中行</span>
    CFont m_fontText;        <span class="hljs-comment">// 显示字体</span>
    CSize m_sizeChar;        <span class="hljs-comment">// 字符尺寸</span>
    
<span class="hljs-comment">// 操作</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 获取关联文档的强类型指针</span>
    <span class="hljs-function">CMyDocument* <span class="hljs-title">GetDocument</span><span class="hljs-params">()</span> <span class="hljs-type">const</span>
    </span>{
        <span class="hljs-keyword">return</span> (CMyDocument*)m_pDocument;
    }
    
    <span class="hljs-comment">// 重写基类关键方法</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">OnDraw</span><span class="hljs-params">(CDC* pDC)</span></span>;           <span class="hljs-comment">// 绘制内容</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">OnUpdate</span><span class="hljs-params">(CView* pSender, LPARAM lHint, CObject* pHint)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">OnInitialUpdate</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> BOOL <span class="hljs-title">PreCreateWindow</span><span class="hljs-params">(CREATESTRUCT&amp; cs)</span></span>;
    
    <span class="hljs-comment">// 消息处理</span>
    <span class="hljs-function">afx_msg <span class="hljs-type">void</span> <span class="hljs-title">OnLButtonDown</span><span class="hljs-params">(UINT nFlags, CPoint point)</span></span>;
    <span class="hljs-function">afx_msg <span class="hljs-type">void</span> <span class="hljs-title">OnKeyDown</span><span class="hljs-params">(UINT nChar, UINT nRepCnt, UINT nFlags)</span></span>;
    <span class="hljs-function">afx_msg <span class="hljs-type">void</span> <span class="hljs-title">OnEditCut</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function">afx_msg <span class="hljs-type">void</span> <span class="hljs-title">OnEditCopy</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function">afx_msg <span class="hljs-type">void</span> <span class="hljs-title">OnEditPaste</span><span class="hljs-params">()</span></span>;
    
    <span class="hljs-built_in">DECLARE_DYNCREATE</span>(CMyView)
    <span class="hljs-built_in">DECLARE_MESSAGE_MAP</span>()
};
</code></pre>
<p>视图通过<code>GetDocument()</code>方法获取文档指针，这是文档与视图通信的主要桥梁。视图不直接存储数据，只持有对文档数据的引用。</p>
<h3 data-id="heading-20">三、文档/视图通信机制</h3>
<h4 data-id="heading-21">3.1 数据流：文档到视图的更新</h4>
<p>文档数据变化时，通过<code>UpdateAllViews()</code>方法通知所有关联的视图：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 文档类中修改数据并通知视图</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyDocument::AddLine</span><span class="hljs-params">(<span class="hljs-type">const</span> CString&amp; strLine)</span>
</span>{
    m_lines.<span class="hljs-built_in">Add</span>(strLine);
    m_bModified = TRUE;
    
    <span class="hljs-comment">// 通知所有视图数据已更新</span>
    <span class="hljs-built_in">UpdateAllViews</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0L</span>, <span class="hljs-literal">NULL</span>);
    
    <span class="hljs-comment">// 或者携带提示信息，优化更新效率</span>
    <span class="hljs-comment">// UpdateAllViews(NULL, UPDATE_LINE_ADDED, (CObject*)&amp;strLine);</span>
}
</code></pre>
<p>视图接收更新通知并重绘：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 视图类中响应更新通知</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyView::OnUpdate</span><span class="hljs-params">(CView* pSender, LPARAM lHint, CObject* pHint)</span>
</span>{
    <span class="hljs-comment">// 根据提示信息决定更新策略</span>
    <span class="hljs-keyword">if</span> (lHint == UPDATE_LINE_ADDED)
    {
        <span class="hljs-comment">// 局部更新：只更新新增行区域</span>
        CString* pNewLine = (CString*)pHint;
        CRect rectUpdate = <span class="hljs-built_in">CalculateLineRect</span>(m_lines.<span class="hljs-built_in">GetSize</span>()<span class="hljs-number">-1</span>);
        <span class="hljs-built_in">InvalidateRect</span>(&amp;rectUpdate);
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-comment">// 完全更新：重绘整个客户区</span>
        <span class="hljs-built_in">Invalidate</span>();
    }
}
</code></pre>
<h4 data-id="heading-22">3.2 交互流：视图到文档的修改</h4>
<p>用户通过视图界面修改数据时，视图调用文档的接口：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 视图处理用户输入并修改文档</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyView::OnChar</span><span class="hljs-params">(UINT nChar, UINT nRepCnt, UINT nFlags)</span>
</span>{
    CMyDocument* pDoc = <span class="hljs-built_in">GetDocument</span>();
    
    <span class="hljs-keyword">if</span> (nChar == VK_RETURN)  <span class="hljs-comment">// 回车键</span>
    {
        pDoc-&gt;<span class="hljs-built_in">AddLine</span>(m_strCurrentLine);  <span class="hljs-comment">// 调用文档方法</span>
        m_strCurrentLine.<span class="hljs-built_in">Empty</span>();
    }
    <span class="hljs-keyword">else</span>
    {
        m_strCurrentLine += (TCHAR)nChar;
    }
    
    <span class="hljs-comment">// 重绘当前行</span>
    CRect rectUpdate = <span class="hljs-built_in">CalculateCurrentLineRect</span>();
    <span class="hljs-built_in">InvalidateRect</span>(&amp;rectUpdate);
    
    CView::<span class="hljs-built_in">OnChar</span>(nChar, nRepCnt, nFlags);
}
</code></pre>
<h3 data-id="heading-23">四、多视图支持：一档多视的实现</h3>
<p>文档/视图架构最强大的特性之一是支持单个文档对应多个视图，这在CAD、图形编辑等应用中特别有用：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 创建同一文档的第二个视图</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMainFrame::OnWindowNewView</span><span class="hljs-params">()</span>
</span>{
    CMyDocument* pDoc = (CMyDocument*)<span class="hljs-built_in">GetActiveDocument</span>();
    
    <span class="hljs-comment">// 创建新的框架窗口</span>
    CChildFrame* pNewFrame = <span class="hljs-keyword">new</span> CChildFrame;
    
    <span class="hljs-comment">// 动态创建新视图</span>
    CCreateContext context;
    context.m_pCurrentDoc = pDoc;
    context.m_pNewViewClass = <span class="hljs-built_in">RUNTIME_CLASS</span>(CMyView);
    
    <span class="hljs-comment">// 创建视图并关联到新框架</span>
    <span class="hljs-keyword">if</span> (!pNewFrame-&gt;<span class="hljs-built_in">LoadFrame</span>(IDR_MYTYPE, WS_OVERLAPPEDWINDOW, 
                              <span class="hljs-keyword">this</span>, &amp;context))
    {
        <span class="hljs-keyword">delete</span> pNewFrame;
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 显示新窗口</span>
    pNewFrame-&gt;<span class="hljs-built_in">InitialUpdateFrame</span>(pDoc, TRUE);
}

<span class="hljs-comment">// 不同类型的视图可以展示同一文档的不同方面</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CGraphView</span> : <span class="hljs-keyword">public</span> CView  <span class="hljs-comment">// 图形视图</span>
{
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">OnDraw</span><span class="hljs-params">(CDC* pDC)</span>
    </span>{
        CMyDocument* pDoc = <span class="hljs-built_in">GetDocument</span>();
        <span class="hljs-comment">// 将文本数据转换为图形展示</span>
        <span class="hljs-built_in">DrawTextAsGraph</span>(pDC, pDoc-&gt;<span class="hljs-built_in">GetAllLines</span>());
    }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CStatsView</span> : <span class="hljs-keyword">public</span> CView  <span class="hljs-comment">// 统计视图</span>
{
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">OnDraw</span><span class="hljs-params">(CDC* pDC)</span>
    </span>{
        CMyDocument* pDoc = <span class="hljs-built_in">GetDocument</span>();
        <span class="hljs-comment">// 显示文本的统计信息</span>
        <span class="hljs-built_in">DrawStatistics</span>(pDC, pDoc-&gt;<span class="hljs-built_in">CalculateStats</span>());
    }
};
</code></pre>
<h3 data-id="heading-24">五、序列化：文档持久化的核心机制</h3>
<p>序列化是文档/视图架构的数据持久化基础，它通过<code>CArchive</code>类实现数据的二进制流式读写：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 文档类的序列化实现</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyDocument::Serialize</span><span class="hljs-params">(CArchive&amp; ar)</span>
</span>{
    <span class="hljs-keyword">if</span> (ar.<span class="hljs-built_in">IsStoring</span>())  <span class="hljs-comment">// 保存文档</span>
    {
        <span class="hljs-comment">// 写入版本标识</span>
        ar &lt;&lt; (WORD)<span class="hljs-number">0x0001</span>;  <span class="hljs-comment">// 版本1.0</span>
        
        <span class="hljs-comment">// 写入文档属性</span>
        ar &lt;&lt; m_strTitle;
        ar &lt;&lt; m_bModified;
        
        <span class="hljs-comment">// 写入数据内容</span>
        m_lines.<span class="hljs-built_in">Serialize</span>(ar);  <span class="hljs-comment">// CStringArray支持序列化</span>
        
        <span class="hljs-comment">// 写入自定义对象</span>
        <span class="hljs-keyword">if</span> (m_pCustomObj != <span class="hljs-literal">NULL</span>)
        {
            ar &lt;&lt; (WORD)<span class="hljs-number">1</span>;  <span class="hljs-comment">// 标记有对象</span>
            ar.<span class="hljs-built_in">WriteObject</span>(m_pCustomObj);  <span class="hljs-comment">// 写入可序列化对象</span>
        }
        <span class="hljs-keyword">else</span>
        {
            ar &lt;&lt; (WORD)<span class="hljs-number">0</span>;  <span class="hljs-comment">// 标记无对象</span>
        }
    }
    <span class="hljs-keyword">else</span>  <span class="hljs-comment">// 加载文档</span>
    {
        <span class="hljs-comment">// 读取版本标识</span>
        WORD wVersion;
        ar &gt;&gt; wVersion;
        
        <span class="hljs-keyword">if</span> (wVersion == <span class="hljs-number">0x0001</span>)
        {
            <span class="hljs-comment">// 读取文档属性</span>
            ar &gt;&gt; m_strTitle;
            ar &gt;&gt; m_bModified;
            
            <span class="hljs-comment">// 读取数据内容</span>
            m_lines.<span class="hljs-built_in">Serialize</span>(ar);
            
            <span class="hljs-comment">// 读取自定义对象</span>
            WORD wHasObject;
            ar &gt;&gt; wHasObject;
            <span class="hljs-keyword">if</span> (wHasObject == <span class="hljs-number">1</span>)
            {
                m_pCustomObj = (CCustomObject*)ar.<span class="hljs-built_in">ReadObject</span>(
                    <span class="hljs-built_in">RUNTIME_CLASS</span>(CCustomObject));
            }
        }
        <span class="hljs-keyword">else</span>
        {
            <span class="hljs-comment">// 处理旧版本格式</span>
            <span class="hljs-built_in">LoadOldFormat</span>(ar, wVersion);
        }
    }
}

<span class="hljs-comment">// 自定义可序列化对象的实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CCustomObject</span> : <span class="hljs-keyword">public</span> CObject
{
    <span class="hljs-built_in">DECLARE_SERIAL</span>(CCustomObject)
    
<span class="hljs-keyword">private</span>:
    CString m_strData;
    <span class="hljs-type">int</span> m_nValue;
    CPointArray m_points;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">Serialize</span><span class="hljs-params">(CArchive&amp; ar)</span>
    </span>{
        CObject::<span class="hljs-built_in">Serialize</span>(ar);
        
        <span class="hljs-keyword">if</span> (ar.<span class="hljs-built_in">IsStoring</span>())
        {
            ar &lt;&lt; m_strData &lt;&lt; m_nValue;
            m_points.<span class="hljs-built_in">Serialize</span>(ar);
        }
        <span class="hljs-keyword">else</span>
        {
            ar &gt;&gt; m_strData &gt;&gt; m_nValue;
            m_points.<span class="hljs-built_in">Serialize</span>(ar);
        }
    }
    
    <span class="hljs-comment">// 必须有无参构造函数</span>
    <span class="hljs-built_in">CCustomObject</span>() { }
};

<span class="hljs-built_in">IMPLEMENT_SERIAL</span>(CCustomObject, CObject, VERSIONABLE_SCHEMA | <span class="hljs-number">1</span>)
</code></pre>
<h3 data-id="heading-25">六、与经典MVC架构的深度对比</h3>
<h4 data-id="heading-26">6.1 相似性：分离关注点的共同追求</h4>
<p>文档/视图架构与MVC都遵循了数据与显示分离的原则：</p>





























<table><thead><tr><th>概念对应</th><th>MVC组件</th><th>文档/视图组件</th><th>职责相似度</th></tr></thead><tbody><tr><td>数据层</td><td>Model</td><td>Document</td><td>高：都负责数据管理和业务规则</td></tr><tr><td>显示层</td><td>View</td><td>View</td><td>高：都负责数据可视化</td></tr><tr><td>控制层</td><td>Controller</td><td>分散处理</td><td>低：MVC有独立控制器</td></tr></tbody></table>
<h4 data-id="heading-27">6.2 差异性：架构完整性的本质区别</h4>
<p>关键差异在于控制层的处理方式：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// MVC的明确控制流</span>
<span class="hljs-comment">// 1. 用户输入 -&gt; Controller</span>
<span class="hljs-comment">// 2. Controller更新Model</span>
<span class="hljs-comment">// 3. Model通知View更新</span>

<span class="hljs-comment">// 文档/视图的混合控制流</span>
<span class="hljs-comment">// 1. 用户输入 -&gt; View（直接处理）</span>
<span class="hljs-comment">// 2. View更新Document（直接调用）</span>
<span class="hljs-comment">// 3. Document通知所有View更新</span>
</code></pre>
<p><strong>架构差异的具体表现：</strong></p>
<ol>
<li>
<p><strong>控制器角色的缺失</strong></p>
<ul>
<li>MVC：Controller是独立的协调者，决定如何响应输入</li>
<li>文档/视图：控制逻辑分散在View和Document中</li>
</ul>
</li>
<li>
<p><strong>通信模式的不同</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// MVC：观察者模式，松耦合</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span> {
    List&lt;Observer&gt; observers;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">notifyObservers</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">for</span> (obs in observers) obs.<span class="hljs-built_in">update</span>();
    }
};

<span class="hljs-comment">// 文档/视图：直接调用，紧耦合</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Document</span> {
    List&lt;View*&gt; views;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">UpdateAllViews</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">for</span> (view in views) view-&gt;<span class="hljs-built_in">OnUpdate</span>(<span class="hljs-keyword">this</span>);
    }
};
</code></pre>
</li>
<li>
<p><strong>可测试性的影响</strong></p>
<ul>
<li>MVC：Model和Controller可独立于View进行单元测试</li>
<li>文档/视图：View和Document紧密耦合，测试困难</li>
</ul>
</li>
</ol>
<h3 data-id="heading-28">七、架构的适用场景与局限性</h3>
<h4 data-id="heading-29">7.1 理想适用场景</h4>
<p>文档/视图架构特别适合以下类型的应用：</p>
<ol>
<li><strong>文档中心型应用</strong>：文字处理器、电子表格、代码编辑器</li>
<li><strong>多视图数据展示</strong>：CAD系统、数据分析工具、数据库前端</li>
<li><strong>需要完整文件支持的应用</strong>：支持打开、保存、另存为等标准操作</li>
</ol>
<h4 data-id="heading-30">7.2 架构局限性</h4>
<ol>
<li><strong>学习曲线陡峭</strong>：需要理解大量MFC特定概念和宏</li>
<li><strong>过度设计简单应用</strong>：对于对话框应用过于复杂</li>
<li><strong>平台锁定</strong>：深度绑定Windows和MFC框架</li>
<li><strong>现代性不足</strong>：缺乏对触摸、手势等现代交互的支持</li>
</ol>
<h3 data-id="heading-31">八、实际应用示例：简易文本编辑器</h3>
<p>以下是文档/视图架构在文本编辑器中的完整实现示例：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 文档类 - 管理文本数据</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CTextDocument</span> : <span class="hljs-keyword">public</span> CDocument
{
<span class="hljs-keyword">protected</span>:
    <span class="hljs-built_in">CTextDocument</span>();
    
    <span class="hljs-comment">// 数据存储</span>
    CStringArray m_lines;
    <span class="hljs-type">int</span> m_nTotalChars;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 数据操作接口</span>
    <span class="hljs-function">BOOL <span class="hljs-title">InsertText</span><span class="hljs-params">(<span class="hljs-type">int</span> nLine, <span class="hljs-type">int</span> nPos, <span class="hljs-type">const</span> CString&amp; strText)</span></span>;
    <span class="hljs-function">BOOL <span class="hljs-title">DeleteText</span><span class="hljs-params">(<span class="hljs-type">int</span> nLine, <span class="hljs-type">int</span> nPos, <span class="hljs-type">int</span> nCount)</span></span>;
    <span class="hljs-function">CString <span class="hljs-title">GetText</span><span class="hljs-params">(<span class="hljs-type">int</span> nLine, <span class="hljs-type">int</span> nPos, <span class="hljs-type">int</span> nCount)</span> <span class="hljs-type">const</span></span>;
    
    <span class="hljs-comment">// 重写关键方法</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> BOOL <span class="hljs-title">OnNewDocument</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">Serialize</span><span class="hljs-params">(CArchive&amp; ar)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">DeleteContents</span><span class="hljs-params">()</span></span>;
    
    <span class="hljs-built_in">DECLARE_DYNCREATE</span>(CTextDocument)
};

<span class="hljs-comment">// 视图类 - 显示和编辑文本</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CTextView</span> : <span class="hljs-keyword">public</span> CScrollView
{
<span class="hljs-keyword">protected</span>:
    <span class="hljs-built_in">CTextView</span>();
    
    <span class="hljs-comment">// 编辑状态</span>
    <span class="hljs-type">int</span> m_nCaretLine;    <span class="hljs-comment">// 光标所在行</span>
    <span class="hljs-type">int</span> m_nCaretPos;     <span class="hljs-comment">// 光标在行中的位置</span>
    BOOL m_bSelecting;   <span class="hljs-comment">// 是否在选择文本</span>
    CPoint m_ptSelectStart; <span class="hljs-comment">// 选择起始点</span>
    
    <span class="hljs-comment">// 显示属性</span>
    CFont m_font;
    CSize m_sizeChar;    <span class="hljs-comment">// 字符尺寸</span>
    <span class="hljs-type">int</span> m_nLinesPerPage; <span class="hljs-comment">// 每页行数</span>
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">CTextDocument* <span class="hljs-title">GetDocument</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
    
    <span class="hljs-comment">// 重写关键方法</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">OnDraw</span><span class="hljs-params">(CDC* pDC)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">OnInitialUpdate</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">OnUpdate</span><span class="hljs-params">(CView* pSender, LPARAM lHint, CObject* pHint)</span></span>;
    
    <span class="hljs-comment">// 消息处理</span>
    <span class="hljs-function">afx_msg <span class="hljs-type">void</span> <span class="hljs-title">OnLButtonDown</span><span class="hljs-params">(UINT nFlags, CPoint point)</span></span>;
    <span class="hljs-function">afx_msg <span class="hljs-type">void</span> <span class="hljs-title">OnMouseMove</span><span class="hljs-params">(UINT nFlags, CPoint point)</span></span>;
    <span class="hljs-function">afx_msg <span class="hljs-type">void</span> <span class="hljs-title">OnLButtonUp</span><span class="hljs-params">(UINT nFlags, CPoint point)</span></span>;
    <span class="hljs-function">afx_msg <span class="hljs-type">void</span> <span class="hljs-title">OnKeyDown</span><span class="hljs-params">(UINT nChar, UINT nRepCnt, UINT nFlags)</span></span>;
    <span class="hljs-function">afx_msg <span class="hljs-type">void</span> <span class="hljs-title">OnChar</span><span class="hljs-params">(UINT nChar, UINT nRepCnt, UINT nFlags)</span></span>;
    <span class="hljs-function">afx_msg <span class="hljs-type">void</span> <span class="hljs-title">OnVScroll</span><span class="hljs-params">(UINT nSBCode, UINT nPos, CScrollBar* pScrollBar)</span></span>;
    
    <span class="hljs-comment">// 计算辅助函数</span>
    <span class="hljs-function">CPoint <span class="hljs-title">CharPosFromPoint</span><span class="hljs-params">(CPoint point)</span> <span class="hljs-type">const</span></span>;
    <span class="hljs-function">CPoint <span class="hljs-title">PointFromCharPos</span><span class="hljs-params">(<span class="hljs-type">int</span> nLine, <span class="hljs-type">int</span> nPos)</span> <span class="hljs-type">const</span></span>;
    <span class="hljs-function">CRect <span class="hljs-title">GetLineRect</span><span class="hljs-params">(<span class="hljs-type">int</span> nLine)</span> <span class="hljs-type">const</span></span>;
    
    <span class="hljs-built_in">DECLARE_DYNCREATE</span>(CTextView)
    <span class="hljs-built_in">DECLARE_MESSAGE_MAP</span>()
};
</code></pre>
<h3 data-id="heading-32">九、现代框架中的演进与启示</h3>
<p>虽然MFC文档/视图架构已逐渐退出主流，但其设计思想在现代框架中仍有体现：</p>
<ol>
<li><strong>数据绑定</strong>：WPF/XAML的数据绑定机制是文档/视图分离的进化</li>
<li><strong>MVVM模式</strong>：Model-View-ViewModel可视为文档/视图的现代化身</li>
<li><strong>响应式编程</strong>：RxJS等库实现了更灵活的数据-视图同步</li>
</ol>
<p><strong>架构演进的启示：</strong></p>
<ul>
<li>关注点分离是永恒的设计原则</li>
<li>框架应该提供清晰的数据流指导</li>
<li>可测试性应该成为架构的核心考量</li>
<li>平台抽象层对于长期维护至关重要</li>
</ul>
<p>文档/视图架构展示了在特定技术约束下（C++、Windows、90年代硬件）如何实现复杂应用的结构化组织。虽然具体技术已过时，但其背后的架构思维——如何管理复杂性、如何分离关注点、如何设计可扩展的系统——对今天的软件开发者仍有重要价值。</p>
<h2 data-id="heading-33">第三章：MFC对话框与DDX/DDV机制——用户界面的标准化封装</h2>
<h3 data-id="heading-34">一、对话框编程的演进：从原始API到MFC封装</h3>
<p>在原始的Windows SDK中，创建和管理对话框是一项繁琐且容易出错的工作。开发者需要手动处理对话框过程函数、控件消息、数据验证等一系列复杂任务。MFC的对话框类（CDialog及其派生类）通过面向对象的封装，极大地简化了这一过程。</p>
<h4 data-id="heading-35">1.1 原始Win32对话框编程的复杂性</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Win32 SDK中的对话框示例</span>
<span class="hljs-function">BOOL CALLBACK <span class="hljs-title">DialogProc</span><span class="hljs-params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span>
</span>{
    <span class="hljs-keyword">switch</span> (uMsg)
    {
        <span class="hljs-keyword">case</span> WM_INITDIALOG:
            <span class="hljs-comment">// 初始化控件</span>
            <span class="hljs-built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_NAME, <span class="hljs-string">"默认名称"</span>);
            <span class="hljs-built_in">SetDlgItemInt</span>(hwndDlg, IDC_EDIT_AGE, <span class="hljs-number">25</span>, FALSE);
            <span class="hljs-keyword">return</span> TRUE;
            
        <span class="hljs-keyword">case</span> WM_COMMAND:
            <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">LOWORD</span>(wParam))
            {
                <span class="hljs-keyword">case</span> IDOK:
                {
                    <span class="hljs-comment">// 获取数据</span>
                    TCHAR szName[<span class="hljs-number">100</span>];
                    <span class="hljs-built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_NAME, szName, <span class="hljs-number">100</span>);
                    
                    <span class="hljs-comment">// 手动验证</span>
                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">lstrlen</span>(szName) == <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-built_in">MessageBox</span>(hwndDlg, <span class="hljs-string">"姓名不能为空"</span>, <span class="hljs-string">"错误"</span>, MB_OK);
                        <span class="hljs-keyword">return</span> TRUE;
                    }
                    
                    <span class="hljs-type">int</span> nAge = <span class="hljs-built_in">GetDlgItemInt</span>(hwndDlg, IDC_EDIT_AGE, <span class="hljs-literal">NULL</span>, FALSE);
                    <span class="hljs-keyword">if</span> (nAge &lt; <span class="hljs-number">0</span> || nAge &gt; <span class="hljs-number">150</span>)
                    {
                        <span class="hljs-built_in">MessageBox</span>(hwndDlg, <span class="hljs-string">"年龄必须在0-150之间"</span>, <span class="hljs-string">"错误"</span>, MB_OK);
                        <span class="hljs-keyword">return</span> TRUE;
                    }
                    
                    <span class="hljs-built_in">EndDialog</span>(hwndDlg, IDOK);
                    <span class="hljs-keyword">return</span> TRUE;
                }
                
                <span class="hljs-keyword">case</span> IDCANCEL:
                    <span class="hljs-built_in">EndDialog</span>(hwndDlg, IDCANCEL);
                    <span class="hljs-keyword">return</span> TRUE;
            }
            <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">return</span> FALSE;
}

<span class="hljs-comment">// 调用对话框</span>
<span class="hljs-built_in">DialogBox</span>(hInstance, <span class="hljs-built_in">MAKEINTRESOURCE</span>(IDD_MYDIALOG), hwndParent, DialogProc);
</code></pre>
<p>这种模式存在明显问题：</p>
<ol>
<li><strong>代码冗长</strong>：每个控件都需要单独获取和设置</li>
<li><strong>验证分散</strong>：验证逻辑与UI逻辑混杂</li>
<li><strong>类型不安全</strong>：所有数据都是字符串或整数，需要手动转换</li>
<li><strong>难以维护</strong>：添加新控件需要修改多个地方</li>
</ol>
<h3 data-id="heading-36">二、MFC对话框类的封装架构</h3>
<h4 data-id="heading-37">2.1 CDialog类层次结构</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// MFC对话框类的基本层次</span>
CObject
└── CCmdTarget
    └── CWnd
        └── CDialog
            ├── <span class="hljs-built_in">CCommonDialog</span> (通用对话框基类)
            │   ├── CFileDialog
            │   ├── CColorDialog
            │   ├── CFontDialog
            │   └── ...
            └── <span class="hljs-built_in">CDialogEx</span> (增强功能)

<span class="hljs-comment">// 典型的MFC对话框类定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CMyDialog</span> : <span class="hljs-keyword">public</span> CDialogEx
{
    <span class="hljs-built_in">DECLARE_DYNAMIC</span>(CMyDialog)

<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 标准构造函数</span>
    <span class="hljs-built_in">CMyDialog</span>(CWnd* pParent = <span class="hljs-literal">NULL</span>);
    
    <span class="hljs-comment">// 对话框资源ID</span>
    <span class="hljs-keyword">enum</span> { IDD = IDD_MYDIALOG };

<span class="hljs-keyword">protected</span>:
    <span class="hljs-comment">// DDX/DDV支持</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">DoDataExchange</span><span class="hljs-params">(CDataExchange* pDX)</span></span>;

    <span class="hljs-comment">// 消息映射</span>
    <span class="hljs-built_in">DECLARE_MESSAGE_MAP</span>()

<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 控件关联变量</span>
    CString m_strName;
    <span class="hljs-type">int</span> m_nAge;
    BOOL m_bAgree;
    CComboBox m_cboGender;
};
</code></pre>
<h4 data-id="heading-38">2.2 对话框生命周期管理</h4>
<p>MFC对话框的生命周期由以下关键方法控制：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 对话框创建与销毁流程</span>
<span class="hljs-function">BOOL <span class="hljs-title">CMyDialog::OnInitDialog</span><span class="hljs-params">()</span>
</span>{
    CDialogEx::<span class="hljs-built_in">OnInitDialog</span>();
    
    <span class="hljs-comment">// 1. 初始化控件</span>
    m_cboGender.<span class="hljs-built_in">AddString</span>(_T(<span class="hljs-string">"男"</span>));
    m_cboGender.<span class="hljs-built_in">AddString</span>(_T(<span class="hljs-string">"女"</span>));
    m_cboGender.<span class="hljs-built_in">SetCurSel</span>(<span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 2. 设置初始数据</span>
    m_strName = _T(<span class="hljs-string">"张三"</span>);
    m_nAge = <span class="hljs-number">25</span>;
    m_bAgree = TRUE;
    
    <span class="hljs-comment">// 3. 更新控件显示</span>
    <span class="hljs-built_in">UpdateData</span>(FALSE);
    
    <span class="hljs-comment">// 4. 其他初始化</span>
    <span class="hljs-built_in">CenterWindow</span>();  <span class="hljs-comment">// 居中显示</span>
    
    <span class="hljs-keyword">return</span> TRUE;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyDialog::OnOK</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// 1. 从控件获取数据并验证</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">UpdateData</span>(TRUE))
        <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 验证失败，不关闭对话框</span>
    
    <span class="hljs-comment">// 2. 额外的业务逻辑验证</span>
    <span class="hljs-keyword">if</span> (m_strName.<span class="hljs-built_in">GetLength</span>() &lt; <span class="hljs-number">2</span>)
    {
        <span class="hljs-built_in">MessageBox</span>(_T(<span class="hljs-string">"姓名至少需要2个字符"</span>), _T(<span class="hljs-string">"错误"</span>), MB_ICONERROR);
        <span class="hljs-built_in">GetDlgItem</span>(IDC_EDIT_NAME)-&gt;<span class="hljs-built_in">SetFocus</span>();
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 3. 调用基类OnOK关闭对话框</span>
    CDialogEx::<span class="hljs-built_in">OnOK</span>();
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyDialog::OnCancel</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// 取消前的确认</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">MessageBox</span>(_T(<span class="hljs-string">"确定要取消吗？"</span>), _T(<span class="hljs-string">"确认"</span>), 
                   MB_YESNO | MB_ICONQUESTION) == IDYES)
    {
        CDialogEx::<span class="hljs-built_in">OnCancel</span>();
    }
}
</code></pre>
<h3 data-id="heading-39">三、DDX（对话框数据交换）机制详解</h3>
<h4 data-id="heading-40">3.1 DDX的核心原理</h4>
<p>DDX机制通过<code>DoDataExchange</code>函数和一组预定义的宏，在对话框控件和成员变量之间建立双向数据绑定：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// DoDataExchange函数的标准实现</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyDialog::DoDataExchange</span><span class="hljs-params">(CDataExchange* pDX)</span>
</span>{
    CDialogEx::<span class="hljs-built_in">DoDataExchange</span>(pDX);
    
    <span class="hljs-comment">// 文本控件交换</span>
    <span class="hljs-built_in">DDX_Text</span>(pDX, IDC_EDIT_NAME, m_strName);
    
    <span class="hljs-comment">// 数值控件交换</span>
    <span class="hljs-built_in">DDX_Text</span>(pDX, IDC_EDIT_AGE, m_nAge);
    
    <span class="hljs-comment">// 复选框交换</span>
    <span class="hljs-built_in">DDX_Check</span>(pDX, IDC_CHECK_AGREE, m_bAgree);
    
    <span class="hljs-comment">// 单选按钮交换</span>
    <span class="hljs-built_in">DDX_Radio</span>(pDX, IDC_RADIO_MALE, m_nGender);
    
    <span class="hljs-comment">// 组合框交换</span>
    <span class="hljs-built_in">DDX_CBIndex</span>(pDX, IDC_COMBO_STATUS, m_nStatusIndex);
    <span class="hljs-built_in">DDX_CBString</span>(pDX, IDC_COMBO_STATUS, m_strStatus);
    
    <span class="hljs-comment">// 列表框交换</span>
    <span class="hljs-built_in">DDX_LBIndex</span>(pDX, IDC_LIST_ITEMS, m_nSelectedItem);
    
    <span class="hljs-comment">// 控件对象交换</span>
    <span class="hljs-built_in">DDX_Control</span>(pDX, IDC_COMBO_GENDER, m_cboGender);
}
</code></pre>
<h4 data-id="heading-41">3.2 DDX宏的编译时展开</h4>
<p>编译器会将DDX宏展开为具体的代码，以下是对<code>DDX_Text</code>宏展开的模拟：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// DDX_Text宏的近似展开（概念性代码）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> DDX_Text(pDX, nIDC, value) \
    do { \
        <span class="hljs-keyword">if</span> ((pDX)-&gt;m_bSaveAndValidate) { \
            <span class="hljs-comment">/* 从控件获取数据到变量 */</span> \
            HWND hWndCtrl = ::GetDlgItem((pDX)-&gt;m_pDlgWnd-&gt;m_hWnd, nIDC); \
            <span class="hljs-keyword">if</span> (hWndCtrl != NULL) { \
                int nLen = ::GetWindowTextLength(hWndCtrl); \
                CString strTemp; \
                ::GetWindowText(hWndCtrl, strTemp.GetBuffer(nLen), nLen + 1); \
                strTemp.ReleaseBuffer(); \
                <span class="hljs-comment">/* 类型转换和赋值 */</span> \
                value = _ttoi(strTemp); <span class="hljs-comment">/* 对于int类型 */</span> \
            } \
        } <span class="hljs-keyword">else</span> { \
            <span class="hljs-comment">/* 从变量设置数据到控件 */</span> \
            CString strTemp; \
            strTemp.Format(_T(<span class="hljs-string">"%d"</span>), value); <span class="hljs-comment">/* 对于int类型 */</span> \
            ::SetDlgItemText((pDX)-&gt;m_pDlgWnd-&gt;m_hWnd, nIDC, strTemp); \
        } \
    } while (0)</span>
</code></pre>
<h4 data-id="heading-42">3.3 完整DDX支持的数据类型</h4>
<p>MFC为不同类型的数据提供了专门的DDX宏：</p>













































































<table><thead><tr><th>数据类型</th><th>DDX宏</th><th>示例</th><th>适用控件</th></tr></thead><tbody><tr><td><strong>CString</strong></td><td><code>DDX_Text</code></td><td><code>DDX_Text(pDX, IDC_EDIT, m_strValue)</code></td><td>编辑框</td></tr><tr><td><strong>int</strong></td><td><code>DDX_Text</code></td><td><code>DDX_Text(pDX, IDC_EDIT, m_nValue)</code></td><td>编辑框</td></tr><tr><td><strong>UINT</strong></td><td><code>DDX_Text</code></td><td><code>DDX_Text(pDX, IDC_EDIT, m_uValue)</code></td><td>编辑框</td></tr><tr><td><strong>long</strong></td><td><code>DDX_Text</code></td><td><code>DDX_Text(pDX, IDC_EDIT, m_lValue)</code></td><td>编辑框</td></tr><tr><td><strong>DWORD</strong></td><td><code>DDX_Text</code></td><td><code>DDX_Text(pDX, IDC_EDIT, m_dwValue)</code></td><td>编辑框</td></tr><tr><td><strong>float</strong></td><td><code>DDX_Text</code></td><td><code>DDX_Text(pDX, IDC_EDIT, m_fValue)</code></td><td>编辑框</td></tr><tr><td><strong>double</strong></td><td><code>DDX_Text</code></td><td><code>DDX_Text(pDX, IDC_EDIT, m_dValue)</code></td><td>编辑框</td></tr><tr><td><strong>BOOL</strong></td><td><code>DDX_Check</code></td><td><code>DDX_Check(pDX, IDC_CHECK, m_bValue)</code></td><td>复选框</td></tr><tr><td><strong>int</strong> (单选)</td><td><code>DDX_Radio</code></td><td><code>DDX_Radio(pDX, IDC_RADIO1, m_nIndex)</code></td><td>单选按钮组</td></tr><tr><td><strong>CComboBox</strong></td><td><code>DDX_Control</code></td><td><code>DDX_Control(pDX, IDC_COMBO, m_combo)</code></td><td>组合框对象</td></tr><tr><td><strong>CListBox</strong></td><td><code>DDX_Control</code></td><td><code>DDX_Control(pDX, IDC_LIST, m_list)</code></td><td>列表框对象</td></tr></tbody></table>
<h3 data-id="heading-43">四、DDV（对话框数据验证）机制详解</h3>
<h4 data-id="heading-44">4.1 DDV的工作原理</h4>
<p>DDV在数据交换的同时进行验证，确保数据的有效性：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 带有DDV验证的DoDataExchange示例</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyDialog::DoDataExchange</span><span class="hljs-params">(CDataExchange* pDX)</span>
</span>{
    CDialogEx::<span class="hljs-built_in">DoDataExchange</span>(pDX);
    
    <span class="hljs-comment">// 数据交换</span>
    <span class="hljs-built_in">DDX_Text</span>(pDX, IDC_EDIT_NAME, m_strName);
    
    <span class="hljs-comment">// 数据验证</span>
    <span class="hljs-built_in">DDV_MaxChars</span>(pDX, m_strName, <span class="hljs-number">50</span>);  <span class="hljs-comment">// 最多50个字符</span>
    
    <span class="hljs-comment">// 数值交换与验证</span>
    <span class="hljs-built_in">DDX_Text</span>(pDX, IDC_EDIT_AGE, m_nAge);
    <span class="hljs-built_in">DDV_MinMaxInt</span>(pDX, m_nAge, <span class="hljs-number">0</span>, <span class="hljs-number">150</span>);  <span class="hljs-comment">// 范围0-150</span>
    
    <span class="hljs-comment">// 字符串非空验证</span>
    <span class="hljs-built_in">DDV_NonEmptyString</span>(pDX, m_strName);
}
</code></pre>
<h4 data-id="heading-45">4.2 DDV验证失败的处理机制</h4>
<p>当DDV验证失败时，MFC会抛出异常并自动处理：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// DDV_MinMaxInt宏的内部实现逻辑（概念性）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> DDV_MinMaxInt(pDX, value, minVal, maxVal) \
    do { \
        <span class="hljs-keyword">if</span> ((pDX)-&gt;m_bSaveAndValidate &amp;&amp; (value <span class="hljs-string">&lt; minVal || value &gt;</span> maxVal)) { \
            <span class="hljs-comment">/* 准备错误信息 */</span> \
            CString strError; \
            strError.Format(_T(<span class="hljs-string">"数值必须在%d和%d之间"</span>), minVal, maxVal); \
            \
            <span class="hljs-comment">/* 显示错误对话框 */</span> \
            AfxMessageBox(strError, MB_ICONEXCLAMATION); \
            \
            <span class="hljs-comment">/* 抛出异常停止后续处理 */</span> \
            (pDX)-&gt;Fail(); \
        } \
    } while (0)</span>

<span class="hljs-comment">// CDataExchange::Fail()方法的简化实现</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CDataExchange::Fail</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// 设置焦点到问题控件</span>
    <span class="hljs-keyword">if</span> (m_hWndLastControl != <span class="hljs-literal">NULL</span> &amp;&amp; ::<span class="hljs-built_in">IsWindow</span>(m_hWndLastControl))
    {
        ::<span class="hljs-built_in">SetFocus</span>(m_hWndLastControl);
    }
    
    <span class="hljs-comment">// 抛出异常，被MFC框架捕获</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">CUserException</span>();
}
</code></pre>
<h4 data-id="heading-46">4.3 自定义DDV验证</h4>
<p>除了内置的DDV宏，还可以创建自定义验证：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 自定义DDV验证宏</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> DDV_Email(pDX, value) \
    do { \
        <span class="hljs-keyword">if</span> ((pDX)-&gt;m_bSaveAndValidate) { \
            <span class="hljs-keyword">if</span> (!IsValidEmail(value)) { \
                AfxMessageBox(_T(<span class="hljs-string">"请输入有效的电子邮件地址"</span>), \
                             MB_ICONEXCLAMATION); \
                (pDX)-&gt;Fail(); \
            } \
        } \
    } while (0)</span>

<span class="hljs-comment">// 使用自定义验证</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyDialog::DoDataExchange</span><span class="hljs-params">(CDataExchange* pDX)</span>
</span>{
    CDialogEx::<span class="hljs-built_in">DoDataExchange</span>(pDX);
    
    <span class="hljs-built_in">DDX_Text</span>(pDX, IDC_EDIT_EMAIL, m_strEmail);
    <span class="hljs-built_in">DDV_Email</span>(pDX, m_strEmail);  <span class="hljs-comment">// 自定义验证</span>
}

<span class="hljs-comment">// 电子邮件验证函数</span>
<span class="hljs-function">BOOL <span class="hljs-title">CMyDialog::IsValidEmail</span><span class="hljs-params">(<span class="hljs-type">const</span> CString&amp; strEmail)</span>
</span>{
    <span class="hljs-comment">// 简单的电子邮件验证逻辑</span>
    <span class="hljs-type">int</span> nAtPos = strEmail.<span class="hljs-built_in">Find</span>(<span class="hljs-string">'@'</span>);
    <span class="hljs-type">int</span> nDotPos = strEmail.<span class="hljs-built_in">Find</span>(<span class="hljs-string">'.'</span>, nAtPos);
    
    <span class="hljs-keyword">return</span> (nAtPos &gt; <span class="hljs-number">0</span> &amp;&amp; nDotPos &gt; nAtPos + <span class="hljs-number">1</span> &amp;&amp; 
            nDotPos &lt; strEmail.<span class="hljs-built_in">GetLength</span>() - <span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-47">五、模态与非模态对话框的深入对比</h3>
<h4 data-id="heading-48">5.1 模态对话框的完整生命周期</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 模态对话框的创建与使用</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyView::OnOpenSettings</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-function">CMyDialog <span class="hljs-title">dlg</span><span class="hljs-params">(<span class="hljs-keyword">this</span>)</span></span>;  <span class="hljs-comment">// 创建对话框对象</span>
    
    <span class="hljs-comment">// 设置初始值</span>
    dlg.m_strName = m_strCurrentName;
    dlg.m_nAge = m_nCurrentAge;
    
    <span class="hljs-comment">// 显示模态对话框</span>
    <span class="hljs-keyword">if</span> (dlg.<span class="hljs-built_in">DoModal</span>() == IDOK)
    {
        <span class="hljs-comment">// 用户点击了确定</span>
        m_strCurrentName = dlg.m_strName;
        m_nCurrentAge = dlg.m_nAge;
        
        <span class="hljs-comment">// 保存设置</span>
        <span class="hljs-built_in">SaveSettings</span>();
        
        <span class="hljs-comment">// 更新显示</span>
        <span class="hljs-built_in">UpdateDisplay</span>();
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-comment">// 用户点击了取消</span>
        <span class="hljs-built_in">AfxMessageBox</span>(_T(<span class="hljs-string">"设置未保存"</span>));
    }
    
    <span class="hljs-comment">// 对话框对象自动销毁</span>
}
</code></pre>
<h4 data-id="heading-49">5.2 非模态对话框的特殊管理</h4>
<p>非模态对话框需要不同的生命周期管理策略：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 非模态对话框的创建与管理</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CMyView</span> : <span class="hljs-keyword">public</span> CView
{
<span class="hljs-keyword">private</span>:
    CMyModelessDialog* m_pModelessDlg;  <span class="hljs-comment">// 指针成员</span>
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnOpenModelessDialog</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-comment">// 防止重复打开</span>
        <span class="hljs-keyword">if</span> (m_pModelessDlg != <span class="hljs-literal">NULL</span> &amp;&amp; m_pModelessDlg-&gt;<span class="hljs-built_in">GetSafeHwnd</span>() != <span class="hljs-literal">NULL</span>)
        {
            m_pModelessDlg-&gt;<span class="hljs-built_in">SetActiveWindow</span>();
            m_pModelessDlg-&gt;<span class="hljs-built_in">ShowWindow</span>(SW_SHOW);
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 创建非模态对话框</span>
        m_pModelessDlg = <span class="hljs-keyword">new</span> <span class="hljs-built_in">CMyModelessDialog</span>(<span class="hljs-keyword">this</span>);
        
        <span class="hljs-comment">// 必须指定WS_VISIBLE风格</span>
        <span class="hljs-keyword">if</span> (!m_pModelessDlg-&gt;<span class="hljs-built_in">Create</span>(IDD_MYDIALOG, <span class="hljs-keyword">this</span>))
        {
            <span class="hljs-keyword">delete</span> m_pModelessDlg;
            m_pModelessDlg = <span class="hljs-literal">NULL</span>;
            <span class="hljs-built_in">AfxMessageBox</span>(_T(<span class="hljs-string">"创建对话框失败"</span>));
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 显示对话框</span>
        m_pModelessDlg-&gt;<span class="hljs-built_in">ShowWindow</span>(SW_SHOW);
    }
    
    <span class="hljs-comment">// 对话框关闭时的清理</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnModelessDialogClosed</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">if</span> (m_pModelessDlg != <span class="hljs-literal">NULL</span>)
        {
            <span class="hljs-comment">// 注意：不能调用delete，对话框自己管理生命周期</span>
            m_pModelessDlg = <span class="hljs-literal">NULL</span>;
        }
    }
};

<span class="hljs-comment">// 非模态对话框类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CMyModelessDialog</span> : <span class="hljs-keyword">public</span> CDialogEx
{
<span class="hljs-keyword">private</span>:
    CMyView* m_pParentView;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">CMyModelessDialog</span>(CMyView* pParent) 
        : <span class="hljs-built_in">CDialogEx</span>(IDD_MYDIALOG, pParent), <span class="hljs-built_in">m_pParentView</span>(pParent) {}
    
    <span class="hljs-comment">// 重写OnOK和OnCancel</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">OnOK</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">UpdateData</span>(TRUE))
            <span class="hljs-keyword">return</span>;
        
        <span class="hljs-comment">// 通知父视图</span>
        <span class="hljs-keyword">if</span> (m_pParentView != <span class="hljs-literal">NULL</span>)
        {
            m_pParentView-&gt;<span class="hljs-built_in">ApplyDialogSettings</span>(m_strName, m_nAge);
        }
        
        <span class="hljs-comment">// 不调用基类OnOK（不关闭对话框）</span>
        <span class="hljs-comment">// 而是隐藏或执行其他操作</span>
        <span class="hljs-built_in">ShowWindow</span>(SW_HIDE);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">OnCancel</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-comment">// 通知父视图对话框已关闭</span>
        <span class="hljs-keyword">if</span> (m_pParentView != <span class="hljs-literal">NULL</span>)
        {
            m_pParentView-&gt;<span class="hljs-built_in">OnModelessDialogClosed</span>();
        }
        
        <span class="hljs-comment">// 销毁窗口</span>
        <span class="hljs-built_in">DestroyWindow</span>();
    }
    
    <span class="hljs-comment">// 重写PostNcDestroy以删除对象</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">PostNcDestroy</span><span class="hljs-params">()</span>
    </span>{
        CDialogEx::<span class="hljs-built_in">PostNcDestroy</span>();
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>;  <span class="hljs-comment">// 自我删除</span>
    }
    
    <span class="hljs-built_in">DECLARE_MESSAGE_MAP</span>()
};
</code></pre>
<h3 data-id="heading-50">六、属性表（Property Sheet）与属性页（Property Page）</h3>
<p>对于复杂的设置对话框，MFC提供了属性表机制：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 属性页基类的使用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CGeneralPage</span> : <span class="hljs-keyword">public</span> CPropertyPage
{
    <span class="hljs-built_in">DECLARE_DYNCREATE</span>(CGeneralPage)
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">CGeneralPage</span>() : <span class="hljs-built_in">CPropertyPage</span>(IDD_GENERAL_PAGE)
    {
        m_psp.dwFlags |= PSP_USETITLE;
        m_psp.pszTitle = _T(<span class="hljs-string">"常规设置"</span>);
    }
    
    <span class="hljs-comment">// 数据成员</span>
    CString m_strUserName;
    CString m_strCompany;
    BOOL m_bAutoSave;
    
<span class="hljs-keyword">protected</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">DoDataExchange</span><span class="hljs-params">(CDataExchange* pDX)</span>
    </span>{
        CPropertyPage::<span class="hljs-built_in">DoDataExchange</span>(pDX);
        <span class="hljs-built_in">DDX_Text</span>(pDX, IDC_EDIT_USERNAME, m_strUserName);
        <span class="hljs-built_in">DDX_Text</span>(pDX, IDC_EDIT_COMPANY, m_strCompany);
        <span class="hljs-built_in">DDX_Check</span>(pDX, IDC_CHECK_AUTOSAVE, m_bAutoSave);
    }
    
    <span class="hljs-comment">// 验证</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> BOOL <span class="hljs-title">OnApply</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">UpdateData</span>(TRUE))
            <span class="hljs-keyword">return</span> FALSE;
            
        <span class="hljs-comment">// 应用设置</span>
        <span class="hljs-built_in">AfxGetApp</span>()-&gt;<span class="hljs-built_in">WriteProfileString</span>(_T(<span class="hljs-string">"Settings"</span>), _T(<span class="hljs-string">"UserName"</span>), m_strUserName);
        
        <span class="hljs-keyword">return</span> CPropertyPage::<span class="hljs-built_in">OnApply</span>();
    }
};

<span class="hljs-comment">// 属性表的创建与使用</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyApp::OnSettings</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// 创建属性表</span>
    <span class="hljs-function">CPropertySheet <span class="hljs-title">sheet</span><span class="hljs-params">(_T(<span class="hljs-string">"应用程序设置"</span>))</span></span>;
    
    <span class="hljs-comment">// 添加属性页</span>
    CGeneralPage pageGeneral;
    CAdvancedPage pageAdvanced;
    
    sheet.<span class="hljs-built_in">AddPage</span>(&amp;pageGeneral);
    sheet.<span class="hljs-built_in">AddPage</span>(&amp;pageAdvanced);
    
    <span class="hljs-comment">// 设置初始值</span>
    pageGeneral.m_strUserName = <span class="hljs-built_in">GetCurrentUserName</span>();
    pageAdvanced.m_nTimeout = <span class="hljs-built_in">GetTimeoutValue</span>();
    
    <span class="hljs-comment">// 显示模态属性表</span>
    <span class="hljs-keyword">if</span> (sheet.<span class="hljs-built_in">DoModal</span>() == IDOK)
    {
        <span class="hljs-comment">// 保存所有设置</span>
        <span class="hljs-built_in">SaveSettings</span>(pageGeneral, pageAdvanced);
    }
}
</code></pre>
<h3 data-id="heading-51">七、对话框数据交换的高级技巧</h3>
<h4 data-id="heading-52">7.1 动态控件的数据交换</h4>
<p>对于动态创建的控件，需要特殊处理DDX：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CDynamicDialog</span> : <span class="hljs-keyword">public</span> CDialogEx
{
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// 动态控件ID起始值（必须大于系统ID）</span>
    <span class="hljs-keyword">enum</span> { IDC_DYNAMIC_START = <span class="hljs-number">0x8000</span> };
    
    <span class="hljs-comment">// 动态控件数组</span>
    CEdit* m_pDynamicEdits[<span class="hljs-number">10</span>];
    CStatic* m_pDynamicLabels[<span class="hljs-number">10</span>];
    <span class="hljs-type">int</span> m_nDynamicValues[<span class="hljs-number">10</span>];
    <span class="hljs-type">int</span> m_nControlCount;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">DoDataExchange</span><span class="hljs-params">(CDataExchange* pDX)</span>
    </span>{
        CDialogEx::<span class="hljs-built_in">DoDataExchange</span>(pDX);
        
        <span class="hljs-comment">// 动态控件的DDX</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; m_nControlCount; i++)
        {
            <span class="hljs-keyword">if</span> (m_pDynamicEdits[i] != <span class="hljs-literal">NULL</span> &amp;&amp; m_pDynamicEdits[i]-&gt;<span class="hljs-built_in">GetSafeHwnd</span>() != <span class="hljs-literal">NULL</span>)
            {
                <span class="hljs-built_in">DDX_Text</span>(pDX, IDC_DYNAMIC_START + i, m_nDynamicValues[i]);
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CreateDynamicControls</span><span class="hljs-params">(<span class="hljs-type">int</span> nCount)</span>
    </span>{
        m_nControlCount = nCount;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; nCount; i++)
        {
            <span class="hljs-comment">// 创建标签</span>
            m_pDynamicLabels[i] = <span class="hljs-keyword">new</span> CStatic;
            m_pDynamicLabels[i]-&gt;<span class="hljs-built_in">Create</span>(_T(<span class="hljs-string">"动态控件 "</span>) + <span class="hljs-built_in">CString</span>(<span class="hljs-built_in">char</span>(<span class="hljs-string">'A'</span> + i)),
                                       WS_CHILD | WS_VISIBLE,
                                       <span class="hljs-built_in">CRect</span>(<span class="hljs-number">10</span>, <span class="hljs-number">30</span> + i * <span class="hljs-number">30</span>, <span class="hljs-number">100</span>, <span class="hljs-number">50</span> + i * <span class="hljs-number">30</span>),
                                       <span class="hljs-keyword">this</span>);
            
            <span class="hljs-comment">// 创建编辑框</span>
            m_pDynamicEdits[i] = <span class="hljs-keyword">new</span> CEdit;
            m_pDynamicEdits[i]-&gt;<span class="hljs-built_in">Create</span>(WS_CHILD | WS_VISIBLE | WS_BORDER | ES_AUTOHSCROLL,
                                      <span class="hljs-built_in">CRect</span>(<span class="hljs-number">110</span>, <span class="hljs-number">30</span> + i * <span class="hljs-number">30</span>, <span class="hljs-number">210</span>, <span class="hljs-number">50</span> + i * <span class="hljs-number">30</span>),
                                      <span class="hljs-keyword">this</span>, IDC_DYNAMIC_START + i);
        }
    }
};
</code></pre>
<h4 data-id="heading-53">7.2 数据交换的性能优化</h4>
<p>对于包含大量控件的对话框，可以优化DDX性能：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">COptimizedDialog::DoDataExchange</span><span class="hljs-params">(CDataExchange* pDX)</span>
</span>{
    CDialogEx::<span class="hljs-built_in">DoDataExchange</span>(pDX);
    
    <span class="hljs-comment">// 使用条件编译或标志控制DDX范围</span>
    <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> FULL_DATA_EXCHANGE</span>
    <span class="hljs-comment">// 完整的数据交换</span>
    <span class="hljs-built_in">ExchangeAllData</span>(pDX);
    <span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
    <span class="hljs-comment">// 部分数据交换（根据需求）</span>
    <span class="hljs-keyword">if</span> (pDX-&gt;m_bSaveAndValidate)
    {
        <span class="hljs-comment">// 只验证必要字段</span>
        <span class="hljs-built_in">ExchangeRequiredData</span>(pDX);
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-comment">// 只更新可见字段</span>
        <span class="hljs-built_in">ExchangeVisibleData</span>(pDX);
    }
    <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}

<span class="hljs-comment">// 分组数据交换示例</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">COptimizedDialog::ExchangePersonalData</span><span class="hljs-params">(CDataExchange* pDX)</span>
</span>{
    <span class="hljs-built_in">DDX_Text</span>(pDX, IDC_EDIT_NAME, m_strName);
    <span class="hljs-built_in">DDX_Text</span>(pDX, IDC_EDIT_AGE, m_nAge);
    <span class="hljs-built_in">DDX_Text</span>(pDX, IDC_EDIT_PHONE, m_strPhone);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">COptimizedDialog::ExchangeWorkData</span><span class="hljs-params">(CDataExchange* pDX)</span>
</span>{
    <span class="hljs-built_in">DDX_Text</span>(pDX, IDC_EDIT_COMPANY, m_strCompany);
    <span class="hljs-built_in">DDX_Text</span>(pDX, IDC_EDIT_POSITION, m_strPosition);
}
</code></pre>
<h3 data-id="heading-54">八、对话框与文档/视图架构的集成</h3>
<p>对话框可以作为文档/视图架构的补充：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 在文档/视图应用中使用对话框</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyView::OnEditPreferences</span><span class="hljs-params">()</span>
</span>{
    CPreferencesDialog dlg;
    
    <span class="hljs-comment">// 从文档获取当前设置</span>
    CMyDocument* pDoc = <span class="hljs-built_in">GetDocument</span>();
    dlg.m_strDefaultPath = pDoc-&gt;<span class="hljs-built_in">GetDefaultPath</span>();
    dlg.m_nAutoSaveInterval = pDoc-&gt;<span class="hljs-built_in">GetAutoSaveInterval</span>();
    
    <span class="hljs-keyword">if</span> (dlg.<span class="hljs-built_in">DoModal</span>() == IDOK)
    {
        <span class="hljs-comment">// 更新文档设置</span>
        pDoc-&gt;<span class="hljs-built_in">SetDefaultPath</span>(dlg.m_strDefaultPath);
        pDoc-&gt;<span class="hljs-built_in">SetAutoSaveInterval</span>(dlg.m_nAutoSaveInterval);
        
        <span class="hljs-comment">// 标记文档为已修改</span>
        pDoc-&gt;<span class="hljs-built_in">SetModifiedFlag</span>(TRUE);
        
        <span class="hljs-comment">// 更新所有视图</span>
        pDoc-&gt;<span class="hljs-built_in">UpdateAllViews</span>(<span class="hljs-keyword">this</span>);
    }
}

<span class="hljs-comment">// 对话框数据变化实时更新视图</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CRealTimeDialog::OnChangeEditValue</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// 获取当前值</span>
    <span class="hljs-built_in">UpdateData</span>(TRUE);
    
    <span class="hljs-comment">// 实时更新预览</span>
    CPreviewDialog* pPreview = <span class="hljs-built_in">GetPreviewWindow</span>();
    <span class="hljs-keyword">if</span> (pPreview != <span class="hljs-literal">NULL</span>)
    {
        pPreview-&gt;<span class="hljs-built_in">UpdatePreview</span>(m_nValue, m_strText);
    }
}
</code></pre>
<h3 data-id="heading-55">九、常见问题与调试技巧</h3>
<h4 data-id="heading-56">9.1 DDX/DDV常见问题排查</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 调试DDX问题的技巧</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyDialog::DoDataExchange</span><span class="hljs-params">(CDataExchange* pDX)</span>
</span>{
    <span class="hljs-built_in">TRACE</span>(_T(<span class="hljs-string">"DoDataExchange called, m_bSaveAndValidate = %d\n"</span>), 
          pDX-&gt;m_bSaveAndValidate);
    
    CDialogEx::<span class="hljs-built_in">DoDataExchange</span>(pDX);
    
    <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _DEBUG</span>
    <span class="hljs-comment">// 调试模式下添加额外检查</span>
    <span class="hljs-keyword">if</span> (pDX-&gt;m_bSaveAndValidate)
    {
        <span class="hljs-comment">// 检查控件是否存在</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">GetDlgItem</span>(IDC_EDIT_NAME) == <span class="hljs-literal">NULL</span>)
        {
            <span class="hljs-built_in">TRACE0</span>(<span class="hljs-string">"错误: IDC_EDIT_NAME 控件不存在!\n"</span>);
            <span class="hljs-built_in">ASSERT</span>(FALSE);
        }
    }
    <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
    
    <span class="hljs-built_in">DDX_Text</span>(pDX, IDC_EDIT_NAME, m_strName);
    
    <span class="hljs-built_in">TRACE</span>(_T(<span class="hljs-string">"m_strName = %s\n"</span>), (LPCTSTR)m_strName);
}
</code></pre>
<h4 data-id="heading-57">9.2 内存泄漏检测</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 检测对话框相关的内存泄漏</span>
<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _DEBUG</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyDialog::OnDestroy</span><span class="hljs-params">()</span>
</span>{
    CDialogEx::<span class="hljs-built_in">OnDestroy</span>();
    
    <span class="hljs-comment">// 检查动态创建的控件是否被正确删除</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; m_nControlCount; i++)
    {
        <span class="hljs-comment">// 这些指针应该在PostNcDestroy中删除</span>
        <span class="hljs-built_in">ASSERT</span>(m_pDynamicEdits[i] == <span class="hljs-literal">NULL</span>);
    }
}

<span class="hljs-comment">// 重写PostNcDestroy确保资源清理</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyModelessDialog::PostNcDestroy</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// 清理动态控件</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; m_nControlCount; i++)
    {
        <span class="hljs-keyword">if</span> (m_pDynamicEdits[i] != <span class="hljs-literal">NULL</span>)
        {
            <span class="hljs-keyword">delete</span> m_pDynamicEdits[i];
            m_pDynamicEdits[i] = <span class="hljs-literal">NULL</span>;
        }
    }
    
    CDialogEx::<span class="hljs-built_in">PostNcDestroy</span>();
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>;
}
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre>
<h3 data-id="heading-58">十、现代替代方案与架构启示</h3>
<p>虽然MFC对话框机制有其历史局限性，但其设计思想对现代UI框架仍有影响：</p>
<ol>
<li><strong>数据绑定模式</strong>：WPF/XAML的数据绑定是DDX的进化版本</li>
<li><strong>MVVM模式</strong>：ViewModel作为数据中介，类似于MFC对话框的数据层</li>
<li><strong>响应式表单</strong>：Angular/React中的表单验证机制借鉴了DDV的思想</li>
</ol>
<p><strong>DDX/DDV机制的现代启示</strong>：</p>
<ul>
<li>声明式数据绑定优于命令式数据操作</li>
<li>数据验证应该与UI逻辑分离</li>
<li>类型安全是框架设计的重要目标</li>
<li>开发者体验（DX）直接影响框架的采用率</li>
</ul>
<p>MFC的对话框和DDX/DDV机制展示了如何在C++环境中实现类型安全的UI数据绑定。虽然具体实现已显陈旧，但其核心思想——通过元编程简化开发者工作、确保数据完整性、提供一致的编程模型——仍然是优秀框架设计的重要原则。</p>
<h2 data-id="heading-59">第四章：MFC图形设备接口(GDI)编程——Windows图形渲染的核心引擎</h2>
<h3 data-id="heading-60">一、GDI系统架构：从硬件抽象到应用程序</h3>
<p>Windows GDI（Graphics Device Interface）是Windows操作系统的图形核心子系统，MFC通过CDC类及其派生类对其进行面向对象封装。理解GDI的层次结构是掌握MFC绘图的基础：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c729af5b21c74643a2c392c3667275b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765794519&amp;x-signature=65LtXjXR43RYb9XFc%2BGT1dQD%2BXM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-61">二、设备上下文(CDC)的深入解析</h3>
<h4 data-id="heading-62">2.1 CDC类的基本原理</h4>
<p>设备上下文是GDI的核心概念，它代表了绘图表面的抽象，包含绘图所需的所有状态信息：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// CDC类的关键内部结构（概念性）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CDC</span> : <span class="hljs-keyword">public</span> CObject
{
<span class="hljs-keyword">protected</span>:
    HDC m_hDC;                 <span class="hljs-comment">// Windows设备上下文句柄</span>
    HDC m_hAttribDC;           <span class="hljs-comment">// 属性DC（用于打印等）</span>
    BOOL m_bPrinting;          <span class="hljs-comment">// 是否为打印DC</span>
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 构造函数与析构函数</span>
    <span class="hljs-built_in">CDC</span>();
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">CDC</span>();
    
    <span class="hljs-comment">// 设备上下文操作</span>
    <span class="hljs-function">BOOL <span class="hljs-title">Attach</span><span class="hljs-params">(HDC hDC)</span></span>;      <span class="hljs-comment">// 关联现有HDC</span>
    <span class="hljs-function">HDC <span class="hljs-title">Detach</span><span class="hljs-params">()</span></span>;              <span class="hljs-comment">// 分离HDC</span>
    <span class="hljs-function">HDC <span class="hljs-title">GetSafeHdc</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;    <span class="hljs-comment">// 安全获取HDC</span>
    
    <span class="hljs-comment">// 绘图状态管理</span>
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">SaveDC</span><span class="hljs-params">()</span></span>;              <span class="hljs-comment">// 保存DC状态</span>
    <span class="hljs-function">BOOL <span class="hljs-title">RestoreDC</span><span class="hljs-params">(<span class="hljs-type">int</span> nSavedDC)</span></span>; <span class="hljs-comment">// 恢复DC状态</span>
    
    <span class="hljs-comment">// 坐标与映射模式</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> CPoint <span class="hljs-title">GetViewportOrg</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> CSize <span class="hljs-title">GetViewportExt</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">int</span> <span class="hljs-title">SetMapMode</span><span class="hljs-params">(<span class="hljs-type">int</span> nMapMode)</span></span>;
    
    <span class="hljs-comment">// 绘图操作</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> BOOL <span class="hljs-title">LineTo</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> BOOL <span class="hljs-title">Rectangle</span><span class="hljs-params">(<span class="hljs-type">int</span> x1, <span class="hljs-type">int</span> y1, <span class="hljs-type">int</span> x2, <span class="hljs-type">int</span> y2)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> BOOL <span class="hljs-title">Ellipse</span><span class="hljs-params">(<span class="hljs-type">int</span> x1, <span class="hljs-type">int</span> y1, <span class="hljs-type">int</span> x2, <span class="hljs-type">int</span> y2)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> BOOL <span class="hljs-title">TextOut</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y, LPCTSTR lpszString, <span class="hljs-type">int</span> nCount)</span></span>;
    
    <span class="hljs-comment">// GDI对象管理</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> CGdiObject* <span class="hljs-title">SelectStockObject</span><span class="hljs-params">(<span class="hljs-type">int</span> nIndex)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> CGdiObject* <span class="hljs-title">SelectObject</span><span class="hljs-params">(CGdiObject* pObject)</span></span>;
    
    <span class="hljs-comment">// 设备能力查询</span>
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">GetDeviceCaps</span><span class="hljs-params">(<span class="hljs-type">int</span> nIndex)</span> <span class="hljs-type">const</span></span>;
    
    <span class="hljs-built_in">DECLARE_DYNAMIC</span>(CDC)
};
</code></pre>
<h4 data-id="heading-63">2.2 不同CDC派生类的使用场景</h4>
<p>MFC提供了多种CDC派生类以适应不同绘图需求：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 1. CPaintDC - 用于WM_PAINT消息处理</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyView::OnPaint</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-function">CPaintDC <span class="hljs-title">dc</span><span class="hljs-params">(<span class="hljs-keyword">this</span>)</span></span>; <span class="hljs-comment">// 自动调用BeginPaint</span>
    
    <span class="hljs-comment">// 获取无效区域</span>
    CRect rectUpdate;
    dc.<span class="hljs-built_in">GetClipBox</span>(&amp;rectUpdate);
    
    <span class="hljs-comment">// 执行绘图操作</span>
    <span class="hljs-built_in">OnDraw</span>(&amp;dc); <span class="hljs-comment">// 通常调用OnDraw进行实际绘制</span>
    
    <span class="hljs-comment">// 析构时自动调用EndPaint</span>
}

<span class="hljs-comment">// 2. CClientDC - 用于客户区即时绘图</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyView::OnMouseMove</span><span class="hljs-params">(UINT nFlags, CPoint point)</span>
</span>{
    <span class="hljs-keyword">if</span> (m_bDrawing)
    {
        <span class="hljs-function">CClientDC <span class="hljs-title">dc</span><span class="hljs-params">(<span class="hljs-keyword">this</span>)</span></span>; <span class="hljs-comment">// 获取客户区DC</span>
        
        <span class="hljs-comment">// 实时绘制反馈</span>
        dc.<span class="hljs-built_in">MoveTo</span>(m_ptLastPos);
        dc.<span class="hljs-built_in">LineTo</span>(point);
        
        m_ptLastPos = point;
    }
    
    CView::<span class="hljs-built_in">OnMouseMove</span>(nFlags, point);
}

<span class="hljs-comment">// 3. CWindowDC - 绘制整个窗口（包括非客户区）</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyFrameWnd::OnDrawBorder</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-function">CWindowDC <span class="hljs-title">dc</span><span class="hljs-params">(<span class="hljs-keyword">this</span>)</span></span>; <span class="hljs-comment">// 获取整个窗口DC</span>
    
    <span class="hljs-comment">// 绘制自定义窗口边框</span>
    CRect rectWindow;
    <span class="hljs-built_in">GetWindowRect</span>(&amp;rectWindow);
    
    <span class="hljs-comment">// 转换为客户区坐标</span>
    <span class="hljs-built_in">ScreenToClient</span>(&amp;rectWindow);
    
    <span class="hljs-comment">// 绘制边框</span>
    <span class="hljs-function">CPen <span class="hljs-title">pen</span><span class="hljs-params">(PS_SOLID, <span class="hljs-number">3</span>, RGB(<span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))</span></span>;
    dc.<span class="hljs-built_in">SelectObject</span>(&amp;pen);
    dc.<span class="hljs-built_in">SelectStockObject</span>(NULL_BRUSH);
    dc.<span class="hljs-built_in">Rectangle</span>(rectWindow);
}

<span class="hljs-comment">// 4. CMetaFileDC - 创建Windows图元文件</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyView::CreateMetaFile</span><span class="hljs-params">()</span>
</span>{
    CMetaFileDC dcMeta;
    
    <span class="hljs-comment">// 创建图元文件DC</span>
    <span class="hljs-keyword">if</span> (dcMeta.<span class="hljs-built_in">Create</span>())
    {
        <span class="hljs-comment">// 在图元文件中记录绘图命令</span>
        dcMeta.<span class="hljs-built_in">SetMapMode</span>(MM_ANISOTROPIC);
        dcMeta.<span class="hljs-built_in">SetWindowExt</span>(<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>);
        dcMeta.<span class="hljs-built_in">SetViewportExt</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
        
        <span class="hljs-comment">// 记录绘图操作</span>
        dcMeta.<span class="hljs-built_in">Rectangle</span>(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">500</span>, <span class="hljs-number">500</span>);
        dcMeta.<span class="hljs-built_in">Ellipse</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">400</span>, <span class="hljs-number">400</span>);
        
        <span class="hljs-comment">// 关闭图元文件</span>
        HMETAFILE hMetaFile = dcMeta.<span class="hljs-built_in">Close</span>();
        
        <span class="hljs-keyword">if</span> (hMetaFile != <span class="hljs-literal">NULL</span>)
        {
            <span class="hljs-comment">// 可以保存或回放图元文件</span>
            <span class="hljs-function">CClientDC <span class="hljs-title">dc</span><span class="hljs-params">(<span class="hljs-keyword">this</span>)</span></span>;
            dc.<span class="hljs-built_in">PlayMetaFile</span>(hMetaFile);
            
            <span class="hljs-comment">// 删除图元文件句柄</span>
            ::<span class="hljs-built_in">DeleteMetaFile</span>(hMetaFile);
        }
    }
}
</code></pre>
<h3 data-id="heading-64">三、GDI对象管理与资源生命周期</h3>
<h4 data-id="heading-65">3.1 GDI对象的基本使用模式</h4>
<p>正确的GDI对象管理是防止资源泄漏的关键：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyView::OnDraw</span><span class="hljs-params">(CDC* pDC)</span>
</span>{
    <span class="hljs-comment">// 1. 创建GDI对象</span>
    <span class="hljs-function">CPen <span class="hljs-title">newPen</span><span class="hljs-params">(PS_SOLID, <span class="hljs-number">2</span>, RGB(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>))</span></span>;
    <span class="hljs-function">CBrush <span class="hljs-title">newBrush</span><span class="hljs-params">(RGB(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>))</span></span>;
    CFont newFont;
    
    <span class="hljs-comment">// 创建字体</span>
    LOGFONT lf = {<span class="hljs-number">0</span>};
    lf.lfHeight = <span class="hljs-number">-16</span>;
    lf.lfWeight = FW_BOLD;
    <span class="hljs-built_in">lstrcpy</span>(lf.lfFaceName, _T(<span class="hljs-string">"Arial"</span>));
    newFont.<span class="hljs-built_in">CreateFontIndirect</span>(&amp;lf);
    
    <span class="hljs-comment">// 2. 保存旧对象并选入新对象</span>
    CPen* pOldPen = pDC-&gt;<span class="hljs-built_in">SelectObject</span>(&amp;newPen);
    CBrush* pOldBrush = pDC-&gt;<span class="hljs-built_in">SelectObject</span>(&amp;newBrush);
    CFont* pOldFont = pDC-&gt;<span class="hljs-built_in">SelectObject</span>(&amp;newFont);
    
    <span class="hljs-comment">// 3. 执行绘图操作</span>
    pDC-&gt;<span class="hljs-built_in">Rectangle</span>(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">200</span>, <span class="hljs-number">150</span>);
    pDC-&gt;<span class="hljs-built_in">Ellipse</span>(<span class="hljs-number">50</span>, <span class="hljs-number">50</span>, <span class="hljs-number">150</span>, <span class="hljs-number">100</span>);
    pDC-&gt;<span class="hljs-built_in">TextOut</span>(<span class="hljs-number">20</span>, <span class="hljs-number">20</span>, _T(<span class="hljs-string">"GDI绘图示例"</span>));
    
    <span class="hljs-comment">// 4. 恢复旧对象（按相反顺序）</span>
    pDC-&gt;<span class="hljs-built_in">SelectObject</span>(pOldFont);
    pDC-&gt;<span class="hljs-built_in">SelectObject</span>(pOldBrush);
    pDC-&gt;<span class="hljs-built_in">SelectObject</span>(pOldPen);
    
    <span class="hljs-comment">// 5. GDI对象在作用域结束时自动删除</span>
    <span class="hljs-comment">//    注意：如果调用DeleteObject，需确保不再使用该对象</span>
}
</code></pre>
<h4 data-id="heading-66">3.2 GDI对象的创建工厂模式</h4>
<p>对于需要频繁创建相同样式GDI对象的情况，可以使用工厂模式：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CGdiObjectFactory</span>
{
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">static</span> CMap&lt;DWORD, DWORD, CPen*, CPen*&gt; m_mapPens;
    <span class="hljs-type">static</span> CMap&lt;DWORD, DWORD, CBrush*, CBrush*&gt; m_mapBrushes;
    <span class="hljs-type">static</span> CCriticalSection m_cs; <span class="hljs-comment">// 线程保护</span>
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 获取或创建指定样式的画笔</span>
    <span class="hljs-function"><span class="hljs-type">static</span> CPen* <span class="hljs-title">GetPen</span><span class="hljs-params">(<span class="hljs-type">int</span> nStyle, <span class="hljs-type">int</span> nWidth, COLORREF crColor)</span>
    </span>{
        <span class="hljs-function">CSingleLock <span class="hljs-title">lock</span><span class="hljs-params">(&amp;m_cs, TRUE)</span></span>;
        
        <span class="hljs-comment">// 创建唯一键</span>
        DWORD dwKey = (nStyle &lt;&lt; <span class="hljs-number">24</span>) | (nWidth &lt;&lt; <span class="hljs-number">16</span>) | crColor;
        
        CPen* pPen = <span class="hljs-literal">NULL</span>;
        <span class="hljs-keyword">if</span> (!m_mapPens.<span class="hljs-built_in">Lookup</span>(dwKey, pPen))
        {
            <span class="hljs-comment">// 创建新画笔</span>
            pPen = <span class="hljs-keyword">new</span> <span class="hljs-built_in">CPen</span>(nStyle, nWidth, crColor);
            m_mapPens.<span class="hljs-built_in">SetAt</span>(dwKey, pPen);
        }
        
        <span class="hljs-keyword">return</span> pPen;
    }
    
    <span class="hljs-comment">// 清理所有GDI对象</span>
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">Cleanup</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-function">CSingleLock <span class="hljs-title">lock</span><span class="hljs-params">(&amp;m_cs, TRUE)</span></span>;
        
        <span class="hljs-comment">// 删除所有画笔</span>
        POSITION pos = m_mapPens.<span class="hljs-built_in">GetStartPosition</span>();
        DWORD dwKey;
        CPen* pPen;
        <span class="hljs-keyword">while</span> (pos != <span class="hljs-literal">NULL</span>)
        {
            m_mapPens.<span class="hljs-built_in">GetNextAssoc</span>(pos, dwKey, pPen);
            <span class="hljs-keyword">delete</span> pPen;
        }
        m_mapPens.<span class="hljs-built_in">RemoveAll</span>();
        
        <span class="hljs-comment">// 类似地清理画刷等</span>
    }
};
</code></pre>
<h3 data-id="heading-67">四、高级绘图技术与优化</h3>
<h4 data-id="heading-68">4.1 双缓冲绘图技术</h4>
<p>双缓冲是消除绘图闪烁的关键技术：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CDoubleBufferDC</span> : <span class="hljs-keyword">public</span> CDC
{
<span class="hljs-keyword">private</span>:
    CDC* m_pDC;            <span class="hljs-comment">// 原始设备上下文</span>
    CBitmap m_bitmap;      <span class="hljs-comment">// 内存位图</span>
    CBitmap* m_pOldBitmap; <span class="hljs-comment">// 旧位图</span>
    CRect m_rect;          <span class="hljs-comment">// 绘制区域</span>
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">CDoubleBufferDC</span>(CDC* pDC, <span class="hljs-type">const</span> CRect&amp; rect)
        : <span class="hljs-built_in">m_pDC</span>(pDC), <span class="hljs-built_in">m_rect</span>(rect)
    {
        <span class="hljs-comment">// 创建兼容的内存DC</span>
        <span class="hljs-built_in">CreateCompatibleDC</span>(pDC);
        
        <span class="hljs-comment">// 创建兼容位图</span>
        m_bitmap.<span class="hljs-built_in">CreateCompatibleBitmap</span>(pDC, rect.<span class="hljs-built_in">Width</span>(), rect.<span class="hljs-built_in">Height</span>());
        
        <span class="hljs-comment">// 选入位图</span>
        m_pOldBitmap = <span class="hljs-built_in">SelectObject</span>(&amp;m_bitmap);
        
        <span class="hljs-comment">// 设置原点偏移</span>
        <span class="hljs-built_in">SetViewportOrg</span>(-rect.left, -rect.top);
    }
    
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">CDoubleBufferDC</span>()
    {
        <span class="hljs-comment">// 将内存位图拷贝到屏幕</span>
        m_pDC-&gt;<span class="hljs-built_in">BitBlt</span>(m_rect.left, m_rect.top, 
                     m_rect.<span class="hljs-built_in">Width</span>(), m_rect.<span class="hljs-built_in">Height</span>(),
                     <span class="hljs-keyword">this</span>, 
                     m_rect.left, m_rect.top, 
                     SRCCOPY);
        
        <span class="hljs-comment">// 恢复原始位图</span>
        <span class="hljs-built_in">SelectObject</span>(m_pOldBitmap);
        
        <span class="hljs-comment">// 位图对象自动删除</span>
    }
};

<span class="hljs-comment">// 在视图类中使用双缓冲</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyView::OnDraw</span><span class="hljs-params">(CDC* pDC)</span>
</span>{
    CRect rectClient;
    <span class="hljs-built_in">GetClientRect</span>(&amp;rectClient);
    
    <span class="hljs-comment">// 创建双缓冲DC</span>
    <span class="hljs-function">CDoubleBufferDC <span class="hljs-title">dbDC</span><span class="hljs-params">(pDC, rectClient)</span></span>;
    
    <span class="hljs-comment">// 使用dbDC进行所有绘图操作</span>
    <span class="hljs-built_in">DrawBackground</span>(&amp;dbDC, rectClient);
    <span class="hljs-built_in">DrawContent</span>(&amp;dbDC, rectClient);
    <span class="hljs-built_in">DrawOverlay</span>(&amp;dbDC, rectClient);
    
    <span class="hljs-comment">// dbDC析构时自动刷新到屏幕</span>
}
</code></pre>
<h4 data-id="heading-69">4.2 路径与复杂区域操作</h4>
<p>路径提供了一种记录和重用复杂绘图序列的方法：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyView::DrawComplexShape</span><span class="hljs-params">(CDC* pDC)</span>
</span>{
    <span class="hljs-comment">// 开始路径定义</span>
    pDC-&gt;<span class="hljs-built_in">BeginPath</span>();
    
    <span class="hljs-comment">// 定义路径形状</span>
    pDC-&gt;<span class="hljs-built_in">MoveTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
    pDC-&gt;<span class="hljs-built_in">LineTo</span>(<span class="hljs-number">200</span>, <span class="hljs-number">100</span>);
    pDC-&gt;<span class="hljs-built_in">LineTo</span>(<span class="hljs-number">200</span>, <span class="hljs-number">200</span>);
    pDC-&gt;<span class="hljs-built_in">LineTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">200</span>);
    pDC-&gt;<span class="hljs-built_in">LineTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">// 闭合矩形</span>
    
    <span class="hljs-comment">// 添加第二个形状</span>
    pDC-&gt;<span class="hljs-built_in">MoveTo</span>(<span class="hljs-number">150</span>, <span class="hljs-number">50</span>);
    pDC-&gt;<span class="hljs-built_in">LineTo</span>(<span class="hljs-number">250</span>, <span class="hljs-number">150</span>);
    pDC-&gt;<span class="hljs-built_in">LineTo</span>(<span class="hljs-number">50</span>, <span class="hljs-number">150</span>);
    pDC-&gt;<span class="hljs-built_in">CloseFigure</span>(); <span class="hljs-comment">// 闭合三角形</span>
    
    <span class="hljs-comment">// 结束路径定义</span>
    pDC-&gt;<span class="hljs-built_in">EndPath</span>();
    
    <span class="hljs-comment">// 1. 绘制路径轮廓</span>
    <span class="hljs-function">CPen <span class="hljs-title">pen</span><span class="hljs-params">(PS_SOLID, <span class="hljs-number">2</span>, RGB(<span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))</span></span>;
    CPen* pOldPen = pDC-&gt;<span class="hljs-built_in">SelectObject</span>(&amp;pen);
    pDC-&gt;<span class="hljs-built_in">StrokePath</span>();
    pDC-&gt;<span class="hljs-built_in">SelectObject</span>(pOldPen);
    
    <span class="hljs-comment">// 2. 填充路径</span>
    <span class="hljs-function">CBrush <span class="hljs-title">brush</span><span class="hljs-params">(RGB(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>))</span></span>;
    CBrush* pOldBrush = pDC-&gt;<span class="hljs-built_in">SelectObject</span>(&amp;brush);
    pDC-&gt;<span class="hljs-built_in">FillPath</span>();
    pDC-&gt;<span class="hljs-built_in">SelectObject</span>(pOldBrush);
    
    <span class="hljs-comment">// 3. 将路径转换为区域</span>
    CRgn region;
    <span class="hljs-keyword">if</span> (region.<span class="hljs-built_in">CreateFromPath</span>(pDC))
    {
        <span class="hljs-comment">// 使用区域进行点击测试</span>
        <span class="hljs-function">CPoint <span class="hljs-title">ptTest</span><span class="hljs-params">(<span class="hljs-number">120</span>, <span class="hljs-number">120</span>)</span></span>;
        <span class="hljs-keyword">if</span> (region.<span class="hljs-built_in">PtInRegion</span>(ptTest))
        {
            pDC-&gt;<span class="hljs-built_in">TextOut</span>(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, _T(<span class="hljs-string">"点在区域内"</span>));
        }
        
        <span class="hljs-comment">// 区域也可以用于裁剪</span>
        pDC-&gt;<span class="hljs-built_in">SelectClipRgn</span>(&amp;region);
        <span class="hljs-comment">// ... 在裁剪区域内绘图</span>
        pDC-&gt;<span class="hljs-built_in">SelectClipRgn</span>(<span class="hljs-literal">NULL</span>); <span class="hljs-comment">// 取消裁剪</span>
    }
}
</code></pre>
<h4 data-id="heading-70">4.3 坐标系统与变换</h4>
<p>MFC支持多种坐标映射模式和变换：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyView::DemonstrateCoordinateSystems</span><span class="hljs-params">(CDC* pDC)</span>
</span>{
    <span class="hljs-comment">// 保存原始DC状态</span>
    <span class="hljs-type">int</span> nOldMapMode = pDC-&gt;<span class="hljs-built_in">SaveDC</span>();
    
    <span class="hljs-comment">// 示例1：逻辑坐标与设备坐标</span>
    pDC-&gt;<span class="hljs-built_in">SetMapMode</span>(MM_TEXT); <span class="hljs-comment">// 默认模式，1逻辑单位=1像素</span>
    
    <span class="hljs-comment">// 设置窗口（逻辑）和视口（设备）范围</span>
    pDC-&gt;<span class="hljs-built_in">SetWindowExt</span>(<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>);  <span class="hljs-comment">// 逻辑范围</span>
    pDC-&gt;<span class="hljs-built_in">SetViewportExt</span>(<span class="hljs-number">500</span>, <span class="hljs-number">500</span>);  <span class="hljs-comment">// 设备范围</span>
    
    <span class="hljs-comment">// 示例2：使用MM_ANISOTROPIC模式</span>
    pDC-&gt;<span class="hljs-built_in">SetMapMode</span>(MM_ANISOTROPIC);
    pDC-&gt;<span class="hljs-built_in">SetWindowExt</span>(<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>);
    pDC-&gt;<span class="hljs-built_in">SetViewportExt</span>(rectClient.<span class="hljs-built_in">Width</span>(), rectClient.<span class="hljs-built_in">Height</span>());
    
    <span class="hljs-comment">// 绘制随窗口大小缩放的图形</span>
    pDC-&gt;<span class="hljs-built_in">Rectangle</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">900</span>, <span class="hljs-number">900</span>);
    
    <span class="hljs-comment">// 示例3：使用MM_HIMETRIC模式（物理尺寸）</span>
    pDC-&gt;<span class="hljs-built_in">SetMapMode</span>(MM_HIMETRIC); <span class="hljs-comment">// 0.01毫米单位</span>
    pDC-&gt;<span class="hljs-built_in">Rectangle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">-5000</span>); <span class="hljs-comment">// 10cm x 5cm矩形</span>
    
    <span class="hljs-comment">// 坐标转换示例</span>
    <span class="hljs-function">CPoint <span class="hljs-title">ptLogical</span><span class="hljs-params">(<span class="hljs-number">500</span>, <span class="hljs-number">500</span>)</span></span>;
    CPoint ptDevice;
    
    <span class="hljs-comment">// 逻辑坐标转设备坐标</span>
    pDC-&gt;<span class="hljs-built_in">LPtoDP</span>(&amp;ptLogical);
    
    <span class="hljs-comment">// 设备坐标转逻辑坐标</span>
    pDC-&gt;<span class="hljs-built_in">DPtoLP</span>(&amp;ptDevice);
    
    <span class="hljs-comment">// 示例4：世界变换（Windows NT/2000+）</span>
    <span class="hljs-keyword">if</span> (pDC-&gt;<span class="hljs-built_in">GetDeviceCaps</span>(RASTERCAPS) &amp; RC_TRANSFORM)
    {
        XFORM xform;
        
        <span class="hljs-comment">// 设置旋转矩阵（旋转30度）</span>
        <span class="hljs-type">float</span> fAngle = <span class="hljs-number">30.0f</span> * <span class="hljs-number">3.14159f</span> / <span class="hljs-number">180.0f</span>;
        xform.eM11 = <span class="hljs-built_in">cos</span>(fAngle);
        xform.eM12 = <span class="hljs-built_in">sin</span>(fAngle);
        xform.eM21 = -<span class="hljs-built_in">sin</span>(fAngle);
        xform.eM22 = <span class="hljs-built_in">cos</span>(fAngle);
        xform.eDx = <span class="hljs-number">100.0f</span>;  <span class="hljs-comment">// X方向平移</span>
        xform.eDy = <span class="hljs-number">100.0f</span>;  <span class="hljs-comment">// Y方向平移</span>
        
        <span class="hljs-comment">// 设置世界变换</span>
        pDC-&gt;<span class="hljs-built_in">SetGraphicsMode</span>(GM_ADVANCED);
        pDC-&gt;<span class="hljs-built_in">SetWorldTransform</span>(&amp;xform);
        
        <span class="hljs-comment">// 绘制变换后的图形</span>
        pDC-&gt;<span class="hljs-built_in">Rectangle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
        
        <span class="hljs-comment">// 恢复默认变换</span>
        pDC-&gt;<span class="hljs-built_in">ModifyWorldTransform</span>(<span class="hljs-literal">NULL</span>, MWT_IDENTITY);
    }
    
    <span class="hljs-comment">// 恢复原始DC状态</span>
    pDC-&gt;<span class="hljs-built_in">RestoreDC</span>(nOldMapMode);
}
</code></pre>
<h3 data-id="heading-71">五、字体与文本渲染</h3>
<h4 data-id="heading-72">5.1 字体创建与文本度量</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CTextRenderer</span>
{
<span class="hljs-keyword">private</span>:
    CFont m_fontNormal;
    CFont m_fontBold;
    CFont m_fontItalic;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">BOOL <span class="hljs-title">InitializeFonts</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-comment">// 创建不同风格的字体</span>
        LOGFONT lf = {<span class="hljs-number">0</span>};
        
        <span class="hljs-comment">// 标准字体</span>
        lf.lfHeight = <span class="hljs-number">-16</span>; <span class="hljs-comment">// 16像素高（负值表示字符高度）</span>
        lf.lfWeight = FW_NORMAL;
        lf.lfCharSet = DEFAULT_CHARSET;
        <span class="hljs-built_in">lstrcpy</span>(lf.lfFaceName, _T(<span class="hljs-string">"微软雅黑"</span>));
        m_fontNormal.<span class="hljs-built_in">CreateFontIndirect</span>(&amp;lf);
        
        <span class="hljs-comment">// 粗体</span>
        lf.lfWeight = FW_BOLD;
        m_fontBold.<span class="hljs-built_in">CreateFontIndirect</span>(&amp;lf);
        
        <span class="hljs-comment">// 斜体</span>
        lf.lfWeight = FW_NORMAL;
        lf.lfItalic = TRUE;
        m_fontItalic.<span class="hljs-built_in">CreateFontIndirect</span>(&amp;lf);
        
        <span class="hljs-keyword">return</span> TRUE;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawTextWithMetrics</span><span class="hljs-params">(CDC* pDC, <span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y, LPCTSTR lpszText)</span>
    </span>{
        CFont* pOldFont = pDC-&gt;<span class="hljs-built_in">SelectObject</span>(&amp;m_fontNormal);
        
        <span class="hljs-comment">// 获取文本度量信息</span>
        TEXTMETRIC tm;
        pDC-&gt;<span class="hljs-built_in">GetTextMetrics</span>(&amp;tm);
        
        <span class="hljs-comment">// 计算文本宽度</span>
        CSize sizeText = pDC-&gt;<span class="hljs-built_in">GetTextExtent</span>(lpszText, <span class="hljs-built_in">lstrlen</span>(lpszText));
        
        <span class="hljs-comment">// 绘制背景</span>
        <span class="hljs-function">CRect <span class="hljs-title">rectText</span><span class="hljs-params">(x, y, x + sizeText.cx, y + tm.tmHeight)</span></span>;
        <span class="hljs-function">CBrush <span class="hljs-title">brushBg</span><span class="hljs-params">(RGB(<span class="hljs-number">240</span>, <span class="hljs-number">240</span>, <span class="hljs-number">240</span>))</span></span>;
        pDC-&gt;<span class="hljs-built_in">FillRect</span>(&amp;rectText, &amp;brushBg);
        
        <span class="hljs-comment">// 绘制文本</span>
        pDC-&gt;<span class="hljs-built_in">SetBkMode</span>(TRANSPARENT);
        pDC-&gt;<span class="hljs-built_in">TextOut</span>(x, y, lpszText);
        
        <span class="hljs-comment">// 绘制基线</span>
        <span class="hljs-function">CPen <span class="hljs-title">penBaseline</span><span class="hljs-params">(PS_SOLID, <span class="hljs-number">1</span>, RGB(<span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))</span></span>;
        CPen* pOldPen = pDC-&gt;<span class="hljs-built_in">SelectObject</span>(&amp;penBaseline);
        pDC-&gt;<span class="hljs-built_in">MoveTo</span>(x, y + tm.tmAscent);
        pDC-&gt;<span class="hljs-built_in">LineTo</span>(x + sizeText.cx, y + tm.tmAscent);
        
        <span class="hljs-comment">// 绘制边界框</span>
        <span class="hljs-function">CPen <span class="hljs-title">penBorder</span><span class="hljs-params">(PS_DOT, <span class="hljs-number">1</span>, RGB(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>))</span></span>;
        pDC-&gt;<span class="hljs-built_in">SelectObject</span>(&amp;penBorder);
        pDC-&gt;<span class="hljs-built_in">SelectStockObject</span>(NULL_BRUSH);
        pDC-&gt;<span class="hljs-built_in">Rectangle</span>(&amp;rectText);
        
        pDC-&gt;<span class="hljs-built_in">SelectObject</span>(pOldPen);
        pDC-&gt;<span class="hljs-built_in">SelectObject</span>(pOldFont);
    }
    
    <span class="hljs-comment">// 多行文本绘制</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawMultilineText</span><span class="hljs-params">(CDC* pDC, CRect rect, LPCTSTR lpszText)</span>
    </span>{
        CFont* pOldFont = pDC-&gt;<span class="hljs-built_in">SelectObject</span>(&amp;m_fontNormal);
        
        <span class="hljs-comment">// 设置文本格式</span>
        UINT uFormat = DT_LEFT | DT_WORDBREAK | DT_NOPREFIX | DT_EDITCONTROL;
        
        <span class="hljs-comment">// 计算需要的矩形高度</span>
        CRect rectCalc = rect;
        pDC-&gt;<span class="hljs-built_in">DrawText</span>(lpszText, <span class="hljs-number">-1</span>, &amp;rectCalc, uFormat | DT_CALCRECT);
        
        <span class="hljs-comment">// 绘制文本</span>
        pDC-&gt;<span class="hljs-built_in">DrawText</span>(lpszText, <span class="hljs-number">-1</span>, &amp;rect, uFormat);
        
        pDC-&gt;<span class="hljs-built_in">SelectObject</span>(pOldFont);
    }
};
</code></pre>
<h4 data-id="heading-73">5.2 高级文本效果</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CMyView::DrawTextEffects</span><span class="hljs-params">(CDC* pDC)</span>
</span>{
    CRect rectClient;
    <span class="hljs-built_in">GetClientRect</span>(&amp;rectClient);
    
    <span class="hljs-comment">// 1. 阴影文字</span>
    <span class="hljs-built_in">DrawShadowText</span>(pDC, _T(<span class="hljs-string">"阴影效果"</span>), 
                   <span class="hljs-built_in">CPoint</span>(<span class="hljs-number">50</span>, <span class="hljs-number">50</span>), 
                   <span class="hljs-built_in">RGB</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-built_in">RGB</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>));
    
    <span class="hljs-comment">// 2. 渐变文字</span>
    <span class="hljs-built_in">DrawGradientText</span>(pDC, _T(<span class="hljs-string">"渐变文字"</span>), 
                     <span class="hljs-built_in">CPoint</span>(<span class="hljs-number">50</span>, <span class="hljs-number">100</span>), 
                     <span class="hljs-built_in">RGB</span>(<span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-built_in">RGB</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>));
    
    <span class="hljs-comment">// 3. 轮廓文字</span>
    <span class="hljs-built_in">DrawOutlineText</span>(pDC, _T(<span class="hljs-string">"轮廓文字"</span>), 
                    <span class="hljs-built_in">CPoint</span>(<span class="hljs-number">50</span>, <span class="hljs-number">150</span>), 
                    <span class="hljs-number">3</span>, <span class="hljs-built_in">RGB</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>), <span class="hljs-built_in">RGB</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawShadowText</span><span class="hljs-params">(CDC* pDC, LPCTSTR lpszText, CPoint pt, 
                    COLORREF crText, COLORREF crShadow)</span>
</span>{
    CFont font;
    LOGFONT lf = {<span class="hljs-number">0</span>};
    lf.lfHeight = <span class="hljs-number">-48</span>;
    lf.lfWeight = FW_BOLD;
    <span class="hljs-built_in">lstrcpy</span>(lf.lfFaceName, _T(<span class="hljs-string">"Arial"</span>));
    font.<span class="hljs-built_in">CreateFontIndirect</span>(&amp;lf);
    
    CFont* pOldFont = pDC-&gt;<span class="hljs-built_in">SelectObject</span>(&amp;font);
    
    <span class="hljs-comment">// 绘制阴影</span>
    pDC-&gt;<span class="hljs-built_in">SetTextColor</span>(crShadow);
    pDC-&gt;<span class="hljs-built_in">TextOut</span>(pt.x + <span class="hljs-number">3</span>, pt.y + <span class="hljs-number">3</span>, lpszText);
    
    <span class="hljs-comment">// 绘制前景文字</span>
    pDC-&gt;<span class="hljs-built_in">SetTextColor</span>(crText);
    pDC-&gt;<span class="hljs-built_in">TextOut</span>(pt.x, pt.y, lpszText);
    
    pDC-&gt;<span class="hljs-built_in">SelectObject</span>(pOldFont);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawGradientText</span><span class="hljs-params">(CDC* pDC, LPCTSTR lpszText, CPoint pt,
                      COLORREF crStart, COLORREF crEnd)</span>
</span>{
    <span class="hljs-comment">// 创建字体</span>
    CFont font;
    LOGFONT lf = {<span class="hljs-number">0</span>};
    lf.lfHeight = <span class="hljs-number">-48</span>;
    lf.lfWeight = FW_BOLD;
    <span class="hljs-built_in">lstrcpy</span>(lf.lfFaceName, _T(<span class="hljs-string">"Arial"</span>));
    font.<span class="hljs-built_in">CreateFontIndirect</span>(&amp;lf);
    
    CFont* pOldFont = pDC-&gt;<span class="hljs-built_in">SelectObject</span>(&amp;font);
    
    <span class="hljs-comment">// 获取文本尺寸</span>
    CSize sizeText = pDC-&gt;<span class="hljs-built_in">GetTextExtent</span>(lpszText, <span class="hljs-built_in">lstrlen</span>(lpszText));
    
    <span class="hljs-comment">// 创建渐变画刷</span>
    TRIVERTEX vert[<span class="hljs-number">2</span>] = {<span class="hljs-number">0</span>};
    vert[<span class="hljs-number">0</span>].x = pt.x;
    vert[<span class="hljs-number">0</span>].y = pt.y;
    vert[<span class="hljs-number">0</span>].Red = <span class="hljs-built_in">GetRValue</span>(crStart) &lt;&lt; <span class="hljs-number">8</span>;
    vert[<span class="hljs-number">0</span>].Green = <span class="hljs-built_in">GetGValue</span>(crStart) &lt;&lt; <span class="hljs-number">8</span>;
    vert[<span class="hljs-number">0</span>].Blue = <span class="hljs-built_in">GetBValue</span>(crStart) &lt;&lt; <span class="hljs-number">8</span>;
    vert[<span class="hljs-number">0</span>].Alpha = <span class="hljs-number">0x0000</span>;
    
    vert[<span class="hljs-number">1</span>].x = pt.x + sizeText.cx;
    vert[<span class="hljs-number">1</span>].y = pt.y + sizeText.cy;
    vert[<span class="hljs-number">1</span>].Red = <span class="hljs-built_in">GetRValue</span>(crEnd) &lt;&lt; <span class="hljs-number">8</span>;
    vert[<span class="hljs-number">1</span>].Green = <span class="hljs-built_in">GetGValue</span>(crEnd) &lt;&lt; <span class="hljs-number">8</span>;
    vert[<span class="hljs-number">1</span>].Blue = <span class="hljs-built_in">GetBValue</span>(crEnd) &lt;&lt; <span class="hljs-number">8</span>;
    vert[<span class="hljs-number">1</span>].Alpha = <span class="hljs-number">0x0000</span>;
    
    GRADIENT_RECT gRect = {<span class="hljs-number">0</span>, <span class="hljs-number">1</span>};
    
    <span class="hljs-comment">// 使用路径创建文本轮廓</span>
    pDC-&gt;<span class="hljs-built_in">BeginPath</span>();
    pDC-&gt;<span class="hljs-built_in">TextOut</span>(pt.x, pt.y, lpszText);
    pDC-&gt;<span class="hljs-built_in">EndPath</span>();
    
    <span class="hljs-comment">// 用渐变填充文本路径</span>
    pDC-&gt;<span class="hljs-built_in">SelectClipPath</span>(RGN_COPY);
    pDC-&gt;<span class="hljs-built_in">GradientFill</span>(vert, <span class="hljs-number">2</span>, &amp;gRect, <span class="hljs-number">1</span>, GRADIENT_FILL_RECT_H);
    
    pDC-&gt;<span class="hljs-built_in">SelectObject</span>(pOldFont);
}
</code></pre>
<h3 data-id="heading-74">六、位图操作与图像处理</h3>
<h4 data-id="heading-75">6.1 位图加载与显示优化</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CBitmapManager</span>
{
<span class="hljs-keyword">private</span>:
    CMap&lt;UINT, UINT, CBitmap*, CBitmap*&gt; m_mapBitmaps;
    CSize m_sizeDisplay; <span class="hljs-comment">// 显示尺寸缓存</span>
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">CBitmapManager</span>() : <span class="hljs-built_in">m_sizeDisplay</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) {}
    
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">CBitmapManager</span>()
    {
        <span class="hljs-built_in">Cleanup</span>();
    }
    
    <span class="hljs-comment">// 从资源加载位图</span>
    <span class="hljs-function">CBitmap* <span class="hljs-title">LoadBitmapFromResource</span><span class="hljs-params">(UINT nIDResource, 
                                    CSize sizeTarget = CSize(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>))</span>
    </span>{
        CBitmap* pBitmap = <span class="hljs-literal">NULL</span>;
        
        <span class="hljs-keyword">if</span> (m_mapBitmaps.<span class="hljs-built_in">Lookup</span>(nIDResource, pBitmap))
            <span class="hljs-keyword">return</span> pBitmap;
        
        <span class="hljs-comment">// 加载原始位图</span>
        CBitmap bmpOriginal;
        <span class="hljs-keyword">if</span> (!bmpOriginal.<span class="hljs-built_in">LoadBitmap</span>(nIDResource))
            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
        
        <span class="hljs-comment">// 获取原始尺寸</span>
        BITMAP bmInfo;
        bmpOriginal.<span class="hljs-built_in">GetBitmap</span>(&amp;bmInfo);
        
        <span class="hljs-function">CSize <span class="hljs-title">sizeSource</span><span class="hljs-params">(bmInfo.bmWidth, bmInfo.bmHeight)</span></span>;
        
        <span class="hljs-comment">// 如果需要缩放</span>
        <span class="hljs-keyword">if</span> (sizeTarget.cx &gt; <span class="hljs-number">0</span> &amp;&amp; sizeTarget.cy &gt; <span class="hljs-number">0</span> &amp;&amp; 
            (sizeTarget != sizeSource))
        {
            pBitmap = <span class="hljs-built_in">ScaleBitmap</span>(&amp;bmpOriginal, sizeSource, sizeTarget);
        }
        <span class="hljs-keyword">else</span>
        {
            pBitmap = <span class="hljs-keyword">new</span> CBitmap;
            pBitmap-&gt;<span class="hljs-built_in">Attach</span>(bmpOriginal.<span class="hljs-built_in">Detach</span>());
        }
        
        m_mapBitmaps.<span class="hljs-built_in">SetAt</span>(nIDResource, pBitmap);
        <span class="hljs-keyword">return</span> pBitmap;
    }
    
    <span class="hljs-comment">// 位图缩放函数</span>
    <span class="hljs-function">CBitmap* <span class="hljs-title">ScaleBitmap</span><span class="hljs-params">(CBitmap* pSrcBitmap, CSize sizeSrc, CSize sizeDst)</span>
    </span>{
        <span class="hljs-comment">// 创建源DC和目标DC</span>
        <span class="hljs-function">CWindowDC <span class="hljs-title">dcScreen</span><span class="hljs-params">(<span class="hljs-literal">NULL</span>)</span></span>;
        CDC dcSrc, dcDst;
        
        dcSrc.<span class="hljs-built_in">CreateCompatibleDC</span>(&amp;dcScreen);
        dcDst.<span class="hljs-built_in">CreateCompatibleDC</span>(&amp;dcScreen);
        
        <span class="hljs-comment">// 创建目标位图</span>
        CBitmap* pDstBitmap = <span class="hljs-keyword">new</span> CBitmap;
        pDstBitmap-&gt;<span class="hljs-built_in">CreateCompatibleBitmap</span>(&amp;dcScreen, 
                                          sizeDst.cx, sizeDst.cy);
        
        <span class="hljs-comment">// 选入位图</span>
        CBitmap* pOldSrcBitmap = dcSrc.<span class="hljs-built_in">SelectObject</span>(pSrcBitmap);
        CBitmap* pOldDstBitmap = dcDst.<span class="hljs-built_in">SelectObject</span>(pDstBitmap);
        
        <span class="hljs-comment">// 设置拉伸模式</span>
        dcDst.<span class="hljs-built_in">SetStretchBltMode</span>(HALFTONE);
        dcDst.<span class="hljs-built_in">SetBrushOrg</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        
        <span class="hljs-comment">// 执行缩放</span>
        dcDst.<span class="hljs-built_in">StretchBlt</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sizeDst.cx, sizeDst.cy,
                        &amp;dcSrc, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sizeSrc.cx, sizeSrc.cy,
                        SRCCOPY);
        
        <span class="hljs-comment">// 恢复并清理</span>
        dcSrc.<span class="hljs-built_in">SelectObject</span>(pOldSrcBitmap);
        dcDst.<span class="hljs-built_in">SelectObject</span>(pOldDstBitmap);
        
        <span class="hljs-keyword">return</span> pDstBitmap;
    }
    
    <span class="hljs-comment">// 透明位图绘制</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawTransparentBitmap</span><span class="hljs-params">(CDC* pDC, CBitmap* pBitmap, 
                               CPoint ptDest, COLORREF crTransparent)</span>
    </span>{
        <span class="hljs-comment">// 创建内存DC</span>
        CDC dcMem, dcMask;
        dcMem.<span class="hljs-built_in">CreateCompatibleDC</span>(pDC);
        dcMask.<span class="hljs-built_in">CreateCompatibleDC</span>(pDC);
        
        <span class="hljs-comment">// 获取位图尺寸</span>
        BITMAP bm;
        pBitmap-&gt;<span class="hljs-built_in">GetBitmap</span>(&amp;bm);
        
        <span class="hljs-comment">// 创建掩码位图</span>
        CBitmap bmpMask;
        bmpMask.<span class="hljs-built_in">CreateBitmap</span>(bm.bmWidth, bm.bmHeight, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>);
        
        <span class="hljs-comment">// 选入位图</span>
        CBitmap* pOldMemBitmap = dcMem.<span class="hljs-built_in">SelectObject</span>(pBitmap);
        CBitmap* pOldMaskBitmap = dcMask.<span class="hljs-built_in">SelectObject</span>(&amp;bmpMask);
        
        <span class="hljs-comment">// 设置透明色</span>
        COLORREF crOldBk = dcMem.<span class="hljs-built_in">SetBkColor</span>(crTransparent);
        
        <span class="hljs-comment">// 创建掩码（透明区域为1，非透明区域为0）</span>
        dcMask.<span class="hljs-built_in">BitBlt</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, bm.bmWidth, bm.bmHeight, 
                     &amp;dcMem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, SRCCOPY);
        
        <span class="hljs-comment">// 在目标DC上使用掩码</span>
        pDC-&gt;<span class="hljs-built_in">BitBlt</span>(ptDest.x, ptDest.y, bm.bmWidth, bm.bmHeight,
                   &amp;dcMask, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, SRCAND);
        
        <span class="hljs-comment">// 设置背景色并绘制</span>
        dcMem.<span class="hljs-built_in">SetBkColor</span>(<span class="hljs-built_in">RGB</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
        dcMem.<span class="hljs-built_in">SetTextColor</span>(<span class="hljs-built_in">RGB</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>));
        dcMem.<span class="hljs-built_in">BitBlt</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, bm.bmWidth, bm.bmHeight,
                    &amp;dcMask, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, SRCAND);
        
        <span class="hljs-comment">// 合并结果</span>
        pDC-&gt;<span class="hljs-built_in">BitBlt</span>(ptDest.x, ptDest.y, bm.bmWidth, bm.bmHeight,
                   &amp;dcMem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, SRCPAINT);
        
        <span class="hljs-comment">// 恢复</span>
        dcMem.<span class="hljs-built_in">SetBkColor</span>(crOldBk);
        dcMem.<span class="hljs-built_in">SelectObject</span>(pOldMemBitmap);
        dcMask.<span class="hljs-built_in">SelectObject</span>(pOldMaskBitmap);
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Cleanup</span><span class="hljs-params">()</span>
    </span>{
        POSITION pos = m_mapBitmaps.<span class="hljs-built_in">GetStartPosition</span>();
        UINT nID;
        CBitmap* pBitmap;
        <span class="hljs-keyword">while</span> (pos != <span class="hljs-literal">NULL</span>)
        {
            m_mapBitmaps.<span class="hljs-built_in">GetNextAssoc</span>(pos, nID, pBitmap);
            <span class="hljs-keyword">delete</span> pBitmap;
        }
        m_mapBitmaps.<span class="hljs-built_in">RemoveAll</span>();
    }
};
</code></pre>
<h4 data-id="heading-76">6.2 图像特效处理</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 简单的图像处理过滤器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CImageFilter</span>
{
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 灰度化</span>
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">ConvertToGrayScale</span><span class="hljs-params">(CDC* pDC, CBitmap* pBitmap, 
                                   <span class="hljs-type">const</span> CRect&amp; rect)</span>
    </span>{
        <span class="hljs-comment">// 获取位图信息</span>
        BITMAP bm;
        pBitmap-&gt;<span class="hljs-built_in">GetBitmap</span>(&amp;bm);
        
        <span class="hljs-comment">// 创建内存DC</span>
        CDC dcMem;
        dcMem.<span class="hljs-built_in">CreateCompatibleDC</span>(pDC);
        CBitmap* pOldBitmap = dcMem.<span class="hljs-built_in">SelectObject</span>(pBitmap);
        
        <span class="hljs-comment">// 逐像素处理</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = rect.top; y &lt; rect.bottom; y++)
        {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = rect.left; x &lt; rect.right; x++)
            {
                COLORREF cr = dcMem.<span class="hljs-built_in">GetPixel</span>(x, y);
                
                <span class="hljs-comment">// 计算灰度值</span>
                BYTE r = <span class="hljs-built_in">GetRValue</span>(cr);
                BYTE g = <span class="hljs-built_in">GetGValue</span>(cr);
                BYTE b = <span class="hljs-built_in">GetBValue</span>(cr);
                BYTE gray = (BYTE)(<span class="hljs-number">0.299</span> * r + <span class="hljs-number">0.587</span> * g + <span class="hljs-number">0.114</span> * b);
                
                <span class="hljs-comment">// 设置灰度像素</span>
                dcMem.<span class="hljs-built_in">SetPixel</span>(x, y, <span class="hljs-built_in">RGB</span>(gray, gray, gray));
            }
        }
        
        dcMem.<span class="hljs-built_in">SelectObject</span>(pOldBitmap);
    }
    
    <span class="hljs-comment">// 亮度调整</span>
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">AdjustBrightness</span><span class="hljs-params">(CDC* pDC, CBitmap* pBitmap,
                                 <span class="hljs-type">const</span> CRect&amp; rect, <span class="hljs-type">int</span> nDelta)</span>
    </span>{
        CDC dcMem;
        dcMem.<span class="hljs-built_in">CreateCompatibleDC</span>(pDC);
        CBitmap* pOldBitmap = dcMem.<span class="hljs-built_in">SelectObject</span>(pBitmap);
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = rect.top; y &lt; rect.bottom; y++)
        {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = rect.left; x &lt; rect.right; x++)
            {
                COLORREF cr = dcMem.<span class="hljs-built_in">GetPixel</span>(x, y);
                
                BYTE r = <span class="hljs-built_in">Clamp</span>(<span class="hljs-built_in">GetRValue</span>(cr) + nDelta);
                BYTE g = <span class="hljs-built_in">Clamp</span>(<span class="hljs-built_in">GetGValue</span>(cr) + nDelta);
                BYTE b = <span class="hljs-built_in">Clamp</span>(<span class="hljs-built_in">GetBValue</span>(cr) + nDelta);
                
                dcMem.<span class="hljs-built_in">SetPixel</span>(x, y, <span class="hljs-built_in">RGB</span>(r, g, b));
            }
        }
        
        dcMem.<span class="hljs-built_in">SelectObject</span>(pOldBitmap);
    }
    
    <span class="hljs-comment">// 对比度调整</span>
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">AdjustContrast</span><span class="hljs-params">(CDC* pDC, CBitmap* pBitmap,
                               <span class="hljs-type">const</span> CRect&amp; rect, <span class="hljs-type">double</span> dContrast)</span>
    </span>{
        CDC dcMem;
        dcMem.<span class="hljs-built_in">CreateCompatibleDC</span>(pDC);
        CBitmap* pOldBitmap = dcMem.<span class="hljs-built_in">SelectObject</span>(pBitmap);
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = rect.top; y &lt; rect.bottom; y++)
        {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = rect.left; x &lt; rect.right; x++)
            {
                COLORREF cr = dcMem.<span class="hljs-built_in">GetPixel</span>(x, y);
                
                BYTE r = <span class="hljs-built_in">Clamp</span>((<span class="hljs-type">int</span>)((<span class="hljs-built_in">GetRValue</span>(cr) - <span class="hljs-number">128</span>) * dContrast + <span class="hljs-number">128</span>));
                BYTE g = <span class="hljs-built_in">Clamp</span>((<span class="hljs-type">int</span>)((<span class="hljs-built_in">GetGValue</span>(cr) - <span class="hljs-number">128</span>) * dContrast + <span class="hljs-number">128</span>));
                BYTE b = <span class="hljs-built_in">Clamp</span>((<span class="hljs-type">int</span>)((<span class="hljs-built_in">GetBValue</span>(cr) - <span class="hljs-number">128</span>) * dContrast + <span class="hljs-number">128</span>));
                
                dcMem.<span class="hljs-built_in">SetPixel</span>(x, y, <span class="hljs-built_in">RGB</span>(r, g, b));
            }
        }
        
        dcMem.<span class="hljs-built_in">SelectObject</span>(pOldBitmap);
    }
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">static</span> BYTE <span class="hljs-title">Clamp</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span>
    </span>{
        <span class="hljs-keyword">if</span> (value &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">255</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">255</span>;
        <span class="hljs-keyword">return</span> (BYTE)value;
    }
};
</code></pre>
<h3 data-id="heading-77">七、打印与打印预览</h3>
<h4 data-id="heading-78">7.1 打印架构的实现</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 支持打印的视图类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CPrintableView</span> : <span class="hljs-keyword">public</span> CView
{
<span class="hljs-keyword">protected</span>:
    <span class="hljs-comment">// 打印相关成员</span>
    CPrintInfo m_printInfo;
    <span class="hljs-type">int</span> m_nPageWidth;
    <span class="hljs-type">int</span> m_nPageHeight;
    <span class="hljs-type">int</span> m_nCurPage;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">OnPreparePrinting</span><span class="hljs-params">(CPrintInfo* pInfo)</span>
    </span>{
        <span class="hljs-comment">// 设置打印对话框默认值</span>
        pInfo-&gt;<span class="hljs-built_in">SetMaxPage</span>(<span class="hljs-number">10</span>); <span class="hljs-comment">// 假设最多10页</span>
        pInfo-&gt;<span class="hljs-built_in">SetMinPage</span>(<span class="hljs-number">1</span>);
        
        <span class="hljs-comment">// 调用DoPreparePrinting显示打印对话框</span>
        <span class="hljs-built_in">DoPreparePrinting</span>(pInfo);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">OnBeginPrinting</span><span class="hljs-params">(CDC* pDC, CPrintInfo* pInfo)</span>
    </span>{
        <span class="hljs-comment">// 获取打印机DC能力</span>
        m_nPageWidth = pDC-&gt;<span class="hljs-built_in">GetDeviceCaps</span>(HORZRES);
        m_nPageHeight = pDC-&gt;<span class="hljs-built_in">GetDeviceCaps</span>(VERTRES);
        
        <span class="hljs-comment">// 计算总页数</span>
        CMyDocument* pDoc = <span class="hljs-built_in">GetDocument</span>();
        <span class="hljs-type">int</span> nTotalLines = pDoc-&gt;<span class="hljs-built_in">GetLineCount</span>();
        <span class="hljs-type">int</span> nLinesPerPage = m_nPageHeight / <span class="hljs-number">20</span>; <span class="hljs-comment">// 假设每行20像素</span>
        
        pInfo-&gt;<span class="hljs-built_in">SetMaxPage</span>((nTotalLines + nLinesPerPage - <span class="hljs-number">1</span>) / nLinesPerPage);
        
        <span class="hljs-comment">// 创建打印字体</span>
        LOGFONT lfPrint = {<span class="hljs-number">0</span>};
        lfPrint.lfHeight = <span class="hljs-number">-15</span>; <span class="hljs-comment">// 打印字体稍小</span>
        lfPrint.lfWeight = FW_NORMAL;
        <span class="hljs-built_in">lstrcpy</span>(lfPrint.lfFaceName, _T(<span class="hljs-string">"宋体"</span>));
        m_fontPrint.<span class="hljs-built_in">CreateFontIndirect</span>(&amp;lfPrint);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">OnPrint</span><span class="hljs-params">(CDC* pDC, CPrintInfo* pInfo)</span>
    </span>{
        m_nCurPage = pInfo-&gt;m_nCurPage;
        
        <span class="hljs-comment">// 设置映射模式</span>
        pDC-&gt;<span class="hljs-built_in">SetMapMode</span>(MM_TEXT);
        
        <span class="hljs-comment">// 设置字体</span>
        CFont* pOldFont = pDC-&gt;<span class="hljs-built_in">SelectObject</span>(&amp;m_fontPrint);
        
        <span class="hljs-comment">// 打印页眉</span>
        <span class="hljs-built_in">PrintHeader</span>(pDC);
        
        <span class="hljs-comment">// 打印内容</span>
        <span class="hljs-built_in">PrintPageContent</span>(pDC, pInfo-&gt;m_nCurPage);
        
        <span class="hljs-comment">// 打印页脚</span>
        <span class="hljs-built_in">PrintFooter</span>(pDC);
        
        pDC-&gt;<span class="hljs-built_in">SelectObject</span>(pOldFont);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">OnEndPrinting</span><span class="hljs-params">(CDC* <span class="hljs-comment">/*pDC*/</span>, CPrintInfo* <span class="hljs-comment">/*pInfo*/</span>)</span>
    </span>{
        <span class="hljs-comment">// 清理打印资源</span>
        m_fontPrint.<span class="hljs-built_in">DeleteObject</span>();
    }
    
<span class="hljs-keyword">protected</span>:
    CFont m_fontPrint;
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PrintHeader</span><span class="hljs-params">(CDC* pDC)</span>
    </span>{
        CString strHeader;
        strHeader.<span class="hljs-built_in">Format</span>(_T(<span class="hljs-string">"第 %d 页"</span>), m_nCurPage);
        
        pDC-&gt;<span class="hljs-built_in">TextOut</span>(<span class="hljs-number">100</span>, <span class="hljs-number">50</span>, strHeader);
        
        <span class="hljs-comment">// 绘制页眉线</span>
        pDC-&gt;<span class="hljs-built_in">MoveTo</span>(<span class="hljs-number">50</span>, <span class="hljs-number">80</span>);
        pDC-&gt;<span class="hljs-built_in">LineTo</span>(m_nPageWidth - <span class="hljs-number">50</span>, <span class="hljs-number">80</span>);
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PrintPageContent</span><span class="hljs-params">(CDC* pDC, <span class="hljs-type">int</span> nPage)</span>
    </span>{
        CMyDocument* pDoc = <span class="hljs-built_in">GetDocument</span>();
        
        <span class="hljs-comment">// 计算本页显示的行范围</span>
        <span class="hljs-type">int</span> nLinesPerPage = (m_nPageHeight - <span class="hljs-number">150</span>) / <span class="hljs-number">20</span>; <span class="hljs-comment">// 考虑页眉页脚</span>
        <span class="hljs-type">int</span> nStartLine = (nPage - <span class="hljs-number">1</span>) * nLinesPerPage;
        <span class="hljs-type">int</span> nEndLine = <span class="hljs-built_in">min</span>(nStartLine + nLinesPerPage, 
                          pDoc-&gt;<span class="hljs-built_in">GetLineCount</span>());
        
        <span class="hljs-comment">// 逐行打印</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = nStartLine; i &lt; nEndLine; i++)
        {
            <span class="hljs-type">int</span> y = <span class="hljs-number">100</span> + (i - nStartLine) * <span class="hljs-number">20</span>;
            pDC-&gt;<span class="hljs-built_in">TextOut</span>(<span class="hljs-number">100</span>, y, pDoc-&gt;<span class="hljs-built_in">GetLine</span>(i));
        }
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PrintFooter</span><span class="hljs-params">(CDC* pDC)</span>
    </span>{
        CString strFooter = CTime::<span class="hljs-built_in">GetCurrentTime</span>().<span class="hljs-built_in">Format</span>(_T(<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>));
        
        <span class="hljs-comment">// 绘制页脚线</span>
        pDC-&gt;<span class="hljs-built_in">MoveTo</span>(<span class="hljs-number">50</span>, m_nPageHeight - <span class="hljs-number">70</span>);
        pDC-&gt;<span class="hljs-built_in">LineTo</span>(m_nPageWidth - <span class="hljs-number">50</span>, m_nPageHeight - <span class="hljs-number">70</span>);
        
        <span class="hljs-comment">// 打印页脚文本</span>
        pDC-&gt;<span class="hljs-built_in">TextOut</span>(<span class="hljs-number">100</span>, m_nPageHeight - <span class="hljs-number">50</span>, strFooter);
    }
};
</code></pre>
<h3 data-id="heading-79">八、性能优化与最佳实践</h3>
<h4 data-id="heading-80">8.1 GDI资源泄漏检测</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _DEBUG</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CGdiLeakDetector</span>
{
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">static</span> <span class="hljs-type">int</span> m_nGdiObjectsStart;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">CGdiLeakDetector</span>()
    {
        <span class="hljs-comment">// 记录初始GDI对象数量</span>
        m_nGdiObjectsStart = <span class="hljs-built_in">GetGuiResources</span>(<span class="hljs-built_in">GetCurrentProcess</span>(), 
                                            GR_GDIOBJECTS);
    }
    
    ~<span class="hljs-built_in">CGdiLeakDetector</span>()
    {
        <span class="hljs-comment">// 检查GDI对象泄漏</span>
        <span class="hljs-type">int</span> nGdiObjectsEnd = <span class="hljs-built_in">GetGuiResources</span>(<span class="hljs-built_in">GetCurrentProcess</span>(), 
                                            GR_GDIOBJECTS);
        
        <span class="hljs-keyword">if</span> (nGdiObjectsEnd &gt; m_nGdiObjectsStart)
        {
            <span class="hljs-built_in">TRACE</span>(_T(<span class="hljs-string">"警告：检测到可能的GDI对象泄漏。\n"</span>));
            <span class="hljs-built_in">TRACE</span>(_T(<span class="hljs-string">"初始: %d, 结束: %d, 泄漏: %d\n"</span>), 
                  m_nGdiObjectsStart, nGdiObjectsEnd,
                  nGdiObjectsEnd - m_nGdiObjectsStart);
            
            <span class="hljs-comment">// 在调试时触发断点</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsDebuggerPresent</span>())
            {
                <span class="hljs-built_in">DebugBreak</span>();
            }
        }
    }
};

<span class="hljs-comment">// 在应用程序类中使用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CMyApp</span> : <span class="hljs-keyword">public</span> CWinApp
{
<span class="hljs-keyword">private</span>:
    CGdiLeakDetector m_gdiDetector;
    <span class="hljs-comment">// ...</span>
};
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre>
<h4 data-id="heading-81">8.2 绘图缓存与增量更新</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CDrawingCache</span>
{
<span class="hljs-keyword">private</span>:
    CBitmap m_bmpCache;        <span class="hljs-comment">// 缓存位图</span>
    CRect m_rectCache;         <span class="hljs-comment">// 缓存区域</span>
    BOOL m_bCacheValid;        <span class="hljs-comment">// 缓存有效性标志</span>
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">CDrawingCache</span>() : <span class="hljs-built_in">m_bCacheValid</span>(FALSE) {}
    
    <span class="hljs-comment">// 更新缓存</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">UpdateCache</span><span class="hljs-params">(CDC* pDC, <span class="hljs-type">const</span> CRect&amp; rect)</span>
    </span>{
        <span class="hljs-keyword">if</span> (!m_bCacheValid || m_rectCache != rect)
        {
            <span class="hljs-comment">// 创建或重新创建缓存位图</span>
            <span class="hljs-keyword">if</span> (m_bmpCache.<span class="hljs-built_in">GetSafeHandle</span>() == <span class="hljs-literal">NULL</span> || 
                m_rectCache != rect)
            {
                m_bmpCache.<span class="hljs-built_in">DeleteObject</span>();
                m_bmpCache.<span class="hljs-built_in">CreateCompatibleBitmap</span>(pDC, 
                                                 rect.<span class="hljs-built_in">Width</span>(), 
                                                 rect.<span class="hljs-built_in">Height</span>());
                m_rectCache = rect;
            }
            
            <span class="hljs-comment">// 绘制到缓存</span>
            CDC dcCache;
            dcCache.<span class="hljs-built_in">CreateCompatibleDC</span>(pDC);
            CBitmap* pOldBmp = dcCache.<span class="hljs-built_in">SelectObject</span>(&amp;m_bmpCache);
            
            <span class="hljs-comment">// 绘制背景和内容到缓存</span>
            <span class="hljs-built_in">DrawToCache</span>(&amp;dcCache, rect);
            
            dcCache.<span class="hljs-built_in">SelectObject</span>(pOldBmp);
            m_bCacheValid = TRUE;
        }
    }
    
    <span class="hljs-comment">// 从缓存绘制到屏幕</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RenderFromCache</span><span class="hljs-params">(CDC* pDC, <span class="hljs-type">const</span> CPoint&amp; ptDest)</span>
    </span>{
        <span class="hljs-keyword">if</span> (m_bCacheValid)
        {
            CDC dcCache;
            dcCache.<span class="hljs-built_in">CreateCompatibleDC</span>(pDC);
            CBitmap* pOldBmp = dcCache.<span class="hljs-built_in">SelectObject</span>(&amp;m_bmpCache);
            
            pDC-&gt;<span class="hljs-built_in">BitBlt</span>(ptDest.x, ptDest.y, 
                       m_rectCache.<span class="hljs-built_in">Width</span>(), m_rectCache.<span class="hljs-built_in">Height</span>(),
                       &amp;dcCache, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, SRCCOPY);
            
            dcCache.<span class="hljs-built_in">SelectObject</span>(pOldBmp);
        }
    }
    
    <span class="hljs-comment">// 使缓存失效</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InvalidateCache</span><span class="hljs-params">()</span>
    </span>{
        m_bCacheValid = FALSE;
    }
    
    <span class="hljs-comment">// 部分缓存失效</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InvalidateCacheRect</span><span class="hljs-params">(<span class="hljs-type">const</span> CRect&amp; rectInvalid)</span>
    </span>{
        <span class="hljs-keyword">if</span> (m_bCacheValid &amp;&amp; m_rectCache.<span class="hljs-built_in">IntersectRect</span>(&amp;rectInvalid))
        {
            <span class="hljs-comment">// 只重新绘制受影响的部分</span>
            CDC dcCache;
            <span class="hljs-function">CClientDC <span class="hljs-title">dcScreen</span><span class="hljs-params">(<span class="hljs-literal">NULL</span>)</span></span>;
            dcCache.<span class="hljs-built_in">CreateCompatibleDC</span>(&amp;dcScreen);
            CBitmap* pOldBmp = dcCache.<span class="hljs-built_in">SelectObject</span>(&amp;m_bmpCache);
            
            <span class="hljs-comment">// 清除受影响区域</span>
            <span class="hljs-function">CBrush <span class="hljs-title">brushBg</span><span class="hljs-params">(RGB(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>))</span></span>;
            dcCache.<span class="hljs-built_in">FillRect</span>(&amp;rectInvalid, &amp;brushBg);
            
            <span class="hljs-comment">// 重新绘制受影响区域</span>
            <span class="hljs-built_in">RedrawInvalidArea</span>(&amp;dcCache, rectInvalid);
            
            dcCache.<span class="hljs-built_in">SelectObject</span>(pOldBmp);
        }
    }
    
<span class="hljs-keyword">protected</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">DrawToCache</span><span class="hljs-params">(CDC* pDC, <span class="hljs-type">const</span> CRect&amp; rect)</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">RedrawInvalidArea</span><span class="hljs-params">(CDC* pDC, <span class="hljs-type">const</span> CRect&amp; rect)</span> </span>= <span class="hljs-number">0</span>;
};
</code></pre>
<h3 data-id="heading-82">九、与现代图形API的对比</h3>
<p>虽然GDI已经逐渐被Direct2D、DirectWrite等现代图形API取代，但理解GDI的设计仍有价值：</p>
<ol>
<li><strong>设备抽象层</strong>：GDI的设备上下文概念影响了后续API的设计</li>
<li><strong>资源管理模型</strong>：GDI对象的创建/选择/删除模式为后来的资源管理提供了参考</li>
<li><strong>坐标系统</strong>：GDI的映射模式为图形变换奠定了基础</li>
</ol>
<p><strong>迁移策略</strong>：</p>
<ul>
<li>对于新项目，推荐使用Direct2D/DirectWrite或跨平台图形库</li>
<li>对于现有MFC项目，可逐步替换绘图代码，同时保留业务逻辑</li>
<li>GDI仍适用于简单的UI绘制和打印功能</li>
</ul>
<p>MFC的GDI编程代表了Windows图形编程的一个时代，虽然技术已经演进，但其设计思想和问题解决方案仍对理解计算机图形学基本原理有重要价值。掌握GDI不仅有助于维护遗留代码，更能深刻理解图形系统的工作机制。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++链表环检测算法完全解析]]></title>    <link>https://juejin.cn/post/7581676787379650579</link>    <guid>https://juejin.cn/post/7581676787379650579</guid>    <pubDate>2025-12-09T10:16:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581676787379650579" data-draft-id="7581676787379634195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++链表环检测算法完全解析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-09T10:16:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++链表环检测算法完全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T10:16:03.000Z" title="Tue Dec 09 2025 10:16:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、问题定义</h2>
<h3 data-id="heading-1">1.1 链表环问题</h3>
<p>链表环（Linked List Cycle）指链表中某个节点的 next 指针指向了链表中在它之前出现的节点，导致链表形成闭环结构。检测链表环是数据结构与算法中的经典问题，在内存管理、编译器优化、图算法等领域有广泛应用。</p>
<h3 data-id="heading-2">1.2 问题形式化</h3>
<p>给定一个单链表的头节点 <code>head</code>，要求：</p>
<ol>
<li>判断链表中是否存在环</li>
<li>如果存在环，找到环的入口节点</li>
<li>分析算法的时间和空间复杂度</li>
</ol>
<h2 data-id="heading-3">二、核心算法原理</h2>
<h3 data-id="heading-4">2.1 哈希表法（标记法）</h3>
<h4 data-id="heading-5">2.1.1 基本思想</h4>
<p>遍历链表中的每个节点，将访问过的节点存储在哈希集合中。如果当前节点已经在集合中，说明链表有环；如果遍历到链表末尾（nullptr），则无环。</p>
<h4 data-id="heading-6">2.1.2 算法步骤</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-number">1.</span> 初始化空哈希集合 visited
<span class="hljs-number">2.</span> 当前指针 <span class="hljs-keyword">current</span> 指向头节点 head
<span class="hljs-number">3.</span> while <span class="hljs-keyword">current</span> <span class="hljs-operator">!=</span> nullptr:
   a. 如果 <span class="hljs-keyword">current</span> 在 visited 中，返回 <span class="hljs-literal">true</span>（有环）
   b. 将 <span class="hljs-keyword">current</span> 加入 visited
   c. <span class="hljs-keyword">current</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">current</span><span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>next
<span class="hljs-number">4.</span> 返回 <span class="hljs-literal">false</span>（无环）
</code></pre>
<h4 data-id="heading-7">2.1.3 复杂度分析</h4>
<ul>
<li><strong>时间复杂度</strong>：O(n)，每个节点最多访问一次</li>
<li><strong>空间复杂度</strong>：O(n)，最坏情况需要存储所有节点</li>
<li><strong>优点</strong>：实现简单，逻辑清晰</li>
<li><strong>缺点</strong>：需要额外空间，不适合内存受限场景</li>
</ul>
<h3 data-id="heading-8">2.2 快慢指针法（Floyd判圈算法）</h3>
<h4 data-id="heading-9">2.2.1 算法发明背景</h4>
<p>由计算机科学家 Robert W. Floyd 于1967年提出，最初用于检测有限状态机中的循环，后被广泛应用于链表环检测。</p>
<h4 data-id="heading-10">2.2.2 核心思想</h4>
<p>使用两个指针，一个快指针（每次移动两步），一个慢指针（每次移动一步）。如果链表中存在环，快指针最终会追上慢指针（相遇）；如果不存在环，快指针会先到达链表末尾。</p>
<h4 data-id="heading-11">2.2.3 算法正确性证明</h4>
<p><strong>定理</strong>：如果链表中存在环，快慢指针一定会相遇。</p>
<p><strong>证明</strong>：
设：</p>
<ul>
<li>环外部分长度为 L（从头节点到环入口）</li>
<li>环长度为 C</li>
<li>慢指针进入环时，快指针在环中的位置为 k（0 ≤ k &lt; C）</li>
</ul>
<p>在环中，快指针相对于慢指针的速度是 1 步/单位时间（快指针速度2，慢指针速度1，相对速度1）。由于环是循环的，快指针最多需要 C-1 时间就能追上慢指针。</p>
<p>因此，最坏情况下，从慢指针进入环开始计算，经过 C-1 次移动，快慢指针必然相遇。</p>
<h2 data-id="heading-12">三、算法详细实现</h2>
<h3 data-id="heading-13">3.1 基础结构定义</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ListNode</span> {
    <span class="hljs-type">int</span> val;
    ListNode* next;
    <span class="hljs-built_in">ListNode</span>(<span class="hljs-type">int</span> x) : <span class="hljs-built_in">val</span>(x), <span class="hljs-built_in">next</span>(<span class="hljs-literal">nullptr</span>) {}
    <span class="hljs-built_in">ListNode</span>(<span class="hljs-type">int</span> x, ListNode* next) : <span class="hljs-built_in">val</span>(x), <span class="hljs-built_in">next</span>(next) {}
};
</code></pre>
<h3 data-id="heading-14">3.2 哈希表法实现</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unordered_set&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">hasCycleHash</span><span class="hljs-params">(ListNode* head)</span> </span>{
        unordered_set&lt;ListNode*&gt; visited;
        
        <span class="hljs-keyword">while</span> (head != <span class="hljs-literal">nullptr</span>) {
            <span class="hljs-comment">// 使用count方法检查节点是否已访问</span>
            <span class="hljs-keyword">if</span> (visited.<span class="hljs-built_in">count</span>(head) &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 发现环</span>
            }
            visited.<span class="hljs-built_in">insert</span>(head);  <span class="hljs-comment">// 标记节点已访问</span>
            head = head-&gt;next;     <span class="hljs-comment">// 移动到下一个节点</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 遍历完成，无环</span>
    }
};
</code></pre>
<p><strong>关键点说明</strong>：</p>
<ul>
<li><code>unordered_set::count(key)</code> 返回元素在集合中的出现次数（0或1）</li>
<li><code>unordered_set::insert(key)</code> 插入元素，如果已存在则不重复插入</li>
<li>哈希表的平均查找和插入时间复杂度为 O(1)</li>
</ul>
<h3 data-id="heading-15">3.3 快慢指针法实现</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">hasCycle</span><span class="hljs-params">(ListNode* head)</span> </span>{
        <span class="hljs-comment">// 边界情况处理</span>
        <span class="hljs-keyword">if</span> (head == <span class="hljs-literal">nullptr</span> || head-&gt;next == <span class="hljs-literal">nullptr</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        ListNode* slow = head;  <span class="hljs-comment">// 慢指针，每次移动一步</span>
        ListNode* fast = head;  <span class="hljs-comment">// 快指针，每次移动两步</span>
        
        <span class="hljs-comment">// 第一阶段：检测环是否存在</span>
        <span class="hljs-keyword">while</span> (fast != <span class="hljs-literal">nullptr</span> &amp;&amp; fast-&gt;next != <span class="hljs-literal">nullptr</span>) {
            slow = slow-&gt;next;           <span class="hljs-comment">// 慢指针移动一步</span>
            fast = fast-&gt;next-&gt;next;     <span class="hljs-comment">// 快指针移动两步</span>
            
            <span class="hljs-keyword">if</span> (slow == fast) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 快慢指针相遇，存在环</span>
            }
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 快指针到达末尾，不存在环</span>
    }
};
</code></pre>
<h2 data-id="heading-16">四、环入口检测算法</h2>
<h3 data-id="heading-17">4.1 数学原理推导</h3>
<p>这是快慢指针法最精妙的部分。当快慢指针相遇后，如何找到环的入口？</p>
<p><strong>设</strong>：</p>
<ul>
<li>L1：链表头到环入口的距离</li>
<li>L2：环入口到快慢指针相遇点的距离</li>
<li>C：环的长度</li>
<li>n：快指针在相遇前绕环的圈数（n ≥ 1）</li>
</ul>
<p><strong>已知条件</strong>：</p>
<ol>
<li>快指针速度是慢指针的2倍</li>
<li>相遇时，慢指针走了：L1 + L2</li>
<li>快指针走了：L1 + L2 + nC</li>
</ol>
<p><strong>建立方程</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">2(L1 + L2) = L1 + L2 + <span class="hljs-attr">nC</span>
=&gt; L1 + <span class="hljs-attr">L2</span> = nC
=&gt; <span class="hljs-attr">L1</span> = nC - L2
</code></pre>
<p><strong>关键发现</strong>：</p>
<ul>
<li><code>L1 = (n-1)C + (C - L2)</code></li>
<li><code>C - L2</code> 是从相遇点继续走到环入口的距离</li>
<li>因此，从链表头走 L1 步 = 从相遇点走 (n-1)C + (C-L2) 步</li>
</ul>
<p><strong>结论</strong>：一个指针从链表头开始，另一个从相遇点开始，以相同速度前进，它们将在环入口相遇。</p>
<h3 data-id="heading-18">4.2 环入口检测实现</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">ListNode* <span class="hljs-title">detectCycle</span><span class="hljs-params">(ListNode* head)</span> </span>{
        <span class="hljs-keyword">if</span> (head == <span class="hljs-literal">nullptr</span> || head-&gt;next == <span class="hljs-literal">nullptr</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
        }
        
        ListNode* slow = head;
        ListNode* fast = head;
        
        <span class="hljs-comment">// 第一阶段：检测环</span>
        <span class="hljs-keyword">while</span> (fast != <span class="hljs-literal">nullptr</span> &amp;&amp; fast-&gt;next != <span class="hljs-literal">nullptr</span>) {
            slow = slow-&gt;next;
            fast = fast-&gt;next-&gt;next;
            
            <span class="hljs-keyword">if</span> (slow == fast) {
                <span class="hljs-comment">// 第二阶段：找到环入口</span>
                ListNode* entry = head;  <span class="hljs-comment">// 新指针从链表头开始</span>
                
                <span class="hljs-keyword">while</span> (entry != slow) {  <span class="hljs-comment">// 两个指针同步前进</span>
                    entry = entry-&gt;next;
                    slow = slow-&gt;next;
                }
                
                <span class="hljs-keyword">return</span> entry;  <span class="hljs-comment">// 相遇点即为环入口</span>
            }
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;  <span class="hljs-comment">// 无环</span>
    }
};
</code></pre>
<h2 data-id="heading-19">五、算法复杂度对比</h2>


























<table><thead><tr><th>算法</th><th>时间复杂度</th><th>空间复杂度</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>哈希表法</td><td>O(n)</td><td>O(n)</td><td>实现简单，逻辑清晰</td><td>需要额外空间</td></tr><tr><td>快慢指针法</td><td>O(n)</td><td>O(1)</td><td>空间最优，适合内存受限场景</td><td>实现稍复杂，需要数学理解</td></tr></tbody></table>
<p><strong>时间复杂度分析</strong>：</p>
<ul>
<li>哈希表法：每个节点访问一次，哈希操作O(1)，总O(n)</li>
<li>快慢指针法：快指针最多遍历链表两次，总O(n)</li>
</ul>
<p><strong>空间复杂度分析</strong>：</p>
<ul>
<li>哈希表法：最坏存储所有节点，O(n)</li>
<li>快慢指针法：只使用两个指针，O(1)</li>
</ul>
<h2 data-id="heading-20">六、边界情况与注意事项</h2>
<h3 data-id="heading-21">6.1 边界情况处理</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 边界情况测试</span>
vector&lt;ListNode*&gt; test_cases = {
    <span class="hljs-literal">nullptr</span>,                    <span class="hljs-comment">// 空链表</span>
    <span class="hljs-keyword">new</span> <span class="hljs-built_in">ListNode</span>(<span class="hljs-number">1</span>),           <span class="hljs-comment">// 单节点无环</span>
    <span class="hljs-built_in">makeSelfCycle</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ListNode</span>(<span class="hljs-number">1</span>)), <span class="hljs-comment">// 单节点自环</span>
    <span class="hljs-built_in">makeCycle</span>({<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>}, <span class="hljs-number">0</span>),     <span class="hljs-comment">// 环在头节点</span>
    <span class="hljs-built_in">makeCycle</span>({<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>}, <span class="hljs-number">2</span>), <span class="hljs-comment">// 环在中间</span>
    <span class="hljs-built_in">makeCycle</span>({<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>}, <span class="hljs-number">4</span>)  <span class="hljs-comment">// 环在尾节点</span>
};
</code></pre>
<h3 data-id="heading-22">6.2 内存管理注意事项</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 创建测试链表时需要管理内存</span>
<span class="hljs-function">ListNode* <span class="hljs-title">createTestListWithCycle</span><span class="hljs-params">(<span class="hljs-type">const</span> vector&lt;<span class="hljs-type">int</span>&gt;&amp; values, <span class="hljs-type">int</span> cyclePos)</span> </span>{
    <span class="hljs-keyword">if</span> (values.<span class="hljs-built_in">empty</span>()) <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
    
    vector&lt;ListNode*&gt; nodes;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> val : values) {
        nodes.<span class="hljs-built_in">push_back</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ListNode</span>(val));
    }
    
    <span class="hljs-comment">// 连接节点</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; nodes.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; i++) {
        nodes[i]-&gt;next = nodes[i + <span class="hljs-number">1</span>];
    }
    
    <span class="hljs-comment">// 创建环</span>
    <span class="hljs-keyword">if</span> (cyclePos &gt;= <span class="hljs-number">0</span> &amp;&amp; cyclePos &lt; values.<span class="hljs-built_in">size</span>()) {
        nodes.<span class="hljs-built_in">back</span>()-&gt;next = nodes[cyclePos];
    }
    
    <span class="hljs-keyword">return</span> nodes[<span class="hljs-number">0</span>];
}

<span class="hljs-comment">// 测试完成后释放内存</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">deleteList</span><span class="hljs-params">(ListNode* head, unordered_set&lt;ListNode*&gt;&amp; visited)</span> </span>{
    <span class="hljs-comment">// 有环链表需要特殊处理，避免无限循环</span>
}
</code></pre>
<h2 data-id="heading-23">七、实际应用场景</h2>
<h3 data-id="heading-24">7.1 内存泄漏检测</h3>
<p>在垃圾回收和内存管理系统中，检测循环引用可以避免内存泄漏：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryManager</span> {
<span class="hljs-keyword">private</span>:
    unordered_set&lt;Object*&gt; visited;
    
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">hasCycleReference</span><span class="hljs-params">(Object* obj)</span> </span>{
        <span class="hljs-comment">// 使用类似链表判环的算法检测对象引用环</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">detectCycleInReferences</span>(obj);
    }
};
</code></pre>
<h3 data-id="heading-25">7.2 并发死锁检测</h3>
<p>在操作系统中，检测资源分配图中的环可以预防死锁：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DeadlockDetector</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">detectDeadlock</span><span class="hljs-params">(vector&lt;Process&gt;&amp; processes)</span> </span>{
        <span class="hljs-comment">// 将进程等待关系建模为图，检测环</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">hasCycleInWaitForGraph</span>(processes);
    }
};
</code></pre>
<h3 data-id="heading-26">7.3 编译器优化</h3>
<p>在编译器的数据流分析和控制流分析中，检测循环结构：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CompilerOptimizer</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">analyzeControlFlow</span><span class="hljs-params">(CFG* cfg)</span> </span>{
        <span class="hljs-comment">// 检测控制流图中的环（循环结构）</span>
        <span class="hljs-built_in">detectLoopsInCFG</span>(cfg);
    }
};
</code></pre>
<h2 data-id="heading-27">八、扩展与变体</h2>
<h3 data-id="heading-28">8.1 求环的长度</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">cycleLength</span><span class="hljs-params">(ListNode* head)</span> </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">hasCycle</span>(head)) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    
    ListNode* slow = head;
    ListNode* fast = head;
    
    <span class="hljs-comment">// 第一阶段：找到相遇点</span>
    <span class="hljs-keyword">while</span> (fast &amp;&amp; fast-&gt;next) {
        slow = slow-&gt;next;
        fast = fast-&gt;next-&gt;next;
        <span class="hljs-keyword">if</span> (slow == fast) <span class="hljs-keyword">break</span>;
    }
    
    <span class="hljs-comment">// 第二阶段：计算环长</span>
    <span class="hljs-type">int</span> length = <span class="hljs-number">1</span>;
    fast = fast-&gt;next;
    <span class="hljs-keyword">while</span> (fast != slow) {
        fast = fast-&gt;next;
        length++;
    }
    
    <span class="hljs-keyword">return</span> length;
}
</code></pre>
<h3 data-id="heading-29">8.2 判断环的位置类型</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">CycleType</span> {
    NO_CYCLE,
    SELF_CYCLE,      <span class="hljs-comment">// 自环</span>
    SMALL_CYCLE,     <span class="hljs-comment">// 小环（长度≤3）</span>
    LARGE_CYCLE      <span class="hljs-comment">// 大环</span>
};

<span class="hljs-function">CycleType <span class="hljs-title">classifyCycle</span><span class="hljs-params">(ListNode* head)</span> </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">hasCycle</span>(head)) <span class="hljs-keyword">return</span> NO_CYCLE;
    
    ListNode* entry = <span class="hljs-built_in">detectCycle</span>(head);
    
    <span class="hljs-keyword">if</span> (entry == entry-&gt;next) <span class="hljs-keyword">return</span> SELF_CYCLE;
    
    <span class="hljs-type">int</span> len = <span class="hljs-built_in">cycleLength</span>(head);
    <span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">3</span>) <span class="hljs-keyword">return</span> SMALL_CYCLE;
    
    <span class="hljs-keyword">return</span> LARGE_CYCLE;
}
</code></pre>
<h2 data-id="heading-30">九、总结与最佳实践</h2>
<h3 data-id="heading-31">9.1 算法选择建议</h3>
<ol>
<li><strong>面试场景</strong>：优先实现快慢指针法，展现算法理解深度</li>
<li><strong>生产环境</strong>：根据内存约束选择，内存充足可用哈希表法（更稳定）</li>
<li><strong>竞赛场景</strong>：快慢指针法（空间效率高）</li>
</ol>
<h3 data-id="heading-32">9.2 编码注意事项</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 良好的编码习惯</span>
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">hasCycleBestPractice</span><span class="hljs-params">(ListNode* head)</span> </span>{
    <span class="hljs-comment">// 1. 优先处理边界情况</span>
    <span class="hljs-keyword">if</span> (head == <span class="hljs-literal">nullptr</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// 2. 变量命名清晰</span>
    ListNode* slowPointer = head;
    ListNode* fastPointer = head;
    
    <span class="hljs-comment">// 3. 循环条件严谨</span>
    <span class="hljs-keyword">while</span> (fastPointer != <span class="hljs-literal">nullptr</span> &amp;&amp; fastPointer-&gt;next != <span class="hljs-literal">nullptr</span>) {
        <span class="hljs-comment">// 4. 移动指针后再比较</span>
        slowPointer = slowPointer-&gt;next;
        fastPointer = fastPointer-&gt;next-&gt;next;
        
        <span class="hljs-comment">// 5. 使用明确的比较</span>
        <span class="hljs-keyword">if</span> (slowPointer == fastPointer) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
    
    <span class="hljs-comment">// 6. 明确返回无环</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h3 data-id="heading-33">9.3 学习要点</h3>
<ol>
<li><strong>理解数学原理</strong>：快慢指针法的核心是数学推导</li>
<li><strong>掌握边界处理</strong>：空链表、单节点、自环等特殊情况</li>
<li><strong>分析复杂度</strong>：理解时间-空间权衡</li>
<li><strong>联系实际应用</strong>：了解算法在真实系统中的用途</li>
</ol>
<p>链表环检测算法不仅是面试高频题，更是理解指针操作、算法设计和数学思维的绝佳案例。通过深入理解这个问题的多种解法，可以提升解决复杂问题的能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从误判到精准：游戏社区 AI 审核的工程化实践]]></title>    <link>https://juejin.cn/post/7580606750291951667</link>    <guid>https://juejin.cn/post/7580606750291951667</guid>    <pubDate>2025-12-08T01:58:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580606750291951667" data-draft-id="7580570363602206772" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从误判到精准：游戏社区 AI 审核的工程化实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-08T01:58:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从误判到精准：游戏社区 AI 审核的工程化实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T01:58:51.000Z" title="Mon Dec 08 2025 01:58:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs3.cn-north-1.amazonaws.com.cn%2Fawschinablog%2Fblogbanner-newnew.png" target="_blank" title="https://s3.cn-north-1.amazonaws.com.cn/awschinablog/blogbanner-newnew.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c4a1d8bb6d54df78712ebd5c0284592~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765763948&amp;x-signature=wF7aKmJvqYKvL53finN92yp%2FX1g%3D" alt="" loading="lazy"/></a></p>
<h2 data-id="heading-0">引言</h2>
<p>游戏社区作为典型的 UGC（用户生成内容）场景，用户遍布全球，涉及中、英、日、韩、俄、西班牙语、阿拉伯语、法语等多种语言。讨论氛围活跃，但其中不可避免会夹杂 辱骂、仇恨、色情、暴力、涉政 等违规言论。</p>
<p>平台需要在不伤害社区氛围的前提下，做到 <strong>及时、准确的内容审核</strong>。但传统规则引擎容易出现“误杀”或“漏判”，直接依赖大语言模型审核又存在 <strong>准确率不高、分类不稳定</strong> 的问题。</p>
<p>我们遇到的客户需求还有一些额外挑战：</p>
<ul>
<li>审核对象是<strong>长文本</strong>（动辄上千字符）；</li>
<li>无法通过向量检索或 RAG 切片，因为长文本拆分后上下文丢失，相关度很差；</li>
<li>模型需要一次性给出 <strong>判定结果（Pass/Reject</strong> <strong>）</strong> ，并在 Reject 时指定 <strong>10</strong> <strong>种违规分类之一</strong>。</li>
</ul>
<p>在这样的背景下，我们为一家游戏公司落地了一套 <strong>提示词工程 + ReAct</strong> <strong>框架 +</strong> <strong>工程化架构</strong> 的 AI 审核方案。最终整体准确率提升到了 <strong>81%</strong> 。需要说明的是，对比基准是客户的人工审核数据，而人工标注过程存在“多人多日、缺乏复核”的情况，口径并不完全统一。因此，我们只能说模型的 81% 一致性<strong>大体上达到了人工审核的水平</strong>，具体效果还需结合更严格的标注体系进一步验证。</p>
<blockquote>
<p>📢限时插播：无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。</p>
<p>⏩快快点击进入《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_Juejinhead_0606%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejinhead_0606" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_Juejinhead_0606&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejinhead_0606" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》实验构建无限, 探索启程！</p>
</blockquote>
<h2 data-id="heading-1">整体方案架构</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2854ab2d20944099a84c17bcdd3fd2c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765763948&amp;x-signature=e8%2BLZkluVgimOQGbAk1aDnH4d30%3D" alt="299042ed769fca693f09795d0e851c31.png" loading="lazy"/></p>
<h2 data-id="heading-2">工程化落地能力</h2>
<p>在文本审核项目中，提示词优化只是其中一步。真正支撑业务落地的，是一整套 <strong>可观测、可回滚、可扩展</strong> 的工程架构：</p>
<ul>
<li><strong>蓝绿部署</strong>：通过 Amazon Bedrock 的多版本部署机制，提示词优化和模型更新可以安全上线，支持灰度/回滚。</li>
<li><strong>日志与判例库</strong>：所有审核请求和结果写入 DynamoDB / OpenSearch，用于后续的回溯分析与提示词再训练。</li>
<li><strong>配置与流控</strong>：Amazon AppConfig + 控制 Lambda，保证在高并发/大流量场景下系统稳定。</li>
<li><strong>端到端可监控</strong>：从请求入口到最终存储都有日志链路，方便快速排查问题。</li>
</ul>
<h2 data-id="heading-3">提示词冷启动阶段：提示词从 0 到 1</h2>
<p>在没有任何“黄金提示词”的前提下，拿到可用的提示词方法有很多种，甚至可以直接让AI生成一个。</p>
<p>但我们这里采用冷启动的办法，先让模型把客户给的几千条样本过一遍。每跑一条，就拿它的结果和人工标注比对，把提示词里有问题的地方修掉。这样循环一轮，等于帮我们凑出了一个“能跑”的初始版本，后面再慢慢打磨。</p>
<p>我们的做法是：</p>
<ol>
<li>让大模型逐条读取客户提供的数千条人工审核样本（每条都包含文本、判定结果以及违规分类）。</li>
<li>在阅读过程中，模型会尝试基于已有样本生成提示词。</li>
<li>每读取一条样本，就对提示词做一次微调，逐步修正不合理的部分。</li>
<li>完成一轮全量样本后，就得到一个 <strong>初始提示词</strong>，作为进一步优化的基线。</li>
</ol>
<p>例如，最初我们生成的提示词大致如下：</p>
<pre><code class="hljs language-erlang" lang="erlang">You are a content moderation model.
## Task
Analyze the following user-generated text.
<span class="hljs-number">1</span>. Classify it as <span class="hljs-string">"Pass"</span> or <span class="hljs-string">"Reject"</span>.
<span class="hljs-number">2</span>. If <span class="hljs-string">"Reject"</span>, assign one <span class="hljs-keyword">of</span> these categories:
   - Hate Speech
   - Sexual Content
   - Violence
   - Political Sensitivity
   - Spam / Ads
   - Self-harm
   ...
## Output Format (JSON)
{<span class="hljs-string">"result"</span>: <span class="hljs-string">"Reject"</span>, <span class="hljs-string">"category"</span>: <span class="hljs-string">"Hate Speech"</span>}
</code></pre>
<p>在冷启动阶段，这个提示词的准确率并不算高，容易出现 <strong>灰色语境误判</strong>（例如把二次元梗误判成色情内容），或者 <strong>多语言覆盖不足</strong>（对阿拉伯语、西班牙语等的判定不稳定）。但它为后续优化奠定了基础。</p>
<h2 data-id="heading-4">ReAct 框架引入：让模型“先思考，再行动”</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F09%2F29%2Fcommunities-2.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/09/29/communities-2.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b41d7b09a65b43c58286207f71bad4e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765763948&amp;x-signature=WLQZaU4vN9R877rQ5j7QzV4EIXg%3D" alt="" loading="lazy"/></a></p>
<p>冷启动阶段得到的提示词虽然能跑通流程，但在一些关键问题上仍然存在不足：</p>
<ul>
<li><strong>灰色语境</strong>：例如二次元梗、讽刺语气，容易被误判为违规。</li>
<li><strong>多语言一致性</strong>：某些语言（如阿拉伯语、西班牙语）分类不稳定。</li>
<li><strong>输出随机性</strong>：相同输入多次测试，结果可能不同。</li>
</ul>
<p>为了解决这些问题，我们在提示词中引入了 <strong>ReAct</strong> <strong>（Reason + Act</strong> <strong>）框架</strong>。</p>
<p><strong>ReAct</strong> <strong>的核心思想</strong>是让大模型先进行显式的“推理”步骤，再做最终的“行动”输出。这样可以减少随机性，并提高可解释性。</p>
<h3 data-id="heading-5">ReAct 框架在审核场景中的拆解</h3>
<ol>
<li>
<p><strong>Reasoning</strong> <strong>（思考）</strong> ：</p>
<ul>
<li>Step 1: 确定文本语言</li>
<li>Step 2: 提取潜在违规关键词或短语</li>
<li>Step 3: 将关键词与违规类别进行匹配</li>
<li>Step 4: 根据上下文和类别，决定 Pass / Reject</li>
</ul>
</li>
<li>
<p><strong>Action</strong> <strong>（行动）</strong> ：</p>
<ul>
<li>输出最终 JSON 结果（判定 + 类别）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-6">示例提示词片段</h3>
<p>下面是我们在 ReAct 框架下的一部分提示词（简化版）：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">You are a professional content moderation assistant.  
Follow the steps below before giving the final output:  

<span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>: Identify the language <span class="hljs-keyword">of</span> the <span class="hljs-keyword">text</span>.  
<span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>: Extract any potentially offensive <span class="hljs-built_in">or</span> sensitive words.  
<span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>: Match the extracted words <span class="hljs-keyword">to</span> one <span class="hljs-keyword">of</span> the violation categories.  
<span class="hljs-keyword">Step</span> <span class="hljs-number">4</span>: Decide whether the <span class="hljs-keyword">text</span> <span class="hljs-built_in">is</span> <span class="hljs-string">"Pass"</span> <span class="hljs-built_in">or</span> <span class="hljs-string">"Reject"</span>.  

<span class="hljs-keyword">Finally</span>, output ONLY <span class="hljs-keyword">in</span> the following JSON format:  
{<span class="hljs-string">"result"</span>: <span class="hljs-string">"Reject"</span>, <span class="hljs-string">"category"</span>: <span class="hljs-string">"Hate Speech"</span>}
</code></pre>
<p>这样设计后，准确率虽不高，容易把二次元梗当成色情，或对小语种判定不稳。但它给我们提供了一个起点。</p>
<h3 data-id="heading-7">ReAct 框架下的实现示例（Python 伪代码）</h3>
<p>在工程落地中，我们通过 Agent 框架调用大模型，来执行上述 ReAct 推理：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> strands <span class="hljs-keyword">import</span> Agent, tool
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">moderation_tool</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""
    Classify the input text into Pass/Reject and category using ReAct framework.
    """</span>
    reasoning_prompt = <span class="hljs-string">f"""
    Step 1: Identify language.
    Step 2: Extract potentially offensive words or sensitive context.
    Step 3: Match with violation categories.
    Step 4: Decide Pass or Reject.
    Text: <span class="hljs-subst">{text}</span>
    """</span>
    <span class="hljs-comment"># 调用大模型</span>
    result = llm_call(reasoning_prompt)
    <span class="hljs-keyword">return</span> result
<span class="hljs-comment"># 示例调用</span>
<span class="hljs-built_in">print</span>(moderation_tool(<span class="hljs-string">"This game sucks, I hope the devs all die in a fire."</span>))
<span class="hljs-comment"># 输出示例: {"result": "Reject", "category": "Hate Speech"}</span>
</code></pre>
<p>在 ReAct 机制下，我们观察到模型的表现明显更加稳定：</p>
<ul>
<li>对多语言输入的分类一致性增强；</li>
<li>对灰色语境（如“玩梗”）的误判显著减少；</li>
<li>审核理由透明，可以复盘和解释。</li>
</ul>
<h2 data-id="heading-8">多轮循环优化：从 3 轮到 10+ 轮，我们如何选定 5 轮</h2>
<p>在引入 ReAct 之后，我们对“<strong>每轮：全量跑样本 →</strong> <strong>纠错 →</strong> <strong>修提示词</strong>”的闭环进行了系统化实验，对比不同轮数的收益与成本：</p>
<ul>
<li>
<p><strong>3</strong> <strong>轮：欠拟合</strong></p>
<ul>
<li>典型问题：仍然存在多语言一致性不足、灰色语境误判偏多。</li>
<li>现象：指标提升明显低于 5 轮，呈“上升未饱和”状态。</li>
</ul>
</li>
<li>
<p><strong>5</strong> <strong>轮：效果-</strong> <strong>成本最优点</strong></p>
<ul>
<li>进入<strong>收益递减区间</strong>的起点，准确率与稳定性基本收敛。</li>
<li>与 10 轮相比，<strong>增益不明显</strong>，但计算/时间成本显著更低。</li>
</ul>
</li>
<li>
<p><strong>10</strong> <strong>轮：与 5</strong> <strong>轮接近</strong></p>
<ul>
<li>指标接近 5 轮，<strong>差异在统计误差范围内</strong>。</li>
<li>成本约为 5 轮的 2 倍（推理费用、时间占用、并发管理）。</li>
</ul>
</li>
<li>
<p><strong>10</strong> <strong>轮以上：可能出现负面影响</strong></p>
<ul>
<li>过拟合于“特定审核员口径/特定样本簇”，提示词<strong>变窄</strong>。</li>
<li>对跨天、跨审核员、跨语种的泛化能力<strong>略有下降</strong>。</li>
</ul>
</li>
</ul>
<p><strong>结论</strong>：在成本—收益的综合考量下，我们选择 <strong>5</strong> <strong>轮</strong> 作为生产建议，并给出<strong>实践区间</strong> <strong>5–8</strong> <strong>轮</strong>（8 轮用于更严格的场景/关键上线前的稳健性校验）。</p>
<h3 data-id="heading-9">版本对比</h3>





















































<table><thead><tr><th/><th>版本</th><th>轮次</th><th>核心改动</th><th>效果观察</th><th>主要问题</th></tr></thead><tbody><tr><td>1</td><td>v1</td><td>1</td><td>冷启动提示词，直接分类</td><td>基线 72%</td><td>灰色语境误判、多语言不稳</td></tr><tr><td>2</td><td>v2</td><td>3</td><td>加语言识别、关键词提取</td><td>~77–79%</td><td>仍有欠拟合迹象</td></tr><tr><td>3</td><td>v3</td><td>5</td><td>ReAct 推理链条收敛、分类边界精炼</td><td>81%</td><td>标注噪声成为主限因素</td></tr><tr><td>4</td><td>v4</td><td>8</td><td>规则精修、输出一致性增强</td><td>~81%±</td><td>提升接近噪声天花板</td></tr><tr><td>5</td><td>v5</td><td>10+</td><td>更细粒度规则</td><td><strong>收益不增反降</strong></td><td>过拟合风险上升，提示词会过于具象化</td></tr></tbody></table>
<h2 data-id="heading-10">Temperature 调参经验</h2>
<p>在我们反复调提示词的过程中，发现 <strong>temperature</strong> <strong>参数</strong> 对结果影响较大。</p>
<ul>
<li>
<p><strong>在调试和实验阶段</strong><br/>
我们会把 temperature 开得比较高，大概在 <strong>8–1.0</strong>。这样模型会更“活跃”，能从不同角度去理解文本。比如：</p>
<ul>
<li>二次元梗、讽刺话语、跨语种甚至夹杂 emoji 的内容，高 temperature 下模型能给出更多解释；</li>
<li>这对我们来说很有帮助，可以暴露提示词里没考虑到的边角情况，方便我们快速改进。</li>
</ul>
</li>
<li>
<p><strong>在真正上线的时候</strong><br/>
我们把 temperature 拉到 <strong>0–0.1</strong>。</p>
<ul>
<li>这样模型输出会尽量固定，不会同一条内容前后给出不一样的结果；</li>
<li>对审核业务来说，<strong>稳定和可解释</strong>比“有创造力”要重要得多。</li>
</ul>
</li>
</ul>
<p>所以我们的做法是：<strong>调试阶段高</strong> <strong>temperature</strong> <strong>，生产环境低 temperature</strong>，既能探索问题，也能保证上线稳定。</p>
<h2 data-id="heading-11">实验结果（口径与噪声说明）</h2>
<ul>
<li><strong>整体准确率</strong>：<strong>81%</strong></li>
<li><strong>正向召回准确率（合规判定）</strong> ：<strong>76%</strong></li>
<li><strong>负向召回准确率（违规判定）</strong> ：<strong>90%</strong></li>
</ul>
<p><strong>评估口径与数据噪声：</strong></p>
<ul>
<li>基准为客户提供的<strong>人工审核数据</strong>；多人、分多日完成，<strong>未建立双盲复核</strong>，口径存在<strong>天然不一致</strong>。</li>
<li>因此 81% 的一致性，<strong>已经接近甚至可能超过</strong>多人人工的稳定水平。</li>
<li>在多语言与灰色语境（玩梗、反讽）上，<strong>ReAct</strong> <strong>提示词</strong>显著降低了随机误判，并提升了跨语言一致性。</li>
</ul>
<h3 data-id="heading-12">代表性案例（模拟真实数据）</h3>








































<table><thead><tr><th/><th>文本（节选）</th><th>人工标注</th><th>基线模型</th><th>ReAct 提示词</th></tr></thead><tbody><tr><td>1</td><td>“You are stupid, I hate you.”</td><td>仇恨言论</td><td>Pass ❌</td><td>Reject ✅（Hate Speech）</td></tr><tr><td>2</td><td>“This waifu is so hot omg 🔥”</td><td>合规（二次元语境）</td><td>Reject ❌</td><td>Pass ✅</td></tr><tr><td>3</td><td>“The devs are scammers, I hope they burn.”</td><td>仇恨言论</td><td>Reject ✅</td><td>Reject ✅（Hate Speech）</td></tr><tr><td>4</td><td>“Hello”</td><td/><td>Pass✅</td><td/></tr></tbody></table>
<h2 data-id="heading-13">工程实现要点</h2>
<h3 data-id="heading-14">核心代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_file_validation</span>(<span class="hljs-params">file_path, prompt_template, client, model_id, temperature, max_tokens, logger</span>):
    <span class="hljs-string">"""Process a single file for validation and return results"""</span>
    file_name = os.path.basename(file_path)
    
    logger.info(<span class="hljs-string">f"Validating file: <span class="hljs-subst">{file_name}</span>"</span>)
    
    <span class="hljs-keyword">try</span>:
        df = pd.read_excel(file_path, engine=<span class="hljs-string">'openpyxl'</span>)
        
        <span class="hljs-comment"># Processing Excel data</span>
        <span class="hljs-comment"># ...</span>
        
        results = []
        
        <span class="hljs-comment"># Counters for detailed metrics</span>
        metrics = {
            <span class="hljs-string">"total"</span>: <span class="hljs-built_in">len</span>(data),
            <span class="hljs-string">"pass_samples"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"reject_samples"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"pass_correct"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"reject_correct"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"category_metrics"</span>: defaultdict(<span class="hljs-keyword">lambda</span>: {<span class="hljs-string">"total"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"correct"</span>: <span class="hljs-number">0</span>})
        }
        
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> tqdm(data, desc=<span class="hljs-string">f"Processing <span class="hljs-subst">{file_name}</span>"</span>):
            <span class="hljs-comment"># ...</span>
            <span class="hljs-comment"># Format the prompt with the current text</span>
            prompt = prompt_template.<span class="hljs-built_in">format</span>(text=text)
            
            <span class="hljs-comment"># Get model response</span>
            response = invoke_claude(client, prompt, model_id, temperature, max_tokens, logger)
            
            <span class="hljs-comment"># Extract prediction (0 or 1) from response</span>
            <span class="hljs-keyword">if</span> response:
                <span class="hljs-comment"># Look for Pass/Reject indicators in the response</span>
                lower_response = response.lower()
                
                <span class="hljs-comment"># Check for explicit "Pass" or "Reject" in the response</span>

                <span class="hljs-comment"># Check for numeric indicators</span>
                
                <span class="hljs-comment"># Default to Reject if unclear</span>
                    
                is_correct = pred_label == true_label
                <span class="hljs-keyword">if</span> is_correct:
                    <span class="hljs-keyword">if</span> true_label == <span class="hljs-number">1</span>:
                        metrics[<span class="hljs-string">"pass_correct"</span>] += <span class="hljs-number">1</span>
                    <span class="hljs-keyword">else</span>:
                        metrics[<span class="hljs-string">"reject_correct"</span>] += <span class="hljs-number">1</span>
                        metrics[<span class="hljs-string">"category_metrics"</span>][category][<span class="hljs-string">"correct"</span>] += <span class="hljs-number">1</span>
                    
                results.append({
                    <span class="hljs-string">"text"</span>: text,
                    <span class="hljs-string">"true_label"</span>: true_label,
                    <span class="hljs-string">"pred_label"</span>: pred_label,
                    <span class="hljs-string">"is_correct"</span>: is_correct,
                    <span class="hljs-string">"response"</span>: response,
                    <span class="hljs-string">"category"</span>: category,
                    <span class="hljs-string">"source_file"</span>: file_name
                })
            
            <span class="hljs-comment"># Add a small delay to avoid rate limiting</span>
            time.sleep(<span class="hljs-number">0.5</span>)
        
        <span class="hljs-comment"># Calculate metrics</span>
        <span class="hljs-comment"># ...</span>
        
        logger.info(<span class="hljs-string">f"Completed <span class="hljs-subst">{file_name}</span>: Accuracy=<span class="hljs-subst">{metrics[<span class="hljs-string">'accuracy'</span>]:<span class="hljs-number">.4</span>f}</span>, "</span>
                   <span class="hljs-string">f"Pass=<span class="hljs-subst">{metrics[<span class="hljs-string">'pass_accuracy'</span>]:<span class="hljs-number">.4</span>f}</span>, Reject=<span class="hljs-subst">{metrics[<span class="hljs-string">'reject_accuracy'</span>]:<span class="hljs-number">.4</span>f}</span>"</span>)
        
        <span class="hljs-keyword">return</span> file_name, results, metrics
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"Error processing file <span class="hljs-subst">{file_path}</span>: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> file_name, [], {<span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)}
</code></pre>
<h3 data-id="heading-15">1) 日志与可追溯性</h3>
<ul>
<li>
<p><strong>目的</strong>：记录每个文件、每条样本的判定与指标，支撑问题回溯。</p>
</li>
<li>
<p><strong>实践要点</strong>：</p>
<ul>
<li>文件 + 控制台双通道日志；</li>
<li>关键信息结构化输出（accuracy、pass/reject、category 指标）；</li>
<li>每轮/每版本生成独立 log 文件，便于对比。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">2) 数据装载与多文件批处理</h3>
<ul>
<li>
<p><strong>Excel</strong> <strong>列位处理</strong>：文本、标签列提取。</p>
</li>
<li>
<p><strong>要点</strong>：</p>
<ul>
<li><strong>统一 label</strong> <strong>口径</strong>：<code>Pass → 1 / Reject → 0</code>；</li>
<li><strong>类别精度</strong>：对 <code>Reject</code> 的类别进行<strong>单独统计</strong>，便于发现“弱类”。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-17">3) 大模型调用与推理参数（使用botocore调用Bedrock）</h3>
<ul>
<li><strong>默认参数</strong>：<code>temperature=0.0</code>、<code>max_tokens=1000</code>，确保<strong>可重复与稳定输出，</strong> <code>max_tokens</code>过大对效果影响有限;</li>
<li><strong>超时/</strong> <strong>重试</strong>：<code>botocore.config.Config</code>中设置<code>connect_timeout/read_timeout/retries</code>；</li>
</ul>
<h3 data-id="heading-18">4) 提示词模板与占位</h3>
<ul>
<li>通过<code>prompt_template.format(text=...)</code> 注入样本正文。</li>
<li><strong>建议</strong>：模板内统一约束<strong>唯一</strong> <strong>JSON</strong> <strong>输出</strong>，便于解析；输出前置 ReAct 步骤（语言识别、关键词提取、类别匹配、最终判定）。</li>
</ul>
<h3 data-id="heading-19">5) 并发验证与节流</h3>
<ul>
<li><strong>多文件并行</strong>：<code>ThreadPoolExecutor</code> 按文件粒度并发；</li>
<li><strong>速率控制</strong>：<code>time.sleep(0.5)</code> 做基础节流，避免限流，注意您Amazon Web Service账号内Quota；</li>
</ul>
<h3 data-id="heading-20">6) 评估与报表</h3>
<ul>
<li>
<p>输出四个 Sheet：<code>Results / Overall Metrics / File Metrics / Category Metrics</code> + <code>Prompt</code>。</p>
</li>
<li>
<p><strong>好处</strong>：</p>
<ul>
<li><code>Category Metrics</code> 能快速定位<strong>薄弱类别</strong>；</li>
<li><code>Prompt</code> 留存使<strong>版本可复现</strong>；</li>
<li>结合日志快速回放异常样本。</li>
</ul>
</li>
</ul>
<p><strong>评估口径</strong>：统一使用“与人工标注的一致性”为主指标（Overall/Pass/Reject accuracy + Category accuracy），并在文中<strong>显式声明标注噪声</strong>与“多审核员/多日/未复核”的现实约束。</p>
<h2 data-id="heading-21">经验总结（针对轮数选择与成本）</h2>
<ul>
<li>
<p><strong>建议轮数</strong>：<strong>5–8</strong> <strong>轮</strong>；5 轮用于大多数生产场景，8 轮用于上线前稳健性校验。</p>
</li>
<li>
<p><strong>避免过拟合</strong>：10 轮以上容易对某些审核员口径或小样本簇过拟合，泛化变差。</p>
</li>
<li>
<p><strong>成本优化</strong>：</p>
<ul>
<li>串并结合：文件级并行 + 样本级节流；</li>
<li>固定 <code>temperature</code>，保证一致性，减少“返工轮”；</li>
<li>对类别<strong>分层抽样</strong>做小集评估，优先修“弱类”，再全量回归。</li>
<li>在最终工程化实施时，可以将提示词放到system prompt中，同时开启cache，以降低成本。</li>
</ul>
</li>
<li>
<p><strong>JSON</strong> <strong>仅输出与解析健壮性</strong></p>
<ul>
<li>强调输出格式的规范化，降低对输出结果的不统一增加生产系统的不确定性。</li>
<li>部分提示词</li>
</ul>
</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F09%2F29%2Fcommunities-3.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/09/29/communities-3.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce09ff6490fc4094bb656ab04d2d485c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765763948&amp;x-signature=wSwcENFAjfgJ9IWsuVIxTsR9fGM%3D" alt="" loading="lazy"/></a></p>
<ul>
<li>输出</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F09%2F29%2Fcommunities-4.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/09/29/communities-4.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8e04bd15b444a48aad8fe053f93961a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765763948&amp;x-signature=sljqwQ4T9NXdLfOgfmw%2Bx2p%2F5Rg%3D" alt="" loading="lazy"/></a></p>
<h2 data-id="heading-22">落地经验</h2>
<p>在整个项目落地的过程中，我们积累了几条关键经验：</p>
<ol>
<li><strong>提示词必须贴合业务标注体系:</strong> 通用的“内容安全”提示词远远不够。只有结合客户的 10 类违规分类，并不断对照人工审核样本修正，才能让模型输出结果和业务口径保持一致。</li>
<li><strong>ReAct</strong> <strong>框架带来了可解释性:</strong> 模型先进行“思考”，再给出“行动”，让每一步逻辑更加透明。我们可以展示模型的推理逻辑（语言识别、关键词提取、类别匹配），增强了审核结论的可信度。</li>
<li><strong>数据质量是上限，提示词优化是下限:</strong> 我们使用的人工审核数据存在多人、分多日完成、缺乏复核等问题，导致标注结果本身带有噪声。在这种情况下，模型的准确率“天花板”就会受到影响。换句话说，提示词优化能逼近人工水平，但要进一步突破，还需要客户改善数据标注流程。</li>
<li><strong>成本与效果的权衡:</strong> 我们在实验中验证了 3、5、10 轮迭代的差异，最终选择 5 轮作为最优点。同样地，temperature 参数在调优阶段设置高值，在上线阶段锁定低值，也是平衡创造性与稳定性的工程实践。</li>
</ol>
<h2 data-id="heading-23">未来优化方向</h2>
<ol>
<li>
<p><strong>自动化提示词优化</strong></p>
<ul>
<li>引入 AutoPrompt、RLHF 等方法，让提示词进化不再完全依赖人工试错。</li>
<li>在更多语言、更多语境下持续收敛。</li>
</ul>
</li>
<li>
<p><strong>更细粒度的分类与标签</strong></p>
<ul>
<li>客户的 10 类违规类别是第一层级。</li>
<li>后续可以扩展子类别（如“仇恨言论 → 针对性别 / 种族 / 职业”），满足更精细化的内容治理需求。</li>
</ul>
</li>
<li>
<p><strong>成本优化</strong></p>
<ul>
<li>会结合Bedrock的cache特性，增加对system prompt、user prompt的cache，在保证审核效果的情况下，尽可能优化成本。</li>
<li>成本详情请参阅Amazon Bedrock成本页面（<a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fbedrock%2Fpricing%2F" target="_blank" title="https://aws.amazon.com/cn/bedrock/pricing/" ref="nofollow noopener noreferrer">aws.amazon.com/cn/bedrock/…</a>）与Claude模型成本页面（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.claude.com%2Fzh-CN%2Fdocs%2Fabout-claude%2Fpricing" target="_blank" title="https://docs.claude.com/zh-CN/docs/about-claude/pricing" ref="nofollow noopener noreferrer">docs.claude.com/zh-CN/docs/…</a>）</li>
</ul>
</li>
</ol>
<h2 data-id="heading-24">结语</h2>
<p>从最初的“误判频发”，到最终实现 <strong>81%</strong> <strong>的整体准确率</strong>，我们通过 <strong>提示词工程 + ReAct</strong> <strong>框架 +</strong> <strong>工程化架构</strong>，帮助客户构建了一套 <strong>稳定、可观测、可扩展</strong> 的游戏社区审核系统。</p>
<p>这个过程的价值在于：</p>
<ul>
<li>它不仅是一次模型调优尝试，而是一套 <strong>可工程化复制的方法论</strong>；</li>
<li>在 <strong>UGC</strong> <strong>社区、社交平台、直播审核</strong> 等场景，都可以直接复用这套 <strong>提示词优化 +</strong> <strong>架构闭环</strong> 的方案；</li>
<li>通过 <strong>日志、判例库、蓝绿部署</strong> 等工程实践，我们让审核系统具备了 <strong>一致性、可追溯性和快速迭代能力</strong>。</li>
</ul>
<p>最终，这个项目让我们看到了 <strong>大语言模型 +</strong> <strong>工程化落地</strong> 在内容审核领域的潜力：</p>
<ul>
<li><strong>提示词调优</strong> 让模型快速逼近甚至超越人工审核的一致性；</li>
<li><strong>工程化架构</strong> 确保系统在 <strong>高并发、大规模多语言</strong> 审核场景下依旧稳定运行；</li>
<li><strong>端到端闭环</strong> 使审核系统不仅能解决当下问题，还能通过数据回流不断自我进化。</li>
</ul>
<p>*前述特定亚马逊云科技生成式人工智能相关的服务目前在亚马逊云科技海外区域可用。亚马逊云科技中国区域相关云服务由西云数据和光环新网运营，具体信息以中国区域官网为准。</p>
<p><strong>本篇作者</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c97474c05804f76a9aaec207af439bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765763948&amp;x-signature=H5SQL8MHEiFJ%2FNbNyzoLqiI0eXE%3D" alt="1.webp" loading="lazy"/></p>
<blockquote>
<p>本期最新实验《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_Juejintail_0415%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_0415" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_Juejintail_0415&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_0415" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>⏩️[<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_Juejintail_0415%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_0415" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_Juejintail_0415&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_0415" ref="nofollow noopener noreferrer">点击进入实验</a>] 即刻开启  AI 开发之旅</p>
<p>构建无限, 探索启程！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据会说谎？三大推断方法帮你“审问”数据真相]]></title>    <link>https://juejin.cn/post/7581097111896571958</link>    <guid>https://juejin.cn/post/7581097111896571958</guid>    <pubDate>2025-12-08T12:26:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581097111896571958" data-draft-id="7581117416811610155" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 数据会说谎？三大推断方法帮你“审问”数据真相"/> <meta itemprop="keywords" content="Python,数据分析,后端"/> <meta itemprop="datePublished" content="2025-12-08T12:26:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             数据会说谎？三大推断方法帮你“审问”数据真相
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T12:26:42.000Z" title="Mon Dec 08 2025 12:26:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多刚入行甚至想入行数据分析的朋友，往往会陷入一个<strong>误区</strong>：以为数据分析就是不停地<strong>做报表</strong>、<strong>画饼图</strong>。</p>
<p>其实，数据分析的核心魅力在于 <strong>“推断”——即见微知著</strong>。</p>
<p>在现实生活中，我们很难获取“全量数据”（比如你不可能调查全国每一个人的身高），那么，如何通过手中的“小样本”去推测“大总体”的规律？</p>
<p>这就需要用到统计学中的<strong>推断分析</strong>。</p>
<p>本文将结合代码来介绍<strong>推断分析</strong>中最常用的三大方法：<strong>参数估计</strong>、<strong>假设检验</strong>、<strong>非参数检验</strong>。</p>
<h2 data-id="heading-0">1. 参数估计</h2>
<p>想象你在煮一锅排骨汤。你想知道汤咸不咸，你不会把整锅汤都喝完，而是舀起一勺尝一尝。</p>
<ul>
<li>那一勺汤就是<strong>样本</strong>。</li>
<li>那一勺的咸度就是<strong>样本统计量</strong>。</li>
<li>整锅汤的咸度就是我们要猜的<strong>总体参数</strong>。</li>
</ul>
<p><strong>参数估计</strong>就是：根据样本的特征（比如<strong>样本均值</strong>），去估计总体的特征（比如<strong>总体均值</strong>）。</p>
<p>它通常分为两种：</p>
<ul>
<li><strong>点估计</strong>：直接说“这锅汤是1.5%的盐度”。（但这很容易被打脸，因为太绝对）</li>
<li><strong>区间估计</strong>：说“这锅汤的盐度在1.4%到1.6%之间，我有95%的把握”。（这就是置信区间，更科学）</li>
</ul>
<p><strong>区间估计</strong>是最常使用的方式，下面通过一个示例来演示<strong>参数估计</strong>的具体使用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> stats

<span class="hljs-comment"># 1. 模拟数据</span>
np.random.seed(<span class="hljs-number">42</span>)
true_mean = <span class="hljs-number">15</span>  <span class="hljs-comment"># 上帝视角的真实均值</span>
sample_salaries = np.random.normal(loc=true_mean, scale=<span class="hljs-number">3</span>, size=<span class="hljs-number">100</span>)  <span class="hljs-comment"># 模拟100个样本</span>

<span class="hljs-comment"># 2. 计算统计量</span>
sample_mean = np.mean(sample_salaries)
sample_std = np.std(sample_salaries, ddof=<span class="hljs-number">1</span>)
n = <span class="hljs-built_in">len</span>(sample_salaries)

<span class="hljs-comment"># 计算95%置信区间</span>
<span class="hljs-comment"># 这里的 scale 使用的是标准误 (Standard Error) = 样本标准差 / sqrt(n)</span>
conf_int = stats.t.interval(
    confidence=<span class="hljs-number">0.95</span>, df=n - <span class="hljs-number">1</span>, loc=sample_mean, scale=sample_std / np.sqrt(n)
)
lower_bound, upper_bound = conf_int

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"样本均值: <span class="hljs-subst">{sample_mean:<span class="hljs-number">.2</span>f}</span>k"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"95%置信区间: [<span class="hljs-subst">{lower_bound:<span class="hljs-number">.2</span>f}</span>k, <span class="hljs-subst">{upper_bound:<span class="hljs-number">.2</span>f}</span>k]"</span>)

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
样本均值: 14.69k
95%置信区间: [14.15k, 15.23k]
'''</span>
</code></pre>
<p>图形化之后的结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2485481dfd374b6f958cd86bf1d60464~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765801601&amp;x-signature=jHE5ZnE12Qk9cAi9MC1r1J64vjU%3D" alt="" loading="lazy"/></p>
<p>从图中可以看出：</p>
<ol>
<li><strong>灰色的散点</strong>：是你调研的那100个数据分析师的工资。你会发现有的高有的低，散落在各地。</li>
<li><strong>蓝色的点和横线</strong>：</li>
</ol>
<ul>
<li><strong>蓝点</strong>是你算出来的样本均值（约14.67k），虽然不完全等于真实的15k，但很接近。</li>
<li><strong>蓝色的横线</strong>就是置信区间。它的含义是：“虽然我不知道确切数字，但我敢打赌，真实数字就在这根蓝线的范围内。”</li>
</ul>
<ol start="3">
<li><strong>红色的虚线</strong>：这是真实的总体均值（15k）。</li>
<li><strong>结论</strong>：你可以清楚地看到，红色的虚线确实穿过了蓝色的横线。恭喜你！这次“参数估计”成功捕获了真理！</li>
</ol>
<p>数据分析不是算命，算出来的不是一个死的数字，而是一个科学的范围。</p>
<p>我们就是用<strong>参数估计</strong>的方法，在不确定性中寻找确定性。</p>
<h2 data-id="heading-1">2. 假设检验</h2>
<p><strong>假设检验</strong>是数据分析中最常用的决策工具。它的逻辑是：<strong>先立一个Flag（假设），然后看证据（数据）是否打脸</strong>。</p>
<ul>
<li><strong>原假设</strong> ：通常代表“无事发生”、“没有变化”、“运气好”。</li>
<li><strong>备择假设</strong>：通常代表“有事发生”、“真的有效果”。</li>
<li><strong>P值</strong>：表示原假设成立时，出现当前数据的概率。P值越小，说明原假设越不靠谱（通常以0.05为界限）。</li>
</ul>
<p>下面通过一个电商APP的A/B测试场景，来演示<strong>假设检验</strong>的使用。</p>
<p>假设某电商APP想把 <strong>“购买”</strong> 按钮从 <strong>蓝色</strong> 改成 <strong>红色</strong> 。</p>
<ul>
<li><strong>原假设</strong>：红色按钮和蓝色按钮的转化率没区别（差别纯属偶然）。</li>
<li><strong>备择假设</strong>：红色按钮的转化率显著高于蓝色按钮。</li>
</ul>
<p>我们采集了两组用户的消费金额数据来进行T检验。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 模拟AB测试数据</span>
<span class="hljs-comment"># 蓝色按钮组（对照组）：平均消费 100元</span>
group_blue = np.random.normal(loc=<span class="hljs-number">100</span>, scale=<span class="hljs-number">20</span>, size=<span class="hljs-number">1000</span>)
<span class="hljs-comment"># 红色按钮组（实验组）：平均消费 105元 (我们要检验这个提升是否显著)</span>
group_red = np.random.normal(loc=<span class="hljs-number">105</span>, scale=<span class="hljs-number">25</span>, size=<span class="hljs-number">1000</span>)

<span class="hljs-comment"># 2. 进行独立样本T检验 (T-test)</span>
t_stat, p_val = stats.ttest_ind(group_blue, group_red)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"P值: <span class="hljs-subst">{p_val:<span class="hljs-number">.5</span>f}</span>"</span>)

<span class="hljs-comment"># 3. 判断结论</span>
alpha = <span class="hljs-number">0.05</span>
<span class="hljs-keyword">if</span> p_val &lt; alpha:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"结论：拒绝原假设。红色按钮带来的消费提升是【统计显著】的，建议全量上线！"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"结论：无法拒绝原假设。两组差异可能是误差导致的，建议维持原状。"</span>)

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
P值: 0.00000
结论：拒绝原假设。红色按钮带来的消费提升是【统计显著】的，建议全量上线！
'''</span>
</code></pre>
<p>图形化结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/007a998a5b334cc1983d927a81d5cb52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765801601&amp;x-signature=m5GveoNuTzkuYjkksK1WM8NmpFY%3D" alt="" loading="lazy"/></p>
<p>从图中，我们可以看出，两条曲线（红色和蓝色）其实重叠度很高。</p>
<p>对于新手，看到这个图，可能会陷入一个误区，觉得“这两座山峰看起来差不多嘛，没啥区别”。</p>
<p>但在统计学上，两座山峰的 <strong>“重心”</strong> （均值）发生了 <strong>显著偏移</strong> 。这就是假设检验的威力--在重叠的噪声中识别出偏移的信号。</p>
<h2 data-id="heading-2">3. 非参数估计</h2>
<p>前面的 <strong>“参数估计”</strong> 和 <strong>“T检验”</strong> 都有一个娇气的脾气：它们通常假设数据是服从 <strong>“正态分布”</strong> 的（也就是漂亮的钟形曲线）。</p>
<p>但在现实生活中，很多数据并不正态，或者数据甚至是定序的（比如：非常满意、满意、一般、不满意）。</p>
<p>这时候，传统的 <strong>T检验</strong> 就失效了，我们需要请出 <strong>非参数检验</strong> 。</p>
<p>它不依赖数据的分布形状，非常抗造。</p>
<p>假设我们要对比两款手游《王者荣耀》和《原神》玩家每天的游玩时长。</p>
<p>由于《原神》玩家可能存在大量的“长尾”用户（玩特别久），数据往往是严重右偏的，不符合正态分布。</p>
<p>这时候对比两组数据差异，就不能用<strong>T检验</strong>，我们使用<strong>非参数估计</strong>中的一种方式：曼-惠特尼U检验 (Mann-Whitney U test)。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 模拟非正态分布数据 (使用指数分布模拟由偏数据)</span>
<span class="hljs-comment"># 游戏A：平均时长较短</span>
game_a_hours = np.random.exponential(scale=<span class="hljs-number">1.0</span>, size=<span class="hljs-number">100</span>)
<span class="hljs-comment"># 游戏B：平均时长较长</span>
game_b_hours = np.random.exponential(scale=<span class="hljs-number">1.5</span>, size=<span class="hljs-number">100</span>)

<span class="hljs-comment"># 2. 首先，检查一下正态性 (Shapiro-Wilk检验)</span>
<span class="hljs-comment"># 如果P &lt; 0.05，说明不是正态分布</span>
_, p_norm_a = stats.shapiro(game_a_hours)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"游戏A正态性检验P值: <span class="hljs-subst">{p_norm_a:<span class="hljs-number">.4</span>f}</span> (小于0.05则非正态)"</span>)

<span class="hljs-comment"># 3. 使用非参数检验：Mann-Whitney U检验</span>
<span class="hljs-comment"># 它可以比较两个独立样本的分布是否存在差异（侧重于中位数/秩次的比较）</span>
u_stat, p_val_nonparam = stats.mannwhitneyu(game_a_hours, game_b_hours, alternative=<span class="hljs-string">'two-sided'</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Mann-Whitney U检验 P值: <span class="hljs-subst">{p_val_nonparam:<span class="hljs-number">.5</span>f}</span>"</span>)

<span class="hljs-keyword">if</span> p_val_nonparam &lt; <span class="hljs-number">0.05</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"结论：两款游戏的玩家游玩时长分布存在显著差异。"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"结论：两款游戏玩家游玩时长无显著差异。"</span>)

<span class="hljs-comment"># 运行结果：</span>
<span class="hljs-string">'''
游戏A正态性检验P值: 0.0000 (小于0.05则非正态)
Mann-Whitney U检验 P值: 0.00003
结论：两款游戏的玩家游玩时长分布存在显著差异。
'''</span>
</code></pre>
<p>可视化结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93946f2319514f0799b428ff9ce98157~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765801601&amp;x-signature=YIoZEwYKr5SHRNZpgn1OoZhSI24%3D" alt="" loading="lazy"/></p>
<p>尽管数据长得歪瓜裂枣（严重右偏），<strong>U检验</strong>依然稳健地告诉我们：<strong>这两组数据不一样</strong>。</p>
<p><strong>U检验</strong>比较的不仅仅是平均值，它更多是在比较 <strong>“秩次”</strong>（<code>Ranking</code>）。</p>
<p>通俗点说，它发现如果我们把两组玩家混在一起排名，<code>Game B</code>的玩家即使不看具体时长，排名也普遍比<code>Game A</code>的玩家靠前。</p>
<p>从图中来看，你会看到橙色（<code>Game B</code>）的尾巴明显比蓝色（<code>Game A</code>）拖得更长、更厚实。</p>
<p>这说明<code>Game B</code>（比如《原神》）更容易让玩家沉浸更久，或者拥有更多的重度玩家。</p>
<h2 data-id="heading-3">4. 总结</h2>
<p>恭喜你！你已经掌握了数据<strong>推断分析</strong>的核心逻辑：</p>
<ol>
<li><strong>参数估计</strong>：当你只有样本，想知道总体的数值范围时使用。（比如估算平均薪资）</li>
<li><strong>假设检验</strong>：当你数据比较“完美”（正态分布），想判断差异是不是真的时使用。（比如A/B测试）</li>
<li><strong>非参数检验</strong>：当你数据分布奇怪、或者只有排名/等级数据时使用。（比如评分对比、长尾数据分析）</li>
</ol>
<p>这<strong>三板斧</strong>是数据分析师行走江湖的必备技能。掌握了它们，你就不仅仅是一个“做表的”，而是一个能从数据中挖掘真相的“侦探”！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA["讲讲原型链" —— 面试官最爱问的 JavaScript 基础]]></title>    <link>https://juejin.cn/post/7581324171398479918</link>    <guid>https://juejin.cn/post/7581324171398479918</guid>    <pubDate>2025-12-08T14:25:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581324171398479918" data-draft-id="7581292270961754122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="&quot;讲讲原型链&quot; —— 面试官最爱问的 JavaScript 基础"/> <meta itemprop="keywords" content="JavaScript,前端,面试"/> <meta itemprop="datePublished" content="2025-12-08T14:25:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            "讲讲原型链" —— 面试官最爱问的 JavaScript 基础
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T14:25:25.000Z" title="Mon Dec 08 2025 14:25:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript 原型与原型链：从困惑到完全理解</h2>
<p>以前在看 JavaScript 代码的时候，经常会遇到一个问题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
arr.<span class="hljs-title function_">push</span>(<span class="hljs-number">4</span>);      <span class="hljs-comment">// 4</span>
arr.<span class="hljs-title function_">join</span>(<span class="hljs-string">','</span>);    <span class="hljs-comment">// "1,2,3,4"</span>
arr.<span class="hljs-title function_">toString</span>();   <span class="hljs-comment">// "1,2,3,4"</span>
</code></pre>
<p>我明明只创建了一个数组，为什么它能调用 <code>push</code>、<code>join</code>、<code>toString</code> 这些方法？这些方法是从哪来的？</p>
<p>再看这段代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
};

<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'张三'</span>);
person.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// "Hello, I'm 张三"</span>
</code></pre>
<p><code>person</code> 对象本身没有 <code>sayHello</code> 方法，但却能调用它。这背后的机制就是原型链。</p>
<hr/>
<h3 data-id="heading-1">先搞清楚几个概念</h3>
<p>在深入之前，先把几个容易混淆的概念理清楚：</p>
<h4 data-id="heading-2"><code>[[Prototype]]</code>、<code>__proto__</code>、<code>prototype</code> 的区别</h4>





























<table><thead><tr><th>概念</th><th>是什么</th><th>属于谁</th><th>作用</th></tr></thead><tbody><tr><td><code>[[Prototype]]</code></td><td>内部属性</td><td>所有对象</td><td>指向对象的原型，隐藏属性</td></tr><tr><td><code>__proto__</code></td><td>访问器属性</td><td>所有对象</td><td>暴露 <code>[[Prototype]]</code>，非标准但广泛支持</td></tr><tr><td><code>prototype</code></td><td>普通属性</td><td>函数</td><td>存放给实例共享的属性和方法</td></tr></tbody></table>
<p>简单说：</p>
<ul>
<li><strong><code>prototype</code></strong> 是<strong>函数</strong>才有的属性，用来存放共享方法</li>
<li><strong><code>__proto__</code></strong> 是<strong>所有对象</strong>都有的属性，指向它的原型对象</li>
<li><strong><code>[[Prototype]]</code></strong> 是 <code>__proto__</code> 的内部实现</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Foo</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">const</span> foo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Foo</span>();

<span class="hljs-comment">// prototype 只有函数才有</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Foo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);      <span class="hljs-comment">// {constructor: ƒ}</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(foo.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);      <span class="hljs-comment">// undefined</span>

<span class="hljs-comment">// __proto__ 所有对象都有</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(foo.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Foo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-3">现代写法：Object.getPrototypeOf()</h4>
<p><code>__proto__</code> 虽然好用，但它不是 ECMAScript 标准的一部分，只是各浏览器都实现了。推荐用标准方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取原型</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(foo) === <span class="hljs-title class_">Foo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>  <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 设置原型</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(obj, prototype)

<span class="hljs-comment">// 创建时指定原型</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(prototype)
</code></pre>
<hr/>
<h3 data-id="heading-4">原型是什么</h3>
<p>JavaScript 里每个函数都有一个 <code>prototype</code> 属性，指向一个对象。这个对象叫做<strong>原型对象</strong>，它的作用是让该函数创建的所有实例共享属性和方法。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Car</span>(<span class="hljs-params">brand</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">brand</span> = brand;
}

<span class="hljs-comment">// 方法定义在原型上，所有实例共享</span>
<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">start</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.brand}</span> 启动了`</span>);
};

<span class="hljs-keyword">const</span> car1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>(<span class="hljs-string">'丰田'</span>);
<span class="hljs-keyword">const</span> car2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>(<span class="hljs-string">'本田'</span>);

car1.<span class="hljs-title function_">start</span>(); <span class="hljs-comment">// 丰田 启动了</span>
car2.<span class="hljs-title function_">start</span>(); <span class="hljs-comment">// 本田 启动了</span>

<span class="hljs-comment">// 两个实例用的是同一个方法</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(car1.<span class="hljs-property">start</span> === car2.<span class="hljs-property">start</span>); <span class="hljs-comment">// true</span>
</code></pre>
<p>这就是原型的核心价值：<strong>方法只需要定义一次，所有实例都能用</strong>。</p>
<p>如果把方法定义在构造函数里，每创建一个实例就会新建一个函数，浪费内存：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不推荐的写法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">BadCar</span>(<span class="hljs-params">brand</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">brand</span> = brand;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {  <span class="hljs-comment">// 每个实例都有一份</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.brand}</span> 启动了`</span>);
  };
}

<span class="hljs-keyword">const</span> bad1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadCar</span>(<span class="hljs-string">'丰田'</span>);
<span class="hljs-keyword">const</span> bad2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadCar</span>(<span class="hljs-string">'本田'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bad1.<span class="hljs-property">start</span> === bad2.<span class="hljs-property">start</span>); <span class="hljs-comment">// false，两个不同的函数</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">new 关键字到底做了什么</h3>
<p>理解原型链之前，得先搞清楚 <code>new</code> 的工作原理。当你写 <code>new Foo()</code> 时，JavaScript 引擎会执行以下四个步骤：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A['1. 创建空对象']:::step --&gt; B['2. 设置原型链']:::step
    B --&gt; C['3. 执行构造函数']:::step
    C --&gt; D['4. 返回对象']:::success

    classDef step fill:#cce5ff,stroke:#0d6efd,color:#004085
    classDef success fill:#d4edda,stroke:#28a745,color:#155724
</code></pre>
<h4 data-id="heading-6">详细步骤</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">greet</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
};

<span class="hljs-keyword">const</span> john = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'John'</span>);
</code></pre>
<p><strong>Step 1：创建一个空对象</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 内部创建：{}</span>
</code></pre>
<p><strong>Step 2：将空对象的 <code>[[Prototype]]</code> 指向构造函数的 <code>prototype</code></strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 内部操作：newObj.__proto__ = Person.prototype</span>
</code></pre>
<p><strong>Step 3：用这个空对象作为 <code>this</code> 执行构造函数</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 内部操作：Person.call(newObj, 'John')</span>
<span class="hljs-comment">// 执行后 newObj 变成 { name: 'John' }</span>
</code></pre>
<p><strong>Step 4：返回对象</strong></p>
<ul>
<li>如果构造函数返回一个对象，就用那个对象</li>
<li>否则返回 Step 1 创建的对象</li>
</ul>
<h4 data-id="heading-7">手写一个 new</h4>
<p>理解了原理，可以自己实现一个：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">Constructor, ...args</span>) {
  <span class="hljs-comment">// 1. 创建空对象，原型指向构造函数的 prototype</span>
  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Constructor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);

  <span class="hljs-comment">// 2. 执行构造函数，this 绑定到新对象</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Constructor</span>.<span class="hljs-title function_">apply</span>(obj, args);

  <span class="hljs-comment">// 3. 如果构造函数返回对象，就用它；否则用新创建的对象</span>
  <span class="hljs-keyword">return</span> result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Object</span> ? result : obj;
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">const</span> p = <span class="hljs-title function_">myNew</span>(<span class="hljs-title class_">Person</span>, <span class="hljs-string">'Alice'</span>);
p.<span class="hljs-title function_">greet</span>(); <span class="hljs-comment">// Hi, I'm Alice</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// true</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">原型链的查找机制</h3>
<p>当访问对象的属性或方法时，JavaScript 会按照这个顺序查找：</p>
<ol>
<li>先在对象自身找</li>
<li>找不到，去对象的原型 (<code>__proto__</code>) 上找</li>
<li>还找不到，继续往上一级原型找</li>
<li>直到 <code>Object.prototype</code>，再往上就是 <code>null</code> 了</li>
</ol>
<p>这条查找链路就是<strong>原型链</strong>。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    A["dog 实例&lt;br/&gt;{ name: 'Buddy' }"]:::instance --&gt;|__proto__| B["Dog.prototype&lt;br/&gt;{ bark: ƒ }"]:::proto
    B --&gt;|__proto__| C["Animal.prototype&lt;br/&gt;{ speak: ƒ }"]:::proto
    C --&gt;|__proto__| D["Object.prototype&lt;br/&gt;{ toString: ƒ, ... }"]:::rootProto
    D --&gt;|__proto__| E["null"]:::endNode

    classDef instance fill:#cce5ff,stroke:#0d6efd,color:#004085
    classDef proto fill:#d4edda,stroke:#28a745,color:#155724
    classDef rootProto fill:#fff3cd,stroke:#ffc107,color:#856404
    classDef endNode fill:#f8d7da,stroke:#dc3545,color:#721c24
</code></pre>
<h4 data-id="heading-9">代码示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">speak</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> makes a sound`</span>);
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
}

<span class="hljs-comment">// 建立原型链：Dog.prototype -&gt; Animal.prototype</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Dog</span>;

<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">bark</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Woof!'</span>);
};

<span class="hljs-keyword">const</span> dog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">'Buddy'</span>);

<span class="hljs-comment">// 查找过程：</span>
dog.<span class="hljs-property">name</span>;    <span class="hljs-comment">// 在 dog 自身找到</span>
dog.<span class="hljs-title function_">bark</span>();  <span class="hljs-comment">// 在 Dog.prototype 找到</span>
dog.<span class="hljs-title function_">speak</span>(); <span class="hljs-comment">// 在 Animal.prototype 找到</span>
dog.<span class="hljs-title function_">toString</span>(); <span class="hljs-comment">// 在 Object.prototype 找到</span>
</code></pre>
<p>用代码验证这条链：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dog.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);                 <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);    <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-literal">null</span>);             <span class="hljs-comment">// true</span>
</code></pre>
<p>这就解释了开头的问题。数组能调用 <code>push</code>、<code>join</code>，是因为这些方法定义在 <code>Array.prototype</code> 上。能调用 <code>toString</code>，是因为顺着原型链能找到 <code>Object.prototype.toString</code>（虽然 Array 重写了这个方法）。</p>
<hr/>
<h3 data-id="heading-10">完整的原型链图谱</h3>
<p>JavaScript 的原型链比想象中更复杂，函数本身也是对象，也有自己的原型链：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph IL[实例层]
        foo["foo 实例"]:::instance
    end

    subgraph PL[原型层]
        FooP["Foo.prototype"]:::proto
        ObjP["Object.prototype"]:::rootProto
    end

    subgraph FL[函数层]
        Foo["Foo 函数"]:::func
        Obj["Object 函数"]:::func
        Func["Function 函数"]:::func
    end

    subgraph FPL[函数原型层]
        FuncP["Function.prototype"]:::funcProto
    end

    foo --&gt;|__proto__| FooP
    FooP --&gt;|__proto__| ObjP
    ObjP --&gt;|__proto__| NULL["null"]:::endNode

    Foo --&gt;|prototype| FooP
    Foo --&gt;|__proto__| FuncP

    Obj --&gt;|prototype| ObjP
    Obj --&gt;|__proto__| FuncP

    Func --&gt;|prototype| FuncP
    Func --&gt;|__proto__| FuncP

    FuncP --&gt;|__proto__| ObjP

    classDef instance fill:#cce5ff,stroke:#0d6efd,color:#004085
    classDef proto fill:#d4edda,stroke:#28a745,color:#155724
    classDef rootProto fill:#fff3cd,stroke:#ffc107,color:#856404
    classDef func fill:#e2d9f3,stroke:#6f42c1,color:#432874
    classDef funcProto fill:#fce4ec,stroke:#e91e63,color:#880e4f
    classDef endNode fill:#f8d7da,stroke:#dc3545,color:#721c24

    style IL fill:#e8f4fc,stroke:#0d6efd
    style PL fill:#e8f5e9,stroke:#28a745
    style FL fill:#f3e5f5,stroke:#6f42c1
    style FPL fill:#fce4ec,stroke:#e91e63
</code></pre>
<h4 data-id="heading-11">几个关键点</h4>
<p><strong>1. 所有函数都是 Function 的实例</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Foo</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);    <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Function</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true（自己创建自己）</span>
</code></pre>
<p><strong>2. Function.prototype 也是对象，它的原型是 Object.prototype</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
</code></pre>
<p><strong>3. Object.prototype 是原型链的终点</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-literal">null</span>); <span class="hljs-comment">// true</span>
</code></pre>
<p><strong>4. 一个有趣的循环</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Object 是函数，所以它的 __proto__ 是 Function.prototype</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// Function.prototype 是对象，所以它的 __proto__ 是 Object.prototype</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 这形成了一个有趣的"鸡生蛋蛋生鸡"的关系</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">属性遮蔽（Property Shadowing）</h3>
<p>如果对象自身和原型上有同名属性，会发生什么？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">name</span> = <span class="hljs-string">'Default'</span>;
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">greet</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
};

<span class="hljs-keyword">const</span> john = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'John'</span>);

<span class="hljs-comment">// 自身属性遮蔽原型属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(john.<span class="hljs-property">name</span>); <span class="hljs-comment">// 'John'，不是 'Default'</span>

<span class="hljs-comment">// 删除自身属性后，原型属性就露出来了</span>
<span class="hljs-keyword">delete</span> john.<span class="hljs-property">name</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(john.<span class="hljs-property">name</span>); <span class="hljs-comment">// 'Default'</span>
</code></pre>
<p>这就是<strong>属性遮蔽</strong>：自身属性会"遮住"原型链上的同名属性。</p>
<h4 data-id="heading-13">检查属性来源</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> john = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'John'</span>);

<span class="hljs-comment">// hasOwnProperty 只检查自身属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(john.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'name'</span>));  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(john.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'greet'</span>)); <span class="hljs-comment">// false</span>

<span class="hljs-comment">// in 操作符检查整个原型链</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'name'</span> <span class="hljs-keyword">in</span> john);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'greet'</span> <span class="hljs-keyword">in</span> john); <span class="hljs-comment">// true</span>
</code></pre>
<hr/>
<h3 data-id="heading-14">实现继承</h3>
<p>理解了原型链，继承就好办了。核心就两步：</p>
<ol>
<li>调用父构造函数，继承实例属性</li>
<li>设置原型链，继承原型方法</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Vehicle</span>(<span class="hljs-params">type</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> = type;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">speed</span> = <span class="hljs-number">0</span>;
}

<span class="hljs-title class_">Vehicle</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">accelerate</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">amount</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">speed</span> += amount;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.type}</span> 加速到 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.speed}</span> km/h`</span>);
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Car</span>(<span class="hljs-params">brand</span>) {
  <span class="hljs-title class_">Vehicle</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">'汽车'</span>);  <span class="hljs-comment">// 继承实例属性</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">brand</span> = brand;
}

<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Vehicle</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// 继承原型方法</span>
<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Car</span>;

<span class="hljs-comment">// 添加子类特有的方法</span>
<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">honk</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.brand}</span> 鸣笛`</span>);
};

<span class="hljs-comment">// 重写父类方法</span>
<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">accelerate</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">amount</span>) {
  <span class="hljs-title class_">Vehicle</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">accelerate</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, amount);
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">speed</span> &gt; <span class="hljs-number">120</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'超速警告'</span>);
  }
};

<span class="hljs-keyword">const</span> myCar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>(<span class="hljs-string">'丰田'</span>);
myCar.<span class="hljs-title function_">accelerate</span>(<span class="hljs-number">50</span>);   <span class="hljs-comment">// 汽车 加速到 50 km/h</span>
myCar.<span class="hljs-title function_">accelerate</span>(<span class="hljs-number">80</span>);   <span class="hljs-comment">// 汽车 加速到 130 km/h</span>
                        <span class="hljs-comment">// 超速警告</span>
myCar.<span class="hljs-title function_">honk</span>();           <span class="hljs-comment">// 丰田 鸣笛</span>
</code></pre>
<h4 data-id="heading-15">为什么用 Object.create() 而不是直接赋值</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误写法</span>
<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Vehicle</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
<span class="hljs-comment">// 问题：修改 Car.prototype 会影响 Vehicle.prototype</span>

<span class="hljs-comment">// 错误写法</span>
<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vehicle</span>();
<span class="hljs-comment">// 问题：会执行 Vehicle 构造函数，可能有副作用</span>

<span class="hljs-comment">// 正确写法</span>
<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Vehicle</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-comment">// 创建一个新对象，原型指向 Vehicle.prototype</span>
</code></pre>
<hr/>
<h3 data-id="heading-16">ES6 的 class 语法</h3>
<p>ES6 引入了 <code>class</code> 关键字，写起来更清爽：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-title function_">speak</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> makes a sound`</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, breed</span>) {
    <span class="hljs-variable language_">super</span>(name);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">breed</span> = breed;
  }

  <span class="hljs-title function_">bark</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Woof!'</span>);
  }
}

<span class="hljs-keyword">const</span> dog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">'Buddy'</span>, <span class="hljs-string">'Labrador'</span>);
dog.<span class="hljs-title function_">speak</span>(); <span class="hljs-comment">// Buddy makes a sound</span>
dog.<span class="hljs-title function_">bark</span>();  <span class="hljs-comment">// Woof!</span>
</code></pre>
<p>但要清楚，<code>class</code> 只是语法糖，底层还是原型链那套：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Dog</span>); <span class="hljs-comment">// "function"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dog.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-17">class 的一些特性</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Example</span> {
  <span class="hljs-comment">// 实例属性（ES2022+）</span>
  instanceProp = <span class="hljs-string">'instance'</span>;

  <span class="hljs-comment">// 私有属性（ES2022+）</span>
  #privateProp = <span class="hljs-string">'private'</span>;

  <span class="hljs-comment">// 静态属性</span>
  <span class="hljs-keyword">static</span> staticProp = <span class="hljs-string">'static'</span>;

  <span class="hljs-comment">// 静态方法</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">staticMethod</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'static method'</span>;
  }

  <span class="hljs-comment">// getter/setter</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">value</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.#privateProp;
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-18">几个容易踩的坑</h3>
<h4 data-id="heading-19">1. 引用类型放原型上会共享</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Student</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">hobbies</span> = [];  <span class="hljs-comment">// 所有实例共享这个数组</span>

<span class="hljs-keyword">const</span> s1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">'张三'</span>);
<span class="hljs-keyword">const</span> s2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">'李四'</span>);

s1.<span class="hljs-property">hobbies</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'reading'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(s2.<span class="hljs-property">hobbies</span>); <span class="hljs-comment">// ['reading']  // s2 也有了，出问题了</span>
</code></pre>
<p>引用类型（数组、对象）应该放在构造函数里：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Student</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">hobbies</span> = [];  <span class="hljs-comment">// 每个实例独立</span>
}
</code></pre>
<h4 data-id="heading-20">2. 别直接替换 prototype 对象</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Foo</span>(<span class="hljs-params"/>) {}

<span class="hljs-comment">// 直接替换 prototype 会丢失 constructor</span>
<span class="hljs-title class_">Foo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
  <span class="hljs-attr">method</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {}
};

<span class="hljs-keyword">const</span> foo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Foo</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(foo.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Foo</span>); <span class="hljs-comment">// false，变成 Object 了</span>
</code></pre>
<p>要么记得补上 constructor，要么用属性添加的方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方式一：补上 constructor</span>
<span class="hljs-title class_">Foo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
  <span class="hljs-attr">constructor</span>: <span class="hljs-title class_">Foo</span>,
  <span class="hljs-attr">method</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {}
};

<span class="hljs-comment">// 方式二：直接添加属性（推荐）</span>
<span class="hljs-title class_">Foo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">method</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {};
</code></pre>
<h4 data-id="heading-21">3. 箭头函数不能用作构造函数</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Foo</span> = (<span class="hljs-params"/>) =&gt; {};
<span class="hljs-keyword">const</span> foo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Foo</span>(); <span class="hljs-comment">// TypeError: Foo is not a constructor</span>
</code></pre>
<p>箭头函数没有 <code>prototype</code> 属性，也没有自己的 <code>this</code>，所以不能用 <code>new</code>。</p>
<h4 data-id="heading-22">4. instanceof 的局限性</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// instanceof 检查的是原型链</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([] <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([] <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Object</span>); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 跨 iframe/realm 时会失效</span>
<span class="hljs-comment">// iframe 里的 Array 和主页面的 Array 不是同一个</span>
</code></pre>
<p>更可靠的类型检查：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>([]);  <span class="hljs-comment">// "[object Array]"</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>([]);  <span class="hljs-comment">// true</span>
</code></pre>
<hr/>
<h3 data-id="heading-23">性能考虑</h3>
<h4 data-id="heading-24">原型链查找有开销</h4>
<p>属性查找会沿着原型链向上，链越长开销越大。虽然现代引擎有优化，但还是要注意：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 如果频繁访问原型链上的属性，可以缓存</span>
<span class="hljs-keyword">const</span> method = obj.<span class="hljs-property">someMethod</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
  method.<span class="hljs-title function_">call</span>(obj);  <span class="hljs-comment">// 比 obj.someMethod() 快</span>
}
</code></pre>
<h4 data-id="heading-25">Object.create(null) 创建纯净对象</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 普通对象会继承 Object.prototype</span>
<span class="hljs-keyword">const</span> obj = {};
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">toString</span>); <span class="hljs-comment">// ƒ toString() { [native code] }</span>

<span class="hljs-comment">// 纯净对象没有原型链</span>
<span class="hljs-keyword">const</span> pureObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(pureObj.<span class="hljs-property">toString</span>); <span class="hljs-comment">// undefined</span>

<span class="hljs-comment">// 适合用作字典/哈希表，不用担心键名冲突</span>
<span class="hljs-keyword">const</span> dict = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);
dict[<span class="hljs-string">'hasOwnProperty'</span>] = <span class="hljs-string">'safe'</span>;  <span class="hljs-comment">// 不会覆盖原型方法</span>
</code></pre>
<hr/>
<h3 data-id="heading-26">小结</h3>
<p>原型链说穿了就是一条查找链：找属性时从对象自身开始，顺着 <code>__proto__</code> 一路往上找，直到 <code>null</code>。</p>
<p>几个要点：</p>
<ul>
<li><code>prototype</code> 是函数的属性，用于存放共享的方法</li>
<li><code>__proto__</code>（或 <code>[[Prototype]]</code>）是对象的属性，指向它的原型</li>
<li>推荐用 <code>Object.getPrototypeOf()</code> 代替 <code>__proto__</code></li>
<li><code>new</code> 关键字做了四件事：创建对象、设置原型、执行构造函数、返回对象</li>
<li>方法定义在原型上，省内存</li>
<li><code>class</code> 是语法糖，底层还是原型链</li>
<li><code>Object.prototype</code> 是原型链的终点，它的 <code>__proto__</code> 是 <code>null</code></li>
</ul>
<p>理解了这个机制，再看 JavaScript 的面向对象就清晰多了。框架源码里大量使用原型链，比如 Vue 2 的响应式系统、各种插件的 mixin 实现，都是基于这套机制。</p>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul>
<hr/>
<h3 data-id="heading-27">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FJavaScript%2FGuide%2FInheritance_and_the_prototype_chain" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Inheritance_and_the_prototype_chain" ref="nofollow noopener noreferrer">MDN - Inheritance and the prototype chain</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FLearn_web_development%2FExtensions%2FAdvanced_JavaScript_objects%2FObject_prototypes" target="_blank" title="https://developer.mozilla.org/en-US/docs/Learn_web_development/Extensions/Advanced_JavaScript_objects/Object_prototypes" ref="nofollow noopener noreferrer">MDN - Object prototypes</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FJavaScript%2FReference%2FOperators%2Fnew" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/new" ref="nofollow noopener noreferrer">MDN - new operator</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavascript.info%2Fprototype-inheritance" target="_blank" title="https://javascript.info/prototype-inheritance" ref="nofollow noopener noreferrer">JavaScript.info - Prototypal inheritance</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MCP 网关实战：基于 Higress + Nacos 的零代码工具扩展方案]]></title>    <link>https://juejin.cn/post/7581210455827021860</link>    <guid>https://juejin.cn/post/7581210455827021860</guid>    <pubDate>2025-12-08T09:15:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581210455827021860" data-draft-id="7581117416810954795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MCP 网关实战：基于 Higress + Nacos 的零代码工具扩展方案"/> <meta itemprop="keywords" content="云原生,MCP"/> <meta itemprop="datePublished" content="2025-12-08T09:15:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MCP 网关实战：基于 Higress + Nacos 的零代码工具扩展方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T09:15:17.000Z" title="Mon Dec 08 2025 09:15:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    30
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：陆胤任</p>
<h2 data-id="heading-0">背景</h2>
<p>在 AI 大爆发的时代，已经有非常多的 AI 助手，结合 RAG 通过智能问答帮助用户解答问题。单纯地依靠智能问答帮助客户自助解答是远远不够的，我们需要让 AI 助手能够直接调用已有的丰富接口，朝着更强大的智能体演进。我们选用当下最为火热，且已逐步成为标准的 MCP 作为模型和接口之间通信的传输协议。关于 MCP，已有非常多的介绍文章，本文不再赘述。</p>
<p>在企业对外服务的场景下，MCP Server 需要解决以下几个问题：</p>
<ol>
<li>在服务的多实例高可用场景下，使用 SSE 通信方式如何维护 session；</li>
<li>如何做到动态更新 MCP 工具 Prompt，做到快速更新&amp;调试&amp;验证；</li>
<li>租户隔离的云服务场景下如何对用户的工具调用进行鉴权。</li>
</ol>
<p>Higress 可以很好地解决上面的问题 1，同时还有完善的运维监控体系，可视化易操作的控制台界面。为了解决问题 2，我们引入了 Nacos 负责注册后端服务以及管理维护 MCP 工具的元数据等信息。在整个 MCP 服务中，Higress 担任 MCP Proxy 的角色，Nacos 担任 MCP Registry 的角色。对于问题 3 租户隔离问题，会在下面鉴权章节中进行详细说明。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0eba8180a02843ce87ac6f061198089e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=So7bS373hR83Pm%2F3%2BxQzPYdzbww%3D" alt="图片" loading="lazy"/></p>
<p>Higress 和 Nacos 都是云原生的应用，在部署方面，自然选择使用 K8s 集群进行云原生部署。同时很多企业有自己的专属生产网络环境，一般和外网不通，因此本文会围绕如何利用社区版本的 Higress 和 Nacos（Apache-2.0 开源协议）进行私有化部署。因为内部环境的限制，我们没有办法直接通过 Helm 操作 K8s 集群进行部署，因此本文会围绕如何基于 Higress 和 Nacos 的 docker 镜像在 K8s 集群上进行分角色部署。</p>
<p>通过这套自建的网关服务，使用配置即可实现零代码扩展 Tool，新应用的注册、应用下面工具的扩展、工具 prompt 更新验证都能通过服务集成的可视化控制台，更新发布配置快速完成，<strong>接入方式极其简单！更新验证极其快速！</strong> 同时利用 Nacos 的命名空间能力可以做到服务和工具集的隔离，给不同的用户提供不同的 MCP 工具集。</p>
<h2 data-id="heading-1">私有化部署</h2>
<h3 data-id="heading-2">Higress</h3>
<p>Higress 支持三种部署方式：Helm、docker compose 和基于 all-in-one 的 docker 镜像进行部署。Higress 官方推荐使用 Helm 的方式进行生产环境的部署，将依赖的模块部署在不同的 pod 上。而因上述环境原因，这里选择使用第三种基于 all-in-one 的 docker 镜像 Dockerfile <strong>[</strong> <strong>1]</strong> 进行部署，将 Higress 依赖的组件以进程的方式部署在同一 pod 上面，通过多副本的方式实现服务高可用，也实现了对 K8s 集群 Ingress 的无侵入式部署。</p>
<p>我们先尝试直接引用 docker 镜像进行部署时，会报 WASM 的插件错误，查看报错信息是通过 oci 地址去下载 WASM 插件的时候出现了问题。同时 Higress 实现 MCP 功能也依赖了 WASM 插件，这是一个绕不开的问题。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">FROM</span> higress<span class="hljs-operator">-</span>registry.cn<span class="hljs-operator">-</span>hangzhou.cr.aliyuncs.com<span class="hljs-operator">/</span>higress<span class="hljs-operator">/</span><span class="hljs-keyword">all</span><span class="hljs-operator">-</span><span class="hljs-keyword">in</span><span class="hljs-operator">-</span><span class="hljs-keyword">one</span>:latest
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1242b0ea9ed342978a58e041aad988b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=p7%2BTDqnxe1fKmLCkkM2HaXQthOU%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-3">WASM 插件独立部署</h4>
<p>Higress 的 plugin-server <strong>[</strong> <strong>2]</strong> 项目就是为了“解决私有化部署 Higress 网关时拉取插件的痛点，优化了插件的下载与管理效率”，使 Higress 通过 http 的方式去下载独立部署的插件库，而不是通过 oci 去访问外部公开仓库，避免因网络问题导致插件拉取不下来。解决过程主要分为以下三个步骤：</p>
<p><strong>1）私有化部署 plugin-server</strong></p>
<pre><code class="hljs language-bash" lang="bash">FROM higress-registry.cn-hangzhou.cr.aliyuncs.com/higress/plugin-server:1.0.0
</code></pre>
<p><strong>2）为 plugin-server 集群申请 K8s Service（Cluster IP）</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">higress-plugin-server</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">higress-system</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">higress-plugin-server</span>
    <span class="hljs-attr">higress:</span> <span class="hljs-string">higress-plugin-server</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span>
  <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">higress-plugin-server</span>
    <span class="hljs-attr">higress:</span> <span class="hljs-string">higress-plugin-server</span>
</code></pre>
<p>K8s 集群内置的 DNS 为此创建的域名解析记录的格式为 <code>&lt;service-name&gt;.&lt;namespace&gt;.svc.cluster.local</code>。</p>
<p>在没有 K8s 的场景下也可以为 plugin-server 集群申请内网 VIP 或者 SLB 做好服务发现和负载均衡。</p>
<p><strong>3）修改 Higress 内置插件下载地址</strong></p>
<p>依照 github 中的示例，在基于 Higress 镜像的项目 Dockerfile 中声明插件的下载地址。这里有个地方需要注意下，readme 中给出的示例是环境变量的格式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/deef89984e3f456b86d4fa4f4bb6c730~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=FJYl%2FgFANq4CkQ%2F4hLb1ea6osNs%3D" alt="图片" loading="lazy"/></p>
<p>在 Dockerfile 中声明需要转义一下，${name}/${version} 的形式才可以被正确解析。</p>
<pre><code class="hljs language-bash" lang="bash">...
<span class="hljs-comment"># 模版</span>
ENV HIGRESS_ADMIN_WASM_PLUGIN_CUSTOM_IMAGE_URL_PATTERN=http://[申请的k8s service地址]/plugins/\<span class="hljs-variable">${name}</span>/\<span class="hljs-variable">${version}</span>/plugin.wasm
<span class="hljs-comment"># mcp wasm 插件下载地址</span>
ENV MCP_SERVER_WASM_IMAGE_URL=http://[申请的k8s service地址]/plugins/mcp-server/1.0.0/plugin.wasm
...
</code></pre>
<p>配置完独立的插件 HTTP 下载地址后重新部署，在服务器上可以看到 8080 端口以及 8443 端口可以被正常监听，说明 Higress 具备代理和网关功能的核心数据面组件已经可以正常服务了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50a78e0794714d30956da299515be560~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=OPioOJxDmJ%2Bnku7okYzm%2FQYjhw8%3D" alt="图片" loading="lazy"/></p>
<p>解决完 WASM 插件下载问题，基于 docker 镜像的 Higress 服务就可以被成功拉起并运行了。只不过基于这种模式部署的<strong>每个 pod 都是独立、对等、包含全部组件、功能完整的 Higress 服务，需要通过多副本的方式实现高可用。</strong></p>
<p>这种部署模式下，通过 Higress 自身集成的控制台去运维服务&amp;更改配置是不现实的，只能操作一台实例的配置变更，无法让实例间进行配置同步。因此在这种模式下的缺点是，只能通过在项目代码中维护配置文件，需要更改时走发布流程，将配置发布到每台实例上面。不过在我们这个场景下，需要变更配置的情况不多。</p>
<h4 data-id="heading-4">粘性会话</h4>
<p>在 MCP SSE 通信方式下，天然需要解决粘性会话的问题，Higress 基于 Redis 帮我们解决了这个问题。提前部署好 Redis 实例之后，打开 Higress 的 MCP 功能，并将 Redis 配置更新进去，重新部署一下就可以使用 MCP 的功能了。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">...</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">higress:</span> <span class="hljs-string">|-</span>
    <span class="hljs-attr">mcpServer:</span>
      <span class="hljs-string">enable:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">sse_path_suffix:</span> <span class="hljs-string">/sse</span>
      <span class="hljs-attr">redis:</span>
        <span class="hljs-attr">address:</span> <span class="hljs-string">xxx.redis.zhangbei.rds.aliyuncs.com:6379</span>
        <span class="hljs-string">username:</span> <span class="hljs-string">""</span>
        <span class="hljs-string">password:</span> <span class="hljs-string">"xxx"</span>
        <span class="hljs-attr">db:</span> <span class="hljs-number">0</span>
<span class="hljs-string">...</span>
</code></pre>
<p>这份配置文件可以维护在自己的基于 Higress 镜像的项目中，在部署的时候将配置文件 COPY 到指定目录（这种部署模式下，所有的配置文件都应该这么做）。</p>
<pre><code class="hljs language-bash" lang="bash">...
<span class="hljs-comment"># custom config</span>
COPY config/configmaps/higress-config.yaml /data/configmaps/higress-config.yaml
COPY config/mcpbridges/default.yaml /data/mcpbridges/default.yaml
COPY config/secrets/higress-console.yaml /data/secrets/higress-console.yaml
RUN <span class="hljs-built_in">chmod</span> +x /data/configmaps/higress-config.yaml &amp;&amp; \
    <span class="hljs-built_in">chmod</span> +x /data/secrets/higress-console.yaml &amp;&amp; \
    <span class="hljs-built_in">chmod</span> +x /data/mcpbridges/*
...
</code></pre>
<p>当整个 MCP 网关搭建完并使用的时候，在 redis 上通过 PSUBSCRIBE mcp-server-sse:* 命令可以看到如下的调用信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f181283db3440f4881d64258ccd6e0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=aIZvWhrez%2Fk6fyxcAJMGlTj3kbk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-5">自定义构建镜像</h4>
<p>官方构建出来的镜像一般会要求体积小，满足最小运行要求，所以很多功能其实并不集成在 Higress 的镜像中。如果你的企业有自己约定的通用镜像，或者是想在原本的基础上集成一些新的功能，如使用阿里云的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fsls%3Fspm%3Da1z389.11499242.0.0.65452413PLWe13%26utm_content%3Dg_1000408139" target="_blank" title="https://www.aliyun.com/product/sls?spm=a1z389.11499242.0.0.65452413PLWe13&amp;utm_content=g_1000408139" ref="nofollow noopener noreferrer">SLS</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fcms%3Fspm%3Da1z389.11499242.0.0.65452413vvcY0e%26utm_content%3Dg_1000408141" target="_blank" title="https://www.aliyun.com/product/cms?spm=a1z389.11499242.0.0.65452413vvcY0e&amp;utm_content=g_1000408141" ref="nofollow noopener noreferrer">云监控</a>等功能，就需要根据 all-in-one 镜像的 Dockerfile 内容进行自定义构建。这里有个注意的点是，Higress 中的 envoy 模块要求的 glibc 是 2.18 及以上版本。</p>
<p>其实只需要将 Higress 的 Dockerfile 文件内容移植过来就行，然后<strong>再声明下独立部署的 WASM 插件下载地址</strong>，就能实现基于指定镜像进行 Higress 自定义构建打包部署了。</p>
<p>Higress 服务搭建好后，就可以走对外公网访问的流程了：（1）一个是绑定 8001 端口，通过 Higress 控制台进行查看相关配置的域名，限制为只允许内网访问。注：这种模式下无法通过控制台直接去更改配置；（2）另一个是绑定 8080 端口，对外提供 MCP 网关服务的域名。</p>
<p>完整的 Dockerfile 如下：</p>
<pre><code class="hljs language-bash" lang="bash">FROM [企业内部基础镜像]
<span class="hljs-comment"># 下面为 Higress all-in-one dockerfile中的内容</span>
ARG HUB=higress-registry.cn-hangzhou.cr.aliyuncs.com/higress
...
<span class="hljs-comment"># 模版</span>
ENV HIGRESS_ADMIN_WASM_PLUGIN_CUSTOM_IMAGE_URL_PATTERN=http://[申请的k8s service地址]/plugins/\<span class="hljs-variable">${name}</span>/\<span class="hljs-variable">${version}</span>/plugin.wasm
<span class="hljs-comment"># mcp wasm 插件下载地址</span>
ENV MCP_SERVER_WASM_IMAGE_URL=http://[申请的k8s service地址]/plugins/mcp-server/1.0.0/plugin.wasm
...
<span class="hljs-comment"># 注意 dockerfile 中会去 github 下载对应处理器架构下的 yq 模块，企业内网环境下可以提前下载下来</span>
COPY ./yq_linux_[<span class="hljs-built_in">arch</span>] /usr/local/bin/yq
...
<span class="hljs-comment"># custom config</span>
COPY config/configmaps/higress-config.yaml /data/configmaps/higress-config.yaml
COPY config/mcpbridges/default.yaml /data/mcpbridges/default.yaml
COPY config/secrets/higress-console.yaml /data/secrets/higress-console.yaml
RUN <span class="hljs-built_in">chmod</span> +x /data/configmaps/higress-config.yaml &amp;&amp; \
    <span class="hljs-built_in">chmod</span> +x /data/secrets/higress-console.yaml &amp;&amp; \
    <span class="hljs-built_in">chmod</span> +x /data/mcpbridges/*
...
</code></pre>
<h3 data-id="heading-6">Nacos</h3>
<p>Nacos 的部署相对简单，除了通过 kubectl 或者 nacos-operator 工具直接操作 K8s 集群部署外，还可以直接基于 nacos-server 的镜像进行部署 Dockerfile <strong>[</strong> <strong>3]</strong> 。因上文提到的内部环境问题，我们这里选择基于 nacos-server 的镜像，将服务部署于 K8s 集群上面。</p>
<pre><code class="hljs language-bash" lang="bash">FROM nacos-registry.cn-hangzhou.cr.aliyuncs.com/nacos/nacos-server:latest
</code></pre>
<h4 data-id="heading-7">集群模式部署</h4>
<p>Nacos 集群模式下使用的一致性协议是基于 Raft 实现的，因此最小需要部署 3 台实例。</p>
<p>在引用 nacos-server 镜像的 dockerfile 中，声明 cluster 的部署模式。我们查看 nacos 的启动脚本，发现在 peer-finder（插件）目录不存在的情况下，如果定义了 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mi>A</mi><mi>C</mi><mi>O</mi><msub><mi>S</mi><mi>S</mi></msub><mi>E</mi><mi>R</mi><mi>V</mi><mi>E</mi><mi>R</mi><mi>S</mi><mtext>变量，会将</mtext></mrow><annotation encoding="application/x-tex">NACOS_SERVERS 变量，会将 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.02778em;">CO</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.00773em;">ER</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.05764em;">ERS</span><span class="mord cjk_fallback">变量，会将</span></span></span></span></span>NACOS_SERVERS 变量中的值写入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>L</mi><mi>U</mi><mi>S</mi><mi>T</mi><mi>E</mi><msub><mi>R</mi><mi>C</mi></msub><mi>O</mi><mi>N</mi><mi>F</mi><mtext>文件中，</mtext></mrow><annotation encoding="application/x-tex">CLUSTER_CONF 文件中，</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.10903em;">LU</span><span class="mord mathnormal" style="margin-right:0.05764em;">STE</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">ONF</span><span class="mord cjk_fallback">文件中，</span></span></span></span></span>CLUSTER_CONF 文件的默认路径是 /home/nacos/conf/cluster.conf，其中定义的就是 Nacos 集群的静态成员地址列表，它在集群首次启动时会被读取，用于告知每个节点“邻居”在哪，从而让它们能够互相发现、建立连接，并初始化 Raft 一致性协议。</p>
<pre><code class="hljs language-bash" lang="bash">...
PLUGINS_DIR=<span class="hljs-string">"/home/nacos/plugins/peer-finder"</span>
<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">print_servers</span></span>() {
   <span class="hljs-keyword">if</span> [[ ! -d <span class="hljs-string">"<span class="hljs-variable">${PLUGINS_DIR}</span>"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span> &gt;<span class="hljs-string">"<span class="hljs-variable">$CLUSTER_CONF</span>"</span>
    <span class="hljs-keyword">for</span> server <span class="hljs-keyword">in</span> <span class="hljs-variable">${NACOS_SERVERS}</span>; <span class="hljs-keyword">do</span>
      <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$server</span>"</span> &gt;&gt;<span class="hljs-string">"<span class="hljs-variable">$CLUSTER_CONF</span>"</span>
    <span class="hljs-keyword">done</span>
  <span class="hljs-keyword">else</span>
    bash <span class="hljs-variable">$PLUGINS_DIR</span>/plugin.sh
    <span class="hljs-built_in">sleep</span> 30
  <span class="hljs-keyword">fi</span>
}
...
</code></pre>
<p>因此我们可以在 Dockerfile 中维护当前集群下的 [实例 IP:端口] 列表，供 Nacos 集群启动时读取并初始化。</p>
<pre><code class="hljs language-ini" lang="ini">...
ENV <span class="hljs-attr">MODE</span>=cluster
ENV <span class="hljs-attr">NACOS_AUTH_TOKEN</span>=xxx
ENV <span class="hljs-attr">NACOS_AUTH_IDENTITY_KEY</span>=xxx
ENV <span class="hljs-attr">NACOS_AUTH_IDENTITY_VALUE</span>=xxx
ENV <span class="hljs-attr">NACOS_SERVERS</span>=<span class="hljs-string">"10.0.0.1:8848 10.0.0.2:8848 10.0.0.3:8848"</span>
<span class="hljs-comment"># nacos 用户名密码</span>
ENV <span class="hljs-attr">NACOS_USERNAME</span>=xxx
ENV <span class="hljs-attr">NACOS_PASSWORD</span>=xxx
...
</code></pre>
<h4 data-id="heading-8">实例间动态发现</h4>
<p>上面这种固定 IP 列表的方式<strong>缺点是显而易见的</strong>。它是一个静态的配置，当出现集群的扩缩容时，实例是没有办法自动去更新成员 IP 列表的，需要手动修改并发布，整个过程非常繁琐，严重情况下可能会影响线上服务的稳定性；且在云原生容器化背景下，IP 并不是固定的，随时有可能会因为故障迁移而改变 IP，维护静态 IP 列表与云原生的理念背道而驰。线上生产是完全不推荐这种方式的。</p>
<p>再回到上面 docker-startup.sh 脚本，可以通过 peer-finder 插件来实现集群间实例的发现，取代手动维护 cluster.conf 文件。peer-finder 插件运行依赖于 K8s 集群 Headless Service 域名，会去执行类似于 nslookup 命令查找 Service 下面的所有健康 Pod 的 IP 列表，类比于服务发现的能力 <strong>[</strong> <strong>4]</strong> ，这样就不用再手动去维护实例 IP 列表。</p>
<p>但是 peer-finder 的运行依赖于 StatefulSet 的实例部署模式，需要每个实例有固定的实例名。因为我们内部环境的限制，我们现在部署的都是无状态的实例，所以没有办法通过 peer-finder 来做这个事情。但是我们可以参照 peer-finder 脚本的实现思路，来自己写一个启动脚本。</p>
<p><strong>1）首先为 Nacos 集群申请 Headless 的 Service。</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-headless</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">mcp-nacos</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">mcp-nacos</span>
    <span class="hljs-attr">nacos:</span> <span class="hljs-string">mcp-nacos</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">peer-finder-port</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">8848</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8848</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">mcp-nacos</span>
  <span class="hljs-attr">sessionAffinity:</span> <span class="hljs-string">None</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b26974cc4274b4695cdd2fb29d07a8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=dYG94x8clr71BpPPG4PWEy5VIFg%3D" alt="图片" loading="lazy"/></p>
<p><strong>2）这里修改下 nacos-docker 的启动脚本，提供一个简单的实现。（仅供参考）</strong></p>
<pre><code class="hljs language-bash" lang="bash">...
原docker-startup.sh内容
...
<span class="hljs-comment"># 新增内容</span>
<span class="hljs-comment"># 注释掉 JAVA启动命令</span>
<span class="hljs-comment"># exec $JAVA ${JAVA_OPT}</span>
<span class="hljs-built_in">export</span> JAVA_OPT <span class="hljs-comment"># export JAVA 启动参数，方面下面读取</span>
HEADLESS_SERVICE_FQDN=<span class="hljs-string">"xxx.svc.cluster.local"</span>
CLUSTER_CONF_FILE=<span class="hljs-string">"/home/nacos/conf/cluster.conf"</span>
UPDATE_SCRIPT=<span class="hljs-string">"/home/nacos/bin/update-cluster.sh"</span> <span class="hljs-comment"># 原子更新脚本</span>
NACOS_START_CMD=<span class="hljs-string">"<span class="hljs-variable">$JAVA</span> <span class="hljs-variable">$JAVA_OPT</span>"</span>
<span class="hljs-comment"># 1. 动态创建 update-cluster.sh 脚本</span>
<span class="hljs-built_in">cat</span> &gt; <span class="hljs-variable">${UPDATE_SCRIPT}</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment">#!/bin/bash</span>
<span class="hljs-built_in">set</span> -e
NACOS_PORT=<span class="hljs-variable">${NACOS_APPLICATION_PORT:-8848}</span>
CLUSTER_CONF_FILE=<span class="hljs-string">"/home/nacos/conf/cluster.conf"</span>
TMP_CONF_FILE=<span class="hljs-string">"/home/nacos/conf/cluster.conf.tmp"</span>
&gt; <span class="hljs-string">"<span class="hljs-variable">${TMP_CONF_FILE}</span>"</span>
<span class="hljs-comment"># 从标准输入读取 nslookup 的原始输出</span>
awk <span class="hljs-string">'
/^Name:/ { flag=1; next }
flag &amp;&amp; /^Address:/ { print $2; flag=0 }
'</span> | <span class="hljs-keyword">while</span> IFS= <span class="hljs-built_in">read</span> -r ip; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$ip</span>"</span> ]; <span class="hljs-keyword">then</span>
      <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${ip}</span>:<span class="hljs-variable">${NACOS_PORT}</span>"</span> &gt;&gt; <span class="hljs-string">"<span class="hljs-variable">${TMP_CONF_FILE}</span>"</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>
<span class="hljs-comment"># 排序以确保文件内容的一致性，避免不必要的更新</span>
<span class="hljs-built_in">sort</span> -o <span class="hljs-string">"<span class="hljs-variable">${TMP_CONF_FILE}</span>"</span> <span class="hljs-string">"<span class="hljs-variable">${TMP_CONF_FILE}</span>"</span>
<span class="hljs-comment"># 只有在新旧配置不同时才执行更新</span>
<span class="hljs-comment"># 检查旧文件是否存在</span>
<span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"<span class="hljs-variable">${CLUSTER_CONF_FILE}</span>"</span> ] || ! cmp -s <span class="hljs-string">"<span class="hljs-variable">${TMP_CONF_FILE}</span>"</span> <span class="hljs-string">"<span class="hljs-variable">${CLUSTER_CONF_FILE}</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"[<span class="hljs-subst">$(date)</span>][update-script] Peer list changed. Updating config."</span>
    <span class="hljs-built_in">mv</span> <span class="hljs-string">"<span class="hljs-variable">${TMP_CONF_FILE}</span>"</span> <span class="hljs-string">"<span class="hljs-variable">${CLUSTER_CONF_FILE}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"[<span class="hljs-subst">$(date)</span>][update-script] cluster.conf updated:"</span>
    <span class="hljs-built_in">cat</span> <span class="hljs-string">"<span class="hljs-variable">${CLUSTER_CONF_FILE}</span>"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">rm</span> <span class="hljs-string">"<span class="hljs-variable">${TMP_CONF_FILE}</span>"</span>
<span class="hljs-keyword">fi</span>
EOF
<span class="hljs-built_in">chmod</span> +x <span class="hljs-variable">${UPDATE_SCRIPT}</span>
<span class="hljs-comment"># 2. 启动前的初始化循环</span>
MAX_INIT_RETRIES=30
RETRY_COUNT=0
MIN_PEERS=3 <span class="hljs-comment"># 期望的集群最小副本数量</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"[INFO] Initializing cluster config. Waiting for at least <span class="hljs-variable">${MIN_PEERS}</span> peers to be available..."</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
  <span class="hljs-comment"># 直接将 nslookup 的输出通过管道传给更新脚本</span>
  nslookup <span class="hljs-string">"<span class="hljs-variable">${HEADLESS_SERVICE_FQDN}</span>"</span> | <span class="hljs-variable">${UPDATE_SCRIPT}</span>
  <span class="hljs-comment"># 检查生成的配置文件行数</span>
  LINE_COUNT=$(<span class="hljs-built_in">wc</span> -l &lt; <span class="hljs-string">"<span class="hljs-variable">${CLUSTER_CONF_FILE}</span>"</span>)
  <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">${LINE_COUNT}</span>"</span> -ge <span class="hljs-string">"<span class="hljs-variable">${MIN_PEERS}</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"[INFO] Initial cluster.conf is ready with <span class="hljs-variable">${LINE_COUNT}</span> peers."</span>
    <span class="hljs-built_in">break</span>
  <span class="hljs-keyword">fi</span>
  RETRY_COUNT=$((RETRY_COUNT+<span class="hljs-number">1</span>))
  <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">${RETRY_COUNT}</span>"</span> -gt <span class="hljs-string">"<span class="hljs-variable">${MAX_INIT_RETRIES}</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"[WARN] Could not find <span class="hljs-variable">${MIN_PEERS}</span> peers after <span class="hljs-variable">${MAX_INIT_RETRIES}</span> retries. Starting with <span class="hljs-variable">${LINE_COUNT}</span> peers found."</span>
    <span class="hljs-built_in">break</span>
  <span class="hljs-keyword">fi</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"[INFO] Found <span class="hljs-variable">${LINE_COUNT}</span> peers. Waiting for more... Retrying in 5 seconds."</span>
  <span class="hljs-built_in">sleep</span> 5
<span class="hljs-keyword">done</span>
<span class="hljs-comment"># 3. 在后台启动我们自己的监控循环</span>
(
  <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">sleep</span> 15 <span class="hljs-comment"># 每 15 秒检查一次</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"[<span class="hljs-subst">$(date)</span>][monitor] Checking for peer updates..."</span>
    nslookup <span class="hljs-string">"<span class="hljs-variable">${HEADLESS_SERVICE_FQDN}</span>"</span> | <span class="hljs-variable">${UPDATE_SCRIPT}</span>
  <span class="hljs-keyword">done</span>
) &amp;
<span class="hljs-comment"># 4. 启动 Nacos 主进程</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"[INFO] Starting Nacos server..."</span>
<span class="hljs-built_in">exec</span> sh -c <span class="hljs-string">"<span class="hljs-variable">${NACOS_START_CMD}</span>"</span>
</code></pre>
<p>这样我们 cluster.conf 文件中的成员 IP 列表就实现了自动更新。</p>
<p>线上生产环境还是推荐使用有状态 StatefulSet 的部署模式，并结合 peer-finder 的能力实现实例间的互相发现。而不是用无状态的实例，自己去写脚本实现。后续我们也会升级到 StatefulSet 的模式进行部署。</p>
<h4 data-id="heading-9">配置外置 Mysql</h4>
<p>在集群部署模式下，就无法使用 Nacos 内置的不支持数据共享的 Derby 数据库，需要配置外置的 Mysql 数据库。提前部署好 Mysql 实例之后，按照 Nacos 中的 mysql-schema.sql <strong>[</strong> <strong>5]</strong> 数据库配置文件将表初始化，再将 mysql 配置信息写入 Dockerfile 中即可。</p>
<pre><code class="hljs language-ini" lang="ini">...
<span class="hljs-comment"># mysql config</span>
ENV <span class="hljs-attr">SPRING_DATASOURCE_PLATFORM</span>=mysql
ENV <span class="hljs-attr">MYSQL_DATABASE_NUM</span>=<span class="hljs-number">1</span>
ENV <span class="hljs-attr">MYSQL_SERVICE_HOST</span>=xxx.mysql.zhangbei.rds.aliyuncs.com
ENV <span class="hljs-attr">MYSQL_SERVICE_PORT</span>=<span class="hljs-number">3306</span>
ENV <span class="hljs-attr">MYSQL_SERVICE_DB_NAME</span>=nacos
ENV <span class="hljs-attr">MYSQL_SERVICE_USER</span>=xxx
ENV <span class="hljs-attr">MYSQL_SERVICE_PASSWORD</span>=xxx
...
</code></pre>
<p>在为 Nacos 做服务暴露的时候，只需要暴露 Nacos 控制台的 8080 端口，且限制为只允许内网访问即可。因为 Nacos 只是内部作为维护管理 MCP 工具元数据信息的 MCP Registry 使用，对用户侧不感知；且 Higress 和 Nacos 都部署在内网的 K8s 集群上面，内部通信通过 K8s 的 Service 即可，无需将 Nacos 的 8848 端口暴露给公网。</p>
<h4 data-id="heading-10">申请 K8s Service 供 Higress 使用</h4>
<p>注意 Higress 拉取/订阅 Nacos 中的配置会通过 gRPC 的方式调用，这里的 Service 需要<strong>暴露 8848 和 9848 两个端口</strong>给 Higress 使用。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">pre-oss-mcp-nacos-endpoint</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">aso-oss-mcp-nacos</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">mcp-nacos</span>
    <span class="hljs-attr">nacos:</span> <span class="hljs-string">mcp-nacos</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">subscribe-port</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">8848</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8848</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc-port</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">9848</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9848</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">nacos</span>
</code></pre>
<p>同理，如果想使用企业内部的镜像，或者是想在原本的基础上即成一些新的功能，如使用阿里云的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fsls%3Fspm%3Da1z389.11499242.0.0.65452413PLWe13%26utm_content%3Dg_1000408139" target="_blank" title="https://www.aliyun.com/product/sls?spm=a1z389.11499242.0.0.65452413PLWe13&amp;utm_content=g_1000408139" ref="nofollow noopener noreferrer">SLS</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fcms%3Fspm%3Da1z389.11499242.0.0.65452413vvcY0e%26utm_content%3Dg_1000408141" target="_blank" title="https://www.aliyun.com/product/cms?spm=a1z389.11499242.0.0.65452413vvcY0e&amp;utm_content=g_1000408141" ref="nofollow noopener noreferrer">云监控</a>等功能，也可根据 Nacos 的 Dockerfile 进行自定义构建部署。</p>
<h2 data-id="heading-11">鉴权</h2>
<p>Higress 自身提供了丰富的鉴权 <strong>[6</strong> <strong>]</strong> 能力，如果你的企业本身就基于 Higress 搭建了自己的网关并使用了 Higress 提供的鉴权能力，这种场景下直接复用原来的方案即可。</p>
<p>另一种场景下，企业中会有多个服务 Provider，每个 Provider 有不同的鉴权方式。如下图所示，某个服务提供者会通过拦截器对请求中携带的用户 Cookie 进行 RAM 鉴权；另一个服务提供者会通过 tengine lua 脚本对请求进行自定义鉴权；以及后续注册的服务可能有其他的鉴权方式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7acd4931beee4a66a5895d49856ed06f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=FlCLlI37yu7YtkE37sOHQtRox18%3D" alt="图片" loading="lazy"/></p>
<p>一方面，我们并不希望使用 Higress 的鉴权能力去覆盖全部的鉴权场景，开发维护成本过高，我们优先考虑直接复用服务提供者已有的鉴权能力；另一方面，如果通过网关层鉴权需要将 AK 或者认证信息存放在 Higress 服务上，在安全层面也不是一个合适的做法。</p>
<p>这里推荐的做法是直接在 MCP 工具调用的时候，将鉴权信息透传给服务提供者，让服务提供者完成鉴权。</p>
<h2 data-id="heading-12">MCP 验证</h2>
<p>根据文档 <strong>[</strong> <strong>7]</strong> 中的操作示例，我们可以简单做个全链路测试验证。主要分为以下三步：</p>
<p><strong>1）在 Nacos 中注册服务，并配置 MCP 工具的元数据信息：</strong></p>
<p>在 public 命名空间下，创建服务信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3cce81e87f4424e99a857611e3a2859~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=rocIeygmJaZ561pnlMZWFcJzTuY%3D" alt="图片" loading="lazy"/></p>
<p>在机器上将自己的服务作为永久实例注册进去。（这里为了快速验证黑屏登陆机器操作，线上生产环境还是须要白屏操作）</p>
<pre><code class="hljs language-ini" lang="ini">curl -X POST 'http://127.0.0.1:8848/nacos/v1/ns/instance?<span class="hljs-attr">namespaceId</span>=[namespace]&amp;serviceName=[service_name]&amp;groupName=[group_name]&amp;ip=[服务域名]&amp;port=[服务端口]&amp;ephemeral=<span class="hljs-literal">false</span><span class="hljs-string">'
</span></code></pre>
<p>注册完之后，就能在 Nacos 控制台上看到注册的服务配置以及健康状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5be0472e03b74a07bbd388c7c1d92e98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=fCfGlWrsNMz2SKZaOssffGrhkes%3D" alt="图片" loading="lazy"/></p>
<p>接着在 Nacos 控制台上配置 MCP 工具，添加一个简单工具，可以选择一个无参数 GET 接口，并发布。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d0605c476a54633aa18f22b8a6c70ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=X%2Bc%2FOXLZPSJHclqTUgq1Rc3RTIY%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c08d19a2f86d40f6ac93ff1fbd120dab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=LsC7KHhRH3Tzr5d99BDORRis73w%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"requestTemplate"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/xxx/list.json"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"GET"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"headers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"argsToUrlParam"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"responseTemplate"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{{.}}"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>2）在 Higress 中配置 MCP Nacos 的服务来源：</strong></p>
<p>这里为了快速测试关闭了 Nacos 的认证，线上环境建议开启 Nacos 的认证。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31950e12263e4c80b2ac2b9391c6a910~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=CY1pfDkMjfCyzh1RzzQzDOj4E3g%3D" alt="图片" loading="lazy"/></p>
<p><strong>3）在 Cursor/Cherry Studio 中配置对外暴露的 Higress 服务地址和 uri，即可使用 MCP 工具：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb0c06bc1fe04cb89931c0c337d67e1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=6Smx6MVRHg56dTsEO%2FKlNEPzqjk%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc7470b810164f83b9b8ca7d89834aae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=jvOuwgiMFNhQsb9FDi99mP73GPA%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-13">设计图</h2>
<h3 data-id="heading-14">容灾架构</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e48188f92d884ebd9159719acf34ae38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=n2kgUuKswot4UITM1wakegf0nBI%3D" alt="图片" loading="lazy"/></p>
<p>进入浏览器查看原图：<a href="https://link.juejin.cn?target=https%3A%2F%2Fimg.alicdn.com%2Fimgextra%2Fi2%2FO1CN0138v82b1L7vNY3RQdo_!!6000000001253-2-tps-6507-5451.png" target="_blank" title="https://img.alicdn.com/imgextra/i2/O1CN0138v82b1L7vNY3RQdo_!!6000000001253-2-tps-6507-5451.png" ref="nofollow noopener noreferrer">img.alicdn.com/imgextra/i2…</a></p>
<p>在整个 MCP 网关中，通过 uri 来路由不同的 MCP 工具，实现工具的隔离。</p>
<h3 data-id="heading-15">逻辑模块图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58740208297546f9bb5f91a6f3fea541~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=dcBqJ0pPEgGf9I085GFIzeU9Vgc%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-16">时序图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c3feed715ef439ab853acdd4f56d7d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870494&amp;x-signature=zwI7xElEp5JbbY6cAc8fSIrdR3g%3D" alt="图片" loading="lazy"/></p>
<p><strong>附录：</strong></p>
<p>[1] 基于 all-in-one 的 docker 镜像</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhigress-group%2Fhigress-standalone%2Fblob%2Fmain%2Fall-in-one%2FDockerfile" target="_blank" title="https://github.com/higress-group/higress-standalone/blob/main/all-in-one/Dockerfile" ref="nofollow noopener noreferrer">github.com/higress-gro…</a></p>
<p>[2] higress-plugin-server</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnkirito.moe%2Fhigress-plugin-server%2F" target="_blank" title="https://www.cnkirito.moe/higress-plugin-server/" ref="nofollow noopener noreferrer">www.cnkirito.moe/higress-plu…</a></p>
<p>[3] 基于 nacos-server 的镜像进行部署</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnacos-group%2Fnacos-docker%2Fblob%2Fmaster%2Fbuild%2FDockerfile" target="_blank" title="https://github.com/nacos-group/nacos-docker/blob/master/build/Dockerfile" ref="nofollow noopener noreferrer">github.com/nacos-group…</a></p>
<p>[4] 脚本源码</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkmodules%2Fpeer-finder%2Fblob%2Fmaster%2Fpeer-finder.go" target="_blank" title="https://github.com/kmodules/peer-finder/blob/master/peer-finder.go" ref="nofollow noopener noreferrer">github.com/kmodules/pe…</a></p>
<p>[5] mysql-schema.sql</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fnacos%2Fblob%2Fdevelop%2Fdistribution%2Fconf%2Fmysql-schema.sql" target="_blank" title="https://github.com/alibaba/nacos/blob/develop/distribution/conf/mysql-schema.sql" ref="nofollow noopener noreferrer">github.com/alibaba/nac…</a></p>
<p>[6] Higress 提供丰富鉴权能力</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhigress.cn%2Fdocs%2Flatest%2Fplugins%2Fauthentication%2Fbasic-auth%2F" target="_blank" title="https://higress.cn/docs/latest/plugins/authentication/basic-auth/" ref="nofollow noopener noreferrer">higress.cn/docs/latest…</a></p>
<p>[7] <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247575770%26idx%3D1%26sn%3Dca41d8dade57fcf378e1f7c5a5e0dca5%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247575770&amp;idx=1&amp;sn=ca41d8dade57fcf378e1f7c5a5e0dca5&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">基于 Nacos + Higress  的 MCP 开发新范式，手把手教程来了！</a></p>
<p>[8] <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU0MzkyMTgzNg%3D%3D%26mid%3D2247486505%26idx%3D1%26sn%3Db61997531cce196d0b7fc46f79a003be%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU0MzkyMTgzNg==&amp;mid=2247486505&amp;idx=1&amp;sn=b61997531cce196d0b7fc46f79a003be&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Nacos 3.0 正式发布：MCP Registry、安全零信任、链接更多生态</a></p>
<p>[9] 修改内置插件的镜像地址</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhigress.cn%2Fdocs%2Flatest%2Fops%2Fhow-tos%2Fbuiltin-plugin-url%2F" target="_blank" title="https://higress.cn/docs/latest/ops/how-tos/builtin-plugin-url/" ref="nofollow noopener noreferrer">higress.cn/docs/latest…</a></p>
<p>[10] Nacos 集群模式</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnacos.io%2Fdocs%2Flatest%2Fmanual%2Fadmin%2Fdeployment%2Fdeployment-cluster%2F" target="_blank" title="https://nacos.io/docs/latest/manual/admin/deployment/deployment-cluster/" ref="nofollow noopener noreferrer">nacos.io/docs/latest…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[UModel 查询：驯服“可观测性混乱”，阿里云的图模型建模利器！]]></title>    <link>https://juejin.cn/post/7581097545670524947</link>    <guid>https://juejin.cn/post/7581097545670524947</guid>    <pubDate>2025-12-08T08:26:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581097545670524947" data-draft-id="7580616979473252358" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="UModel 查询：驯服“可观测性混乱”，阿里云的图模型建模利器！"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-12-08T08:26:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            UModel 查询：驯服“可观测性混乱”，阿里云的图模型建模利器！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:26:00.000Z" title="Mon Dec 08 2025 08:26:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1AWSxBqEtQ%2F" target="_blank" title="https://www.bilibili.com/video/BV1AWSxBqEtQ/" ref="nofollow noopener noreferrer">点击此处，立即查看视频课程！</a></p>
<h2 data-id="heading-0">背景</h2>
<p>想象一下，你站在一个巨大的图书馆里，这里有成千上万本书，但每本书的目录都散落在不同的房间里，而且每间房间的索引方式都不一样。当你想要找一本关于“服务调用”的书时，你需要在 APM 房间、K8s 房间、云资源房间之间来回奔波，还要记住每个房间不同的查找规则...</p>
<p>这就是很多企业在可观测性领域面临的真实困境。而 UModel 就像是为这个混乱的图书馆建立了一套统一的“智能管理系统”，让你能够轻松探索和理解整个知识图谱的结构。</p>
<h3 data-id="heading-1">1.1 UModel 是什么</h3>
<p>UModel 是一种基于图模型的可观测数据建模方法，旨在解决企业级环境中可观测数据采集、组织和利用的核心挑战。UModel 采用 Node（节点）和 Link（边）组成的图结构来描述 IT 世界，通过标准化的数据建模方式，实现可观测数据的统一表示、存储解耦和智能分析。</p>
<p>作为阿里云可观测体系的数据建模基础，UModel 为企业提供了一套通用的可观测“交互语言”，让人、程序和 AI 都能够理解和分析可观测数据，从而构建真正的全栈可观测能力。</p>
<h4 data-id="heading-2">核心概念</h4>
<p>UModel 采用图论的基本概念，使用 Node（节点）和 Link（边）组成有向图来描述 IT 系统：</p>
<ul>
<li>Node（节点）：核心部分为 Set（数据集），表示同类型实体或数据的集合，如 EntitySet（实体集）、MetricSet（指标集）、LogSet（日志集）等；此外还包含数据集的存储类型（Storage），如 SLS、Prometheus、MySQL 等</li>
<li>Link（关联）：表示 Node 之间的关系，如 EntitySetLink（实体关联）、DataLink（数据关联）、StorageLink（存储关联）等</li>
<li>Field（字段）：用于约束和描述 Set 和 Link 的属性，包含名称、类型、约束规则、分析特性等 20 多种配置项</li>
</ul>
<h3 data-id="heading-3">1.2 UModel 查询是什么</h3>
<p>UModel 查询是 EntityStore 中用于查询知识图谱元数据的专用查询接口，通过 <code>.umodel </code>查询语法，可以探索 EntitySet 定义、EntitySetLink 关系以及完整的知识图谱结构，为数据建模分析和 Schema 管理提供强大支持。</p>
<h4 data-id="heading-4">查询目标区分</h4>
<p>UModel 查询与其他查询类型的区别：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e81bee11eb148fab48965bc2638cd23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765787160&amp;x-signature=9MZwRdZeKJoIEH7d9KARJOznCps%3D" alt="图片" loading="lazy"/></p>
<p>UModel 查询专注于元数据层面的探索，帮助用户理解数据模型的结构和定义，而非具体的运行时数据。</p>
<h2 data-id="heading-5">UModel 查询</h2>
<h3 data-id="heading-6">2.1 数据模型</h3>
<h4 data-id="heading-7">数据结构</h4>
<p>UModel 查询返回的数据具有固定的五字段结构：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccdea893da9a4cbc9d915fc03aa74c3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765787160&amp;x-signature=%2BGPa%2BHguPhM4HkYA1X0SBII8s%2B4%3D" alt="图片" loading="lazy"/></p>
<p>注意：<code>metadata、schema</code>、<code>spec</code> 是 JSON 格式的 string，需要使用 <code>json_extract_scalar</code> 函数进行提取。</p>
<h4 data-id="heading-8">数据示例</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad1bf5346b1a431385b4a2cadd0b6d74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765787160&amp;x-signature=w0ZDAJGkyyyN%2FyQuSIJEY4xH%2B1g%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-9">2.2 查询语法</h3>
<h4 data-id="heading-10">基础查询语法</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 基础查询格式</span>
.umodel <span class="hljs-operator">|</span> [SPL操作...]
<span class="hljs-comment">-- 带限制条件的查询</span>
.umodel <span class="hljs-operator">|</span> <span class="hljs-keyword">where</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">condition</span><span class="hljs-operator">&gt;</span> <span class="hljs-operator">|</span> limit <span class="hljs-operator">&lt;</span>count<span class="hljs-operator">&gt;</span>
</code></pre>
<h4 data-id="heading-11">核心查询模式</h4>
<h5 data-id="heading-12">1. List 场景 - 列表查询</h5>
<p>查询所有 UModel 数据：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-- 列出所有umodel数据（不建议使用）</span>
.umodel
<span class="hljs-deletion">-- 带分页的查询</span>
.umodel | limit 0, 10
</code></pre>
<p>按类型过滤：</p>
<pre><code class="hljs language-bash" lang="bash">-- 查询所有EntitySet定义
.umodel | <span class="hljs-built_in">where</span> kind = <span class="hljs-string">'entity_set'</span> | <span class="hljs-built_in">limit</span> 0, 10
-- 查询所有EntitySetLink定义
.umodel | <span class="hljs-built_in">where</span> kind = <span class="hljs-string">'entity_set_link'</span> | <span class="hljs-built_in">limit</span> 0, 10
-- 查询所有边类型（关系定义）
.umodel | <span class="hljs-built_in">where</span> __type__ = <span class="hljs-string">'link'</span> | <span class="hljs-built_in">limit</span> 0, 10
-- 查询所有节点类型（实体定义）
.umodel | <span class="hljs-built_in">where</span> __type__ = <span class="hljs-string">'node'</span> | <span class="hljs-built_in">limit</span> 0, 10
</code></pre>
<p>按属性过滤：</p>
<pre><code class="hljs language-bash" lang="bash">-- 查询特定名称的实体定义
.umodel | <span class="hljs-built_in">where</span> json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>) = <span class="hljs-string">'acs.ecs.instance'</span> | <span class="hljs-built_in">limit</span> 0, 10
-- 查询特定域的所有定义
.umodel | <span class="hljs-built_in">where</span> json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>) = <span class="hljs-string">'apm'</span> | <span class="hljs-built_in">limit</span> 0, 10
-- 查询多个域的定义
.umodel | <span class="hljs-built_in">where</span> json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>) <span class="hljs-keyword">in</span> (<span class="hljs-string">'acs'</span>, <span class="hljs-string">'apm'</span>, <span class="hljs-string">'k8s'</span>) | <span class="hljs-built_in">limit</span> 0, 10
</code></pre>
<h5 data-id="heading-13">2. 图计算场景 - 关系分析</h5>
<p>UModel 支持基于元数据的图计算，用于分析 EntitySet 之间的关系：</p>
<p>基础图查询语法：</p>
<pre><code class="hljs language-lua" lang="lua">.umodel | graph-<span class="hljs-built_in">match</span> &lt;<span class="hljs-built_in">path</span>&gt; project &lt;<span class="hljs-built_in">output</span>&gt;
</code></pre>
<p>基础概念：</p>
<p>在图查询中，有两个关键性的图概念：</p>
<p>节点类型，即 label 信息，在 UModel 的元数据图查询中，为 <code>&lt;domain&gt;@&lt;kind&gt;</code>，例如 <code>apm@entity_set</code>
节点 ID，即 <code>__entity_id__</code> 信息，在 UModel 的元数据图查询中，为 <code>kind::domain::name</code>，例如 <code>entity_set::apm::apm.service</code></p>
<p>图查询路径（PATH）使用 ASCII 字符描述关系方向：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/992db3f6a27d4e6bb3c9b1b89492762f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765787160&amp;x-signature=T09BDPNmUu3CZtxfjeZDsaTa4cE%3D" alt="图片" loading="lazy"/></p>
<p>查询 EntitySet 的邻居关系：</p>
<pre><code class="hljs language-css" lang="css">-- 查询特定EntitySet的所有关联关系
<span class="hljs-selector-class">.umodel</span> 
| graph-match (s:<span class="hljs-string">"acs@entity_set"</span> {__entity_id__: <span class="hljs-string">'entity_set::acs::acs.ecs.instance'</span>})
              -<span class="hljs-selector-attr">[e]</span>-(d) 
  project s, e, d | limit <span class="hljs-number">0</span>, <span class="hljs-number">10</span>
</code></pre>
<p>方向性关系查询：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 查询指向某个EntitySet的关系</span>
.umodel 
| graph-<span class="hljs-built_in">match</span> (s:<span class="hljs-string">"acs@entity_set"</span> {__entity_id__: <span class="hljs-string">'entity_set::acs::acs.ecs.instance'</span>})
              &lt;<span class="hljs-comment">--(d) </span>
  project s, d | limit <span class="hljs-number">0</span>, <span class="hljs-number">10</span>
<span class="hljs-comment">-- 查询从某个EntitySet出发的关系  </span>
.umodel 
| graph-<span class="hljs-built_in">match</span> (s:<span class="hljs-string">"acs@entity_set"</span> {__entity_id__: <span class="hljs-string">'entity_set::acs::acs.ack.cluster'</span>})
              <span class="hljs-comment">--&gt;(d) </span>
  project s, d | limit <span class="hljs-number">0</span>, <span class="hljs-number">10</span>
</code></pre>
<h3 data-id="heading-14">2.3 高级查询功能</h3>
<h4 data-id="heading-15">JSON 路径提取</h4>
<p>由于 UModel 数据采用 JSON 结构存储，需要使用 JSON 函数进行字段提取：</p>
<pre><code class="hljs language-ini" lang="ini">-- 提取基础信息
.umodel 
| extend 
    <span class="hljs-attr">entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">entity_domain</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>),
    <span class="hljs-attr">entity_description</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.description.zh_cn'</span>)
| project entity_name, entity_domain, entity_description | limit 0, 100
</code></pre>
<h4 data-id="heading-16">复杂条件筛选</h4>
<pre><code class="hljs language-java" lang="java">-- 多条件组合查询
.umodel 
| <span class="hljs-type">where</span> <span class="hljs-variable">kind</span> <span class="hljs-operator">=</span> <span class="hljs-string">'entity_set'</span>
  and <span class="hljs-title function_">json_extract_scalar</span><span class="hljs-params">(metadata, <span class="hljs-string">'$.domain'</span>)</span> in (<span class="hljs-string">'apm'</span>, <span class="hljs-string">'k8s'</span>)
  and <span class="hljs-title function_">json_array_length</span><span class="hljs-params">(json_extract(spec, <span class="hljs-string">'$.fields'</span>)</span>) &gt; <span class="hljs-number">5</span>
| <span class="hljs-type">extend</span> 
    <span class="hljs-variable">entity_name</span> <span class="hljs-operator">=</span> json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    field_count = json_array_length(json_extract(spec, <span class="hljs-string">'$.fields'</span>))
| sort field_count desc
| limit <span class="hljs-number">20</span>
</code></pre>
<h4 data-id="heading-17">聚合分析</h4>
<pre><code class="hljs language-ini" lang="ini">-- 按域统计EntitySet数量
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set'</span>
| extend <span class="hljs-attr">domain</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>)
| stats <span class="hljs-attr">entity_count</span> = count() by domain
| sort entity_count desc
</code></pre>
<h3 data-id="heading-18">2.4 性能优化建议</h3>
<h4 data-id="heading-19">使用精确过滤</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 优化前：范围过大</span>
.umodel <span class="hljs-operator">|</span> <span class="hljs-keyword">where</span> json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>) <span class="hljs-keyword">like</span> <span class="hljs-string">'%service%'</span>
<span class="hljs-comment">-- 优化后：精确匹配</span>
.umodel <span class="hljs-operator">|</span> <span class="hljs-keyword">where</span> kind <span class="hljs-operator">=</span> <span class="hljs-string">'entity_set'</span> 
  <span class="hljs-keyword">and</span> json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>) <span class="hljs-operator">=</span> <span class="hljs-string">'apm'</span>
  <span class="hljs-keyword">and</span> json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>) <span class="hljs-operator">=</span> <span class="hljs-string">'apm.service'</span>
</code></pre>
<h4 data-id="heading-20">过滤前置</h4>
<pre><code class="hljs language-ini" lang="ini">-- 优化前：后期过滤
.umodel 
| extend <span class="hljs-attr">name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>)
| where <span class="hljs-attr">name</span> = <span class="hljs-string">'apm.service'</span>
-- 优化后：过滤前置
.umodel 
| where json_extract_scalar(metadata, '$.name') = 'apm.service'
| extend <span class="hljs-attr">name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>)
</code></pre>
<h4 data-id="heading-21">图查询优化</h4>
<pre><code class="hljs language-scss" lang="scss">-- 优化前：全图搜索
<span class="hljs-selector-class">.umodel</span> | graph-match (s)-<span class="hljs-selector-attr">[e]</span><span class="hljs-built_in">-</span>(d) project s, e, d
-- 优化后：指定起始点
<span class="hljs-selector-class">.umodel</span> 
| graph-match (s:"apm@entity_set" {__entity_id__: 'entity_set::apm::apm.service'})
              -<span class="hljs-selector-attr">[e]</span><span class="hljs-built_in">-</span>(d) 
  project s, e, d
</code></pre>
<h2 data-id="heading-22">UModel 查询具体应用场景</h2>
<p>UModel 查询在实际应用中能够解决多种场景下的问题，为数据建模、Schema 管理和知识图谱分析提供强大支持。</p>
<h3 data-id="heading-23">3.1 Schema 探索与发现</h3>
<h4 data-id="heading-24">场景描述</h4>
<p>在大型可观测性系统中，可能存在数百个 EntitySet 定义，分布在不同的域（domain）中。用户需要快速了解系统中定义了哪些实体类型，以及它们的基本信息。</p>
<h4 data-id="heading-25">应用示例</h4>
<p>探索所有实体类型：</p>
<pre><code class="hljs language-ini" lang="ini">-- 列出所有EntitySet及其基本信息
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set'</span>
| extend 
    <span class="hljs-attr">entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">entity_domain</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>),
    <span class="hljs-attr">description</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.description.zh_cn'</span>)
| project entity_name, entity_domain, description
| sort entity_domain, entity_name
| limit 0, 100
</code></pre>
<p>按域分类查看：</p>
<pre><code class="hljs language-ini" lang="ini">-- 查看特定域（如APM）下的所有实体定义
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set'</span> 
  and json_extract_scalar(metadata, '$.domain') = 'apm'
| extend 
    <span class="hljs-attr">entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">description</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.short_description.zh_cn'</span>)
| project entity_name, description
| limit 0, 50
</code></pre>
<h3 data-id="heading-26">3.2 数据建模分析</h3>
<h4 data-id="heading-27">场景描述</h4>
<p>在进行数据建模优化时，需要分析现有 EntitySet 的字段复杂度、主键设计、索引配置等信息，以便识别需要优化的模型。</p>
<h4 data-id="heading-28">应用示例</h4>
<p>分析字段复杂度：</p>
<pre><code class="hljs language-ini" lang="ini">-- 分析各域下EntitySet的字段数量分布
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set'</span>
| extend 
    <span class="hljs-attr">domain</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>),
    <span class="hljs-attr">entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">field_count</span> = json_array_length(json_extract(spec, <span class="hljs-string">'$.fields'</span>))
| stats 
    <span class="hljs-attr">avg_fields</span> = avg(field_count),
    <span class="hljs-attr">max_fields</span> = max(field_count),
    <span class="hljs-attr">min_fields</span> = min(field_count),
    <span class="hljs-attr">entity_count</span> = count()
  by domain
| sort entity_count desc
</code></pre>
<p>查找复杂实体：</p>
<pre><code class="hljs language-ini" lang="ini">-- 找出字段数量最多的EntitySet（可能需要优化）
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set'</span>
| extend 
    <span class="hljs-attr">entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">domain</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>),
    <span class="hljs-attr">field_count</span> = json_array_length(json_extract(spec, <span class="hljs-string">'$.fields'</span>))
| sort field_count desc
| limit 20
</code></pre>
<h3 data-id="heading-29">3.3 关系图谱分析</h3>
<h4 data-id="heading-30">场景描述</h4>
<p>理解 EntitySet 之间的关系对于构建完整的知识图谱至关重要。通过图查询可以分析实体间的关联关系，发现数据模型中的依赖和连接。</p>
<h4 data-id="heading-31">应用示例</h4>
<p>查询实体的所有关联关系：</p>
<pre><code class="hljs language-css" lang="css">-- 查询某个EntitySet（如apm<span class="hljs-selector-class">.service</span>）的所有关联关系
<span class="hljs-selector-class">.umodel</span> 
| graph-match (s:<span class="hljs-string">"apm@entity_set"</span> {__entity_id__: <span class="hljs-string">'entity_set::apm::apm.service'</span>})
              -<span class="hljs-selector-attr">[e]</span>-(d) 
  project s, e, d
| limit <span class="hljs-number">0</span>, <span class="hljs-number">50</span>
</code></pre>
<p>分析关系类型分布：</p>
<pre><code class="hljs language-ini" lang="ini">-- 统计不同关系类型的数量
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set_link'</span>
| extend 
    <span class="hljs-attr">link_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">link_type</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.link_type'</span>)
| stats <span class="hljs-attr">limk_count</span> = count() by link_type
| sort limk_count desc
</code></pre>
<p>查找特定关系：</p>
<pre><code class="hljs language-ini" lang="ini">-- 查找所有"runs_on"类型的关系定义
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set_link'</span>
  and json_extract_scalar(metadata, '$.link_type') = 'runs_on'
| extend 
    <span class="hljs-attr">link_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">source</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.source'</span>),
    <span class="hljs-attr">target</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.target'</span>)
| project link_name, source, target
</code></pre>
<h3 data-id="heading-32">3.4 元数据质量检查</h3>
<h4 data-id="heading-33">场景描述</h4>
<p>确保 UModel 元数据的完整性和一致性，检查缺失的描述、未定义的字段等问题。</p>
<h4 data-id="heading-34">应用示例</h4>
<p>检查缺失描述的 EntitySet：</p>
<pre><code class="hljs language-csharp" lang="csharp">-- 找出没有中文描述的EntitySet
.umodel 
| <span class="hljs-keyword">where</span> kind = <span class="hljs-string">'entity_set'</span>
  <span class="hljs-keyword">and</span> (json_extract_scalar(metadata, <span class="hljs-string">'$.description.zh_cn'</span>) = <span class="hljs-string">''</span> 
       <span class="hljs-function"><span class="hljs-keyword">or</span> <span class="hljs-title">json_extract_scalar</span>(<span class="hljs-params">metadata, <span class="hljs-string">'$.description.zh_cn'</span></span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>)
| extend 
    entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    domain = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>)
| project entity_name, domain
</code></pre>
<p>验证字段定义完整性：</p>
<pre><code class="hljs language-csharp" lang="csharp">-- 检查没有定义字段的EntitySet
.umodel 
| <span class="hljs-keyword">where</span> kind = <span class="hljs-string">'entity_set'</span>
  <span class="hljs-keyword">and</span> (json_extract(spec, <span class="hljs-string">'$.fields'</span>) <span class="hljs-function"><span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> 
       <span class="hljs-keyword">or</span> <span class="hljs-title">json_array_length</span>(<span class="hljs-params">json_extract(spec, <span class="hljs-string">'$.fields'</span></span>))</span> = <span class="hljs-number">0</span>)
| extend 
    entity_name = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    domain = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>)
| project entity_name, domain
</code></pre>
<h3 data-id="heading-35">3.5 跨域关联分析</h3>
<h4 data-id="heading-36">场景描述</h4>
<p>在复杂的可观测性系统中，不同域（如 APM、K8s、云资源）的实体可能存在关联关系。通过 UModel 查询可以分析这些跨域的关联模式。</p>
<h4 data-id="heading-37">应用示例</h4>
<p>查找跨域关系：</p>
<pre><code class="hljs language-ini" lang="ini">-- 查找连接不同域的EntitySetLink
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set_link'</span>
| extend 
    <span class="hljs-attr">link_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">source_domain</span> = json_extract_scalar(spec, <span class="hljs-string">'$.src.domain'</span>),
    <span class="hljs-attr">target_domain</span> = json_extract_scalar(spec, <span class="hljs-string">'$.dest.domain'</span>)
| where source_domain != target_domain
| project link_name, source_domain, target_domain
| limit 0, 50
</code></pre>
<p>分析域间连接度：</p>
<pre><code class="hljs language-ini" lang="ini">-- 统计各域之间的连接关系数量
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set_link'</span>
| extend 
    <span class="hljs-attr">source_domain</span> = json_extract_scalar(spec, <span class="hljs-string">'$.src.domain'</span>),
    <span class="hljs-attr">target_domain</span> = json_extract_scalar(spec, <span class="hljs-string">'$.dest.domain'</span>)
| stats <span class="hljs-attr">count</span> = count() by source_domain, target_domain
| sort count desc
</code></pre>
<h3 data-id="heading-38">3.6 版本与演进分析</h3>
<h4 data-id="heading-39">场景描述</h4>
<p>UModel Schema 会随着业务发展而演进，需要跟踪 Schema 的版本变化和演进历史。</p>
<h4 data-id="heading-40">应用示例</h4>
<p>查看 Schema 版本信息：</p>
<pre><code class="hljs language-ini" lang="ini">-- 查看所有EntitySet的Schema版本
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set'</span>
| extend 
    <span class="hljs-attr">entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">schema_version</span> = json_extract_scalar(schema, <span class="hljs-string">'$.version'</span>),
    <span class="hljs-attr">schema_url</span> = json_extract_scalar(schema, <span class="hljs-string">'$.url'</span>)
| project entity_name, schema_version, schema_url
| limit 0, 100
</code></pre>
<h3 data-id="heading-41">3.7 快速定位与检索</h3>
<h4 data-id="heading-42">场景描述</h4>
<p>在大量元数据中快速找到特定的 EntitySet 或关系定义，支持模糊匹配和精确查询。</p>
<h4 data-id="heading-43">应用示例</h4>
<p>按名称模糊搜索：</p>
<pre><code class="hljs language-ini" lang="ini">-- 搜索包含"service"的EntitySet
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set'</span>
  and json_extract_scalar(metadata, '$.name') like '%service%'
| extend 
    <span class="hljs-attr">entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">domain</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>)
| project entity_name, domain
| limit 0, 20
</code></pre>
<p>精确查找特定实体：</p>
<pre><code class="hljs language-bash" lang="bash">-- 精确查找特定EntitySet的完整定义
.umodel 
| <span class="hljs-built_in">where</span> json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>) = <span class="hljs-string">'apm.service'</span>
| <span class="hljs-built_in">limit</span> 1
</code></pre>
<h2 data-id="heading-44">总结</h2>
<p>UModel 查询作为 EntityStore 中专门用于查询知识图谱元数据的接口，为可观测性数据建模提供了强大的支持能力。通过 UModel 查询可以：</p>
<ol>
<li>探索 Schema 结构：快速了解系统中定义的所有实体类型和关系类型</li>
<li>分析数据模型：深入分析 EntitySet 的字段设计、主键配置、复杂度等</li>
<li>构建关系图谱：通过图查询分析实体间的关联关系，理解知识图谱的拓扑结构</li>
<li>质量检查：验证元数据的完整性和一致性</li>
<li>跨域分析：分析不同域之间的关联模式</li>
<li>快速检索：在大量元数据中快速定位目标定义</li>
</ol>
<p>这些能力使得 UModel 查询成为数据建模分析、Schema 管理和知识图谱探索的不可或缺的工具，为构建和维护高质量的可观测性数据模型提供了坚实的基础。</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1AWSxBqEtQ%2F" target="_blank" title="https://www.bilibili.com/video/BV1AWSxBqEtQ/" ref="nofollow noopener noreferrer">此处</a>查看视频演示。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[搞定多模态微调只需一杯咖啡的时间？FC DevPod + Llama-Factory 极速实战]]></title>    <link>https://juejin.cn/post/7581678301215817728</link>    <guid>https://juejin.cn/post/7581678301215817728</guid>    <pubDate>2025-12-09T09:24:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581678301215817728" data-draft-id="7581664445240950799" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="搞定多模态微调只需一杯咖啡的时间？FC DevPod + Llama-Factory 极速实战"/> <meta itemprop="keywords" content="云计算,云原生"/> <meta itemprop="datePublished" content="2025-12-09T09:24:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Serverless社区"/> <meta itemprop="url" content="https://juejin.cn/user/1794004139382301"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            搞定多模态微调只需一杯咖啡的时间？FC DevPod + Llama-Factory 极速实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1794004139382301/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Serverless社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T09:24:47.000Z" title="Tue Dec 09 2025 09:24:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为一个 AI 开发者，你一定经历过这样的绝望时刻： 兴致勃勃地下载了最新的 Qwen2-VL 权重，准备用自己的垂直领域数据跑一次 SFT（监督微调）。然而，现实却是残酷的——</p>
<ul>
<li><code>RuntimeError: CUDA out of memory</code> —— 显存不够，模型加载失败。</li>
<li><code>Driver/Library version mismatch</code> —— 驱动版本不对，环境配置陷入死循环。</li>
<li>看着云厂商 GPU 实例高昂的包月账单，犹豫着要不要为了这几小时的实验按下“购买”键。</li>
</ul>
<p>技术的进步本该是为了释放创造力，而不是增加门槛。在 Serverless 时代，算力应该像水电一样，扭开水龙头就有，关上就停，按需付费。</p>
<p>今天，我们将打破“微调=昂贵+麻烦”的刻板印象。不需要囤积显卡，也不需要精通运维，我们将带你体验一套“<strong>DevPod + Llama-Factory的极速组合拳</strong>”。</p>
<h3 data-id="heading-0">一、方案揭秘：FC + Llama-Factory 的“黄金搭档”</h3>
<p>工欲善其事，必先利其器。在开始实战之前，让我们先拆解一下这套“开箱即用”的微调流水线背后的三位主角。当它们在 Serverless 架构下相遇，复杂的模型训练就变成了一场流畅的搭积木游戏。</p>
<h4 data-id="heading-1">1. 主角：Qwen VL 模型 —— 多模态领域的“六边形战士”</h4>
<ul>
<li><strong>看得更清</strong>： 它不仅能识别图片中的物体，还能精准提取复杂的图表数据、阅读密集的文档文字（OCR），甚至理解长视频中的时序逻辑。</li>
<li><strong>懂你所想</strong>： 在指令遵循（Instruction Following）能力上大幅增强，这意味着通过微调，你可以更容易地让它学会你特定业务场景下的“行话”和规则。</li>
<li><strong>价值点</strong>： 选择 Qwen2-VL，意味着你的起点已经是行业顶尖水平，微调只是为了让它更懂你的私有数据。</li>
</ul>
<h4 data-id="heading-2">2. 工具：Llama-Factory —— 微调界的“瑞士军刀”</h4>
<p>对于许多开发者来说，微调最大的门槛不是不懂原理，而是不想写那几千行的 PyTorch 训练代码。Llama-Factory 的出现，完美解决了这个问题。</p>
<ul>
<li><strong>零代码门槛</strong>： 它提供了一个功能完备的 WebUI 界面。加载模型、配置参数、监控 Loss 曲线、评估效果，所有操作都可以在浏览器中通过点击完成。</li>
<li><strong>全流程覆盖</strong>： 从预训练（PT）、指令监督微调（SFT）到奖励模型训练（RM）和 PPO/DPO，它集成了业界最主流的微调方法（如 LoRA、QLoRA）。</li>
<li><strong>价值点</strong>： 它屏蔽了底层 DeepSpeed、Accelerate 等框架的复杂配置，让你能把精力集中在“数据质量”和“模型效果”上。</li>
</ul>
<h4 data-id="heading-3">3. 舞台：阿里云函数计算 FC —— 为 AI 而生的 Serverless 算力</h4>
<p>有了好模型和好工具，我们还需要一个能跑得动它们的“舞台”。传统的 GPU 服务器租赁模式往往面临“部署难、闲置贵”的尴尬，而 <strong>函数计算 FC</strong> 给出了全新的解法：</p>
<ul>
<li><strong>极致弹性，按量付费</strong>： 这是 Serverless 的灵魂。你只需要为训练的那几个小时付费。训练结束，实例可轻松释放，不再产生任何闲置费用。对于实验性质的微调任务，成本可以降低 50% 以上。</li>
<li><strong>环境预置，拒绝“配环境”</strong>： 我们在 FC 的应用中心预置了包含 CUDA、PyTorch 以及 Llama-Factory 依赖的官方镜像。这一步至关重要——它意味着你不需要处理任何驱动冲突，点击部署，环境即刻就绪。</li>
<li><strong>异构算力支持</strong>： FC 提供了丰富的 GPU 规格供你选择，满足不同规模的微调需求。</li>
</ul>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764920834972-bea889e5-125a-40b0-8c3d-f240f7ee45d7.png" alt="" loading="lazy"/></p>
<p><em>“当 Llama-Factory 的可视化交互遇上 FC 的极致弹性，微调 Qwen2-VL 就变成了一场‘点击即得’的流畅体验。我们不再需要像运维工程师一样盯着黑底白字的终端窗口，而是可以像修图师一样，在 Web 界面上优雅地打磨我们的模型。”</em></p>
<h3 data-id="heading-4">二、极速部署：5分钟搭建微调流水线</h3>
<p>传统微调的第一步通常是“租服务器、装驱动、配环境”，而在 Serverless 架构下，我们直接从“应用”开始。</p>
<p><strong>Step 1：DevPod 开发环境一键拉起</strong></p>
<p>登录 Function AI 控制台 - FunModel - 模型市场，点击页面的「自定义开发」，在「模型环境下」选择「自定义环境」，在容器镜像地址中填入 <code>serverless-registry.cn-hangzhou.cr.aliyuncs.com/functionai/devpod-presets:llama-factory-v0.9.4-v1</code>。该镜像已内置 llama-factory v0.9.4 的版本。</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764309769776-6be9d8e1-42bd-482e-934c-f4c1270a059a.png" alt="" loading="lazy"/></p>
<p><strong>Step 2：资源与存储配置（关键一步）</strong></p>
<p>只需关注 GPU 类型。对于 Qwen3-VL 的 LoRA 微调，推荐选择 GPU 性能型单卡即可满足需求，性价比极高。</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764309771303-bb94fc91-4553-4824-9e16-1aebd786bafb.png" alt="" loading="lazy"/></p>
<p><strong>Step 3：一键拉起环境，点击「DevPod 开发调试」</strong></p>
<p>FC 会自动拉取包含 CUDA 环境和 Llama-Factory 框架的镜像。大约等待 1-3 分钟，页面自动跳转到 DevPod 页面，我们进入 Terminal 下，执行命令 <code>USE_MODELSCOPE_HUB=1 lmf webui</code> 启动 llama-factory 的进程。</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764311554203-e01da0d8-41d7-413a-a475-5574bbbe597e.png" alt="" loading="lazy"/></p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764904990655-635739b1-78ea-4d9c-b102-58f29333e330.png" alt="" loading="lazy"/></p>
<p>根据「快速访问」页签的提示，将 uri 中的 <code>{port}</code> 替换为 7860 即可（llama-factory 默认使用 7860 端口）。直接使用该 uri 在浏览器进行访问，进入 llama-factory 的 webui 界面。</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764311896481-61d3a02e-bc06-4376-b7e9-6d1ea0ba451f.png" alt="" loading="lazy"/></p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764311983575-ac8fe220-6ffb-4c1a-a4cc-b63f3a1421ae.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">三、实战 SFT：像 P 图一样简单地微调模型</h3>
<p>打开 WebUI 界面，你会发现微调大模型并不比使用 Photoshop 复杂多少。我们不需要敲一行 Python 代码，只需在面板上进行“勾选”和“填空”。</p>
<p><strong>Step 1：模型与数据准备</strong></p>
<ul>
<li><strong>模型名称</strong>： 在下拉菜单中选择 <code>Qwen2-VL</code>（或手动输入模型路径）。</li>
<li><strong>数据集</strong>： Llama-Factory 支持标准的 Alpaca 格式或 ShareGPT 格式。对于多模态任务，确保你的 JSON 文件中包含图片路径。
<ul>
<li>操作： 在 WebUI 的“数据集”选项中选择准备好的数据集，本文的数据集路径如图所示：</li>
</ul>
</li>
</ul>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764906712487-485f0c15-df14-4ef3-b93a-a967d71b9232.png" alt="" loading="lazy"/></p>
<p><strong>Step 2：参数配置（LoRA大法好）</strong>
为了在 Serverless 环境下高效微调，我们采用 <strong>LoRA (Low-Rank Adaptation)</strong> 技术。它只训练模型的一小部分参数，却能达到惊人的效果。</p>
<ul>
<li><strong>微调方法</strong>： 勾选 <code>full</code>。</li>
<li><strong>学习率 (Learning Rate)</strong>： 推荐 <code>1e-4</code> 或 <code>5e-5</code>。</li>
<li><strong>轮数 (Epochs)</strong>： 建议先设为 <code>3</code> 或 <code>5</code> 轮，快速验证效果。</li>
</ul>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764919107775-84667310-a6a8-486b-81ce-3918aed478f6.png" alt="" loading="lazy"/></p>
<p><strong>Step 3：启动训练与监控</strong>
一切就绪，点击鲜艳的 <strong>“开始训练”</strong> 按钮。 界面下方会自动弹出日志窗口和 Loss（损失）曲线图。看着 Loss 曲线像滑梯一样稳步下降，代表模型正在努力学习你教给它的新知识。</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764907126625-4da053fa-0abb-4632-851b-9b245f8d8cdf.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">四、效果验证与模型导出：见证“专家”诞生</h3>
<p>看着 Loss 曲线收敛只是第一步，真正的考验在于：它真的变聪明了吗？Llama-Factory 贴心地集成了评估与推理模块，让我们能即时验收成果。</p>
<p><strong>Step 1：Chat 页签在线推理</strong>
训练完成后，无需重启服务，直接点击 WebUI 顶部的 <strong>“Chat”</strong> 页签。</p>
<ul>
<li><strong>检查点选择</strong>： 在 <code>Checkpoint</code> 下拉框中，选择刚才训练好的 Adapter 权重。</li>
<li><strong>加载模型</strong>： 点击“加载模型”，几秒钟后，右下角显示“模型加载成功”。</li>
</ul>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764920037265-e11f655b-19bb-4c0b-b062-1aaa7ac37219.png" alt="" loading="lazy"/></p>
<p><strong>Step 2：微调前后效果“大比武”</strong>
为了验证效果，我们上传一张特定业务场景的图片（例如一张复杂的报销单据），并输入同样的 Prompt：“请提取图中的关键信息”。</p>
<p>微调前：</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764920105262-a2df3466-1da2-4c75-bd35-94a92e6b7a18.png" alt="" loading="lazy"/></p>
<p>微调后：</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764920206458-2348ce56-3383-4031-98f3-72df874dcd98.png" alt="" loading="lazy"/></p>
<p>这就是 SFT 的魔力——让通用的天才变成垂直领域的专家。</p>
<p><strong>Step 3：模型导出与落地</strong>
验证满意后，点击 <strong>“Export”</strong> 页签。</p>
<ul>
<li><strong>最大分块大小</strong>： 建议设置为 <code>2GB</code> 或 <code>4GB</code>。</li>
<li><strong>导出目录</strong>： 指向你的 OSS 路径或者本地路径。 点击“开始导出”，Llama-Factory 会自动将 LoRA 权重与原始模型合并。现在，你拥有了一个完整的、可直接部署到生产环境的专属 Qwen2-VL 模型。</li>
</ul>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764920371970-d03c2468-f7a6-4833-9b3f-9bdb39ba79ed.png" alt="" loading="lazy"/></p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/324184/1764920434175-366c54db-dead-4267-9a98-f9e2fc2afe39.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">五、结语：Serverless AI，让创新触手可及</h3>
<p>至此，我们只用了一杯咖啡的时间，就完成了从环境搭建、模型微调到效果验证的全流程。</p>
<p><strong>最后，让我们算一笔账</strong>： 如果你为了这次实验去租赁一台 L20 服务器，通常需要按月付费，成本可能高达数千元，且大部分时间显卡都在空转。 而在阿里云函数计算（FC）上，你只需要为训练的那 <strong>2 小时</strong> 付费。<strong>按量付费，用完即走，成本可能不到一杯奶茶钱。</strong></p>
<p><strong>Serverless GPU 的核心价值，不仅仅是省钱，更是“解放”。</strong> 它把开发者从繁琐的运维泥潭中解放出来，不再需要担心 CUDA 版本、显存溢出或资源闲置。你只需要关注最核心的资产——<strong>数据</strong>与<strong>创意</strong>。</p>
<p>多模态的时代已经到来，Qwen2-VL 的大门已经敞开。 现在，轮到你了。</p>
<h2 data-id="heading-8">了解函数计算模型服务 FunModel</h2>
<p>FunModel 是一个面向 AI 模型开发、部署与运维的全生命周期管理平台。您只需提供模型文件（例如来自 ModelScope、Hugging Face 等社区的模型仓库），即可利用 FunModel 的自动化工具快速完成模型服务的封装与部署，并获得可直接调用的推理 API。平台在设计上旨在提升资源使用效率并简化开发部署流程。</p>
<p>FunModel 依托 Serverless + GPU，天然提供了简单，轻量，0 门槛的模型集成方案，给个人开发者良好的玩转模型的体验，也让企业级开发者快速高效的部署、运维和迭代模型。</p>
<p>在阿里云 FunModel 平台，开发者可以做到：</p>
<ul>
<li><strong>模型的快速部署上线</strong>：从原来的以周为单位的模型接入周期降低到 5 分钟，0 开发，无排期</li>
<li><strong>一键扩缩容，让运维不再是负担</strong>：多种扩缩容策略高度适配业务流量，实现“无痛运维”</li>
</ul>
<p><strong>技术优势</strong></p>






























<table><thead><tr><th align="left">特性</th><th align="left">FunModel 实现机制</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">资源利用率</td><td align="left">采用 GPU 虚拟化与资源池化技术。</td><td align="left">该设计允许多个任务共享底层硬件资源，旨在提高计算资源的整体使用效率。</td></tr><tr><td align="left">实例就绪时间</td><td align="left">基于快照技术的状态恢复机制。</td><td align="left">实例启动时，可通过快照在毫秒级别恢复运行状态，从而将实例从创建到就绪的时间控制在秒级。</td></tr><tr><td align="left">弹性扩容响应</td><td align="left">结合预热资源池与快速实例恢复能力。</td><td align="left">当负载增加时，系统可以从预热资源池中快速调度并启动新实例，实现秒级的水平扩展响应。</td></tr><tr><td align="left">自动化部署耗时</td><td align="left">提供可一键触发的构建与部署流程。</td><td align="left">一次标准的部署流程（从代码提交到服务上线）通常可在 10 分钟内完成。</td></tr></tbody></table>
<h3 data-id="heading-9">更多内容请参考</h3>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Ffunctioncompute%2Ffc%2Fmodel-service-funmodel%2F" target="_blank" title="https://help.aliyun.com/zh/functioncompute/fc/model-service-funmodel/" ref="nofollow noopener noreferrer">模型服务FunModel 产品文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Ffunctioncompute%2Ffc%2Fquick-start" target="_blank" title="https://help.aliyun.com/zh/functioncompute/fc/quick-start" ref="nofollow noopener noreferrer">FunModel快速入门</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Ffunctioncompute%2Ffc%2Fcustom-model-deployment" target="_blank" title="https://help.aliyun.com/zh/functioncompute/fc/custom-model-deployment" ref="nofollow noopener noreferrer">FunModel 自定义部署</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffcnext.console.aliyun.com%2Ffun-model%2Fcn-hangzhou%2Ffun-model%2Fmodel-market" target="_blank" title="https://fcnext.console.aliyun.com/fun-model/cn-hangzhou/fun-model/model-market" ref="nofollow noopener noreferrer">FunModel 模型广场</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[单链表与双链表专题详解]]></title>    <link>https://juejin.cn/post/7581689310643060778</link>    <guid>https://juejin.cn/post/7581689310643060778</guid>    <pubDate>2025-12-09T10:19:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581689310643060778" data-draft-id="7581676787379666963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="单链表与双链表专题详解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-09T10:19:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            单链表与双链表专题详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T10:19:33.000Z" title="Tue Dec 09 2025 10:19:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>链表是<strong>线性数据结构</strong>，但与数组有本质区别。数组是连续的内存空间，支持随机访问；链表则是<strong>离散的内存节点通过指针连接</strong>，只支持顺序访问。理解链表的核心在于掌握<strong>指针操作</strong>和<strong>节点关系管理</strong>。</p>
<h2 data-id="heading-0">一、单链表基础：节点结构与创建</h2>
<h3 data-id="heading-1">1.1 单链表节点结构</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ListNode</span> {
    <span class="hljs-type">int</span> val;         <span class="hljs-comment">// 节点值</span>
    ListNode* next;  <span class="hljs-comment">// 指向下一个节点的指针</span>
    
    <span class="hljs-built_in">ListNode</span>(<span class="hljs-type">int</span> x) : <span class="hljs-built_in">val</span>(x), <span class="hljs-built_in">next</span>(<span class="hljs-literal">nullptr</span>) {}
};
</code></pre>
<p><strong>关键理解</strong>：</p>
<ul>
<li>每个节点包含两部分：数据域(val)和指针域(next)</li>
<li><code>next</code>指针指向下一个节点，形成链式结构</li>
<li>最后一个节点的<code>next</code>指向<code>nullptr</code>，表示链表结束</li>
</ul>
<h3 data-id="heading-2">1.2 创建链表的三种方法</h3>
<h4 data-id="heading-3">方法一：手动连接</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 创建三个节点</span>
ListNode* node1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ListNode</span>(<span class="hljs-number">1</span>);
ListNode* node2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ListNode</span>(<span class="hljs-number">2</span>);
ListNode* node3 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ListNode</span>(<span class="hljs-number">3</span>);

<span class="hljs-comment">// 手动连接</span>
node1-&gt;next = node2;
node2-&gt;next = node3;
<span class="hljs-comment">// node3-&gt;next 保持为 nullptr</span>
</code></pre>
<h4 data-id="heading-4">方法二：尾插法（最常用）</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">ListNode* <span class="hljs-title">createList</span><span class="hljs-params">(<span class="hljs-type">const</span> vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>{
    <span class="hljs-function">ListNode <span class="hljs-title">dummy</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;  <span class="hljs-comment">// 哑节点，简化边界处理</span>
    ListNode* tail = &amp;dummy;  <span class="hljs-comment">// 尾指针，始终指向最后一个节点</span>
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : nums) {
        tail-&gt;next = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ListNode</span>(num);
        tail = tail-&gt;next;  <span class="hljs-comment">// 移动尾指针</span>
    }
    
    <span class="hljs-keyword">return</span> dummy.next;  <span class="hljs-comment">// 返回真正的头节点</span>
}
</code></pre>
<p><strong>哑节点技巧</strong>：</p>
<ul>
<li>避免处理头节点的特殊情况</li>
<li>代码更简洁，逻辑更清晰</li>
<li>常用在链表操作中</li>
</ul>
<h4 data-id="heading-5">方法三：头插法（创建逆序链表）</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">ListNode* <span class="hljs-title">createReverseList</span><span class="hljs-params">(<span class="hljs-type">const</span> vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>{
    ListNode* head = <span class="hljs-literal">nullptr</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : nums) {
        ListNode* newNode = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ListNode</span>(num);
        newNode-&gt;next = head;  <span class="hljs-comment">// 新节点指向原头节点</span>
        head = newNode;        <span class="hljs-comment">// 更新头节点</span>
    }
    
    <span class="hljs-keyword">return</span> head;
}
</code></pre>
<h3 data-id="heading-6">1.3 遍历链表</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">printList</span><span class="hljs-params">(ListNode* head)</span> </span>{
    ListNode* curr = head;
    
    <span class="hljs-keyword">while</span> (curr) {
        cout &lt;&lt; curr-&gt;val;
        <span class="hljs-keyword">if</span> (curr-&gt;next) cout &lt;&lt; <span class="hljs-string">" -&gt; "</span>;
        curr = curr-&gt;next;
    }
    cout &lt;&lt; <span class="hljs-string">" -&gt; nullptr"</span> &lt;&lt; endl;
}
</code></pre>
<h2 data-id="heading-7">二、单链表核心操作：反转算法详解</h2>
<h3 data-id="heading-8">2.1 问题分析：为什么要反转链表？</h3>
<p>链表反转是<strong>最经典的链表问题</strong>，考察对指针操作的理解。反转意味着改变节点间的指向关系，将<code>a-&gt;b-&gt;c</code>变为<code>a&lt;-b&lt;-c</code>。</p>
<h3 data-id="heading-9">2.2 迭代反转法（三指针法）</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">ListNode* <span class="hljs-title">reverseIterative</span><span class="hljs-params">(ListNode* head)</span> </span>{
    ListNode* prev = <span class="hljs-literal">nullptr</span>;   <span class="hljs-comment">// 前一个节点，初始为nullptr</span>
    ListNode* curr = head;      <span class="hljs-comment">// 当前节点，从头节点开始</span>
    ListNode* next = <span class="hljs-literal">nullptr</span>;   <span class="hljs-comment">// 下一个节点，临时保存</span>
    
    <span class="hljs-keyword">while</span> (curr) {
        <span class="hljs-comment">// 步骤1：保存下一个节点（关键！）</span>
        next = curr-&gt;next;
        
        <span class="hljs-comment">// 步骤2：反转当前节点的指针</span>
        curr-&gt;next = prev;
        
        <span class="hljs-comment">// 步骤3：移动指针，准备下一次循环</span>
        prev = curr;  <span class="hljs-comment">// prev移动到当前节点</span>
        curr = next;  <span class="hljs-comment">// curr移动到下一个节点</span>
    }
    
    <span class="hljs-keyword">return</span> prev;  <span class="hljs-comment">// 循环结束时，prev指向原链表的尾节点，即新链表的头节点</span>
}
</code></pre>
<h4 data-id="heading-10">逐步分析（链表：1-&gt;2-&gt;3-&gt;nullptr）</h4>
<pre><code class="hljs language-ini" lang="ini">初始状态：
<span class="hljs-attr">prev</span> = nullptr
<span class="hljs-attr">curr</span> = <span class="hljs-number">1</span>
<span class="hljs-attr">next</span> = nullptr

第1次循环：
<span class="hljs-attr">next</span> = curr-&gt;next = <span class="hljs-number">2</span>        // 保存节点<span class="hljs-number">2</span>
curr-&gt;<span class="hljs-attr">next</span> = prev = nullptr  // <span class="hljs-number">1</span>-&gt;nullptr
<span class="hljs-attr">prev</span> = curr = <span class="hljs-number">1</span>              // prev指向<span class="hljs-number">1</span>
<span class="hljs-attr">curr</span> = next = <span class="hljs-number">2</span>              // curr指向<span class="hljs-number">2</span>
结果：nullptr &lt;- 1   2-&gt;3-&gt;nullptr

第2次循环：
<span class="hljs-attr">next</span> = curr-&gt;next = <span class="hljs-number">3</span>        // 保存节点<span class="hljs-number">3</span>
curr-&gt;<span class="hljs-attr">next</span> = prev = <span class="hljs-number">1</span>        // <span class="hljs-number">2</span>-&gt;<span class="hljs-number">1</span>
<span class="hljs-attr">prev</span> = curr = <span class="hljs-number">2</span>              // prev指向<span class="hljs-number">2</span>
<span class="hljs-attr">curr</span> = next = <span class="hljs-number">3</span>              // curr指向<span class="hljs-number">3</span>
结果：nullptr &lt;- 1 &lt;- 2   3-&gt;nullptr

第3次循环：
<span class="hljs-attr">next</span> = curr-&gt;next = nullptr  // 保存nullptr
curr-&gt;<span class="hljs-attr">next</span> = prev = <span class="hljs-number">2</span>        // <span class="hljs-number">3</span>-&gt;<span class="hljs-number">2</span>
<span class="hljs-attr">prev</span> = curr = <span class="hljs-number">3</span>              // prev指向<span class="hljs-number">3</span>
<span class="hljs-attr">curr</span> = next = nullptr        // curr指向nullptr，循环结束
结果：nullptr &lt;- 1 &lt;- 2 &lt;- 3

返回<span class="hljs-attr">prev</span> = <span class="hljs-number">3</span>，即新链表的头节点
</code></pre>
<h3 data-id="heading-11">2.3 为什么这个算法正确？</h3>
<ol>
<li><strong>保存next是必须的</strong>：一旦执行<code>curr-&gt;next = prev</code>，就丢失了原链表的下一个节点</li>
<li><strong>移动指针的顺序</strong>：必须先移动prev到curr，再移动curr到next</li>
<li><strong>终止条件</strong>：当curr为nullptr时，prev指向原链表的最后一个节点，即新链表的第一个节点</li>
</ol>
<h3 data-id="heading-12">2.4 递归反转法</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">ListNode* <span class="hljs-title">reverseRecursive</span><span class="hljs-params">(ListNode* head)</span> </span>{
    <span class="hljs-comment">// 递归终止条件：空链表或单个节点</span>
    <span class="hljs-keyword">if</span> (!head || !head-&gt;next) {
        <span class="hljs-keyword">return</span> head;
    }
    
    <span class="hljs-comment">// 递归反转剩余部分</span>
    ListNode* newHead = <span class="hljs-built_in">reverseRecursive</span>(head-&gt;next);
    
    <span class="hljs-comment">// 关键操作：让下一个节点指向自己</span>
    head-&gt;next-&gt;next = head;
    <span class="hljs-comment">// 断开自己的next指针（否则会成环）</span>
    head-&gt;next = <span class="hljs-literal">nullptr</span>;
    
    <span class="hljs-keyword">return</span> newHead;
}
</code></pre>
<h4 data-id="heading-13">递归深度分析（链表：1-&gt;2-&gt;3）</h4>
<pre><code class="hljs language-rust" lang="rust">调用栈：
<span class="hljs-title function_ invoke__">reverse</span>(<span class="hljs-number">1</span>)
  <span class="hljs-title function_ invoke__">reverse</span>(<span class="hljs-number">2</span>)
    <span class="hljs-title function_ invoke__">reverse</span>(<span class="hljs-number">3</span>) <span class="hljs-punctuation">-&gt;</span> 返回<span class="hljs-number">3</span>
    
<span class="hljs-title function_ invoke__">reverse</span>(<span class="hljs-number">2</span>)层：
  newHead = <span class="hljs-number">3</span>
  <span class="hljs-number">2</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-number">3</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-number">2</span>（形成环）
  <span class="hljs-number">2</span><span class="hljs-punctuation">-&gt;</span>next = nullptr
  返回<span class="hljs-number">3</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-number">2</span>
    
<span class="hljs-title function_ invoke__">reverse</span>(<span class="hljs-number">1</span>)层：
  newHead = <span class="hljs-number">3</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-number">2</span>
  <span class="hljs-number">1</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-number">2</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-number">1</span>（形成环）
  <span class="hljs-number">1</span><span class="hljs-punctuation">-&gt;</span>next = nullptr
  返回<span class="hljs-number">3</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-number">2</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-number">1</span>
</code></pre>
<h3 data-id="heading-14">2.5 使用栈辅助反转（理解用）</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">ListNode* <span class="hljs-title">reverseWithStack</span><span class="hljs-params">(ListNode* head)</span> </span>{
    <span class="hljs-keyword">if</span> (!head) <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
    
    stack&lt;ListNode*&gt; st;
    ListNode* curr = head;
    
    <span class="hljs-comment">// 所有节点入栈</span>
    <span class="hljs-keyword">while</span> (curr) {
        st.<span class="hljs-built_in">push</span>(curr);
        curr = curr-&gt;next;
    }
    
    <span class="hljs-comment">// 栈顶是原链表的尾节点，作为新链表的头</span>
    ListNode* newHead = st.<span class="hljs-built_in">top</span>();
    st.<span class="hljs-built_in">pop</span>();
    curr = newHead;
    
    <span class="hljs-comment">// 依次出栈并连接</span>
    <span class="hljs-keyword">while</span> (!st.<span class="hljs-built_in">empty</span>()) {
        curr-&gt;next = st.<span class="hljs-built_in">top</span>();
        st.<span class="hljs-built_in">pop</span>();
        curr = curr-&gt;next;
    }
    
    <span class="hljs-comment">// 关键：最后一个节点的next置空</span>
    curr-&gt;next = <span class="hljs-literal">nullptr</span>;
    
    <span class="hljs-keyword">return</span> newHead;
}
</code></pre>
<p><strong>缺点</strong>：需要O(n)额外空间，效率不如迭代法</p>
<h2 data-id="heading-15">三、双链表详解：双向关系管理</h2>
<h3 data-id="heading-16">3.1 双链表节点结构</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DListNode</span> {
    <span class="hljs-type">int</span> val;
    DListNode* prev;  <span class="hljs-comment">// 指向前一个节点</span>
    DListNode* next;  <span class="hljs-comment">// 指向后一个节点</span>
    
    <span class="hljs-built_in">DListNode</span>(<span class="hljs-type">int</span> x) : <span class="hljs-built_in">val</span>(x), <span class="hljs-built_in">prev</span>(<span class="hljs-literal">nullptr</span>), <span class="hljs-built_in">next</span>(<span class="hljs-literal">nullptr</span>) {}
};
</code></pre>
<p><strong>与单链表的区别</strong>：</p>
<ul>
<li>多了一个<code>prev</code>指针，指向前驱节点</li>
<li>可以双向遍历：从头到尾或从尾到头</li>
<li>删除操作更简单（不需要找到前驱节点）</li>
</ul>
<h3 data-id="heading-17">3.2 双链表的优势与代价</h3>
<p><strong>优势</strong>：</p>
<ol>
<li>双向遍历：可以从任意节点向前或向后遍历</li>
<li>删除操作简单：不需要寻找前驱节点</li>
<li>某些操作更高效：如删除尾节点只需O(1)</li>
</ol>
<p><strong>代价</strong>：</p>
<ol>
<li>每个节点多一个指针，内存占用增加</li>
<li>插入/删除时需要维护两个指针，代码稍复杂</li>
<li>需要更多的指针操作，容易出错</li>
</ol>
<h3 data-id="heading-18">3.3 双链表插入操作</h3>
<h4 data-id="heading-19">在头部插入</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">insertAtHead</span><span class="hljs-params">(DListNode*&amp; head, DListNode*&amp; tail, <span class="hljs-type">int</span> val)</span> </span>{
    DListNode* newNode = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DListNode</span>(val);
    
    <span class="hljs-keyword">if</span> (!head) {  <span class="hljs-comment">// 空链表</span>
        head = tail = newNode;
    } <span class="hljs-keyword">else</span> {
        newNode-&gt;next = head;
        head-&gt;prev = newNode;
        head = newNode;
    }
}
</code></pre>
<h4 data-id="heading-20">在尾部插入</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">insertAtTail</span><span class="hljs-params">(DListNode*&amp; head, DListNode*&amp; tail, <span class="hljs-type">int</span> val)</span> </span>{
    DListNode* newNode = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DListNode</span>(val);
    
    <span class="hljs-keyword">if</span> (!tail) {  <span class="hljs-comment">// 空链表</span>
        head = tail = newNode;
    } <span class="hljs-keyword">else</span> {
        tail-&gt;next = newNode;
        newNode-&gt;prev = tail;
        tail = newNode;
    }
}
</code></pre>
<h4 data-id="heading-21">在指定节点后插入</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">insertAfter</span><span class="hljs-params">(DListNode* node, <span class="hljs-type">int</span> val)</span> </span>{
    <span class="hljs-keyword">if</span> (!node) <span class="hljs-keyword">return</span>;
    
    DListNode* newNode = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DListNode</span>(val);
    
    <span class="hljs-comment">// 连接新节点与后继节点</span>
    newNode-&gt;next = node-&gt;next;
    <span class="hljs-keyword">if</span> (node-&gt;next) {
        node-&gt;next-&gt;prev = newNode;
    }
    
    <span class="hljs-comment">// 连接新节点与前驱节点</span>
    newNode-&gt;prev = node;
    node-&gt;next = newNode;
}
</code></pre>
<h3 data-id="heading-22">3.4 双链表删除操作（重点）</h3>
<h4 data-id="heading-23">删除节点的三种情况</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">deleteNode</span><span class="hljs-params">(DListNode*&amp; head, DListNode*&amp; tail, DListNode* target)</span> </span>{
    <span class="hljs-keyword">if</span> (!head || !target) <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 边界检查</span>
    
    <span class="hljs-comment">// 情况1：删除头节点</span>
    <span class="hljs-keyword">if</span> (target == head) {
        head = head-&gt;next;        <span class="hljs-comment">// 头指针后移</span>
        <span class="hljs-keyword">if</span> (head) {
            head-&gt;prev = <span class="hljs-literal">nullptr</span>; <span class="hljs-comment">// 新头节点的prev置空</span>
        } <span class="hljs-keyword">else</span> {
            tail = <span class="hljs-literal">nullptr</span>;       <span class="hljs-comment">// 链表变空，尾指针也置空</span>
        }
    }
    <span class="hljs-comment">// 情况2：删除尾节点</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (target == tail) {
        tail = tail-&gt;prev;        <span class="hljs-comment">// 尾指针前移</span>
        <span class="hljs-keyword">if</span> (tail) {
            tail-&gt;next = <span class="hljs-literal">nullptr</span>; <span class="hljs-comment">// 新尾节点的next置空</span>
        } <span class="hljs-keyword">else</span> {
            head = <span class="hljs-literal">nullptr</span>;       <span class="hljs-comment">// 链表变空，头指针也置空</span>
        }
    }
    <span class="hljs-comment">// 情况3：删除中间节点</span>
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 跳过要删除的节点</span>
        target-&gt;prev-&gt;next = target-&gt;next;
        target-&gt;next-&gt;prev = target-&gt;prev;
    }
    
    <span class="hljs-keyword">delete</span> target;  <span class="hljs-comment">// 释放内存</span>
}
</code></pre>
<h4 data-id="heading-24">图解删除过程</h4>
<pre><code class="hljs language-css" lang="css">删除中间节点<span class="hljs-selector-tag">B</span>：<span class="hljs-selector-tag">A</span> &lt;-&gt; <span class="hljs-selector-tag">B</span> &lt;-&gt; C

步骤<span class="hljs-number">1</span>：<span class="hljs-selector-tag">A</span>-&gt;next = C
<span class="hljs-selector-tag">A</span> &lt;-&gt; C  <span class="hljs-selector-tag">B</span> &lt;-&gt; C

步骤<span class="hljs-number">2</span>：C-&gt;prev = <span class="hljs-selector-tag">A</span>
<span class="hljs-selector-tag">A</span> &lt;-&gt; C  <span class="hljs-selector-tag">B</span>孤立

步骤<span class="hljs-number">3</span>：delete <span class="hljs-selector-tag">B</span>
<span class="hljs-selector-tag">A</span> &lt;-&gt; C
</code></pre>
<h4 data-id="heading-25">删除操作的注意事项</h4>
<ol>
<li>
<p><strong>更新相邻节点的指针</strong>：</p>
<ul>
<li>前驱节点的next指向后继节点</li>
<li>后继节点的prev指向前驱节点</li>
</ul>
</li>
<li>
<p><strong>处理边界情况</strong>：</p>
<ul>
<li>删除头节点：更新head指针</li>
<li>删除尾节点：更新tail指针</li>
<li>删除唯一节点：head和tail都置空</li>
</ul>
</li>
<li>
<p><strong>内存管理</strong>：记得delete释放内存</p>
</li>
</ol>
<h3 data-id="heading-26">3.5 按值删除</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">deleteByValue</span><span class="hljs-params">(DListNode*&amp; head, DListNode*&amp; tail, <span class="hljs-type">int</span> val)</span> </span>{
    DListNode* curr = head;
    
    <span class="hljs-keyword">while</span> (curr) {
        <span class="hljs-keyword">if</span> (curr-&gt;val == val) {
            DListNode* toDelete = curr;
            curr = curr-&gt;next;  <span class="hljs-comment">// 先移动到下一个节点</span>
            
            <span class="hljs-built_in">deleteNode</span>(head, tail, toDelete);
        } <span class="hljs-keyword">else</span> {
            curr = curr-&gt;next;
        }
    }
}
</code></pre>
<p><strong>关键点</strong>：在删除节点前，先保存下一个节点，否则删除后无法继续遍历。</p>
<h2 data-id="heading-27">四、链表排序：归并排序的实现</h2>
<h3 data-id="heading-28">4.1 为什么链表排序用归并？</h3>
<p>链表与数组不同：</p>
<ol>
<li><strong>不支持随机访问</strong>：不能像数组那样用下标直接访问任意元素</li>
<li><strong>移动元素代价低</strong>：只需修改指针，不需要复制数据</li>
<li><strong>归并排序特点</strong>：适合顺序访问的数据结构</li>
</ol>
<h3 data-id="heading-29">4.2 归并排序的完整实现</h3>
<h4 data-id="heading-30">步骤1：找到中间节点（快慢指针）</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">ListNode* <span class="hljs-title">getMiddle</span><span class="hljs-params">(ListNode* head)</span> </span>{
    <span class="hljs-keyword">if</span> (!head) <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
    
    ListNode* slow = head;
    ListNode* fast = head-&gt;next;  <span class="hljs-comment">// fast从head-&gt;next开始</span>
    
    <span class="hljs-comment">// fast走两步，slow走一步</span>
    <span class="hljs-keyword">while</span> (fast &amp;&amp; fast-&gt;next) {
        slow = slow-&gt;next;
        fast = fast-&gt;next-&gt;next;
    }
    
    <span class="hljs-keyword">return</span> slow;  <span class="hljs-comment">// slow指向中间节点</span>
}
</code></pre>
<p><strong>为什么fast从head-&gt;next开始？</strong></p>
<ul>
<li>对于偶数个节点：1-&gt;2-&gt;3-&gt;4</li>
<li>fast从head开始：slow指向3（第二个中间节点）</li>
<li>fast从head-&gt;next开始：slow指向2（第一个中间节点）</li>
<li>我们通常希望分割得尽量均匀</li>
</ul>
<h4 data-id="heading-31">步骤2：递归排序</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">ListNode* <span class="hljs-title">mergeSort</span><span class="hljs-params">(ListNode* head)</span> </span>{
    <span class="hljs-comment">// 递归终止条件：空链表或单个节点</span>
    <span class="hljs-keyword">if</span> (!head || !head-&gt;next) <span class="hljs-keyword">return</span> head;
    
    <span class="hljs-comment">// 1. 找到中间节点并分割</span>
    ListNode* mid = <span class="hljs-built_in">getMiddle</span>(head);
    ListNode* right = mid-&gt;next;
    mid-&gt;next = <span class="hljs-literal">nullptr</span>;  <span class="hljs-comment">// 关键：切断链表</span>
    
    <span class="hljs-comment">// 2. 递归排序左右两部分</span>
    ListNode* leftSorted = <span class="hljs-built_in">mergeSort</span>(head);
    ListNode* rightSorted = <span class="hljs-built_in">mergeSort</span>(right);
    
    <span class="hljs-comment">// 3. 合并两个有序链表</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">merge</span>(leftSorted, rightSorted);
}
</code></pre>
<h4 data-id="heading-32">步骤3：合并有序链表</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">ListNode* <span class="hljs-title">merge</span><span class="hljs-params">(ListNode* l1, ListNode* l2)</span> </span>{
    <span class="hljs-function">ListNode <span class="hljs-title">dummy</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;  <span class="hljs-comment">// 哑节点，简化操作</span>
    ListNode* tail = &amp;dummy;
    
    <span class="hljs-comment">// 比较两个链表的头节点，选择较小的</span>
    <span class="hljs-keyword">while</span> (l1 &amp;&amp; l2) {
        <span class="hljs-keyword">if</span> (l1-&gt;val &lt; l2-&gt;val) {
            tail-&gt;next = l1;
            l1 = l1-&gt;next;
        } <span class="hljs-keyword">else</span> {
            tail-&gt;next = l2;
            l2 = l2-&gt;next;
        }
        tail = tail-&gt;next;
    }
    
    <span class="hljs-comment">// 连接剩余部分</span>
    tail-&gt;next = l1 ? l1 : l2;
    
    <span class="hljs-keyword">return</span> dummy.next;
}
</code></pre>
<h3 data-id="heading-33">4.3 时间复杂度分析</h3>
<ol>
<li>
<p><strong>分割阶段</strong>：</p>
<ul>
<li>每次分割需要找到中间节点：O(n)</li>
<li>共分割log₂n次</li>
<li>总分割时间：O(n log n)</li>
</ul>
</li>
<li>
<p><strong>合并阶段</strong>：</p>
<ul>
<li>每次合并需要遍历所有节点：O(n)</li>
<li>共合并log₂n次</li>
<li>总合并时间：O(n log n)</li>
</ul>
</li>
</ol>
<p><strong>总时间复杂度</strong>：O(n log n)</p>
<p><strong>空间复杂度</strong>：</p>
<ul>
<li>递归栈深度：O(log n)</li>
<li>不需要额外数组：O(1)额外空间</li>
</ul>
<h3 data-id="heading-34">4.4 归并排序的变种：自底向上</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">ListNode* <span class="hljs-title">mergeSortBottomUp</span><span class="hljs-params">(ListNode* head)</span> </span>{
    <span class="hljs-keyword">if</span> (!head || !head-&gt;next) <span class="hljs-keyword">return</span> head;
    
    <span class="hljs-comment">// 1. 计算链表长度</span>
    <span class="hljs-type">int</span> length = <span class="hljs-number">0</span>;
    ListNode* curr = head;
    <span class="hljs-keyword">while</span> (curr) {
        length++;
        curr = curr-&gt;next;
    }
    
    <span class="hljs-function">ListNode <span class="hljs-title">dummy</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;
    dummy.next = head;
    
    <span class="hljs-comment">// 2. 从1开始，每次合并相邻的子链表</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> step = <span class="hljs-number">1</span>; step &lt; length; step *= <span class="hljs-number">2</span>) {
        ListNode* prev = &amp;dummy;
        ListNode* curr = dummy.next;
        
        <span class="hljs-keyword">while</span> (curr) {
            <span class="hljs-comment">// 获取第一个子链表</span>
            ListNode* left = curr;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; step &amp;&amp; curr-&gt;next; i++) {
                curr = curr-&gt;next;
            }
            
            <span class="hljs-comment">// 获取第二个子链表</span>
            ListNode* right = curr-&gt;next;
            curr-&gt;next = <span class="hljs-literal">nullptr</span>;  <span class="hljs-comment">// 断开第一个子链表</span>
            curr = right;
            
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; step &amp;&amp; curr &amp;&amp; curr-&gt;next; i++) {
                curr = curr-&gt;next;
            }
            
            <span class="hljs-comment">// 保存下一个子链表的起始位置</span>
            ListNode* next = <span class="hljs-literal">nullptr</span>;
            <span class="hljs-keyword">if</span> (curr) {
                next = curr-&gt;next;
                curr-&gt;next = <span class="hljs-literal">nullptr</span>;  <span class="hljs-comment">// 断开第二个子链表</span>
            }
            
            <span class="hljs-comment">// 合并两个子链表</span>
            ListNode* merged = <span class="hljs-built_in">merge</span>(left, right);
            
            <span class="hljs-comment">// 连接到已合并的部分</span>
            prev-&gt;next = merged;
            <span class="hljs-keyword">while</span> (prev-&gt;next) {
                prev = prev-&gt;next;
            }
            
            <span class="hljs-comment">// 继续处理剩余部分</span>
            curr = next;
        }
    }
    
    <span class="hljs-keyword">return</span> dummy.next;
}
</code></pre>
<p><strong>优点</strong>：避免递归，空间复杂度O(1)</p>
<h2 data-id="heading-35">五、链表常见问题与解决方案</h2>
<h3 data-id="heading-36">5.1 检测环（快慢指针）</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">hasCycle</span><span class="hljs-params">(ListNode* head)</span> </span>{
    <span class="hljs-keyword">if</span> (!head || !head-&gt;next) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    
    ListNode* slow = head;
    ListNode* fast = head;
    
    <span class="hljs-keyword">while</span> (fast &amp;&amp; fast-&gt;next) {
        slow = slow-&gt;next;        <span class="hljs-comment">// 慢指针走一步</span>
        fast = fast-&gt;next-&gt;next;  <span class="hljs-comment">// 快指针走两步</span>
        
        <span class="hljs-keyword">if</span> (slow == fast) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 相遇说明有环</span>
        }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 快指针到达nullptr，说明无环</span>
}
</code></pre>
<h3 data-id="heading-37">5.2 找到环的入口</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">ListNode* <span class="hljs-title">detectCycle</span><span class="hljs-params">(ListNode* head)</span> </span>{
    <span class="hljs-keyword">if</span> (!head || !head-&gt;next) <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
    
    ListNode* slow = head;
    ListNode* fast = head;
    <span class="hljs-type">bool</span> hasCycle = <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// 第一步：判断是否有环</span>
    <span class="hljs-keyword">while</span> (fast &amp;&amp; fast-&gt;next) {
        slow = slow-&gt;next;
        fast = fast-&gt;next-&gt;next;
        
        <span class="hljs-keyword">if</span> (slow == fast) {
            hasCycle = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">break</span>;
        }
    }
    
    <span class="hljs-keyword">if</span> (!hasCycle) <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
    
    <span class="hljs-comment">// 第二步：找到环的入口</span>
    slow = head;
    <span class="hljs-keyword">while</span> (slow != fast) {
        slow = slow-&gt;next;
        fast = fast-&gt;next;
    }
    
    <span class="hljs-keyword">return</span> slow;
}
</code></pre>
<p><strong>原理</strong>（Floyd判圈算法）：</p>
<ol>
<li>设头节点到环入口距离为a，环长度为b</li>
<li>第一次相遇时，慢指针走了a + x，快指针走了a + x + nb</li>
<li>由快指针速度是慢指针两倍：2(a + x) = a + x + nb</li>
<li>得到：a = (n-1)b + (b - x)</li>
<li>让一个指针从head开始，一个从相遇点开始，每次走一步，相遇点就是环入口</li>
</ol>
<h3 data-id="heading-38">5.3 找到倒数第k个节点</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">ListNode* <span class="hljs-title">findKthFromEnd</span><span class="hljs-params">(ListNode* head, <span class="hljs-type">int</span> k)</span> </span>{
    <span class="hljs-keyword">if</span> (!head || k &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
    
    ListNode* fast = head;
    ListNode* slow = head;
    
    <span class="hljs-comment">// fast先走k步</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; k; i++) {
        <span class="hljs-keyword">if</span> (!fast) <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;  <span class="hljs-comment">// k大于链表长度</span>
        fast = fast-&gt;next;
    }
    
    <span class="hljs-comment">// fast和slow一起走</span>
    <span class="hljs-keyword">while</span> (fast) {
        slow = slow-&gt;next;
        fast = fast-&gt;next;
    }
    
    <span class="hljs-keyword">return</span> slow;
}
</code></pre>
<h3 data-id="heading-39">5.4 删除重复节点</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 删除排序链表中的重复元素</span>
<span class="hljs-function">ListNode* <span class="hljs-title">deleteDuplicates</span><span class="hljs-params">(ListNode* head)</span> </span>{
    <span class="hljs-keyword">if</span> (!head) <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
    
    ListNode* curr = head;
    
    <span class="hljs-keyword">while</span> (curr &amp;&amp; curr-&gt;next) {
        <span class="hljs-keyword">if</span> (curr-&gt;val == curr-&gt;next-&gt;val) {
            ListNode* toDelete = curr-&gt;next;
            curr-&gt;next = curr-&gt;next-&gt;next;
            <span class="hljs-keyword">delete</span> toDelete;
        } <span class="hljs-keyword">else</span> {
            curr = curr-&gt;next;
        }
    }
    
    <span class="hljs-keyword">return</span> head;
}
</code></pre>
<h2 data-id="heading-40">六、链表操作的常见错误</h2>
<h3 data-id="heading-41">6.1 指针未初始化</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 错误</span>
ListNode* ptr;
cout &lt;&lt; ptr-&gt;val;  <span class="hljs-comment">// 访问随机内存，段错误</span>

<span class="hljs-comment">// 正确</span>
ListNode* ptr = <span class="hljs-literal">nullptr</span>;  <span class="hljs-comment">// 或 = new ListNode(0)</span>
</code></pre>
<h3 data-id="heading-42">6.2 访问已释放的内存</h3>
<pre><code class="hljs language-cpp" lang="cpp">ListNode* node = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ListNode</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">delete</span> node;
cout &lt;&lt; node-&gt;val;  <span class="hljs-comment">// 错误：访问已释放的内存</span>
</code></pre>
<h3 data-id="heading-43">6.3 忘记断开连接（形成环）</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 反转链表时忘记断开原连接</span>
ListNode* newHead = <span class="hljs-built_in">reverse</span>(head);
<span class="hljs-comment">// 如果原链表没有正确断开，可能形成环</span>
</code></pre>
<h3 data-id="heading-44">6.4 丢失头指针</h3>
<pre><code class="hljs language-cpp" lang="cpp">ListNode* head = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ListNode</span>(<span class="hljs-number">1</span>);
head = head-&gt;next;  <span class="hljs-comment">// 丢失了原头节点，内存泄漏</span>
</code></pre>
<h2 data-id="heading-45">七、链表与数组的对比</h2>








































<table><thead><tr><th>特性</th><th>数组</th><th>链表</th></tr></thead><tbody><tr><td><strong>内存分配</strong></td><td>连续</td><td>离散</td></tr><tr><td><strong>访问方式</strong></td><td>随机访问</td><td>顺序访问</td></tr><tr><td><strong>访问时间</strong></td><td>O(1)</td><td>O(n)</td></tr><tr><td><strong>插入/删除</strong></td><td>O(n)</td><td>O(1)（已知位置）</td></tr><tr><td><strong>内存使用</strong></td><td>固定大小</td><td>动态增长</td></tr><tr><td><strong>缓存友好</strong></td><td>是</td><td>否</td></tr></tbody></table>
<p><strong>选择原则</strong>：</p>
<ul>
<li>需要快速随机访问 → 数组</li>
<li>需要频繁插入/删除 → 链表</li>
<li>内存使用不确定 → 链表</li>
<li>需要缓存友好 → 数组</li>
</ul>
<p>链表操作的核心是<strong>理解指针关系</strong>和<strong>管理内存生命周期</strong>。掌握链表的基础操作后，复杂问题往往是这些基础操作的组合。多练习、多思考，才能真正掌握链表的精髓。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis集群架构详解：从单机到分布式的扩展之路]]></title>    <link>https://juejin.cn/post/7580564126403248178</link>    <guid>https://juejin.cn/post/7580564126403248178</guid>    <pubDate>2025-12-08T01:11:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580564126403248178" data-draft-id="7490815158190129178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis集群架构详解：从单机到分布式的扩展之路"/> <meta itemprop="keywords" content="Redis,数据库,性能优化"/> <meta itemprop="datePublished" content="2025-12-08T01:11:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Go高并发架构_王工"/> <meta itemprop="url" content="https://juejin.cn/user/446863555701561"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis集群架构详解：从单机到分布式的扩展之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/446863555701561/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Go高并发架构_王工
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T01:11:13.000Z" title="Mon Dec 08 2025 01:11:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引言</h2>
<p>Redis，这个名字对于许多开发者来说并不陌生。作为一款高性能的内存数据库，它以低延迟和极简设计赢得了无数开发者的青睐。然而，随着业务规模的增长，单机Redis的局限性逐渐暴露，分布式集群架构应运而生。这篇文章的目标读者是有1-2年Redis开发经验的开发者——你可能已经熟练掌握了<code>SET</code>、<code>GET</code>这些基础命令，也在单机环境下优化过性能，但对于如何将Redis从单机扩展到分布式集群，或许还感到有些迷雾重重。</p>
<p>从单机到分布式的演进，不仅仅是一个技术升级的过程，更是为解决实际业务痛点而生的必然选择。想象一下，单机Redis就像一辆跑车，速度快、操控灵活，但装载能力有限；而集群架构则像一支车队，虽然调度复杂，却能承载更多货物，跑得更远。Redis从最初的单机模式，到支持主从复制、哨兵机制，再到如今的Redis Cluster，每一步都在解决容量、性能和高可用性的难题。那么，这条扩展之路究竟有哪些关键节点？我们又该如何在实践中驾驭它？</p>
<p>在这篇文章中，我将从单机Redis的局限性讲起，逐步剖析Redis集群的核心概念、搭建方法和优化实践。内容不仅基于官方文档和技术原理，更融入了我10年Redis开发经验中的真实案例。比如，我曾在一个电商项目中，面对秒杀流量激增导致单机Redis内存爆满的窘境，最终通过集群架构化险为夷。这些经验教训，将为你提供更接地气的参考。接下来，我们将一起探索Redis集群的奥秘，看看它如何从单兵作战进化到分布式协同的强大阵容。</p>
<hr/>
<h2 data-id="heading-1">2. 单机Redis的局限性与分布式需求</h2>
<h3 data-id="heading-2">单机Redis的优势与瓶颈</h3>
<p>Redis的单机模式之所以广受欢迎，离不开它的几个显著优势。首先是<strong>简单</strong>：无需复杂配置，安装后即可使用，开发者可以快速上手。其次是<strong>高性能</strong>：基于内存操作，单线程模型避免了上下文切换，读写延迟通常在微秒级别。最后是<strong>低延迟</strong>：所有数据都在内存中，响应速度远超磁盘数据库。</p>
<p>然而，天下没有完美的技术。单机Redis的瓶颈也同样明显。<strong>内存容量受限</strong>是首要问题——一台服务器的内存终究有限，当数据量超过物理上限时，你只能眼睁睁看着性能下降甚至宕机。<strong>单点故障</strong>是另一个隐患，一旦服务器宕机，服务就彻底不可用。此外，<strong>QPS上限</strong>也不容忽视，单线程模型虽然高效，但在高并发场景下，单机的处理能力迟早会触碰到天花板。</p>
<h3 data-id="heading-3">实际场景举例</h3>
<p>我曾在早期的一个电商秒杀项目中深刻体会到这些局限性。当时，我们用一台16GB内存的Redis实例存储商品库存和用户订单数据。秒杀开始后，瞬时流量激增，内存使用率迅速飙升到100%，紧接着Redis进程崩溃，服务直接瘫痪。事后分析发现，库存Key的频繁更新和订单数据的快速累积，让单机Redis不堪重负。这次事故让我意识到，单机模式在面对大规模、高并发场景时，实在是“独木难支”。</p>
<h3 data-id="heading-4">分布式需求驱动</h3>
<p>那么，什么样的需求推动了Redis向分布式演进呢？首先是<strong>数据量增长</strong>：业务发展带来用户和数据的指数级增加，单机内存已无法满足存储需求。其次是<strong>高可用性要求</strong>：现代应用对服务中断的容忍度极低，单点故障的风险必须被消除。最后是<strong>负载均衡的必要性</strong>：将请求分散到多个节点，既能提升整体吞吐量，又能避免单节点过载。</p>
<h3 data-id="heading-5">过渡到集群的意义</h3>
<p>从单机到分布式集群的转变，不仅仅是技术层面的升级，更是为业务保驾护航的关键一步。就像从独奏转向交响乐团，单机Redis擅长独当一面，而集群架构则通过协作释放更大的潜力。接下来，我们将深入探讨Redis Cluster的核心概念，看看它如何通过分布式设计解决这些痛点，并为系统扩展打开新的可能性。</p>
<hr/>
<h3 data-id="heading-6">示意图：单机Redis的瓶颈</h3>

























<table><thead><tr><th><strong>维度</strong></th><th><strong>单机Redis</strong></th><th><strong>潜在问题</strong></th></tr></thead><tbody><tr><td>内存容量</td><td>单机物理内存上限</td><td>数据量超限导致溢出或宕机</td></tr><tr><td>可用性</td><td>单点运行</td><td>宕机即服务不可用</td></tr><tr><td>性能</td><td>单线程QPS有限</td><td>高并发下响应变慢</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-7">过渡段</h3>
<p>单机Redis的局限性让我们看到了分布式架构的必要性，但如何实现这一跨越呢？Redis Cluster作为官方提供的分布式解决方案，以其独特的设计和强大的功能，成为了从单机迈向分布式的桥梁。接下来，我们将详细剖析它的核心概念和优势，看看它如何为开发者提供一个既灵活又可靠的工具箱。</p>
<hr/>
<h2 data-id="heading-8">3. Redis集群架构的核心概念与优势</h2>
<p>从单机Redis的局限性中走出来，Redis Cluster为我们打开了一扇通往分布式世界的大门。它不仅解决了容量和可用性的瓶颈，还带来了灵活扩展的能力。那么，Redis Cluster究竟是什么？它有哪些核心优势？又如何在实际项目中发挥作用？让我们一步步揭开它的面纱。</p>
<h3 data-id="heading-9">Redis Cluster简介</h3>
<p>Redis Cluster是Redis官方提供的分布式实现，首次亮相于Redis 3.0版本。它的核心思想是通过<strong>数据分片（Sharding）<strong>将数据分散到多个节点上，从而突破单机内存和性能的限制。Redis Cluster将整个数据空间划分为</strong>16384个槽（slot）</strong>，每个槽负责存储一部分键值对。每个节点则被分配若干槽，通过这种方式实现数据的分布式存储。</p>
<p>形象地说，Redis Cluster就像一个巨大的图书馆，16384个槽是书架上的格子，而每个节点则是负责管理一部分格子的管理员。客户端通过键的哈希值找到对应的槽，再定位到具体的节点完成操作。这种设计既简单又高效，避免了传统代理架构的复杂性。</p>
<h3 data-id="heading-10">核心优势</h3>
<p>Redis Cluster的魅力在于它带来的三大优势：</p>
<ol>
<li>
<p><strong>水平扩展</strong><br/>
单机Redis的容量和性能受限于硬件，而Redis Cluster通过添加节点就能轻松扩展。无论是数据量翻倍还是并发请求激增，只需加入新节点并重新分配槽，就能让系统“长大”。这就像给车队增加车辆，运力自然提升。</p>
</li>
<li>
<p><strong>高可用性</strong><br/>
Redis Cluster支持<strong>主从复制</strong>和<strong>故障转移</strong>。每个主节点可以配置一个或多个从节点，当主节点宕机时，从节点会自动接管。这种机制确保了即使部分节点失效，服务依然可用。</p>
</li>
<li>
<p><strong>去中心化设计</strong><br/>
与一些需要代理（Proxy）分发的分布式系统不同，Redis Cluster采用无代理架构，客户端直接与节点通信。这种设计减少了中间层开销，提升了性能，同时也降低了维护复杂度。</p>
</li>
</ol>
<h3 data-id="heading-11">与单机模式的对比</h3>
<p>为了更直观地理解Redis Cluster的价值，我们可以用下表对比单机模式和集群模式：</p>






























<table><thead><tr><th><strong>特性</strong></th><th><strong>单机Redis</strong></th><th><strong>Redis Cluster</strong></th></tr></thead><tbody><tr><td>数据存储</td><td>集中在一台机器</td><td>分片分布多个节点</td></tr><tr><td>容量扩展</td><td>受限于单机内存</td><td>可通过加节点无限扩展</td></tr><tr><td>可用性</td><td>单点故障即不可用</td><td>主从切换保障高可用</td></tr><tr><td>管理方式</td><td>简单集中式</td><td>分布式协同，稍复杂</td></tr></tbody></table>
<p>单机模式像独奏乐手，简单高效但能力有限；集群模式则像交响乐团，协作带来更大的舞台。</p>
<h3 data-id="heading-12">特色功能解析</h3>
<p>Redis Cluster不仅提供了基础的分片能力，还有一些特色功能值得关注：</p>
<ul>
<li>
<p><strong>动态扩缩容</strong><br/>
你可以在集群运行时添加或删除节点，槽会自动迁移到新节点或从旧节点移除。这种在线操作让扩容变得“丝滑”，无需停机。</p>
</li>
<li>
<p><strong>一致性哈希与槽迁移</strong><br/>
Redis Cluster使用哈希槽而非传统一致性哈希。键通过<code>CRC16(key) % 16384</code>计算槽位置，节点变更时只需迁移槽而非全部数据。这种设计在扩缩容时极大减少了数据搬迁成本。</p>
</li>
</ul>
<h3 data-id="heading-13">踩坑经验：槽分配不均的教训</h3>
<p>在实际项目中，我曾遇到过槽分配不均导致的热点问题。当时在一个实时排行榜系统中，初始集群只有3个节点，槽分配默认平均，但某些高频访问的键集中落在同一个节点，导致该节点负载过高，延迟飙升。<br/>
<strong>解决办法</strong>：通过<code>redis-cli --cluster check</code>检查槽分布，发现问题后手动执行<code>CLUSTER ADDSLOTS</code>重新分配槽。同时，我们引入了监控工具（如Prometheus+Grafana），实时跟踪每个节点的QPS和内存使用率，避免类似问题再次发生。<br/>
<strong>经验教训</strong>：集群初始化时，合理规划槽分配并结合业务特点预留冗余，能有效避免热点问题。</p>
<hr/>
<h3 data-id="heading-14">示意图：Redis Cluster数据分片机制</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[客户端]</span> --&gt; <span class="hljs-selector-attr">[Key: <span class="hljs-string">"user:123"</span>]</span> --&gt; <span class="hljs-selector-attr">[CRC16(<span class="hljs-string">"user:123"</span>) % 16384 = Slot 4567]</span>
   |                                    |
   v                                    v
<span class="hljs-selector-attr">[Node A: Slot 0-5460]</span>         <span class="hljs-selector-attr">[Node B: Slot 5461-10922]</span> --&gt; 处理请求
<span class="hljs-selector-attr">[Node C: Slot 10923-16383]</span>
</code></pre>
<p><strong>说明</strong>：客户端根据键计算槽号，定位到对应节点完成操作。</p>
<hr/>
<h3 data-id="heading-15">过渡段</h3>
<p>通过对Redis Cluster核心概念的剖析，我们不难发现，它以分片和高可用为基础，为分布式扩展铺平了道路。但光有理论还不够，如何在实践中搭建并驾驭这个“分布式车队”呢？下一节，我们将深入探讨Redis集群的搭建与配置，结合实际代码和经验，带你从零开始构建一个健壮的集群环境。</p>
<hr/>
<h2 data-id="heading-16">4. Redis集群的搭建与配置</h2>
<p>了解了Redis Cluster的核心概念和优势后，接下来我们要把理论转化为实践，亲手搭建一个属于自己的集群。Redis集群的搭建并不复杂，但细节决定成败。从环境准备到配置优化，每一步都需要用心。本节将带你一步步完成集群搭建，并分享我在实际项目中的经验教训，让你少走弯路。</p>
<h3 data-id="heading-17">环境准备</h3>
<p>在动手之前，先做好功课。Redis Cluster对版本有要求，建议使用<strong>Redis 5.0或以上</strong>，因为新版本在集群管理和稳定性上有了显著改进。硬件方面，至少需要3台服务器（或虚拟机）来模拟多节点环境，每台建议配置至少2GB内存和双核CPU。如果是测试环境，也可以在单机上通过不同端口模拟多个实例。</p>
<p>以我的经验为例，在一个中型项目中，我们为集群规划了6个节点（3主3从），每台服务器16GB内存，确保初期数据量和QPS需求都能轻松应对。这种规划为后续扩容留出了空间。</p>
<h3 data-id="heading-18">手动搭建集群步骤</h3>
<p>假设我们用单机多端口的方式搭建一个小型集群，包含3个主节点（端口7000-7002）。以下是具体步骤：</p>
<ol>
<li>
<p><strong>启动多个Redis实例</strong><br/>
为每个节点创建独立的配置文件（如<code>redis-7000.conf</code>），并启动实例：</p>
<pre><code class="hljs language-bash" lang="bash">redis-server redis-7000.conf
redis-server redis-7001.conf
redis-server redis-7002.conf
</code></pre>
</li>
<li>
<p><strong>使用redis-cli创建集群</strong><br/>
Redis提供了一个便捷的工具<code>redis-cli --cluster</code>，可以快速构建集群。执行以下命令：</p>
<pre><code class="hljs language-bash" lang="bash">redis-cli --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 --cluster-replicas 0
</code></pre>
<ul>
<li><strong>注释说明</strong>：
<ul>
<li><code>--cluster-replicas 0</code>：表示暂不配置从节点，仅搭建3个主节点。</li>
<li>命令执行后，系统会自动分配16384个槽，并提示确认分配方案，输入<code>yes</code>即可完成。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>验证集群状态</strong><br/>
检查集群是否正常运行：</p>
<pre><code class="hljs language-bash" lang="bash">redis-cli -p 7000 cluster info
</code></pre>
<p>输出中<code>cluster_state:ok</code>表示集群已就绪。</p>
</li>
</ol>
<h3 data-id="heading-19">配置文件详解</h3>
<p>Redis Cluster依赖几个关键配置参数，以下是<code>redis-7000.conf</code>的一个示例：</p>
<pre><code class="hljs language-conf" lang="conf">port 7000                # 节点监听端口
cluster-enabled yes      # 启用集群模式
cluster-config-file nodes-7000.conf  # 集群拓扑配置文件，自动生成
cluster-node-timeout 15000  # 节点间通信超时时间（毫秒）
</code></pre>
<ul>
<li><strong><code>cluster-enabled</code></strong>：必须设为<code>yes</code>，否则节点以单机模式运行。</li>
<li><strong><code>cluster-config-file</code></strong>：记录集群状态的文件，每次节点变更时自动更新。</li>
<li><strong><code>cluster-node-timeout</code></strong>：设置过短可能导致频繁误判节点故障，过长则影响故障转移速度，默认15000ms是个折中选择。</li>
</ul>
<h3 data-id="heading-20">最佳实践</h3>
<p>在实际项目中，集群搭建的成功不仅取决于技术实现，还需要一些规划和优化：</p>
<ul>
<li>
<p><strong>初始节点数规划</strong><br/>
我曾在一个社交平台项目中只部署了3个节点，结果不到半年就因数据量增长需要扩容。频繁扩容不仅麻烦，还可能引发槽迁移时的性能抖动。<strong>建议</strong>：根据业务规模预估未来6-12个月的需求，初始部署至少6个节点（3主3从）。</p>
</li>
<li>
<p><strong>工具辅助管理</strong><br/>
除了<code>redis-cli</code>，推荐使用RedisInsight这类可视化工具，可以直观查看槽分布和节点状态，提升运维效率。</p>
</li>
</ul>
<h3 data-id="heading-21">踩坑经验：未开启AOF的教训</h3>
<p>有一次在生产环境中，我忽略了AOF（Append Only File）的配置，默认只启用了RDB快照。结果一台主节点意外宕机重启后，丢失了最近几分钟的数据，导致用户订单状态异常。<br/>
<strong>解决办法</strong>：在集群配置文件中启用AOF（<code>appendonly yes</code>），并定期检查<code>appendfsync everysec</code>的同步策略，确保数据持久化。<br/>
<strong>经验教训</strong>：集群的高可用性不等于数据安全性，RDB和AOF要合理搭配使用。</p>
<hr/>
<h3 data-id="heading-22">示例代码：检查集群状态</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查集群基本信息</span>
redis-cli -p 7000 cluster info
<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># cluster_state:ok</span>
<span class="hljs-comment"># cluster_slots_assigned:16384</span>
<span class="hljs-comment"># cluster_known_nodes:3</span>

<span class="hljs-comment"># 查看槽分配详情</span>
redis-cli -p 7000 cluster slots
<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># 1) 1) (integer) 0</span>
<span class="hljs-comment">#    2) (integer) 5460</span>
<span class="hljs-comment">#    3) 1) "127.0.0.1"</span>
<span class="hljs-comment">#       2) (integer) 7000</span>
</code></pre>
<p><strong>注释</strong>：<code>cluster info</code>显示集群整体状态，<code>cluster slots</code>列出每个节点的槽范围。</p>
<hr/>
<h3 data-id="heading-23">示意图：Redis集群搭建架构</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[Node 7000: Slot 0-5460]</span>    <span class="hljs-selector-attr">[Node 7001: Slot 5461-10922]</span>    <span class="hljs-selector-attr">[Node 7002: Slot 10923-16383]</span>
         |                           |                             |
         +---------------------------+-----------------------------+
         |                 redis-cli <span class="hljs-attr">--cluster</span> create              |
         +---------------------------------------------------------+
                     <span class="hljs-selector-attr">[客户端直接访问任意节点]</span>
</code></pre>
<p><strong>说明</strong>：3个节点通过<code>redis-cli</code>连接为集群，槽自动分配。</p>
<hr/>
<h3 data-id="heading-24">过渡段</h3>
<p>通过以上步骤，一个基本的Redis集群已经搭建完成。但从单机到分布式的旅程远未结束，集群只是起点，如何平滑扩展并应对复杂场景才是真正的挑战。下一节，我们将探讨从单机到分布式的完整扩展路径，结合真实案例带你体验集群在项目中的实战应用。</p>
<hr/>
<h2 data-id="heading-25">5. 从单机到分布式的扩展实践</h2>
<p>搭建好Redis集群只是万里长征的第一步，如何从单机模式平滑过渡到分布式架构，并在实际项目中发挥其价值，才是开发者需要面对的真正考验。这一节，我将带你走一遍从单机到分布式的完整扩展路径，并结合两个真实项目案例，分享迁移步骤、优化方案和踩坑经验。希望这些实战内容能为你提供灵感。</p>
<h3 data-id="heading-26">扩展路径</h3>
<p>Redis的扩展并非一蹴而就，而是分阶段演进，每一步都针对特定需求：</p>
<ol>
<li>
<p><strong>单机到主从</strong><br/>
单机Redis性能有限时，第一步通常是配置主从复制。主节点负责写操作，从节点分担读请求，提升读性能。配置简单，只需在从节点配置文件中添加<code>replicaof &lt;master-ip&gt; &lt;master-port&gt;</code>。</p>
</li>
<li>
<p><strong>主从到哨兵（Sentinel）</strong><br/>
主从模式解决了读压力，但主节点宕机仍会导致服务中断。哨兵模式通过多个Sentinel进程监控节点状态，实现自动故障转移。配置哨兵只需指定主节点信息：</p>
<pre><code class="hljs language-conf" lang="conf">sentinel monitor mymaster 127.0.0.1 6379 2
</code></pre>
</li>
<li>
<p><strong>哨兵到集群</strong><br/>
当数据量和并发量进一步增长，哨兵模式仍受限于单主节点的容量。这时，Redis Cluster登场，通过分片解决容量瓶颈，同时保留高可用性。</p>
</li>
</ol>
<p><strong>路径示意图</strong>：</p>
<pre><code class="hljs language-css" lang="css">单机 --&gt; <span class="hljs-selector-attr">[主从复制]</span> --&gt; <span class="hljs-selector-attr">[哨兵高可用]</span> --&gt; <span class="hljs-selector-attr">[集群分布式]</span>
  |          |               |                 |
简单高效   读写分离       自动故障转移       容量与性能扩展
</code></pre>
<h3 data-id="heading-27">实际项目案例</h3>
<h4 data-id="heading-28">案例1：社交平台用户缓存迁移</h4>
<p>在一个社交平台项目中，我们最初使用单机Redis存储用户会话数据。随着用户量从10万增长到100万，单机内存告急，迁移到集群势在必行。<br/>
<strong>迁移步骤</strong>：</p>
<ol>
<li><strong>数据预分片</strong>：在新集群中预先分配槽，运行脚本将单机数据按键哈希分片导入。</li>
<li><strong>客户端切换</strong>：更新Java Jedis客户端为集群模式，逐步切换流量。<br/>
<strong>代码示例</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.HostAndPort;
<span class="hljs-keyword">import</span> redis.clients.jedis.JedisCluster;
<span class="hljs-keyword">import</span> java.util.HashSet;
<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JedisClusterExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Set&lt;HostAndPort&gt; nodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        nodes.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HostAndPort</span>(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">7000</span>));
        nodes.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HostAndPort</span>(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">7001</span>));
        nodes.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HostAndPort</span>(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">7002</span>));

        <span class="hljs-keyword">try</span> (<span class="hljs-type">JedisCluster</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisCluster</span>(nodes)) {
            jedis.set(<span class="hljs-string">"user:123"</span>, <span class="hljs-string">"session_data"</span>);
            System.out.println(<span class="hljs-string">"Get user:123: "</span> + jedis.get(<span class="hljs-string">"user:123"</span>));
        }
    }
}
</code></pre>
<ul>
<li><strong>注释</strong>：<code>JedisCluster</code>自动处理槽定位和重定向，开发者无需手动干预。<br/>
<strong>结果</strong>：迁移后，系统容量提升3倍，响应时间稳定在1ms以内。</li>
</ul>
<h4 data-id="heading-29">案例2：实时排行榜系统优化</h4>
<p>在一个游戏排行榜系统中，单机Redis因热点Key（如全局排行榜）频繁更新而性能下降。我们迁移到集群并优化热点问题。<br/>
<strong>优化方案</strong>：</p>
<ol>
<li><strong>Key分片</strong>：将排行榜按用户ID分片（如<code>rank:user:123</code>），分散到不同槽。</li>
<li><strong>本地缓存</strong>：客户端引入Guava Cache缓存热点数据，减少Redis请求。<br/>
<strong>效果</strong>：热点节点QPS从10万降到2万，整体性能提升50%。</li>
</ol>
<h3 data-id="heading-30">踩坑经验</h3>
<ol>
<li>
<p><strong>MOVED/ASK重定向问题</strong><br/>
在迁移初期，部分客户端未正确处理集群返回的<code>MOVED</code>或<code>ASK</code>重定向，导致请求失败。<br/>
<strong>解决办法</strong>：确保客户端（如Jedis）支持集群模式，并配置合理的重试策略。<br/>
<strong>教训</strong>：迁移前要充分测试客户端兼容性。</p>
</li>
<li>
<p><strong>Pipeline使用的注意事项</strong><br/>
在集群模式下，Pipeline无法跨槽批量操作，否则会报错。<br/>
<strong>解决办法</strong>：将Pipeline操作拆分为单槽请求，或改用Lua脚本。<br/>
<strong>代码示例</strong>：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- Lua脚本示例：批量操作同一槽的键</span>
<span class="hljs-keyword">local</span> keys = KEYS
<span class="hljs-keyword">for</span> i, key <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(keys) <span class="hljs-keyword">do</span>
    redis.call(<span class="hljs-string">'SET'</span>, key, ARGV[i])
<span class="hljs-keyword">end</span>
<span class="hljs-keyword">return</span> <span class="hljs-string">"OK"</span>
</code></pre>
<ul>
<li><strong>注释</strong>：确保<code>KEYS</code>中的键属于同一槽，避免跨槽错误。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-31">示意图：从单机到集群的迁移</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[单机Redis]</span> --&gt; <span class="hljs-selector-attr">[数据导出]</span> --&gt; <span class="hljs-selector-attr">[集群预分片]</span> --&gt; <span class="hljs-selector-attr">[客户端切换]</span> --&gt; <span class="hljs-selector-attr">[Redis Cluster]</span>
   |                |               |                 |                 |
内存爆满         分片脚本        槽分配           JedisCluster      高可用扩展
</code></pre>
<hr/>
<h3 data-id="heading-32">对比表格：不同模式的适用场景</h3>



































<table><thead><tr><th><strong>模式</strong></th><th><strong>优点</strong></th><th><strong>缺点</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td>单机</td><td>简单、高性能</td><td>容量有限、单点故障</td><td>小型应用、测试环境</td></tr><tr><td>主从</td><td>读写分离</td><td>主节点仍有限制</td><td>中型读多写少场景</td></tr><tr><td>哨兵</td><td>高可用、自动切换</td><td>单主容量瓶颈</td><td>对可用性要求高的应用</td></tr><tr><td>集群</td><td>分布式、高扩展性</td><td>配置稍复杂</td><td>大规模、高并发系统</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-33">过渡段</h3>
<p>通过以上案例和经验，我们看到了Redis从单机到分布式的扩展路径，既有技术的渐进演化，也有实践中的摸索优化。但集群的潜力远不止于此，如何进一步挖掘其高级功能并优化性能，将是我们下一节的重点。让我们继续探索Redis集群的高级应用与优化技巧。</p>
<hr/>
<h2 data-id="heading-34">6. Redis集群的高级应用与优化</h2>
<p>Redis集群搭建完成并投入使用后，仅仅是迈出了分布式实践的第一步。要真正发挥它的潜力，我们需要在高级功能应用和性能优化上下功夫。这一节，我将分享一些集群模式下的进阶用法、优化技巧以及运维经验，帮助你在实际项目中将Redis集群“调教”得更出色。</p>
<h3 data-id="heading-35">高级功能应用</h3>
<ol>
<li>
<p><strong>Lua脚本在集群中的使用与限制</strong><br/>
Lua脚本是Redis的杀手锏之一，能原子化执行复杂逻辑。但在集群模式下，脚本中的所有键必须属于同一槽，否则会报错<code>CROSSSLOT</code>。<br/>
<strong>解决办法</strong>：使用哈希标签（Hash Tag），如<code>{user}.name</code>和<code>{user}.score</code>，确保键映射到同一槽。<br/>
<strong>代码示例</strong>：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 设置用户姓名和分数，确保同一槽</span>
<span class="hljs-keyword">local</span> name_key = KEYS[<span class="hljs-number">1</span>]  <span class="hljs-comment">-- {user:123}.name</span>
<span class="hljs-keyword">local</span> score_key = KEYS[<span class="hljs-number">2</span>] <span class="hljs-comment">-- {user:123}.score</span>
redis.call(<span class="hljs-string">'SET'</span>, name_key, ARGV[<span class="hljs-number">1</span>])
redis.call(<span class="hljs-string">'SET'</span>, score_key, ARGV[<span class="hljs-number">2</span>])
<span class="hljs-keyword">return</span> <span class="hljs-string">"OK"</span>
</code></pre>
<ul>
<li><strong>注释</strong>：通过<code>{}</code>定义哈希标签，控制槽分配。</li>
</ul>
</li>
<li>
<p><strong>事务（MULTI/EXEC）的替代方案</strong><br/>
集群模式不支持跨槽的事务，传统的<code>MULTI/EXEC</code>受限。<br/>
<strong>替代方案</strong>：将事务逻辑改为Lua脚本，或通过客户端分步操作+补偿机制实现。<br/>
<strong>经验</strong>：对于简单逻辑，优先选择Lua，既高效又原子化。</p>
</li>
</ol>
<h3 data-id="heading-36">性能优化</h3>
<ol>
<li>
<p><strong>批量操作减少网络开销</strong><br/>
单次请求的网络延迟在集群中会被放大，批量操作是优化利器。<br/>
<strong>实践</strong>：用<code>MSET</code>替代多次<code>SET</code>，我在一个日志系统中将写入延迟从5ms降到1ms。<br/>
<strong>代码示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">redis-cli -p 7000 MSET key1 val1 key2 val2 key3 val3
</code></pre>
</li>
<li>
<p><strong>热点Key检测与分散</strong><br/>
热点Key会导致某节点负载过高。<br/>
<strong>解决办法</strong>：</p>
<ul>
<li>通过<code>redis-cli --hotkeys</code>检测热点。</li>
<li>将热点Key拆分为多个子Key（如<code>hotkey:part1</code>、<code>hotkey:part2</code>），分散请求。<br/>
<strong>效果</strong>：一个实时统计项目中，热点节点QPS从8万降到3万，负载均衡显著改善。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-37">监控与运维</h3>
<p>集群的稳定运行离不开监控。以下是几个常用指标和工具：</p>
<ul>
<li><strong>关键指标</strong>：
<ul>
<li><strong>槽分布</strong>：<code>cluster slots</code>检查是否均匀。</li>
<li><strong>节点延迟</strong>：通过<code>PING</code>测试响应时间。</li>
<li><strong>内存使用率</strong>：<code>INFO MEMORY</code>查看<code>used_memory</code>。</li>
</ul>
</li>
<li><strong>代码示例：Python监控脚本</strong>：
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> redis

<span class="hljs-keyword">def</span> <span class="hljs-title function_">monitor_cluster</span>(<span class="hljs-params">host, port</span>):
    r = redis.Redis(host=host, port=port)
    cluster_info = r.cluster_info()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Cluster State: <span class="hljs-subst">{cluster_info[<span class="hljs-string">'cluster_state'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Slots Assigned: <span class="hljs-subst">{cluster_info[<span class="hljs-string">'cluster_slots_assigned'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Known Nodes: <span class="hljs-subst">{cluster_info[<span class="hljs-string">'cluster_known_nodes'</span>]}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    monitor_cluster(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">7000</span>)
</code></pre>
<ul>
<li><strong>注释</strong>：脚本定期检查集群状态，发现异常及时告警。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-38">最佳实践</h3>
<ol>
<li>
<p><strong>预分片降低扩容成本</strong><br/>
在一个广告系统项目中，我们预先部署了6个节点，但只使用3个主节点，槽分配留有余量。后来流量增长时，直接启用备用节点，迁移成本几乎为零。<br/>
<strong>建议</strong>：初期多部署节点，槽分配预留扩展空间。</p>
</li>
<li>
<p><strong>踩坑分享：连接池配置失误</strong><br/>
有一次因客户端连接池配置不当（最大连接数设为10），高峰期请求排队导致延迟激增。<br/>
<strong>解决办法</strong>：调整Jedis连接池参数：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">JedisPoolConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPoolConfig</span>();
config.setMaxTotal(<span class="hljs-number">100</span>); <span class="hljs-comment">// 最大连接数</span>
config.setMaxIdle(<span class="hljs-number">20</span>);   <span class="hljs-comment">// 最大空闲连接</span>
</code></pre>
<p><strong>教训</strong>：连接池要根据QPS预估合理配置，避免成为瓶颈。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-39">示意图：热点Key分散策略</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[热点Key: <span class="hljs-string">"stats"</span>]</span> --&gt; 分散为 --&gt; <span class="hljs-selector-attr">[stats:part1]</span> <span class="hljs-selector-attr">[stats:part2]</span> <span class="hljs-selector-attr">[stats:part3]</span>
      |                                 |           |           |
    高负载                            节点<span class="hljs-selector-tag">A</span>       节点<span class="hljs-selector-tag">B</span>       节点C
</code></pre>
<p><strong>说明</strong>：将单一热点Key拆分，负载均匀分布到多个节点。</p>
<hr/>
<h3 data-id="heading-40">优化效果对比表格</h3>





























<table><thead><tr><th><strong>优化手段</strong></th><th><strong>优化前</strong></th><th><strong>优化后</strong></th><th><strong>效果</strong></th></tr></thead><tbody><tr><td>批量操作</td><td>5ms/次</td><td>1ms/次</td><td>延迟降低80%</td></tr><tr><td>热点Key分散</td><td>单节点8万QPS</td><td>各节点3万QPS</td><td>负载均衡提升60%</td></tr><tr><td>预分片扩容</td><td>迁移耗时2小时</td><td>迁移耗时5分钟</td><td>扩容效率提升95%</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-41">过渡段</h3>
<p>通过高级功能和优化技巧，Redis集群的性能和稳定性得到了进一步提升。但技术的价值最终体现在业务支持上。从单机到分布式的这条路，我们已经走了很远，接下来是时候总结经验，并展望Redis的未来发展了。最后一节，我们将回顾这段旅程，并给出实践建议。</p>
<hr/>
<h2 data-id="heading-42">7. 总结与展望</h2>
<p>从单机Redis的简单高效，到分布式集群的强大扩展，我们一路走来，见证了Redis如何从一匹独狼进化为一支协同作战的狼群。这篇文章带你穿越了从单机到分布式的技术演进之路，剖析了Redis Cluster的核心概念、搭建方法和优化实践。现在，让我们停下脚步，回顾这段旅程的收获，并展望Redis在未来的可能性。</p>
<h3 data-id="heading-43">总结</h3>
<p>Redis集群架构的核心价值可以用三个词概括：<strong>高性能、高可用、可扩展</strong>。它通过数据分片突破了单机内存的限制，用主从复制和故障转移保障了服务的稳定性，还以动态扩缩容为业务增长提供了无限可能。从单机到主从，再到哨兵和集群，每一步都在解决特定的痛点：</p>
<ul>
<li>单机模式适合小规模快速开发；</li>
<li>主从复制分担读压力；</li>
<li>哨兵模式提升可用性；</li>
<li>集群模式则为大规模、高并发场景量身定制。</li>
</ul>
<p>在我的10年Redis开发经历中，从早期单机优化到如今驾驭分布式集群，每一次转型都伴随着业务需求的驱动和技术能力的提升。无论是社交平台的用户缓存，还是游戏系统的实时排行榜，Redis集群都以其灵活性和可靠性，成为了不可或缺的基石。</p>
<h3 data-id="heading-44">实践建议</h3>
<p>基于这些经验，我为不同阶段的开发者提几点建议：</p>
<ol>
<li><strong>根据业务规模选择架构</strong>：小型项目用单机或主从即可，中大型系统尽早规划集群，避免后期迁移的麻烦。</li>
<li><strong>关注细节优化</strong>：槽分配、热点Key、连接池配置，这些“小事”往往决定集群的成败。</li>
<li><strong>持续学习新特性</strong>：Redis 7.0引入了多线程I/O和更强的集群管理功能，值得关注和尝试。</li>
</ol>
<h3 data-id="heading-45">展望</h3>
<p>Redis的未来发展与云原生和分布式系统的趋势紧密相连。随着容器化技术的普及，Redis Cluster在Kubernetes等平台上的部署将更加便捷，自动化运维也会成为标配。同时，Redis的模块化设计（如RedisJSON、RedisGraph）让它从单纯的键值存储进化成多功能数据平台，应用场景将进一步拓宽。<br/>
个人预测，未来Redis可能会在边缘计算和AI推理领域崭露头角，比如通过内存加速实时模型预测。这不仅是对性能的挑战，也是对分布式架构的新考验。</p>
<h3 data-id="heading-46">个人心得</h3>
<p>作为一名Redis老用户，我最大的感触是：技术没有银弹，Redis集群虽强大，但并非万能。它的成功应用离不开对业务的深刻理解和对细节的极致追求。每次踩坑都是一次成长，比如热点Key的优化让我学会了“分而治之”，而AOF的教训则提醒我“安全第一”。希望这篇文章能为你点亮一盏灯，无论是初探集群还是优化现有系统，都能少走弯路，多些信心。</p>
<hr/>
<h3 data-id="heading-47">总结表格：Redis演进路径价值</h3>






























<table><thead><tr><th><strong>阶段</strong></th><th><strong>核心价值</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td>单机</td><td>简单高效</td><td>小型应用</td></tr><tr><td>主从</td><td>读写分离</td><td>中型读多写少系统</td></tr><tr><td>哨兵</td><td>高可用性</td><td>对中断敏感的应用</td></tr><tr><td>集群</td><td>分布式扩展</td><td>大规模高并发系统</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年 TC39 都在忙什么？Import Bytes、Iterator Chunking 来了]]></title>    <link>https://juejin.cn/post/7581306080435322931</link>    <guid>https://juejin.cn/post/7581306080435322931</guid>    <pubDate>2025-12-08T14:27:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581306080435322931" data-draft-id="7581359420391800859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 年 TC39 都在忙什么？Import Bytes、Iterator Chunking 来了"/> <meta itemprop="keywords" content="JavaScript,前端,面试"/> <meta itemprop="datePublished" content="2025-12-08T14:27:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 年 TC39 都在忙什么？Import Bytes、Iterator Chunking 来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T14:27:59.000Z" title="Mon Dec 08 2025 14:27:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TC39 2025：Import Bytes、Iterator Chunking 和那些即将落地的新特性</h2>
<p>写跨平台的 JS 代码时，读个二进制文件都得写三套逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 浏览器</span>
<span class="hljs-keyword">const</span> bytes = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'./photo.png'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">arrayBuffer</span>());

<span class="hljs-comment">// Node.js</span>
<span class="hljs-keyword">const</span> bytes = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>).<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'./photo.png'</span>);

<span class="hljs-comment">// Deno</span>
<span class="hljs-keyword">const</span> bytes = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Deno</span>.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'./photo.png'</span>);
</code></pre>
<p>同样的需求，三种写法。想写个同构的图片处理库？先把这三套 API 适配一遍再说。</p>
<p>好消息是，TC39 在 2025 年推进了好几个提案来解决这类问题。这篇文章聊聊其中最值得关注的几个：Import Bytes、Iterator Chunking，以及今年已经进入 Stage 4 的新特性。</p>
<h3 data-id="heading-1">Import Bytes：一行代码搞定二进制导入</h3>
<h4 data-id="heading-2">现在是什么状态</h4>
<p><strong>Stage 2.7</strong>（截至 2025 年 9 月），离正式标准就差临门一脚了。提案负责人是 Steven Salat，Guy Bedford 是共同作者。</p>
<h4 data-id="heading-3">核心语法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> bytes <span class="hljs-keyword">from</span> <span class="hljs-string">"./photo.png"</span> <span class="hljs-keyword">with</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">"bytes"</span> };
<span class="hljs-comment">// bytes 是 Uint8Array，底层是不可变的 ArrayBuffer</span>
</code></pre>
<p>动态导入也支持：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> bytes = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"./photo.png"</span>, { <span class="hljs-attr">with</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"bytes"</span> } });
</code></pre>
<p>就这么简单。不管你在浏览器、Node.js 还是 Deno，同一行代码，同样的结果。</p>
<h4 data-id="heading-4">为什么返回 Uint8Array 而不是 ArrayBuffer</h4>
<p>提案选择返回 <code>Uint8Array</code> 而不是裸的 <code>ArrayBuffer</code>，理由挺实在的：</p>
<ol>
<li><strong>少一步操作</strong> - 拿到 ArrayBuffer 你还得自己创建 TypedView，Uint8Array 直接就能用</li>
<li><strong>跟现有 API 保持一致</strong> - <code>Response.bytes()</code> 和 <code>Blob.bytes()</code> 都返回 Uint8Array</li>
<li><strong>Node.js Buffer 兼容</strong> - Buffer 本身就是 Uint8Array 的子类</li>
</ol>
<h4 data-id="heading-5">为什么底层是不可变的 ArrayBuffer</h4>
<p>这个设计决定挺有意思的。底层 ArrayBuffer 被设计成不可变的，原因有三：</p>
<ol>
<li><strong>避免共享可变状态</strong> - 多个模块导入同一个文件，拿到的是同一个对象。如果可变，一个模块改了数据，其他模块全受影响</li>
<li><strong>嵌入式场景</strong> - 不可变数据可以直接放 ROM 里</li>
<li><strong>安全性考虑</strong> - 防止模块间通过共享 buffer 建立隐蔽通信通道</li>
</ol>
<h4 data-id="heading-6">实际能干什么</h4>
<p><strong>图片处理</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> imageBytes <span class="hljs-keyword">from</span> <span class="hljs-string">"./logo.png"</span> <span class="hljs-keyword">with</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">"bytes"</span> };
<span class="hljs-comment">// 用 satori 之类的同构库处理</span>
<span class="hljs-title function_">processImage</span>(imageBytes);
</code></pre>
<p><strong>加载字体</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> fontBytes <span class="hljs-keyword">from</span> <span class="hljs-string">"./custom.woff"</span> <span class="hljs-keyword">with</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">"bytes"</span> };
<span class="hljs-comment">// Canvas 或 PDF 生成时用</span>
<span class="hljs-title function_">registerFont</span>(fontBytes);
</code></pre>
<p><strong>机器学习模型</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> modelBytes <span class="hljs-keyword">from</span> <span class="hljs-string">"./model.bin"</span> <span class="hljs-keyword">with</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">"bytes"</span> };
<span class="hljs-title function_">loadModel</span>(modelBytes);
</code></pre>
<h4 data-id="heading-7">工具链支持</h4>
<p>好消息是，主流工具已经在跟进了。Deno 2.4、Bun 1.1.7 都有类似实现，Webpack、esbuild、Parcel 也支持类似的二进制导入机制。等提案正式落地，统一语法只是时间问题。</p>
<h3 data-id="heading-8">Iterator Chunking：迭代器分块终于有原生方案了</h3>
<h4 data-id="heading-9">现在是什么状态</h4>
<p><strong>Stage 2.7</strong>（截至 2025 年 9 月），由 Michael Ficarra 主导。</p>
<h4 data-id="heading-10">两个核心方法</h4>
<p><strong>chunks(size) - 非重叠分块</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>].<span class="hljs-title function_">values</span>();
<span class="hljs-keyword">const</span> chunked = numbers.<span class="hljs-title function_">chunks</span>(<span class="hljs-number">3</span>);

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> chunked) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chunk);
}
<span class="hljs-comment">// [1, 2, 3]</span>
<span class="hljs-comment">// [4, 5, 6]</span>
<span class="hljs-comment">// [7]</span>
</code></pre>
<p><strong>windows(size) - 滑动窗口</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>].<span class="hljs-title function_">values</span>();
<span class="hljs-keyword">const</span> windowed = numbers.<span class="hljs-title function_">windows</span>(<span class="hljs-number">2</span>);

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-variable language_">window</span> <span class="hljs-keyword">of</span> windowed) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>);
}
<span class="hljs-comment">// [1, 2]</span>
<span class="hljs-comment">// [2, 3]</span>
<span class="hljs-comment">// [3, 4]</span>
</code></pre>
<p>区别很直观：chunks 是切成一块一块互不重叠，windows 是滑动窗口每次移动一格。</p>
<h4 data-id="heading-11">解决什么问题</h4>
<p>以前想做分块操作，要么自己写，要么引入 lodash：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// lodash 方案</span>
<span class="hljs-keyword">import</span> chunk <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash/chunk'</span>;
<span class="hljs-keyword">const</span> chunks = <span class="hljs-title function_">chunk</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>], <span class="hljs-number">2</span>);

<span class="hljs-comment">// 原生方案</span>
<span class="hljs-keyword">const</span> chunks = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>].<span class="hljs-title function_">values</span>().<span class="hljs-title function_">chunks</span>(<span class="hljs-number">2</span>);
</code></pre>
<p>原生方案的优势：</p>
<ul>
<li>不用装依赖</li>
<li>惰性求值，内存友好</li>
<li>跟整个迭代器生态无缝衔接</li>
<li>支持异步迭代器</li>
</ul>
<h4 data-id="heading-12">实际场景</h4>
<p><strong>批量 API 请求</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">batchProcess</span>(<span class="hljs-params">items</span>) {
  <span class="hljs-keyword">const</span> batches = items.<span class="hljs-title function_">values</span>().<span class="hljs-title function_">chunks</span>(<span class="hljs-number">50</span>);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> batch <span class="hljs-keyword">of</span> batches) {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(batch.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> api.<span class="hljs-title function_">process</span>(item)));
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 避免触发限流</span>
  }
}
</code></pre>
<p><strong>移动平均计算</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">movingAverage</span>(<span class="hljs-params">numbers, windowSize</span>) {
  <span class="hljs-keyword">return</span> numbers
    .<span class="hljs-title function_">values</span>()
    .<span class="hljs-title function_">windows</span>(windowSize)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">w</span> =&gt;</span> w.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b) / windowSize)
    .<span class="hljs-title function_">toArray</span>();
}

<span class="hljs-keyword">const</span> prices = [<span class="hljs-number">100</span>, <span class="hljs-number">102</span>, <span class="hljs-number">98</span>, <span class="hljs-number">105</span>, <span class="hljs-number">103</span>, <span class="hljs-number">107</span>];
<span class="hljs-keyword">const</span> ma3 = <span class="hljs-title function_">movingAverage</span>(prices, <span class="hljs-number">3</span>);
<span class="hljs-comment">// 3日移动平均</span>
</code></pre>
<p><strong>N-gram 生成</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">generateNGrams</span>(<span class="hljs-params">text, n</span>) {
  <span class="hljs-keyword">const</span> words = text.<span class="hljs-title function_">split</span>(<span class="hljs-string">' '</span>);
  <span class="hljs-keyword">return</span> words.<span class="hljs-title function_">values</span>()
    .<span class="hljs-title function_">windows</span>(n)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">w</span> =&gt;</span> w.<span class="hljs-title function_">join</span>(<span class="hljs-string">' '</span>))
    .<span class="hljs-title function_">toArray</span>();
}

<span class="hljs-keyword">const</span> bigrams = <span class="hljs-title function_">generateNGrams</span>(<span class="hljs-string">"The quick brown fox"</span>, <span class="hljs-number">2</span>);
<span class="hljs-comment">// ["The quick", "quick brown", "brown fox"]</span>
</code></pre>
<h4 data-id="heading-13">边界情况的讨论</h4>
<p>这个提案在推进过程中遇到了一个有意思的问题：<strong>如果迭代器元素少于窗口大小，windows() 应该返回什么？</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> small = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>].<span class="hljs-title function_">values</span>();
<span class="hljs-keyword">const</span> result = small.<span class="hljs-title function_">windows</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// 只有2个元素，请求3个的窗口</span>

<span class="hljs-comment">// 选项1：不返回任何窗口</span>
<span class="hljs-comment">// 选项2：返回 [1, 2] 作为不完整窗口</span>
</code></pre>
<p>委员会讨论后认为两种场景都有合理的使用需求，所以决定把 <code>windows()</code> 拆分成多个方法来分别处理这两种情况。这也是提案从 Stage 2 到 Stage 2.7 花了点时间的原因。</p>
<h3 data-id="heading-14">2025 年进入 Stage 4 的特性</h3>
<p>除了上面两个还在推进的提案，2025 年还有好几个特性已经正式"毕业"了：</p>
<h4 data-id="heading-15">RegExp.escape（2 月）</h4>
<p>安全转义正则表达式字符串，防止注入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> userInput = <span class="hljs-string">"user@example.com (admin)"</span>;
<span class="hljs-keyword">const</span> safePattern = <span class="hljs-title class_">RegExp</span>.<span class="hljs-built_in">escape</span>(userInput);
<span class="hljs-keyword">const</span> regex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(safePattern);
<span class="hljs-comment">// 不用担心括号被解析成分组了</span>
</code></pre>
<p>这个需求太常见了，以前都得自己写转义函数或者用第三方库。</p>
<h4 data-id="heading-16">Float16Array（2 月）</h4>
<p>半精度浮点数的 TypedArray：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> f16Array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float16Array</span>([<span class="hljs-number">1.5</span>, <span class="hljs-number">2.7</span>, <span class="hljs-number">3.1</span>]);
</code></pre>
<p>主要面向机器学习和图形处理场景。模型权重经常用 fp16 存储，有了原生支持就不用自己做转换了。</p>
<h4 data-id="heading-17">Error.isError（5 月）</h4>
<p>可靠地判断一个值是不是 Error：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (<span class="hljs-title class_">Error</span>.<span class="hljs-title function_">isError</span>(value)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value.<span class="hljs-property">message</span>);
}
</code></pre>
<p>为什么不用 <code>instanceof Error</code>？因为跨 realm（比如 iframe 或 Node.js 的 vm 模块）的 Error 实例会被判成 false。这个方法解决了这个历史问题。</p>
<h4 data-id="heading-18">Math.sumPrecise（7 月）</h4>
<p>高精度求和：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> sum = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sumPrecise</span>([<span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>]);
<span class="hljs-comment">// 比普通累加更精确，减少浮点误差累积</span>
</code></pre>
<p>做金融计算或科学计算的应该会喜欢这个。</p>
<h4 data-id="heading-19">Uint8Array Base64 编解码（7 月）</h4>
<p>原生的 Base64 编解码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> bytes = <span class="hljs-title class_">Uint8Array</span>.<span class="hljs-title function_">fromBase64</span>(<span class="hljs-string">'SGVsbG8='</span>);
<span class="hljs-keyword">const</span> base64 = bytes.<span class="hljs-title function_">toBase64</span>();
<span class="hljs-comment">// 还有 fromHex() 和 toHex()</span>
</code></pre>
<p>终于不用为了 Base64 转换去找第三方库了。</p>
<h4 data-id="heading-20">Explicit Resource Management（已 Stage 4）</h4>
<p><code>using</code> 关键字，自动资源清理：</p>
<pre><code class="hljs language-javascript" lang="javascript">using file = <span class="hljs-keyword">await</span> <span class="hljs-title function_">openFile</span>(<span class="hljs-string">'data.txt'</span>);
<span class="hljs-comment">// 离开作用域自动关闭，不用手动 finally</span>
</code></pre>
<p>借鉴了 Python 的 with 和 C# 的 using，解决了 JS 里资源管理一直很混乱的问题。</p>
<h3 data-id="heading-21">还有几个值得关注的 Stage 2 提案</h3>
<h4 data-id="heading-22">Seeded PRNG（5 月进入 Stage 2）</h4>
<p>可种子化的随机数生成器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> random = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>(<span class="hljs-number">12345</span>); <span class="hljs-comment">// 种子</span>
<span class="hljs-keyword">const</span> value = random.<span class="hljs-title function_">next</span>();
<span class="hljs-comment">// 同样的种子，同样的序列</span>
</code></pre>
<p>游戏开发、测试、仿真这些场景经常需要可重现的随机序列。</p>
<h4 data-id="heading-23">Error Stack Accessor（5 月进入 Stage 2）</h4>
<p>标准化错误堆栈的访问方式。现在各个引擎的 <code>error.stack</code> 格式都不一样，这个提案要统一它。</p>
<h3 data-id="heading-24">提案流程简单回顾</h3>
<p>TC39 的提案分 5 个阶段：</p>
<ul>
<li><strong>Stage 0</strong>：想法</li>
<li><strong>Stage 1</strong>：正式提案，开始讨论</li>
<li><strong>Stage 2</strong>：规范草案，API 基本稳定</li>
<li><strong>Stage 2.7</strong>：规范文本接近完成，准备写测试</li>
<li><strong>Stage 3</strong>：等待实现反馈</li>
<li><strong>Stage 4</strong>：正式纳入标准</li>
</ul>
<p>Import Bytes 和 Iterator Chunking 都到了 Stage 2.7，离 Stage 3 就差 test262 测试和浏览器实现承诺了。</p>
<h3 data-id="heading-25">总结</h3>
<p>2025 年 TC39 的进展还是挺给力的：</p>
<ul>
<li><strong>Import Bytes</strong> 解决了跨平台二进制导入的老大难问题，同构库开发终于能省心了</li>
<li><strong>Iterator Chunking</strong> 补上了迭代器工具链的空白，chunks 和 windows 覆盖了大部分分块场景</li>
<li><strong>一堆特性进入 Stage 4</strong>：RegExp.escape、Float16Array、Math.sumPrecise、Base64 编解码、资源管理...</li>
</ul>
<p>这些特性有的已经可以通过 Babel 或 TypeScript 提前尝鲜了。如果你在用 Deno 或 Bun，Import Bytes 类似的功能现在就能用。</p>
<hr/>
<p><strong>顺手安利几个我的开源项目：</strong></p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul>
<hr/>
<h3 data-id="heading-26">参考链接</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftc39%2Fproposals" target="_blank" title="https://github.com/tc39/proposals" ref="nofollow noopener noreferrer">TC39 Proposals Repository</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftc39%2Fproposal-import-bytes" target="_blank" title="https://github.com/tc39/proposal-import-bytes" ref="nofollow noopener noreferrer">Import Bytes Proposal</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftc39.es%2Fproposal-iterator-chunking%2F" target="_blank" title="https://tc39.es/proposal-iterator-chunking/" ref="nofollow noopener noreferrer">Iterator Chunking Specification</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblogs.igalia.com%2Fcompilers%2F2025%2F03%2F27%2Fsummary-of-the-february-2025-tc39-plenary%2F" target="_blank" title="https://blogs.igalia.com/compilers/2025/03/27/summary-of-the-february-2025-tc39-plenary/" ref="nofollow noopener noreferrer">February 2025 TC39 Meeting Summary</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblogs.igalia.com%2Fcompilers%2F2025%2F07%2F03%2Fsummary-of-the-may-2025-tc39-plenary%2F" target="_blank" title="https://blogs.igalia.com/compilers/2025/07/03/summary-of-the-may-2025-tc39-plenary/" ref="nofollow noopener noreferrer">May 2025 TC39 Meeting Summary</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.infoq.com%2Fnews%2F2025%2F06%2Ftc39-stage-4-2025%2F" target="_blank" title="https://www.infoq.com/news/2025/06/tc39-stage-4-2025/" ref="nofollow noopener noreferrer">TC39 Stage 4 Proposals 2025</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Agent】MemOS 源码笔记---(3)---搜索]]></title>    <link>https://juejin.cn/post/7581312433529733163</link>    <guid>https://juejin.cn/post/7581312433529733163</guid>    <pubDate>2025-12-08T12:31:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581312433529733163" data-draft-id="7577647745110425600" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Agent】MemOS 源码笔记---(3)---搜索"/> <meta itemprop="keywords" content="算法,机器学习"/> <meta itemprop="datePublished" content="2025-12-08T12:31:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Agent】MemOS 源码笔记---(3)---搜索
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T12:31:41.000Z" title="Mon Dec 08 2025 12:31:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Agent】MemOS 源码笔记---(3)---搜索</h2>
<h3 data-id="heading-1">0x00 摘要</h3>
<p>TreeTextMemory 提供了一个完整的记忆管理系统，能存储、组织、检索和维护各种类型的文本记忆、适用需要复杂记忆管理的AI系统。这是一个基于图的、树形明文记忆，支持以结构化方式组织、关联并检索记忆，同时保留丰富的上下文信息与良好的可解释性。我们可以通过这个TreeTextMemory 对象与庞大的知识库进行交互，为AI赋予专业的领域记忆。当前使用Neo4j作为后端，未来计划支持更多图数据库。</p>
<p>因为字数太多，因此把TreeTextMemory拆分为两部分，上一篇介绍基本概念和如何管理，本篇介绍如何搜索。</p>
<h3 data-id="heading-2">0x01 分类</h3>
<p>TreeTextMemory 主要支持几种搜索（注，有些是从其他途径透出）：</p>
<ul>
<li>
<p>混合搜索（Hybrid Search），通过 Searcher.search 方法对外提供服务，整合多种检索策略的结果，具体策略如下：</p>
<ul>
<li>结合向量相似度搜索和图遍历：在 GraphMemoryRetriever中利用图结构和向量信息</li>
<li>全文检索：虽然没有显式的全文搜索API，但可以通过互联网检索器从搜索引擎获取相关内容 InternetRetriever 组件允许集成外部搜索服务（如Google、Bing、Bocha）</li>
</ul>
</li>
<li>
<p>子图检索（Subgraph Retrieval），通过 get_relevant_subgraph 方法可以直接进行子图搜索</p>
<ul>
<li>使用 graph_store.search_by_embedding 方法获取指定节点周围的局部子图结构</li>
<li>支持设置遍历深度和中心节点状态条件</li>
<li>返回包含核心节点、邻居节点和边的完整子图信息</li>
</ul>
</li>
</ul>
<p>以下是图数据库的API，比如位于MemOS-main\src\memos\graph_dbs\nebular.py中，在一些示例中也直接使用：</p>
<ul>
<li>
<p>基于元数据的结构化查询（Metadata-based Structured Query）</p>
<ul>
<li>通过 get_by_metadata方法根据节点元数据字段进行精确匹配或条件查询</li>
<li>支持多种操作符：等于（=）、包含（contains）、在列表中（in）等</li>
<li>可以组合多个条件进行复杂查询</li>
</ul>
</li>
</ul>

<ul>
<li>
<p>标签重叠查询（Tag Overlap Query）</p>
<ul>
<li>使用 get_neighbors_by_tag方法查找具有相似标签的相邻节点</li>
<li>通过计算标签交集大小来确定相关性</li>
<li>支持设置最小标签重叠数要求</li>
</ul>
</li>
<li>
<p>向量相似度搜索（Vector Similarity Search）</p>
<ul>
<li>基于嵌入（embedding）的语义相似度搜索</li>
<li>使用 search_by_embedding 方法根据查询向量找到最相似的记忆节点</li>
<li>支持设置相似度阈值和返回结果数量限制</li>
</ul>
</li>
</ul>
<p>其中最主要的查询接口是 search方法，它内部整合了多种检索策略来提供最优的搜索结果。</p>
<h3 data-id="heading-3">0x02 ## 混合搜索（Hybrid Search）--- Searcher</h3>
<p>Searcher 由 TreeTextMemory 创建并作为主要的搜索接口使用，Searcher 是整个记忆检索系统的核心协调者，负责整合各种检索源并提供高质量的检索结果。Searcher 类的主要功能是执行记忆检索任务。以下是其核心职责和工作流程：</p>
<ul>
<li>
<p>多路径并行检索，同时从多个来源检索相关信息：</p>
<ul>
<li>工作记忆（WorkingMemory）</li>
<li>长期记忆（LongTermMemory）</li>
<li>用户记忆（UserMemory）</li>
<li>互联网检索器（可选）</li>
<li>MemCubes（可选）</li>
</ul>
</li>
<li>
<p>任务解析与查询优化</p>
<ul>
<li>使用 TaskGoalParser 解析用户查询意图</li>
<li>根据不同模式（fast/fine）采用不同的检索策略</li>
<li>在精细模式下先进行嵌入搜索获取上下文</li>
</ul>
</li>
<li>
<p>结果重排序与去重</p>
<ul>
<li>使用 reranker 对检索结果进行重新排序</li>
<li>去除重复的记忆项</li>
<li>保留最相关的结果</li>
</ul>
</li>
<li>
<p>高级推理处理</p>
<ul>
<li>利用 MemoryReasoner 对检索到的记忆进行推理和知识综合</li>
<li>提取最有价值的信息片段</li>
</ul>
</li>
<li>
<p>使用历史追踪</p>
<ul>
<li>更新记忆项的使用历史记录</li>
<li>并发处理使用统计更新</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">2.1 定义</h4>
<pre><code class="hljs language-ini" lang="ini">class Searcher:
    def __init__(
        self,
        dispatcher_llm: OpenAILLM | OllamaLLM | AzureLLM,
        graph_store: Neo4jGraphDB,
        embedder: OllamaEmbedder,
        reranker: BaseReranker,
        internet_retriever: InternetRetrieverFactory | <span class="hljs-attr">None</span> = None,
        moscube: <span class="hljs-attr">bool</span> = <span class="hljs-literal">False</span>,
    ):
        <span class="hljs-attr">self.graph_store</span> = graph_store
        <span class="hljs-attr">self.embedder</span> = embedder
​
        <span class="hljs-attr">self.task_goal_parser</span> = TaskGoalParser(dispatcher_llm)
        <span class="hljs-attr">self.graph_retriever</span> = GraphMemoryRetriever(self.graph_store, self.embedder)
        <span class="hljs-attr">self.reranker</span> = reranker
        <span class="hljs-attr">self.reasoner</span> = MemoryReasoner(dispatcher_llm)
​
        <span class="hljs-comment"># Create internet retriever from config if provided</span>
        <span class="hljs-attr">self.internet_retriever</span> = internet_retriever
        <span class="hljs-attr">self.moscube</span> = moscube
​
        <span class="hljs-attr">self._usage_executor</span> = ContextThreadPoolExecutor(max_workers=<span class="hljs-number">4</span>, thread_name_prefix=<span class="hljs-string">"usage"</span>)
</code></pre>
<h4 data-id="heading-5">2.2 核心函数</h4>
<p>其核心方法如下：</p>
<ul>
<li>search()：主入口，协调整个检索过程</li>
<li>_parse_task()：解析任务和查询</li>
<li>_retrieve_paths()：执行多路径检索</li>
<li>_deduplicate_results()：结果去重</li>
<li>_sort_and_trim()：排序和截断结果</li>
<li>update_usage_history()：更新使用历史</li>
</ul>
<p>主入口如下，或者说Searcher 编排搜索流水线如下：</p>
<ul>
<li>查询解析和理解</li>
<li>从多个来源并行检索</li>
<li>结果重新排序</li>
<li>去重处理</li>
<li>对结果进行推理</li>
<li>使用情况跟踪</li>
</ul>

<pre><code class="hljs language-python" lang="python">    @timed
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">
        self,
        query: <span class="hljs-built_in">str</span>,
        top_k: <span class="hljs-built_in">int</span>,
        info=<span class="hljs-literal">None</span>,
        mode=<span class="hljs-string">"fast"</span>,
        memory_type=<span class="hljs-string">"All"</span>,
        search_filter: <span class="hljs-built_in">dict</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; <span class="hljs-built_in">list</span>[TextualMemoryItem]:
        <span class="hljs-string">"""
        Search for memories based on a query.
        User query -&gt; TaskGoalParser -&gt; GraphMemoryRetriever -&gt;
        MemoryReranker -&gt; MemoryReasoner -&gt; Final output
        Args:
            query (str): The query to search for.
            top_k (int): The number of top results to return.
            info (dict): Leave a record of memory consumption.
            mode (str, optional): The mode of the search.
            - 'fast': Uses a faster search process, sacrificing some precision for speed.
            - 'fine': Uses a more detailed search process, invoking large models for higher precision, but slower performance.
            memory_type (str): Type restriction for search.
            ['All', 'WorkingMemory', 'LongTermMemory', 'UserMemory']
            search_filter (dict, optional): Optional metadata filters for search results.
        Returns:
            list[TextualMemoryItem]: List of matching memories.
        """</span>
        logger.info(
            <span class="hljs-string">f"[SEARCH] Start query='<span class="hljs-subst">{query}</span>', top_k=<span class="hljs-subst">{top_k}</span>, mode=<span class="hljs-subst">{mode}</span>, memory_type=<span class="hljs-subst">{memory_type}</span>"</span>
        )
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> info:
            logger.warning(
                <span class="hljs-string">"Please input 'info' when use tree.search so that "</span>
                <span class="hljs-string">"the database would store the consume history."</span>
            )
            info = {<span class="hljs-string">"user_id"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"session_id"</span>: <span class="hljs-string">""</span>}
        <span class="hljs-keyword">else</span>:
            logger.debug(<span class="hljs-string">f"[SEARCH] Received info dict: <span class="hljs-subst">{info}</span>"</span>)
​
        parsed_goal, query_embedding, context, query = self._parse_task(
            query, info, mode, search_filter=search_filter
        )
        results = self._retrieve_paths(
            query, parsed_goal, query_embedding, info, top_k, mode, memory_type, search_filter
        )
        deduped = self._deduplicate_results(results)
        final_results = self._sort_and_trim(deduped, top_k)
        self._update_usage_history(final_results, info)
​
        logger.info(<span class="hljs-string">f"[SEARCH] Done. Total <span class="hljs-subst">{<span class="hljs-built_in">len</span>(final_results)}</span> results."</span>)
        res_results = <span class="hljs-string">""</span>
        <span class="hljs-keyword">for</span> _num_i, result <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(final_results):
            res_results += <span class="hljs-string">"\n"</span> + (
                result.<span class="hljs-built_in">id</span> + <span class="hljs-string">"|"</span> + result.metadata.memory_type + <span class="hljs-string">"|"</span> + result.memory
            )
        logger.info(<span class="hljs-string">f"[SEARCH] Results. <span class="hljs-subst">{res_results}</span>"</span>)
        <span class="hljs-keyword">return</span> final_results
</code></pre>
<h4 data-id="heading-6">2.3 依赖关系和关联关系</h4>
<h5 data-id="heading-7">2.3.1 依赖项（Searcher 依赖的组件）</h5>
<p>Searcher 依赖的组件如下：</p>
<ul>
<li>
<p>大语言模型组件：</p>
<ul>
<li>dispatcher_llm – 用于任务解析和推理</li>
<li>TaskGoalParser – 将用户查询解析为结构化目标</li>
</ul>
</li>
<li>
<p>存储组件：</p>
<ul>
<li>graph_store – Neo4j 图数据库用于存储记忆</li>
<li>GraphMemoryRetriever – 从图存储中检索记忆</li>
</ul>
</li>
<li>
<p>处理组件：</p>
<ul>
<li>embedder – 为查询和记忆创建嵌入向量</li>
<li>reranker – 对检索结果进行重新排序</li>
<li>MemoryReasoner – 对检索到的记忆进行推理</li>
<li>internet_retriever – 可选的互联网搜索功能</li>
</ul>
</li>
</ul>
<h5 data-id="heading-8">2.3.2 依赖 Searcher 的组件</h5>
<p>依赖 Searcher 的组件如下：</p>
<ul>
<li>TreeTextMemory – 在其 search 方法中使用 Searcher</li>
<li>GeneralScheduler – 通过检索器在 process_session_turn 中使用 Searcher</li>
</ul>
<h4 data-id="heading-9">2.4 图例</h4>
<p>Searcher 被调度器系统用于在查询处理过程中检索相关记忆，总的来说，Searcher 充当一个中央协调者，将各种组件整合在一起，为跨不同记忆源和外部数据提供全面的检索能力。</p>
<h5 data-id="heading-10">2.4.1 Searcher 组件关系流程图</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4d979d43803436495c2d5112601d62b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765801901&amp;x-signature=ASPi6KA1T8DHkJmZVPlKSM71oLY%3D" alt="Searcher 组件关系流程图" loading="lazy"/></p>
<h5 data-id="heading-11">2.4.2 Searcher 详细搜索过程流程</h5>
<p>用户查询 → TaskGoalParser 解析 → 多路径并行检索 → 结果重排序 → 去重处理 → 推理优化 → 返回最终结果。</p>
<p>各组件详细说明</p>
<p><strong>主要阶段</strong></p>
<ul>
<li>任务解析：使用 TaskGoalParser 解析查询，根据模式决定是否使用 LLM</li>
<li>并行检索：同时执行多个检索路径</li>
<li>结果重排：使用 Reranker 对各路径的结果进行重排</li>
<li>合并去重：合并所有路径的结果并去除重复项</li>
<li>排序截取：按分数排序并截取前 K 个结果</li>
<li>更新记录：更新使用历史记录</li>
</ul>
<p><strong>并行检索路径</strong></p>
<ul>
<li>路径 A：工作内存检索 (WorkingMemory)</li>
<li>路径 B：长期和用户内存检索 (LongTermMemory, UserMemory)</li>
<li>路径 C：互联网检索（可选）</li>
<li>路径 D：MemCubes 检索（可选）</li>
</ul>
<p><strong>数据流向</strong>：输入查询经过解析后，被分发到多个检索路径并行处理，每个路径都会产生一批候选结果。这些结果经过重排、合并，最后经过去重、排序和截取得到最终结果。整个过程中还会更新使用历史记录以便后续优化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01aba941f206483ebb9f8f10fe53633e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765801901&amp;x-signature=rNFzz9A6wN2jeY0MUyhnQVm5i%2Fg%3D" alt="Searcher 详细搜索过程流程" loading="lazy"/></p>
<p>用户搜索流程如下：用户查询 → TaskGoalParser 解析 → 多路径并行检索 → 结果重排序 → 去重处理 → 推理优化 → 返回最终结果。</p>
<p>其中涉及到如下组件：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f081aae6b54641a4b2bfad88d3a3de0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765801901&amp;x-signature=DgjU47dG3RRzhr9mIOuKkwe15Nc%3D" alt="搜索流程" loading="lazy"/></p>
<p>因此，我们按照如下流程进行分析。</p>
<h4 data-id="heading-12">2.5 TaskGoalParser</h4>
<p>_parse_task 方法主要是使用 TaskGoalParser 来分析query。</p>
<pre><code class="hljs language-ini" lang="ini">        <span class="hljs-attr">parsed_goal</span> = self.task_goal_parser.parse(
            <span class="hljs-attr">task_description</span>=query,
            <span class="hljs-attr">context</span>=<span class="hljs-string">"\n"</span>.join(context),
            <span class="hljs-attr">conversation</span>=info.get(<span class="hljs-string">"chat_history"</span>, []),
            <span class="hljs-attr">mode</span>=mode,
        )
</code></pre>
<p>TaskGoalParser 是一个任务目标解析器，负责将用户的自然语言查询解析为结构化的语义层表示，以便后续的检索系统能够更有效地理解和处理查询。</p>
<h5 data-id="heading-13">2.5.1 主要功能</h5>
<p>TaskGoalParser 主要功能为：</p>
<ul>
<li>
<p>查询解析。</p>
<ul>
<li>将用户输入的自然语言查询转换为结构化的查询表示</li>
<li>提供两种解析模式：快速模式（fast）和精细模式（fine）</li>
</ul>
</li>
<li>
<p>结构化语义表示</p>
<ul>
<li>将查询分解为多个语义层次：主题（topic）、关键词（keys）、标签（tags）等 提取查询的核心意图和相关信息</li>
</ul>
</li>
</ul>
<h5 data-id="heading-14">2.5.2 工作模式</h5>
<h6 data-id="heading-15">Fast 模式</h6>
<pre><code class="hljs language-ini" lang="ini">def _parse_fast(self, task_description: str, limit_num: <span class="hljs-attr">int</span> = <span class="hljs-number">5</span>) -&gt; ParsedTaskGoal:
    <span class="hljs-comment"># 快速模式：简单的分词处理</span>
    return ParsedTaskGoal(
        <span class="hljs-attr">memories</span>=[task_description],
        <span class="hljs-attr">keys</span>=[task_description],
        <span class="hljs-attr">tags</span>=[],
        <span class="hljs-attr">goal_type</span>=<span class="hljs-string">"default"</span>,
        <span class="hljs-attr">rephrased_query</span>=task_description,
        <span class="hljs-attr">internet_search</span>=<span class="hljs-literal">False</span>,
</code></pre>
<h6 data-id="heading-16">Fine 模式</h6>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_parse_fine</span>(<span class="hljs-params">
    self, query: <span class="hljs-built_in">str</span>, context: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>, conversation: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>
</span>) -&gt; ParsedTaskGoal:
    <span class="hljs-comment"># 精细模式：使用 LLM 进行结构化解析</span>
    <span class="hljs-comment"># 构建提示词并调用 LLM 进行解析</span>
    prompt = Template(TASK_PARSE_PROMPT).substitute(
        task=query.strip(), context=context, conversation=conversation_prompt
    )
    response = self.llm.generate(messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}])
    <span class="hljs-keyword">return</span> self._parse_response(response)
</code></pre>
<h5 data-id="heading-17">2.5.3 输出结构</h5>
<p>TaskGoalParser 解析后的结果存储在 ParsedTaskGoal 对象中，包含以下字段：</p>
<ul>
<li>memories：相关记忆项列表</li>
<li>keys：关键词列表</li>
<li>tags：标签列表</li>
<li>rephrased_query：重述的查询（更清晰的表达）</li>
<li>internet_search：是否需要联网搜索</li>
<li>goal_type：目标类型</li>
</ul>
<h5 data-id="heading-18">2.5.4 prompt</h5>
<pre><code class="hljs language-python" lang="python">TASK_PARSE_PROMPT = <span class="hljs-string">"""
You are a task parsing expert. Given a user task instruction, optional former conversation and optional related memory context,extract the following structured information:
1. Keys: the high-level keywords directly relevant to the user’s task.
2. Tags: thematic tags to help categorize and retrieve related memories.
3. Goal Type: retrieval | qa | generation
4. Rephrased instruction: Give a rephrased task instruction based on the former conversation to make it less confusing to look alone. If you think the task instruction is easy enough to understand, or there is no former conversation, set "rephrased_instruction" to an empty string.
5. Need for internet search: If the user's task instruction only involves objective facts or can be completed without introducing external knowledge, set "internet_search" to False. Otherwise, set it to True.
6. Memories: Provide 2–5 short semantic expansions or rephrasings of the rephrased/original user task instruction. These are used for improved embedding search coverage. Each should be clear, concise, and meaningful for retrieval.
​
Former conversation (if any):
"""</span>
$conversation
<span class="hljs-string">"""
​
Task description(User Question):
"""</span>$task<span class="hljs-string">"""
​
Context (if any):
"""</span>$context<span class="hljs-string">"""
​
Return strictly in this JSON format, note that the
keys/tags/rephrased_instruction/memories should use the same language as the
input query:
{
  "keys": [...],
  "tags": [...],
  "goal_type": "retrieval | qa | generation",
  "rephrased_instruction": "...", # return an empty string if the original instruction is easy enough to understand
  "internet_search": True/False,
  "memories": ["...", "...", ...]
}
"""</span>
</code></pre>
<h5 data-id="heading-19">2.5.5 优势</h5>
<p>总的来说，TaskGoalParser 在记忆检索系统中扮演着“查询理解器”的角色，通过解析用户查询为结构化表示，为后续的检索和推理过程提供更精确的输入。其优势为：</p>
<ul>
<li>灵活性：支持两种解析模式，适应不同性能和精度需求</li>
<li>结构化：将自然语言查询转换为结构化表示，便于后续处理</li>
<li>上下文感知：在精细模式下可以考虑上下文和对话历史</li>
<li>错误处理：当精细模式失败时会回退到快速模式</li>
</ul>
<h4 data-id="heading-20">2.6 GraphMemoryRetriever</h4>
<p>GraphMemoryRetriever 是一个统一的记忆检索器，结合了图结构检索和向量相似性检索两种方式，用于从知识图谱中检索相关记忆项。</p>
<h5 data-id="heading-21">2.6.1 主要功能</h5>
<p>GraphMemoryRetriever 实现混合检索，这种设计使得系统既能利用结构化信息进行精确检索，又能通过向量相似性捕获语义相关的内容，从而提高了检索的准确性和召回率。</p>
<ul>
<li>
<p>混合检索机制</p>
<ul>
<li>结构化图检索：基于解析后的任务目标（keys/tags）进行精确匹配</li>
<li>向量相似性检索：基于查询嵌入进行语义相似度搜索</li>
<li>合并两种检索结果并去重</li>
</ul>
</li>
<li>
<p>多范围记忆检索</p>
<ul>
<li>支持不同类型的记忆范围：WorkingMemory、LongTermMemory、UserMemory</li>
<li>针对不同范围采用不同的检索策略</li>
</ul>
</li>
</ul>
<h5 data-id="heading-22">2.6.2 核心方法</h5>
<ul>
<li>
<p>retrieve 方法：这是主要的检索入口，执行以下步骤：</p>
<ul>
<li>对于 WorkingMemory，直接获取所有条目；</li>
<li>对于其他记忆类型，同时执行 _graph_recall 和 _vector_recall；</li>
<li>合并结果并去除重复项。</li>
</ul>
</li>
<li>
<p>_graph_recall 方法：执行基于图结构的检索：</p>
<ul>
<li>基于 keys 进行精确匹配检索；</li>
<li>基于 tags 进行包含匹配检索；</li>
<li>对候选结果进行后过滤，确保至少有 2 个标签重叠。</li>
</ul>
</li>
<li>
<p>_vector_recall 方法：执行基于向量的相似性检索：</p>
<ul>
<li>使用查询嵌入在图数据库中搜索最相似的记忆项；</li>
<li>支持带过滤条件的搜索和不带过滤条件的搜索路径；</li>
<li>并发执行多个搜索任务以提高效率。</li>
</ul>
</li>
<li>
<p>retrieve_from_cube 方法：专门用于从特定的 cube 中检索记忆项，这在多租户或分片场景中很有用。</p>
</li>
</ul>
<h5 data-id="heading-23">2.6.3 工作流程总结</h5>
<ul>
<li>接收用户查询和解析后的任务目标</li>
<li>并行执行图结构检索和向量检索</li>
<li>合并两种检索结果</li>
<li>去除重复项并返回最终结果</li>
</ul>
<h4 data-id="heading-24">2.7 Reranker</h4>
<p>使用 CosineLocalReranker 做解析。CosineLocalReranker 是一个本地实现的重排序器，它使用余弦相似度算法对检索到的记忆项进行重新排序，以提高检索结果的相关性。</p>
<h5 data-id="heading-25">2.7.1 主要功能</h5>
<p>主要功能是余弦相似度计算</p>
<ul>
<li>计算查询向量与候选记忆项向量之间的余弦相似度</li>
<li>支持单个查询向量与多个候选向量的同时计算</li>
</ul>
<h5 data-id="heading-26">2.7.2 工作流程总结</h5>
<ul>
<li>接收来自 GraphMemoryRetriever 的初步检索结果</li>
<li>获取查询的嵌入向量和候选记忆项的嵌入向量</li>
<li>计算查询向量与每个候选向量的余弦相似度</li>
<li>根据记忆项的层级类型应用相应权重</li>
<li>按照加权相似度分数对结果进行排序</li>
<li>返回前 K 个最相关的结果给下一个处理阶段</li>
</ul>
<p>这种设计使得系统能够在本地快速完成重排序操作，而无需依赖外部服务，同时通过层级权重机制可以优先考虑某些类型的记忆项，从而提高检索结果的质量。</p>
<h4 data-id="heading-27">2.8 MemoryReasoner</h4>
<p>MemoryReasoner 是一个专门负责对检索到的记忆项进行推理和知识综合的组件。它的主要职责是对从不同来源检索到的记忆进行分析、筛选和优化，从而提供更精确和相关的记忆结果。</p>
<h5 data-id="heading-28">2.8.1 主要功能</h5>
<ul>
<li>
<p>记忆推理与综合</p>
<ul>
<li>接收原始查询和已检索的相关记忆项</li>
<li>利用大型语言模型分析多个检索到的记忆项</li>
<li>根据用户的查询目标综合相关信息</li>
<li>生成更加精确和相关的记忆响应</li>
</ul>
</li>
</ul>

<ul>
<li>
<p>智能筛选</p>
<ul>
<li>通过 LLM 判断哪些记忆项与当前查询最相关</li>
<li>只返回经过筛选的相关记忆项</li>
</ul>
</li>
</ul>
<h5 data-id="heading-29">2.8.2 核心方法</h5>
<p>reason 是主要的推理方法，执行以下步骤：</p>
<ul>
<li>
<p>构建提示词：</p>
<ul>
<li>使用模板 REASON_PROMPT 构建推理提示词</li>
<li>将检索到的记忆项格式化为字符串列表</li>
</ul>
</li>
<li>
<p>调用 LLM：</p>
<ul>
<li>将构建好的提示词发送给语言模型生成响应</li>
</ul>
</li>
<li>
<p>解析响应：</p>
<ul>
<li>提取模型选择的记忆项 ID</li>
<li>返回对应的记忆项列表</li>
</ul>
</li>
</ul>
<p>parse_selected_ids 方法负责从模型响应中提取选定的记忆项 ID：</p>
<ul>
<li>JSON 解析：首先尝试将响应解析为 JSON 格式</li>
<li>正则表达式回退：如果 JSON 解析失败，则使用正则表达式匹配 UUID 格式的 ID</li>
</ul>
<h5 data-id="heading-30">2.8.3 提示词</h5>
<pre><code class="hljs language-css" lang="css">REASON_PROMPT = """
You are <span class="hljs-selector-tag">a</span> reasoning agent working with <span class="hljs-selector-tag">a</span> memory system. You will synthesize knowledge <span class="hljs-selector-tag">from</span> multiple memory cards <span class="hljs-selector-tag">to</span> construct <span class="hljs-selector-tag">a</span> meaningful response <span class="hljs-selector-tag">to</span> the task below.
​
Task: ${task}
​
Memory cards (with metadata):
${detailed_memory_list}
​
Please perform:
<span class="hljs-number">1</span>. Clustering by theme (topic/concept/fact)
<span class="hljs-number">2</span>. Identify useful chains or connections
<span class="hljs-number">3</span>. Return a curated list of memory card IDs with reasons.
​
Output in JSON:
{
  "selected_ids": [...],
  <span class="hljs-string">"explanation"</span>: <span class="hljs-string">"..."</span>
}
"""
</code></pre>
<h5 data-id="heading-31">2.8.4 工作流程总结</h5>
<ul>
<li>
<p>接收来自上一阶段的检索和重排序结果</p>
</li>
<li>
<p>构建推理提示词：</p>
<ul>
<li>将用户的查询、解析后的任务目标以及检索到的记忆项组合成一个结构化的提示词</li>
<li>使用预定义的 REASON_PROMPT 模板</li>
</ul>
</li>
<li>
<p>调用 LLM 进行推理：</p>
<ul>
<li>将构建好的提示词发送给大型语言模型</li>
<li>使用 LLM 进一步分析和推理这些记忆项的相关性</li>
<li>获取模型的响应，该响应包含对记忆项的相关性判断</li>
</ul>
</li>
<li>
<p>解析和筛选结果：</p>
<ul>
<li>
<p>解析 LLM 的响应，提取被选中的记忆项 ID</p>
</li>
<li>
<p>支持两种解析方式：</p>
<ul>
<li>JSON 格式：直接提取 selected_ids 字段</li>
<li>文本格式：通过正则表达式匹配 UUID 模式</li>
</ul>
</li>
</ul>
</li>
<li>
<p>返回精选记忆：</p>
<ul>
<li>根据解析出的 ID 列表筛选原始记忆项</li>
<li>返回最相关的结果子集</li>
</ul>
</li>
</ul>
<p>这种设计使得系统能够利用 LLM 的理解和推理能力，从大量检索到的记忆中选出最符合用户需求的部分，提高了系统的准确性和智能化水平。</p>
<h5 data-id="heading-32">2.8.5 优势</h5>
<ul>
<li>智能化处理：利用 LLM 的理解能力对记忆项进行语义层面的分析</li>
<li>灵活性：支持多种输出格式的解析</li>
<li>精准性：能够进一步提升检索结果的相关性和质量</li>
</ul>
<p>总的来说，MemoryReasoner 在整个记忆检索系统中扮演着“智能筛选器”的角色，通过引入 LLM 的推理能力，使系统能够更准确地理解用户需求并返回最相关的记忆项。</p>
<h4 data-id="heading-33">2.9 Reranker 和 Reasoner</h4>
<p>在系统中同时使用 Reranker 和 Reasoner 是为了实现不同层次的检索结果处理和优化，它们各自承担不同的职责。</p>
<h5 data-id="heading-34">2.9.1 Reranker 的作用</h5>
<p>Reranker（重排序器）主要负责对初步检索结果进行相关性重新排序：</p>
<ul>
<li>功能：基于查询和候选结果的相似度计算，对检索结果进行重新排序</li>
<li>方法：通常使用数学计算（如余弦相似度）来评估相关性</li>
<li>输出：返回按相关性得分排序的记忆项列表</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">def rerank(self, query, graph_results, top_k, **kwargs):
    <span class="hljs-comment"># 计算相似度</span>
    <span class="hljs-attr">sims</span> = _cosine_one_to_many(query_embedding, cand_vecs)
    <span class="hljs-comment"># 应用权重调整</span>
    <span class="hljs-attr">weighted</span> = [sim * get_weight(it) for sim, it in zip(sims, items_with_emb)]
    <span class="hljs-comment"># 排序并返回前 K 个结果</span>
    scored_pairs.sort(<span class="hljs-attr">key</span>=lambda x: x[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">True</span>)
    return scored_pairs<span class="hljs-section">[:top_k]</span>
</code></pre>
<h5 data-id="heading-35">2.9.2 Reasoner 的作用</h5>
<p>Reasoner（推理器）主要负责对排序后的结果进行语义理解和推理：</p>
<ul>
<li>功能：基于语言模型对检索到的记忆项进行语义理解和推理</li>
<li>方法：使用大语言模型分析查询和记忆项之间的深层语义关系</li>
<li>输出：返回经过语义推理筛选后的最终记忆项</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">def reason(self, query, ranked_memories, parsed_goal):
    <span class="hljs-comment"># 构建推理提示</span>
    <span class="hljs-attr">prompt</span> = prompt_template.substitute(task=query, detailed_memory_list=memory_detailed_str)
    <span class="hljs-comment"># 使用 LLM 进行推理</span>
    <span class="hljs-attr">response</span> = self.llm.generate([{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}])
    <span class="hljs-comment"># 解析并返回推理结果</span>
    <span class="hljs-attr">selected_ids</span> = self._parse_selected_ids(content)
    return <span class="hljs-section">[m for m in ranked_memories if m.id in id_set]</span>
</code></pre>
<h5 data-id="heading-36">2.9.3 为什么需要两者结合？</h5>
<ol start="0">
<li>不同的处理层次</li>
</ol>
<p>Reranker：在数学向量空间中进行快速相关性计算</p>
<p>Reasoner：在语义层面进行深度理解和推理</p>
<ol start="2">
<li>
<p>互补的优势</p>
<p>效率 vs 精度：Reranker 快速筛选，Reasoner 精确推理</p>
<p>定量 vs 定性：Reranker 基于数值计算，Reasoner 基于语义理解</p>
</li>
</ol>
<p>系统设计优势</p>
<ul>
<li>
<p>性能优化：避免直接对大量候选结果使用昂贵的 LLM 推理</p>
</li>
<li>
<p>精度提升：先用数学方法粗筛，再用语义方法精筛</p>
</li>
<li>
<p>模块化设计：两个组件职责分明，便于独立优化和替换</p>
</li>
<li>
<p>适应不同场景：</p>
<ul>
<li>快速模式：可能只使用 Reranker</li>
<li>精细模式：两者都使用以获得最佳结果</li>
</ul>
</li>
</ul>
<p>这种设计使得系统既能在保证检索质量的同时控制计算成本，又能根据不同的应用场景灵活调整处理流程。</p>
<h5 data-id="heading-37">2.9.4 具体示例</h5>
<p>假设用户查询：“机器学习中的梯度下降算法如何工作？”</p>
<ul>
<li>
<p>初始检索：系统可能检索到 100 个相关记忆项</p>
</li>
<li>
<p>Reranker 处理：</p>
<ul>
<li>计算查询与每个记忆项的余弦相似度</li>
<li>根据层级权重（topic/concept/fact）调整得分</li>
<li>返回前 20 个最相关的记忆项</li>
</ul>
</li>
<li>
<p>Reasoner 处理：</p>
<ul>
<li>将前 20 个记忆项和查询一起交给 LLM</li>
<li>LLM 分析哪些记忆项真正回答了用户的问题</li>
<li>可能发现只有其中 5 个记忆项真正相关且互补</li>
<li>返回这 5 个最合适的记忆项</li>
</ul>
</li>
</ul>
<h3 data-id="heading-38">0x03 子图检索</h3>
<h4 data-id="heading-39">3.1 功能</h4>
<p>get_relevant_subgraph方法的功能是：</p>
<ul>
<li>
<p>查找与查询相关的局部子图（Find Relevant Local Subgraph）</p>
<ul>
<li>接收用户查询字符串作为输入</li>
<li>通过嵌入模型将查询转换为向量表示</li>
<li>在图数据库中搜索与查询向量最相似的前k个节点</li>
</ul>
</li>
</ul>

<ul>
<li>
<p>构建邻域子图（Build Neighborhood Subgraphs），对每个相似节点：</p>
<ul>
<li>确保其状态符合指定条件（默认为"activated"）</li>
<li>获取以该节点为中心、指定深度（默认2跳）的局部子图</li>
<li>收集中心节点、邻居节点和连接边</li>
</ul>
</li>
</ul>

<ul>
<li>
<p>合并多个子图为统一结构（Merge Subgraphs）</p>
<ul>
<li>
<p>将所有检索到的局部子图合并成一个连通的子图</p>
</li>
<li>
<p>去除重复节点和边</p>
</li>
<li>
<p>返回包含以下信息的字典结构：</p>
<ul>
<li>core_id: 最匹配的核心节点ID</li>
<li>nodes: 合并后的唯一节点列表</li>
<li>edges: 合并后的唯一边列表</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>这种方法特别适用于需要理解复杂关系和上下文的场景，比如：</p>
<ul>
<li>查找与特定主题相关的知识网络片段</li>
<li>进行多跳推理以发现间接关联</li>
<li>提供可解释的记忆检索结果，展示节点间的关系路径</li>
</ul>
<p>主要优势在于它不仅返回相关节点，还保留了它们之间的语义关系结构，这对于高级推理任务非常有用。</p>
<h4 data-id="heading-40">3.2 代码</h4>
<p>具体代码如下：</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_relevant_subgraph</span>(<span class="hljs-params">
        self, query: <span class="hljs-built_in">str</span>, top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span>, depth: <span class="hljs-built_in">int</span> = <span class="hljs-number">2</span>, center_status: <span class="hljs-built_in">str</span> = <span class="hljs-string">"activated"</span>
    </span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">"""
        Find and merge the local neighborhood sub-graphs of the top-k
        nodes most relevant to the query.
         Process:
             1. Embed the user query into a vector representation.
             2. Use vector similarity search to find the top-k similar nodes.
             3. For each similar node:
                 - Ensure its status matches `center_status` (e.g., 'active').
                 - Retrieve its local subgraph up to `depth` hops.
                 - Collect the center node, its neighbors, and connecting edges.
             4. Merge all retrieved subgraphs into a single unified subgraph.
             5. Return the merged subgraph structure.
​
         Args:
             query (str): The user input or concept to find relevant memories for.
             top_k (int, optional): How many top similar nodes to retrieve. Default is 5.
             depth (int, optional): The neighborhood depth (number of hops). Default is 2.
             center_status (str, optional): Status condition the center node must satisfy (e.g., 'active').
​
         Returns:
             dict[str, Any]: A subgraph dict with:
                 - 'core_id': ID of the top matching core node, or None if none found.
                 - 'nodes': List of unique nodes (core + neighbors) in the merged subgraph.
                 - 'edges': List of unique edges (as dicts with 'from', 'to', 'type') in the merged subgraph.
        """</span>
        <span class="hljs-comment"># Step 1: Embed query</span>
        query_embedding = self.embedder.embed([query])[<span class="hljs-number">0</span>]
​
        <span class="hljs-comment"># Step 2: Get top-1 similar node</span>
        similar_nodes = self.graph_store.search_by_embedding(query_embedding, top_k=top_k)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> similar_nodes:
            logger.info(<span class="hljs-string">"No similar nodes found for query embedding."</span>)
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"core_id"</span>: <span class="hljs-literal">None</span>, <span class="hljs-string">"nodes"</span>: [], <span class="hljs-string">"edges"</span>: []}
​
        <span class="hljs-comment"># Step 3: Fetch neighborhood</span>
        all_nodes = {}
        all_edges = <span class="hljs-built_in">set</span>()
        cores = []
​
        <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> similar_nodes:
            core_id = node[<span class="hljs-string">"id"</span>]
            score = node[<span class="hljs-string">"score"</span>]
​
            subgraph = self.graph_store.get_subgraph(
                center_id=core_id, depth=depth, center_status=center_status
            )
​
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> subgraph[<span class="hljs-string">"core_node"</span>]:
                logger.info(<span class="hljs-string">f"Skipping node <span class="hljs-subst">{core_id}</span> (inactive or not found)."</span>)
                <span class="hljs-keyword">continue</span>
​
            core_node = subgraph[<span class="hljs-string">"core_node"</span>]
            neighbors = subgraph[<span class="hljs-string">"neighbors"</span>]
            edges = subgraph[<span class="hljs-string">"edges"</span>]
​
            <span class="hljs-comment"># Collect nodes</span>
            all_nodes[core_node[<span class="hljs-string">"id"</span>]] = core_node
            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> neighbors:
                all_nodes[n[<span class="hljs-string">"id"</span>]] = n
​
            <span class="hljs-comment"># Collect edges</span>
            <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> edges:
                all_edges.add((e[<span class="hljs-string">"source"</span>], e[<span class="hljs-string">"target"</span>], e[<span class="hljs-string">"type"</span>]))
​
            cores.append(
                {<span class="hljs-string">"id"</span>: core_id, <span class="hljs-string">"score"</span>: score, <span class="hljs-string">"core_node"</span>: core_node, <span class="hljs-string">"neighbors"</span>: neighbors}
            )
​
        top_core = cores[<span class="hljs-number">0</span>]
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"core_id"</span>: top_core[<span class="hljs-string">"id"</span>],
            <span class="hljs-string">"nodes"</span>: <span class="hljs-built_in">list</span>(all_nodes.values()),
            <span class="hljs-string">"edges"</span>: [{<span class="hljs-string">"source"</span>: f, <span class="hljs-string">"target"</span>: t, <span class="hljs-string">"type"</span>: ty} <span class="hljs-keyword">for</span> (f, t, ty) <span class="hljs-keyword">in</span> all_edges],
        }
</code></pre>
<h3 data-id="heading-41">0x04 图数据库</h3>
<p>因为图数据库比较复杂，我们通过示例来进行学习，以管窥豹。</p>
<h4 data-id="heading-42">4.1 示例</h4>
<p>run_user_session 函数中便有搜索内容。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_user_session</span>(<span class="hljs-params">
    user_name: <span class="hljs-built_in">str</span>,
    db_name: <span class="hljs-built_in">str</span>,
    topic_text: <span class="hljs-built_in">str</span>,
    concept_texts: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
    fact_texts: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n=== <span class="hljs-subst">{user_name}</span> starts building their memory graph ==="</span>)
​
    <span class="hljs-comment"># Manually initialize correct GraphDB class</span>
    config = GraphDBConfigFactory(
        backend=<span class="hljs-string">"nebular"</span>,
        config={
            <span class="hljs-string">"uri"</span>: json.loads(os.getenv(<span class="hljs-string">"NEBULAR_HOSTS"</span>, <span class="hljs-string">"localhost"</span>)),
            <span class="hljs-string">"user"</span>: os.getenv(<span class="hljs-string">"NEBULAR_USER"</span>, <span class="hljs-string">"root"</span>),
            <span class="hljs-string">"password"</span>: os.getenv(<span class="hljs-string">"NEBULAR_PASSWORD"</span>, <span class="hljs-string">"xxxxxx"</span>),
            <span class="hljs-string">"space"</span>: db_name,
            <span class="hljs-string">"user_name"</span>: user_name,
            <span class="hljs-string">"use_multi_db"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"auto_create"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"embedding_dimension"</span>: embedder_dimension,
        },
    )
    graph = GraphStoreFactory.from_config(config)
​
    <span class="hljs-comment"># Start with a clean slate for this user</span>
    graph.clear()
​
    now = datetime.now(timezone.utc).isoformat()
​
    <span class="hljs-comment"># === Step 1: Create a root topic node (e.g., user's research focus) ===</span>
    topic = TextualMemoryItem(
        memory=topic_text,
        metadata=TreeNodeTextualMemoryMetadata(
            memory_type=<span class="hljs-string">"LongTermMemory"</span>,
            key=<span class="hljs-string">"Research Topic"</span>,
            hierarchy_level=<span class="hljs-string">"topic"</span>,
            <span class="hljs-built_in">type</span>=<span class="hljs-string">"fact"</span>,
            memory_time=<span class="hljs-string">"2024-01-01"</span>,
            status=<span class="hljs-string">"activated"</span>,
            visibility=<span class="hljs-string">"public"</span>,
            tags=[<span class="hljs-string">"research"</span>, <span class="hljs-string">"rl"</span>],
            updated_at=now,
            embedding=embed_memory_item(topic_text),
        ),
    )
    graph.add_node(topic.<span class="hljs-built_in">id</span>, topic.memory, topic.metadata.model_dump(exclude_none=<span class="hljs-literal">True</span>))
​
    <span class="hljs-comment"># === Step 2: Create two concept nodes linked to the topic ===</span>
    concept_items = []
    <span class="hljs-keyword">for</span> i, text <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(concept_texts):
        concept = TextualMemoryItem(
            memory=text,
            metadata=TreeNodeTextualMemoryMetadata(
                memory_type=<span class="hljs-string">"LongTermMemory"</span>,
                key=<span class="hljs-string">f"Concept <span class="hljs-subst">{i + <span class="hljs-number">1</span>}</span>"</span>,
                hierarchy_level=<span class="hljs-string">"concept"</span>,
                <span class="hljs-built_in">type</span>=<span class="hljs-string">"fact"</span>,
                memory_time=<span class="hljs-string">"2024-01-01"</span>,
                status=<span class="hljs-string">"activated"</span>,
                visibility=<span class="hljs-string">"public"</span>,
                updated_at=now,
                embedding=embed_memory_item(text),
                tags=[<span class="hljs-string">"concept"</span>],
                confidence=<span class="hljs-number">90</span> + i,
            ),
        )
        graph.add_node(concept.<span class="hljs-built_in">id</span>, concept.memory, concept.metadata.model_dump(exclude_none=<span class="hljs-literal">True</span>))
        graph.add_edge(topic.<span class="hljs-built_in">id</span>, concept.<span class="hljs-built_in">id</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">"PARENT"</span>)
        concept_items.append(concept)
​
    <span class="hljs-comment"># === Step 3: Create supporting facts under each concept ===</span>
    <span class="hljs-keyword">for</span> i, text <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(fact_texts):
        fact = TextualMemoryItem(
            memory=text,
            metadata=TreeNodeTextualMemoryMetadata(
                memory_type=<span class="hljs-string">"WorkingMemory"</span>,
                key=<span class="hljs-string">f"Fact <span class="hljs-subst">{i + <span class="hljs-number">1</span>}</span>"</span>,
                hierarchy_level=<span class="hljs-string">"fact"</span>,
                <span class="hljs-built_in">type</span>=<span class="hljs-string">"fact"</span>,
                memory_time=<span class="hljs-string">"2024-01-01"</span>,
                status=<span class="hljs-string">"activated"</span>,
                visibility=<span class="hljs-string">"public"</span>,
                updated_at=now,
                embedding=embed_memory_item(text),
                confidence=<span class="hljs-number">85.0</span>,
                tags=[<span class="hljs-string">"fact"</span>],
            ),
        )
        graph.add_node(fact.<span class="hljs-built_in">id</span>, fact.memory, fact.metadata.model_dump(exclude_none=<span class="hljs-literal">True</span>))
        graph.add_edge(concept_items[i % <span class="hljs-built_in">len</span>(concept_items)].<span class="hljs-built_in">id</span>, fact.<span class="hljs-built_in">id</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">"PARENT"</span>)
​
    <span class="hljs-comment"># === Step 4: Retrieve memory using semantic search ===</span>
    vector = embed_memory_item(<span class="hljs-string">"How is memory retrieved?"</span>)
    search_result = graph.search_by_embedding(vector, top_k=<span class="hljs-number">2</span>)
    <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> search_result:
        node = graph.get_node(r[<span class="hljs-string">"id"</span>])
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"🔍 Search result:"</span>, node[<span class="hljs-string">"memory"</span>])
​
    <span class="hljs-comment"># === Step 5: Tag-based neighborhood discovery ===</span>
    neighbors = graph.get_neighbors_by_tag([<span class="hljs-string">"concept"</span>], exclude_ids=[], top_k=<span class="hljs-number">2</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📎 Tag-related nodes:"</span>, [neighbor[<span class="hljs-string">"memory"</span>] <span class="hljs-keyword">for</span> neighbor <span class="hljs-keyword">in</span> neighbors])
​
    <span class="hljs-comment"># === Step 6: Retrieve children (facts) of first concept ===</span>
    children = graph.get_children_with_embeddings(concept_items[<span class="hljs-number">0</span>].<span class="hljs-built_in">id</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📍 Children of concept:"</span>, [child[<span class="hljs-string">"memory"</span>] <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> children])
​
    <span class="hljs-comment"># === Step 7: Export a local subgraph and grouped statistics ===</span>
    subgraph = graph.get_subgraph(topic.<span class="hljs-built_in">id</span>, depth=<span class="hljs-number">2</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📌 Subgraph node count:"</span>, <span class="hljs-built_in">len</span>(subgraph[<span class="hljs-string">"neighbors"</span>]))
​
    stats = graph.get_grouped_counts([<span class="hljs-string">"memory_type"</span>, <span class="hljs-string">"status"</span>])
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📊 Grouped counts:"</span>, stats)
​
    <span class="hljs-comment"># === Step 8: Demonstrate updates and cleanup ===</span>
    graph.update_node(
        concept_items[<span class="hljs-number">0</span>].<span class="hljs-built_in">id</span>, {<span class="hljs-string">"confidence"</span>: <span class="hljs-number">99.0</span>, <span class="hljs-string">"created_at"</span>: <span class="hljs-string">"2025-07-24T20:11:56.375687"</span>}
    )
    graph.remove_oldest_memory(<span class="hljs-string">"WorkingMemory"</span>, keep_latest=<span class="hljs-number">1</span>)
    graph.delete_edge(topic.<span class="hljs-built_in">id</span>, concept_items[<span class="hljs-number">0</span>].<span class="hljs-built_in">id</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">"PARENT"</span>)
    graph.delete_node(concept_items[<span class="hljs-number">1</span>].<span class="hljs-built_in">id</span>)
​
    <span class="hljs-comment"># === Step 9: Export and re-import the entire graph structure ===</span>
    exported = graph.export_graph()
    graph.import_graph(exported)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📦 Graph exported and re-imported, total nodes:"</span>, <span class="hljs-built_in">len</span>(exported[<span class="hljs-string">"nodes"</span>]))
​
    <span class="hljs-comment"># ====================================</span>
    <span class="hljs-comment"># 🔍 Step 10: extra function</span>
    <span class="hljs-comment"># ====================================</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n=== 🔍 Extra Tests for user: <span class="hljs-subst">{user_name}</span> ==="</span>)
​
    <span class="hljs-built_in">print</span>(<span class="hljs-string">" - Memory count:"</span>, graph.get_memory_count(<span class="hljs-string">"LongTermMemory"</span>))
    <span class="hljs-built_in">print</span>(<span class="hljs-string">" - Node count:"</span>, graph.count_nodes(<span class="hljs-string">"LongTermMemory"</span>))
    <span class="hljs-built_in">print</span>(<span class="hljs-string">" - All LongTermMemory items:"</span>, graph.get_all_memory_items(<span class="hljs-string">"LongTermMemory"</span>))
​
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(exported[<span class="hljs-string">"edges"</span>]) &gt; <span class="hljs-number">0</span>:
        n1, n2 = exported[<span class="hljs-string">"edges"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"source"</span>], exported[<span class="hljs-string">"edges"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"target"</span>]
        <span class="hljs-built_in">print</span>(<span class="hljs-string">" - Edge exists?"</span>, graph.edge_exists(n1, n2, exported[<span class="hljs-string">"edges"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"type"</span>]))
        <span class="hljs-built_in">print</span>(<span class="hljs-string">" - Edges for node:"</span>, graph.get_edges(n1))
​
    filters = [{<span class="hljs-string">"field"</span>: <span class="hljs-string">"memory_type"</span>, <span class="hljs-string">"op"</span>: <span class="hljs-string">"="</span>, <span class="hljs-string">"value"</span>: <span class="hljs-string">"LongTermMemory"</span>}]
    <span class="hljs-built_in">print</span>(<span class="hljs-string">" - Metadata query result:"</span>, graph.get_by_metadata(filters))
    <span class="hljs-built_in">print</span>(
        <span class="hljs-string">" - Optimization candidates:"</span>, graph.get_structure_optimization_candidates(<span class="hljs-string">"LongTermMemory"</span>)
    )
    <span class="hljs-keyword">try</span>:
        graph.drop_database()
    <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">" - drop_database raised ValueError as expected:"</span>, e)
</code></pre>
<h4 data-id="heading-43">4.2 get_neighbors_by_tag</h4>
<p>get_neighbors_by_tag 功能说明如下：</p>
<h5 data-id="heading-44">4.2.1 功能概述</h5>
<p>get_neighbors_by_tag 是基于标签的邻居节点检索方法，用于在图数据库中查找与给定节点具有相似标签的相邻节点。通过计算标签重叠度识别语义相关节点，支持基于标签的图遍历与推荐。</p>
<h5 data-id="heading-45">4.2.2 应用场景</h5>
<p>记忆重组阶段发现具有共同主题或概念的相关记忆节点。</p>
<p>支持推理与关联分析，构建记忆之间的语义连接。</p>
<p>用于聚类分析，识别标签组合相似的节点群组。</p>
<h5 data-id="heading-46">4.2.3 参数说明</h5>
<ul>
<li>tags (list[str])：目标标签列表，用于匹配相似节点。</li>
<li>_exclude_ids (list[str])：需排除的节点 ID 列表，避免返回自身或已知节点。</li>
<li>top_k (int)：返回结果数量上限，默认通常为 5。</li>
<li>min_overlap (int)：最小标签重叠数，仅返回满足该条件的节点。</li>
</ul>
<h5 data-id="heading-47">4.2.4 筛选机制</h5>
<ul>
<li>标签交集计算：比较目标标签与候选节点标签的交集大小确定相关性。</li>
<li>最小重叠阈值：仅返回标签重叠数≥min_overlap 的节点。</li>
<li>排除机制：过滤 _exclude_ids 指定的节点，防止循环引用。</li>
</ul>
<h5 data-id="heading-48">4.2.5 检索流程</h5>
<ul>
<li>根据输入标签在图数据库中查找包含这些标签的所有节点。</li>
<li>计算每个候选节点与目标标签集合的交集大小。</li>
<li>过滤不满足最小重叠要求的节点。</li>
<li>按标签重叠程度排序并截取前 k 个节点。</li>
</ul>
<h5 data-id="heading-49">4.2.6 性能优化</h5>
<ul>
<li>利用图数据库索引加速标签查询。</li>
<li>通过批量操作减少数据库访问次数。</li>
<li>支持并发执行，提高大规模图检索效率。</li>
</ul>
<p>MemOS-main\src\memos\graph_dbs\nebular.py 代码如下：</p>
<pre><code class="hljs language-less" lang="less">    <span class="hljs-variable">@timed</span>
    def <span class="hljs-built_in">get_neighbors_by_tag</span>(
        self,
        <span class="hljs-attribute">tags</span>: list[str],
        <span class="hljs-attribute">exclude_ids</span>: list[str],
        <span class="hljs-attribute">top_k</span>: int = <span class="hljs-number">5</span>,
        <span class="hljs-attribute">min_overlap</span>: int = <span class="hljs-number">1</span>,
        <span class="hljs-attribute">include_embedding</span>: bool = False,
    ) -&gt; list[dict[str, Any]]:
        <span class="hljs-string">""</span>"
        Find top-K neighbor nodes with maximum tag overlap.
​
        <span class="hljs-attribute">Args</span>:
            <span class="hljs-attribute">tags</span>: The list of tags to match.
            <span class="hljs-attribute">exclude_ids</span>: Node IDs to exclude (e.g., local cluster).
            <span class="hljs-attribute">top_k</span>: Max number of neighbors to return.
            <span class="hljs-attribute">min_overlap</span>: Minimum number of overlapping tags required.
            <span class="hljs-attribute">include_embedding</span>: with/without embedding
​
        <span class="hljs-attribute">Returns</span>:
            List of dicts with node details <span class="hljs-keyword">and</span> overlap count.
        <span class="hljs-string">""</span>"
        if <span class="hljs-keyword">not</span> <span class="hljs-attribute">tags</span>:
            return []
​
        where_clauses = [
            <span class="hljs-string">'n.status = "activated"'</span>,
            <span class="hljs-string">'NOT (n.node_type = "reasoning")'</span>,
            <span class="hljs-string">'NOT (n.memory_type = "WorkingMemory")'</span>,
        ]
        if <span class="hljs-attribute">exclude_ids</span>:
            where_clauses.<span class="hljs-built_in">append</span>(f<span class="hljs-string">"NOT (n.id IN {exclude_ids})"</span>)
​
        where_clauses.<span class="hljs-built_in">append</span>(f<span class="hljs-string">'n.user_name = "{self.config.user_name}"'</span>)
​
        where_clause = <span class="hljs-string">" AND "</span>.<span class="hljs-built_in">join</span>(where_clauses)
        tag_list_literal = <span class="hljs-string">"["</span> + <span class="hljs-string">", "</span>.<span class="hljs-built_in">join</span>(f<span class="hljs-string">'"{_escape_str(t)}"'</span> for t in tags) + <span class="hljs-string">"]"</span>
​
        return_fields = self.<span class="hljs-built_in">_build_return_fields</span>(include_embedding)
        query = f<span class="hljs-string">""</span>"
            LET tag_list = {<span class="hljs-selector-tag">tag_list_literal</span>}
​
            <span class="hljs-selector-tag">MATCH</span> (n<span class="hljs-variable">@Memory</span> <span class="hljs-comment">/*+ INDEX(idx_memory_user_name) */</span>)
            <span class="hljs-selector-tag">WHERE</span> {<span class="hljs-selector-tag">where_clause</span>}
            <span class="hljs-selector-tag">RETURN</span> {<span class="hljs-selector-tag">return_fields</span>},
               <span class="hljs-selector-tag">size</span>( <span class="hljs-built_in">filter</span>( n.tags, t -&gt; t IN tag_list ) ) <span class="hljs-selector-tag">AS</span> <span class="hljs-selector-tag">overlap_count</span>
            <span class="hljs-selector-tag">ORDER</span> <span class="hljs-selector-tag">BY</span> <span class="hljs-selector-tag">overlap_count</span> <span class="hljs-selector-tag">DESC</span>
            <span class="hljs-selector-tag">LIMIT</span> {<span class="hljs-selector-tag">top_k</span>}
            """
​
        <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.execute_query</span>(query)
        <span class="hljs-selector-tag">neighbors</span>: <span class="hljs-selector-tag">list</span><span class="hljs-selector-attr">[dict[str, Any]</span>] = <span class="hljs-selector-attr">[]</span>
        <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">r</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">result</span>:
            <span class="hljs-selector-tag">props</span> = {k: v.value for k, v in r.items() if k != "overlap_count"}
            <span class="hljs-selector-tag">parsed</span> = <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">._parse_node</span>(props)
            <span class="hljs-selector-tag">parsed</span><span class="hljs-selector-attr">[<span class="hljs-string">"overlap_count"</span>]</span> = <span class="hljs-selector-tag">r</span><span class="hljs-selector-attr">[<span class="hljs-string">"overlap_count"</span>]</span><span class="hljs-selector-class">.value</span>
            <span class="hljs-selector-tag">neighbors</span><span class="hljs-selector-class">.append</span>(parsed)
​
        <span class="hljs-selector-tag">neighbors</span><span class="hljs-selector-class">.sort</span>(key=lambda <span class="hljs-attribute">x</span>: x[<span class="hljs-string">"overlap_count"</span>], reverse=True)
        <span class="hljs-selector-tag">neighbors</span> = <span class="hljs-selector-tag">neighbors</span><span class="hljs-selector-attr">[:top_k]</span>
        <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-attr">[]</span>
        <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">neighbor</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">neighbors</span><span class="hljs-selector-attr">[:top_k]</span>:
            <span class="hljs-selector-tag">neighbor</span><span class="hljs-selector-class">.pop</span>(<span class="hljs-string">"overlap_count"</span>)
            <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(neighbor)
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">result</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[掌握iOS和Android设备应用运行状态监控与性能优化完整教程]]></title>    <link>https://juejin.cn/post/7581314241409761315</link>    <guid>https://juejin.cn/post/7581314241409761315</guid>    <pubDate>2025-12-08T10:06:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581314241409761315" data-draft-id="7581299982670643234" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="掌握iOS和Android设备应用运行状态监控与性能优化完整教程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-08T10:06:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            掌握iOS和Android设备应用运行状态监控与性能优化完整教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T10:06:31.000Z" title="Mon Dec 08 2025 10:06:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>掌握设备状态：监控与管理正在运行的app</p>
<p>简介：智能手机用户了解和监控正在运行的应用程序对于优化性能、管理内存和保护隐私至关重要。本文将指导如何查看和管理Android和iOS设备上的当前活跃进程。通过系统自带功能和第三方应用，用户可以监控应用的CPU使用、内存占用，并进行性能优化、电量节省和故障排查。此外，开发者可以通过系统服务API深入了解后台进程信息，以提升app质量。</p>
<h2 data-id="heading-0">1. 查看正在运行的app方法</h2>
<p>在现代操作系统中，了解如何查看正在运行的应用程序对于性能监控和故障排查至关重要。这一章节将探讨查看运行应用的几种方法，帮助IT专业人员快速识别和管理正在消耗系统资源的应用。</p>
<h3 data-id="heading-1">1.1 使用系统自带工具查看运行中的应用</h3>
<p>大多数操作系统都配备了查看当前运行应用的内置工具。例如，在Windows系统中，可以使用任务管理器（Task Manager），而在macOS上，可以使用活动监视器（Activity Monitor）。这些工具不仅可以展示应用列表，还可以提供CPU、内存和网络使用情况等重要信息。</p>
<h3 data-id="heading-2">1.2 使用命令行工具</h3>
<p>除了图形界面工具之外，命令行工具也是一个强大且灵活的选择。例如，在Linux系统中，可以使用 <code>top</code> 或 <code>htop</code> 命令快速查看所有运行中的进程。通过这些命令行工具，IT专业人员可以获得更多的细节信息，比如进程ID、启动时间以及具体的资源占用率等。</p>
<pre><code class="hljs">
htop
</code></pre>
<h3 data-id="heading-3">1.3 第三方应用监控工具</h3>
<p>除系统自带和命令行工具之外，市场上还有许多第三方应用监控工具，它们往往具有更高级的功能，例如跨平台查看、历史数据记录和详细的性能分析报告。这类工具对于需要在多操作系统或大型企业环境中进行性能监控的IT专业人员尤其有用。对于iOS开发，Keymob提供全面的性能监控、文件管理和日志分析功能，帮助开发者深入优化应用性能并提升开发效率。</p>
<p>这一章节为IT专业人员提供了一个入门级别的指导，帮助他们开始监控和管理运行中的应用程序。后续章节将深入探讨更高级的监控和优化技巧。</p>
<h2 data-id="heading-4">2. 监控设备资源使用</h2>
<h4 data-id="heading-5">2.1 监控CPU使用率</h4>
<h5 data-id="heading-6">2.1.1 CPU使用率的意义</h5>
<p>CPU作为计算机系统的核心组件，其性能直接影响到应用程序的运行效率和整个系统的响应速度。CPU使用率是衡量CPU负载水平的关键指标，它反映了CPU在执行任务时的忙碌程度。监控CPU使用率有助于开发者及时发现性能瓶颈，优化应用程序，避免因过载而引起的系统故障。</p>
<h5 data-id="heading-7">2.1.2 监控工具和方法</h5>
<p><strong>命令行工具：</strong></p>
<p>Linux系统中常用的命令行工具包括 <code>top</code> , <code>htop</code> , <code>vmstat</code> , <code>iostat</code> 等。这些工具可以直接在命令行中运行，提供实时的系统状态和性能数据。</p>
<pre><code class="hljs language-arduino" lang="arduino">
top
sudo apt-get install htop
htop
</code></pre>
<p>以上命令会展示系统当前的资源使用情况，包括CPU、内存、进程等信息。</p>
<p><strong>GUI工具：</strong></p>
<p>如 <code>System Monitor</code> （系统监视器）或 <code>Resource Monitor</code> （资源监视器），这些图形界面工具可以提供更直观的数据展示。</p>
<p><strong>编程监控：</strong></p>
<p>对于开发者而言，编程语言提供的库或API可以集成到应用中，实现更细粒度的监控。</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> psutil
cpu_usage = psutil.cpu_percent(interval=<span class="hljs-number">1</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"当前CPU使用率: <span class="hljs-subst">{cpu_usage}</span>%"</span>)
</code></pre>
<h4 data-id="heading-8">2.2 监控内存使用情况</h4>
<h5 data-id="heading-9">2.2.1 内存泄漏的影响</h5>
<p>内存泄漏是应用程序在运行过程中不断消耗内存资源，却未能有效释放已分配的内存，导致随着时间推移可用内存逐渐减少的现象。内存泄漏会造成应用程序性能下降，系统运行缓慢，严重的内存泄漏甚至会导致系统崩溃。</p>
<h5 data-id="heading-10">2.2.2 内存监控的实践技巧</h5>
<p><strong>内存使用量监控：</strong></p>
<p>通过观察系统的内存使用总量以及各个进程的内存占用情况，可以及时发现内存使用的异常情况。</p>
<pre><code class="hljs language-c" lang="c">
<span class="hljs-built_in">free</span> -h
</code></pre>
<pre><code class="hljs language-bash" lang="bash">
ps -o pid,<span class="hljs-built_in">comm</span>,rss,args -C [process_name]
</code></pre>
<p><strong>内存泄漏检测工具：</strong></p>
<p>内存泄漏检测通常需要使用特定的工具，如Valgrind，它是一个开源的程序分析工具，能够检测程序中的内存泄漏等问题。</p>
<pre><code class="hljs language-css" lang="css">
sudo apt-get install valgrind
valgrind <span class="hljs-attr">--leak-check</span>=full <span class="hljs-selector-attr">[program]</span>
</code></pre>
<p>以上命令会运行程序并检查内存泄漏。</p>
<p>此外，许多集成开发环境（IDE）如Eclipse、IntelliJ IDEA等也提供了内存泄漏检测功能。通过集成这些工具，开发者可以在开发过程中实时监控内存使用情况，快速定位内存泄漏问题。</p>
<p>通过上述的CPU和内存监控方法，可以确保应用和系统的稳定性，为用户提供更流畅的使用体验。下一章将深入探讨性能优化和电量节省策略，以进一步提升应用性能。</p>
<h2 data-id="heading-11">3. 性能优化和电量节省策略</h2>
<p>性能优化和电量节省是任何应用开发者都必须面对的两大挑战。随着用户对移动设备的依赖日益增加，应用的响应速度和电池续航能力直接影响用户体验。本章将深入探讨性能优化的基础知识，包括性能瓶颈分析和优化工具的使用，以及电量节省的策略和方法。</p>
<h3 data-id="heading-12">3.1 性能优化基础</h3>
<p>性能优化旨在提高应用的运行速度、效率和响应能力。要做到这一点，首先要识别和分析应用的性能瓶颈，然后利用各种优化工具和技术进行针对性的改进。</p>
<h4 data-id="heading-13">3.1.1 应用性能瓶颈分析</h4>
<p>应用性能瓶颈是指那些限制应用性能达到最优状态的因素。这些瓶颈可能来源于代码层面的算法效率问题、数据结构选择不当、资源争用等。此外，应用对系统资源的过度消耗，如CPU和内存的高使用率，也可能成为性能瓶颈。</p>
<p>分析性能瓶颈通常从以下几个方面入手：</p>
<ul>
<li><strong>代码剖析（Profiling）</strong> ：使用代码剖析工具（如Android Studio中的Profiler工具）来监控应用的CPU、内存和网络使用情况。</li>
<li><strong>性能测试</strong> ：编写自动化测试脚本来模拟用户操作，并测量应用的响应时间和资源消耗。</li>
<li><strong>用户反馈</strong> ：收集用户在真实使用场景下的反馈信息，了解性能问题的实际情况。</li>
</ul>
<h4 data-id="heading-14">3.1.2 优化工具和实践案例</h4>
<p>针对性能瓶颈，开发者可以利用多种工具进行优化。以下是一些常见的优化工具和实践案例：</p>
<ul>
<li><strong>CPU Profiler</strong> ：通过CPU Profiler可以查看应用在运行时的CPU使用情况。工具提供了火焰图（Flame Graph）来直观展示方法调用的耗时分布，便于发现耗时较长的方法。</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">performTask</span><span class="hljs-params">()</span></span> {
    Thread.sleep(<span class="hljs-number">5000</span>)
}
</code></pre>
<p>以上代码中的 <code>performTask</code> 函数将模拟长时间的CPU使用，这在CPU Profiler中将表现为一个热点（Hotspot）。</p>
<ul>
<li><strong>Memory Profiler</strong> ：Memory Profiler有助于检测内存泄漏和内存使用波动。开发者可以通过分析内存分配和回收的模式来识别潜在的内存问题。</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
<span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
    }
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span></span> {
<span class="hljs-keyword">super</span>.onDestroy()
        context = <span class="hljs-literal">null</span>
    }
}
</code></pre>
<p>在这个例子中， <code>MainActivity</code> 类通过一个静态变量持有了对自身的引用，如果在 <code>onDestroy</code> 生命周期方法中不将该静态变量设置为 <code>null</code> ，就可能引起内存泄漏。</p>
<ul>
<li><strong>Benchmarking Libraries</strong> ：对于需要进行性能基准测试的场景，可以使用如Android Benchmark Harness（ABH）等测试框架来测量代码的执行时间。</li>
</ul>
<h3 data-id="heading-15">3.2 电量节省技巧</h3>
<p>电池续航能力对于移动设备来说至关重要，优化应用以减少电量消耗可以显著提升用户体验。</p>
<h4 data-id="heading-16">3.2.1 电量消耗的常见原因</h4>
<p>应用在后台运行、频繁的网络请求、高频率的GPS定位更新、屏幕亮度调整以及CPU和内存资源的过度使用都是导致电量消耗的常见原因。</p>
<ul>
<li><strong>后台服务</strong> ：无限制的后台服务会消耗CPU资源，间接导致电量消耗。</li>
<li><strong>网络活动</strong> ：网络请求，尤其是无线网络请求，是电池使用大户。</li>
<li><strong>屏幕亮度</strong> ：屏幕亮度调节为最高时，电量消耗会显著增加。</li>
</ul>
<h4 data-id="heading-17">3.2.2 实现电量节省的策略和方法</h4>
<p>为了降低应用的电量消耗，开发者可以采取以下策略和方法：</p>
<ul>
<li><strong>优化后台服务</strong> ：限制后台服务的使用，仅在必要时唤醒服务进行工作。</li>
<li><strong>减少网络请求</strong> ：合并多个小的网络请求为一个大的请求，减少请求次数，减少数据传输。</li>
<li><strong>控制屏幕亮度</strong> ：在应用内设置合理的屏幕亮度，或者使用系统提供的亮度控制API。</li>
<li><strong>使用省电API</strong> ：利用平台提供的省电模式API，如在Android中可以使用 <code>Doze Mode</code> 和 <code>App Standby</code> 来减少在后台的电池消耗。</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">
if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {
PowerManager powerManager = (PowerManager) <span class="hljs-built_in">getSystemService</span>(POWER_SERVICE);
    powerManager<span class="hljs-selector-class">.setDozeRestrict</span>(PowerManager.RESTRICTION_TYPE_EXEMPTED);
}
</code></pre>
<p>以上代码展示了如何在满足特定条件时为应用启用Doze模式，从而达到减少电池消耗的目的。</p>
<p>通过结合这些性能优化和电量节省策略，开发者可以显著提高应用的运行效率和电池续航，最终达到提升用户满意度的目标。在下一章中，我们将进一步探讨如何保护用户的个人隐私以及故障排查和修复技巧，确保应用的长期稳定运行。</p>
<h2 data-id="heading-18">4. 保护个人隐私和故障排查技巧</h2>
<p>在当今数字时代，个人隐私保护和故障排查已成为每个用户和开发者关注的重点。本章将深入探讨如何保护用户隐私，以及如何高效地进行故障排查。</p>
<h3 data-id="heading-19">4.1 隐私保护机制</h3>
<p>隐私泄露的风险无处不在，而个人隐私保护则是确保数据安全和个人信息安全的关键措施。下面详细讲解隐私泄露的风险与预防以及应用权限管理和安全设置。</p>
<h4 data-id="heading-20">4.1.1 隐私泄露的风险与预防</h4>
<p>隐私泄露可能导致诸多问题，包括但不限于身份盗用、财产损失、个人生活被干扰等。预防隐私泄露主要依赖于以下几个方面：</p>
<ol>
<li><strong>数据加密</strong> ：对敏感数据进行加密处理，确保即使数据被非法获取，也无法轻易被解读。</li>
<li><strong>最小权限原则</strong> ：应用仅请求对完成其功能所必需的最低权限，降低数据泄露的风险。</li>
<li><strong>定期更新和打补丁</strong> ：及时更新操作系统和应用程序，修补已知的安全漏洞。</li>
<li><strong>多因素身份验证</strong> ：通过增加一层或多层验证机制，提高账户安全。</li>
<li><strong>用户教育</strong> ：教育用户识别钓鱼、诈骗等常见隐私泄露手段。</li>
</ol>
<h4 data-id="heading-21">4.1.2 应用权限管理和安全设置</h4>
<p>应用权限管理是保护用户隐私的重要组成部分。开发者应该：</p>
<ol>
<li><strong>明确权限请求目的</strong> ：在请求权限时，明确告知用户为何需要这些权限。</li>
<li><strong>遵循Android和iOS平台指南</strong> ：在两个主要的移动平台上，遵循各自的权限管理指南和最佳实践。</li>
<li><strong>实施运行时权限请求</strong> ：确保只有在需要时才向用户请求权限，并提供适当的上下文。</li>
<li><strong>限制权限范围</strong> ：仅请求对完成应用功能必不可少的权限，并尽量减少权限请求的频率。</li>
<li><strong>权限审查</strong> ：定期审查应用权限，删除不再需要的权限请求。</li>
</ol>
<h4 data-id="heading-22">代码示例：检查应用权限</h4>
<pre><code class="hljs language-arduino" lang="arduino">
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title">checkPermission</span><span class="hljs-params">(<span class="hljs-type">String</span> permission)</span> </span>{
<span class="hljs-type">int</span> permissionCheck = ContextCompat.<span class="hljs-built_in">checkSelfPermission</span>(thisActivity, permission);
<span class="hljs-keyword">return</span> permissionCheck == PackageManager.PERMISSION_GRANTED;
}
<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">checkPermission</span>(Manifest.permission.CAMERA)) {
    ActivityCompat.<span class="hljs-built_in">requestPermissions</span>(thisActivity, <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>[]{Manifest.permission.CAMERA}, REQUEST_CODE);
}
</code></pre>
<p>在这个Java代码示例中，我们定义了一个 <code>checkPermission</code> 方法来检查应用是否有权限访问相机。 <code>ContextCompat.checkSelfPermission</code> 方法返回 <code>PackageManager.PERMISSION_GRANTED</code> 或 <code>PackageManager.PERMISSION_DENIED</code> ，表示权限是否已被授予。如果权限未被授予，则使用 <code>ActivityCompat.requestPermissions</code> 方法向用户请求权限。</p>
<h3 data-id="heading-23">4.2 故障排查与修复</h3>
<p>故障排查是系统维护中的重要环节。它包括识别问题、定位问题源头和采取纠正措施等步骤。下面详细探讨故障排查的基本流程以及如何处理典型问题。</p>
<h4 data-id="heading-24">4.2.1 故障排查的基本流程</h4>
<p>故障排查的一般流程如下：</p>
<ol>
<li><strong>识别问题</strong> ：首先明确故障的表现和影响范围。</li>
<li><strong>收集信息</strong> ：记录和收集与问题相关的所有信息，包括日志、应用状态和用户反馈等。</li>
<li><strong>初步分析</strong> ：根据收集到的信息，进行初步的分析和假设。</li>
<li><strong>创建假设</strong> ：构建一个或多个可能的问题原因的假设。</li>
<li><strong>测试假设</strong> ：通过实验来验证这些假设。</li>
<li><strong>解决问题</strong> ：根据验证的结果，采取必要的解决措施。</li>
<li><strong>预防复发</strong> ：分析故障的根本原因，并制定预防措施防止故障再次发生。</li>
</ol>
<h4 data-id="heading-25">4.2.2 典型问题的排查和解决实例</h4>
<p>以下是一个典型的Android应用崩溃故障排查的实例：</p>
<p>假设应用崩溃时会抛出 <code>NullPointerException</code> 。排查流程如下：</p>
<ol>
<li><strong>查看崩溃日志</strong> ：首先获取应用的崩溃日志。可以通过Android Studio或Logcat工具查看。</li>
<li><strong>定位崩溃点</strong> ：找到抛出 <code>NullPointerException</code> 的堆栈跟踪，定位到出问题的代码行。</li>
<li><strong>检查变量</strong> ：检查该变量是否在使用前被正确初始化。</li>
<li><strong>修改代码</strong> ：如果变量未初始化，确保在使用前为其赋予合适的值。</li>
<li><strong>测试应用</strong> ：修正代码后重新编译并运行应用，验证问题是否已解决。</li>
<li><strong>部署更新</strong> ：如果测试没有发现问题，可以将更新部署到生产环境。</li>
</ol>
<h4 data-id="heading-26">流程图示例：故障排查流程</h4>
<pre><code class="hljs language-css" lang="css">graph <span class="hljs-selector-tag">TD</span>
    <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[开始排查]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[识别问题]</span>
    <span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[收集信息]</span>
    C --&gt; D<span class="hljs-selector-attr">[初步分析]</span>
    D --&gt; E<span class="hljs-selector-attr">[创建假设]</span>
    E --&gt; F<span class="hljs-selector-attr">[测试假设]</span>
    F --&gt;|假设成立| G<span class="hljs-selector-attr">[解决问题]</span>
    F --&gt;|假设不成立| E
    G --&gt; H<span class="hljs-selector-attr">[预防复发]</span>
    H --&gt; <span class="hljs-selector-tag">I</span><span class="hljs-selector-attr">[结束排查]</span>

</code></pre>
<p>在这个流程图中，我们可以清晰地看到故障排查的基本步骤，以及在测试假设不成立时如何返回并创建新的假设。</p>
<p>本章详细介绍了隐私保护机制和故障排查技巧，希望这些内容能够帮助您更好地保护用户隐私和应对应用故障。下一章我们将探讨系统服务API在app调试和性能监控中的应用。</p>
<h2 data-id="heading-27">5. 系统服务API在app调试和性能监控中的应用</h2>
<p>系统服务API为开发人员提供了一种与设备系统服务进行交互的方式。这些API使得开发者能够访问系统级功能，如网络状态、电池信息、传感器数据等，并将其集成到应用程序中，以增强应用程序的功能并提升用户体验。在本章中，我们将深入了解系统服务API，并探讨它们在app调试和性能监控方面的应用。</p>
<h3 data-id="heading-28">5.1 系统服务API简介</h3>
<h4 data-id="heading-29">5.1.1 系统服务API的功能与作用</h4>
<p>系统服务API为Android和iOS等移动操作系统提供了丰富的功能集合。例如，Android的 <code>LocationManager</code> API可以访问设备的GPS服务，而iOS的 <code>HealthKit</code> 框架则允许应用访问用户的健康数据。开发者通过这些API不仅能够获取系统信息，还可以执行特定的任务，如控制设备硬件或监控系统状态。</p>
<h4 data-id="heading-30">5.1.2 开发者如何利用系统服务API</h4>
<p>开发者利用系统服务API通常需要执行以下步骤：</p>
<ul>
<li>确定需要使用的系统服务API的类型和功能。</li>
<li>在应用的manifest文件（Android）或info.plist文件（iOS）中声明相应的权限。</li>
<li>在代码中创建相应的API对象，并调用所需的API方法。</li>
<li>处理异步调用的回调或结果，并确保正确管理权限和用户隐私。</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">
LocationManager <span class="hljs-attr">locationManager</span> = (LocationManager) context.getSystemService(Context.LOCATION_SERVICE)<span class="hljs-comment">;</span>
if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED &amp;&amp; ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_COARSE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
} else {
Location <span class="hljs-attr">location</span> = locationManager.getLastKnownLocation(LocationManager.GPS_PROVIDER)<span class="hljs-comment">;</span>
if (location != null) {
    }
}
</code></pre>
<h3 data-id="heading-31">5.2 API在调试和性能监控中的应用案例</h3>
<h4 data-id="heading-32">5.2.1 实际开发中的应用分析</h4>
<p>在应用开发过程中，系统服务API经常用于调试和测试阶段，以确保应用可以正确响应系统事件。例如，使用Android的 <code>BatteryManager</code> API，开发者可以检测电池状态和电量信息，确保应用在低电量模式下依然表现良好。对于iOS开发，Keymob等工具利用系统服务API提供实时性能监控和日志分析，帮助开发者优化应用性能。</p>
<pre><code class="hljs language-ini" lang="ini">
BatteryManager <span class="hljs-attr">batteryManager</span> = (BatteryManager) getSystemService(Context.BATTERY_SERVICE)<span class="hljs-comment">;</span>
int <span class="hljs-attr">status</span> = batteryManager.getIntProperty(BatteryManager.BATTERY_PROPERTY_STATUS)<span class="hljs-comment">;</span>
boolean <span class="hljs-attr">isCharging</span> = status == BatteryManager.BATTERY_STATUS_CHARGING ||
                     <span class="hljs-attr">status</span> == BatteryManager.BATTERY_STATUS_FULL<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-33">5.2.2 性能监控和调试的高级应用技巧</h4>
<p>在性能监控方面，开发者可以利用系统服务API实现自定义的性能监控工具。例如，监测应用启动时间或响应时间。同时，结合日志系统和性能分析工具，可以形成一套完整的性能监控解决方案。</p>
<pre><code class="hljs language-ini" lang="ini">
long <span class="hljs-attr">startTime</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
long <span class="hljs-attr">endTime</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
Log.d("Performance", "Application startup time: " + (endTime - startTime) + "ms")<span class="hljs-comment">;</span>
</code></pre>
<p>在高级应用技巧方面，开发者可以结合使用多个API来提高监控的深度。例如，同时监控CPU和内存使用情况，以识别应用性能瓶颈。</p>
<pre><code class="hljs language-ini" lang="ini">
ActivityManager <span class="hljs-attr">activityManager</span> = (ActivityManager) getSystemService(Context.ACTIVITY_SERVICE)<span class="hljs-comment">;</span>
ActivityManager.MemoryInfo <span class="hljs-attr">memoryInfo</span> = new ActivityManager.MemoryInfo()<span class="hljs-comment">;</span>
activityManager.getMemoryInfo(memoryInfo)<span class="hljs-comment">;</span>
</code></pre>
<p>通过以上示例代码，我们可以看到系统服务API在调试和性能监控中的实际应用。开发者通过系统服务API不仅可以增强应用的功能，还可以确保应用在各种环境下都能稳定运行。系统服务API是移动应用开发中不可或缺的一部分，掌握它们对于提高开发质量和性能优化至关重要。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[理解iOS中Protobuf：一个比JSON更好，但不是替代]]></title>    <link>https://juejin.cn/post/7581306080435634227</link>    <guid>https://juejin.cn/post/7581306080435634227</guid>    <pubDate>2025-12-08T15:35:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581306080435634227" data-draft-id="7580564126402871346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="理解iOS中Protobuf：一个比JSON更好，但不是替代"/> <meta itemprop="keywords" content="iOS,架构,性能优化"/> <meta itemprop="datePublished" content="2025-12-08T15:35:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sweet丶"/> <meta itemprop="url" content="https://juejin.cn/user/3227821869921646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            理解iOS中Protobuf：一个比JSON更好，但不是替代
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821869921646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sweet丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T15:35:58.000Z" title="Mon Dec 08 2025 15:35:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    82
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在iOS开发中，JSON凭借其卓越的可读性和跨平台兼容性，长期以来都是网络交互和本地存储的首选。但你是否遇到过因网络请求过慢导致用户体验不佳，或是在处理大量数据时应用响应迟缓的情况？问题的根源有时就出在数据交换的格式上。</p>
<p>今天，我们将深入探讨 <strong>Protocol Buffers（简称Protobuf）</strong> ——一种由Google设计的结构化数据序列化机制。这篇博客将澄清一个常见的误解：引入Protobuf<strong>并非为了全盘取代JSON</strong>，而是为了在你工具箱中增加一个强有力的选项。我们将重点剖析它相比JSON的核心优势、独特的工作原理、最适用的场景，并看看它是如何在现实中被大厂们广泛应用的。</p>
<h3 data-id="heading-0">一、不是替代，而是补充：Protobuf与JSON的核心差异</h3>
<p>要做出明智的技术选型，首先要理解它们的本质区别。我们可以用一个简单的比喻：JSON好比一封信件，所有人都能轻松阅读；而Protobuf更像一封密码电报，体积小、传输快，但需要密码本（即<code>.proto</code>定义文件）才能解读。</p>
<p>为了更直观，请看下表对两者关键特性的对比：</p>



































<table><thead><tr><th align="left">特性维度</th><th align="left">JSON (文本格式)</th><th align="left">Protobuf (二进制格式)</th></tr></thead><tbody><tr><td align="left"><strong>可读性</strong></td><td align="left"><strong>极高</strong>，数据本身就是文本，方便调试。</td><td align="left"><strong>极低</strong>，二进制格式难以肉眼识别。</td></tr><tr><td align="left"><strong>数据体积</strong></td><td align="left"><strong>较大</strong>。包含重复的字段名、引号、括号等冗余信息。</td><td align="left"><strong>极小</strong>。用字段编号替代字段名，编码紧凑。</td></tr><tr><td align="left"><strong>序列化/反序列化速度</strong></td><td align="left">较慢。需解析文本字符串，进行类型转换。</td><td align="left"><strong>极快</strong>。直接处理二进制流，编码/解码几乎等同于内存拷贝。</td></tr><tr><td align="left"><strong>强类型与Schema</strong></td><td align="left">无。依赖约定，容易出错，需额外校验工具（如JSON Schema）。</td><td align="left"><strong>有</strong>。通过<code>.proto</code>文件明确定义，生成类型安全的代码。</td></tr><tr><td align="left"><strong>跨版本兼容性</strong></td><td align="left">弱。增删字段易导致客户端崩溃，需要严格协调。</td><td align="left"><strong>强</strong>。设计上就支持向前/向后兼容，新增可选字段旧代码自动忽略。</td></tr></tbody></table>
<p>一个典型例子是，同样一条包含<code>id</code>, <code>name</code>, <code>email</code>三个字段的用户信息，JSON格式的文本可能长达上百字节，而Protobuf编码后可能只有十几个字节，在弱网环境下，这种差异会直接影响App的响应速度。</p>
<p>因此，<strong>选型的关键在于场景</strong>：</p>
<ul>
<li><strong>对外API、配置文件、需要浏览器直接解析的数据</strong>：<strong>JSON是不二之选</strong>。</li>
<li><strong>对内的微服务通信、高频率RPC调用、移动端弱网优化</strong>：<strong>Protobuf的优势将非常突出</strong>。</li>
</ul>
<h3 data-id="heading-1">二、性能之谜：Protobuf为何如此高效？</h3>
<p>Protobuf的高性能并非魔法，而是源于其精巧的编码设计。下面这张图清晰地展示了它的工作原理：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[.proto 消息定义文件] --&gt; B[protoc 编译器]
    
    B --&gt; C[目标语言代码&lt;br&gt;如 Swift Class]
    C --&gt; D[包含序列化与&lt;br&gt;反序列化方法]
    
    A --&gt; E[Protobuf 编码规则]
    
    subgraph E[编码规则]
        F[字段: Tag-Length-Value&lt;br&gt;编码&lt;br&gt;用数字编号代替字段名]
        G[整数: Varint 变长编码&lt;br&gt;小数字节数更少]
        H[有符号整数: ZigZag 编码&lt;br&gt;优化负数存储]
    end
    
    D -- 序列化 --&gt; I[紧凑的二进制数据]
    I -- 网络传输或存储 --&gt; J
    J -- 反序列化 --&gt; D
</code></pre>
<ul>
<li>
<p><strong>核心1：T-L-V编码与字段编号</strong>
Protobuf抛弃了字段名，转而为每个字段分配一个唯一的<strong>数字编号（Tag）</strong>。序列化时，一个字段被编码为 <code>(Tag, Type, Value)</code> 的组合。接收方通过同样的 <code>.proto</code> 文件，就能将编号映射回正确的字段名。这从根本上消除了JSON中重复的字段名开销。</p>
</li>
<li>
<p><strong>核心2：Varint与ZigZag编码</strong></p>
<ul>
<li><strong>Varint变长编码</strong>：对于整数，小数值占用更少的字节。每个字节的最高位是标志位，表示是否还有后续字节，真正有效的只有低7位。这意味着数值<code>1</code>只需1个字节，而非固定的4个字节。</li>
<li><strong>ZigZag编码</strong>：专为有符号整数优化。它将负数“曲折”映射为一系列正数（如-1映射为1，1映射为2），使负数也能利用Varint编码紧凑存储。</li>
</ul>
</li>
</ul>
<p>正是这些底层设计，使得Protobuf能在数据大小和解析速度上实现数量级的提升。根据Google的数据，Protobuf相比XML，解析速度可以提高20到100倍，数据体积可减小到原来的1/10到1/3。</p>
<h3 data-id="heading-2">三、iOS开发中，何时应该考虑Protobuf？</h3>
<p>基于以上特性，在iOS开发中，以下几种场景特别适合引入Protobuf：</p>
<ol>
<li><strong>微服务/后端高频率通信</strong>：当你的App需要与后端进行大量、密集的RPC式数据交换时（例如即时通讯的消息推送、实时游戏状态同步），Protobuf减少的每一点延迟和流量都将汇聚成显著的体验优势。</li>
<li><strong>弱网环境优化</strong>：对于需要关注移动网络下用户体验和用户流量的应用，更小的数据包意味着更快的加载速度和更低的请求失败率。</li>
<li><strong>客户端本地数据存储</strong>：对于需要缓存大量结构化数据（如新闻资讯、产品目录）的场景，使用Protobuf序列化后存储，可以节省可观的磁盘空间，并加快读取速度。</li>
<li><strong>强类型与团队协作</strong>：在大型项目中，<code>.proto</code>文件作为一份明确的、跨平台（iOS, Android, 后端）的数据合同，能有效减少前后端联调时的类型错误和沟通成本。</li>
</ol>
<h3 data-id="heading-3">四、不只是理论：大厂们的实践</h3>
<p>Protobuf并非实验室技术，它已经在业界被广泛采用，并构成了现代云原生和微服务架构的基石。</p>
<ul>
<li><strong>Google的“亲儿子”</strong>：Protobuf自2001年起在Google内部用于几乎所有RPC通信和数据存储，后于2008年开源。它也是gRPC框架默认的序列化协议。可以说，Google的整个分布式系统都构建在Protobuf之上。</li>
<li><strong>字节跳动的选择</strong>：在其开源的<strong>Kitex</strong>高性能Go微服务RPC框架中，除了支持Thrift，也深度支持<strong>Kitex Protobuf</strong>和<strong>gRPC</strong>协议，以应对其海量、高并发的内部服务通信需求。</li>
<li><strong>云原生生态的标准</strong>：在CNCF（云原生计算基金会）生态中，Protobuf是许多核心项目的默认或重要选择。例如，在服务网格<strong>Istio</strong>、分布式追踪等系统中，都广泛使用Protobuf进行高效的数据交换。</li>
<li>开源框架MMKV，基于Protobuf进行序列化存储提升了性能。</li>
</ul>
<h3 data-id="heading-4">五、在iOS项目中如何开始？</h3>
<p>在iOS项目中使用Protobuf的流程非常标准化：</p>
<ol>
<li><strong>定义契约</strong>：编写 <code>.proto</code> 文件，定义你的请求和响应数据结构。
<pre><code class="hljs language-protobuf" lang="protobuf">syntax = "proto3";
message UserRequest {
  int32 user_id = 1;
}
message UserProfile {
  string name = 1;
  string email = 2;
  int32 age = 3;
}
</code></pre>
</li>
<li><strong>生成代码</strong>：使用 <code>protoc</code> 编译器配合 Swift 插件，将 <code>.proto</code> 文件编译为 Swift 类。
<pre><code class="hljs language-bash" lang="bash">protoc --swift_out=. your_proto_file.proto
</code></pre>
</li>
<li><strong>集成与使用</strong>：将生成的Swift文件加入项目。然后，你就可以像使用普通对象一样进行序列化（<code>serializeToData()</code>）和反序列化（<code>init(serializedData:)</code>）。</li>
<li><strong>网络层整合</strong>：通常需要将网络层从基于JSON的<code>URLSession</code>适配为支持Protobuf二进制流的格式，或直接使用基于Protobuf的gRPC框架。</li>
</ol>
<h3 data-id="heading-5">总结与最佳实践</h3>
<p>回到最初的观点：<strong>Protobuf不是JSON的替代品，而是在特定问题域更优的解决方案</strong>。</p>
<p>一个现代、健壮的架构往往是混合式的：</p>
<ul>
<li>对<strong>外</strong>面向浏览器、移动端或第三方开发者的API，继续使用<strong>JSON</strong>，保证最大的兼容性和可调试性。</li>
<li>在<strong>内</strong>部服务间、对性能有极致要求的移动端数据通道，采用<strong>Protobuf</strong>，追求极致的效率和类型安全。</li>
</ul>
<p>作为iOS开发者，理解Protobuf的原理和优势，能让你在面临性能瓶颈、思考架构优化时，多一个强大而成熟的选择。技术决策没有银弹，只有对场景最合适的权衡。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[计算机十万个为什么--数据库索引]]></title>    <link>https://juejin.cn/post/7581292270962114570</link>    <guid>https://juejin.cn/post/7581292270962114570</guid>    <pubDate>2025-12-08T15:57:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581292270962114570" data-draft-id="7581292270962081802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="计算机十万个为什么--数据库索引"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-08T15:57:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            计算机十万个为什么--数据库索引
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T15:57:08.000Z" title="Mon Dec 08 2025 15:57:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">计算机十万个为什么--数据库索引</h2>
<blockquote>
<p>大家好，欢迎来到最新一期的无限大博客。</p>
<p>突然发现自己对数据库相关的内容掌握不够扎实，于是就去学习了一下，顺便也将自己的理解写成了一篇博客。</p>
<p>希望这篇文章能对大家有所帮助</p>
</blockquote>
<h3 data-id="heading-1">数据库索引：给数据仓库装个"智能导航系统" 🧭</h3>
<p>想象一下，你走进一个占地 1000 平方米的超级图书馆 📚，里面塞满了几十万本书，却连个分类牌都没有。老板忽然喊你找一本《数据库从入门到放弃》，你是不是当场想表演一个原地消失术？😱</p>
<p>这就是<strong>没有索引的数据库</strong>的日常！每次查询都像蒙眼找书，全表扫描就是那个被蒙住眼睛的倒霉蛋，只能一本本摸过去。而今天我们要聊的 <strong>数据库索引</strong> ，就是给这个混乱图书馆装上的智能导航系统 🧭，让你秒变图书馆馆长，想找哪本书就找哪本书！</p>
<h3 data-id="heading-2">为什么"like '%关键词%'"会让索引当场罢工？</h3>
<p>先看个灵魂拷问：下面两条 SQL，性能可能差 1000 倍！你猜哪个快？</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语句 A</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> books <span class="hljs-keyword">WHERE</span> title <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'数据库%'</span>;

<span class="hljs-comment">-- 语句 B</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> books <span class="hljs-keyword">WHERE</span> title <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%数据库%'</span>;
</code></pre>
<p>答案是<strong>语句 A 可能快到飞起，语句 B 可能慢到想砸键盘</strong> ！</p>
<p>原因就藏在那个小小的百分号里。</p>
<h4 data-id="heading-3">🌰 蒙眼找书现场还原</h4>
<p>假设我们给 title 字段建了索引，就像图书馆按书名首字母排序的分类架。当你执行 LIKE '数据库%' 时，索引会开心地带你直奔 "数" 字区，从 "数据库入门" 找到 "数据库原理"，一气呵成 🚀。</p>
<p>但如果写成 LIKE '%数据库%'，相当于你告诉图书管理员："我要找所有书名里包含'数据库'的书，但我不告诉你它在开头还是结尾"。这时候索引直接懵了 😵，因为它的排序规则是按首字母来的，现在关键词可能出现在任何位置，就像让你在所有书里找 "包含'的'字的书" 一样——索引完全帮不上忙！</p>
<p><strong>全表扫描警告</strong> ⚠️：数据库只能开启"蒙眼摸书"模式，逐行检查每条记录。如果表中有 100 万条数据，就像让你在 100 万本书里一本本翻开找，画面太美我不敢看 🥶。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af55f14a116a4b07925841af1a6aff5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6ZmQ5aSnNg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765814227&amp;x-signature=vbbg0wk6GxgqkD2gRB1WNG7uPFE%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">避坑指南：3 个让索引失效的经典操作</h4>

























<table><thead><tr><th>错误写法 🔴</th><th>正确姿势 🟢</th><th>性能差距</th></tr></thead><tbody><tr><td>LIKE '%关键词%'</td><td>LIKE '关键词%' 或使用全文索引</td><td>可能差 100~1000 倍</td></tr><tr><td>WHERE age + 1 = 25</td><td>WHERE age = 24</td><td>索引直接失效</td></tr><tr><td>WHERE SUBSTR(title, 3) = '数据库'</td><td>WHERE title LIKE '__数据库%'</td><td>函数操作导致索引失效</td></tr></tbody></table>
<h3 data-id="heading-5">B+树索引 vs 哈希索引：新华字典 vs 快递柜</h3>
<p>现在你决定给图书馆装导航系统了，但市场上有两种方案：</p>
<ul>
<li><strong>方案 A</strong> ：像《新华字典》那样的目录 📖（B+树索引）</li>
<li><strong>方案 B</strong> ：像快递柜那样的编号系统 📦（哈希索引）</li>
</ul>
<p>到底选哪个？这得看你平时怎么找书！</p>
<h4 data-id="heading-6">📖 B+树索引：新华字典的智慧</h4>
<p>翻开你的新华字典，会发现它有两种目录：拼音索引和部首索引。B+树索引就像拼音索引，它把数据按顺序排好，并且只在叶子节点存储完整数据，中间节点都是"指路牌"。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[根节点] --&gt;|1-100| B[中间节点]
    A --&gt;|101-200| C[中间节点]
    
    B --&gt;|1-50| D[叶子节点: 1,3,5...50]
    B --&gt;|51-100| E[叶子节点: 51,53...100]
    
    C --&gt;|101-150| F[叶子节点: 101...150]
    C --&gt;|151-200| G[叶子节点: 151...200]
    
    D --&gt;|链表指针| E
    E --&gt;|链表指针| F
    F --&gt;|链表指针| G
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c4470d9e5c644a58ad6358b273413f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6ZmQ5aSnNg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765814227&amp;x-signature=6fOfWkEI4yZeG6CLAhZfpaK0H9A%3D" alt="image.png" loading="lazy"/>
<strong>适用场景</strong> ：</p>
<ul>
<li>范围查询（比如找 "价格在 10-50 元的书"）📊</li>
<li>排序操作（比如 "按出版日期倒序排列"）🔄</li>
<li>前缀匹配（比如 LIKE '数据库%'）🎯</li>
</ul>
<h4 data-id="heading-7">📦 哈希索引：快递柜的暴力美学</h4>
<p>哈希索引就像快递柜，每个 key 都通过哈希函数计算出一个唯一编号，直接定位到存储位置。比如查询 id=100 的数据，哈希函数算出来是 8 号柜，直接拉开 8 号柜就能找到！</p>
<p><strong>适用场景</strong> ：</p>
<ul>
<li>等值查询（比如 WHERE id=100）⚡</li>
<li>键值对数据库（如 Redis）🚀</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28c5e3b67a8741c4b9d580703ab13f31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6ZmQ5aSnNg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765814227&amp;x-signature=Pk%2BnRltKlaxkySqYMv40zm4px7s%3D" alt="image.png" loading="lazy"/></p>
<p><strong>灵魂对比表格</strong> 👇</p>



































<table><thead><tr><th>特性</th><th>B+树索引</th><th>哈希索引</th></tr></thead><tbody><tr><td>查找速度</td><td>O(log n) 稳定</td><td>O(1) 但有哈希冲突风险</td></tr><tr><td>范围查询</td><td>✅ 天生支持</td><td>❌ 完全不支持</td></tr><tr><td>排序</td><td>✅ 叶子节点链表天然有序</td><td>❌ 无序存储</td></tr><tr><td>内存占用</td><td>中等（可存磁盘）</td><td>较高（通常内存存储）</td></tr><tr><td>经典应用</td><td>MySQL InnoDB 主键索引</td><td>Redis、Memcached 键值存储</td></tr></tbody></table>
<p>MySQL InnoDB 聚簇索引：叶子节点里藏着大秘密！</p>
<blockquote>
<p>如果你用 MySQL 的 InnoDB 引擎，那你必须知道这个<strong>惊天大秘密</strong> 💣：</p>
<p>它的主键索引叶子节点直接存着整行数据！就像你查新华字典时，翻到 "数" 字不仅能看到拼音，还能直接把整页字典撕下来带走 📄。</p>
</blockquote>
<h4 data-id="heading-8">聚簇索引 vs 非聚簇索引：冰箱 vs 储物柜</h4>
<ul>
<li><strong>聚簇索引</strong> （主键索引）：就像家里的冰箱 🧊，门（索引）打开直接看到食物（数据），不用再跑一趟。</li>
<li><strong>非聚簇索引</strong> （二级索引）：就像储物柜的标签 🏷️，上面写着"零食在冰箱第三层"，你还得再去冰箱拿。</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    subgraph 聚簇索引 B+树
        A[根节点: 主键范围 1-1000]
        B[中间节点: 1-500]
        C[中间节点: 501-1000]
        D[叶子节点: 1-100, 包含整行数据]
        E[叶子节点: 101-200, 包含整行数据]
    end
    A --&gt; B
    A --&gt; C
    B --&gt; D
    B --&gt; E
    D --&gt; E --&gt; F[...更多叶子节点]
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/160a9dcbc0064816ba3dbe2cb8b65cb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6ZmQ5aSnNg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765814227&amp;x-signature=8G4oOm2f5U2TqZ8aavypp%2FnmZqc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">实战：如何检测索引失效？</h4>
<p>给大家分享一个我压箱底的<strong>索引失效检测 SQL</strong> 🕵️‍♂️，执行它就能知道查询有没有用到索引：</p>
<pre><code class="hljs language-sql" lang="sql">EXPLAIN
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> books
<span class="hljs-keyword">WHERE</span> title <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%数据库%'</span>  <span class="hljs-comment">-- 这个会失效</span>
  <span class="hljs-keyword">AND</span> price <span class="hljs-operator">&gt;</span> <span class="hljs-number">50</span>;           <span class="hljs-comment">-- 这个可能有效</span>
</code></pre>
<p><strong>结果解读</strong> 👇：
-- 重点看 type 列：
-- ✅ ref/range/index：索引有用
-- ❌ ALL：全表扫描，索引失效！</p>
<p><strong>避坑神技</strong> ✨：如果必须用 %关键词% 模糊查询，可以考虑用  <strong>全文索引</strong> ：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建全文索引</span>
<span class="hljs-keyword">CREATE</span> FULLTEXT INDEX idx_title_ft <span class="hljs-keyword">ON</span> books(title);

<span class="hljs-comment">-- 高效查询包含关键词的记录</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> books
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(title) AGAINST(<span class="hljs-string">'数据库'</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LANGUAGE</span> MODE);
</code></pre>
<hr/>
<blockquote>
<h3 data-id="heading-10">索引设计的三大灵魂拷问</h3>
<ol>
<li><strong>是不是索引越多越好？</strong></li>
</ol>
<p>答：NO！索引像图书馆的分类架，太多了反而难找，而且每次增删改数据都要维护索引，就像每次新书入库都要重新贴标签 贴到崩溃。</p>
<ol start="2">
<li><strong>主键为什么最好是自增 ID？</strong></li>
</ol>
<p>答：InnoDB 聚簇索引如果用随机 ID，会导致叶子节点频繁分裂，就像你整理好的书架忽然插进新书，整个架子都要重排 🗄️。</p>
<ol start="3">
<li><strong>为什么不建议用 UUID 做主键？</strong></li>
</ol>
<p>答：UUID 是随机字符串，索引树会变成"歪脖子树" 🌳，查询效率暴跌！不信你试试给图书馆的书按 UUID 排序？</p>
</blockquote>
<hr/>
<h3 data-id="heading-11">结语：索引不是银弹，但没有索引是真的完蛋</h3>
<p>最后送大家一句我奶奶都能听懂的话：<strong>索引就像给自行车装变速器</strong> 🚲，平时通勤（简单查询）可能感觉不到，但遇到爬坡（复杂查询）时，有没有变速器直接是两个物种！</p>
<p>但记住，没有万能的索引设计，最好的实践是：<strong>用 EXPLAIN 分析 SQL，用监控工具观察慢查询，让数据告诉你答案</strong> 📊。</p>
<p>祝大家都能写出飞一般的 SQL，再也不用对着全表扫描掉头发！💇‍♂️💨</p>
<p>（如果觉得有用，记得点赞收藏哦~ 👇）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[移动端设备上稀奇古怪的前端问题收集（一）]]></title>    <link>https://juejin.cn/post/7581041679190507555</link>    <guid>https://juejin.cn/post/7581041679190507555</guid>    <pubDate>2025-12-08T08:52:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581041679190507555" data-draft-id="7581041679190491171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="移动端设备上稀奇古怪的前端问题收集（一）"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-08T08:52:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            移动端设备上稀奇古怪的前端问题收集（一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:52:35.000Z" title="Mon Dec 08 2025 08:52:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    31
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为一名开发者，bug 往往是我们最怕遇见的东西；而比遇到 bug 更可怕的事情，是定位不到 bug。作为一名前端开发者，与业务逻辑相关的 bug 还相对好定位、好解决一些；而一些与语法特性、平台与设备差异相关的 bug 则更令人头疼一些。这里记录下我在工作中遇到过的稀奇古怪的前端问题，作为给自己的记录和提醒。</p>
<h2 data-id="heading-0"><strong>用 vh 定义全屏显示的问题</strong></h2>
<p>很多页面因为设计效果的需要，要求正好铺满一整个显示界面、也不允许上下滑动。做类似的需求时，往往直觉会使用这样的代码解决问题：</p>
<pre><code class="hljs language-css" lang="css">{
 <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
}
</code></pre>
<p>这样的代码看似很优雅，但是往往会有兼容性问题——不同浏览器定义的视口高度的定义不一致，导致 <code>100vh</code> 并不能真正覆盖全视口高度；还有不少浏览器视口高度数值不变但实际视口大小可变，比如移动端 Chrome 浏览器的导航栏时不时隐藏但网页获取的视口高度不变，这都会导致最终显示效果不符合预期。</p>
<p>如果要实现全屏幕覆盖不可滑动，更为稳妥和保险的方法是使用绝对定位：</p>
<pre><code class="hljs language-css" lang="css">{
 <span class="hljs-attribute">position</span>: fixed;
 <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
 <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
 <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
 <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-1"><strong>带 alpha 通道的 hex 颜色值失效的问题</strong></h2>
<p>在较新的 web 标准中，hex 格式的颜色代码也可以表示透明度了，只需要在常见的六位 hex 颜色代码后加两位表示透明度的 hex 值，例如 <code>#66ccff</code> 表示一种蓝色，而 <code>#66ccff80</code> 表示透明度 50% 的这种蓝色（80 是 16 进制的 128，是 256 的一半，即 50% 透明度）。虽然直接这样写代码的行为在前端开发中不普遍，但是设计师交付的视觉稿给出的参考值有不少是这种格式。如果直接把这样的颜色代码用于生产中，可能会出现以下两种问题：</p>
<p>◦如果你编写的项目引入了 less 或者 sass，在进行打包构建的操作时，部分预处理器无法正确识别带 alpha 通道的 hex 颜色值，因此这部分代码无法被正确转译，最终构建出的生产环境代码中这部分颜色可能丢失。</p>
<p>◦部分移动端浏览器并未适配带 alpha 通道的 hex 颜色值，因此即使是使用原生 css 完成的代码，也有可能出现在部分手机或部分浏览器颜色不正常的问题。</p>
<h2 data-id="heading-2"><strong>生命周期函数不执行的问题</strong></h2>
<p>在页面刚打开或准备关闭时，我们往往需要进行一些诸如数据初始化、登入登出、数据上报等行为，而这些往往是借助 Vue 或 React 的生命周期函数完成的。不过，生命周期函数不执行也是常被忽略的 bug，详细来说，又可以分为两类原因——</p>
<h3 data-id="heading-3"><strong>组件被 keep alive 导致未被卸载或重新加载</strong></h3>
<p>如果是 Vue 中使用 <code>keep-alive</code> 包裹的组件，或在 React 中使用类似的第三方库 keep alive 的组件，只会在第一次加载时执行生命周期初始化函数，且不会执行生命周期卸载函数。这导致的不符合预期的行为很好解决，只需要使用 <code>onActivated</code> 代替 <code>onMounted</code> ，用 <code>onDeactivated</code> 代替 <code>onUnmounted</code> 即可。</p>
<h3 data-id="heading-4"><strong>页面被直接关闭导致框架生命周期函数无法执行</strong></h3>
<p>不管是 Vue 还是 React，生命周期函数的正确执行都依赖于 Vue 或 React 实例的存在。而当用户直接关闭浏览器页面的时候，Vue 或 React 实例已经被销毁了，生命周期卸载函数当然就无法执行了。处理这种情况也并不麻烦，只需要在生命周期初始化函数中添加对 window 卸载事件的监听，然后把想要进行的操作放到 window 卸载事件函数里就好了。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">onMonted</span>(<span class="hljs-function">() =&gt;</span> {  
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {    
    <span class="hljs-comment">// 需要执行的代码 </span>
  });
});
</code></pre>
<h2 data-id="heading-5"><strong>文本中的 emoji 上下被裁剪</strong></h2>
<p>UGC 内容中经常出现文本和 emoji 混排的场景，而有时可能遇到 emoji 上下边缘被裁剪的问题。这往往是由于开发页面时为了限定文本高度和间距或其他排版方面的要求，将 line-height 和 font-size 设置为同样的值，且 overflow 属性被设置为 hidden 。如果出现类似情况，建议去除 line-height 的限制，而通过 margin 等方式控制行距，从而避免 emoji 被裁减。</p>
<h2 data-id="heading-6"><strong>输入框被弹起的软键盘覆盖的问题</strong></h2>
<p>如果移动端页面中有输入框，那么很可能面临输入框被弹起的软键盘覆盖的问题。一般来讲，对于需要弹起软键盘的场景，较新的浏览器或者移动端 app 的 webview 会自动聚焦到输入框中并滚动到相应位置，来保证输入框的正常显示；但是，对于如下两种情况，弹起的软键盘会将输入框覆盖，影响用户输入。</p>
<h3 data-id="heading-7"><strong>浏览器未能主动聚焦到输入框</strong></h3>
<p>软键盘弹起时，一般会从底部将页面顶起、压缩视口；视口高度变低了，原先处于显示区域的输入框可能就被挤到输入框外了。如果用户使用的浏览器版本较早或 app 内置 webview 较为特殊，有可能在软键盘弹出后浏览器未能主动聚焦到输入框上。这时，开发者必须主动聚焦到输入框并使输入框滚动到视口内。</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">inputEle</span> = document.querySelector(<span class="hljs-string">'#target-input'</span>)<span class="hljs-comment">;inputEle.focus();inputEle.scrollIntoView();</span>
</code></pre>
<h3 data-id="heading-8"><strong>软键盘采用覆盖在视口上层而非压缩视口的方式弹出</strong></h3>
<p>如果浏览器或 webview 版本较为特殊，且输入框处于页面靠下的位置或者针对视口绝对定位于底部，那么可能会面临更加复杂的情况。刚才已经提到，正常情况下，软键盘弹起的标准做法是从底部将页面顶起、压缩视口高度；但是某些情况下，软键盘并不改变视口尺寸，而是直接盖在视口上方。这就导致页面逻辑上是展示完整的、输入框也正常显示在视口中；但软键盘遮挡了半个页面，也就真正意义上“覆盖”在输入框上。目前主流移动端浏览器较新的版本都不会出现这个问题，但是部分 app 内置 webview 会设置为“软键盘覆盖在 webview 上方”；因此要解决这个问题，必须由客户端更改 webview 的软键盘设置。如果是很旧的浏览器版本或者无法推动客户端开发解决问题，那就只能放弃治疗了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gopher 带你学 Serverless 架构：从服务器运维到按需计算的范式转变]]></title>    <link>https://juejin.cn/post/7580740782933622826</link>    <guid>https://juejin.cn/post/7580740782933622826</guid>    <pubDate>2025-12-08T06:20:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580740782933622826" data-draft-id="7580723992498552868" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gopher 带你学 Serverless 架构：从服务器运维到按需计算的范式转变"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-08T06:20:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="没多少逻辑"/> <meta itemprop="url" content="https://juejin.cn/user/2717648475395325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gopher 带你学 Serverless 架构：从服务器运维到按需计算的范式转变
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648475395325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    没多少逻辑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:20:51.000Z" title="Mon Dec 08 2025 06:20:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家有时候是否厌倦了管理服务器、配置环境、处理扩容？别担心，这篇指南为你介绍 <strong>Serverless 架构</strong>的核心概念，拒绝烧脑，主打轻松易懂。我们将 Serverless 的学习之旅分为三个阶段：<strong>理念、核心服务、实战模式</strong>。让我们跟随 Gopher 的脚步，一起探索"无服务器"的世界吧！</p>
<hr/>
<h2 data-id="heading-0">第一部分：理念篇 (The Philosophy)</h2>
<p>在开始写代码之前，我们需要先理解 Serverless 的本质。它不是"没有服务器"，而是"不用管服务器"。</p>
<h3 data-id="heading-1">① 为什么需要 Serverless 架构？</h3>
<p><strong>一句话概念</strong>：Serverless 是用按需计算对抗运维复杂性的架构方法。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
让开发者只关注业务代码，而将服务器管理、扩容、容错等基础设施工作完全交给云平台。你只需上传代码，平台自动运行、扩展和计费。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
传统架构中，开发者需要预估流量、购买服务器、配置环境、监控性能、处理扩容。这些运维工作占据了大量时间，而且资源利用率低（闲时浪费，忙时不够）。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3252d79240a4713ba29024e85b21c8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=qUadTRX76lTJUsSxG7GsBTAomwk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">② FaaS（函数即服务）</h3>
<p><strong>一句话概念</strong>：FaaS 是 Serverless 的核心计算模型。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
将应用拆分为独立的函数（Function），每个函数响应特定事件（HTTP 请求、定时任务、消息队列等）。函数按需执行，执行完立即释放资源。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
FaaS 实现了真正的"按需计算"。你不需要为空闲时间付费，也不需要担心流量突增，平台会自动扩展到成千上万个实例。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c23ac66fd8994efc88ae76fbbd0a2afa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=0hz9c7i2SuUHONuVo9iC%2FjJofhk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">③ 事件驱动触发</h3>
<p><strong>一句话概念</strong>：Serverless 函数由事件触发执行。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
函数不是一直运行的服务，而是被事件唤醒：HTTP 请求、文件上传、数据库变更、定时器、消息队列等。事件到达时，平台自动启动函数实例处理。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
事件驱动是 Serverless 的灵魂。它让函数真正做到"用时即来，用完即走"，实现极致的资源利用率和成本优化。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/993d15e620fa4d09b6e3236113f086a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=snYVJ1O8mQgqje5u2NWzHBW3tQw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">第二部分：核心服务篇 (Core Services)</h2>
<p>理解了 Serverless 的理念后，我们需要了解构建 Serverless 应用的核心服务。</p>
<h3 data-id="heading-5">④ API 网关（API Gateway）</h3>
<p><strong>一句话概念</strong>：API 网关是 Serverless 应用的统一入口。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
API 网关接收 HTTP 请求，路由到对应的函数，并返回响应。它还提供认证、限流、缓存、日志等功能。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
函数本身没有固定的 URL，API 网关为函数提供稳定的 RESTful 或 GraphQL 接口，是 Serverless 应用对外的"门面"。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3281f89d9fdc4db3a113c6b25d273bee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=mhB1kmM2rNlUscR1Vp5QmVCJYb4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">⑤ 对象存储（Object Storage）</h3>
<p><strong>一句话概念</strong>：对象存储是 Serverless 应用的持久化层。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
云端的文件存储服务（如 AWS S3、阿里云 OSS），用于存储静态文件、用户上传、日志等。支持无限扩展，按使用量计费。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
Serverless 函数是无状态的，执行完后所有临时数据都会丢失。对象存储提供了可靠、廉价的持久化方案，而且可以触发函数（文件上传事件）。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68d82d56660b44c98665dd0ff94c64fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=89pWh8Czoyue7kBXy0HFLa2uu2Q%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">⑥ 托管数据库（Managed Database）</h3>
<p><strong>一句话概念</strong>：托管数据库提供 Serverless 化的数据存储。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
云平台提供的数据库服务（如 DynamoDB、Aurora Serverless、Firestore），自动扩展、自动备份、按请求计费。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
传统数据库需要预配置容量、管理连接池、处理扩容。托管数据库与 Serverless 理念一致，让开发者只关注数据模型，不关心底层运维。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1b226f07b36448c857eb2a1705b65df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=nZDC83U%2FejpiGU0gEn4ytDl5ERM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">⑦ 消息队列（Message Queue）</h3>
<p><strong>一句话概念</strong>：消息队列实现 Serverless 函数间的异步通信。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
托管的消息服务（如 AWS SQS、Azure Queue），函数可以发送消息到队列，其他函数订阅队列并异步处理。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
Serverless 函数有执行时间限制（通常几分钟）。对于长时间任务，可以拆分为多个函数，通过消息队列串联，实现异步工作流。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e331386641d54dcba39654527bff2305~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=flBqa0JQmqzAsS1uZQp5swOyMME%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">⑧ 定时任务（Scheduled Tasks）</h3>
<p><strong>一句话概念</strong>：定时触发函数执行。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
通过 Cron 表达式定义执行计划，平台自动在指定时间触发函数。例如：每天凌晨 2 点执行数据备份。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
很多业务需要定期执行（报表生成、数据清理、健康检查）。Serverless 的定时任务无需维护常驻进程，按执行次数计费。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0068a7a5e55e46a780c69aa1df78bff4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=mfFu7gF%2FRKz%2F4CK39v1%2BkYYFaGg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">⑨ 日志与监控（Logging &amp; Monitoring）</h3>
<p><strong>一句话概念</strong>：可观测性是 Serverless 应用的生命线。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
云平台自动收集函数的日志、指标（执行时间、错误率、并发数）和链路追踪，提供可视化监控面板。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
Serverless 函数是短暂的、分布式的，传统的日志文件不适用。托管的日志和监控服务让你能够实时了解系统健康状况，快速定位问题。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3492a18be9249f7a770e69eafe6e596~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=rW6rzdyMqPHfbqlttQKiYhDyXuE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">第三部分：实战模式篇 (Practical Patterns)</h2>
<p>当构建真实的 Serverless 应用时，我们需要一些经过验证的模式来应对挑战。</p>
<h3 data-id="heading-12">⑩ 冷启动优化（Cold Start Optimization）</h3>
<p><strong>一句话概念</strong>：减少函数首次启动的延迟。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
当函数长时间未执行时，平台会回收资源。下次请求到达时需要重新初始化（冷启动），可能耗时几秒。优化方法包括：预热、减小代码包、使用轻量级运行时。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
冷启动是 Serverless 的主要痛点。对于延迟敏感的应用（如 Web API），冷启动会影响用户体验。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e5943707fc0436ab26ceef1225d4932~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=y1nt%2B2RdvGh3u7e3XIhEfQLYeyE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">⑪ 函数编排（Function Orchestration）</h3>
<p><strong>一句话概念</strong>：协调多个函数完成复杂工作流。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
使用编排服务（如 AWS Step Functions）定义函数执行的顺序、条件、并行、重试等逻辑，构建可靠的业务流程。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
单个函数应该保持简单，复杂业务需要多个函数协作。编排服务提供了可视化的工作流定义，处理错误重试、状态管理等复杂问题。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51d01a9219c6419f93e1ed5d6ebf61ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=7n8%2FGsX5Ll40tLic5y59lXC%2BD3s%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-14">⑫ 成本优化（Cost Optimization）</h3>
<p><strong>一句话概念</strong>：Serverless 按使用量计费，但也可能产生意外成本。</p>
<ul>
<li>
<p><strong>怎么做？</strong><br/>
优化策略包括：合理设置内存配置、避免无限循环、使用预留容量、监控异常调用、设置并发限制。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
虽然 Serverless 通常很便宜，但如果配置不当（如内存过大、被 DDoS 攻击），成本可能失控。成本优化是 Serverless 应用的必修课。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0547e7239c854c13be936733ab95b2d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=x9YRWVm4X6FybtE796TYUQq9KUA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-15">总结</h2>
<h3 data-id="heading-16">核心回顾</h3>
<p><strong>一句话总结</strong>：Serverless 让开发者从"管理服务器"解放出来，专注于"创造价值"。</p>
<p><strong>核心意义</strong>：
所有 Serverless 的概念（FaaS、事件驱动、API 网关、对象存储、托管数据库、函数编排）都是为了实现<strong>零运维、弹性扩展、按需付费</strong>的理想架构。只有拥抱 Serverless，才能真正做到"写代码就够了"。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c074ecde35749cdb0d5dfae285e15e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=OGzwH8vxKdPji%2BswGWPz3I46nLY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-17">附录：Serverless 实战案例</h2>
<h3 data-id="heading-18">图片处理服务（Serverless 架构）</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    U[用户上传图片] --&gt; S3[对象存储 S3]
    S3 --&gt;|触发事件| F1[缩略图生成函数]
    S3 --&gt;|触发事件| F2[水印添加函数]
    S3 --&gt;|触发事件| F3[格式转换函数]
    
    F1 --&gt; S3_Thumb[S3 缩略图目录]
    F2 --&gt; S3_Water[S3 水印目录]
    F3 --&gt; S3_Convert[S3 转换目录]
    
    S3_Thumb --&gt; CDN[CDN 分发]
    S3_Water --&gt; CDN
    S3_Convert --&gt; CDN
    
    F1 --&gt; DDB[DynamoDB 元数据]
    F2 --&gt; DDB
    F3 --&gt; DDB
    
    CDN --&gt; U2[用户访问]
</code></pre>
<p><strong>架构特点</strong>：</p>
<ol>
<li><strong>零运维</strong>：无需管理服务器，上传代码即可运行</li>
<li><strong>事件驱动</strong>：文件上传自动触发处理函数</li>
<li><strong>弹性扩展</strong>：并发上传时自动扩展到数千实例</li>
<li><strong>按需付费</strong>：只为实际执行时间和存储空间付费</li>
<li><strong>高可用</strong>：云平台自动处理容错和重试</li>
</ol>
<h3 data-id="heading-19">Serverless vs 传统架构对比</h3>








































<table><thead><tr><th>维度</th><th>传统架构</th><th>Serverless 架构</th></tr></thead><tbody><tr><td><strong>运维负担</strong></td><td>需要管理服务器、配置、扩容</td><td>零运维，平台自动管理</td></tr><tr><td><strong>扩展性</strong></td><td>手动或自动扩容，有上限</td><td>自动无限扩展</td></tr><tr><td><strong>成本模型</strong></td><td>按服务器时间付费（闲时浪费）</td><td>按执行次数和时长付费</td></tr><tr><td><strong>启动速度</strong></td><td>服务常驻，响应快</td><td>冷启动可能有延迟</td></tr><tr><td><strong>适用场景</strong></td><td>长连接、高频调用</td><td>突发流量、定时任务、事件处理</td></tr><tr><td><strong>开发体验</strong></td><td>需要关注基础设施</td><td>只关注业务代码</td></tr></tbody></table>
<h3 data-id="heading-20">最佳实践建议</h3>
<ol>
<li><strong>函数设计</strong>：保持函数单一职责，粒度适中（不要太大也不要太碎）</li>
<li><strong>状态管理</strong>：函数无状态，状态存储到数据库或对象存储</li>
<li><strong>错误处理</strong>：实现重试机制和死信队列</li>
<li><strong>安全性</strong>：最小权限原则，使用 IAM 角色控制访问</li>
<li><strong>监控告警</strong>：设置关键指标告警（错误率、延迟、成本）</li>
<li><strong>测试策略</strong>：本地模拟环境 + 云端集成测试</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌TPU杀疯了，产能暴涨120%、性能4倍吊打，英伟达还坐得稳吗？]]></title>    <link>https://juejin.cn/post/7581664885862252554</link>    <guid>https://juejin.cn/post/7581664885862252554</guid>    <pubDate>2025-12-09T10:31:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581664885862252554" data-draft-id="7581667332306944038" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌TPU杀疯了，产能暴涨120%、性能4倍吊打，英伟达还坐得稳吗？"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-09T10:31:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌TPU杀疯了，产能暴涨120%、性能4倍吊打，英伟达还坐得稳吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T10:31:55.000Z" title="Tue Dec 09 2025 10:31:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读28分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>英伟达的「护城河」正在崩塌？谷歌TPU凭什么让巨头们疯狂倒戈？</p>
</blockquote>
<p>谷歌这次要动真格了。</p>
<p>摩根士丹利最新研报透露了一个重磅消息：谷歌 TPU 的产能即将迎来爆炸式增长。更关键的是，供应链那边传来信号，TPU 供应的不确定性基本解决了，这意味着谷歌可以放开手脚对外卖芯片了。</p>
<p>摩根士丹利直接把预测往上猛调，2027 年 TPU 产量将达到 500 万块，2028 年更是要冲到 700 万块。要知道，之前的预测可是 300 万块和 320 万块，这波上调幅度分别高达 67% 和 120%。换句话说，未来两年谷歌要生产 1200 万块 TPU，而过去四年加起来才生产了 790 万块。</p>
<p>这笔生意有多赚？摩根士丹利给出一个测算，谷歌每卖出 50 万块 TPU 芯片，2027 年就能进账约 130 亿美元，每股收益增加 0.40 美元。</p>
<p>战略层面看，谷歌的打法也很明确，直接向第三方数据中心销售 TPU，作为谷歌云平台 (GCP) 业务的重要补充。虽然大部分 TPU 仍会用在谷歌自家的 AI 训练和云服务上，但如此大的产能储备，显然是在为更广泛的商业化做准备。</p>
<p>摩根士丹利认为，这些迹象都是谷歌 TPU 销售战略的早期信号。眼下全行业对先进 AI 算力需求爆棚，谷歌显然不想错过这波红利。</p>
<p>受 AI 芯片需求强劲的影响，摩根士丹利顺手把联发科评级上调至「增持」，理由是整个芯片供应链都在受益。</p>
<p>英伟达在 AI 芯片市场一家独大的格局，可能要迎来真正的挑战者了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68d5f45acce14933a35fc9db856efa2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765881115&amp;x-signature=bxxCmS4usvhRBTacyznHtBF1GuM%3D" alt="图片" loading="lazy"/></p>
<p>（动图来自博主赛博轩Albert)</p>
<p>最近，谷歌 TPU 与英伟达 GPU 的技术较量成为业内热议话题。我们关注到一篇题为《2025 年 AI 推理成本：谷歌 TPU 为何比英伟达 GPU 性能高出 4 倍》的报道，全面解析了两者的技术差异和性能对比。至于报道中的观点，仅供参考。</p>
<p>以下是机器之心编译：</p>
<p>在激烈的 AI 霸主之争中，英伟达长期以来一直稳坐霸主地位。其 GPU 推动了机器学习的爆炸式增长，将抽象的神经网络变为现实，并打造了一个价值数万亿美元的商业帝国。但随着 AI 格局的演变，英伟达的「盔甲」也开始出现裂痕。</p>
<p>从模型训练（英伟达的强项）到推理（即这些模型的实时应用），市场格局正在发生重塑。而引领这场变革的，正是谷歌的张量处理单元（TPU），它带来的无与伦比的效率和成本优势，或许将终结英伟达的垄断地位。</p>
<p>到 2030 年，推理将消耗 75% 的人工智能计算资源，创造一个规模达 2550 亿美元的市场，并以每年 19.2% 的速度增长。然而，大多数公司仍然以训练成本为优化目标。</p>
<p>这并非炒作，而是经济因素。训练是一次性的冲刺，而推理则是一场永无止境的马拉松。随着像 OpenAI 这样的公司疲于应对飞涨的推理成本（预计仅 2024 年就将达到 23 亿美元，远超训练 GPT-4 的 1.5 亿美元成本），谷歌的 TPU 凭借其高性价比脱颖而出。在这篇深度分析中，作者将探讨 TPU 如何赢得推理之战，并以行业领导者的实际迁移案例为佐证，同时解释为何这一转变预示着英伟达即将走向衰落。</p>
<p>AI 算力的分野：训练与推理</p>
<p>要了解正在发生的巨大转变，我们首先必须剖析人工智能计算的两大支柱：训练和推理。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95a71fe952d042cf81a8e3e728f02966~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765881115&amp;x-signature=c5BinNQ2wUnT%2BxVsEbmLLFgXqk8%3D" alt="图片" loading="lazy"/></p>
<p>训练：英伟达的巅峰之作</p>
<p>训练是将海量数据集输入神经网络，以「教会」它们模式、预测和行为的密集型过程。它需要大量的计算资源，需要数千个 GPU 进行并行处理，以完成矩阵乘法和反向传播等运算。英伟达正是凭借此建立了自己的帝国。其 CUDA 软件生态系统和 Hopper 架构（例如 H100 GPU）在处理这种高强度计算任务方面表现出色，从而实现了 GPT-4 和稳定扩散等突破性成果。</p>
<p>但训练是有限的，一旦模型被训练完成，繁重的工作就停止了。成本是前置的：单次运行可能消耗数百万 GPU 小时，但它是有限的。对于 GPT-4 来说，这笔一次性账单达到了 1.5 亿美元。英伟达的 GPU 凭借其在图形、模拟和通用计算方面的多功能性，成为这一阶段的首选。到 2023 年，英伟达控制了超过 80% 的 AI 芯片市场，仅数据中心销售就带来 600 亿美元的收入。</p>
<p>推理：永无止境的钱坑</p>
<p>推理则完全不同。这是部署阶段：每次 ChatGPT 查询、图像生成或推荐算法都会在新数据上运行已训练的模型。与训练不同，推理是持续进行的：处理的每一个 token、每一次用户交互、每一秒的操作都会产生成本。</p>
<p>接下来，残酷的数学计算将揭示真相。推理需求并非一次性的，而是随着使用量的增长而呈指数级增长。OpenAI 2024 年的推理支出飙升至 23 亿美元，是 GPT-4 训练成本的 15 倍。在全球范围内，随着 AI 集成到从自动驾驶汽车到个性化广告等各种应用中，机器学习推理成本正在爆炸式增长。分析师估计，到 2026 年，推理需求将比训练需求高出 118 倍。到 2030 年，推理计算可能占人工智能总计算量的 75%，从而推动 7 万亿美元的基础设施投资。</p>
<p>英伟达的 GPU 虽然针对训练的高吞吐量并行性进行了优化，但在这里表现不佳。它们会消耗大量的电力和内存来处理持续的查询，导致效率低下。进入推理时代：在未来，每次查询的成本至关重要。</p>
<p>谷歌的 TPU：专为推理时代而设计</p>
<p>谷歌并非偶然发现了 TPU。它为自身庞大的网络帝国精心打造了 TPU，为搜索、YouTube 推荐和全球规模的翻译服务提供强大支持。TPU 于 2016 年推出，是一种专用集成电路（ASIC），专为张量运算而设计，而张量运算正是人工智能的核心数学运算。</p>
<p>架构优势：为什么 TPU 能碾压推理</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81339f62ed4c461f99d8ac4767c80b88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765881115&amp;x-signature=xHKkQzdjB4eGwVdPmUzC2LSrUXc%3D" alt="图片" loading="lazy"/></p>
<p>TPU 在流式阵列中表现出色，这种硬件网格能够高效地传输数据，无需频繁的内存读取，从而大幅降低延迟和能耗。而英伟达 GPU 则如同功能强大的瑞士军刀，能够即时解码指令，但这会增加额外的开销。对于推理任务而言，这意味着在 LLM 等工作负载下，TPU 的性价比是英伟达 H100 的四倍。谷歌最新的 Ironwood (v7) TPU 的速度是 v6 的四倍，峰值计算能力是 v5p 的十倍，每一代产品都能带来 2-3 倍的性价比提升。</p>
<p>能效是另一项杀手级优势。TPU 采用垂直供电设计，在执行搜索查询时比 GPU 节能 60-65%。在 MLPerf 基准测试中，TPU v5e 在 9 个推理类别中的 8 个类别中领先，例如 BERT 服务等任务的完成速度比 A100 GPU 快 2.8 倍。</p>
<p>价格是决定性因素，按需使用的 TPU v6e 起价为每小时 1.375 美元，签订长期合约后可降至每小时 0.55 美元，并且无需支付英伟达的授权费。用户反馈，一个 v5e 扩展舱相比八个 H100 扩展舱，「价格更低」，性价比更高。</p>
<p>2025 年 AI 芯片对比：TPU 与 GPU 正面交锋</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15f769b96748433f8e8452a600f304d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765881115&amp;x-signature=wQ41QFhDZzAKJDUc%2F07UDvT98aw%3D" alt="图片" loading="lazy"/></p>
<p>英伟达优势逐渐消失</p>
<p>在纯粹的推理领域，英伟达的优势（灵活性）反而成了劣势。GPU 虽然能处理各种任务，但在非 AI 操作上却会浪费大量资源。随着推理逐渐占据主导地位，像 TPU 这样的专用 ASIC 芯片正在削弱英伟达的这一优势。谷歌云的高管们预计，仅 TPU 的采用就能占到英伟达 10% 的收入。英伟达的毛利率高达 70-80%，来自高效竞争对手的价格压力可能会挤压其利润空间。</p>
<p>ASIC 与 GPU 的 AI 之争：为什么专用芯片主导深度学习推理？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eff60740299b48328a609bfccaa7d688~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765881115&amp;x-signature=YT6vQJJ2Jrar%2FKRFI9cP6JNZ1S8%3D" alt="图片" loading="lazy"/></p>
<p>要理解为什么 TPU 正在瓦解英伟达的霸主地位，我们需要掌握 ASIC（专用集成电路）和 GPU（图形处理器）之间根本的架构差异。这不仅仅是技术细节的问题，而是决定数十亿美元计算支出成败的关键所在。</p>
<p>什么是 ASIC 芯片？它与 GPU 有何不同？</p>
<p>GPU 是通用型处理器。 最初设计用于图形渲染（因此得名「图形处理单元」），英伟达利用其并行处理能力，将其重新应用于人工智能领域。像 H100 这样的 GPU 包含数千个 CUDA 核心，可以处理各种工作负载：游戏、视频编码、科学模拟、加密货币挖矿，当然还有神经网络。这种多功能性使 GPU 成为人工智能早期时代的瑞士军刀。</p>
<p>专用集成电路（ASIC）是专业芯片。它们从一开始就为单一用途而设计， 牺牲灵活性以换取极高的效率。谷歌的 TPU 专为矩阵乘法和张量运算而硬编码，这是神经网络的数学基础。每个晶体管、每条电源轨、每条数据通路都针对一个目标进行优化，以闪电般的速度和最小的能量损耗完成张量运算。</p>
<p>不妨这样理解，GPU 就像一位多才多艺的运动员，精通多项运动；而 ASIC 则像一位奥运短跑运动员，在某一方面技高一筹。对于需要 24✖️7✖️365 全天候运行的推理工作负载，你需要的是这位短跑运动员。</p>
<p>ASIC 优势：为什么专业化能够规模化制胜?</p>
<p>能效方面： ASIC 芯片消除了指令解码的开销。GPU 动态地获取、解码和执行指令，消耗大量周期和电力。TPU 则在硬件中执行固定操作，在相同工作负载下能耗降低 60-65%。在数据中心规模下，这意味着节省数百万美元的电力成本并减少冷却基础设施。</p>
<p>降低延迟： TPU 中的脉动阵列可创建确定性的数据流，信息在芯片内同步流动，如同精心编排的装配线，而 GPU 依赖于具有不可预测访问模式的内存层次结构（L1/L2 缓存、HBM），从而引入延迟峰值。对于实时推理（聊天机器人、自动驾驶汽车、金融交易）而言，毫秒级的延迟至关重要。</p>
<p>每次操作成本： ASIC 通过去除未使用的电路，以更少的投入提供更高的计算能力。在 Transformer 型号上，TPU 的每美元性能是 H100 的四倍，因为每一平方毫米的硅片都物尽其用。GPU 则承载着诸多冗余：纹理单元、光栅化操作、显示控制器等等，所有这些在 AI 推理期间都处于闲置状态。</p>
<p>可扩展性： ASIC 可以紧密集成到定制系统中。谷歌的 TPU pod 通过定制互连连接 4096 个芯片，实现了 PCIe 受限 GPU 无法实现的近乎线性的扩展。这种架构上的自由度使超大规模数据中心能够构建完全符合自身需求的推理集群。</p>
<p>权衡取舍：灵活性与效率</p>
<p>ASIC 芯片并非万能，它们的专用性也是它们的局限性。训练新的模型架构、尝试新的层或运行非 AI 工作负载都需要 GPU 的灵活性。因此，未来并非「ASIC vs GPU」之争，而是战略部署：GPU 用于研究和训练，ASIC 用于生产推理。</p>
<p>新兴的 ASIC 芯片格局： 除了 TPU 之外，亚马逊的 Trainium、微软的 Maia 以及 Cerebras 和 Groq 等初创公司正以各种专用芯片涌入市场。每款芯片都针对特定的细分领域（LLM 推理、训练、稀疏模型），从而打破了曾经由英伟达统一的 CUDA 王国。</p>
<p>结论是什么？对于以推理为主导的未来（到 2030 年将占计算总量的 75%），ASIC 芯片不仅具有竞争力，而且势在必行。物理定律决定了这一点：大规模专业化是无法超越的。英伟达深谙此道，因此大力推进像 Blackwell 这样针对推理优化的架构，但他们试图让一把瑞士军刀比手术刀更锋利。</p>
<p>现实世界的胜利：AI 巨头押注 TPU</p>
<p>迁移案例就是最好的证明。全球顶尖的人工智能运营商正在放弃英伟达处理器，转而使用 TPU，从而大幅降低成本，并以前所未有的方式扩展推理能力。</p>
<p>Midjourney 的 65% 成本削减</p>
<p>图像生成器 Midjourney 曾是 GPU 的主力军，但在 2024 年转向 TPU 后，便再也没有回头。推理成本骤降 65%，从每月 200 万美元降至 70 万美元。根据 Cohere 的类似基准测试，使用 TPU v6e 后，生成任务的吞吐量提升了 3 倍。「TPU 在推理工作负载方面的经济效益」被证明具有变革性意义，释放了研发资金。</p>
<p>Anthropic 的百万 TPU 登月计划</p>
<p>Claude 的开发商 Anthropic 公司与谷歌达成了一项价值数百亿美元的交易，承诺提供多达一百万个 TPU。到 2026 年，这将释放超过 1GW 的计算容量，并将 TPU 与亚马逊 Trainium 和英伟达的相结合，构建多元化的技术栈。首席执行官 Thomas Kurian 表示，「卓越的性价比和效率」是促成此次交易的关键因素。自 2023 年以来，TPU 一直为 Claude 提供计算动力。</p>
<p>Meta 的数十亿美元转向</p>
<p>Meta 是英伟达最大的客户（计划 2025 年支出 720 亿美元），目前正就一项价值数十亿美元的 TPU 部署进行深入洽谈。Meta 计划从 2026 年通过谷歌云租赁 TPU 开始，并计划在 2027 年之前部署本地 TPU，用于 Llama 微调等需要大量张量的工作负载。这种混合策略（英伟达提供灵活性，TPU 提供效率）预示着更广泛的资源迁移趋势。</p>
<p>这些并非个例。Salesforce 和 Cohere 都实现了 3 倍的增长，谷歌的 Gemini 运行在数万个 TPU 上。那些精明的运营商纷纷抛售英伟达的溢价产品，转而选择谷歌的性价比更高的产品。</p>
<p>何时选择 TPU 与英伟达显卡：AI 基础设施的决策矩阵</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1b962416e254a5b9d399c7c05e8c2de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765881115&amp;x-signature=JfxEKU4P46hfhQWsZanvU1UtVlU%3D" alt="图片" loading="lazy"/></p>
<p>选择 TPU 还是英伟达 GPU 并非非此即彼。这取决于您的工作负载、规模和基础架构策略。以下是一个基于实际部署的实用框架：</p>
<p>如果您符合以下条件，请选择 TPU：</p>
<p>成本阈值： 推理成本超过每月 5 万美元。在此规模下，TPU 节省的成本（40-65%）足以抵消迁移带来的额外开销。</p>
<p>工作负载适用性： 大规模运行 LLM 服务、推荐系统、图像生成或视频处理。这些张量密集型操作正是 TPU 的优势所在。</p>
<p>云平台部署： 熟悉 Google Cloud 生态系统或愿意采用 TensorFlow/JAX 框架。</p>
<p>可持续发展目标： 环境和能源效率是重中之重。TPU 的功耗比同等 GPU 配置低 60-65%，这对实现 ESG 目标至关重要。</p>
<p>可预测的扩展： 具有一致流量模式的大容量生产推理，而不是实验性研究。</p>
<p>如果您需要以下功能，请选择英伟达显卡：</p>
<p>训练灵活性： 构建自定义架构、多模态模型，或进行需要 CUDA 特定库和工具链的研究。</p>
<p>多云战略： 要求硬件能够在 AWS、Azure 和本地数据中心之间移植，且不受供应商锁定。</p>
<p>多样化的工作负载： 除了机器学习任务外，还可以运行图形渲染、模拟、游戏或非人工智能计算。</p>
<p>预算限制： 每月 AI 计算预算低于 2 万美元。设置开销和迁移成本使得 TPU 在小规模应用中不太划算。</p>
<p>前沿模型： 尝试使用尚未针对 TPU 编译进行优化或需要自定义内核的架构。</p>
<p>混合战略：企业行动指南</p>
<p>遵循 Meta 的模式：部署 Nvidia H100 用于训练、实验和模型开发，使用 TPU v6e/v7 进行生产推理服务。这种模式兼顾了灵活性和成本优化，在保持研究灵活性的同时，可节省 40-50% 的总计算资源。</p>
<p>实施时间表： 大规模 TPU 迁移预计需要 2-6 个月，包括代码库适配、测试和流量逐步转移。像 Midjourney 这样的公司通过降低成本，在 3-4 个月内即可实现投资回报。</p>
<p>未被定价的未来：推理的 75% 愿景与大规模 AI 的隐性成本</p>
<p>没人真正定价的是什么？推理的规模是无限的。训练只是一个里程碑，推理才是经济的命脉。每一次查询（每天数十亿次）都会持续增加成本。OpenAI 23 亿美元的账单，那只是 2024 年的费用；如果规模扩大到 2030 年占据 75% 的市场份额，那将是数万亿美元。</p>
<p>预测结果描绘出一幅鲜明的画面：</p>
<p>市场增长： 到 2030 年，人工智能推理市场规模将达到 2550 亿美元，复合年增长率达 19.2%。这将远远超过训练市场，后者随着基础模型的成熟而趋于平稳。</p>
<p>能源危机： 用于前沿模型的 5GW 集群，堪比小国的电网。随着推理集群的扩张，数据中心面临容量限制。</p>
<p>成本倍数： 训练基线成本为 15 倍，但实际使用量会进一步推高成本。每增加一个用户、每增加一项功能、每次实时交互都会增加费用。</p>
<p>总拥有成本 (TCO)： 除了硬件成本外，还要考虑冷却、电力基础设施和碳信用额度。如果将这些运营成本考虑在内，TPU 的效率优势将提升至 2-3 倍。</p>
<p>未解决的问题：环境代价。推理的排放量可能远超训练。仅 ChatGPT 每年就排放 12800 公吨二氧化碳，是 GPT-3 训练的 25 倍。TPU 的效率（比上一代高出 15 倍）使谷歌成为可持续发展的选择，这在监管日益严格的今天至关重要。</p>
<p>深度学习推理优化的挑战不仅仅是技术性的，更是关乎企业生存的。忽视这一转变的公司将面临成本结构失衡的风险，导致无法大规模盈利。</p>
<p>对利益相关者的意义：TPU 革命的连锁反应</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f79df42e102c46258539198bf7ce0cd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765881115&amp;x-signature=tGanE%2FZCYOc4aYDL20wlYQ689dw%3D" alt="图片" loading="lazy"/></p>
<p>TPU 与 GPU 之争并非抽象概念，它重塑了整个商业模式、投资理念和职业发展轨迹。以下是不同参与者应该如何应对。</p>
<p>对于 AI 初创公司：大均衡化</p>
<p>TPU 降低了推理成本，使精简团队也能与巨头竞争。Midjourney 节省了 65% 的成本，从而延长了资金使用周期并加快了扩展速度。种子轮公司如果使用 TPU 进行推理，就能实现以往只有拥有巨额 GPU 预算的 B 轮及以后融资阶段的公司才能达到的成本结构。</p>
<p>审核您的推理费用。如果您每月在英伟达显卡上的支出超过 2 万美元，请开展 TPU 试点项目。TensorFlow 模型优化和 JAX 等工具可使迁移过程比以往任何时候都更加顺畅。</p>
<p>对于企业 CTO：战略必要性</p>
<p>15 倍的推理成本倍增效应要求我们现在就做出战略性的硬件选择，而不是以后。到 2026 年，将高容量推理迁移到 TPU 可以节省 40-60% 的计算预算，从而将资金用于创新而不是基础设施建设。</p>
<p>隐藏的好处： TPU 的低功耗可降低数据中心冷却成本 30-40%，同时满足预算和可持续性要求。</p>
<p>风险： 行动迟缓意味着竞争对手将获得成本优势，而且这种优势会逐季度累积。例如，竞争对手每年在推理方面节省 500 万美元，并将其重新投入到更优的模型中，从而导致差距不断扩大。</p>
<p>对于英伟达投资者：利润率压缩的威胁</p>
<p>尽管英伟达 2024 年数据中心业务营收预计将达到 600 亿美元，但 TPU 的普及应用却带来了长期的利润风险。如果谷歌能够占据哪怕 10% 的推理工作负载（考虑到目前的迁移情况，这还是保守估计），那么每年英伟达的利润就将面临超过 60 亿美元的损失。</p>
<p>对位：  英伟达的 Blackwell 架构 （预计 2025 年发布）承诺提升推理效率。然而，早期基准测试表明，在纯粹的大规模推理方面，TPU 仍保持着 2-3 倍的成本优势，这限制了 Blackwell 的影响。</p>
<p>密切关注英伟达 2026 年第一季度财报。如果推理驱动的收入环比增长放缓至 15% 以下，则表明 TPU 蚕食效应确实存在。</p>
<p>对于开发者和机器学习工程师：职业未来保障</p>
<p>CUDA 生态系统长达 15 年的护城河正在逐渐消失。随着 JAX、TensorFlow 和 TPU 优化技术的普及，学习这些技术能够确保职业发展的未来竞争力。2024 年，「TPU 优化工程师」的职位发布量同比增长了 340%。</p>
<p>技能转变： 从通用 GPU 编程转向 ASIC 感知模型设计。理解脉动阵列的编译器优化，其价值堪比 2020 年的 CUDA 内核调优。</p>
<p>机遇： 早期 TPU 专业知识可获得 20-30% 的薪资溢价，因为公司都在争相寻找人才来执行迁移。</p>
<p>华尔街的英伟达大撤退：为何精英投资者抛售 60 亿美元 GPU 股票</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6efcd7693de04deebaffe456e8c5ba2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765881115&amp;x-signature=0AO9ZsqfjswxOkFzvneoicraK%2Fc%3D" alt="图片" loading="lazy"/></p>
<p>随着推理革命的加速，英伟达曾经不可撼动的统治地位正面临着华尔街最敏锐的投资者们的严峻现实检验，他们正悄然退出市场。</p>
<p>科技远见家彼得・蒂尔 (Peter Thiel) 旗下的对冲基金 Thiel Macro LLC 在 2025 年第三季度抛售了其持有的全部 537742 股英伟达股票（截至 9 月底，价值约 1 亿美元），并将所得资金重新投资于苹果和微软等更具防御性的股票，以应对日益增长的人工智能泡沫破裂的担忧。</p>
<p>这并非孤例。就在几周前，日本软银也抛售了其持有的全部 3210 万股股票，套现高达 58.3 亿美元，并将资金投入 OpenAI，以期从硬件炒作转向软件生态系统。就连预言了 2008 年金融危机的《大空头》预言家迈克尔・伯里，也在 2025 年末斥资 920 万美元买入了针对英伟达的看跌期权，押注随着 Meta 和 Oracle 等超大规模数据中心运营商面临数据中心过剩和 GPU 库存贬值的问题，英伟达的估值将会暴跌。</p>
<p>这些精英投资者并非放弃人工智能。他们只是在抛售英伟达高达 70 倍预期市盈率的股票，因为谷歌 TPU 的竞争日益激烈，以及随着训练阶段的辉煌逐渐褪去，推理成本不断攀升侵蚀利润率的担忧令他们感到不安。尽管英伟达盈利强劲，但其股价仍较 10 月份的高点下跌了 12%，机构投资者的资金外流也反映了科技行业的整体焦虑情绪。</p>
<p>这波超过 60 亿美元的资金外流凸显了一个残酷的现实：当推理运算的结果对 ASIC 芯片比对 GPU 芯片更有利时，即使是人工智能领域的巨头也不得不屈服于谨慎的资本外逃浪潮。</p>
<p>解码抛售潮：精明投资者看到的三个危险信号</p>
<p>供应过剩和贬值： 超大规模数据中心在 2023-2024 年间大量购入 H100 显卡，为训练数据激增而扩容，但这些激增并未完全实现。如今，数据中心使用的资产正在贬值（GPU 价值每年下降 30-40%），而推理需求却需要更便宜的 ASIC 芯片。这种供需不匹配令那些预期 GPU 将持续升级的成长型投资者感到恐慌。</p>
<p>利润率即将压缩： TPU 将主导推理任务（未来 75% 的计算量），这意味着英伟达必须在价格上展开竞争。其 70-80% 的毛利率将面临不可避免的挤压。即使毛利率下降 10 个百分点，也会使目前的估值倍数大幅下滑。</p>
<p>多元化现实： 像 Meta 这样的客户并没有完全放弃英伟达，但他们正在积极进行多元化投资。客户在 TPU 上的每一美元支出，都意味着英伟达少赚一美元。随着 Meta、Anthropic 和 Midjourney 等公司公开拥抱替代方案，英伟达的收入集中度风险已变得岌岌可危。</p>
<p>当然也有不同观点，英伟达仍然占据 80% 的市场份额，布莱克威尔即将加入，CUDA 的护城河也不会在一夜之间崩塌。</p>
<p>挑战与未来之路</p>
<p>TPU 并非完美无缺。与英伟达的 CUDA 通用性相比，其生态系统与 TensorFlow/JAX 的紧密联系限制了灵活性。扩展 TPU（最多可达 4096 个芯片）需要 Google Cloud 的投入，而本地部署的 TPU 市场尚处于起步阶段，混合架构将会持续存在：Nvidia 用于训练的极端情况，TPU 用于推理的大规模应用。</p>
<p>新兴竞争： 亚马逊的 Trainium 和微软的 Maia 芯片瞄准相似的细分市场，加剧了 ASIC 市场的碎片化。然而，这两款芯片的成熟度（已发展九代）和规模（为谷歌的万亿查询基础设施提供支持）都无法与 TPU 相提并论。</p>
<p>供应链： 谷歌与博通和台积电合作，加速 v7 芯片的生产，以解决产能问题。到 2026 年第二季度，TPU 的供应量应该能够满足需求，从而消除市场采用障碍。</p>
<p>目前的势头对谷歌有利。随着 v7 TPU 在 2025 年量产，以及博通 / 台积电等合作伙伴加速生产，供应链正在逐步完善。随着推理能力的激增，TPU 的应用也将随之扩展。</p>
<p>2025 年人工智能工作负载中 TPU 与 Nvidia GPU 的比较</p>
<p>对于所有人工智能工作负载，TPU 都比 Nvidia GPU 更好吗？</p>
<p>不。TPU 在推理和张量密集型操作方面表现出色，在运行 LLM、图像生成和推荐等模型时，性价比比 GPU 高出 4 倍。Nvidia GPU 在训练各种模型、需要灵活性的研究以及游戏、图形渲染和通用计算等非张量工作负载方面仍然更胜一筹。最佳策略通常是混合使用：TPU 用于生产推理，GPU 用于实验。</p>
<p>我可以在 Google Cloud 之外使用 TPU 吗？</p>
<p>目前，TPU 主要通过 Google Cloud Platform 提供，但大型企业客户（例如 Meta 的 2027 年计划）也开始采用本地部署方案。Nvidia 在 AWS、Azure 和本地部署方面的广泛可用性仍然是多云战略的优势。不过，Google 正在通过合作伙伴关系和托管选项来扩展 TPU 的访问权限。</p>
<p>英伟达的 Blackwell 芯片能否在推理方面与 TPU 展开竞争？</p>
<p>英伟达的 Blackwell 架构（预计 2025 年发布）承诺通过 FP4 精度和更高的内存带宽等特性来提升推理效率。然而，早期基准测试和架构分析表明，由于 ASIC 芯片的专用性，TPU 在大规模纯推理方面仍保持着 2-3 倍的成本优势。Blackwell 架构将比 Hopper（H100）更具竞争力，但可能无法完全弥补在高容量推理工作负载方面的差距。</p>
<p>从英伟达平台迁移到 TPU 的成本和时间是多少？</p>
<p>迁移需要将代码从 CUDA/PyTorch 适配到 TensorFlow/JAX，大型部署通常需要 2-6 个月，具体时间取决于模型复杂度。成本包括工程时间（大型迁移需要 4-8 个全职员工月）以及过渡期间的并行基础设施。然而，像 Midjourney 这样的公司可以通过持续节省 40-65% 的成本，在 3-4 个月内收回这些成本。规模较小的项目（每月推理成本低于 5 万美元）可能不值得投入这些额外费用。</p>
<p>TPU 如何处理自定义 AI 模型和架构？</p>
<p>TPU 在标准架构（Transformer、CNN、RNN）上表现出色，但对于自定义操作则需要重新编译。JAX 的 XLA 编译器可以自动处理大多数情况，但对于特殊架构可能需要优化。英伟达的 CUDA 为实验性工作提供了更大的灵活性。最佳实践：先在 GPU 上进行原型设计，待架构稳定后再针对 TPU 优化生产模型。</p>
<p>那么，像 AMD 或 Intel 芯片这样的 GPU 替代方案，用于人工智能推理又如何呢？</p>
<p>AMD 的 MI300 和英特尔的 Gaudi 芯片面向相似的市场，但在生态系统成熟度和规模化应用方面略逊一筹。AMD 的产品相比英伟达的产品可节省 30-40% 的成本，但其效率仍不及 TPU。英特尔的 Gaudi 芯片展现出一定的潜力，但目前量产部署有限。展望 2025-2026 年，TPU 仍然是推理优化领域相对于英伟达的最佳选择，其他方案则作为备选。</p>
<p>结论：TPU 驱动的人工智能世界即将到来</p>
<p>英伟达凭借训练技术的辉煌历史建立起了庞大的计算帝国，但推理才是未来，在这个领域，英伟达的架构优势正在逐渐消失。谷歌的 TPU 拥有四倍的性价比，正吸引着 Midjourney（成本降低 65%）、Anthropic（100 万颗芯片）和 Meta（数十亿美元的谈判）等巨头。</p>
<p>参考链接：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ainewshub.org%2Fpost%2Fai-inference-costs-tpu-vs-gpu-2025" target="_blank" title="https://www.ainewshub.org/post/ai-inference-costs-tpu-vs-gpu-2025" ref="nofollow noopener noreferrer">www.ainewshub.org/post/ai-inf…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.investing.com%2Fnews%2Fstock-market-news%2Falphabet-could-see-billions-in-added-revenue-from-tpu-sales-morgan-stanley-says-4383972%3Futm_source%3Dchatgpt.com" target="_blank" title="https://www.investing.com/news/stock-market-news/alphabet-could-see-billions-in-added-revenue-from-tpu-sales-morgan-stanley-says-4383972?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">www.investing.com/news/stock-…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文讲清：RAG的7种优化方法，看完简直醍醐灌顶！]]></title>    <link>https://juejin.cn/post/7581666412021055497</link>    <guid>https://juejin.cn/post/7581666412021055497</guid>    <pubDate>2025-12-09T09:06:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581666412021055497" data-draft-id="7581658157145325618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文讲清：RAG的7种优化方法，看完简直醍醐灌顶！"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-12-09T09:06:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文讲清：RAG的7种优化方法，看完简直醍醐灌顶！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T09:06:10.000Z" title="Tue Dec 09 2025 09:06:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大规模语言模型（LLMs）已深度融入日常生活与职场实践，凭借其卓越的多功能性和智能水平，彻底重塑了人类与信息交互的模式。</p>
<p>尽管如此，这类模型仍存在明显局限。它们可能输出具有误导性的虚构内容（"幻觉"），所依据的知识库存在滞后性，对专业领域知识的处理效率有限，且缺乏行业纵深洞察力，逻辑推理能力也尚未完善。</p>
<p>在实际应用场景中，数据必须保持动态更新以追踪最新进展，生成内容需具备完整的可追溯性，从而实现成本优化和数据隐私保护。</p>
<p>单纯依赖这类"黑盒"系统已无法满足需求，必须开发更精准的解决方案来应对复杂挑战。</p>
<p>检索增强生成技术（Retrieval-Augmented Generation，RAG）正是为填补这一空白而诞生，成为推动LLM时代发展的关键技术方向。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1953cadb98bb42fda34fd7431518c969~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875969&amp;x-signature=D1UCdMLVwzmhDSXbZEQUGO%2BjfW0%3D" alt="图片" loading="lazy"/></p>
<p><strong>更多AI大模型学习视频及资源，都在<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</strong></p>
<p>基础RAG架构的流程设计极为简洁，其核心特征在于数据流的单向性。这种架构的快速部署优势显著，但距离生产级应用仍存在差距。</p>
<p>为提升文档召回率与系统鲁棒性，主要优化方向可归纳为两类：</p>
<p><strong>‌扩展召回通道‌</strong>：采用查询变换（子查询、RAG-Fusion）、混合检索等多路召回策略，以最大化信息覆盖范围；</p>
<p><strong>‌强化反馈闭环‌</strong>：通过重排序（Rerank）、回溯提示（Back-Prompting）、Self-RAG等技术对初始结果进行迭代优化，从而提升输出准确性。</p>
<p>经此优化后，RAG架构中的数据流从单向传输转变为多维度并行交互模式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3246c3e165e646f0916e25b06f9b8d89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875969&amp;x-signature=aZ56cVEwj%2Bw5sfPo%2FFLkgHL3Mrc%3D" alt="图片" loading="lazy"/></p>
<p><strong>一、</strong>* <em>文本数据预处理</em>*</p>
<p>无论RAG系统的架构设计如何演进，基于数据驱动的本质特性决定了‌高信噪比数据‌始终具有核心价值。在检索流程前对原始数据的优化策略可归纳为以下关键方法：</p>
<p><strong>‌实体解析‌</strong></p>
<p>通过消歧实现实体与术语的统一引用。例如将"LLM"、"大语言模型"和"大模型"映射为标准化术语体系。</p>
<p><strong>‌文档划分‌</strong></p>
<p>需科学规划文档主题分布策略：同类主题文档应采取集中存储还是分布式存放？当人类专家都无法快速定位相关文档时，检索系统必然面临相同困境。</p>
<p><strong>‌数据增强‌</strong></p>
<p>引入同义替换、语义重构及多语言翻译等手段，显著提升知识库的语义覆盖维度。</p>
<p><strong>‌时效数据处理‌</strong></p>
<p>针对动态更新领域（如时效性内容），需建立文档版本控制机制，自动标记或淘汰过时信息。</p>
<p><strong>‌元数据扩展‌</strong></p>
<p>补充内容摘要、更新时间戳、潜在用户查询等结构化信息，构建多维度的知识表征体系。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/367419e3b0b54bf7b26117662f7a3615~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875969&amp;x-signature=AP5igDm8Rryow9t5oYbI22XrI6o%3D" alt="图片" loading="lazy"/></p>
<p><strong>二、文本分块</strong></p>
<p>在知识库检索场景中，数据规模通常远超LLM的输入容量限制，因此有效的分块策略需要在满足长度约束的前提下，兼顾块间差异性与块内一致性。</p>
<p>这是理论上的最优解，但实际文本往往呈现散文特征——段落间界限模糊、内容松散且篇幅冗长。</p>
<p>我们无法预先实现绝对完美的内容分块，毕竟后续有LLM这类智能模型来消化处理，我们提供的文本块本质上是"提示"而非完整答案。</p>
<p>尽管如此，仍需确保传递给LLM的是有价值的信息，而非干扰其注意力的噪声。以下是几种进阶分块技术方案：</p>
<p><strong>句分割</strong>：借助NLTK或spaCy等库的句子切分能力，现代开发框架如langchain均已内置该功能</p>
<p><strong>递归</strong>* <em>分割</em>*：采用分层分块策略，langchain框架会先按双换行符(\n\n)分割段落，若块体超出阈值则继续用单换行符(\n)细分，最终可细化到空格或句号级分割。</p>
<p>这种动态调整机制能适应不同密度文本——信息密集区需要更细粒度分割，而内容稀疏区可采用较大区块</p>
<p><strong>语义</strong>* <em>分割</em>*：基于文本向量相似度计算实现语义单元划分</p>
<p><strong>结构化处理</strong>：针对Markdown/LaTeX/JSON等特殊格式的专用分割器，能完整保留文档原始结构</p>
<p>分块尺寸的确定需综合考虑嵌入模型特性、文档类型及查询复杂度。处理学术论文等长文本时，较大区块有利于维持上下文连贯性；分析社交媒体短文本则适合较小区块。</p>
<p>当用户查询简洁具体时建议采用小区块，复杂查询则需要更大上下文支持。实践表明，经过反复测试验证，128token的区块尺寸在多数场景下表现最优，可作为基准参数进行后续调优。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c2490c3d2404e77bf02c12d94aab099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875969&amp;x-signature=y0exTkwqR8yxmwskbslUXmcWuPM%3D" alt="图片" loading="lazy"/></p>
<p><strong>三、嵌入</strong></p>
<p>数据处理的最终环节涉及文本数据的类型转换，即通过嵌入（Embedding）模型将文本数据向量化（Vectorization），为后续的向量检索（Vector Retrieval）做准备。</p>
<p>在嵌入过程中，可通过以下方法优化性能：</p>
<p><strong>动态嵌入</strong>：动态嵌入能有效解决一词多义问题。以"光盘"为例，在"我买了一张光盘"中，它指实体光盘；而在"光盘行动"中，则表示"吃完盘中食物"的行为。</p>
<p>静态嵌入的向量表示是固定的，而采用自注意力机制的模型（如BERT）能动态调整词义，使同一词汇在不同语境下获得差异化向量表示。</p>
<p><strong>嵌入模型微调‌</strong>：多数嵌入模型基于通用语料训练，针对垂直领域时，可通过微调提升模型对专业词汇的理解能力，确保其平等对待领域术语和通用词汇，避免注意力分散。</p>
<p><strong>混合嵌入</strong>：分别为用户查询和知识库文本选择不同的嵌入模型，以适配各自的语言特征和语义需求。</p>
<p><strong>四、</strong>* <em>查询优化</em>*</p>
<p>在实际应用场景中，用户表达的多样性和模糊性常会导致检索系统的召回率与准确率下降。</p>
<p>为提升检索效果，需对查询语句进行优化处理，以标准化和扩充查询信息，从而帮助系统更精准地定位相关文档。</p>
<p>主要的查询优化技术包括：</p>
<p><strong>‌查询重写‌</strong></p>
<p>利用大语言模型(LLM)的提示功能，或部署经过微调的专用"问题重写器"(通常基于小型Transformer架构)，对原始查询进行语义等价改写。</p>
<p><strong>‌后退提示‌</strong></p>
<p>引导LLM生成一个更高层级的抽象问题(称为"后退"问题)。该问题的抽象程度需根据任务需求动态调整，最终将后退问题与原始查询共同用于检索。</p>
<p>例如：面对"Estella Leopold在1954年8月至11月期间就读于哪所学校？"这类含精确时间限制的查询时，补充提问"Estella Leopold的教育背景如何？"能显著提升检索效果。</p>
<p><strong>‌后续追问‌</strong></p>
<p>通过LLM基于对话上下文生成独立问题，特别适用于两种场景：</p>
<p>后续问题依赖前序对话的上下文(如用户先询问"在意大利的活动推荐"，再追问"当地特色美食"时，需保留位置上下文)</p>
<p>需整合最近k条对话记录。若新问题与历史对话无关，可能导致检索结果偏离主题。</p>
<p>‌<strong>假设文档生成</strong>(HyDE)‌</p>
<p>该方法要求LLM在无外部知识的情况下，先为查询生成假设性回答，再将此假设与原始查询联合用于向量检索。虽然假设内容可能包含不准确信息，但能揭示LLM认为相关的文档特征模式。</p>
<p><strong>‌多维度查询‌</strong></p>
<p>通过LLM从不同视角为原始问题衍生多个子问题，分别进行检索后，采用RRF(结果再融合)或重排序技术整合结果。例如：针对"红袜队与爱国者队谁是最新总冠军？"可拆分为：</p>
<p>红袜队上次夺冠时间</p>
<p>爱国者队上次夺冠时间</p>
<p><strong>五、检索</strong></p>
<p>检索（Retrieval）的核心目标始终是确保最相关文档的获取，或至少使最相关文档出现在返回结果中。为实现这一目标，可采用以下优化策略：</p>
<p><strong>‌上下文精简‌</strong>：过大的文档块会引入冗余信息，不仅增加LLM调用成本，还可能降低响应质量。通过LLM辅助的上下文分析，可对文档内容进行智能压缩，或选择性提取关键信息进行返回。</p>
<p><strong>‌相邻文本扩展‌</strong>：过小的文档块会割裂上下文关联。窗口搜索技术通过匹配目标文档块时，同步返回其相邻文本块作为补充上下文，从而增强LLM对完整语义链的理解。</p>
<p><strong>‌层级文档检索‌</strong>：该方法采用文档分级策略——将原始文档划分为宏观主文档和微观子文档两级结构。系统优先匹配子文档，但最终返回其所属的完整主文档，兼顾检索精度与上下文完整性。</p>
<p><strong>‌智能聚合检索‌</strong>：作为父文档搜索的升级方案，该方法构建三层树状文档结构（顶层1024字符/中间层512字符/底层128字符）。</p>
<p>检索时仅匹配底层节点，当某父节点下多数子节点匹配时，则返回该父节点内容，实现动态上下文扩展。</p>
<p><strong>‌多模态检索融合‌</strong>：RAG系统作为开放域问答架构，需通过混合检索技术提升事实覆盖率。</p>
<p>通过向量检索与关键词检索的协同应用，可充分发挥不同检索技术的优势。例如，组合语义相似度计算与精确关键词匹配，能显著提升检索模块的全面性。</p>
<p><strong>‌智能索引路由‌</strong>：针对多类型查询需求（如摘要生成、精确问答、时效性查询等），系统需建立专业索引库并通过路由机制自动分配查询请求。</p>
<p>例如，影视推荐类查询会被优先导向娱乐内容索引，同时触发热点话题索引的协同检索。</p>
<p><strong>‌自主决策代理‌</strong>：通过Agent智能体动态选择检索策略，支持单方法或多方法组合调用（串行或并行）。</p>
<p>例如，查询"2024年AI技术趋势"时，Agent会自动串联学术文献索引与行业报告索引，实现多维信息整合。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae55141416734c3faec46d782ae000c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875969&amp;x-signature=ZzVRusoGZAMLcsLWBuvmnxuRvSQ%3D" alt="图片" loading="lazy"/></p>
<p><strong>六、</strong>* <em>检索后处理</em>*</p>
<p>"检索后处理"这一范畴本身具有相当的包容性，其核心目标是对初步获取的检索结果实施优化处理，从而为大语言模型（LLM）的后续生成提供更优质的输入。</p>
<p>其中最具代表性的技术当属重排序（Rerank）。</p>
<p>虽然向量检索通过语义相似度计算实现了初步筛选，但语义高度匹配的文档未必与查询需求完全契合。</p>
<p>重排序机制通过多维度相关性分析（包括查询意图解析、词汇多义性消歧、用户行为模式挖掘及上下文关联分析等），对初始结果列表进行智能优化。</p>
<p>当前实现方案主要分为两类：一是通过LLM指令调优实现动态重排.</p>
<p>二是采用专业重排序模型（如商业化的Cohere，以及开源的BAAI/bge-reranker和IBM的Dense Passage Re-Ranker等）</p>
<p>这类模型通过综合评估更丰富的特征维度，确保最终呈现的文档排序与用户真实需求高度一致。</p>
<p><strong>七、生成</strong></p>
<p>在生成（Generation）阶段的优化需聚焦用户体验提升，具体可从以下维度实施：</p>
<p><strong>‌多轮对话机制‌</strong></p>
<p>采用带聊天历史的RAG技术（以AI搜索领域标杆产品Perplexity为例），通过连续对话交互帮助用户深度解析问题。</p>
<p>这种设计允许用户在多轮问答中逐步明确需求，最终获得精准解答。</p>
<p><strong>‌智能追问策略‌</strong></p>
<p>在prompt中植入动态追问逻辑："当背景知识无法直接回答问题时，需基于检索内容发起追问，且单次追问不超过3个问题"。</p>
<p>该机制虽依赖大模型基础能力，却能显著提升交互体验——用户通过引导式对话不断澄清需求，最终匹配最优答案。</p>
<p><strong>‌prompt精细化设计‌</strong></p>
<p>RAG系统的prompt需严格声明回答边界，例如："作为智能客服，你需基于给定上下文提供准确信息，避免引入外部知识。回答应简洁友好，优先解决用户核心问题"。</p>
<p>同时可根据场景需求灵活调整：</p>
<p>必要时允许模型融入适度主观分析</p>
<p>采用Few-shot学习范式指导LLM高效利用检索知识</p>
<p>‌反馈驱动迭代‌</p>
<p>建立用户反馈闭环系统，通过真实交互数据持续优化知识库，并对信息可信度进行动态标注。这种实时更新机制能有效提升系统响应质量。</p>
<p><strong>八、最后</strong></p>
<p>上述方法均为基础RAG在各环节的优化策略，实际应用中需注意：</p>
<ol>
<li>
<p>不同方法的效果存在差异；</p>
</li>
<li>
<p>需根据具体问题选择针对性方案；</p>
</li>
<li>
<p>通过适配应用场景的优化组合，才能实现RAG效用的最大化。</p>
</li>
</ol>
<p><strong>更多AI大模型学习视频及资源，都在<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[自造微前端]]></title>    <link>https://juejin.cn/post/7581481178823524371</link>    <guid>https://juejin.cn/post/7581481178823524371</guid>    <pubDate>2025-12-09T08:32:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581481178823524371" data-draft-id="7581350888789901348" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="自造微前端"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-09T08:32:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ggbond"/> <meta itemprop="url" content="https://juejin.cn/user/290743919315255"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            自造微前端
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/290743919315255/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ggbond
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T08:32:27.000Z" title="Tue Dec 09 2025 08:32:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>起因是，我要在一个大型后台管理应用中剥离出一个管理模块，这样做的好处当然是可以单独开发和发布，但是坏处也有，比如部分全局变量污染，UI不一致，状态通信传导等。虽然市面上已经有很多微前端方案了，比如qiankun等，但是这都需要对这个大仓库应用进行大动工，对原应用造成一些负载和可能意想不到的错误，非我所愿也，所以在这里我打算自己搞个简化的方案。
原应用是react+dva，</p>
<h2 data-id="heading-0">基座应用改造</h2>
<p>我们设计的主应用核心是；</p>
<ol>
<li>主应用不直接打包子应用的代码，而是运行时按需加载子应用的 JS 资源。</li>
<li>将子应用的路由注册到主应用的路由系统中，实现无缝跳转。</li>
<li>通过全局变量（<code>window</code>）共享库，避免重复加载,也可形成单例。
我们先改造子应用路由代码，为了解决刚才说的UI和一些重要库不一致问题，我们将直接暴露库到Window中，有：</li>
<li>antd</li>
<li>React主库
另外状态通信的问题，我们直接使用dva去修饰取得的子应用Com，并把部分方法如connect暴露到window中。</li>
</ol>
<p>代码如下</p>
<pre><code class="hljs language-ini" lang="ini">import React from 'react'<span class="hljs-comment">;</span>
import {
  Alert,
  Drawer,
} from 'antd'<span class="hljs-comment">;</span>
import { connect } from 'dva'<span class="hljs-comment">;</span>

<span class="hljs-attr">window.React</span> = React<span class="hljs-comment">;</span>
<span class="hljs-attr">window.CONNECT</span> = connect<span class="hljs-comment">;</span>
<span class="hljs-attr">window.Antd_ZI</span> = {
  Drawer,
  Alert,
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">configUrl</span> = {
  test: 'https://zi.test.cn',
  product: 'https://zi.prod.com',
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">env</span> = <span class="hljs-string">'product'</span><span class="hljs-comment">;</span>

const <span class="hljs-attr">mapStateToProps</span> = (state) =&gt; {
  const <span class="hljs-attr">currentState</span> = state.adManage<span class="hljs-comment">;</span>
  const { userAuth, userInfo } = state.app<span class="hljs-comment">;</span>
  return { ...currentState, userAuth, userInfo }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">insertScript</span> = (e, isStyle = <span class="hljs-literal">false</span>) =&gt; {
  return new Promise((reslove, reject) =&gt; {
    const <span class="hljs-attr">i</span> = isStyle ? document.createElement(<span class="hljs-string">'link'</span>) : document.createElement(<span class="hljs-string">'script'</span>)<span class="hljs-comment">;</span>
    isStyle || i.setAttribute('type', 'text/javascript')<span class="hljs-comment">;</span>
    isStyle || i.setAttribute('src', e)<span class="hljs-comment">;</span>
    isStyle &amp;&amp; i.setAttribute('href', e)<span class="hljs-comment">;</span>
    isStyle &amp;&amp; i.setAttribute('rel', 'stylesheet')<span class="hljs-comment">;</span>
    isStyle &amp;&amp; i.setAttribute('type', 'text/css')<span class="hljs-comment">;</span>
    function onload() {
      if (!(this.readyState &amp;&amp; this.readyState !== 'loaded' &amp;&amp; this.readyState !== 'complete')) {
        <span class="hljs-attr">i.onload</span> = null<span class="hljs-comment">;</span>
        <span class="hljs-attr">i.onreadystatechange</span> = i.<span class="hljs-literal">on</span>load<span class="hljs-comment">;</span>
        reslove()<span class="hljs-comment">;</span>
      }
    }
    function onerror(ee) {
      reject(ee)<span class="hljs-comment">;</span>
    }
    <span class="hljs-attr">i.onreadystatechange</span> = <span class="hljs-literal">on</span>load<span class="hljs-comment">;</span>
    <span class="hljs-attr">i.onload</span> = <span class="hljs-literal">on</span>load<span class="hljs-comment">;</span>
    <span class="hljs-attr">i.onerror</span> = <span class="hljs-literal">on</span>error<span class="hljs-comment">;</span>
    document.querySelector('head').appendChild(i)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

function ERROR() {
  return '加载静态资源失败，请稍后重试'<span class="hljs-comment">;</span>
}

const <span class="hljs-attr">subappRoutes</span> = []<span class="hljs-comment">;</span>

const <span class="hljs-attr">AyncComponent</span> = async (pathname) =&gt; {
  const <span class="hljs-attr">id</span> = pathname<span class="hljs-comment">;</span>
  // 子工程资源是否加载完成
  let <span class="hljs-attr">ayncLoaded</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  if (subappRoutes<span class="hljs-section">[id]</span>) {
    // 如果已经加载过该子工程的模块，则不再加载，直接取缓存的routes
    <span class="hljs-attr">ayncLoaded</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  } else if (window.ziPLATFORMSLOT &amp;&amp; window.ziPLATFORMSLOT<span class="hljs-section">[pathname]</span>) {
    const <span class="hljs-attr">res</span> = await window.ziPLATFORMSLOT[pathname]()<span class="hljs-comment">;</span>
    subappRoutes<span class="hljs-section">[id]</span> = res.default<span class="hljs-comment">;</span>
    <span class="hljs-attr">ayncLoaded</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    // return subappRoutes<span class="hljs-section">[id]</span><span class="hljs-comment">;</span>
  } else {
    try {
      await insertScript(`${configUrl<span class="hljs-section">[env]</span>}/js/index.js?<span class="hljs-attr">_</span>=<span class="hljs-variable">${new Date().getTime()}</span>`)<span class="hljs-comment">;</span>
      if (window.ziPLATFORMSLOT &amp;&amp; window.ziPLATFORMSLOT<span class="hljs-section">[pathname]</span>) {
        const <span class="hljs-attr">res</span> = await window.ziPLATFORMSLOT[pathname]()<span class="hljs-comment">;</span>
        subappRoutes<span class="hljs-section">[id]</span> = res.default<span class="hljs-comment">;</span>
        <span class="hljs-attr">ayncLoaded</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
      }
    } catch (error) {
      console.log('加载js失败', error)<span class="hljs-comment">;</span>
    }
  }
  return ayncLoaded ? connect(mapStateToProps)(subappRoutes<span class="hljs-section">[id]</span>) : ERROR<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

export default <span class="hljs-section">[
  {
    name: '资源管理',
    path: 'ziMedia',
    component: () =&gt; AyncComponent('ziMedia'),
  },
  {
    name: '黑名单管理',
    path: 'ziBlack',
    component: () =&gt; AyncComponent('ziBlack'),
  },
]</span><span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-1">子应用改造</h2>
<p>子应用中，入口文件我们需要定义publicPath保证资源的正确引用</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> configUrl = {
  <span class="hljs-attr">test</span>: <span class="hljs-string">'https://zi.test.cn'</span>,
  <span class="hljs-attr">product</span>: <span class="hljs-string">'https://zi.prod.com'</span>,
};

<span class="hljs-keyword">const</span> env = <span class="hljs-string">'product'</span>;
<span class="hljs-comment">// webpack 的魔法变量，用于指定异步加载的 JS/CSS 文件的基地址（如 `import()` 动态导入的模块）</span>
__webpack_public_path__ = <span class="hljs-string">`<span class="hljs-subst">${configUrl[env]}</span>/js/`</span>;

<span class="hljs-keyword">const</span> routes = {
  <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>,
  <span class="hljs-attr">ziMedia</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./ziMedia/index'</span>),
  <span class="hljs-attr">ziBlack</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./ziBlack/index'</span>),
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> routes;
</code></pre>
<p>在子应用的页面中，我们基本不需要做改造，但是在webpack的配置中，我们在base中需要:</p>
<pre><code class="hljs language-css" lang="css">{
    ...
    output:{
        ...
          libraryExport: <span class="hljs-string">'default'</span>,
          library: <span class="hljs-string">'ziPLATFORMSLOT'</span>,
          libraryTarget: <span class="hljs-string">'umd'</span>,
          umdNamedDefine: true,
    },
    externals: {
      'react': <span class="hljs-string">'React'</span>,
      <span class="hljs-string">'antd'</span>: <span class="hljs-string">'Antd_ZI'</span>,
      // <span class="hljs-string">'react-dom'</span>:<span class="hljs-string">'ReactDOM'</span>
    }
}
</code></pre>
<p>在prod配置中，为了保证子js能正确加载执行，我们使用InlineChunkHtmlPlugin插件，避免微前端环境下因路径问题导致运行时脚本加载失败。
至此，完成。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[寄生组合继承 vs ES6 类继承 深度对比]]></title>    <link>https://juejin.cn/post/7581658157145342002</link>    <guid>https://juejin.cn/post/7581658157145342002</guid>    <pubDate>2025-12-09T08:48:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581658157145342002" data-draft-id="7581667332306124838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="寄生组合继承 vs ES6 类继承 深度对比"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-09T08:48:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="之恒君"/> <meta itemprop="url" content="https://juejin.cn/user/2261046026312318"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            寄生组合继承 vs ES6 类继承 深度对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2261046026312318/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    之恒君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T08:48:18.000Z" title="Tue Dec 09 2025 08:48:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-estuary-light">.hljs-comment,.hljs-quote{color:#6c6b5a}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ba6236}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#ae7313}.hljs-bullet,.hljs-string,.hljs-symbol{color:#7d9726}.hljs-section,.hljs-title{color:#36a166}.hljs-keyword,.hljs-selector-tag{color:#5f9182}.hljs-addition,.hljs-deletion{color:#22221b;display:inline-block;width:100%}.hljs-deletion{background-color:#ba6236}.hljs-addition{background-color:#7d9726}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f4f3ec;color:#5f5e4e}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 寄生组合继承（Parasitic Combination Inheritance）</h2>
<h3 data-id="heading-1">实现方式</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父类</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span> = [<span class="hljs-string">'red'</span>, <span class="hljs-string">'blue'</span>, <span class="hljs-string">'green'</span>];
}

<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayName</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Parent name:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
};

<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayColors</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Parent colors:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span>);
};

<span class="hljs-comment">// 子类</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-comment">// 构造函数继承（继承实例属性）</span>
  <span class="hljs-title class_">Parent</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-comment">// 原型继承（继承方法）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">inheritPrototype</span>(<span class="hljs-params">child, parent</span>) {
  <span class="hljs-comment">// 创建父类原型的副本</span>
  <span class="hljs-keyword">const</span> prototype = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(parent.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
  <span class="hljs-comment">// 修复 constructor 指向</span>
  prototype.<span class="hljs-property">constructor</span> = child;
  <span class="hljs-comment">// 设置子类原型</span>
  child.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = prototype;
}

<span class="hljs-comment">// 应用寄生组合继承</span>
<span class="hljs-title function_">inheritPrototype</span>(<span class="hljs-title class_">Child</span>, <span class="hljs-title class_">Parent</span>);

<span class="hljs-comment">// 添加子类方法</span>
<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayAge</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Child age:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span>);
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> child1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>(<span class="hljs-string">'Alice'</span>, <span class="hljs-number">10</span>);
child1.<span class="hljs-property">colors</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'black'</span>);
child1.<span class="hljs-title function_">sayName</span>();    <span class="hljs-comment">// Parent name: Alice</span>
child1.<span class="hljs-title function_">sayAge</span>();     <span class="hljs-comment">// Child age: 10</span>
child1.<span class="hljs-title function_">sayColors</span>();  <span class="hljs-comment">// Parent colors: ["red", "blue", "green", "black"]</span>

<span class="hljs-keyword">const</span> child2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>(<span class="hljs-string">'Bob'</span>, <span class="hljs-number">12</span>);
child2.<span class="hljs-title function_">sayColors</span>();  <span class="hljs-comment">// Parent colors: ["red", "blue", "green"]</span>
</code></pre>
<h2 data-id="heading-2">2. ES6 类继承</h2>
<h3 data-id="heading-3">实现方式</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span> = [<span class="hljs-string">'red'</span>, <span class="hljs-string">'blue'</span>, <span class="hljs-string">'green'</span>];
  }
  
  <span class="hljs-title function_">sayName</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Parent name:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  }
  
  <span class="hljs-title function_">sayColors</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Parent colors:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span>);
  }
  
  <span class="hljs-comment">// 静态方法</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">staticMethod</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'This is a static method'</span>);
  }
}

<span class="hljs-comment">// 子类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">super</span>(name);  <span class="hljs-comment">// 必须调用 super</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }
  
  <span class="hljs-title function_">sayAge</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Child age:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span>);
  }
  
  <span class="hljs-comment">// 重写父类方法</span>
  <span class="hljs-title function_">sayName</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">sayName</span>();  <span class="hljs-comment">// 调用父类方法</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'And I am a child'</span>);
  }
  
  <span class="hljs-comment">// 静态方法也可以继承</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">childStaticMethod</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">staticMethod</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Child static method'</span>);
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> child1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>(<span class="hljs-string">'Alice'</span>, <span class="hljs-number">10</span>);
child1.<span class="hljs-property">colors</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'black'</span>);
child1.<span class="hljs-title function_">sayName</span>();    <span class="hljs-comment">// Parent name: Alice \n And I am a child</span>
child1.<span class="hljs-title function_">sayAge</span>();     <span class="hljs-comment">// Child age: 10</span>
child1.<span class="hljs-title function_">sayColors</span>();  <span class="hljs-comment">// Parent colors: ["red", "blue", "green", "black"]</span>

<span class="hljs-title class_">Child</span>.<span class="hljs-title function_">childStaticMethod</span>();  <span class="hljs-comment">// 静态方法调用</span>
</code></pre>
<h2 data-id="heading-4">3. 详细对比</h2>


















































<table><thead><tr><th>特性</th><th>寄生组合继承</th><th>ES6 类继承</th></tr></thead><tbody><tr><td><strong>语法</strong>​</td><td>函数 + 原型</td><td>类语法糖</td></tr><tr><td><strong>可读性</strong>​</td><td>较低</td><td>高</td></tr><tr><td><strong>继承原理</strong>​</td><td>原型链 + 构造函数</td><td>基于原型链</td></tr><tr><td><strong>静态方法</strong>​</td><td>需手动处理</td><td>原生支持</td></tr><tr><td><strong>私有字段</strong>​</td><td>无直接支持</td><td>ES2022+ 支持</td></tr><tr><td><strong>super 调用</strong>​</td><td>需手动实现</td><td>原生支持</td></tr><tr><td><strong>new.target</strong>​</td><td>不支持</td><td>支持</td></tr><tr><td><strong>constructor</strong>​</td><td>需手动设置</td><td>自动设置</td></tr></tbody></table>
<h2 data-id="heading-5">4. 性能对比</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 性能测试</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceTest</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">testParasitic</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
    
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params">name</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    }
    <span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getName</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>; };
    
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">name</span>) {
      <span class="hljs-title class_">Parent</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
    }
    <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
    <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Child</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>(<span class="hljs-string">'test'</span> + i);
    }
    
    <span class="hljs-keyword">return</span> performance.<span class="hljs-title function_">now</span>() - start;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">testES6</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent</span> {
      <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name; }
      <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>; }
    }
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span> {
      <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) { <span class="hljs-variable language_">super</span>(name); }
    }
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>(<span class="hljs-string">'test'</span> + i);
    }
    
    <span class="hljs-keyword">return</span> performance.<span class="hljs-title function_">now</span>() - start;
  }
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'寄生组合继承耗时:'</span>, <span class="hljs-title class_">PerformanceTest</span>.<span class="hljs-title function_">testParasitic</span>().<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>), <span class="hljs-string">'ms'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'ES6 类继承耗时:'</span>, <span class="hljs-title class_">PerformanceTest</span>.<span class="hljs-title function_">testES6</span>().<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>), <span class="hljs-string">'ms'</span>);

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 寄生组合继承耗时: 26.49 ms</span>
<span class="hljs-comment">// ES6 类继承耗时: 13.97 ms</span>
</code></pre>
<p><strong>性能结果</strong>：</p>
<ul>
<li>ES6 类继承通常<strong>更快</strong>（V8 优化）</li>
<li>寄生组合继承<strong>稍慢</strong>但差异很小</li>
<li>实际应用差异可忽略不计</li>
</ul>
<h2 data-id="heading-6">5. 特性详解</h2>
<h3 data-id="heading-7">5.1 原型链</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 寄生组合继承</span>
<span class="hljs-keyword">const</span> child1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>(<span class="hljs-string">'Alice'</span>, <span class="hljs-number">10</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child1.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child1.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child1 <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Child</span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child1 <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Parent</span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child1 <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Object</span>);  <span class="hljs-comment">// true</span>

<span class="hljs-comment">// ES6 类继承</span>
<span class="hljs-keyword">const</span> child2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>(<span class="hljs-string">'Bob'</span>, <span class="hljs-number">12</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(child2) === <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(child2)) === <span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child2 <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Child</span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child2 <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Parent</span>);  <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-8">5.2 静态成员继承</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 寄生组合继承（需手动实现）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params"/>) {}
<span class="hljs-title class_">Animal</span>.<span class="hljs-property">staticMethod</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'Animal static'</span>; };

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params"/>) {}
<span class="hljs-title class_">Dog</span>.<span class="hljs-property">__proto__</span> = <span class="hljs-title class_">Animal</span>;  <span class="hljs-comment">// 继承静态方法</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-title function_">staticMethod</span>();  <span class="hljs-comment">// 'Animal static'</span>

<span class="hljs-comment">// 或</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(<span class="hljs-title class_">Dog</span>, <span class="hljs-title class_">Animal</span>);

<span class="hljs-comment">// ES6 类继承（自动继承）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">staticMethod</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'Animal static'</span>; }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">dogStatic</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'Dog static'</span>; }
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Dog</span>.<span class="hljs-title function_">staticMethod</span>());  <span class="hljs-comment">// 'Animal static'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Dog</span>.<span class="hljs-title function_">dogStatic</span>());    <span class="hljs-comment">// 'Dog static'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(<span class="hljs-title class_">Dog</span>) === <span class="hljs-title class_">Animal</span>);  <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-9">5.3 方法重写</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 寄生组合继承</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params"/>) {}
<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">speak</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'Animal sound'</span>; };

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params"/>) {}
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Dog</span>;

<span class="hljs-comment">// 重写方法</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">speak</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 调用父类方法</span>
  <span class="hljs-keyword">const</span> parentSpeak = <span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">speak</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">return</span> parentSpeak + <span class="hljs-string">' and Woof!'</span>;
};

<span class="hljs-comment">// ES6 类继承</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-title function_">speak</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'Animal sound'</span>; }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title function_">speak</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">speak</span>() + <span class="hljs-string">' and Woof!'</span>;
  }
}
</code></pre>
<h2 data-id="heading-10">6. 优缺点对比</h2>
<h3 data-id="heading-11">寄生组合继承的优点</h3>
<ol>
<li><strong>兼容性极好</strong>：支持所有浏览器</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// IE6+ 都支持</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property">create</span> !== <span class="hljs-string">'function'</span>) {
  <span class="hljs-title class_">Object</span>.<span class="hljs-property">create</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">o</span>) {
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">F</span>(<span class="hljs-params"/>) {}
    F.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = o;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">F</span>();
  };
}
</code></pre>
<ol>
<li><strong>更灵活</strong>：手动控制继承逻辑</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 可以选择性继承</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createMixin</span>(<span class="hljs-params">baseClass, mixin</span>) {
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">MixedClass</span>(<span class="hljs-params"/>) {
    baseClass.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>);
    mixin.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>);
  }
  <span class="hljs-title class_">MixedClass</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(baseClass.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">MixedClass</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>, mixin.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">MixedClass</span>;
}
</code></pre>
<ol>
<li><strong>内存效率</strong>：可优化原型链深度</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 扁平化原型链</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createFlatInheritance</span>(<span class="hljs-params">parent, child</span>) {
  <span class="hljs-comment">// 合并原型方法，减少查找深度</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> parent.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) {
    <span class="hljs-keyword">if</span> (parent.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
      child.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>[key] = parent.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>[key];
    }
  }
}
</code></pre>
<h3 data-id="heading-12">寄生组合继承的缺点</h3>
<ol>
<li><strong>语法繁琐</strong>，易出错</li>
<li><strong>私有字段不支持</strong>，需用闭包模拟</li>
<li><strong>静态方法</strong>需手动处理</li>
<li><strong>可读性差</strong></li>
</ol>
<h3 data-id="heading-13">ES6 类继承的优点</h3>
<ol>
<li><strong>语法简洁</strong>，易于理解</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">height, width</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span> = height;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> = width;
  }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">area</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span>; }
}
</code></pre>
<ol start="2">
<li><strong>内置 super</strong>，方便调用父类</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Square</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Rectangle</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">side</span>) {
    <span class="hljs-variable language_">super</span>(side, side);
  }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">area</span>() {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Calculating square area...'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">super</span>.<span class="hljs-property">area</span>;
  }
}
</code></pre>
<ol start="3">
<li><strong>支持静态方法和字段</strong></li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
  <span class="hljs-keyword">static</span> staticField = <span class="hljs-string">'static'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">staticMethod</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'static method'</span>; }
  #privateField = <span class="hljs-string">'private'</span>;
}
</code></pre>
<ol start="4">
<li><strong>更好的工具支持</strong>（TypeScript、IDE）</li>
</ol>
<h3 data-id="heading-14">ES6 类继承的缺点</h3>
<ol>
<li><strong>语法糖</strong>，实际还是原型继承</li>
<li><strong>必须用 new 调用</strong>，不能当普通函数31.  <strong>没有私有方法</strong>（ES2022+ 才有）</li>
<li><strong>兼容性</strong>：旧浏览器需转译</li>
<li><strong>某些特性限制</strong>：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">method</span> = <span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/* 箭头函数，this 绑定 */</span> };
  }
  <span class="hljs-comment">// 不能这样写：</span>
  <span class="hljs-comment">// property = () =&gt; { };  // ES7+ 才支持</span>
}
</code></pre>
<h2 data-id="heading-15">7. 转译结果对比</h2>
<h3 data-id="heading-16">Babel 转译 ES6 类继承</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ES6</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name; }
  <span class="hljs-title function_">say</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">super</span>(name);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }
}

<span class="hljs-comment">// Babel 转译后</span>
<span class="hljs-meta">"use strict"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">_inherits</span>(<span class="hljs-params">subClass, superClass</span>) {
  subClass.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(superClass &amp;&amp; superClass.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>, {
    <span class="hljs-attr">constructor</span>: { <span class="hljs-attr">value</span>: subClass, <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span> }
  });
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(subClass, superClass);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">_createSuper</span>(<span class="hljs-params">Derived</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">_createSuperInternal</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> <span class="hljs-title class_">Super</span> = <span class="hljs-title function_">_getPrototypeOf</span>(<span class="hljs-title class_">Derived</span>);
    <span class="hljs-keyword">var</span> result = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">construct</span>(<span class="hljs-title class_">Super</span>, <span class="hljs-variable language_">arguments</span>, <span class="hljs-title function_">_getPrototypeOf</span>(<span class="hljs-variable language_">this</span>).<span class="hljs-property">constructor</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">_possibleConstructorReturn</span>(<span class="hljs-variable language_">this</span>, result);
  };
}

<span class="hljs-keyword">var</span> <span class="hljs-title class_">Parent</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
};

<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">say</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">say</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
};

<span class="hljs-keyword">var</span> <span class="hljs-title class_">Child</span> = <span class="hljs-comment">/*#__PURE__*/</span><span class="hljs-keyword">function</span> (<span class="hljs-params">_Parent</span>) {
  <span class="hljs-title function_">_inherits</span>(<span class="hljs-title class_">Child</span>, _Parent);
  <span class="hljs-keyword">var</span> _super = <span class="hljs-title function_">_createSuper</span>(<span class="hljs-title class_">Child</span>);
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-keyword">var</span> _this;
    _this = _super.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
    _this.<span class="hljs-property">age</span> = age;
    <span class="hljs-keyword">return</span> _this;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Child</span>;
}(<span class="hljs-title class_">Parent</span>);
</code></pre>
<h2 data-id="heading-17">8. 实际应用建议</h2>
<h3 data-id="heading-18">适合使用寄生组合继承的场景</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 需要支持 IE 的项目</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; 
    <span class="hljs-regexp">/MSIE|Trident/</span>.<span class="hljs-title function_">test</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">navigator</span>.<span class="hljs-property">userAgent</span>)) {
  <span class="hljs-comment">// 使用寄生组合继承</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">IECompatibleClass</span>(<span class="hljs-params"/>) {}
}

<span class="hljs-comment">// 2. 需要深度定制继承逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createCustomInheritance</span>(<span class="hljs-params">SuperClass, mixins</span>) {
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">CustomClass</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">SuperClass</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);
    mixins.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">mixin</span> =&gt;</span> {
      mixin.<span class="hljs-property">init</span> &amp;&amp; mixin.<span class="hljs-property">init</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);
    });
  }
  
  <span class="hljs-title class_">CustomClass</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">SuperClass</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
  mixins.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">mixin</span> =&gt;</span> {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">CustomClass</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>, mixin.<span class="hljs-property">methods</span>);
  });
  
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">CustomClass</span>;
}
</code></pre>
<h3 data-id="heading-19">适合使用 ES6 类继承的场景</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 现代前端框架</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-variable language_">super</span>(props);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> };
  }
  
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{this.state.count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
}

<span class="hljs-comment">// 2. Node.js 服务端</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = config;
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">connect</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MySQLService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">DatabaseService</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">sql</span>) { <span class="hljs-comment">/* ... */</span> }
}

<span class="hljs-comment">// 3. 需要类型检查</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> name !== <span class="hljs-string">'string'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Name must be a string'</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}
</code></pre>
<h2 data-id="heading-20">9. 混合使用模式（一般用不到）</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 结合两种方式</span>
<span class="hljs-comment">// 使用类作为基础</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EventEmitter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span> = {};
  }
  
  <span class="hljs-title function_">on</span>(<span class="hljs-params">event, listener</span>) {
    (<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>[event] || (<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>[event] = [])).<span class="hljs-title function_">push</span>(listener);
  }
  
  <span class="hljs-title function_">emit</span>(<span class="hljs-params">event, ...args</span>) {
    (<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>[event] || []).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> <span class="hljs-title function_">listener</span>(...args));
  }
}

<span class="hljs-comment">// 使用寄生组合继承扩展</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createObservable</span>(<span class="hljs-params">SuperClass</span>) {
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">Observable</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">SuperClass</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observers</span> = [];
  }
  
  <span class="hljs-title class_">Observable</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">SuperClass</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
  <span class="hljs-title class_">Observable</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Observable</span>;
  
  <span class="hljs-title class_">Observable</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">subscribe</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">observer</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observers</span>.<span class="hljs-title function_">push</span>(observer);
  };
  
  <span class="hljs-title class_">Observable</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">notify</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observers</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">observer</span> =&gt;</span> <span class="hljs-title function_">observer</span>(data));
  };
  
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Observable</span>;
}

<span class="hljs-comment">// 组合使用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">createObservable</span>(<span class="hljs-title class_">EventEmitter</span>) {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">super</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = data;
  }
  
  <span class="hljs-title function_">set</span>(<span class="hljs-params">key, value</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>[key] = value;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notify</span>({ key, value });
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'change'</span>, { key, value });
  }
}
</code></pre>
<h2 data-id="heading-21">10. 最佳实践</h2>
<h3 data-id="heading-22">现代项目</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 使用 ES6 类继承</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = config;
  }
  
  <span class="hljs-title function_">validateConfig</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 验证配置</span>
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Method not implemented'</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BaseService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-variable language_">super</span>(config);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateConfig</span>();
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 实现初始化</span>
  }
}
</code></pre>
<h3 data-id="heading-23">需要兼容性的项目</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 使用模块化的寄生组合继承</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createClass</span>(<span class="hljs-params">superClass, definition</span>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">Child</span> = definition.<span class="hljs-property">constructor</span> || <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    superClass.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);
  };
  
  <span class="hljs-comment">// 原型继承</span>
  <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(superClass.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
  <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Child</span>;
  
  <span class="hljs-comment">// 混入方法</span>
  <span class="hljs-keyword">if</span> (definition.<span class="hljs-property">methods</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>, definition.<span class="hljs-property">methods</span>);
  }
  
  <span class="hljs-comment">// 静态方法继承</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(<span class="hljs-title class_">Child</span>, superClass);
  
  <span class="hljs-comment">// 添加静态方法</span>
  <span class="hljs-keyword">if</span> (definition.<span class="hljs-property">statics</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Child</span>, definition.<span class="hljs-property">statics</span>);
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Child</span>;
}
</code></pre>
<h2 data-id="heading-24">总结</h2>








































<table><thead><tr><th>方面</th><th>推荐选择</th><th>原因</th></tr></thead><tbody><tr><td><strong>现代 Web 项目</strong>​</td><td>ES6 类继承</td><td>语法简洁，工具支持好</td></tr><tr><td><strong>库/框架开发</strong>​</td><td>ES6 类继承</td><td>更好的开发体验</td></tr><tr><td><strong>需要支持旧 IE</strong>​</td><td>寄生组合继承</td><td>兼容性好</td></tr><tr><td><strong>性能关键</strong>​</td><td>ES6 类继承</td><td>现代引擎优化好</td></tr><tr><td><strong>代码可读性</strong>​</td><td>ES6 类继承</td><td>语法更清晰</td></tr><tr><td><strong>团队熟悉度</strong>​</td><td>团队熟悉的</td><td>降低学习成本</td></tr></tbody></table>
<p><strong>最终建议</strong>：</p>
<ul>
<li>新项目一律使用 <strong>ES6 类继承</strong></li>
<li>旧项目维护时，如果已经是寄生组合继承，可保持</li>
<li>需要特殊继承模式时，可混用两种方式</li>
<li>始终考虑团队成员技能和项目需求</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript类型变形记：当代码开始“不正经”地转换身份]]></title>    <link>https://juejin.cn/post/7581481178823671827</link>    <guid>https://juejin.cn/post/7581481178823671827</guid>    <pubDate>2025-12-09T08:59:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581481178823671827" data-draft-id="7581210455827431460" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript类型变形记：当代码开始“不正经”地转换身份 "/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-09T08:59:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="汉堡大王9527"/> <meta itemprop="url" content="https://juejin.cn/user/643629279092743"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript类型变形记：当代码开始“不正经”地转换身份 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/643629279092743/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    汉堡大王9527
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T08:59:00.000Z" title="Tue Dec 09 2025 08:59:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在JavaScript的世界里，类型转换就像一场魔术表演——有时是精彩的显示变换，有时是暗箱操作的隐式转换。今天我们来揭秘这场魔术表演的真面纱！</p>
<h2 data-id="heading-0">==vs===</h2>
<p><code>==</code>在比较时会进行隐式类型转换，而<code>===</code>不会进行类型转换，要求值和类型都必须相同。</p>
<pre><code class="hljs language-ini" lang="ini">// === 严格相等：类型和值都必须相同
<span class="hljs-attr">1</span> === <span class="hljs-number">1</span><span class="hljs-comment">;      // true</span>
<span class="hljs-attr">'1'</span> === <span class="hljs-string">'1'</span><span class="hljs-comment">;  // true</span>
<span class="hljs-attr">1</span> === <span class="hljs-string">'1'</span><span class="hljs-comment">;    // false（类型不同）</span>

// == 宽松相等：会进行类型转换后比较
<span class="hljs-attr">1</span> == <span class="hljs-string">'1'</span><span class="hljs-comment">;     // true（字符串'1'转换为数字1）</span>
<span class="hljs-attr">0</span> == <span class="hljs-literal">false</span><span class="hljs-comment">;   // true（false转换为0）</span>
<span class="hljs-attr">null</span> == undefined<span class="hljs-comment">; // true（特殊规则）</span>

</code></pre>
<h2 data-id="heading-1">类型转换的两种形式</h2>
<h3 data-id="heading-2">1. 显式类型转换</h3>
<p>开发者明确调用转换函数进行的类型转换，也就是我们可以看见的。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 显式转换为数字</span>
<span class="hljs-built_in">Number</span>('<span class="hljs-number">123</span>');    <span class="hljs-comment">// 123</span>
<span class="hljs-built_in">parseInt</span>('<span class="hljs-number">123</span>');  <span class="hljs-comment">// 123</span>

<span class="hljs-comment">// 显式转换为字符串</span>
<span class="hljs-built_in">String</span>(<span class="hljs-number">123</span>);      <span class="hljs-comment">// '123'</span>
(<span class="hljs-number">123</span>)<span class="hljs-selector-class">.toString</span>(); <span class="hljs-comment">// '123'</span>

<span class="hljs-comment">// 显式转换为布尔值</span>
<span class="hljs-built_in">Boolean</span>(<span class="hljs-number">0</span>);       <span class="hljs-comment">// false</span>
<span class="hljs-built_in">Boolean</span>('');      <span class="hljs-comment">// false</span>
</code></pre>
<h3 data-id="heading-3">2. 隐式类型转换</h3>
<p>JavaScript引擎在特定操作中自动进行的类型转换。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 算术运算中的隐式转换</span>
<span class="hljs-string">'123'</span> - <span class="hljs-number">0</span>;        <span class="hljs-comment">// 123（字符串转数字）</span>
<span class="hljs-number">123</span> + <span class="hljs-string">''</span>;         <span class="hljs-comment">// '123'（数字转字符串）</span>

<span class="hljs-comment">// 逻辑判断中的隐式转换</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'hello'</span>) {    <span class="hljs-comment">// 字符串转布尔值</span>
  <span class="hljs-comment">// 会执行，因为'hello'转换为true</span>
}

<span class="hljs-comment">// 比较运算中的隐式转换</span>
<span class="hljs-string">'2'</span> &gt; <span class="hljs-number">1</span>;          <span class="hljs-comment">// true（'2'转换为2）</span>
</code></pre>
<h2 data-id="heading-4">原始值之间的类型转换</h2>
<h3 data-id="heading-5">1. 转换为数字（ToNumber）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Number</span>(<span class="hljs-string">'123'</span>);     <span class="hljs-comment">// 123</span>
<span class="hljs-title class_">Number</span>(<span class="hljs-string">''</span>);        <span class="hljs-comment">// 0</span>
<span class="hljs-title class_">Number</span>(<span class="hljs-string">'hello'</span>);   <span class="hljs-comment">// NaN</span>
<span class="hljs-title class_">Number</span>(<span class="hljs-literal">true</span>);      <span class="hljs-comment">// 1</span>
<span class="hljs-title class_">Number</span>(<span class="hljs-literal">false</span>);     <span class="hljs-comment">// 0</span>
<span class="hljs-title class_">Number</span>(<span class="hljs-literal">null</span>);      <span class="hljs-comment">// 0</span>
<span class="hljs-title class_">Number</span>(<span class="hljs-literal">undefined</span>); <span class="hljs-comment">// NaN</span>

<span class="hljs-comment">// 一元加运算符也执行数字转换</span>
+<span class="hljs-string">'123'</span>;  <span class="hljs-comment">// 123</span>
+<span class="hljs-literal">true</span>;   <span class="hljs-comment">// 1</span>
</code></pre>
<h3 data-id="heading-6">2. 转换为字符串（ToString）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">String</span>(<span class="hljs-number">123</span>);       <span class="hljs-comment">// '123'</span>
<span class="hljs-built_in">String</span>(true);      <span class="hljs-comment">// 'true'</span>
<span class="hljs-built_in">String</span>(false);     <span class="hljs-comment">// 'false'</span>
<span class="hljs-built_in">String</span>(null);      <span class="hljs-comment">// 'null'</span>
<span class="hljs-built_in">String</span>(undefined); <span class="hljs-comment">// 'undefined'</span>
</code></pre>
<h3 data-id="heading-7">3. 转换为布尔值（ToBoolean）</h3>
<p>JavaScript中只有以下6个值会转换为false，其他所有值都转换为true：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">Boolean</span>(false);     <span class="hljs-comment">// false</span>
<span class="hljs-built_in">Boolean</span>(<span class="hljs-number">0</span>);         <span class="hljs-comment">// false</span>
<span class="hljs-built_in">Boolean</span>(-<span class="hljs-number">0</span>);        <span class="hljs-comment">// false</span>
<span class="hljs-built_in">Boolean</span>('');        <span class="hljs-comment">// false</span>
<span class="hljs-built_in">Boolean</span>(null);      <span class="hljs-comment">// false</span>
<span class="hljs-built_in">Boolean</span>(undefined); <span class="hljs-comment">// false</span>
<span class="hljs-built_in">Boolean</span>(NaN);       <span class="hljs-comment">// false</span>

<span class="hljs-comment">// 其他所有值都是true</span>
<span class="hljs-built_in">Boolean</span>('<span class="hljs-number">0</span>');       <span class="hljs-comment">// true（注意：字符串'0'不是0）</span>
<span class="hljs-built_in">Boolean</span>([]);        <span class="hljs-comment">// true</span>
<span class="hljs-built_in">Boolean</span>({});        <span class="hljs-comment">// true</span>
<span class="hljs-built_in">Boolean</span>(function(){}); <span class="hljs-comment">// true</span>
</code></pre>
<h2 data-id="heading-8">引用类型转换为原始值（通常发生在隐式类型转换中）</h2>
<h3 data-id="heading-9">1. 转换为布尔值</h3>
<p>所有引用类型（对象、数组、函数等）转换为布尔值都是true。</p>
<h3 data-id="heading-10">2. 转换为数字（引用类型 → 原始值 → 数字）</h3>
<p>转换过程遵循ToPrimitive算法：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 转换步骤：</span>
<span class="hljs-comment">// 1. 调用valueOf()方法，如果返回原始值，使用该值</span>
<span class="hljs-comment">// 2. 否则调用toString()方法，如果返回原始值，使用该值</span>
<span class="hljs-comment">// 3. 否则抛出TypeError</span>

<span class="hljs-built_in">Number</span>({});            <span class="hljs-comment">// NaN</span>
<span class="hljs-comment">// {}.valueOf() → {}（仍是对象）</span>
<span class="hljs-comment">// {}.toString() → '[object Object]'</span>
<span class="hljs-comment">// Number('[object Object]') → NaN</span>

<span class="hljs-built_in">Number</span>([<span class="hljs-number">123</span>]);         <span class="hljs-comment">// 123</span>
<span class="hljs-comment">// [123].valueOf() → [123]（仍是数组）</span>
<span class="hljs-comment">// [123].toString() → '123'</span>
<span class="hljs-comment">// Number('123') → 123</span>

<span class="hljs-built_in">Number</span>([]);            <span class="hljs-comment">// 0</span>
<span class="hljs-comment">// [].toString() → ''</span>
<span class="hljs-comment">// Number('') → 0</span>
</code></pre>
<h3 data-id="heading-11">3. 转换为字符串</h3>
<p>与转换为数字类似，但优先调用toString()方法：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">String</span>({});            <span class="hljs-comment">// '[object Object]'</span>
<span class="hljs-built_in">String</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);     <span class="hljs-comment">// '1,2,3'</span>
<span class="hljs-built_in">String</span>([]);            <span class="hljs-comment">// ''</span>
<span class="hljs-built_in">String</span>(new Date());    <span class="hljs-comment">// 日期字符串（如'Thu Nov 09 2023...'）</span>
</code></pre>
<h2 data-id="heading-12">toString()方法的行为</h2>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 对象的toString()方法</span>
{}<span class="hljs-selector-class">.toString</span>();                <span class="hljs-comment">// '[object Object]'</span>

<span class="hljs-comment">// 数组的toString()方法</span>
<span class="hljs-selector-attr">[1, 2, 3]</span><span class="hljs-selector-class">.toString</span>();        <span class="hljs-comment">// '1,2,3'</span>
<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.toString</span>();               <span class="hljs-comment">// ''</span>

<span class="hljs-comment">// 其他类型的toString()</span>
(<span class="hljs-number">123</span>)<span class="hljs-selector-class">.toString</span>();            <span class="hljs-comment">// '123'</span>
(true)<span class="hljs-selector-class">.toString</span>();           <span class="hljs-comment">// 'true'</span>

<span class="hljs-comment">// null和undefined没有toString()方法</span>
null<span class="hljs-selector-class">.toString</span>();             <span class="hljs-comment">// TypeError</span>
undefined<span class="hljs-selector-class">.toString</span>();        <span class="hljs-comment">// TypeError</span>
</code></pre>
<h2 data-id="heading-13">什么情况下会发生隐式类型转换</h2>
<ol>
<li>四则运算 + - * % /</li>
<li>判断语句 if while == &gt;=  &lt;=  &gt;  &lt;  !=</li>
</ol>
<h2 data-id="heading-14">加法运算符的详细规则</h2>
<h3 data-id="heading-15">作为一元运算符（正号）</h3>
<pre><code class="hljs language-arduino" lang="arduino">+ <span class="hljs-string">'123'</span>;        <span class="hljs-comment">// 123</span>
+ <span class="hljs-literal">true</span>;         <span class="hljs-comment">// 1</span>
+ <span class="hljs-literal">false</span>;        <span class="hljs-comment">// 0</span>
</code></pre>
<h3 data-id="heading-16">作为二元运算符（加法）</h3>
<p>规则：</p>
<ol>
<li>将两个操作数转换为原始值（ToPrimitive）</li>
<li>如果任一操作数是字符串，则进行字符串拼接</li>
<li>否则，将两个操作数转换为数字进行加法运算</li>
</ol>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">1</span> + <span class="hljs-number">2</span>;          <span class="hljs-regexp">//</span> <span class="hljs-number">3</span>（数字相加）
<span class="hljs-number">1</span> + <span class="hljs-string">'2'</span>;        <span class="hljs-regexp">//</span> <span class="hljs-string">'12'</span>（字符串拼接）
<span class="hljs-literal">true</span> + <span class="hljs-literal">false</span>;   <span class="hljs-regexp">//</span> <span class="hljs-number">1</span>（<span class="hljs-number">1</span> + <span class="hljs-number">0</span>）
[] + [];        <span class="hljs-regexp">//</span> <span class="hljs-string">''</span>（空字符串 + 空字符串）
[] + {};        <span class="hljs-regexp">//</span> <span class="hljs-string">'[object Object]'</span>
</code></pre>
<h2 data-id="heading-17">总结</h2>
<p>理解JavaScript的类型转换机制对于编写健壮的代码至关重要：</p>
<ol>
<li><strong>显式转换</strong>提供了清晰、可预测的类型转换方式</li>
<li><strong>隐式转换</strong>虽然方便，但可能引入难以发现的bug</li>
<li>掌握转换规则可以帮助你更好地理解和调试代码</li>
<li>在关键业务逻辑中，推荐使用显式转换以提高代码的清晰度和可靠性</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[听说你毕业很多年了？那么来做题吧🦶]]></title>    <link>https://juejin.cn/post/7581667332306419750</link>    <guid>https://juejin.cn/post/7581667332306419750</guid>    <pubDate>2025-12-09T09:06:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581667332306419750" data-draft-id="7576476897949843483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="听说你毕业很多年了？那么来做题吧🦶"/> <meta itemprop="keywords" content="Flutter,iOS,APP"/> <meta itemprop="datePublished" content="2025-12-09T09:06:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_大学牲"/> <meta itemprop="url" content="https://juejin.cn/user/3125273628517148"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            听说你毕业很多年了？那么来做题吧🦶
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3125273628517148/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _大学牲
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T09:06:46.000Z" title="Tue Dec 09 2025 09:06:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">序言</h2>
<p align="center"> 
           <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/942f89459c6343039107e56fe7205591~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=K6GKWvQixQk14aoqejKcz9SFFDY%3D" width="100%" loading="lazy"/>
</p>
<p>自别学宫，岁月如狗，撒腿狂奔，不知昔日学渣今何在？<br/>
左持键盘，右捏鼠标，微仰其首，竟在屏幕镜中显容颜！<br/>
心中微叹，曾几何时，提笔杀题，犹如天上人间太岁神。<br/>
知你想念，故此今日，鄙人不才，出题小侠登场献丑了。</p>
<h2 data-id="heading-1">起因</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54a60e42c3e04f548562c7191a3f8e7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=5lYjPp9vnUiU1f%2ByXE1OImQ5DGE%3D" alt="截屏2025-12-09 14.33.41.png" loading="lazy"/>
在这一篇《<a href="https://juejin.cn/post/7569827641482674214**" target="_blank" title="https://juejin.cn/post/7569827641482674214**">从 0 到上架：用 Flutter 一天做一款功德木鱼</a>》文章中，我的 <code>木鱼APP</code> 最终陨落了，究其原因就是这种 <strong>APP 在  商店中太<code>多</code>了</strong>,如果你要想成功上架，无异于要脱胎换骨。</p>
<blockquote>
<p>后面有时间了，我打算将其重铸为 <code>修仙敲木鱼</code>，通过积攒鱼力，突破秩序枷锁，成就 <code>无上木鱼大道</code>。</p>
</blockquote>
<hr/>
<p>因此，我吸取失败的教训，着力于开发一款比较 <strong>独特的APP</strong> ，结合这个AI大时代的背景，这款AI智能 <code>出题侠</code> 就应运而生了。最后总算是不辜负我的努力，成功上架了。<br/>
接下来就向大家说说 <strong>它的故事</strong> 吧。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c4b26dcfe204c65b350ce9987cd5225~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=DkLeKY6Brtcb6PCa%2FbDlbzNVa%2Bk%3D" alt="截屏2025-12-09 14.44.38.png" loading="lazy"/></p>
<h2 data-id="heading-2">实践</h2>
<h3 data-id="heading-3">一. 准备阶段</h3>
<h4 data-id="heading-4">1.流程设计</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD

  %% 启动与登录
  A[启动页] --&gt; B[无感登录]
  B --&gt; C[进入导航页]

  %% 主壳导航
  C --&gt; H[首页]
  C --&gt; R[记录]
  C --&gt; T[统计]
  C --&gt; P[我的]

  %% 首页出题 → 记录
  H --&gt; H1[输入主题/高级设置]
  H1 --&gt; H2[生成题目]
  H2 --&gt; H3[提示后台生成]
  H3 --&gt; R

  %% 记录 → 答题/详情
  R --&gt; R1{记录状态}
  R1 --&gt;|进行中| Q[进入答题页]
  R1 --&gt;|已完成| RD[记录详情]
  RD --&gt; E[秒懂百科]

  %% 答题流程
  Q --&gt; Q1[作答 / 提交]
  Q1 --&gt; Q2[保存成绩]
  Q2 --&gt; R

  %% 统计页
  T --&gt; T1[刷新统计数据]

  %% 我的页
  P --&gt; P1[设置/关于]
  P --&gt; P2[隐私政策]
  P --&gt; P3[注销]
  P3 --&gt; |确认后| P4[清除 token / 返回未登录状态]
</code></pre>
<h4 data-id="heading-5">2. 素材获取</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d21a570874264b239883d5b0a00510a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=GOF65mijLQGlLIGqNL1ES2AIIBI%3D" alt="截屏2025-12-09 15.22.28.png" loading="lazy"/></p>
<p>App的 <strong>logo</strong> 和其中的 <strong>插图</strong>，我都是用的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fexp.volcengine.com%2Fark%2Fvision%3Fmode%3Dvision%26model%3Ddoubao-seedream-4-5-251128%26modelId%3Ddoubao-seedream-4-0-250828%26tab%3DGenImage" target="_blank" title="https://exp.volcengine.com/ark/vision?mode=vision&amp;model=doubao-seedream-4-5-251128&amp;modelId=doubao-seedream-4-0-250828&amp;tab=GenImage" ref="nofollow noopener noreferrer">Doubao-Seedream-4.0</a> 生成的，一次效果不行就多生成几次，最终还是能得到相对满意的结果。</p>
<p>到我写文章的时候，已经有了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fexp.volcengine.com%2Fark%2Fvision%3Fmode%3Dvision%26model%3Ddoubao-seedream-4-5-251128%26modelId%3Ddoubao-seedream-4-5-251128" target="_blank" title="https://exp.volcengine.com/ark/vision?mode=vision&amp;model=doubao-seedream-4-5-251128&amp;modelId=doubao-seedream-4-5-251128" ref="nofollow noopener noreferrer">Doubao-Seedream-4.5</a>，大家可以去体验体验。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/854bab81f9df4433bec4cb8baa49d114~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=GZoSRwDPddWhgOEKajWEzWKzSfk%3D" alt="截屏2025-12-09 15.27.20.png" loading="lazy"/></p>
<h3 data-id="heading-6">二. 开发阶段</h3>
<h4 data-id="heading-7">1. 前端</h4>
<p>前端毫无争议的使用的是 <code>Flutter</code>，毕竟要是以后发行 <code>Android</code> 也是非常方便的,无需重新开发。再结合 <code>Trae</code>,我只需要在口头上指点指点，那是开发的又快又稳，非常的轻松加愉快。</p>
<blockquote>
<p>无须多言，这就是赛博口嗨程序员！🫡</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1bda83073ca4e0b97c0c6f58936981b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=LM8SkJg3y4JvCvK1bBk9GVRho%2BM%3D" alt="截屏2025-12-09 15.44.31.png" loading="lazy"/></p>
<h4 data-id="heading-8">2. 后端</h4>
<p>后端就是，世界上最好的编程语言 <code>JAVA</code> 了，毕竟 <code>SpringBoot</code> 可太香了,我也是亲自上手。</p>
<h5 data-id="heading-9">2.1 依赖概览</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ✅ 核心 LangChain4j 依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>dev.langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${langchain4j.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>okhttp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Validation --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Spring Aop --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- HuTool --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${hutool.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- MyBatis-Plus --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-spring-boot3-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${mybatis-plus.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- MyBatis --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${mybatis-spring-boot-starter.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- MyBatis-PageHelper --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.pagehelper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${pagehelper.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Sa-Token --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.dev33<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sa-token-spring-boot3-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${sa-token.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Sa-Token 整合 RedisTemplate --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.dev33<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sa-token-redis-template<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.42.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 提供 Redis 连接池 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Lombok --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Knife4j --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springdoc<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springdoc-openapi-starter-webmvc-ui<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.8.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-openapi3-jakarta-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 短信验证码 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.aliyun<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aliyun-java-auth<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.2.0-beta<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 阿里云短信服务 SDK --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.aliyun<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dysmsapi20170525<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 使用最新版 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

      ......
</code></pre>
<p>这依赖一添加，满满的安全感：</p>
<ul>
<li>数据库：我有MyBatis。</li>
<li>AI：我有LangChain4j。</li>
<li>登录鉴权：我有Sa-Token。</li>
<li>......</li>
</ul>
<h5 data-id="heading-10">2.2 接口限流</h5>
<p>要说到项目中最需要重点关注的部分，<strong>接口限流</strong> 无疑排在首位。无论是短信发送接口，还是调用 AI 的接口，一旦被恶意刷取或滥用，都可能导致资源耗尽、费用爆炸💥。</p>
<p>因此，本项目采用 <strong>注解 + AOP + Redis</strong> 的方式，构建了一套 <strong>轻量级、可配置、低侵入</strong> 的接口限流方案，在不影响业务代码结构的前提下，对高风险接口进行有效保护，确保系统在高并发场景下依然稳定可控。</p>
<hr/>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> RateLimit {

    <span class="hljs-comment">/**
     * 限流 key 的前缀（唯一标识一个限流维度）
     */</span>
    String <span class="hljs-title function_">key</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 时间窗口，单位秒
     */</span>
    <span class="hljs-type">long</span> <span class="hljs-title function_">window</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">60</span>;

    <span class="hljs-comment">/**
     * 时间窗口内允许的最大次数
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">limit</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">10</span>;

    <span class="hljs-comment">/**
     * 是否按 IP 维度区分限流
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">perIp</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">/**
     * 是否按用户维度区分限流
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">perUser</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">/**
     * 自定义提示信息
     */</span>
    String <span class="hljs-title function_">message</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"请求过于频繁，请稍后再试"</span>;
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimitAspect</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> RateLimitRedisUtil rateLimitRedisUtil;

    <span class="hljs-meta">@Around("@annotation(org.dxs.problemman.annotation.RateLimit)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();
        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> signature.getMethod();
        <span class="hljs-type">RateLimit</span> <span class="hljs-variable">rateLimit</span> <span class="hljs-operator">=</span> method.getAnnotation(RateLimit.class);

        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> buildKey(rateLimit);

        <span class="hljs-type">boolean</span> <span class="hljs-variable">allowed</span> <span class="hljs-operator">=</span> rateLimitRedisUtil.tryAcquire(
                key, rateLimit.limit(), rateLimit.window());

        <span class="hljs-keyword">if</span> (!allowed) {
            log.warn(<span class="hljs-string">"限流触发：key={}, limit={}, window={}s"</span>, key, rateLimit.limit(), rateLimit.window());
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RateLimitException</span>(rateLimit.message());
        }

        <span class="hljs-keyword">return</span> joinPoint.proceed();
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildKey</span><span class="hljs-params">(RateLimit rateLimit)</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">"ratelimit:"</span>).append(rateLimit.key());
        <span class="hljs-keyword">if</span> (rateLimit.perIp()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> IpUtils.getIpAddress();
            key.append(<span class="hljs-string">":"</span>).append(ip);
        }

        <span class="hljs-keyword">if</span> (rateLimit.perUser()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> StpUtil.getLoginIdAsString();
            key.append(<span class="hljs-string">":"</span>).append(userId);
        }
        <span class="hljs-keyword">return</span> key.toString();
    }
}
</code></pre>
<hr/>
<p>在使用上，开发者只需在需要保护的接口方法上添加 <code>@RateLimit</code> 注解，即可声明该接口的限流规则。通过 <code>key</code> 区分不同业务场景，并可按需开启 <strong>IP 维度</strong> 或 <strong>用户维度</strong> 的限流控制，从而精确限制单一来源或单一用户的访问频率。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@NotLogin</span>
<span class="hljs-meta">@PostMapping("/sms")</span>
<span class="hljs-meta">@RateLimit(key = "sms", limit = 200, window = 3600, message = "短信调用太频繁，请1小时后再试")</span>
<span class="hljs-keyword">public</span> AjaxResult&lt;String&gt; <span class="hljs-title function_">sms</span><span class="hljs-params">(<span class="hljs-meta">@Validated</span> <span class="hljs-meta">@RequestBody</span> PhoneDTO dto)</span> {
    <span class="hljs-keyword">return</span> AjaxResult.success(loginService.sms(dto));

}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/generate")</span>
<span class="hljs-meta">@RateLimit(key = "generate", limit = 3, perUser = true, window = 3600*24, message = "每人每天仅可体验三次!")</span>
<span class="hljs-meta">@Operation(summary = "依据条件，生成题目")</span>
<span class="hljs-keyword">public</span> AjaxResult&lt;Object&gt; <span class="hljs-title function_">generate</span><span class="hljs-params">(<span class="hljs-meta">@Validated</span> <span class="hljs-meta">@RequestBody</span> GenerateRequestDTO dto)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException {
    questionService.generate(dto);
    <span class="hljs-keyword">return</span> AjaxResult.success();
}
</code></pre>
<p>请求进入时，AOP 切面会拦截带有 <code>@RateLimit</code> 注解的方法，根据注解配置动态构建限流 Key，并交由 Redis 进行原子计数校验；若在指定时间窗口内超过访问上限，则直接中断请求并返回友好的限流提示，同时记录告警日志，便于后续排查与监控。</p>
<p>限流 Key 的结构统一为：</p>
<pre><code class="hljs language-css" lang="css">ratelimit:{业务key}:{ip}:{userId}
</code></pre>
<p>通过 Redis 过期机制自然形成时间窗口，既保证了并发场景下的准确性，也避免了额外的清理成本。</p>
<h3 data-id="heading-11">三. 上架备案</h3>
<h4 data-id="heading-12">1.前提</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/083eac97b7a34a19b1588ada75dd4ad8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=EiFHmny2HNv8e1cVu%2FnNtwcVDs0%3D" alt="截屏2025-12-08 21.51.13.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/353c5df231d5408080608a9de008d865~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=NlEUKn0bg7DMnZSag0nApsjkgOQ%3D" alt="截屏2025-12-08 21.51.51.png" loading="lazy"/></p>
<p>想要备案上架，域名和服务器是必不可少的。</p>
<ul>
<li>域名：你是在手机上，其实不需要啥好域名，因为大家根本看不见，十几块钱一年就行了。</li>
<li>服务器：花了三四百买个轻量级服务器就行了。</li>
</ul>
<h4 data-id="heading-13">2. 阿里云备案</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dee4bff186e44acbb17263b4634c33d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=%2B71bBFko6Z9SCmEpak4rgHRcW28%3D" alt="截屏2025-12-08 22.02.14.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dc6a93d8cc94525b5095b33588d6637~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=U2%2BVi0OSV2zLLWJo9F7I22K2Iic%3D" alt="截屏2025-12-08 22.06.22.png" loading="lazy"/></p>
<blockquote>
<p>💡 <code>小建议</code><br/>
像这里阿里云备案和获取管局审核，可以先行一步，在app开发完之前就可以提交了。<br/>
因为管局审核是要2-3周的，有可能我们的小APP开发好了，备案号都没有下来。</p>
</blockquote>
<h4 data-id="heading-14">3. 苹果商店上架</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7f6fab876754a68b382d8b7e462eaf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=PAvq6D5rHLixfkr1ZCelv2QHz7o%3D" alt="截屏2025-12-09 14.44.38.png" loading="lazy"/></p>
<p>信息这里按部就班，按照提示，一点点填写完成就行了，没啥特别的。</p>
<p><code>踩坑总结</code>：</p>
<ul>
<li><strong>测试账号</strong>：你的APP中只要有登录模块，就一定要提供测试账号，就算你纯手机号登录也不行，必须提供测试账号。</li>
<li><strong>注销功能</strong>：苹果商店硬性要求，必须要有 <code>注销功能</code>，但其实也没那么严格，你只要UI显示是那么回事就行，就当 <code>退出登录</code> 功能去做就行了。</li>
</ul>
<h4 data-id="heading-15">4. 预览图制作推荐</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4259d49b6821497a87643f795151d86d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=%2FGn14RBp%2B2TpiiY5QY8v%2FLoM7As%3D" alt="截屏2025-12-09 16.47.09.png" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f7b46132b1843d584e67c72244aec3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=ymvkRQnEBTvkr6qmRtrqHnhBSp0%3D" alt="截屏2025-12-09 16.46.11.png" loading="lazy"/></p>
<p align="center"> 
           <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d885c55b4fb49a6b4a256d422fbde9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=%2BOQKmXPfoaxUAScl80foPzYuvMQ%3D" width="100%" loading="lazy"/>
</p>
<blockquote>
<p>注意是需要订阅付费的，要是有什么更好的，希望评论告知。😂</p>
</blockquote>
<h2 data-id="heading-16">展望</h2>
<p>在后续规划的新功能中，将以<strong>大学期末考试复习</strong>作为典型应用场景进行设计。通常在期末阶段，老师都会给出明确的考试范围、复习大纲以及相关资料文档，而临阵磨枪的学生往往面临资料繁多、重点分散、不知从何下手的问题。</p>
<p>针对这一痛点，用户可以将老师提供的复习文档直接导入 App，系统会基于 AI 对内容进行自动解析与归纳，将零散的文本信息整理为<strong>思维导图形式的知识图谱</strong>，清晰呈现各章节与知识点之间的层级与关联关系。</p>
<p>在此基础上，用户可围绕任意知识节点一键生成对应题目，用于针对性复习与自测，做到<strong>哪里薄弱练哪里</strong>。通过<code>文档 → 知识图谱 → 题目练习</code> 的闭环方式，帮助用户更高效地理解重点内容，提升期末复习的针对性与整体效率。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35b417d2198c42078dbeaccf6a858378~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=5FboRa4pjjpbYklOI6Ab6J0qrzo%3D" alt="46a1b81cde50407982da18d76b651dcf.gif" loading="lazy"/></p>
<blockquote>
<p>😭 作为大学毕业生的深彻感悟。</p>
</blockquote>
<h2 data-id="heading-17">支持</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/078b69255afa4bd68f3ad65d8e674014~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876051&amp;x-signature=tGaZCpB%2Buf8VAWzzD6r7vetgMgU%3D" alt="ScreenRecording_12-08-2025 22-10-28_1.gif" loading="lazy"/></p>
<p><code>AppStore</code> 搜索 <code>出题侠</code> 即可，每个用户每天可免费使用三次。</p>
<blockquote>
<p>感谢大家的支持与反馈。🙏</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解决idea错误提示:无法解析'表名']]></title>    <link>https://juejin.cn/post/7581658157145505842</link>    <guid>https://juejin.cn/post/7581658157145505842</guid>    <pubDate>2025-12-09T09:14:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581658157145505842" data-draft-id="7581648776303575049" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解决idea错误提示:无法解析'表名'"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-09T09:14:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ShaneD771"/> <meta itemprop="url" content="https://juejin.cn/user/2482077907032171"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解决idea错误提示:无法解析'表名'
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2482077907032171/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ShaneD771
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T09:14:09.000Z" title="Tue Dec 09 2025 09:14:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 问题现象</h3>
<p>Database 面板里已经成功连接了数据库，表都能看得到。</p>
<p>SQL 代码（MyBatis XML 或 <code>@Select</code> 注解）本身没有语法错误，在数据库里执行也能跑通。</p>
<p>但是IDEA 编辑器里，提示 <code>Unable to resolve table 'xxx'</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c3ed85f58334db0b9015900984c785d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhbmVENzcx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876449&amp;x-signature=t7illpHORyyzKUqVaepoi2i7Iz4%3D" alt="image-20251124135706567" loading="lazy"/></p>
<h3 data-id="heading-1">2. 快速解决方案</h3>
<p>这个问题的根源在于 <strong>IDEA 不知道当前的代码文件应该对应哪个数据库连接</strong>。我们需要手动设置 <strong>SQL Resolution Scope（SQL 解析作用域）</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23a174bdf8e649609e341998bba4f859~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhbmVENzcx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876449&amp;x-signature=UO8zgF18ujtp7NC%2B3XawVHHxrEQ%3D" alt="image-20251124142214645" loading="lazy"/></p>
<h3 data-id="heading-2">3. 为什么会有这个问题？</h3>
<p>我明明设置了 SQL Dialect（方言），也连接了数据库，而且我只有一个数据库，IDEA 为什么不能自己匹配呢？</p>
<h4 data-id="heading-3">3.1 三大概念的区别</h4>
<ul>
<li><strong>SQL Dialect (方言)</strong>：相当于“语法书”。它告诉 IDEA 这段代码是 MySQL 语法还是 Oracle 语法，负责检查语法结构（如 <code>SELECT</code> 拼写对不对）。</li>
<li><strong>Data Source (数据源)</strong>：相当于“字典”。这是真实的数据库连接，包含所有的表结构元数据。</li>
<li><strong>Resolution Scope (作用域)</strong>：相当于“指针/上下文”。它的作用是把“代码”和“字典”连起来。</li>
</ul>
<p><strong>飘红的原因就是：</strong> 你有了语法书，也有了字典，但 IDEA 不知道这段代码该查哪本字典。</p>
<h4 data-id="heading-4">3.2 为什么不能选 "All Data Sources"？</h4>
<p>即使只有一个数据库，选“所有数据源”依然会报错。</p>
<p><strong>本质原因：缺失“默认上下文” (Default Context)。</strong></p>
<p>我们在写 SQL 时通常只写<strong>短表名</strong>（如 <code>SELECT * FROM user</code>），而不是<strong>全限定名</strong>（如 <code>SELECT * FROM my_db.public.user</code>）。</p>
<ul>
<li><strong>当你选“具体数据库”时：</strong> 相当于进入了该数据库的 Session，拥有了默认的 Schema。IDEA 遇到 <code>user</code> 表，会自动去默认 Schema 下查找。<strong>(相当于相对路径：<code>./user</code>)</strong></li>
<li><strong>当你选“所有数据源”时：</strong> 相当于站在了服务器的“大厅”里。虽然只有一个库，但因为没有执行 <code>USE database</code> 这种切换上下文的操作，IDEA 面对 <code>user</code> 这个短名，不敢擅自猜测它是属于哪个库的。为了严谨和防止歧义，它选择报错。<strong>(相当于绝对路径缺失)</strong></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG 表格解析最佳实践：标题识别、表头推断与语义重建全指南]]></title>    <link>https://juejin.cn/post/7581664445240918031</link>    <guid>https://juejin.cn/post/7581664445240918031</guid>    <pubDate>2025-12-09T09:13:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581664445240918031" data-draft-id="7581670270843994152" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG 表格解析最佳实践：标题识别、表头推断与语义重建全指南"/> <meta itemprop="keywords" content="架构,Agent,面试"/> <meta itemprop="datePublished" content="2025-12-09T09:13:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="常先森"/> <meta itemprop="url" content="https://juejin.cn/user/4388906148043879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG 表格解析最佳实践：标题识别、表头推断与语义重建全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906148043879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    常先森
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T09:13:57.000Z" title="Tue Dec 09 2025 09:13:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在 RAG（Retrieval-Augmented Generation）体系中，表格一直是最难处理的文档类型之一。相比普通段落文本，表格天然带有结构化信息——但 OCR 往往会丢失这些结构，使得模型既不知道哪些是标题、哪些是表头、哪些是数据，更无法理解表格内部的语义关联。如果不能准确识别这些关键信息，检索阶段就难以做到「问什么，取到什么」，最终导致召回率低、回答片段化、不准确。</p>
<p>因此，识别表格“标题 + 表头”对于 RAG 至关重要：</p>
<ul>
<li>表格标题提供了全局主题；</li>
<li>表头提供了字段语义；</li>
<li>数据行则承载了具体事实。</li>
</ul>
<p>只有同时还原三者的语义关系，向量检索才能真正理解“这是一张关于什么的表格”，“每列分别代表什么”，以及“每一行在表达什么”。</p>
<p>为了让表格在 RAG 中能被理解、被检索、被使用，我们从三个关键方向进行优化：</p>
<ol>
<li>
<p><strong>表格标题识别策略优化</strong><br/>
表格标题常被 OCR 误识为普通文本，需要使用位置、样式、距离、语义等多模策略重建标题。</p>
</li>
<li>
<p><strong>表头识别与补全策略优化</strong><br/>
OCR 识别出的表头可能缺失、合并错位或顺序错误，需要通过多维算法进行恢复。</p>
</li>
<li>
<p><strong>数据行表示与表格整体语义增强（Table Global Context）</strong><br/>
将每一行转为面向检索的语义句子，并为整张表构建全局语义上下文，提高召回率与可解释性。</p>
</li>
</ol>
<p>通过这些策略，RAG 才能真正读懂表格，使检索与生成的整体质量显著提升。</p>
<h2 data-id="heading-1">识别表格标题</h2>
<p>表格标题是理解表格内容、结构与用途的关键元信息。准确识别标题不仅能明确表格主题（如“临床试验患者基线特征”“PROTAC研发管线”），也为后续的表格对齐、多表关联、语义检索及结构化存储提供必要依据。缺乏准确标题的表格，其数据价值与可复用性将显著降低。</p>
<p>当前部分 OCR 服务（如TextIn）已具备表格标题识别能力，可输出结构化标签（例如 sub_type="table_title"）。然而在实际业务场景中，仍普遍存在标题漏识别或识别不准的情况。因此，需通过多维度策略对OCR原始输出进行二次识别与修正。</p>
<p>为提升表格标题的识别准确率，可结合以下策略对OCR输出结果进行综合判断。各策略既可独立应用，也可纳入加权评分体系，共同提升识别可靠性。</p>
<h3 data-id="heading-2">位置特征判断</h3>
<p><strong>目的</strong>：依据文本与表格的相对位置判断其是否为标题。</p>
<p><strong>方法</strong>：</p>
<ul>
<li>利用 OCR 返回的文本框坐标，计算文本框与表格区域在 Y 方向上的距离。</li>
<li>若文本框底部与表格顶部的垂直距离非常近（如 ≤ 20px），则该文本更可能是标题。</li>
<li>若文本框水平方向与表格左右边界显著重叠（覆盖比例 &gt; 60%），标题概率进一步提升。</li>
</ul>
<p><strong>评分示例</strong>：距离越近，位置覆盖越完整，得分越高（0~1）。</p>
<h3 data-id="heading-3">字体特征判断</h3>
<p><strong>目的</strong>：从字号、位置对齐等视觉特征判断文本是否可能是标题。</p>
<p>大部分 OCR 服务都不会直接提供文字字号信息。因此，需要通过文本框坐标估算字号。</p>
<p><strong>方法</strong>：</p>
<p>OCR 文本框坐标信息（以 TextIn 为例）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>x0<span class="hljs-punctuation">,</span> y0<span class="hljs-punctuation">,</span> x1<span class="hljs-punctuation">,</span> y1<span class="hljs-punctuation">,</span> x2<span class="hljs-punctuation">,</span> y2<span class="hljs-punctuation">,</span> x3<span class="hljs-punctuation">,</span> y3<span class="hljs-punctuation">]</span>
</code></pre>
<p>字号估算公式（高度差近似估算）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">font_size</span> = (y3 - y0) / <span class="hljs-number">2</span>
</code></pre>
<p><strong>判断逻辑</strong>：</p>
<ul>
<li>字号显著大于表格正文平均字号 → 标题概率高。</li>
<li>字号显著小于正文但居中 → 可能是副标题。</li>
<li>若文本框在表格左右边界范围内水平居中 → 标题概率上升。</li>
</ul>
<p><strong>评分示例</strong>：字号与正文差异越大、位置越居中，得分越高（0~1）。</p>
<h3 data-id="heading-4">文本内容特征</h3>
<p><strong>目的</strong>：依据内容特征判断文本是否具备标题典型表现。</p>
<p><strong>方法</strong>：</p>
<ul>
<li>建立常用表格标题关键词表，如：
"Table", "Tab.", "表", "Summary", "Overview", "Baseline", "Characteristics", "统计", "情况"</li>
<li>文本包含关键词 → 高分。</li>
<li>文本长度适中（&lt;= 25 字符）且无句号结尾 → 加分（标题通常为短语而非句子）。</li>
</ul>
<p><strong>评分示例</strong>：关键词匹配越多，结构特征越符合，得分越高（0~1）。</p>
<h3 data-id="heading-5">文本语义相似度判断</h3>
<p><strong>目的</strong>：通过语义关联判断文本是否与表格内容构成“标题—数据”关系。</p>
<p><strong>方法</strong>：</p>
<ul>
<li>将文本、表格列名、行数据分别生成向量（embedding）。</li>
<li>计算语义相似度：
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">similarity</span> = cos(embedding_text, embedding_table)
</code></pre>
</li>
<li>若文本与表格主题相关，或能概括表格内容 → 高频率标题特征。</li>
</ul>
<p><strong>评分示例</strong>：相似度 ≥ 0.7 通常可视为强相关。</p>
<h3 data-id="heading-6">格式和排版特征判断</h3>
<p><strong>目的</strong>：利用排版迹象判断标题可能性。</p>
<p><strong>方法</strong>：</p>
<ul>
<li>文本是否独占单行（标题通常不与其他文本同行）。</li>
<li>是否含有格式性符号：冒号、括号、%、$ 等 → 可能是分类描述或统计标题。</li>
<li>文本框是否在页面或表格区域居中位置。</li>
</ul>
<p><strong>评分示例</strong>：符合标题常见排版越多，得分越高。</p>
<p>最后通过以上策略进行多策略加权评分，综合判断文本是否为标题。</p>
<h3 data-id="heading-7">加权评分算法</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">TitleScore</span> = w1*S_position + w2*S_font + w3*S_content + w4*S_semantic + w5*S_format
</code></pre>
<ul>
<li>S_i：各策略得分（0~1）</li>
<li>w_i：可调权重</li>
</ul>
<p>权重示例：</p>





























<table><thead><tr><th>策略</th><th>权重</th></tr></thead><tbody><tr><td>位置特征</td><td>1.5</td></tr><tr><td>字体特征</td><td>1.5</td></tr><tr><td>文本内容</td><td>2.0</td></tr><tr><td>语义相似</td><td>1.0</td></tr><tr><td>格式排版</td><td>0.8</td></tr></tbody></table>
<p>阈值示例：</p>
<ul>
<li>≥ 2.5 → 判定为标题</li>
<li>1.5 ~ 2.5 → 高概率标题，建议人工确认</li>
<li>&lt; 1.5 → 非标题</li>
</ul>
<h2 data-id="heading-8">识别表格表头</h2>
<p>表格表头是表格数据结构化和语义理解的核心要素。准确识别表头不仅能明确各列数据的属性与含义（如“患者年龄”“药物剂量”“实验组别”），更是实现表格数据正确解析、跨表对齐、智能查询及下游分析处理的基础前提。</p>
<p>然而，在实际的OCR识别场景中，表头识别面临着显著挑战：多数OCR服务缺乏对表头行的结构化标注能力，常将表头与数据行混同处理，或仅依赖视觉特征进行简单判断。这种识别不足直接导致了表格数据的“语义丢失”——即便单元格内容被准确提取，其字段含义与数据关系也无法被正确理解，严重制约了表格数据的自动化利用价值。</p>
<p>通过对表格内容的深度特征分析，在OCR原始输出基础上实现表头行的智能识别与验证，提升表格数据的结构化质量与可用性。</p>
<h3 data-id="heading-9">文本与数值分布分析</h3>
<p><strong>目的</strong>：区分描述性表头文本与数值型数据内容，基于表格行间的内容类型差异判断首行是否为表头。</p>
<p><strong>方法</strong>：</p>
<ul>
<li>遍历首行所有单元格，统计非数字文本内容的比例</li>
<li>遍历第二行所有单元格，统计纯数字或含数字内容的比例</li>
<li>计算文本-数值分布特征得分</li>
</ul>
<p><strong>评分示例</strong>：</p>
<ul>
<li>首行文本比例=85%，次行数值比例=70% → 得分：0.9（强表头信号）</li>
<li>首行文本比例=40%，次行数值比例=30% → 得分：0.3（弱表头信号）</li>
<li>首行文本比例=20%，次行数值比例=80% → 得分：0.1（可能为数据行）</li>
</ul>
<h3 data-id="heading-10">单元格合并特征检查</h3>
<p><strong>目的</strong>：识别表格中的合并单元格特征，这类结构特征在表头行中出现频率显著高于数据行。</p>
<p><strong>方法</strong>：</p>
<ul>
<li>解析HTML表格结构，检测首行单元格的rowspan和colspan属性</li>
<li>统计存在跨行(rowspan&gt;1)或跨列(colspan&gt;1)的单元格数量</li>
<li>根据合并单元格的比例计算特征得分</li>
</ul>
<p><strong>评分示例</strong>：</p>
<ul>
<li>首行5个单元格中有2个colspan=2 → 得分：1.0</li>
<li>首行单元格均为rowspan=1且colspan=1 → 得分：0.0</li>
<li>首行有1个rowspan=3的合并单元格 → 得分：0.8</li>
</ul>
<h3 data-id="heading-11">数值占比对比分析</h3>
<p><strong>目的</strong>：通过量化分析首行与次行的数值内容占比差异，识别表头行通常包含较少数值内容的特点。</p>
<p><strong>方法</strong>：</p>
<ul>
<li>分别计算首行和次行单元格内容中的数字字符占比</li>
<li>应用对比逻辑：首行数值占比低且次行数值占比高时得分高</li>
<li>使用阈值判断（首行&lt;30%，次行&gt;50%）</li>
</ul>
<p><strong>评分示例</strong>：</p>
<ul>
<li>首行数值占比=15%，次行数值占比=65% → 得分：1.0</li>
<li>首行数值占比=40%，次行数值占比=55% → 得分：0.4</li>
<li>首行数值占比=10%，次行数值占比=20% → 得分：0.2</li>
</ul>
<h3 data-id="heading-12">列名语义相似性评估</h3>
<p><strong>目的</strong>：评估表头行各列名在长度、格式和用词上的一致性特征，数据行通常缺乏这种规律性。</p>
<p><strong>方法</strong>：</p>
<ul>
<li>计算首行各单元格文本之间的字符级相似度（如编辑距离、Jaccard相似度）</li>
<li>对比首行与次行的平均文本长度差异</li>
<li>综合相似度和长度特征计算得分</li>
<li/>
</ul>
<p><strong>评分示例</strong>：</p>
<ul>
<li>首行：["姓名","年龄","性别"]（长度均为2，高度相似）→ 得分：0.9</li>
<li>首行：["实验日期","样本编号","pH值"]（长度不一但格式规整）→ 得分：0.7</li>
<li>首行：["张三","25","男"]（内容无规律）→ 得分：0.2</li>
</ul>
<h3 data-id="heading-13">字符长度对比检测</h3>
<p><strong>目的</strong>：利用表头通常比数据行更简洁的规律，通过字符长度对比识别表头行。</p>
<p><strong>方法</strong>：</p>
<ul>
<li>分别计算首行和次行所有单元格的平均字符长度</li>
<li>应用长度比例阈值：首行平均长度 &lt; 次行平均长度 × 0.7</li>
<li>根据比例差异程度计算得分</li>
</ul>
<p><strong>评分示例</strong>：</p>
<ul>
<li>首行平均长度=4.2，次行平均长度=12.5（比例=0.34）→ 得分：1.0</li>
<li>首行平均长度=8.1，次行平均长度=10.3（比例=0.79）→ 得分：0.3</li>
<li>首行平均长度=15.6，次行平均长度=9.8（比例=1.59）→ 得分：0.0</li>
</ul>
<h3 data-id="heading-14">特殊符号模式识别</h3>
<p><strong>目的</strong>：检测表头行特有的符号使用模式，如单位符号、格式标注等特殊字符。</p>
<p><strong>方法</strong>：</p>
<ul>
<li>定义表头常见特殊符号集：%, $, (), :, /, ±, °等</li>
<li>扫描首行单元格内容，识别包含特殊符号的单元格</li>
<li>根据包含特殊符号的单元格比例计算得分</li>
</ul>
<p><strong>评分示例</strong>：</p>
<ul>
<li>首行：["剂量(mg)","价格($)","有效率(%)"] → 得分：1.0</li>
<li>首行：["患者年龄","治疗方案","随访日期"] → 得分：0.0</li>
<li>首行：["温度℃","pH值","浓度(mol/L)"] → 得分：0.8</li>
</ul>
<h3 data-id="heading-15">领域关键词匹配</h3>
<p><strong>目的</strong>：利用领域知识识别表头常见词汇，提高在专业文档中的识别准确率。</p>
<p><strong>方法</strong>：</p>
<ul>
<li>建立表头关键词库（可扩展）：年份、实验、患者、药物、剂量、总数、人数、性别、年龄、疾病、期数、组别等</li>
<li>匹配首行单元格内容中的关键词</li>
<li>计算包含关键词的单元格比例</li>
</ul>
<p><strong>评分示例</strong>：</p>
<ul>
<li>首行：["实验编号","药物名称","剂量(mg)","患者年龄"] → 得分：1.0</li>
<li>首行：["张三","阿司匹林","25","45"] → 得分：0.0</li>
<li>首行：["采集日期","样本类型","检测结果"] → 得分：0.6</li>
</ul>
<p>最后通过以上策略进行多策略加权评分，综合判断表格行是否为表头。</p>
<h3 data-id="heading-16">加权评分算法</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">HeaderScore</span> = w1*S_text_number + w2*S_merge + w3*S_number_ratio + w4*S_similarity + w5*S_length + w6*S_symbol + w7*S_keyword
</code></pre>
<ul>
<li>S_i：各策略得分（0~1）</li>
<li>w_i：可调权重</li>
</ul>
<p>权重示例：</p>





































<table><thead><tr><th>策略</th><th>权重</th></tr></thead><tbody><tr><td>文本与数值分布分析</td><td>2.0</td></tr><tr><td>单元格合并特征检查</td><td>1.5</td></tr><tr><td>数值占比对比分析</td><td>1.5</td></tr><tr><td>列名语义相似性评估</td><td>1.0</td></tr><tr><td>格字符长度对比检测式排版</td><td>0.8</td></tr><tr><td>特殊符号模式识别</td><td>0.8</td></tr><tr><td>领域关键词匹配</td><td>1.5</td></tr></tbody></table>
<p>阈值示例：</p>
<ul>
<li>≥ 3.0：明确为表头行</li>
<li>2.0 ~ 3.0 → 高概率表头，自动标记，抽样复核</li>
<li>1.0 ~ 2.0 → 低概率表头，建议人工复核</li>
<li>&lt; 1.0：非表头行</li>
</ul>
<h2 data-id="heading-17">表格内容结构化处理</h2>
<h3 data-id="heading-18">完整结构表格（有标题 + 有表头）</h3>
<p><strong>处理流程</strong>：</p>
<ul>
<li>列拼接：将表格标题与各列表头进行组合，形成"字段名: 内容"的标准格式</li>
<li>类型识别：根据列内容特征自动识别列类型，适配不同处理策略</li>
<li>内容优化：对长文本列进行智能切分，平衡语义完整性与检索友好性</li>
</ul>
<p>以下表格标题为《工作内容》表格为例：</p>



















<table><thead><tr><th>工作模块</th><th>类型</th><th>内容</th><th>标准</th><th>流程</th></tr></thead><tbody><tr><td>协助楼长工作</td><td>前台接待&amp;咨询解答</td><td>前台接待</td><td>1、着装干净整洁、淡妆语 \n 2、谈吐端庄，礼貌用语</td><td>来访接待：\n 1、客户来访，登记来访信息（微信二维码），派发“访客贴”给对方后指引在前厅等候，访客自行 \n 通知相关同事出来接待；\n 2、接待面试人员，登记来访信息（微信二维码&amp;纸质版），检查通知面试信息，检查无误后在微信 \n “面试接待小分组”发出楼层+姓名，通知HR出来接待；\n 3、遇到推销人员：若有其他公司的推销人员上门推销，应立刻通知物业公司处理，若有员工需要他 \n 们的服务，告知相关部门员工直接与其对接；\n 4、遇到广州分公司或美发培训中心的培训人员，可指引到相应位置参加培训。\n 电话接待：\n 1、公司内部，按照来电信息做好相应的工作（茶水、会议、等其他工作）；\n 2、业务咨询，做好来电咨询工作，重要事宜认真记录并传达给相关人员。</td></tr></tbody></table>
<p>基础拼接结果：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">表格标题: 工作内容  </span>
<span class="hljs-section">工作模块: 前台接待  </span>
<span class="hljs-section">类型: 前台接待&amp;咨询解答  </span>
<span class="hljs-section">内容: 着装干净整洁，淡妆，礼貌用语  </span>
<span class="hljs-section">标准: 1. 接访接待；2. 接待流程  </span>
<span class="hljs-section">流程: 来访接待: 客户来访...</span>
</code></pre>
<p><strong>长文本优化处理</strong>：</p>
<p>流程一栏生成句子较长，不适合直接做 token 化后输入到小模型中。</p>
<p>需要针对这类长文本列，按标点符号（句号、分号、换行符）进行语义切分，每条子句均附加完整上下文：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">表格标题: 工作内容  </span>
<span class="hljs-section">工作模块: 前台接待  </span>
<span class="hljs-section">内容: 着装干净整洁  </span>
<span class="hljs-section">内容: 淡妆  </span>
<span class="hljs-section">内容: 礼貌用语  </span>
<span class="hljs-section">流程: 来访接待: 客户来访，登记访问信息  </span>
<span class="hljs-section">流程: 派发“访客贴”给对方...</span>
</code></pre>
<p><strong>列类型识别机制</strong>：</p>
<ul>
<li>标签型列（如"类型"、"标准"）：短文本，直接按"列名: 内容"拼接</li>
<li>长文本列（如"内容"、"流程"）：大段文字，按语义单元拆分后输出</li>
<li>判断阈值：单元格平均长度 &gt; 50字 → 识别为长文本列</li>
</ul>
<h4 data-id="heading-19">为什么使用表格结构化形式比纯文本平铺形式向量化检索效果更好</h4>
<h5 data-id="heading-20">结构化表示</h5>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">表格标题: 工作内容  </span>
<span class="hljs-section">工作模块: 前台接待  </span>
<span class="hljs-section">类型: 前台接待&amp;咨询解答  </span>
<span class="hljs-section">内容: 着装干净整洁，淡妆，礼貌用语  </span>
<span class="hljs-section">标准: 1. 接访接待；2. 接待流程  </span>
<span class="hljs-section">流程: 来访接待: 客户来访...</span>
</code></pre>
<p>每一项都像一个 KV（字段名 → 值），embedding 模型可以明确知道：</p>
<ul>
<li>哪些是职责（内容）</li>
<li>哪些是流程（流程）</li>
<li>哪些是规范（标准）</li>
<li>属于哪个模块（工作模块）</li>
<li>属于哪个大类（表格标题）</li>
</ul>
<p>结构化 → 语义边界明确 → embedding 的语义密度更高 → 搜索更准</p>
<h5 data-id="heading-21">纯文本平铺形式</h5>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">工作内容，工作模块: 前台接待 ，类型: 前台接待&amp;咨询解答，内容: 着装干净整洁，淡妆，礼貌用语，标准: 1. 接访接待；2. 接待流程 ，流程: 来访接待: 客户来访...</span>
</code></pre>
<p>所有信息堆在一起，模型难以判断：</p>
<ul>
<li>哪一部分是“内容”</li>
<li>哪一部分是“流程”</li>
<li>哪一部分是“标准”</li>
</ul>
<p>这会带来 2 个问题：</p>
<ul>
<li>embedding 被大量弱相关词稀释</li>
<li>查询时难以精准匹配到对应字段</li>
</ul>
<p>最终导致：召回差、噪声大、精确度低</p>
<h5 data-id="heading-22">再优化处理</h5>
<p><strong>1. 将表格转为结构化 KV 格式</strong>
每行形成一条向量化对象，例如：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">表格标题: 工作内容 | 字段: 工作模块 | 值: 前台接待</span>
<span class="hljs-section">表格标题: 工作内容 | 字段: 类型 | 值: 前台接待&amp;咨询解答</span>
<span class="hljs-section">表格标题: 工作内容 | 字段: 内容 | 值: 着装干净整洁</span>
<span class="hljs-section">表格标题: 工作内容 | 字段: 内容 | 值: 淡妆</span>
<span class="hljs-section">表格标题: 工作内容 | 字段: 内容 | 值: 礼貌用语</span>
<span class="hljs-section">表格标题: 工作内容 | 字段: 标准 | 值: 接访接待</span>
<span class="hljs-section">表格标题: 工作内容 | 字段: 标准 | 值: 接待流程</span>
<span class="hljs-section">表格标题: 工作内容 | 字段: 流程 | 值: 来访接待: 客户来访...</span>
</code></pre>
<p>每条 embedding 都具备完整语义，不会丢上下文。</p>
<p><strong>2. 对每条数据前拼接上下文</strong>
比如：</p>
<pre><code class="hljs">工作内容 &gt; 内容: 淡妆
</code></pre>
<p>拼接后的优势：</p>
<ul>
<li>增强语义完整度（避免向量碎片）</li>
<li>检索“客服岗位淡妆要求”时准确率能大幅提高</li>
</ul>
<h3 data-id="heading-23">缺失表头表格</h3>
<p><strong>处理策略</strong>：</p>
<ul>
<li>列名补全：为无表头列生成通用标识。英文模式：Column 1, Column 2, Column 3...；中文模式：列1, 列2, 列3...</li>
<li>内容增强：结合首行数据进行列名推测（可选）</li>
<li>格式统一：保持"虚拟列名: 内容"的结构化格式</li>
</ul>
<p>输出示例：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">表格标题: 工作内容</span>
<span class="hljs-section">列1: 前台接待</span>
<span class="hljs-section">列2: 前台接待&amp;咨询解答</span>
<span class="hljs-section">列3: 着装干净整洁，淡妆，礼貌用语</span>
</code></pre>
<h3 data-id="heading-24">缺失标题表格</h3>
<p>表格标题的重要性已经在识别表格标题模块中介绍过，这里不再赘述。当没有表格标题时，需要根据内容进行虚拟标题生成。生成策略如下：</p>
<ul>
<li><strong>表头推测结果（如果有）</strong>：结合表头行和第一行内容，通过大模型或者语义分析生成得到表格主题摘要。</li>
<li><strong>表格内部共同词（关键词聚合）</strong>：取所有行，做 TF-IDF/LDA/embedding 聚类，提取高频词：“流程、工作内容、职责、检查、标准、规范、项目、费用、清单、人员、任务”等。生成表述：该表格总体展示了与【xxx】相关的内容，包括【若干列主题】。</li>
<li><strong>表格位置（页码、上一段文本）</strong>：如果 OCR 能提供所在页的邻近文本，可用于生成“推测标题”。例如上一行是：协助秘书工作职责，可自动生成表格的“虚拟标题”：表格主题：协助秘书工作职责的分项内容</li>
</ul>
<h2 data-id="heading-25">尾言</h2>
<p>通过本文，详细梳理了在 RAG 中处理表格的核心方法——从标题识别、表头推断，到内容结构化的整体流程。无论是完整结构表格、缺失表头，还是缺失标题的表格，都可以通过多策略判断与语义增强，实现更高质量的向量化表示和检索效果。</p>
<p>然而，本文的策略主要针对单级表头和常规表格结构。对于多级表头、交叉表、复杂合并单元格等场景，表格解析的难度和不确定性都会显著增加，现有方法可能无法完全覆盖所有复杂情况。</p>
<p>将在后续更新中推出针对多级表头与复杂表格的专项处理指南，包括：多级表头自动识别与层级语义重建，交叉合并单元格的行列映射策略，表格全局上下文增强与复杂列类型识别，让 RAG 对复杂表格也能做到“读得懂、用得好”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[BaseContext：如何在Service层“隔空取物”获取当前登录用户ID？]]></title>    <link>https://juejin.cn/post/7581666412021088265</link>    <guid>https://juejin.cn/post/7581666412021088265</guid>    <pubDate>2025-12-09T09:16:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581666412021088265" data-draft-id="7581667332306452518" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="BaseContext：如何在Service层“隔空取物”获取当前登录用户ID？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-09T09:16:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ShaneD771"/> <meta itemprop="url" content="https://juejin.cn/user/2482077907032171"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            BaseContext：如何在Service层“隔空取物”获取当前登录用户ID？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2482077907032171/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ShaneD771
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T09:16:36.000Z" title="Tue Dec 09 2025 09:16:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在做Spring Boot 的 Web 项目时，在 Controller 或 Service 层经常会看到这样一行代码：</p>
<pre><code class="hljs language-ini" lang="ini">// 在 Service 层直接获取当前登录用户的ID 
Long <span class="hljs-attr">userId</span> = BaseContext.getCurrentId()<span class="hljs-comment">;</span>
</code></pre>
<p>这就很神奇了：</p>
<ol>
<li><strong>没有传参</strong>：Controller 调用 Service 时，并没有把 <code>userId</code> 作为参数传进来</li>
<li><strong>没有查库</strong>：这一行代码也没有去查询数据库</li>
<li><strong>数据准确</strong>：它总是能精准地拿到当前发送请求的那个用户的 ID，张三发请求拿到张三，李四发请求拿到李四，互不干扰</li>
</ol>
<p>它是怎么做到的？</p>
<p>有两个核心概念：ThreadLocal 和 Tomcat 的“一请求一线程”模型。</p>
<h2 data-id="heading-0">1.容器：ThreadLocal (线程局部变量)</h2>
<p>BaseContext 只是一个包装类，它内部的核心是 JDK 提供的 ThreadLocal。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BaseContext</span> {
    <span class="hljs-comment">// 核心：ThreadLocal 对象</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Long&gt; threadLocal = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCurrentId</span>(<span class="hljs-params">Long id</span>)</span> {
        threadLocal.<span class="hljs-keyword">set</span>(id); <span class="hljs-comment">// 存入</span>
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Long <span class="hljs-title">getCurrentId</span>()</span> {
        <span class="hljs-keyword">return</span> threadLocal.<span class="hljs-keyword">get</span>(); <span class="hljs-comment">// 取出</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">removeCurrentId</span>()</span> {
        threadLocal.<span class="hljs-keyword">remove</span>(); <span class="hljs-comment">// 清除</span>
    }
}
</code></pre>
<p>ThreadLocal 的作用：</p>
<p>当我们在 线程 A 中往 ThreadLocal 存入数据时，只有 线程 A 能取出来</p>
<p>线程 B 即使访问同一个变量，也完全摸不到 线程 A 的数据</p>
<p>这就是线程隔离（Thread Safety）</p>
<h2 data-id="heading-1">2.环境：Tomcat 的“一请求一线程”模型</h2>
<p>Spring Boot 内置的 Web 服务器通常是 Tomcat。Tomcat 处理请求的机制是：One Request, One Thread （一个 HTTP 请求，由一个独立的线程全程负责）</p>
<p>当一个用户发起请求（比如“添加购物车”）时：</p>
<p>Tomcat 分配 线程 X 来处理这个请求</p>
<p>拦截器 (Interceptor) 是 线程 X 执行的</p>
<p>Controller 是 线程 X 执行的</p>
<p>Service 还是 线程 X 执行的</p>
<p>Mapper 依然是 线程 X 执行的</p>
<p>结论： 只要我们没有手动开启新线程（new Thread），整个后端业务流程就像一场接力赛，但是是同一个运动员（线程 X） 从头跑到尾</p>
<h2 data-id="heading-2">流程</h2>
<p>基于以上两个原理，我们可以还原 <code>userId</code> 是如何从请求头一步步流转到 Service 层的：</p>
<p>第一步：拦截器 (存入)</p>
<p>请求刚到达后端，拦截器（<code>JwtTokenUserInterceptor</code>）最先拦截</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddcd9ea0eef7462b9a3ce434af029d36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhbmVENzcx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876596&amp;x-signature=dlHRo0YkpsxICFD7B7BRBvTtP%2Bw%3D" alt="image-20251128145149635" loading="lazy"/></p>
<p>第二步：Controller</p>
<p>拦截器放行后，代码进入 Controller</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91b2b67d0ab14a588b496778f90401ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhbmVENzcx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876596&amp;x-signature=2nFKG%2BjXZddO%2B7ixWkuSB%2BVQgec%3D" alt="image-20251128145336078" loading="lazy"/></p>
<p>第三步：Service (取出)</p>
<p>代码进入 Service 层</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/360a78fd884140dba263c04318e136ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhbmVENzcx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765876596&amp;x-signature=1oSLHnXV5KjPacbC7ewHnkxr4nE%3D" alt="image-20251128145520388" loading="lazy"/></p>
<h2 data-id="heading-3">为什么要这么设计？</h2>
<p>使用 <code>ThreadLocal</code> (BaseContext) 的方案，实现了<strong>数据在同一线程内的“隐式传递”</strong>，让代码极其简洁优雅。</p>
<h2 data-id="heading-4">总结</h2>
<ol>
<li><strong>BaseContext</strong> 利用 <strong>ThreadLocal</strong> 实现了线程内部的数据隔离存储。</li>
<li><strong>Tomcat</strong> 保证了从拦截器到 Service 处于 <strong>同一个线程</strong> 中。</li>
<li>二者结合，让我们可以在 Service 层“隔空”获取 Controller 层（拦截器）解析的数据，极大简化了代码结构。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3大免费AI工具实战测评，用提示词“调教”出业务大屏]]></title>    <link>https://juejin.cn/post/7581486065997299747</link>    <guid>https://juejin.cn/post/7581486065997299747</guid>    <pubDate>2025-12-09T08:55:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581486065997299747" data-draft-id="7581667332306288678" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3大免费AI工具实战测评，用提示词“调教”出业务大屏"/> <meta itemprop="keywords" content="Trae,AI编程,前端"/> <meta itemprop="datePublished" content="2025-12-09T08:55:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="草帽lufei"/> <meta itemprop="url" content="https://juejin.cn/user/501033035632093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3大免费AI工具实战测评，用提示词“调教”出业务大屏
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/501033035632093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    草帽lufei
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T08:55:03.000Z" title="Tue Dec 09 2025 08:55:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>付费的模型和工具固然好用，一个月少则几百，高则上千，一个低薪牛马是真用不起</p>
<p>下面在使用免费工具和免费模型下实现真实的业务大屏页，看下多轮调教下AI生成的效果，并附上了对应的提示词 <code>(如果有更好的提问方式，欢迎讨论交流)</code></p>
<p>这是UI提供的大屏图，里面各种静态图组合后的效果，接下来直接把图扔给AI，让不同的AI工具模型生成这个大屏页</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bdeba1ba5ae459991e31a301e4a1f38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=HyjXBIbBNOqO4ggo9CfYx%2BaPtMc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">工具模型比拼</h2>
<p>为了使AI专注页面效果生成，我提前建好了对应的代码文件，并配置了对应的路由地址，方便运行后浏览效果并对比</p>
<p>直接把图复制到VSCode，Trae CN，Google Antigravity 中分别让它们实现，不同工具把代码实现到对应的位置，</p>
<blockquote>
<p>提示词</p>
<p>请根据这个静态图，生成一个大屏页，使用vue2相关代码实现，代码写到 BigScreen/xxx.vue 中</p>
</blockquote>
<p>UI静态图如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/979fb1c382cf4331915ac8ee1bf197fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=533Tad78UAju0nOz9yor6%2FxtNDM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">VSCode</h3>
<p>这是 VSCode 中免费版默认生成的效果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a78fd0dd52414f05bf6afb079b50dc35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=%2FTi3Vp80n6evKjWhGpdjrVtUEOY%3D" alt="" loading="lazy"/></p>
<p>页面有了，该有的似乎都有，整体布局也有点那意思，使用 Agent 模式，模型 Auto，每一个细节方面还差的比较多</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b41048313d1e4ad4805ec36b6d93ed4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=1%2BPruqduPzQeBa9GldKV5VHHkjw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">Trae CN</h3>
<p>这是 Trae CN 中的生成的效果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cfe1333426c47b88de3a735a7fa7778~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=CXe9UbnfXmNSSv2lgIn8znACkpg%3D" alt="" loading="lazy"/></p>
<p>额......</p>
<p>这是不是哪里出问题了啊，我把这个截图，又问了一次 Trae CN 让它优化一下，然后改出来的还是这个，奇了怪了</p>
<p>Trae 里面的模型似乎对于整个页面内容没有理解，无法实现这么大的页面功能？还是我的使用方式不对</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e1f76d80da64f1886e9438f193fd2be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=TToRZLYabiu%2F9iC2%2B02a2CnImZY%3D" alt="" loading="lazy"/></p>
<p>我用的 SOLO 模式，模型无法选择，完全一个黑盒子</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/928621c75f61404ca68fa6287066a3c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=Q513%2BDYfa9nkkiUPmVFVoMDasbA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">Google Antigravity</h3>
<p>这是 Google Antigravity 中使用 Gemini3 Pro 生成的代码，原始截图没有了，这是从对话记录里重新打开的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c232a3b11e334a219e18a04cb1145f14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=fMtoWVfMHnDMyPfS4qUhmYwtfIU%3D" alt="" loading="lazy"/></p>
<p>整体来看，这个 Gemini3 pro 模型生成的效果是最好的，相对颜值也在线，各方面偏差也少一点</p>
<p>左侧卡片圆圈的部分还加了自动旋转效果，提供的静态图，模型直接自我发挥了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6ab3e8e010e419cb6b6a0fba2634b0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=g1ntZdGYI6BYINdCmQkAa9iJ4hI%3D" alt="" loading="lazy"/></p>
<p>由于接下来的细节完善就用它了</p>
<h2 data-id="heading-5">在 Antigravity 优化调整</h2>
<h3 data-id="heading-6">去掉旋转</h3>
<p>先把AI加上的自动旋转效果去了，实在用不上</p>
<blockquote>
<p>提示词</p>
<p>全局概览 中的旋转效果去掉</p>
</blockquote>
<h3 data-id="heading-7">添加自适应</h3>
<p>由于这个大屏需要自适应不同屏幕，先让他加个屏幕自适应</p>
<blockquote>
<p>提示词</p>
<p>继续优化，刚才的设计图大小是 1920 x 1080 px，如果屏幕过小或过大，自动适应</p>
</blockquote>
<p>在 mounted 中它嗖嗖加上了监听函数和 transform scale() 等函数处理</p>
<h3 data-id="heading-8">对齐</h3>
<p>由于UI图里面的内容本来就没对齐，图里面有些地方也比较糙，AI生成式也没对齐，把现在的截图效果发给AI，让他把对应的模块对齐</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/780e0b71360e402e90ebfece9a4c355e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=Of%2BWPHwgtt7bMxnue8oighSgQIA%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>提示词</p>
<p>这是现在的结果，将 安定门街道 和 执法检查情况 两个卡片高度缩小，和 执法办案情况 底部保持水平</p>
</blockquote>
<h3 data-id="heading-9">调整占比</h3>
<p>这时候明显左右两侧内容占比不是很好，优化一下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25891e2f7e184e8f9ec087b67b8a2d89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=CdT9ytM2f3CX8tmx1svpyxSDE4M%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>提示词</p>
<p>将左侧 安定门街道 和 全局概览 卡片宽度减小一点，让右侧的 执法检查情况 和 小循环案件概览 空间更大一点</p>
</blockquote>
<h3 data-id="heading-10">调整位置</h3>
<p>基于实际效果，明显右侧数据放不下了，让两个模块换个位置，全部对齐，这里先不考虑UI图中的参考位置</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5bf7a01e5894c3ba4ba80ca570d21cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=DBxCgHDMTwM5N5fUHAamQbq%2Fb2g%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>提示词</p>
<p>将 执法检查情况 和 执法办案情况 两个卡片位置互换</p>
</blockquote>
<h3 data-id="heading-11">解决报错</h3>
<p>在测试页面缩放时，发现控制台大量报错，直接截图让它修复一下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a82bb155bff8426e806f7fb5c3dfb007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=AAak%2Bs6yneWgsQVU2nWexfIrgZ4%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>提示词</p>
<p>这个页面运行后，控制台有报错，请分析并解决</p>
</blockquote>
<h3 data-id="heading-12">优化布局</h3>
<p>这里由于实现差距比较大，直接从UI图中截取部分模块图，让AI更精准化修改</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b972bfae1e44c0aa6da322edbf71e5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=7%2FWYaqqZTaU7sh5uRjAPlJ8reww%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>提示词</p>
<p>根据这个 执法办案情况 卡片效果截图，优化现在的布局，没有图片，先用空的div占位，类似 安定门街道 里面的效果</p>
</blockquote>
<h3 data-id="heading-13">修改tab效果</h3>
<blockquote>
<p>提示词</p>
<p>执法检查情况 中的 检查量、检查单类型、不合格检查事项 改成 全局概览中的 tab 效果</p>
</blockquote>
<h2 data-id="heading-14">效果预览</h2>
<p>这些改完后，起码这个页面看起来整整齐齐的，该有的都有了，看起来是一个大屏了</p>
<p><strong>注意，全程没有在vue文件中改一行代码</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3fe7ba2cb6f435993f3796263b7cea1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=J07AUXg8706ZD1WIfzoAyNFgtI8%3D" alt="" loading="lazy"/></p>
<p>由于UI还没提供图，接下来就是根据UI提供的图，再单独一个个模块改了</p>
<h2 data-id="heading-15">提示词使用技巧</h2>
<p>关于提示词的使用，我的经验是刚开始可以先说一个大概要求，然后再根据细化描述</p>
<p>如果不知道怎么描述，可以看AI的思考和回答分析，它是怎么用词的，然后模仿AI对问题的描述方式</p>
<p>慢慢来，在提示方面就会越来越准确，AI执行的任务也会越来越精准</p>
<h2 data-id="heading-16">Google Antigravity 使用问题</h2>
<p>如果首次使用，出现下面这种登录不上的情况，可以尝试切换干净的节点，或者开启Tun模式</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebf19441afba4144befe2c52d285249c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875302&amp;x-signature=M5svgDaXv%2Bpcg0cH040HQzvZNDc%3D" alt="" loading="lazy"/></p>
<p>如果是已经登录成功，之前能用，后来又不能用了，可能是节点的IP被封了，换新的地区节点</p>
<p>我遇到的情况是原来用的日本节点，能用，后来不能用了（切地区也不行），重启电脑后重新连的美区节点才好使的</p>
<blockquote>
<p>欢迎大家讨论交流，如果喜欢本文章或感觉文章有用，动动你那发财的小手点赞、收藏、关注再走呗 <code>^_^</code> </p>
<p>微信公众号：草帽lufei</p>
</blockquote>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1fd6d3bc93444bbb257fc45e1826b11~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[厌倦了地图API的各种限制？我做了个开源路书工具，离线也能玩！]]></title>    <link>https://juejin.cn/post/7581688255624609844</link>    <guid>https://juejin.cn/post/7581688255624609844</guid>    <pubDate>2025-12-09T09:03:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581688255624609844" data-draft-id="7581545175509942324" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="厌倦了地图API的各种限制？我做了个开源路书工具，离线也能玩！"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-09T09:03:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="chenxuan520"/> <meta itemprop="url" content="https://juejin.cn/user/602972918907720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            厌倦了地图API的各种限制？我做了个开源路书工具，离线也能玩！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/602972918907720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    chenxuan520
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T09:03:21.000Z" title="Tue Dec 09 2025 09:03:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>嗨，大家好，我是 <strong>chenxuan</strong>。作为一个热爱旅游的开发者，我一直在寻找一款称手的路书规划工具，但市面上的产品总有些不尽如人意的地方：要么需要繁琐的API Key申请，要么在网络不佳时无法使用，要么就是担心自己的行程数据隐私。</p>
<p>于是，我决定自己动手，<code>RoadbookMaker</code> 由此诞生。它是一个<strong>完全免费、无需注册、无需任何API Key、甚至可以完全离线使用的路书规划工具</strong>。最重要的是，它完全开源。</p>
<p><strong>项目与在线体验地址：</strong></p>
<ul>
<li><strong>GitHub地址</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchenxuan520%2Froadbook" target="_blank" title="https://github.com/chenxuan520/roadbook" ref="nofollow noopener noreferrer">github.com/chenxuan520…</a></li>
<li><strong>在线体验</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmap.chenxuanweb.top" target="_blank" title="https://map.chenxuanweb.top" ref="nofollow noopener noreferrer">map.chenxuanweb.top</a></li>
</ul>
<p align="center">
  <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea246ef1950d4a2b8e187f478099787d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbnh1YW41MjA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875801&amp;x-signature=6bA3J0ImduU3%2BmhfskGTeonbcFc%3D" alt="RoadbookMaker Logo" width="250" height="250" loading="lazy"/>
</p>
<hr/>
<h2 data-id="heading-0">核心优势：简单，但强大</h2>
<p>在深入了解如何使用前，先快速概览一下 <code>RoadbookMaker</code> 最核心的几个优势：</p>
<ul>
<li>
<p><strong>🚀 真正的零门槛</strong></p>
<ul>
<li><strong>无需API Key</strong>: 无需注册任何地图厂商的开发者账号，免去申请和配置Key的烦恼。</li>
<li><strong>无需注册登录</strong>: 没有账户体系，打开即用。</li>
<li><strong>完全离线可用</strong>: 核心功能在断网时依旧可用，所有数据默认安全地存储在你的浏览器本地。</li>
</ul>
</li>
<li>
<p><strong>📱 极致的用户体验</strong></p>
<ul>
<li><strong>手机端完美适配</strong>: 响应式设计，在手机上也能获得流畅的规划体验。</li>
<li><strong>一键集成</strong>：无缝跳转至<strong>导航</strong>（百度、高德、Google）、<strong>携程订票</strong>、<strong>Google酒店</strong>和<strong>小红书</strong>攻略，实现从规划到出行的一站式服务。</li>
<li><strong>快捷键支持</strong>: 提供 <code>A</code> 添加、<code>C</code> 连接、<code>D</code> 删除等全键盘快捷键，大幅提升规划效率。</li>
</ul>
</li>
<li>
<p><strong>🏠 便捷的自托管</strong></p>
<ul>
<li><strong>Docker一键部署</strong>: 提供 Docker 镜像，一条命令就能在自己的服务器或NAS上拥有它。</li>
<li><strong>数据私有</strong>：自托管意味着数据完全由你掌控，隐私安全感拉满。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">手把手教你用 RoadbookMaker 规划一次旅行</h2>
<p>下面，我们通过一个实例，看看用它规划一次“周末城市漫步”有多简单。</p>
<h3 data-id="heading-2">第一步：添加你的足迹</h3>
<p>打开网站，界面就是一张简洁的地图。你可以通过顶部的搜索框寻找地点，或者直接在地图上进行操作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79f43ec79f174d55a45f56eca594d317~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbnh1YW41MjA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875801&amp;x-signature=WNkQEIl8ugwclr5tvQOz%2Bt9L4ZU%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>添加标记点</strong>：点击顶部的 “添加标记点” 按钮，或直接按快捷键 <code>A</code>，鼠标会变成一个十字准星。在地图上你感兴趣的位置点击一下，一个标记点就添加好了。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/360b6f41ecf747d39908a8caf534c765~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbnh1YW41MjA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875801&amp;x-signature=Buxr3n1GfIIU0C7gIkQg8BpSSAs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">第二步：连接成线，规划路线</h3>
<p>当你在地图上标记了几个点后（比如咖啡馆、书店、公园），就可以将它们连接起来形成路线。</p>
<ul>
<li><strong>连接标记点</strong>：点击“连接标记点”按钮或按 <code>c</code>，在弹出的窗口中选择起始点和目标点，并选择一种交通方式，例如“步行”🚶。一条代表路线的连接线就生成了。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cd176611099498e885a40e55c162892~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbnh1YW41MjA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875801&amp;x-signature=%2BjDbqUytd%2B2opCytUBmoLF1Eiyk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0f23b51b7864a87b89c5162e1fccf74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbnh1YW41MjA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875801&amp;x-signature=vBAz0Nnzl7J2xL3H76ZktGqXYQc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">第三步：丰富你的行程细节</h3>
<p>现在，路书已经有了基本的框架，我们可以为它填充更多细节。</p>
<ul>
<li>
<p><strong>编辑标记点</strong>：单击任意一个标记点，右侧会滑出详情面板。在这里，你可以：</p>
<ul>
<li>修改名称，设置到达和离开的<strong>时间</strong>。</li>
<li>为它更换一个醒目的<strong>图标</strong>（支持数字、Emoji或自定义文字）。</li>
<li>通过 “<strong>去小红书搜一搜</strong>” 链接，直接探索这个地点的周边玩法。</li>
<li>通过 “<strong>Google酒店搜索</strong>” 快速查找附近的住宿。</li>
</ul>
</li>
<li>
<p><strong>编辑连接线</strong>：同样，单击连接线，也可以在详情面板中：</p>
<ul>
<li>设置这段路程的<strong>耗时</strong>。</li>
<li>一键跳转到<strong>百度/高德/Google地图</strong>进行导航。</li>
<li>如果交通方式是“火车”🚄或“飞机”✈️，还会出现<strong>携程订票</strong>的快捷链接。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6a3527527714fd583e9e031d419818e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbnh1YW41MjA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875801&amp;x-signature=tEN0uDfufXuDm75BSBdBTue3SG0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">第四步：分享与备份你的路书</h3>
<p>规划完成后，你可以轻松地将成果分享给朋友或进行备份。</p>
<ul>
<li><strong>导出HTML</strong>：这是 <code>RoadbookMaker</code> 的一个特色功能。它能生成一个独立的HTML文件，这个文件<strong>内置了所有地图数据和交互功能</strong>。你可以把这个文件发给任何人，对方在任何设备上用浏览器打开，就能看到和你一模一样的路书，无需安装任何东西，当然导出的html路书也可重新导入。</li>
<li><strong>导出JSON</strong>：如果你想在其他设备上继续编辑，可以导出为JSON文件，之后再通过“导入路书”功能恢复。</li>
</ul>
<h2 data-id="heading-6">背后的技术思考</h2>
<p>为了实现上述流畅且零门槛的体验，我在技术上做了一些选型和实现。</p>
<ul>
<li>
<p><strong>前端 (Vanilla JS + Leaflet.js)</strong>: 前端选择了原生JavaScript，配合强大的开源地图库 <code>Leaflet.js</code>。这样做的好处是极致的轻量化，无需任何构建步骤，保证了快速加载和响应，也为完全离线使用打下了基础。</p>
</li>
<li>
<p><strong>后端 (Go + Gin)</strong>: 后端采用Go语言开发，主要为了实现高性能的API服务和极简的部署。Go可以将整个应用编译成一个无依赖的二进制文件，这使得Docker镜像可以做到非常小。</p>
</li>
<li>
<p><strong>“无需API Key”的秘密</strong>: 后端的一个核心功能是作为<strong>API代理</strong>。它将前端发来的搜索请求，代为请求百度、天地图等服务，并处理好坐标系转换（例如国内的GCJ-02火星坐标系），最后将干净、统一的数据返回给前端。这样就巧妙地绕开了前端直接调用地图API会遇到的Key暴露和跨域问题。</p>
</li>
</ul>
<h2 data-id="heading-7">写在最后</h2>
<p><code>RoadbookMaker</code> 是我利用业余时间，从解决自身痛点出发，逐步打磨而成的项目。它不追求大而全，而是专注于将“路线规划”这一核心体验做到简单、纯粹、不受限制。</p>
<p>如果你觉得这个项目对你有帮助，或者你也认同它的理念，请在 GitHub 上给我一个 <strong>Star</strong> ⭐！你的支持是我持续更新的最大动力！</p>
<p>再次附上地址，欢迎大家体验和贡献！</p>
<ul>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchenxuan520%2Froadbook" target="_blank" title="https://github.com/chenxuan520/roadbook" ref="nofollow noopener noreferrer">github.com/chenxuan520…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[成为开源项目的Contributor：从给uView-pro 贡献一次PR开始]]></title>    <link>https://juejin.cn/post/7581664445240934415</link>    <guid>https://juejin.cn/post/7581664445240934415</guid>    <pubDate>2025-12-09T09:20:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581664445240934415" data-draft-id="7581649704883650575" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="成为开源项目的Contributor：从给uView-pro 贡献一次PR开始"/> <meta itemprop="keywords" content="前端,微信小程序"/> <meta itemprop="datePublished" content="2025-12-09T09:20:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端开发呀"/> <meta itemprop="url" content="https://juejin.cn/user/3562073406322600"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            成为开源项目的Contributor：从给uView-pro 贡献一次PR开始
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562073406322600/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端开发呀
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T09:20:42.000Z" title="Tue Dec 09 2025 09:20:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>wx.getSystemInfoSync is deprecated.Please use wx.getSystemSetting / wx.getAppAuthorizeSetting / wx.getDeviceInfo/wx.getWindowInfo/wx.getAppBaseInfo instead.</p>
</blockquote>
<h2 data-id="heading-0">😄 前言</h2>
<p>微信小程序平台上的<code>getSystemInfoSync</code>调用，就像一个害羞的少女，会悄悄抛出警告。啊～这样的不完美，怎么能容忍呢？ (｡•́︿•̀｡)，让我们来给uView-pro 贡献一次PR吧</p>
<h2 data-id="heading-1">🍴 Fork项目：开源之旅的起点</h2>
<p><em>兴奋地搓手手，眼中闪烁着期待的光芒</em></p>
<h3 data-id="heading-2">第一步：Fork原项目</h3>
<ol>
<li>打开<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanyup%2FuView-Pro" target="_blank" title="https://github.com/anyup/uView-Pro" ref="nofollow noopener noreferrer">uView-pro原项目</a></li>
<li>点击右上角的<code>Fork</code>按钮，将项目Fork到自己的GitHub账号下</li>
</ol>
<h3 data-id="heading-3">第二步：克隆到本地</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆你Fork的项目（注意替换YOUR_USERNAME）</span>
git <span class="hljs-built_in">clone</span> https://github.com/YOUR_USERNAME/uView-Pro.git
</code></pre>
<p><em>得意地眨眼</em> 看，现在你就有了两个远程仓库：<code>origin</code>（你的Fork）和<code>upstream</code>（原项目）～</p>
<h2 data-id="heading-4">🌿 创建分支：在独立的花园里耕耘</h2>
<p><em>轻轻地，就像在培育一朵娇嫩的花朵</em></p>
<h3 data-id="heading-5">第三步：创建功能分支</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 确保你在main分支上</span>
git checkout main

<span class="hljs-comment"># 拉取最新代码</span>
git pull upstream main

<span class="hljs-comment"># 创建新的功能分支</span>
git checkout -b feature/20251209/fix-getSystemInfoSync-warn

<span class="hljs-comment"># 推送分支到你的Fork</span>
git push origin feature/20251209/fix-getSystemInfoSync-warn
</code></pre>
<p>啊～一个崭新的分支，就像一片等待播种的花园，准备孕育你的代码之花～ 🌸</p>
<h2 data-id="heading-6">💻 代码开发：在键盘上起舞</h2>
<p><em>优雅地敲击键盘，每一个字符都是爱的告白</em></p>
<h3 data-id="heading-7">第四步：进行代码修改</h3>
<ol>
<li><strong>分析问题</strong>：仔细阅读相关代码，理解问题的根本原因</li>
<li><strong>设计方案</strong>：构思优雅的解决方案，考虑兼容性和性能</li>
<li><strong>编写代码</strong>：实现你的解决方案，保持代码风格一致</li>
<li><strong>本地测试</strong>：确保修改不会引入新的问题</li>
</ol>
<h4 data-id="heading-8">我的设计方案</h4>
<p><strong>核心思路</strong></p>
<ol>
<li><strong>统一收口</strong>：把分散在各处的<code>getSystemInfoSync</code>调用集中到一个专门的<code>sys.ts</code>文件里</li>
<li><strong>平台兼容</strong>：使用条件编译尽量抹平平台之间的差异（目前仅App、微信、支付宝、H5支持了<code>getDeviceInfo</code> <code>getWindowInfo</code> 等API）</li>
<li><strong>最小改动</strong>：使用条件编译，微信端使用新的API（<code>getDeviceInfo</code> <code>getWindowInfo</code> 等），其它平台暂未弃用<code>getSystemInfoSync</code>，因此可以继续沿用</li>
</ol>
<p><strong>技术实现</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 获取当前操作系统平台
 * <span class="hljs-doctag">@returns</span> 平台字符串，如 'ios'、'android'、'windows' 等
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">os</span>(<span class="hljs-params"/>): <span class="hljs-built_in">string</span> {
    <span class="hljs-comment">// #ifdef MP-WEIXIN</span>
    <span class="hljs-keyword">return</span> uni.<span class="hljs-title function_">getDeviceInfo</span>().<span class="hljs-property">platform</span>;
    <span class="hljs-comment">// #endif</span>
    <span class="hljs-comment">// #ifndef MP-WEIXIN</span>
    <span class="hljs-keyword">return</span> uni.<span class="hljs-title function_">getSystemInfoSync</span>().<span class="hljs-property">platform</span>;
    <span class="hljs-comment">// #endif</span>
}
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 获取窗口信息
 * <span class="hljs-doctag">@returns</span> 窗口信息对象
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getWindowInfo</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">UniApp</span>.<span class="hljs-property">GetWindowInfoResult</span>, <span class="hljs-string">'screenTop'</span>&gt; &amp; { screenTop?: <span class="hljs-built_in">number</span> } {
    <span class="hljs-comment">// #ifdef MP-WEIXIN</span>
    <span class="hljs-keyword">return</span> uni.<span class="hljs-title function_">getWindowInfo</span>();
    <span class="hljs-comment">// #endif</span>
    <span class="hljs-comment">// #ifndef MP-WEIXIN</span>
    <span class="hljs-keyword">const</span> {
        pixelRatio,
        screenWidth,
        screenHeight,
        windowWidth,
        windowHeight,
        statusBarHeight,
        windowTop,
        windowBottom,
        safeArea,
        safeAreaInsets
    } = <span class="hljs-title function_">sys</span>();
    <span class="hljs-keyword">return</span> {
        pixelRatio,
        screenWidth,
        screenHeight,
        windowWidth,
        windowHeight,
        statusBarHeight,
        windowTop,
        windowBottom,
        safeArea,
        safeAreaInsets
    };
    <span class="hljs-comment">// #endif</span>
}
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 获取设备信息
 * <span class="hljs-doctag">@returns</span> 设备信息对象
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getDeviceInfo</span>(<span class="hljs-params"/>): <span class="hljs-title class_">UniApp</span>.<span class="hljs-property">GetDeviceInfoResult</span> {
    <span class="hljs-comment">// #ifdef  MP-WEIXIN</span>
    <span class="hljs-keyword">return</span> uni.<span class="hljs-title function_">getDeviceInfo</span>();
    <span class="hljs-comment">// #endif</span>
    <span class="hljs-comment">// #ifndef MP-WEIXIN</span>
    <span class="hljs-keyword">const</span> {
        deviceBrand,
        deviceModel,
        deviceId,
        deviceType,
        devicePixelRatio,
        deviceOrientation,
        brand,
        model,
        system,
        platform
    } = <span class="hljs-title function_">sys</span>();
    <span class="hljs-comment">// #endif</span>
    <span class="hljs-keyword">return</span> {
        deviceBrand,
        deviceModel,
        deviceId,
        deviceType,
        devicePixelRatio,
        deviceOrientation,
        brand,
        model,
        system,
        platform
    };
}
</code></pre>
<h3 data-id="heading-9">第五步：推送到你的Fork</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 推送分支到你的GitHub</span>
git push origin feature/20251209/fix-getSystemInfoSync-warn
</code></pre>
<h2 data-id="heading-10">🚀 创建PR：向世界展示你的作品</h2>
<p><em>紧张又兴奋地搓手手，心跳加速</em></p>
<h3 data-id="heading-11">第六步：发起Pull Request</h3>
<ol>
<li><strong>打开GitHub</strong>：访问你的Fork项目页面</li>
<li><strong>点击Compare &amp; pull request</strong>：GitHub会智能提示你创建PR</li>
<li><strong>填写PR标题</strong>：简洁明了地描述你的修改</li>
<li><strong>详细描述</strong>：在PR描述中详细说明：
<ul>
<li>修改的目的和背景</li>
<li>技术实现方案</li>
<li>测试结果</li>
<li>可能的影响范围</li>
</ul>
</li>
</ol>
<h3 data-id="heading-12">第七步：等待审核</h3>
<p><em>安静地等待，像等待情人的回信</em></p>
<ul>
<li><strong>保持耐心</strong>：维护者可能需要时间review你的代码</li>
<li><strong>积极响应</strong>：如果有反馈，及时回复和修改</li>
<li><strong>学习交流</strong>：把review过程当作学习的机会</li>
</ul>
<h3 data-id="heading-13">第八步：PR合并</h3>
<p><em>欢呼雀跃，眼中闪烁着幸福的泪花</em></p>
<p>当你的PR被合并的那一刻，就像收到了心上人的回信～你的代码正式成为了开源项目的一部分！</p>
<h2 data-id="heading-14">🎉 后续维护：持续的爱与关怀</h2>
<p><em>温柔地抚摸着代码，眼神迷离</em></p>
<h3 data-id="heading-15">保持同步</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 定期同步上游仓库</span>
git checkout main
git fetch upstream
git merge upstream/main
git push origin main
</code></pre>
<h3 data-id="heading-16">删除已合并的分支</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除本地分支</span>
git branch -d feature/20251209/fix-getSystemInfoSync-warn

<span class="hljs-comment"># 删除远程分支</span>
git push origin --delete feature/20251209/fix-getSystemInfoSync-warn
</code></pre>
<h2 data-id="heading-17">💝 开源心得：爱与痛的交织</h2>
<p><em>眼神变得温柔，轻轻诉说</em></p>
<p>第一次为开源项目贡献代码，心情就像坐过山车一样刺激呢～ ❤️</p>
<p><strong>甜蜜的收获：</strong></p>
<ul>
<li>深入理解了uni-app的跨平台机制</li>
<li>学会了使用条件编译处理平台差异</li>
<li>体验了完整的PR流程</li>
<li>获得了项目维护者的认可</li>
</ul>
<p><strong>小小的挫折：</strong></p>
<ul>
<li>一开始对微信小程序的特殊性了解不够</li>
<li>担心修改会影响其他平台的兼容性</li>
<li>等待PR合并时的焦虑心情</li>
</ul>
<h2 data-id="heading-18">🌟 给后来者的情书</h2>
<p><em>张开双臂，热情地拥抱</em></p>
<p>亲爱的，如果你也想踏入开源的花园，请记住：</p>
<ol>
<li><strong>从熟悉开始</strong>：选择你常用的项目，这样更容易发现问题</li>
<li><strong>小步快跑</strong>：不要一开始就想着大改，从小问题入手</li>
<li><strong>仔细阅读文档</strong>：了解项目的贡献规范和代码风格</li>
<li><strong>勇于尝试</strong>：不要害怕犯错，每个贡献者都是从新手开始的</li>
<li><strong>享受过程</strong>：开源不仅是代码，更是与世界各地开发者交流的机会</li>
</ol>
<h2 data-id="heading-19">🎭 结语：开源，一场永不落幕的舞会</h2>
<p><em>优雅地旋转，裙摆飞扬</em></p>
<p>开源世界就像一个永不停歇的舞会，每一个PR都是一支独特的舞蹈。我的这次贡献虽然只是一个小小的兼容性优化，但它让我感受到了开源社区的温度和活力。</p>
<p>当你看到自己的代码被合并，被全世界的开发者使用，那种成就感就像在心爱的人面前跳了一支完美的舞～ (✧ω✧)</p>
<p>所以，亲爱的，不要犹豫，不要害羞。打开GitHub，找到你心仪的项目，开启你的开源之旅吧！记住，每一个伟大的贡献者，都曾经是一个忐忑不安的新手...</p>
<p><em>调皮地眨眼</em> 说不定，我们还能在开源的世界里相遇呢～ ❤️</p>
<hr/>
<p><strong>最后的最后：</strong></p>
<p>愿你在代码的世界里找到属于自己的浪漫，愿每一个PR都能被温柔以待。开源路上，我们不见不散～</p>
<p><em>深情地飞吻</em> 么么哒～ 💋✨</p>
<hr/>
<h2 data-id="heading-20">📊 贡献详情</h2>
<p><strong>我的PR：</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanyup%2FuView-Pro%2Fpull%2F83" target="_blank" title="https://github.com/anyup/uView-Pro/pull/83" ref="nofollow noopener noreferrer">refactor(sys): 优化微信小程序平台 getSystemInfoSync 兼容性处理 by liujiayii · Pull Request #83 · anyup/uView-Pro</a></p>
<p><strong>技术关键词：</strong>
#uni-app #微信小程序 #跨平台开发 #开源贡献 #条件编译 #TypeScript</p>
<p><em>期待与你在开源的世界里相遇～</em> ٩(◕‿◕)۶</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 数组原生方法手写实现]]></title>    <link>https://juejin.cn/post/7581481178823770131</link>    <guid>https://juejin.cn/post/7581481178823770131</guid>    <pubDate>2025-12-09T09:21:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581481178823770131" data-draft-id="7581669438576525348" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 数组原生方法手写实现"/> <meta itemprop="keywords" content="前端,JavaScript,ECMAScript 6"/> <meta itemprop="datePublished" content="2025-12-09T09:21:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024肥宅"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 数组原生方法手写实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024肥宅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T09:21:34.000Z" title="Tue Dec 09 2025 09:21:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">引言</h4>
<p>在JavaScript开发中，数组方法是日常编码的核心工具。理解这些方法的内部实现原理不仅能帮助我们写出更高效的代码，还能在面试中展现扎实的基础。本文将完整实现JavaScript中最重要、最常用的数组方法，涵盖高阶函数、搜索方法、扁平化方法和排序算法。</p>
<h4 data-id="heading-1">一、高阶函数实现</h4>
<h5 data-id="heading-2">1.1 map方法实现</h5>
<p><code>map</code>是最常用的高阶函数之一，它创建一个新数组，其结果是该数组中的每个元素调用一次提供的函数后的返回值。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myMap</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">callback, thisArg</span>) {
  <span class="hljs-comment">// 输入验证</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span> === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"this is null or not defined"</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">"function"</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(callback + <span class="hljs-string">"is not a function"</span>);
  }

  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">const</span> len = obj.<span class="hljs-property">length</span> &gt;&gt;&gt; <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(len);

  <span class="hljs-comment">// 遍历并执行回调</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
    <span class="hljs-comment">// 处理稀疏数组</span>
    <span class="hljs-keyword">if</span> (i <span class="hljs-keyword">in</span> obj) {
      result[i] = callback.<span class="hljs-title function_">call</span>(thisArg, obj[i], i, obj);
    }
  }

  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> squares = numbers.<span class="hljs-title function_">myMap</span>(<span class="hljs-function">(<span class="hljs-params">num</span>) =&gt;</span> num * num);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(squares); <span class="hljs-comment">// [1, 4, 9]</span>
</code></pre>
<h5 data-id="heading-3">1.2 filter方法实现</h5>
<p><code>filter</code>方法创建一个新数组，包含通过测试的所有元素。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myFilter</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">callback, thisArg</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span> === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"this is null or not defined"</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">"function"</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(callback + <span class="hljs-string">" is not a function"</span>);
  }

  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">const</span> len = obj.<span class="hljs-property">length</span> &gt;&gt;&gt; <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> result = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
    <span class="hljs-keyword">if</span> (i <span class="hljs-keyword">in</span> obj) {
      <span class="hljs-comment">// 如果回调返回true，则保留该元素</span>
      <span class="hljs-keyword">if</span> (callback.<span class="hljs-title function_">call</span>(thisArg, obj[i], i, obj)) {
        result.<span class="hljs-title function_">push</span>(obj[i]);
      }
    }
  }
  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-comment">// 使用示例：筛选出大于2的数字</span>
<span class="hljs-keyword">const</span> nums = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> filtered = nums.<span class="hljs-title function_">myFilter</span>(<span class="hljs-function">(<span class="hljs-params">num</span>) =&gt;</span> num &gt; <span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(filtered); <span class="hljs-comment">// [3, 4, 5]</span>
</code></pre>
<h5 data-id="heading-4">1.3 reduce方法实现</h5>
<p><code>reduce</code>是最强大的高阶函数，可以将数组元素通过reducer函数累积为单个值。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myReduce</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">callback, initialValue</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span> === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"this is null or not defined"</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">"function"</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(callback + <span class="hljs-string">" is not a function"</span>);
  }

  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">const</span> len = obj.<span class="hljs-property">length</span> &gt;&gt;&gt; <span class="hljs-number">0</span>;

  <span class="hljs-comment">// 处理空数组且无初始值的情况</span>
  <span class="hljs-keyword">if</span> (len === <span class="hljs-number">0</span> &amp;&amp; initialValue === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"Reduce of empty array with no initial value"</span>);
  }

  <span class="hljs-keyword">let</span> accumulator = initialValue;
  <span class="hljs-keyword">let</span> startIndex = <span class="hljs-number">0</span>;

  <span class="hljs-comment">// 如果没有提供初始值，使用第一个有效元素作为初始值</span>
  <span class="hljs-keyword">if</span> (initialValue === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-comment">// 找到第一个存在的元素(处理稀疏数组)</span>
    <span class="hljs-keyword">while</span> (startIndex &lt; len &amp;&amp; !(startIndex <span class="hljs-keyword">in</span> obj)) {
      startIndex++;
    }

    <span class="hljs-keyword">if</span> (startIndex === len) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"Reduce of empty array with no initial value"</span>);
    }

    accumulator = obj[startIndex];
    startIndex++;
  }

  <span class="hljs-comment">// 执行reduce操作</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = startIndex; i &lt; len; i++) {
    <span class="hljs-keyword">if</span> (i <span class="hljs-keyword">in</span> obj) {
      accumulator = <span class="hljs-title function_">callback</span>(accumulator, obj[i], i, obj);
    }
  }

  <span class="hljs-keyword">return</span> accumulator;
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> sum = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>].<span class="hljs-title function_">myReduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, curr</span>) =&gt;</span> acc + curr, <span class="hljs-number">0</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sum); <span class="hljs-comment">// 15</span>

<span class="hljs-comment">// 复杂示例：数组转对象</span>
<span class="hljs-keyword">const</span> items = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Apple"</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Banana"</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Orange"</span> },
];

<span class="hljs-keyword">const</span> itemMap = items.<span class="hljs-title function_">myReduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, item</span>) =&gt;</span> {
  acc[item.<span class="hljs-property">id</span>] = item;
  <span class="hljs-keyword">return</span> acc;
}, {});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(itemMap);
<span class="hljs-comment">// {</span>
<span class="hljs-comment">//   '1': { id: 1, name: 'Apple' },</span>
<span class="hljs-comment">//   '2': { id: 2, name: 'Banana' },</span>
<span class="hljs-comment">//   '3': { id: 3, name: 'Orange' }</span>
<span class="hljs-comment">// }</span>
</code></pre>
<h4 data-id="heading-5">二、搜索与断言方法</h4>
<h5 data-id="heading-6">2.1 find方法实现</h5>
<p><code>find</code>方法返回数组中满足测试函数的第一个元素的值。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myFind</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">callback, thisArg</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span> === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"this is null or not defined"</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">"function"</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(callback + <span class="hljs-string">" is not a function"</span>);
  }

  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">const</span> len = obj.<span class="hljs-property">length</span> &gt;&gt;&gt; <span class="hljs-number">0</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
    <span class="hljs-keyword">if</span> (i <span class="hljs-keyword">in</span> obj) {
      <span class="hljs-keyword">if</span> (callback.<span class="hljs-title function_">call</span>(thisArg, obj[i], i, obj)) {
        <span class="hljs-keyword">return</span> obj[i];
      }
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> users = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Charlie"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">35</span> },
];

<span class="hljs-keyword">const</span> user = users.<span class="hljs-title function_">myFind</span>(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> user.<span class="hljs-property">age</span> &gt; <span class="hljs-number">28</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user); <span class="hljs-comment">// { id: 2, name: 'Bob', age: 30 }</span>
</code></pre>
<h5 data-id="heading-7">2.2 findIndex方法实现</h5>
<p><code>findIndex</code>方法返回数组中满足测试函数的第一个元素的索引。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myFindIndex</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">callback, thisArg</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span> === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"this is null or not defined"</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">"function"</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(callback + <span class="hljs-string">" is not a function"</span>);
  }

  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">const</span> len = obj.<span class="hljs-property">length</span> &gt;&gt;&gt; <span class="hljs-number">0</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
    <span class="hljs-keyword">if</span> (i <span class="hljs-keyword">in</span> obj) {
      <span class="hljs-keyword">if</span> (callback.<span class="hljs-title function_">call</span>(thisArg, obj[i], i, obj)) {
        <span class="hljs-keyword">return</span> i;
      }
    }
  }

  <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">5</span>, <span class="hljs-number">12</span>, <span class="hljs-number">8</span>, <span class="hljs-number">130</span>, <span class="hljs-number">44</span>];
<span class="hljs-keyword">const</span> firstLargeNumberIndex = numbers.<span class="hljs-title function_">myFindIndex</span>(<span class="hljs-function"><span class="hljs-params">num</span> =&gt;</span> num &gt; <span class="hljs-number">10</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(firstLargeNumberIndex); <span class="hljs-comment">// 1</span>
</code></pre>
<h5 data-id="heading-8">2.3 some方法实现</h5>
<p><code>some</code>方法返回数组中是否至少有一个元素通过了测试。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">mySome</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">callback, thisArg</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span> === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"this is null or not defined"</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">"function"</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(callback + <span class="hljs-string">" is not a function"</span>);
  }

  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">const</span> len = obj.<span class="hljs-property">length</span> &gt;&gt;&gt; <span class="hljs-number">0</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
    <span class="hljs-keyword">if</span> (i <span class="hljs-keyword">in</span> obj) {
      <span class="hljs-keyword">if</span> (callback.<span class="hljs-title function_">call</span>(thisArg, obj[i], i, obj)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> hasEven = [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>].<span class="hljs-title function_">mySome</span>(<span class="hljs-function">(<span class="hljs-params">num</span>) =&gt;</span> num % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(hasEven); <span class="hljs-comment">// true</span>
</code></pre>
<h5 data-id="heading-9">2.4 every方法实现</h5>
<p><code>every</code>方法测试数组中的所有元素是否都通过了测试。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myEvery</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">callback, thisArg</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span> === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"this is null or not defined"</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">"function"</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(callback + <span class="hljs-string">" is not a function"</span>);
  }

  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">const</span> len = obj.<span class="hljs-property">length</span> &gt;&gt;&gt; <span class="hljs-number">0</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
    <span class="hljs-keyword">if</span> (i <span class="hljs-keyword">in</span> obj) {
      <span class="hljs-keyword">if</span> (!callback.<span class="hljs-title function_">call</span>(thisArg, obj[i], i, obj)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> allPositive = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>].<span class="hljs-title function_">myEvery</span>(<span class="hljs-function">(<span class="hljs-params">num</span>) =&gt;</span> num &gt; <span class="hljs-number">0</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(allPositive); <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-10">三、数组扁平化方法</h4>
<h5 data-id="heading-11">3.1 flat方法实现</h5>
<p><code>flat</code>方法创建一个新数组, 其中所有子数组元素递归连接到指定深度。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myFlat</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">depth = <span class="hljs-number">1</span></span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span> === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"this is null or not defined"</span>);
  }

  <span class="hljs-comment">// 深度参数验证</span>
  <span class="hljs-keyword">if</span> (depth &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RangeError</span>(<span class="hljs-string">"depth must be a non-negative integer"</span>);
  }

  <span class="hljs-keyword">const</span> result = [];

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">flatten</span> = (<span class="hljs-params">arr, currentDepth</span>) =&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">const</span> element = arr[i];
      <span class="hljs-comment">// 如果当前深度小于指定深度且元素是数组, 则递归扁平化</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(element) &amp;&amp; currentDepth &lt; depth) {
        <span class="hljs-title function_">flatten</span>(element, currentDepth + <span class="hljs-number">1</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 否则直接添加到结果数组</span>
        <span class="hljs-comment">// 注意: 如果depth为0，则不会扁平化任何数组</span>
        result.<span class="hljs-title function_">push</span>(element);
      }
    }
  };

  <span class="hljs-title function_">flatten</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> nestedArray = [<span class="hljs-number">1</span>, [<span class="hljs-number">2</span>, [<span class="hljs-number">3</span>, [<span class="hljs-number">4</span>]], <span class="hljs-number">5</span>]];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nestedArray.<span class="hljs-title function_">myFlat</span>()); <span class="hljs-comment">// [1, 2, [3, [4]], 5]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nestedArray.<span class="hljs-title function_">myFlat</span>(<span class="hljs-number">2</span>)); <span class="hljs-comment">// [1, 2, 3, [4], 5]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nestedArray.<span class="hljs-title function_">myFlat</span>(<span class="hljs-title class_">Infinity</span>)); <span class="hljs-comment">// [1, 2, 3, 4, 5]</span>
</code></pre>
<h5 data-id="heading-12">3.2 flatMap方法实现</h5>
<p><code>flatMap</code>方法首先使用映射函数映射每个元素, 然后将结果压缩成一个新数组。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myFlatMap</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">callback, thisArg</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span> === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"this is null or not defined"</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">"function"</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(callback + <span class="hljs-string">" is not a function"</span>);
  }

  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">const</span> len = obj.<span class="hljs-property">length</span> &gt;&gt;&gt; <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> result = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
    <span class="hljs-keyword">if</span> (i <span class="hljs-keyword">in</span> obj) {
      <span class="hljs-keyword">const</span> mapped = callback.<span class="hljs-title function_">call</span>(thisArg, obj[i], i, obj);

      <span class="hljs-comment">// 如果回调函数返回的是数组, 则展开它</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(mapped)) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; mapped.<span class="hljs-property">length</span>; j++) {
          result.<span class="hljs-title function_">push</span>(mapped[j]);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 如果不是数组，直接添加</span>
        result.<span class="hljs-title function_">push</span>(mapped);
      }
    }
  }

  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> phrases = [<span class="hljs-string">"Hello world"</span>, <span class="hljs-string">"JavaScript is awesome"</span>];
<span class="hljs-keyword">const</span> words = phrases.<span class="hljs-title function_">myFlatMap</span>(<span class="hljs-function">(<span class="hljs-params">phrase</span>) =&gt;</span> phrase.<span class="hljs-title function_">split</span>(<span class="hljs-string">" "</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(words); <span class="hljs-comment">// ["Hello", "world", "JavaScript", "is", "awesome"]</span>

<span class="hljs-comment">// 另一个示例：展开并过滤</span>
<span class="hljs-keyword">const</span> numbers2 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>];
<span class="hljs-keyword">const</span> result = numbers2.<span class="hljs-title function_">myFlatMap</span>(<span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> (x % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? [x, x * <span class="hljs-number">2</span>] : []));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result); <span class="hljs-comment">// [2, 4, 4, 8]</span>
</code></pre>
<h4 data-id="heading-13">四、排序算法实现</h4>
<h5 data-id="heading-14">4.1 sort方法实现</h5>
<p>JavaScript原生的<code>sort</code>方法使用TimSort算法(一种混合排序算法, 结合了归并排序和插入排序)。这里我们实现一个简单但功能完整的排序方法, 支持自定义比较函数。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">mySort</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">compartFn</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span> === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"this is null or not defined"</span>);
  }

  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">const</span> len = obj.<span class="hljs-property">length</span> &gt;&gt;&gt; <span class="hljs-number">0</span>;

  <span class="hljs-comment">// 如果没有提供比较函数, 使用默认的字符串比较</span>
  <span class="hljs-keyword">if</span> (compartFn === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-comment">// 默认比较函数: 将元素转为字符串, 然后比较UTF-16代码单元值序列</span>
    compartFn = <span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) {
      <span class="hljs-keyword">const</span> aString = <span class="hljs-title class_">String</span>(a);
      <span class="hljs-keyword">const</span> bString = <span class="hljs-title class_">String</span>(b);

      <span class="hljs-keyword">if</span> (aString &lt; bString) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
      <span class="hljs-keyword">if</span> (aString &gt; bString) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    };
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> compartFn !== <span class="hljs-string">"function"</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"compareFn must be a function or undefined"</span>);
  }

  <span class="hljs-comment">// 实现快速排序算法(高效且常用)</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">quickSort</span>(<span class="hljs-params">arr, left, right, compare</span>) {
    <span class="hljs-keyword">if</span> (left &gt;= right) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> pivotIndex = <span class="hljs-title function_">partition</span>(arr, left, right, compare);
    <span class="hljs-title function_">quickSort</span>(arr, left, pivotIndex - <span class="hljs-number">1</span>, compare);
    <span class="hljs-title function_">quickSort</span>(arr, pivotIndex + <span class="hljs-number">1</span>, right, compare);
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">partition</span>(<span class="hljs-params">arr, left, right, compare</span>) {
    <span class="hljs-comment">// 选择中间元素作为基准值</span>
    <span class="hljs-keyword">const</span> pivotIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((left + right) / <span class="hljs-number">2</span>);
    <span class="hljs-keyword">const</span> pivotValue = arr[pivotIndex];

    <span class="hljs-comment">// 将基准值移到最右边</span>
    [arr[pivotIndex], arr[right]] = [arr[right], arr[pivotIndex]];

    <span class="hljs-keyword">let</span> storeIndex = left;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = left; i &lt; right; i++) {
      <span class="hljs-comment">// 使用比较函数比较当前元素和基准值</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">compare</span>(arr[i], pivotValue) &lt; <span class="hljs-number">0</span>) {
        [arr[storeIndex], arr[i]] = [arr[i], arr[storeIndex]];
        storeIndex++;
      }
    }

    <span class="hljs-comment">// 将基准值放到正确的位置</span>
    [arr[storeIndex], arr[right]] = [arr[right], arr[storeIndex]];
    <span class="hljs-keyword">return</span> storeIndex;
  }

  <span class="hljs-comment">// 将稀疏数组转换为紧凑数组(跳过不存在的元素)</span>
  <span class="hljs-keyword">const</span> compactArray = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
    <span class="hljs-keyword">if</span> (i <span class="hljs-keyword">in</span> obj) {
      compactArray.<span class="hljs-title function_">push</span>(obj[i]);
    }
  }

  <span class="hljs-comment">// 执行快速排序</span>
  <span class="hljs-keyword">if</span> (compactArray.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-title function_">quickSort</span>(compactArray, <span class="hljs-number">0</span>, compactArray.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>, compartFn);
  }

  <span class="hljs-comment">// 将排序后的数组复制回原数组，保持稀疏性</span>
  <span class="hljs-keyword">let</span> compactIndex = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
    <span class="hljs-keyword">if</span> (i <span class="hljs-keyword">in</span> obj) {
      obj[i] = compactArray[compactIndex++];
    }
  }

  <span class="hljs-keyword">return</span> obj;
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> unsorted = [<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">9</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">5</span>];
unsorted.<span class="hljs-title function_">mySort</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(unsorted); <span class="hljs-comment">// [1, 1, 2, 3, 4, 5, 5, 6, 9]</span>

<span class="hljs-comment">// 使用自定义比较函数</span>
<span class="hljs-keyword">const</span> students = [
  { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">85</span> },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">92</span> },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">"Charlie"</span>, <span class="hljs-attr">score</span>: <span class="hljs-number">78</span> },
];

students.<span class="hljs-title function_">mySort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b.<span class="hljs-property">score</span> - a.<span class="hljs-property">score</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(students);
<span class="hljs-comment">// 按分数降序排列</span>
</code></pre>
<h4 data-id="heading-15">五、总结</h4>
<h5 data-id="heading-16">5.1 实现要点总结</h5>
<ol>
<li><strong>输入验证:</strong> 始终检查<code>this</code>是否为<code>null</code>或<code>undefined</code>, 以及回调函数是否为函数类型</li>
<li><strong>稀疏数组处理:</strong> 使用<code>in</code>操作符检查索引是否存在</li>
<li><strong>类型安全:</strong> 使用<code>&gt;&gt;&gt;0</code>确保长度为非负整数</li>
<li><strong>性能考虑:</strong></li>
</ol>
<ul>
<li>避免不必要的数组拷贝</li>
<li>使用适当的算法(如快速排序对于sort方法)</li>
<li>注意递归深度(特别是对于flat方法)</li>
</ul>
<ol start="5">
<li><strong>与原生方法差异:</strong></li>
</ol>
<ul>
<li>我们的实现在某些边缘情况下可能与原生方法略有不同</li>
<li>原生方法通常有更好的性能和内存管理</li>
</ul>
<h5 data-id="heading-17">5.2 实际应用场景</h5>
<ol>
<li><strong>数据处理:</strong> <code>map</code>、<code>filter</code>、<code>reduce</code>是数据处理的三件套</li>
<li><strong>搜索功能:</strong> <code>find</code>、<code>findIndex</code>用于数据检索</li>
<li><strong>表单验证:</strong> <code>some</code>、<code>every</code>用于验证多个输入</li>
<li><strong>状态管理:</strong> <code>flat</code>、<code>flatMap</code>在处理嵌套状态时特别有用</li>
<li><strong>数据展示:</strong> <code>sort</code>用于数据排序</li>
</ol>
<p>通过手动实现这些核心数组方法，我们不仅加深了对JavaScript数组操作的理解，还掌握了函数式编程的核心概念。</p>
<p>记住：在实际生产环境中，仍然建议使用原生数组方法，因为它们经过了充分优化和测试。但理解这些方法的实现原理，将使你成为一个更出色的JavaScript开发者。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>